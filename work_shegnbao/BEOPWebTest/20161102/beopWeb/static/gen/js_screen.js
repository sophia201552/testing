(function(){window.UEDITOR_HOME_URL='/static/scripts/lib/ueditor/';var URL=window.UEDITOR_HOME_URL||getUEBasePath();window.UEDITOR_CONFIG={UEDITOR_HOME_URL:URL,serverUrl:URL+"jsp/controller.jsp",toolbars:[['source','|','undo','redo','|','bold','italic','underline','fontborder','strikethrough','superscript','subscript','removeformat','formatmatch','autotypeset','pasteplain','|','forecolor','backcolor','insertorderedlist','insertunorderedlist','selectall','cleardoc','|','rowspacingtop','rowspacingbottom','lineheight','|','customstyle','paragraph','fontfamily','fontsize','|','justifyleft','justifycenter','justifyright','justifyjustify','|','touppercase','tolowercase','|','link','unlink','|','imagenone','imageleft','imageright','|','simpleupload','emotion','map','gmap','pagebreak','background','|','horizontal','date','time','spechars','snapscreen','|','inserttable','deletetable','insertparagraphbeforetable','insertrow','deleterow','insertcol','deletecol','mergecells','mergeright','mergedown','splittocells','splittorows','splittocols','charts','|','print','preview','searchreplace','drafts']],zIndex:1100,enableAutoSave:false,saveInterval:50000000000,autoHeightEnabled:false,wordCount:false};function getUEBasePath(docUrl,confUrl){return getBasePath(docUrl||self.document.URL||self.location.href,confUrl||getConfigFilePath());}
function getConfigFilePath(){var configPath=document.getElementsByTagName('script');return configPath[configPath.length-1].src;}
function getBasePath(docUrl,confUrl){var basePath=confUrl;if(/^(\/|\\\\)/.test(confUrl)){basePath=/^.+?\w(\/|\\\\)/.exec(docUrl)[0]+confUrl.replace(/^(\/|\\\\)/,'');}else if(!/^[a-z]+:/i.test(confUrl)){docUrl=docUrl.split("#")[0].split("?")[0].replace(/[^\\\/]+$/,'');basePath=docUrl+""+confUrl;}
return optimizationPath(basePath);}
function optimizationPath(path){var protocol=/^[a-z]+:\/\//.exec(path)[0],tmp=null,res=[];path=path.replace(protocol,"").split("?")[0].split("#")[0];path=path.replace(/\\/g,'/').split(/\//);path[path.length-1]="";while(path.length){if((tmp=path.shift())===".."){res.pop();}else if(tmp!=="."){res.push(tmp);}}
return protocol+res.join("/");}
window.UE={getUEBasePath:getUEBasePath};})();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(){UEDITOR_CONFIG=window.UEDITOR_CONFIG||{};var baidu=window.baidu||{};window.baidu=baidu;window.UE=baidu.editor=window.UE||{};UE.plugins={};UE.commands={};UE.instants={};UE.I18N={};UE._customizeUI={};UE.version="1.4.3";var dom=UE.dom={};var browser=UE.browser=function(){var agent=navigator.userAgent.toLowerCase(),opera=window.opera,browser={ie:/(msie\s|trident.*rv:)([\w.]+)/.test(agent),opera:!!opera&&opera.version,webkit:agent.indexOf(' applewebkit/')>-1,mac:agent.indexOf('macintosh')>-1,quirks:document.compatMode=='BackCompat'};browser.gecko=navigator.product=='Gecko'&&!browser.webkit&&!browser.opera&&!browser.ie;var version=0;if(browser.ie){var v1=agent.match(/(?:msie\s([\w.]+))/);var v2=agent.match(/(?:trident.*rv:([\w.]+))/);if(v1&&v2&&v1[1]&&v2[1]){version=Math.max(v1[1]*1,v2[1]*1);}else if(v1&&v1[1]){version=v1[1]*1;}else if(v2&&v2[1]){version=v2[1]*1;}else{version=0;}browser.ie11Compat=document.documentMode==11;browser.ie9Compat=document.documentMode==9;browser.ie8=!!document.documentMode;browser.ie8Compat=document.documentMode==8;browser.ie7Compat=version==7&&!document.documentMode||document.documentMode==7;browser.ie6Compat=version<7||browser.quirks;browser.ie9above=version>8;browser.ie9below=version<9;browser.ie11above=version>10;browser.ie11below=version<11;}
if(browser.gecko){var geckoRelease=agent.match(/rv:([\d\.]+)/);if(geckoRelease){geckoRelease=geckoRelease[1].split('.');version=geckoRelease[0]*10000+(geckoRelease[1]||0)*100+(geckoRelease[2]||0)*1;}}if(/chrome\/(\d+\.\d)/i.test(agent)){browser.chrome=+RegExp['\x241'];}if(/(\d+\.\d)?(?:\.\d)?\s+safari\/?(\d+\.\d+)?/i.test(agent)&&!/chrome/i.test(agent)){browser.safari=+(RegExp['\x241']||RegExp['\x242']);}
if(browser.opera)version=parseFloat(opera.version());if(browser.webkit)version=parseFloat(agent.match(/ applewebkit\/(\d+)/)[1]);browser.version=version;browser.isCompatible=!browser.mobile&&(browser.ie&&version>=6||browser.gecko&&version>=10801||browser.opera&&version>=9.5||browser.air&&version>=1||browser.webkit&&version>=522||false);return browser;}();var ie=browser.ie,webkit=browser.webkit,gecko=browser.gecko,opera=browser.opera;var utils=UE.utils={each:function each(obj,iterator,context){if(obj==null)return;if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++){if(iterator.call(context,obj[i],i,obj)===false)return false;}}else{for(var key in obj){if(obj.hasOwnProperty(key)){if(iterator.call(context,obj[key],key,obj)===false)return false;}}}},makeInstance:function makeInstance(obj){var noop=new Function();noop.prototype=obj;obj=new noop();noop.prototype=null;return obj;},extend:function extend(t,s,b){if(s){for(var k in s){if(!b||!t.hasOwnProperty(k)){t[k]=s[k];}}}return t;},extend2:function extend2(t){var a=arguments;for(var i=1;i<a.length;i++){var x=a[i];for(var k in x){if(!t.hasOwnProperty(k)){t[k]=x[k];}}}return t;},inherits:function inherits(subClass,superClass){var oldP=subClass.prototype,newP=utils.makeInstance(superClass.prototype);utils.extend(newP,oldP,true);subClass.prototype=newP;return newP.constructor=subClass;},bind:function bind(fn,context){return function(){return fn.apply(context,arguments);};},defer:function defer(fn,delay,exclusion){var timerID;return function(){if(exclusion){clearTimeout(timerID);}timerID=setTimeout(fn,delay);};},indexOf:function indexOf(array,item,start){var index=-1;start=this.isNumber(start)?start:0;this.each(array,function(v,i){if(i>=start&&v===item){index=i;return false;}});return index;},removeItem:function removeItem(array,item){for(var i=0,l=array.length;i<l;i++){if(array[i]===item){array.splice(i,1);i--;}}},trim:function trim(str){return str.replace(/(^[ \t\n\r]+)|([ \t\n\r]+$)/g,'');},listToMap:function listToMap(list){if(!list)return{};list=utils.isArray(list)?list:list.split(',');for(var i=0,ci,obj={};ci=list[i++];){obj[ci.toUpperCase()]=obj[ci]=1;}return obj;},unhtml:function unhtml(str,reg){return str?str.replace(reg||/[&<">'](?:(amp|lt|quot|gt|#39|nbsp|#\d+);)?/g,function(a,b){if(b){return a;}else{return{'<':'&lt;','&':'&amp;','"':'&quot;','>':'&gt;',"'":'&#39;'}[a];}}):'';},html:function html(str){return str?str.replace(/&((g|l|quo)t|amp|#39|nbsp);/g,function(m){return{'&lt;':'<','&amp;':'&','&quot;':'"','&gt;':'>','&#39;':"'",'&nbsp;':' '}[m];}):'';},cssStyleToDomStyle:function(){var test=document.createElement('div').style,cache={'float':test.cssFloat!=undefined?'cssFloat':test.styleFloat!=undefined?'styleFloat':'float'};return function(cssName){return cache[cssName]||(cache[cssName]=cssName.toLowerCase().replace(/-./g,function(match){return match.charAt(1).toUpperCase();}));};}(),loadFile:function(){var tmpList=[];function getItem(doc,obj){try{for(var i=0,ci;ci=tmpList[i++];){if(ci.doc===doc&&ci.url==(obj.src||obj.href)){return ci;}}}catch(e){return null;}}return function(doc,obj,fn){var item=getItem(doc,obj);if(item){if(item.ready){fn&&fn();}else{item.funs.push(fn);}return;}tmpList.push({doc:doc,url:obj.src||obj.href,funs:[fn]});if(!doc.body){var html=[];for(var p in obj){if(p=='tag')continue;html.push(p+'="'+obj[p]+'"');}doc.write('<'+obj.tag+' '+html.join(' ')+' ></'+obj.tag+'>');return;}if(obj.id&&doc.getElementById(obj.id)){return;}var element=doc.createElement(obj.tag);delete obj.tag;for(var p in obj){element.setAttribute(p,obj[p]);}element.onload=element.onreadystatechange=function(){if(!this.readyState||/loaded|complete/.test(this.readyState)){item=getItem(doc,obj);if(item.funs.length>0){item.ready=1;for(var fi;fi=item.funs.pop();){fi();}}element.onload=element.onreadystatechange=null;}};element.onerror=function(){throw Error('The load '+(obj.href||obj.src)+' fails,check the url settings of file ueditor.config.js ');};doc.getElementsByTagName("head")[0].appendChild(element);};}(),isEmptyObject:function isEmptyObject(obj){if(obj==null)return true;if(this.isArray(obj)||this.isString(obj))return obj.length===0;for(var key in obj){if(obj.hasOwnProperty(key))return false;}return true;},fixColor:function fixColor(name,value){if(/color/i.test(name)&&/rgba?/.test(value)){var array=value.split(",");if(array.length>3)return"";value="#";for(var i=0,color;color=array[i++];){color=parseInt(color.replace(/[^\d]/gi,''),10).toString(16);value+=color.length==1?"0"+color:color;}value=value.toUpperCase();}return value;},optCss:function optCss(val){var padding,margin,border;val=val.replace(/(padding|margin|border)\-([^:]+):([^;]+);?/gi,function(str,key,name,val){if(val.split(' ').length==1){switch(key){case'padding':!padding&&(padding={});padding[name]=val;return'';case'margin':!margin&&(margin={});margin[name]=val;return'';case'border':return val=='initial'?'':str;}}return str;});function opt(obj,name){if(!obj){return'';}var t=obj.top,b=obj.bottom,l=obj.left,r=obj.right,val='';if(!t||!l||!b||!r){for(var p in obj){val+=';'+name+'-'+p+':'+obj[p]+';';}}else{val+=';'+name+':'+(t==b&&b==l&&l==r?t:t==b&&l==r?t+' '+l:l==r?t+' '+l+' '+b:t+' '+r+' '+b+' '+l)+';';}return val;}val+=opt(padding,'padding')+opt(margin,'margin');return val.replace(/^[ \n\r\t;]*|[ \n\r\t]*$/,'').replace(/;([ \n\r\t]+)|\1;/g,';').replace(/(&((l|g)t|quot|#39))?;{2,}/g,function(a,b){return b?b+";;":';';});},clone:function clone(source,target){var tmp;target=target||{};for(var i in source){if(source.hasOwnProperty(i)){tmp=source[i];if((typeof tmp==='undefined'?'undefined':_typeof(tmp))=='object'){target[i]=utils.isArray(tmp)?[]:{};utils.clone(source[i],target[i]);}else{target[i]=tmp;}}}return target;},transUnitToPx:function transUnitToPx(val){if(!/(pt|cm)/.test(val)){return val;}var unit;val.replace(/([\d.]+)(\w+)/,function(str,v,u){val=v;unit=u;});switch(unit){case'cm':val=parseFloat(val)*25;break;case'pt':val=Math.round(parseFloat(val)*96/72);}return val+(val?'px':'');},domReady:function(){var fnArr=[];function doReady(doc){doc.isReady=true;for(var ci;ci=fnArr.pop();ci()){}}return function(onready,win){win=win||window;var doc=win.document;onready&&fnArr.push(onready);if(doc.readyState==="complete"){doReady(doc);}else{doc.isReady&&doReady(doc);if(browser.ie&&browser.version!=11){(function(){if(doc.isReady)return;try{doc.documentElement.doScroll("left");}catch(error){setTimeout(arguments.callee,0);return;}doReady(doc);})();win.attachEvent('onload',function(){doReady(doc);});}else{doc.addEventListener("DOMContentLoaded",function(){doc.removeEventListener("DOMContentLoaded",arguments.callee,false);doReady(doc);},false);win.addEventListener('load',function(){doReady(doc);},false);}}};}(),cssRule:browser.ie&&browser.version!=11?function(key,style,doc){var indexList,index;if(style===undefined||style&&style.nodeType&&style.nodeType==9){doc=style&&style.nodeType&&style.nodeType==9?style:doc||document;indexList=doc.indexList||(doc.indexList={});index=indexList[key];if(index!==undefined){return doc.styleSheets[index].cssText;}return undefined;}doc=doc||document;indexList=doc.indexList||(doc.indexList={});index=indexList[key];if(style===''){if(index!==undefined){doc.styleSheets[index].cssText='';delete indexList[key];return true;}return false;}
if(index!==undefined){sheetStyle=doc.styleSheets[index];}else{sheetStyle=doc.createStyleSheet('',index=doc.styleSheets.length);indexList[key]=index;}sheetStyle.cssText=style;}:function(key,style,doc){var head,node;if(style===undefined||style&&style.nodeType&&style.nodeType==9){doc=style&&style.nodeType&&style.nodeType==9?style:doc||document;node=doc.getElementById(key);return node?node.innerHTML:undefined;}doc=doc||document;node=doc.getElementById(key);if(style===''){if(node){node.parentNode.removeChild(node);return true;}return false;}
if(node){node.innerHTML=style;}else{node=doc.createElement('style');node.id=key;node.innerHTML=style;doc.getElementsByTagName('head')[0].appendChild(node);}},sort:function sort(array,compareFn){compareFn=compareFn||function(item1,item2){return item1.localeCompare(item2);};for(var i=0,len=array.length;i<len;i++){for(var j=i,length=array.length;j<length;j++){if(compareFn(array[i],array[j])>0){var t=array[i];array[i]=array[j];array[j]=t;}}}return array;},serializeParam:function serializeParam(json){var strArr=[];for(var i in json){if(i=="method"||i=="timeout"||i=="async")continue;if(!(_typeof(json[i]).toLowerCase()=="function"||_typeof(json[i]).toLowerCase()=="object")){strArr.push(encodeURIComponent(i)+"="+encodeURIComponent(json[i]));}else if(utils.isArray(json[i])){for(var j=0;j<json[i].length;j++){strArr.push(encodeURIComponent(i)+"[]="+encodeURIComponent(json[i][j]));}}}return strArr.join("&");},formatUrl:function formatUrl(url){var u=url.replace(/&&/g,'&');u=u.replace(/\?&/g,'?');u=u.replace(/&$/g,'');u=u.replace(/&#/g,'#');u=u.replace(/&+/g,'&');return u;},isCrossDomainUrl:function isCrossDomainUrl(url){var a=document.createElement('a');a.href=url;if(browser.ie){a.href=a.href;}return!(a.protocol==location.protocol&&a.hostname==location.hostname&&(a.port==location.port||a.port=='80'&&location.port==''||a.port==''&&location.port=='80'));},clearEmptyAttrs:function clearEmptyAttrs(obj){for(var p in obj){if(obj[p]===''){delete obj[p];}}return obj;},str2json:function str2json(s){if(!utils.isString(s))return null;if(window.JSON){return JSON.parse(s);}else{return new Function("return "+utils.trim(s||''))();}},json2str:function(){if(window.JSON){return JSON.stringify;}else{var escapeMap;var _ret=function(){var encodeString=function encodeString(source){if(/["\\\x00-\x1f]/.test(source)){source=source.replace(/["\\\x00-\x1f]/g,function(match){var c=escapeMap[match];if(c){return c;}c=match.charCodeAt();return'\\u00'+Math.floor(c/16).toString(16)+(c%16).toString(16);});}return'"'+source+'"';};var encodeArray=function encodeArray(source){var result=["["],l=source.length,preComma,i,item;for(i=0;i<l;i++){item=source[i];switch(typeof item==='undefined'?'undefined':_typeof(item)){case"undefined":case"function":case"unknown":break;default:if(preComma){result.push(',');}result.push(utils.json2str(item));preComma=1;}}result.push("]");return result.join("");};var pad=function pad(source){return source<10?'0'+source:source;};var encodeDate=function encodeDate(source){return'"'+source.getFullYear()+"-"+pad(source.getMonth()+1)+"-"+pad(source.getDate())+"T"+pad(source.getHours())+":"+pad(source.getMinutes())+":"+pad(source.getSeconds())+'"';};escapeMap={"\b":'\\b',"\t":'\\t',"\n":'\\n',"\f":'\\f',"\r":'\\r','"':'\\"',"\\":'\\\\'};return{v:function v(value){switch(typeof value==='undefined'?'undefined':_typeof(value)){case'undefined':return'undefined';case'number':return isFinite(value)?String(value):"null";case'string':return encodeString(value);case'boolean':return String(value);default:if(value===null){return'null';}else if(utils.isArray(value)){return encodeArray(value);}else if(utils.isDate(value)){return encodeDate(value);}else{var result=['{'],encode=utils.json2str,preComma,item;for(var key in value){if(Object.prototype.hasOwnProperty.call(value,key)){item=value[key];switch(typeof item==='undefined'?'undefined':_typeof(item)){case'undefined':case'unknown':case'function':break;default:if(preComma){result.push(',');}preComma=1;result.push(encode(key)+':'+encode(item));}}}result.push('}');return result.join('');}}}};}();if((typeof _ret==='undefined'?'undefined':_typeof(_ret))==="object")return _ret.v;}}()};utils.each(['String','Function','Array','Number','RegExp','Object','Date'],function(v){UE.utils['is'+v]=function(obj){return Object.prototype.toString.apply(obj)=='[object '+v+']';};});var EventBase=UE.EventBase=function(){};EventBase.prototype={addListener:function addListener(types,listener){types=utils.trim(types).split(/\s+/);for(var i=0,ti;ti=types[i++];){getListener(this,ti,true).push(listener);}},on:function on(types,listener){return this.addListener(types,listener);},off:function off(types,listener){return this.removeListener(types,listener);},trigger:function trigger(){return this.fireEvent.apply(this,arguments);},removeListener:function removeListener(types,listener){types=utils.trim(types).split(/\s+/);for(var i=0,ti;ti=types[i++];){utils.removeItem(getListener(this,ti)||[],listener);}},fireEvent:function fireEvent(){var types=arguments[0];types=utils.trim(types).split(' ');for(var i=0,ti;ti=types[i++];){var listeners=getListener(this,ti),r,t,k;if(listeners){k=listeners.length;while(k--){if(!listeners[k])continue;t=listeners[k].apply(this,arguments);if(t===true){return t;}if(t!==undefined){r=t;}}}if(t=this['on'+ti.toLowerCase()]){r=t.apply(this,arguments);}}return r;}};function getListener(obj,type,force){var allListeners;type=type.toLowerCase();return(allListeners=obj.__allListeners||force&&(obj.__allListeners={}))&&(allListeners[type]||force&&(allListeners[type]=[]));}
var dtd=dom.dtd=function(){function _(s){for(var k in s){s[k.toUpperCase()]=s[k];}return s;}var X=utils.extend2;var A=_({isindex:1,fieldset:1}),B=_({input:1,button:1,select:1,textarea:1,label:1}),C=X(_({a:1}),B),D=X({iframe:1},C),E=_({hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1}),F=_({ins:1,del:1,script:1,style:1}),G=X(_({b:1,acronym:1,bdo:1,'var':1,'#':1,abbr:1,code:1,br:1,i:1,cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1}),F),H=X(_({sub:1,img:1,embed:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1}),G),I=X(_({p:1}),H),J=X(_({iframe:1}),H,B),K=_({img:1,embed:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,'#':1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,'var':1,div:1,object:1,sup:1,strike:1,dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1}),L=X(_({a:0}),J),M=_({tr:1}),N=_({'#':1}),O=X(_({param:1}),K),P=X(_({form:1}),A,D,E,I),Q=_({li:1,ol:1,ul:1}),R=_({style:1,script:1}),S=_({base:1,link:1,meta:1,title:1}),T=X(S,R),U=_({head:1,body:1}),V=_({html:1});var block=_({address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1}),empty=_({area:1,base:1,basefont:1,br:1,col:1,command:1,dialog:1,embed:1,hr:1,img:1,input:1,isindex:1,keygen:1,link:1,meta:1,param:1,source:1,track:1,wbr:1});return _({$nonBodyContent:X(V,U,S),$block:block,$inline:L,$inlineWithA:X(_({a:1}),L),$body:X(_({script:1,style:1}),block),$cdata:_({script:1,style:1}),$empty:empty,$nonChild:_({iframe:1,textarea:1}),$listItem:_({dd:1,dt:1,li:1}),$list:_({ul:1,ol:1,dl:1}),$isNotEmpty:_({table:1,ul:1,ol:1,dl:1,iframe:1,area:1,base:1,col:1,hr:1,img:1,embed:1,input:1,link:1,meta:1,param:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1}),$removeEmpty:_({a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,'var':1}),$removeEmptyBlock:_({'p':1,'div':1}),$tableContent:_({caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1,table:1}),$notTransContent:_({pre:1,script:1,style:1,textarea:1}),html:U,head:T,style:N,script:N,body:P,base:{},link:{},meta:{},title:N,col:{},tr:_({td:1,th:1}),img:{},embed:{},colgroup:_({thead:1,col:1,tbody:1,tr:1,tfoot:1}),noscript:P,td:P,br:{},th:P,center:P,kbd:L,button:X(I,E),basefont:{},h5:L,h4:L,samp:L,h6:L,ol:Q,h1:L,h3:L,option:N,h2:L,form:X(A,D,E,I),select:_({optgroup:1,option:1}),font:L,ins:L,menu:Q,abbr:L,label:L,table:_({thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1}),code:L,tfoot:M,cite:L,li:P,input:{},iframe:P,strong:L,textarea:N,noframes:P,big:L,small:L,span:_({'#':1,br:1,b:1,strong:1,u:1,i:1,em:1,sub:1,sup:1,strike:1,span:1}),hr:L,dt:L,sub:L,optgroup:_({option:1}),param:{},bdo:L,'var':L,div:P,object:O,sup:L,dd:P,strike:L,area:{},dir:Q,map:X(_({area:1,form:1,p:1}),A,F,E),applet:O,dl:_({dt:1,dd:1}),del:L,isindex:{},fieldset:X(_({legend:1}),K),thead:M,ul:Q,acronym:L,b:L,a:X(_({a:1}),J),blockquote:X(_({td:1,tr:1,tbody:1,li:1}),P),caption:L,i:L,u:L,tbody:M,s:L,address:X(D,I),tt:L,legend:L,q:L,pre:X(G,C),p:X(_({'a':1}),L),em:L,dfn:L});}();function getDomNode(node,start,ltr,startFromChild,fn,guard){var tmpNode=startFromChild&&node[start],parent;!tmpNode&&(tmpNode=node[ltr]);while(!tmpNode&&(parent=(parent||node).parentNode)){if(parent.tagName=='BODY'||guard&&!guard(parent)){return null;}tmpNode=parent[ltr];}if(tmpNode&&fn&&!fn(tmpNode)){return getDomNode(tmpNode,start,ltr,false,fn);}return tmpNode;}var attrFix=ie&&browser.version<9?{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder"}:{tabindex:"tabIndex",readonly:"readOnly"},styleBlock=utils.listToMap(['-webkit-box','-moz-box','block','list-item','table','table-row-group','table-header-group','table-footer-group','table-row','table-column-group','table-column','table-cell','table-caption']);var domUtils=dom.domUtils={NODE_ELEMENT:1,NODE_DOCUMENT:9,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11,POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16,fillChar:ie&&browser.version=='6'?'\uFEFF':'\u200B',keys:{8:1,46:1,16:1,17:1,18:1,37:1,38:1,39:1,40:1,13:1},getPosition:function getPosition(nodeA,nodeB){if(nodeA===nodeB){return 0;}var node,parentsA=[nodeA],parentsB=[nodeB];node=nodeA;while(node=node.parentNode){if(node===nodeB){return 10;}parentsA.push(node);}node=nodeB;while(node=node.parentNode){if(node===nodeA){return 20;}parentsB.push(node);}parentsA.reverse();parentsB.reverse();if(parentsA[0]!==parentsB[0]){return 1;}var i=-1;while(i++,parentsA[i]===parentsB[i]){}nodeA=parentsA[i];nodeB=parentsB[i];while(nodeA=nodeA.nextSibling){if(nodeA===nodeB){return 4;}}
return 2;},getNodeIndex:function getNodeIndex(node,ignoreTextNode){var preNode=node,i=0;while(preNode=preNode.previousSibling){if(ignoreTextNode&&preNode.nodeType==3){if(preNode.nodeType!=preNode.nextSibling.nodeType){i++;}continue;}i++;}return i;},inDoc:function inDoc(node,doc){return domUtils.getPosition(node,doc)==10;},findParent:function findParent(node,filterFn,includeSelf){if(node&&!domUtils.isBody(node)){node=includeSelf?node:node.parentNode;while(node){if(!filterFn||filterFn(node)||domUtils.isBody(node)){return filterFn&&!filterFn(node)&&domUtils.isBody(node)?null:node;}node=node.parentNode;}}return null;},findParentByTagName:function findParentByTagName(node,tagNames,includeSelf,excludeFn){tagNames=utils.listToMap(utils.isArray(tagNames)?tagNames:[tagNames]);return domUtils.findParent(node,function(node){return tagNames[node.tagName]&&!(excludeFn&&excludeFn(node));},includeSelf);},findParents:function findParents(node,includeSelf,filterFn,closerFirst){var parents=includeSelf&&(filterFn&&filterFn(node)||!filterFn)?[node]:[];while(node=domUtils.findParent(node,filterFn)){parents.push(node);}return closerFirst?parents:parents.reverse();},insertAfter:function insertAfter(node,newNode){return node.nextSibling?node.parentNode.insertBefore(newNode,node.nextSibling):node.parentNode.appendChild(newNode);},remove:function remove(node,keepChildren){var parent=node.parentNode,child;if(parent){if(keepChildren&&node.hasChildNodes()){while(child=node.firstChild){parent.insertBefore(child,node);}}parent.removeChild(node);}return node;},getNextDomNode:function getNextDomNode(node,startFromChild,filterFn,guard){return getDomNode(node,'firstChild','nextSibling',startFromChild,filterFn,guard);},getPreDomNode:function getPreDomNode(node,startFromChild,filterFn,guard){return getDomNode(node,'lastChild','previousSibling',startFromChild,filterFn,guard);},isBookmarkNode:function isBookmarkNode(node){return node.nodeType==1&&node.id&&/^_baidu_bookmark_/i.test(node.id);},getWindow:function getWindow(node){var doc=node.ownerDocument||node;return doc.defaultView||doc.parentWindow;},getCommonAncestor:function getCommonAncestor(nodeA,nodeB){if(nodeA===nodeB)return nodeA;var parentsA=[nodeA],parentsB=[nodeB],parent=nodeA,i=-1;while(parent=parent.parentNode){if(parent===nodeB){return parent;}parentsA.push(parent);}parent=nodeB;while(parent=parent.parentNode){if(parent===nodeA)return parent;parentsB.push(parent);}parentsA.reverse();parentsB.reverse();while(i++,parentsA[i]===parentsB[i]){}return i==0?null:parentsA[i-1];},clearEmptySibling:function clearEmptySibling(node,ignoreNext,ignorePre){function clear(next,dir){var tmpNode;while(next&&!domUtils.isBookmarkNode(next)&&(domUtils.isEmptyInlineElement(next)||!new RegExp('[^\t\n\r'+domUtils.fillChar+']').test(next.nodeValue))){tmpNode=next[dir];domUtils.remove(next);next=tmpNode;}}!ignoreNext&&clear(node.nextSibling,'nextSibling');!ignorePre&&clear(node.previousSibling,'previousSibling');},split:function split(node,offset){var doc=node.ownerDocument;if(browser.ie&&offset==node.nodeValue.length){var next=doc.createTextNode('');return domUtils.insertAfter(node,next);}var retval=node.splitText(offset);if(browser.ie8){var tmpNode=doc.createTextNode('');domUtils.insertAfter(retval,tmpNode);domUtils.remove(tmpNode);}return retval;},isWhitespace:function isWhitespace(node){return!new RegExp('[^ \t\n\r'+domUtils.fillChar+']').test(node.nodeValue);},getXY:function getXY(element){var x=0,y=0;while(element.offsetParent){y+=element.offsetTop;x+=element.offsetLeft;element=element.offsetParent;}return{'x':x,'y':y};},on:function on(element,type,handler){var types=utils.isArray(type)?type:utils.trim(type).split(/\s+/),k=types.length;if(k)while(k--){type=types[k];if(element.addEventListener){element.addEventListener(type,handler,false);}else{if(!handler._d){handler._d={els:[]};}var key=type+handler.toString(),index=utils.indexOf(handler._d.els,element);if(!handler._d[key]||index==-1){if(index==-1){handler._d.els.push(element);}if(!handler._d[key]){handler._d[key]=function(evt){return handler.call(evt.srcElement,evt||window.event);};}element.attachEvent('on'+type,handler._d[key]);}}}element=null;},un:function un(element,type,handler){var types=utils.isArray(type)?type:utils.trim(type).split(/\s+/),k=types.length;if(k)while(k--){type=types[k];if(element.removeEventListener){element.removeEventListener(type,handler,false);}else{var key=type+handler.toString();try{element.detachEvent('on'+type,handler._d?handler._d[key]:handler);}catch(e){}if(handler._d&&handler._d[key]){var index=utils.indexOf(handler._d.els,element);if(index!=-1){handler._d.els.splice(index,1);}handler._d.els.length==0&&delete handler._d[key];}}}},isSameElement:function isSameElement(nodeA,nodeB){if(nodeA.tagName!=nodeB.tagName){return false;}var thisAttrs=nodeA.attributes,otherAttrs=nodeB.attributes;if(!ie&&thisAttrs.length!=otherAttrs.length){return false;}var attrA,attrB,al=0,bl=0;for(var i=0;attrA=thisAttrs[i++];){if(attrA.nodeName=='style'){if(attrA.specified){al++;}if(domUtils.isSameStyle(nodeA,nodeB)){continue;}else{return false;}}if(ie){if(attrA.specified){al++;attrB=otherAttrs.getNamedItem(attrA.nodeName);}else{continue;}}else{attrB=nodeB.attributes[attrA.nodeName];}if(!attrB.specified||attrA.nodeValue!=attrB.nodeValue){return false;}}
if(ie){for(i=0;attrB=otherAttrs[i++];){if(attrB.specified){bl++;}}if(al!=bl){return false;}}return true;},isSameStyle:function isSameStyle(nodeA,nodeB){var styleA=nodeA.style.cssText.replace(/( ?; ?)/g,';').replace(/( ?: ?)/g,':'),styleB=nodeB.style.cssText.replace(/( ?; ?)/g,';').replace(/( ?: ?)/g,':');if(browser.opera){styleA=nodeA.style;styleB=nodeB.style;if(styleA.length!=styleB.length)return false;for(var p in styleA){if(/^(\d+|csstext)$/i.test(p)){continue;}if(styleA[p]!=styleB[p]){return false;}}return true;}if(!styleA||!styleB){return styleA==styleB;}styleA=styleA.split(';');styleB=styleB.split(';');if(styleA.length!=styleB.length){return false;}for(var i=0,ci;ci=styleA[i++];){if(utils.indexOf(styleB,ci)==-1){return false;}}return true;},isBlockElm:function isBlockElm(node){return node.nodeType==1&&(dtd.$block[node.tagName]||styleBlock[domUtils.getComputedStyle(node,'display')])&&!dtd.$nonChild[node.tagName];},isBody:function isBody(node){return node&&node.nodeType==1&&node.tagName.toLowerCase()=='body';},breakParent:function breakParent(node,parent){var tmpNode,parentClone=node,clone=node,leftNodes,rightNodes;do{parentClone=parentClone.parentNode;if(leftNodes){tmpNode=parentClone.cloneNode(false);tmpNode.appendChild(leftNodes);leftNodes=tmpNode;tmpNode=parentClone.cloneNode(false);tmpNode.appendChild(rightNodes);rightNodes=tmpNode;}else{leftNodes=parentClone.cloneNode(false);rightNodes=leftNodes.cloneNode(false);}while(tmpNode=clone.previousSibling){leftNodes.insertBefore(tmpNode,leftNodes.firstChild);}while(tmpNode=clone.nextSibling){rightNodes.appendChild(tmpNode);}clone=parentClone;}while(parent!==parentClone);tmpNode=parent.parentNode;tmpNode.insertBefore(leftNodes,parent);tmpNode.insertBefore(rightNodes,parent);tmpNode.insertBefore(node,rightNodes);domUtils.remove(parent);return node;},isEmptyInlineElement:function isEmptyInlineElement(node){if(node.nodeType!=1||!dtd.$removeEmpty[node.tagName]){return 0;}node=node.firstChild;while(node){if(domUtils.isBookmarkNode(node)){return 0;}if(node.nodeType==1&&!domUtils.isEmptyInlineElement(node)||node.nodeType==3&&!domUtils.isWhitespace(node)){return 0;}node=node.nextSibling;}return 1;},trimWhiteTextNode:function trimWhiteTextNode(node){function remove(dir){var child;while((child=node[dir])&&child.nodeType==3&&domUtils.isWhitespace(child)){node.removeChild(child);}}remove('firstChild');remove('lastChild');},mergeChild:function mergeChild(node,tagName,attrs){var list=domUtils.getElementsByTagName(node,node.tagName.toLowerCase());for(var i=0,ci;ci=list[i++];){if(!ci.parentNode||domUtils.isBookmarkNode(ci)){continue;}
if(ci.tagName.toLowerCase()=='span'){if(node===ci.parentNode){domUtils.trimWhiteTextNode(node);if(node.childNodes.length==1){node.style.cssText=ci.style.cssText+";"+node.style.cssText;domUtils.remove(ci,true);continue;}}ci.style.cssText=node.style.cssText+';'+ci.style.cssText;if(attrs){var style=attrs.style;if(style){style=style.split(';');for(var j=0,s;s=style[j++];){ci.style[utils.cssStyleToDomStyle(s.split(':')[0])]=s.split(':')[1];}}}if(domUtils.isSameStyle(ci,node)){domUtils.remove(ci,true);}continue;}if(domUtils.isSameElement(node,ci)){domUtils.remove(ci,true);}}},getElementsByTagName:function getElementsByTagName(node,name,filter){if(filter&&utils.isString(filter)){var className=filter;filter=function filter(node){return domUtils.hasClass(node,className);};}name=utils.trim(name).replace(/[ ]{2,}/g,' ').split(' ');var arr=[];for(var n=0,ni;ni=name[n++];){var list=node.getElementsByTagName(ni);for(var i=0,ci;ci=list[i++];){if(!filter||filter(ci))arr.push(ci);}}return arr;},mergeToParent:function mergeToParent(node){var parent=node.parentNode;while(parent&&dtd.$removeEmpty[parent.tagName]){if(parent.tagName==node.tagName||parent.tagName=='A'){domUtils.trimWhiteTextNode(parent);if(parent.tagName=='SPAN'&&!domUtils.isSameStyle(parent,node)||parent.tagName=='A'&&node.tagName=='SPAN'){if(parent.childNodes.length>1||parent!==node.parentNode){node.style.cssText=parent.style.cssText+";"+node.style.cssText;parent=parent.parentNode;continue;}else{parent.style.cssText+=";"+node.style.cssText;if(parent.tagName=='A'){parent.style.textDecoration='underline';}}}if(parent.tagName!='A'){parent===node.parentNode&&domUtils.remove(node,true);break;}}parent=parent.parentNode;}},mergeSibling:function mergeSibling(node,ignorePre,ignoreNext){function merge(rtl,start,node){var next;if((next=node[rtl])&&!domUtils.isBookmarkNode(next)&&next.nodeType==1&&domUtils.isSameElement(node,next)){while(next.firstChild){if(start=='firstChild'){node.insertBefore(next.lastChild,node.firstChild);}else{node.appendChild(next.firstChild);}}domUtils.remove(next);}}!ignorePre&&merge('previousSibling','firstChild',node);!ignoreNext&&merge('nextSibling','lastChild',node);},unSelectable:ie&&browser.ie9below||browser.opera?function(node){node.onselectstart=function(){return false;};node.onclick=node.onkeyup=node.onkeydown=function(){return false;};node.unselectable='on';node.setAttribute("unselectable","on");for(var i=0,ci;ci=node.all[i++];){switch(ci.tagName.toLowerCase()){case'iframe':case'textarea':case'input':case'select':break;default:ci.unselectable='on';node.setAttribute("unselectable","on");}}}:function(node){node.style.MozUserSelect=node.style.webkitUserSelect=node.style.msUserSelect=node.style.KhtmlUserSelect='none';},removeAttributes:function removeAttributes(node,attrNames){attrNames=utils.isArray(attrNames)?attrNames:utils.trim(attrNames).replace(/[ ]{2,}/g,' ').split(' ');for(var i=0,ci;ci=attrNames[i++];){ci=attrFix[ci]||ci;switch(ci){case'className':node[ci]='';break;case'style':node.style.cssText='';var val=node.getAttributeNode('style');!browser.ie&&val&&node.removeAttributeNode(val);}node.removeAttribute(ci);}},createElement:function createElement(doc,tag,attrs){return domUtils.setAttributes(doc.createElement(tag),attrs);},setAttributes:function setAttributes(node,attrs){for(var attr in attrs){if(attrs.hasOwnProperty(attr)){var value=attrs[attr];switch(attr){case'class':node.className=value;break;case'style':node.style.cssText=node.style.cssText+";"+value;break;case'innerHTML':node[attr]=value;break;case'value':node.value=value;break;default:node.setAttribute(attrFix[attr]||attr,value);}}}return node;},getComputedStyle:function getComputedStyle(element,styleName){var pros='width height top left';if(pros.indexOf(styleName)>-1){return element['offset'+styleName.replace(/^\w/,function(s){return s.toUpperCase();})]+'px';}
if(element.nodeType==3){element=element.parentNode;}
if(browser.ie&&browser.version<9&&styleName=='font-size'&&!element.style.fontSize&&!dtd.$empty[element.tagName]&&!dtd.$nonChild[element.tagName]){var span=element.ownerDocument.createElement('span');span.style.cssText='padding:0;border:0;font-family:simsun;';span.innerHTML='.';element.appendChild(span);var result=span.offsetHeight;element.removeChild(span);span=null;return result+'px';}try{var value=domUtils.getStyle(element,styleName)||(window.getComputedStyle?domUtils.getWindow(element).getComputedStyle(element,'').getPropertyValue(styleName):(element.currentStyle||element.style)[utils.cssStyleToDomStyle(styleName)]);}catch(e){return"";}return utils.transUnitToPx(utils.fixColor(styleName,value));},removeClasses:function removeClasses(elm,classNames){classNames=utils.isArray(classNames)?classNames:utils.trim(classNames).replace(/[ ]{2,}/g,' ').split(' ');for(var i=0,ci,cls=elm.className;ci=classNames[i++];){cls=cls.replace(new RegExp('\\b'+ci+'\\b'),'');}cls=utils.trim(cls).replace(/[ ]{2,}/g,' ');if(cls){elm.className=cls;}else{domUtils.removeAttributes(elm,['class']);}},addClass:function addClass(elm,classNames){if(!elm)return;classNames=utils.trim(classNames).replace(/[ ]{2,}/g,' ').split(' ');for(var i=0,ci,cls=elm.className;ci=classNames[i++];){if(!new RegExp('\\b'+ci+'\\b').test(cls)){cls+=' '+ci;}}elm.className=utils.trim(cls);},hasClass:function hasClass(element,className){if(utils.isRegExp(className)){return className.test(element.className);}className=utils.trim(className).replace(/[ ]{2,}/g,' ').split(' ');for(var i=0,ci,cls=element.className;ci=className[i++];){if(!new RegExp('\\b'+ci+'\\b','i').test(cls)){return false;}}return i-1==className.length;},preventDefault:function preventDefault(evt){evt.preventDefault?evt.preventDefault():evt.returnValue=false;},removeStyle:function removeStyle(element,name){if(browser.ie){if(name=='color'){name='(^|;)'+name;}element.style.cssText=element.style.cssText.replace(new RegExp(name+'[^:]*:[^;]+;?','ig'),'');}else{if(element.style.removeProperty){element.style.removeProperty(name);}else{element.style.removeAttribute(utils.cssStyleToDomStyle(name));}}if(!element.style.cssText){domUtils.removeAttributes(element,['style']);}},getStyle:function getStyle(element,name){var value=element.style[utils.cssStyleToDomStyle(name)];return utils.fixColor(name,value);},setStyle:function setStyle(element,name,value){element.style[utils.cssStyleToDomStyle(name)]=value;if(!utils.trim(element.style.cssText)){this.removeAttributes(element,'style');}},setStyles:function setStyles(element,styles){for(var name in styles){if(styles.hasOwnProperty(name)){domUtils.setStyle(element,name,styles[name]);}}},removeDirtyAttr:function removeDirtyAttr(node){for(var i=0,ci,nodes=node.getElementsByTagName('*');ci=nodes[i++];){ci.removeAttribute('_moz_dirty');}node.removeAttribute('_moz_dirty');},getChildCount:function getChildCount(node,fn){var count=0,first=node.firstChild;fn=fn||function(){return 1;};while(first){if(fn(first)){count++;}first=first.nextSibling;}return count;},isEmptyNode:function isEmptyNode(node){return!node.firstChild||domUtils.getChildCount(node,function(node){return!domUtils.isBr(node)&&!domUtils.isBookmarkNode(node)&&!domUtils.isWhitespace(node);})==0;},clearSelectedArr:function clearSelectedArr(nodes){var node;while(node=nodes.pop()){domUtils.removeAttributes(node,['class']);}},scrollToView:function scrollToView(node,win,offsetTop){var getViewPaneSize=function getViewPaneSize(){var doc=win.document,mode=doc.compatMode=='CSS1Compat';return{width:(mode?doc.documentElement.clientWidth:doc.body.clientWidth)||0,height:(mode?doc.documentElement.clientHeight:doc.body.clientHeight)||0};},getScrollPosition=function getScrollPosition(win){if('pageXOffset'in win){return{x:win.pageXOffset||0,y:win.pageYOffset||0};}else{var doc=win.document;return{x:doc.documentElement.scrollLeft||doc.body.scrollLeft||0,y:doc.documentElement.scrollTop||doc.body.scrollTop||0};}};var winHeight=getViewPaneSize().height,offset=winHeight*-1+offsetTop;offset+=node.offsetHeight||0;var elementPosition=domUtils.getXY(node);offset+=elementPosition.y;var currentScroll=getScrollPosition(win).y;if(offset>currentScroll||offset<currentScroll-winHeight){win.scrollTo(0,offset+(offset<0?-20:20));}},isBr:function isBr(node){return node.nodeType==1&&node.tagName=='BR';},isFillChar:function isFillChar(node,isInStart){if(node.nodeType!=3)return false;var text=node.nodeValue;if(isInStart){return new RegExp('^'+domUtils.fillChar).test(text);}return!text.replace(new RegExp(domUtils.fillChar,'g'),'').length;},isStartInblock:function isStartInblock(range){var tmpRange=range.cloneRange(),flag=0,start=tmpRange.startContainer,tmp;if(start.nodeType==1&&start.childNodes[tmpRange.startOffset]){start=start.childNodes[tmpRange.startOffset];var pre=start.previousSibling;while(pre&&domUtils.isFillChar(pre)){start=pre;pre=pre.previousSibling;}}if(this.isFillChar(start,true)&&tmpRange.startOffset==1){tmpRange.setStartBefore(start);start=tmpRange.startContainer;}while(start&&domUtils.isFillChar(start)){tmp=start;start=start.previousSibling;}if(tmp){tmpRange.setStartBefore(tmp);start=tmpRange.startContainer;}if(start.nodeType==1&&domUtils.isEmptyNode(start)&&tmpRange.startOffset==1){tmpRange.setStart(start,0).collapse(true);}while(!tmpRange.startOffset){start=tmpRange.startContainer;if(domUtils.isBlockElm(start)||domUtils.isBody(start)){flag=1;break;}var pre=tmpRange.startContainer.previousSibling,tmpNode;if(!pre){tmpRange.setStartBefore(tmpRange.startContainer);}else{while(pre&&domUtils.isFillChar(pre)){tmpNode=pre;pre=pre.previousSibling;}if(tmpNode){tmpRange.setStartBefore(tmpNode);}else{tmpRange.setStartBefore(tmpRange.startContainer);}}}return flag&&!domUtils.isBody(tmpRange.startContainer)?1:0;},isEmptyBlock:function isEmptyBlock(node,reg){if(node.nodeType!=1)return 0;reg=reg||new RegExp('[ \xa0\t\r\n'+domUtils.fillChar+']','g');if(node[browser.ie?'innerText':'textContent'].replace(reg,'').length>0){return 0;}for(var n in dtd.$isNotEmpty){if(node.getElementsByTagName(n).length){return 0;}}return 1;},setViewportOffset:function setViewportOffset(element,offset){var left=parseInt(element.style.left)|0;var top=parseInt(element.style.top)|0;var rect=element.getBoundingClientRect();var offsetLeft=offset.left-rect.left;var offsetTop=offset.top-rect.top;if(offsetLeft){element.style.left=left+offsetLeft+'px';}if(offsetTop){element.style.top=top+offsetTop+'px';}},fillNode:function fillNode(doc,node){var tmpNode=browser.ie?doc.createTextNode(domUtils.fillChar):doc.createElement('br');node.innerHTML='';node.appendChild(tmpNode);},moveChild:function moveChild(src,tag,dir){while(src.firstChild){if(dir&&tag.firstChild){tag.insertBefore(src.lastChild,tag.firstChild);}else{tag.appendChild(src.firstChild);}}},hasNoAttributes:function hasNoAttributes(node){return browser.ie?/^<\w+\s*?>/.test(node.outerHTML):node.attributes.length==0;},isCustomeNode:function isCustomeNode(node){return node.nodeType==1&&node.getAttribute('_ue_custom_node_');},isTagNode:function isTagNode(node,tagNames){return node.nodeType==1&&new RegExp('\\b'+node.tagName+'\\b','i').test(tagNames);},filterNodeList:function filterNodeList(nodelist,filter,forAll){var results=[];if(!utils.isFunction(filter)){var str=filter;filter=function filter(n){return utils.indexOf(utils.isArray(str)?str:str.split(' '),n.tagName.toLowerCase())!=-1;};}utils.each(nodelist,function(n){filter(n)&&results.push(n);});return results.length==0?null:results.length==1||!forAll?results[0]:results;},isInNodeEndBoundary:function isInNodeEndBoundary(rng,node){var start=rng.startContainer;if(start.nodeType==3&&rng.startOffset!=start.nodeValue.length){return 0;}if(start.nodeType==1&&rng.startOffset!=start.childNodes.length){return 0;}while(start!==node){if(start.nextSibling){return 0;};start=start.parentNode;}return 1;},isBoundaryNode:function isBoundaryNode(node,dir){var tmp;while(!domUtils.isBody(node)){tmp=node;node=node.parentNode;if(tmp!==node[dir]){return false;}}return true;},fillHtml:browser.ie11below?'&nbsp;':'<br/>'};var fillCharReg=new RegExp(domUtils.fillChar,'g');(function(){var guid=0,fillChar=domUtils.fillChar,fillData;function updateCollapse(range){range.collapsed=range.startContainer&&range.endContainer&&range.startContainer===range.endContainer&&range.startOffset==range.endOffset;}function selectOneNode(rng){return!rng.collapsed&&rng.startContainer.nodeType==1&&rng.startContainer===rng.endContainer&&rng.endOffset-rng.startOffset==1;}function setEndPoint(toStart,node,offset,range){if(node.nodeType==1&&(dtd.$empty[node.tagName]||dtd.$nonChild[node.tagName])){offset=domUtils.getNodeIndex(node)+(toStart?0:1);node=node.parentNode;}if(toStart){range.startContainer=node;range.startOffset=offset;if(!range.endContainer){range.collapse(true);}}else{range.endContainer=node;range.endOffset=offset;if(!range.startContainer){range.collapse(false);}}updateCollapse(range);return range;}function execContentsAction(range,action){var start=range.startContainer,end=range.endContainer,startOffset=range.startOffset,endOffset=range.endOffset,doc=range.document,frag=doc.createDocumentFragment(),tmpStart,tmpEnd;if(start.nodeType==1){start=start.childNodes[startOffset]||(tmpStart=start.appendChild(doc.createTextNode('')));}if(end.nodeType==1){end=end.childNodes[endOffset]||(tmpEnd=end.appendChild(doc.createTextNode('')));}if(start===end&&start.nodeType==3){frag.appendChild(doc.createTextNode(start.substringData(startOffset,endOffset-startOffset)));if(action){start.deleteData(startOffset,endOffset-startOffset);range.collapse(true);}return frag;}var current,currentLevel,clone=frag,startParents=domUtils.findParents(start,true),endParents=domUtils.findParents(end,true);for(var i=0;startParents[i]==endParents[i];){i++;}for(var j=i,si;si=startParents[j];j++){current=si.nextSibling;if(si==start){if(!tmpStart){if(range.startContainer.nodeType==3){clone.appendChild(doc.createTextNode(start.nodeValue.slice(startOffset)));if(action){start.deleteData(startOffset,start.nodeValue.length-startOffset);}}else{clone.appendChild(!action?start.cloneNode(true):start);}}}else{currentLevel=si.cloneNode(false);clone.appendChild(currentLevel);}while(current){if(current===end||current===endParents[j]){break;}si=current.nextSibling;clone.appendChild(!action?current.cloneNode(true):current);current=si;}clone=currentLevel;}clone=frag;if(!startParents[i]){clone.appendChild(startParents[i-1].cloneNode(false));clone=clone.firstChild;}for(var j=i,ei;ei=endParents[j];j++){current=ei.previousSibling;if(ei==end){if(!tmpEnd&&range.endContainer.nodeType==3){clone.appendChild(doc.createTextNode(end.substringData(0,endOffset)));if(action){end.deleteData(0,endOffset);}}}else{currentLevel=ei.cloneNode(false);clone.appendChild(currentLevel);}
if(j!=i||!startParents[i]){while(current){if(current===start){break;}ei=current.previousSibling;clone.insertBefore(!action?current.cloneNode(true):current,clone.firstChild);current=ei;}}clone=currentLevel;}if(action){range.setStartBefore(!endParents[i]?endParents[i-1]:!startParents[i]?startParents[i-1]:endParents[i]).collapse(true);}tmpStart&&domUtils.remove(tmpStart);tmpEnd&&domUtils.remove(tmpEnd);return frag;}var Range=dom.Range=function(document){var me=this;me.startContainer=me.startOffset=me.endContainer=me.endOffset=null;me.document=document;me.collapsed=true;};function removeFillData(doc,excludeNode){try{if(fillData&&domUtils.inDoc(fillData,doc)){if(!fillData.nodeValue.replace(fillCharReg,'').length){var tmpNode=fillData.parentNode;domUtils.remove(fillData);while(tmpNode&&domUtils.isEmptyInlineElement(tmpNode)&&(browser.safari?!(domUtils.getPosition(tmpNode,excludeNode)&domUtils.POSITION_CONTAINS):!tmpNode.contains(excludeNode))){fillData=tmpNode.parentNode;domUtils.remove(tmpNode);tmpNode=fillData;}}else{fillData.nodeValue=fillData.nodeValue.replace(fillCharReg,'');}}}catch(e){}}function mergeSibling(node,dir){var tmpNode;node=node[dir];while(node&&domUtils.isFillChar(node)){tmpNode=node[dir];domUtils.remove(node);node=tmpNode;}}Range.prototype={cloneContents:function cloneContents(){return this.collapsed?null:execContentsAction(this,0);},deleteContents:function deleteContents(){var txt;if(!this.collapsed){execContentsAction(this,1);}if(browser.webkit){txt=this.startContainer;if(txt.nodeType==3&&!txt.nodeValue.length){this.setStartBefore(txt).collapse(true);domUtils.remove(txt);}}return this;},extractContents:function extractContents(){return this.collapsed?null:execContentsAction(this,2);},setStart:function setStart(node,offset){return setEndPoint(true,node,offset,this);},setEnd:function setEnd(node,offset){return setEndPoint(false,node,offset,this);},setStartAfter:function setStartAfter(node){return this.setStart(node.parentNode,domUtils.getNodeIndex(node)+1);},setStartBefore:function setStartBefore(node){return this.setStart(node.parentNode,domUtils.getNodeIndex(node));},setEndAfter:function setEndAfter(node){return this.setEnd(node.parentNode,domUtils.getNodeIndex(node)+1);},setEndBefore:function setEndBefore(node){return this.setEnd(node.parentNode,domUtils.getNodeIndex(node));},setStartAtFirst:function setStartAtFirst(node){return this.setStart(node,0);},setStartAtLast:function setStartAtLast(node){return this.setStart(node,node.nodeType==3?node.nodeValue.length:node.childNodes.length);},setEndAtFirst:function setEndAtFirst(node){return this.setEnd(node,0);},setEndAtLast:function setEndAtLast(node){return this.setEnd(node,node.nodeType==3?node.nodeValue.length:node.childNodes.length);},selectNode:function selectNode(node){return this.setStartBefore(node).setEndAfter(node);},selectNodeContents:function selectNodeContents(node){return this.setStart(node,0).setEndAtLast(node);},cloneRange:function cloneRange(){var me=this;return new Range(me.document).setStart(me.startContainer,me.startOffset).setEnd(me.endContainer,me.endOffset);},collapse:function collapse(toStart){var me=this;if(toStart){me.endContainer=me.startContainer;me.endOffset=me.startOffset;}else{me.startContainer=me.endContainer;me.startOffset=me.endOffset;}me.collapsed=true;return me;},shrinkBoundary:function shrinkBoundary(ignoreEnd){var me=this,child,collapsed=me.collapsed;function check(node){return node.nodeType==1&&!domUtils.isBookmarkNode(node)&&!dtd.$empty[node.tagName]&&!dtd.$nonChild[node.tagName];}while(me.startContainer.nodeType==1&&(child=me.startContainer.childNodes[me.startOffset])&&check(child)){me.setStart(child,0);}if(collapsed){return me.collapse(true);}if(!ignoreEnd){while(me.endContainer.nodeType==1&&me.endOffset>0&&(child=me.endContainer.childNodes[me.endOffset-1])&&check(child)){me.setEnd(child,child.childNodes.length);}}return me;},getCommonAncestor:function getCommonAncestor(includeSelf,ignoreTextNode){var me=this,start=me.startContainer,end=me.endContainer;if(start===end){if(includeSelf&&selectOneNode(this)){start=start.childNodes[me.startOffset];if(start.nodeType==1)return start;}
return ignoreTextNode&&start.nodeType==3?start.parentNode:start;}return domUtils.getCommonAncestor(start,end);},trimBoundary:function trimBoundary(ignoreEnd){this.txtToElmBoundary();var start=this.startContainer,offset=this.startOffset,collapsed=this.collapsed,end=this.endContainer;if(start.nodeType==3){if(offset==0){this.setStartBefore(start);}else{if(offset>=start.nodeValue.length){this.setStartAfter(start);}else{var textNode=domUtils.split(start,offset);if(start===end){this.setEnd(textNode,this.endOffset-offset);}else if(start.parentNode===end){this.endOffset+=1;}this.setStartBefore(textNode);}}if(collapsed){return this.collapse(true);}}if(!ignoreEnd){offset=this.endOffset;end=this.endContainer;if(end.nodeType==3){if(offset==0){this.setEndBefore(end);}else{offset<end.nodeValue.length&&domUtils.split(end,offset);this.setEndAfter(end);}}}return this;},txtToElmBoundary:function txtToElmBoundary(ignoreCollapsed){function adjust(r,c){var container=r[c+'Container'],offset=r[c+'Offset'];if(container.nodeType==3){if(!offset){r['set'+c.replace(/(\w)/,function(a){return a.toUpperCase();})+'Before'](container);}else if(offset>=container.nodeValue.length){r['set'+c.replace(/(\w)/,function(a){return a.toUpperCase();})+'After'](container);}}}if(ignoreCollapsed||!this.collapsed){adjust(this,'start');adjust(this,'end');}return this;},insertNode:function insertNode(node){var first=node,length=1;if(node.nodeType==11){first=node.firstChild;length=node.childNodes.length;}this.trimBoundary(true);var start=this.startContainer,offset=this.startOffset;var nextNode=start.childNodes[offset];if(nextNode){start.insertBefore(node,nextNode);}else{start.appendChild(node);}if(first.parentNode===this.endContainer){this.endOffset=this.endOffset+length;}return this.setStartBefore(first);},setCursor:function setCursor(toEnd,noFillData){return this.collapse(!toEnd).select(noFillData);},createBookmark:function createBookmark(serialize,same){var endNode,startNode=this.document.createElement('span');startNode.style.cssText='display:none;line-height:0px;';startNode.appendChild(this.document.createTextNode('\u200D'));startNode.id='_baidu_bookmark_start_'+(same?'':guid++);if(!this.collapsed){endNode=startNode.cloneNode(true);endNode.id='_baidu_bookmark_end_'+(same?'':guid++);}this.insertNode(startNode);if(endNode){this.collapse().insertNode(endNode).setEndBefore(endNode);}this.setStartAfter(startNode);return{start:serialize?startNode.id:startNode,end:endNode?serialize?endNode.id:endNode:null,id:serialize};},moveToBookmark:function moveToBookmark(bookmark){var start=bookmark.id?this.document.getElementById(bookmark.start):bookmark.start,end=bookmark.end&&bookmark.id?this.document.getElementById(bookmark.end):bookmark.end;this.setStartBefore(start);domUtils.remove(start);if(end){this.setEndBefore(end);domUtils.remove(end);}else{this.collapse(true);}return this;},enlarge:function enlarge(toBlock,stopFn){var isBody=domUtils.isBody,pre,node,tmp=this.document.createTextNode('');if(toBlock){node=this.startContainer;if(node.nodeType==1){if(node.childNodes[this.startOffset]){pre=node=node.childNodes[this.startOffset];}else{node.appendChild(tmp);pre=node=tmp;}}else{pre=node;}while(1){if(domUtils.isBlockElm(node)){node=pre;while((pre=node.previousSibling)&&!domUtils.isBlockElm(pre)){node=pre;}this.setStartBefore(node);break;}pre=node;node=node.parentNode;}node=this.endContainer;if(node.nodeType==1){if(pre=node.childNodes[this.endOffset]){node.insertBefore(tmp,pre);}else{node.appendChild(tmp);}pre=node=tmp;}else{pre=node;}while(1){if(domUtils.isBlockElm(node)){node=pre;while((pre=node.nextSibling)&&!domUtils.isBlockElm(pre)){node=pre;}this.setEndAfter(node);break;}pre=node;node=node.parentNode;}if(tmp.parentNode===this.endContainer){this.endOffset--;}domUtils.remove(tmp);}
if(!this.collapsed){while(this.startOffset==0){if(stopFn&&stopFn(this.startContainer)){break;}if(isBody(this.startContainer)){break;}this.setStartBefore(this.startContainer);}while(this.endOffset==(this.endContainer.nodeType==1?this.endContainer.childNodes.length:this.endContainer.nodeValue.length)){if(stopFn&&stopFn(this.endContainer)){break;}if(isBody(this.endContainer)){break;}this.setEndAfter(this.endContainer);}}return this;},enlargeToBlockElm:function enlargeToBlockElm(ignoreEnd){while(!domUtils.isBlockElm(this.startContainer)){this.setStartBefore(this.startContainer);}if(!ignoreEnd){while(!domUtils.isBlockElm(this.endContainer)){this.setEndAfter(this.endContainer);}}return this;},adjustmentBoundary:function adjustmentBoundary(){if(!this.collapsed){while(!domUtils.isBody(this.startContainer)&&this.startOffset==this.startContainer[this.startContainer.nodeType==3?'nodeValue':'childNodes'].length&&this.startContainer[this.startContainer.nodeType==3?'nodeValue':'childNodes'].length){this.setStartAfter(this.startContainer);}while(!domUtils.isBody(this.endContainer)&&!this.endOffset&&this.endContainer[this.endContainer.nodeType==3?'nodeValue':'childNodes'].length){this.setEndBefore(this.endContainer);}}return this;},applyInlineStyle:function applyInlineStyle(tagName,attrs,list){if(this.collapsed)return this;this.trimBoundary().enlarge(false,function(node){return node.nodeType==1&&domUtils.isBlockElm(node);}).adjustmentBoundary();var bookmark=this.createBookmark(),end=bookmark.end,filterFn=function filterFn(node){return node.nodeType==1?node.tagName.toLowerCase()!='br':!domUtils.isWhitespace(node);},current=domUtils.getNextDomNode(bookmark.start,false,filterFn),node,pre,range=this.cloneRange();while(current&&domUtils.getPosition(current,end)&domUtils.POSITION_PRECEDING){if(current.nodeType==3||dtd[tagName][current.tagName]){range.setStartBefore(current);node=current;while(node&&(node.nodeType==3||dtd[tagName][node.tagName])&&node!==end){pre=node;node=domUtils.getNextDomNode(node,node.nodeType==1,null,function(parent){return dtd[tagName][parent.tagName];});}var frag=range.setEndAfter(pre).extractContents(),elm;if(list&&list.length>0){var level,top;top=level=list[0].cloneNode(false);for(var i=1,ci;ci=list[i++];){level.appendChild(ci.cloneNode(false));level=level.firstChild;}elm=level;}else{elm=range.document.createElement(tagName);}if(attrs){domUtils.setAttributes(elm,attrs);}elm.appendChild(frag);range.insertNode(list?top:elm);var aNode;if(tagName=='span'&&attrs.style&&/text\-decoration/.test(attrs.style)&&(aNode=domUtils.findParentByTagName(elm,'a',true))){domUtils.setAttributes(aNode,attrs);domUtils.remove(elm,true);elm=aNode;}else{domUtils.mergeSibling(elm);domUtils.clearEmptySibling(elm);}
domUtils.mergeChild(elm,attrs);current=domUtils.getNextDomNode(elm,false,filterFn);domUtils.mergeToParent(elm);if(node===end){break;}}else{current=domUtils.getNextDomNode(current,true,filterFn);}}return this.moveToBookmark(bookmark);},removeInlineStyle:function removeInlineStyle(tagNames){if(this.collapsed)return this;tagNames=utils.isArray(tagNames)?tagNames:[tagNames];this.shrinkBoundary().adjustmentBoundary();var start=this.startContainer,end=this.endContainer;while(1){if(start.nodeType==1){if(utils.indexOf(tagNames,start.tagName.toLowerCase())>-1){break;}if(start.tagName.toLowerCase()=='body'){start=null;break;}}start=start.parentNode;}while(1){if(end.nodeType==1){if(utils.indexOf(tagNames,end.tagName.toLowerCase())>-1){break;}if(end.tagName.toLowerCase()=='body'){end=null;break;}}end=end.parentNode;}var bookmark=this.createBookmark(),frag,tmpRange;if(start){tmpRange=this.cloneRange().setEndBefore(bookmark.start).setStartBefore(start);frag=tmpRange.extractContents();tmpRange.insertNode(frag);domUtils.clearEmptySibling(start,true);start.parentNode.insertBefore(bookmark.start,start);}if(end){tmpRange=this.cloneRange().setStartAfter(bookmark.end).setEndAfter(end);frag=tmpRange.extractContents();tmpRange.insertNode(frag);domUtils.clearEmptySibling(end,false,true);end.parentNode.insertBefore(bookmark.end,end.nextSibling);}var current=domUtils.getNextDomNode(bookmark.start,false,function(node){return node.nodeType==1;}),next;while(current&&current!==bookmark.end){next=domUtils.getNextDomNode(current,true,function(node){return node.nodeType==1;});if(utils.indexOf(tagNames,current.tagName.toLowerCase())>-1){domUtils.remove(current,true);}current=next;}return this.moveToBookmark(bookmark);},getClosedNode:function getClosedNode(){var node;if(!this.collapsed){var range=this.cloneRange().adjustmentBoundary().shrinkBoundary();if(selectOneNode(range)){var child=range.startContainer.childNodes[range.startOffset];if(child&&child.nodeType==1&&(dtd.$empty[child.tagName]||dtd.$nonChild[child.tagName])){node=child;}}}return node;},select:browser.ie?function(noFillData,textRange){var nativeRange;if(!this.collapsed)this.shrinkBoundary();var node=this.getClosedNode();if(node&&!textRange){try{nativeRange=this.document.body.createControlRange();nativeRange.addElement(node);nativeRange.select();}catch(e){}return this;}var bookmark=this.createBookmark(),start=bookmark.start,end;nativeRange=this.document.body.createTextRange();nativeRange.moveToElementText(start);nativeRange.moveStart('character',1);if(!this.collapsed){var nativeRangeEnd=this.document.body.createTextRange();end=bookmark.end;nativeRangeEnd.moveToElementText(end);nativeRange.setEndPoint('EndToEnd',nativeRangeEnd);}else{if(!noFillData&&this.startContainer.nodeType!=3){var tmpText=this.document.createTextNode(fillChar),tmp=this.document.createElement('span');tmp.appendChild(this.document.createTextNode(fillChar));start.parentNode.insertBefore(tmp,start);start.parentNode.insertBefore(tmpText,start);removeFillData(this.document,tmpText);fillData=tmpText;mergeSibling(tmp,'previousSibling');mergeSibling(start,'nextSibling');nativeRange.moveStart('character',-1);nativeRange.collapse(true);}}this.moveToBookmark(bookmark);tmp&&domUtils.remove(tmp);try{nativeRange.select();}catch(e){}return this;}:function(notInsertFillData){function checkOffset(rng){function check(node,offset,dir){if(node.nodeType==3&&node.nodeValue.length<offset){rng[dir+'Offset']=node.nodeValue.length;}}check(rng.startContainer,rng.startOffset,'start');check(rng.endContainer,rng.endOffset,'end');}var win=domUtils.getWindow(this.document),sel=win.getSelection(),txtNode;browser.gecko?this.document.body.focus():win.focus();if(sel){sel.removeAllRanges();if(this.collapsed&&!notInsertFillData){var start=this.startContainer,child=start;if(start.nodeType==1){child=start.childNodes[this.startOffset];}if(!(start.nodeType==3&&this.startOffset)&&(child?!child.previousSibling||child.previousSibling.nodeType!=3:!start.lastChild||start.lastChild.nodeType!=3)){txtNode=this.document.createTextNode(fillChar);this.insertNode(txtNode);removeFillData(this.document,txtNode);mergeSibling(txtNode,'previousSibling');mergeSibling(txtNode,'nextSibling');fillData=txtNode;this.setStart(txtNode,browser.webkit?1:0).collapse(true);}}var nativeRange=this.document.createRange();if(this.collapsed&&browser.opera&&this.startContainer.nodeType==1){var child=this.startContainer.childNodes[this.startOffset];if(!child){child=this.startContainer.lastChild;if(child&&domUtils.isBr(child)){this.setStartBefore(child).collapse(true);}}else{while(child&&domUtils.isBlockElm(child)){if(child.nodeType==1&&child.childNodes[0]){child=child.childNodes[0];}else{break;}}child&&this.setStartBefore(child).collapse(true);}}
checkOffset(this);nativeRange.setStart(this.startContainer,this.startOffset);nativeRange.setEnd(this.endContainer,this.endOffset);sel.addRange(nativeRange);}return this;},scrollToView:function scrollToView(win,offset){win=win?window:domUtils.getWindow(this.document);var me=this,span=me.document.createElement('span');span.innerHTML='&nbsp;';me.cloneRange().insertNode(span);domUtils.scrollToView(span,win,offset);domUtils.remove(span);return me;},inFillChar:function inFillChar(){var start=this.startContainer;if(this.collapsed&&start.nodeType==3&&start.nodeValue.replace(new RegExp('^'+domUtils.fillChar),'').length+1==start.nodeValue.length){return true;}return false;},createAddress:function createAddress(ignoreEnd,ignoreTxt){var addr={},me=this;function getAddress(isStart){var node=isStart?me.startContainer:me.endContainer;var parents=domUtils.findParents(node,true,function(node){return!domUtils.isBody(node);}),addrs=[];for(var i=0,ci;ci=parents[i++];){addrs.push(domUtils.getNodeIndex(ci,ignoreTxt));}var firstIndex=0;if(ignoreTxt){if(node.nodeType==3){var tmpNode=node.previousSibling;while(tmpNode&&tmpNode.nodeType==3){firstIndex+=tmpNode.nodeValue.replace(fillCharReg,'').length;tmpNode=tmpNode.previousSibling;}firstIndex+=isStart?me.startOffset:me.endOffset;}else{node=node.childNodes[isStart?me.startOffset:me.endOffset];if(node){firstIndex=domUtils.getNodeIndex(node,ignoreTxt);}else{node=isStart?me.startContainer:me.endContainer;var first=node.firstChild;while(first){if(domUtils.isFillChar(first)){first=first.nextSibling;continue;}firstIndex++;if(first.nodeType==3){while(first&&first.nodeType==3){first=first.nextSibling;}}else{first=first.nextSibling;}}}}}else{firstIndex=isStart?domUtils.isFillChar(node)?0:me.startOffset:me.endOffset;}if(firstIndex<0){firstIndex=0;}addrs.push(firstIndex);return addrs;}addr.startAddress=getAddress(true);if(!ignoreEnd){addr.endAddress=me.collapsed?[].concat(addr.startAddress):getAddress();}return addr;},moveToAddress:function moveToAddress(addr,ignoreEnd){var me=this;function getNode(address,isStart){var tmpNode=me.document.body,parentNode,offset;for(var i=0,ci,l=address.length;i<l;i++){ci=address[i];parentNode=tmpNode;tmpNode=tmpNode.childNodes[ci];if(!tmpNode){offset=ci;break;}}if(isStart){if(tmpNode){me.setStartBefore(tmpNode);}else{me.setStart(parentNode,offset);}}else{if(tmpNode){me.setEndBefore(tmpNode);}else{me.setEnd(parentNode,offset);}}}getNode(addr.startAddress,true);!ignoreEnd&&addr.endAddress&&getNode(addr.endAddress);return me;},equals:function equals(rng){for(var p in this){if(this.hasOwnProperty(p)){if(this[p]!==rng[p])return false;}}return true;},traversal:function traversal(doFn,filterFn){if(this.collapsed)return this;var bookmark=this.createBookmark(),end=bookmark.end,current=domUtils.getNextDomNode(bookmark.start,false,filterFn);while(current&&current!==end&&domUtils.getPosition(current,end)&domUtils.POSITION_PRECEDING){var tmpNode=domUtils.getNextDomNode(current,false,filterFn);doFn(current);current=tmpNode;}return this.moveToBookmark(bookmark);}};})();(function(){function getBoundaryInformation(range,start){var getIndex=domUtils.getNodeIndex;range=range.duplicate();range.collapse(start);var parent=range.parentElement();if(!parent.hasChildNodes()){return{container:parent,offset:0};}var siblings=parent.children,child,testRange=range.duplicate(),startIndex=0,endIndex=siblings.length-1,index=-1,distance;while(startIndex<=endIndex){index=Math.floor((startIndex+endIndex)/2);child=siblings[index];testRange.moveToElementText(child);var position=testRange.compareEndPoints('StartToStart',range);if(position>0){endIndex=index-1;}else if(position<0){startIndex=index+1;}else{return{container:parent,offset:getIndex(child)};}}if(index==-1){testRange.moveToElementText(parent);testRange.setEndPoint('StartToStart',range);distance=testRange.text.replace(/(\r\n|\r)/g,'\n').length;siblings=parent.childNodes;if(!distance){child=siblings[siblings.length-1];return{container:child,offset:child.nodeValue.length};}var i=siblings.length;while(distance>0){distance-=siblings[--i].nodeValue.length;}return{container:siblings[i],offset:-distance};}testRange.collapse(position>0);testRange.setEndPoint(position>0?'StartToStart':'EndToStart',range);distance=testRange.text.replace(/(\r\n|\r)/g,'\n').length;if(!distance){return dtd.$empty[child.tagName]||dtd.$nonChild[child.tagName]?{container:parent,offset:getIndex(child)+(position>0?0:1)}:{container:child,offset:position>0?0:child.childNodes.length};}while(distance>0){try{var pre=child;child=child[position>0?'previousSibling':'nextSibling'];distance-=child.nodeValue.length;}catch(e){return{container:parent,offset:getIndex(pre)};}}return{container:child,offset:position>0?-distance:child.nodeValue.length+distance};}function transformIERangeToRange(ieRange,range){if(ieRange.item){range.selectNode(ieRange.item(0));}else{var bi=getBoundaryInformation(ieRange,true);range.setStart(bi.container,bi.offset);if(ieRange.compareEndPoints('StartToEnd',ieRange)!=0){bi=getBoundaryInformation(ieRange,false);range.setEnd(bi.container,bi.offset);}}return range;}function _getIERange(sel){var ieRange;try{ieRange=sel.getNative().createRange();}catch(e){return null;}var el=ieRange.item?ieRange.item(0):ieRange.parentElement();if((el.ownerDocument||el)===sel.document){return ieRange;}return null;}var Selection=dom.Selection=function(doc){var me=this,iframe;me.document=doc;if(browser.ie9below){iframe=domUtils.getWindow(doc).frameElement;domUtils.on(iframe,'beforedeactivate',function(){me._bakIERange=me.getIERange();});domUtils.on(iframe,'activate',function(){try{if(!_getIERange(me)&&me._bakIERange){me._bakIERange.select();}}catch(ex){}me._bakIERange=null;});}iframe=doc=null;};Selection.prototype={rangeInBody:function rangeInBody(rng,txtRange){var node=browser.ie9below||txtRange?rng.item?rng.item():rng.parentElement():rng.startContainer;return node===this.document.body||domUtils.inDoc(node,this.document);},getNative:function getNative(){var doc=this.document;try{return!doc?null:browser.ie9below?doc.selection:domUtils.getWindow(doc).getSelection();}catch(e){return null;}},getIERange:function getIERange(){var ieRange=_getIERange(this);if(!ieRange){if(this._bakIERange){return this._bakIERange;}}return ieRange;},cache:function cache(){this.clear();this._cachedRange=this.getRange();this._cachedStartElement=this.getStart();this._cachedStartElementPath=this.getStartElementPath();},getStartElementPath:function getStartElementPath(){if(this._cachedStartElementPath){return this._cachedStartElementPath;}var start=this.getStart();if(start){return domUtils.findParents(start,true,null,true);}return[];},clear:function clear(){this._cachedStartElementPath=this._cachedRange=this._cachedStartElement=null;},isFocus:function isFocus(){try{if(browser.ie9below){var nativeRange=_getIERange(this);return!!(nativeRange&&this.rangeInBody(nativeRange));}else{return!!this.getNative().rangeCount;}}catch(e){return false;}},getRange:function getRange(){var me=this;function optimze(range){var child=me.document.body.firstChild,collapsed=range.collapsed;while(child&&child.firstChild){range.setStart(child,0);child=child.firstChild;}if(!range.startContainer){range.setStart(me.document.body,0);}if(collapsed){range.collapse(true);}}if(me._cachedRange!=null){return this._cachedRange;}var range=new baidu.editor.dom.Range(me.document);if(browser.ie9below){var nativeRange=me.getIERange();if(nativeRange){try{transformIERangeToRange(nativeRange,range);}catch(e){optimze(range);}}else{optimze(range);}}else{var sel=me.getNative();if(sel&&sel.rangeCount){var firstRange=sel.getRangeAt(0);var lastRange=sel.getRangeAt(sel.rangeCount-1);range.setStart(firstRange.startContainer,firstRange.startOffset).setEnd(lastRange.endContainer,lastRange.endOffset);if(range.collapsed&&domUtils.isBody(range.startContainer)&&!range.startOffset){optimze(range);}}else{if(this._bakRange&&domUtils.inDoc(this._bakRange.startContainer,this.document)){return this._bakRange;}optimze(range);}}return this._bakRange=range;},getStart:function getStart(){if(this._cachedStartElement){return this._cachedStartElement;}var range=browser.ie9below?this.getIERange():this.getRange(),tmpRange,start,tmp,parent;if(browser.ie9below){if(!range){return this.document.body.firstChild;}
if(range.item){return range.item(0);}tmpRange=range.duplicate();tmpRange.text.length>0&&tmpRange.moveStart('character',1);tmpRange.collapse(1);start=tmpRange.parentElement();parent=tmp=range.parentElement();while(tmp=tmp.parentNode){if(tmp==start){start=parent;break;}}}else{range.shrinkBoundary();start=range.startContainer;if(start.nodeType==1&&start.hasChildNodes()){start=start.childNodes[Math.min(start.childNodes.length-1,range.startOffset)];}if(start.nodeType==3){return start.parentNode;}}return start;},getText:function getText(){var nativeSel,nativeRange;if(this.isFocus()&&(nativeSel=this.getNative())){nativeRange=browser.ie9below?nativeSel.createRange():nativeSel.getRangeAt(0);return browser.ie9below?nativeRange.text:nativeRange.toString();}return'';},clearRange:function clearRange(){this.getNative()[browser.ie9below?'empty':'removeAllRanges']();}};})();(function(){var uid=0,_selectionChangeTimer;function setValue(form,editor){var textarea;if(editor.textarea){if(utils.isString(editor.textarea)){for(var i=0,ti,tis=domUtils.getElementsByTagName(form,'textarea');ti=tis[i++];){if(ti.id=='ueditor_textarea_'+editor.options.textarea){textarea=ti;break;}}}else{textarea=editor.textarea;}}if(!textarea){form.appendChild(textarea=domUtils.createElement(document,'textarea',{'name':editor.options.textarea,'id':'ueditor_textarea_'+editor.options.textarea,'style':"display:none"}));editor.textarea=textarea;}!textarea.getAttribute('name')&&textarea.setAttribute('name',editor.options.textarea);textarea.value=editor.hasContents()?editor.options.allHtmlEnabled?editor.getAllHtml():editor.getContent(null,null,true):'';}function loadPlugins(me){for(var pi in UE.plugins){UE.plugins[pi].call(me);}}function checkCurLang(I18N){for(var lang in I18N){return lang;}}function langReadied(me){me.langIsReady=true;me.fireEvent("langReady");}var Editor=UE.Editor=function(options){var me=this;me.uid=uid++;EventBase.call(me);me.commands={};me.options=utils.extend(utils.clone(options||{}),UEDITOR_CONFIG,true);me.shortcutkeys={};me.inputRules=[];me.outputRules=[];me.setOpt(Editor.defaultOptions(me));me.loadServerConfig();if(!utils.isEmptyObject(UE.I18N)){me.options.lang=checkCurLang(UE.I18N);UE.plugin.load(me);langReadied(me);}else{utils.loadFile(document,{src:me.options.langPath+me.options.lang+"/"+me.options.lang+".js",tag:"script",type:"text/javascript",defer:"defer"},function(){UE.plugin.load(me);langReadied(me);});}UE.instants['ueditorInstant'+me.uid]=me;};Editor.prototype={registerCommand:function registerCommand(name,obj){this.commands[name]=obj;},ready:function ready(fn){var me=this;if(fn){me.isReady?fn.apply(me):me.addListener('ready',fn);}},setOpt:function setOpt(key,val){var obj={};if(utils.isString(key)){obj[key]=val;}else{obj=key;}utils.extend(this.options,obj,true);},getOpt:function getOpt(key){return this.options[key];},destroy:function destroy(){var me=this;me.fireEvent('destroy');var container=me.container.parentNode;var textarea=me.textarea;if(!textarea){textarea=document.createElement('textarea');container.parentNode.insertBefore(textarea,container);}else{textarea.style.display='';}textarea.style.width=me.iframe.offsetWidth+'px';textarea.style.height=me.iframe.offsetHeight+'px';textarea.value=me.getContent();textarea.id=me.key;container.innerHTML='';domUtils.remove(container);var key=me.key;for(var p in me){if(me.hasOwnProperty(p)){delete this[p];}}UE.delEditor(key);},render:function render(container){var me=this,options=me.options,getStyleValue=function getStyleValue(attr){return parseInt(domUtils.getComputedStyle(container,attr));};if(utils.isString(container)){container=document.getElementById(container);}if(container){if(options.initialFrameWidth){options.minFrameWidth=options.initialFrameWidth;}else{options.minFrameWidth=options.initialFrameWidth=container.offsetWidth;}if(options.initialFrameHeight){options.minFrameHeight=options.initialFrameHeight;}else{options.initialFrameHeight=options.minFrameHeight=container.offsetHeight;}container.style.width=/%$/.test(options.initialFrameWidth)?'100%':options.initialFrameWidth-getStyleValue("padding-left")-getStyleValue("padding-right")+'px';container.style.height=/%$/.test(options.initialFrameHeight)?'100%':options.initialFrameHeight-getStyleValue("padding-top")-getStyleValue("padding-bottom")+'px';container.style.zIndex=options.zIndex;var html=(ie&&browser.version<9?'':'<!DOCTYPE html>')+'<html xmlns=\'http://www.w3.org/1999/xhtml\' class=\'view\' ><head>'+'<style type=\'text/css\'>'+'.view{padding:0;word-wrap:break-word;cursor:text;height:90%;}\n'+'body{margin:8px;font-family:sans-serif;font-size:16px;}'+'p{margin:5px 0;}</style>'+(options.iframeCssUrl?'<link rel=\'stylesheet\' type=\'text/css\' href=\''+utils.unhtml(options.iframeCssUrl)+'\'/>':'')+(options.initialStyle?'<style>'+options.initialStyle+'</style>':'')+'</head><body class=\'view\' ></body>'+'<script type=\'text/javascript\' '+(ie?'defer=\'defer\'':'')+' id=\'_initialScript\'>'+'setTimeout(function(){editor = window.parent.UE.instants[\'ueditorInstant'+me.uid+'\'];editor._setup(document);},0);'+'var _tmpScript = document.getElementById(\'_initialScript\');_tmpScript.parentNode.removeChild(_tmpScript);</script></html>';container.appendChild(domUtils.createElement(document,'iframe',{id:'ueditor_'+me.uid,width:"100%",height:"100%",frameborder:"0",src:'javascript:void(function(){document.open();'+(options.customDomain&&document.domain!=location.hostname?'document.domain="'+document.domain+'";':'')+'document.write("'+html+'");document.close();}())'}));container.style.overflow='hidden';setTimeout(function(){if(/%$/.test(options.initialFrameWidth)){options.minFrameWidth=options.initialFrameWidth=container.offsetWidth;}if(/%$/.test(options.initialFrameHeight)){options.minFrameHeight=options.initialFrameHeight=container.offsetHeight;container.style.height=options.initialFrameHeight+'px';}});}},_setup:function _setup(doc){var me=this,options=me.options;if(ie){doc.body.disabled=true;doc.body.contentEditable=true;doc.body.disabled=false;}else{doc.body.contentEditable=true;}doc.body.spellcheck=false;me.document=doc;me.window=doc.defaultView||doc.parentWindow;me.iframe=me.window.frameElement;me.body=doc.body;me.selection=new dom.Selection(doc);var geckoSel;if(browser.gecko&&(geckoSel=this.selection.getNative())){geckoSel.removeAllRanges();}this._initEvents();for(var form=this.iframe.parentNode;!domUtils.isBody(form);form=form.parentNode){if(form.tagName=='FORM'){me.form=form;if(me.options.autoSyncData){domUtils.on(me.window,'blur',function(){setValue(form,me);});}else{domUtils.on(form,'submit',function(){setValue(this,me);});}break;}}if(options.initialContent){if(options.autoClearinitialContent){var oldExecCommand=me.execCommand;me.execCommand=function(){me.fireEvent('firstBeforeExecCommand');return oldExecCommand.apply(me,arguments);};this._setDefaultContent(options.initialContent);}else this.setContent(options.initialContent,false,true);}
if(domUtils.isEmptyNode(me.body)){me.body.innerHTML='<p>'+(browser.ie?'':'<br/>')+'</p>';}
if(options.focus){setTimeout(function(){me.focus(me.options.focusInEnd);!me.options.autoClearinitialContent&&me._selectionChange();},0);}if(!me.container){me.container=this.iframe.parentNode;}if(options.fullscreen&&me.ui){me.ui.setFullScreen(true);}try{me.document.execCommand('2D-position',false,false);}catch(e){}try{me.document.execCommand('enableInlineTableEditing',false,false);}catch(e){}try{me.document.execCommand('enableObjectResizing',false,false);}catch(e){}
me._bindshortcutKeys();me.isReady=1;me.fireEvent('ready');options.onready&&options.onready.call(me);if(!browser.ie9below){domUtils.on(me.window,['blur','focus'],function(e){if(e.type=='blur'){me._bakRange=me.selection.getRange();try{me._bakNativeRange=me.selection.getNative().getRangeAt(0);me.selection.getNative().removeAllRanges();}catch(e){me._bakNativeRange=null;}}else{try{me._bakRange&&me._bakRange.select();}catch(e){}}});}
if(browser.gecko&&browser.version<=10902){me.body.contentEditable=false;setTimeout(function(){me.body.contentEditable=true;},100);setInterval(function(){me.body.style.height=me.iframe.offsetHeight-20+'px';},100);}!options.isShow&&me.setHide();options.readonly&&me.setDisabled();},sync:function sync(formId){var me=this,form=formId?document.getElementById(formId):domUtils.findParent(me.iframe.parentNode,function(node){return node.tagName=='FORM';},true);form&&setValue(form,me);},setHeight:function setHeight(height,notSetHeight){if(height!==parseInt(this.iframe.parentNode.style.height)){this.iframe.parentNode.style.height=height+'px';}!notSetHeight&&(this.options.minFrameHeight=this.options.initialFrameHeight=height);this.body.style.height=height+'px';!notSetHeight&&this.trigger('setHeight');},addshortcutkey:function addshortcutkey(cmd,keys){var obj={};if(keys){obj[cmd]=keys;}else{obj=cmd;}utils.extend(this.shortcutkeys,obj);},_bindshortcutKeys:function _bindshortcutKeys(){var me=this,shortcutkeys=this.shortcutkeys;me.addListener('keydown',function(type,e){var keyCode=e.keyCode||e.which;for(var i in shortcutkeys){var tmp=shortcutkeys[i].split(',');for(var t=0,ti;ti=tmp[t++];){ti=ti.split(':');var key=ti[0],param=ti[1];if(/^(ctrl)(\+shift)?\+(\d+)$/.test(key.toLowerCase())||/^(\d+)$/.test(key)){if((RegExp.$1=='ctrl'?e.ctrlKey||e.metaKey:0)&&(RegExp.$2!=""?e[RegExp.$2.slice(1)+"Key"]:1)&&keyCode==RegExp.$3||keyCode==RegExp.$1){if(me.queryCommandState(i,param)!=-1)me.execCommand(i,param);domUtils.preventDefault(e);}}}}});},getContent:function getContent(cmd,fn,notSetCursor,ignoreBlank,formatter){var me=this;if(cmd&&utils.isFunction(cmd)){fn=cmd;cmd='';}if(fn?!fn():!this.hasContents()){return'';}me.fireEvent('beforegetcontent');var root=UE.htmlparser(me.body.innerHTML,ignoreBlank);me.filterOutputRule(root);me.fireEvent('aftergetcontent',cmd,root);return root.toHtml(formatter);},getAllHtml:function getAllHtml(){var me=this,headHtml=[],html='';me.fireEvent('getAllHtml',headHtml);if(browser.ie&&browser.version>8){var headHtmlForIE9='';utils.each(me.document.styleSheets,function(si){headHtmlForIE9+=si.href?'<link rel="stylesheet" type="text/css" href="'+si.href+'" />':'<style>'+si.cssText+'</style>';});utils.each(me.document.getElementsByTagName('script'),function(si){headHtmlForIE9+=si.outerHTML;});}return'<html><head>'+(me.options.charset?'<meta http-equiv="Content-Type" content="text/html; charset='+me.options.charset+'"/>':'')+(headHtmlForIE9||me.document.getElementsByTagName('head')[0].innerHTML)+headHtml.join('\n')+'</head>'+'<body '+(ie&&browser.version<9?'class="view"':'')+'>'+me.getContent(null,null,true)+'</body></html>';},getPlainTxt:function getPlainTxt(){var reg=new RegExp(domUtils.fillChar,'g'),html=this.body.innerHTML.replace(/[\n\r]/g,'');html=html.replace(/<(p|div)[^>]*>(<br\/?>|&nbsp;)<\/\1>/gi,'\n').replace(/<br\/?>/gi,'\n').replace(/<[^>/]+>/g,'').replace(/(\n)?<\/([^>]+)>/g,function(a,b,c){return dtd.$block[c]?'\n':b?b:'';});return html.replace(reg,'').replace(/\u00a0/g,' ').replace(/&nbsp;/g,' ');},getContentTxt:function getContentTxt(){var reg=new RegExp(domUtils.fillChar,'g');return this.body[browser.ie?'innerText':'textContent'].replace(reg,'').replace(/\u00a0/g,' ');},setContent:function setContent(html,isAppendTo,notFireSelectionchange){var me=this;me.fireEvent('beforesetcontent',html);var root=UE.htmlparser(html);me.filterInputRule(root);html=root.toHtml();me.body.innerHTML=(isAppendTo?me.body.innerHTML:'')+html;function isCdataDiv(node){return node.tagName=='DIV'&&node.getAttribute('cdata_tag');}
if(me.options.enterTag=='p'){var child=this.body.firstChild,tmpNode;if(!child||child.nodeType==1&&(dtd.$cdata[child.tagName]||isCdataDiv(child)||domUtils.isCustomeNode(child))&&child===this.body.lastChild){this.body.innerHTML='<p>'+(browser.ie?'&nbsp;':'<br/>')+'</p>'+this.body.innerHTML;}else{var p=me.document.createElement('p');while(child){while(child&&(child.nodeType==3||child.nodeType==1&&dtd.p[child.tagName]&&!dtd.$cdata[child.tagName])){tmpNode=child.nextSibling;p.appendChild(child);child=tmpNode;}if(p.firstChild){if(!child){me.body.appendChild(p);break;}else{child.parentNode.insertBefore(p,child);p=me.document.createElement('p');}}child=child.nextSibling;}}}me.fireEvent('aftersetcontent');me.fireEvent('contentchange');!notFireSelectionchange&&me._selectionChange();me._bakRange=me._bakIERange=me._bakNativeRange=null;var geckoSel;if(browser.gecko&&(geckoSel=this.selection.getNative())){geckoSel.removeAllRanges();}if(me.options.autoSyncData){me.form&&setValue(me.form,me);}},focus:function focus(toEnd){try{var me=this,rng=me.selection.getRange();if(toEnd){var node=me.body.lastChild;if(node&&node.nodeType==1&&!dtd.$empty[node.tagName]){if(domUtils.isEmptyBlock(node)){rng.setStartAtFirst(node);}else{rng.setStartAtLast(node);}rng.collapse(true);}rng.setCursor(true);}else{if(!rng.collapsed&&domUtils.isBody(rng.startContainer)&&rng.startOffset==0){var node=me.body.firstChild;if(node&&node.nodeType==1&&!dtd.$empty[node.tagName]){rng.setStartAtFirst(node).collapse(true);}}rng.select(true);}this.fireEvent('focus selectionchange');}catch(e){}},isFocus:function isFocus(){return this.selection.isFocus();},blur:function blur(){var sel=this.selection.getNative();if(sel.empty&&browser.ie){var nativeRng=document.body.createTextRange();nativeRng.moveToElementText(document.body);nativeRng.collapse(true);nativeRng.select();sel.empty();}else{sel.removeAllRanges();}},_initEvents:function _initEvents(){var me=this,doc=me.document,win=me.window;me._proxyDomEvent=utils.bind(me._proxyDomEvent,me);domUtils.on(doc,['click','contextmenu','mousedown','keydown','keyup','keypress','mouseup','mouseover','mouseout','selectstart'],me._proxyDomEvent);domUtils.on(win,['focus','blur'],me._proxyDomEvent);domUtils.on(me.body,'drop',function(e){if(browser.gecko&&e.stopPropagation){e.stopPropagation();}me.fireEvent('contentchange');});domUtils.on(doc,['mouseup','keydown'],function(evt){if(evt.type=='keydown'&&(evt.ctrlKey||evt.metaKey||evt.shiftKey||evt.altKey)){return;}if(evt.button==2)return;me._selectionChange(250,evt);});},_proxyDomEvent:function _proxyDomEvent(evt){if(this.fireEvent('before'+evt.type.replace(/^on/,'').toLowerCase())===false){return false;}if(this.fireEvent(evt.type.replace(/^on/,''),evt)===false){return false;}return this.fireEvent('after'+evt.type.replace(/^on/,'').toLowerCase());},_selectionChange:function _selectionChange(delay,evt){var me=this;var hackForMouseUp=false;var mouseX,mouseY;if(browser.ie&&browser.version<9&&evt&&evt.type=='mouseup'){var range=this.selection.getRange();if(!range.collapsed){hackForMouseUp=true;mouseX=evt.clientX;mouseY=evt.clientY;}}clearTimeout(_selectionChangeTimer);_selectionChangeTimer=setTimeout(function(){if(!me.selection||!me.selection.getNative()){return;}
var ieRange;if(hackForMouseUp&&me.selection.getNative().type=='None'){ieRange=me.document.body.createTextRange();try{ieRange.moveToPoint(mouseX,mouseY);}catch(ex){ieRange=null;}}var bakGetIERange;if(ieRange){bakGetIERange=me.selection.getIERange;me.selection.getIERange=function(){return ieRange;};}me.selection.cache();if(bakGetIERange){me.selection.getIERange=bakGetIERange;}if(me.selection._cachedRange&&me.selection._cachedStartElement){me.fireEvent('beforeselectionchange');me.fireEvent('selectionchange',!!evt);me.fireEvent('afterselectionchange');me.selection.clear();}},delay||50);},_callCmdFn:function _callCmdFn(fnName,args){var cmdName=args[0].toLowerCase(),cmd,cmdFn;cmd=this.commands[cmdName]||UE.commands[cmdName];cmdFn=cmd&&cmd[fnName];if((!cmd||!cmdFn)&&fnName=='queryCommandState'){return 0;}else if(cmdFn){return cmdFn.apply(this,args);}},execCommand:function execCommand(cmdName){cmdName=cmdName.toLowerCase();var me=this,result,cmd=me.commands[cmdName]||UE.commands[cmdName];if(!cmd||!cmd.execCommand){return null;}if(!cmd.notNeedUndo&&!me.__hasEnterExecCommand){me.__hasEnterExecCommand=true;if(me.queryCommandState.apply(me,arguments)!=-1){me.fireEvent('saveScene');me.fireEvent.apply(me,['beforeexeccommand',cmdName].concat(arguments));result=this._callCmdFn('execCommand',arguments);me.fireEvent.apply(me,['afterexeccommand',cmdName].concat(arguments));me.fireEvent('saveScene');}me.__hasEnterExecCommand=false;}else{result=this._callCmdFn('execCommand',arguments);!me.__hasEnterExecCommand&&!cmd.ignoreContentChange&&!me._ignoreContentChange&&me.fireEvent('contentchange');}!me.__hasEnterExecCommand&&!cmd.ignoreContentChange&&!me._ignoreContentChange&&me._selectionChange();return result;},queryCommandState:function queryCommandState(cmdName){return this._callCmdFn('queryCommandState',arguments);},queryCommandValue:function queryCommandValue(cmdName){return this._callCmdFn('queryCommandValue',arguments);},hasContents:function hasContents(tags){if(tags){for(var i=0,ci;ci=tags[i++];){if(this.document.getElementsByTagName(ci).length>0){return true;}}}if(!domUtils.isEmptyBlock(this.body)){return true;}
tags=['div'];for(i=0;ci=tags[i++];){var nodes=domUtils.getElementsByTagName(this.document,ci);for(var n=0,cn;cn=nodes[n++];){if(domUtils.isCustomeNode(cn)){return true;}}}return false;},reset:function reset(){this.fireEvent('reset');},setEnabled:function setEnabled(){var me=this,range;if(me.body.contentEditable=='false'){me.body.contentEditable=true;range=me.selection.getRange();try{range.moveToBookmark(me.lastBk);delete me.lastBk;}catch(e){range.setStartAtFirst(me.body).collapse(true);}range.select(true);if(me.bkqueryCommandState){me.queryCommandState=me.bkqueryCommandState;delete me.bkqueryCommandState;}if(me.bkqueryCommandValue){me.queryCommandValue=me.bkqueryCommandValue;delete me.bkqueryCommandValue;}me.fireEvent('selectionchange');}},enable:function enable(){return this.setEnabled();},setDisabled:function setDisabled(except){var me=this;except=except?utils.isArray(except)?except:[except]:[];if(me.body.contentEditable=='true'){if(!me.lastBk){me.lastBk=me.selection.getRange().createBookmark(true);}me.body.contentEditable=false;me.bkqueryCommandState=me.queryCommandState;me.bkqueryCommandValue=me.queryCommandValue;me.queryCommandState=function(type){if(utils.indexOf(except,type)!=-1){return me.bkqueryCommandState.apply(me,arguments);}return-1;};me.queryCommandValue=function(type){if(utils.indexOf(except,type)!=-1){return me.bkqueryCommandValue.apply(me,arguments);}return null;};me.fireEvent('selectionchange');}},disable:function disable(except){return this.setDisabled(except);},_setDefaultContent:function(){function clear(){var me=this;if(me.document.getElementById('initContent')){me.body.innerHTML='<p>'+(ie?'':'<br/>')+'</p>';me.removeListener('firstBeforeExecCommand focus',clear);setTimeout(function(){me.focus();me._selectionChange();},0);}}return function(cont){var me=this;me.body.innerHTML='<p id="initContent">'+cont+'</p>';me.addListener('firstBeforeExecCommand focus',clear);};}(),setShow:function setShow(){var me=this,range=me.selection.getRange();if(me.container.style.display=='none'){try{range.moveToBookmark(me.lastBk);delete me.lastBk;}catch(e){range.setStartAtFirst(me.body).collapse(true);}
setTimeout(function(){range.select(true);},100);me.container.style.display='';}},show:function show(){return this.setShow();},setHide:function setHide(){var me=this;if(!me.lastBk){me.lastBk=me.selection.getRange().createBookmark(true);}me.container.style.display='none';},hide:function hide(){return this.setHide();},getLang:function getLang(path){var lang=UE.I18N[this.options.lang];if(!lang){throw Error("not import language file");}path=(path||"").split(".");for(var i=0,ci;ci=path[i++];){lang=lang[ci];if(!lang)break;}return lang;},getContentLength:function getContentLength(ingoneHtml,tagNames){var count=this.getContent(false,false,true).length;if(ingoneHtml){tagNames=(tagNames||[]).concat(['hr','img','iframe']);count=this.getContentTxt().replace(/[\t\r\n]+/g,'').length;for(var i=0,ci;ci=tagNames[i++];){count+=this.document.getElementsByTagName(ci).length;}}return count;},addInputRule:function addInputRule(rule){this.inputRules.push(rule);},filterInputRule:function filterInputRule(root){for(var i=0,ci;ci=this.inputRules[i++];){ci.call(this,root);}},addOutputRule:function addOutputRule(rule){this.outputRules.push(rule);},filterOutputRule:function filterOutputRule(root){for(var i=0,ci;ci=this.outputRules[i++];){ci.call(this,root);}},getActionUrl:function getActionUrl(action){var actionName=this.getOpt(action)||action,imageUrl=this.getOpt('imageUrl'),serverUrl=this.getOpt('serverUrl');if(!serverUrl&&imageUrl){serverUrl=imageUrl.replace(/^(.*[\/]).+([\.].+)$/,'$1controller$2');}if(serverUrl){serverUrl=serverUrl+(serverUrl.indexOf('?')==-1?'?':'&')+'action='+(actionName||'');return utils.formatUrl(serverUrl);}else{return'';}}};utils.inherits(Editor,EventBase);})();UE.Editor.defaultOptions=function(editor){var _url=editor.options.UEDITOR_HOME_URL;return{isShow:true,initialContent:'',initialStyle:'',autoClearinitialContent:false,iframeCssUrl:_url+'themes/iframe.css',textarea:'editorValue',focus:false,focusInEnd:true,autoClearEmptyNode:true,fullscreen:false,readonly:false,zIndex:999,imagePopup:true,enterTag:'p',customDomain:false,lang:'zh-cn',langPath:_url+'lang/',theme:'default',themePath:_url+'themes/',allHtmlEnabled:false,scaleEnabled:false,tableNativeEditInFF:false,autoSyncData:true,fileNameFormat:'{time}{rand:6}'};};(function(){UE.Editor.prototype.loadServerConfig=function(){var me=this;setTimeout(function(){try{me.options.imageUrl&&me.setOpt('serverUrl',me.options.imageUrl.replace(/^(.*[\/]).+([\.].+)$/,'$1controller$2'));var configUrl=me.getActionUrl('config'),isJsonp=utils.isCrossDomainUrl(configUrl);me._serverConfigLoaded=false;configUrl&&UE.ajax.request(configUrl,{'method':'GET','dataType':isJsonp?'jsonp':'','onsuccess':function onsuccess(r){try{var config=isJsonp?r:eval("("+r.responseText+")");utils.extend(me.options,config);me.fireEvent('serverConfigLoaded');me._serverConfigLoaded=true;}catch(e){showErrorMsg(me.getLang('loadconfigFormatError'));}},'onerror':function onerror(){showErrorMsg(me.getLang('loadconfigHttpError'));}});}catch(e){showErrorMsg(me.getLang('loadconfigError'));}});function showErrorMsg(msg){console&&console.error(msg);}};UE.Editor.prototype.isServerConfigLoaded=function(){var me=this;return me._serverConfigLoaded||false;};UE.Editor.prototype.afterConfigReady=function(handler){if(!handler||!utils.isFunction(handler))return;var me=this;var readyHandler=function readyHandler(){handler.apply(me,arguments);me.removeListener('serverConfigLoaded',readyHandler);};if(me.isServerConfigLoaded()){handler.call(me,'serverConfigLoaded');}else{me.addListener('serverConfigLoaded',readyHandler);}};})();UE.ajax=function(){var fnStr='XMLHttpRequest()';try{new ActiveXObject("Msxml2.XMLHTTP");fnStr='ActiveXObject(\'Msxml2.XMLHTTP\')';}catch(e){try{new ActiveXObject("Microsoft.XMLHTTP");fnStr='ActiveXObject(\'Microsoft.XMLHTTP\')';}catch(e){}}var creatAjaxRequest=new Function('return new '+fnStr);function json2str(json){var strArr=[];for(var i in json){if(i=="method"||i=="timeout"||i=="async"||i=="dataType"||i=="callback")continue;if(json[i]==undefined||json[i]==null)continue;if(!(_typeof(json[i]).toLowerCase()=="function"||_typeof(json[i]).toLowerCase()=="object")){strArr.push(encodeURIComponent(i)+"="+encodeURIComponent(json[i]));}else if(utils.isArray(json[i])){for(var j=0;j<json[i].length;j++){strArr.push(encodeURIComponent(i)+"[]="+encodeURIComponent(json[i][j]));}}}return strArr.join("&");}function doAjax(url,ajaxOptions){}function doJsonp(url,opts){var successhandler=opts.onsuccess||function(){},scr=document.createElement('SCRIPT'),options=opts||{},charset=options['charset'],callbackField=options['jsonp']||'callback',callbackFnName,timeOut=options['timeOut']||0,timer,reg=new RegExp('(\\?|&)'+callbackField+'=([^&]*)'),matches;if(utils.isFunction(successhandler)){callbackFnName='bd__editor__'+Math.floor(Math.random()*2147483648).toString(36);window[callbackFnName]=getCallBack(0);}else if(utils.isString(successhandler)){callbackFnName=successhandler;}else{if(matches=reg.exec(url)){callbackFnName=matches[2];}}url=url.replace(reg,'\x241'+callbackField+'='+callbackFnName);if(url.search(reg)<0){url+=(url.indexOf('?')<0?'?':'&')+callbackField+'='+callbackFnName;}var queryStr=json2str(opts);if(!utils.isEmptyObject(opts.data)){queryStr+=(queryStr?"&":"")+json2str(opts.data);}if(queryStr){url=url.replace(/\?/,'?'+queryStr+'&');}scr.onerror=getCallBack(1);if(timeOut){timer=setTimeout(getCallBack(1),timeOut);}createScriptTag(scr,url,charset);function createScriptTag(scr,url,charset){scr.setAttribute('type','text/javascript');scr.setAttribute('defer','defer');charset&&scr.setAttribute('charset',charset);scr.setAttribute('src',url);document.getElementsByTagName('head')[0].appendChild(scr);}function getCallBack(onTimeOut){return function(){try{if(onTimeOut){options.onerror&&options.onerror();}else{try{clearTimeout(timer);successhandler.apply(window,arguments);}catch(e){}}}catch(exception){options.onerror&&options.onerror.call(window,exception);}finally{options.oncomplete&&options.oncomplete.apply(window,arguments);scr.parentNode&&scr.parentNode.removeChild(scr);window[callbackFnName]=null;try{delete window[callbackFnName];}catch(e){}}};}}return{request:function request(url,opts){if(opts&&opts.dataType=='jsonp'){doJsonp(url,opts);}else{doAjax(url,opts);}},getJSONP:function getJSONP(url,data,fn){var opts={'data':data,'oncomplete':fn};doJsonp(url,opts);}};}();var filterWord=UE.filterWord=function(){function isWordDocument(str){return/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument|<(v|o):|lang=)/ig.test(str);}
function transUnit(v){v=v.replace(/[\d.]+\w+/g,function(m){return utils.transUnitToPx(m);});return v;}function filterPasteWord(str){return str.replace(/[\t\r\n]+/g,' ').replace(/<!--[\s\S]*?-->/ig,"").replace(/<v:shape [^>]*>[\s\S]*?.<\/v:shape>/gi,function(str){if(browser.opera){return'';}try{if(/Bitmap/i.test(str)){return'';}var width=str.match(/width:([ \d.]*p[tx])/i)[1],height=str.match(/height:([ \d.]*p[tx])/i)[1],src=str.match(/src=\s*"([^"]*)"/i)[1];return'<img width="'+transUnit(width)+'" height="'+transUnit(height)+'" src="'+src+'" />';}catch(e){return'';}}).replace(/<\/?div[^>]*>/g,'').replace(/v:\w+=(["']?)[^'"]+\1/g,'').replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|xml|meta|link|style|\w+:\w+)(?=[\s\/>]))[^>]*>/gi,"").replace(/<p [^>]*class="?MsoHeading"?[^>]*>(.*?)<\/p>/gi,"<p><strong>$1</strong></p>").replace(/\s+(class|lang|align)\s*=\s*(['"]?)([\w-]+)\2/ig,function(str,name,marks,val){return name=='class'&&val=='MsoListParagraph'?str:'';}).replace(/<(font|span)[^>]*>(\s*)<\/\1>/gi,function(a,b,c){return c.replace(/[\t\r\n ]+/g,' ');}).replace(/(<[a-z][^>]*)\sstyle=(["'])([^\2]*?)\2/gi,function(str,tag,tmp,style){var n=[],s=style.replace(/^\s+|\s+$/,'').replace(/&#39;/g,'\'').replace(/&quot;/gi,"'").replace(/[\d.]+(cm|pt)/g,function(str){return utils.transUnitToPx(str);}).split(/;\s*/g);for(var i=0,v;v=s[i];i++){var name,value,parts=v.split(":");if(parts.length==2){name=parts[0].toLowerCase();value=parts[1].toLowerCase();if(/^(background)\w*/.test(name)&&value.replace(/(initial|\s)/g,'').length==0||/^(margin)\w*/.test(name)&&/^0\w+$/.test(value)){continue;}switch(name){case"mso-padding-alt":case"mso-padding-top-alt":case"mso-padding-right-alt":case"mso-padding-bottom-alt":case"mso-padding-left-alt":case"mso-margin-alt":case"mso-margin-top-alt":case"mso-margin-right-alt":case"mso-margin-bottom-alt":case"mso-margin-left-alt":case"mso-height":case"mso-width":case"mso-vertical-align-alt":if(!/<table/.test(tag))n[i]=name.replace(/^mso-|-alt$/g,"")+":"+transUnit(value);continue;case"horiz-align":n[i]="text-align:"+value;continue;case"vert-align":n[i]="vertical-align:"+value;continue;case"font-color":case"mso-foreground":n[i]="color:"+value;continue;case"mso-background":case"mso-highlight":n[i]="background:"+value;continue;case"mso-default-height":n[i]="min-height:"+transUnit(value);continue;case"mso-default-width":n[i]="min-width:"+transUnit(value);continue;case"mso-padding-between-alt":n[i]="border-collapse:separate;border-spacing:"+transUnit(value);continue;case"text-line-through":if(value=="single"||value=="double"){n[i]="text-decoration:line-through";}continue;case"mso-zero-height":if(value=="yes"){n[i]="display:none";}continue;case'margin':if(!/[1-9]/.test(value)){continue;}}if(/^(mso|column|font-emph|lang|layout|line-break|list-image|nav|panose|punct|row|ruby|sep|size|src|tab-|table-border|text-(?:decor|trans)|top-bar|version|vnd|word-break)/.test(name)||/text\-indent|padding|margin/.test(name)&&/\-[\d.]+/.test(value)){continue;}n[i]=name+":"+parts[1];}}return tag+(n.length?' style="'+n.join(';').replace(/;{2,}/g,';')+'"':'');});}return function(html){return isWordDocument(html)?filterPasteWord(html):html;};}();(function(){var uNode=UE.uNode=function(obj){this.type=obj.type;this.data=obj.data;this.tagName=obj.tagName;this.parentNode=obj.parentNode;this.attrs=obj.attrs||{};this.children=obj.children;};var notTransAttrs={'href':1,'src':1,'_src':1,'_href':1,'cdata_data':1};var notTransTagName={style:1,script:1};var indentChar='    ',breakChar='\n';function insertLine(arr,current,begin){arr.push(breakChar);return current+(begin?1:-1);}function insertIndent(arr,current){for(var i=0;i<current;i++){arr.push(indentChar);}}
uNode.createElement=function(html){if(/[<>]/.test(html)){return UE.htmlparser(html).children[0];}else{return new uNode({type:'element',children:[],tagName:html});}};uNode.createText=function(data,noTrans){return new UE.uNode({type:'text','data':noTrans?data:utils.unhtml(data||'')});};function nodeToHtml(node,arr,formatter,current){switch(node.type){case'root':for(var i=0,ci;ci=node.children[i++];){if(formatter&&ci.type=='element'&&!dtd.$inlineWithA[ci.tagName]&&i>1){insertLine(arr,current,true);insertIndent(arr,current);}nodeToHtml(ci,arr,formatter,current);}break;case'text':isText(node,arr);break;case'element':isElement(node,arr,formatter,current);break;case'comment':isComment(node,arr,formatter);}return arr;}function isText(node,arr){if(node.parentNode.tagName=='pre'){arr.push(node.data);}else{arr.push(notTransTagName[node.parentNode.tagName]?utils.html(node.data):node.data.replace(/[ ]{2}/g,' &nbsp;'));}}function isElement(node,arr,formatter,current){var attrhtml='';if(node.attrs){attrhtml=[];var attrs=node.attrs;for(var a in attrs){attrhtml.push(a+(attrs[a]!==undefined?'="'+(notTransAttrs[a]?utils.html(attrs[a]).replace(/["]/g,function(a){return'&quot;';}):utils.unhtml(attrs[a]))+'"':''));}attrhtml=attrhtml.join(' ');}arr.push('<'+node.tagName+(attrhtml?' '+attrhtml:'')+(dtd.$empty[node.tagName]?'\/':'')+'>');if(formatter&&!dtd.$inlineWithA[node.tagName]&&node.tagName!='pre'){if(node.children&&node.children.length){current=insertLine(arr,current,true);insertIndent(arr,current);}}if(node.children&&node.children.length){for(var i=0,ci;ci=node.children[i++];){if(formatter&&ci.type=='element'&&!dtd.$inlineWithA[ci.tagName]&&i>1){insertLine(arr,current);insertIndent(arr,current);}nodeToHtml(ci,arr,formatter,current);}}if(!dtd.$empty[node.tagName]){if(formatter&&!dtd.$inlineWithA[node.tagName]&&node.tagName!='pre'){if(node.children&&node.children.length){current=insertLine(arr,current);insertIndent(arr,current);}}arr.push('<\/'+node.tagName+'>');}}function isComment(node,arr){arr.push('<!--'+node.data+'-->');}function _getNodeById(root,id){var node;if(root.type=='element'&&root.getAttr('id')==id){return root;}if(root.children&&root.children.length){for(var i=0,ci;ci=root.children[i++];){if(node=_getNodeById(ci,id)){return node;}}}}function _getNodesByTagName(node,tagName,arr){if(node.type=='element'&&node.tagName==tagName){arr.push(node);}if(node.children&&node.children.length){for(var i=0,ci;ci=node.children[i++];){_getNodesByTagName(ci,tagName,arr);}}}function nodeTraversal(root,fn){if(root.children&&root.children.length){for(var i=0,ci;ci=root.children[i];){nodeTraversal(ci,fn);if(ci.parentNode){if(ci.children&&ci.children.length){fn(ci);}if(ci.parentNode)i++;}}}else{fn(root);}}uNode.prototype={toHtml:function toHtml(formatter){var arr=[];nodeToHtml(this,arr,formatter,0);return arr.join('');},innerHTML:function innerHTML(htmlstr){if(this.type!='element'||dtd.$empty[this.tagName]){return this;}if(utils.isString(htmlstr)){if(this.children){for(var i=0,ci;ci=this.children[i++];){ci.parentNode=null;}}this.children=[];var tmpRoot=UE.htmlparser(htmlstr);for(var i=0,ci;ci=tmpRoot.children[i++];){this.children.push(ci);ci.parentNode=this;}return this;}else{var tmpRoot=new UE.uNode({type:'root',children:this.children});return tmpRoot.toHtml();}},innerText:function innerText(textStr,noTrans){if(this.type!='element'||dtd.$empty[this.tagName]){return this;}if(textStr){if(this.children){for(var i=0,ci;ci=this.children[i++];){ci.parentNode=null;}}this.children=[];this.appendChild(uNode.createText(textStr,noTrans));return this;}else{return this.toHtml().replace(/<[^>]+>/g,'');}},getData:function getData(){if(this.type=='element')return'';return this.data;},firstChild:function firstChild(){return this.children?this.children[0]:null;},lastChild:function lastChild(){return this.children?this.children[this.children.length-1]:null;},previousSibling:function previousSibling(){var parent=this.parentNode;for(var i=0,ci;ci=parent.children[i];i++){if(ci===this){return i==0?null:parent.children[i-1];}}},nextSibling:function nextSibling(){var parent=this.parentNode;for(var i=0,ci;ci=parent.children[i++];){if(ci===this){return parent.children[i];}}},replaceChild:function replaceChild(target,source){if(this.children){if(target.parentNode){target.parentNode.removeChild(target);}for(var i=0,ci;ci=this.children[i];i++){if(ci===source){this.children.splice(i,1,target);source.parentNode=null;target.parentNode=this;return target;}}}},appendChild:function appendChild(node){if(this.type=='root'||this.type=='element'&&!dtd.$empty[this.tagName]){if(!this.children){this.children=[];}if(node.parentNode){node.parentNode.removeChild(node);}for(var i=0,ci;ci=this.children[i];i++){if(ci===node){this.children.splice(i,1);break;}}this.children.push(node);node.parentNode=this;return node;}},insertBefore:function insertBefore(target,source){if(this.children){if(target.parentNode){target.parentNode.removeChild(target);}for(var i=0,ci;ci=this.children[i];i++){if(ci===source){this.children.splice(i,0,target);target.parentNode=this;return target;}}}},insertAfter:function insertAfter(target,source){if(this.children){if(target.parentNode){target.parentNode.removeChild(target);}for(var i=0,ci;ci=this.children[i];i++){if(ci===source){this.children.splice(i+1,0,target);target.parentNode=this;return target;}}}},removeChild:function removeChild(node,keepChildren){if(this.children){for(var i=0,ci;ci=this.children[i];i++){if(ci===node){this.children.splice(i,1);ci.parentNode=null;if(keepChildren&&ci.children&&ci.children.length){for(var j=0,cj;cj=ci.children[j];j++){this.children.splice(i+j,0,cj);cj.parentNode=this;}}return ci;}}}},getAttr:function getAttr(attrName){return this.attrs&&this.attrs[attrName.toLowerCase()];},setAttr:function setAttr(attrName,attrVal){if(!attrName){delete this.attrs;return;}if(!this.attrs){this.attrs={};}if(utils.isObject(attrName)){for(var a in attrName){if(!attrName[a]){delete this.attrs[a];}else{this.attrs[a.toLowerCase()]=attrName[a];}}}else{if(!attrVal){delete this.attrs[attrName];}else{this.attrs[attrName.toLowerCase()]=attrVal;}}},getIndex:function getIndex(){var parent=this.parentNode;for(var i=0,ci;ci=parent.children[i];i++){if(ci===this){return i;}}return-1;},getNodeById:function getNodeById(id){var node;if(this.children&&this.children.length){for(var i=0,ci;ci=this.children[i++];){if(node=_getNodeById(ci,id)){return node;}}}},getNodesByTagName:function getNodesByTagName(tagNames){tagNames=utils.trim(tagNames).replace(/[ ]{2,}/g,' ').split(' ');var arr=[],me=this;utils.each(tagNames,function(tagName){if(me.children&&me.children.length){for(var i=0,ci;ci=me.children[i++];){_getNodesByTagName(ci,tagName,arr);}}});return arr;},getStyle:function getStyle(name){var cssStyle=this.getAttr('style');if(!cssStyle){return'';}var reg=new RegExp('(^|;)\\s*'+name+':([^;]+)','i');var match=cssStyle.match(reg);if(match&&match[0]){return match[2];}return'';},setStyle:function setStyle(name,val){function exec(name,val){var reg=new RegExp('(^|;)\\s*'+name+':([^;]+;?)','gi');cssStyle=cssStyle.replace(reg,'$1');if(val){cssStyle=name+':'+utils.unhtml(val)+';'+cssStyle;}}var cssStyle=this.getAttr('style');if(!cssStyle){cssStyle='';}if(utils.isObject(name)){for(var a in name){exec(a,name[a]);}}else{exec(name,val);}this.setAttr('style',utils.trim(cssStyle));},traversal:function traversal(fn){if(this.children&&this.children.length){nodeTraversal(this,fn);}return this;}};})();var htmlparser=UE.htmlparser=function(htmlstr,ignoreBlank){var re_tag=/<(?:(?:\/([^>]+)>)|(?:!--([\S|\s]*?)-->)|(?:([^\s\/<>]+)\s*((?:(?:"[^"]*")|(?:'[^']*')|[^"'<>])*)\/?>))/g,re_attr=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g;var allowEmptyTags={b:1,code:1,i:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,span:1,sub:1,img:1,sup:1,font:1,big:1,small:1,iframe:1,a:1,br:1,pre:1};htmlstr=htmlstr.replace(new RegExp(domUtils.fillChar,'g'),'');if(!ignoreBlank){htmlstr=htmlstr.replace(new RegExp('[\\r\\t\\n'+(ignoreBlank?'':' ')+']*<\/?(\\w+)\\s*(?:[^>]*)>[\\r\\t\\n'+(ignoreBlank?'':' ')+']*','g'),function(a,b){if(b&&allowEmptyTags[b.toLowerCase()]){return a.replace(/(^[\n\r]+)|([\n\r]+$)/g,'');}return a.replace(new RegExp('^[\\r\\n'+(ignoreBlank?'':' ')+']+'),'').replace(new RegExp('[\\r\\n'+(ignoreBlank?'':' ')+']+$'),'');});}var notTransAttrs={'href':1,'src':1};var uNode=UE.uNode,needParentNode={'td':'tr','tr':['tbody','thead','tfoot'],'tbody':'table','th':'tr','thead':'table','tfoot':'table','caption':'table','li':['ul','ol'],'dt':'dl','dd':'dl','option':'select'},needChild={'ol':'li','ul':'li'};function text(parent,data){if(needChild[parent.tagName]){var tmpNode=uNode.createElement(needChild[parent.tagName]);parent.appendChild(tmpNode);tmpNode.appendChild(uNode.createText(data));parent=tmpNode;}else{parent.appendChild(uNode.createText(data));}}function element(parent,tagName,htmlattr){var needParentTag;if(needParentTag=needParentNode[tagName]){var tmpParent=parent,hasParent;while(tmpParent.type!='root'){if(utils.isArray(needParentTag)?utils.indexOf(needParentTag,tmpParent.tagName)!=-1:needParentTag==tmpParent.tagName){parent=tmpParent;hasParent=true;break;}tmpParent=tmpParent.parentNode;}if(!hasParent){parent=element(parent,utils.isArray(needParentTag)?needParentTag[0]:needParentTag);}}
var elm=new uNode({parentNode:parent,type:'element',tagName:tagName.toLowerCase(),children:dtd.$empty[tagName]?null:[]});if(htmlattr){var attrs={},match;while(match=re_attr.exec(htmlattr)){attrs[match[1].toLowerCase()]=notTransAttrs[match[1].toLowerCase()]?match[2]||match[3]||match[4]:utils.unhtml(match[2]||match[3]||match[4]);}elm.attrs=attrs;}
parent.children.push(elm);return dtd.$empty[tagName]?parent:elm;}function comment(parent,data){parent.children.push(new uNode({type:'comment',data:data,parentNode:parent}));}var match,currentIndex=0,nextIndex=0;var root=new uNode({type:'root',children:[]});var currentParent=root;while(match=re_tag.exec(htmlstr)){currentIndex=match.index;try{if(currentIndex>nextIndex){text(currentParent,htmlstr.slice(nextIndex,currentIndex));}if(match[3]){if(dtd.$cdata[currentParent.tagName]){text(currentParent,match[0]);}else{currentParent=element(currentParent,match[3].toLowerCase(),match[4]);}}else if(match[1]){if(currentParent.type!='root'){if(dtd.$cdata[currentParent.tagName]&&!dtd.$cdata[match[1]]){text(currentParent,match[0]);}else{var tmpParent=currentParent;while(currentParent.type=='element'&&currentParent.tagName!=match[1].toLowerCase()){currentParent=currentParent.parentNode;if(currentParent.type=='root'){currentParent=tmpParent;throw'break';}}
currentParent=currentParent.parentNode;}}}else if(match[2]){comment(currentParent,match[2]);}}catch(e){}nextIndex=re_tag.lastIndex;}
if(nextIndex<htmlstr.length){text(currentParent,htmlstr.slice(nextIndex));}return root;};var filterNode=UE.filterNode=function(){function filterNode(node,rules){switch(node.type){case'text':break;case'element':var val;if(val=rules[node.tagName]){if(val==='-'){node.parentNode.removeChild(node);}else if(utils.isFunction(val)){var parentNode=node.parentNode,index=node.getIndex();val(node);if(node.parentNode){if(node.children){for(var i=0,ci;ci=node.children[i];){filterNode(ci,rules);if(ci.parentNode){i++;}}}}else{for(var i=index,ci;ci=parentNode.children[i];){filterNode(ci,rules);if(ci.parentNode){i++;}}}}else{var attrs=val['$'];if(attrs&&node.attrs){var tmpAttrs={},tmpVal;for(var a in attrs){tmpVal=node.getAttr(a);if(a=='style'&&utils.isArray(attrs[a])){var tmpCssStyle=[];utils.each(attrs[a],function(v){var tmp;if(tmp=node.getStyle(v)){tmpCssStyle.push(v+':'+tmp);}});tmpVal=tmpCssStyle.join(';');}if(tmpVal){tmpAttrs[a]=tmpVal;}}node.attrs=tmpAttrs;}if(node.children){for(var i=0,ci;ci=node.children[i];){filterNode(ci,rules);if(ci.parentNode){i++;}}}}}else{if(dtd.$cdata[node.tagName]){node.parentNode.removeChild(node);}else{var parentNode=node.parentNode,index=node.getIndex();node.parentNode.removeChild(node,true);for(var i=index,ci;ci=parentNode.children[i];){filterNode(ci,rules);if(ci.parentNode){i++;}}}}break;case'comment':node.parentNode.removeChild(node);}}return function(root,rules){if(utils.isEmptyObject(rules)){return root;}var val;if(val=rules['-']){utils.each(val.split(' '),function(k){rules[k]='-';});}for(var i=0,ci;ci=root.children[i];){filterNode(ci,rules);if(ci.parentNode){i++;}}return root;};}();UE.plugin=function(){var _plugins={};return{register:function register(pluginName,fn,oldOptionName,afterDisabled){if(oldOptionName&&utils.isFunction(oldOptionName)){afterDisabled=oldOptionName;oldOptionName=null;}_plugins[pluginName]={optionName:oldOptionName||pluginName,execFn:fn,afterDisabled:afterDisabled};},load:function load(editor){utils.each(_plugins,function(plugin){var _export=plugin.execFn.call(editor);if(editor.options[plugin.optionName]!==false){if(_export){utils.each(_export,function(v,k){switch(k.toLowerCase()){case'shortcutkey':editor.addshortcutkey(v);break;case'bindevents':utils.each(v,function(fn,eventName){editor.addListener(eventName,fn);});break;case'bindmultievents':utils.each(utils.isArray(v)?v:[v],function(event){var types=utils.trim(event.type).split(/\s+/);utils.each(types,function(eventName){editor.addListener(eventName,event.handler);});});break;case'commands':utils.each(v,function(execFn,execName){editor.commands[execName]=execFn;});break;case'outputrule':editor.addOutputRule(v);break;case'inputrule':editor.addInputRule(v);break;case'defaultoptions':editor.setOpt(v);}});}}else if(plugin.afterDisabled){plugin.afterDisabled.call(editor);}});utils.each(UE.plugins,function(plugin){plugin.call(editor);});},run:function run(pluginName,editor){var plugin=_plugins[pluginName];if(plugin){plugin.exeFn.call(editor);}}};}();var keymap=UE.keymap={'Backspace':8,'Tab':9,'Enter':13,'Shift':16,'Control':17,'Alt':18,'CapsLock':20,'Esc':27,'Spacebar':32,'PageUp':33,'PageDown':34,'End':35,'Home':36,'Left':37,'Up':38,'Right':39,'Down':40,'Insert':45,'Del':46,'NumLock':144,'Cmd':91,'=':187,'-':189,"b":66,'i':73,'z':90,'y':89,'v':86,'x':88,'s':83,'n':78};var LocalStorage=UE.LocalStorage=function(){var storage=window.localStorage||getUserData()||null,LOCAL_FILE='localStorage';return{saveLocalData:function saveLocalData(key,data){if(storage&&data){storage.setItem(key,data);return true;}return false;},getLocalData:function getLocalData(key){if(storage){return storage.getItem(key);}return null;},removeItem:function removeItem(key){storage&&storage.removeItem(key);}};function getUserData(){var container=document.createElement("div");container.style.display="none";if(!container.addBehavior){return null;}container.addBehavior("#default#userdata");return{getItem:function getItem(key){var result=null;try{document.body.appendChild(container);container.load(LOCAL_FILE);result=container.getAttribute(key);document.body.removeChild(container);}catch(e){}return result;},setItem:function setItem(key,value){document.body.appendChild(container);container.setAttribute(key,value);container.save(LOCAL_FILE);document.body.removeChild(container);},removeItem:function removeItem(key){document.body.appendChild(container);container.removeAttribute(key);container.save(LOCAL_FILE);document.body.removeChild(container);}};}}();(function(){var ROOTKEY='ueditor_preference';UE.Editor.prototype.setPreferences=function(key,value){var obj={};if(utils.isString(key)){obj[key]=value;}else{obj=key;}var data=LocalStorage.getLocalData(ROOTKEY);if(data&&(data=utils.str2json(data))){utils.extend(data,obj);}else{data=obj;}data&&LocalStorage.saveLocalData(ROOTKEY,utils.json2str(data));};UE.Editor.prototype.getPreferences=function(key){var data=LocalStorage.getLocalData(ROOTKEY);if(data&&(data=utils.str2json(data))){return key?data[key]:data;}return null;};UE.Editor.prototype.removePreferences=function(key){var data=LocalStorage.getLocalData(ROOTKEY);if(data&&(data=utils.str2json(data))){data[key]=undefined;delete data[key];}data&&LocalStorage.saveLocalData(ROOTKEY,utils.json2str(data));};})();UE.plugins['defaultfilter']=function(){var me=this;me.setOpt({'allowDivTransToP':true,'disabledTableInTable':true});me.addInputRule(function(root){var allowDivTransToP=this.options.allowDivTransToP;var val;function tdParent(node){while(node&&node.type=='element'){if(node.tagName=='td'){return true;}node=node.parentNode;}return false;}
root.traversal(function(node){if(node.type=='element'){if(!dtd.$cdata[node.tagName]&&me.options.autoClearEmptyNode&&dtd.$inline[node.tagName]&&!dtd.$empty[node.tagName]&&(!node.attrs||utils.isEmptyObject(node.attrs))){if(!node.firstChild())node.parentNode.removeChild(node);else if(node.tagName=='span'&&(!node.attrs||utils.isEmptyObject(node.attrs))){node.parentNode.removeChild(node,true);}return;}switch(node.tagName){case'style':case'script':node.setAttr({cdata_tag:node.tagName,cdata_data:node.innerHTML()||'','_ue_custom_node_':'true'});node.tagName='div';node.innerHTML('');break;case'a':if(val=node.getAttr('href')){node.setAttr('_href',val);}break;case'img':if(val=node.getAttr('src')){if(/^data:/.test(val)){node.parentNode.removeChild(node);break;}}node.setAttr('_src',node.getAttr('src'));break;case'span':if(browser.webkit&&(val=node.getStyle('white-space'))){if(/nowrap|normal/.test(val)){node.setStyle('white-space','');if(me.options.autoClearEmptyNode&&utils.isEmptyObject(node.attrs)){node.parentNode.removeChild(node,true);}}}val=node.getAttr('id');if(val&&/^_baidu_bookmark_/i.test(val)){node.parentNode.removeChild(node);}break;case'p':if(val=node.getAttr('align')){node.setAttr('align');node.setStyle('text-align',val);}
utils.each(node.children,function(n){if(n.type=='element'&&n.tagName=='p'){var next=n.nextSibling();node.parentNode.insertAfter(n,node);var last=n;while(next){var tmp=next.nextSibling();node.parentNode.insertAfter(next,last);last=next;next=tmp;}return false;}});if(!node.firstChild()){node.innerHTML(browser.ie?'&nbsp;':'<br/>');}break;case'div':if(node.getAttr('cdata_tag')){break;}
val=node.getAttr('class');if(val&&/^line number\d+/.test(val)){break;}if(!allowDivTransToP){break;}var tmpNode,p=UE.uNode.createElement('p');while(tmpNode=node.firstChild()){if(tmpNode.type=='text'||!UE.dom.dtd.$block[tmpNode.tagName]){p.appendChild(tmpNode);}else{if(p.firstChild()){node.parentNode.insertBefore(p,node);p=UE.uNode.createElement('p');}else{node.parentNode.insertBefore(tmpNode,node);}}}if(p.firstChild()){node.parentNode.insertBefore(p,node);}node.parentNode.removeChild(node);break;case'dl':node.tagName='ul';break;case'dt':case'dd':node.tagName='li';break;case'li':var className=node.getAttr('class');if(!className||!/list\-/.test(className)){node.setAttr();}var tmpNodes=node.getNodesByTagName('ol ul');UE.utils.each(tmpNodes,function(n){node.parentNode.insertAfter(n,node);});break;case'td':case'th':case'caption':if(!node.children||!node.children.length){node.appendChild(browser.ie11below?UE.uNode.createText(' '):UE.uNode.createElement('br'));}break;case'table':if(me.options.disabledTableInTable&&tdParent(node)){node.parentNode.insertBefore(UE.uNode.createText(node.innerText()),node);node.parentNode.removeChild(node);}}}});});me.addOutputRule(function(root){var val;root.traversal(function(node){if(node.type=='element'){if(me.options.autoClearEmptyNode&&dtd.$inline[node.tagName]&&!dtd.$empty[node.tagName]&&(!node.attrs||utils.isEmptyObject(node.attrs))){if(!node.firstChild())node.parentNode.removeChild(node);else if(node.tagName=='span'&&(!node.attrs||utils.isEmptyObject(node.attrs))){node.parentNode.removeChild(node,true);}return;}switch(node.tagName){case'div':if(val=node.getAttr('cdata_tag')){node.tagName=val;node.appendChild(UE.uNode.createText(node.getAttr('cdata_data')));node.setAttr({cdata_tag:'',cdata_data:'','_ue_custom_node_':''});}break;case'a':if(val=node.getAttr('_href')){node.setAttr({'href':utils.html(val),'_href':''});}break;break;case'span':val=node.getAttr('id');if(val&&/^_baidu_bookmark_/i.test(val)){node.parentNode.removeChild(node);}break;case'img':if(val=node.getAttr('_src')){node.setAttr({'src':node.getAttr('_src'),'_src':''});}}}});});};UE.commands['inserthtml']={execCommand:function execCommand(command,html,notNeedFilter){var me=this,range,div;if(!html){return;}if(me.fireEvent('beforeinserthtml',html)===true){return;}range=me.selection.getRange();div=range.document.createElement('div');div.style.display='inline';if(!notNeedFilter){var root=UE.htmlparser(html);if(me.options.filterRules){UE.filterNode(root,me.options.filterRules);}
me.filterInputRule(root);html=root.toHtml();}div.innerHTML=utils.trim(html);if(!range.collapsed){var tmpNode=range.startContainer;if(domUtils.isFillChar(tmpNode)){range.setStartBefore(tmpNode);}tmpNode=range.endContainer;if(domUtils.isFillChar(tmpNode)){range.setEndAfter(tmpNode);}range.txtToElmBoundary();if(range.endContainer&&range.endContainer.nodeType==1){tmpNode=range.endContainer.childNodes[range.endOffset];if(tmpNode&&domUtils.isBr(tmpNode)){range.setEndAfter(tmpNode);}}if(range.startOffset==0){tmpNode=range.startContainer;if(domUtils.isBoundaryNode(tmpNode,'firstChild')){tmpNode=range.endContainer;if(range.endOffset==(tmpNode.nodeType==3?tmpNode.nodeValue.length:tmpNode.childNodes.length)&&domUtils.isBoundaryNode(tmpNode,'lastChild')){me.body.innerHTML='<p>'+(browser.ie?'':'<br/>')+'</p>';range.setStart(me.body.firstChild,0).collapse(true);}}}!range.collapsed&&range.deleteContents();if(range.startContainer.nodeType==1){var child=range.startContainer.childNodes[range.startOffset],pre;if(child&&domUtils.isBlockElm(child)&&(pre=child.previousSibling)&&domUtils.isBlockElm(pre)){range.setEnd(pre,pre.childNodes.length).collapse();while(child.firstChild){pre.appendChild(child.firstChild);}domUtils.remove(child);}}}var child,parent,pre,tmp,hadBreak=0,nextNode;if(range.inFillChar()){child=range.startContainer;if(domUtils.isFillChar(child)){range.setStartBefore(child).collapse(true);domUtils.remove(child);}else if(domUtils.isFillChar(child,true)){child.nodeValue=child.nodeValue.replace(fillCharReg,'');range.startOffset--;range.collapsed&&range.collapse(true);}}
var li=domUtils.findParentByTagName(range.startContainer,'li',true);if(li){var next,last;while(child=div.firstChild){while(child&&(child.nodeType==3||!domUtils.isBlockElm(child)||child.tagName=='HR')){next=child.nextSibling;range.insertNode(child).collapse();last=child;child=next;}if(child){if(/^(ol|ul)$/i.test(child.tagName)){while(child.firstChild){last=child.firstChild;domUtils.insertAfter(li,child.firstChild);li=li.nextSibling;}domUtils.remove(child);}else{var tmpLi;next=child.nextSibling;tmpLi=me.document.createElement('li');domUtils.insertAfter(li,tmpLi);tmpLi.appendChild(child);last=child;child=next;li=tmpLi;}}}li=domUtils.findParentByTagName(range.startContainer,'li',true);if(domUtils.isEmptyBlock(li)){domUtils.remove(li);}if(last){range.setStartAfter(last).collapse(true).select(true);}}else{while(child=div.firstChild){if(hadBreak){var p=me.document.createElement('p');while(child&&(child.nodeType==3||!dtd.$block[child.tagName])){nextNode=child.nextSibling;p.appendChild(child);child=nextNode;}if(p.firstChild){child=p;}}range.insertNode(child);nextNode=child.nextSibling;if(!hadBreak&&child.nodeType==domUtils.NODE_ELEMENT&&domUtils.isBlockElm(child)){parent=domUtils.findParent(child,function(node){return domUtils.isBlockElm(node);});if(parent&&parent.tagName.toLowerCase()!='body'&&!(dtd[parent.tagName][child.nodeName]&&child.parentNode===parent)){if(!dtd[parent.tagName][child.nodeName]){pre=parent;}else{tmp=child.parentNode;while(tmp!==parent){pre=tmp;tmp=tmp.parentNode;}}domUtils.breakParent(child,pre||tmp);var pre=child.previousSibling;domUtils.trimWhiteTextNode(pre);if(!pre.childNodes.length){domUtils.remove(pre);}
if(!browser.ie&&(next=child.nextSibling)&&domUtils.isBlockElm(next)&&next.lastChild&&!domUtils.isBr(next.lastChild)){next.appendChild(me.document.createElement('br'));}hadBreak=1;}}var next=child.nextSibling;if(!div.firstChild&&next&&domUtils.isBlockElm(next)){range.setStart(next,0).collapse(true);break;}range.setEndAfter(child).collapse();}child=range.startContainer;if(nextNode&&domUtils.isBr(nextNode)){domUtils.remove(nextNode);}
if(domUtils.isBlockElm(child)&&domUtils.isEmptyNode(child)){if(nextNode=child.nextSibling){domUtils.remove(child);if(nextNode.nodeType==1&&dtd.$block[nextNode.tagName]){range.setStart(nextNode,0).collapse(true).shrinkBoundary();}}else{try{child.innerHTML=browser.ie?domUtils.fillChar:'<br/>';}catch(e){range.setStartBefore(child);domUtils.remove(child);}}}
try{range.select(true);}catch(e){}}setTimeout(function(){range=me.selection.getRange();range.scrollToView(me.autoHeightEnabled,me.autoHeightEnabled?domUtils.getXY(me.iframe).y:0);me.fireEvent('afterinserthtml',html);},200);}};UE.plugins['autotypeset']=function(){this.setOpt({'autotypeset':{mergeEmptyline:true,removeClass:true,removeEmptyline:false,textAlign:"left",imageBlockLine:'center',pasteFilter:false,clearFontSize:false,clearFontFamily:false,removeEmptyNode:false,removeTagNames:utils.extend({div:1},dtd.$removeEmpty),indent:false,indentValue:'2em',bdc2sb:false,tobdc:false}});var me=this,opt=me.options.autotypeset,remainClass={'selectTdClass':1,'pagebreak':1,'anchorclass':1},remainTag={'li':1},tags={div:1,p:1,blockquote:1,center:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,span:1},highlightCont;if(!opt){return;}readLocalOpts();function isLine(node,notEmpty){if(!node||node.nodeType==3)return 0;if(domUtils.isBr(node))return 1;if(node&&node.parentNode&&tags[node.tagName.toLowerCase()]){if(highlightCont&&highlightCont.contains(node)||node.getAttribute('pagebreak')){return 0;}return notEmpty?!domUtils.isEmptyBlock(node):domUtils.isEmptyBlock(node,new RegExp('[\\s'+domUtils.fillChar+']','g'));}}function removeNotAttributeSpan(node){if(!node.style.cssText){domUtils.removeAttributes(node,['style']);if(node.tagName.toLowerCase()=='span'&&domUtils.hasNoAttributes(node)){domUtils.remove(node,true);}}}function autotype(type,html){var me=this,cont;if(html){if(!opt.pasteFilter){return;}cont=me.document.createElement('div');cont.innerHTML=html.html;}else{cont=me.document.body;}var nodes=domUtils.getElementsByTagName(cont,'*');for(var i=0,ci;ci=nodes[i++];){if(me.fireEvent('excludeNodeinautotype',ci)===true){continue;}
if(opt.clearFontSize&&ci.style.fontSize){domUtils.removeStyle(ci,'font-size');removeNotAttributeSpan(ci);}
if(opt.clearFontFamily&&ci.style.fontFamily){domUtils.removeStyle(ci,'font-family');removeNotAttributeSpan(ci);}if(isLine(ci)){if(opt.mergeEmptyline){var next=ci.nextSibling,tmpNode,isBr=domUtils.isBr(ci);while(isLine(next)){tmpNode=next;next=tmpNode.nextSibling;if(isBr&&(!next||next&&!domUtils.isBr(next))){break;}domUtils.remove(tmpNode);}}
if(opt.removeEmptyline&&domUtils.inDoc(ci,cont)&&!remainTag[ci.parentNode.tagName.toLowerCase()]){if(domUtils.isBr(ci)){next=ci.nextSibling;if(next&&!domUtils.isBr(next)){continue;}}domUtils.remove(ci);continue;}}if(isLine(ci,true)&&ci.tagName!='SPAN'){if(opt.indent){ci.style.textIndent=opt.indentValue;}if(opt.textAlign){ci.style.textAlign=opt.textAlign;}}
if(opt.removeClass&&ci.className&&!remainClass[ci.className.toLowerCase()]){if(highlightCont&&highlightCont.contains(ci)){continue;}domUtils.removeAttributes(ci,['class']);}
if(opt.imageBlockLine&&ci.tagName.toLowerCase()=='img'&&!ci.getAttribute('emotion')){if(html){var img=ci;switch(opt.imageBlockLine){case'left':case'right':case'none':var pN=img.parentNode,tmpNode,pre,next;while(dtd.$inline[pN.tagName]||pN.tagName=='A'){pN=pN.parentNode;}tmpNode=pN;if(tmpNode.tagName=='P'&&domUtils.getStyle(tmpNode,'text-align')=='center'){if(!domUtils.isBody(tmpNode)&&domUtils.getChildCount(tmpNode,function(node){return!domUtils.isBr(node)&&!domUtils.isWhitespace(node);})==1){pre=tmpNode.previousSibling;next=tmpNode.nextSibling;if(pre&&next&&pre.nodeType==1&&next.nodeType==1&&pre.tagName==next.tagName&&domUtils.isBlockElm(pre)){pre.appendChild(tmpNode.firstChild);while(next.firstChild){pre.appendChild(next.firstChild);}domUtils.remove(tmpNode);domUtils.remove(next);}else{domUtils.setStyle(tmpNode,'text-align','');}}}domUtils.setStyle(img,'float',opt.imageBlockLine);break;case'center':if(me.queryCommandValue('imagefloat')!='center'){pN=img.parentNode;domUtils.setStyle(img,'float','none');tmpNode=img;while(pN&&domUtils.getChildCount(pN,function(node){return!domUtils.isBr(node)&&!domUtils.isWhitespace(node);})==1&&(dtd.$inline[pN.tagName]||pN.tagName=='A')){tmpNode=pN;pN=pN.parentNode;}var pNode=me.document.createElement('p');domUtils.setAttributes(pNode,{style:'text-align:center'});tmpNode.parentNode.insertBefore(pNode,tmpNode);pNode.appendChild(tmpNode);domUtils.setStyle(tmpNode,'float','');}}}else{var range=me.selection.getRange();range.selectNode(ci).select();me.execCommand('imagefloat',opt.imageBlockLine);}}
if(opt.removeEmptyNode){if(opt.removeTagNames[ci.tagName.toLowerCase()]&&domUtils.hasNoAttributes(ci)&&domUtils.isEmptyBlock(ci)){domUtils.remove(ci);}}}if(opt.tobdc){var root=UE.htmlparser(cont.innerHTML);root.traversal(function(node){if(node.type=='text'){node.data=ToDBC(node.data);}});cont.innerHTML=root.toHtml();}if(opt.bdc2sb){var root=UE.htmlparser(cont.innerHTML);root.traversal(function(node){if(node.type=='text'){node.data=DBC2SB(node.data);}});cont.innerHTML=root.toHtml();}if(html){html.html=cont.innerHTML;}}if(opt.pasteFilter){me.addListener('beforepaste',autotype);}function DBC2SB(str){var result='';for(var i=0;i<str.length;i++){var code=str.charCodeAt(i);if(code>=65281&&code<=65373)
{result+=String.fromCharCode(str.charCodeAt(i)-65248);}else if(code==12288)
{result+=String.fromCharCode(str.charCodeAt(i)-12288+32);}else{result+=str.charAt(i);}}return result;}function ToDBC(txtstring){txtstring=utils.html(txtstring);var tmp="";var mark="";for(var i=0;i<txtstring.length;i++){if(txtstring.charCodeAt(i)==32){tmp=tmp+String.fromCharCode(12288);}else if(txtstring.charCodeAt(i)<127){tmp=tmp+String.fromCharCode(txtstring.charCodeAt(i)+65248);}else{tmp+=txtstring.charAt(i);}}return tmp;}function readLocalOpts(){var cookieOpt=me.getPreferences('autotypeset');utils.extend(me.options.autotypeset,cookieOpt);}me.commands['autotypeset']={execCommand:function execCommand(){me.removeListener('beforepaste',autotype);if(opt.pasteFilter){me.addListener('beforepaste',autotype);}autotype.call(me);}};};UE.plugin.register('autosubmit',function(){return{shortcutkey:{"autosubmit":"ctrl+13"},commands:{'autosubmit':{execCommand:function execCommand(){var me=this,form=domUtils.findParentByTagName(me.iframe,"form",false);if(form){if(me.fireEvent("beforesubmit")===false){return;}me.sync();form.submit();}}}}};});UE.plugin.register('background',function(){var me=this,cssRuleId='editor_background',isSetColored,reg=new RegExp('body[\\s]*\\{(.+)\\}','i');function stringToObj(str){var obj={},styles=str.split(';');utils.each(styles,function(v){var index=v.indexOf(':'),key=utils.trim(v.substr(0,index)).toLowerCase();key&&(obj[key]=utils.trim(v.substr(index+1)||''));});return obj;}function setBackground(obj){if(obj){var styles=[];for(var name in obj){if(obj.hasOwnProperty(name)){styles.push(name+":"+obj[name]+'; ');}}utils.cssRule(cssRuleId,styles.length?'body{'+styles.join("")+'}':'',me.document);}else{utils.cssRule(cssRuleId,'',me.document);}}
var orgFn=me.hasContents;me.hasContents=function(){if(me.queryCommandValue('background')){return true;}return orgFn.apply(me,arguments);};return{bindEvents:{'getAllHtml':function getAllHtml(type,headHtml){var body=this.body,su=domUtils.getComputedStyle(body,"background-image"),url="";if(su.indexOf(me.options.imagePath)>0){url=su.substring(su.indexOf(me.options.imagePath),su.length-1).replace(/"|\(|\)/ig,"");}else{url=su!="none"?su.replace(/url\("?|"?\)/ig,""):"";}var html='<style type="text/css">body{';var bgObj={"background-color":domUtils.getComputedStyle(body,"background-color")||"#ffffff",'background-image':url?'url('+url+')':'','background-repeat':domUtils.getComputedStyle(body,"background-repeat")||"",'background-position':browser.ie?domUtils.getComputedStyle(body,"background-position-x")+" "+domUtils.getComputedStyle(body,"background-position-y"):domUtils.getComputedStyle(body,"background-position"),'height':domUtils.getComputedStyle(body,"height")};for(var name in bgObj){if(bgObj.hasOwnProperty(name)){html+=name+":"+bgObj[name]+"; ";}}html+='}</style> ';headHtml.push(html);},'aftersetcontent':function aftersetcontent(){if(isSetColored==false)setBackground();}},inputRule:function inputRule(root){isSetColored=false;utils.each(root.getNodesByTagName('p'),function(p){var styles=p.getAttr('data-background');if(styles){isSetColored=true;setBackground(stringToObj(styles));p.parentNode.removeChild(p);}});},outputRule:function outputRule(root){var me=this,styles=(utils.cssRule(cssRuleId,me.document)||'').replace(/[\n\r]+/g,'').match(reg);if(styles){root.appendChild(UE.uNode.createElement('<p style="display:none;" data-background="'+utils.trim(styles[1].replace(/"/g,'').replace(/[\s]+/g,' '))+'"><br/></p>'));}},commands:{'background':{execCommand:function execCommand(cmd,obj){setBackground(obj);},queryCommandValue:function queryCommandValue(){var me=this,styles=(utils.cssRule(cssRuleId,me.document)||'').replace(/[\n\r]+/g,'').match(reg);return styles?stringToObj(styles[1]):null;},notNeedUndo:true}}};});UE.commands['imagefloat']={execCommand:function execCommand(cmd,align){var me=this,range=me.selection.getRange();if(!range.collapsed){var img=range.getClosedNode();if(img&&img.tagName=='IMG'){switch(align){case'left':case'right':case'none':var pN=img.parentNode,tmpNode,pre,next;while(dtd.$inline[pN.tagName]||pN.tagName=='A'){pN=pN.parentNode;}tmpNode=pN;if(tmpNode.tagName=='P'&&domUtils.getStyle(tmpNode,'text-align')=='center'){if(!domUtils.isBody(tmpNode)&&domUtils.getChildCount(tmpNode,function(node){return!domUtils.isBr(node)&&!domUtils.isWhitespace(node);})==1){pre=tmpNode.previousSibling;next=tmpNode.nextSibling;if(pre&&next&&pre.nodeType==1&&next.nodeType==1&&pre.tagName==next.tagName&&domUtils.isBlockElm(pre)){pre.appendChild(tmpNode.firstChild);while(next.firstChild){pre.appendChild(next.firstChild);}domUtils.remove(tmpNode);domUtils.remove(next);}else{domUtils.setStyle(tmpNode,'text-align','');}}range.selectNode(img).select();}domUtils.setStyle(img,'float',align=='none'?'':align);if(align=='none'){domUtils.removeAttributes(img,'align');}break;case'center':if(me.queryCommandValue('imagefloat')!='center'){pN=img.parentNode;domUtils.setStyle(img,'float','');domUtils.removeAttributes(img,'align');tmpNode=img;while(pN&&domUtils.getChildCount(pN,function(node){return!domUtils.isBr(node)&&!domUtils.isWhitespace(node);})==1&&(dtd.$inline[pN.tagName]||pN.tagName=='A')){tmpNode=pN;pN=pN.parentNode;}range.setStartBefore(tmpNode).setCursor(false);pN=me.document.createElement('div');pN.appendChild(tmpNode);domUtils.setStyle(tmpNode,'float','');me.execCommand('insertHtml','<p id="_img_parent_tmp" style="text-align:center">'+pN.innerHTML+'</p>');tmpNode=me.document.getElementById('_img_parent_tmp');tmpNode.removeAttribute('id');tmpNode=tmpNode.firstChild;range.selectNode(tmpNode).select();next=tmpNode.parentNode.nextSibling;if(next&&domUtils.isEmptyNode(next)){domUtils.remove(next);}}break;}}}},queryCommandValue:function queryCommandValue(){var range=this.selection.getRange(),startNode,floatStyle;if(range.collapsed){return'none';}startNode=range.getClosedNode();if(startNode&&startNode.nodeType==1&&startNode.tagName=='IMG'){floatStyle=domUtils.getComputedStyle(startNode,'float')||startNode.getAttribute('align');if(floatStyle=='none'){floatStyle=domUtils.getComputedStyle(startNode.parentNode,'text-align')=='center'?'center':floatStyle;}return{left:1,right:1,center:1}[floatStyle]?floatStyle:'none';}return'none';},queryCommandState:function queryCommandState(){var range=this.selection.getRange(),startNode;if(range.collapsed)return-1;startNode=range.getClosedNode();if(startNode&&startNode.nodeType==1&&startNode.tagName=='IMG'){return 0;}return-1;}};UE.commands['insertimage']={execCommand:function execCommand(cmd,opt){opt=utils.isArray(opt)?opt:[opt];if(!opt.length){return;}var me=this,range=me.selection.getRange(),img=range.getClosedNode();if(me.fireEvent('beforeinsertimage',opt)===true){return;}if(img&&/img/i.test(img.tagName)&&(img.className!="edui-faked-video"||img.className.indexOf("edui-upload-video")!=-1)&&!img.getAttribute("word_img")){var first=opt.shift();var floatStyle=first['floatStyle'];delete first['floatStyle'];domUtils.setAttributes(img,first);me.execCommand('imagefloat',floatStyle);if(opt.length>0){range.setStartAfter(img).setCursor(false,true);me.execCommand('insertimage',opt);}}else{var html=[],str='',ci;ci=opt[0];if(opt.length==1){str='<img src="'+ci.src+'" '+(ci._src?' _src="'+ci._src+'" ':'')+(ci.width?'width="'+ci.width+'" ':'')+(ci.height?' height="'+ci.height+'" ':'')+(ci['floatStyle']=='left'||ci['floatStyle']=='right'?' style="float:'+ci['floatStyle']+';"':'')+(ci.title&&ci.title!=""?' title="'+ci.title+'"':'')+(ci.border&&ci.border!="0"?' border="'+ci.border+'"':'')+(ci.alt&&ci.alt!=""?' alt="'+ci.alt+'"':'')+(ci.hspace&&ci.hspace!="0"?' hspace = "'+ci.hspace+'"':'')+(ci.vspace&&ci.vspace!="0"?' vspace = "'+ci.vspace+'"':'')+'/>';if(ci['floatStyle']=='center'){str='<p style="text-align: center">'+str+'</p>';}html.push(str);}else{for(var i=0;ci=opt[i++];){str='<p '+(ci['floatStyle']=='center'?'style="text-align: center" ':'')+'><img src="'+ci.src+'" '+(ci.width?'width="'+ci.width+'" ':'')+(ci._src?' _src="'+ci._src+'" ':'')+(ci.height?' height="'+ci.height+'" ':'')+' style="'+(ci['floatStyle']&&ci['floatStyle']!='center'?'float:'+ci['floatStyle']+';':'')+(ci.border||'')+'" '+(ci.title?' title="'+ci.title+'"':'')+' /></p>';html.push(str);}}me.execCommand('insertHtml',html.join(''));}me.fireEvent('afterinsertimage',opt);}};UE.plugins['justify']=function(){var me=this,block=domUtils.isBlockElm,defaultValue={left:1,right:1,center:1,justify:1},doJustify=function doJustify(range,style){var bookmark=range.createBookmark(),filterFn=function filterFn(node){return node.nodeType==1?node.tagName.toLowerCase()!='br'&&!domUtils.isBookmarkNode(node):!domUtils.isWhitespace(node);};range.enlarge(true);var bookmark2=range.createBookmark(),current=domUtils.getNextDomNode(bookmark2.start,false,filterFn),tmpRange=range.cloneRange(),tmpNode;while(current&&!(domUtils.getPosition(current,bookmark2.end)&domUtils.POSITION_FOLLOWING)){if(current.nodeType==3||!block(current)){tmpRange.setStartBefore(current);while(current&&current!==bookmark2.end&&!block(current)){tmpNode=current;current=domUtils.getNextDomNode(current,false,null,function(node){return!block(node);});}tmpRange.setEndAfter(tmpNode);var common=tmpRange.getCommonAncestor();if(!domUtils.isBody(common)&&block(common)){domUtils.setStyles(common,utils.isString(style)?{'text-align':style}:style);current=common;}else{var p=range.document.createElement('p');domUtils.setStyles(p,utils.isString(style)?{'text-align':style}:style);var frag=tmpRange.extractContents();p.appendChild(frag);tmpRange.insertNode(p);current=p;}current=domUtils.getNextDomNode(current,false,filterFn);}else{current=domUtils.getNextDomNode(current,true,filterFn);}}return range.moveToBookmark(bookmark2).moveToBookmark(bookmark);};UE.commands['justify']={execCommand:function execCommand(cmdName,align){var range=this.selection.getRange(),txt;if(range.collapsed){txt=this.document.createTextNode('p');range.insertNode(txt);}doJustify(range,align);if(txt){range.setStartBefore(txt).collapse(true);domUtils.remove(txt);}range.select();return true;},queryCommandValue:function queryCommandValue(){var startNode=this.selection.getStart(),value=domUtils.getComputedStyle(startNode,'text-align');return defaultValue[value]?value:'left';},queryCommandState:function queryCommandState(){var start=this.selection.getStart(),cell=start&&domUtils.findParentByTagName(start,["td","th","caption"],true);return cell?-1:0;}};};UE.plugins['font']=function(){var me=this,fonts={'forecolor':'color','backcolor':'background-color','fontsize':'font-size','fontfamily':'font-family','underline':'text-decoration','strikethrough':'text-decoration','fontborder':'border'},needCmd={'underline':1,'strikethrough':1,'fontborder':1},needSetChild={'forecolor':'color','backcolor':'background-color','fontsize':'font-size','fontfamily':'font-family'};me.setOpt({'fontfamily':[{name:'songti',val:'宋体,SimSun'},{name:'yahei',val:'微软雅黑,Microsoft YaHei'},{name:'kaiti',val:'楷体,楷体_GB2312, SimKai'},{name:'heiti',val:'黑体, SimHei'},{name:'lishu',val:'隶书, SimLi'},{name:'andaleMono',val:'andale mono'},{name:'arial',val:'arial, helvetica,sans-serif'},{name:'arialBlack',val:'arial black,avant garde'},{name:'comicSansMs',val:'comic sans ms'},{name:'impact',val:'impact,chicago'},{name:'timesNewRoman',val:'times new roman'}],'fontsize':[10,11,12,14,16,18,20,24,36]});function mergeWithParent(node){var parent;while(parent=node.parentNode){if(parent.tagName=='SPAN'&&domUtils.getChildCount(parent,function(child){return!domUtils.isBookmarkNode(child)&&!domUtils.isBr(child);})==1){parent.style.cssText+=node.style.cssText;domUtils.remove(node,true);node=parent;}else{break;}}}function mergeChild(rng,cmdName,value){if(needSetChild[cmdName]){rng.adjustmentBoundary();if(!rng.collapsed&&rng.startContainer.nodeType==1){var start=rng.startContainer.childNodes[rng.startOffset];if(start&&domUtils.isTagNode(start,'span')){var bk=rng.createBookmark();utils.each(domUtils.getElementsByTagName(start,'span'),function(span){if(!span.parentNode||domUtils.isBookmarkNode(span))return;if(cmdName=='backcolor'&&domUtils.getComputedStyle(span,'background-color').toLowerCase()===value){return;}domUtils.removeStyle(span,needSetChild[cmdName]);if(span.style.cssText.replace(/^\s+$/,'').length==0){domUtils.remove(span,true);}});rng.moveToBookmark(bk);}}}}function mergesibling(rng,cmdName,value){var collapsed=rng.collapsed,bk=rng.createBookmark(),common;if(collapsed){common=bk.start.parentNode;while(dtd.$inline[common.tagName]){common=common.parentNode;}}else{common=domUtils.getCommonAncestor(bk.start,bk.end);}utils.each(domUtils.getElementsByTagName(common,'span'),function(span){if(!span.parentNode||domUtils.isBookmarkNode(span))return;if(/\s*border\s*:\s*none;?\s*/i.test(span.style.cssText)){if(/^\s*border\s*:\s*none;?\s*$/.test(span.style.cssText)){domUtils.remove(span,true);}else{domUtils.removeStyle(span,'border');}return;}if(/border/i.test(span.style.cssText)&&span.parentNode.tagName=='SPAN'&&/border/i.test(span.parentNode.style.cssText)){span.style.cssText=span.style.cssText.replace(/border[^:]*:[^;]+;?/gi,'');}if(!(cmdName=='fontborder'&&value=='none')){var next=span.nextSibling;while(next&&next.nodeType==1&&next.tagName=='SPAN'){if(domUtils.isBookmarkNode(next)&&cmdName=='fontborder'){span.appendChild(next);next=span.nextSibling;continue;}if(next.style.cssText==span.style.cssText){domUtils.moveChild(next,span);domUtils.remove(next);}if(span.nextSibling===next)break;next=span.nextSibling;}}mergeWithParent(span);if(browser.ie&&browser.version>8){var parent=domUtils.findParent(span,function(n){return n.tagName=='SPAN'&&/background-color/.test(n.style.cssText);});if(parent&&!/background-color/.test(span.style.cssText)){span.style.backgroundColor=parent.style.backgroundColor;}}});rng.moveToBookmark(bk);mergeChild(rng,cmdName,value);}me.addInputRule(function(root){utils.each(root.getNodesByTagName('u s del font strike'),function(node){if(node.tagName=='font'){var cssStyle=[];for(var p in node.attrs){switch(p){case'size':cssStyle.push('font-size:'+({'1':'10','2':'12','3':'16','4':'18','5':'24','6':'32','7':'48'}[node.attrs[p]]||node.attrs[p])+'px');break;case'color':cssStyle.push('color:'+node.attrs[p]);break;case'face':cssStyle.push('font-family:'+node.attrs[p]);break;case'style':cssStyle.push(node.attrs[p]);}}node.attrs={'style':cssStyle.join(';')};}else{var val=node.tagName=='u'?'underline':'line-through';node.attrs={'style':(node.getAttr('style')||'')+'text-decoration:'+val+';'};}node.tagName='span';});});for(var p in fonts){(function(cmd,style){UE.commands[cmd]={execCommand:function execCommand(cmdName,value){value=value||(this.queryCommandState(cmdName)?'none':cmdName=='underline'?'underline':cmdName=='fontborder'?'1px solid #000':'line-through');var me=this,range=this.selection.getRange(),text;if(value=='default'){if(range.collapsed){text=me.document.createTextNode('font');range.insertNode(text).select();}me.execCommand('removeFormat','span,a',style);if(text){range.setStartBefore(text).collapse(true);domUtils.remove(text);}mergesibling(range,cmdName,value);range.select();}else{if(!range.collapsed){if(needCmd[cmd]&&me.queryCommandValue(cmd)){me.execCommand('removeFormat','span,a',style);}range=me.selection.getRange();range.applyInlineStyle('span',{'style':style+':'+value});mergesibling(range,cmdName,value);range.select();}else{var span=domUtils.findParentByTagName(range.startContainer,'span',true);text=me.document.createTextNode('font');if(span&&!span.children.length&&!span[browser.ie?'innerText':'textContent'].replace(fillCharReg,'').length){range.insertNode(text);if(needCmd[cmd]){range.selectNode(text).select();me.execCommand('removeFormat','span,a',style,null);span=domUtils.findParentByTagName(text,'span',true);range.setStartBefore(text);}span&&(span.style.cssText+=';'+style+':'+value);range.collapse(true).select();}else{range.insertNode(text);range.selectNode(text).select();span=range.document.createElement('span');if(needCmd[cmd]){if(domUtils.findParentByTagName(text,'a',true)){range.setStartBefore(text).setCursor();domUtils.remove(text);return;}me.execCommand('removeFormat','span,a',style);}span.style.cssText=style+':'+value;text.parentNode.insertBefore(span,text);if(!browser.ie||browser.ie&&browser.version==9){var spanParent=span.parentNode;while(!domUtils.isBlockElm(spanParent)){if(spanParent.tagName=='SPAN'){span.style.cssText=spanParent.style.cssText+";"+span.style.cssText;}spanParent=spanParent.parentNode;}}if(opera){setTimeout(function(){range.setStart(span,0).collapse(true);mergesibling(range,cmdName,value);range.select();});}else{range.setStart(span,0).collapse(true);mergesibling(range,cmdName,value);range.select();}}domUtils.remove(text);}}return true;},queryCommandValue:function queryCommandValue(cmdName){var startNode=this.selection.getStart();if(cmdName=='underline'||cmdName=='strikethrough'){var tmpNode=startNode,value;while(tmpNode&&!domUtils.isBlockElm(tmpNode)&&!domUtils.isBody(tmpNode)){if(tmpNode.nodeType==1){value=domUtils.getComputedStyle(tmpNode,style);if(value!='none'){return value;}}tmpNode=tmpNode.parentNode;}return'none';}if(cmdName=='fontborder'){var tmp=startNode,val;while(tmp&&dtd.$inline[tmp.tagName]){if(val=domUtils.getComputedStyle(tmp,'border')){if(/1px/.test(val)&&/solid/.test(val)){return val;}}tmp=tmp.parentNode;}return'';}if(cmdName=='FontSize'){var styleVal=domUtils.getComputedStyle(startNode,style),tmp=/^([\d\.]+)(\w+)$/.exec(styleVal);if(tmp){return Math.floor(tmp[1])+tmp[2];}return styleVal;}return domUtils.getComputedStyle(startNode,style);},queryCommandState:function queryCommandState(cmdName){if(!needCmd[cmdName])return 0;var val=this.queryCommandValue(cmdName);if(cmdName=='fontborder'){return/1px/.test(val)&&/solid/.test(val);}else{return cmdName=='underline'?/underline/.test(val):/line\-through/.test(val);}}};})(p,fonts[p]);}};UE.plugins['link']=function(){function optimize(range){var start=range.startContainer,end=range.endContainer;if(start=domUtils.findParentByTagName(start,'a',true)){range.setStartBefore(start);}if(end=domUtils.findParentByTagName(end,'a',true)){range.setEndAfter(end);}}UE.commands['unlink']={execCommand:function execCommand(){var range=this.selection.getRange(),bookmark;if(range.collapsed&&!domUtils.findParentByTagName(range.startContainer,'a',true)){return;}bookmark=range.createBookmark();optimize(range);range.removeInlineStyle('a').moveToBookmark(bookmark).select();},queryCommandState:function queryCommandState(){return!this.highlight&&this.queryCommandValue('link')?0:-1;}};function doLink(range,opt,me){var rngClone=range.cloneRange(),link=me.queryCommandValue('link');optimize(range=range.adjustmentBoundary());var start=range.startContainer;if(start.nodeType==1&&link){start=start.childNodes[range.startOffset];if(start&&start.nodeType==1&&start.tagName=='A'&&/^(?:https?|ftp|file)\s*:\s*\/\//.test(start[browser.ie?'innerText':'textContent'])){start[browser.ie?'innerText':'textContent']=utils.html(opt.textValue||opt.href);}}if(!rngClone.collapsed||link){range.removeInlineStyle('a');rngClone=range.cloneRange();}if(rngClone.collapsed){var a=range.document.createElement('a'),text='';if(opt.textValue){text=utils.html(opt.textValue);delete opt.textValue;}else{text=utils.html(opt.href);}domUtils.setAttributes(a,opt);start=domUtils.findParentByTagName(rngClone.startContainer,'a',true);if(start&&domUtils.isInNodeEndBoundary(rngClone,start)){range.setStartAfter(start).collapse(true);}a[browser.ie?'innerText':'textContent']=text;range.insertNode(a).selectNode(a);}else{range.applyInlineStyle('a',opt);}}UE.commands['link']={execCommand:function execCommand(cmdName,opt){var range;opt._href&&(opt._href=utils.unhtml(opt._href,/[<">]/g));opt.href&&(opt.href=utils.unhtml(opt.href,/[<">]/g));opt.textValue&&(opt.textValue=utils.unhtml(opt.textValue,/[<">]/g));doLink(range=this.selection.getRange(),opt,this);range.collapse().select(true);},queryCommandValue:function queryCommandValue(){var range=this.selection.getRange(),node;if(range.collapsed){node=range.startContainer;node=node.nodeType==1?node:node.parentNode;if(node&&(node=domUtils.findParentByTagName(node,'a',true))&&!domUtils.isInNodeEndBoundary(range,node)){return node;}}else{range.shrinkBoundary();var start=range.startContainer.nodeType==3||!range.startContainer.childNodes[range.startOffset]?range.startContainer:range.startContainer.childNodes[range.startOffset],end=range.endContainer.nodeType==3||range.endOffset==0?range.endContainer:range.endContainer.childNodes[range.endOffset-1],common=range.getCommonAncestor();node=domUtils.findParentByTagName(common,'a',true);if(!node&&common.nodeType==1){var as=common.getElementsByTagName('a'),ps,pe;for(var i=0,ci;ci=as[i++];){ps=domUtils.getPosition(ci,start),pe=domUtils.getPosition(ci,end);if((ps&domUtils.POSITION_FOLLOWING||ps&domUtils.POSITION_CONTAINS)&&(pe&domUtils.POSITION_PRECEDING||pe&domUtils.POSITION_CONTAINS)){node=ci;break;}}}return node;}},queryCommandState:function queryCommandState(){var img=this.selection.getRange().getClosedNode(),flag=img&&(img.className=="edui-faked-video"||img.className.indexOf("edui-upload-video")!=-1);return flag?-1:0;}};};UE.plugins['insertframe']=function(){var me=this;function deleteIframe(){me._iframe&&delete me._iframe;}me.addListener("selectionchange",function(){deleteIframe();});};UE.commands['scrawl']={queryCommandState:function queryCommandState(){return browser.ie&&browser.version<=8?-1:0;}};UE.plugins['removeformat']=function(){var me=this;me.setOpt({'removeFormatTags':'b,big,code,del,dfn,em,font,i,ins,kbd,q,samp,small,span,strike,strong,sub,sup,tt,u,var','removeFormatAttributes':'class,style,lang,width,height,align,hspace,valign'});me.commands['removeformat']={execCommand:function execCommand(cmdName,tags,style,attrs,notIncludeA){var tagReg=new RegExp('^(?:'+(tags||this.options.removeFormatTags).replace(/,/g,'|')+')$','i'),removeFormatAttributes=style?[]:(attrs||this.options.removeFormatAttributes).split(','),range=new dom.Range(this.document),bookmark,node,parent,filter=function filter(node){return node.nodeType==1;};function isRedundantSpan(node){if(node.nodeType==3||node.tagName.toLowerCase()!='span'){return 0;}if(browser.ie){var attrs=node.attributes;if(attrs.length){for(var i=0,l=attrs.length;i<l;i++){if(attrs[i].specified){return 0;}}return 1;}}return!node.attributes.length;}function doRemove(range){var bookmark1=range.createBookmark();if(range.collapsed){range.enlarge(true);}
if(!notIncludeA){var aNode=domUtils.findParentByTagName(range.startContainer,'a',true);if(aNode){range.setStartBefore(aNode);}aNode=domUtils.findParentByTagName(range.endContainer,'a',true);if(aNode){range.setEndAfter(aNode);}}bookmark=range.createBookmark();node=bookmark.start;while((parent=node.parentNode)&&!domUtils.isBlockElm(parent)){domUtils.breakParent(node,parent);domUtils.clearEmptySibling(node);}if(bookmark.end){node=bookmark.end;while((parent=node.parentNode)&&!domUtils.isBlockElm(parent)){domUtils.breakParent(node,parent);domUtils.clearEmptySibling(node);}
var current=domUtils.getNextDomNode(bookmark.start,false,filter),next;while(current){if(current==bookmark.end){break;}next=domUtils.getNextDomNode(current,true,filter);if(!dtd.$empty[current.tagName.toLowerCase()]&&!domUtils.isBookmarkNode(current)){if(tagReg.test(current.tagName)){if(style){domUtils.removeStyle(current,style);if(isRedundantSpan(current)&&style!='text-decoration'){domUtils.remove(current,true);}}else{domUtils.remove(current,true);}}else{if(!dtd.$tableContent[current.tagName]&&!dtd.$list[current.tagName]){domUtils.removeAttributes(current,removeFormatAttributes);if(isRedundantSpan(current)){domUtils.remove(current,true);}}}}current=next;}}
var pN=bookmark.start.parentNode;if(domUtils.isBlockElm(pN)&&!dtd.$tableContent[pN.tagName]&&!dtd.$list[pN.tagName]){domUtils.removeAttributes(pN,removeFormatAttributes);}pN=bookmark.end.parentNode;if(bookmark.end&&domUtils.isBlockElm(pN)&&!dtd.$tableContent[pN.tagName]&&!dtd.$list[pN.tagName]){domUtils.removeAttributes(pN,removeFormatAttributes);}range.moveToBookmark(bookmark).moveToBookmark(bookmark1);var node=range.startContainer,tmp,collapsed=range.collapsed;while(node.nodeType==1&&domUtils.isEmptyNode(node)&&dtd.$removeEmpty[node.tagName]){tmp=node.parentNode;range.setStartBefore(node);if(range.startContainer===range.endContainer){range.endOffset--;}domUtils.remove(node);node=tmp;}if(!collapsed){node=range.endContainer;while(node.nodeType==1&&domUtils.isEmptyNode(node)&&dtd.$removeEmpty[node.tagName]){tmp=node.parentNode;range.setEndBefore(node);domUtils.remove(node);node=tmp;}}}range=this.selection.getRange();doRemove(range);range.select();}};};UE.plugins['blockquote']=function(){var me=this;function getObj(editor){return domUtils.filterNodeList(editor.selection.getStartElementPath(),'blockquote');}me.commands['blockquote']={execCommand:function execCommand(cmdName,attrs){var range=this.selection.getRange(),obj=getObj(this),blockquote=dtd.blockquote,bookmark=range.createBookmark();if(obj){var start=range.startContainer,startBlock=domUtils.isBlockElm(start)?start:domUtils.findParent(start,function(node){return domUtils.isBlockElm(node);}),end=range.endContainer,endBlock=domUtils.isBlockElm(end)?end:domUtils.findParent(end,function(node){return domUtils.isBlockElm(node);});startBlock=domUtils.findParentByTagName(startBlock,'li',true)||startBlock;endBlock=domUtils.findParentByTagName(endBlock,'li',true)||endBlock;if(startBlock.tagName=='LI'||startBlock.tagName=='TD'||startBlock===obj||domUtils.isBody(startBlock)){domUtils.remove(obj,true);}else{domUtils.breakParent(startBlock,obj);}if(startBlock!==endBlock){obj=domUtils.findParentByTagName(endBlock,'blockquote');if(obj){if(endBlock.tagName=='LI'||endBlock.tagName=='TD'||domUtils.isBody(endBlock)){obj.parentNode&&domUtils.remove(obj,true);}else{domUtils.breakParent(endBlock,obj);}}}var blockquotes=domUtils.getElementsByTagName(this.document,'blockquote');for(var i=0,bi;bi=blockquotes[i++];){if(!bi.childNodes.length){domUtils.remove(bi);}else if(domUtils.getPosition(bi,startBlock)&domUtils.POSITION_FOLLOWING&&domUtils.getPosition(bi,endBlock)&domUtils.POSITION_PRECEDING){domUtils.remove(bi,true);}}}else{var tmpRange=range.cloneRange(),node=tmpRange.startContainer.nodeType==1?tmpRange.startContainer:tmpRange.startContainer.parentNode,preNode=node,doEnd=1;while(1){if(domUtils.isBody(node)){if(preNode!==node){if(range.collapsed){tmpRange.selectNode(preNode);doEnd=0;}else{tmpRange.setStartBefore(preNode);}}else{tmpRange.setStart(node,0);}break;}if(!blockquote[node.tagName]){if(range.collapsed){tmpRange.selectNode(preNode);}else{tmpRange.setStartBefore(preNode);}break;}preNode=node;node=node.parentNode;}
if(doEnd){preNode=node=node=tmpRange.endContainer.nodeType==1?tmpRange.endContainer:tmpRange.endContainer.parentNode;while(1){if(domUtils.isBody(node)){if(preNode!==node){tmpRange.setEndAfter(preNode);}else{tmpRange.setEnd(node,node.childNodes.length);}break;}if(!blockquote[node.tagName]){tmpRange.setEndAfter(preNode);break;}preNode=node;node=node.parentNode;}}node=range.document.createElement('blockquote');domUtils.setAttributes(node,attrs);node.appendChild(tmpRange.extractContents());tmpRange.insertNode(node);var childs=domUtils.getElementsByTagName(node,'blockquote');for(var i=0,ci;ci=childs[i++];){if(ci.parentNode){domUtils.remove(ci,true);}}}range.moveToBookmark(bookmark).select();},queryCommandState:function queryCommandState(){return getObj(this)?1:0;}};};UE.commands['touppercase']=UE.commands['tolowercase']={execCommand:function execCommand(cmd){var me=this;var rng=me.selection.getRange();if(rng.collapsed){return rng;}var bk=rng.createBookmark(),bkEnd=bk.end,filterFn=function filterFn(node){return!domUtils.isBr(node)&&!domUtils.isWhitespace(node);},curNode=domUtils.getNextDomNode(bk.start,false,filterFn);while(curNode&&domUtils.getPosition(curNode,bkEnd)&domUtils.POSITION_PRECEDING){if(curNode.nodeType==3){curNode.nodeValue=curNode.nodeValue[cmd=='touppercase'?'toUpperCase':'toLowerCase']();}curNode=domUtils.getNextDomNode(curNode,true,filterFn);if(curNode===bkEnd){break;}}rng.moveToBookmark(bk).select();}};UE.commands['indent']={execCommand:function execCommand(){var me=this,value=me.queryCommandState("indent")?"0em":me.options.indentValue||'2em';me.execCommand('Paragraph','p',{style:'text-indent:'+value});},queryCommandState:function queryCommandState(){var pN=domUtils.filterNodeList(this.selection.getStartElementPath(),'p h1 h2 h3 h4 h5 h6');return pN&&pN.style.textIndent&&parseInt(pN.style.textIndent)?1:0;}};UE.commands['print']={execCommand:function execCommand(){this.window.print();},notNeedUndo:1};UE.commands['preview']={execCommand:function execCommand(){var w=window.open('','_blank',''),d=w.document;d.open();d.write('<!DOCTYPE html><html><head><meta charset="utf-8"/><script src="'+this.options.UEDITOR_HOME_URL+'ueditor.parse.js"></script><script>'+"setTimeout(function(){uParse('div',{rootPath: '"+this.options.UEDITOR_HOME_URL+"'})},300)"+'</script></head><body><div>'+this.getContent(null,null,true)+'</div></body></html>');d.close();},notNeedUndo:1};UE.plugins['selectall']=function(){var me=this;me.commands['selectall']={execCommand:function execCommand(){var me=this,body=me.body,range=me.selection.getRange();range.selectNodeContents(body);if(domUtils.isEmptyBlock(body)){if(browser.opera&&body.firstChild&&body.firstChild.nodeType==1){range.setStartAtFirst(body.firstChild);}range.collapse(true);}range.select(true);},notNeedUndo:1};me.addshortcutkey({"selectAll":"ctrl+65"});};UE.plugins['paragraph']=function(){var me=this,block=domUtils.isBlockElm,notExchange=['TD','LI','PRE'],doParagraph=function doParagraph(range,style,attrs,sourceCmdName){var bookmark=range.createBookmark(),filterFn=function filterFn(node){return node.nodeType==1?node.tagName.toLowerCase()!='br'&&!domUtils.isBookmarkNode(node):!domUtils.isWhitespace(node);},para;range.enlarge(true);var bookmark2=range.createBookmark(),current=domUtils.getNextDomNode(bookmark2.start,false,filterFn),tmpRange=range.cloneRange(),tmpNode;while(current&&!(domUtils.getPosition(current,bookmark2.end)&domUtils.POSITION_FOLLOWING)){if(current.nodeType==3||!block(current)){tmpRange.setStartBefore(current);while(current&&current!==bookmark2.end&&!block(current)){tmpNode=current;current=domUtils.getNextDomNode(current,false,null,function(node){return!block(node);});}tmpRange.setEndAfter(tmpNode);para=range.document.createElement(style);if(attrs){domUtils.setAttributes(para,attrs);if(sourceCmdName&&sourceCmdName=='customstyle'&&attrs.style){para.style.cssText=attrs.style;}}para.appendChild(tmpRange.extractContents());if(domUtils.isEmptyNode(para)){domUtils.fillChar(range.document,para);}tmpRange.insertNode(para);var parent=para.parentNode;if(block(parent)&&!domUtils.isBody(para.parentNode)&&utils.indexOf(notExchange,parent.tagName)==-1){if(!(sourceCmdName&&sourceCmdName=='customstyle')){parent.getAttribute('dir')&&para.setAttribute('dir',parent.getAttribute('dir'));parent.style.cssText&&(para.style.cssText=parent.style.cssText+';'+para.style.cssText);parent.style.textAlign&&!para.style.textAlign&&(para.style.textAlign=parent.style.textAlign);parent.style.textIndent&&!para.style.textIndent&&(para.style.textIndent=parent.style.textIndent);parent.style.padding&&!para.style.padding&&(para.style.padding=parent.style.padding);}
if(attrs&&/h\d/i.test(parent.tagName)&&!/h\d/i.test(para.tagName)){domUtils.setAttributes(parent,attrs);if(sourceCmdName&&sourceCmdName=='customstyle'&&attrs.style){parent.style.cssText=attrs.style;}domUtils.remove(para,true);para=parent;}else{domUtils.remove(para.parentNode,true);}}if(utils.indexOf(notExchange,parent.tagName)!=-1){current=parent;}else{current=para;}current=domUtils.getNextDomNode(current,false,filterFn);}else{current=domUtils.getNextDomNode(current,true,filterFn);}}return range.moveToBookmark(bookmark2).moveToBookmark(bookmark);};me.setOpt('paragraph',{'p':'','h1':'','h2':'','h3':'','h4':'','h5':'','h6':''});me.commands['paragraph']={execCommand:function execCommand(cmdName,style,attrs,sourceCmdName){var range=this.selection.getRange();if(range.collapsed){var txt=this.document.createTextNode('p');range.insertNode(txt);if(browser.ie){var node=txt.previousSibling;if(node&&domUtils.isWhitespace(node)){domUtils.remove(node);}node=txt.nextSibling;if(node&&domUtils.isWhitespace(node)){domUtils.remove(node);}}}range=doParagraph(range,style,attrs,sourceCmdName);if(txt){range.setStartBefore(txt).collapse(true);pN=txt.parentNode;domUtils.remove(txt);if(domUtils.isBlockElm(pN)&&domUtils.isEmptyNode(pN)){domUtils.fillNode(this.document,pN);}}if(browser.gecko&&range.collapsed&&range.startContainer.nodeType==1){var child=range.startContainer.childNodes[range.startOffset];if(child&&child.nodeType==1&&child.tagName.toLowerCase()==style){range.setStart(child,0).collapse(true);}}
range.select();return true;},queryCommandValue:function queryCommandValue(){var node=domUtils.filterNodeList(this.selection.getStartElementPath(),'p h1 h2 h3 h4 h5 h6');return node?node.tagName.toLowerCase():'';}};};(function(){var block=domUtils.isBlockElm,getObj=function getObj(editor){return domUtils.filterNodeList(editor.selection.getStartElementPath(),function(n){return n&&n.nodeType==1&&n.getAttribute('dir');});},doDirectionality=function doDirectionality(range,editor,forward){var bookmark,filterFn=function filterFn(node){return node.nodeType==1?!domUtils.isBookmarkNode(node):!domUtils.isWhitespace(node);},obj=getObj(editor);if(obj&&range.collapsed){obj.setAttribute('dir',forward);return range;}bookmark=range.createBookmark();range.enlarge(true);var bookmark2=range.createBookmark(),current=domUtils.getNextDomNode(bookmark2.start,false,filterFn),tmpRange=range.cloneRange(),tmpNode;while(current&&!(domUtils.getPosition(current,bookmark2.end)&domUtils.POSITION_FOLLOWING)){if(current.nodeType==3||!block(current)){tmpRange.setStartBefore(current);while(current&&current!==bookmark2.end&&!block(current)){tmpNode=current;current=domUtils.getNextDomNode(current,false,null,function(node){return!block(node);});}tmpRange.setEndAfter(tmpNode);var common=tmpRange.getCommonAncestor();if(!domUtils.isBody(common)&&block(common)){common.setAttribute('dir',forward);current=common;}else{var p=range.document.createElement('p');p.setAttribute('dir',forward);var frag=tmpRange.extractContents();p.appendChild(frag);tmpRange.insertNode(p);current=p;}current=domUtils.getNextDomNode(current,false,filterFn);}else{current=domUtils.getNextDomNode(current,true,filterFn);}}return range.moveToBookmark(bookmark2).moveToBookmark(bookmark);};UE.commands['directionality']={execCommand:function execCommand(cmdName,forward){var range=this.selection.getRange();if(range.collapsed){var txt=this.document.createTextNode('d');range.insertNode(txt);}doDirectionality(range,this,forward);if(txt){range.setStartBefore(txt).collapse(true);domUtils.remove(txt);}range.select();return true;},queryCommandValue:function queryCommandValue(){var node=getObj(this);return node?node.getAttribute('dir'):'ltr';}};})();UE.plugins['horizontal']=function(){var me=this;me.commands['horizontal']={execCommand:function execCommand(cmdName){var me=this;if(me.queryCommandState(cmdName)!==-1){me.execCommand('insertHtml','<hr>');var range=me.selection.getRange(),start=range.startContainer;if(start.nodeType==1&&!start.childNodes[range.startOffset]){var tmp;if(tmp=start.childNodes[range.startOffset-1]){if(tmp.nodeType==1&&tmp.tagName=='HR'){if(me.options.enterTag=='p'){tmp=me.document.createElement('p');range.insertNode(tmp);range.setStart(tmp,0).setCursor();}else{tmp=me.document.createElement('br');range.insertNode(tmp);range.setStartBefore(tmp).setCursor();}}}}return true;}},queryCommandState:function queryCommandState(){return domUtils.filterNodeList(this.selection.getStartElementPath(),'table')?-1:0;}};me.addListener('delkeydown',function(name,evt){var rng=this.selection.getRange();rng.txtToElmBoundary(true);if(domUtils.isStartInblock(rng)){var tmpNode=rng.startContainer;var pre=tmpNode.previousSibling;if(pre&&domUtils.isTagNode(pre,'hr')){domUtils.remove(pre);rng.select();domUtils.preventDefault(evt);return true;}}});};UE.commands['time']=UE.commands["date"]={execCommand:function execCommand(cmd,format){var date=new Date();function formatTime(date,format){var hh=('0'+date.getHours()).slice(-2),ii=('0'+date.getMinutes()).slice(-2),ss=('0'+date.getSeconds()).slice(-2);format=format||'hh:ii:ss';return format.replace(/hh/ig,hh).replace(/ii/ig,ii).replace(/ss/ig,ss);}function formatDate(date,format){var yyyy=('000'+date.getFullYear()).slice(-4),yy=yyyy.slice(-2),mm=('0'+(date.getMonth()+1)).slice(-2),dd=('0'+date.getDate()).slice(-2);format=format||'yyyy-mm-dd';return format.replace(/yyyy/ig,yyyy).replace(/yy/ig,yy).replace(/mm/ig,mm).replace(/dd/ig,dd);}this.execCommand('insertHtml',cmd=="time"?formatTime(date,format):formatDate(date,format));}};UE.plugins['rowspacing']=function(){var me=this;me.setOpt({'rowspacingtop':['5','10','15','20','25'],'rowspacingbottom':['5','10','15','20','25']});me.commands['rowspacing']={execCommand:function execCommand(cmdName,value,dir){this.execCommand('paragraph','p',{style:'margin-'+dir+':'+value+'px'});return true;},queryCommandValue:function queryCommandValue(cmdName,dir){var pN=domUtils.filterNodeList(this.selection.getStartElementPath(),function(node){return domUtils.isBlockElm(node);}),value;if(pN){value=domUtils.getComputedStyle(pN,'margin-'+dir).replace(/[^\d]/g,'');return!value?0:value;}return 0;}};};UE.plugins['lineheight']=function(){var me=this;me.setOpt({'lineheight':['1','1.5','1.75','2','3','4','5']});me.commands['lineheight']={execCommand:function execCommand(cmdName,value){this.execCommand('paragraph','p',{style:'line-height:'+(value=="1"?"normal":value+'em')});return true;},queryCommandValue:function queryCommandValue(){var pN=domUtils.filterNodeList(this.selection.getStartElementPath(),function(node){return domUtils.isBlockElm(node);});if(pN){var value=domUtils.getComputedStyle(pN,'line-height');return value=='normal'?1:value.replace(/[^\d.]*/ig,"");}}};};UE.plugins['insertcode']=function(){var me=this;me.ready(function(){utils.cssRule('pre','pre{margin:.5em 0;padding:.4em .6em;border-radius:8px;background:#f8f8f8;}',me.document);});me.setOpt('insertcode',{'as3':'ActionScript3','bash':'Bash/Shell','cpp':'C/C++','css':'Css','cf':'CodeFunction','c#':'C#','delphi':'Delphi','diff':'Diff','erlang':'Erlang','groovy':'Groovy','html':'Html','java':'Java','jfx':'JavaFx','js':'Javascript','pl':'Perl','php':'Php','plain':'Plain Text','ps':'PowerShell','python':'Python','ruby':'Ruby','scala':'Scala','sql':'Sql','vb':'Vb','xml':'Xml'});me.commands['insertcode']={execCommand:function execCommand(cmd,lang){var me=this,rng=me.selection.getRange(),pre=domUtils.findParentByTagName(rng.startContainer,'pre',true);if(pre){pre.className='brush:'+lang+';toolbar:false;';}else{var code='';if(rng.collapsed){code=browser.ie&&browser.ie11below?browser.version<=8?'&nbsp;':'':'<br/>';}else{var frag=rng.extractContents();var div=me.document.createElement('div');div.appendChild(frag);utils.each(UE.filterNode(UE.htmlparser(div.innerHTML.replace(/[\r\t]/g,'')),me.options.filterTxtRules).children,function(node){if(browser.ie&&browser.ie11below&&browser.version>8){if(node.type=='element'){if(node.tagName=='br'){code+='\n';}else if(!dtd.$empty[node.tagName]){utils.each(node.children,function(cn){if(cn.type=='element'){if(cn.tagName=='br'){code+='\n';}else if(!dtd.$empty[node.tagName]){code+=cn.innerText();}}else{code+=cn.data;}});if(!/\n$/.test(code)){code+='\n';}}}else{code+=node.data+'\n';}if(!node.nextSibling()&&/\n$/.test(code)){code=code.replace(/\n$/,'');}}else{if(browser.ie&&browser.ie11below){if(node.type=='element'){if(node.tagName=='br'){code+='<br>';}else if(!dtd.$empty[node.tagName]){utils.each(node.children,function(cn){if(cn.type=='element'){if(cn.tagName=='br'){code+='<br>';}else if(!dtd.$empty[node.tagName]){code+=cn.innerText();}}else{code+=cn.data;}});if(!/br>$/.test(code)){code+='<br>';}}}else{code+=node.data+'<br>';}if(!node.nextSibling()&&/<br>$/.test(code)){code=code.replace(/<br>$/,'');}}else{code+=node.type=='element'?dtd.$empty[node.tagName]?'':node.innerText():node.data;if(!/br\/?\s*>$/.test(code)){if(!node.nextSibling())return;code+='<br>';}}}});}me.execCommand('inserthtml','<pre id="coder"class="brush:'+lang+';toolbar:false">'+code+'</pre>',true);pre=me.document.getElementById('coder');domUtils.removeAttributes(pre,'id');var tmpNode=pre.previousSibling;if(tmpNode&&(tmpNode.nodeType==3&&tmpNode.nodeValue.length==1&&browser.ie&&browser.version==6||domUtils.isEmptyBlock(tmpNode))){domUtils.remove(tmpNode);}var rng=me.selection.getRange();if(domUtils.isEmptyBlock(pre)){rng.setStart(pre,0).setCursor(false,true);}else{rng.selectNodeContents(pre).select();}}},queryCommandValue:function queryCommandValue(){var path=this.selection.getStartElementPath();var lang='';utils.each(path,function(node){if(node.nodeName=='PRE'){var match=node.className.match(/brush:([^;]+)/);lang=match&&match[1]?match[1]:'';return false;}});return lang;}};me.addInputRule(function(root){utils.each(root.getNodesByTagName('pre'),function(pre){var brs=pre.getNodesByTagName('br');if(brs.length){browser.ie&&browser.ie11below&&browser.version>8&&utils.each(brs,function(br){var txt=UE.uNode.createText('\n');br.parentNode.insertBefore(txt,br);br.parentNode.removeChild(br);});return;}if(browser.ie&&browser.ie11below&&browser.version>8)return;var code=pre.innerText().split(/\n/);pre.innerHTML('');utils.each(code,function(c){if(c.length){pre.appendChild(UE.uNode.createText(c));}pre.appendChild(UE.uNode.createElement('br'));});});});me.addOutputRule(function(root){utils.each(root.getNodesByTagName('pre'),function(pre){var code='';utils.each(pre.children,function(n){if(n.type=='text'){code+=n.data.replace(/[ ]/g,'&nbsp;').replace(/\n$/,'');}else{if(n.tagName=='br'){code+='\n';}else{code+=!dtd.$empty[n.tagName]?'':n.innerText();}}});pre.innerText(code.replace(/(&nbsp;|\n)+$/,''));});});me.notNeedCodeQuery={help:1,undo:1,redo:1,source:1,print:1,searchreplace:1,fullscreen:1,preview:1,insertparagraph:1,elementpath:1,insertcode:1,inserthtml:1,selectall:1};var orgQuery=me.queryCommandState;me.queryCommandState=function(cmd){var me=this;if(!me.notNeedCodeQuery[cmd.toLowerCase()]&&me.selection&&me.queryCommandValue('insertcode')){return-1;}return UE.Editor.prototype.queryCommandState.apply(this,arguments);};me.addListener('beforeenterkeydown',function(){var rng=me.selection.getRange();var pre=domUtils.findParentByTagName(rng.startContainer,'pre',true);if(pre){me.fireEvent('saveScene');if(!rng.collapsed){rng.deleteContents();}if(!browser.ie||browser.ie9above){var tmpNode=me.document.createElement('br'),pre;rng.insertNode(tmpNode).setStartAfter(tmpNode).collapse(true);var next=tmpNode.nextSibling;if(!next&&(!browser.ie||browser.version>10)){rng.insertNode(tmpNode.cloneNode(false));}else{rng.setStartAfter(tmpNode);}pre=tmpNode.previousSibling;var tmp;while(pre){tmp=pre;pre=pre.previousSibling;if(!pre||pre.nodeName=='BR'){pre=tmp;break;}}if(pre){var str='';while(pre&&pre.nodeName!='BR'&&new RegExp('^[\\s'+domUtils.fillChar+']*$').test(pre.nodeValue)){str+=pre.nodeValue;pre=pre.nextSibling;}if(pre.nodeName!='BR'){var match=pre.nodeValue.match(new RegExp('^([\\s'+domUtils.fillChar+']+)'));if(match&&match[1]){str+=match[1];}}if(str){str=me.document.createTextNode(str);rng.insertNode(str).setStartAfter(str);}}rng.collapse(true).select(true);}else{if(browser.version>8){var txt=me.document.createTextNode('\n');var start=rng.startContainer;if(rng.startOffset==0){var preNode=start.previousSibling;if(preNode){rng.insertNode(txt);var fillchar=me.document.createTextNode(' ');rng.setStartAfter(txt).insertNode(fillchar).setStart(fillchar,0).collapse(true).select(true);}}else{rng.insertNode(txt).setStartAfter(txt);var fillchar=me.document.createTextNode(' ');start=rng.startContainer.childNodes[rng.startOffset];if(start&&!/^\n/.test(start.nodeValue)){rng.setStartBefore(txt);}rng.insertNode(fillchar).setStart(fillchar,0).collapse(true).select(true);}}else{var tmpNode=me.document.createElement('br');rng.insertNode(tmpNode);rng.insertNode(me.document.createTextNode(domUtils.fillChar));rng.setStartAfter(tmpNode);pre=tmpNode.previousSibling;var tmp;while(pre){tmp=pre;pre=pre.previousSibling;if(!pre||pre.nodeName=='BR'){pre=tmp;break;}}if(pre){var str='';while(pre&&pre.nodeName!='BR'&&new RegExp('^[ '+domUtils.fillChar+']*$').test(pre.nodeValue)){str+=pre.nodeValue;pre=pre.nextSibling;}if(pre.nodeName!='BR'){var match=pre.nodeValue.match(new RegExp('^([ '+domUtils.fillChar+']+)'));if(match&&match[1]){str+=match[1];}}str=me.document.createTextNode(str);rng.insertNode(str).setStartAfter(str);}rng.collapse(true).select();}}me.fireEvent('saveScene');return true;}});me.addListener('tabkeydown',function(cmd,evt){var rng=me.selection.getRange();var pre=domUtils.findParentByTagName(rng.startContainer,'pre',true);if(pre){me.fireEvent('saveScene');if(evt.shiftKey){}else{if(!rng.collapsed){var bk=rng.createBookmark();var start=bk.start.previousSibling;while(start){if(pre.firstChild===start&&!domUtils.isBr(start)){pre.insertBefore(me.document.createTextNode('    '),start);break;}if(domUtils.isBr(start)){pre.insertBefore(me.document.createTextNode('    '),start.nextSibling);break;}start=start.previousSibling;}var end=bk.end;start=bk.start.nextSibling;if(pre.firstChild===bk.start){pre.insertBefore(me.document.createTextNode('    '),start.nextSibling);}while(start&&start!==end){if(domUtils.isBr(start)&&start.nextSibling){if(start.nextSibling===end){break;}pre.insertBefore(me.document.createTextNode('    '),start.nextSibling);}start=start.nextSibling;}rng.moveToBookmark(bk).select();}else{var tmpNode=me.document.createTextNode('    ');rng.insertNode(tmpNode).setStartAfter(tmpNode).collapse(true).select(true);}}me.fireEvent('saveScene');return true;}});me.addListener('beforeinserthtml',function(evtName,html){var me=this,rng=me.selection.getRange(),pre=domUtils.findParentByTagName(rng.startContainer,'pre',true);if(pre){if(!rng.collapsed){rng.deleteContents();}var htmlstr='';if(browser.ie&&browser.version>8){utils.each(UE.filterNode(UE.htmlparser(html),me.options.filterTxtRules).children,function(node){if(node.type=='element'){if(node.tagName=='br'){htmlstr+='\n';}else if(!dtd.$empty[node.tagName]){utils.each(node.children,function(cn){if(cn.type=='element'){if(cn.tagName=='br'){htmlstr+='\n';}else if(!dtd.$empty[node.tagName]){htmlstr+=cn.innerText();}}else{htmlstr+=cn.data;}});if(!/\n$/.test(htmlstr)){htmlstr+='\n';}}}else{htmlstr+=node.data+'\n';}if(!node.nextSibling()&&/\n$/.test(htmlstr)){htmlstr=htmlstr.replace(/\n$/,'');}});var tmpNode=me.document.createTextNode(utils.html(htmlstr.replace(/&nbsp;/g,' ')));rng.insertNode(tmpNode).selectNode(tmpNode).select();}else{var frag=me.document.createDocumentFragment();utils.each(UE.filterNode(UE.htmlparser(html),me.options.filterTxtRules).children,function(node){if(node.type=='element'){if(node.tagName=='br'){frag.appendChild(me.document.createElement('br'));}else if(!dtd.$empty[node.tagName]){utils.each(node.children,function(cn){if(cn.type=='element'){if(cn.tagName=='br'){frag.appendChild(me.document.createElement('br'));}else if(!dtd.$empty[node.tagName]){frag.appendChild(me.document.createTextNode(utils.html(cn.innerText().replace(/&nbsp;/g,' '))));}}else{frag.appendChild(me.document.createTextNode(utils.html(cn.data.replace(/&nbsp;/g,' '))));}});if(frag.lastChild.nodeName!='BR'){frag.appendChild(me.document.createElement('br'));}}}else{frag.appendChild(me.document.createTextNode(utils.html(node.data.replace(/&nbsp;/g,' '))));}if(!node.nextSibling()&&frag.lastChild.nodeName=='BR'){frag.removeChild(frag.lastChild);}});rng.insertNode(frag).select();}return true;}});me.addListener('keydown',function(cmd,evt){var me=this,keyCode=evt.keyCode||evt.which;if(keyCode==40){var rng=me.selection.getRange(),pre,start=rng.startContainer;if(rng.collapsed&&(pre=domUtils.findParentByTagName(rng.startContainer,'pre',true))&&!pre.nextSibling){var last=pre.lastChild;while(last&&last.nodeName=='BR'){last=last.previousSibling;}if(last===start||rng.startContainer===pre&&rng.startOffset==pre.childNodes.length){me.execCommand('insertparagraph');domUtils.preventDefault(evt);}}}});me.addListener('delkeydown',function(type,evt){var rng=this.selection.getRange();rng.txtToElmBoundary(true);var start=rng.startContainer;if(domUtils.isTagNode(start,'pre')&&rng.collapsed&&domUtils.isStartInblock(rng)){var p=me.document.createElement('p');domUtils.fillNode(me.document,p);start.parentNode.insertBefore(p,start);domUtils.remove(start);rng.setStart(p,0).setCursor(false,true);domUtils.preventDefault(evt);return true;}});};UE.commands['cleardoc']={execCommand:function execCommand(cmdName){var me=this,enterTag=me.options.enterTag,range=me.selection.getRange();if(enterTag=="br"){me.body.innerHTML="<br/>";range.setStart(me.body,0).setCursor();}else{me.body.innerHTML="<p>"+(ie?"":"<br/>")+"</p>";range.setStart(me.body.firstChild,0).setCursor(false,true);}setTimeout(function(){me.fireEvent("clearDoc");},0);}};UE.plugin.register('anchor',function(){return{bindEvents:{'ready':function ready(){utils.cssRule('anchor','.anchorclass{background: url(\''+this.options.themePath+this.options.theme+'/images/anchor.gif\') no-repeat scroll left center transparent;cursor: auto;display: inline-block;height: 16px;width: 15px;}',this.document);}},outputRule:function outputRule(root){utils.each(root.getNodesByTagName('img'),function(a){var val;if(val=a.getAttr('anchorname')){a.tagName='a';a.setAttr({anchorname:'',name:val,'class':''});}});},inputRule:function inputRule(root){utils.each(root.getNodesByTagName('a'),function(a){var val;if((val=a.getAttr('name'))&&!a.getAttr('href')){a.tagName='img';a.setAttr({anchorname:a.getAttr('name'),'class':'anchorclass'});a.setAttr('name');}});},commands:{'anchor':{execCommand:function execCommand(cmd,name){var range=this.selection.getRange(),img=range.getClosedNode();if(img&&img.getAttribute('anchorname')){if(name){img.setAttribute('anchorname',name);}else{range.setStartBefore(img).setCursor();domUtils.remove(img);}}else{if(name){var anchor=this.document.createElement('img');range.collapse(true);domUtils.setAttributes(anchor,{'anchorname':name,'class':'anchorclass'});range.insertNode(anchor).setStartAfter(anchor).setCursor(false,true);}}}}}};});UE.plugins['wordcount']=function(){var me=this;me.setOpt('wordCount',true);me.addListener('contentchange',function(){me.fireEvent('wordcount');});var timer;me.addListener('ready',function(){var me=this;domUtils.on(me.body,"keyup",function(evt){var code=evt.keyCode||evt.which,ignores={"16":1,"18":1,"20":1,"37":1,"38":1,"39":1,"40":1};if(code in ignores)return;clearTimeout(timer);timer=setTimeout(function(){me.fireEvent('wordcount');},200);});});};UE.plugins['pagebreak']=function(){var me=this,notBreakTags=['td'];me.setOpt('pageBreakTag','_ueditor_page_break_tag_');function fillNode(node){if(domUtils.isEmptyBlock(node)){var firstChild=node.firstChild,tmpNode;while(firstChild&&firstChild.nodeType==1&&domUtils.isEmptyBlock(firstChild)){tmpNode=firstChild;firstChild=firstChild.firstChild;}!tmpNode&&(tmpNode=node);domUtils.fillNode(me.document,tmpNode);}}
me.ready(function(){utils.cssRule('pagebreak','.pagebreak{display:block;clear:both !important;cursor:default !important;width: 100% !important;margin:0;}',me.document);});function isHr(node){return node&&node.nodeType==1&&node.tagName=='HR'&&node.className=='pagebreak';}me.addInputRule(function(root){root.traversal(function(node){if(node.type=='text'&&node.data==me.options.pageBreakTag){var hr=UE.uNode.createElement('<hr class="pagebreak" noshade="noshade" size="5" style="-webkit-user-select: none;">');node.parentNode.insertBefore(hr,node);node.parentNode.removeChild(node);}});});me.addOutputRule(function(node){utils.each(node.getNodesByTagName('hr'),function(n){if(n.getAttr('class')=='pagebreak'){var txt=UE.uNode.createText(me.options.pageBreakTag);n.parentNode.insertBefore(txt,n);n.parentNode.removeChild(n);}});});me.commands['pagebreak']={execCommand:function execCommand(){var range=me.selection.getRange(),hr=me.document.createElement('hr');domUtils.setAttributes(hr,{'class':'pagebreak',noshade:"noshade",size:"5"});domUtils.unSelectable(hr);var node=domUtils.findParentByTagName(range.startContainer,notBreakTags,true),parents=[],pN;if(node){switch(node.tagName){case'TD':pN=node.parentNode;if(!pN.previousSibling){var table=domUtils.findParentByTagName(pN,'table');table.parentNode.insertBefore(hr,table);parents=domUtils.findParents(hr,true);}else{pN.parentNode.insertBefore(hr,pN);parents=domUtils.findParents(hr);}pN=parents[1];if(hr!==pN){domUtils.breakParent(hr,pN);}
me.fireEvent('afteradjusttable',me.document);}}else{if(!range.collapsed){range.deleteContents();var start=range.startContainer;while(!domUtils.isBody(start)&&domUtils.isBlockElm(start)&&domUtils.isEmptyNode(start)){range.setStartBefore(start).collapse(true);domUtils.remove(start);start=range.startContainer;}}range.insertNode(hr);var pN=hr.parentNode,nextNode;while(!domUtils.isBody(pN)){domUtils.breakParent(hr,pN);nextNode=hr.nextSibling;if(nextNode&&domUtils.isEmptyBlock(nextNode)){domUtils.remove(nextNode);}pN=hr.parentNode;}nextNode=hr.nextSibling;var pre=hr.previousSibling;if(isHr(pre)){domUtils.remove(pre);}else{pre&&fillNode(pre);}if(!nextNode){var p=me.document.createElement('p');hr.parentNode.appendChild(p);domUtils.fillNode(me.document,p);range.setStart(p,0).collapse(true);}else{if(isHr(nextNode)){domUtils.remove(nextNode);}else{fillNode(nextNode);}range.setEndAfter(hr).collapse(false);}range.select(true);}}};};UE.plugin.register('wordimage',function(){var me=this,images=[];return{commands:{'wordimage':{execCommand:function execCommand(){var images=domUtils.getElementsByTagName(me.body,"img");var urlList=[];for(var i=0,ci;ci=images[i++];){var url=ci.getAttribute("word_img");url&&urlList.push(url);}return urlList;},queryCommandState:function queryCommandState(){images=domUtils.getElementsByTagName(me.body,"img");for(var i=0,ci;ci=images[i++];){if(ci.getAttribute("word_img")){return 1;}}return-1;},notNeedUndo:true}},inputRule:function inputRule(root){utils.each(root.getNodesByTagName('img'),function(img){var attrs=img.attrs,flag=parseInt(attrs.width)<128||parseInt(attrs.height)<43,opt=me.options,src=opt.UEDITOR_HOME_URL+'themes/default/images/spacer.gif';if(attrs['src']&&/^(?:(file:\/+))/.test(attrs['src'])){img.setAttr({width:attrs.width,height:attrs.height,alt:attrs.alt,word_img:attrs.src,src:src,'style':'background:url('+(flag?opt.themePath+opt.theme+'/images/word.gif':opt.langPath+opt.lang+'/images/localimage.png')+') no-repeat center center;border:1px solid #ddd'});}});}};});UE.plugins['dragdrop']=function(){var me=this;me.ready(function(){domUtils.on(this.body,'dragend',function(){var rng=me.selection.getRange();var node=rng.getClosedNode()||me.selection.getStart();if(node&&node.tagName=='IMG'){var pre=node.previousSibling,next;while(next=node.nextSibling){if(next.nodeType==1&&next.tagName=='SPAN'&&!next.firstChild){domUtils.remove(next);}else{break;}}if((pre&&pre.nodeType==1&&!domUtils.isEmptyBlock(pre)||!pre)&&(!next||next&&!domUtils.isEmptyBlock(next))){if(pre&&pre.tagName=='P'&&!domUtils.isEmptyBlock(pre)){pre.appendChild(node);domUtils.moveChild(next,pre);domUtils.remove(next);}else if(next&&next.tagName=='P'&&!domUtils.isEmptyBlock(next)){next.insertBefore(node,next.firstChild);}if(pre&&pre.tagName=='P'&&domUtils.isEmptyBlock(pre)){domUtils.remove(pre);}if(next&&next.tagName=='P'&&domUtils.isEmptyBlock(next)){domUtils.remove(next);}rng.selectNode(node).select();me.fireEvent('saveScene');}}});});me.addListener('keyup',function(type,evt){var keyCode=evt.keyCode||evt.which;if(keyCode==13){var rng=me.selection.getRange(),node;if(node=domUtils.findParentByTagName(rng.startContainer,'p',true)){if(domUtils.getComputedStyle(node,'text-align')=='center'){domUtils.removeStyle(node,'text-align');}}}});};UE.plugins['undo']=function(){var saveSceneTimer;var me=this,maxUndoCount=me.options.maxUndoCount||20,maxInputCount=me.options.maxInputCount||20,fillchar=new RegExp(domUtils.fillChar+'|<\/hr>','gi');var noNeedFillCharTags={ol:1,ul:1,table:1,tbody:1,tr:1,body:1};var orgState=me.options.autoClearEmptyNode;function compareAddr(indexA,indexB){if(indexA.length!=indexB.length)return 0;for(var i=0,l=indexA.length;i<l;i++){if(indexA[i]!=indexB[i])return 0;}return 1;}function compareRangeAddress(rngAddrA,rngAddrB){if(rngAddrA.collapsed!=rngAddrB.collapsed){return 0;}if(!compareAddr(rngAddrA.startAddress,rngAddrB.startAddress)||!compareAddr(rngAddrA.endAddress,rngAddrB.endAddress)){return 0;}return 1;}function UndoManager(){this.list=[];this.index=0;this.hasUndo=false;this.hasRedo=false;this.undo=function(){if(this.hasUndo){if(!this.list[this.index-1]&&this.list.length==1){this.reset();return;}while(this.list[this.index].content==this.list[this.index-1].content){this.index--;if(this.index==0){return this.restore(0);}}this.restore(--this.index);}};this.redo=function(){if(this.hasRedo){while(this.list[this.index].content==this.list[this.index+1].content){this.index++;if(this.index==this.list.length-1){return this.restore(this.index);}}this.restore(++this.index);}};this.restore=function(){var me=this.editor;var scene=this.list[this.index];var root=UE.htmlparser(scene.content.replace(fillchar,''));me.options.autoClearEmptyNode=false;me.filterInputRule(root);me.options.autoClearEmptyNode=orgState;me.document.body.innerHTML=root.toHtml();me.fireEvent('afterscencerestore');if(browser.ie){utils.each(domUtils.getElementsByTagName(me.document,'td th caption p'),function(node){if(domUtils.isEmptyNode(node)){domUtils.fillNode(me.document,node);}});}try{var rng=new dom.Range(me.document).moveToAddress(scene.address);rng.select(noNeedFillCharTags[rng.startContainer.nodeName.toLowerCase()]);}catch(e){}this.update();this.clearKey();me.fireEvent('reset',true);};this.getScene=function(){var me=this.editor;var rng=me.selection.getRange(),rngAddress=rng.createAddress(false,true);me.fireEvent('beforegetscene');var root=UE.htmlparser(me.body.innerHTML);me.options.autoClearEmptyNode=false;me.filterOutputRule(root);me.options.autoClearEmptyNode=orgState;var cont=root.toHtml();me.fireEvent('aftergetscene');return{address:rngAddress,content:cont};};this.save=function(notCompareRange,notSetCursor){clearTimeout(saveSceneTimer);var currentScene=this.getScene(notSetCursor),lastScene=this.list[this.index];if(lastScene&&lastScene.content!=currentScene.content){me.trigger('contentchange');}
if(lastScene&&lastScene.content==currentScene.content&&(notCompareRange?1:compareRangeAddress(lastScene.address,currentScene.address))){return;}this.list=this.list.slice(0,this.index+1);this.list.push(currentScene);if(this.list.length>maxUndoCount){this.list.shift();}this.index=this.list.length-1;this.clearKey();this.update();};this.update=function(){this.hasRedo=!!this.list[this.index+1];this.hasUndo=!!this.list[this.index-1];};this.reset=function(){this.list=[];this.index=0;this.hasUndo=false;this.hasRedo=false;this.clearKey();};this.clearKey=function(){keycont=0;lastKeyCode=null;};}me.undoManger=new UndoManager();me.undoManger.editor=me;function saveScene(){this.undoManger.save();}me.addListener('saveScene',function(){var args=Array.prototype.splice.call(arguments,1);this.undoManger.save.apply(this.undoManger,args);});me.addListener('reset',function(type,exclude){if(!exclude){this.undoManger.reset();}});me.commands['redo']=me.commands['undo']={execCommand:function execCommand(cmdName){this.undoManger[cmdName]();},queryCommandState:function queryCommandState(cmdName){return this.undoManger['has'+(cmdName.toLowerCase()=='undo'?'Undo':'Redo')]?0:-1;},notNeedUndo:1};var keys={16:1,17:1,18:1,37:1,38:1,39:1,40:1},keycont=0,lastKeyCode;var inputType=false;me.addListener('ready',function(){domUtils.on(this.body,'compositionstart',function(){inputType=true;});domUtils.on(this.body,'compositionend',function(){inputType=false;});});me.addshortcutkey({"Undo":"ctrl+90","Redo":"ctrl+89"});var isCollapsed=true;me.addListener('keydown',function(type,evt){var me=this;var keyCode=evt.keyCode||evt.which;if(!keys[keyCode]&&!evt.ctrlKey&&!evt.metaKey&&!evt.shiftKey&&!evt.altKey){var _ret2=function(){var save=function save(cont){cont.undoManger.save(false,true);cont.fireEvent('selectionchange');};if(inputType)return{v:void 0};if(!me.selection.getRange().collapsed){me.undoManger.save(false,true);isCollapsed=false;return{v:void 0};}if(me.undoManger.list.length==0){me.undoManger.save(true);}clearTimeout(saveSceneTimer);saveSceneTimer=setTimeout(function(){if(inputType){var interalTimer=setInterval(function(){if(!inputType){save(me);clearInterval(interalTimer);}},300);return;}save(me);},200);lastKeyCode=keyCode;keycont++;if(keycont>=maxInputCount){save(me);}}();if((typeof _ret2==='undefined'?'undefined':_typeof(_ret2))==="object")return _ret2.v;}});me.addListener('keyup',function(type,evt){var keyCode=evt.keyCode||evt.which;if(!keys[keyCode]&&!evt.ctrlKey&&!evt.metaKey&&!evt.shiftKey&&!evt.altKey){if(inputType)return;if(!isCollapsed){this.undoManger.save(false,true);isCollapsed=true;}}});me.stopCmdUndo=function(){me.__hasEnterExecCommand=true;};me.startCmdUndo=function(){me.__hasEnterExecCommand=false;};};UE.plugin.register('copy',function(){var me=this;function initZeroClipboard(){ZeroClipboard.config({debug:false,swfPath:me.options.UEDITOR_HOME_URL+'third-party/zeroclipboard/ZeroClipboard.swf'});var client=me.zeroclipboard=new ZeroClipboard();client.on('copy',function(e){var client=e.client,rng=me.selection.getRange(),div=document.createElement('div');div.appendChild(rng.cloneContents());client.setText(div.innerText||div.textContent);client.setHtml(div.innerHTML);rng.select();});client.on('mouseover mouseout',function(e){var target=e.target;if(e.type=='mouseover'){domUtils.addClass(target,'edui-state-hover');}else if(e.type=='mouseout'){domUtils.removeClasses(target,'edui-state-hover');}});client.on('wrongflash noflash',function(){ZeroClipboard.destroy();});}return{bindEvents:{'ready':function ready(){if(!browser.ie){if(window.ZeroClipboard){initZeroClipboard();}else{utils.loadFile(document,{src:me.options.UEDITOR_HOME_URL+"third-party/zeroclipboard/ZeroClipboard.js",tag:"script",type:"text/javascript",defer:"defer"},function(){initZeroClipboard();});}}}},commands:{'copy':{execCommand:function execCommand(cmd){if(!me.document.execCommand('copy')){alert(me.getLang('copymsg'));}}}}};});UE.plugins['paste']=function(){function getClipboardData(callback){var doc=this.document;if(doc.getElementById('baidu_pastebin')){return;}var range=this.selection.getRange(),bk=range.createBookmark(),pastebin=doc.createElement('div');pastebin.id='baidu_pastebin';browser.webkit&&pastebin.appendChild(doc.createTextNode(domUtils.fillChar+domUtils.fillChar));doc.body.appendChild(pastebin);bk.start.style.display='';pastebin.style.cssText="position:absolute;width:1px;height:1px;overflow:hidden;left:-1000px;white-space:nowrap;top:"+
domUtils.getXY(bk.start).y+'px';range.selectNodeContents(pastebin).select(true);setTimeout(function(){if(browser.webkit){for(var i=0,pastebins=doc.querySelectorAll('#baidu_pastebin'),pi;pi=pastebins[i++];){if(domUtils.isEmptyNode(pi)){domUtils.remove(pi);}else{pastebin=pi;break;}}}try{pastebin.parentNode.removeChild(pastebin);}catch(e){}range.moveToBookmark(bk).select(true);callback(pastebin);},0);}var me=this;me.setOpt({retainOnlyLabelPasted:false});var txtContent,htmlContent,address;function getPureHtml(html){return html.replace(/<(\/?)([\w\-]+)([^>]*)>/gi,function(a,b,tagName,attrs){tagName=tagName.toLowerCase();if({img:1}[tagName]){return a;}attrs=attrs.replace(/([\w\-]*?)\s*=\s*(("([^"]*)")|('([^']*)')|([^\s>]+))/gi,function(str,atr,val){if({'src':1,'href':1,'name':1}[atr.toLowerCase()]){return atr+'='+val+' ';}return'';});if({'span':1,'div':1}[tagName]){return'';}else{return'<'+b+tagName+' '+utils.trim(attrs)+'>';}});}function filter(div){var html;if(div.firstChild){var nodes=domUtils.getElementsByTagName(div,'span');for(var i=0,ni;ni=nodes[i++];){if(ni.id=='_baidu_cut_start'||ni.id=='_baidu_cut_end'){domUtils.remove(ni);}}if(browser.webkit){var brs=div.querySelectorAll('div br');for(var i=0,bi;bi=brs[i++];){var pN=bi.parentNode;if(pN.tagName=='DIV'&&pN.childNodes.length==1){pN.innerHTML='<p><br/></p>';domUtils.remove(pN);}}var divs=div.querySelectorAll('#baidu_pastebin');for(var i=0,di;di=divs[i++];){var tmpP=me.document.createElement('p');di.parentNode.insertBefore(tmpP,di);while(di.firstChild){tmpP.appendChild(di.firstChild);}domUtils.remove(di);}var metas=div.querySelectorAll('meta');for(var i=0,ci;ci=metas[i++];){domUtils.remove(ci);}var brs=div.querySelectorAll('br');for(i=0;ci=brs[i++];){if(/^apple-/i.test(ci.className)){domUtils.remove(ci);}}}if(browser.gecko){var dirtyNodes=div.querySelectorAll('[_moz_dirty]');for(i=0;ci=dirtyNodes[i++];){ci.removeAttribute('_moz_dirty');}}if(!browser.ie){var spans=div.querySelectorAll('span.Apple-style-span');for(var i=0,ci;ci=spans[i++];){domUtils.remove(ci,true);}}
html=div.innerHTML;html=UE.filterWord(html);var root=UE.htmlparser(html);if(me.options.filterRules){UE.filterNode(root,me.options.filterRules);}
me.filterInputRule(root);if(browser.webkit){var br=root.lastChild();if(br&&br.type=='element'&&br.tagName=='br'){root.removeChild(br);}utils.each(me.body.querySelectorAll('div'),function(node){if(domUtils.isEmptyBlock(node)){domUtils.remove(node,true);}});}html={'html':root.toHtml()};me.fireEvent('beforepaste',html,root);if(!html.html){return;}root=UE.htmlparser(html.html,true);if(me.queryCommandState('pasteplain')===1){me.execCommand('insertHtml',UE.filterNode(root,me.options.filterTxtRules).toHtml(),true);}else{UE.filterNode(root,me.options.filterTxtRules);txtContent=root.toHtml();htmlContent=html.html;address=me.selection.getRange().createAddress(true);me.execCommand('insertHtml',me.getOpt('retainOnlyLabelPasted')===true?getPureHtml(htmlContent):htmlContent,true);}me.fireEvent("afterpaste",html);}}me.addListener('pasteTransfer',function(cmd,plainType){if(address&&txtContent&&htmlContent&&txtContent!=htmlContent){var range=me.selection.getRange();range.moveToAddress(address,true);if(!range.collapsed){while(!domUtils.isBody(range.startContainer)){var start=range.startContainer;if(start.nodeType==1){start=start.childNodes[range.startOffset];if(!start){range.setStartBefore(range.startContainer);continue;}var pre=start.previousSibling;if(pre&&pre.nodeType==3&&new RegExp('^[\n\r\t '+domUtils.fillChar+']*$').test(pre.nodeValue)){range.setStartBefore(pre);}}if(range.startOffset==0){range.setStartBefore(range.startContainer);}else{break;}}while(!domUtils.isBody(range.endContainer)){var end=range.endContainer;if(end.nodeType==1){end=end.childNodes[range.endOffset];if(!end){range.setEndAfter(range.endContainer);continue;}var next=end.nextSibling;if(next&&next.nodeType==3&&new RegExp('^[\n\r\t'+domUtils.fillChar+']*$').test(next.nodeValue)){range.setEndAfter(next);}}if(range.endOffset==range.endContainer[range.endContainer.nodeType==3?'nodeValue':'childNodes'].length){range.setEndAfter(range.endContainer);}else{break;}}}range.deleteContents();range.select(true);me.__hasEnterExecCommand=true;var html=htmlContent;if(plainType===2){html=getPureHtml(html);}else if(plainType){html=txtContent;}me.execCommand('inserthtml',html,true);me.__hasEnterExecCommand=false;var rng=me.selection.getRange();while(!domUtils.isBody(rng.startContainer)&&!rng.startOffset&&rng.startContainer[rng.startContainer.nodeType==3?'nodeValue':'childNodes'].length){rng.setStartBefore(rng.startContainer);}var tmpAddress=rng.createAddress(true);address.endAddress=tmpAddress.startAddress;}});me.addListener('ready',function(){domUtils.on(me.body,'cut',function(){var range=me.selection.getRange();if(!range.collapsed&&me.undoManger){me.undoManger.save();}});domUtils.on(me.body,browser.ie||browser.opera?'keydown':'paste',function(e){if((browser.ie||browser.opera)&&(!e.ctrlKey&&!e.metaKey||e.keyCode!='86')){return;}getClipboardData.call(me,function(div){filter(div);});});});me.commands['paste']={execCommand:function execCommand(cmd){if(browser.ie){getClipboardData.call(me,function(div){filter(div);});me.document.execCommand('paste');}else{alert(me.getLang('pastemsg'));}}};};UE.plugins['pasteplain']=function(){var me=this;me.setOpt({'pasteplain':false,'filterTxtRules':function(){function transP(node){node.tagName='p';node.setStyle();}function removeNode(node){node.parentNode.removeChild(node,true);}return{'-':'script style object iframe embed input select','p':{$:{}},'br':{$:{}},div:function div(node){var tmpNode,p=UE.uNode.createElement('p');while(tmpNode=node.firstChild()){if(tmpNode.type=='text'||!UE.dom.dtd.$block[tmpNode.tagName]){p.appendChild(tmpNode);}else{if(p.firstChild()){node.parentNode.insertBefore(p,node);p=UE.uNode.createElement('p');}else{node.parentNode.insertBefore(tmpNode,node);}}}if(p.firstChild()){node.parentNode.insertBefore(p,node);}node.parentNode.removeChild(node);},ol:removeNode,ul:removeNode,dl:removeNode,dt:removeNode,dd:removeNode,'li':removeNode,'caption':transP,'th':transP,'tr':transP,'h1':transP,'h2':transP,'h3':transP,'h4':transP,'h5':transP,'h6':transP,'td':function td(node){var txt=!!node.innerText();if(txt){node.parentNode.insertAfter(UE.uNode.createText(' &nbsp; &nbsp;'),node);}node.parentNode.removeChild(node,node.innerText());}};}()});var pasteplain=me.options.pasteplain;me.commands['pasteplain']={queryCommandState:function queryCommandState(){return pasteplain?1:0;},execCommand:function execCommand(){pasteplain=!pasteplain|0;},notNeedUndo:1};};UE.plugins['list']=function(){var me=this,notExchange={'TD':1,'PRE':1,'BLOCKQUOTE':1};var customStyle={'cn':'cn-1-','cn1':'cn-2-','cn2':'cn-3-','num':'num-1-','num1':'num-2-','num2':'num-3-','dash':'dash','dot':'dot'};me.setOpt({'autoTransWordToList':false,'insertorderedlist':{'num':'','num1':'','num2':'','cn':'','cn1':'','cn2':'','decimal':'','lower-alpha':'','lower-roman':'','upper-alpha':'','upper-roman':''},'insertunorderedlist':{'circle':'','disc':'','square':'','dash':'','dot':''},listDefaultPaddingLeft:'30',listiconpath:'http://bs.baidu.com/listicon/',maxListLevel:-1,disablePInList:false});function listToArray(list){var arr=[];for(var p in list){arr.push(p);}return arr;}var listStyle={'OL':listToArray(me.options.insertorderedlist),'UL':listToArray(me.options.insertunorderedlist)};var liiconpath=me.options.listiconpath;for(var s in customStyle){if(!me.options.insertorderedlist.hasOwnProperty(s)&&!me.options.insertunorderedlist.hasOwnProperty(s)){delete customStyle[s];}}me.ready(function(){var customCss=[];for(var p in customStyle){if(p=='dash'||p=='dot'){customCss.push('li.list-'+customStyle[p]+'{background-image:url('+liiconpath+customStyle[p]+'.gif)}');customCss.push('ul.custom_'+p+'{list-style:none;}ul.custom_'+p+' li{background-position:0 3px;background-repeat:no-repeat}');}else{for(var i=0;i<99;i++){customCss.push('li.list-'+customStyle[p]+i+'{background-image:url('+liiconpath+'list-'+customStyle[p]+i+'.gif)}');}customCss.push('ol.custom_'+p+'{list-style:none;}ol.custom_'+p+' li{background-position:0 3px;background-repeat:no-repeat}');}switch(p){case'cn':customCss.push('li.list-'+p+'-paddingleft-1{padding-left:25px}');customCss.push('li.list-'+p+'-paddingleft-2{padding-left:40px}');customCss.push('li.list-'+p+'-paddingleft-3{padding-left:55px}');break;case'cn1':customCss.push('li.list-'+p+'-paddingleft-1{padding-left:30px}');customCss.push('li.list-'+p+'-paddingleft-2{padding-left:40px}');customCss.push('li.list-'+p+'-paddingleft-3{padding-left:55px}');break;case'cn2':customCss.push('li.list-'+p+'-paddingleft-1{padding-left:40px}');customCss.push('li.list-'+p+'-paddingleft-2{padding-left:55px}');customCss.push('li.list-'+p+'-paddingleft-3{padding-left:68px}');break;case'num':case'num1':customCss.push('li.list-'+p+'-paddingleft-1{padding-left:25px}');break;case'num2':customCss.push('li.list-'+p+'-paddingleft-1{padding-left:35px}');customCss.push('li.list-'+p+'-paddingleft-2{padding-left:40px}');break;case'dash':customCss.push('li.list-'+p+'-paddingleft{padding-left:35px}');break;case'dot':customCss.push('li.list-'+p+'-paddingleft{padding-left:20px}');}}customCss.push('.list-paddingleft-1{padding-left:0}');customCss.push('.list-paddingleft-2{padding-left:'+me.options.listDefaultPaddingLeft+'px}');customCss.push('.list-paddingleft-3{padding-left:'+me.options.listDefaultPaddingLeft*2+'px}');utils.cssRule('list','ol,ul{margin:0;pading:0;'+(browser.ie?'':'width:95%')+'}li{clear:both;}'+customCss.join('\n'),me.document);});me.ready(function(){domUtils.on(me.body,'cut',function(){setTimeout(function(){var rng=me.selection.getRange(),li;if(!rng.collapsed){if(li=domUtils.findParentByTagName(rng.startContainer,'li',true)){if(!li.nextSibling&&domUtils.isEmptyBlock(li)){var pn=li.parentNode,node;if(node=pn.previousSibling){domUtils.remove(pn);rng.setStartAtLast(node).collapse(true);rng.select(true);}else if(node=pn.nextSibling){domUtils.remove(pn);rng.setStartAtFirst(node).collapse(true);rng.select(true);}else{var tmpNode=me.document.createElement('p');domUtils.fillNode(me.document,tmpNode);pn.parentNode.insertBefore(tmpNode,pn);domUtils.remove(pn);rng.setStart(tmpNode,0).collapse(true);rng.select(true);}}}}});});});function getStyle(node){var cls=node.className;if(domUtils.hasClass(node,/custom_/)){return cls.match(/custom_(\w+)/)[1];}return domUtils.getStyle(node,'list-style-type');}me.addListener('beforepaste',function(type,html){var me=this,rng=me.selection.getRange(),li;var root=UE.htmlparser(html.html,true);if(li=domUtils.findParentByTagName(rng.startContainer,'li',true)){var list=li.parentNode,tagName=list.tagName=='OL'?'ul':'ol';utils.each(root.getNodesByTagName(tagName),function(n){n.tagName=list.tagName;n.setAttr();if(n.parentNode===root){type=getStyle(list)||(list.tagName=='OL'?'decimal':'disc');}else{var className=n.parentNode.getAttr('class');if(className&&/custom_/.test(className)){type=className.match(/custom_(\w+)/)[1];}else{type=n.parentNode.getStyle('list-style-type');}if(!type){type=list.tagName=='OL'?'decimal':'disc';}}var index=utils.indexOf(listStyle[list.tagName],type);if(n.parentNode!==root)index=index+1==listStyle[list.tagName].length?0:index+1;var currentStyle=listStyle[list.tagName][index];if(customStyle[currentStyle]){n.setAttr('class','custom_'+currentStyle);}else{n.setStyle('list-style-type',currentStyle);}});}html.html=root.toHtml();});me.getOpt('disablePInList')===true&&me.addOutputRule(function(root){utils.each(root.getNodesByTagName('li'),function(li){var newChildrens=[],index=0;utils.each(li.children,function(n){if(n.tagName=='p'){var tmpNode;while(tmpNode=n.children.pop()){newChildrens.splice(index,0,tmpNode);tmpNode.parentNode=li;lastNode=tmpNode;}tmpNode=newChildrens[newChildrens.length-1];if(!tmpNode||tmpNode.type!='element'||tmpNode.tagName!='br'){var br=UE.uNode.createElement('br');br.parentNode=li;newChildrens.push(br);}index=newChildrens.length;}});if(newChildrens.length){li.children=newChildrens;}});});me.addInputRule(function(root){utils.each(root.getNodesByTagName('li'),function(li){var tmpP=UE.uNode.createElement('p');for(var i=0,ci;ci=li.children[i];){if(ci.type=='text'||dtd.p[ci.tagName]){tmpP.appendChild(ci);}else{if(tmpP.firstChild()){li.insertBefore(tmpP,ci);tmpP=UE.uNode.createElement('p');i=i+2;}else{i++;}}}if(tmpP.firstChild()&&!tmpP.parentNode||!li.firstChild()){li.appendChild(tmpP);}
if(!tmpP.firstChild()){tmpP.innerHTML(browser.ie?'&nbsp;':'<br/>');}
var p=li.firstChild();var lastChild=p.lastChild();if(lastChild&&lastChild.type=='text'&&/^\s*$/.test(lastChild.data)){p.removeChild(lastChild);}});if(me.options.autoTransWordToList){var orderlisttype,unorderlisttype;(function(){var checkListType=function checkListType(content,container){var span=container.firstChild();if(span&&span.type=='element'&&span.tagName=='span'&&/Wingdings|Symbol/.test(span.getStyle('font-family'))){for(var p in unorderlisttype){if(unorderlisttype[p]==span.data){return p;}}return'disc';}for(var p in orderlisttype){if(orderlisttype[p].test(content)){return p;}}};orderlisttype={'num1':/^\d+\)/,'decimal':/^\d+\./,'lower-alpha':/^[a-z]+\)/,'upper-alpha':/^[A-Z]+\./,'cn':/^[\u4E00\u4E8C\u4E09\u56DB\u516d\u4e94\u4e03\u516b\u4e5d]+[\u3001]/,'cn2':/^\([\u4E00\u4E8C\u4E09\u56DB\u516d\u4e94\u4e03\u516b\u4e5d]+\)/};unorderlisttype={'square':'n'};utils.each(root.getNodesByTagName('p'),function(node){if(node.getAttr('class')!='MsoListParagraph'){return;}
node.setStyle('margin','');node.setStyle('margin-left','');node.setAttr('class','');function appendLi(list,p,type){if(list.tagName=='ol'){if(browser.ie){var first=p.firstChild();if(first.type=='element'&&first.tagName=='span'&&orderlisttype[type].test(first.innerText())){p.removeChild(first);}}else{p.innerHTML(p.innerHTML().replace(orderlisttype[type],''));}}else{p.removeChild(p.firstChild());}var li=UE.uNode.createElement('li');li.appendChild(p);list.appendChild(li);}var tmp=node,type,cacheNode=node;if(node.parentNode.tagName!='li'&&(type=checkListType(node.innerText(),node))){var list=UE.uNode.createElement(me.options.insertorderedlist.hasOwnProperty(type)?'ol':'ul');if(customStyle[type]){list.setAttr('class','custom_'+type);}else{list.setStyle('list-style-type',type);}while(node&&node.parentNode.tagName!='li'&&checkListType(node.innerText(),node)){tmp=node.nextSibling();if(!tmp){node.parentNode.insertBefore(list,node);}appendLi(list,node,type);node=tmp;}if(!list.parentNode&&node&&node.parentNode){node.parentNode.insertBefore(list,node);}}var span=cacheNode.firstChild();if(span&&span.type=='element'&&span.tagName=='span'&&/^\s*(&nbsp;)+\s*$/.test(span.innerText())){span.parentNode.removeChild(span);}});})();}});me.addListener('contentchange',function(){adjustListStyle(me.document);});function adjustListStyle(doc,ignore){utils.each(domUtils.getElementsByTagName(doc,'ol ul'),function(node){if(!domUtils.inDoc(node,doc))return;var parent=node.parentNode;if(parent.tagName==node.tagName){var nodeStyleType=getStyle(node)||(node.tagName=='OL'?'decimal':'disc'),parentStyleType=getStyle(parent)||(parent.tagName=='OL'?'decimal':'disc');if(nodeStyleType==parentStyleType){var styleIndex=utils.indexOf(listStyle[node.tagName],nodeStyleType);styleIndex=styleIndex+1==listStyle[node.tagName].length?0:styleIndex+1;setListStyle(node,listStyle[node.tagName][styleIndex]);}}var index=0,type=2;if(domUtils.hasClass(node,/custom_/)){if(!(/[ou]l/i.test(parent.tagName)&&domUtils.hasClass(parent,/custom_/))){type=1;}}else{if(/[ou]l/i.test(parent.tagName)&&domUtils.hasClass(parent,/custom_/)){type=3;}}var style=domUtils.getStyle(node,'list-style-type');style&&(node.style.cssText='list-style-type:'+style);node.className=utils.trim(node.className.replace(/list-paddingleft-\w+/,''))+' list-paddingleft-'+type;utils.each(domUtils.getElementsByTagName(node,'li'),function(li){li.style.cssText&&(li.style.cssText='');if(!li.firstChild){domUtils.remove(li);return;}if(li.parentNode!==node){return;}index++;if(domUtils.hasClass(node,/custom_/)){var paddingLeft=1,currentStyle=getStyle(node);if(node.tagName=='OL'){if(currentStyle){switch(currentStyle){case'cn':case'cn1':case'cn2':if(index>10&&(index%10==0||index>10&&index<20)){paddingLeft=2;}else if(index>20){paddingLeft=3;}break;case'num2':if(index>9){paddingLeft=2;}}}li.className='list-'+customStyle[currentStyle]+index+' '+'list-'+currentStyle+'-paddingleft-'+paddingLeft;}else{li.className='list-'+customStyle[currentStyle]+' '+'list-'+currentStyle+'-paddingleft';}}else{li.className=li.className.replace(/list-[\w\-]+/gi,'');}var className=li.getAttribute('class');if(className!==null&&!className.replace(/\s/g,'')){domUtils.removeAttributes(li,'class');}});!ignore&&adjustList(node,node.tagName.toLowerCase(),getStyle(node)||domUtils.getStyle(node,'list-style-type'),true);});}function adjustList(list,tag,style,ignoreEmpty){var nextList=list.nextSibling;if(nextList&&nextList.nodeType==1&&nextList.tagName.toLowerCase()==tag&&(getStyle(nextList)||domUtils.getStyle(nextList,'list-style-type')||(tag=='ol'?'decimal':'disc'))==style){domUtils.moveChild(nextList,list);if(nextList.childNodes.length==0){domUtils.remove(nextList);}}if(nextList&&domUtils.isFillChar(nextList)){domUtils.remove(nextList);}var preList=list.previousSibling;if(preList&&preList.nodeType==1&&preList.tagName.toLowerCase()==tag&&(getStyle(preList)||domUtils.getStyle(preList,'list-style-type')||(tag=='ol'?'decimal':'disc'))==style){domUtils.moveChild(list,preList);}if(preList&&domUtils.isFillChar(preList)){domUtils.remove(preList);}!ignoreEmpty&&domUtils.isEmptyBlock(list)&&domUtils.remove(list);if(getStyle(list)){adjustListStyle(list.ownerDocument,true);}}function setListStyle(list,style){if(customStyle[style]){list.className='custom_'+style;}try{domUtils.setStyle(list,'list-style-type',style);}catch(e){}}function clearEmptySibling(node){var tmpNode=node.previousSibling;if(tmpNode&&domUtils.isEmptyBlock(tmpNode)){domUtils.remove(tmpNode);}tmpNode=node.nextSibling;if(tmpNode&&domUtils.isEmptyBlock(tmpNode)){domUtils.remove(tmpNode);}}me.addListener('keydown',function(type,evt){function preventAndSave(){evt.preventDefault?evt.preventDefault():evt.returnValue=false;me.fireEvent('contentchange');me.undoManger&&me.undoManger.save();}function findList(node,filterFn){while(node&&!domUtils.isBody(node)){if(filterFn(node)){return null;}if(node.nodeType==1&&/[ou]l/i.test(node.tagName)){return node;}node=node.parentNode;}return null;}var keyCode=evt.keyCode||evt.which;if(keyCode==13&&!evt.shiftKey){var rng=me.selection.getRange(),parent=domUtils.findParent(rng.startContainer,function(node){return domUtils.isBlockElm(node);},true),li=domUtils.findParentByTagName(rng.startContainer,'li',true);if(parent&&parent.tagName!='PRE'&&!li){var html=parent.innerHTML.replace(new RegExp(domUtils.fillChar,'g'),'');if(/^\s*1\s*\.[^\d]/.test(html)){parent.innerHTML=html.replace(/^\s*1\s*\./,'');rng.setStartAtLast(parent).collapse(true).select();me.__hasEnterExecCommand=true;me.execCommand('insertorderedlist');me.__hasEnterExecCommand=false;}}var range=me.selection.getRange(),start=findList(range.startContainer,function(node){return node.tagName=='TABLE';}),end=range.collapsed?start:findList(range.endContainer,function(node){return node.tagName=='TABLE';});if(start&&end&&start===end){if(!range.collapsed){start=domUtils.findParentByTagName(range.startContainer,'li',true);end=domUtils.findParentByTagName(range.endContainer,'li',true);if(start&&end&&start===end){range.deleteContents();li=domUtils.findParentByTagName(range.startContainer,'li',true);if(li&&domUtils.isEmptyBlock(li)){pre=li.previousSibling;next=li.nextSibling;p=me.document.createElement('p');domUtils.fillNode(me.document,p);parentList=li.parentNode;if(pre&&next){range.setStart(next,0).collapse(true).select(true);domUtils.remove(li);}else{if(!pre&&!next||!pre){parentList.parentNode.insertBefore(p,parentList);}else{li.parentNode.parentNode.insertBefore(p,parentList.nextSibling);}domUtils.remove(li);if(!parentList.firstChild){domUtils.remove(parentList);}range.setStart(p,0).setCursor();}preventAndSave();return;}}else{var tmpRange=range.cloneRange(),bk=tmpRange.collapse(false).createBookmark();range.deleteContents();tmpRange.moveToBookmark(bk);var li=domUtils.findParentByTagName(tmpRange.startContainer,'li',true);clearEmptySibling(li);tmpRange.select();preventAndSave();return;}}li=domUtils.findParentByTagName(range.startContainer,'li',true);if(li){if(domUtils.isEmptyBlock(li)){bk=range.createBookmark();var parentList=li.parentNode;if(li!==parentList.lastChild){domUtils.breakParent(li,parentList);clearEmptySibling(li);}else{parentList.parentNode.insertBefore(li,parentList.nextSibling);if(domUtils.isEmptyNode(parentList)){domUtils.remove(parentList);}}
if(!dtd.$list[li.parentNode.tagName]){if(!domUtils.isBlockElm(li.firstChild)){p=me.document.createElement('p');li.parentNode.insertBefore(p,li);while(li.firstChild){p.appendChild(li.firstChild);}domUtils.remove(li);}else{domUtils.remove(li,true);}}range.moveToBookmark(bk).select();}else{var first=li.firstChild;if(!first||!domUtils.isBlockElm(first)){var p=me.document.createElement('p');!li.firstChild&&domUtils.fillNode(me.document,p);while(li.firstChild){p.appendChild(li.firstChild);}li.appendChild(p);first=p;}var span=me.document.createElement('span');range.insertNode(span);domUtils.breakParent(span,li);var nextLi=span.nextSibling;first=nextLi.firstChild;if(!first){p=me.document.createElement('p');domUtils.fillNode(me.document,p);nextLi.appendChild(p);first=p;}if(domUtils.isEmptyNode(first)){first.innerHTML='';domUtils.fillNode(me.document,first);}range.setStart(first,0).collapse(true).shrinkBoundary().select();domUtils.remove(span);var pre=nextLi.previousSibling;if(pre&&domUtils.isEmptyBlock(pre)){pre.innerHTML='<p></p>';domUtils.fillNode(me.document,pre.firstChild);}}
preventAndSave();}}}if(keyCode==8){range=me.selection.getRange();if(range.collapsed&&domUtils.isStartInblock(range)){tmpRange=range.cloneRange().trimBoundary();li=domUtils.findParentByTagName(range.startContainer,'li',true);if(li&&domUtils.isStartInblock(tmpRange)){start=domUtils.findParentByTagName(range.startContainer,'p',true);if(start&&start!==li.firstChild){var parentList=domUtils.findParentByTagName(start,['ol','ul']);domUtils.breakParent(start,parentList);clearEmptySibling(start);me.fireEvent('contentchange');range.setStart(start,0).setCursor(false,true);me.fireEvent('saveScene');domUtils.preventDefault(evt);return;}if(li&&(pre=li.previousSibling)){if(keyCode==46&&li.childNodes.length){return;}
if(dtd.$list[pre.tagName]){pre=pre.lastChild;}me.undoManger&&me.undoManger.save();first=li.firstChild;if(domUtils.isBlockElm(first)){if(domUtils.isEmptyNode(first)){pre.appendChild(first);range.setStart(first,0).setCursor(false,true);while(li.firstChild){pre.appendChild(li.firstChild);}}else{span=me.document.createElement('span');range.insertNode(span);if(domUtils.isEmptyBlock(pre)){pre.innerHTML='';}domUtils.moveChild(li,pre);range.setStartBefore(span).collapse(true).select(true);domUtils.remove(span);}}else{if(domUtils.isEmptyNode(li)){var p=me.document.createElement('p');pre.appendChild(p);range.setStart(p,0).setCursor();}else{range.setEnd(pre,pre.childNodes.length).collapse().select(true);while(li.firstChild){pre.appendChild(li.firstChild);}}}domUtils.remove(li);me.fireEvent('contentchange');me.fireEvent('saveScene');domUtils.preventDefault(evt);return;}
if(li&&!li.previousSibling){var parentList=li.parentNode;var bk=range.createBookmark();if(domUtils.isTagNode(parentList.parentNode,'ol ul')){parentList.parentNode.insertBefore(li,parentList);if(domUtils.isEmptyNode(parentList)){domUtils.remove(parentList);}}else{while(li.firstChild){parentList.parentNode.insertBefore(li.firstChild,parentList);}domUtils.remove(li);if(domUtils.isEmptyNode(parentList)){domUtils.remove(parentList);}}range.moveToBookmark(bk).setCursor(false,true);me.fireEvent('contentchange');me.fireEvent('saveScene');domUtils.preventDefault(evt);return;}}}}});me.addListener('keyup',function(type,evt){var keyCode=evt.keyCode||evt.which;if(keyCode==8){var rng=me.selection.getRange(),list;if(list=domUtils.findParentByTagName(rng.startContainer,['ol','ul'],true)){adjustList(list,list.tagName.toLowerCase(),getStyle(list)||domUtils.getComputedStyle(list,'list-style-type'),true);}}});me.addListener('tabkeydown',function(){var range=me.selection.getRange();function checkLevel(li){if(me.options.maxListLevel!=-1){var level=li.parentNode,levelNum=0;while(/[ou]l/i.test(level.tagName)){levelNum++;level=level.parentNode;}if(levelNum>=me.options.maxListLevel){return true;}}}
var li=domUtils.findParentByTagName(range.startContainer,'li',true);if(li){var bk;if(range.collapsed){if(checkLevel(li))return true;var parentLi=li.parentNode,list=me.document.createElement(parentLi.tagName),index=utils.indexOf(listStyle[list.tagName],getStyle(parentLi)||domUtils.getComputedStyle(parentLi,'list-style-type'));index=index+1==listStyle[list.tagName].length?0:index+1;var currentStyle=listStyle[list.tagName][index];setListStyle(list,currentStyle);if(domUtils.isStartInblock(range)){me.fireEvent('saveScene');bk=range.createBookmark();parentLi.insertBefore(list,li);list.appendChild(li);adjustList(list,list.tagName.toLowerCase(),currentStyle);me.fireEvent('contentchange');range.moveToBookmark(bk).select(true);return true;}}else{me.fireEvent('saveScene');bk=range.createBookmark();for(var i=0,closeList,parents=domUtils.findParents(li),ci;ci=parents[i++];){if(domUtils.isTagNode(ci,'ol ul')){closeList=ci;break;}}var current=li;if(bk.end){while(current&&!(domUtils.getPosition(current,bk.end)&domUtils.POSITION_FOLLOWING)){if(checkLevel(current)){current=domUtils.getNextDomNode(current,false,null,function(node){return node!==closeList;});continue;}var parentLi=current.parentNode,list=me.document.createElement(parentLi.tagName),index=utils.indexOf(listStyle[list.tagName],getStyle(parentLi)||domUtils.getComputedStyle(parentLi,'list-style-type'));var currentIndex=index+1==listStyle[list.tagName].length?0:index+1;var currentStyle=listStyle[list.tagName][currentIndex];setListStyle(list,currentStyle);parentLi.insertBefore(list,current);while(current&&!(domUtils.getPosition(current,bk.end)&domUtils.POSITION_FOLLOWING)){li=current.nextSibling;list.appendChild(current);if(!li||domUtils.isTagNode(li,'ol ul')){if(li){while(li=li.firstChild){if(li.tagName=='LI'){break;}}}else{li=domUtils.getNextDomNode(current,false,null,function(node){return node!==closeList;});}break;}current=li;}adjustList(list,list.tagName.toLowerCase(),currentStyle);current=li;}}me.fireEvent('contentchange');range.moveToBookmark(bk).select();return true;}}});function getLi(start){while(start&&!domUtils.isBody(start)){if(start.nodeName=='TABLE'){return null;}if(start.nodeName=='LI'){return start;}start=start.parentNode;}}me.commands['insertorderedlist']=me.commands['insertunorderedlist']={execCommand:function execCommand(command,style){if(!style){style=command.toLowerCase()=='insertorderedlist'?'decimal':'disc';}var me=this,range=this.selection.getRange(),filterFn=function filterFn(node){return node.nodeType==1?node.tagName.toLowerCase()!='br':!domUtils.isWhitespace(node);},tag=command.toLowerCase()=='insertorderedlist'?'ol':'ul',frag=me.document.createDocumentFragment();range.adjustmentBoundary().shrinkBoundary();var bko=range.createBookmark(true),start=getLi(me.document.getElementById(bko.start)),modifyStart=0,end=getLi(me.document.getElementById(bko.end)),modifyEnd=0,startParent,endParent,list,tmp;if(start||end){start&&(startParent=start.parentNode);if(!bko.end){end=start;}end&&(endParent=end.parentNode);if(startParent===endParent){while(start!==end){tmp=start;start=start.nextSibling;if(!domUtils.isBlockElm(tmp.firstChild)){var p=me.document.createElement('p');while(tmp.firstChild){p.appendChild(tmp.firstChild);}tmp.appendChild(p);}frag.appendChild(tmp);}tmp=me.document.createElement('span');startParent.insertBefore(tmp,end);if(!domUtils.isBlockElm(end.firstChild)){p=me.document.createElement('p');while(end.firstChild){p.appendChild(end.firstChild);}end.appendChild(p);}frag.appendChild(end);domUtils.breakParent(tmp,startParent);if(domUtils.isEmptyNode(tmp.previousSibling)){domUtils.remove(tmp.previousSibling);}if(domUtils.isEmptyNode(tmp.nextSibling)){domUtils.remove(tmp.nextSibling);}var nodeStyle=getStyle(startParent)||domUtils.getComputedStyle(startParent,'list-style-type')||(command.toLowerCase()=='insertorderedlist'?'decimal':'disc');if(startParent.tagName.toLowerCase()==tag&&nodeStyle==style){for(var i=0,ci,tmpFrag=me.document.createDocumentFragment();ci=frag.firstChild;){if(domUtils.isTagNode(ci,'ol ul')){tmpFrag.appendChild(ci);}else{while(ci.firstChild){tmpFrag.appendChild(ci.firstChild);domUtils.remove(ci);}}}tmp.parentNode.insertBefore(tmpFrag,tmp);}else{list=me.document.createElement(tag);setListStyle(list,style);list.appendChild(frag);tmp.parentNode.insertBefore(list,tmp);}domUtils.remove(tmp);list&&adjustList(list,tag,style);range.moveToBookmark(bko).select();return;}
if(start){while(start){tmp=start.nextSibling;if(domUtils.isTagNode(start,'ol ul')){frag.appendChild(start);}else{var tmpfrag=me.document.createDocumentFragment(),hasBlock=0;while(start.firstChild){if(domUtils.isBlockElm(start.firstChild)){hasBlock=1;}tmpfrag.appendChild(start.firstChild);}if(!hasBlock){var tmpP=me.document.createElement('p');tmpP.appendChild(tmpfrag);frag.appendChild(tmpP);}else{frag.appendChild(tmpfrag);}domUtils.remove(start);}start=tmp;}startParent.parentNode.insertBefore(frag,startParent.nextSibling);if(domUtils.isEmptyNode(startParent)){range.setStartBefore(startParent);domUtils.remove(startParent);}else{range.setStartAfter(startParent);}modifyStart=1;}if(end&&domUtils.inDoc(endParent,me.document)){start=endParent.firstChild;while(start&&start!==end){tmp=start.nextSibling;if(domUtils.isTagNode(start,'ol ul')){frag.appendChild(start);}else{tmpfrag=me.document.createDocumentFragment();hasBlock=0;while(start.firstChild){if(domUtils.isBlockElm(start.firstChild)){hasBlock=1;}tmpfrag.appendChild(start.firstChild);}if(!hasBlock){tmpP=me.document.createElement('p');tmpP.appendChild(tmpfrag);frag.appendChild(tmpP);}else{frag.appendChild(tmpfrag);}domUtils.remove(start);}start=tmp;}var tmpDiv=domUtils.createElement(me.document,'div',{'tmpDiv':1});domUtils.moveChild(end,tmpDiv);frag.appendChild(tmpDiv);domUtils.remove(end);endParent.parentNode.insertBefore(frag,endParent);range.setEndBefore(endParent);if(domUtils.isEmptyNode(endParent)){domUtils.remove(endParent);}modifyEnd=1;}}if(!modifyStart){range.setStartBefore(me.document.getElementById(bko.start));}if(bko.end&&!modifyEnd){range.setEndAfter(me.document.getElementById(bko.end));}range.enlarge(true,function(node){return notExchange[node.tagName];});frag=me.document.createDocumentFragment();var bk=range.createBookmark(),current=domUtils.getNextDomNode(bk.start,false,filterFn),tmpRange=range.cloneRange(),tmpNode,block=domUtils.isBlockElm;while(current&&current!==bk.end&&domUtils.getPosition(current,bk.end)&domUtils.POSITION_PRECEDING){if(current.nodeType==3||dtd.li[current.tagName]){if(current.nodeType==1&&dtd.$list[current.tagName]){while(current.firstChild){frag.appendChild(current.firstChild);}tmpNode=domUtils.getNextDomNode(current,false,filterFn);domUtils.remove(current);current=tmpNode;continue;}tmpNode=current;tmpRange.setStartBefore(current);while(current&&current!==bk.end&&(!block(current)||domUtils.isBookmarkNode(current))){tmpNode=current;current=domUtils.getNextDomNode(current,false,null,function(node){return!notExchange[node.tagName];});}if(current&&block(current)){tmp=domUtils.getNextDomNode(tmpNode,false,filterFn);if(tmp&&domUtils.isBookmarkNode(tmp)){current=domUtils.getNextDomNode(tmp,false,filterFn);tmpNode=tmp;}}tmpRange.setEndAfter(tmpNode);current=domUtils.getNextDomNode(tmpNode,false,filterFn);var li=range.document.createElement('li');li.appendChild(tmpRange.extractContents());if(domUtils.isEmptyNode(li)){var tmpNode=range.document.createElement('p');while(li.firstChild){tmpNode.appendChild(li.firstChild);}li.appendChild(tmpNode);}frag.appendChild(li);}else{current=domUtils.getNextDomNode(current,true,filterFn);}}range.moveToBookmark(bk).collapse(true);list=me.document.createElement(tag);setListStyle(list,style);list.appendChild(frag);range.insertNode(list);adjustList(list,tag,style);for(var i=0,ci,tmpDivs=domUtils.getElementsByTagName(list,'div');ci=tmpDivs[i++];){if(ci.getAttribute('tmpDiv')){domUtils.remove(ci,true);}}range.moveToBookmark(bko).select();},queryCommandState:function queryCommandState(command){var tag=command.toLowerCase()=='insertorderedlist'?'ol':'ul';var path=this.selection.getStartElementPath();for(var i=0,ci;ci=path[i++];){if(ci.nodeName=='TABLE'){return 0;}if(tag==ci.nodeName.toLowerCase()){return 1;};}return 0;},queryCommandValue:function queryCommandValue(command){var tag=command.toLowerCase()=='insertorderedlist'?'ol':'ul';var path=this.selection.getStartElementPath(),node;for(var i=0,ci;ci=path[i++];){if(ci.nodeName=='TABLE'){node=null;break;}if(tag==ci.nodeName.toLowerCase()){node=ci;break;};}return node?getStyle(node)||domUtils.getComputedStyle(node,'list-style-type'):null;}};};(function(){var sourceEditors={textarea:function textarea(editor,holder){var textarea=holder.ownerDocument.createElement('textarea');textarea.style.cssText='position:absolute;resize:none;width:100%;height:100%;border:0;padding:0;margin:0;overflow-y:auto;';if(browser.ie&&browser.version<8){textarea.style.width=holder.offsetWidth+'px';textarea.style.height=holder.offsetHeight+'px';holder.onresize=function(){textarea.style.width=holder.offsetWidth+'px';textarea.style.height=holder.offsetHeight+'px';};}holder.appendChild(textarea);return{setContent:function setContent(content){textarea.value=content;},getContent:function getContent(){return textarea.value;},select:function select(){var range;if(browser.ie){range=textarea.createTextRange();range.collapse(true);range.select();}else{textarea.setSelectionRange(0,0);textarea.focus();}},dispose:function dispose(){holder.removeChild(textarea);holder.onresize=null;textarea=null;holder=null;}};},codemirror:function codemirror(editor,holder){var codeEditor=window.CodeMirror(holder,{mode:"text/html",tabMode:"indent",lineNumbers:true,lineWrapping:true});var dom=codeEditor.getWrapperElement();dom.style.cssText='position:absolute;left:0;top:0;width:100%;height:100%;font-family:consolas,"Courier new",monospace;font-size:13px;';codeEditor.getScrollerElement().style.cssText='position:absolute;left:0;top:0;width:100%;height:100%;';codeEditor.refresh();return{getCodeMirror:function getCodeMirror(){return codeEditor;},setContent:function setContent(content){codeEditor.setValue(content);},getContent:function getContent(){return codeEditor.getValue();},select:function select(){codeEditor.focus();},dispose:function dispose(){holder.removeChild(dom);dom=null;codeEditor=null;}};}};UE.plugins['source']=function(){var me=this;var opt=this.options;var sourceMode=false;var sourceEditor;var orgSetContent;opt.sourceEditor=browser.ie?'textarea':opt.sourceEditor||'codemirror';me.setOpt({sourceEditorFirst:false});function createSourceEditor(holder){return sourceEditors[opt.sourceEditor=='codemirror'&&window.CodeMirror?'codemirror':'textarea'](me,holder);}var bakCssText;var oldGetContent,bakAddress;me.commands['source']={execCommand:function execCommand(){sourceMode=!sourceMode;if(sourceMode){bakAddress=me.selection.getRange().createAddress(false,true);me.undoManger&&me.undoManger.save(true);if(browser.gecko){me.body.contentEditable=false;}bakCssText=me.iframe.style.cssText;me.iframe.style.cssText+='position:absolute;left:-32768px;top:-32768px;';me.fireEvent('beforegetcontent');var root=UE.htmlparser(me.body.innerHTML);me.filterOutputRule(root);root.traversal(function(node){if(node.type=='element'){switch(node.tagName){case'td':case'th':case'caption':if(node.children&&node.children.length==1){if(node.firstChild().tagName=='br'){node.removeChild(node.firstChild());}};break;case'pre':node.innerText(node.innerText().replace(/&nbsp;/g,' '));}}});me.fireEvent('aftergetcontent');var content=root.toHtml(true);sourceEditor=createSourceEditor(me.iframe.parentNode);sourceEditor.setContent(content);orgSetContent=me.setContent;me.setContent=function(html){var root=UE.htmlparser(html);me.filterInputRule(root);html=root.toHtml();sourceEditor.setContent(html);};setTimeout(function(){sourceEditor.select();me.addListener('fullscreenchanged',function(){try{sourceEditor.getCodeMirror().refresh();}catch(e){}});});oldGetContent=me.getContent;me.getContent=function(){return sourceEditor.getContent()||'<p>'+(browser.ie?'':'<br/>')+'</p>';};}else{me.iframe.style.cssText=bakCssText;var cont=sourceEditor.getContent()||'<p>'+(browser.ie?'':'<br/>')+'</p>';cont=cont.replace(new RegExp('[\\r\\t\\n ]*<\/?(\\w+)\\s*(?:[^>]*)>','g'),function(a,b){if(b&&!dtd.$inlineWithA[b.toLowerCase()]){return a.replace(/(^[\n\r\t ]*)|([\n\r\t ]*$)/g,'');}return a.replace(/(^[\n\r\t]*)|([\n\r\t]*$)/g,'');});me.setContent=orgSetContent;me.setContent(cont);sourceEditor.dispose();sourceEditor=null;me.getContent=oldGetContent;var first=me.body.firstChild;if(!first){me.body.innerHTML='<p>'+(browser.ie?'':'<br/>')+'</p>';first=me.body.firstChild;}
me.undoManger&&me.undoManger.save(true);if(browser.gecko){var input=document.createElement('input');input.style.cssText='position:absolute;left:0;top:-32768px';document.body.appendChild(input);me.body.contentEditable=false;setTimeout(function(){domUtils.setViewportOffset(input,{left:-32768,top:0});input.focus();setTimeout(function(){me.body.contentEditable=true;me.selection.getRange().moveToAddress(bakAddress).select(true);domUtils.remove(input);});});}else{try{me.selection.getRange().moveToAddress(bakAddress).select(true);}catch(e){}}}this.fireEvent('sourcemodechanged',sourceMode);},queryCommandState:function queryCommandState(){return sourceMode|0;},notNeedUndo:1};var oldQueryCommandState=me.queryCommandState;me.queryCommandState=function(cmdName){cmdName=cmdName.toLowerCase();if(sourceMode){return cmdName in{'source':1,'fullscreen':1}?1:-1;}return oldQueryCommandState.apply(this,arguments);};if(opt.sourceEditor=="codemirror"){me.addListener("ready",function(){utils.loadFile(document,{src:opt.codeMirrorJsUrl||opt.UEDITOR_HOME_URL+"third-party/codemirror/codemirror.js",tag:"script",type:"text/javascript",defer:"defer"},function(){if(opt.sourceEditorFirst){setTimeout(function(){me.execCommand("source");},0);}});utils.loadFile(document,{tag:"link",rel:"stylesheet",type:"text/css",href:opt.codeMirrorCssUrl||opt.UEDITOR_HOME_URL+"third-party/codemirror/codemirror.css"});});}};})();UE.plugins['enterkey']=function(){var hTag,me=this,tag=me.options.enterTag;me.addListener('keyup',function(type,evt){var keyCode=evt.keyCode||evt.which;if(keyCode==13){var range=me.selection.getRange(),start=range.startContainer,doSave;if(!browser.ie){if(/h\d/i.test(hTag)){if(browser.gecko){var h=domUtils.findParentByTagName(start,['h1','h2','h3','h4','h5','h6','blockquote','caption','table'],true);if(!h){me.document.execCommand('formatBlock',false,'<p>');doSave=1;}}else{if(start.nodeType==1){var tmp=me.document.createTextNode(''),div;range.insertNode(tmp);div=domUtils.findParentByTagName(tmp,'div',true);if(div){var p=me.document.createElement('p');while(div.firstChild){p.appendChild(div.firstChild);}div.parentNode.insertBefore(p,div);domUtils.remove(div);range.setStartBefore(tmp).setCursor();doSave=1;}domUtils.remove(tmp);}}if(me.undoManger&&doSave){me.undoManger.save();}}
browser.opera&&range.select();}else{me.fireEvent('saveScene',true,true);}}});me.addListener('keydown',function(type,evt){var keyCode=evt.keyCode||evt.which;if(keyCode==13){if(me.fireEvent('beforeenterkeydown')){domUtils.preventDefault(evt);return;}me.fireEvent('saveScene',true,true);hTag='';var range=me.selection.getRange();if(!range.collapsed){var start=range.startContainer,end=range.endContainer,startTd=domUtils.findParentByTagName(start,'td',true),endTd=domUtils.findParentByTagName(end,'td',true);if(startTd&&endTd&&startTd!==endTd||!startTd&&endTd||startTd&&!endTd){evt.preventDefault?evt.preventDefault():evt.returnValue=false;return;}}if(tag=='p'){if(!browser.ie){start=domUtils.findParentByTagName(range.startContainer,['ol','ul','p','h1','h2','h3','h4','h5','h6','blockquote','caption'],true);if(!start&&!browser.opera){me.document.execCommand('formatBlock',false,'<p>');if(browser.gecko){range=me.selection.getRange();start=domUtils.findParentByTagName(range.startContainer,'p',true);start&&domUtils.removeDirtyAttr(start);}}else{hTag=start.tagName;start.tagName.toLowerCase()=='p'&&browser.gecko&&domUtils.removeDirtyAttr(start);}}}else{evt.preventDefault?evt.preventDefault():evt.returnValue=false;if(!range.collapsed){range.deleteContents();start=range.startContainer;if(start.nodeType==1&&(start=start.childNodes[range.startOffset])){while(start.nodeType==1){if(dtd.$empty[start.tagName]){range.setStartBefore(start).setCursor();if(me.undoManger){me.undoManger.save();}return false;}if(!start.firstChild){var br=range.document.createElement('br');start.appendChild(br);range.setStart(start,0).setCursor();if(me.undoManger){me.undoManger.save();}return false;}start=start.firstChild;}if(start===range.startContainer.childNodes[range.startOffset]){br=range.document.createElement('br');range.insertNode(br).setCursor();}else{range.setStart(start,0).setCursor();}}else{br=range.document.createElement('br');range.insertNode(br).setStartAfter(br).setCursor();}}else{br=range.document.createElement('br');range.insertNode(br);var parent=br.parentNode;if(parent.lastChild===br){br.parentNode.insertBefore(br.cloneNode(true),br);range.setStartBefore(br);}else{range.setStartAfter(br);}range.setCursor();}}}});};UE.plugins['keystrokes']=function(){var me=this;var collapsed=true;me.addListener('keydown',function(type,evt){var keyCode=evt.keyCode||evt.which,rng=me.selection.getRange();if(!rng.collapsed&&!(evt.ctrlKey||evt.shiftKey||evt.altKey||evt.metaKey)&&(keyCode>=65&&keyCode<=90||keyCode>=48&&keyCode<=57||keyCode>=96&&keyCode<=111||{13:1,8:1,46:1}[keyCode])){var tmpNode=rng.startContainer;if(domUtils.isFillChar(tmpNode)){rng.setStartBefore(tmpNode);}tmpNode=rng.endContainer;if(domUtils.isFillChar(tmpNode)){rng.setEndAfter(tmpNode);}rng.txtToElmBoundary();if(rng.endContainer&&rng.endContainer.nodeType==1){tmpNode=rng.endContainer.childNodes[rng.endOffset];if(tmpNode&&domUtils.isBr(tmpNode)){rng.setEndAfter(tmpNode);}}if(rng.startOffset==0){tmpNode=rng.startContainer;if(domUtils.isBoundaryNode(tmpNode,'firstChild')){tmpNode=rng.endContainer;if(rng.endOffset==(tmpNode.nodeType==3?tmpNode.nodeValue.length:tmpNode.childNodes.length)&&domUtils.isBoundaryNode(tmpNode,'lastChild')){me.fireEvent('saveScene');me.body.innerHTML='<p>'+(browser.ie?'':'<br/>')+'</p>';rng.setStart(me.body.firstChild,0).setCursor(false,true);me._selectionChange();return;}}}}
if(keyCode==keymap.Backspace){rng=me.selection.getRange();collapsed=rng.collapsed;if(me.fireEvent('delkeydown',evt)){return;}var start,end;if(rng.collapsed&&rng.inFillChar()){start=rng.startContainer;if(domUtils.isFillChar(start)){rng.setStartBefore(start).shrinkBoundary(true).collapse(true);domUtils.remove(start);}else{start.nodeValue=start.nodeValue.replace(new RegExp('^'+domUtils.fillChar),'');rng.startOffset--;rng.collapse(true).select(true);}}
if(start=rng.getClosedNode()){me.fireEvent('saveScene');rng.setStartBefore(start);domUtils.remove(start);rng.setCursor();me.fireEvent('saveScene');domUtils.preventDefault(evt);return;}
if(!browser.ie){start=domUtils.findParentByTagName(rng.startContainer,'table',true);end=domUtils.findParentByTagName(rng.endContainer,'table',true);if(start&&!end||!start&&end||start!==end){evt.preventDefault();return;}}}
if(keyCode==keymap.Tab){var excludeTagNameForTabKey={'ol':1,'ul':1,'table':1};if(me.fireEvent('tabkeydown',evt)){domUtils.preventDefault(evt);return;}var range=me.selection.getRange();me.fireEvent('saveScene');for(var i=0,txt='',tabSize=me.options.tabSize||4,tabNode=me.options.tabNode||'&nbsp;';i<tabSize;i++){txt+=tabNode;}var span=me.document.createElement('span');span.innerHTML=txt+domUtils.fillChar;if(range.collapsed){range.insertNode(span.cloneNode(true).firstChild).setCursor(true);}else{var filterFn=function filterFn(node){return domUtils.isBlockElm(node)&&!excludeTagNameForTabKey[node.tagName.toLowerCase()];};start=domUtils.findParent(range.startContainer,filterFn,true);end=domUtils.findParent(range.endContainer,filterFn,true);if(start&&end&&start===end){range.deleteContents();range.insertNode(span.cloneNode(true).firstChild).setCursor(true);}else{var bookmark=range.createBookmark();range.enlarge(true);var bookmark2=range.createBookmark(),current=domUtils.getNextDomNode(bookmark2.start,false,filterFn);while(current&&!(domUtils.getPosition(current,bookmark2.end)&domUtils.POSITION_FOLLOWING)){current.insertBefore(span.cloneNode(true).firstChild,current.firstChild);current=domUtils.getNextDomNode(current,false,filterFn);}range.moveToBookmark(bookmark2).moveToBookmark(bookmark).select();}}domUtils.preventDefault(evt);}
if(browser.gecko&&keyCode==46){range=me.selection.getRange();if(range.collapsed){start=range.startContainer;if(domUtils.isEmptyBlock(start)){var parent=start.parentNode;while(domUtils.getChildCount(parent)==1&&!domUtils.isBody(parent)){start=parent;parent=parent.parentNode;}if(start===parent.lastChild)evt.preventDefault();return;}}}});me.addListener('keyup',function(type,evt){var keyCode=evt.keyCode||evt.which,rng,me=this;if(keyCode==keymap.Backspace){if(me.fireEvent('delkeyup')){return;}rng=me.selection.getRange();if(rng.collapsed){var tmpNode,autoClearTagName=['h1','h2','h3','h4','h5','h6'];if(tmpNode=domUtils.findParentByTagName(rng.startContainer,autoClearTagName,true)){if(domUtils.isEmptyBlock(tmpNode)){var pre=tmpNode.previousSibling;if(pre&&pre.nodeName!='TABLE'){domUtils.remove(tmpNode);rng.setStartAtLast(pre).setCursor(false,true);return;}else{var next=tmpNode.nextSibling;if(next&&next.nodeName!='TABLE'){domUtils.remove(tmpNode);rng.setStartAtFirst(next).setCursor(false,true);return;}}}}
if(domUtils.isBody(rng.startContainer)){var tmpNode=domUtils.createElement(me.document,'p',{'innerHTML':browser.ie?domUtils.fillChar:'<br/>'});rng.insertNode(tmpNode).setStart(tmpNode,0).setCursor(false,true);}}
if(!collapsed&&(rng.startContainer.nodeType==3||rng.startContainer.nodeType==1&&domUtils.isEmptyBlock(rng.startContainer))){if(browser.ie){var span=rng.document.createElement('span');rng.insertNode(span).setStartBefore(span).collapse(true);rng.select();domUtils.remove(span);}else{rng.select();}}}});};UE.plugins['fiximgclick']=function(){var elementUpdated=false;function Scale(){this.editor=null;this.resizer=null;this.cover=null;this.doc=document;this.prePos={x:0,y:0};this.startPos={x:0,y:0};}(function(){var rect=[[0,0,-1,-1],[0,0,0,-1],[0,0,1,-1],[0,0,-1,0],[0,0,1,0],[0,0,-1,1],[0,0,0,1],[0,0,1,1]];Scale.prototype={init:function init(editor){var me=this;me.editor=editor;me.startPos=this.prePos={x:0,y:0};me.dragId=-1;var hands=[],cover=me.cover=document.createElement('div'),resizer=me.resizer=document.createElement('div');cover.id=me.editor.ui.id+'_imagescale_cover';cover.style.cssText='position:absolute;display:none;z-index:'+me.editor.options.zIndex+';filter:alpha(opacity=0); opacity:0;background:#CCC;';domUtils.on(cover,'mousedown click',function(){me.hide();});for(i=0;i<8;i++){hands.push('<span class="edui-editor-imagescale-hand'+i+'"></span>');}resizer.id=me.editor.ui.id+'_imagescale';resizer.className='edui-editor-imagescale';resizer.innerHTML=hands.join('');resizer.style.cssText+=';display:none;border:1px solid #3b77ff;z-index:'+me.editor.options.zIndex+';';me.editor.ui.getDom().appendChild(cover);me.editor.ui.getDom().appendChild(resizer);me.initStyle();me.initEvents();},initStyle:function initStyle(){utils.cssRule('imagescale','.edui-editor-imagescale{display:none;position:absolute;border:1px solid #38B2CE;cursor:hand;-webkit-box-sizing: content-box;-moz-box-sizing: content-box;box-sizing: content-box;}'+'.edui-editor-imagescale span{position:absolute;width:6px;height:6px;overflow:hidden;font-size:0px;display:block;background-color:#3C9DD0;}'+'.edui-editor-imagescale .edui-editor-imagescale-hand0{cursor:nw-resize;top:0;margin-top:-4px;left:0;margin-left:-4px;}'+'.edui-editor-imagescale .edui-editor-imagescale-hand1{cursor:n-resize;top:0;margin-top:-4px;left:50%;margin-left:-4px;}'+'.edui-editor-imagescale .edui-editor-imagescale-hand2{cursor:ne-resize;top:0;margin-top:-4px;left:100%;margin-left:-3px;}'+'.edui-editor-imagescale .edui-editor-imagescale-hand3{cursor:w-resize;top:50%;margin-top:-4px;left:0;margin-left:-4px;}'+'.edui-editor-imagescale .edui-editor-imagescale-hand4{cursor:e-resize;top:50%;margin-top:-4px;left:100%;margin-left:-3px;}'+'.edui-editor-imagescale .edui-editor-imagescale-hand5{cursor:sw-resize;top:100%;margin-top:-3px;left:0;margin-left:-4px;}'+'.edui-editor-imagescale .edui-editor-imagescale-hand6{cursor:s-resize;top:100%;margin-top:-3px;left:50%;margin-left:-4px;}'+'.edui-editor-imagescale .edui-editor-imagescale-hand7{cursor:se-resize;top:100%;margin-top:-3px;left:100%;margin-left:-3px;}');},initEvents:function initEvents(){var me=this;me.startPos.x=me.startPos.y=0;me.isDraging=false;},_eventHandler:function _eventHandler(e){var me=this;switch(e.type){case'mousedown':var hand=e.target||e.srcElement,hand;if(hand.className.indexOf('edui-editor-imagescale-hand')!=-1&&me.dragId==-1){me.dragId=hand.className.slice(-1);me.startPos.x=me.prePos.x=e.clientX;me.startPos.y=me.prePos.y=e.clientY;domUtils.on(me.doc,'mousemove',me.proxy(me._eventHandler,me));}break;case'mousemove':if(me.dragId!=-1){me.updateContainerStyle(me.dragId,{x:e.clientX-me.prePos.x,y:e.clientY-me.prePos.y});me.prePos.x=e.clientX;me.prePos.y=e.clientY;elementUpdated=true;me.updateTargetElement();}break;case'mouseup':if(me.dragId!=-1){me.updateContainerStyle(me.dragId,{x:e.clientX-me.prePos.x,y:e.clientY-me.prePos.y});me.updateTargetElement();if(me.target.parentNode)me.attachTo(me.target);me.dragId=-1;}domUtils.un(me.doc,'mousemove',me.proxy(me._eventHandler,me));if(elementUpdated){elementUpdated=false;me.editor.fireEvent('contentchange');}break;default:break;}},updateTargetElement:function updateTargetElement(){var me=this;domUtils.setStyles(me.target,{'width':me.resizer.style.width,'height':me.resizer.style.height});me.target.width=parseInt(me.resizer.style.width);me.target.height=parseInt(me.resizer.style.height);me.attachTo(me.target);},updateContainerStyle:function updateContainerStyle(dir,offset){var me=this,dom=me.resizer,tmp;if(rect[dir][0]!=0){tmp=parseInt(dom.style.left)+offset.x;dom.style.left=me._validScaledProp('left',tmp)+'px';}if(rect[dir][1]!=0){tmp=parseInt(dom.style.top)+offset.y;dom.style.top=me._validScaledProp('top',tmp)+'px';}if(rect[dir][2]!=0){tmp=dom.clientWidth+rect[dir][2]*offset.x;dom.style.width=me._validScaledProp('width',tmp)+'px';}if(rect[dir][3]!=0){tmp=dom.clientHeight+rect[dir][3]*offset.y;dom.style.height=me._validScaledProp('height',tmp)+'px';}},_validScaledProp:function _validScaledProp(prop,value){var ele=this.resizer,wrap=document;value=isNaN(value)?0:value;switch(prop){case'left':return value<0?0:value+ele.clientWidth>wrap.clientWidth?wrap.clientWidth-ele.clientWidth:value;case'top':return value<0?0:value+ele.clientHeight>wrap.clientHeight?wrap.clientHeight-ele.clientHeight:value;case'width':return value<=0?1:value+ele.offsetLeft>wrap.clientWidth?wrap.clientWidth-ele.offsetLeft:value;case'height':return value<=0?1:value+ele.offsetTop>wrap.clientHeight?wrap.clientHeight-ele.offsetTop:value;}},hideCover:function hideCover(){this.cover.style.display='none';},showCover:function showCover(){var me=this,editorPos=domUtils.getXY(me.editor.ui.getDom()),iframePos=domUtils.getXY(me.editor.iframe);domUtils.setStyles(me.cover,{'width':me.editor.iframe.offsetWidth+'px','height':me.editor.iframe.offsetHeight+'px','top':iframePos.y-editorPos.y+'px','left':iframePos.x-editorPos.x+'px','position':'absolute','display':''});},show:function show(targetObj){var me=this;me.resizer.style.display='block';if(targetObj)me.attachTo(targetObj);domUtils.on(this.resizer,'mousedown',me.proxy(me._eventHandler,me));domUtils.on(me.doc,'mouseup',me.proxy(me._eventHandler,me));me.showCover();me.editor.fireEvent('afterscaleshow',me);me.editor.fireEvent('saveScene');},hide:function hide(){var me=this;me.hideCover();me.resizer.style.display='none';domUtils.un(me.resizer,'mousedown',me.proxy(me._eventHandler,me));domUtils.un(me.doc,'mouseup',me.proxy(me._eventHandler,me));me.editor.fireEvent('afterscalehide',me);},proxy:function proxy(fn,context){return function(e){return fn.apply(context||this,arguments);};},attachTo:function attachTo(targetObj){var me=this,target=me.target=targetObj,resizer=this.resizer,imgPos=domUtils.getXY(target),iframePos=domUtils.getXY(me.editor.iframe),editorPos=domUtils.getXY(resizer.parentNode);domUtils.setStyles(resizer,{'width':target.width+'px','height':target.height+'px','left':iframePos.x+imgPos.x-me.editor.document.body.scrollLeft-editorPos.x-parseInt(resizer.style.borderLeftWidth)+'px','top':iframePos.y+imgPos.y-me.editor.document.body.scrollTop-editorPos.y-parseInt(resizer.style.borderTopWidth)+'px'});}};})();return function(){var me=this,imageScale;me.setOpt('imageScaleEnabled',true);if(!browser.ie&&me.options.imageScaleEnabled){me.addListener('click',function(type,e){var range=me.selection.getRange(),img=range.getClosedNode();if(img&&img.tagName=='IMG'&&me.body.contentEditable!="false"){if(img.className.indexOf("edui-faked-music")!=-1||img.getAttribute("anchorname")||domUtils.hasClass(img,'loadingclass')||domUtils.hasClass(img,'loaderrorclass')){return;}if(!imageScale){imageScale=new Scale();imageScale.init(me);me.ui.getDom().appendChild(imageScale.resizer);var _keyDownHandler=function _keyDownHandler(e){imageScale.hide();if(imageScale.target)me.selection.getRange().selectNode(imageScale.target).select();},_mouseDownHandler=function _mouseDownHandler(e){var ele=e.target||e.srcElement;if(ele&&(ele.className===undefined||ele.className.indexOf('edui-editor-imagescale')==-1)){_keyDownHandler(e);}},timer;me.addListener('afterscaleshow',function(e){me.addListener('beforekeydown',_keyDownHandler);me.addListener('beforemousedown',_mouseDownHandler);domUtils.on(document,'keydown',_keyDownHandler);domUtils.on(document,'mousedown',_mouseDownHandler);me.selection.getNative().removeAllRanges();});me.addListener('afterscalehide',function(e){me.removeListener('beforekeydown',_keyDownHandler);me.removeListener('beforemousedown',_mouseDownHandler);domUtils.un(document,'keydown',_keyDownHandler);domUtils.un(document,'mousedown',_mouseDownHandler);var target=imageScale.target;if(target.parentNode){me.selection.getRange().selectNode(target).select();}});domUtils.on(imageScale.resizer,'mousedown',function(e){me.selection.getNative().removeAllRanges();var ele=e.target||e.srcElement;if(ele&&ele.className.indexOf('edui-editor-imagescale-hand')==-1){timer=setTimeout(function(){imageScale.hide();if(imageScale.target)me.selection.getRange().selectNode(ele).select();},200);}});domUtils.on(imageScale.resizer,'mouseup',function(e){var ele=e.target||e.srcElement;if(ele&&ele.className.indexOf('edui-editor-imagescale-hand')==-1){clearTimeout(timer);}});}imageScale.show(img);}else{if(imageScale&&imageScale.resizer.style.display!='none')imageScale.hide();}});}if(browser.webkit){me.addListener('click',function(type,e){if(e.target.tagName=='IMG'&&me.body.contentEditable!="false"){var range=new dom.Range(me.document);range.selectNode(e.target).select();}});}};}();UE.plugin.register('autolink',function(){var cont=0;return!browser.ie?{bindEvents:{'reset':function reset(){cont=0;},'keydown':function keydown(type,evt){var me=this;var keyCode=evt.keyCode||evt.which;if(keyCode==32||keyCode==13){var sel=me.selection.getNative(),range=sel.getRangeAt(0).cloneRange(),offset,charCode;var start=range.startContainer;while(start.nodeType==1&&range.startOffset>0){start=range.startContainer.childNodes[range.startOffset-1];if(!start){break;}range.setStart(start,start.nodeType==1?start.childNodes.length:start.nodeValue.length);range.collapse(true);start=range.startContainer;}do{if(range.startOffset==0){start=range.startContainer.previousSibling;while(start&&start.nodeType==1){start=start.lastChild;}if(!start||domUtils.isFillChar(start)){break;}offset=start.nodeValue.length;}else{start=range.startContainer;offset=range.startOffset;}range.setStart(start,offset-1);charCode=range.toString().charCodeAt(0);}while(charCode!=160&&charCode!=32);if(range.toString().replace(new RegExp(domUtils.fillChar,'g'),'').match(/(?:https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|www\.)/i)){while(range.toString().length){if(/^(?:https?:\/\/|ssh:\/\/|ftp:\/\/|file:\/|www\.)/i.test(range.toString())){break;}try{range.setStart(range.startContainer,range.startOffset+1);}catch(e){var start=range.startContainer;while(!(next=start.nextSibling)){if(domUtils.isBody(start)){return;}start=start.parentNode;}range.setStart(next,0);}}
if(domUtils.findParentByTagName(range.startContainer,'a',true)){return;}var a=me.document.createElement('a'),text=me.document.createTextNode(' '),href;me.undoManger&&me.undoManger.save();a.appendChild(range.extractContents());a.href=a.innerHTML=a.innerHTML.replace(/<[^>]+>/g,'');href=a.getAttribute("href").replace(new RegExp(domUtils.fillChar,'g'),'');href=/^(?:https?:\/\/)/ig.test(href)?href:"http://"+href;a.setAttribute('_src',utils.html(href));a.href=utils.html(href);range.insertNode(a);a.parentNode.insertBefore(text,a.nextSibling);range.setStart(text,0);range.collapse(true);sel.removeAllRanges();sel.addRange(range);me.undoManger&&me.undoManger.save();}}}}}:{};},function(){var keyCodes={37:1,38:1,39:1,40:1,13:1,32:1};function checkIsCludeLink(node){if(node.nodeType==3){return null;}if(node.nodeName=='A'){return node;}var lastChild=node.lastChild;while(lastChild){if(lastChild.nodeName=='A'){return lastChild;}if(lastChild.nodeType==3){if(domUtils.isWhitespace(lastChild)){lastChild=lastChild.previousSibling;continue;}return null;}lastChild=lastChild.lastChild;}}browser.ie&&this.addListener('keyup',function(cmd,evt){var me=this,keyCode=evt.keyCode;if(keyCodes[keyCode]){var rng=me.selection.getRange();var start=rng.startContainer;if(keyCode==13){while(start&&!domUtils.isBody(start)&&!domUtils.isBlockElm(start)){start=start.parentNode;}if(start&&!domUtils.isBody(start)&&start.nodeName=='P'){var pre=start.previousSibling;if(pre&&pre.nodeType==1){var pre=checkIsCludeLink(pre);if(pre&&!pre.getAttribute('_href')){domUtils.remove(pre,true);}}}}else if(keyCode==32){if(start.nodeType==3&&/^\s$/.test(start.nodeValue)){start=start.previousSibling;if(start&&start.nodeName=='A'&&!start.getAttribute('_href')){domUtils.remove(start,true);}}}else{start=domUtils.findParentByTagName(start,'a',true);if(start&&!start.getAttribute('_href')){var bk=rng.createBookmark();domUtils.remove(start,true);rng.moveToBookmark(bk).select(true);}}}});});UE.plugins['autoheight']=function(){var me=this;me.autoHeightEnabled=me.options.autoHeightEnabled!==false;if(!me.autoHeightEnabled){return;}var bakOverflow,lastHeight=0,options=me.options,currentHeight,timer;function adjustHeight(){var me=this;clearTimeout(timer);if(isFullscreen)return;if(!me.queryCommandState||me.queryCommandState&&me.queryCommandState('source')!=1){timer=setTimeout(function(){var node=me.body.lastChild;while(node&&node.nodeType!=1){node=node.previousSibling;}if(node&&node.nodeType==1){node.style.clear='both';currentHeight=Math.max(domUtils.getXY(node).y+node.offsetHeight+25,Math.max(options.minFrameHeight,options.initialFrameHeight));if(currentHeight!=lastHeight){if(currentHeight!==parseInt(me.iframe.parentNode.style.height)){me.iframe.parentNode.style.height=currentHeight+'px';}me.body.style.height=currentHeight+'px';lastHeight=currentHeight;}domUtils.removeStyle(node,'clear');}},50);}}var isFullscreen;me.addListener('fullscreenchanged',function(cmd,f){isFullscreen=f;});me.addListener('destroy',function(){me.removeListener('contentchange afterinserthtml keyup mouseup',adjustHeight);});me.enableAutoHeight=function(){var me=this;if(!me.autoHeightEnabled){return;}var doc=me.document;me.autoHeightEnabled=true;bakOverflow=doc.body.style.overflowY;doc.body.style.overflowY='hidden';me.addListener('contentchange afterinserthtml keyup mouseup',adjustHeight);setTimeout(function(){adjustHeight.call(me);},browser.gecko?100:0);me.fireEvent('autoheightchanged',me.autoHeightEnabled);};me.disableAutoHeight=function(){me.body.style.overflowY=bakOverflow||'';me.removeListener('contentchange',adjustHeight);me.removeListener('keyup',adjustHeight);me.removeListener('mouseup',adjustHeight);me.autoHeightEnabled=false;me.fireEvent('autoheightchanged',me.autoHeightEnabled);};me.on('setHeight',function(){me.disableAutoHeight();});me.addListener('ready',function(){me.enableAutoHeight();var timer;domUtils.on(browser.ie?me.body:me.document,browser.webkit?'dragover':'drop',function(){clearTimeout(timer);timer=setTimeout(function(){adjustHeight.call(me);},100);});var lastScrollY;window.onscroll=function(){if(lastScrollY===null){lastScrollY=this.scrollY;}else if(this.scrollY==0&&lastScrollY!=0){me.window.scrollTo(0,0);lastScrollY=null;}};});};UE.plugins['autofloat']=function(){var me=this,lang=me.getLang();me.setOpt({topOffset:0});var optsAutoFloatEnabled=me.options.autoFloatEnabled!==false,topOffset=me.options.topOffset;if(!optsAutoFloatEnabled){return;}var uiUtils=UE.ui.uiUtils,LteIE6=browser.ie&&browser.version<=6,quirks=browser.quirks;function checkHasUI(){if(!UE.ui){alert(lang.autofloatMsg);return 0;}return 1;}function fixIE6FixedPos(){var docStyle=document.body.style;docStyle.backgroundImage='url("about:blank")';docStyle.backgroundAttachment='fixed';}var bakCssText,placeHolder=document.createElement('div'),toolbarBox,orgTop,getPosition,flag=true;function setFloating(){var toobarBoxPos=domUtils.getXY(toolbarBox),origalFloat=domUtils.getComputedStyle(toolbarBox,'position'),origalLeft=domUtils.getComputedStyle(toolbarBox,'left');toolbarBox.style.width=toolbarBox.offsetWidth+'px';toolbarBox.style.zIndex=me.options.zIndex*1+1;toolbarBox.parentNode.insertBefore(placeHolder,toolbarBox);if(LteIE6||quirks&&browser.ie){if(toolbarBox.style.position!='absolute'){toolbarBox.style.position='absolute';}toolbarBox.style.top=(document.body.scrollTop||document.documentElement.scrollTop)-orgTop+topOffset+'px';}else{if(browser.ie7Compat&&flag){flag=false;toolbarBox.style.left=domUtils.getXY(toolbarBox).x-document.documentElement.getBoundingClientRect().left+2+'px';}if(toolbarBox.style.position!='fixed'){toolbarBox.style.position='fixed';toolbarBox.style.top=topOffset+"px";(origalFloat=='absolute'||origalFloat=='relative')&&parseFloat(origalLeft)&&(toolbarBox.style.left=toobarBoxPos.x+'px');}}}function unsetFloating(){flag=true;if(placeHolder.parentNode){placeHolder.parentNode.removeChild(placeHolder);}toolbarBox.style.cssText=bakCssText;}function updateFloating(){var rect3=getPosition(me.container);var offset=me.options.toolbarTopOffset||0;if(rect3.top<0&&rect3.bottom-toolbarBox.offsetHeight>offset){setFloating();}else{unsetFloating();}}var defer_updateFloating=utils.defer(function(){updateFloating();},browser.ie?200:100,true);me.addListener('destroy',function(){domUtils.un(window,['scroll','resize'],updateFloating);me.removeListener('keydown',defer_updateFloating);});me.addListener('ready',function(){if(checkHasUI(me)){if(!me.ui){return;}getPosition=uiUtils.getClientRect;toolbarBox=me.ui.getDom('toolbarbox');orgTop=getPosition(toolbarBox).top;bakCssText=toolbarBox.style.cssText;placeHolder.style.height=toolbarBox.offsetHeight+'px';if(LteIE6){fixIE6FixedPos();}domUtils.on(window,['scroll','resize'],updateFloating);me.addListener('keydown',defer_updateFloating);me.addListener('beforefullscreenchange',function(t,enabled){if(enabled){unsetFloating();}});me.addListener('fullscreenchanged',function(t,enabled){if(!enabled){updateFloating();}});me.addListener('sourcemodechanged',function(t,enabled){setTimeout(function(){updateFloating();},0);});me.addListener("clearDoc",function(){setTimeout(function(){updateFloating();},0);});}});};UE.plugins['video']=function(){var me=this;function creatInsertStr(url,width,height,id,align,classname,type){var str;switch(type){case'image':str='<img '+(id?'id="'+id+'"':'')+' width="'+width+'" height="'+height+'" _url="'+url+'" class="'+classname.replace(/\bvideo-js\b/,'')+'"'+' src="'+me.options.UEDITOR_HOME_URL+'themes/default/images/spacer.gif" style="background:url('+me.options.UEDITOR_HOME_URL+'themes/default/images/videologo.gif) no-repeat center center; border:1px solid gray;'+(align?'float:'+align+';':'')+'" />';break;case'embed':str='<embed type="application/x-shockwave-flash" class="'+classname+'" pluginspage="http://www.macromedia.com/go/getflashplayer"'+' src="'+utils.html(url)+'" width="'+width+'" height="'+height+'"'+(align?' style="float:'+align+'"':'')+' wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" >';break;case'video':var ext=url.substr(url.lastIndexOf('.')+1);if(ext=='ogv')ext='ogg';str='<video'+(id?' id="'+id+'"':'')+' class="'+classname+' video-js" '+(align?' style="float:'+align+'"':'')+' controls preload="none" width="'+width+'" height="'+height+'" src="'+url+'" data-setup="{}">'+'<source src="'+url+'" type="video/'+ext+'" /></video>';break;}return str;}function switchImgAndVideo(root,img2video){utils.each(root.getNodesByTagName(img2video?'img':'embed video'),function(node){var className=node.getAttr('class');if(className&&className.indexOf('edui-faked-video')!=-1){var html=creatInsertStr(img2video?node.getAttr('_url'):node.getAttr('src'),node.getAttr('width'),node.getAttr('height'),null,node.getStyle('float')||'',className,img2video?'embed':'image');node.parentNode.replaceChild(UE.uNode.createElement(html),node);}if(className&&className.indexOf('edui-upload-video')!=-1){var html=creatInsertStr(img2video?node.getAttr('_url'):node.getAttr('src'),node.getAttr('width'),node.getAttr('height'),null,node.getStyle('float')||'',className,img2video?'video':'image');node.parentNode.replaceChild(UE.uNode.createElement(html),node);}});}me.addOutputRule(function(root){switchImgAndVideo(root,true);});me.addInputRule(function(root){switchImgAndVideo(root);});me.commands["insertvideo"]={execCommand:function execCommand(cmd,videoObjs,type){videoObjs=utils.isArray(videoObjs)?videoObjs:[videoObjs];var html=[],id='tmpVedio',cl;for(var i=0,vi,len=videoObjs.length;i<len;i++){vi=videoObjs[i];cl=type=='upload'?'edui-upload-video video-js vjs-default-skin':'edui-faked-video';html.push(creatInsertStr(vi.url,vi.width||420,vi.height||280,id+i,null,cl,'image'));}me.execCommand("inserthtml",html.join(""),true);var rng=this.selection.getRange();for(var i=0,len=videoObjs.length;i<len;i++){var img=this.document.getElementById('tmpVedio'+i);domUtils.removeAttributes(img,'id');rng.selectNode(img).select();me.execCommand('imagefloat',videoObjs[i].align);}},queryCommandState:function queryCommandState(){var img=me.selection.getRange().getClosedNode(),flag=img&&(img.className=="edui-faked-video"||img.className.indexOf("edui-upload-video")!=-1);return flag?1:0;}};};(function(){var UETable=UE.UETable=function(table){this.table=table;this.indexTable=[];this.selectedTds=[];this.cellsRange={};this.update(table);};UETable.removeSelectedClass=function(cells){utils.each(cells,function(cell){domUtils.removeClasses(cell,"selectTdClass");});};UETable.addSelectedClass=function(cells){utils.each(cells,function(cell){domUtils.addClass(cell,"selectTdClass");});};UETable.isEmptyBlock=function(node){var reg=new RegExp(domUtils.fillChar,'g');if(node[browser.ie?'innerText':'textContent'].replace(/^\s*$/,'').replace(reg,'').length>0){return 0;}for(var i in dtd.$isNotEmpty){if(dtd.$isNotEmpty.hasOwnProperty(i)){if(node.getElementsByTagName(i).length){return 0;}}}return 1;};UETable.getWidth=function(cell){if(!cell)return 0;return parseInt(domUtils.getComputedStyle(cell,"width"),10);};UETable.getTableCellAlignState=function(cells){!utils.isArray(cells)&&(cells=[cells]);var result={},status=['align','valign'],tempStatus=null,isSame=true;utils.each(cells,function(cellNode){utils.each(status,function(currentState){tempStatus=cellNode.getAttribute(currentState);if(!result[currentState]&&tempStatus){result[currentState]=tempStatus;}else if(!result[currentState]||tempStatus!==result[currentState]){isSame=false;return false;}});return isSame;});return isSame?result:null;};UETable.getTableItemsByRange=function(editor){var start=editor.selection.getStart();if(start&&start.id&&start.id.indexOf('_baidu_bookmark_start_')===0&&start.nextSibling){start=start.nextSibling;}
var cell=start&&domUtils.findParentByTagName(start,["td","th"],true),tr=cell&&cell.parentNode,caption=start&&domUtils.findParentByTagName(start,'caption',true),table=caption?caption.parentNode:tr&&tr.parentNode.parentNode;return{cell:cell,tr:tr,table:table,caption:caption};};UETable.getUETableBySelected=function(editor){var table=UETable.getTableItemsByRange(editor).table;if(table&&table.ueTable&&table.ueTable.selectedTds.length){return table.ueTable;}return null;};UETable.getDefaultValue=function(editor,table){var borderMap={thin:'0px',medium:'1px',thick:'2px'},tableBorder,tdPadding,tdBorder,tmpValue;if(!table){table=editor.document.createElement('table');table.insertRow(0).insertCell(0).innerHTML='xxx';editor.body.appendChild(table);var td=table.getElementsByTagName('td')[0];tmpValue=domUtils.getComputedStyle(table,'border-left-width');tableBorder=parseInt(borderMap[tmpValue]||tmpValue,10);tmpValue=domUtils.getComputedStyle(td,'padding-left');tdPadding=parseInt(borderMap[tmpValue]||tmpValue,10);tmpValue=domUtils.getComputedStyle(td,'border-left-width');tdBorder=parseInt(borderMap[tmpValue]||tmpValue,10);domUtils.remove(table);return{tableBorder:tableBorder,tdPadding:tdPadding,tdBorder:tdBorder};}else{td=table.getElementsByTagName('td')[0];tmpValue=domUtils.getComputedStyle(table,'border-left-width');tableBorder=parseInt(borderMap[tmpValue]||tmpValue,10);tmpValue=domUtils.getComputedStyle(td,'padding-left');tdPadding=parseInt(borderMap[tmpValue]||tmpValue,10);tmpValue=domUtils.getComputedStyle(td,'border-left-width');tdBorder=parseInt(borderMap[tmpValue]||tmpValue,10);return{tableBorder:tableBorder,tdPadding:tdPadding,tdBorder:tdBorder};}};UETable.getUETable=function(tdOrTable){var tag=tdOrTable.tagName.toLowerCase();tdOrTable=tag=="td"||tag=="th"||tag=='caption'?domUtils.findParentByTagName(tdOrTable,"table",true):tdOrTable;if(!tdOrTable.ueTable){tdOrTable.ueTable=new UETable(tdOrTable);}return tdOrTable.ueTable;};UETable.cloneCell=function(cell,ignoreMerge,keepPro){if(!cell||utils.isString(cell)){return this.table.ownerDocument.createElement(cell||'td');}var flag=domUtils.hasClass(cell,"selectTdClass");flag&&domUtils.removeClasses(cell,"selectTdClass");var tmpCell=cell.cloneNode(true);if(ignoreMerge){tmpCell.rowSpan=tmpCell.colSpan=1;}
!keepPro&&domUtils.removeAttributes(tmpCell,'width height');!keepPro&&domUtils.removeAttributes(tmpCell,'style');tmpCell.style.borderLeftStyle="";tmpCell.style.borderTopStyle="";tmpCell.style.borderLeftColor=cell.style.borderRightColor;tmpCell.style.borderLeftWidth=cell.style.borderRightWidth;tmpCell.style.borderTopColor=cell.style.borderBottomColor;tmpCell.style.borderTopWidth=cell.style.borderBottomWidth;flag&&domUtils.addClass(cell,"selectTdClass");return tmpCell;};UETable.prototype={getMaxRows:function getMaxRows(){var rows=this.table.rows,maxLen=1;for(var i=0,row;row=rows[i];i++){var currentMax=1;for(var j=0,cj;cj=row.cells[j++];){currentMax=Math.max(cj.rowSpan||1,currentMax);}maxLen=Math.max(currentMax+i,maxLen);}return maxLen;},getMaxCols:function getMaxCols(){var rows=this.table.rows,maxLen=0,cellRows={};for(var i=0,row;row=rows[i];i++){var cellsNum=0;for(var j=0,cj;cj=row.cells[j++];){cellsNum+=cj.colSpan||1;if(cj.rowSpan&&cj.rowSpan>1){for(var k=1;k<cj.rowSpan;k++){if(!cellRows['row_'+(i+k)]){cellRows['row_'+(i+k)]=cj.colSpan||1;}else{cellRows['row_'+(i+k)]++;}}}}cellsNum+=cellRows['row_'+i]||0;maxLen=Math.max(cellsNum,maxLen);}return maxLen;},getCellColIndex:function getCellColIndex(cell){},getHSideCell:function getHSideCell(cell,right){try{var cellInfo=this.getCellInfo(cell),previewRowIndex,previewColIndex;var len=this.selectedTds.length,range=this.cellsRange;if(!right&&(!len?!cellInfo.colIndex:!range.beginColIndex)||right&&(!len?cellInfo.colIndex==this.colsNum-1:range.endColIndex==this.colsNum-1))return null;previewRowIndex=!len?cellInfo.rowIndex:range.beginRowIndex;previewColIndex=!right?!len?cellInfo.colIndex<1?0:cellInfo.colIndex-1:range.beginColIndex-1:!len?cellInfo.colIndex+1:range.endColIndex+1;return this.getCell(this.indexTable[previewRowIndex][previewColIndex].rowIndex,this.indexTable[previewRowIndex][previewColIndex].cellIndex);}catch(e){showError(e);}},getTabNextCell:function getTabNextCell(cell,preRowIndex){var cellInfo=this.getCellInfo(cell),rowIndex=preRowIndex||cellInfo.rowIndex,colIndex=cellInfo.colIndex+1+(cellInfo.colSpan-1),nextCell;try{nextCell=this.getCell(this.indexTable[rowIndex][colIndex].rowIndex,this.indexTable[rowIndex][colIndex].cellIndex);}catch(e){try{rowIndex=rowIndex*1+1;colIndex=0;nextCell=this.getCell(this.indexTable[rowIndex][colIndex].rowIndex,this.indexTable[rowIndex][colIndex].cellIndex);}catch(e){}}return nextCell;},getVSideCell:function getVSideCell(cell,bottom,ignoreRange){try{var cellInfo=this.getCellInfo(cell),nextRowIndex,nextColIndex;var len=this.selectedTds.length&&!ignoreRange,range=this.cellsRange;if(!bottom&&cellInfo.rowIndex==0||bottom&&(!len?cellInfo.rowIndex+cellInfo.rowSpan>this.rowsNum-1:range.endRowIndex==this.rowsNum-1))return null;nextRowIndex=!bottom?!len?cellInfo.rowIndex-1:range.beginRowIndex-1:!len?cellInfo.rowIndex+cellInfo.rowSpan:range.endRowIndex+1;nextColIndex=!len?cellInfo.colIndex:range.beginColIndex;return this.getCell(this.indexTable[nextRowIndex][nextColIndex].rowIndex,this.indexTable[nextRowIndex][nextColIndex].cellIndex);}catch(e){showError(e);}},getSameEndPosCells:function getSameEndPosCells(cell,xOrY){try{var flag=xOrY.toLowerCase()==="x",end=domUtils.getXY(cell)[flag?'x':'y']+cell["offset"+(flag?'Width':'Height')],rows=this.table.rows,cells=null,returns=[];for(var i=0;i<this.rowsNum;i++){cells=rows[i].cells;for(var j=0,tmpCell;tmpCell=cells[j++];){var tmpEnd=domUtils.getXY(tmpCell)[flag?'x':'y']+tmpCell["offset"+(flag?'Width':'Height')];if(tmpEnd>end&&flag)break;if(cell==tmpCell||end==tmpEnd){if(tmpCell[flag?"colSpan":"rowSpan"]==1){returns.push(tmpCell);}if(flag)break;}}}return returns;}catch(e){showError(e);}},setCellContent:function setCellContent(cell,content){cell.innerHTML=content||(browser.ie?domUtils.fillChar:"<br />");},cloneCell:UETable.cloneCell,getSameStartPosXCells:function getSameStartPosXCells(cell){try{var start=domUtils.getXY(cell).x+cell.offsetWidth,rows=this.table.rows,cells,returns=[];for(var i=0;i<this.rowsNum;i++){cells=rows[i].cells;for(var j=0,tmpCell;tmpCell=cells[j++];){var tmpStart=domUtils.getXY(tmpCell).x;if(tmpStart>start)break;if(tmpStart==start&&tmpCell.colSpan==1){returns.push(tmpCell);break;}}}return returns;}catch(e){showError(e);}},update:function update(table){this.table=table||this.table;this.selectedTds=[];this.cellsRange={};this.indexTable=[];var rows=this.table.rows,rowsNum=this.getMaxRows(),dNum=rowsNum-rows.length,colsNum=this.getMaxCols();while(dNum--){this.table.insertRow(rows.length);}this.rowsNum=rowsNum;this.colsNum=colsNum;for(var i=0,len=rows.length;i<len;i++){this.indexTable[i]=new Array(colsNum);}
for(var rowIndex=0,row;row=rows[rowIndex];rowIndex++){for(var cellIndex=0,cell,cells=row.cells;cell=cells[cellIndex];cellIndex++){if(cell.rowSpan>rowsNum){cell.rowSpan=rowsNum;}var colIndex=cellIndex,rowSpan=cell.rowSpan||1,colSpan=cell.colSpan||1;while(this.indexTable[rowIndex][colIndex]){colIndex++;}for(var j=0;j<rowSpan;j++){for(var k=0;k<colSpan;k++){this.indexTable[rowIndex+j][colIndex+k]={rowIndex:rowIndex,cellIndex:cellIndex,colIndex:colIndex,rowSpan:rowSpan,colSpan:colSpan};}}}}
for(j=0;j<rowsNum;j++){for(k=0;k<colsNum;k++){if(this.indexTable[j][k]===undefined){row=rows[j];cell=row.cells[row.cells.length-1];cell=cell?cell.cloneNode(true):this.table.ownerDocument.createElement("td");this.setCellContent(cell);if(cell.colSpan!==1)cell.colSpan=1;if(cell.rowSpan!==1)cell.rowSpan=1;row.appendChild(cell);this.indexTable[j][k]={rowIndex:j,cellIndex:cell.cellIndex,colIndex:k,rowSpan:1,colSpan:1};}}}
var tds=domUtils.getElementsByTagName(this.table,"td"),selectTds=[];utils.each(tds,function(td){if(domUtils.hasClass(td,"selectTdClass")){selectTds.push(td);}});if(selectTds.length){var start=selectTds[0],end=selectTds[selectTds.length-1],startInfo=this.getCellInfo(start),endInfo=this.getCellInfo(end);this.selectedTds=selectTds;this.cellsRange={beginRowIndex:startInfo.rowIndex,beginColIndex:startInfo.colIndex,endRowIndex:endInfo.rowIndex+endInfo.rowSpan-1,endColIndex:endInfo.colIndex+endInfo.colSpan-1};}
if(!domUtils.hasClass(this.table.rows[0],"firstRow")){domUtils.addClass(this.table.rows[0],"firstRow");for(var i=1;i<this.table.rows.length;i++){domUtils.removeClasses(this.table.rows[i],"firstRow");}}},getCellInfo:function getCellInfo(cell){if(!cell)return;var cellIndex=cell.cellIndex,rowIndex=cell.parentNode.rowIndex,rowInfo=this.indexTable[rowIndex],numCols=this.colsNum;for(var colIndex=cellIndex;colIndex<numCols;colIndex++){var cellInfo=rowInfo[colIndex];if(cellInfo.rowIndex===rowIndex&&cellInfo.cellIndex===cellIndex){return cellInfo;}}},getCell:function getCell(rowIndex,cellIndex){return rowIndex<this.rowsNum&&this.table.rows[rowIndex].cells[cellIndex]||null;},deleteCell:function deleteCell(cell,rowIndex){rowIndex=typeof rowIndex=='number'?rowIndex:cell.parentNode.rowIndex;var row=this.table.rows[rowIndex];row.deleteCell(cell.cellIndex);},getCellsRange:function getCellsRange(cellA,cellB){function checkRange(beginRowIndex,beginColIndex,endRowIndex,endColIndex){var tmpBeginRowIndex=beginRowIndex,tmpBeginColIndex=beginColIndex,tmpEndRowIndex=endRowIndex,tmpEndColIndex=endColIndex,cellInfo,colIndex,rowIndex;if(beginRowIndex>0){for(colIndex=beginColIndex;colIndex<endColIndex;colIndex++){cellInfo=me.indexTable[beginRowIndex][colIndex];rowIndex=cellInfo.rowIndex;if(rowIndex<beginRowIndex){tmpBeginRowIndex=Math.min(rowIndex,tmpBeginRowIndex);}}}
if(endColIndex<me.colsNum){for(rowIndex=beginRowIndex;rowIndex<endRowIndex;rowIndex++){cellInfo=me.indexTable[rowIndex][endColIndex];colIndex=cellInfo.colIndex+cellInfo.colSpan-1;if(colIndex>endColIndex){tmpEndColIndex=Math.max(colIndex,tmpEndColIndex);}}}
if(endRowIndex<me.rowsNum){for(colIndex=beginColIndex;colIndex<endColIndex;colIndex++){cellInfo=me.indexTable[endRowIndex][colIndex];rowIndex=cellInfo.rowIndex+cellInfo.rowSpan-1;if(rowIndex>endRowIndex){tmpEndRowIndex=Math.max(rowIndex,tmpEndRowIndex);}}}
if(beginColIndex>0){for(rowIndex=beginRowIndex;rowIndex<endRowIndex;rowIndex++){cellInfo=me.indexTable[rowIndex][beginColIndex];colIndex=cellInfo.colIndex;if(colIndex<beginColIndex){tmpBeginColIndex=Math.min(cellInfo.colIndex,tmpBeginColIndex);}}}
if(tmpBeginRowIndex!=beginRowIndex||tmpBeginColIndex!=beginColIndex||tmpEndRowIndex!=endRowIndex||tmpEndColIndex!=endColIndex){return checkRange(tmpBeginRowIndex,tmpBeginColIndex,tmpEndRowIndex,tmpEndColIndex);}else{return{beginRowIndex:beginRowIndex,beginColIndex:beginColIndex,endRowIndex:endRowIndex,endColIndex:endColIndex};}}try{var me=this,cellAInfo=me.getCellInfo(cellA);if(cellA===cellB){return{beginRowIndex:cellAInfo.rowIndex,beginColIndex:cellAInfo.colIndex,endRowIndex:cellAInfo.rowIndex+cellAInfo.rowSpan-1,endColIndex:cellAInfo.colIndex+cellAInfo.colSpan-1};}var cellBInfo=me.getCellInfo(cellB);var beginRowIndex=Math.min(cellAInfo.rowIndex,cellBInfo.rowIndex),beginColIndex=Math.min(cellAInfo.colIndex,cellBInfo.colIndex),endRowIndex=Math.max(cellAInfo.rowIndex+cellAInfo.rowSpan-1,cellBInfo.rowIndex+cellBInfo.rowSpan-1),endColIndex=Math.max(cellAInfo.colIndex+cellAInfo.colSpan-1,cellBInfo.colIndex+cellBInfo.colSpan-1);return checkRange(beginRowIndex,beginColIndex,endRowIndex,endColIndex);}catch(e){}},getCells:function getCells(range){this.clearSelected();var beginRowIndex=range.beginRowIndex,beginColIndex=range.beginColIndex,endRowIndex=range.endRowIndex,endColIndex=range.endColIndex,cellInfo,rowIndex,colIndex,tdHash={},returnTds=[];for(var i=beginRowIndex;i<=endRowIndex;i++){for(var j=beginColIndex;j<=endColIndex;j++){cellInfo=this.indexTable[i][j];rowIndex=cellInfo.rowIndex;colIndex=cellInfo.colIndex;var key=rowIndex+'|'+colIndex;if(tdHash[key])continue;tdHash[key]=1;if(rowIndex<i||colIndex<j||rowIndex+cellInfo.rowSpan-1>endRowIndex||colIndex+cellInfo.colSpan-1>endColIndex){return null;}returnTds.push(this.getCell(rowIndex,cellInfo.cellIndex));}}return returnTds;},clearSelected:function clearSelected(){UETable.removeSelectedClass(this.selectedTds);this.selectedTds=[];this.cellsRange={};},setSelected:function setSelected(range){var cells=this.getCells(range);UETable.addSelectedClass(cells);this.selectedTds=cells;this.cellsRange=range;},isFullRow:function isFullRow(){var range=this.cellsRange;return range.endColIndex-range.beginColIndex+1==this.colsNum;},isFullCol:function isFullCol(){var range=this.cellsRange,table=this.table,ths=table.getElementsByTagName("th"),rows=range.endRowIndex-range.beginRowIndex+1;return!ths.length?rows==this.rowsNum:rows==this.rowsNum||rows==this.rowsNum-1;},getNextCell:function getNextCell(cell,bottom,ignoreRange){try{var cellInfo=this.getCellInfo(cell),nextRowIndex,nextColIndex;var len=this.selectedTds.length&&!ignoreRange,range=this.cellsRange;if(!bottom&&cellInfo.rowIndex==0||bottom&&(!len?cellInfo.rowIndex+cellInfo.rowSpan>this.rowsNum-1:range.endRowIndex==this.rowsNum-1))return null;nextRowIndex=!bottom?!len?cellInfo.rowIndex-1:range.beginRowIndex-1:!len?cellInfo.rowIndex+cellInfo.rowSpan:range.endRowIndex+1;nextColIndex=!len?cellInfo.colIndex:range.beginColIndex;return this.getCell(this.indexTable[nextRowIndex][nextColIndex].rowIndex,this.indexTable[nextRowIndex][nextColIndex].cellIndex);}catch(e){showError(e);}},getPreviewCell:function getPreviewCell(cell,top){try{var cellInfo=this.getCellInfo(cell),previewRowIndex,previewColIndex;var len=this.selectedTds.length,range=this.cellsRange;if(!top&&(!len?!cellInfo.colIndex:!range.beginColIndex)||top&&(!len?cellInfo.rowIndex>this.colsNum-1:range.endColIndex==this.colsNum-1))return null;previewRowIndex=!top?!len?cellInfo.rowIndex:range.beginRowIndex:!len?cellInfo.rowIndex<1?0:cellInfo.rowIndex-1:range.beginRowIndex;previewColIndex=!top?!len?cellInfo.colIndex<1?0:cellInfo.colIndex-1:range.beginColIndex-1:!len?cellInfo.colIndex:range.endColIndex+1;return this.getCell(this.indexTable[previewRowIndex][previewColIndex].rowIndex,this.indexTable[previewRowIndex][previewColIndex].cellIndex);}catch(e){showError(e);}},moveContent:function moveContent(cellTo,cellFrom){if(UETable.isEmptyBlock(cellFrom))return;if(UETable.isEmptyBlock(cellTo)){cellTo.innerHTML=cellFrom.innerHTML;return;}var child=cellTo.lastChild;if(child.nodeType==3||!dtd.$block[child.tagName]){cellTo.appendChild(cellTo.ownerDocument.createElement('br'));}while(child=cellFrom.firstChild){cellTo.appendChild(child);}},mergeRight:function mergeRight(cell){var cellInfo=this.getCellInfo(cell),rightColIndex=cellInfo.colIndex+cellInfo.colSpan,rightCellInfo=this.indexTable[cellInfo.rowIndex][rightColIndex],rightCell=this.getCell(rightCellInfo.rowIndex,rightCellInfo.cellIndex);cell.colSpan=cellInfo.colSpan+rightCellInfo.colSpan;cell.removeAttribute("width");this.moveContent(cell,rightCell);this.deleteCell(rightCell,rightCellInfo.rowIndex);this.update();},mergeDown:function mergeDown(cell){var cellInfo=this.getCellInfo(cell),downRowIndex=cellInfo.rowIndex+cellInfo.rowSpan,downCellInfo=this.indexTable[downRowIndex][cellInfo.colIndex],downCell=this.getCell(downCellInfo.rowIndex,downCellInfo.cellIndex);cell.rowSpan=cellInfo.rowSpan+downCellInfo.rowSpan;cell.removeAttribute("height");this.moveContent(cell,downCell);this.deleteCell(downCell,downCellInfo.rowIndex);this.update();},mergeRange:function mergeRange(){var range=this.cellsRange,leftTopCell=this.getCell(range.beginRowIndex,this.indexTable[range.beginRowIndex][range.beginColIndex].cellIndex);if(leftTopCell.tagName=="TH"&&range.endRowIndex!==range.beginRowIndex){var index=this.indexTable,info=this.getCellInfo(leftTopCell);leftTopCell=this.getCell(1,index[1][info.colIndex].cellIndex);range=this.getCellsRange(leftTopCell,this.getCell(index[this.rowsNum-1][info.colIndex].rowIndex,index[this.rowsNum-1][info.colIndex].cellIndex));}
var cells=this.getCells(range);for(var i=0,ci;ci=cells[i++];){if(ci!==leftTopCell){this.moveContent(leftTopCell,ci);this.deleteCell(ci);}}
leftTopCell.rowSpan=range.endRowIndex-range.beginRowIndex+1;leftTopCell.rowSpan>1&&leftTopCell.removeAttribute("height");leftTopCell.colSpan=range.endColIndex-range.beginColIndex+1;leftTopCell.colSpan>1&&leftTopCell.removeAttribute("width");if(leftTopCell.rowSpan==this.rowsNum&&leftTopCell.colSpan!=1){leftTopCell.colSpan=1;}if(leftTopCell.colSpan==this.colsNum&&leftTopCell.rowSpan!=1){var rowIndex=leftTopCell.parentNode.rowIndex;if(this.table.deleteRow){for(var i=rowIndex+1,curIndex=rowIndex+1,len=leftTopCell.rowSpan;i<len;i++){this.table.deleteRow(curIndex);}}else{for(var i=0,len=leftTopCell.rowSpan-1;i<len;i++){var row=this.table.rows[rowIndex+1];row.parentNode.removeChild(row);}}leftTopCell.rowSpan=1;}this.update();},insertRow:function insertRow(rowIndex,sourceCell){var numCols=this.colsNum,table=this.table,row=table.insertRow(rowIndex),cell,isInsertTitle=typeof sourceCell=='string'&&sourceCell.toUpperCase()=='TH';function replaceTdToTh(colIndex,cell,tableRow){if(colIndex==0){var tr=tableRow.nextSibling||tableRow.previousSibling,th=tr.cells[colIndex];if(th.tagName=='TH'){th=cell.ownerDocument.createElement("th");th.appendChild(cell.firstChild);tableRow.insertBefore(th,cell);domUtils.remove(cell);}}else{if(cell.tagName=='TH'){var td=cell.ownerDocument.createElement("td");td.appendChild(cell.firstChild);tableRow.insertBefore(td,cell);domUtils.remove(cell);}}}
if(rowIndex==0||rowIndex==this.rowsNum){for(var colIndex=0;colIndex<numCols;colIndex++){cell=this.cloneCell(sourceCell,true);this.setCellContent(cell);cell.getAttribute('vAlign')&&cell.setAttribute('vAlign',cell.getAttribute('vAlign'));row.appendChild(cell);if(!isInsertTitle)replaceTdToTh(colIndex,cell,row);}}else{var infoRow=this.indexTable[rowIndex],cellIndex=0;for(colIndex=0;colIndex<numCols;colIndex++){var cellInfo=infoRow[colIndex];if(cellInfo.rowIndex<rowIndex){cell=this.getCell(cellInfo.rowIndex,cellInfo.cellIndex);cell.rowSpan=cellInfo.rowSpan+1;}else{cell=this.cloneCell(sourceCell,true);this.setCellContent(cell);row.appendChild(cell);}if(!isInsertTitle)replaceTdToTh(colIndex,cell,row);}}
this.update();return row;},deleteRow:function deleteRow(rowIndex){var row=this.table.rows[rowIndex],infoRow=this.indexTable[rowIndex],colsNum=this.colsNum,count=0;for(var colIndex=0;colIndex<colsNum;){var cellInfo=infoRow[colIndex],cell=this.getCell(cellInfo.rowIndex,cellInfo.cellIndex);if(cell.rowSpan>1){if(cellInfo.rowIndex==rowIndex){var clone=cell.cloneNode(true);clone.rowSpan=cell.rowSpan-1;clone.innerHTML="";cell.rowSpan=1;var nextRowIndex=rowIndex+1,nextRow=this.table.rows[nextRowIndex],insertCellIndex,preMerged=this.getPreviewMergedCellsNum(nextRowIndex,colIndex)-count;if(preMerged<colIndex){insertCellIndex=colIndex-preMerged-1;domUtils.insertAfter(nextRow.cells[insertCellIndex],clone);}else{if(nextRow.cells.length)nextRow.insertBefore(clone,nextRow.cells[0]);}count+=1;}}colIndex+=cell.colSpan||1;}var deleteTds=[],cacheMap={};for(colIndex=0;colIndex<colsNum;colIndex++){var tmpRowIndex=infoRow[colIndex].rowIndex,tmpCellIndex=infoRow[colIndex].cellIndex,key=tmpRowIndex+"_"+tmpCellIndex;if(cacheMap[key])continue;cacheMap[key]=1;cell=this.getCell(tmpRowIndex,tmpCellIndex);deleteTds.push(cell);}var mergeTds=[];utils.each(deleteTds,function(td){if(td.rowSpan==1){td.parentNode.removeChild(td);}else{mergeTds.push(td);}});utils.each(mergeTds,function(td){td.rowSpan--;});row.parentNode.removeChild(row);this.update();},insertCol:function insertCol(colIndex,sourceCell,defaultValue){var rowsNum=this.rowsNum,rowIndex=0,tableRow,cell,backWidth=parseInt((this.table.offsetWidth-(this.colsNum+1)*20-(this.colsNum+1))/(this.colsNum+1),10),isInsertTitleCol=typeof sourceCell=='string'&&sourceCell.toUpperCase()=='TH';function replaceTdToTh(rowIndex,cell,tableRow){if(rowIndex==0){var th=cell.nextSibling||cell.previousSibling;if(th.tagName=='TH'){th=cell.ownerDocument.createElement("th");th.appendChild(cell.firstChild);tableRow.insertBefore(th,cell);domUtils.remove(cell);}}else{if(cell.tagName=='TH'){var td=cell.ownerDocument.createElement("td");td.appendChild(cell.firstChild);tableRow.insertBefore(td,cell);domUtils.remove(cell);}}}var preCell;if(colIndex==0||colIndex==this.colsNum){for(;rowIndex<rowsNum;rowIndex++){tableRow=this.table.rows[rowIndex];preCell=tableRow.cells[colIndex==0?colIndex:tableRow.cells.length];cell=this.cloneCell(sourceCell,true);this.setCellContent(cell);cell.setAttribute('vAlign',cell.getAttribute('vAlign'));preCell&&cell.setAttribute('width',preCell.getAttribute('width'));if(!colIndex){tableRow.insertBefore(cell,tableRow.cells[0]);}else{domUtils.insertAfter(tableRow.cells[tableRow.cells.length-1],cell);}if(!isInsertTitleCol)replaceTdToTh(rowIndex,cell,tableRow);}}else{for(;rowIndex<rowsNum;rowIndex++){var cellInfo=this.indexTable[rowIndex][colIndex];if(cellInfo.colIndex<colIndex){cell=this.getCell(cellInfo.rowIndex,cellInfo.cellIndex);cell.colSpan=cellInfo.colSpan+1;}else{tableRow=this.table.rows[rowIndex];preCell=tableRow.cells[cellInfo.cellIndex];cell=this.cloneCell(sourceCell,true);this.setCellContent(cell);cell.setAttribute('vAlign',cell.getAttribute('vAlign'));preCell&&cell.setAttribute('width',preCell.getAttribute('width'));preCell?tableRow.insertBefore(cell,preCell):tableRow.appendChild(cell);}if(!isInsertTitleCol)replaceTdToTh(rowIndex,cell,tableRow);}}
this.update();this.updateWidth(backWidth,defaultValue||{tdPadding:10,tdBorder:1});},updateWidth:function updateWidth(width,defaultValue){var table=this.table,tmpWidth=UETable.getWidth(table)-defaultValue.tdPadding*2-defaultValue.tdBorder+width;if(tmpWidth<table.ownerDocument.body.offsetWidth){table.setAttribute("width",tmpWidth);return;}var tds=domUtils.getElementsByTagName(this.table,"td th");utils.each(tds,function(td){td.setAttribute("width",width);});},deleteCol:function deleteCol(colIndex){var indexTable=this.indexTable,tableRows=this.table.rows,backTableWidth=this.table.getAttribute("width"),backTdWidth=0,rowsNum=this.rowsNum,cacheMap={};for(var rowIndex=0;rowIndex<rowsNum;){var infoRow=indexTable[rowIndex],cellInfo=infoRow[colIndex],key=cellInfo.rowIndex+'_'+cellInfo.colIndex;if(cacheMap[key])continue;cacheMap[key]=1;var cell=this.getCell(cellInfo.rowIndex,cellInfo.cellIndex);if(!backTdWidth)backTdWidth=cell&&parseInt(cell.offsetWidth/cell.colSpan,10).toFixed(0);if(cell.colSpan>1){cell.colSpan--;}else{tableRows[rowIndex].deleteCell(cellInfo.cellIndex);}rowIndex+=cellInfo.rowSpan||1;}this.table.setAttribute("width",backTableWidth-backTdWidth);this.update();},splitToCells:function splitToCells(cell){var me=this,cells=this.splitToRows(cell);utils.each(cells,function(cell){me.splitToCols(cell);});},splitToRows:function splitToRows(cell){var cellInfo=this.getCellInfo(cell),rowIndex=cellInfo.rowIndex,colIndex=cellInfo.colIndex,results=[];cell.rowSpan=1;results.push(cell);for(var i=rowIndex,endRow=rowIndex+cellInfo.rowSpan;i<endRow;i++){if(i==rowIndex)continue;var tableRow=this.table.rows[i],tmpCell=tableRow.insertCell(colIndex-this.getPreviewMergedCellsNum(i,colIndex));tmpCell.colSpan=cellInfo.colSpan;this.setCellContent(tmpCell);tmpCell.setAttribute('vAlign',cell.getAttribute('vAlign'));tmpCell.setAttribute('align',cell.getAttribute('align'));if(cell.style.cssText){tmpCell.style.cssText=cell.style.cssText;}results.push(tmpCell);}this.update();return results;},getPreviewMergedCellsNum:function getPreviewMergedCellsNum(rowIndex,colIndex){var indexRow=this.indexTable[rowIndex],num=0;for(var i=0;i<colIndex;){var colSpan=indexRow[i].colSpan,tmpRowIndex=indexRow[i].rowIndex;num+=colSpan-(tmpRowIndex==rowIndex?1:0);i+=colSpan;}return num;},splitToCols:function splitToCols(cell){var backWidth=(cell.offsetWidth/cell.colSpan-22).toFixed(0),cellInfo=this.getCellInfo(cell),rowIndex=cellInfo.rowIndex,colIndex=cellInfo.colIndex,results=[];cell.colSpan=1;cell.setAttribute("width",backWidth);results.push(cell);for(var j=colIndex,endCol=colIndex+cellInfo.colSpan;j<endCol;j++){if(j==colIndex)continue;var tableRow=this.table.rows[rowIndex],tmpCell=tableRow.insertCell(this.indexTable[rowIndex][j].cellIndex+1);tmpCell.rowSpan=cellInfo.rowSpan;this.setCellContent(tmpCell);tmpCell.setAttribute('vAlign',cell.getAttribute('vAlign'));tmpCell.setAttribute('align',cell.getAttribute('align'));tmpCell.setAttribute('width',backWidth);if(cell.style.cssText){tmpCell.style.cssText=cell.style.cssText;}
if(cell.tagName=='TH'){var th=cell.ownerDocument.createElement('th');th.appendChild(tmpCell.firstChild);th.setAttribute('vAlign',cell.getAttribute('vAlign'));th.rowSpan=tmpCell.rowSpan;tableRow.insertBefore(th,tmpCell);domUtils.remove(tmpCell);}results.push(tmpCell);}this.update();return results;},isLastCell:function isLastCell(cell,rowsNum,colsNum){rowsNum=rowsNum||this.rowsNum;colsNum=colsNum||this.colsNum;var cellInfo=this.getCellInfo(cell);return cellInfo.rowIndex+cellInfo.rowSpan==rowsNum&&cellInfo.colIndex+cellInfo.colSpan==colsNum;},getLastCell:function getLastCell(cells){cells=cells||this.table.getElementsByTagName("td");var firstInfo=this.getCellInfo(cells[0]);var me=this,last=cells[0],tr=last.parentNode,cellsNum=0,cols=0,rows;utils.each(cells,function(cell){if(cell.parentNode==tr)cols+=cell.colSpan||1;cellsNum+=cell.rowSpan*cell.colSpan||1;});rows=cellsNum/cols;utils.each(cells,function(cell){if(me.isLastCell(cell,rows,cols)){last=cell;return false;}});return last;},selectRow:function selectRow(rowIndex){var indexRow=this.indexTable[rowIndex],start=this.getCell(indexRow[0].rowIndex,indexRow[0].cellIndex),end=this.getCell(indexRow[this.colsNum-1].rowIndex,indexRow[this.colsNum-1].cellIndex),range=this.getCellsRange(start,end);this.setSelected(range);},selectTable:function selectTable(){var tds=this.table.getElementsByTagName("td"),range=this.getCellsRange(tds[0],tds[tds.length-1]);this.setSelected(range);},setBackground:function setBackground(cells,value){if(typeof value==="string"){utils.each(cells,function(cell){cell.style.backgroundColor=value;});}else if((typeof value==='undefined'?'undefined':_typeof(value))==="object"){value=utils.extend({repeat:true,colorList:["#ddd","#fff"]},value);var rowIndex=this.getCellInfo(cells[0]).rowIndex,count=0,colors=value.colorList,getColor=function getColor(list,index,repeat){return list[index]?list[index]:repeat?list[index%list.length]:"";};for(var i=0,cell;cell=cells[i++];){var cellInfo=this.getCellInfo(cell);cell.style.backgroundColor=getColor(colors,rowIndex+count==cellInfo.rowIndex?count:++count,value.repeat);}}},removeBackground:function removeBackground(cells){utils.each(cells,function(cell){cell.style.backgroundColor="";});}};function showError(e){}})();;(function(){var UT=UE.UETable,getTableItemsByRange=function getTableItemsByRange(editor){return UT.getTableItemsByRange(editor);},getUETableBySelected=function getUETableBySelected(editor){return UT.getUETableBySelected(editor);},getDefaultValue=function getDefaultValue(editor,table){return UT.getDefaultValue(editor,table);},getUETable=function getUETable(tdOrTable){return UT.getUETable(tdOrTable);};UE.commands['inserttable']={queryCommandState:function queryCommandState(){return getTableItemsByRange(this).table?-1:0;},execCommand:function execCommand(cmd,opt){function createTable(opt,tdWidth){var html=[],rowsNum=opt.numRows,colsNum=opt.numCols;for(var r=0;r<rowsNum;r++){html.push('<tr'+(r==0?' class="firstRow"':'')+'>');for(var c=0;c<colsNum;c++){html.push('<td width="'+tdWidth+'"  vAlign="'+opt.tdvalign+'" >'+(browser.ie&&browser.version<11?domUtils.fillChar:'<br/>')+'</td>');}html.push('</tr>');}
return'<table><tbody>'+html.join('')+'</tbody></table>';}if(!opt){opt=utils.extend({},{numCols:this.options.defaultCols,numRows:this.options.defaultRows,tdvalign:this.options.tdvalign});}var me=this;var range=this.selection.getRange(),start=range.startContainer,firstParentBlock=domUtils.findParent(start,function(node){return domUtils.isBlockElm(node);},true)||me.body;var defaultValue=getDefaultValue(me),tableWidth=firstParentBlock.offsetWidth,tdWidth=Math.floor(tableWidth/opt.numCols-defaultValue.tdPadding*2-defaultValue.tdBorder);!opt.tdvalign&&(opt.tdvalign=me.options.tdvalign);me.execCommand("inserthtml",createTable(opt,tdWidth));}};UE.commands['insertparagraphbeforetable']={queryCommandState:function queryCommandState(){return getTableItemsByRange(this).cell?0:-1;},execCommand:function execCommand(){var table=getTableItemsByRange(this).table;if(table){var p=this.document.createElement("p");p.innerHTML=browser.ie?'&nbsp;':'<br />';table.parentNode.insertBefore(p,table);this.selection.getRange().setStart(p,0).setCursor();}}};UE.commands['deletetable']={queryCommandState:function queryCommandState(){var rng=this.selection.getRange();return domUtils.findParentByTagName(rng.startContainer,'table',true)?0:-1;},execCommand:function execCommand(cmd,table){var rng=this.selection.getRange();table=table||domUtils.findParentByTagName(rng.startContainer,'table',true);if(table){var next=table.nextSibling;if(!next){next=domUtils.createElement(this.document,'p',{'innerHTML':browser.ie?domUtils.fillChar:'<br/>'});table.parentNode.insertBefore(next,table);}domUtils.remove(table);rng=this.selection.getRange();if(next.nodeType==3){rng.setStartBefore(next);}else{rng.setStart(next,0);}rng.setCursor(false,true);this.fireEvent("tablehasdeleted");}}};UE.commands['cellalign']={queryCommandState:function queryCommandState(){return getSelectedArr(this).length?0:-1;},execCommand:function execCommand(cmd,align){var selectedTds=getSelectedArr(this);if(selectedTds.length){for(var i=0,ci;ci=selectedTds[i++];){ci.setAttribute('align',align);}}}};UE.commands['cellvalign']={queryCommandState:function queryCommandState(){return getSelectedArr(this).length?0:-1;},execCommand:function execCommand(cmd,valign){var selectedTds=getSelectedArr(this);if(selectedTds.length){for(var i=0,ci;ci=selectedTds[i++];){ci.setAttribute('vAlign',valign);}}}};UE.commands['insertcaption']={queryCommandState:function queryCommandState(){var table=getTableItemsByRange(this).table;if(table){return table.getElementsByTagName('caption').length==0?1:-1;}return-1;},execCommand:function execCommand(){var table=getTableItemsByRange(this).table;if(table){var caption=this.document.createElement('caption');caption.innerHTML=browser.ie?domUtils.fillChar:'<br/>';table.insertBefore(caption,table.firstChild);var range=this.selection.getRange();range.setStart(caption,0).setCursor();}}};UE.commands['deletecaption']={queryCommandState:function queryCommandState(){var rng=this.selection.getRange(),table=domUtils.findParentByTagName(rng.startContainer,'table');if(table){return table.getElementsByTagName('caption').length==0?-1:1;}return-1;},execCommand:function execCommand(){var rng=this.selection.getRange(),table=domUtils.findParentByTagName(rng.startContainer,'table');if(table){domUtils.remove(table.getElementsByTagName('caption')[0]);var range=this.selection.getRange();range.setStart(table.rows[0].cells[0],0).setCursor();}}};UE.commands['inserttitle']={queryCommandState:function queryCommandState(){var table=getTableItemsByRange(this).table;if(table){var firstRow=table.rows[0];return firstRow.cells[firstRow.cells.length-1].tagName.toLowerCase()!='th'?0:-1;}return-1;},execCommand:function execCommand(){var table=getTableItemsByRange(this).table;if(table){getUETable(table).insertRow(0,'th');}var th=table.getElementsByTagName('th')[0];this.selection.getRange().setStart(th,0).setCursor(false,true);}};UE.commands['deletetitle']={queryCommandState:function queryCommandState(){var table=getTableItemsByRange(this).table;if(table){var firstRow=table.rows[0];return firstRow.cells[firstRow.cells.length-1].tagName.toLowerCase()=='th'?0:-1;}return-1;},execCommand:function execCommand(){var table=getTableItemsByRange(this).table;if(table){domUtils.remove(table.rows[0]);}var td=table.getElementsByTagName('td')[0];this.selection.getRange().setStart(td,0).setCursor(false,true);}};UE.commands['inserttitlecol']={queryCommandState:function queryCommandState(){var table=getTableItemsByRange(this).table;if(table){var lastRow=table.rows[table.rows.length-1];return lastRow.getElementsByTagName('th').length?-1:0;}return-1;},execCommand:function execCommand(cmd){var table=getTableItemsByRange(this).table;if(table){getUETable(table).insertCol(0,'th');}resetTdWidth(table,this);var th=table.getElementsByTagName('th')[0];this.selection.getRange().setStart(th,0).setCursor(false,true);}};UE.commands['deletetitlecol']={queryCommandState:function queryCommandState(){var table=getTableItemsByRange(this).table;if(table){var lastRow=table.rows[table.rows.length-1];return lastRow.getElementsByTagName('th').length?0:-1;}return-1;},execCommand:function execCommand(){var table=getTableItemsByRange(this).table;if(table){for(var i=0;i<table.rows.length;i++){domUtils.remove(table.rows[i].children[0]);}}resetTdWidth(table,this);var td=table.getElementsByTagName('td')[0];this.selection.getRange().setStart(td,0).setCursor(false,true);}};UE.commands["mergeright"]={queryCommandState:function queryCommandState(cmd){var tableItems=getTableItemsByRange(this),table=tableItems.table,cell=tableItems.cell;if(!table||!cell)return-1;var ut=getUETable(table);if(ut.selectedTds.length)return-1;var cellInfo=ut.getCellInfo(cell),rightColIndex=cellInfo.colIndex+cellInfo.colSpan;if(rightColIndex>=ut.colsNum)return-1;var rightCellInfo=ut.indexTable[cellInfo.rowIndex][rightColIndex],rightCell=table.rows[rightCellInfo.rowIndex].cells[rightCellInfo.cellIndex];if(!rightCell||cell.tagName!=rightCell.tagName)return-1;return rightCellInfo.rowIndex==cellInfo.rowIndex&&rightCellInfo.rowSpan==cellInfo.rowSpan?0:-1;},execCommand:function execCommand(cmd){var rng=this.selection.getRange(),bk=rng.createBookmark(true);var cell=getTableItemsByRange(this).cell,ut=getUETable(cell);ut.mergeRight(cell);rng.moveToBookmark(bk).select();}};UE.commands["mergedown"]={queryCommandState:function queryCommandState(cmd){var tableItems=getTableItemsByRange(this),table=tableItems.table,cell=tableItems.cell;if(!table||!cell)return-1;var ut=getUETable(table);if(ut.selectedTds.length)return-1;var cellInfo=ut.getCellInfo(cell),downRowIndex=cellInfo.rowIndex+cellInfo.rowSpan;if(downRowIndex>=ut.rowsNum)return-1;var downCellInfo=ut.indexTable[downRowIndex][cellInfo.colIndex],downCell=table.rows[downCellInfo.rowIndex].cells[downCellInfo.cellIndex];if(!downCell||cell.tagName!=downCell.tagName)return-1;return downCellInfo.colIndex==cellInfo.colIndex&&downCellInfo.colSpan==cellInfo.colSpan?0:-1;},execCommand:function execCommand(){var rng=this.selection.getRange(),bk=rng.createBookmark(true);var cell=getTableItemsByRange(this).cell,ut=getUETable(cell);ut.mergeDown(cell);rng.moveToBookmark(bk).select();}};UE.commands["mergecells"]={queryCommandState:function queryCommandState(){return getUETableBySelected(this)?0:-1;},execCommand:function execCommand(){var ut=getUETableBySelected(this);if(ut&&ut.selectedTds.length){var cell=ut.selectedTds[0];ut.mergeRange();var rng=this.selection.getRange();if(domUtils.isEmptyBlock(cell)){rng.setStart(cell,0).collapse(true);}else{rng.selectNodeContents(cell);}rng.select();}}};UE.commands["insertrow"]={queryCommandState:function queryCommandState(){var tableItems=getTableItemsByRange(this),cell=tableItems.cell;return cell&&(cell.tagName=="TD"||cell.tagName=='TH'&&tableItems.tr!==tableItems.table.rows[0])&&getUETable(tableItems.table).rowsNum<this.options.maxRowNum?0:-1;},execCommand:function execCommand(){var rng=this.selection.getRange(),bk=rng.createBookmark(true);var tableItems=getTableItemsByRange(this),cell=tableItems.cell,table=tableItems.table,ut=getUETable(table),cellInfo=ut.getCellInfo(cell);if(!ut.selectedTds.length){ut.insertRow(cellInfo.rowIndex,cell);}else{var range=ut.cellsRange;for(var i=0,len=range.endRowIndex-range.beginRowIndex+1;i<len;i++){ut.insertRow(range.beginRowIndex,cell);}}rng.moveToBookmark(bk).select();if(table.getAttribute("interlaced")==="enabled")this.fireEvent("interlacetable",table);}};UE.commands["insertrownext"]={queryCommandState:function queryCommandState(){var tableItems=getTableItemsByRange(this),cell=tableItems.cell;return cell&&cell.tagName=="TD"&&getUETable(tableItems.table).rowsNum<this.options.maxRowNum?0:-1;},execCommand:function execCommand(){var rng=this.selection.getRange(),bk=rng.createBookmark(true);var tableItems=getTableItemsByRange(this),cell=tableItems.cell,table=tableItems.table,ut=getUETable(table),cellInfo=ut.getCellInfo(cell);if(!ut.selectedTds.length){ut.insertRow(cellInfo.rowIndex+cellInfo.rowSpan,cell);}else{var range=ut.cellsRange;for(var i=0,len=range.endRowIndex-range.beginRowIndex+1;i<len;i++){ut.insertRow(range.endRowIndex+1,cell);}}rng.moveToBookmark(bk).select();if(table.getAttribute("interlaced")==="enabled")this.fireEvent("interlacetable",table);}};UE.commands["deleterow"]={queryCommandState:function queryCommandState(){var tableItems=getTableItemsByRange(this);return tableItems.cell?0:-1;},execCommand:function execCommand(){var cell=getTableItemsByRange(this).cell,ut=getUETable(cell),cellsRange=ut.cellsRange,cellInfo=ut.getCellInfo(cell),preCell=ut.getVSideCell(cell),nextCell=ut.getVSideCell(cell,true),rng=this.selection.getRange();if(utils.isEmptyObject(cellsRange)){ut.deleteRow(cellInfo.rowIndex);}else{for(var i=cellsRange.beginRowIndex;i<cellsRange.endRowIndex+1;i++){ut.deleteRow(cellsRange.beginRowIndex);}}var table=ut.table;if(!table.getElementsByTagName('td').length){var nextSibling=table.nextSibling;domUtils.remove(table);if(nextSibling){rng.setStart(nextSibling,0).setCursor(false,true);}}else{if(cellInfo.rowSpan==1||cellInfo.rowSpan==cellsRange.endRowIndex-cellsRange.beginRowIndex+1){if(nextCell||preCell)rng.selectNodeContents(nextCell||preCell).setCursor(false,true);}else{var newCell=ut.getCell(cellInfo.rowIndex,ut.indexTable[cellInfo.rowIndex][cellInfo.colIndex].cellIndex);if(newCell)rng.selectNodeContents(newCell).setCursor(false,true);}}if(table.getAttribute("interlaced")==="enabled")this.fireEvent("interlacetable",table);}};UE.commands["insertcol"]={queryCommandState:function queryCommandState(cmd){var tableItems=getTableItemsByRange(this),cell=tableItems.cell;return cell&&(cell.tagName=="TD"||cell.tagName=='TH'&&cell!==tableItems.tr.cells[0])&&getUETable(tableItems.table).colsNum<this.options.maxColNum?0:-1;},execCommand:function execCommand(cmd){var rng=this.selection.getRange(),bk=rng.createBookmark(true);if(this.queryCommandState(cmd)==-1)return;var cell=getTableItemsByRange(this).cell,ut=getUETable(cell),cellInfo=ut.getCellInfo(cell);if(!ut.selectedTds.length){ut.insertCol(cellInfo.colIndex,cell);}else{var range=ut.cellsRange;for(var i=0,len=range.endColIndex-range.beginColIndex+1;i<len;i++){ut.insertCol(range.beginColIndex,cell);}}rng.moveToBookmark(bk).select(true);}};UE.commands["insertcolnext"]={queryCommandState:function queryCommandState(){var tableItems=getTableItemsByRange(this),cell=tableItems.cell;return cell&&getUETable(tableItems.table).colsNum<this.options.maxColNum?0:-1;},execCommand:function execCommand(){var rng=this.selection.getRange(),bk=rng.createBookmark(true);var cell=getTableItemsByRange(this).cell,ut=getUETable(cell),cellInfo=ut.getCellInfo(cell);if(!ut.selectedTds.length){ut.insertCol(cellInfo.colIndex+cellInfo.colSpan,cell);}else{var range=ut.cellsRange;for(var i=0,len=range.endColIndex-range.beginColIndex+1;i<len;i++){ut.insertCol(range.endColIndex+1,cell);}}rng.moveToBookmark(bk).select();}};UE.commands["deletecol"]={queryCommandState:function queryCommandState(){var tableItems=getTableItemsByRange(this);return tableItems.cell?0:-1;},execCommand:function execCommand(){var cell=getTableItemsByRange(this).cell,ut=getUETable(cell),range=ut.cellsRange,cellInfo=ut.getCellInfo(cell),preCell=ut.getHSideCell(cell),nextCell=ut.getHSideCell(cell,true);if(utils.isEmptyObject(range)){ut.deleteCol(cellInfo.colIndex);}else{for(var i=range.beginColIndex;i<range.endColIndex+1;i++){ut.deleteCol(range.beginColIndex);}}var table=ut.table,rng=this.selection.getRange();if(!table.getElementsByTagName('td').length){var nextSibling=table.nextSibling;domUtils.remove(table);if(nextSibling){rng.setStart(nextSibling,0).setCursor(false,true);}}else{if(domUtils.inDoc(cell,this.document)){rng.setStart(cell,0).setCursor(false,true);}else{if(nextCell&&domUtils.inDoc(nextCell,this.document)){rng.selectNodeContents(nextCell).setCursor(false,true);}else{if(preCell&&domUtils.inDoc(preCell,this.document)){rng.selectNodeContents(preCell).setCursor(true,true);}}}}}};UE.commands["splittocells"]={queryCommandState:function queryCommandState(){var tableItems=getTableItemsByRange(this),cell=tableItems.cell;if(!cell)return-1;var ut=getUETable(tableItems.table);if(ut.selectedTds.length>0)return-1;return cell&&(cell.colSpan>1||cell.rowSpan>1)?0:-1;},execCommand:function execCommand(){var rng=this.selection.getRange(),bk=rng.createBookmark(true);var cell=getTableItemsByRange(this).cell,ut=getUETable(cell);ut.splitToCells(cell);rng.moveToBookmark(bk).select();}};UE.commands["splittorows"]={queryCommandState:function queryCommandState(){var tableItems=getTableItemsByRange(this),cell=tableItems.cell;if(!cell)return-1;var ut=getUETable(tableItems.table);if(ut.selectedTds.length>0)return-1;return cell&&cell.rowSpan>1?0:-1;},execCommand:function execCommand(){var rng=this.selection.getRange(),bk=rng.createBookmark(true);var cell=getTableItemsByRange(this).cell,ut=getUETable(cell);ut.splitToRows(cell);rng.moveToBookmark(bk).select();}};UE.commands["splittocols"]={queryCommandState:function queryCommandState(){var tableItems=getTableItemsByRange(this),cell=tableItems.cell;if(!cell)return-1;var ut=getUETable(tableItems.table);if(ut.selectedTds.length>0)return-1;return cell&&cell.colSpan>1?0:-1;},execCommand:function execCommand(){var rng=this.selection.getRange(),bk=rng.createBookmark(true);var cell=getTableItemsByRange(this).cell,ut=getUETable(cell);ut.splitToCols(cell);rng.moveToBookmark(bk).select();}};UE.commands["adaptbytext"]=UE.commands["adaptbywindow"]={queryCommandState:function queryCommandState(){return getTableItemsByRange(this).table?0:-1;},execCommand:function execCommand(cmd){var tableItems=getTableItemsByRange(this),table=tableItems.table;if(table){if(cmd=='adaptbywindow'){resetTdWidth(table,this);}else{var cells=domUtils.getElementsByTagName(table,"td th");utils.each(cells,function(cell){cell.removeAttribute("width");});table.removeAttribute("width");}}}};UE.commands['averagedistributecol']={queryCommandState:function queryCommandState(){var ut=getUETableBySelected(this);if(!ut)return-1;return ut.isFullRow()||ut.isFullCol()?0:-1;},execCommand:function execCommand(cmd){var me=this,ut=getUETableBySelected(me);function getAverageWidth(){var tb=ut.table,averageWidth,sumWidth=0,colsNum=0,tbAttr=getDefaultValue(me,tb);if(ut.isFullRow()){sumWidth=tb.offsetWidth;colsNum=ut.colsNum;}else{var begin=ut.cellsRange.beginColIndex,end=ut.cellsRange.endColIndex,node;for(var i=begin;i<=end;){node=ut.selectedTds[i];sumWidth+=node.offsetWidth;i+=node.colSpan;colsNum+=1;}}averageWidth=Math.ceil(sumWidth/colsNum)-tbAttr.tdBorder*2-tbAttr.tdPadding*2;return averageWidth;}function setAverageWidth(averageWidth){utils.each(domUtils.getElementsByTagName(ut.table,"th"),function(node){node.setAttribute("width","");});var cells=ut.isFullRow()?domUtils.getElementsByTagName(ut.table,"td"):ut.selectedTds;utils.each(cells,function(node){if(node.colSpan==1){node.setAttribute("width",averageWidth);}});}if(ut&&ut.selectedTds.length){setAverageWidth(getAverageWidth());}}};UE.commands['averagedistributerow']={queryCommandState:function queryCommandState(){var ut=getUETableBySelected(this);if(!ut)return-1;if(ut.selectedTds&&/th/ig.test(ut.selectedTds[0].tagName))return-1;return ut.isFullRow()||ut.isFullCol()?0:-1;},execCommand:function execCommand(cmd){var me=this,ut=getUETableBySelected(me);function getAverageHeight(){var averageHeight,rowNum,sumHeight=0,tb=ut.table,tbAttr=getDefaultValue(me,tb),tdpadding=parseInt(domUtils.getComputedStyle(tb.getElementsByTagName('td')[0],"padding-top"));if(ut.isFullCol()){var captionArr=domUtils.getElementsByTagName(tb,"caption"),thArr=domUtils.getElementsByTagName(tb,"th"),captionHeight,thHeight;if(captionArr.length>0){captionHeight=captionArr[0].offsetHeight;}if(thArr.length>0){thHeight=thArr[0].offsetHeight;}sumHeight=tb.offsetHeight-(captionHeight||0)-(thHeight||0);rowNum=thArr.length==0?ut.rowsNum:ut.rowsNum-1;}else{var begin=ut.cellsRange.beginRowIndex,end=ut.cellsRange.endRowIndex,count=0,trs=domUtils.getElementsByTagName(tb,"tr");for(var i=begin;i<=end;i++){sumHeight+=trs[i].offsetHeight;count+=1;}rowNum=count;}
if(browser.ie&&browser.version<9){averageHeight=Math.ceil(sumHeight/rowNum);}else{averageHeight=Math.ceil(sumHeight/rowNum)-tbAttr.tdBorder*2-tdpadding*2;}return averageHeight;}function setAverageHeight(averageHeight){var cells=ut.isFullCol()?domUtils.getElementsByTagName(ut.table,"td"):ut.selectedTds;utils.each(cells,function(node){if(node.rowSpan==1){node.setAttribute("height",averageHeight);}});}if(ut&&ut.selectedTds.length){setAverageHeight(getAverageHeight());}}};UE.commands['cellalignment']={queryCommandState:function queryCommandState(){return getTableItemsByRange(this).table?0:-1;},execCommand:function execCommand(cmd,data){var me=this,ut=getUETableBySelected(me);if(!ut){var start=me.selection.getStart(),cell=start&&domUtils.findParentByTagName(start,["td","th","caption"],true);if(!/caption/ig.test(cell.tagName)){domUtils.setAttributes(cell,data);}else{cell.style.textAlign=data.align;cell.style.verticalAlign=data.vAlign;}me.selection.getRange().setCursor(true);}else{utils.each(ut.selectedTds,function(cell){domUtils.setAttributes(cell,data);});}},queryCommandValue:function queryCommandValue(cmd){var activeMenuCell=getTableItemsByRange(this).cell;if(!activeMenuCell){activeMenuCell=getSelectedArr(this)[0];}if(!activeMenuCell){return null;}else{var cells=UE.UETable.getUETable(activeMenuCell).selectedTds;!cells.length&&(cells=activeMenuCell);return UE.UETable.getTableCellAlignState(cells);}}};UE.commands['tablealignment']={queryCommandState:function queryCommandState(){if(browser.ie&&browser.version<8){return-1;}return getTableItemsByRange(this).table?0:-1;},execCommand:function execCommand(cmd,value){var me=this,start=me.selection.getStart(),table=start&&domUtils.findParentByTagName(start,["table"],true);if(table){table.setAttribute("align",value);}}};UE.commands['edittable']={queryCommandState:function queryCommandState(){return getTableItemsByRange(this).table?0:-1;},execCommand:function execCommand(cmd,color){var rng=this.selection.getRange(),table=domUtils.findParentByTagName(rng.startContainer,'table');if(table){var arr=domUtils.getElementsByTagName(table,"td").concat(domUtils.getElementsByTagName(table,"th"),domUtils.getElementsByTagName(table,"caption"));utils.each(arr,function(node){node.style.borderColor=color;});}}};UE.commands['edittd']={queryCommandState:function queryCommandState(){return getTableItemsByRange(this).table?0:-1;},execCommand:function execCommand(cmd,bkColor){var me=this,ut=getUETableBySelected(me);if(!ut){var start=me.selection.getStart(),cell=start&&domUtils.findParentByTagName(start,["td","th","caption"],true);if(cell){cell.style.backgroundColor=bkColor;}}else{utils.each(ut.selectedTds,function(cell){cell.style.backgroundColor=bkColor;});}}};UE.commands["settablebackground"]={queryCommandState:function queryCommandState(){return getSelectedArr(this).length>1?0:-1;},execCommand:function execCommand(cmd,value){var cells,ut;cells=getSelectedArr(this);ut=getUETable(cells[0]);ut.setBackground(cells,value);}};UE.commands["cleartablebackground"]={queryCommandState:function queryCommandState(){var cells=getSelectedArr(this);if(!cells.length)return-1;for(var i=0,cell;cell=cells[i++];){if(cell.style.backgroundColor!=="")return 0;}return-1;},execCommand:function execCommand(){var cells=getSelectedArr(this),ut=getUETable(cells[0]);ut.removeBackground(cells);}};UE.commands["interlacetable"]=UE.commands["uninterlacetable"]={queryCommandState:function queryCommandState(cmd){var table=getTableItemsByRange(this).table;if(!table)return-1;var interlaced=table.getAttribute("interlaced");if(cmd=="interlacetable"){return interlaced==="enabled"?-1:0;}else{return!interlaced||interlaced==="disabled"?-1:0;}},execCommand:function execCommand(cmd,classList){var table=getTableItemsByRange(this).table;if(cmd=="interlacetable"){table.setAttribute("interlaced","enabled");this.fireEvent("interlacetable",table,classList);}else{table.setAttribute("interlaced","disabled");this.fireEvent("uninterlacetable",table);}}};UE.commands["setbordervisible"]={queryCommandState:function queryCommandState(cmd){var table=getTableItemsByRange(this).table;if(!table)return-1;return 0;},execCommand:function execCommand(){var table=getTableItemsByRange(this).table;utils.each(domUtils.getElementsByTagName(table,'td'),function(td){td.style.borderWidth='1px';td.style.borderStyle='solid';});}};function resetTdWidth(table,editor){var tds=domUtils.getElementsByTagName(table,'td th');utils.each(tds,function(td){td.removeAttribute("width");});table.setAttribute('width',getTableWidth(editor,true,getDefaultValue(editor,table)));var tdsWidths=[];setTimeout(function(){utils.each(tds,function(td){td.colSpan==1&&tdsWidths.push(td.offsetWidth);});utils.each(tds,function(td,i){td.colSpan==1&&td.setAttribute("width",tdsWidths[i]+"");});},0);}function getTableWidth(editor,needIEHack,defaultValue){var body=editor.body;return body.offsetWidth-(needIEHack?parseInt(domUtils.getComputedStyle(body,'margin-left'),10)*2:0)-defaultValue.tableBorder*2-(editor.options.offsetWidth||0);}function getSelectedArr(editor){var cell=getTableItemsByRange(editor).cell;if(cell){var ut=getUETable(cell);return ut.selectedTds.length?ut.selectedTds:[cell];}else{return[];}}})();UE.plugins['table']=function(){var me=this,tabTimer=null,tableDragTimer=null,tableResizeTimer=null,cellMinWidth=5,isInResizeBuffer=false,cellBorderWidth=5,offsetOfTableCell=10,singleClickState=0,userActionStatus=null,dblclickTime=360,UT=UE.UETable,getUETable=function getUETable(tdOrTable){return UT.getUETable(tdOrTable);},getUETableBySelected=function getUETableBySelected(editor){return UT.getUETableBySelected(editor);},getDefaultValue=function getDefaultValue(editor,table){return UT.getDefaultValue(editor,table);},removeSelectedClass=function removeSelectedClass(cells){return UT.removeSelectedClass(cells);};function showError(e){}me.ready(function(){var me=this;var orgGetText=me.selection.getText;me.selection.getText=function(){var table=getUETableBySelected(me);if(table){var str='';utils.each(table.selectedTds,function(td){str+=td[browser.ie?'innerText':'textContent'];});return str;}else{return orgGetText.call(me.selection);}};});var startTd=null,currentTd=null,onDrag="",onBorder=false,dragButton=null,dragOver=false,dragLine=null,dragTd=null;var mousedown=false,needIEHack=true;me.setOpt({'maxColNum':20,'maxRowNum':100,'defaultCols':5,'defaultRows':5,'tdvalign':'top','cursorpath':me.options.UEDITOR_HOME_URL+"themes/default/images/cursor_",'tableDragable':false,'classList':["ue-table-interlace-color-single","ue-table-interlace-color-double"]});me.getUETable=getUETable;var commands={'deletetable':1,'inserttable':1,'cellvalign':1,'insertcaption':1,'deletecaption':1,'inserttitle':1,'deletetitle':1,"mergeright":1,"mergedown":1,"mergecells":1,"insertrow":1,"insertrownext":1,"deleterow":1,"insertcol":1,"insertcolnext":1,"deletecol":1,"splittocells":1,"splittorows":1,"splittocols":1,"adaptbytext":1,"adaptbywindow":1,"adaptbycustomer":1,"insertparagraph":1,"insertparagraphbeforetable":1,"averagedistributecol":1,"averagedistributerow":1};me.ready(function(){utils.cssRule('table','.selectTdClass{background-color:#edf5fa !important}'+'table.noBorderTable td,table.noBorderTable th,table.noBorderTable caption{border:1px dashed #ddd !important}'+'table{margin-bottom:10px;border-collapse:collapse;display:table;}'+'td,th{padding: 5px 10px;border: 1px solid #DDD;}'+'caption{border:1px dashed #DDD;border-bottom:0;padding:3px;text-align:center;}'+'th{border-top:1px solid #BBB;background-color:#F7F7F7;}'+'table tr.firstRow th{border-top-width:2px;}'+'.ue-table-interlace-color-single{ background-color: #fcfcfc; } .ue-table-interlace-color-double{ background-color: #f7faff; }'+'td p{margin:0;padding:0;}',me.document);var tableCopyList,isFullCol,isFullRow;me.addListener('keydown',function(cmd,evt){var me=this;var keyCode=evt.keyCode||evt.which;if(keyCode==8){var ut=getUETableBySelected(me);if(ut&&ut.selectedTds.length){if(ut.isFullCol()){me.execCommand('deletecol');}else if(ut.isFullRow()){me.execCommand('deleterow');}else{me.fireEvent('delcells');}domUtils.preventDefault(evt);}var caption=domUtils.findParentByTagName(me.selection.getStart(),'caption',true),range=me.selection.getRange();if(range.collapsed&&caption&&isEmptyBlock(caption)){me.fireEvent('saveScene');var table=caption.parentNode;domUtils.remove(caption);if(table){range.setStart(table.rows[0].cells[0],0).setCursor(false,true);}me.fireEvent('saveScene');}}if(keyCode==46){ut=getUETableBySelected(me);if(ut){me.fireEvent('saveScene');for(var i=0,ci;ci=ut.selectedTds[i++];){domUtils.fillNode(me.document,ci);}me.fireEvent('saveScene');domUtils.preventDefault(evt);}}if(keyCode==13){var rng=me.selection.getRange(),caption=domUtils.findParentByTagName(rng.startContainer,'caption',true);if(caption){var table=domUtils.findParentByTagName(caption,'table');if(!rng.collapsed){rng.deleteContents();me.fireEvent('saveScene');}else{if(caption){rng.setStart(table.rows[0].cells[0],0).setCursor(false,true);}}domUtils.preventDefault(evt);return;}if(rng.collapsed){var table=domUtils.findParentByTagName(rng.startContainer,'table');if(table){var cell=table.rows[0].cells[0],start=domUtils.findParentByTagName(me.selection.getStart(),['td','th'],true),preNode=table.previousSibling;if(cell===start&&(!preNode||preNode.nodeType==1&&preNode.tagName=='TABLE')&&domUtils.isStartInblock(rng)){var first=domUtils.findParent(me.selection.getStart(),function(n){return domUtils.isBlockElm(n);},true);if(first&&(/t(h|d)/i.test(first.tagName)||first===start.firstChild)){me.execCommand('insertparagraphbeforetable');domUtils.preventDefault(evt);}}}}}if((evt.ctrlKey||evt.metaKey)&&evt.keyCode=='67'){tableCopyList=null;var ut=getUETableBySelected(me);if(ut){var tds=ut.selectedTds;isFullCol=ut.isFullCol();isFullRow=ut.isFullRow();tableCopyList=[[ut.cloneCell(tds[0],null,true)]];for(var i=1,ci;ci=tds[i];i++){if(ci.parentNode!==tds[i-1].parentNode){tableCopyList.push([ut.cloneCell(ci,null,true)]);}else{tableCopyList[tableCopyList.length-1].push(ut.cloneCell(ci,null,true));}}}}});me.addListener("tablehasdeleted",function(){toggleDraggableState(this,false,"",null);if(dragButton)domUtils.remove(dragButton);});me.addListener('beforepaste',function(cmd,html){var me=this;var rng=me.selection.getRange();if(domUtils.findParentByTagName(rng.startContainer,'caption',true)){var div=me.document.createElement("div");div.innerHTML=html.html;html.html=div[browser.ie9below?'innerText':'textContent'];return;}var table=getUETableBySelected(me);if(tableCopyList){me.fireEvent('saveScene');var rng=me.selection.getRange();var td=domUtils.findParentByTagName(rng.startContainer,['td','th'],true),tmpNode,preNode;if(td){var ut=getUETable(td);if(isFullRow){var rowIndex=ut.getCellInfo(td).rowIndex;if(td.tagName=='TH'){rowIndex++;}for(var i=0,ci;ci=tableCopyList[i++];){var tr=ut.insertRow(rowIndex++,"td");for(var j=0,cj;cj=ci[j];j++){var cell=tr.cells[j];if(!cell){cell=tr.insertCell(j);}cell.innerHTML=cj.innerHTML;cj.getAttribute('width')&&cell.setAttribute('width',cj.getAttribute('width'));cj.getAttribute('vAlign')&&cell.setAttribute('vAlign',cj.getAttribute('vAlign'));cj.getAttribute('align')&&cell.setAttribute('align',cj.getAttribute('align'));cj.style.cssText&&(cell.style.cssText=cj.style.cssText);}for(var j=0,cj;cj=tr.cells[j];j++){if(!ci[j])break;cj.innerHTML=ci[j].innerHTML;ci[j].getAttribute('width')&&cj.setAttribute('width',ci[j].getAttribute('width'));ci[j].getAttribute('vAlign')&&cj.setAttribute('vAlign',ci[j].getAttribute('vAlign'));ci[j].getAttribute('align')&&cj.setAttribute('align',ci[j].getAttribute('align'));ci[j].style.cssText&&(cj.style.cssText=ci[j].style.cssText);}}}else{if(isFullCol){cellInfo=ut.getCellInfo(td);var maxColNum=0;for(var j=0,ci=tableCopyList[0],cj;cj=ci[j++];){maxColNum+=cj.colSpan||1;}me.__hasEnterExecCommand=true;for(i=0;i<maxColNum;i++){me.execCommand('insertcol');}me.__hasEnterExecCommand=false;td=ut.table.rows[0].cells[cellInfo.cellIndex];if(td.tagName=='TH'){td=ut.table.rows[1].cells[cellInfo.cellIndex];}}for(var i=0,ci;ci=tableCopyList[i++];){tmpNode=td;for(var j=0,cj;cj=ci[j++];){if(td){td.innerHTML=cj.innerHTML;cj.getAttribute('width')&&td.setAttribute('width',cj.getAttribute('width'));cj.getAttribute('vAlign')&&td.setAttribute('vAlign',cj.getAttribute('vAlign'));cj.getAttribute('align')&&td.setAttribute('align',cj.getAttribute('align'));cj.style.cssText&&(td.style.cssText=cj.style.cssText);preNode=td;td=td.nextSibling;}else{var cloneTd=cj.cloneNode(true);domUtils.removeAttributes(cloneTd,['class','rowSpan','colSpan']);preNode.parentNode.appendChild(cloneTd);}}td=ut.getNextCell(tmpNode,true,true);if(!tableCopyList[i])break;if(!td){var cellInfo=ut.getCellInfo(tmpNode);ut.table.insertRow(ut.table.rows.length);ut.update();td=ut.getVSideCell(tmpNode,true);}}}ut.update();}else{table=me.document.createElement('table');for(var i=0,ci;ci=tableCopyList[i++];){var tr=table.insertRow(table.rows.length);for(var j=0,cj;cj=ci[j++];){cloneTd=UT.cloneCell(cj,null,true);domUtils.removeAttributes(cloneTd,['class']);tr.appendChild(cloneTd);}if(j==2&&cloneTd.rowSpan>1){cloneTd.rowSpan=1;}}var defaultValue=getDefaultValue(me),width=me.body.offsetWidth-(needIEHack?parseInt(domUtils.getComputedStyle(me.body,'margin-left'),10)*2:0)-defaultValue.tableBorder*2-(me.options.offsetWidth||0);me.execCommand('insertHTML','<table  '+(isFullCol&&isFullRow?'width="'+width+'"':'')+'>'+table.innerHTML.replace(/>\s*</g,'><').replace(/\bth\b/gi,"td")+'</table>');}me.fireEvent('contentchange');me.fireEvent('saveScene');html.html='';return true;}else{var div=me.document.createElement("div"),tables;div.innerHTML=html.html;tables=div.getElementsByTagName("table");if(domUtils.findParentByTagName(me.selection.getStart(),'table')){utils.each(tables,function(t){domUtils.remove(t);});if(domUtils.findParentByTagName(me.selection.getStart(),'caption',true)){div.innerHTML=div[browser.ie?'innerText':'textContent'];}}else{utils.each(tables,function(table){removeStyleSize(table,true);domUtils.removeAttributes(table,['style','border']);utils.each(domUtils.getElementsByTagName(table,"td"),function(td){if(isEmptyBlock(td)){domUtils.fillNode(me.document,td);}removeStyleSize(td,true);});});}html.html=div.innerHTML;}});me.addListener('afterpaste',function(){utils.each(domUtils.getElementsByTagName(me.body,"table"),function(table){if(table.offsetWidth>me.body.offsetWidth){var defaultValue=getDefaultValue(me,table);table.style.width=me.body.offsetWidth-(needIEHack?parseInt(domUtils.getComputedStyle(me.body,'margin-left'),10)*2:0)-defaultValue.tableBorder*2-(me.options.offsetWidth||0)+'px';}});});me.addListener('blur',function(){tableCopyList=null;});var timer;me.addListener('keydown',function(){clearTimeout(timer);timer=setTimeout(function(){var rng=me.selection.getRange(),cell=domUtils.findParentByTagName(rng.startContainer,['th','td'],true);if(cell){var table=cell.parentNode.parentNode.parentNode;if(table.offsetWidth>table.getAttribute("width")){cell.style.wordBreak="break-all";}}},100);});me.addListener("selectionchange",function(){toggleDraggableState(me,false,"",null);});me.addListener("contentchange",function(){var me=this;hideDragLine(me);if(getUETableBySelected(me))return;var rng=me.selection.getRange();var start=rng.startContainer;start=domUtils.findParentByTagName(start,['td','th'],true);utils.each(domUtils.getElementsByTagName(me.document,'table'),function(table){if(me.fireEvent("excludetable",table)===true)return;table.ueTable=new UT(table);table.onmouseover=function(){me.fireEvent('tablemouseover',table);};table.onmousemove=function(){me.fireEvent('tablemousemove',table);me.options.tableDragable&&toggleDragButton(true,this,me);utils.defer(function(){me.fireEvent('contentchange',50);},true);};table.onmouseout=function(){me.fireEvent('tablemouseout',table);toggleDraggableState(me,false,"",null);hideDragLine(me);};table.onclick=function(evt){evt=me.window.event||evt;var target=getParentTdOrTh(evt.target||evt.srcElement);if(!target)return;var ut=getUETable(target),table=ut.table,cellInfo=ut.getCellInfo(target),cellsRange,rng=me.selection.getRange();if(inTableSide(table,target,evt,true)){var endTdCol=ut.getCell(ut.indexTable[ut.rowsNum-1][cellInfo.colIndex].rowIndex,ut.indexTable[ut.rowsNum-1][cellInfo.colIndex].cellIndex);if(evt.shiftKey&&ut.selectedTds.length){if(ut.selectedTds[0]!==endTdCol){cellsRange=ut.getCellsRange(ut.selectedTds[0],endTdCol);ut.setSelected(cellsRange);}else{rng&&rng.selectNodeContents(endTdCol).select();}}else{if(target!==endTdCol){cellsRange=ut.getCellsRange(target,endTdCol);ut.setSelected(cellsRange);}else{rng&&rng.selectNodeContents(endTdCol).select();}}return;}if(inTableSide(table,target,evt)){var endTdRow=ut.getCell(ut.indexTable[cellInfo.rowIndex][ut.colsNum-1].rowIndex,ut.indexTable[cellInfo.rowIndex][ut.colsNum-1].cellIndex);if(evt.shiftKey&&ut.selectedTds.length){if(ut.selectedTds[0]!==endTdRow){cellsRange=ut.getCellsRange(ut.selectedTds[0],endTdRow);ut.setSelected(cellsRange);}else{rng&&rng.selectNodeContents(endTdRow).select();}}else{if(target!==endTdRow){cellsRange=ut.getCellsRange(target,endTdRow);ut.setSelected(cellsRange);}else{rng&&rng.selectNodeContents(endTdRow).select();}}}};});switchBorderColor(me,true);});domUtils.on(me.document,"mousemove",mouseMoveEvent);domUtils.on(me.document,"mouseout",function(evt){var target=evt.target||evt.srcElement;if(target.tagName=="TABLE"){toggleDraggableState(me,false,"",null);}});me.addListener("interlacetable",function(type,table,classList){if(!table)return;var me=this,rows=table.rows,len=rows.length,getClass=function getClass(list,index,repeat){return list[index]?list[index]:repeat?list[index%list.length]:"";};for(var i=0;i<len;i++){rows[i].className=getClass(classList||me.options.classList,i,true);}});me.addListener("uninterlacetable",function(type,table){if(!table)return;var me=this,rows=table.rows,classList=me.options.classList,len=rows.length;for(var i=0;i<len;i++){domUtils.removeClasses(rows[i],classList);}});me.addListener("mousedown",mouseDownEvent);me.addListener("mouseup",mouseUpEvent);domUtils.on(me.body,'dragstart',function(evt){mouseUpEvent.call(me,'dragstart',evt);});me.addOutputRule(function(root){utils.each(root.getNodesByTagName('div'),function(n){if(n.getAttr('id')=='ue_tableDragLine'){n.parentNode.removeChild(n);}});});var currentRowIndex=0;me.addListener("mousedown",function(){currentRowIndex=0;});me.addListener('tabkeydown',function(){var range=this.selection.getRange(),common=range.getCommonAncestor(true,true),table=domUtils.findParentByTagName(common,'table');if(table){if(domUtils.findParentByTagName(common,'caption',true)){var cell=domUtils.getElementsByTagName(table,'th td');if(cell&&cell.length){range.setStart(cell[0],0).setCursor(false,true);}}else{var cell=domUtils.findParentByTagName(common,['td','th'],true),ua=getUETable(cell);currentRowIndex=cell.rowSpan>1?currentRowIndex:ua.getCellInfo(cell).rowIndex;var nextCell=ua.getTabNextCell(cell,currentRowIndex);if(nextCell){if(isEmptyBlock(nextCell)){range.setStart(nextCell,0).setCursor(false,true);}else{range.selectNodeContents(nextCell).select();}}else{me.fireEvent('saveScene');me.__hasEnterExecCommand=true;this.execCommand('insertrownext');me.__hasEnterExecCommand=false;range=this.selection.getRange();range.setStart(table.rows[table.rows.length-1].cells[0],0).setCursor();me.fireEvent('saveScene');}}return true;}});browser.ie&&me.addListener('selectionchange',function(){toggleDraggableState(this,false,"",null);});me.addListener("keydown",function(type,evt){var me=this;var keyCode=evt.keyCode||evt.which;if(keyCode==8||keyCode==46){return;}var notCtrlKey=!evt.ctrlKey&&!evt.metaKey&&!evt.shiftKey&&!evt.altKey;notCtrlKey&&removeSelectedClass(domUtils.getElementsByTagName(me.body,"td"));var ut=getUETableBySelected(me);if(!ut)return;notCtrlKey&&ut.clearSelected();});me.addListener("beforegetcontent",function(){switchBorderColor(this,false);browser.ie&&utils.each(this.document.getElementsByTagName('caption'),function(ci){if(domUtils.isEmptyNode(ci)){ci.innerHTML='&nbsp;';}});});me.addListener("aftergetcontent",function(){switchBorderColor(this,true);});me.addListener("getAllHtml",function(){removeSelectedClass(me.document.getElementsByTagName("td"));});me.addListener("fullscreenchanged",function(type,fullscreen){if(!fullscreen){var ratio=this.body.offsetWidth/document.body.offsetWidth,tables=domUtils.getElementsByTagName(this.body,"table");utils.each(tables,function(table){if(table.offsetWidth<me.body.offsetWidth)return false;var tds=domUtils.getElementsByTagName(table,"td"),backWidths=[];utils.each(tds,function(td){backWidths.push(td.offsetWidth);});for(var i=0,td;td=tds[i];i++){td.setAttribute("width",Math.floor(backWidths[i]*ratio));}table.setAttribute("width",Math.floor(getTableWidth(me,needIEHack,getDefaultValue(me))));});}});var oldExecCommand=me.execCommand;me.execCommand=function(cmd,datatat){var me=this,args=arguments;cmd=cmd.toLowerCase();var ut=getUETableBySelected(me),tds,range=new dom.Range(me.document),cmdFun=me.commands[cmd]||UE.commands[cmd],result;if(!cmdFun)return;if(ut&&!commands[cmd]&&!cmdFun.notNeedUndo&&!me.__hasEnterExecCommand){me.__hasEnterExecCommand=true;me.fireEvent("beforeexeccommand",cmd);tds=ut.selectedTds;var lastState=-2,lastValue=-2,value,state;for(var i=0,td;td=tds[i];i++){if(isEmptyBlock(td)){range.setStart(td,0).setCursor(false,true);}else{range.selectNode(td).select(true);}state=me.queryCommandState(cmd);value=me.queryCommandValue(cmd);if(state!=-1){if(lastState!==state||lastValue!==value){me._ignoreContentChange=true;result=oldExecCommand.apply(me,arguments);me._ignoreContentChange=false;}lastState=me.queryCommandState(cmd);lastValue=me.queryCommandValue(cmd);if(domUtils.isEmptyBlock(td)){domUtils.fillNode(me.document,td);}}}range.setStart(tds[0],0).shrinkBoundary(true).setCursor(false,true);me.fireEvent('contentchange');me.fireEvent("afterexeccommand",cmd);me.__hasEnterExecCommand=false;me._selectionChange();}else{result=oldExecCommand.apply(me,arguments);}return result;};});function removeStyleSize(obj,replaceToProperty){removeStyle(obj,"width",true);removeStyle(obj,"height",true);}function removeStyle(obj,styleName,replaceToProperty){if(obj.style[styleName]){replaceToProperty&&obj.setAttribute(styleName,parseInt(obj.style[styleName],10));obj.style[styleName]="";}}function getParentTdOrTh(ele){if(ele.tagName=="TD"||ele.tagName=="TH")return ele;var td;if(td=domUtils.findParentByTagName(ele,"td",true)||domUtils.findParentByTagName(ele,"th",true))return td;return null;}function isEmptyBlock(node){var reg=new RegExp(domUtils.fillChar,'g');if(node[browser.ie?'innerText':'textContent'].replace(/^\s*$/,'').replace(reg,'').length>0){return 0;}for(var n in dtd.$isNotEmpty){if(node.getElementsByTagName(n).length){return 0;}}return 1;}function mouseCoords(evt){if(evt.pageX||evt.pageY){return{x:evt.pageX,y:evt.pageY};}return{x:evt.clientX+me.document.body.scrollLeft-me.document.body.clientLeft,y:evt.clientY+me.document.body.scrollTop-me.document.body.clientTop};}function mouseMoveEvent(evt){if(isEditorDisabled()){return;}try{var target=getParentTdOrTh(evt.target||evt.srcElement),pos;if(isInResizeBuffer){me.body.style.webkitUserSelect='none';if(Math.abs(userActionStatus.x-evt.clientX)>offsetOfTableCell||Math.abs(userActionStatus.y-evt.clientY)>offsetOfTableCell){clearTableDragTimer();isInResizeBuffer=false;singleClickState=0;tableBorderDrag(evt);}}
if(onDrag&&dragTd){singleClickState=0;me.body.style.webkitUserSelect='none';me.selection.getNative()[browser.ie9below?'empty':'removeAllRanges']();pos=mouseCoords(evt);toggleDraggableState(me,true,onDrag,pos,target);if(onDrag=="h"){dragLine.style.left=getPermissionX(dragTd,evt)+"px";}else if(onDrag=="v"){dragLine.style.top=getPermissionY(dragTd,evt)+"px";}return;}
if(target){if(me.fireEvent('excludetable',target)===true)return;pos=mouseCoords(evt);var state=getRelation(target,pos),table=domUtils.findParentByTagName(target,"table",true);if(inTableSide(table,target,evt,true)){if(me.fireEvent("excludetable",table)===true)return;me.body.style.cursor="url("+me.options.cursorpath+"h.png),pointer";}else if(inTableSide(table,target,evt)){if(me.fireEvent("excludetable",table)===true)return;me.body.style.cursor="url("+me.options.cursorpath+"v.png),pointer";}else{me.body.style.cursor="text";var curCell=target;if(/\d/.test(state)){state=state.replace(/\d/,'');target=getUETable(target).getPreviewCell(target,state=="v");}
toggleDraggableState(me,target?!!state:false,target?state:'',pos,target);}}else{toggleDragButton(false,table,me);}}catch(e){showError(e);}}var dragButtonTimer;function toggleDragButton(show,table,editor){if(!show){if(dragOver)return;dragButtonTimer=setTimeout(function(){!dragOver&&dragButton&&dragButton.parentNode&&dragButton.parentNode.removeChild(dragButton);},2000);}else{createDragButton(table,editor);}}function createDragButton(table,editor){var pos=domUtils.getXY(table),doc=table.ownerDocument;if(dragButton&&dragButton.parentNode)return dragButton;dragButton=doc.createElement("div");dragButton.contentEditable=false;dragButton.innerHTML="";dragButton.style.cssText="width:15px;height:15px;background-image:url("+editor.options.UEDITOR_HOME_URL+"dialogs/table/dragicon.png);position: absolute;cursor:move;top:"+(pos.y-15)+"px;left:"+pos.x+"px;";domUtils.unSelectable(dragButton);dragButton.onmouseover=function(evt){dragOver=true;};dragButton.onmouseout=function(evt){dragOver=false;};domUtils.on(dragButton,'click',function(type,evt){doClick(evt,this);});domUtils.on(dragButton,'dblclick',function(type,evt){doDblClick(evt);});domUtils.on(dragButton,'dragstart',function(type,evt){domUtils.preventDefault(evt);});var timer;function doClick(evt,button){clearTimeout(timer);timer=setTimeout(function(){editor.fireEvent("tableClicked",table,button);},300);}function doDblClick(evt){clearTimeout(timer);var ut=getUETable(table),start=table.rows[0].cells[0],end=ut.getLastCell(),range=ut.getCellsRange(start,end);editor.selection.getRange().setStart(start,0).setCursor(false,true);ut.setSelected(range);}doc.body.appendChild(dragButton);}
function inTableSide(table,cell,evt,top){var pos=mouseCoords(evt),state=getRelation(cell,pos);if(top){var caption=table.getElementsByTagName("caption")[0],capHeight=caption?caption.offsetHeight:0;return state=="v1"&&pos.y-domUtils.getXY(table).y-capHeight<8;}else{return state=="h1"&&pos.x-domUtils.getXY(table).x<8;}}function getPermissionX(dragTd,evt){var ut=getUETable(dragTd);if(ut){var preTd=ut.getSameEndPosCells(dragTd,"x")[0],nextTd=ut.getSameStartPosXCells(dragTd)[0],mouseX=mouseCoords(evt).x,left=(preTd?domUtils.getXY(preTd).x:domUtils.getXY(ut.table).x)+20,right=nextTd?domUtils.getXY(nextTd).x+nextTd.offsetWidth-20:me.body.offsetWidth+5||parseInt(domUtils.getComputedStyle(me.body,"width"),10);left+=cellMinWidth;right-=cellMinWidth;return mouseX<left?left:mouseX>right?right:mouseX;}}function getPermissionY(dragTd,evt){try{var top=domUtils.getXY(dragTd).y,mousePosY=mouseCoords(evt).y;return mousePosY<top?top:mousePosY;}catch(e){showError(e);}}function toggleDraggableState(editor,draggable,dir,mousePos,cell){try{editor.body.style.cursor=dir=="h"?"col-resize":dir=="v"?"row-resize":"text";if(browser.ie){if(dir&&!mousedown&&!getUETableBySelected(editor)){getDragLine(editor,editor.document);showDragLineAt(dir,cell);}else{hideDragLine(editor);}}onBorder=draggable;}catch(e){showError(e);}}function getResizeLineByUETable(){var lineId='_UETableResizeLine',line=this.document.getElementById(lineId);if(!line){line=this.document.createElement("div");line.id=lineId;line.contnetEditable=false;line.setAttribute("unselectable","on");var styles={width:2*cellBorderWidth+1+'px',position:'absolute','z-index':100000,cursor:'col-resize',background:'red',display:'none'};line.onmouseout=function(){this.style.display='none';};utils.extend(line.style,styles);this.document.body.appendChild(line);}return line;}function updateResizeLine(cell,uetable){var line=getResizeLineByUETable.call(this),table=uetable.table,styles={top:domUtils.getXY(table).y+'px',left:domUtils.getXY(cell).x+cell.offsetWidth-cellBorderWidth+'px',display:'block',height:table.offsetHeight+'px'};utils.extend(line.style,styles);}function showResizeLine(cell){var uetable=getUETable(cell);updateResizeLine.call(this,cell,uetable);}function getRelation(ele,mousePos){var elePos=domUtils.getXY(ele);if(!elePos){return'';}if(elePos.x+ele.offsetWidth-mousePos.x<cellBorderWidth){return"h";}if(mousePos.x-elePos.x<cellBorderWidth){return'h1';}if(elePos.y+ele.offsetHeight-mousePos.y<cellBorderWidth){return"v";}if(mousePos.y-elePos.y<cellBorderWidth){return'v1';}return'';}function mouseDownEvent(type,evt){if(isEditorDisabled()){return;}userActionStatus={x:evt.clientX,y:evt.clientY};if(evt.button==2){var ut=getUETableBySelected(me),flag=false;if(ut){var td=getTargetTd(me,evt);utils.each(ut.selectedTds,function(ti){if(ti===td){flag=true;}});if(!flag){removeSelectedClass(domUtils.getElementsByTagName(me.body,"th td"));ut.clearSelected();}else{td=ut.selectedTds[0];setTimeout(function(){me.selection.getRange().setStart(td,0).setCursor(false,true);},0);}}}else{tableClickHander(evt);}}
function clearTableTimer(){tabTimer&&clearTimeout(tabTimer);tabTimer=null;}
function tableDbclickHandler(evt){singleClickState=0;evt=evt||me.window.event;var target=getParentTdOrTh(evt.target||evt.srcElement);if(target){var h;if(h=getRelation(target,mouseCoords(evt))){hideDragLine(me);if(h=='h1'){h='h';if(inTableSide(domUtils.findParentByTagName(target,"table"),target,evt)){me.execCommand('adaptbywindow');}else{target=getUETable(target).getPreviewCell(target);if(target){var rng=me.selection.getRange();rng.selectNodeContents(target).setCursor(true,true);}}}if(h=='h'){var ut=getUETable(target),table=ut.table,cells=getCellsByMoveBorder(target,table,true);cells=extractArray(cells,'left');ut.width=ut.offsetWidth;var oldWidth=[],newWidth=[];utils.each(cells,function(cell){oldWidth.push(cell.offsetWidth);});utils.each(cells,function(cell){cell.removeAttribute("width");});window.setTimeout(function(){var changeable=true;utils.each(cells,function(cell,index){var width=cell.offsetWidth;if(width>oldWidth[index]){changeable=false;return false;}newWidth.push(width);});var change=changeable?newWidth:oldWidth;utils.each(cells,function(cell,index){cell.width=change[index]-getTabcellSpace();});},0);}}}}function tableClickHander(evt){removeSelectedClass(domUtils.getElementsByTagName(me.body,"td th"));utils.each(me.document.getElementsByTagName('table'),function(t){t.ueTable=null;});startTd=getTargetTd(me,evt);if(!startTd)return;var table=domUtils.findParentByTagName(startTd,"table",true);ut=getUETable(table);ut&&ut.clearSelected();if(!onBorder){me.document.body.style.webkitUserSelect='';mousedown=true;me.addListener('mouseover',mouseOverEvent);}else{borderActionHandler(evt);}}
function borderActionHandler(evt){if(browser.ie){evt=reconstruct(evt);}clearTableDragTimer();isInResizeBuffer=true;tableDragTimer=setTimeout(function(){tableBorderDrag(evt);},dblclickTime);}function extractArray(originArr,key){var result=[],tmp=null;for(var i=0,len=originArr.length;i<len;i++){tmp=originArr[i][key];if(tmp){result.push(tmp);}}return result;}function clearTableDragTimer(){tableDragTimer&&clearTimeout(tableDragTimer);tableDragTimer=null;}function reconstruct(obj){var attrs=['pageX','pageY','clientX','clientY','srcElement','target'],newObj={};if(obj){for(var i=0,key,val;key=attrs[i];i++){val=obj[key];val&&(newObj[key]=val);}}return newObj;}
function tableBorderDrag(evt){isInResizeBuffer=false;startTd=evt.target||evt.srcElement;if(!startTd)return;var state=getRelation(startTd,mouseCoords(evt));if(/\d/.test(state)){state=state.replace(/\d/,'');startTd=getUETable(startTd).getPreviewCell(startTd,state=='v');}hideDragLine(me);getDragLine(me,me.document);me.fireEvent('saveScene');showDragLineAt(state,startTd);mousedown=true;onDrag=state;dragTd=startTd;}function mouseUpEvent(type,evt){if(isEditorDisabled()){return;}clearTableDragTimer();isInResizeBuffer=false;if(onBorder){singleClickState=++singleClickState%3;userActionStatus={x:evt.clientX,y:evt.clientY};tableResizeTimer=setTimeout(function(){singleClickState>0&&singleClickState--;},dblclickTime);if(singleClickState===2){singleClickState=0;tableDbclickHandler(evt);return;}}if(evt.button==2)return;var me=this;var range=me.selection.getRange(),start=domUtils.findParentByTagName(range.startContainer,'table',true),end=domUtils.findParentByTagName(range.endContainer,'table',true);if(start||end){if(start===end){start=domUtils.findParentByTagName(range.startContainer,['td','th','caption'],true);end=domUtils.findParentByTagName(range.endContainer,['td','th','caption'],true);if(start!==end){me.selection.clearRange();}}else{me.selection.clearRange();}}mousedown=false;me.document.body.style.webkitUserSelect='';if(onDrag&&dragTd){me.selection.getNative()[browser.ie9below?'empty':'removeAllRanges']();singleClickState=0;dragLine=me.document.getElementById('ue_tableDragLine');if(dragLine){var dragTdPos=domUtils.getXY(dragTd),dragLinePos=domUtils.getXY(dragLine);switch(onDrag){case"h":changeColWidth(dragTd,dragLinePos.x-dragTdPos.x);break;case"v":changeRowHeight(dragTd,dragLinePos.y-dragTdPos.y-dragTd.offsetHeight);break;default:}onDrag="";dragTd=null;hideDragLine(me);me.fireEvent('saveScene');return;}}
if(!startTd){var target=domUtils.findParentByTagName(evt.target||evt.srcElement,"td",true);if(!target)target=domUtils.findParentByTagName(evt.target||evt.srcElement,"th",true);if(target&&(target.tagName=="TD"||target.tagName=="TH")){if(me.fireEvent("excludetable",target)===true)return;range=new dom.Range(me.document);range.setStart(target,0).setCursor(false,true);}}else{var ut=getUETable(startTd),cell=ut?ut.selectedTds[0]:null;if(cell){range=new dom.Range(me.document);if(domUtils.isEmptyBlock(cell)){range.setStart(cell,0).setCursor(false,true);}else{range.selectNodeContents(cell).shrinkBoundary().setCursor(false,true);}}else{range=me.selection.getRange().shrinkBoundary();if(!range.collapsed){var start=domUtils.findParentByTagName(range.startContainer,['td','th'],true),end=domUtils.findParentByTagName(range.endContainer,['td','th'],true);if(start&&!end||!start&&end||start&&end&&start!==end){range.setCursor(false,true);}}}startTd=null;me.removeListener('mouseover',mouseOverEvent);}me._selectionChange(250,evt);}function mouseOverEvent(type,evt){if(isEditorDisabled()){return;}var me=this,tar=evt.target||evt.srcElement;currentTd=domUtils.findParentByTagName(tar,"td",true)||domUtils.findParentByTagName(tar,"th",true);if(startTd&&currentTd&&(startTd.tagName=="TD"&&currentTd.tagName=="TD"||startTd.tagName=="TH"&&currentTd.tagName=="TH")&&domUtils.findParentByTagName(startTd,'table')==domUtils.findParentByTagName(currentTd,'table')){var ut=getUETable(currentTd);if(startTd!=currentTd){me.document.body.style.webkitUserSelect='none';me.selection.getNative()[browser.ie9below?'empty':'removeAllRanges']();var range=ut.getCellsRange(startTd,currentTd);ut.setSelected(range);}else{me.document.body.style.webkitUserSelect='';ut.clearSelected();}}evt.preventDefault?evt.preventDefault():evt.returnValue=false;}function setCellHeight(cell,height,backHeight){var lineHight=parseInt(domUtils.getComputedStyle(cell,"line-height"),10),tmpHeight=backHeight+height;height=tmpHeight<lineHight?lineHight:tmpHeight;if(cell.style.height)cell.style.height="";cell.rowSpan==1?cell.setAttribute("height",height):cell.removeAttribute&&cell.removeAttribute("height");}function getWidth(cell){if(!cell)return 0;return parseInt(domUtils.getComputedStyle(cell,"width"),10);}function changeColWidth(cell,changeValue){var ut=getUETable(cell);if(ut){var table=ut.table,cells=getCellsByMoveBorder(cell,table);table.style.width="";table.removeAttribute("width");changeValue=correctChangeValue(changeValue,cell,cells);if(cell.nextSibling){var i=0;utils.each(cells,function(cellGroup){cellGroup.left.width=+cellGroup.left.width+changeValue;cellGroup.right&&(cellGroup.right.width=+cellGroup.right.width-changeValue);});}else{utils.each(cells,function(cellGroup){cellGroup.left.width-=-changeValue;});}}}function isEditorDisabled(){return me.body.contentEditable==="false";}function changeRowHeight(td,changeValue){if(Math.abs(changeValue)<10)return;var ut=getUETable(td);if(ut){var cells=ut.getSameEndPosCells(td,"y"),backHeight=cells[0]?cells[0].offsetHeight:0;for(var i=0,cell;cell=cells[i++];){setCellHeight(cell,changeValue,backHeight);}}}function getCellsByMoveBorder(cell,table,isContainMergeCell){if(!table){table=domUtils.findParentByTagName(cell,'table');}if(!table){return null;}
var index=domUtils.getNodeIndex(cell),temp=cell,rows=table.rows,colIndex=0;while(temp){if(temp.nodeType===1){colIndex+=temp.colSpan||1;}temp=temp.previousSibling;}temp=null;var borderCells=[];utils.each(rows,function(tabRow){var cells=tabRow.cells,currIndex=0;utils.each(cells,function(tabCell){currIndex+=tabCell.colSpan||1;if(currIndex===colIndex){borderCells.push({left:tabCell,right:tabCell.nextSibling||null});return false;}else if(currIndex>colIndex){if(isContainMergeCell){borderCells.push({left:tabCell});}return false;}});});return borderCells;}function getMinWidthByTableCells(cells){var minWidth=Number.MAX_VALUE;for(var i=0,curCell;curCell=cells[i];i++){minWidth=Math.min(minWidth,curCell.width||getTableCellWidth(curCell));}return minWidth;}function correctChangeValue(changeValue,relatedCell,cells){changeValue-=getTabcellSpace();if(changeValue<0){return 0;}changeValue-=getTableCellWidth(relatedCell);var direction=changeValue<0?'left':'right';changeValue=Math.abs(changeValue);utils.each(cells,function(cellGroup){var curCell=cellGroup[direction];if(curCell){changeValue=Math.min(changeValue,getTableCellWidth(curCell)-cellMinWidth);}});changeValue=changeValue<0?0:changeValue;return direction==='left'?-changeValue:changeValue;}function getTableCellWidth(cell){var width=0,offset=0,width=cell.offsetWidth-getTabcellSpace();if(!cell.nextSibling){width-=getTableCellOffset(cell);}width=width<0?0:width;try{cell.width=width;}catch(e){}return width;}function getTableCellOffset(cell){tab=domUtils.findParentByTagName(cell,"table",false);if(tab.offsetVal===undefined){var prev=cell.previousSibling;if(prev){tab.offsetVal=cell.offsetWidth-prev.offsetWidth===UT.borderWidth?UT.borderWidth:0;}else{tab.offsetVal=0;}}return tab.offsetVal;}function getTabcellSpace(){if(UT.tabcellSpace===undefined){var cell=null,tab=me.document.createElement("table"),tbody=me.document.createElement("tbody"),trow=me.document.createElement("tr"),tabcell=me.document.createElement("td"),mirror=null;tabcell.style.cssText='border: 0;';tabcell.width=1;trow.appendChild(tabcell);trow.appendChild(mirror=tabcell.cloneNode(false));tbody.appendChild(trow);tab.appendChild(tbody);tab.style.cssText="visibility: hidden;";me.body.appendChild(tab);UT.paddingSpace=tabcell.offsetWidth-1;var tmpTabWidth=tab.offsetWidth;tabcell.style.cssText='';mirror.style.cssText='';UT.borderWidth=(tab.offsetWidth-tmpTabWidth)/3;UT.tabcellSpace=UT.paddingSpace+UT.borderWidth;me.body.removeChild(tab);}getTabcellSpace=function getTabcellSpace(){return UT.tabcellSpace;};return UT.tabcellSpace;}function getDragLine(editor,doc){if(mousedown)return;dragLine=editor.document.createElement("div");domUtils.setAttributes(dragLine,{id:"ue_tableDragLine",unselectable:'on',contenteditable:false,'onresizestart':'return false','ondragstart':'return false','onselectstart':'return false',style:"background-color:blue;position:absolute;padding:0;margin:0;background-image:none;border:0px none;opacity:0;filter:alpha(opacity=0)"});editor.body.appendChild(dragLine);}function hideDragLine(editor){if(mousedown)return;var line;while(line=editor.document.getElementById('ue_tableDragLine')){domUtils.remove(line);}}function showDragLineAt(state,cell){if(!cell)return;var table=domUtils.findParentByTagName(cell,"table"),caption=table.getElementsByTagName('caption'),width=table.offsetWidth,height=table.offsetHeight-(caption.length>0?caption[0].offsetHeight:0),tablePos=domUtils.getXY(table),cellPos=domUtils.getXY(cell),css;switch(state){case"h":css='height:'+height+'px;top:'+(tablePos.y+(caption.length>0?caption[0].offsetHeight:0))+'px;left:'+(cellPos.x+cell.offsetWidth);dragLine.style.cssText=css+'px;position: absolute;display:block;background-color:blue;width:1px;border:0; color:blue;opacity:.3;filter:alpha(opacity=30)';break;case"v":css='width:'+width+'px;left:'+tablePos.x+'px;top:'+(cellPos.y+cell.offsetHeight);dragLine.style.cssText=css+'px;overflow:hidden;position: absolute;display:block;background-color:blue;height:1px;border:0;color:blue;opacity:.2;filter:alpha(opacity=20)';break;default:}}function switchBorderColor(editor,flag){var tableArr=domUtils.getElementsByTagName(editor.body,"table"),color;for(var i=0,node;node=tableArr[i++];){var td=domUtils.getElementsByTagName(node,"td");if(td[0]){if(flag){color=td[0].style.borderColor.replace(/\s/g,"");if(/(#ffffff)|(rgb\(255,255,255\))/ig.test(color))domUtils.addClass(node,"noBorderTable");}else{domUtils.removeClasses(node,"noBorderTable");}}}}function getTableWidth(editor,needIEHack,defaultValue){var body=editor.body;return body.offsetWidth-(needIEHack?parseInt(domUtils.getComputedStyle(body,'margin-left'),10)*2:0)-defaultValue.tableBorder*2-(editor.options.offsetWidth||0);}function getTargetTd(editor,evt){var target=domUtils.findParentByTagName(evt.target||evt.srcElement,["td","th"],true),dir=null;if(!target){return null;}dir=getRelation(target,mouseCoords(evt));if(!target){return null;}if(dir==='h1'&&target.previousSibling){var position=domUtils.getXY(target),cellWidth=target.offsetWidth;if(Math.abs(position.x+cellWidth-evt.clientX)>cellWidth/3){target=target.previousSibling;}}else if(dir==='v1'&&target.parentNode.previousSibling){var position=domUtils.getXY(target),cellHeight=target.offsetHeight;if(Math.abs(position.y+cellHeight-evt.clientY)>cellHeight/3){target=target.parentNode.previousSibling.firstChild;}}
return target&&!(editor.fireEvent("excludetable",target)===true)?target:null;}};UE.UETable.prototype.sortTable=function(sortByCellIndex,compareFn){var table=this.table,rows=table.rows,trArray=[],flag=rows[0].cells[0].tagName==="TH",lastRowIndex=0;if(this.selectedTds.length){var range=this.cellsRange,len=range.endRowIndex+1;for(var i=range.beginRowIndex;i<len;i++){trArray[i]=rows[i];}trArray.splice(0,range.beginRowIndex);lastRowIndex=range.endRowIndex+1===this.rowsNum?0:range.endRowIndex+1;}else{for(var i=0,len=rows.length;i<len;i++){trArray[i]=rows[i];}}var Fn={'reversecurrent':function reversecurrent(td1,td2){return 1;},'orderbyasc':function orderbyasc(td1,td2){var value1=td1.innerText||td1.textContent,value2=td2.innerText||td2.textContent;return value1.localeCompare(value2);},'reversebyasc':function reversebyasc(td1,td2){var value1=td1.innerHTML,value2=td2.innerHTML;return value2.localeCompare(value1);},'orderbynum':function orderbynum(td1,td2){var value1=td1[browser.ie?'innerText':'textContent'].match(/\d+/),value2=td2[browser.ie?'innerText':'textContent'].match(/\d+/);if(value1)value1=+value1[0];if(value2)value2=+value2[0];return(value1||0)-(value2||0);},'reversebynum':function reversebynum(td1,td2){var value1=td1[browser.ie?'innerText':'textContent'].match(/\d+/),value2=td2[browser.ie?'innerText':'textContent'].match(/\d+/);if(value1)value1=+value1[0];if(value2)value2=+value2[0];return(value2||0)-(value1||0);}};table.setAttribute('data-sort-type',compareFn&&typeof compareFn==="string"&&Fn[compareFn]?compareFn:'');flag&&trArray.splice(0,1);trArray=utils.sort(trArray,function(tr1,tr2){var result;if(compareFn&&typeof compareFn==="function"){result=compareFn.call(this,tr1.cells[sortByCellIndex],tr2.cells[sortByCellIndex]);}else if(compareFn&&typeof compareFn==="number"){result=1;}else if(compareFn&&typeof compareFn==="string"&&Fn[compareFn]){result=Fn[compareFn].call(this,tr1.cells[sortByCellIndex],tr2.cells[sortByCellIndex]);}else{result=Fn['orderbyasc'].call(this,tr1.cells[sortByCellIndex],tr2.cells[sortByCellIndex]);}return result;});var fragment=table.ownerDocument.createDocumentFragment();for(var j=0,len=trArray.length;j<len;j++){fragment.appendChild(trArray[j]);}var tbody=table.getElementsByTagName("tbody")[0];if(!lastRowIndex){tbody.appendChild(fragment);}else{tbody.insertBefore(fragment,rows[lastRowIndex-range.endRowIndex+range.beginRowIndex-1]);}};UE.plugins['tablesort']=function(){var me=this,UT=UE.UETable,getUETable=function getUETable(tdOrTable){return UT.getUETable(tdOrTable);},getTableItemsByRange=function getTableItemsByRange(editor){return UT.getTableItemsByRange(editor);};me.ready(function(){utils.cssRule('tablesort','table.sortEnabled tr.firstRow th,table.sortEnabled tr.firstRow td{padding-right:20px;background-repeat: no-repeat;background-position: center right;'+'   background-image:url('+me.options.themePath+me.options.theme+'/images/sortable.png);}',me.document);me.addListener("afterexeccommand",function(type,cmd){if(cmd=='mergeright'||cmd=='mergedown'||cmd=='mergecells'){this.execCommand('disablesort');}});});UE.commands['sorttable']={queryCommandState:function queryCommandState(){var me=this,tableItems=getTableItemsByRange(me);if(!tableItems.cell)return-1;var table=tableItems.table,cells=table.getElementsByTagName("td");for(var i=0,cell;cell=cells[i++];){if(cell.rowSpan!=1||cell.colSpan!=1)return-1;}return 0;},execCommand:function execCommand(cmd,fn){var me=this,range=me.selection.getRange(),bk=range.createBookmark(true),tableItems=getTableItemsByRange(me),cell=tableItems.cell,ut=getUETable(tableItems.table),cellInfo=ut.getCellInfo(cell);ut.sortTable(cellInfo.cellIndex,fn);range.moveToBookmark(bk);try{range.select();}catch(e){}}};UE.commands["enablesort"]=UE.commands["disablesort"]={queryCommandState:function queryCommandState(cmd){var table=getTableItemsByRange(this).table;if(table&&cmd=='enablesort'){var cells=domUtils.getElementsByTagName(table,'th td');for(var i=0;i<cells.length;i++){if(cells[i].getAttribute('colspan')>1||cells[i].getAttribute('rowspan')>1)return-1;}}return!table?-1:cmd=='enablesort'^table.getAttribute('data-sort')!='sortEnabled'?-1:0;},execCommand:function execCommand(cmd){var table=getTableItemsByRange(this).table;table.setAttribute("data-sort",cmd=="enablesort"?"sortEnabled":"sortDisabled");cmd=="enablesort"?domUtils.addClass(table,"sortEnabled"):domUtils.removeClasses(table,"sortEnabled");}};};UE.plugins['contextmenu']=function(){var me=this;me.setOpt('enableContextMenu',true);if(me.getOpt('enableContextMenu')===false){return;}var lang=me.getLang("contextMenu"),menu,items=me.options.contextMenu||[{label:lang['selectall'],cmdName:'selectall'},{label:lang.cleardoc,cmdName:'cleardoc',exec:function exec(){if(confirm(lang.confirmclear)){this.execCommand('cleardoc');}}},'-',{label:lang.unlink,cmdName:'unlink'},'-',{group:lang.paragraph,icon:'justifyjustify',subMenu:[{label:lang.justifyleft,cmdName:'justify',value:'left'},{label:lang.justifyright,cmdName:'justify',value:'right'},{label:lang.justifycenter,cmdName:'justify',value:'center'},{label:lang.justifyjustify,cmdName:'justify',value:'justify'}]},'-',{group:lang.table,icon:'table',subMenu:[{label:lang.inserttable,cmdName:'inserttable'},{label:lang.deletetable,cmdName:'deletetable'},'-',{label:lang.deleterow,cmdName:'deleterow'},{label:lang.deletecol,cmdName:'deletecol'},{label:lang.insertcol,cmdName:'insertcol'},{label:lang.insertcolnext,cmdName:'insertcolnext'},{label:lang.insertrow,cmdName:'insertrow'},{label:lang.insertrownext,cmdName:'insertrownext'},'-',{label:lang.insertcaption,cmdName:'insertcaption'},{label:lang.deletecaption,cmdName:'deletecaption'},{label:lang.inserttitle,cmdName:'inserttitle'},{label:lang.deletetitle,cmdName:'deletetitle'},{label:lang.inserttitlecol,cmdName:'inserttitlecol'},{label:lang.deletetitlecol,cmdName:'deletetitlecol'},'-',{label:lang.mergecells,cmdName:'mergecells'},{label:lang.mergeright,cmdName:'mergeright'},{label:lang.mergedown,cmdName:'mergedown'},'-',{label:lang.splittorows,cmdName:'splittorows'},{label:lang.splittocols,cmdName:'splittocols'},{label:lang.splittocells,cmdName:'splittocells'},'-',{label:lang.averageDiseRow,cmdName:'averagedistributerow'},{label:lang.averageDisCol,cmdName:'averagedistributecol'},'-',{label:lang.edittd,cmdName:'edittd',exec:function exec(){if(UE.ui['edittd']){new UE.ui['edittd'](this);}this.getDialog('edittd').open();}},{label:lang.edittable,cmdName:'edittable',exec:function exec(){if(UE.ui['edittable']){new UE.ui['edittable'](this);}this.getDialog('edittable').open();}},{label:lang.setbordervisible,cmdName:'setbordervisible'}]},{group:lang.tablesort,icon:'tablesort',subMenu:[{label:lang.enablesort,cmdName:'enablesort'},{label:lang.disablesort,cmdName:'disablesort'},'-',{label:lang.reversecurrent,cmdName:'sorttable',value:'reversecurrent'},{label:lang.orderbyasc,cmdName:'sorttable',value:'orderbyasc'},{label:lang.reversebyasc,cmdName:'sorttable',value:'reversebyasc'},{label:lang.orderbynum,cmdName:'sorttable',value:'orderbynum'},{label:lang.reversebynum,cmdName:'sorttable',value:'reversebynum'}]},{group:lang.borderbk,icon:'borderBack',subMenu:[{label:lang.setcolor,cmdName:"interlacetable",exec:function exec(){this.execCommand("interlacetable");}},{label:lang.unsetcolor,cmdName:"uninterlacetable",exec:function exec(){this.execCommand("uninterlacetable");}},{label:lang.setbackground,cmdName:"settablebackground",exec:function exec(){this.execCommand("settablebackground",{repeat:true,colorList:["#bbb","#ccc"]});}},{label:lang.unsetbackground,cmdName:"cleartablebackground",exec:function exec(){this.execCommand("cleartablebackground");}},{label:lang.redandblue,cmdName:"settablebackground",exec:function exec(){this.execCommand("settablebackground",{repeat:true,colorList:["red","blue"]});}},{label:lang.threecolorgradient,cmdName:"settablebackground",exec:function exec(){this.execCommand("settablebackground",{repeat:true,colorList:["#aaa","#bbb","#ccc"]});}}]},{group:lang.aligntd,icon:'aligntd',subMenu:[{cmdName:'cellalignment',value:{align:'left',vAlign:'top'}},{cmdName:'cellalignment',value:{align:'center',vAlign:'top'}},{cmdName:'cellalignment',value:{align:'right',vAlign:'top'}},{cmdName:'cellalignment',value:{align:'left',vAlign:'middle'}},{cmdName:'cellalignment',value:{align:'center',vAlign:'middle'}},{cmdName:'cellalignment',value:{align:'right',vAlign:'middle'}},{cmdName:'cellalignment',value:{align:'left',vAlign:'bottom'}},{cmdName:'cellalignment',value:{align:'center',vAlign:'bottom'}},{cmdName:'cellalignment',value:{align:'right',vAlign:'bottom'}}]},{group:lang.aligntable,icon:'aligntable',subMenu:[{cmdName:'tablealignment',className:'left',label:lang.tableleft,value:"left"},{cmdName:'tablealignment',className:'center',label:lang.tablecenter,value:"center"},{cmdName:'tablealignment',className:'right',label:lang.tableright,value:"right"}]},'-',{label:lang.insertparagraphbefore,cmdName:'insertparagraph',value:true},{label:lang.insertparagraphafter,cmdName:'insertparagraph'},{label:lang['copy'],cmdName:'copy'},{label:lang['paste'],cmdName:'paste'}];if(!items.length){return;}var uiUtils=UE.ui.uiUtils;me.addListener('contextmenu',function(type,evt){var offset=uiUtils.getViewportOffsetByEvent(evt);me.fireEvent('beforeselectionchange');if(menu){menu.destroy();}for(var i=0,ti,contextItems=[];ti=items[i];i++){var last;(function(item){if(item=='-'){if((last=contextItems[contextItems.length-1])&&last!=='-'){contextItems.push('-');}}else if(item.hasOwnProperty("group")){for(var j=0,cj,subMenu=[];cj=item.subMenu[j];j++){(function(subItem){if(subItem=='-'){if((last=subMenu[subMenu.length-1])&&last!=='-'){subMenu.push('-');}else{subMenu.splice(subMenu.length-1);}}else{if((me.commands[subItem.cmdName]||UE.commands[subItem.cmdName]||subItem.query)&&(subItem.query?subItem.query():me.queryCommandState(subItem.cmdName))>-1){subMenu.push({'label':subItem.label||me.getLang("contextMenu."+subItem.cmdName+(subItem.value||''))||"",'className':'edui-for-'+subItem.cmdName+(subItem.className?' edui-for-'+subItem.cmdName+'-'+subItem.className:''),onclick:subItem.exec?function(){subItem.exec.call(me);}:function(){me.execCommand(subItem.cmdName,subItem.value);}});}}})(cj);}if(subMenu.length){var getLabel=function getLabel(){switch(item.icon){case"table":return me.getLang("contextMenu.table");case"justifyjustify":return me.getLang("contextMenu.paragraph");case"aligntd":return me.getLang("contextMenu.aligntd");case"aligntable":return me.getLang("contextMenu.aligntable");case"tablesort":return lang.tablesort;case"borderBack":return lang.borderbk;default:return'';}};contextItems.push({'label':getLabel(),className:'edui-for-'+item.icon,'subMenu':{items:subMenu,editor:me}});}}else{if((me.commands[item.cmdName]||UE.commands[item.cmdName]||item.query)&&(item.query?item.query.call(me):me.queryCommandState(item.cmdName))>-1){contextItems.push({'label':item.label||me.getLang("contextMenu."+item.cmdName),className:'edui-for-'+(item.icon?item.icon:item.cmdName+(item.value||'')),onclick:item.exec?function(){item.exec.call(me);}:function(){me.execCommand(item.cmdName,item.value);}});}}})(ti);}if(contextItems[contextItems.length-1]=='-'){contextItems.pop();}menu=new UE.ui.Menu({items:contextItems,className:"edui-contextmenu",editor:me});menu.render();menu.showAt(offset);me.fireEvent("aftershowcontextmenu",menu);domUtils.preventDefault(evt);if(browser.ie){var ieRange;try{ieRange=me.selection.getNative().createRange();}catch(e){return;}if(ieRange.item){var range=new dom.Range(me.document);range.selectNode(ieRange.item(0)).select(true,true);}}});me.addListener('aftershowcontextmenu',function(type,menu){if(me.zeroclipboard){var items=menu.items;for(var key in items){if(items[key].className=='edui-for-copy'){me.zeroclipboard.clip(items[key].getDom());}}}});};UE.plugins['shortcutmenu']=function(){var me=this,menu,items=me.options.shortcutMenu||[];if(!items.length){return;}me.addListener('contextmenu mouseup',function(type,e){var me=this,customEvt={type:type,target:e.target||e.srcElement,screenX:e.screenX,screenY:e.screenY,clientX:e.clientX,clientY:e.clientY};setTimeout(function(){var rng=me.selection.getRange();if(rng.collapsed===false||type=="contextmenu"){if(!menu){menu=new baidu.editor.ui.ShortCutMenu({editor:me,items:items,theme:me.options.theme,className:'edui-shortcutmenu'});menu.render();me.fireEvent("afterrendershortcutmenu",menu);}menu.show(customEvt,!!UE.plugins['contextmenu']);}});if(type=='contextmenu'){domUtils.preventDefault(e);if(browser.ie9below){var ieRange;try{ieRange=me.selection.getNative().createRange();}catch(e){return;}if(ieRange.item){var range=new dom.Range(me.document);range.selectNode(ieRange.item(0)).select(true,true);}}}});me.addListener('keydown',function(type){if(type=="keydown"){menu&&!menu.isHidden&&menu.hide();}});};UE.plugins['basestyle']=function(){var basestyles={'bold':['strong','b'],'italic':['em','i'],'subscript':['sub'],'superscript':['sup']},getObj=function getObj(editor,tagNames){return domUtils.filterNodeList(editor.selection.getStartElementPath(),tagNames);},me=this;me.addshortcutkey({"Bold":"ctrl+66","Italic":"ctrl+73","Underline":"ctrl+85"});me.addInputRule(function(root){utils.each(root.getNodesByTagName('b i'),function(node){switch(node.tagName){case'b':node.tagName='strong';break;case'i':node.tagName='em';}});});for(var style in basestyles){(function(cmd,tagNames){me.commands[cmd]={execCommand:function execCommand(cmdName){var range=me.selection.getRange(),obj=getObj(this,tagNames);if(range.collapsed){if(obj){var tmpText=me.document.createTextNode('');range.insertNode(tmpText).removeInlineStyle(tagNames);range.setStartBefore(tmpText);domUtils.remove(tmpText);}else{var tmpNode=range.document.createElement(tagNames[0]);if(cmdName=='superscript'||cmdName=='subscript'){tmpText=me.document.createTextNode('');range.insertNode(tmpText).removeInlineStyle(['sub','sup']).setStartBefore(tmpText).collapse(true);}range.insertNode(tmpNode).setStart(tmpNode,0);}range.collapse(true);}else{if(cmdName=='superscript'||cmdName=='subscript'){if(!obj||obj.tagName.toLowerCase()!=cmdName){range.removeInlineStyle(['sub','sup']);}}obj?range.removeInlineStyle(tagNames):range.applyInlineStyle(tagNames[0]);}range.select();},queryCommandState:function queryCommandState(){return getObj(this,tagNames)?1:0;}};})(style,basestyles[style]);}};UE.plugins['elementpath']=function(){var currentLevel,tagNames,me=this;me.setOpt('elementPathEnabled',true);if(!me.options.elementPathEnabled){return;}me.commands['elementpath']={execCommand:function execCommand(cmdName,level){var start=tagNames[level],range=me.selection.getRange();currentLevel=level*1;range.selectNode(start).select();},queryCommandValue:function queryCommandValue(){var parents=[].concat(this.selection.getStartElementPath()).reverse(),names=[];tagNames=parents;for(var i=0,ci;ci=parents[i];i++){if(ci.nodeType==3){continue;}var name=ci.tagName.toLowerCase();if(name=='img'&&ci.getAttribute('anchorname')){name='anchor';}names[i]=name;if(currentLevel==i){currentLevel=-1;break;}}return names;}};};UE.plugins['formatmatch']=function(){var me=this,list=[],img,flag=0;me.addListener('reset',function(){list=[];flag=0;});function addList(type,evt){if(browser.webkit){var target=evt.target.tagName=='IMG'?evt.target:null;}function addFormat(range){if(text){range.selectNode(text);}return range.applyInlineStyle(list[list.length-1].tagName,null,list);}me.undoManger&&me.undoManger.save();var range=me.selection.getRange(),imgT=target||range.getClosedNode();if(img&&imgT&&imgT.tagName=='IMG'){imgT.style.cssText+=';float:'+(img.style.cssFloat||img.style.styleFloat||'none')+';display:'+(img.style.display||'inline');img=null;}else{if(!img){var collapsed=range.collapsed;if(collapsed){var text=me.document.createTextNode('match');range.insertNode(text).select();}me.__hasEnterExecCommand=true;var removeFormatAttributes=me.options.removeFormatAttributes;me.options.removeFormatAttributes='';me.execCommand('removeformat');me.options.removeFormatAttributes=removeFormatAttributes;me.__hasEnterExecCommand=false;range=me.selection.getRange();if(list.length){addFormat(range);}if(text){range.setStartBefore(text).collapse(true);}range.select();text&&domUtils.remove(text);}}me.undoManger&&me.undoManger.save();me.removeListener('mouseup',addList);flag=0;}me.commands['formatmatch']={execCommand:function execCommand(cmdName){if(flag){flag=0;list=[];me.removeListener('mouseup',addList);return;}var range=me.selection.getRange();img=range.getClosedNode();if(!img||img.tagName!='IMG'){range.collapse(true).shrinkBoundary();var start=range.startContainer;list=domUtils.findParents(start,true,function(node){return!domUtils.isBlockElm(node)&&node.nodeType==1;});for(var i=0,ci;ci=list[i];i++){if(ci.tagName=='A'){list.splice(i,1);break;}}}me.addListener('mouseup',addList);flag=1;},queryCommandState:function queryCommandState(){return flag;},notNeedUndo:1};};UE.plugin.register('searchreplace',function(){var me=this;var _blockElm={'table':1,'tbody':1,'tr':1,'ol':1,'ul':1};function findTextInString(textContent,opt,currentIndex){var str=opt.searchStr;if(opt.dir==-1){textContent=textContent.split('').reverse().join('');str=str.split('').reverse().join('');currentIndex=textContent.length-currentIndex;}var reg=new RegExp(str,'g'+(opt.casesensitive?'':'i')),match;while(match=reg.exec(textContent)){if(match.index>=currentIndex){return opt.dir==-1?textContent.length-match.index-opt.searchStr.length:match.index;}}return-1;}function findTextBlockElm(node,currentIndex,opt){var textContent,index,methodName=opt.all||opt.dir==1?'getNextDomNode':'getPreDomNode';if(domUtils.isBody(node)){node=node.firstChild;}var first=1;while(node){textContent=node.nodeType==3?node.nodeValue:node[browser.ie?'innerText':'textContent'];index=findTextInString(textContent,opt,currentIndex);first=0;if(index!=-1){return{'node':node,'index':index};}node=domUtils[methodName](node);while(node&&_blockElm[node.nodeName.toLowerCase()]){node=domUtils[methodName](node,true);}if(node){currentIndex=opt.dir==-1?(node.nodeType==3?node.nodeValue:node[browser.ie?'innerText':'textContent']).length:0;}}}function findNTextInBlockElm(node,index,str){var currentIndex=0,currentNode=node.firstChild,currentNodeLength=0,result;while(currentNode){if(currentNode.nodeType==3){currentNodeLength=currentNode.nodeValue.replace(/(^[\t\r\n]+)|([\t\r\n]+$)/,'').length;currentIndex+=currentNodeLength;if(currentIndex>=index){return{'node':currentNode,'index':currentNodeLength-(currentIndex-index)};}}else if(!dtd.$empty[currentNode.tagName]){currentNodeLength=currentNode[browser.ie?'innerText':'textContent'].replace(/(^[\t\r\n]+)|([\t\r\n]+$)/,'').length;currentIndex+=currentNodeLength;if(currentIndex>=index){result=findNTextInBlockElm(currentNode,currentNodeLength-(currentIndex-index),str);if(result){return result;}}}currentNode=domUtils.getNextDomNode(currentNode);}}function searchReplace(me,opt){var rng=me.selection.getRange(),startBlockNode,searchStr=opt.searchStr,span=me.document.createElement('span');span.innerHTML='$$ueditor_searchreplace_key$$';rng.shrinkBoundary(true);if(!rng.collapsed){rng.select();var rngText=me.selection.getText();if(new RegExp('^'+opt.searchStr+'$',opt.casesensitive?'':'i').test(rngText)){if(opt.replaceStr!=undefined){replaceText(rng,opt.replaceStr);rng.select();return true;}else{rng.collapse(opt.dir==-1);}}}rng.insertNode(span);rng.enlargeToBlockElm(true);startBlockNode=rng.startContainer;var currentIndex=startBlockNode[browser.ie?'innerText':'textContent'].indexOf('$$ueditor_searchreplace_key$$');rng.setStartBefore(span);domUtils.remove(span);var result=findTextBlockElm(startBlockNode,currentIndex,opt);if(result){var rngStart=findNTextInBlockElm(result.node,result.index,searchStr);var rngEnd=findNTextInBlockElm(result.node,result.index+searchStr.length,searchStr);rng.setStart(rngStart.node,rngStart.index).setEnd(rngEnd.node,rngEnd.index);if(opt.replaceStr!==undefined){replaceText(rng,opt.replaceStr);}rng.select();return true;}else{rng.setCursor();}}function replaceText(rng,str){str=me.document.createTextNode(str);rng.deleteContents().insertNode(str);}return{commands:{'searchreplace':{execCommand:function execCommand(cmdName,opt){utils.extend(opt,{all:false,casesensitive:false,dir:1},true);var num=0;if(opt.all){var rng=me.selection.getRange(),first=me.body.firstChild;if(first&&first.nodeType==1){rng.setStart(first,0);rng.shrinkBoundary(true);}else if(first.nodeType==3){rng.setStartBefore(first);}rng.collapse(true).select(true);if(opt.replaceStr!==undefined){me.fireEvent('saveScene');}while(searchReplace(this,opt)){num++;}if(num){me.fireEvent('saveScene');}}else{if(opt.replaceStr!==undefined){me.fireEvent('saveScene');}if(searchReplace(this,opt)){num++;}if(num){me.fireEvent('saveScene');}}return num;},notNeedUndo:1}}};});UE.plugins['customstyle']=function(){var me=this;me.setOpt({'customstyle':[{tag:'h1',name:'tc',style:'font-size:32px;font-weight:bold;border-bottom:#ccc 2px solid;padding:0 4px 0 0;text-align:center;margin:0 0 20px 0;'},{tag:'h1',name:'tl',style:'font-size:32px;font-weight:bold;border-bottom:#ccc 2px solid;padding:0 4px 0 0;text-align:left;margin:0 0 10px 0;'},{tag:'span',name:'im',style:'font-size:16px;font-style:italic;font-weight:bold;line-height:18px;'},{tag:'span',name:'hi',style:'font-size:16px;font-style:italic;font-weight:bold;color:rgb(51, 153, 204);line-height:18px;'}]});me.commands['customstyle']={execCommand:function execCommand(cmdName,obj){var me=this,tagName=obj.tag,node=domUtils.findParent(me.selection.getStart(),function(node){return node.getAttribute('label');},true),range,bk,tmpObj={};for(var p in obj){if(obj[p]!==undefined)tmpObj[p]=obj[p];}delete tmpObj.tag;if(node&&node.getAttribute('label')==obj.label){range=this.selection.getRange();bk=range.createBookmark();if(range.collapsed){if(dtd.$block[node.tagName]){var fillNode=me.document.createElement('p');domUtils.moveChild(node,fillNode);node.parentNode.insertBefore(fillNode,node);domUtils.remove(node);}else{domUtils.remove(node,true);}}else{var common=domUtils.getCommonAncestor(bk.start,bk.end),nodes=domUtils.getElementsByTagName(common,tagName);if(new RegExp(tagName,'i').test(common.tagName)){nodes.push(common);}for(var i=0,ni;ni=nodes[i++];){if(ni.getAttribute('label')==obj.label){var ps=domUtils.getPosition(ni,bk.start),pe=domUtils.getPosition(ni,bk.end);if((ps&domUtils.POSITION_FOLLOWING||ps&domUtils.POSITION_CONTAINS)&&(pe&domUtils.POSITION_PRECEDING||pe&domUtils.POSITION_CONTAINS))if(dtd.$block[tagName]){var fillNode=me.document.createElement('p');domUtils.moveChild(ni,fillNode);ni.parentNode.insertBefore(fillNode,ni);}domUtils.remove(ni,true);}}node=domUtils.findParent(common,function(node){return node.getAttribute('label')==obj.label;},true);if(node){domUtils.remove(node,true);}}range.moveToBookmark(bk).select();}else{if(dtd.$block[tagName]){this.execCommand('paragraph',tagName,tmpObj,'customstyle');range=me.selection.getRange();if(!range.collapsed){range.collapse();node=domUtils.findParent(me.selection.getStart(),function(node){return node.getAttribute('label')==obj.label;},true);var pNode=me.document.createElement('p');domUtils.insertAfter(node,pNode);domUtils.fillNode(me.document,pNode);range.setStart(pNode,0).setCursor();}}else{range=me.selection.getRange();if(range.collapsed){node=me.document.createElement(tagName);domUtils.setAttributes(node,tmpObj);range.insertNode(node).setStart(node,0).setCursor();return;}bk=range.createBookmark();range.applyInlineStyle(tagName,tmpObj).moveToBookmark(bk).select();}}},queryCommandValue:function queryCommandValue(){var parent=domUtils.filterNodeList(this.selection.getStartElementPath(),function(node){return node.getAttribute('label');});return parent?parent.getAttribute('label'):'';}};me.addListener('keyup',function(type,evt){var keyCode=evt.keyCode||evt.which;if(keyCode==32||keyCode==13){var range=me.selection.getRange();if(range.collapsed){var node=domUtils.findParent(me.selection.getStart(),function(node){return node.getAttribute('label');},true);if(node&&dtd.$block[node.tagName]&&domUtils.isEmptyNode(node)){var p=me.document.createElement('p');domUtils.insertAfter(node,p);domUtils.fillNode(me.document,p);domUtils.remove(node);range.setStart(p,0).setCursor();}}}});};UE.plugins['catchremoteimage']=function(){var me=this,ajax=UE.ajax;if(me.options.catchRemoteImageEnable===false)return;me.setOpt({catchRemoteImageEnable:false});me.addListener("afterpaste",function(){me.fireEvent("catchRemoteImage");});me.addListener("catchRemoteImage",function(){var catcherLocalDomain=me.getOpt('catcherLocalDomain'),catcherActionUrl=me.getActionUrl(me.getOpt('catcherActionName')),catcherUrlPrefix=me.getOpt('catcherUrlPrefix'),catcherFieldName=me.getOpt('catcherFieldName');var remoteImages=[],imgs=domUtils.getElementsByTagName(me.document,"img"),test=function test(src,urls){if(src.indexOf(location.host)!=-1||/(^\.)|(^\/)/.test(src)){return true;}if(urls){for(var j=0,url;url=urls[j++];){if(src.indexOf(url)!==-1){return true;}}}return false;};for(var i=0,ci;ci=imgs[i++];){if(ci.getAttribute("word_img")){continue;}var src=ci.getAttribute("_src")||ci.src||"";if(/^(https?|ftp):/i.test(src)&&!test(src,catcherLocalDomain)){remoteImages.push(src);}}if(remoteImages.length){catchremoteimage(remoteImages,{success:function success(r){try{var info=r.state!==undefined?r:eval("("+r.responseText+")");}catch(e){return;}var i,j,ci,cj,oldSrc,newSrc,list=info.list;for(i=0;ci=imgs[i++];){oldSrc=ci.getAttribute("_src")||ci.src||"";for(j=0;cj=list[j++];){if(oldSrc==cj.source&&cj.state=="SUCCESS"){newSrc=catcherUrlPrefix+cj.url;domUtils.setAttributes(ci,{"src":newSrc,"_src":newSrc});break;}}}me.fireEvent('catchremotesuccess');},error:function error(){me.fireEvent("catchremoteerror");}});}function catchremoteimage(imgs,callbacks){var params=utils.serializeParam(me.queryCommandValue('serverparam'))||'',url=utils.formatUrl(catcherActionUrl+(catcherActionUrl.indexOf('?')==-1?'?':'&')+params),isJsonp=utils.isCrossDomainUrl(url),opt={'method':'POST','dataType':isJsonp?'jsonp':'','timeout':60000,'onsuccess':callbacks["success"],'onerror':callbacks["error"]};opt[catcherFieldName]=imgs;ajax.request(url,opt);}});};UE.plugin.register('snapscreen',function(){var me=this;var snapplugin;function getLocation(url){var search,a=document.createElement('a'),params=utils.serializeParam(me.queryCommandValue('serverparam'))||'';a.href=url;if(browser.ie){a.href=a.href;}search=a.search;if(params){search=search+(search.indexOf('?')==-1?'?':'&')+params;search=search.replace(/[&]+/ig,'&');}return{'port':a.port,'hostname':a.hostname,'path':a.pathname+search||+a.hash};}return{commands:{'snapscreen':{execCommand:function execCommand(cmd){var url,local,res;var lang=me.getLang("snapScreen_plugin");if(!snapplugin){var container=me.container;var doc=me.container.ownerDocument||me.container.document;snapplugin=doc.createElement("object");try{snapplugin.type="application/x-pluginbaidusnap";}catch(e){return;}snapplugin.style.cssText="position:absolute;left:-9999px;width:0;height:0;";snapplugin.setAttribute("width","0");snapplugin.setAttribute("height","0");container.appendChild(snapplugin);}function onSuccess(rs){try{rs=eval("("+rs+")");if(rs.state=='SUCCESS'){var opt=me.options;me.execCommand('insertimage',{src:opt.snapscreenUrlPrefix+rs.url,_src:opt.snapscreenUrlPrefix+rs.url,alt:rs.title||'',floatStyle:opt.snapscreenImgAlign});}else{alert(rs.state);}}catch(e){alert(lang.callBackErrorMsg);}}url=me.getActionUrl(me.getOpt('snapscreenActionName'));local=getLocation(url);setTimeout(function(){try{res=snapplugin.saveSnapshot(local.hostname,local.path,local.port);}catch(e){me.ui._dialogs['snapscreenDialog'].open();return;}onSuccess(res);},50);},queryCommandState:function queryCommandState(){return navigator.userAgent.indexOf("Windows",0)!=-1?0:-1;}}}};});UE.commands['insertparagraph']={execCommand:function execCommand(cmdName,front){var me=this,range=me.selection.getRange(),start=range.startContainer,tmpNode;while(start){if(domUtils.isBody(start)){break;}tmpNode=start;start=start.parentNode;}if(tmpNode){var p=me.document.createElement('p');if(front){tmpNode.parentNode.insertBefore(p,tmpNode);}else{tmpNode.parentNode.insertBefore(p,tmpNode.nextSibling);}domUtils.fillNode(me.document,p);range.setStart(p,0).setCursor(false,true);}}};UE.plugin.register('webapp',function(){var me=this;function createInsertStr(obj,toEmbed){return!toEmbed?'<img title="'+obj.title+'" width="'+obj.width+'" height="'+obj.height+'"'+' src="'+me.options.UEDITOR_HOME_URL+'themes/default/images/spacer.gif" _logo_url="'+obj.logo+'" style="background:url('+obj.logo+') no-repeat center center; border:1px solid gray;" class="edui-faked-webapp" _url="'+obj.url+'" '+(obj.align&&!obj.cssfloat?'align="'+obj.align+'"':'')+(obj.cssfloat?'style="float:'+obj.cssfloat+'"':'')+'/>':'<iframe class="edui-faked-webapp" title="'+obj.title+'" '+(obj.align&&!obj.cssfloat?'align="'+obj.align+'"':'')+(obj.cssfloat?'style="float:'+obj.cssfloat+'"':'')+'width="'+obj.width+'" height="'+obj.height+'"  scrolling="no" frameborder="0" src="'+obj.url+'" logo_url = "'+obj.logo+'"></iframe>';}return{outputRule:function outputRule(root){utils.each(root.getNodesByTagName('img'),function(node){var html;if(node.getAttr('class')=='edui-faked-webapp'){html=createInsertStr({title:node.getAttr('title'),'width':node.getAttr('width'),'height':node.getAttr('height'),'align':node.getAttr('align'),'cssfloat':node.getStyle('float'),'url':node.getAttr("_url"),'logo':node.getAttr('_logo_url')},true);var embed=UE.uNode.createElement(html);node.parentNode.replaceChild(embed,node);}});},inputRule:function inputRule(root){utils.each(root.getNodesByTagName('iframe'),function(node){if(node.getAttr('class')=='edui-faked-webapp'){var img=UE.uNode.createElement(createInsertStr({title:node.getAttr('title'),'width':node.getAttr('width'),'height':node.getAttr('height'),'align':node.getAttr('align'),'cssfloat':node.getStyle('float'),'url':node.getAttr("src"),'logo':node.getAttr('logo_url')}));node.parentNode.replaceChild(img,node);}});},commands:{'webapp':{execCommand:function execCommand(cmd,obj){var me=this,str=createInsertStr(utils.extend(obj,{align:'none'}),false);me.execCommand("inserthtml",str);},queryCommandState:function queryCommandState(){var me=this,img=me.selection.getRange().getClosedNode(),flag=img&&img.className=="edui-faked-webapp";return flag?1:0;}}}};});UE.plugins['template']=function(){UE.commands['template']={execCommand:function execCommand(cmd,obj){obj.html&&this.execCommand("inserthtml",obj.html);}};this.addListener("click",function(type,evt){var el=evt.target||evt.srcElement,range=this.selection.getRange();var tnode=domUtils.findParent(el,function(node){if(node.className&&domUtils.hasClass(node,"ue_t")){return node;}},true);tnode&&range.selectNode(tnode).shrinkBoundary().select();});this.addListener("keydown",function(type,evt){var range=this.selection.getRange();if(!range.collapsed){if(!evt.ctrlKey&&!evt.metaKey&&!evt.shiftKey&&!evt.altKey){var tnode=domUtils.findParent(range.startContainer,function(node){if(node.className&&domUtils.hasClass(node,"ue_t")){return node;}},true);if(tnode){domUtils.removeClasses(tnode,["ue_t"]);}}}});};UE.plugin.register('music',function(){var me=this;function creatInsertStr(url,width,height,align,cssfloat,toEmbed){return!toEmbed?'<img '+(align&&!cssfloat?'align="'+align+'"':'')+(cssfloat?'style="float:'+cssfloat+'"':'')+' width="'+width+'" height="'+height+'" _url="'+url+'" class="edui-faked-music"'+' src="'+me.options.langPath+me.options.lang+'/images/music.png" />':'<embed type="application/x-shockwave-flash" class="edui-faked-music" pluginspage="http://www.macromedia.com/go/getflashplayer"'+' src="'+url+'" width="'+width+'" height="'+height+'" '+(align&&!cssfloat?'align="'+align+'"':'')+(cssfloat?'style="float:'+cssfloat+'"':'')+' wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" >';}return{outputRule:function outputRule(root){utils.each(root.getNodesByTagName('img'),function(node){var html;if(node.getAttr('class')=='edui-faked-music'){var cssfloat=node.getStyle('float');var align=node.getAttr('align');html=creatInsertStr(node.getAttr("_url"),node.getAttr('width'),node.getAttr('height'),align,cssfloat,true);var embed=UE.uNode.createElement(html);node.parentNode.replaceChild(embed,node);}});},inputRule:function inputRule(root){utils.each(root.getNodesByTagName('embed'),function(node){if(node.getAttr('class')=='edui-faked-music'){var cssfloat=node.getStyle('float');var align=node.getAttr('align');html=creatInsertStr(node.getAttr("src"),node.getAttr('width'),node.getAttr('height'),align,cssfloat,false);var img=UE.uNode.createElement(html);node.parentNode.replaceChild(img,node);}});},commands:{'music':{execCommand:function execCommand(cmd,musicObj){var me=this,str=creatInsertStr(musicObj.url,musicObj.width||400,musicObj.height||95,"none",false);me.execCommand("inserthtml",str);},queryCommandState:function queryCommandState(){var me=this,img=me.selection.getRange().getClosedNode(),flag=img&&img.className=="edui-faked-music";return flag?1:0;}}}};});UE.plugin.register('autoupload',function(){function sendAndInsertFile(file,editor){var me=editor;var fieldName,urlPrefix,maxSize,allowFiles,actionUrl,loadingHtml,errorHandler,successHandler,filetype=/image\/\w+/i.test(file.type)?'image':'file',loadingId='loading_'+(+new Date()).toString(36);fieldName=me.getOpt(filetype+'FieldName');urlPrefix=me.getOpt(filetype+'UrlPrefix');maxSize=me.getOpt(filetype+'MaxSize');allowFiles=me.getOpt(filetype+'AllowFiles');actionUrl=me.getActionUrl(me.getOpt(filetype+'ActionName'));errorHandler=function errorHandler(title){var loader=me.document.getElementById(loadingId);loader&&domUtils.remove(loader);me.fireEvent('showmessage',{'id':loadingId,'content':title,'type':'error','timeout':4000});};if(filetype=='image'){loadingHtml='<img class="loadingclass" id="'+loadingId+'" src="'+me.options.themePath+me.options.theme+'/images/spacer.gif" title="'+(me.getLang('autoupload.loading')||'')+'" >';successHandler=function successHandler(data){var link=urlPrefix+data.url,loader=me.document.getElementById(loadingId);if(loader){loader.setAttribute('src',link);loader.setAttribute('_src',link);loader.setAttribute('title',data.title||'');loader.setAttribute('alt',data.original||'');loader.removeAttribute('id');domUtils.removeClasses(loader,'loadingclass');}};}else{loadingHtml='<p>'+'<img class="loadingclass" id="'+loadingId+'" src="'+me.options.themePath+me.options.theme+'/images/spacer.gif" title="'+(me.getLang('autoupload.loading')||'')+'" >'+'</p>';successHandler=function successHandler(data){var link=urlPrefix+data.url,loader=me.document.getElementById(loadingId);var rng=me.selection.getRange(),bk=rng.createBookmark();rng.selectNode(loader).select();me.execCommand('insertfile',{'url':link});rng.moveToBookmark(bk).select();};}me.execCommand('inserthtml',loadingHtml);if(!me.getOpt(filetype+'ActionName')){errorHandler(me.getLang('autoupload.errorLoadConfig'));return;}if(file.size>maxSize){errorHandler(me.getLang('autoupload.exceedSizeError'));return;}var fileext=file.name?file.name.substr(file.name.lastIndexOf('.')):'';if(fileext&&filetype!='image'||allowFiles&&(allowFiles.join('')+'.').indexOf(fileext.toLowerCase()+'.')==-1){errorHandler(me.getLang('autoupload.exceedTypeError'));return;}var xhr=new XMLHttpRequest(),fd=new FormData(),params=utils.serializeParam(me.queryCommandValue('serverparam'))||'',url=utils.formatUrl(actionUrl+(actionUrl.indexOf('?')==-1?'?':'&')+params);fd.append(fieldName,file,file.name||'blob.'+file.type.substr('image/'.length));fd.append('type','ajax');xhr.open("post",url,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.addEventListener('load',function(e){try{var json=new Function("return "+utils.trim(e.target.response))();if(json.state=='SUCCESS'&&json.url){successHandler(json);}else{errorHandler(json.state);}}catch(er){errorHandler(me.getLang('autoupload.loadError'));}});xhr.send(fd);}function getPasteImage(e){return e.clipboardData&&e.clipboardData.items&&e.clipboardData.items.length==1&&/^image\//.test(e.clipboardData.items[0].type)?e.clipboardData.items:null;}function getDropImage(e){return e.dataTransfer&&e.dataTransfer.files?e.dataTransfer.files:null;}return{outputRule:function outputRule(root){utils.each(root.getNodesByTagName('img'),function(n){if(/\b(loaderrorclass)|(bloaderrorclass)\b/.test(n.getAttr('class'))){n.parentNode.removeChild(n);}});utils.each(root.getNodesByTagName('p'),function(n){if(/\bloadpara\b/.test(n.getAttr('class'))){n.parentNode.removeChild(n);}});},bindEvents:{'ready':function ready(e){var me=this;if(window.FormData&&window.FileReader){domUtils.on(me.body,'paste drop',function(e){var hasImg=false,items;items=e.type=='paste'?getPasteImage(e):getDropImage(e);if(items){var len=items.length,file;while(len--){file=items[len];if(file.getAsFile)file=file.getAsFile();if(file&&file.size>0){sendAndInsertFile(file,me);hasImg=true;}}hasImg&&e.preventDefault();}});domUtils.on(me.body,'dragover',function(e){if(e.dataTransfer.types[0]=='Files'){e.preventDefault();}});utils.cssRule('loading','.loadingclass{display:inline-block;cursor:default;background: url(\''+this.options.themePath+this.options.theme+'/images/loading.gif\') no-repeat center center transparent;border:1px solid #cccccc;margin-left:1px;height: 22px;width: 22px;}\n'+'.loaderrorclass{display:inline-block;cursor:default;background: url(\''+this.options.themePath+this.options.theme+'/images/loaderror.png\') no-repeat center center transparent;border:1px solid #cccccc;margin-right:1px;height: 22px;width: 22px;'+'}',this.document);}}}};});UE.plugin.register('autosave',function(){var me=this,lastSaveTime=new Date(),MIN_TIME=20,saveKey=null;function save(editor){var saveData;if(new Date()-lastSaveTime<MIN_TIME){return;}if(!editor.hasContents()){saveKey&&me.removePreferences(saveKey);return;}lastSaveTime=new Date();editor._saveFlag=null;saveData=me.body.innerHTML;if(editor.fireEvent("beforeautosave",{content:saveData})===false){return;}me.setPreferences(saveKey,saveData);editor.fireEvent("afterautosave",{content:saveData});}return{defaultOptions:{saveInterval:500},bindEvents:{'ready':function ready(){var _suffix="-drafts-data",key=null;if(me.key){key=me.key+_suffix;}else{key=(me.container.parentNode.id||'ue-common')+_suffix;}
saveKey=(location.protocol+location.host+location.pathname).replace(/[.:\/]/g,'_')+key;},'contentchange':function contentchange(){if(!saveKey){return;}if(me._saveFlag){window.clearTimeout(me._saveFlag);}if(me.options.saveInterval>0){me._saveFlag=window.setTimeout(function(){save(me);},me.options.saveInterval);}else{save(me);}}},commands:{'clearlocaldata':{execCommand:function execCommand(cmd,name){if(saveKey&&me.getPreferences(saveKey)){me.removePreferences(saveKey);}},notNeedUndo:true,ignoreContentChange:true},'getlocaldata':{execCommand:function execCommand(cmd,name){return saveKey?me.getPreferences(saveKey)||'':'';},notNeedUndo:true,ignoreContentChange:true},'drafts':{execCommand:function execCommand(cmd,name){if(saveKey){me.body.innerHTML=me.getPreferences(saveKey)||'<p>'+domUtils.fillHtml+'</p>';me.focus(true);}},queryCommandState:function queryCommandState(){return saveKey?me.getPreferences(saveKey)===null?-1:0:-1;},notNeedUndo:true,ignoreContentChange:true}}};});UE.plugin.register('charts',function(){var me=this;return{bindEvents:{'chartserror':function chartserror(){}},commands:{'charts':{execCommand:function execCommand(cmd,data){var tableNode=domUtils.findParentByTagName(this.selection.getRange().startContainer,'table',true),flagText=[],config={};if(!tableNode){return false;}if(!validData(tableNode)){me.fireEvent("chartserror");return false;}config.title=data.title||'';config.subTitle=data.subTitle||'';config.xTitle=data.xTitle||'';config.yTitle=data.yTitle||'';config.suffix=data.suffix||'';config.tip=data.tip||'';config.dataFormat=data.tableDataFormat||'';config.chartType=data.chartType||0;for(var key in config){if(!config.hasOwnProperty(key)){continue;}flagText.push(key+":"+config[key]);}tableNode.setAttribute("data-chart",flagText.join(";"));domUtils.addClass(tableNode,"edui-charts-table");},queryCommandState:function queryCommandState(cmd,name){var tableNode=domUtils.findParentByTagName(this.selection.getRange().startContainer,'table',true);return tableNode&&validData(tableNode)?0:-1;}}},inputRule:function inputRule(root){utils.each(root.getNodesByTagName('table'),function(tableNode){if(tableNode.getAttr("data-chart")!==undefined){tableNode.setAttr("style");}});},outputRule:function outputRule(root){utils.each(root.getNodesByTagName('table'),function(tableNode){if(tableNode.getAttr("data-chart")!==undefined){tableNode.setAttr("style","display: none;");}});}};function validData(table){var firstRows=null,cellCount=0;if(table.rows.length<2){return false;}
if(table.rows[0].cells.length<2){return false;}
firstRows=table.rows[0].cells;cellCount=firstRows.length;for(var i=0,cell;cell=firstRows[i];i++){if(cell.tagName.toLowerCase()!=='th'){return false;}}for(var i=1,row;row=table.rows[i];i++){if(row.cells.length!=cellCount){return false;}
if(row.cells[0].tagName.toLowerCase()!=='th'){return false;}for(var j=1,cell;cell=row.cells[j];j++){var value=utils.trim(cell.innerText||cell.textContent||'');value=value.replace(new RegExp(UE.dom.domUtils.fillChar,'g'),'').replace(/^\s+|\s+$/g,'');if(!/^\d*\.?\d+$/.test(value)){return false;}}}return true;}});UE.plugin.register('section',function(){function Section(option){this.tag='';this.level=-1,this.dom=null;this.nextSection=null;this.previousSection=null;this.parentSection=null;this.startAddress=[];this.endAddress=[];this.children=[];}function getSection(option){var section=new Section();return utils.extend(section,option);}function getNodeFromAddress(startAddress,root){var current=root;for(var i=0;i<startAddress.length;i++){if(!current.childNodes)return null;current=current.childNodes[startAddress[i]];}return current;}var me=this;return{bindMultiEvents:{type:'aftersetcontent afterscencerestore',handler:function handler(){me.fireEvent('updateSections');}},bindEvents:{'ready':function ready(){me.fireEvent('updateSections');domUtils.on(me.body,'drop paste',function(){me.fireEvent('updateSections');});},'afterexeccommand':function afterexeccommand(type,cmd){if(cmd=='paragraph'){me.fireEvent('updateSections');}},'keyup':function keyup(type,e){var me=this,range=me.selection.getRange();if(range.collapsed!=true){me.fireEvent('updateSections');}else{var keyCode=e.keyCode||e.which;if(keyCode==13||keyCode==8||keyCode==46){me.fireEvent('updateSections');}}}},commands:{'getsections':{execCommand:function execCommand(cmd,levels){var levelFn=levels||['h1','h2','h3','h4','h5','h6'];for(var i=0;i<levelFn.length;i++){if(typeof levelFn[i]=='string'){levelFn[i]=function(fn){return function(node){return node.tagName==fn.toUpperCase();};}(levelFn[i]);}else if(typeof levelFn[i]!='function'){levelFn[i]=function(node){return null;};}}function getSectionLevel(node){for(var i=0;i<levelFn.length;i++){if(levelFn[i](node))return i;}return-1;}var me=this,Directory=getSection({'level':-1,'title':'root'}),previous=Directory;function traversal(node,Directory){var level,tmpSection=null,parent,child,children=node.childNodes;for(var i=0,len=children.length;i<len;i++){child=children[i];level=getSectionLevel(child);if(level>=0){var address=me.selection.getRange().selectNode(child).createAddress(true).startAddress,current=getSection({'tag':child.tagName,'title':child.innerText||child.textContent||'','level':level,'dom':child,'startAddress':utils.clone(address,[]),'endAddress':utils.clone(address,[]),'children':[]});previous.nextSection=current;current.previousSection=previous;parent=previous;while(level<=parent.level){parent=parent.parentSection;}current.parentSection=parent;parent.children.push(current);tmpSection=previous=current;}else{child.nodeType===1&&traversal(child,Directory);tmpSection&&tmpSection.endAddress[tmpSection.endAddress.length-1]++;}}}traversal(me.body,Directory);return Directory;},notNeedUndo:true},'movesection':{execCommand:function execCommand(cmd,sourceSection,targetSection,isAfter){var me=this,targetAddress,target;if(!sourceSection||!targetSection||targetSection.level==-1)return;targetAddress=isAfter?targetSection.endAddress:targetSection.startAddress;target=getNodeFromAddress(targetAddress,me.body);if(!targetAddress||!target||isContainsAddress(sourceSection.startAddress,sourceSection.endAddress,targetAddress))return;var startNode=getNodeFromAddress(sourceSection.startAddress,me.body),endNode=getNodeFromAddress(sourceSection.endAddress,me.body),current,nextNode;if(isAfter){current=endNode;while(current&&!(domUtils.getPosition(startNode,current)&domUtils.POSITION_FOLLOWING)){nextNode=current.previousSibling;domUtils.insertAfter(target,current);if(current==startNode)break;current=nextNode;}}else{current=startNode;while(current&&!(domUtils.getPosition(current,endNode)&domUtils.POSITION_FOLLOWING)){nextNode=current.nextSibling;target.parentNode.insertBefore(current,target);if(current==endNode)break;current=nextNode;}}me.fireEvent('updateSections');function isContainsAddress(startAddress,endAddress,addressTarget){var isAfterStartAddress=false,isBeforeEndAddress=false;for(var i=0;i<startAddress.length;i++){if(i>=addressTarget.length)break;if(addressTarget[i]>startAddress[i]){isAfterStartAddress=true;break;}else if(addressTarget[i]<startAddress[i]){break;}}for(var i=0;i<endAddress.length;i++){if(i>=addressTarget.length)break;if(addressTarget[i]<startAddress[i]){isBeforeEndAddress=true;break;}else if(addressTarget[i]>startAddress[i]){break;}}return isAfterStartAddress&&isBeforeEndAddress;}}},'deletesection':{execCommand:function execCommand(cmd,section,keepChildren){var me=this;if(!section)return;function getNodeFromAddress(startAddress){var current=me.body;for(var i=0;i<startAddress.length;i++){if(!current.childNodes)return null;current=current.childNodes[startAddress[i]];}return current;}var startNode=getNodeFromAddress(section.startAddress),endNode=getNodeFromAddress(section.endAddress),current=startNode,nextNode;if(!keepChildren){while(current&&domUtils.inDoc(endNode,me.document)&&!(domUtils.getPosition(current,endNode)&domUtils.POSITION_FOLLOWING)){nextNode=current.nextSibling;domUtils.remove(current);current=nextNode;}}else{domUtils.remove(current);}me.fireEvent('updateSections');}},'selectsection':{execCommand:function execCommand(cmd,section){if(!section&&!section.dom)return false;var me=this,range=me.selection.getRange(),address={'startAddress':utils.clone(section.startAddress,[]),'endAddress':utils.clone(section.endAddress,[])};address.endAddress[address.endAddress.length-1]++;range.moveToAddress(address).select().scrollToView();return true;},notNeedUndo:true},'scrolltosection':{execCommand:function execCommand(cmd,section){if(!section&&!section.dom)return false;var me=this,range=me.selection.getRange(),address={'startAddress':section.startAddress,'endAddress':section.endAddress};address.endAddress[address.endAddress.length-1]++;range.moveToAddress(address).scrollToView();return true;},notNeedUndo:true}}};});UE.plugin.register('simpleupload',function(){var me=this,isLoaded=false,containerBtn;function initUploadBtn(){var w=containerBtn.offsetWidth||20,h=containerBtn.offsetHeight||20,btnIframe=document.createElement('iframe'),btnStyle='display:block;width:'+w+'px;height:'+h+'px;overflow:hidden;border:0;margin:0;padding:0;position:absolute;top:0;left:0;filter:alpha(opacity=0);-moz-opacity:0;-khtml-opacity: 0;opacity: 0;cursor:pointer;';domUtils.on(btnIframe,'load',function(){var timestrap=(+new Date()).toString(36),wrapper,btnIframeDoc,btnIframeBody;btnIframeDoc=btnIframe.contentDocument||btnIframe.contentWindow.document;btnIframeBody=btnIframeDoc.body;wrapper=btnIframeDoc.createElement('div');wrapper.innerHTML='<form id="edui_form_'+timestrap+'" target="edui_iframe_'+timestrap+'" method="POST" enctype="multipart/form-data" action="'+me.getOpt('serverUrl')+'" '+'style="'+btnStyle+'">'+'<input id="edui_input_'+timestrap+'" type="file" accept="image/*" name="'+me.options.imageFieldName+'" '+'style="'+btnStyle+'">'+'</form>'+'<iframe id="edui_iframe_'+timestrap+'" name="edui_iframe_'+timestrap+'" style="display:none;width:0;height:0;border:0;margin:0;padding:0;position:absolute;"></iframe>';wrapper.className='edui-'+me.options.theme;wrapper.id=me.ui.id+'_iframeupload';btnIframeBody.style.cssText=btnStyle;btnIframeBody.style.width=w+'px';btnIframeBody.style.height=h+'px';btnIframeBody.appendChild(wrapper);if(btnIframeBody.parentNode){btnIframeBody.parentNode.style.width=w+'px';btnIframeBody.parentNode.style.height=w+'px';}var form=btnIframeDoc.getElementById('edui_form_'+timestrap);var input=btnIframeDoc.getElementById('edui_input_'+timestrap);var iframe=btnIframeDoc.getElementById('edui_iframe_'+timestrap);domUtils.on(input,'change',function(){if(!input.value)return;var loadingId='loading_'+(+new Date()).toString(36);var params=utils.serializeParam(me.queryCommandValue('serverparam'))||'';var imageActionUrl=me.getActionUrl(me.getOpt('imageActionName'));var allowFiles=me.getOpt('imageAllowFiles');me.focus();me.execCommand('inserthtml','<img class="loadingclass" id="'+loadingId+'" src="'+me.options.themePath+me.options.theme+'/images/spacer.gif" title="'+(me.getLang('simpleupload.loading')||'')+'" >');function callback(){try{var link,json,loader,body=(iframe.contentDocument||iframe.contentWindow.document).body,result=body.innerText||body.textContent||'';json=new Function("return "+result)();link=me.options.imageUrlPrefix+json.url;if(json.state=='SUCCESS'&&json.url){loader=me.document.getElementById(loadingId);loader.setAttribute('src',link);loader.setAttribute('_src',link);loader.setAttribute('title',json.title||'');loader.setAttribute('alt',json.original||'');loader.removeAttribute('id');domUtils.removeClasses(loader,'loadingclass');}else{showErrorLoader&&showErrorLoader(json.state);}}catch(er){showErrorLoader&&showErrorLoader(me.getLang('simpleupload.loadError'));}form.reset();domUtils.un(iframe,'load',callback);}function showErrorLoader(title){if(loadingId){var loader=me.document.getElementById(loadingId);loader&&domUtils.remove(loader);me.fireEvent('showmessage',{'id':loadingId,'content':title,'type':'error','timeout':4000});}}if(!me.getOpt('imageActionName')){errorHandler(me.getLang('autoupload.errorLoadConfig'));return;}
var filename=input.value,fileext=filename?filename.substr(filename.lastIndexOf('.')):'';if(!fileext||allowFiles&&(allowFiles.join('')+'.').indexOf(fileext.toLowerCase()+'.')==-1){showErrorLoader(me.getLang('simpleupload.exceedTypeError'));return;}domUtils.on(iframe,'load',callback);form.action=utils.formatUrl(imageActionUrl+(imageActionUrl.indexOf('?')==-1?'?':'&')+params);form.submit();});var stateTimer;me.addListener('selectionchange',function(){clearTimeout(stateTimer);stateTimer=setTimeout(function(){var state=me.queryCommandState('simpleupload');if(state==-1){input.disabled='disabled';}else{input.disabled=false;}},400);});isLoaded=true;});btnIframe.style.cssText=btnStyle;containerBtn.appendChild(btnIframe);}return{bindEvents:{'ready':function ready(){utils.cssRule('loading','.loadingclass{display:inline-block;cursor:default;background: url(\''+this.options.themePath+this.options.theme+'/images/loading.gif\') no-repeat center center transparent;border:1px solid #cccccc;margin-right:1px;height: 22px;width: 22px;}\n'+'.loaderrorclass{display:inline-block;cursor:default;background: url(\''+this.options.themePath+this.options.theme+'/images/loaderror.png\') no-repeat center center transparent;border:1px solid #cccccc;margin-right:1px;height: 22px;width: 22px;'+'}',this.document);},'simpleuploadbtnready':function simpleuploadbtnready(type,container){containerBtn=container;me.afterConfigReady(initUploadBtn);}},outputRule:function outputRule(root){utils.each(root.getNodesByTagName('img'),function(n){if(/\b(loaderrorclass)|(bloaderrorclass)\b/.test(n.getAttr('class'))){n.parentNode.removeChild(n);}});},commands:{'simpleupload':{queryCommandState:function queryCommandState(){return isLoaded?0:-1;}}}};});UE.plugin.register('serverparam',function(){var me=this,serverParam={};return{commands:{'serverparam':{execCommand:function execCommand(cmd,key,value){if(key===undefined||key===null){serverParam={};}else if(utils.isString(key)){if(value===undefined||value===null){delete serverParam[key];}else{serverParam[key]=value;}}else if(utils.isObject(key)){utils.extend(serverParam,key,true);}else if(utils.isFunction(key)){utils.extend(serverParam,key(),true);}},queryCommandValue:function queryCommandValue(){return serverParam||{};}}}};});UE.plugin.register('insertfile',function(){var me=this;function getFileIcon(url){var ext=url.substr(url.lastIndexOf('.')+1).toLowerCase(),maps={"rar":"icon_rar.gif","zip":"icon_rar.gif","tar":"icon_rar.gif","gz":"icon_rar.gif","bz2":"icon_rar.gif","doc":"icon_doc.gif","docx":"icon_doc.gif","pdf":"icon_pdf.gif","mp3":"icon_mp3.gif","xls":"icon_xls.gif","chm":"icon_chm.gif","ppt":"icon_ppt.gif","pptx":"icon_ppt.gif","avi":"icon_mv.gif","rmvb":"icon_mv.gif","wmv":"icon_mv.gif","flv":"icon_mv.gif","swf":"icon_mv.gif","rm":"icon_mv.gif","exe":"icon_exe.gif","psd":"icon_psd.gif","txt":"icon_txt.gif","jpg":"icon_jpg.gif","png":"icon_jpg.gif","jpeg":"icon_jpg.gif","gif":"icon_jpg.gif","ico":"icon_jpg.gif","bmp":"icon_jpg.gif"};return maps[ext]?maps[ext]:maps['txt'];}return{commands:{'insertfile':{execCommand:function execCommand(command,filelist){filelist=utils.isArray(filelist)?filelist:[filelist];var i,item,icon,title,html='',URL=me.getOpt('UEDITOR_HOME_URL'),iconDir=URL+(URL.substr(URL.length-1)=='/'?'':'/')+'dialogs/attachment/fileTypeImages/';for(i=0;i<filelist.length;i++){item=filelist[i];icon=iconDir+getFileIcon(item.url);title=item.title||item.url.substr(item.url.lastIndexOf('/')+1);html+='<p style="line-height: 16px;">'+'<img style="vertical-align: middle; margin-right: 2px;" src="'+icon+'" _src="'+icon+'" />'+'<a style="font-size:12px; color:#0066cc;" href="'+item.url+'" title="'+title+'">'+title+'</a>'+'</p>';}me.execCommand('insertHtml',html);}}}};});var baidu=baidu||{};baidu.editor=baidu.editor||{};UE.ui=baidu.editor.ui={};(function(){var browser=baidu.editor.browser,domUtils=baidu.editor.dom.domUtils;var magic='$EDITORUI';var root=window[magic]={};var uidMagic='ID'+magic;var uidCount=0;var uiUtils=baidu.editor.ui.uiUtils={uid:function uid(obj){return obj?obj[uidMagic]||(obj[uidMagic]=++uidCount):++uidCount;},hook:function hook(fn,callback){var _dg;if(fn&&fn._callbacks){_dg=fn;}else{_dg=function dg(){var q;if(fn){q=fn.apply(this,arguments);}var callbacks=_dg._callbacks;var k=callbacks.length;while(k--){var r=callbacks[k].apply(this,arguments);if(q===undefined){q=r;}}return q;};_dg._callbacks=[];}_dg._callbacks.push(callback);return _dg;},createElementByHtml:function createElementByHtml(html){var el=document.createElement('div');el.innerHTML=html;el=el.firstChild;el.parentNode.removeChild(el);return el;},getViewportElement:function getViewportElement(){return browser.ie&&browser.quirks?document.body:document.documentElement;},getClientRect:function getClientRect(element){var bcr;try{bcr=element.getBoundingClientRect();}catch(e){bcr={left:0,top:0,height:0,width:0};}var rect={left:Math.round(bcr.left),top:Math.round(bcr.top),height:Math.round(bcr.bottom-bcr.top),width:Math.round(bcr.right-bcr.left)};var doc;while((doc=element.ownerDocument)!==document&&(element=domUtils.getWindow(doc).frameElement)){bcr=element.getBoundingClientRect();rect.left+=bcr.left;rect.top+=bcr.top;}rect.bottom=rect.top+rect.height;rect.right=rect.left+rect.width;return rect;},getViewportRect:function getViewportRect(){var viewportEl=uiUtils.getViewportElement();var width=(window.innerWidth||viewportEl.clientWidth)|0;var height=(window.innerHeight||viewportEl.clientHeight)|0;return{left:0,top:0,height:height,width:width,bottom:height,right:width};},setViewportOffset:function setViewportOffset(element,offset){var rect;var fixedLayer=uiUtils.getFixedLayer();if(element.parentNode===fixedLayer){element.style.left=offset.left+'px';element.style.top=offset.top+'px';}else{domUtils.setViewportOffset(element,offset);}},getEventOffset:function getEventOffset(evt){var el=evt.target||evt.srcElement;var rect=uiUtils.getClientRect(el);var offset=uiUtils.getViewportOffsetByEvent(evt);return{left:offset.left-rect.left,top:offset.top-rect.top};},getViewportOffsetByEvent:function getViewportOffsetByEvent(evt){var el=evt.target||evt.srcElement;var frameEl=domUtils.getWindow(el).frameElement;var offset={left:evt.clientX,top:evt.clientY};if(frameEl&&el.ownerDocument!==document){var rect=uiUtils.getClientRect(frameEl);offset.left+=rect.left;offset.top+=rect.top;}return offset;},setGlobal:function setGlobal(id,obj){root[id]=obj;return magic+'["'+id+'"]';},unsetGlobal:function unsetGlobal(id){delete root[id];},copyAttributes:function copyAttributes(tgt,src){var attributes=src.attributes;var k=attributes.length;while(k--){var attrNode=attributes[k];if(attrNode.nodeName!='style'&&attrNode.nodeName!='class'&&(!browser.ie||attrNode.specified)){tgt.setAttribute(attrNode.nodeName,attrNode.nodeValue);}}if(src.className){domUtils.addClass(tgt,src.className);}if(src.style.cssText){tgt.style.cssText+=';'+src.style.cssText;}},removeStyle:function removeStyle(el,styleName){if(el.style.removeProperty){el.style.removeProperty(styleName);}else if(el.style.removeAttribute){el.style.removeAttribute(styleName);}else throw'';},contains:function contains(elA,elB){return elA&&elB&&(elA===elB?false:elA.contains?elA.contains(elB):elA.compareDocumentPosition(elB)&16);},startDrag:function startDrag(evt,callbacks,doc){var doc=doc||document;var startX=evt.clientX;var startY=evt.clientY;function handleMouseMove(evt){var x=evt.clientX-startX;var y=evt.clientY-startY;callbacks.ondragmove(x,y,evt);if(evt.stopPropagation){evt.stopPropagation();}else{evt.cancelBubble=true;}}if(doc.addEventListener){(function(){var handleMouseUp=function handleMouseUp(evt){doc.removeEventListener('mousemove',handleMouseMove,true);doc.removeEventListener('mouseup',handleMouseUp,true);window.removeEventListener('mouseup',handleMouseUp,true);callbacks.ondragstop();};doc.addEventListener('mousemove',handleMouseMove,true);doc.addEventListener('mouseup',handleMouseUp,true);window.addEventListener('mouseup',handleMouseUp,true);evt.preventDefault();})();}else{var elm;(function(){var releaseCaptrue=function releaseCaptrue(){elm.releaseCapture();elm.detachEvent('onmousemove',handleMouseMove);elm.detachEvent('onmouseup',releaseCaptrue);elm.detachEvent('onlosecaptrue',releaseCaptrue);callbacks.ondragstop();};elm=evt.srcElement;elm.setCapture();elm.attachEvent('onmousemove',handleMouseMove);elm.attachEvent('onmouseup',releaseCaptrue);elm.attachEvent('onlosecaptrue',releaseCaptrue);evt.returnValue=false;})();}callbacks.ondragstart();},getFixedLayer:function getFixedLayer(){var layer=document.getElementById('edui_fixedlayer');if(layer==null){layer=document.createElement('div');layer.id='edui_fixedlayer';document.body.appendChild(layer);if(browser.ie&&browser.version<=8){layer.style.position='absolute';bindFixedLayer();setTimeout(updateFixedOffset);}else{layer.style.position='fixed';}layer.style.left='0';layer.style.top='0';layer.style.width='0';layer.style.height='0';}return layer;},makeUnselectable:function makeUnselectable(element){if(browser.opera||browser.ie&&browser.version<9){element.unselectable='on';if(element.hasChildNodes()){for(var i=0;i<element.childNodes.length;i++){if(element.childNodes[i].nodeType==1){uiUtils.makeUnselectable(element.childNodes[i]);}}}}else{if(element.style.MozUserSelect!==undefined){element.style.MozUserSelect='none';}else if(element.style.WebkitUserSelect!==undefined){element.style.WebkitUserSelect='none';}else if(element.style.KhtmlUserSelect!==undefined){element.style.KhtmlUserSelect='none';}}}};function updateFixedOffset(){var layer=document.getElementById('edui_fixedlayer');uiUtils.setViewportOffset(layer,{left:0,top:0});}function bindFixedLayer(adjOffset){domUtils.on(window,'scroll',updateFixedOffset);domUtils.on(window,'resize',baidu.editor.utils.defer(updateFixedOffset,0,true));}})();(function(){var utils=baidu.editor.utils,uiUtils=baidu.editor.ui.uiUtils,EventBase=baidu.editor.EventBase,UIBase=baidu.editor.ui.UIBase=function(){};UIBase.prototype={className:'',uiName:'',initOptions:function initOptions(options){var me=this;for(var k in options){me[k]=options[k];}this.id=this.id||'edui'+uiUtils.uid();},initUIBase:function initUIBase(){this._globalKey=utils.unhtml(uiUtils.setGlobal(this.id,this));},render:function render(holder){var html=this.renderHtml();var el=uiUtils.createElementByHtml(html);var list=domUtils.getElementsByTagName(el,"*");var theme="edui-"+(this.theme||this.editor.options.theme);var layer=document.getElementById('edui_fixedlayer');for(var i=0,node;node=list[i++];){domUtils.addClass(node,theme);}domUtils.addClass(el,theme);if(layer){layer.className="";domUtils.addClass(layer,theme);}var seatEl=this.getDom();if(seatEl!=null){seatEl.parentNode.replaceChild(el,seatEl);uiUtils.copyAttributes(el,seatEl);}else{if(typeof holder=='string'){holder=document.getElementById(holder);}holder=holder||uiUtils.getFixedLayer();domUtils.addClass(holder,theme);holder.appendChild(el);}this.postRender();},getDom:function getDom(name){if(!name){return document.getElementById(this.id);}else{return document.getElementById(this.id+'_'+name);}},postRender:function postRender(){this.fireEvent('postrender');},getHtmlTpl:function getHtmlTpl(){return'';},formatHtml:function formatHtml(tpl){var prefix='edui-'+this.uiName;return tpl.replace(/##/g,this.id).replace(/%%-/g,this.uiName?prefix+'-':'').replace(/%%/g,(this.uiName?prefix:'')+' '+this.className).replace(/\$\$/g,this._globalKey);},renderHtml:function renderHtml(){return this.formatHtml(this.getHtmlTpl());},dispose:function dispose(){var box=this.getDom();if(box)baidu.editor.dom.domUtils.remove(box);uiUtils.unsetGlobal(this.id);}};utils.inherits(UIBase,EventBase);})();(function(){var utils=baidu.editor.utils,UIBase=baidu.editor.ui.UIBase,Separator=baidu.editor.ui.Separator=function(options){this.initOptions(options);this.initSeparator();};Separator.prototype={uiName:'separator',initSeparator:function initSeparator(){this.initUIBase();},getHtmlTpl:function getHtmlTpl(){return'<div id="##" class="edui-box %%"></div>';}};utils.inherits(Separator,UIBase);})();(function(){var utils=baidu.editor.utils,domUtils=baidu.editor.dom.domUtils,UIBase=baidu.editor.ui.UIBase,uiUtils=baidu.editor.ui.uiUtils;var Mask=baidu.editor.ui.Mask=function(options){this.initOptions(options);this.initUIBase();};Mask.prototype={getHtmlTpl:function getHtmlTpl(){return'<div id="##" class="edui-mask %%" onclick="return $$._onClick(event, this);" onmousedown="return $$._onMouseDown(event, this);"></div>';},postRender:function postRender(){var me=this;domUtils.on(window,'resize',function(){setTimeout(function(){if(!me.isHidden()){me._fill();}});});},show:function show(zIndex){this._fill();this.getDom().style.display='';this.getDom().style.zIndex=zIndex;},hide:function hide(){this.getDom().style.display='none';this.getDom().style.zIndex='';},isHidden:function isHidden(){return this.getDom().style.display=='none';},_onMouseDown:function _onMouseDown(){return false;},_onClick:function _onClick(e,target){this.fireEvent('click',e,target);},_fill:function _fill(){var el=this.getDom();var vpRect=uiUtils.getViewportRect();el.style.width=vpRect.width+'px';el.style.height=vpRect.height+'px';}};utils.inherits(Mask,UIBase);})();(function(){var utils=baidu.editor.utils,uiUtils=baidu.editor.ui.uiUtils,domUtils=baidu.editor.dom.domUtils,UIBase=baidu.editor.ui.UIBase,Popup=baidu.editor.ui.Popup=function(options){this.initOptions(options);this.initPopup();};var allPopups=[];function closeAllPopup(evt,el){for(var i=0;i<allPopups.length;i++){var pop=allPopups[i];if(!pop.isHidden()){if(pop.queryAutoHide(el)!==false){if(evt&&/scroll/ig.test(evt.type)&&pop.className=="edui-wordpastepop")return;pop.hide();}}}if(allPopups.length)pop.editor.fireEvent("afterhidepop");}Popup.postHide=closeAllPopup;var ANCHOR_CLASSES=['edui-anchor-topleft','edui-anchor-topright','edui-anchor-bottomleft','edui-anchor-bottomright'];Popup.prototype={SHADOW_RADIUS:5,content:null,_hidden:false,autoRender:true,canSideLeft:true,canSideUp:true,initPopup:function initPopup(){this.initUIBase();allPopups.push(this);},getHtmlTpl:function getHtmlTpl(){return'<div id="##" class="edui-popup %%" onmousedown="return false;">'+' <div id="##_body" class="edui-popup-body">'+' <iframe style="position:absolute;z-index:-1;left:0;top:0;background-color: transparent;" frameborder="0" width="100%" height="100%" src="about:blank"></iframe>'+' <div class="edui-shadow"></div>'+' <div id="##_content" class="edui-popup-content">'+this.getContentHtmlTpl()+'  </div>'+' </div>'+'</div>';},getContentHtmlTpl:function getContentHtmlTpl(){if(this.content){if(typeof this.content=='string'){return this.content;}return this.content.renderHtml();}else{return'';}},_UIBase_postRender:UIBase.prototype.postRender,postRender:function postRender(){if(this.content instanceof UIBase){this.content.postRender();}
if(this.captureWheel&&!this.captured){this.captured=true;var winHeight=(document.documentElement.clientHeight||document.body.clientHeight)-80,_height=this.getDom().offsetHeight,_top=uiUtils.getClientRect(this.combox.getDom()).top,content=this.getDom('content'),ifr=this.getDom('body').getElementsByTagName('iframe'),me=this;ifr.length&&(ifr=ifr[0]);while(_top+_height>winHeight){_height-=30;}content.style.height=_height+'px';ifr&&(ifr.style.height=_height+'px');if(window.XMLHttpRequest){domUtils.on(content,'onmousewheel'in document.body?'mousewheel':'DOMMouseScroll',function(e){if(e.preventDefault){e.preventDefault();}else{e.returnValue=false;}if(e.wheelDelta){content.scrollTop-=e.wheelDelta/120*60;}else{content.scrollTop-=e.detail/-3*60;}});}else{domUtils.on(this.getDom(),'mousewheel',function(e){e.returnValue=false;me.getDom('content').scrollTop-=e.wheelDelta/120*60;});}}this.fireEvent('postRenderAfter');this.hide(true);this._UIBase_postRender();},_doAutoRender:function _doAutoRender(){if(!this.getDom()&&this.autoRender){this.render();}},mesureSize:function mesureSize(){var box=this.getDom('content');return uiUtils.getClientRect(box);},fitSize:function fitSize(){if(this.captureWheel&&this.sized){return this.__size;}this.sized=true;var popBodyEl=this.getDom('body');popBodyEl.style.width='';popBodyEl.style.height='';var size=this.mesureSize();if(this.captureWheel){popBodyEl.style.width=-(-20-size.width)+'px';var height=parseInt(this.getDom('content').style.height,10);!window.isNaN(height)&&(size.height=height);}else{popBodyEl.style.width=size.width+'px';}popBodyEl.style.height=size.height+'px';this.__size=size;this.captureWheel&&(this.getDom('content').style.overflow='auto');return size;},showAnchor:function showAnchor(element,hoz){this.showAnchorRect(uiUtils.getClientRect(element),hoz);},showAnchorRect:function showAnchorRect(rect,hoz,adj){this._doAutoRender();var vpRect=uiUtils.getViewportRect();this.getDom().style.visibility='hidden';this._show();var popSize=this.fitSize();var sideLeft,sideUp,left,top;if(hoz){sideLeft=this.canSideLeft&&rect.right+popSize.width>vpRect.right&&rect.left>popSize.width;sideUp=this.canSideUp&&rect.top+popSize.height>vpRect.bottom&&rect.bottom>popSize.height;left=sideLeft?rect.left-popSize.width:rect.right;top=sideUp?rect.bottom-popSize.height:rect.top;}else{sideLeft=this.canSideLeft&&rect.right+popSize.width>vpRect.right&&rect.left>popSize.width;sideUp=this.canSideUp&&rect.top+popSize.height>vpRect.bottom&&rect.bottom>popSize.height;left=sideLeft?rect.right-popSize.width:rect.left;top=sideUp?rect.top-popSize.height:rect.bottom;}var popEl=this.getDom();uiUtils.setViewportOffset(popEl,{left:left,top:top});domUtils.removeClasses(popEl,ANCHOR_CLASSES);popEl.className+=' '+ANCHOR_CLASSES[(sideUp?1:0)*2+(sideLeft?1:0)];if(this.editor){popEl.style.zIndex=this.editor.container.style.zIndex*1+10;baidu.editor.ui.uiUtils.getFixedLayer().style.zIndex=popEl.style.zIndex-1;}this.getDom().style.visibility='visible';},showAt:function showAt(offset){var left=offset.left;var top=offset.top;var rect={left:left,top:top,right:left,bottom:top,height:0,width:0};this.showAnchorRect(rect,false,true);},_show:function _show(){if(this._hidden){var box=this.getDom();box.style.display='';this._hidden=false;this.fireEvent('show');}},isHidden:function isHidden(){return this._hidden;},show:function show(){this._doAutoRender();this._show();},hide:function hide(notNofity){if(!this._hidden&&this.getDom()){this.getDom().style.display='none';this._hidden=true;if(!notNofity){this.fireEvent('hide');}}},queryAutoHide:function queryAutoHide(el){return!el||!uiUtils.contains(this.getDom(),el);}};utils.inherits(Popup,UIBase);domUtils.on(document,'mousedown',function(evt){var el=evt.target||evt.srcElement;closeAllPopup(evt,el);});domUtils.on(window,'scroll',function(evt,el){closeAllPopup(evt,el);});})();(function(){var utils=baidu.editor.utils,UIBase=baidu.editor.ui.UIBase,ColorPicker=baidu.editor.ui.ColorPicker=function(options){this.initOptions(options);this.noColorText=this.noColorText||this.editor.getLang("clearColor");this.initUIBase();};ColorPicker.prototype={getHtmlTpl:function getHtmlTpl(){return genColorPicker(this.noColorText,this.editor);},_onTableClick:function _onTableClick(evt){var tgt=evt.target||evt.srcElement;var color=tgt.getAttribute('data-color');if(color){this.fireEvent('pickcolor',color);}},_onTableOver:function _onTableOver(evt){var tgt=evt.target||evt.srcElement;var color=tgt.getAttribute('data-color');if(color){this.getDom('preview').style.backgroundColor=color;}},_onTableOut:function _onTableOut(){this.getDom('preview').style.backgroundColor='';},_onPickNoColor:function _onPickNoColor(){this.fireEvent('picknocolor');}};utils.inherits(ColorPicker,UIBase);var COLORS=('ffffff,000000,eeece1,1f497d,4f81bd,c0504d,9bbb59,8064a2,4bacc6,f79646,'+'f2f2f2,7f7f7f,ddd9c3,c6d9f0,dbe5f1,f2dcdb,ebf1dd,e5e0ec,dbeef3,fdeada,'+'d8d8d8,595959,c4bd97,8db3e2,b8cce4,e5b9b7,d7e3bc,ccc1d9,b7dde8,fbd5b5,'+'bfbfbf,3f3f3f,938953,548dd4,95b3d7,d99694,c3d69b,b2a2c7,92cddc,fac08f,'+'a5a5a5,262626,494429,17365d,366092,953734,76923c,5f497a,31859b,e36c09,'+'7f7f7f,0c0c0c,1d1b10,0f243e,244061,632423,4f6128,3f3151,205867,974806,'+'c00000,ff0000,ffc000,ffff00,92d050,00b050,00b0f0,0070c0,002060,7030a0,').split(',');function genColorPicker(noColorText,editor){var html='<div id="##" class="edui-colorpicker %%">'+'<div class="edui-colorpicker-topbar edui-clearfix">'+'<div unselectable="on" id="##_preview" class="edui-colorpicker-preview"></div>'+'<div unselectable="on" class="edui-colorpicker-nocolor" onclick="$$._onPickNoColor(event, this);">'+noColorText+'</div>'+'</div>'+'<table  class="edui-box" style="border-collapse: collapse;" onmouseover="$$._onTableOver(event, this);" onmouseout="$$._onTableOut(event, this);" onclick="return $$._onTableClick(event, this);" cellspacing="0" cellpadding="0">'+'<tr style="border-bottom: 1px solid #ddd;font-size: 13px;line-height: 25px;color:#39C;padding-top: 2px"><td colspan="10">'+editor.getLang("themeColor")+'</td> </tr>'+'<tr class="edui-colorpicker-tablefirstrow" >';for(var i=0;i<COLORS.length;i++){if(i&&i%10===0){html+='</tr>'+(i==60?'<tr style="border-bottom: 1px solid #ddd;font-size: 13px;line-height: 25px;color:#39C;"><td colspan="10">'+editor.getLang("standardColor")+'</td></tr>':'')+'<tr'+(i==60?' class="edui-colorpicker-tablefirstrow"':'')+'>';}html+=i<70?'<td style="padding: 0 2px;"><a hidefocus title="'+COLORS[i]+'" onclick="return false;" href="javascript:" unselectable="on" class="edui-box edui-colorpicker-colorcell"'+' data-color="#'+COLORS[i]+'"'+' style="background-color:#'+COLORS[i]+';border:solid #ccc;'+(i<10||i>=60?'border-width:1px;':i>=10&&i<20?'border-width:1px 1px 0 1px;':'border-width:0 1px 0 1px;')+'"'+'></a></td>':'';}html+='</tr></table></div>';return html;}})();(function(){var utils=baidu.editor.utils,uiUtils=baidu.editor.ui.uiUtils,UIBase=baidu.editor.ui.UIBase;var TablePicker=baidu.editor.ui.TablePicker=function(options){this.initOptions(options);this.initTablePicker();};TablePicker.prototype={defaultNumRows:10,defaultNumCols:10,maxNumRows:20,maxNumCols:20,numRows:10,numCols:10,lengthOfCellSide:22,initTablePicker:function initTablePicker(){this.initUIBase();},getHtmlTpl:function getHtmlTpl(){var me=this;return'<div id="##" class="edui-tablepicker %%">'+'<div class="edui-tablepicker-body">'+'<div class="edui-infoarea">'+'<span id="##_label" class="edui-label"></span>'+'</div>'+'<div class="edui-pickarea"'+' onmousemove="$$._onMouseMove(event, this);"'+' onmouseover="$$._onMouseOver(event, this);"'+' onmouseout="$$._onMouseOut(event, this);"'+' onclick="$$._onClick(event, this);"'+'>'+'<div id="##_overlay" class="edui-overlay"></div>'+'</div>'+'</div>'+'</div>';},_UIBase_render:UIBase.prototype.render,render:function render(holder){this._UIBase_render(holder);this.getDom('label').innerHTML='0'+this.editor.getLang("t_row")+' x 0'+this.editor.getLang("t_col");},_track:function _track(numCols,numRows){var style=this.getDom('overlay').style;var sideLen=this.lengthOfCellSide;style.width=numCols*sideLen+'px';style.height=numRows*sideLen+'px';var label=this.getDom('label');label.innerHTML=numCols+this.editor.getLang("t_col")+' x '+numRows+this.editor.getLang("t_row");this.numCols=numCols;this.numRows=numRows;},_onMouseOver:function _onMouseOver(evt,el){var rel=evt.relatedTarget||evt.fromElement;if(!uiUtils.contains(el,rel)&&el!==rel){this.getDom('label').innerHTML='0'+this.editor.getLang("t_col")+' x 0'+this.editor.getLang("t_row");this.getDom('overlay').style.visibility='';}},_onMouseOut:function _onMouseOut(evt,el){var rel=evt.relatedTarget||evt.toElement;if(!uiUtils.contains(el,rel)&&el!==rel){this.getDom('label').innerHTML='0'+this.editor.getLang("t_col")+' x 0'+this.editor.getLang("t_row");this.getDom('overlay').style.visibility='hidden';}},_onMouseMove:function _onMouseMove(evt,el){var style=this.getDom('overlay').style;var offset=uiUtils.getEventOffset(evt);var sideLen=this.lengthOfCellSide;var numCols=Math.ceil(offset.left/sideLen);var numRows=Math.ceil(offset.top/sideLen);this._track(numCols,numRows);},_onClick:function _onClick(){this.fireEvent('picktable',this.numCols,this.numRows);}};utils.inherits(TablePicker,UIBase);})();(function(){var browser=baidu.editor.browser,domUtils=baidu.editor.dom.domUtils,uiUtils=baidu.editor.ui.uiUtils;var TPL_STATEFUL='onmousedown="$$.Stateful_onMouseDown(event, this);"'+' onmouseup="$$.Stateful_onMouseUp(event, this);"'+(browser.ie?' onmouseenter="$$.Stateful_onMouseEnter(event, this);"'+' onmouseleave="$$.Stateful_onMouseLeave(event, this);"':' onmouseover="$$.Stateful_onMouseOver(event, this);"'+' onmouseout="$$.Stateful_onMouseOut(event, this);"');baidu.editor.ui.Stateful={alwalysHoverable:false,target:null,Stateful_init:function Stateful_init(){this._Stateful_dGetHtmlTpl=this.getHtmlTpl;this.getHtmlTpl=this.Stateful_getHtmlTpl;},Stateful_getHtmlTpl:function Stateful_getHtmlTpl(){var tpl=this._Stateful_dGetHtmlTpl();return tpl.replace(/stateful/g,function(){return TPL_STATEFUL;});},Stateful_onMouseEnter:function Stateful_onMouseEnter(evt,el){this.target=el;if(!this.isDisabled()||this.alwalysHoverable){this.addState('hover');this.fireEvent('over');}},Stateful_onMouseLeave:function Stateful_onMouseLeave(evt,el){if(!this.isDisabled()||this.alwalysHoverable){this.removeState('hover');this.removeState('active');this.fireEvent('out');}},Stateful_onMouseOver:function Stateful_onMouseOver(evt,el){var rel=evt.relatedTarget;if(!uiUtils.contains(el,rel)&&el!==rel){this.Stateful_onMouseEnter(evt,el);}},Stateful_onMouseOut:function Stateful_onMouseOut(evt,el){var rel=evt.relatedTarget;if(!uiUtils.contains(el,rel)&&el!==rel){this.Stateful_onMouseLeave(evt,el);}},Stateful_onMouseDown:function Stateful_onMouseDown(evt,el){if(!this.isDisabled()){this.addState('active');}},Stateful_onMouseUp:function Stateful_onMouseUp(evt,el){if(!this.isDisabled()){this.removeState('active');}},Stateful_postRender:function Stateful_postRender(){if(this.disabled&&!this.hasState('disabled')){this.addState('disabled');}},hasState:function hasState(state){return domUtils.hasClass(this.getStateDom(),'edui-state-'+state);},addState:function addState(state){if(!this.hasState(state)){this.getStateDom().className+=' edui-state-'+state;}},removeState:function removeState(state){if(this.hasState(state)){domUtils.removeClasses(this.getStateDom(),['edui-state-'+state]);}},getStateDom:function getStateDom(){return this.getDom('state');},isChecked:function isChecked(){return this.hasState('checked');},setChecked:function setChecked(checked){if(!this.isDisabled()&&checked){this.addState('checked');}else{this.removeState('checked');}},isDisabled:function isDisabled(){return this.hasState('disabled');},setDisabled:function setDisabled(disabled){if(disabled){this.removeState('hover');this.removeState('checked');this.removeState('active');this.addState('disabled');}else{this.removeState('disabled');}}};})();(function(){var utils=baidu.editor.utils,UIBase=baidu.editor.ui.UIBase,Stateful=baidu.editor.ui.Stateful,Button=baidu.editor.ui.Button=function(options){if(options.name){var btnName=options.name;var cssRules=options.cssRules;if(!options.className){options.className='edui-for-'+btnName;}options.cssRules='.edui-default  .edui-for-'+btnName+' .edui-icon {'+cssRules+'}';}this.initOptions(options);this.initButton();};Button.prototype={uiName:'button',label:'',title:'',showIcon:true,showText:true,cssRules:'',initButton:function initButton(){this.initUIBase();this.Stateful_init();if(this.cssRules){utils.cssRule('edui-customize-'+this.name+'-style',this.cssRules);}},getHtmlTpl:function getHtmlTpl(){return'<div id="##" class="edui-box %%">'+'<div id="##_state" stateful>'+'<div class="%%-wrap"><div id="##_body" unselectable="on" '+(this.title?'title="'+this.title+'"':'')+' class="%%-body" onmousedown="return $$._onMouseDown(event, this);" onclick="return $$._onClick(event, this);">'+(this.showIcon?'<div class="edui-box edui-icon"></div>':'')+(this.showText?'<div class="edui-box edui-label">'+this.label+'</div>':'')+'</div>'+'</div>'+'</div></div>';},postRender:function postRender(){this.Stateful_postRender();this.setDisabled(this.disabled);},_onMouseDown:function _onMouseDown(e){var target=e.target||e.srcElement,tagName=target&&target.tagName&&target.tagName.toLowerCase();if(tagName=='input'||tagName=='object'||tagName=='object'){return false;}},_onClick:function _onClick(){if(!this.isDisabled()){this.fireEvent('click');}},setTitle:function setTitle(text){var label=this.getDom('label');label.innerHTML=text;}};utils.inherits(Button,UIBase);utils.extend(Button.prototype,Stateful);})();(function(){var utils=baidu.editor.utils,uiUtils=baidu.editor.ui.uiUtils,domUtils=baidu.editor.dom.domUtils,UIBase=baidu.editor.ui.UIBase,Stateful=baidu.editor.ui.Stateful,SplitButton=baidu.editor.ui.SplitButton=function(options){this.initOptions(options);this.initSplitButton();};SplitButton.prototype={popup:null,uiName:'splitbutton',title:'',initSplitButton:function initSplitButton(){this.initUIBase();this.Stateful_init();var me=this;if(this.popup!=null){var popup=this.popup;this.popup=null;this.setPopup(popup);}},_UIBase_postRender:UIBase.prototype.postRender,postRender:function postRender(){this.Stateful_postRender();this._UIBase_postRender();},setPopup:function setPopup(popup){if(this.popup===popup)return;if(this.popup!=null){this.popup.dispose();}popup.addListener('show',utils.bind(this._onPopupShow,this));popup.addListener('hide',utils.bind(this._onPopupHide,this));popup.addListener('postrender',utils.bind(function(){popup.getDom('body').appendChild(uiUtils.createElementByHtml('<div id="'+this.popup.id+'_bordereraser" class="edui-bordereraser edui-background" style="width:'+(uiUtils.getClientRect(this.getDom()).width+20)+'px"></div>'));popup.getDom().className+=' '+this.className;},this));this.popup=popup;},_onPopupShow:function _onPopupShow(){this.addState('opened');},_onPopupHide:function _onPopupHide(){this.removeState('opened');},getHtmlTpl:function getHtmlTpl(){return'<div id="##" class="edui-box %%">'+'<div '+(this.title?'title="'+this.title+'"':'')+' id="##_state" stateful><div class="%%-body">'+'<div id="##_button_body" class="edui-box edui-button-body" onclick="$$._onButtonClick(event, this);">'+'<div class="edui-box edui-icon"></div>'+'</div>'+'<div class="edui-box edui-splitborder"></div>'+'<div class="edui-box edui-arrow" onclick="$$._onArrowClick();"></div>'+'</div></div></div>';},showPopup:function showPopup(){var rect=uiUtils.getClientRect(this.getDom());rect.top-=this.popup.SHADOW_RADIUS;rect.height+=this.popup.SHADOW_RADIUS;this.popup.showAnchorRect(rect);},_onArrowClick:function _onArrowClick(event,el){if(!this.isDisabled()){this.showPopup();}},_onButtonClick:function _onButtonClick(){if(!this.isDisabled()){this.fireEvent('buttonclick');}}};utils.inherits(SplitButton,UIBase);utils.extend(SplitButton.prototype,Stateful,true);})();(function(){var utils=baidu.editor.utils,uiUtils=baidu.editor.ui.uiUtils,ColorPicker=baidu.editor.ui.ColorPicker,Popup=baidu.editor.ui.Popup,SplitButton=baidu.editor.ui.SplitButton,ColorButton=baidu.editor.ui.ColorButton=function(options){this.initOptions(options);this.initColorButton();};ColorButton.prototype={initColorButton:function initColorButton(){var me=this;this.popup=new Popup({content:new ColorPicker({noColorText:me.editor.getLang("clearColor"),editor:me.editor,onpickcolor:function onpickcolor(t,color){me._onPickColor(color);},onpicknocolor:function onpicknocolor(t,color){me._onPickNoColor(color);}}),editor:me.editor});this.initSplitButton();},_SplitButton_postRender:SplitButton.prototype.postRender,postRender:function postRender(){this._SplitButton_postRender();this.getDom('button_body').appendChild(uiUtils.createElementByHtml('<div id="'+this.id+'_colorlump" class="edui-colorlump"></div>'));this.getDom().className+=' edui-colorbutton';},setColor:function setColor(color){this.getDom('colorlump').style.backgroundColor=color;this.color=color;},_onPickColor:function _onPickColor(color){if(this.fireEvent('pickcolor',color)!==false){this.setColor(color);this.popup.hide();}},_onPickNoColor:function _onPickNoColor(color){if(this.fireEvent('picknocolor')!==false){this.popup.hide();}}};utils.inherits(ColorButton,SplitButton);})();(function(){var utils=baidu.editor.utils,Popup=baidu.editor.ui.Popup,TablePicker=baidu.editor.ui.TablePicker,SplitButton=baidu.editor.ui.SplitButton,TableButton=baidu.editor.ui.TableButton=function(options){this.initOptions(options);this.initTableButton();};TableButton.prototype={initTableButton:function initTableButton(){var me=this;this.popup=new Popup({content:new TablePicker({editor:me.editor,onpicktable:function onpicktable(t,numCols,numRows){me._onPickTable(numCols,numRows);}}),'editor':me.editor});this.initSplitButton();},_onPickTable:function _onPickTable(numCols,numRows){if(this.fireEvent('picktable',numCols,numRows)!==false){this.popup.hide();}}};utils.inherits(TableButton,SplitButton);})();(function(){var utils=baidu.editor.utils,UIBase=baidu.editor.ui.UIBase;var AutoTypeSetPicker=baidu.editor.ui.AutoTypeSetPicker=function(options){this.initOptions(options);this.initAutoTypeSetPicker();};AutoTypeSetPicker.prototype={initAutoTypeSetPicker:function initAutoTypeSetPicker(){this.initUIBase();},getHtmlTpl:function getHtmlTpl(){var me=this.editor,opt=me.options.autotypeset,lang=me.getLang("autoTypeSet");var textAlignInputName='textAlignValue'+me.uid,imageBlockInputName='imageBlockLineValue'+me.uid,symbolConverInputName='symbolConverValue'+me.uid;return'<div id="##" class="edui-autotypesetpicker %%">'+'<div class="edui-autotypesetpicker-body">'+'<table >'+'<tr><td nowrap><input type="checkbox" name="mergeEmptyline" '+(opt["mergeEmptyline"]?"checked":"")+'>'+lang.mergeLine+'</td><td colspan="2"><input type="checkbox" name="removeEmptyline" '+(opt["removeEmptyline"]?"checked":"")+'>'+lang.delLine+'</td></tr>'+'<tr><td nowrap><input type="checkbox" name="removeClass" '+(opt["removeClass"]?"checked":"")+'>'+lang.removeFormat+'</td><td colspan="2"><input type="checkbox" name="indent" '+(opt["indent"]?"checked":"")+'>'+lang.indent+'</td></tr>'+'<tr>'+'<td nowrap><input type="checkbox" name="textAlign" '+(opt["textAlign"]?"checked":"")+'>'+lang.alignment+'</td>'+'<td colspan="2" id="'+textAlignInputName+'">'+'<input type="radio" name="'+textAlignInputName+'" value="left" '+(opt["textAlign"]&&opt["textAlign"]=="left"?"checked":"")+'>'+me.getLang("justifyleft")+'<input type="radio" name="'+textAlignInputName+'" value="center" '+(opt["textAlign"]&&opt["textAlign"]=="center"?"checked":"")+'>'+me.getLang("justifycenter")+'<input type="radio" name="'+textAlignInputName+'" value="right" '+(opt["textAlign"]&&opt["textAlign"]=="right"?"checked":"")+'>'+me.getLang("justifyright")+'</td>'+'</tr>'+'<tr>'+'<td nowrap><input type="checkbox" name="imageBlockLine" '+(opt["imageBlockLine"]?"checked":"")+'>'+lang.imageFloat+'</td>'+'<td nowrap id="'+imageBlockInputName+'">'+'<input type="radio" name="'+imageBlockInputName+'" value="none" '+(opt["imageBlockLine"]&&opt["imageBlockLine"]=="none"?"checked":"")+'>'+me.getLang("default")+'<input type="radio" name="'+imageBlockInputName+'" value="left" '+(opt["imageBlockLine"]&&opt["imageBlockLine"]=="left"?"checked":"")+'>'+me.getLang("justifyleft")+'<input type="radio" name="'+imageBlockInputName+'" value="center" '+(opt["imageBlockLine"]&&opt["imageBlockLine"]=="center"?"checked":"")+'>'+me.getLang("justifycenter")+'<input type="radio" name="'+imageBlockInputName+'" value="right" '+(opt["imageBlockLine"]&&opt["imageBlockLine"]=="right"?"checked":"")+'>'+me.getLang("justifyright")+'</td>'+'</tr>'+'<tr><td nowrap><input type="checkbox" name="clearFontSize" '+(opt["clearFontSize"]?"checked":"")+'>'+lang.removeFontsize+'</td><td colspan="2"><input type="checkbox" name="clearFontFamily" '+(opt["clearFontFamily"]?"checked":"")+'>'+lang.removeFontFamily+'</td></tr>'+'<tr><td nowrap colspan="3"><input type="checkbox" name="removeEmptyNode" '+(opt["removeEmptyNode"]?"checked":"")+'>'+lang.removeHtml+'</td></tr>'+'<tr><td nowrap colspan="3"><input type="checkbox" name="pasteFilter" '+(opt["pasteFilter"]?"checked":"")+'>'+lang.pasteFilter+'</td></tr>'+'<tr>'+'<td nowrap><input type="checkbox" name="symbolConver" '+(opt["bdc2sb"]||opt["tobdc"]?"checked":"")+'>'+lang.symbol+'</td>'+'<td id="'+symbolConverInputName+'">'+'<input type="radio" name="bdc" value="bdc2sb" '+(opt["bdc2sb"]?"checked":"")+'>'+lang.bdc2sb+'<input type="radio" name="bdc" value="tobdc" '+(opt["tobdc"]?"checked":"")+'>'+lang.tobdc+''+'</td>'+'<td nowrap align="right"><button >'+lang.run+'</button></td>'+'</tr>'+'</table>'+'</div>'+'</div>';},_UIBase_render:UIBase.prototype.render};utils.inherits(AutoTypeSetPicker,UIBase);})();(function(){var utils=baidu.editor.utils,Popup=baidu.editor.ui.Popup,AutoTypeSetPicker=baidu.editor.ui.AutoTypeSetPicker,SplitButton=baidu.editor.ui.SplitButton,AutoTypeSetButton=baidu.editor.ui.AutoTypeSetButton=function(options){this.initOptions(options);this.initAutoTypeSetButton();};function getPara(me){var opt={},cont=me.getDom(),editorId=me.editor.uid,inputType=null,attrName=null,ipts=domUtils.getElementsByTagName(cont,"input");for(var i=ipts.length-1,ipt;ipt=ipts[i--];){inputType=ipt.getAttribute("type");if(inputType=="checkbox"){attrName=ipt.getAttribute("name");opt[attrName]&&delete opt[attrName];if(ipt.checked){var attrValue=document.getElementById(attrName+"Value"+editorId);if(attrValue){if(/input/ig.test(attrValue.tagName)){opt[attrName]=attrValue.value;}else{var iptChilds=attrValue.getElementsByTagName("input");for(var j=iptChilds.length-1,iptchild;iptchild=iptChilds[j--];){if(iptchild.checked){opt[attrName]=iptchild.value;break;}}}}else{opt[attrName]=true;}}else{opt[attrName]=false;}}else{opt[ipt.getAttribute("value")]=ipt.checked;}}var selects=domUtils.getElementsByTagName(cont,"select");for(var i=0,si;si=selects[i++];){var attr=si.getAttribute('name');opt[attr]=opt[attr]?si.value:'';}utils.extend(me.editor.options.autotypeset,opt);me.editor.setPreferences('autotypeset',opt);}AutoTypeSetButton.prototype={initAutoTypeSetButton:function initAutoTypeSetButton(){var me=this;this.popup=new Popup({content:new AutoTypeSetPicker({editor:me.editor}),'editor':me.editor,hide:function hide(){if(!this._hidden&&this.getDom()){getPara(this);this.getDom().style.display='none';this._hidden=true;this.fireEvent('hide');}}});var flag=0;this.popup.addListener('postRenderAfter',function(){var popupUI=this;if(flag)return;var cont=this.getDom(),btn=cont.getElementsByTagName('button')[0];btn.onclick=function(){getPara(popupUI);me.editor.execCommand('autotypeset');popupUI.hide();};domUtils.on(cont,'click',function(e){var target=e.target||e.srcElement,editorId=me.editor.uid;if(target&&target.tagName=='INPUT'){if(target.name=='imageBlockLine'||target.name=='textAlign'||target.name=='symbolConver'){var checked=target.checked,radioTd=document.getElementById(target.name+'Value'+editorId),radios=radioTd.getElementsByTagName('input'),defalutSelect={'imageBlockLine':'none','textAlign':'left','symbolConver':'tobdc'};for(var i=0;i<radios.length;i++){if(checked){if(radios[i].value==defalutSelect[target.name]){radios[i].checked='checked';}}else{radios[i].checked=false;}}}
if(target.name=='imageBlockLineValue'+editorId||target.name=='textAlignValue'+editorId||target.name=='bdc'){var checkboxs=target.parentNode.previousSibling.getElementsByTagName('input');checkboxs&&(checkboxs[0].checked=true);}getPara(popupUI);}});flag=1;});this.initSplitButton();}};utils.inherits(AutoTypeSetButton,SplitButton);})();(function(){var utils=baidu.editor.utils,Popup=baidu.editor.ui.Popup,Stateful=baidu.editor.ui.Stateful,UIBase=baidu.editor.ui.UIBase;var CellAlignPicker=baidu.editor.ui.CellAlignPicker=function(options){this.initOptions(options);this.initSelected();this.initCellAlignPicker();};CellAlignPicker.prototype={initSelected:function initSelected(){var status={valign:{top:0,middle:1,bottom:2},align:{left:0,center:1,right:2},count:3},result=-1;if(this.selected){this.selectedIndex=status.valign[this.selected.valign]*status.count+status.align[this.selected.align];}},initCellAlignPicker:function initCellAlignPicker(){this.initUIBase();this.Stateful_init();},getHtmlTpl:function getHtmlTpl(){var alignType=['left','center','right'],COUNT=9,tempClassName=null,tempIndex=-1,tmpl=[];for(var i=0;i<COUNT;i++){tempClassName=this.selectedIndex===i?' class="edui-cellalign-selected" ':'';tempIndex=i%3;tempIndex===0&&tmpl.push('<tr>');tmpl.push('<td index="'+i+'" '+tempClassName+' stateful><div class="edui-icon edui-'+alignType[tempIndex]+'"></div></td>');tempIndex===2&&tmpl.push('</tr>');}return'<div id="##" class="edui-cellalignpicker %%">'+'<div class="edui-cellalignpicker-body">'+'<table onclick="$$._onClick(event);">'+tmpl.join('')+'</table>'+'</div>'+'</div>';},getStateDom:function getStateDom(){return this.target;},_onClick:function _onClick(evt){var target=evt.target||evt.srcElement;if(/icon/.test(target.className)){this.items[target.parentNode.getAttribute("index")].onclick();Popup.postHide(evt);}},_UIBase_render:UIBase.prototype.render};utils.inherits(CellAlignPicker,UIBase);utils.extend(CellAlignPicker.prototype,Stateful,true);})();(function(){var utils=baidu.editor.utils,Stateful=baidu.editor.ui.Stateful,uiUtils=baidu.editor.ui.uiUtils,UIBase=baidu.editor.ui.UIBase;var PastePicker=baidu.editor.ui.PastePicker=function(options){this.initOptions(options);this.initPastePicker();};PastePicker.prototype={initPastePicker:function initPastePicker(){this.initUIBase();this.Stateful_init();},getHtmlTpl:function getHtmlTpl(){return'<div class="edui-pasteicon" onclick="$$._onClick(this)"></div>'+'<div class="edui-pastecontainer">'+'<div class="edui-title">'+this.editor.getLang("pasteOpt")+'</div>'+'<div class="edui-button">'+'<div title="'+this.editor.getLang("pasteSourceFormat")+'" onclick="$$.format(false)" stateful>'+'<div class="edui-richtxticon"></div></div>'+'<div title="'+this.editor.getLang("tagFormat")+'" onclick="$$.format(2)" stateful>'+'<div class="edui-tagicon"></div></div>'+'<div title="'+this.editor.getLang("pasteTextFormat")+'" onclick="$$.format(true)" stateful>'+'<div class="edui-plaintxticon"></div></div>'+'</div>'+'</div>'+'</div>';},getStateDom:function getStateDom(){return this.target;},format:function format(param){this.editor.ui._isTransfer=true;this.editor.fireEvent('pasteTransfer',param);},_onClick:function _onClick(cur){var node=domUtils.getNextDomNode(cur),screenHt=uiUtils.getViewportRect().height,subPop=uiUtils.getClientRect(node);if(subPop.top+subPop.height>screenHt)node.style.top=-subPop.height-cur.offsetHeight+"px";else node.style.top="";if(/hidden/ig.test(domUtils.getComputedStyle(node,"visibility"))){node.style.visibility="visible";domUtils.addClass(cur,"edui-state-opened");}else{node.style.visibility="hidden";domUtils.removeClasses(cur,"edui-state-opened");}},_UIBase_render:UIBase.prototype.render};utils.inherits(PastePicker,UIBase);utils.extend(PastePicker.prototype,Stateful,true);})();(function(){var utils=baidu.editor.utils,uiUtils=baidu.editor.ui.uiUtils,UIBase=baidu.editor.ui.UIBase,Toolbar=baidu.editor.ui.Toolbar=function(options){this.initOptions(options);this.initToolbar();};Toolbar.prototype={items:null,initToolbar:function initToolbar(){this.items=this.items||[];this.initUIBase();},add:function add(item,index){if(index===undefined){this.items.push(item);}else{this.items.splice(index,0,item);}},getHtmlTpl:function getHtmlTpl(){var buff=[];for(var i=0;i<this.items.length;i++){buff[i]=this.items[i].renderHtml();}return'<div id="##" class="edui-toolbar %%" onselectstart="return false;" onmousedown="return $$._onMouseDown(event, this);">'+buff.join('')+'</div>';},postRender:function postRender(){var box=this.getDom();for(var i=0;i<this.items.length;i++){this.items[i].postRender();}uiUtils.makeUnselectable(box);},_onMouseDown:function _onMouseDown(e){var target=e.target||e.srcElement,tagName=target&&target.tagName&&target.tagName.toLowerCase();if(tagName=='input'||tagName=='object'||tagName=='object'){return false;}}};utils.inherits(Toolbar,UIBase);})();(function(){var utils=baidu.editor.utils,domUtils=baidu.editor.dom.domUtils,uiUtils=baidu.editor.ui.uiUtils,UIBase=baidu.editor.ui.UIBase,Popup=baidu.editor.ui.Popup,Stateful=baidu.editor.ui.Stateful,CellAlignPicker=baidu.editor.ui.CellAlignPicker,Menu=baidu.editor.ui.Menu=function(options){this.initOptions(options);this.initMenu();};var menuSeparator={renderHtml:function renderHtml(){return'<div class="edui-menuitem edui-menuseparator"><div class="edui-menuseparator-inner"></div></div>';},postRender:function postRender(){},queryAutoHide:function queryAutoHide(){return true;}};Menu.prototype={items:null,uiName:'menu',initMenu:function initMenu(){this.items=this.items||[];this.initPopup();this.initItems();},initItems:function initItems(){for(var i=0;i<this.items.length;i++){var item=this.items[i];if(item=='-'){this.items[i]=this.getSeparator();}else if(!(item instanceof MenuItem)){item.editor=this.editor;item.theme=this.editor.options.theme;this.items[i]=this.createItem(item);}}},getSeparator:function getSeparator(){return menuSeparator;},createItem:function createItem(item){item.menu=this;return new MenuItem(item);},_Popup_getContentHtmlTpl:Popup.prototype.getContentHtmlTpl,getContentHtmlTpl:function getContentHtmlTpl(){if(this.items.length==0){return this._Popup_getContentHtmlTpl();}var buff=[];for(var i=0;i<this.items.length;i++){var item=this.items[i];buff[i]=item.renderHtml();}return'<div class="%%-body">'+buff.join('')+'</div>';},_Popup_postRender:Popup.prototype.postRender,postRender:function postRender(){var me=this;for(var i=0;i<this.items.length;i++){var item=this.items[i];item.ownerMenu=this;item.postRender();}domUtils.on(this.getDom(),'mouseover',function(evt){evt=evt||event;var rel=evt.relatedTarget||evt.fromElement;var el=me.getDom();if(!uiUtils.contains(el,rel)&&el!==rel){me.fireEvent('over');}});this._Popup_postRender();},queryAutoHide:function queryAutoHide(el){if(el){if(uiUtils.contains(this.getDom(),el)){return false;}for(var i=0;i<this.items.length;i++){var item=this.items[i];if(item.queryAutoHide(el)===false){return false;}}}},clearItems:function clearItems(){for(var i=0;i<this.items.length;i++){var item=this.items[i];clearTimeout(item._showingTimer);clearTimeout(item._closingTimer);if(item.subMenu){item.subMenu.destroy();}}this.items=[];},destroy:function destroy(){if(this.getDom()){domUtils.remove(this.getDom());}this.clearItems();},dispose:function dispose(){this.destroy();}};utils.inherits(Menu,Popup);var MenuItem=baidu.editor.ui.MenuItem=function(options){this.initOptions(options);this.initUIBase();this.Stateful_init();if(this.subMenu&&!(this.subMenu instanceof Menu)){if(options.className&&options.className.indexOf("aligntd")!=-1){var me=this;this.subMenu.selected=this.editor.queryCommandValue('cellalignment');this.subMenu=new Popup({content:new CellAlignPicker(this.subMenu),parentMenu:me,editor:me.editor,destroy:function destroy(){if(this.getDom()){domUtils.remove(this.getDom());}}});this.subMenu.addListener("postRenderAfter",function(){domUtils.on(this.getDom(),"mouseover",function(){me.addState('opened');});});}else{this.subMenu=new Menu(this.subMenu);}}};MenuItem.prototype={label:'',subMenu:null,ownerMenu:null,uiName:'menuitem',alwalysHoverable:true,getHtmlTpl:function getHtmlTpl(){return'<div id="##" class="%%" stateful onclick="$$._onClick(event, this);">'+'<div class="%%-body">'+this.renderLabelHtml()+'</div>'+'</div>';},postRender:function postRender(){var me=this;this.addListener('over',function(){me.ownerMenu.fireEvent('submenuover',me);if(me.subMenu){me.delayShowSubMenu();}});if(this.subMenu){this.getDom().className+=' edui-hassubmenu';this.subMenu.render();this.addListener('out',function(){me.delayHideSubMenu();});this.subMenu.addListener('over',function(){clearTimeout(me._closingTimer);me._closingTimer=null;me.addState('opened');});this.ownerMenu.addListener('hide',function(){me.hideSubMenu();});this.ownerMenu.addListener('submenuover',function(t,subMenu){if(subMenu!==me){me.delayHideSubMenu();}});this.subMenu._bakQueryAutoHide=this.subMenu.queryAutoHide;this.subMenu.queryAutoHide=function(el){if(el&&uiUtils.contains(me.getDom(),el)){return false;}return this._bakQueryAutoHide(el);};}this.getDom().style.tabIndex='-1';uiUtils.makeUnselectable(this.getDom());this.Stateful_postRender();},delayShowSubMenu:function delayShowSubMenu(){var me=this;if(!me.isDisabled()){me.addState('opened');clearTimeout(me._showingTimer);clearTimeout(me._closingTimer);me._closingTimer=null;me._showingTimer=setTimeout(function(){me.showSubMenu();},250);}},delayHideSubMenu:function delayHideSubMenu(){var me=this;if(!me.isDisabled()){me.removeState('opened');clearTimeout(me._showingTimer);if(!me._closingTimer){me._closingTimer=setTimeout(function(){if(!me.hasState('opened')){me.hideSubMenu();}me._closingTimer=null;},400);}}},renderLabelHtml:function renderLabelHtml(){return'<div class="edui-arrow"></div>'+'<div class="edui-box edui-icon"></div>'+'<div class="edui-box edui-label %%-label">'+(this.label||'')+'</div>';},getStateDom:function getStateDom(){return this.getDom();},queryAutoHide:function queryAutoHide(el){if(this.subMenu&&this.hasState('opened')){return this.subMenu.queryAutoHide(el);}},_onClick:function _onClick(event,this_){if(this.hasState('disabled'))return;if(this.fireEvent('click',event,this_)!==false){if(this.subMenu){this.showSubMenu();}else{Popup.postHide(event);}}},showSubMenu:function showSubMenu(){var rect=uiUtils.getClientRect(this.getDom());rect.right-=5;rect.left+=2;rect.width-=7;rect.top-=4;rect.bottom+=4;rect.height+=8;this.subMenu.showAnchorRect(rect,true,true);},hideSubMenu:function hideSubMenu(){this.subMenu.hide();}};utils.inherits(MenuItem,UIBase);utils.extend(MenuItem.prototype,Stateful,true);})();(function(){var utils=baidu.editor.utils,uiUtils=baidu.editor.ui.uiUtils,Menu=baidu.editor.ui.Menu,SplitButton=baidu.editor.ui.SplitButton,Combox=baidu.editor.ui.Combox=function(options){this.initOptions(options);this.initCombox();};Combox.prototype={uiName:'combox',onbuttonclick:function onbuttonclick(){this.showPopup();},initCombox:function initCombox(){var me=this;this.items=this.items||[];for(var i=0;i<this.items.length;i++){var item=this.items[i];item.uiName='listitem';item.index=i;item.onclick=function(){me.selectByIndex(this.index);};}this.popup=new Menu({items:this.items,uiName:'list',editor:this.editor,captureWheel:true,combox:this});this.initSplitButton();},_SplitButton_postRender:SplitButton.prototype.postRender,postRender:function postRender(){this._SplitButton_postRender();this.setLabel(this.label||'');this.setValue(this.initValue||'');},showPopup:function showPopup(){var rect=uiUtils.getClientRect(this.getDom());rect.top+=1;rect.bottom-=1;rect.height-=2;this.popup.showAnchorRect(rect);},getValue:function getValue(){return this.value;},setValue:function setValue(value){var index=this.indexByValue(value);if(index!=-1){this.selectedIndex=index;this.setLabel(this.items[index].label);this.value=this.items[index].value;}else{this.selectedIndex=-1;this.setLabel(this.getLabelForUnknowValue(value));this.value=value;}},setLabel:function setLabel(label){this.getDom('button_body').innerHTML=label;this.label=label;},getLabelForUnknowValue:function getLabelForUnknowValue(value){return value;},indexByValue:function indexByValue(value){for(var i=0;i<this.items.length;i++){if(value==this.items[i].value){return i;}}return-1;},getItem:function getItem(index){return this.items[index];},selectByIndex:function selectByIndex(index){if(index<this.items.length&&this.fireEvent('select',index)!==false){this.selectedIndex=index;this.value=this.items[index].value;this.setLabel(this.items[index].label);}}};utils.inherits(Combox,SplitButton);})();(function(){var utils=baidu.editor.utils,domUtils=baidu.editor.dom.domUtils,uiUtils=baidu.editor.ui.uiUtils,Mask=baidu.editor.ui.Mask,UIBase=baidu.editor.ui.UIBase,Button=baidu.editor.ui.Button,Dialog=baidu.editor.ui.Dialog=function(options){if(options.name){var name=options.name;var cssRules=options.cssRules;if(!options.className){options.className='edui-for-'+name;}if(cssRules){options.cssRules='.edui-default .edui-for-'+name+' .edui-dialog-content  {'+cssRules+'}';}}this.initOptions(utils.extend({autoReset:true,draggable:true,onok:function onok(){},oncancel:function oncancel(){},onclose:function onclose(t,ok){return ok?this.onok():this.oncancel();},holdScroll:false},options));this.initDialog();};var modalMask;var dragMask;var activeDialog;Dialog.prototype={draggable:false,uiName:'dialog',initDialog:function initDialog(){var me=this,theme=this.editor.options.theme;if(this.cssRules){utils.cssRule('edui-customize-'+this.name+'-style',this.cssRules);}this.initUIBase();this.modalMask=modalMask||(modalMask=new Mask({className:'edui-dialog-modalmask',theme:theme,onclick:function onclick(){activeDialog&&activeDialog.close(false);}}));this.dragMask=dragMask||(dragMask=new Mask({className:'edui-dialog-dragmask',theme:theme}));this.closeButton=new Button({className:'edui-dialog-closebutton',title:me.closeDialog,theme:theme,onclick:function onclick(){me.close(false);}});this.fullscreen&&this.initResizeEvent();if(this.buttons){for(var i=0;i<this.buttons.length;i++){if(!(this.buttons[i]instanceof Button)){this.buttons[i]=new Button(utils.extend(this.buttons[i],{editor:this.editor},true));}}}},initResizeEvent:function initResizeEvent(){var me=this;domUtils.on(window,"resize",function(){if(me._hidden||me._hidden===undefined){return;}if(me.__resizeTimer){window.clearTimeout(me.__resizeTimer);}me.__resizeTimer=window.setTimeout(function(){me.__resizeTimer=null;var dialogWrapNode=me.getDom(),contentNode=me.getDom('content'),wrapRect=UE.ui.uiUtils.getClientRect(dialogWrapNode),contentRect=UE.ui.uiUtils.getClientRect(contentNode),vpRect=uiUtils.getViewportRect();contentNode.style.width=vpRect.width-wrapRect.width+contentRect.width+"px";contentNode.style.height=vpRect.height-wrapRect.height+contentRect.height+"px";dialogWrapNode.style.width=vpRect.width+"px";dialogWrapNode.style.height=vpRect.height+"px";me.fireEvent("resize");},100);});},fitSize:function fitSize(){var popBodyEl=this.getDom('body');var size=this.mesureSize();popBodyEl.style.width=size.width+'px';popBodyEl.style.height=size.height+'px';return size;},safeSetOffset:function safeSetOffset(offset){var me=this;var el=me.getDom();var vpRect=uiUtils.getViewportRect();var rect=uiUtils.getClientRect(el);var left=offset.left;if(left+rect.width>vpRect.right){left=vpRect.right-rect.width;}var top=offset.top;if(top+rect.height>vpRect.bottom){top=vpRect.bottom-rect.height;}el.style.left=Math.max(left,0)+'px';el.style.top=Math.max(top,0)+'px';},showAtCenter:function showAtCenter(){var vpRect=uiUtils.getViewportRect();if(!this.fullscreen){this.getDom().style.display='';var popSize=this.fitSize();var titleHeight=this.getDom('titlebar').offsetHeight|0;var left=vpRect.width/2-popSize.width/2;var top=vpRect.height/2-(popSize.height-titleHeight)/2-titleHeight;var popEl=this.getDom();this.safeSetOffset({left:Math.max(left|0,0),top:Math.max(top|0,0)});if(!domUtils.hasClass(popEl,'edui-state-centered')){popEl.className+=' edui-state-centered';}}else{var dialogWrapNode=this.getDom(),contentNode=this.getDom('content');dialogWrapNode.style.display="block";var wrapRect=UE.ui.uiUtils.getClientRect(dialogWrapNode),contentRect=UE.ui.uiUtils.getClientRect(contentNode);dialogWrapNode.style.left="-100000px";contentNode.style.width=vpRect.width-wrapRect.width+contentRect.width+"px";contentNode.style.height=vpRect.height-wrapRect.height+contentRect.height+"px";dialogWrapNode.style.width=vpRect.width+"px";dialogWrapNode.style.height=vpRect.height+"px";dialogWrapNode.style.left=0;this._originalContext={html:{overflowX:document.documentElement.style.overflowX,overflowY:document.documentElement.style.overflowY},body:{overflowX:document.body.style.overflowX,overflowY:document.body.style.overflowY}};document.documentElement.style.overflowX='hidden';document.documentElement.style.overflowY='hidden';document.body.style.overflowX='hidden';document.body.style.overflowY='hidden';}this._show();},getContentHtml:function getContentHtml(){var contentHtml='';if(typeof this.content=='string'){contentHtml=this.content;}else if(this.iframeUrl){contentHtml='<span id="'+this.id+'_contmask" class="dialogcontmask"></span><iframe id="'+this.id+'_iframe" class="%%-iframe" height="100%" width="100%" frameborder="0" src="'+this.iframeUrl+'"></iframe>';}return contentHtml;},getHtmlTpl:function getHtmlTpl(){var footHtml='';if(this.buttons){var buff=[];for(var i=0;i<this.buttons.length;i++){buff[i]=this.buttons[i].renderHtml();}footHtml='<div class="%%-foot">'+'<div id="##_buttons" class="%%-buttons">'+buff.join('')+'</div>'+'</div>';}return'<div id="##" class="%%"><div '+(!this.fullscreen?'class="%%"':'class="%%-wrap edui-dialog-fullscreen-flag"')+'><div id="##_body" class="%%-body">'+'<div class="%%-shadow"></div>'+'<div id="##_titlebar" class="%%-titlebar">'+'<div class="%%-draghandle" onmousedown="$$._onTitlebarMouseDown(event, this);">'+'<span class="%%-caption">'+(this.title||'')+'</span>'+'</div>'+this.closeButton.renderHtml()+'</div>'+'<div id="##_content" class="%%-content">'+(this.autoReset?'':this.getContentHtml())+'</div>'+footHtml+'</div></div></div>';},postRender:function postRender(){if(!this.modalMask.getDom()){this.modalMask.render();this.modalMask.hide();}if(!this.dragMask.getDom()){this.dragMask.render();this.dragMask.hide();}var me=this;this.addListener('show',function(){me.modalMask.show(this.getDom().style.zIndex-2);});this.addListener('hide',function(){me.modalMask.hide();});if(this.buttons){for(var i=0;i<this.buttons.length;i++){this.buttons[i].postRender();}}domUtils.on(window,'resize',function(){setTimeout(function(){if(!me.isHidden()){me.safeSetOffset(uiUtils.getClientRect(me.getDom()));}});});this._hide();},mesureSize:function mesureSize(){var body=this.getDom('body');var width=uiUtils.getClientRect(this.getDom('content')).width;var dialogBodyStyle=body.style;dialogBodyStyle.width=width;return uiUtils.getClientRect(body);},_onTitlebarMouseDown:function _onTitlebarMouseDown(evt,el){if(this.draggable){var rect;var vpRect=uiUtils.getViewportRect();var me=this;uiUtils.startDrag(evt,{ondragstart:function ondragstart(){rect=uiUtils.getClientRect(me.getDom());me.getDom('contmask').style.visibility='visible';me.dragMask.show(me.getDom().style.zIndex-1);},ondragmove:function ondragmove(x,y){var left=rect.left+x;var top=rect.top+y;me.safeSetOffset({left:left,top:top});},ondragstop:function ondragstop(){me.getDom('contmask').style.visibility='hidden';domUtils.removeClasses(me.getDom(),['edui-state-centered']);me.dragMask.hide();}});}},reset:function reset(){this.getDom('content').innerHTML=this.getContentHtml();this.fireEvent('dialogafterreset');},_show:function _show(){if(this._hidden){this.getDom().style.display='';this.editor.container.style.zIndex&&(this.getDom().style.zIndex=this.editor.container.style.zIndex*1+10);this._hidden=false;this.fireEvent('show');baidu.editor.ui.uiUtils.getFixedLayer().style.zIndex=this.getDom().style.zIndex-4;}},isHidden:function isHidden(){return this._hidden;},_hide:function _hide(){if(!this._hidden){var wrapNode=this.getDom();wrapNode.style.display='none';wrapNode.style.zIndex='';wrapNode.style.width='';wrapNode.style.height='';this._hidden=true;this.fireEvent('hide');}},open:function open(){if(this.autoReset){try{this.reset();}catch(e){this.render();this.open();}}this.showAtCenter();if(this.iframeUrl){try{this.getDom('iframe').focus();}catch(ex){}}activeDialog=this;},_onCloseButtonClick:function _onCloseButtonClick(evt,el){this.close(false);},close:function close(ok){if(this.fireEvent('close',ok)!==false){if(this.fullscreen){document.documentElement.style.overflowX=this._originalContext.html.overflowX;document.documentElement.style.overflowY=this._originalContext.html.overflowY;document.body.style.overflowX=this._originalContext.body.overflowX;document.body.style.overflowY=this._originalContext.body.overflowY;delete this._originalContext;}this._hide();var content=this.getDom('content');var iframe=this.getDom('iframe');if(content&&iframe){var doc=iframe.contentDocument||iframe.contentWindow.document;doc&&(doc.body.innerHTML='');domUtils.remove(content);}}}};utils.inherits(Dialog,UIBase);})();(function(){var utils=baidu.editor.utils,Menu=baidu.editor.ui.Menu,SplitButton=baidu.editor.ui.SplitButton,MenuButton=baidu.editor.ui.MenuButton=function(options){this.initOptions(options);this.initMenuButton();};MenuButton.prototype={initMenuButton:function initMenuButton(){var me=this;this.uiName="menubutton";this.popup=new Menu({items:me.items,className:me.className,editor:me.editor});this.popup.addListener('show',function(){var list=this;for(var i=0;i<list.items.length;i++){list.items[i].removeState('checked');if(list.items[i].value==me._value){list.items[i].addState('checked');this.value=me._value;}}});this.initSplitButton();},setValue:function setValue(value){this._value=value;}};utils.inherits(MenuButton,SplitButton);})();(function(){var utils=baidu.editor.utils,Popup=baidu.editor.ui.Popup,SplitButton=baidu.editor.ui.SplitButton,MultiMenuPop=baidu.editor.ui.MultiMenuPop=function(options){this.initOptions(options);this.initMultiMenu();};MultiMenuPop.prototype={initMultiMenu:function initMultiMenu(){var me=this;this.popup=new Popup({content:'',editor:me.editor,iframe_rendered:false,onshow:function onshow(){if(!this.iframe_rendered){this.iframe_rendered=true;this.getDom('content').innerHTML='<iframe id="'+me.id+'_iframe" src="'+me.iframeUrl+'" frameborder="0"></iframe>';me.editor.container.style.zIndex&&(this.getDom().style.zIndex=me.editor.container.style.zIndex*1+1);}}});this.onbuttonclick=function(){this.showPopup();};this.initSplitButton();}};utils.inherits(MultiMenuPop,SplitButton);})();(function(){var UI=baidu.editor.ui,UIBase=UI.UIBase,uiUtils=UI.uiUtils,utils=baidu.editor.utils,domUtils=baidu.editor.dom.domUtils;var allMenus=[],timeID,isSubMenuShow=false;var ShortCutMenu=UI.ShortCutMenu=function(options){this.initOptions(options);this.initShortCutMenu();};ShortCutMenu.postHide=hideAllMenu;ShortCutMenu.prototype={isHidden:true,SPACE:5,initShortCutMenu:function initShortCutMenu(){this.items=this.items||[];this.initUIBase();this.initItems();this.initEvent();allMenus.push(this);},initEvent:function initEvent(){var me=this,doc=me.editor.document;domUtils.on(doc,"mousemove",function(e){if(me.isHidden===false){if(me.getSubMenuMark()||me.eventType=="contextmenu")return;var flag=true,el=me.getDom(),wt=el.offsetWidth,ht=el.offsetHeight,distanceX=wt/2+me.SPACE,distanceY=ht/2,x=Math.abs(e.screenX-me.left),y=Math.abs(e.screenY-me.top);clearTimeout(timeID);timeID=setTimeout(function(){if(y>0&&y<distanceY){me.setOpacity(el,"1");}else if(y>distanceY&&y<distanceY+70){me.setOpacity(el,"0.5");flag=false;}else if(y>distanceY+70&&y<distanceY+140){me.hide();}if(flag&&x>0&&x<distanceX){me.setOpacity(el,"1");}else if(x>distanceX&&x<distanceX+70){me.setOpacity(el,"0.5");}else if(x>distanceX+70&&x<distanceX+140){me.hide();}});}});if(browser.chrome){domUtils.on(doc,"mouseout",function(e){var relatedTgt=e.relatedTarget||e.toElement;if(relatedTgt==null||relatedTgt.tagName=="HTML"){me.hide();}});}me.editor.addListener("afterhidepop",function(){if(!me.isHidden){isSubMenuShow=true;}});},initItems:function initItems(){if(utils.isArray(this.items)){for(var i=0,len=this.items.length;i<len;i++){var item=this.items[i].toLowerCase();if(UI[item]){this.items[i]=new UI[item](this.editor);this.items[i].className+=" edui-shortcutsubmenu ";}}}},setOpacity:function setOpacity(el,value){if(browser.ie&&browser.version<9){el.style.filter="alpha(opacity = "+parseFloat(value)*100+");";}else{el.style.opacity=value;}},getSubMenuMark:function getSubMenuMark(){isSubMenuShow=false;var layerEle=uiUtils.getFixedLayer();var list=domUtils.getElementsByTagName(layerEle,"div",function(node){return domUtils.hasClass(node,"edui-shortcutsubmenu edui-popup");});for(var i=0,node;node=list[i++];){if(node.style.display!="none"){isSubMenuShow=true;}}return isSubMenuShow;},show:function show(e,hasContextmenu){var me=this,offset={},el=this.getDom(),fixedlayer=uiUtils.getFixedLayer();function setPos(offset){if(offset.left<0){offset.left=0;}if(offset.top<0){offset.top=0;}el.style.cssText="position:absolute;left:"+offset.left+"px;top:"+offset.top+"px;";}function setPosByCxtMenu(menu){if(!menu.tagName){menu=menu.getDom();}offset.left=parseInt(menu.style.left);offset.top=parseInt(menu.style.top);offset.top-=el.offsetHeight+15;setPos(offset);}me.eventType=e.type;el.style.cssText="display:block;left:-9999px";if(e.type=="contextmenu"&&hasContextmenu){var menu=domUtils.getElementsByTagName(fixedlayer,"div","edui-contextmenu")[0];if(menu){setPosByCxtMenu(menu);}else{me.editor.addListener("aftershowcontextmenu",function(type,menu){setPosByCxtMenu(menu);});}}else{offset=uiUtils.getViewportOffsetByEvent(e);offset.top-=el.offsetHeight+me.SPACE;offset.left+=me.SPACE+20;setPos(offset);me.setOpacity(el,0.2);}me.isHidden=false;me.left=e.screenX+el.offsetWidth/2-me.SPACE;me.top=e.screenY-el.offsetHeight/2-me.SPACE;if(me.editor){el.style.zIndex=me.editor.container.style.zIndex*1+10;fixedlayer.style.zIndex=el.style.zIndex-1;}},hide:function hide(){if(this.getDom()){this.getDom().style.display="none";}this.isHidden=true;},postRender:function postRender(){if(utils.isArray(this.items)){for(var i=0,item;item=this.items[i++];){item.postRender();}}},getHtmlTpl:function getHtmlTpl(){var buff;if(utils.isArray(this.items)){buff=[];for(var i=0;i<this.items.length;i++){buff[i]=this.items[i].renderHtml();}buff=buff.join("");}else{buff=this.items;}return'<div id="##" class="%% edui-toolbar" data-src="shortcutmenu" onmousedown="return false;" onselectstart="return false;" >'+buff+'</div>';}};utils.inherits(ShortCutMenu,UIBase);function hideAllMenu(e){var tgt=e.target||e.srcElement,cur=domUtils.findParent(tgt,function(node){return domUtils.hasClass(node,"edui-shortcutmenu")||domUtils.hasClass(node,"edui-popup");},true);if(!cur){for(var i=0,menu;menu=allMenus[i++];){menu.hide();}}}domUtils.on(document,'mousedown',function(e){hideAllMenu(e);});domUtils.on(window,'scroll',function(e){hideAllMenu(e);});})();(function(){var utils=baidu.editor.utils,UIBase=baidu.editor.ui.UIBase,Breakline=baidu.editor.ui.Breakline=function(options){this.initOptions(options);this.initSeparator();};Breakline.prototype={uiName:'Breakline',initSeparator:function initSeparator(){this.initUIBase();},getHtmlTpl:function getHtmlTpl(){return'<br/>';}};utils.inherits(Breakline,UIBase);})();(function(){var utils=baidu.editor.utils,domUtils=baidu.editor.dom.domUtils,UIBase=baidu.editor.ui.UIBase,Message=baidu.editor.ui.Message=function(options){this.initOptions(options);this.initMessage();};Message.prototype={initMessage:function initMessage(){this.initUIBase();},getHtmlTpl:function getHtmlTpl(){return'<div id="##" class="edui-message %%">'+' <div id="##_closer" class="edui-message-closer">×</div>'+' <div id="##_body" class="edui-message-body edui-message-type-info">'+' <iframe style="position:absolute;z-index:-1;left:0;top:0;background-color: transparent;" frameborder="0" width="100%" height="100%" src="about:blank"></iframe>'+' <div class="edui-shadow"></div>'+' <div id="##_content" class="edui-message-content">'+'  </div>'+' </div>'+'</div>';},reset:function reset(opt){var me=this;if(!opt.keepshow){clearTimeout(this.timer);me.timer=setTimeout(function(){me.hide();},opt.timeout||4000);}opt.content!==undefined&&me.setContent(opt.content);opt.type!==undefined&&me.setType(opt.type);me.show();},postRender:function postRender(){var me=this,closer=this.getDom('closer');closer&&domUtils.on(closer,'click',function(){me.hide();});},setContent:function setContent(content){this.getDom('content').innerHTML=content;},setType:function setType(type){type=type||'info';var body=this.getDom('body');body.className=body.className.replace(/edui-message-type-[\w-]+/,'edui-message-type-'+type);},getContent:function getContent(){return this.getDom('content').innerHTML;},getType:function getType(){var arr=this.getDom('body').match(/edui-message-type-([\w-]+)/);return arr?arr[1]:'';},show:function show(){this.getDom().style.display='block';},hide:function hide(){var dom=this.getDom();if(dom){dom.style.display='none';dom.parentNode&&dom.parentNode.removeChild(dom);}}};utils.inherits(Message,UIBase);})();(function(){var utils=baidu.editor.utils;var editorui=baidu.editor.ui;var _Dialog=editorui.Dialog;editorui.buttons={};editorui.Dialog=function(options){var dialog=new _Dialog(options);dialog.addListener('hide',function(){if(dialog.editor){var editor=dialog.editor;try{if(browser.gecko){var y=editor.window.scrollY,x=editor.window.scrollX;editor.body.focus();editor.window.scrollTo(x,y);}else{editor.focus();}}catch(ex){}}});return dialog;};var iframeUrlMap={'anchor':'~/dialogs/anchor/anchor.html','insertimage':'~/dialogs/image/image.html','link':'~/dialogs/link/link.html','spechars':'~/dialogs/spechars/spechars.html','searchreplace':'~/dialogs/searchreplace/searchreplace.html','map':'~/dialogs/map/map.html','gmap':'~/dialogs/gmap/gmap.html','insertvideo':'~/dialogs/video/video.html','help':'~/dialogs/help/help.html','preview':'~/dialogs/preview/preview.html','emotion':'~/dialogs/emotion/emotion.html','wordimage':'~/dialogs/wordimage/wordimage.html','attachment':'~/dialogs/attachment/attachment.html','insertframe':'~/dialogs/insertframe/insertframe.html','edittip':'~/dialogs/table/edittip.html','edittable':'~/dialogs/table/edittable.html','edittd':'~/dialogs/table/edittd.html','webapp':'~/dialogs/webapp/webapp.html','snapscreen':'~/dialogs/snapscreen/snapscreen.html','scrawl':'~/dialogs/scrawl/scrawl.html','music':'~/dialogs/music/music.html','template':'~/dialogs/template/template.html','background':'~/dialogs/background/background.html','charts':'~/dialogs/charts/charts.html'};var btnCmds=['undo','redo','formatmatch','bold','italic','underline','fontborder','touppercase','tolowercase','strikethrough','subscript','superscript','source','indent','outdent','blockquote','pasteplain','pagebreak','selectall','print','horizontal','removeformat','time','date','unlink','insertparagraphbeforetable','insertrow','insertcol','mergeright','mergedown','deleterow','deletecol','splittorows','splittocols','splittocells','mergecells','deletetable','drafts'];for(var i=0,ci;ci=btnCmds[i++];){ci=ci.toLowerCase();editorui[ci]=function(cmd){return function(editor){var ui=new editorui.Button({className:'edui-for-'+cmd,title:editor.options.labelMap[cmd]||editor.getLang("labelMap."+cmd)||'',onclick:function onclick(){editor.execCommand(cmd);},theme:editor.options.theme,showText:false});editorui.buttons[cmd]=ui;editor.addListener('selectionchange',function(type,causeByUi,uiReady){var state=editor.queryCommandState(cmd);if(state==-1){ui.setDisabled(true);ui.setChecked(false);}else{if(!uiReady){ui.setDisabled(false);ui.setChecked(state);}}});return ui;};}(ci);}
editorui.cleardoc=function(editor){var ui=new editorui.Button({className:'edui-for-cleardoc',title:editor.options.labelMap.cleardoc||editor.getLang("labelMap.cleardoc")||'',theme:editor.options.theme,onclick:function onclick(){if(confirm(editor.getLang("confirmClear"))){editor.execCommand('cleardoc');}}});editorui.buttons["cleardoc"]=ui;editor.addListener('selectionchange',function(){ui.setDisabled(editor.queryCommandState('cleardoc')==-1);});return ui;};var typeset={'justify':['left','right','center','justify'],'imagefloat':['none','left','center','right'],'directionality':['ltr','rtl']};for(var p in typeset){(function(cmd,val){for(var i=0,ci;ci=val[i++];){(function(cmd2){editorui[cmd.replace('float','')+cmd2]=function(editor){var ui=new editorui.Button({className:'edui-for-'+cmd.replace('float','')+cmd2,title:editor.options.labelMap[cmd.replace('float','')+cmd2]||editor.getLang("labelMap."+cmd.replace('float','')+cmd2)||'',theme:editor.options.theme,onclick:function onclick(){editor.execCommand(cmd,cmd2);}});editorui.buttons[cmd]=ui;editor.addListener('selectionchange',function(type,causeByUi,uiReady){ui.setDisabled(editor.queryCommandState(cmd)==-1);ui.setChecked(editor.queryCommandValue(cmd)==cmd2&&!uiReady);});return ui;};})(ci);}})(p,typeset[p]);}
for(var i=0,ci;ci=['backcolor','forecolor'][i++];){editorui[ci]=function(cmd){return function(editor){var ui=new editorui.ColorButton({className:'edui-for-'+cmd,color:'default',title:editor.options.labelMap[cmd]||editor.getLang("labelMap."+cmd)||'',editor:editor,onpickcolor:function onpickcolor(t,color){editor.execCommand(cmd,color);},onpicknocolor:function onpicknocolor(){editor.execCommand(cmd,'default');this.setColor('transparent');this.color='default';},onbuttonclick:function onbuttonclick(){editor.execCommand(cmd,this.color);}});editorui.buttons[cmd]=ui;editor.addListener('selectionchange',function(){ui.setDisabled(editor.queryCommandState(cmd)==-1);});return ui;};}(ci);}var dialogBtns={noOk:['searchreplace','help','spechars','webapp','preview'],ok:['attachment','anchor','link','insertimage','map','gmap','insertframe','wordimage','insertvideo','insertframe','edittip','edittable','edittd','scrawl','template','music','background','charts']};for(var p in dialogBtns){(function(type,vals){for(var i=0,ci;ci=vals[i++];){if(browser.opera&&ci==="searchreplace"){continue;}(function(cmd){editorui[cmd]=function(editor,iframeUrl,title){iframeUrl=iframeUrl||(editor.options.iframeUrlMap||{})[cmd]||iframeUrlMap[cmd];title=editor.options.labelMap[cmd]||editor.getLang("labelMap."+cmd)||'';var dialog;if(iframeUrl){dialog=new editorui.Dialog(utils.extend({iframeUrl:editor.ui.mapUrl(iframeUrl),editor:editor,className:'edui-for-'+cmd,title:title,holdScroll:cmd==='insertimage',fullscreen:/charts|preview/.test(cmd),closeDialog:editor.getLang("closeDialog")},type=='ok'?{buttons:[{className:'edui-okbutton',label:editor.getLang("ok"),editor:editor,onclick:function onclick(){dialog.close(true);}},{className:'edui-cancelbutton',label:editor.getLang("cancel"),editor:editor,onclick:function onclick(){dialog.close(false);}}]}:{}));editor.ui._dialogs[cmd+"Dialog"]=dialog;}var ui=new editorui.Button({className:'edui-for-'+cmd,title:title,onclick:function onclick(){if(dialog){switch(cmd){case"wordimage":var images=editor.execCommand("wordimage");if(images&&images.length){dialog.render();dialog.open();}break;case"scrawl":if(editor.queryCommandState("scrawl")!=-1){dialog.render();dialog.open();}break;default:dialog.render();dialog.open();}}},theme:editor.options.theme,disabled:cmd=='scrawl'&&editor.queryCommandState("scrawl")==-1||cmd=='charts'});editorui.buttons[cmd]=ui;editor.addListener('selectionchange',function(){var unNeedCheckState={'edittable':1};if(cmd in unNeedCheckState)return;var state=editor.queryCommandState(cmd);if(ui.getDom()){ui.setDisabled(state==-1);ui.setChecked(state);}});return ui;};})(ci.toLowerCase());}})(p,dialogBtns[p]);}editorui.snapscreen=function(editor,iframeUrl,title){title=editor.options.labelMap['snapscreen']||editor.getLang("labelMap.snapscreen")||'';var ui=new editorui.Button({className:'edui-for-snapscreen',title:title,onclick:function onclick(){editor.execCommand("snapscreen");},theme:editor.options.theme});editorui.buttons['snapscreen']=ui;iframeUrl=iframeUrl||(editor.options.iframeUrlMap||{})["snapscreen"]||iframeUrlMap["snapscreen"];if(iframeUrl){var dialog=new editorui.Dialog({iframeUrl:editor.ui.mapUrl(iframeUrl),editor:editor,className:'edui-for-snapscreen',title:title,buttons:[{className:'edui-okbutton',label:editor.getLang("ok"),editor:editor,onclick:function onclick(){dialog.close(true);}},{className:'edui-cancelbutton',label:editor.getLang("cancel"),editor:editor,onclick:function onclick(){dialog.close(false);}}]});dialog.render();editor.ui._dialogs["snapscreenDialog"]=dialog;}editor.addListener('selectionchange',function(){ui.setDisabled(editor.queryCommandState('snapscreen')==-1);});return ui;};editorui.insertcode=function(editor,list,title){list=editor.options['insertcode']||[];title=editor.options.labelMap['insertcode']||editor.getLang("labelMap.insertcode")||'';var items=[];utils.each(list,function(key,val){items.push({label:key,value:val,theme:editor.options.theme,renderLabelHtml:function renderLabelHtml(){return'<div class="edui-label %%-label" >'+(this.label||'')+'</div>';}});});var ui=new editorui.Combox({editor:editor,items:items,onselect:function onselect(t,index){editor.execCommand('insertcode',this.items[index].value);},onbuttonclick:function onbuttonclick(){this.showPopup();},title:title,initValue:title,className:'edui-for-insertcode',indexByValue:function indexByValue(value){if(value){for(var i=0,ci;ci=this.items[i];i++){if(ci.value.indexOf(value)!=-1)return i;}}return-1;}});editorui.buttons['insertcode']=ui;editor.addListener('selectionchange',function(type,causeByUi,uiReady){if(!uiReady){var state=editor.queryCommandState('insertcode');if(state==-1){ui.setDisabled(true);}else{ui.setDisabled(false);var value=editor.queryCommandValue('insertcode');if(!value){ui.setValue(title);return;}
value&&(value=value.replace(/['"]/g,'').split(',')[0]);ui.setValue(value);}}});return ui;};editorui.fontfamily=function(editor,list,title){list=editor.options['fontfamily']||[];title=editor.options.labelMap['fontfamily']||editor.getLang("labelMap.fontfamily")||'';if(!list.length)return;for(var i=0,ci,items=[];ci=list[i];i++){var langLabel=editor.getLang('fontfamily')[ci.name]||"";(function(key,val){items.push({label:key,value:val,theme:editor.options.theme,renderLabelHtml:function renderLabelHtml(){return'<div class="edui-label %%-label" style="font-family:'+utils.unhtml(this.value)+'">'+(this.label||'')+'</div>';}});})(ci.label||langLabel,ci.val);}var ui=new editorui.Combox({editor:editor,items:items,onselect:function onselect(t,index){editor.execCommand('FontFamily',this.items[index].value);},onbuttonclick:function onbuttonclick(){this.showPopup();},title:title,initValue:title,className:'edui-for-fontfamily',indexByValue:function indexByValue(value){if(value){for(var i=0,ci;ci=this.items[i];i++){if(ci.value.indexOf(value)!=-1)return i;}}return-1;}});editorui.buttons['fontfamily']=ui;editor.addListener('selectionchange',function(type,causeByUi,uiReady){if(!uiReady){var state=editor.queryCommandState('FontFamily');if(state==-1){ui.setDisabled(true);}else{ui.setDisabled(false);var value=editor.queryCommandValue('FontFamily');value&&(value=value.replace(/['"]/g,'').split(',')[0]);ui.setValue(value);}}});return ui;};editorui.fontsize=function(editor,list,title){title=editor.options.labelMap['fontsize']||editor.getLang("labelMap.fontsize")||'';list=list||editor.options['fontsize']||[];if(!list.length)return;var items=[];for(var i=0;i<list.length;i++){var size=list[i]+'px';items.push({label:size,value:size,theme:editor.options.theme,renderLabelHtml:function renderLabelHtml(){return'<div class="edui-label %%-label" style="line-height:1;font-size:'+this.value+'">'+(this.label||'')+'</div>';}});}var ui=new editorui.Combox({editor:editor,items:items,title:title,initValue:title,onselect:function onselect(t,index){editor.execCommand('FontSize',this.items[index].value);},onbuttonclick:function onbuttonclick(){this.showPopup();},className:'edui-for-fontsize'});editorui.buttons['fontsize']=ui;editor.addListener('selectionchange',function(type,causeByUi,uiReady){if(!uiReady){var state=editor.queryCommandState('FontSize');if(state==-1){ui.setDisabled(true);}else{ui.setDisabled(false);ui.setValue(editor.queryCommandValue('FontSize'));}}});return ui;};editorui.paragraph=function(editor,list,title){title=editor.options.labelMap['paragraph']||editor.getLang("labelMap.paragraph")||'';list=editor.options['paragraph']||[];if(utils.isEmptyObject(list))return;var items=[];for(var i in list){items.push({value:i,label:list[i]||editor.getLang("paragraph")[i],theme:editor.options.theme,renderLabelHtml:function renderLabelHtml(){return'<div class="edui-label %%-label"><span class="edui-for-'+this.value+'">'+(this.label||'')+'</span></div>';}});}var ui=new editorui.Combox({editor:editor,items:items,title:title,initValue:title,className:'edui-for-paragraph',onselect:function onselect(t,index){editor.execCommand('Paragraph',this.items[index].value);},onbuttonclick:function onbuttonclick(){this.showPopup();}});editorui.buttons['paragraph']=ui;editor.addListener('selectionchange',function(type,causeByUi,uiReady){if(!uiReady){var state=editor.queryCommandState('Paragraph');if(state==-1){ui.setDisabled(true);}else{ui.setDisabled(false);var value=editor.queryCommandValue('Paragraph');var index=ui.indexByValue(value);if(index!=-1){ui.setValue(value);}else{ui.setValue(ui.initValue);}}}});return ui;};editorui.customstyle=function(editor){var list=editor.options['customstyle']||[],title=editor.options.labelMap['customstyle']||editor.getLang("labelMap.customstyle")||'';if(!list.length)return;var langCs=editor.getLang('customstyle');for(var i=0,items=[],t;t=list[i++];){(function(t){var ck={};ck.label=t.label?t.label:langCs[t.name];ck.style=t.style;ck.className=t.className;ck.tag=t.tag;items.push({label:ck.label,value:ck,theme:editor.options.theme,renderLabelHtml:function renderLabelHtml(){return'<div class="edui-label %%-label">'+'<'+ck.tag+' '+(ck.className?' class="'+ck.className+'"':"")+(ck.style?' style="'+ck.style+'"':"")+'>'+ck.label+"<\/"+ck.tag+">"+'</div>';}});})(t);}var ui=new editorui.Combox({editor:editor,items:items,title:title,initValue:title,className:'edui-for-customstyle',onselect:function onselect(t,index){editor.execCommand('customstyle',this.items[index].value);},onbuttonclick:function onbuttonclick(){this.showPopup();},indexByValue:function indexByValue(value){for(var i=0,ti;ti=this.items[i++];){if(ti.label==value){return i-1;}}return-1;}});editorui.buttons['customstyle']=ui;editor.addListener('selectionchange',function(type,causeByUi,uiReady){if(!uiReady){var state=editor.queryCommandState('customstyle');if(state==-1){ui.setDisabled(true);}else{ui.setDisabled(false);var value=editor.queryCommandValue('customstyle');var index=ui.indexByValue(value);if(index!=-1){ui.setValue(value);}else{ui.setValue(ui.initValue);}}}});return ui;};editorui.inserttable=function(editor,iframeUrl,title){title=editor.options.labelMap['inserttable']||editor.getLang("labelMap.inserttable")||'';var ui=new editorui.TableButton({editor:editor,title:title,className:'edui-for-inserttable',onpicktable:function onpicktable(t,numCols,numRows){editor.execCommand('InsertTable',{numRows:numRows,numCols:numCols,border:1});},onbuttonclick:function onbuttonclick(){this.showPopup();}});editorui.buttons['inserttable']=ui;editor.addListener('selectionchange',function(){ui.setDisabled(editor.queryCommandState('inserttable')==-1);});return ui;};editorui.lineheight=function(editor){var val=editor.options.lineheight||[];if(!val.length)return;for(var i=0,ci,items=[];ci=val[i++];){items.push({label:ci,value:ci,theme:editor.options.theme,onclick:function onclick(){editor.execCommand("lineheight",this.value);}});}var ui=new editorui.MenuButton({editor:editor,className:'edui-for-lineheight',title:editor.options.labelMap['lineheight']||editor.getLang("labelMap.lineheight")||'',items:items,onbuttonclick:function onbuttonclick(){var value=editor.queryCommandValue('LineHeight')||this.value;editor.execCommand("LineHeight",value);}});editorui.buttons['lineheight']=ui;editor.addListener('selectionchange',function(){var state=editor.queryCommandState('LineHeight');if(state==-1){ui.setDisabled(true);}else{ui.setDisabled(false);var value=editor.queryCommandValue('LineHeight');value&&ui.setValue((value+'').replace(/cm/,''));ui.setChecked(state);}});return ui;};var rowspacings=['top','bottom'];for(var r=0,ri;ri=rowspacings[r++];){(function(cmd){editorui['rowspacing'+cmd]=function(editor){var val=editor.options['rowspacing'+cmd]||[];if(!val.length)return null;for(var i=0,ci,items=[];ci=val[i++];){items.push({label:ci,value:ci,theme:editor.options.theme,onclick:function onclick(){editor.execCommand("rowspacing",this.value,cmd);}});}var ui=new editorui.MenuButton({editor:editor,className:'edui-for-rowspacing'+cmd,title:editor.options.labelMap['rowspacing'+cmd]||editor.getLang("labelMap.rowspacing"+cmd)||'',items:items,onbuttonclick:function onbuttonclick(){var value=editor.queryCommandValue('rowspacing',cmd)||this.value;editor.execCommand("rowspacing",value,cmd);}});editorui.buttons[cmd]=ui;editor.addListener('selectionchange',function(){var state=editor.queryCommandState('rowspacing',cmd);if(state==-1){ui.setDisabled(true);}else{ui.setDisabled(false);var value=editor.queryCommandValue('rowspacing',cmd);value&&ui.setValue((value+'').replace(/%/,''));ui.setChecked(state);}});return ui;};})(ri);}
var lists=['insertorderedlist','insertunorderedlist'];for(var l=0,cl;cl=lists[l++];){(function(cmd){editorui[cmd]=function(editor){var vals=editor.options[cmd],_onMenuClick=function _onMenuClick(){editor.execCommand(cmd,this.value);},items=[];for(var i in vals){items.push({label:vals[i]||editor.getLang()[cmd][i]||"",value:i,theme:editor.options.theme,onclick:_onMenuClick});}var ui=new editorui.MenuButton({editor:editor,className:'edui-for-'+cmd,title:editor.getLang("labelMap."+cmd)||'','items':items,onbuttonclick:function onbuttonclick(){var value=editor.queryCommandValue(cmd)||this.value;editor.execCommand(cmd,value);}});editorui.buttons[cmd]=ui;editor.addListener('selectionchange',function(){var state=editor.queryCommandState(cmd);if(state==-1){ui.setDisabled(true);}else{ui.setDisabled(false);var value=editor.queryCommandValue(cmd);ui.setValue(value);ui.setChecked(state);}});return ui;};})(cl);}editorui.fullscreen=function(editor,title){title=editor.options.labelMap['fullscreen']||editor.getLang("labelMap.fullscreen")||'';var ui=new editorui.Button({className:'edui-for-fullscreen',title:title,theme:editor.options.theme,onclick:function onclick(){if(editor.ui){editor.ui.setFullScreen(!editor.ui.isFullScreen());}this.setChecked(editor.ui.isFullScreen());}});editorui.buttons['fullscreen']=ui;editor.addListener('selectionchange',function(){var state=editor.queryCommandState('fullscreen');ui.setDisabled(state==-1);ui.setChecked(editor.ui.isFullScreen());});return ui;};editorui["emotion"]=function(editor,iframeUrl){var cmd="emotion";var ui=new editorui.MultiMenuPop({title:editor.options.labelMap[cmd]||editor.getLang("labelMap."+cmd+"")||'',editor:editor,className:'edui-for-'+cmd,iframeUrl:editor.ui.mapUrl(iframeUrl||(editor.options.iframeUrlMap||{})[cmd]||iframeUrlMap[cmd])});editorui.buttons[cmd]=ui;editor.addListener('selectionchange',function(){ui.setDisabled(editor.queryCommandState(cmd)==-1);});return ui;};editorui.autotypeset=function(editor){var ui=new editorui.AutoTypeSetButton({editor:editor,title:editor.options.labelMap['autotypeset']||editor.getLang("labelMap.autotypeset")||'',className:'edui-for-autotypeset',onbuttonclick:function onbuttonclick(){editor.execCommand('autotypeset');}});editorui.buttons['autotypeset']=ui;editor.addListener('selectionchange',function(){ui.setDisabled(editor.queryCommandState('autotypeset')==-1);});return ui;};editorui["simpleupload"]=function(editor){var name='simpleupload',ui=new editorui.Button({className:'edui-for-'+name,title:editor.options.labelMap[name]||editor.getLang("labelMap."+name)||'',onclick:function onclick(){},theme:editor.options.theme,showText:false});editorui.buttons[name]=ui;editor.addListener('ready',function(){var b=ui.getDom('body'),iconSpan=b.children[0];editor.fireEvent('simpleuploadbtnready',iconSpan);});editor.addListener('selectionchange',function(type,causeByUi,uiReady){var state=editor.queryCommandState(name);if(state==-1){ui.setDisabled(true);ui.setChecked(false);}else{if(!uiReady){ui.setDisabled(false);ui.setChecked(state);}}});return ui;};})();(function(){var utils=baidu.editor.utils,uiUtils=baidu.editor.ui.uiUtils,UIBase=baidu.editor.ui.UIBase,domUtils=baidu.editor.dom.domUtils;var nodeStack=[];function EditorUI(options){this.initOptions(options);this.initEditorUI();}EditorUI.prototype={uiName:'editor',initEditorUI:function initEditorUI(){this.editor.ui=this;this._dialogs={};this.initUIBase();this._initToolbars();var editor=this.editor,me=this;editor.addListener('ready',function(){editor.getDialog=function(name){return editor.ui._dialogs[name+"Dialog"];};domUtils.on(editor.window,'scroll',function(evt){baidu.editor.ui.Popup.postHide(evt);});editor.ui._actualFrameWidth=editor.options.initialFrameWidth;UE.browser.ie&&UE.browser.version===6&&editor.container.ownerDocument.execCommand("BackgroundImageCache",false,true);if(editor.options.elementPathEnabled){editor.ui.getDom('elementpath').innerHTML='<div class="edui-editor-breadcrumb">'+editor.getLang("elementPathTip")+':</div>';}if(editor.options.wordCount){var countFn=function countFn(){setCount(editor,me);domUtils.un(editor.document,"click",arguments.callee);};domUtils.on(editor.document,"click",countFn);editor.ui.getDom('wordcount').innerHTML=editor.getLang("wordCountTip");}editor.ui._scale();if(editor.options.scaleEnabled){if(editor.autoHeightEnabled){editor.disableAutoHeight();}me.enableScale();}else{me.disableScale();}if(!editor.options.elementPathEnabled&&!editor.options.wordCount&&!editor.options.scaleEnabled){editor.ui.getDom('elementpath').style.display="none";editor.ui.getDom('wordcount').style.display="none";editor.ui.getDom('scale').style.display="none";}if(!editor.selection.isFocus())return;editor.fireEvent('selectionchange',false,true);});editor.addListener('mousedown',function(t,evt){var el=evt.target||evt.srcElement;baidu.editor.ui.Popup.postHide(evt,el);baidu.editor.ui.ShortCutMenu.postHide(evt);});editor.addListener("delcells",function(){if(UE.ui['edittip']){new UE.ui['edittip'](editor);}editor.getDialog('edittip').open();});var pastePop,isPaste=false,timer;editor.addListener("afterpaste",function(){if(editor.queryCommandState('pasteplain'))return;if(baidu.editor.ui.PastePicker){pastePop=new baidu.editor.ui.Popup({content:new baidu.editor.ui.PastePicker({editor:editor}),editor:editor,className:'edui-wordpastepop'});pastePop.render();}isPaste=true;});editor.addListener("afterinserthtml",function(){clearTimeout(timer);timer=setTimeout(function(){if(pastePop&&(isPaste||editor.ui._isTransfer)){if(pastePop.isHidden()){var span=domUtils.createElement(editor.document,'span',{'style':"line-height:0px;",'innerHTML':'\uFEFF'}),range=editor.selection.getRange();range.insertNode(span);var tmp=getDomNode(span,'firstChild','previousSibling');tmp&&pastePop.showAnchor(tmp.nodeType==3?tmp.parentNode:tmp);domUtils.remove(span);}else{pastePop.show();}delete editor.ui._isTransfer;isPaste=false;}},200);});editor.addListener('contextmenu',function(t,evt){baidu.editor.ui.Popup.postHide(evt);});editor.addListener('keydown',function(t,evt){if(pastePop)pastePop.dispose(evt);var keyCode=evt.keyCode||evt.which;if(evt.altKey&&keyCode==90){UE.ui.buttons['fullscreen'].onclick();}});editor.addListener('wordcount',function(type){setCount(this,me);});function setCount(editor,ui){editor.setOpt({wordCount:true,maximumWords:10000,wordCountMsg:editor.options.wordCountMsg||editor.getLang("wordCountMsg"),wordOverFlowMsg:editor.options.wordOverFlowMsg||editor.getLang("wordOverFlowMsg")});var opt=editor.options,max=opt.maximumWords,msg=opt.wordCountMsg,errMsg=opt.wordOverFlowMsg,countDom=ui.getDom('wordcount');if(!opt.wordCount){return;}var count=editor.getContentLength(true);if(count>max){countDom.innerHTML=errMsg;editor.fireEvent("wordcountoverflow");}else{countDom.innerHTML=msg.replace("{#leave}",max-count).replace("{#count}",count);}}editor.addListener('selectionchange',function(){if(editor.options.elementPathEnabled){me[(editor.queryCommandState('elementpath')==-1?'dis':'en')+'ableElementPath']();}if(editor.options.scaleEnabled){me[(editor.queryCommandState('scale')==-1?'dis':'en')+'ableScale']();}});var popup=new baidu.editor.ui.Popup({editor:editor,content:'',className:'edui-bubble',_onEditButtonClick:function _onEditButtonClick(){this.hide();editor.ui._dialogs.linkDialog.open();},_onImgEditButtonClick:function _onImgEditButtonClick(name){this.hide();editor.ui._dialogs[name]&&editor.ui._dialogs[name].open();},_onImgSetFloat:function _onImgSetFloat(value){this.hide();editor.execCommand("imagefloat",value);},_setIframeAlign:function _setIframeAlign(value){var frame=popup.anchorEl;var newFrame=frame.cloneNode(true);switch(value){case-2:newFrame.setAttribute("align","");break;case-1:newFrame.setAttribute("align","left");break;case 1:newFrame.setAttribute("align","right");break;}frame.parentNode.insertBefore(newFrame,frame);domUtils.remove(frame);popup.anchorEl=newFrame;popup.showAnchor(popup.anchorEl);},_updateIframe:function _updateIframe(){var frame=editor._iframe=popup.anchorEl;if(domUtils.hasClass(frame,'ueditor_baidumap')){editor.selection.getRange().selectNode(frame).select();editor.ui._dialogs.mapDialog.open();popup.hide();}else{editor.ui._dialogs.insertframeDialog.open();popup.hide();}},_onRemoveButtonClick:function _onRemoveButtonClick(cmdName){editor.execCommand(cmdName);this.hide();},queryAutoHide:function queryAutoHide(el){if(el&&el.ownerDocument==editor.document){if(el.tagName.toLowerCase()=='img'||domUtils.findParentByTagName(el,'a',true)){return el!==popup.anchorEl;}}return baidu.editor.ui.Popup.prototype.queryAutoHide.call(this,el);}});popup.render();if(editor.options.imagePopup){editor.addListener('mouseover',function(t,evt){evt=evt||window.event;var el=evt.target||evt.srcElement;if(editor.ui._dialogs.insertframeDialog&&/iframe/ig.test(el.tagName)){var html=popup.formatHtml('<nobr>'+editor.getLang("property")+': <span onclick=$$._setIframeAlign(-2) class="edui-clickable">'+editor.getLang("default")+'</span>&nbsp;&nbsp;<span onclick=$$._setIframeAlign(-1) class="edui-clickable">'+editor.getLang("justifyleft")+'</span>&nbsp;&nbsp;<span onclick=$$._setIframeAlign(1) class="edui-clickable">'+editor.getLang("justifyright")+'</span>&nbsp;&nbsp;'+' <span onclick="$$._updateIframe( this);" class="edui-clickable">'+editor.getLang("modify")+'</span></nobr>');if(html){popup.getDom('content').innerHTML=html;popup.anchorEl=el;popup.showAnchor(popup.anchorEl);}else{popup.hide();}}});editor.addListener('selectionchange',function(t,causeByUi){if(!causeByUi)return;var html='',str="",img=editor.selection.getRange().getClosedNode(),dialogs=editor.ui._dialogs;if(img&&img.tagName=='IMG'){var dialogName='insertimageDialog';if(img.className.indexOf("edui-faked-video")!=-1||img.className.indexOf("edui-upload-video")!=-1){dialogName="insertvideoDialog";}if(img.className.indexOf("edui-faked-webapp")!=-1){dialogName="webappDialog";}if(img.src.indexOf("http://api.map.baidu.com")!=-1){dialogName="mapDialog";}if(img.className.indexOf("edui-faked-music")!=-1){dialogName="musicDialog";}if(img.src.indexOf("http://maps.google.com/maps/api/staticmap")!=-1){dialogName="gmapDialog";}if(img.getAttribute("anchorname")){dialogName="anchorDialog";html=popup.formatHtml('<nobr>'+editor.getLang("property")+': <span onclick=$$._onImgEditButtonClick("anchorDialog") class="edui-clickable">'+editor.getLang("modify")+'</span>&nbsp;&nbsp;'+'<span onclick=$$._onRemoveButtonClick(\'anchor\') class="edui-clickable">'+editor.getLang("delete")+'</span></nobr>');}if(img.getAttribute("word_img")){editor.word_img=[img.getAttribute("word_img")];dialogName="wordimageDialog";}if(domUtils.hasClass(img,'loadingclass')||domUtils.hasClass(img,'loaderrorclass')){dialogName="";}if(!dialogs[dialogName]){return;}str='<nobr>'+editor.getLang("property")+': '+'<span onclick=$$._onImgSetFloat("none") class="edui-clickable">'+editor.getLang("default")+'</span>&nbsp;&nbsp;'+'<span onclick=$$._onImgSetFloat("left") class="edui-clickable">'+editor.getLang("justifyleft")+'</span>&nbsp;&nbsp;'+'<span onclick=$$._onImgSetFloat("right") class="edui-clickable">'+editor.getLang("justifyright")+'</span>&nbsp;&nbsp;'+'<span onclick=$$._onImgSetFloat("center") class="edui-clickable">'+editor.getLang("justifycenter")+'</span>&nbsp;&nbsp;'+'<span onclick="$$._onImgEditButtonClick(\''+dialogName+'\');" class="edui-clickable">'+editor.getLang("modify")+'</span></nobr>';!html&&(html=popup.formatHtml(str));}if(editor.ui._dialogs.linkDialog){var link=editor.queryCommandValue('link');var url;if(link&&(url=link.getAttribute('_href')||link.getAttribute('href',2))){var txt=url;if(url.length>30){txt=url.substring(0,20)+"...";}if(html){html+='<div style="height:5px;"></div>';}html+=popup.formatHtml('<nobr>'+editor.getLang("anthorMsg")+': <a target="_blank" href="'+url+'" title="'+url+'" >'+txt+'</a>'+' <span class="edui-clickable" onclick="$$._onEditButtonClick();">'+editor.getLang("modify")+'</span>'+' <span class="edui-clickable" onclick="$$._onRemoveButtonClick(\'unlink\');"> '+editor.getLang("clear")+'</span></nobr>');popup.showAnchor(link);}}if(html){popup.getDom('content').innerHTML=html;popup.anchorEl=img||link;popup.showAnchor(popup.anchorEl);}else{popup.hide();}});}},_initToolbars:function _initToolbars(){var editor=this.editor;var toolbars=this.toolbars||[];var toolbarUis=[];for(var i=0;i<toolbars.length;i++){var toolbar=toolbars[i];var toolbarUi=new baidu.editor.ui.Toolbar({theme:editor.options.theme});for(var j=0;j<toolbar.length;j++){var toolbarItem=toolbar[j];var toolbarItemUi=null;if(typeof toolbarItem=='string'){toolbarItem=toolbarItem.toLowerCase();if(toolbarItem=='|'){toolbarItem='Separator';}if(toolbarItem=='||'){toolbarItem='Breakline';}if(baidu.editor.ui[toolbarItem]){toolbarItemUi=new baidu.editor.ui[toolbarItem](editor);}
if(toolbarItem=='fullscreen'){if(toolbarUis&&toolbarUis[0]){toolbarUis[0].items.splice(0,0,toolbarItemUi);}else{toolbarItemUi&&toolbarUi.items.splice(0,0,toolbarItemUi);}continue;}}else{toolbarItemUi=toolbarItem;}if(toolbarItemUi&&toolbarItemUi.id){toolbarUi.add(toolbarItemUi);}}toolbarUis[i]=toolbarUi;}
utils.each(UE._customizeUI,function(obj,key){var itemUI,index;if(obj.id&&obj.id!=editor.key){return false;}itemUI=obj.execFn.call(editor,editor,key);if(itemUI){index=obj.index;if(index===undefined){index=toolbarUi.items.length;}toolbarUi.add(itemUI,index);}});this.toolbars=toolbarUis;},getHtmlTpl:function getHtmlTpl(){return'<div id="##" class="%%">'+'<div id="##_toolbarbox" class="%%-toolbarbox">'+(this.toolbars.length?'<div id="##_toolbarboxouter" class="%%-toolbarboxouter"><div class="%%-toolbarboxinner">'+this.renderToolbarBoxHtml()+'</div></div>':'')+'<div id="##_toolbarmsg" class="%%-toolbarmsg" style="display:none;">'+'<div id = "##_upload_dialog" class="%%-toolbarmsg-upload" onclick="$$.showWordImageDialog();">'+this.editor.getLang("clickToUpload")+'</div>'+'<div class="%%-toolbarmsg-close" onclick="$$.hideToolbarMsg();">x</div>'+'<div id="##_toolbarmsg_label" class="%%-toolbarmsg-label"></div>'+'<div style="height:0;overflow:hidden;clear:both;"></div>'+'</div>'+'<div id="##_message_holder" class="%%-messageholder"></div>'+'</div>'+'<div id="##_iframeholder" class="%%-iframeholder">'+'</div>'+'<div id="##_bottombar" class="%%-bottomContainer"><table><tr>'+'<td id="##_elementpath" class="%%-bottombar"></td>'+'<td id="##_wordcount" class="%%-wordcount"></td>'+'<td id="##_scale" class="%%-scale"><div class="%%-icon"></div></td>'+'</tr></table></div>'+'<div id="##_scalelayer"></div>'+'</div>';},showWordImageDialog:function showWordImageDialog(){this._dialogs['wordimageDialog'].open();},renderToolbarBoxHtml:function renderToolbarBoxHtml(){var buff=[];for(var i=0;i<this.toolbars.length;i++){buff.push(this.toolbars[i].renderHtml());}return buff.join('');},setFullScreen:function setFullScreen(fullscreen){var editor=this.editor,container=editor.container.parentNode.parentNode;if(this._fullscreen!=fullscreen){this._fullscreen=fullscreen;this.editor.fireEvent('beforefullscreenchange',fullscreen);if(baidu.editor.browser.gecko){var bk=editor.selection.getRange().createBookmark();}if(fullscreen){while(container.tagName!="BODY"){var position=baidu.editor.dom.domUtils.getComputedStyle(container,"position");nodeStack.push(position);container.style.position="static";container=container.parentNode;}this._bakHtmlOverflow=document.documentElement.style.overflow;this._bakBodyOverflow=document.body.style.overflow;this._bakAutoHeight=this.editor.autoHeightEnabled;this._bakScrollTop=Math.max(document.documentElement.scrollTop,document.body.scrollTop);this._bakEditorContaninerWidth=editor.iframe.parentNode.offsetWidth;if(this._bakAutoHeight){editor.autoHeightEnabled=false;this.editor.disableAutoHeight();}document.documentElement.style.overflow='hidden';window.scrollTo(0,window.scrollY);this._bakCssText=this.getDom().style.cssText;this._bakCssText1=this.getDom('iframeholder').style.cssText;editor.iframe.parentNode.style.width='';this._updateFullScreen();}else{while(container.tagName!="BODY"){container.style.position=nodeStack.shift();container=container.parentNode;}this.getDom().style.cssText=this._bakCssText;this.getDom('iframeholder').style.cssText=this._bakCssText1;if(this._bakAutoHeight){editor.autoHeightEnabled=true;this.editor.enableAutoHeight();}document.documentElement.style.overflow=this._bakHtmlOverflow;document.body.style.overflow=this._bakBodyOverflow;editor.iframe.parentNode.style.width=this._bakEditorContaninerWidth+'px';window.scrollTo(0,this._bakScrollTop);}if(browser.gecko&&editor.body.contentEditable==='true'){var input=document.createElement('input');document.body.appendChild(input);editor.body.contentEditable=false;setTimeout(function(){input.focus();setTimeout(function(){editor.body.contentEditable=true;editor.fireEvent('fullscreenchanged',fullscreen);editor.selection.getRange().moveToBookmark(bk).select(true);baidu.editor.dom.domUtils.remove(input);fullscreen&&window.scroll(0,0);},0);},0);}if(editor.body.contentEditable==='true'){this.editor.fireEvent('fullscreenchanged',fullscreen);this.triggerLayout();}}},_updateFullScreen:function _updateFullScreen(){if(this._fullscreen){var vpRect=uiUtils.getViewportRect();this.getDom().style.cssText='border:0;position:absolute;left:0;top:'+(this.editor.options.topOffset||0)+'px;width:'+vpRect.width+'px;height:'+vpRect.height+'px;z-index:'+(this.getDom().style.zIndex*1+100);uiUtils.setViewportOffset(this.getDom(),{left:0,top:this.editor.options.topOffset||0});this.editor.setHeight(vpRect.height-this.getDom('toolbarbox').offsetHeight-this.getDom('bottombar').offsetHeight-(this.editor.options.topOffset||0),true);if(browser.gecko){try{window.onresize();}catch(e){}}}},_updateElementPath:function _updateElementPath(){var bottom=this.getDom('elementpath'),list;if(this.elementPathEnabled&&(list=this.editor.queryCommandValue('elementpath'))){var buff=[];for(var i=0,ci;ci=list[i];i++){buff[i]=this.formatHtml('<span unselectable="on" onclick="$$.editor.execCommand(&quot;elementpath&quot;, &quot;'+i+'&quot;);">'+ci+'</span>');}bottom.innerHTML='<div class="edui-editor-breadcrumb" onmousedown="return false;">'+this.editor.getLang("elementPathTip")+': '+buff.join(' &gt; ')+'</div>';}else{bottom.style.display='none';}},disableElementPath:function disableElementPath(){var bottom=this.getDom('elementpath');bottom.innerHTML='';bottom.style.display='none';this.elementPathEnabled=false;},enableElementPath:function enableElementPath(){var bottom=this.getDom('elementpath');bottom.style.display='';this.elementPathEnabled=true;this._updateElementPath();},_scale:function _scale(){var doc=document,editor=this.editor,editorHolder=editor.container,editorDocument=editor.document,toolbarBox=this.getDom("toolbarbox"),bottombar=this.getDom("bottombar"),scale=this.getDom("scale"),scalelayer=this.getDom("scalelayer");var isMouseMove=false,position=null,minEditorHeight=0,minEditorWidth=editor.options.minFrameWidth,pageX=0,pageY=0,scaleWidth=0,scaleHeight=0;function down(){position=domUtils.getXY(editorHolder);if(!minEditorHeight){minEditorHeight=editor.options.minFrameHeight+toolbarBox.offsetHeight+bottombar.offsetHeight;}scalelayer.style.cssText="position:absolute;left:0;display:;top:0;background-color:#41ABFF;opacity:0.4;filter: Alpha(opacity=40);width:"+editorHolder.offsetWidth+"px;height:"+editorHolder.offsetHeight+"px;z-index:"+(editor.options.zIndex+1);domUtils.on(doc,"mousemove",move);domUtils.on(editorDocument,"mouseup",up);domUtils.on(doc,"mouseup",up);}var me=this;this.editor.addListener('fullscreenchanged',function(e,fullScreen){if(fullScreen){me.disableScale();}else{if(me.editor.options.scaleEnabled){me.enableScale();var tmpNode=me.editor.document.createElement('span');me.editor.body.appendChild(tmpNode);me.editor.body.style.height=Math.max(domUtils.getXY(tmpNode).y,me.editor.iframe.offsetHeight-20)+'px';domUtils.remove(tmpNode);}}});function move(event){clearSelection();var e=event||window.event;pageX=e.pageX||doc.documentElement.scrollLeft+e.clientX;pageY=e.pageY||doc.documentElement.scrollTop+e.clientY;scaleWidth=pageX-position.x;scaleHeight=pageY-position.y;if(scaleWidth>=minEditorWidth){isMouseMove=true;scalelayer.style.width=scaleWidth+'px';}if(scaleHeight>=minEditorHeight){isMouseMove=true;scalelayer.style.height=scaleHeight+"px";}}function up(){if(isMouseMove){isMouseMove=false;editor.ui._actualFrameWidth=scalelayer.offsetWidth-2;editorHolder.style.width=editor.ui._actualFrameWidth+'px';editor.setHeight(scalelayer.offsetHeight-bottombar.offsetHeight-toolbarBox.offsetHeight-2,true);}if(scalelayer){scalelayer.style.display="none";}clearSelection();domUtils.un(doc,"mousemove",move);domUtils.un(editorDocument,"mouseup",up);domUtils.un(doc,"mouseup",up);}function clearSelection(){if(browser.ie)doc.selection.clear();else window.getSelection().removeAllRanges();}this.enableScale=function(){if(editor.queryCommandState("source")==1)return;scale.style.display="";this.scaleEnabled=true;domUtils.on(scale,"mousedown",down);};this.disableScale=function(){scale.style.display="none";this.scaleEnabled=false;domUtils.un(scale,"mousedown",down);};},isFullScreen:function isFullScreen(){return this._fullscreen;},postRender:function postRender(){UIBase.prototype.postRender.call(this);for(var i=0;i<this.toolbars.length;i++){this.toolbars[i].postRender();}var me=this;var timerId,domUtils=baidu.editor.dom.domUtils,updateFullScreenTime=function updateFullScreenTime(){clearTimeout(timerId);timerId=setTimeout(function(){me._updateFullScreen();});};domUtils.on(window,'resize',updateFullScreenTime);me.addListener('destroy',function(){domUtils.un(window,'resize',updateFullScreenTime);clearTimeout(timerId);});},showToolbarMsg:function showToolbarMsg(msg,flag){this.getDom('toolbarmsg_label').innerHTML=msg;this.getDom('toolbarmsg').style.display='';if(!flag){var w=this.getDom('upload_dialog');w.style.display='none';}},hideToolbarMsg:function hideToolbarMsg(){this.getDom('toolbarmsg').style.display='none';},mapUrl:function mapUrl(url){return url?url.replace('~/',this.editor.options.UEDITOR_HOME_URL||''):'';},triggerLayout:function triggerLayout(){var dom=this.getDom();if(dom.style.zoom=='1'){dom.style.zoom='100%';}else{dom.style.zoom='1';}}};utils.inherits(EditorUI,baidu.editor.ui.UIBase);var instances={};UE.ui.Editor=function(options){var editor=new UE.Editor(options);editor.options.editor=editor;utils.loadFile(document,{href:editor.options.themePath+editor.options.theme+"/css/ueditor.css",tag:"link",type:"text/css",rel:"stylesheet"});var oldRender=editor.render;editor.render=function(holder){if(holder.constructor===String){editor.key=holder;instances[holder]=editor;}utils.domReady(function(){editor.langIsReady?renderUI():editor.addListener("langReady",renderUI);function renderUI(){editor.setOpt({labelMap:editor.options.labelMap||editor.getLang('labelMap')});new EditorUI(editor.options);if(holder){if(holder.constructor===String){holder=document.getElementById(holder);}holder&&holder.getAttribute('name')&&(editor.options.textarea=holder.getAttribute('name'));if(holder&&/script|textarea/ig.test(holder.tagName)){var newDiv=document.createElement('div');holder.parentNode.insertBefore(newDiv,holder);var cont=holder.value||holder.innerHTML;editor.options.initialContent=/^[\t\r\n ]*$/.test(cont)?editor.options.initialContent:cont.replace(/>[\n\r\t]+([ ]{4})+/g,'>').replace(/[\n\r\t]+([ ]{4})+</g,'<').replace(/>[\n\r\t]+</g,'><');holder.className&&(newDiv.className=holder.className);holder.style.cssText&&(newDiv.style.cssText=holder.style.cssText);if(/textarea/i.test(holder.tagName)){editor.textarea=holder;editor.textarea.style.display='none';}else{holder.parentNode.removeChild(holder);}if(holder.id){newDiv.id=holder.id;domUtils.removeAttributes(holder,'id');}holder=newDiv;holder.innerHTML='';}}domUtils.addClass(holder,"edui-"+editor.options.theme);editor.ui.render(holder);var opt=editor.options;editor.container=editor.ui.getDom();var parents=domUtils.findParents(holder,true);var displays=[];for(var i=0,ci;ci=parents[i];i++){displays[i]=ci.style.display;ci.style.display='block';}if(opt.initialFrameWidth){opt.minFrameWidth=opt.initialFrameWidth;}else{opt.minFrameWidth=opt.initialFrameWidth=holder.offsetWidth;var styleWidth=holder.style.width;if(/%$/.test(styleWidth)){opt.initialFrameWidth=styleWidth;}}if(opt.initialFrameHeight){opt.minFrameHeight=opt.initialFrameHeight;}else{opt.initialFrameHeight=opt.minFrameHeight=holder.offsetHeight;}for(var i=0,ci;ci=parents[i];i++){ci.style.display=displays[i];}
if(holder.style.height){holder.style.height='';}editor.container.style.width=opt.initialFrameWidth+(/%$/.test(opt.initialFrameWidth)?'':'px');editor.container.style.zIndex=opt.zIndex;oldRender.call(editor,editor.ui.getDom('iframeholder'));editor.fireEvent("afteruiready");}});};return editor;};UE.getEditor=function(id,opt){var editor=instances[id];if(!editor){editor=instances[id]=new UE.ui.Editor(opt);editor.render(id);}return editor;};UE.delEditor=function(id){var editor;if(editor=instances[id]){editor.key&&editor.destroy();delete instances[id];}};UE.insertPic=function(ueditor){if(!ueditor)return;var bodyEditor=ueditor.body;var btnInsertPic=ueditor.container.querySelector('.edui-for-simpleupload');var input=document.createElement('input');var range;input.type='file';input.accept="image/*";input.style.display="none";btnInsertPic.appendChild(input);bodyEditor.onclick=function(){range=ueditor.window.getSelection().getRangeAt(0);};if(typeof FileReader==='undefined'){alert("抱歉，你的浏览器不支持 FileReader");input.setAttribute('disabled','disabled');}else{input.addEventListener('change',readFile,false);}btnInsertPic.onclick=function(e){input.click();e.stopPropagation();};function readFile(e){e.stopPropagation();var file=this.files[0];if(!/image\/\w+/.test(file.type)){alert("文件必须为图片！");return false;}var reader=new FileReader();reader.readAsDataURL(file);reader.onload=function(e){var img=document.createElement('img');img.src=this.result;if(range){range.insertNode(img);}else{bodyEditor.appendChild(img);}};}};UE.registerUI=function(uiName,fn,index,editorId){utils.each(uiName.split(/\s+/),function(name){UE._customizeUI[name]={id:editorId,execFn:fn,index:index};});};})();UE.registerUI('message',function(editor){var editorui=baidu.editor.ui;var Message=editorui.Message;var holder;var _messageItems=[];var me=editor;me.addListener('ready',function(){holder=document.getElementById(me.ui.id+'_message_holder');updateHolderPos();setTimeout(function(){updateHolderPos();},500);});me.addListener('showmessage',function(type,opt){opt=utils.isString(opt)?{'content':opt}:opt;var message=new Message({'timeout':opt.timeout,'type':opt.type,'content':opt.content,'keepshow':opt.keepshow,'editor':me}),mid=opt.id||'msg_'+(+new Date()).toString(36);message.render(holder);_messageItems[mid]=message;message.reset(opt);updateHolderPos();return mid;});me.addListener('updatemessage',function(type,id,opt){opt=utils.isString(opt)?{'content':opt}:opt;var message=_messageItems[id];message.render(holder);message&&message.reset(opt);});me.addListener('hidemessage',function(type,id){var message=_messageItems[id];message&&message.hide();});function updateHolderPos(){var toolbarbox=me.ui.getDom('toolbarbox');if(toolbarbox){holder.style.top=toolbarbox.offsetHeight+3+'px';}holder.style.zIndex=Math.max(me.options.zIndex,me.iframe.style.zIndex)+1;}});UE.registerUI('autosave',function(editor){var timer=null,uid=null;editor.on('afterautosave',function(){clearTimeout(timer);timer=setTimeout(function(){if(uid){editor.trigger('hidemessage',uid);}uid=editor.trigger('showmessage',{content:editor.getLang('autosave.success'),timeout:50000});},50000);});});})();var Stopwatch=function(){Stopwatch=function Stopwatch(){};Stopwatch.prototype={startTime:0,running:false,elapsedTime:0,start:function start(){this.startTime=+new Date();this.elapsedTime=0;this.running=true;},stop:function stop(){this.elapsedTime=+new Date()-this.startTime;this.running=false;},getElapsedTime:function getElapsedTime(){if(this.running)return+new Date()-this.startTime;else return this.elapsedTime;},reset:function reset(){this.elapsedTime=0;this.startTime=0;this.running=false;}};return Stopwatch;}();var TimerAnimation=function(){function TimerAnimation(duration,timeWarp){this.timeWarp=timeWarp;if(duration!==undefined)this.duration=duration;else this.duration=1000;this.stopwatch=new Stopwatch();};TimerAnimation.prototype={start:function start(){this.stopwatch.start();},stop:function stop(){this.stopwatch.stop();},getRealElapsedTime:function getRealElapsedTime(){return this.stopwatch.getElapsedTime();},getElapsedTime:function getElapsedTime(){var elapsedTime=this.stopwatch.getElapsedTime(),percentComplete=elapsedTime/this.duration;if(!this.stopwatch.running)return undefined;if(this.timeWarp==undefined)return elapsedTime;return elapsedTime*(this.timeWarp(percentComplete)/percentComplete);},isRunning:function isRunning(){return this.stopwatch.running;},isOver:function isOver(){return this.stopwatch.getElapsedTime()>this.duration;},reset:function reset(){this.stopwatch.reset();}};TimerAnimation.makeEaseOut=function(strength){return function(percentComplete){return 1-Math.pow(1-percentComplete,strength*2);};};TimerAnimation.makeEaseIn=function(strength){return function(percentComplete){return Math.pow(percentComplete,strength*2);};};TimerAnimation.makeEaseInOut=function(){return function(percentComplete){return percentComplete-Math.sin(percentComplete*2*Math.PI)/(2*Math.PI);};};TimerAnimation.makeElastic=function(passes){passes=passes||3;return function(percentComplete){return(1-Math.cos(percentComplete*Math.PI*passes))*(1-percentComplete)+percentComplete;};};TimerAnimation.makeBounce=function(bounces){var fn=AnimationTimer.makeElastic(bounces);return function(percentComplete){percentComplete=fn(percentComplete);return percentComplete<=1?percentComplete:2-percentComplete;};};TimerAnimation.makeLinear=function(){return function(percentComplete){return percentComplete;};};return TimerAnimation;}();var ImagePainter=function ImagePainter(imageUrl){this.image=new Image();this.image.src=imageUrl;};ImagePainter.prototype={image:undefined,paint:function paint(sprite,context){if(this.image!==undefined){if(!this.image.complete){this.image.onload=function(e){sprite.width=this.width;sprite.height=this.height;context.drawImage(this,sprite.x,sprite.y,sprite.width,sprite.height);};}else{context.drawImage(this.image,sprite.x,sprite.y,sprite.width,sprite.height);}}}};SpriteSheetPainter=function SpriteSheetPainter(cells){this.cells=cells;};SpriteSheetPainter.prototype={cells:[],cellIndex:0,advance:function advance(){if(this.cellIndex==this.cells.length-1){this.cellIndex=0;}else{this.cellIndex++;}},paint:function paint(sprite,context){var cell=this.cells[this.cellIndex];context.drawImage(spritesheet,cell.left,cell.top,cell.width,cell.height,sprite.left,sprite.top,cell.width,cell.height);}};var SpriteAnimator=function SpriteAnimator(painters,elapsedCallback){this.painters=painters;if(elapsedCallback){this.elapsedCallback=elapsedCallback;}};SpriteAnimator.prototype={painters:[],duration:1000,startTime:0,index:0,elapsedCallback:undefined,end:function end(sprite,originalPainter){sprite.animating=false;if(this.elapsedCallback){this.elapsedCallback(sprite);}else{sprite.painter=originalPainter;}},start:function start(sprite,duration){var endTime=+new Date()+duration,period=duration/this.painters.length,interval=undefined,animator=this,originalPainter=sprite.painter;this.index=0;sprite.animating=true;sprite.painter=this.painters[this.index];interval=setInterval(function(){if(+new Date()<endTime){sprite.painter=animator.painters[++animator.index];}else{animator.end(sprite,originalPainter);clearInterval(interval);}},period);}};var Sprite=function Sprite(id,painter,behaviors){if(id!==undefined)this.id=id;if(painter!==undefined)this.painter=painter;if(behaviors!==undefined)this.behaviors=behaviors;return this;};Sprite.prototype={x:0,y:0,width:10,height:10,velocityX:0,velocityY:0,visible:true,animating:false,painter:undefined,behaviors:[],paint:function paint(context){if(this.painter!==undefined&&this.visible){this.painter.paint(this,context);}},update:function update(context,time){for(var i=this.behaviors.length;i>0;--i){this.behaviors[i-1].execute(this,context,time);}}};var HitModel=function(){function HitModel(canvas){this.list={};this.scaleX=1;this.scaleY=1;this.scaleBoxX=undefined;this.scaleBoxY=undefined;this.rectLeft=undefined;this.rectTop=undefined;this.currentId=undefined;this.canvas=canvas;this.setScale(canvas);}
HitModel.prototype={add:function add(id,type,x,y,width,height){if(!this.list[type])this.list[type]={};this.list[type][id]={startX:x,startY:y,endX:x+width,endY:y+height};},clear:function clear(){this.list={};},remove:function remove(type,id){if(arguments.length===1){if(this.list[type]){this.list[type]=null;}}else if(arguments.length>1){if(this.list[type]&&this.list[type][id]){this.list[type][id]=null;}}},isHit:function isHit(x,y,hitModel){if(!(x&&y))return false;if(hitModel.startX>x||x>hitModel.endX)return false;if(hitModel.startY>y||y>hitModel.endY)return false;return true;},firstHitId:function firstHitId(_x,_y,_type){var obj=this.convertToCanvasPosition(_x,_y);if(_type){for(var key in this.list[_type]){if(this.isHit(obj.x,obj.y,this.list[_type][key])){return{id:key,type:_type};}}}else{for(var type in this.list){for(var key in this.list[type]){if(this.isHit(obj.x,obj.y,this.list[type][key])){return{id:key,type:type};}}}}
return null;},setScale:function setScale(canvas){var rect=canvas.getBoundingClientRect();this.scaleBoxX=canvas.width/rect.width;this.scaleBoxY=canvas.height/rect.height;this.rectLeft=rect.left*this.scaleBoxX;this.rectTop=rect.top*this.scaleBoxY;},convertToCanvasPosition:function convertToCanvasPosition(x,y){var rect=this.canvas.getBoundingClientRect();return{x:(x-rect.left-this.canvas.scrollLeft)*this.scaleX,y:(y-rect.top-this.canvas.scrollTop)*this.scaleY};}};return HitModel;}();StringTools={};StringTools.wordWrap=function(context,x,y,width,text,options){var strs=new Array();var str="";for(var i=0;i<text.length;i++){str+=text[i];if(context.measureText(str).width>width-8){strs.push(str);str="";}}
strs.push(str);var size=context.font.split("px")[0];size=size.split(' ');size=size[size.length-1];var heigth=parseInt(size)*4/3;for(var i=0;i<strs.length;i++){context.fillText(strs[i],x,y+heigth*i);}};StringTools.getRealStringLength=function(str){var length=0;for(i=0;i<str.length;i++){if((str.charCodeAt(i)&0xff00)!=0){length++;}
length++;}
return length;};var CanvasGeometry=function(){function CanvasGeometry(){};CanvasGeometry.fillRadiusRect=function(ctx,x,y,width,height,radius){ctx.beginPath();ctx.moveTo(x+radius,y);ctx.arcTo(x+width,y,x+width,y+height,radius);ctx.arcTo(x+width,y+height,x,y+height,radius);ctx.arcTo(x,y+height,x,y,radius);ctx.arcTo(x,y,x+width,y,radius);ctx.closePath();};return CanvasGeometry;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(){"use strict";var root=this,previous=root.Chart;var Chart=function Chart(context){var chart=this;this.canvas=context.canvas;this.ctx=context;var width=this.width=context.canvas.width;var height=this.height=context.canvas.height;this.aspectRatio=this.width/this.height;helpers.retinaScale(this);return this;};Chart.defaults={global:{animation:true,animationSteps:60,animationEasing:"easeOutQuart",showScale:true,scaleOverride:false,scaleSteps:null,scaleStepWidth:null,scaleStartValue:null,scaleLineColor:"rgba(0,0,0,.1)",scaleLineWidth:1,scaleShowLabels:true,scaleLabel:"<%=value%>",scaleIntegersOnly:true,scaleBeginAtZero:false,scaleFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",scaleFontSize:12,scaleFontStyle:"normal",scaleFontColor:"#666",responsive:false,maintainAspectRatio:true,showTooltips:true,tooltipEvents:["mousemove","touchstart","touchmove","mouseout"],tooltipFillColor:"rgba(0,0,0,0.8)",tooltipFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",tooltipFontSize:14,tooltipFontStyle:"normal",tooltipFontColor:"#fff",tooltipTitleFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",tooltipTitleFontSize:14,tooltipTitleFontStyle:"bold",tooltipTitleFontColor:"#fff",tooltipYPadding:6,tooltipXPadding:6,tooltipCaretSize:8,tooltipCornerRadius:6,tooltipXOffset:10,tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value %>",multiTooltipTemplate:"<%= value %>",multiTooltipKeyBackground:'#fff',onAnimationProgress:function onAnimationProgress(){},onAnimationComplete:function onAnimationComplete(){}}};Chart.types={};var helpers=Chart.helpers={};var each=helpers.each=function(loopable,callback,self){var additionalArgs=Array.prototype.slice.call(arguments,3);if(loopable){if(loopable.length===+loopable.length){var i;for(i=0;i<loopable.length;i++){callback.apply(self,[loopable[i],i].concat(additionalArgs));}}else{for(var item in loopable){callback.apply(self,[loopable[item],item].concat(additionalArgs));}}}},clone=helpers.clone=function(obj){var objClone={};each(obj,function(value,key){if(obj.hasOwnProperty(key))objClone[key]=value;});return objClone;},extend=helpers.extend=function(base){each(Array.prototype.slice.call(arguments,1),function(extensionObject){each(extensionObject,function(value,key){if(extensionObject.hasOwnProperty(key))base[key]=value;});});return base;},merge=helpers.merge=function(base,master){var args=Array.prototype.slice.call(arguments,0);args.unshift({});return extend.apply(null,args);},indexOf=helpers.indexOf=function(arrayToSearch,item){if(Array.prototype.indexOf){return arrayToSearch.indexOf(item);}else{for(var i=0;i<arrayToSearch.length;i++){if(arrayToSearch[i]===item)return i;}return-1;}},where=helpers.where=function(collection,filterCallback){var filtered=[];helpers.each(collection,function(item){if(filterCallback(item)){filtered.push(item);}});return filtered;},findNextWhere=helpers.findNextWhere=function(arrayToSearch,filterCallback,startIndex){if(!startIndex){startIndex=-1;}for(var i=startIndex+1;i<arrayToSearch.length;i++){var currentItem=arrayToSearch[i];if(filterCallback(currentItem)){return currentItem;}};},findPreviousWhere=helpers.findPreviousWhere=function(arrayToSearch,filterCallback,startIndex){if(!startIndex){startIndex=arrayToSearch.length;}for(var i=startIndex-1;i>=0;i--){var currentItem=arrayToSearch[i];if(filterCallback(currentItem)){return currentItem;}};},inherits=helpers.inherits=function(extensions){var parent=this;var ChartElement=extensions&&extensions.hasOwnProperty("constructor")?extensions.constructor:function(){return parent.apply(this,arguments);};var Surrogate=function Surrogate(){this.constructor=ChartElement;};Surrogate.prototype=parent.prototype;ChartElement.prototype=new Surrogate();ChartElement.extend=inherits;if(extensions)extend(ChartElement.prototype,extensions);ChartElement.__super__=parent.prototype;return ChartElement;},noop=helpers.noop=function(){},uid=helpers.uid=function(){var id=0;return function(){return"chart-"+id++;};}(),warn=helpers.warn=function(str){if(window.console&&typeof window.console.warn=="function")console.warn(str);},amd=helpers.amd=typeof define=='function'&&define.amd,isNumber=helpers.isNumber=function(n){return!isNaN(parseFloat(n))&&isFinite(n);},max=helpers.max=function(array){return Math.max.apply(Math,array);},min=helpers.min=function(array){return Math.min.apply(Math,array);},cap=helpers.cap=function(valueToCap,maxValue,minValue){if(isNumber(maxValue)){if(valueToCap>maxValue){return maxValue;}}else if(isNumber(minValue)){if(valueToCap<minValue){return minValue;}}return valueToCap;},getDecimalPlaces=helpers.getDecimalPlaces=function(num){if(num%1!==0&&isNumber(num)){return num.toString().split(".")[1].length;}else{return 0;}},toRadians=helpers.radians=function(degrees){return degrees*(Math.PI/180);},getAngleFromPoint=helpers.getAngleFromPoint=function(centrePoint,anglePoint){var distanceFromXCenter=anglePoint.x-centrePoint.x,distanceFromYCenter=anglePoint.y-centrePoint.y,radialDistanceFromCenter=Math.sqrt(distanceFromXCenter*distanceFromXCenter+distanceFromYCenter*distanceFromYCenter);var angle=Math.PI*2+Math.atan2(distanceFromYCenter,distanceFromXCenter);if(distanceFromXCenter<0&&distanceFromYCenter<0){angle+=Math.PI*2;}return{angle:angle,distance:radialDistanceFromCenter};},aliasPixel=helpers.aliasPixel=function(pixelWidth){return pixelWidth%2===0?0:0.5;},splineCurve=helpers.splineCurve=function(FirstPoint,MiddlePoint,AfterPoint,t){var d01=Math.sqrt(Math.pow(MiddlePoint.x-FirstPoint.x,2)+Math.pow(MiddlePoint.y-FirstPoint.y,2)),d12=Math.sqrt(Math.pow(AfterPoint.x-MiddlePoint.x,2)+Math.pow(AfterPoint.y-MiddlePoint.y,2)),fa=t*d01/(d01+d12),fb=t*d12/(d01+d12);return{inner:{x:MiddlePoint.x-fa*(AfterPoint.x-FirstPoint.x),y:MiddlePoint.y-fa*(AfterPoint.y-FirstPoint.y)},outer:{x:MiddlePoint.x+fb*(AfterPoint.x-FirstPoint.x),y:MiddlePoint.y+fb*(AfterPoint.y-FirstPoint.y)}};},calculateOrderOfMagnitude=helpers.calculateOrderOfMagnitude=function(val){return Math.floor(Math.log(val)/Math.LN10);},calculateScaleRange=helpers.calculateScaleRange=function(valuesArray,drawingSize,textSize,startFromZero,integersOnly){var minSteps=2,maxSteps=Math.floor(drawingSize/(textSize*1.5)),skipFitting=minSteps>=maxSteps;var maxValue=max(valuesArray),minValue=min(valuesArray);if(maxValue===minValue){maxValue+=0.5;if(minValue>=0.5&&!startFromZero){minValue-=0.5;}else{maxValue+=0.5;}}var valueRange=Math.abs(maxValue-minValue),rangeOrderOfMagnitude=calculateOrderOfMagnitude(valueRange),graphMax=Math.ceil(maxValue/(1*Math.pow(10,rangeOrderOfMagnitude)))*Math.pow(10,rangeOrderOfMagnitude),graphMin=startFromZero?0:Math.floor(minValue/(1*Math.pow(10,rangeOrderOfMagnitude)))*Math.pow(10,rangeOrderOfMagnitude),graphRange=graphMax-graphMin,stepValue=Math.pow(10,rangeOrderOfMagnitude),numberOfSteps=Math.round(graphRange/stepValue);while((numberOfSteps>maxSteps||numberOfSteps*2<maxSteps)&&!skipFitting){if(numberOfSteps>maxSteps){stepValue*=2;numberOfSteps=Math.round(graphRange/stepValue);if(numberOfSteps%1!==0){skipFitting=true;}}
else{if(integersOnly&&rangeOrderOfMagnitude>=0){if(stepValue/2%1===0){stepValue/=2;numberOfSteps=Math.round(graphRange/stepValue);}
else{break;}}
else{stepValue/=2;numberOfSteps=Math.round(graphRange/stepValue);}}}if(skipFitting){numberOfSteps=minSteps;stepValue=graphRange/numberOfSteps;}return{steps:numberOfSteps,stepValue:stepValue,min:graphMin,max:graphMin+numberOfSteps*stepValue};},template=helpers.template=function(templateString,valuesObject){if(templateString instanceof Function){return templateString(valuesObject);}var cache={};function tmpl(str,data){var fn=!/\W/.test(str)?cache[str]=cache[str]:new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return data?fn(data):fn;}return tmpl(templateString,valuesObject);},generateLabels=helpers.generateLabels=function(templateString,numberOfSteps,graphMin,stepValue){var labelsArray=new Array(numberOfSteps);if(labelTemplateString){each(labelsArray,function(val,index){labelsArray[index]=template(templateString,{value:graphMin+stepValue*(index+1)});});}return labelsArray;},easingEffects=helpers.easingEffects={linear:function linear(t){return t;},easeInQuad:function easeInQuad(t){return t*t;},easeOutQuad:function easeOutQuad(t){return-1*t*(t-2);},easeInOutQuad:function easeInOutQuad(t){if((t/=1/2)<1)return 1/2*t*t;return-1/2*(--t*(t-2)-1);},easeInCubic:function easeInCubic(t){return t*t*t;},easeOutCubic:function easeOutCubic(t){return 1*((t=t/1-1)*t*t+1);},easeInOutCubic:function easeInOutCubic(t){if((t/=1/2)<1)return 1/2*t*t*t;return 1/2*((t-=2)*t*t+2);},easeInQuart:function easeInQuart(t){return t*t*t*t;},easeOutQuart:function easeOutQuart(t){return-1*((t=t/1-1)*t*t*t-1);},easeInOutQuart:function easeInOutQuart(t){if((t/=1/2)<1)return 1/2*t*t*t*t;return-1/2*((t-=2)*t*t*t-2);},easeInQuint:function easeInQuint(t){return 1*(t/=1)*t*t*t*t;},easeOutQuint:function easeOutQuint(t){return 1*((t=t/1-1)*t*t*t*t+1);},easeInOutQuint:function easeInOutQuint(t){if((t/=1/2)<1)return 1/2*t*t*t*t*t;return 1/2*((t-=2)*t*t*t*t+2);},easeInSine:function easeInSine(t){return-1*Math.cos(t/1*(Math.PI/2))+1;},easeOutSine:function easeOutSine(t){return 1*Math.sin(t/1*(Math.PI/2));},easeInOutSine:function easeInOutSine(t){return-1/2*(Math.cos(Math.PI*t/1)-1);},easeInExpo:function easeInExpo(t){return t===0?1:1*Math.pow(2,10*(t/1-1));},easeOutExpo:function easeOutExpo(t){return t===1?1:1*(-Math.pow(2,-10*t/1)+1);},easeInOutExpo:function easeInOutExpo(t){if(t===0)return 0;if(t===1)return 1;if((t/=1/2)<1)return 1/2*Math.pow(2,10*(t-1));return 1/2*(-Math.pow(2,-10*--t)+2);},easeInCirc:function easeInCirc(t){if(t>=1)return t;return-1*(Math.sqrt(1-(t/=1)*t)-1);},easeOutCirc:function easeOutCirc(t){return 1*Math.sqrt(1-(t=t/1-1)*t);},easeInOutCirc:function easeInOutCirc(t){if((t/=1/2)<1)return-1/2*(Math.sqrt(1-t*t)-1);return 1/2*(Math.sqrt(1-(t-=2)*t)+1);},easeInElastic:function easeInElastic(t){var s=1.70158;var p=0;var a=1;if(t===0)return 0;if((t/=1)==1)return 1;if(!p)p=1*0.3;if(a<Math.abs(1)){a=1;s=p/4;}else s=p/(2*Math.PI)*Math.asin(1/a);return-(a*Math.pow(2,10*(t-=1))*Math.sin((t*1-s)*(2*Math.PI)/p));},easeOutElastic:function easeOutElastic(t){var s=1.70158;var p=0;var a=1;if(t===0)return 0;if((t/=1)==1)return 1;if(!p)p=1*0.3;if(a<Math.abs(1)){a=1;s=p/4;}else s=p/(2*Math.PI)*Math.asin(1/a);return a*Math.pow(2,-10*t)*Math.sin((t*1-s)*(2*Math.PI)/p)+1;},easeInOutElastic:function easeInOutElastic(t){var s=1.70158;var p=0;var a=1;if(t===0)return 0;if((t/=1/2)==2)return 1;if(!p)p=1*(0.3*1.5);if(a<Math.abs(1)){a=1;s=p/4;}else s=p/(2*Math.PI)*Math.asin(1/a);if(t<1)return-0.5*(a*Math.pow(2,10*(t-=1))*Math.sin((t*1-s)*(2*Math.PI)/p));return a*Math.pow(2,-10*(t-=1))*Math.sin((t*1-s)*(2*Math.PI)/p)*0.5+1;},easeInBack:function easeInBack(t){var s=1.70158;return 1*(t/=1)*t*((s+1)*t-s);},easeOutBack:function easeOutBack(t){var s=1.70158;return 1*((t=t/1-1)*t*((s+1)*t+s)+1);},easeInOutBack:function easeInOutBack(t){var s=1.70158;if((t/=1/2)<1)return 1/2*(t*t*(((s*=1.525)+1)*t-s));return 1/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2);},easeInBounce:function easeInBounce(t){return 1-easingEffects.easeOutBounce(1-t);},easeOutBounce:function easeOutBounce(t){if((t/=1)<1/2.75){return 1*(7.5625*t*t);}else if(t<2/2.75){return 1*(7.5625*(t-=1.5/2.75)*t+0.75);}else if(t<2.5/2.75){return 1*(7.5625*(t-=2.25/2.75)*t+0.9375);}else{return 1*(7.5625*(t-=2.625/2.75)*t+0.984375);}},easeInOutBounce:function easeInOutBounce(t){if(t<1/2)return easingEffects.easeInBounce(t*2)*0.5;return easingEffects.easeOutBounce(t*2-1)*0.5+1*0.5;}},requestAnimFrame=helpers.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return window.setTimeout(callback,1000/60);};}(),cancelAnimFrame=helpers.cancelAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(callback){return window.clearTimeout(callback,1000/60);};}(),animationLoop=helpers.animationLoop=function(callback,totalSteps,easingString,onProgress,onComplete,chartInstance){var currentStep=0,easingFunction=easingEffects[easingString]||easingEffects.linear;var animationFrame=function animationFrame(){currentStep++;var stepDecimal=currentStep/totalSteps;var easeDecimal=easingFunction(stepDecimal);callback.call(chartInstance,easeDecimal,stepDecimal,currentStep);onProgress.call(chartInstance,easeDecimal,stepDecimal);if(currentStep<totalSteps){chartInstance.animationFrame=requestAnimFrame(animationFrame);}else{onComplete.apply(chartInstance);}};requestAnimFrame(animationFrame);},getRelativePosition=helpers.getRelativePosition=function(evt){var mouseX,mouseY;var e=evt.originalEvent||evt,canvas=evt.currentTarget||evt.srcElement,boundingRect=canvas.getBoundingClientRect();if(e.touches){mouseX=e.touches[0].clientX-boundingRect.left;mouseY=e.touches[0].clientY-boundingRect.top;}else{mouseX=e.clientX-boundingRect.left;mouseY=e.clientY-boundingRect.top;}return{x:mouseX,y:mouseY};},addEvent=helpers.addEvent=function(node,eventType,method){if(node.addEventListener){node.addEventListener(eventType,method);}else if(node.attachEvent){node.attachEvent("on"+eventType,method);}else{node["on"+eventType]=method;}},removeEvent=helpers.removeEvent=function(node,eventType,handler){if(node.removeEventListener){node.removeEventListener(eventType,handler,false);}else if(node.detachEvent){node.detachEvent("on"+eventType,handler);}else{node["on"+eventType]=noop;}},bindEvents=helpers.bindEvents=function(chartInstance,arrayOfEvents,handler){if(!chartInstance.events)chartInstance.events={};each(arrayOfEvents,function(eventName){chartInstance.events[eventName]=function(){handler.apply(chartInstance,arguments);};addEvent(chartInstance.chart.canvas,eventName,chartInstance.events[eventName]);});},unbindEvents=helpers.unbindEvents=function(chartInstance,arrayOfEvents){each(arrayOfEvents,function(handler,eventName){removeEvent(chartInstance.chart.canvas,eventName,handler);});},getMaximumWidth=helpers.getMaximumWidth=function(domNode){var container=domNode.parentNode;return container.clientWidth;},getMaximumHeight=helpers.getMaximumHeight=function(domNode){var container=domNode.parentNode;return container.clientHeight;},getMaximumSize=helpers.getMaximumSize=helpers.getMaximumWidth,retinaScale=helpers.retinaScale=function(chart){var ctx=chart.ctx,width=chart.canvas.width,height=chart.canvas.height;if(window.devicePixelRatio){ctx.canvas.style.width=width+"px";ctx.canvas.style.height=height+"px";ctx.canvas.height=height*window.devicePixelRatio;ctx.canvas.width=width*window.devicePixelRatio;ctx.scale(window.devicePixelRatio,window.devicePixelRatio);}},_clear=helpers.clear=function(chart){chart.ctx.clearRect(0,0,chart.width,chart.height);},fontString=helpers.fontString=function(pixelSize,fontStyle,fontFamily){return fontStyle+" "+pixelSize+"px "+fontFamily;},longestText=helpers.longestText=function(ctx,font,arrayOfStrings){ctx.font=font;var longest=0;each(arrayOfStrings,function(string){var textWidth=ctx.measureText(string).width;longest=textWidth>longest?textWidth:longest;});return longest;},drawRoundedRectangle=helpers.drawRoundedRectangle=function(ctx,x,y,width,height,radius){ctx.beginPath();ctx.moveTo(x+radius,y);ctx.lineTo(x+width-radius,y);ctx.quadraticCurveTo(x+width,y,x+width,y+radius);ctx.lineTo(x+width,y+height-radius);ctx.quadraticCurveTo(x+width,y+height,x+width-radius,y+height);ctx.lineTo(x+radius,y+height);ctx.quadraticCurveTo(x,y+height,x,y+height-radius);ctx.lineTo(x,y+radius);ctx.quadraticCurveTo(x,y,x+radius,y);ctx.closePath();};Chart.instances={};Chart.Type=function(data,options,chart){this.options=options;this.chart=chart;this.id=uid();Chart.instances[this.id]=this;if(options.responsive){this.resize();}this.initialize.call(this,data);};extend(Chart.Type.prototype,{initialize:function initialize(){return this;},clear:function clear(){_clear(this.chart);return this;},stop:function stop(){helpers.cancelAnimFrame.call(root,this.animationFrame);return this;},resize:function resize(callback){this.stop();var canvas=this.chart.canvas,newWidth=getMaximumWidth(this.chart.canvas),newHeight=this.options.maintainAspectRatio?newWidth/this.chart.aspectRatio:getMaximumHeight(this.chart.canvas);canvas.width=this.chart.width=newWidth;canvas.height=this.chart.height=newHeight;retinaScale(this.chart);if(typeof callback==="function"){callback.apply(this,Array.prototype.slice.call(arguments,1));}return this;},reflow:noop,render:function render(reflow){if(reflow){this.reflow();}if(this.options.animation&&!reflow){helpers.animationLoop(this.draw,this.options.animationSteps,this.options.animationEasing,this.options.onAnimationProgress,this.options.onAnimationComplete,this);}else{this.draw();this.options.onAnimationComplete.call(this);}return this;},generateLegend:function generateLegend(){return template(this.options.legendTemplate,this);},destroy:function destroy(){this.clear();unbindEvents(this,this.events);delete Chart.instances[this.id];},showTooltip:function showTooltip(ChartElements,forceRedraw){if(typeof this.activeElements==='undefined')this.activeElements=[];var isChanged=function(Elements){var changed=false;if(Elements.length!==this.activeElements.length){changed=true;return changed;}each(Elements,function(element,index){if(element!==this.activeElements[index]){changed=true;}},this);return changed;}.call(this,ChartElements);if(!isChanged&&!forceRedraw){return;}else{this.activeElements=ChartElements;}this.draw();if(ChartElements.length>0){if(this.datasets&&this.datasets.length>1){var dataArray,dataIndex;for(var i=this.datasets.length-1;i>=0;i--){dataArray=this.datasets[i].points||this.datasets[i].bars||this.datasets[i].segments;dataIndex=indexOf(dataArray,ChartElements[0]);if(dataIndex!==-1){break;}}var tooltipLabels=[],tooltipColors=[],medianPosition=function(index){var Elements=[],dataCollection,xPositions=[],yPositions=[],xMax,yMax,xMin,yMin;helpers.each(this.datasets,function(dataset){dataCollection=dataset.points||dataset.bars||dataset.segments;if(dataCollection[dataIndex]&&dataCollection[dataIndex].hasValue()){Elements.push(dataCollection[dataIndex]);}});helpers.each(Elements,function(element){xPositions.push(element.x);yPositions.push(element.y);tooltipLabels.push(helpers.template(this.options.multiTooltipTemplate,element));tooltipColors.push({fill:element._saved.fillColor||element.fillColor,stroke:element._saved.strokeColor||element.strokeColor});},this);yMin=min(yPositions);yMax=max(yPositions);xMin=min(xPositions);xMax=max(xPositions);return{x:xMin>this.chart.width/2?xMin:xMax,y:(yMin+yMax)/2};}.call(this,dataIndex);new Chart.MultiTooltip({x:medianPosition.x,y:medianPosition.y,xPadding:this.options.tooltipXPadding,yPadding:this.options.tooltipYPadding,xOffset:this.options.tooltipXOffset,fillColor:this.options.tooltipFillColor,textColor:this.options.tooltipFontColor,fontFamily:this.options.tooltipFontFamily,fontStyle:this.options.tooltipFontStyle,fontSize:this.options.tooltipFontSize,titleTextColor:this.options.tooltipTitleFontColor,titleFontFamily:this.options.tooltipTitleFontFamily,titleFontStyle:this.options.tooltipTitleFontStyle,titleFontSize:this.options.tooltipTitleFontSize,cornerRadius:this.options.tooltipCornerRadius,labels:tooltipLabels,legendColors:tooltipColors,legendColorBackground:this.options.multiTooltipKeyBackground,title:ChartElements[0].label,chart:this.chart,ctx:this.chart.ctx}).draw();}else{each(ChartElements,function(Element){var tooltipPosition=Element.tooltipPosition();new Chart.Tooltip({x:Math.round(tooltipPosition.x),y:Math.round(tooltipPosition.y),xPadding:this.options.tooltipXPadding,yPadding:this.options.tooltipYPadding,fillColor:this.options.tooltipFillColor,textColor:this.options.tooltipFontColor,fontFamily:this.options.tooltipFontFamily,fontStyle:this.options.tooltipFontStyle,fontSize:this.options.tooltipFontSize,caretHeight:this.options.tooltipCaretSize,cornerRadius:this.options.tooltipCornerRadius,text:template(this.options.tooltipTemplate,Element),chart:this.chart}).draw();},this);}}return this;},toBase64Image:function toBase64Image(){return this.chart.canvas.toDataURL.apply(this.chart.canvas,arguments);}});Chart.Type.extend=function(extensions){var parent=this;var ChartType=function ChartType(){return parent.apply(this,arguments);};ChartType.prototype=clone(parent.prototype);extend(ChartType.prototype,extensions);ChartType.extend=Chart.Type.extend;if(extensions.name||parent.prototype.name){var chartName=extensions.name||parent.prototype.name;var baseDefaults=Chart.defaults[parent.prototype.name]?clone(Chart.defaults[parent.prototype.name]):{};Chart.defaults[chartName]=extend(baseDefaults,extensions.defaults);Chart.types[chartName]=ChartType;Chart.prototype[chartName]=function(data,options){var config=merge(Chart.defaults.global,Chart.defaults[chartName],options||{});return new ChartType(data,config,this);};}else{warn("Name not provided for this chart, so it hasn't been registered");}return parent;};Chart.Element=function(configuration){extend(this,configuration);this.initialize.apply(this,arguments);this.save();};extend(Chart.Element.prototype,{initialize:function initialize(){},restore:function restore(props){if(!props){extend(this,this._saved);}else{each(props,function(key){this[key]=this._saved[key];},this);}return this;},save:function save(){this._saved=clone(this);delete this._saved._saved;return this;},update:function update(newProps){each(newProps,function(value,key){this._saved[key]=this[key];this[key]=value;},this);return this;},transition:function transition(props,ease){each(props,function(value,key){this[key]=(value-this._saved[key])*ease+this._saved[key];},this);return this;},tooltipPosition:function tooltipPosition(){return{x:this.x,y:this.y};},hasValue:function hasValue(){return isNumber(this.value);}});Chart.Element.extend=inherits;Chart.Point=Chart.Element.extend({display:true,inRange:function inRange(chartX,chartY){var hitDetectionRange=this.hitDetectionRadius+this.radius;return Math.pow(chartX-this.x,2)+Math.pow(chartY-this.y,2)<Math.pow(hitDetectionRange,2);},draw:function draw(){if(this.display){var ctx=this.ctx;ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.closePath();ctx.strokeStyle=this.strokeColor;ctx.lineWidth=this.strokeWidth;ctx.fillStyle=this.fillColor;ctx.fill();ctx.stroke();}}});Chart.Arc=Chart.Element.extend({inRange:function inRange(chartX,chartY){var pointRelativePosition=helpers.getAngleFromPoint(this,{x:chartX,y:chartY});var betweenAngles=pointRelativePosition.angle>=this.startAngle&&pointRelativePosition.angle<=this.endAngle,withinRadius=pointRelativePosition.distance>=this.innerRadius&&pointRelativePosition.distance<=this.outerRadius;return betweenAngles&&withinRadius;},tooltipPosition:function tooltipPosition(){var centreAngle=this.startAngle+(this.endAngle-this.startAngle)/2,rangeFromCentre=(this.outerRadius-this.innerRadius)/2+this.innerRadius;return{x:this.x+Math.cos(centreAngle)*rangeFromCentre,y:this.y+Math.sin(centreAngle)*rangeFromCentre};},draw:function draw(animationPercent){var easingDecimal=animationPercent||1;var ctx=this.ctx;ctx.beginPath();ctx.arc(this.x,this.y,this.outerRadius,this.startAngle,this.endAngle);ctx.arc(this.x,this.y,this.innerRadius,this.endAngle,this.startAngle,true);ctx.closePath();ctx.strokeStyle=this.strokeColor;ctx.lineWidth=this.strokeWidth;ctx.fillStyle=this.fillColor;ctx.fill();ctx.lineJoin='bevel';if(this.showStroke){ctx.stroke();}}});Chart.Rectangle=Chart.Element.extend({draw:function draw(){var ctx=this.ctx,halfWidth=this.width/2,leftX=this.x-halfWidth,rightX=this.x+halfWidth,top=this.base-(this.base-this.y),halfStroke=this.strokeWidth/2;if(this.showStroke){leftX+=halfStroke;rightX-=halfStroke;top+=halfStroke;}ctx.beginPath();ctx.fillStyle=this.fillColor;ctx.strokeStyle=this.strokeColor;ctx.lineWidth=this.strokeWidth;ctx.moveTo(leftX,this.base);ctx.lineTo(leftX,top);ctx.lineTo(rightX,top);ctx.lineTo(rightX,this.base);ctx.fill();if(this.showStroke){ctx.stroke();}},height:function height(){return this.base-this.y;},inRange:function inRange(chartX,chartY){return chartX>=this.x-this.width/2&&chartX<=this.x+this.width/2&&chartY>=this.y&&chartY<=this.base;}});Chart.Tooltip=Chart.Element.extend({draw:function draw(){var ctx=this.chart.ctx;ctx.font=fontString(this.fontSize,this.fontStyle,this.fontFamily);this.xAlign="center";this.yAlign="above";var caretPadding=2;var tooltipWidth=ctx.measureText(this.text).width+2*this.xPadding,tooltipRectHeight=this.fontSize+2*this.yPadding,tooltipHeight=tooltipRectHeight+this.caretHeight+caretPadding;if(this.x+tooltipWidth/2>this.chart.width){this.xAlign="left";}else if(this.x-tooltipWidth/2<0){this.xAlign="right";}if(this.y-tooltipHeight<0){this.yAlign="below";}var tooltipX=this.x-tooltipWidth/2,tooltipY=this.y-tooltipHeight;ctx.fillStyle=this.fillColor;switch(this.yAlign){case"above":ctx.beginPath();ctx.moveTo(this.x,this.y-caretPadding);ctx.lineTo(this.x+this.caretHeight,this.y-(caretPadding+this.caretHeight));ctx.lineTo(this.x-this.caretHeight,this.y-(caretPadding+this.caretHeight));ctx.closePath();ctx.fill();break;case"below":tooltipY=this.y+caretPadding+this.caretHeight;ctx.beginPath();ctx.moveTo(this.x,this.y+caretPadding);ctx.lineTo(this.x+this.caretHeight,this.y+caretPadding+this.caretHeight);ctx.lineTo(this.x-this.caretHeight,this.y+caretPadding+this.caretHeight);ctx.closePath();ctx.fill();break;}switch(this.xAlign){case"left":tooltipX=this.x-tooltipWidth+(this.cornerRadius+this.caretHeight);break;case"right":tooltipX=this.x-(this.cornerRadius+this.caretHeight);break;}drawRoundedRectangle(ctx,tooltipX,tooltipY,tooltipWidth,tooltipRectHeight,this.cornerRadius);ctx.fill();ctx.fillStyle=this.textColor;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(this.text,tooltipX+tooltipWidth/2,tooltipY+tooltipRectHeight/2);}});Chart.MultiTooltip=Chart.Element.extend({initialize:function initialize(){this.font=fontString(this.fontSize,this.fontStyle,this.fontFamily);this.titleFont=fontString(this.titleFontSize,this.titleFontStyle,this.titleFontFamily);this.height=this.labels.length*this.fontSize+(this.labels.length-1)*(this.fontSize/2)+this.yPadding*2+this.titleFontSize*1.5;this.ctx.font=this.titleFont;var titleWidth=this.ctx.measureText(this.title).width,labelWidth=longestText(this.ctx,this.font,this.labels)+this.fontSize+3,longestTextWidth=max([labelWidth,titleWidth]);this.width=longestTextWidth+this.xPadding*2;var halfHeight=this.height/2;if(this.y-halfHeight<0){this.y=halfHeight;}else if(this.y+halfHeight>this.chart.height){this.y=this.chart.height-halfHeight;}
if(this.x>this.chart.width/2){this.x-=this.xOffset+this.width;}else{this.x+=this.xOffset;}},getLineHeight:function getLineHeight(index){var baseLineHeight=this.y-this.height/2+this.yPadding,afterTitleIndex=index-1;if(index===0){return baseLineHeight+this.titleFontSize/2;}else{return baseLineHeight+(this.fontSize*1.5*afterTitleIndex+this.fontSize/2)+this.titleFontSize*1.5;}},draw:function draw(){drawRoundedRectangle(this.ctx,this.x,this.y-this.height/2,this.width,this.height,this.cornerRadius);var ctx=this.ctx;ctx.fillStyle=this.fillColor;ctx.fill();ctx.closePath();ctx.textAlign="left";ctx.textBaseline="middle";ctx.fillStyle=this.titleTextColor;ctx.font=this.titleFont;ctx.fillText(this.title,this.x+this.xPadding,this.getLineHeight(0));ctx.font=this.font;helpers.each(this.labels,function(label,index){ctx.fillStyle=this.textColor;ctx.fillText(label,this.x+this.xPadding+this.fontSize+3,this.getLineHeight(index+1));ctx.fillStyle=this.legendColorBackground;ctx.fillRect(this.x+this.xPadding,this.getLineHeight(index+1)-this.fontSize/2,this.fontSize,this.fontSize);ctx.fillStyle=this.legendColors[index].fill;ctx.fillRect(this.x+this.xPadding,this.getLineHeight(index+1)-this.fontSize/2,this.fontSize,this.fontSize);},this);}});Chart.Scale=Chart.Element.extend({initialize:function initialize(){this.fit();},buildYLabels:function buildYLabels(){this.yLabels=[];var stepDecimalPlaces=getDecimalPlaces(this.stepValue);for(var i=0;i<=this.steps;i++){this.yLabels.push(template(this.templateString,{value:(this.min+i*this.stepValue).toFixed(stepDecimalPlaces)}));}this.yLabelWidth=this.display&&this.showLabels?longestText(this.ctx,this.font,this.yLabels):0;},addXLabel:function addXLabel(label){this.xLabels.push(label);this.valuesCount++;this.fit();},removeXLabel:function removeXLabel(){this.xLabels.shift();this.valuesCount--;this.fit();},fit:function fit(){this.startPoint=this.display?this.fontSize:0;this.endPoint=this.display?this.height-this.fontSize*1.5-5:this.height;this.startPoint+=this.padding;this.endPoint-=this.padding;var cachedHeight=this.endPoint-this.startPoint,cachedYLabelWidth;this.calculateYRange(cachedHeight);this.buildYLabels();this.calculateXLabelRotation();while(cachedHeight>this.endPoint-this.startPoint){cachedHeight=this.endPoint-this.startPoint;cachedYLabelWidth=this.yLabelWidth;this.calculateYRange(cachedHeight);this.buildYLabels();if(cachedYLabelWidth<this.yLabelWidth){this.calculateXLabelRotation();}}},calculateXLabelRotation:function calculateXLabelRotation(){this.ctx.font=this.font;var firstWidth=this.ctx.measureText(this.xLabels[0]).width,lastWidth=this.ctx.measureText(this.xLabels[this.xLabels.length-1]).width,firstRotated,lastRotated;this.xScalePaddingRight=lastWidth/2+3;this.xScalePaddingLeft=firstWidth/2>this.yLabelWidth+10?firstWidth/2:this.yLabelWidth+10;this.xLabelRotation=0;if(this.display){var originalLabelWidth=longestText(this.ctx,this.font,this.xLabels),cosRotation,firstRotatedWidth;this.xLabelWidth=originalLabelWidth;var xGridWidth=Math.floor(this.calculateX(1)-this.calculateX(0))-6;while(this.xLabelWidth>xGridWidth&&this.xLabelRotation===0||this.xLabelWidth>xGridWidth&&this.xLabelRotation<=90&&this.xLabelRotation>0){cosRotation=Math.cos(toRadians(this.xLabelRotation));firstRotated=cosRotation*firstWidth;lastRotated=cosRotation*lastWidth;if(firstRotated+this.fontSize/2>this.yLabelWidth+8){this.xScalePaddingLeft=firstRotated+this.fontSize/2;}this.xScalePaddingRight=this.fontSize/2;this.xLabelRotation++;this.xLabelWidth=cosRotation*originalLabelWidth;}if(this.xLabelRotation>0){this.endPoint-=Math.sin(toRadians(this.xLabelRotation))*originalLabelWidth+3;}}else{this.xLabelWidth=0;this.xScalePaddingRight=this.padding;this.xScalePaddingLeft=this.padding;}},calculateYRange:noop,drawingArea:function drawingArea(){return this.startPoint-this.endPoint;},calculateY:function calculateY(value){var scalingFactor=this.drawingArea()/(this.min-this.max);return this.endPoint-scalingFactor*(value-this.min);},calculateX:function calculateX(index){var isRotated=this.xLabelRotation>0,innerWidth=this.width-(this.xScalePaddingLeft+this.xScalePaddingRight),valueWidth=innerWidth/(this.valuesCount-(this.offsetGridLines?0:1)),valueOffset=valueWidth*index+this.xScalePaddingLeft;if(this.offsetGridLines){valueOffset+=valueWidth/2;}return Math.round(valueOffset);},update:function update(newProps){helpers.extend(this,newProps);this.fit();},draw:function draw(){var ctx=this.ctx,yLabelGap=(this.endPoint-this.startPoint)/this.steps,xStart=Math.round(this.xScalePaddingLeft);if(this.display){ctx.fillStyle=this.textColor;ctx.font=this.font;each(this.yLabels,function(labelString,index){var yLabelCenter=this.endPoint-yLabelGap*index,linePositionY=Math.round(yLabelCenter);ctx.textAlign="right";ctx.textBaseline="middle";if(this.showLabels){ctx.fillText(labelString,xStart-10,yLabelCenter);}ctx.beginPath();if(index>0){ctx.lineWidth=this.gridLineWidth;ctx.strokeStyle=this.gridLineColor;}else{ctx.lineWidth=this.lineWidth;ctx.strokeStyle=this.lineColor;}linePositionY+=helpers.aliasPixel(ctx.lineWidth);ctx.moveTo(xStart,linePositionY);ctx.lineTo(this.width,linePositionY);ctx.stroke();ctx.closePath();ctx.lineWidth=this.lineWidth;ctx.strokeStyle=this.lineColor;ctx.beginPath();ctx.moveTo(xStart-5,linePositionY);ctx.lineTo(xStart,linePositionY);ctx.stroke();ctx.closePath();},this);each(this.xLabels,function(label,index){var xPos=this.calculateX(index)+aliasPixel(this.lineWidth),linePos=this.calculateX(index-(this.offsetGridLines?0.5:0))+aliasPixel(this.lineWidth),isRotated=this.xLabelRotation>0;ctx.beginPath();if(index>0){ctx.lineWidth=this.gridLineWidth;ctx.strokeStyle=this.gridLineColor;}else{ctx.lineWidth=this.lineWidth;ctx.strokeStyle=this.lineColor;}ctx.moveTo(linePos,this.endPoint);ctx.lineTo(linePos,this.startPoint-3);ctx.stroke();ctx.closePath();ctx.lineWidth=this.lineWidth;ctx.strokeStyle=this.lineColor;ctx.beginPath();ctx.moveTo(linePos,this.endPoint);ctx.lineTo(linePos,this.endPoint+5);ctx.stroke();ctx.closePath();ctx.save();ctx.translate(xPos,isRotated?this.endPoint+12:this.endPoint+8);ctx.rotate(toRadians(this.xLabelRotation)*-1);ctx.font=this.font;ctx.textAlign=isRotated?"right":"center";ctx.textBaseline=isRotated?"middle":"top";ctx.fillText(label,0,0);ctx.restore();},this);}}});Chart.RadialScale=Chart.Element.extend({initialize:function initialize(){this.size=min([this.height,this.width]);this.drawingArea=this.display?this.size/2-(this.fontSize/2+this.backdropPaddingY):this.size/2;},calculateCenterOffset:function calculateCenterOffset(value){var scalingFactor=this.drawingArea/(this.max-this.min);return(value-this.min)*scalingFactor;},update:function update(){if(!this.lineArc){this.setScaleSize();}else{this.drawingArea=this.display?this.size/2-(this.fontSize/2+this.backdropPaddingY):this.size/2;}this.buildYLabels();},buildYLabels:function buildYLabels(){this.yLabels=[];var stepDecimalPlaces=getDecimalPlaces(this.stepValue);for(var i=0;i<=this.steps;i++){this.yLabels.push(template(this.templateString,{value:(this.min+i*this.stepValue).toFixed(stepDecimalPlaces)}));}},getCircumference:function getCircumference(){return Math.PI*2/this.valuesCount;},setScaleSize:function setScaleSize(){var largestPossibleRadius=min([this.height/2-this.pointLabelFontSize-5,this.width/2]),pointPosition,i,textWidth,halfTextWidth,furthestRight=this.width,furthestRightIndex,furthestRightAngle,furthestLeft=0,furthestLeftIndex,furthestLeftAngle,xProtrusionLeft,xProtrusionRight,radiusReductionRight,radiusReductionLeft,maxWidthRadius;this.ctx.font=fontString(this.pointLabelFontSize,this.pointLabelFontStyle,this.pointLabelFontFamily);for(i=0;i<this.valuesCount;i++){pointPosition=this.getPointPosition(i,largestPossibleRadius);textWidth=this.ctx.measureText(template(this.templateString,{value:this.labels[i]})).width+5;if(i===0||i===this.valuesCount/2){halfTextWidth=textWidth/2;if(pointPosition.x+halfTextWidth>furthestRight){furthestRight=pointPosition.x+halfTextWidth;furthestRightIndex=i;}if(pointPosition.x-halfTextWidth<furthestLeft){furthestLeft=pointPosition.x-halfTextWidth;furthestLeftIndex=i;}}else if(i<this.valuesCount/2){if(pointPosition.x+textWidth>furthestRight){furthestRight=pointPosition.x+textWidth;furthestRightIndex=i;}}else if(i>this.valuesCount/2){if(pointPosition.x-textWidth<furthestLeft){furthestLeft=pointPosition.x-textWidth;furthestLeftIndex=i;}}}xProtrusionLeft=furthestLeft;xProtrusionRight=Math.ceil(furthestRight-this.width);furthestRightAngle=this.getIndexAngle(furthestRightIndex);furthestLeftAngle=this.getIndexAngle(furthestLeftIndex);radiusReductionRight=xProtrusionRight/Math.sin(furthestRightAngle+Math.PI/2);radiusReductionLeft=xProtrusionLeft/Math.sin(furthestLeftAngle+Math.PI/2);radiusReductionRight=isNumber(radiusReductionRight)?radiusReductionRight:0;radiusReductionLeft=isNumber(radiusReductionLeft)?radiusReductionLeft:0;this.drawingArea=largestPossibleRadius-(radiusReductionLeft+radiusReductionRight)/2;this.setCenterPoint(radiusReductionLeft,radiusReductionRight);},setCenterPoint:function setCenterPoint(leftMovement,rightMovement){var maxRight=this.width-rightMovement-this.drawingArea,maxLeft=leftMovement+this.drawingArea;this.xCenter=(maxLeft+maxRight)/2;this.yCenter=this.height/2;},getIndexAngle:function getIndexAngle(index){var angleMultiplier=Math.PI*2/this.valuesCount;return index*angleMultiplier-Math.PI/2;},getPointPosition:function getPointPosition(index,distanceFromCenter){var thisAngle=this.getIndexAngle(index);return{x:Math.cos(thisAngle)*distanceFromCenter+this.xCenter,y:Math.sin(thisAngle)*distanceFromCenter+this.yCenter};},draw:function draw(){if(this.display){var ctx=this.ctx;each(this.yLabels,function(label,index){if(index>0){var yCenterOffset=index*(this.drawingArea/this.steps),yHeight=this.yCenter-yCenterOffset,pointPosition;if(this.lineWidth>0){ctx.strokeStyle=this.lineColor;ctx.lineWidth=this.lineWidth;if(this.lineArc){ctx.beginPath();ctx.arc(this.xCenter,this.yCenter,yCenterOffset,0,Math.PI*2);ctx.closePath();ctx.stroke();}else{ctx.beginPath();for(var i=0;i<this.valuesCount;i++){pointPosition=this.getPointPosition(i,this.calculateCenterOffset(this.min+index*this.stepValue));if(i===0){ctx.moveTo(pointPosition.x,pointPosition.y);}else{ctx.lineTo(pointPosition.x,pointPosition.y);}}ctx.closePath();ctx.stroke();}}if(this.showLabels){ctx.font=fontString(this.fontSize,this.fontStyle,this.fontFamily);if(this.showLabelBackdrop){var labelWidth=ctx.measureText(label).width;ctx.fillStyle=this.backdropColor;ctx.fillRect(this.xCenter-labelWidth/2-this.backdropPaddingX,yHeight-this.fontSize/2-this.backdropPaddingY,labelWidth+this.backdropPaddingX*2,this.fontSize+this.backdropPaddingY*2);}ctx.textAlign='center';ctx.textBaseline="middle";ctx.fillStyle=this.fontColor;ctx.fillText(label,this.xCenter,yHeight);}}},this);if(!this.lineArc){ctx.lineWidth=this.angleLineWidth;ctx.strokeStyle=this.angleLineColor;for(var i=this.valuesCount-1;i>=0;i--){if(this.angleLineWidth>0){var outerPosition=this.getPointPosition(i,this.calculateCenterOffset(this.max));ctx.beginPath();ctx.moveTo(this.xCenter,this.yCenter);ctx.lineTo(outerPosition.x,outerPosition.y);ctx.stroke();ctx.closePath();}
var pointLabelPosition=this.getPointPosition(i,this.calculateCenterOffset(this.max)+5);ctx.font=fontString(this.pointLabelFontSize,this.pointLabelFontStyle,this.pointLabelFontFamily);ctx.fillStyle=this.pointLabelFontColor;var labelsCount=this.labels.length,halfLabelsCount=this.labels.length/2,quarterLabelsCount=halfLabelsCount/2,upperHalf=i<quarterLabelsCount||i>labelsCount-quarterLabelsCount,exactQuarter=i===quarterLabelsCount||i===labelsCount-quarterLabelsCount;if(i===0){ctx.textAlign='center';}else if(i===halfLabelsCount){ctx.textAlign='center';}else if(i<halfLabelsCount){ctx.textAlign='left';}else{ctx.textAlign='right';}
if(exactQuarter){ctx.textBaseline='middle';}else if(upperHalf){ctx.textBaseline='bottom';}else{ctx.textBaseline='top';}ctx.fillText(this.labels[i],pointLabelPosition.x,pointLabelPosition.y);}}}}});helpers.addEvent(window,"resize",function(){var timeout;return function(){clearTimeout(timeout);timeout=setTimeout(function(){each(Chart.instances,function(instance){if(instance.options.responsive){instance.resize(instance.render,true);}});},50);};}());if(amd){define(function(){return Chart;});}else if((typeof module==="undefined"?"undefined":_typeof(module))==='object'&&module.exports){module.exports=Chart;}root.Chart=Chart;Chart.noConflict=function(){root.Chart=previous;return Chart;};}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={scaleBeginAtZero:true,scaleShowGridLines:true,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,barShowStroke:true,barStrokeWidth:2,barValueSpacing:5,barDatasetSpacing:1,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].fillColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"};Chart.Type.extend({name:"Bar",defaults:defaultConfig,initialize:function initialize(data){var options=this.options;this.ScaleClass=Chart.Scale.extend({offsetGridLines:true,calculateBarX:function calculateBarX(datasetCount,datasetIndex,barIndex){var xWidth=this.calculateBaseWidth(),xAbsolute=this.calculateX(barIndex)-xWidth/2,barWidth=this.calculateBarWidth(datasetCount);return xAbsolute+barWidth*datasetIndex+datasetIndex*options.barDatasetSpacing+barWidth/2;},calculateBaseWidth:function calculateBaseWidth(){return this.calculateX(1)-this.calculateX(0)-2*options.barValueSpacing;},calculateBarWidth:function calculateBarWidth(datasetCount){var baseWidth=this.calculateBaseWidth()-(datasetCount-1)*options.barDatasetSpacing;return baseWidth/datasetCount;}});this.datasets=[];if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activeBars=evt.type!=='mouseout'?this.getBarsAtEvent(evt):[];this.eachBars(function(bar){bar.restore(['fillColor','strokeColor']);});helpers.each(activeBars,function(activeBar){activeBar.fillColor=activeBar.highlightFill;activeBar.strokeColor=activeBar.highlightStroke;});this.showTooltip(activeBars);});}
this.BarClass=Chart.Rectangle.extend({strokeWidth:this.options.barStrokeWidth,showStroke:this.options.barShowStroke,ctx:this.chart.ctx});helpers.each(data.datasets,function(dataset,datasetIndex){var datasetObject={label:dataset.label||null,fillColor:dataset.fillColor,strokeColor:dataset.strokeColor,bars:[]};this.datasets.push(datasetObject);helpers.each(dataset.data,function(dataPoint,index){datasetObject.bars.push(new this.BarClass({value:dataPoint,label:data.labels[index],datasetLabel:dataset.label,strokeColor:dataset.strokeColor,fillColor:dataset.fillColor,highlightFill:dataset.highlightFill||dataset.fillColor,highlightStroke:dataset.highlightStroke||dataset.strokeColor}));},this);},this);this.buildScale(data.labels);this.BarClass.prototype.base=this.scale.endPoint;this.eachBars(function(bar,index,datasetIndex){helpers.extend(bar,{width:this.scale.calculateBarWidth(this.datasets.length),x:this.scale.calculateBarX(this.datasets.length,datasetIndex,index),y:this.scale.endPoint});bar.save();},this);this.render();},update:function update(){this.scale.update();helpers.each(this.activeElements,function(activeElement){activeElement.restore(['fillColor','strokeColor']);});this.eachBars(function(bar){bar.save();});this.render();},eachBars:function eachBars(callback){helpers.each(this.datasets,function(dataset,datasetIndex){helpers.each(dataset.bars,callback,this,datasetIndex);},this);},getBarsAtEvent:function getBarsAtEvent(e){var barsArray=[],eventPosition=helpers.getRelativePosition(e),datasetIterator=function datasetIterator(dataset){barsArray.push(dataset.bars[barIndex]);},barIndex;for(var datasetIndex=0;datasetIndex<this.datasets.length;datasetIndex++){for(barIndex=0;barIndex<this.datasets[datasetIndex].bars.length;barIndex++){if(this.datasets[datasetIndex].bars[barIndex].inRange(eventPosition.x,eventPosition.y)){helpers.each(this.datasets,datasetIterator);return barsArray;}}}return barsArray;},buildScale:function buildScale(labels){var self=this;var dataTotal=function dataTotal(){var values=[];self.eachBars(function(bar){values.push(bar.value);});return values;};var scaleOptions={templateString:this.options.scaleLabel,height:this.chart.height,width:this.chart.width,ctx:this.chart.ctx,textColor:this.options.scaleFontColor,fontSize:this.options.scaleFontSize,fontStyle:this.options.scaleFontStyle,fontFamily:this.options.scaleFontFamily,valuesCount:labels.length,beginAtZero:this.options.scaleBeginAtZero,integersOnly:this.options.scaleIntegersOnly,calculateYRange:function calculateYRange(currentHeight){var updatedRanges=helpers.calculateScaleRange(dataTotal(),currentHeight,this.fontSize,this.beginAtZero,this.integersOnly);helpers.extend(this,updatedRanges);},xLabels:labels,font:helpers.fontString(this.options.scaleFontSize,this.options.scaleFontStyle,this.options.scaleFontFamily),lineWidth:this.options.scaleLineWidth,lineColor:this.options.scaleLineColor,gridLineWidth:this.options.scaleShowGridLines?this.options.scaleGridLineWidth:0,gridLineColor:this.options.scaleShowGridLines?this.options.scaleGridLineColor:"rgba(0,0,0,0)",padding:this.options.showScale?0:this.options.barShowStroke?this.options.barStrokeWidth:0,showLabels:this.options.scaleShowLabels,display:this.options.showScale};if(this.options.scaleOverride){helpers.extend(scaleOptions,{calculateYRange:helpers.noop,steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+this.options.scaleSteps*this.options.scaleStepWidth});}this.scale=new this.ScaleClass(scaleOptions);},addData:function addData(valuesArray,label){helpers.each(valuesArray,function(value,datasetIndex){this.datasets[datasetIndex].bars.push(new this.BarClass({value:value,label:label,x:this.scale.calculateBarX(this.datasets.length,datasetIndex,this.scale.valuesCount+1),y:this.scale.endPoint,width:this.scale.calculateBarWidth(this.datasets.length),base:this.scale.endPoint,strokeColor:this.datasets[datasetIndex].strokeColor,fillColor:this.datasets[datasetIndex].fillColor}));},this);this.scale.addXLabel(label);this.update();},removeData:function removeData(){this.scale.removeXLabel();helpers.each(this.datasets,function(dataset){dataset.bars.shift();},this);this.update();},reflow:function reflow(){helpers.extend(this.BarClass.prototype,{y:this.scale.endPoint,base:this.scale.endPoint});var newScaleProps=helpers.extend({height:this.chart.height,width:this.chart.width});this.scale.update(newScaleProps);},draw:function draw(ease){var easingDecimal=ease||1;this.clear();var ctx=this.chart.ctx;this.scale.draw(easingDecimal);helpers.each(this.datasets,function(dataset,datasetIndex){helpers.each(dataset.bars,function(bar,index){if(bar.hasValue()){bar.base=this.scale.endPoint;bar.transition({x:this.scale.calculateBarX(this.datasets.length,datasetIndex,index),y:this.scale.calculateY(bar.value),width:this.scale.calculateBarWidth(this.datasets.length)},easingDecimal).draw();}},this);},this);}});}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={segmentShowStroke:true,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:50,animationSteps:100,animationEasing:"easeOutBounce",animateRotate:true,animateScale:false,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<segments.length; i++){%><li><span style=\"background-color:<%=segments[i].fillColor%>\"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>"};Chart.Type.extend({name:"Doughnut",defaults:defaultConfig,initialize:function initialize(data){this.segments=[];this.outerRadius=(helpers.min([this.chart.width,this.chart.height])-this.options.segmentStrokeWidth/2)/2;this.SegmentArc=Chart.Arc.extend({ctx:this.chart.ctx,x:this.chart.width/2,y:this.chart.height/2});if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activeSegments=evt.type!=='mouseout'?this.getSegmentsAtEvent(evt):[];helpers.each(this.segments,function(segment){segment.restore(["fillColor"]);});helpers.each(activeSegments,function(activeSegment){activeSegment.fillColor=activeSegment.highlightColor;});this.showTooltip(activeSegments);});}this.calculateTotal(data);helpers.each(data,function(datapoint,index){this.addData(datapoint,index,true);},this);this.render();},getSegmentsAtEvent:function getSegmentsAtEvent(e){var segmentsArray=[];var location=helpers.getRelativePosition(e);helpers.each(this.segments,function(segment){if(segment.inRange(location.x,location.y))segmentsArray.push(segment);},this);return segmentsArray;},addData:function addData(segment,atIndex,silent){var index=atIndex||this.segments.length;this.segments.splice(index,0,new this.SegmentArc({value:segment.value,outerRadius:this.options.animateScale?0:this.outerRadius,innerRadius:this.options.animateScale?0:this.outerRadius/100*this.options.percentageInnerCutout,fillColor:segment.color,highlightColor:segment.highlight||segment.color,showStroke:this.options.segmentShowStroke,strokeWidth:this.options.segmentStrokeWidth,strokeColor:this.options.segmentStrokeColor,startAngle:Math.PI*1.5,circumference:this.options.animateRotate?0:this.calculateCircumference(segment.value),label:segment.label}));if(!silent){this.reflow();this.update();}},calculateCircumference:function calculateCircumference(value){return Math.PI*2*(value/this.total);},calculateTotal:function calculateTotal(data){this.total=0;helpers.each(data,function(segment){this.total+=segment.value;},this);},update:function update(){this.calculateTotal(this.segments);helpers.each(this.activeElements,function(activeElement){activeElement.restore(['fillColor']);});helpers.each(this.segments,function(segment){segment.save();});this.render();},removeData:function removeData(atIndex){var indexToDelete=helpers.isNumber(atIndex)?atIndex:this.segments.length-1;this.segments.splice(indexToDelete,1);this.reflow();this.update();},reflow:function reflow(){helpers.extend(this.SegmentArc.prototype,{x:this.chart.width/2,y:this.chart.height/2});this.outerRadius=(helpers.min([this.chart.width,this.chart.height])-this.options.segmentStrokeWidth/2)/2;helpers.each(this.segments,function(segment){segment.update({outerRadius:this.outerRadius,innerRadius:this.outerRadius/100*this.options.percentageInnerCutout});},this);},draw:function draw(easeDecimal){var animDecimal=easeDecimal?easeDecimal:1;this.clear();helpers.each(this.segments,function(segment,index){segment.transition({circumference:this.calculateCircumference(segment.value),outerRadius:this.outerRadius,innerRadius:this.outerRadius/100*this.options.percentageInnerCutout},animDecimal);segment.endAngle=segment.startAngle+segment.circumference;segment.draw();if(index===0){segment.startAngle=Math.PI*1.5;}
if(index<this.segments.length-1){this.segments[index+1].startAngle=segment.endAngle;}},this);}});Chart.types.Doughnut.extend({name:"Pie",defaults:helpers.merge(defaultConfig,{percentageInnerCutout:0})});}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={scaleShowGridLines:true,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:true,bezierCurveTension:0.4,pointDot:true,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:20,datasetStroke:true,datasetStrokeWidth:2,datasetFill:true,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].strokeColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"};Chart.Type.extend({name:"Line",defaults:defaultConfig,initialize:function initialize(data){this.PointClass=Chart.Point.extend({strokeWidth:this.options.pointDotStrokeWidth,radius:this.options.pointDotRadius,display:this.options.pointDot,hitDetectionRadius:this.options.pointHitDetectionRadius,ctx:this.chart.ctx,inRange:function inRange(mouseX){return Math.pow(mouseX-this.x,2)<Math.pow(this.radius+this.hitDetectionRadius,2);}});this.datasets=[];if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activePoints=evt.type!=='mouseout'?this.getPointsAtEvent(evt):[];this.eachPoints(function(point){point.restore(['fillColor','strokeColor']);});helpers.each(activePoints,function(activePoint){activePoint.fillColor=activePoint.highlightFill;activePoint.strokeColor=activePoint.highlightStroke;});this.showTooltip(activePoints);});}
helpers.each(data.datasets,function(dataset){var datasetObject={label:dataset.label||null,fillColor:dataset.fillColor,strokeColor:dataset.strokeColor,pointColor:dataset.pointColor,pointStrokeColor:dataset.pointStrokeColor,points:[]};this.datasets.push(datasetObject);helpers.each(dataset.data,function(dataPoint,index){datasetObject.points.push(new this.PointClass({value:dataPoint,label:data.labels[index],datasetLabel:dataset.label,strokeColor:dataset.pointStrokeColor,fillColor:dataset.pointColor,highlightFill:dataset.pointHighlightFill||dataset.pointColor,highlightStroke:dataset.pointHighlightStroke||dataset.pointStrokeColor}));},this);this.buildScale(data.labels);this.eachPoints(function(point,index){helpers.extend(point,{x:this.scale.calculateX(index),y:this.scale.endPoint});point.save();},this);},this);this.render();},update:function update(){this.scale.update();helpers.each(this.activeElements,function(activeElement){activeElement.restore(['fillColor','strokeColor']);});this.eachPoints(function(point){point.save();});this.render();},eachPoints:function eachPoints(callback){helpers.each(this.datasets,function(dataset){helpers.each(dataset.points,callback,this);},this);},getPointsAtEvent:function getPointsAtEvent(e){var pointsArray=[],eventPosition=helpers.getRelativePosition(e);helpers.each(this.datasets,function(dataset){helpers.each(dataset.points,function(point){if(point.inRange(eventPosition.x,eventPosition.y))pointsArray.push(point);});},this);return pointsArray;},buildScale:function buildScale(labels){var self=this;var dataTotal=function dataTotal(){var values=[];self.eachPoints(function(point){values.push(point.value);});return values;};var scaleOptions={templateString:this.options.scaleLabel,height:this.chart.height,width:this.chart.width,ctx:this.chart.ctx,textColor:this.options.scaleFontColor,fontSize:this.options.scaleFontSize,fontStyle:this.options.scaleFontStyle,fontFamily:this.options.scaleFontFamily,valuesCount:labels.length,beginAtZero:this.options.scaleBeginAtZero,integersOnly:this.options.scaleIntegersOnly,calculateYRange:function calculateYRange(currentHeight){var updatedRanges=helpers.calculateScaleRange(dataTotal(),currentHeight,this.fontSize,this.beginAtZero,this.integersOnly);helpers.extend(this,updatedRanges);},xLabels:labels,font:helpers.fontString(this.options.scaleFontSize,this.options.scaleFontStyle,this.options.scaleFontFamily),lineWidth:this.options.scaleLineWidth,lineColor:this.options.scaleLineColor,gridLineWidth:this.options.scaleShowGridLines?this.options.scaleGridLineWidth:0,gridLineColor:this.options.scaleShowGridLines?this.options.scaleGridLineColor:"rgba(0,0,0,0)",padding:this.options.showScale?0:this.options.pointDotRadius+this.options.pointDotStrokeWidth,showLabels:this.options.scaleShowLabels,display:this.options.showScale};if(this.options.scaleOverride){helpers.extend(scaleOptions,{calculateYRange:helpers.noop,steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+this.options.scaleSteps*this.options.scaleStepWidth});}this.scale=new Chart.Scale(scaleOptions);},addData:function addData(valuesArray,label){helpers.each(valuesArray,function(value,datasetIndex){this.datasets[datasetIndex].points.push(new this.PointClass({value:value,label:label,x:this.scale.calculateX(this.scale.valuesCount+1),y:this.scale.endPoint,strokeColor:this.datasets[datasetIndex].pointStrokeColor,fillColor:this.datasets[datasetIndex].pointColor}));},this);this.scale.addXLabel(label);this.update();},removeData:function removeData(){this.scale.removeXLabel();helpers.each(this.datasets,function(dataset){dataset.points.shift();},this);this.update();},reflow:function reflow(){var newScaleProps=helpers.extend({height:this.chart.height,width:this.chart.width});this.scale.update(newScaleProps);},draw:function draw(ease){var easingDecimal=ease||1;this.clear();var ctx=this.chart.ctx;var hasValue=function hasValue(item){return item.value!==null;},nextPoint=function nextPoint(point,collection,index){return helpers.findNextWhere(collection,hasValue,index)||point;},previousPoint=function previousPoint(point,collection,index){return helpers.findPreviousWhere(collection,hasValue,index)||point;};this.scale.draw(easingDecimal);helpers.each(this.datasets,function(dataset){var pointsWithValues=helpers.where(dataset.points,hasValue);helpers.each(dataset.points,function(point,index){if(point.hasValue()){point.transition({y:this.scale.calculateY(point.value),x:this.scale.calculateX(index)},easingDecimal);}},this);if(this.options.bezierCurve){helpers.each(pointsWithValues,function(point,index){var tension=index>0&&index<pointsWithValues.length-1?this.options.bezierCurveTension:0;point.controlPoints=helpers.splineCurve(previousPoint(point,pointsWithValues,index),point,nextPoint(point,pointsWithValues,index),tension);if(point.controlPoints.outer.y>this.scale.endPoint){point.controlPoints.outer.y=this.scale.endPoint;}else if(point.controlPoints.outer.y<this.scale.startPoint){point.controlPoints.outer.y=this.scale.startPoint;}
if(point.controlPoints.inner.y>this.scale.endPoint){point.controlPoints.inner.y=this.scale.endPoint;}else if(point.controlPoints.inner.y<this.scale.startPoint){point.controlPoints.inner.y=this.scale.startPoint;}},this);}
ctx.lineWidth=this.options.datasetStrokeWidth;ctx.strokeStyle=dataset.strokeColor;ctx.beginPath();helpers.each(pointsWithValues,function(point,index){if(index===0){ctx.moveTo(point.x,point.y);}else{if(this.options.bezierCurve){var previous=previousPoint(point,pointsWithValues,index);ctx.bezierCurveTo(previous.controlPoints.outer.x,previous.controlPoints.outer.y,point.controlPoints.inner.x,point.controlPoints.inner.y,point.x,point.y);}else{ctx.lineTo(point.x,point.y);}}},this);ctx.stroke();if(this.options.datasetFill&&pointsWithValues.length>0){ctx.lineTo(pointsWithValues[pointsWithValues.length-1].x,this.scale.endPoint);ctx.lineTo(pointsWithValues[0].x,this.scale.endPoint);ctx.fillStyle=dataset.fillColor;ctx.closePath();ctx.fill();}
helpers.each(pointsWithValues,function(point){point.draw();});},this);}});}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={scaleShowLabelBackdrop:true,scaleBackdropColor:"rgba(255,255,255,0.75)",scaleBeginAtZero:true,scaleBackdropPaddingY:2,scaleBackdropPaddingX:2,scaleShowLine:true,segmentShowStroke:true,segmentStrokeColor:"#fff",segmentStrokeWidth:2,animationSteps:100,animationEasing:"easeOutBounce",animateRotate:true,animateScale:false,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<segments.length; i++){%><li><span style=\"background-color:<%=segments[i].fillColor%>\"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>"};Chart.Type.extend({name:"PolarArea",defaults:defaultConfig,initialize:function initialize(data){this.segments=[];this.SegmentArc=Chart.Arc.extend({showStroke:this.options.segmentShowStroke,strokeWidth:this.options.segmentStrokeWidth,strokeColor:this.options.segmentStrokeColor,ctx:this.chart.ctx,innerRadius:0,x:this.chart.width/2,y:this.chart.height/2});this.scale=new Chart.RadialScale({display:this.options.showScale,fontStyle:this.options.scaleFontStyle,fontSize:this.options.scaleFontSize,fontFamily:this.options.scaleFontFamily,fontColor:this.options.scaleFontColor,showLabels:this.options.scaleShowLabels,showLabelBackdrop:this.options.scaleShowLabelBackdrop,backdropColor:this.options.scaleBackdropColor,backdropPaddingY:this.options.scaleBackdropPaddingY,backdropPaddingX:this.options.scaleBackdropPaddingX,lineWidth:this.options.scaleShowLine?this.options.scaleLineWidth:0,lineColor:this.options.scaleLineColor,lineArc:true,width:this.chart.width,height:this.chart.height,xCenter:this.chart.width/2,yCenter:this.chart.height/2,ctx:this.chart.ctx,templateString:this.options.scaleLabel,valuesCount:data.length});this.updateScaleRange(data);this.scale.update();helpers.each(data,function(segment,index){this.addData(segment,index,true);},this);if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activeSegments=evt.type!=='mouseout'?this.getSegmentsAtEvent(evt):[];helpers.each(this.segments,function(segment){segment.restore(["fillColor"]);});helpers.each(activeSegments,function(activeSegment){activeSegment.fillColor=activeSegment.highlightColor;});this.showTooltip(activeSegments);});}this.render();},getSegmentsAtEvent:function getSegmentsAtEvent(e){var segmentsArray=[];var location=helpers.getRelativePosition(e);helpers.each(this.segments,function(segment){if(segment.inRange(location.x,location.y))segmentsArray.push(segment);},this);return segmentsArray;},addData:function addData(segment,atIndex,silent){var index=atIndex||this.segments.length;this.segments.splice(index,0,new this.SegmentArc({fillColor:segment.color,highlightColor:segment.highlight||segment.color,label:segment.label,value:segment.value,outerRadius:this.options.animateScale?0:this.scale.calculateCenterOffset(segment.value),circumference:this.options.animateRotate?0:this.scale.getCircumference(),startAngle:Math.PI*1.5}));if(!silent){this.reflow();this.update();}},removeData:function removeData(atIndex){var indexToDelete=helpers.isNumber(atIndex)?atIndex:this.segments.length-1;this.segments.splice(indexToDelete,1);this.reflow();this.update();},calculateTotal:function calculateTotal(data){this.total=0;helpers.each(data,function(segment){this.total+=segment.value;},this);this.scale.valuesCount=this.segments.length;},updateScaleRange:function updateScaleRange(datapoints){var valuesArray=[];helpers.each(datapoints,function(segment){valuesArray.push(segment.value);});var scaleSizes=this.options.scaleOverride?{steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+this.options.scaleSteps*this.options.scaleStepWidth}:helpers.calculateScaleRange(valuesArray,helpers.min([this.chart.width,this.chart.height])/2,this.options.scaleFontSize,this.options.scaleBeginAtZero,this.options.scaleIntegersOnly);helpers.extend(this.scale,scaleSizes,{size:helpers.min([this.chart.width,this.chart.height]),xCenter:this.chart.width/2,yCenter:this.chart.height/2});},update:function update(){this.calculateTotal(this.segments);helpers.each(this.segments,function(segment){segment.save();});this.render();},reflow:function reflow(){helpers.extend(this.SegmentArc.prototype,{x:this.chart.width/2,y:this.chart.height/2});this.updateScaleRange(this.segments);this.scale.update();helpers.extend(this.scale,{xCenter:this.chart.width/2,yCenter:this.chart.height/2});helpers.each(this.segments,function(segment){segment.update({outerRadius:this.scale.calculateCenterOffset(segment.value)});},this);},draw:function draw(ease){var easingDecimal=ease||1;this.clear();helpers.each(this.segments,function(segment,index){segment.transition({circumference:this.scale.getCircumference(),outerRadius:this.scale.calculateCenterOffset(segment.value)},easingDecimal);segment.endAngle=segment.startAngle+segment.circumference;if(index===0){segment.startAngle=Math.PI*1.5;}
if(index<this.segments.length-1){this.segments[index+1].startAngle=segment.endAngle;}segment.draw();},this);this.scale.draw();}});}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;Chart.Type.extend({name:"Radar",defaults:{scaleShowLine:true,angleShowLineOut:true,scaleShowLabels:false,scaleBeginAtZero:true,angleLineColor:"rgba(0,0,0,.1)",angleLineWidth:1,pointLabelFontFamily:"'Arial'",pointLabelFontStyle:"normal",pointLabelFontSize:10,pointLabelFontColor:"#666",pointDot:true,pointDotRadius:3,pointDotStrokeWidth:1,pointHitDetectionRadius:20,datasetStroke:true,datasetStrokeWidth:2,datasetFill:true,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].strokeColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"},initialize:function initialize(data){this.PointClass=Chart.Point.extend({strokeWidth:this.options.pointDotStrokeWidth,radius:this.options.pointDotRadius,display:this.options.pointDot,hitDetectionRadius:this.options.pointHitDetectionRadius,ctx:this.chart.ctx});this.datasets=[];this.buildScale(data);if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activePointsCollection=evt.type!=='mouseout'?this.getPointsAtEvent(evt):[];this.eachPoints(function(point){point.restore(['fillColor','strokeColor']);});helpers.each(activePointsCollection,function(activePoint){activePoint.fillColor=activePoint.highlightFill;activePoint.strokeColor=activePoint.highlightStroke;});this.showTooltip(activePointsCollection);});}
helpers.each(data.datasets,function(dataset){var datasetObject={label:dataset.label||null,fillColor:dataset.fillColor,strokeColor:dataset.strokeColor,pointColor:dataset.pointColor,pointStrokeColor:dataset.pointStrokeColor,points:[]};this.datasets.push(datasetObject);helpers.each(dataset.data,function(dataPoint,index){var pointPosition;if(!this.scale.animation){pointPosition=this.scale.getPointPosition(index,this.scale.calculateCenterOffset(dataPoint));}datasetObject.points.push(new this.PointClass({value:dataPoint,label:data.labels[index],datasetLabel:dataset.label,x:this.options.animation?this.scale.xCenter:pointPosition.x,y:this.options.animation?this.scale.yCenter:pointPosition.y,strokeColor:dataset.pointStrokeColor,fillColor:dataset.pointColor,highlightFill:dataset.pointHighlightFill||dataset.pointColor,highlightStroke:dataset.pointHighlightStroke||dataset.pointStrokeColor}));},this);},this);this.render();},eachPoints:function eachPoints(callback){helpers.each(this.datasets,function(dataset){helpers.each(dataset.points,callback,this);},this);},getPointsAtEvent:function getPointsAtEvent(evt){var mousePosition=helpers.getRelativePosition(evt),fromCenter=helpers.getAngleFromPoint({x:this.scale.xCenter,y:this.scale.yCenter},mousePosition);var anglePerIndex=Math.PI*2/this.scale.valuesCount,pointIndex=Math.round((fromCenter.angle-Math.PI*1.5)/anglePerIndex),activePointsCollection=[];if(pointIndex>=this.scale.valuesCount||pointIndex<0){pointIndex=0;}if(fromCenter.distance<=this.scale.drawingArea){helpers.each(this.datasets,function(dataset){activePointsCollection.push(dataset.points[pointIndex]);});}return activePointsCollection;},buildScale:function buildScale(data){this.scale=new Chart.RadialScale({display:this.options.showScale,fontStyle:this.options.scaleFontStyle,fontSize:this.options.scaleFontSize,fontFamily:this.options.scaleFontFamily,fontColor:this.options.scaleFontColor,showLabels:this.options.scaleShowLabels,showLabelBackdrop:this.options.scaleShowLabelBackdrop,backdropColor:this.options.scaleBackdropColor,backdropPaddingY:this.options.scaleBackdropPaddingY,backdropPaddingX:this.options.scaleBackdropPaddingX,lineWidth:this.options.scaleShowLine?this.options.scaleLineWidth:0,lineColor:this.options.scaleLineColor,angleLineColor:this.options.angleLineColor,angleLineWidth:this.options.angleShowLineOut?this.options.angleLineWidth:0,pointLabelFontColor:this.options.pointLabelFontColor,pointLabelFontSize:this.options.pointLabelFontSize,pointLabelFontFamily:this.options.pointLabelFontFamily,pointLabelFontStyle:this.options.pointLabelFontStyle,height:this.chart.height,width:this.chart.width,xCenter:this.chart.width/2,yCenter:this.chart.height/2,ctx:this.chart.ctx,templateString:this.options.scaleLabel,labels:data.labels,valuesCount:data.datasets[0].data.length});this.scale.setScaleSize();this.updateScaleRange(data.datasets);this.scale.buildYLabels();},updateScaleRange:function updateScaleRange(datasets){var valuesArray=function(){var totalDataArray=[];helpers.each(datasets,function(dataset){if(dataset.data){totalDataArray=totalDataArray.concat(dataset.data);}else{helpers.each(dataset.points,function(point){totalDataArray.push(point.value);});}});return totalDataArray;}();var scaleSizes=this.options.scaleOverride?{steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+this.options.scaleSteps*this.options.scaleStepWidth}:helpers.calculateScaleRange(valuesArray,helpers.min([this.chart.width,this.chart.height])/2,this.options.scaleFontSize,this.options.scaleBeginAtZero,this.options.scaleIntegersOnly);helpers.extend(this.scale,scaleSizes);},addData:function addData(valuesArray,label){this.scale.valuesCount++;helpers.each(valuesArray,function(value,datasetIndex){var pointPosition=this.scale.getPointPosition(this.scale.valuesCount,this.scale.calculateCenterOffset(value));this.datasets[datasetIndex].points.push(new this.PointClass({value:value,label:label,x:pointPosition.x,y:pointPosition.y,strokeColor:this.datasets[datasetIndex].pointStrokeColor,fillColor:this.datasets[datasetIndex].pointColor}));},this);this.scale.labels.push(label);this.reflow();this.update();},removeData:function removeData(){this.scale.valuesCount--;this.scale.labels.shift();helpers.each(this.datasets,function(dataset){dataset.points.shift();},this);this.reflow();this.update();},update:function update(){this.eachPoints(function(point){point.save();});this.reflow();this.render();},reflow:function reflow(){helpers.extend(this.scale,{width:this.chart.width,height:this.chart.height,size:helpers.min([this.chart.width,this.chart.height]),xCenter:this.chart.width/2,yCenter:this.chart.height/2});this.updateScaleRange(this.datasets);this.scale.setScaleSize();this.scale.buildYLabels();},draw:function draw(ease){var easeDecimal=ease||1,ctx=this.chart.ctx;this.clear();this.scale.draw();helpers.each(this.datasets,function(dataset){helpers.each(dataset.points,function(point,index){if(point.hasValue()){point.transition(this.scale.getPointPosition(index,this.scale.calculateCenterOffset(point.value)),easeDecimal);}},this);ctx.lineWidth=this.options.datasetStrokeWidth;ctx.strokeStyle=dataset.strokeColor;ctx.beginPath();helpers.each(dataset.points,function(point,index){if(index===0){ctx.moveTo(point.x,point.y);}else{ctx.lineTo(point.x,point.y);}},this);ctx.closePath();ctx.stroke();ctx.fillStyle=dataset.fillColor;ctx.fill();helpers.each(dataset.points,function(point){if(point.hasValue()){point.draw();}});},this);}});}).call(this);var TimeShaft=function(){function TimeShaft(_parent){this.parent=_parent;this.containerHeight=100;this.pointList=undefined;this.timeShaftLabel=undefined;this.dictData=undefined;this.startTime=undefined;this.endTime=undefined;this.tbCurrentTime=undefined;this.playHandle=undefined;this.isPlaying=false;this.playInterval=1000;this.$inputInterval=undefined;var _this=this;this.defer=$.Deferred();}
TimeShaft.prototype={show:function show(){var _this=this;WebAPI.get("/static/views/observer/widgets/timeShaft.html").done(function(resultHtml){_this.resultHtml=resultHtml;_this.defer.resolve();});$.when(this.defer).done(function(){_this.parent.toolContainer.html(_this.resultHtml);_this.parent.toolContainer.animate({height:_this.containerHeight+'px'},200);_this.init();I18n.fillArea(_this.parent.toolContainer);});$('.toolBacktrace .dropdownNav','#liProjectMenu').text(I18n.resource.observer.widgets.QUIT_TRACE);},close:function close(){if(this.parent.toolContainer)this.parent.toolContainer.html('');this.parent=null;this.containerHeight=null;this.pointList=null;this.timeShaftLabel=null;this.dictData=null;this.tbCurrentTime=null;if(this.playHandle)clearInterval(this.playHandle);this.playHandle=null;this.resultHtml=null;$('.toolBacktrace .dropdownNav','#liProjectMenu').text(I18n.resource.observer.widgets.BACKTRACE);},init:function init(){var _this=this;this.tbCurrentTime=document.getElementById('txtCurrentTime');this.$inputInterval=$('#inputInterval');WebAPI.get("/get_history_data/getMinPeriod/"+AppConfig.projectId).done(function(dataSrc){if(undefined==dataSrc)return;if(dataSrc['minPeriod']!='m1')_this.$inputInterval.children(':first').css('display','none');else _this.$inputInterval.children(':first').css('display','block');});var now=new Date();var sessionStartTime=sessionStorage.getItem(AppConfig.userId+'_dataPlay_startTime');var sessionEndTime=sessionStorage.getItem(AppConfig.userId+'_dataPlay_endTime');var sessionInterval=sessionStorage.getItem(AppConfig.userId+'_dataPlay_interval');if(sessionStartTime&&sessionEndTime){this.startTime=new Date(sessionStartTime);this.endTime=new Date(sessionEndTime);}else{this.startTime=new Date(now-86400000);this.endTime=now;}
if(sessionInterval){this.$inputInterval.val(sessionInterval);}
$("#txtTimeStart").val(timeFormat(this.startTime,timeFormatChange($("#txtTimeStart").data().format))).on('changeDate',function(ev){$(this).val(timeFormat(ev.currentTarget.value,timeFormatChange(this.dataset.format)));});$("#txtTimeEnd").val(timeFormat(this.endTime,timeFormatChange($("#txtTimeEnd").data().format))).on('changeDate',function(ev){$(this).val(timeFormat(ev.currentTarget.value,timeFormatChange(this.dataset.format)));});_this.refreshCalendar();$("#select_id option[index='0']").prop("selected",'selected');_this.$inputInterval.off('change').change(function(){_this.refreshCalendar();});$('#divFramesConfig a[elapse]').off('click').click(function(e){var timeBaseline,timeFlags;timeFlags=e.currentTarget.attributes['elapse'].value.split(',');if(timeFlags.length==2){timeBaseline=+new Date();timeBaseline=timeBaseline+new Date().getTimezoneOffset()*60000-timeBaseline%86400000;var end=new Date(timeBaseline+parseInt(timeFlags[1])-1000);var now=new Date();if(end>now){now.setHours(now.getHours()-1);_this.endTime=now.format('yyyy-MM-dd HH:55:00');}else{_this.endTime=end.format('yyyy-MM-dd HH:55:00');}
_this.startTime=new Date(timeBaseline+parseInt(timeFlags[0]));}else{var time=new Date();var now=new Date();if(timeFlags[0]=='thisWeek'){time.setDate(time.getDate()-time.getDay());time.setHours(0);time.setMinutes(0);time.setSeconds(0);now.setHours(now.getHours()-1);_this.endTime=now.format('yyyy-MM-dd HH:55:00');_this.startTime=time;}else if(timeFlags[0]=='lastWeek'){time.setDate(time.getDate()-time.getDay()-7);time.setHours(0);time.setMinutes(0);time.setSeconds(0);_this.startTime=time;_this.endTime=new Date(time.getTime()+86400000*7-60000);}}
_this.requestData(_this.startTime,_this.endTime);});$('#btnRquestHistory').off('click').click(function(e){var now=new Date();_this.startTime=$("#txtTimeStart").val().toDate().format('yyyy-MM-dd HH:00:00');_this.endTime=$("#txtTimeEnd").val().toDate().format('yyyy-MM-dd HH:55:00');;if(now<new Date(_this.endTime)){now.setHours(now.getHours()-1);_this.endTime=now.format('yyyy-MM-dd HH:55:00');}
_this.requestData(_this.startTime,_this.endTime);sessionStorage.setItem(AppConfig.userId+'_dataPlay_startTime',$("#txtTimeStart").val());sessionStorage.setItem(AppConfig.userId+'_dataPlay_endTime',$("#txtTimeEnd").val());sessionStorage.setItem(AppConfig.userId+'_dataPlay_interval',$("#inputInterval").val());});$("#btnPlay").off('click').click(function(e){if(_this.isPlaying){_this.stop();}else{_this.play();}});$("#btnPrevious").off('click').click(function(e){var element=$('#tabFrames .td-frame-selected');var label=$('#tabFrames .td-frame-selected').attr('data-title');if(label&&label!=''){var index=_this.timeShaftLabel.indexOf(label);if(index>0){_this.setActive(element.prev());_this.renderParentScreen(_this.timeShaftLabel[index-1]);if(index<2){this.classList.add('disabled');}
if(index<=_this.timeShaftLabel.length-1){$("#btnNext").removeClass('disabled');}}}});$("#btnNext").off('click').click(function(e){var element=$('#tabFrames .td-frame-selected');var label=$('#tabFrames .td-frame-selected').attr('data-title');if(label&&label!=''){var index=_this.timeShaftLabel.indexOf(label);if(index>-1&&index<_this.timeShaftLabel.length-1){_this.setActive(element.next());_this.renderParentScreen(_this.timeShaftLabel[index+1]);if(index>_this.timeShaftLabel.length-3){this.classList.add('disabled');}
if(index>=0){$('#btnPrevious').removeClass('disabled');}}}});var $intervalTimes=$('#intervalTimes');$("#btnTime").off('click').click(function(e){$intervalTimes.prev('div').hide();$intervalTimes.show();});$intervalTimes.children('span').off('click').click(function(){$intervalTimes.prev('div').show();$intervalTimes.hide();_this.playInterval=parseInt($(this).attr('time'))*1000;if(_this.isPlaying){_this.stop();_this.play();}});$("#btnConfig").click(function(e){if(_this.isPlaying){_this.stop();}
$('#divFramesConfig').show();$('#divPaneFrames').hide();});},showFramePane:function showFramePane(){$('#divFramesConfig').hide();$('#divPaneFrames').show();},requestData:function requestData(startTime,endTime,screen,isPlayTheCenterFrame){var _this=this;if(startTime>endTime){alert('Time range error.');return;}
this.startTime=startTime;this.endTime=endTime;_this.refreshCalendar();var timeStepSelectedValue=_this.$inputInterval?_this.$inputInterval.val():'m5';var data={projectId:AppConfig.projectId,timeStart:startTime.format("yyyy-MM-dd HH:mm:ss"),timeEnd:endTime.format("yyyy-MM-dd HH:mm:ss"),timeFormat:timeStepSelectedValue,pointList:Object.keys(screen?screen.dictRefreshMap:this.parent.dictRefreshMap)};Spinner.spin(ElScreenContainer);WebAPI.post("/get_history_data_padded_reduce",data).done(function(dataSrc){if(dataSrc==undefined||!dataSrc.timeStamp){alert('no history data');return;}
if(screen){_this.renderCurrentMoment(screen,dataSrc);}else{_this.initData(dataSrc);_this.initTimeShaft();$('#divFramesConfig').hide();$('#divPaneFrames').show();isPlayTheCenterFrame&&ToolCurrent.playTheCenterMoment();}}).always(function(){Spinner.stop();});},returnToMoment:function returnToMoment(time,screen){var screen=screen?screen:this.parent;this.requestData(time,time,screen);},requestDataForCurrentMoment:function requestDataForCurrentMoment(screen){var time=this.tbCurrentTime.value.toDate();this.requestData(time,time,screen);},renderCurrentMoment:function renderCurrentMoment(screen,dataSrc){var arrData=[];for(var key in dataSrc.data){arrData.push({name:key,value:dataSrc.data[key][0]});}
screen.renderData(arrData);},initData:function initData(dataSrc){if(undefined==dataSrc.data)return;this.timeShaftLabel=new Array();this.dictData=new Object();if(this.timeShaftLabel.length==0){for(var i=0,len=dataSrc.timeStamp.length;i<len;i++){var time=timeFormat(dataSrc.timeStamp[i],"yyyy-mm-dd hh:ii");this.timeShaftLabel.push(time);this.dictData[time]=new Array();}}
var name,val,time;for(var key in dataSrc.data){name=key;for(var i=0,len=dataSrc.timeStamp.length;i<len;i++){var time=dataSrc.timeStamp[i].toDate().format("yyyy-MM-dd HH:mm");this.dictData[time].push({name:name,value:dataSrc.data[key][i]});}}},planTdColSpan:function planTdColSpan(){var _this=this;var labels=this.timeShaftLabel;var iptIntlVal=_this.$inputInterval.val();if(iptIntlVal=='m5'){var tempMinute='';this.dictMinute={};for(var i=0;i<labels.length;i++){var labelMinute=timeFormat(labels[i],timeFormatChange(this.tbCurrentTime.dataset.format));if(tempMinute!=labelMinute.split(':')[0]){tempMinute=labelMinute.split(':')[0];this.dictMinute[tempMinute]=1;}else{this.dictMinute[tempMinute]++;}}}else if(iptIntlVal=='h1'){var tempHour='';this.dictHour={};for(var i=0;i<labels.length;i++){var labelHour=labels[i];if(tempHour!=labelHour.split(' ')[0]){tempHour=labelHour.split(' ')[0];this.dictHour[tempHour]=1;}else{this.dictHour[tempHour]++;}}}else if(iptIntlVal=='d1'){var tempDay='';this.dictDay={};for(var i=0;i<labels.length;i++){var labelDay=labels[i];var secondHrPost=labelDay.indexOf('-',labelDay.indexOf('-')+1);if(tempDay!=labelDay.substring(0,secondHrPost)){tempDay=labelDay.substring(0,secondHrPost);this.dictDay[tempDay]=1;}else{this.dictDay[tempDay]++;}}}else if(iptIntlVal=='M1'){var tempMouth='';this.dictMouth={};for(var i=0;i<labels.length;i++){var labelMouth=labels[i];if(tempMouth!=labelMouth.split('-')[0]){tempMouth=labelMouth.split('-')[0];this.dictMouth[tempMouth]=1;}else{this.dictMouth[tempMouth]++;}}}},addFirstTd:function addFirstTd(dict,label,trtop,iptIntvlVal){var _this=this;var tdContTotal=label.split(':')[0];var tdContTotal2=timeFormat(label,timeFormatChange(this.tbCurrentTime.dataset.format));td=document.createElement('td');td.className='td-border-split';$(td).css({'white-space':'nowrap'});if(iptIntvlVal=='m5'){td.textContent=tdContTotal2.split(':')[0]+":00";}else if(iptIntvlVal=='h1'){td.textContent=tdContTotal.split(' ')[0];}else if(iptIntvlVal=='d1'){td.textContent=tdContTotal.split('-')[0]+'-'+tdContTotal.split('-')[1];}else{td.textContent=tdContTotal.split('-')[0];}
for(var temp in dict){var countTotal=dict[temp];if(td.textContent.split(':')[0]==temp){td.colSpan=countTotal;}}
trtop.appendChild(td);},initTimeShaft:function initTimeShaft(){var _this=this;var trs=document.getElementById('tabFrames').getElementsByTagName('tr');var trTop=trs[0],trData=trs[1],trBottom=trs[2],td;var iptIntvlVal=_this.$inputInterval.val();trTop.innerHTML='';trData.innerHTML='';trBottom.innerHTML='';this.planTdColSpan();for(var i=0,count=1,len=this.timeShaftLabel.length;i<len;i++){var label=this.timeShaftLabel[i];if(iptIntvlVal=='m5'){if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].split(':')[1]!='00'&&i==0){this.addFirstTd(this.dictMinute,label,trTop,'m5');}else if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].indexOf(':00')>=0){this.addFirstTd(this.dictMinute,label,trTop,'m5');count=0;}}else if(iptIntvlVal=='h1'){if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].split(' ')[1]!='00:00'&&i==0){this.addFirstTd(this.dictHour,label,trTop,'h1');}else if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].indexOf('00:00')>=0){this.addFirstTd(this.dictHour,label,trTop,'h1');count=0;}}else if(iptIntvlVal=='d1'){if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].split('-')[2]!='01 00:00'&&i==0){this.addFirstTd(this.dictDay,label,trTop,'d1');}else if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].indexOf('01 00:00')>=0){this.addFirstTd(this.dictDay,label,trTop,'d1');count=0;}}else{if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].split('-')[1]+'-'+this.timeShaftLabel[i].split('-')[2]!='01-01 00:00'&&i==0){this.addFirstTd(this.dictMouth,label,trTop);}else if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].indexOf('01-01 00:00')>=0){this.addFirstTd(this.dictMouth,label,trTop);count=0;}}
td=document.createElement('td');td.title=timeFormat(label,timeFormatChange(this.tbCurrentTime.dataset.format));td.dataset.title=label;td.className='td-frame';if(i==0){td.classList.add('td-frame-selected');this.renderParentScreen(label);}
td.onclick=function(e){var target=e.currentTarget||e.target;_this.setActive($(target));_this.renderParentScreen(target.attributes['data-title'].value);_this.setBtnStatus();};trData.appendChild(td);td=document.createElement('td');td.className='td-border-split';if(iptIntvlVal=='m5'){td.textContent=label.split(':')[1];}else if(iptIntvlVal=='h1'){var hourThirdTd=label.split(':')[0];td.textContent=hourThirdTd.split(' ')[1].split(':')[0];}else if(iptIntvlVal=='d1'){var dayThirdTd=label.split(':')[0];td.textContent=dayThirdTd.split('-')[2].split(' ')[0];}else{var dayThirdTd=label.split(':')[0];td.textContent=dayThirdTd.split('-')[1];}
trBottom.appendChild(td);count++;}
this.setBtnStatus();},renderParentScreen:function renderParentScreen(time){if(undefined==time){return;}
this.tbCurrentTime.value=timeFormat(time,timeFormatChange(this.tbCurrentTime.dataset.format));this.parent.renderData(this.dictData[time]);},play:function play(){var _this=this;this.isPlaying=true;var startTimeLabel;var selectedFrames=$('#tabFrames .td-frame-selected');if(selectedFrames.length>0){startTimeLabel=selectedFrames.first().attr('data-title');}else{startTimeLabel=this.timeShaftLabel[0];}
var index=this.timeShaftLabel.indexOf(startTimeLabel);this.playHandle=setInterval(function(e){if(index>_this.timeShaftLabel.length){_this.stop();}else{if(index<_this.timeShaftLabel.length-1){var element=$('#tabFrames .td-frame-selected').removeClass('td-frame-selected').next();element.addClass('td-frame-selected');}
_this.renderParentScreen(_this.timeShaftLabel[index]);index++;}},_this.playInterval);$('#btnPlay span').removeClass('glyphicon-play').addClass('glyphicon-pause');},stop:function stop(){this.isPlaying=false;if(this.playHandle)clearInterval(this.playHandle);$('#btnPlay span').removeClass('glyphicon-pause').addClass('glyphicon-play');},setActive:function setActive(jqueryElement){$('#tabFrames .td-frame-selected').removeClass('td-frame-selected').next();jqueryElement.addClass('td-frame-selected');this.stop();},playTheCenterMoment:function playTheCenterMoment(){var indexCenter=parseInt(this.timeShaftLabel.length/2);this.setActive($($('#tabFrames .td-frame')[indexCenter]));this.renderParentScreen(this.timeShaftLabel[indexCenter]);},setBtnStatus:function setBtnStatus(){var $btnPre=$('#btnPrevious');var $btnNext=$('#btnNext');if($('#tabFrames tbody tr:nth-child(2) td:nth-child(1)')[0].className.indexOf('td-frame-selected')>-1){$btnPre.addClass('disabled');}else{$btnPre.removeClass('disabled');}
if($('#tabFrames tbody tr:nth-child(2) td:nth-last-child(1)')[0].className.indexOf('td-frame-selected')>-1){$btnNext.addClass('disabled');}else{$btnNext.removeClass('disabled');}},refreshCalendar:function refreshCalendar(){var _this=this;if(_this.$inputInterval&&_this.$inputInterval.val()=='M1'){$('.navbar-left .form_datetime').datetimepicker('remove');$('.navbar-left .form_datetime').datetime({format:"yyyy-mm-dd 00:00",minView:"year",startView:4});}else{var interval=function(intvl){var intvlTime=5;if(intvl=='h1'){intvlTime=60;}else if(intvl=='d1'){intvlTime=1440;}
return intvlTime*60000;}(_this.$inputInterval?_this.$inputInterval.val():'');$('.form_datetime').datetimepicker('remove');$(".form_datetime").datetime({pickerPosition:"top-right"});$(this.tbCurrentTime).change(function(){var selectTime=new Date($('#txtCurrentTime').val()).getTime();var time=(selectTime-selectTime%interval).toDate().format('yyyy-MM-dd HH:mm');$('#tabFrames .td-frame[data-title="'+time+'"]').click();});}}};return TimeShaft;}();var TimeShaftDashboard=function(){function TimeShaftDashboard(_parent){TimeShaft.call(_parent);this.parent=_parent;this.containerHeight=100;this.timeShaftLabel=undefined;this.dictData=undefined;this.startTime=undefined;this.endTime=undefined;this.tbCurrentTime=undefined;this.$inputInterval=undefined;var _this=this;this.defer=$.Deferred();WebAPI.get("/static/views/observer/widgets/timeShaft.html").done(function(resultHtml){_this.resultHtml=resultHtml;_this.defer.resolve();});}
TimeShaftDashboard.prototype=new TimeShaft();TimeShaftDashboard.prototype.show=function(){var _this=this;$.when(this.defer).done(function(){_this.parent.toolContainer.html(_this.resultHtml);_this.parent.toolContainer.css({height:_this.containerHeight+'px'});_this.init();I18n.fillArea(_this.parent.toolContainer);});};TimeShaftDashboard.prototype.requestData=function(startTime,endTime,screen,isPlayTheCenterFrame){var _this=this;if(startTime>endTime){alert('Time range error.');return;}
this.startTime=startTime;this.endTime=endTime;_this.refreshCalendar();if(undefined==_this.parent.store.dsInfoList){return;}
var dsIdList=[];for(var i=0,len=_this.parent.store.dsInfoList.length;i<len;i++){dsIdList.push(_this.parent.store.dsInfoList[i].id);}
var timeStepSelectedValue=_this.$inputInterval.val();var postData={dsItemIds:dsIdList,timeStart:startTime.format("yyyy-MM-dd HH:mm:ss"),timeEnd:endTime.format("yyyy-MM-dd HH:mm:ss"),timeFormat:timeStepSelectedValue};Spinner.spin(ElScreenContainer);WebAPI.post("/analysis/startWorkspaceDataGenHistogram",postData).done(function(dataSrc){if(dataSrc==undefined||!dataSrc.timeShaft){alert('no history data');return;}
if(screen){_this.renderCurrentMoment(screen,dataSrc);}else{_this.initData(dataSrc);_this.initTimeShaft();$('#divFramesConfig').hide();$('#divPaneFrames').show();isPlayTheCenterFrame&&ToolCurrent.playTheCenterMoment();}}).always(function(){Spinner.stop();});};TimeShaftDashboard.prototype.initData=function(dataSrc){if(undefined==dataSrc.list)return;this.timeShaftLabel=new Array();this.dictData=new Object();if(this.timeShaftLabel.length==0){for(var i=0,len=dataSrc.timeShaft.length;i<len;i++){var time=dataSrc.timeShaft[i].toDate().format("yyyy-MM-dd HH:mm");this.timeShaftLabel.push(time);this.dictData[time]=new Array();}}
var name,time;for(var j=0,len2=dataSrc.list.length;j<len2;j++){name=dataSrc.list[j].dsItemId;for(var k=0,len3=dataSrc.timeShaft.length;k<len3;k++){time=dataSrc.timeShaft[k].toDate().format("yyyy-MM-dd HH:mm");this.dictData[time].push({dsItemId:name,data:dataSrc.list[j].data[k],time:time});}}};TimeShaftDashboard.prototype.renderParentScreen=function(time){if(undefined==time){return;}
this.tbCurrentTime.value=timeFormat(time,timeFormatChange(this.tbCurrentTime.dataset.format));this.parent.renderData(this.dictData[time],new Date(time),this.startTime,this.endTime);};TimeShaftDashboard.prototype.setBtnStatus=function(){var $btnPre=$('#btnPrevious');var $btnNext=$('#btnNext');var child1=$('#tabFrames tbody tr:nth-child(2) td:nth-child(1)')[0];if(undefined!=child1){if(child1.className.indexOf('td-frame-selected')>-1){$btnPre.addClass('disabled');}else{$btnPre.removeClass('disabled');}}
var child2=$('#tabFrames tbody tr:nth-child(2) td:nth-last-child(1)')[0];if(undefined!=child2){if(child2.className.indexOf('td-frame-selected')>-1){$btnNext.addClass('disabled');}else{$btnNext.removeClass('disabled');}}};return TimeShaftDashboard;}();var TimeShaftPageScreen=function(){function TimeShaftPageScreen(){TimeShaft.apply(this,arguments);this.containerHeight=100;this.$container=$(this.parent.replayCtn);}
TimeShaftPageScreen.prototype=Object.create(TimeShaft.prototype);TimeShaftPageScreen.prototype.constructor=TimeShaftPageScreen;TimeShaftPageScreen.prototype.show=function(){var _this=this;WebAPI.get("/static/views/observer/widgets/timeShaft.html").done(function(resultHtml){_this.resultHtml=resultHtml;_this.defer.resolve();});return $.when(this.defer).done(function(){_this.$container.html(_this.resultHtml);_this.$container.animate({height:_this.containerHeight+'px'},200);_this.init();I18n.fillArea(_this.$container);});};TimeShaftPageScreen.prototype.requestData=function(startTime,endTime,screen,isPlayTheCenterFrame){var _this=this;var points=[];if(startTime>endTime){alert('Time range error.');return;}
this.startTime=startTime;this.endTime=endTime;points=function(pointMap){var points=[];Object.keys(pointMap).forEach(function(k){points=points.concat(pointMap[k]||[]);});return points;}(this.parent.store.dictPoints);_this.refreshCalendar();if(!points||!points.length){return;}
var timeStepSelectedValue=_this.$inputInterval.val();var postData={dsItemIds:points,timeStart:startTime.format("yyyy-MM-dd HH:mm:ss"),timeEnd:endTime.format("yyyy-MM-dd HH:mm:ss"),timeFormat:timeStepSelectedValue};Spinner.spin(ElScreenContainer);WebAPI.post("/analysis/startWorkspaceDataGenHistogram",postData).done(function(dataSrc){if(dataSrc==undefined||!dataSrc.timeShaft){alert('no history data');return;}
if(screen){_this.renderCurrentMoment(screen,dataSrc);}else{_this.initData(dataSrc);_this.initTimeShaft();$('#divFramesConfig').hide();$('#divPaneFrames').show();isPlayTheCenterFrame&&_this.playTheCenterMoment();}}).always(function(){Spinner.stop();});};TimeShaftPageScreen.prototype.renderCurrentMoment=function(screen,dataSrc){screen.renderData(dataSrc);},TimeShaftPageScreen.prototype.initData=function(dataSrc){if(undefined==dataSrc.list)return;this.timeShaftLabel=new Array();this.dictData=new Object();if(this.timeShaftLabel.length==0){for(var i=0,len=dataSrc.timeShaft.length;i<len;i++){var time=dataSrc.timeShaft[i].toDate().format("yyyy-MM-dd HH:mm");this.timeShaftLabel.push(time);this.dictData[time]=new Array();}}
var name,time;for(var j=0,len2=dataSrc.list.length;j<len2;j++){name=dataSrc.list[j].dsItemId;for(var k=0,len3=dataSrc.timeShaft.length;k<len3;k++){time=dataSrc.timeShaft[k].toDate().format("yyyy-MM-dd HH:mm");this.dictData[time].push({dsItemId:name,data:dataSrc.list[j].data[k],time:time});}}};TimeShaftPageScreen.prototype.renderParentScreen=function(time){if(undefined==time){return;}
this.tbCurrentTime.value=time;this.parent.renderData(this.dictData[time]);};TimeShaftPageScreen.prototype.setBtnStatus=function(){var $btnPre=$('#btnPrevious');var $btnNext=$('#btnNext');var child1=$('#tabFrames tbody tr:nth-child(2) td:nth-child(1)')[0];if(undefined!=child1){if(child1.className.indexOf('td-frame-selected')>-1){$btnPre.addClass('disabled');}else{$btnPre.removeClass('disabled');}}
var child2=$('#tabFrames tbody tr:nth-child(2) td:nth-last-child(1)')[0];if(undefined!=child2){if(child2.className.indexOf('td-frame-selected')>-1){$btnNext.addClass('disabled');}else{$btnNext.removeClass('disabled');}}};return TimeShaftPageScreen;}();var simpleHeat=function(){function simpleHeat(canvas){if(!(this instanceof simpleHeat)){return new simpleHeat(canvas);}
this._canvas=canvas=typeof canvas==='string'?document.getElementById(canvas):canvas;this.canvsdpalette=undefined;this._ctx=canvas.getContext('2d');this._width=canvas.width;this._height=canvas.height;this._max=1;this._data=[];}
simpleHeat.prototype={defaultRadius:8,defaultGradient:{0:'blue',0.25:'cyan',0.5:'lime',0.75:'yellow',1.0:'red'},data:function data(_data){this._data=_data;return this;},max:function max(_max){this._max=_max;return this;},min:function min(_min){this._min=_min;return this;},add:function add(point){this._data.push(point);return this;},clear:function clear(){this._data=[];return this;},gradient:function gradient(grad){this.canvsdpalette=document.createElement('canvas');var ctx=this.canvsdpalette.getContext('2d');this.canvsdpalette.width=1;this.canvsdpalette.height=256;var gradient=ctx.createLinearGradient(0,0,0,256);for(var i in grad){gradient.addColorStop(i,grad[i]);}
ctx.save();ctx.globalAlpha=1;ctx.fillStyle=gradient;ctx.fillRect(0,0,1,256);ctx.restore();this._grad=ctx.getImageData(0,0,1,256).data;return this;},draw:function draw(minOpacity){if(!this._grad){this.gradient(this.defaultGradient);}
var ctx=this._ctx,pAlpha;ctx.clearRect(0,0,this._width,this._height);var a=1/(this._max-this._min),b=this._min/(this._min-this._max),c=(this._max-this._min)/2;for(var i=0,len=this._data.length,p,temp;i<len;i++){p=this._data[i],temp=p[2];if(temp==0)continue;if(temp<this._max&&temp>this._min){pAlpha=(c-Math.abs(temp-this._min-c))/c;pAlpha=pAlpha<0.5?pAlpha*0.4:pAlpha*0.9;}else{pAlpha=0.9;}
var r=this.defaultRadius;var blur=blur||30;var circle=document.createElement('canvas'),ctxCircle=circle.getContext('2d'),r2=this._r=r+blur;circle.width=circle.height=r2*2;ctxCircle.save();ctxCircle.shadowOffsetX=ctxCircle.shadowOffsetY=200;ctxCircle.shadowBlur=blur;var intTemp=parseInt(temp),x=intTemp-this._min,j,color;j=x<0?0:parseInt(256*a*x)*4;if(j>=1024)j=1020;ctxCircle.shadowColor=ctxCircle.fillStyle='rgb('+this._grad[j]+', '+this._grad[j+1]+', '+this._grad[j+2]+')';ctxCircle.beginPath();ctxCircle.arc(r2-200,r2-200,r,0,Math.PI*2,true);ctxCircle.closePath();ctxCircle.fill();ctxCircle.restore();ctx.globalAlpha=Math.max(minOpacity,pAlpha);ctx.drawImage(circle,p[0]-this._r,p[1]-this._r);ctxCircle=null;circle=null;}
return this;},destroy:function destroy(){this._data=null;this._canvas=null;}};return simpleHeat;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var Konva={};(function(root){'use strict';var PI_OVER_180=Math.PI/180;Konva={version:'0.10.0',stages:[],idCounter:0,ids:{},names:{},shapes:{},listenClickTap:false,inDblClickWindow:false,enableTrace:false,traceArrMax:100,dblClickWindow:400,pixelRatio:undefined,dragDistance:0,angleDeg:true,showWarnings:true,Filters:{},isDragging:function isDragging(){var dd=Konva.DD;if(dd){return dd.isDragging;}return false;},isDragReady:function isDragReady(){var dd=Konva.DD;if(dd){return!!dd.node;}return false;},_addId:function _addId(node,id){if(id!==undefined){this.ids[id]=node;}},_removeId:function _removeId(id){if(id!==undefined){delete this.ids[id];}},_addName:function _addName(node,name){if(name){if(!this.names[name]){this.names[name]=[];}this.names[name].push(node);}},_removeName:function _removeName(name,_id){if(!name){return;}var nodes=this.names[name];if(!nodes){return;}for(var n=0;n<nodes.length;n++){var no=nodes[n];if(no._id===_id){nodes.splice(n,1);}}if(nodes.length===0){delete this.names[name];}},getAngle:function getAngle(angle){return this.angleDeg?angle*PI_OVER_180:angle;},_parseUA:function _parseUA(userAgent){var ua=userAgent.toLowerCase(),match=/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf('compatible')<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[],mobile=!!userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i),ieMobile=!!userAgent.match(/IEMobile/i);return{browser:match[1]||'',version:match[2]||'0',mobile:mobile,ieMobile:ieMobile};},UA:undefined};Konva.UA=Konva._parseUA(root.navigator&&root.navigator.userAgent||'');})(this);(function(root,factory){'use strict';if((typeof exports==='undefined'?'undefined':_typeof(exports))==='object'){var KonvaJS=factory();if(global.window&&global.window.document){Konva.document=global.window.document;Konva.window=global.window;}else{var Canvas=require('canvas');var jsdom=require('jsdom').jsdom;Konva.document=jsdom('<!DOCTYPE html><html><head></head><body></body></html>');Konva.window=Konva.document.parentWindow;Konva.window.Image=Canvas.Image;Konva._nodeCanvas=Canvas;}Konva.root=root;module.exports=KonvaJS;return;}else if(typeof define==='function'&&define.amd){define(factory);}Konva.document=document;Konva.window=window;Konva.root=root;})(this,function(){'use strict';return Konva;});(function(){'use strict';Konva.Collection=function(){var args=[].slice.call(arguments),length=args.length,i=0;this.length=length;for(;i<length;i++){this[i]=args[i];}return this;};Konva.Collection.prototype=[];Konva.Collection.prototype.each=function(func){for(var n=0;n<this.length;n++){func(this[n],n);}};Konva.Collection.prototype.toArray=function(){var arr=[],len=this.length,n;for(n=0;n<len;n++){arr.push(this[n]);}return arr;};Konva.Collection.toCollection=function(arr){var collection=new Konva.Collection(),len=arr.length,n;for(n=0;n<len;n++){collection.push(arr[n]);}return collection;};Konva.Collection._mapMethod=function(methodName){Konva.Collection.prototype[methodName]=function(){var len=this.length,i;var args=[].slice.call(arguments);for(i=0;i<len;i++){this[i][methodName].apply(this[i],args);}return this;};};Konva.Collection.mapMethods=function(constructor){var prot=constructor.prototype;for(var methodName in prot){Konva.Collection._mapMethod(methodName);}};Konva.Transform=function(m){this.m=m&&m.slice()||[1,0,0,1,0,0];};Konva.Transform.prototype={copy:function copy(){return new Konva.Transform(this.m);},point:function point(_point){var m=this.m;return{x:m[0]*_point.x+m[2]*_point.y+m[4],y:m[1]*_point.x+m[3]*_point.y+m[5]};},translate:function translate(x,y){this.m[4]+=this.m[0]*x+this.m[2]*y;this.m[5]+=this.m[1]*x+this.m[3]*y;return this;},scale:function scale(sx,sy){this.m[0]*=sx;this.m[1]*=sx;this.m[2]*=sy;this.m[3]*=sy;return this;},rotate:function rotate(rad){var c=Math.cos(rad);var s=Math.sin(rad);var m11=this.m[0]*c+this.m[2]*s;var m12=this.m[1]*c+this.m[3]*s;var m21=this.m[0]*-s+this.m[2]*c;var m22=this.m[1]*-s+this.m[3]*c;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;return this;},getTranslation:function getTranslation(){return{x:this.m[4],y:this.m[5]};},skew:function skew(sx,sy){var m11=this.m[0]+this.m[2]*sy;var m12=this.m[1]+this.m[3]*sy;var m21=this.m[2]+this.m[0]*sx;var m22=this.m[3]+this.m[1]*sx;this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;return this;},multiply:function multiply(matrix){var m11=this.m[0]*matrix.m[0]+this.m[2]*matrix.m[1];var m12=this.m[1]*matrix.m[0]+this.m[3]*matrix.m[1];var m21=this.m[0]*matrix.m[2]+this.m[2]*matrix.m[3];var m22=this.m[1]*matrix.m[2]+this.m[3]*matrix.m[3];var dx=this.m[0]*matrix.m[4]+this.m[2]*matrix.m[5]+this.m[4];var dy=this.m[1]*matrix.m[4]+this.m[3]*matrix.m[5]+this.m[5];this.m[0]=m11;this.m[1]=m12;this.m[2]=m21;this.m[3]=m22;this.m[4]=dx;this.m[5]=dy;return this;},invert:function invert(){var d=1/(this.m[0]*this.m[3]-this.m[1]*this.m[2]);var m0=this.m[3]*d;var m1=-this.m[1]*d;var m2=-this.m[2]*d;var m3=this.m[0]*d;var m4=d*(this.m[2]*this.m[5]-this.m[3]*this.m[4]);var m5=d*(this.m[1]*this.m[4]-this.m[0]*this.m[5]);this.m[0]=m0;this.m[1]=m1;this.m[2]=m2;this.m[3]=m3;this.m[4]=m4;this.m[5]=m5;return this;},getMatrix:function getMatrix(){return this.m;},setAbsolutePosition:function setAbsolutePosition(x,y){var m0=this.m[0],m1=this.m[1],m2=this.m[2],m3=this.m[3],m4=this.m[4],m5=this.m[5],yt=(m0*(y-m5)-m1*(x-m4))/(m0*m3-m1*m2),xt=(x-m4-m2*yt)/m0;return this.translate(xt,yt);}};var CONTEXT_2D='2d',OBJECT_ARRAY='[object Array]',OBJECT_NUMBER='[object Number]',OBJECT_STRING='[object String]',PI_OVER_DEG180=Math.PI/180,DEG180_OVER_PI=180/Math.PI,HASH='#',EMPTY_STRING='',ZERO='0',KONVA_WARNING='Konva warning: ',KONVA_ERROR='Konva error: ',RGB_PAREN='rgb(',COLORS={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,132,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,255,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,203],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[119,128,144],slategrey:[119,128,144],snow:[255,255,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],transparent:[255,255,255,0],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,5]},RGB_REGEX=/rgb\((\d{1,3}),(\d{1,3}),(\d{1,3})\)/;Konva.Util={_isElement:function _isElement(obj){return!!(obj&&obj.nodeType==1);},_isFunction:function _isFunction(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply);},_isObject:function _isObject(obj){return!!obj&&obj.constructor===Object;},_isArray:function _isArray(obj){return Object.prototype.toString.call(obj)===OBJECT_ARRAY;},_isNumber:function _isNumber(obj){return Object.prototype.toString.call(obj)===OBJECT_NUMBER;},_isString:function _isString(obj){return Object.prototype.toString.call(obj)===OBJECT_STRING;},_throttle:function _throttle(func,wait,opts){var context,args,result;var timeout=null;var previous=0;var options=opts||{};var later=function later(){previous=options.leading===false?0:new Date().getTime();timeout=null;result=func.apply(context,args);context=args=null;};return function(){var now=new Date().getTime();if(!previous&&options.leading===false){previous=now;}var remaining=wait-(now-previous);context=this;args=arguments;if(remaining<=0){clearTimeout(timeout);timeout=null;previous=now;result=func.apply(context,args);context=args=null;}else if(!timeout&&options.trailing!==false){timeout=setTimeout(later,remaining);}return result;};},_hasMethods:function _hasMethods(obj){var names=[],key;for(key in obj){if(!obj.hasOwnProperty(key)){continue;}if(this._isFunction(obj[key])){names.push(key);}}return names.length>0;},createCanvasElement:function createCanvasElement(){var canvas=Konva.document.createElement('canvas');try{canvas.style=canvas.style||{};}catch(e){}return canvas;},isBrowser:function isBrowser(){return(typeof exports==='undefined'?'undefined':_typeof(exports))!=='object';},_isInDocument:function _isInDocument(el){while(el=el.parentNode){if(el==Konva.document){return true;}}return false;},_simplifyArray:function _simplifyArray(arr){var retArr=[],len=arr.length,util=Konva.Util,n,val;for(n=0;n<len;n++){val=arr[n];if(util._isNumber(val)){val=Math.round(val*1000)/1000;}else if(!util._isString(val)){val=val.toString();}retArr.push(val);}return retArr;},_getImage:function _getImage(arg,callback){var imageObj,canvas;if(!arg){callback(null);}
else if(this._isElement(arg)){callback(arg);}
else if(this._isString(arg)){imageObj=new Konva.window.Image();imageObj.onload=function(){callback(imageObj);};imageObj.src=arg;}
else if(arg.data){canvas=Konva.Util.createCanvasElement();canvas.width=arg.width;canvas.height=arg.height;var _context=canvas.getContext(CONTEXT_2D);_context.putImageData(arg,0,0);this._getImage(canvas.toDataURL(),callback);}else{callback(null);}},_getRGBAString:function _getRGBAString(obj){var red=obj.red||0,green=obj.green||0,blue=obj.blue||0,alpha=obj.alpha||1;return['rgba(',red,',',green,',',blue,',',alpha,')'].join(EMPTY_STRING);},_rgbToHex:function _rgbToHex(r,g,b){return((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);},_hexToRgb:function _hexToRgb(hex){hex=hex.replace(HASH,EMPTY_STRING);var bigint=parseInt(hex,16);return{r:bigint>>16&255,g:bigint>>8&255,b:bigint&255};},getRandomColor:function getRandomColor(){var randColor=(Math.random()*0xFFFFFF<<0).toString(16);while(randColor.length<6){randColor=ZERO+randColor;}return HASH+randColor;},get:function get(val,def){if(val===undefined){return def;}else{return val;}},getRGB:function getRGB(color){var rgb;if(color in COLORS){rgb=COLORS[color];return{r:rgb[0],g:rgb[1],b:rgb[2]};}
else if(color[0]===HASH){return this._hexToRgb(color.substring(1));}
else if(color.substr(0,4)===RGB_PAREN){rgb=RGB_REGEX.exec(color.replace(/ /g,''));return{r:parseInt(rgb[1],10),g:parseInt(rgb[2],10),b:parseInt(rgb[3],10)};}
else{return{r:0,g:0,b:0};}},colorToRGBA:function colorToRGBA(str){str=str||'black';return Konva.Util._namedColorToRBA(str)||Konva.Util._hex3ColorToRGBA(str)||Konva.Util._hex6ColorToRGBA(str)||Konva.Util._rgbColorToRGBA(str)||Konva.Util._rgbaColorToRGBA(str);},_namedColorToRBA:function _namedColorToRBA(str){var c=COLORS[str.toLowerCase()];if(!c){return null;}return{r:c[0],g:c[1],b:c[2],a:1};},_rgbColorToRGBA:function _rgbColorToRGBA(str){if(str.indexOf('rgb(')===0){str=str.match(/rgb\(([^)]+)\)/)[1];var parts=str.split(/ *, */).map(Number);return{r:parts[0],g:parts[1],b:parts[2],a:1};}},_rgbaColorToRGBA:function _rgbaColorToRGBA(str){if(str.indexOf('rgba(')===0){str=str.match(/rgba\(([^)]+)\)/)[1];var parts=str.split(/ *, */).map(Number);return{r:parts[0],g:parts[1],b:parts[2],a:parts[3]};}},_hex6ColorToRGBA:function _hex6ColorToRGBA(str){if(str[0]==='#'&&str.length===7){return{r:parseInt(str.slice(1,3),16),g:parseInt(str.slice(3,5),16),b:parseInt(str.slice(5,7),16),a:1};}},_hex3ColorToRGBA:function _hex3ColorToRGBA(str){if(str[0]==='#'&&str.length===4){return{r:parseInt(str[1]+str[1],16),g:parseInt(str[2]+str[2],16),b:parseInt(str[3]+str[3],16),a:1};}},_merge:function _merge(o1,o2){var retObj=this._clone(o2);for(var key in o1){if(this._isObject(o1[key])){retObj[key]=this._merge(o1[key],retObj[key]);}else{retObj[key]=o1[key];}}return retObj;},cloneObject:function cloneObject(obj){var retObj={};for(var key in obj){if(this._isObject(obj[key])){retObj[key]=this.cloneObject(obj[key]);}else if(this._isArray(obj[key])){retObj[key]=this.cloneArray(obj[key]);}else{retObj[key]=obj[key];}}return retObj;},cloneArray:function cloneArray(arr){return arr.slice(0);},_degToRad:function _degToRad(deg){return deg*PI_OVER_DEG180;},_radToDeg:function _radToDeg(rad){return rad*DEG180_OVER_PI;},_capitalize:function _capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1);},throw:function _throw(str){throw new Error(KONVA_ERROR+str);},error:function error(str){console.error(KONVA_ERROR+str);},warn:function warn(str){if(Konva.root.console&&console.warn&&Konva.showWarnings){console.warn(KONVA_WARNING+str);}},extend:function extend(child,parent){function Ctor(){this.constructor=child;}Ctor.prototype=parent.prototype;var oldProto=child.prototype;child.prototype=new Ctor();for(var key in oldProto){if(oldProto.hasOwnProperty(key)){child.prototype[key]=oldProto[key];}}child.__super__=parent.prototype;child.super=parent;},addMethods:function addMethods(constructor,methods){var key;for(key in methods){constructor.prototype[key]=methods[key];}},_getControlPoints:function _getControlPoints(x0,y0,x1,y1,x2,y2,t){var d01=Math.sqrt(Math.pow(x1-x0,2)+Math.pow(y1-y0,2)),d12=Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2)),fa=t*d01/(d01+d12),fb=t*d12/(d01+d12),p1x=x1-fa*(x2-x0),p1y=y1-fa*(y2-y0),p2x=x1+fb*(x2-x0),p2y=y1+fb*(y2-y0);return[p1x,p1y,p2x,p2y];},_expandPoints:function _expandPoints(p,tension){var len=p.length,allPoints=[],n,cp;for(n=2;n<len-2;n+=2){cp=Konva.Util._getControlPoints(p[n-2],p[n-1],p[n],p[n+1],p[n+2],p[n+3],tension);allPoints.push(cp[0]);allPoints.push(cp[1]);allPoints.push(p[n]);allPoints.push(p[n+1]);allPoints.push(cp[2]);allPoints.push(cp[3]);}return allPoints;},_removeLastLetter:function _removeLastLetter(str){return str.substring(0,str.length-1);},each:function each(obj,func){for(var key in obj){func(key,obj[key]);}},_getProjectionToSegment:function _getProjectionToSegment(x1,y1,x2,y2,x3,y3){var x,y,dist;var pd2=(x1-x2)*(x1-x2)+(y1-y2)*(y1-y2);if(pd2==0){x=x1;y=y1;dist=(x3-x2)*(x3-x2)+(y3-y2)*(y3-y2);}else{var u=((x3-x1)*(x2-x1)+(y3-y1)*(y2-y1))/pd2;if(u<0){x=x1;y=y1;dist=(x1-x3)*(x1-x3)+(y1-y3)*(y1-y3);}else if(u>1.0){x=x2;y=y2;dist=(x2-x3)*(x2-x3)+(y2-y3)*(y2-y3);}else{x=x1+u*(x2-x1);y=y1+u*(y2-y1);dist=(x-x3)*(x-x3)+(y-y3)*(y-y3);}}return[x,y,dist];},_getProjectionToLine:function _getProjectionToLine(pt,line,isClosed){var pc=Konva.Util.cloneObject(pt);var dist=Number.MAX_VALUE;line.forEach(function(p1,i){if(!isClosed&&i===line.length-1){return;}var p2=line[(i+1)%line.length];var proj=Konva.Util._getProjectionToSegment(p1.x,p1.y,p2.x,p2.y,pt.x,pt.y);var px=proj[0],py=proj[1],pdist=proj[2];if(pdist<dist){pc.x=px;pc.y=py;dist=pdist;}});return pc;},_prepareArrayForTween:function _prepareArrayForTween(startArray,endArray,isClosed){var n,start=[],end=[];if(startArray.length>endArray.length){var temp=endArray;endArray=startArray;startArray=temp;}for(n=0;n<startArray.length;n+=2){start.push({x:startArray[n],y:startArray[n+1]});}for(n=0;n<endArray.length;n+=2){end.push({x:endArray[n],y:endArray[n+1]});}var newStart=[];end.forEach(function(point){var pr=Konva.Util._getProjectionToLine(point,start,isClosed);newStart.push(pr.x);newStart.push(pr.y);});return newStart;}};})();(function(){'use strict';var canvas=Konva.Util.createCanvasElement(),context=canvas.getContext('2d'),_pixelRatio=function(){var devicePixelRatio=Konva.window.devicePixelRatio||1,backingStoreRatio=context.webkitBackingStorePixelRatio||context.mozBackingStorePixelRatio||context.msBackingStorePixelRatio||context.oBackingStorePixelRatio||context.backingStorePixelRatio||1;return devicePixelRatio/backingStoreRatio;}();Konva.Canvas=function(config){this.init(config);};Konva.Canvas.prototype={init:function init(config){var conf=config||{};var pixelRatio=conf.pixelRatio||Konva.pixelRatio||_pixelRatio;this.pixelRatio=pixelRatio;this._canvas=Konva.Util.createCanvasElement();this._canvas.style.padding=0;this._canvas.style.margin=0;this._canvas.style.border=0;this._canvas.style.background='transparent';this._canvas.style.position='absolute';this._canvas.style.top=0;this._canvas.style.left=0;},getContext:function getContext(){return this.context;},getPixelRatio:function getPixelRatio(){return this.pixelRatio;},setPixelRatio:function setPixelRatio(pixelRatio){var previousRatio=this.pixelRatio;this.pixelRatio=pixelRatio;this.setSize(this.getWidth()/previousRatio,this.getHeight()/previousRatio);},setWidth:function setWidth(width){this.width=this._canvas.width=width*this.pixelRatio;this._canvas.style.width=width+'px';var pixelRatio=this.pixelRatio,_context=this.getContext()._context;_context.scale(pixelRatio,pixelRatio);},setHeight:function setHeight(height){this.height=this._canvas.height=height*this.pixelRatio;this._canvas.style.height=height+'px';var pixelRatio=this.pixelRatio,_context=this.getContext()._context;_context.scale(pixelRatio,pixelRatio);},getWidth:function getWidth(){return this.width;},getHeight:function getHeight(){return this.height;},setSize:function setSize(width,height){this.setWidth(width);this.setHeight(height);},toDataURL:function toDataURL(mimeType,quality){try{return this._canvas.toDataURL(mimeType,quality);}catch(e){try{return this._canvas.toDataURL();}catch(err){Konva.Util.warn('Unable to get data URL. '+err.message);return'';}}}};Konva.SceneCanvas=function(config){var conf=config||{};var width=conf.width||0,height=conf.height||0;Konva.Canvas.call(this,conf);this.context=new Konva.SceneContext(this);this.setSize(width,height);};Konva.Util.extend(Konva.SceneCanvas,Konva.Canvas);Konva.HitCanvas=function(config){var conf=config||{};var width=conf.width||0,height=conf.height||0;Konva.Canvas.call(this,conf);this.context=new Konva.HitContext(this);this.setSize(width,height);this.hitCanvas=true;};Konva.Util.extend(Konva.HitCanvas,Konva.Canvas);})();(function(){'use strict';var COMMA=',',OPEN_PAREN='(',CLOSE_PAREN=')',OPEN_PAREN_BRACKET='([',CLOSE_BRACKET_PAREN='])',SEMICOLON=';',DOUBLE_PAREN='()',EQUALS='=',CONTEXT_METHODS=['arc','arcTo','beginPath','bezierCurveTo','clearRect','clip','closePath','createLinearGradient','createPattern','createRadialGradient','drawImage','fill','fillText','getImageData','createImageData','lineTo','moveTo','putImageData','quadraticCurveTo','rect','restore','rotate','save','scale','setLineDash','setTransform','stroke','strokeText','transform','translate'];var CONTEXT_PROPERTIES=['fillStyle','strokeStyle','shadowColor','shadowBlur','shadowOffsetX','shadowOffsetY','lineCap','lineJoin','lineWidth','miterLimit','font','textAlign','textBaseline','globalAlpha','globalCompositeOperation'];Konva.Context=function(canvas){this.init(canvas);};Konva.Context.prototype={init:function init(canvas){this.canvas=canvas;this._context=canvas._canvas.getContext('2d');if(Konva.enableTrace){this.traceArr=[];this._enableTrace();}},fillShape:function fillShape(shape){if(shape.getFillEnabled()){this._fill(shape);}},strokeShape:function strokeShape(shape){if(shape.getStrokeEnabled()){this._stroke(shape);}},fillStrokeShape:function fillStrokeShape(shape){var fillEnabled=shape.getFillEnabled();if(fillEnabled){this._fill(shape);}if(shape.getStrokeEnabled()){this._stroke(shape);}},getTrace:function getTrace(relaxed){var traceArr=this.traceArr,len=traceArr.length,str='',n,trace,method,args;for(n=0;n<len;n++){trace=traceArr[n];method=trace.method;if(method){args=trace.args;str+=method;if(relaxed){str+=DOUBLE_PAREN;}else{if(Konva.Util._isArray(args[0])){str+=OPEN_PAREN_BRACKET+args.join(COMMA)+CLOSE_BRACKET_PAREN;}else{str+=OPEN_PAREN+args.join(COMMA)+CLOSE_PAREN;}}}
else{str+=trace.property;if(!relaxed){str+=EQUALS+trace.val;}}str+=SEMICOLON;}return str;},clearTrace:function clearTrace(){this.traceArr=[];},_trace:function _trace(str){var traceArr=this.traceArr,len;traceArr.push(str);len=traceArr.length;if(len>=Konva.traceArrMax){traceArr.shift();}},reset:function reset(){var pixelRatio=this.getCanvas().getPixelRatio();this.setTransform(1*pixelRatio,0,0,1*pixelRatio,0,0);},getCanvas:function getCanvas(){return this.canvas;},clear:function clear(bounds){var canvas=this.getCanvas();if(bounds){this.clearRect(bounds.x||0,bounds.y||0,bounds.width||0,bounds.height||0);}else{this.clearRect(0,0,canvas.getWidth()/canvas.pixelRatio,canvas.getHeight()/canvas.pixelRatio);}},_applyLineCap:function _applyLineCap(shape){var lineCap=shape.getLineCap();if(lineCap){this.setAttr('lineCap',lineCap);}},_applyOpacity:function _applyOpacity(shape){var absOpacity=shape.getAbsoluteOpacity();if(absOpacity!==1){this.setAttr('globalAlpha',absOpacity);}},_applyLineJoin:function _applyLineJoin(shape){var lineJoin=shape.getLineJoin();if(lineJoin){this.setAttr('lineJoin',lineJoin);}},setAttr:function setAttr(attr,val){this._context[attr]=val;},arc:function arc(){var a=arguments;this._context.arc(a[0],a[1],a[2],a[3],a[4],a[5]);},beginPath:function beginPath(){this._context.beginPath();},bezierCurveTo:function bezierCurveTo(){var a=arguments;this._context.bezierCurveTo(a[0],a[1],a[2],a[3],a[4],a[5]);},clearRect:function clearRect(){var a=arguments;this._context.clearRect(a[0],a[1],a[2],a[3]);},clip:function clip(){this._context.clip();},closePath:function closePath(){this._context.closePath();},createImageData:function createImageData(){var a=arguments;if(a.length===2){return this._context.createImageData(a[0],a[1]);}else if(a.length===1){return this._context.createImageData(a[0]);}},createLinearGradient:function createLinearGradient(){var a=arguments;return this._context.createLinearGradient(a[0],a[1],a[2],a[3]);},createPattern:function createPattern(){var a=arguments;return this._context.createPattern(a[0],a[1]);},createRadialGradient:function createRadialGradient(){var a=arguments;return this._context.createRadialGradient(a[0],a[1],a[2],a[3],a[4],a[5]);},drawImage:function drawImage(){var a=arguments,_context=this._context;if(a.length===3){_context.drawImage(a[0],a[1],a[2]);}else if(a.length===5){_context.drawImage(a[0],a[1],a[2],a[3],a[4]);}else if(a.length===9){_context.drawImage(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8]);}},isPointInPath:function isPointInPath(x,y){return this._context.isPointInPath(x,y);},fill:function fill(){this._context.fill();},fillRect:function fillRect(x,y,width,height){this._context.fillRect(x,y,width,height);},strokeRect:function strokeRect(x,y,width,height){this._context.strokeRect(x,y,width,height);},fillText:function fillText(){var a=arguments;this._context.fillText(a[0],a[1],a[2]);},measureText:function measureText(text){return this._context.measureText(text);},getImageData:function getImageData(){var a=arguments;return this._context.getImageData(a[0],a[1],a[2],a[3]);},lineTo:function lineTo(){var a=arguments;this._context.lineTo(a[0],a[1]);},moveTo:function moveTo(){var a=arguments;this._context.moveTo(a[0],a[1]);},rect:function rect(){var a=arguments;this._context.rect(a[0],a[1],a[2],a[3]);},putImageData:function putImageData(){var a=arguments;this._context.putImageData(a[0],a[1],a[2]);},quadraticCurveTo:function quadraticCurveTo(){var a=arguments;this._context.quadraticCurveTo(a[0],a[1],a[2],a[3]);},restore:function restore(){this._context.restore();},rotate:function rotate(){var a=arguments;this._context.rotate(a[0]);},save:function save(){this._context.save();},scale:function scale(){var a=arguments;this._context.scale(a[0],a[1]);},setLineDash:function setLineDash(){var a=arguments,_context=this._context;if(this._context.setLineDash){_context.setLineDash(a[0]);}
else if('mozDash'in _context){_context.mozDash=a[0];}
else if('webkitLineDash'in _context){_context.webkitLineDash=a[0];}},getLineDash:function getLineDash(){return this._context.getLineDash();},setTransform:function setTransform(){var a=arguments;this._context.setTransform(a[0],a[1],a[2],a[3],a[4],a[5]);},stroke:function stroke(){this._context.stroke();},strokeText:function strokeText(){var a=arguments;this._context.strokeText(a[0],a[1],a[2]);},transform:function transform(){var a=arguments;this._context.transform(a[0],a[1],a[2],a[3],a[4],a[5]);},translate:function translate(){var a=arguments;this._context.translate(a[0],a[1]);},_enableTrace:function _enableTrace(){var that=this,len=CONTEXT_METHODS.length,_simplifyArray=Konva.Util._simplifyArray,origSetter=this.setAttr,n,args;var func=function func(methodName){var origMethod=that[methodName],ret;that[methodName]=function(){args=_simplifyArray(Array.prototype.slice.call(arguments,0));ret=origMethod.apply(that,arguments);if(methodName==='clearRect'){args[2]=args[2]/that.canvas.getPixelRatio();args[3]=args[3]/that.canvas.getPixelRatio();}that._trace({method:methodName,args:args});return ret;};};for(n=0;n<len;n++){func(CONTEXT_METHODS[n]);}
that.setAttr=function(){origSetter.apply(that,arguments);that._trace({property:arguments[0],val:arguments[1]});};}};CONTEXT_PROPERTIES.forEach(function(prop){Object.defineProperty(Konva.Context.prototype,prop,{get:function get(){return this._context[prop];},set:function set(val){this._context[prop]=val;}});});Konva.SceneContext=function(canvas){Konva.Context.call(this,canvas);};Konva.SceneContext.prototype={_fillColor:function _fillColor(shape){var fill=shape.fill();this.setAttr('fillStyle',fill);shape._fillFunc(this);},_fillPattern:function _fillPattern(shape){var fillPatternX=shape.getFillPatternX(),fillPatternY=shape.getFillPatternY(),fillPatternScale=shape.getFillPatternScale(),fillPatternRotation=Konva.getAngle(shape.getFillPatternRotation()),fillPatternOffset=shape.getFillPatternOffset();if(fillPatternX||fillPatternY){this.translate(fillPatternX||0,fillPatternY||0);}if(fillPatternRotation){this.rotate(fillPatternRotation);}if(fillPatternScale){this.scale(fillPatternScale.x,fillPatternScale.y);}if(fillPatternOffset){this.translate(-1*fillPatternOffset.x,-1*fillPatternOffset.y);}this.setAttr('fillStyle',this.createPattern(shape.getFillPatternImage(),shape.getFillPatternRepeat()||'repeat'));this.fill();},_fillLinearGradient:function _fillLinearGradient(shape){var start=shape.getFillLinearGradientStartPoint(),end=shape.getFillLinearGradientEndPoint(),colorStops=shape.getFillLinearGradientColorStops(),grd=this.createLinearGradient(start.x,start.y,end.x,end.y);if(colorStops){for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1]);}this.setAttr('fillStyle',grd);shape._fillFunc(this);}},_fillRadialGradient:function _fillRadialGradient(shape){var start=shape.getFillRadialGradientStartPoint(),end=shape.getFillRadialGradientEndPoint(),startRadius=shape.getFillRadialGradientStartRadius(),endRadius=shape.getFillRadialGradientEndRadius(),colorStops=shape.getFillRadialGradientColorStops(),grd=this.createRadialGradient(start.x,start.y,startRadius,end.x,end.y,endRadius);for(var n=0;n<colorStops.length;n+=2){grd.addColorStop(colorStops[n],colorStops[n+1]);}this.setAttr('fillStyle',grd);this.fill();},_fill:function _fill(shape){var hasColor=shape.fill(),hasPattern=shape.getFillPatternImage(),hasLinearGradient=shape.getFillLinearGradientColorStops(),hasRadialGradient=shape.getFillRadialGradientColorStops(),fillPriority=shape.getFillPriority();if(hasColor&&fillPriority==='color'){this._fillColor(shape);}else if(hasPattern&&fillPriority==='pattern'){this._fillPattern(shape);}else if(hasLinearGradient&&fillPriority==='linear-gradient'){this._fillLinearGradient(shape);}else if(hasRadialGradient&&fillPriority==='radial-gradient'){this._fillRadialGradient(shape);}
else if(hasColor){this._fillColor(shape);}else if(hasPattern){this._fillPattern(shape);}else if(hasLinearGradient){this._fillLinearGradient(shape);}else if(hasRadialGradient){this._fillRadialGradient(shape);}},_stroke:function _stroke(shape){var dash=shape.dash(),strokeScaleEnabled=shape.getStrokeScaleEnabled()||shape instanceof Konva.Text;if(shape.hasStroke()){if(!strokeScaleEnabled){this.save();this.setTransform(1,0,0,1,0,0);}this._applyLineCap(shape);if(dash&&shape.dashEnabled()){this.setLineDash(dash);}this.setAttr('lineWidth',shape.strokeWidth());this.setAttr('strokeStyle',shape.stroke());if(!shape.getShadowForStrokeEnabled()){this.setAttr('shadowColor','rgba(0,0,0,0)');}shape._strokeFunc(this);if(!strokeScaleEnabled){this.restore();}}},_applyShadow:function _applyShadow(shape){var util=Konva.Util,color=util.get(shape.getShadowRGBA(),'black'),blur=util.get(shape.getShadowBlur(),5),offset=util.get(shape.getShadowOffset(),{x:0,y:0}),m=shape.getAbsoluteTransform().m,scaleX=m[0],scaleY=m[3];this.setAttr('shadowColor',color);this.setAttr('shadowBlur',blur);this.setAttr('shadowOffsetX',offset.x*scaleX);this.setAttr('shadowOffsetY',offset.y*scaleY);}};Konva.Util.extend(Konva.SceneContext,Konva.Context);Konva.HitContext=function(canvas){Konva.Context.call(this,canvas);};Konva.HitContext.prototype={_fill:function _fill(shape){this.save();this.setAttr('fillStyle',shape.colorKey);shape._fillFuncHit(this);this.restore();},_stroke:function _stroke(shape){if(shape.hasStroke()&&shape.strokeHitEnabled()){var strokeScaleEnabled=shape.getStrokeScaleEnabled()||shape instanceof Konva.Text;if(!strokeScaleEnabled){this.save();this.setTransform(1,0,0,1,0,0);}this._applyLineCap(shape);this.setAttr('lineWidth',shape.strokeWidth());this.setAttr('strokeStyle',shape.colorKey);shape._strokeFuncHit(this);if(!strokeScaleEnabled){this.restore();}}}};Konva.Util.extend(Konva.HitContext,Konva.Context);})();(function(){'use strict';var GET='get',SET='set';Konva.Factory={addGetterSetter:function addGetterSetter(constructor,attr,def,validator,after){this.addGetter(constructor,attr,def);this.addSetter(constructor,attr,validator,after);this.addOverloadedGetterSetter(constructor,attr);},addGetter:function addGetter(constructor,attr,def){var method=GET+Konva.Util._capitalize(attr);constructor.prototype[method]=function(){var val=this.attrs[attr];return val===undefined?def:val;};},addSetter:function addSetter(constructor,attr,validator,after){var method=SET+Konva.Util._capitalize(attr);constructor.prototype[method]=function(val){if(validator){val=validator.call(this,val);}this._setAttr(attr,val);if(after){after.call(this);}return this;};},addComponentsGetterSetter:function addComponentsGetterSetter(constructor,attr,components,validator,after){var len=components.length,capitalize=Konva.Util._capitalize,getter=GET+capitalize(attr),setter=SET+capitalize(attr),n,component;constructor.prototype[getter]=function(){var ret={};for(n=0;n<len;n++){component=components[n];ret[component]=this.getAttr(attr+capitalize(component));}return ret;};constructor.prototype[setter]=function(val){var oldVal=this.attrs[attr],key;if(validator){val=validator.call(this,val);}for(key in val){if(!val.hasOwnProperty(key)){continue;}this._setAttr(attr+capitalize(key),val[key]);}this._fireChangeEvent(attr,oldVal,val);if(after){after.call(this);}return this;};this.addOverloadedGetterSetter(constructor,attr);},addOverloadedGetterSetter:function addOverloadedGetterSetter(constructor,attr){var capitalizedAttr=Konva.Util._capitalize(attr),setter=SET+capitalizedAttr,getter=GET+capitalizedAttr;constructor.prototype[attr]=function(){if(arguments.length){this[setter](arguments[0]);return this;}
return this[getter]();};},addDeprecatedGetterSetter:function addDeprecatedGetterSetter(constructor,attr,def,validator){var method=GET+Konva.Util._capitalize(attr);var message=attr+' property is deprecated and will be removed soon. Look at Konva change log for more information.';constructor.prototype[method]=function(){Konva.Util.error(message);var val=this.attrs[attr];return val===undefined?def:val;};this.addSetter(constructor,attr,validator,function(){Konva.Util.error(message);});this.addOverloadedGetterSetter(constructor,attr);},backCompat:function backCompat(constructor,methods){Konva.Util.each(methods,function(oldMethodName,newMethodName){var method=constructor.prototype[newMethodName];constructor.prototype[oldMethodName]=function(){method.apply(this,arguments);Konva.Util.error(oldMethodName+' method is deprecated and will be removed soon. Use '+newMethodName+' instead');};});},afterSetFilter:function afterSetFilter(){this._filterUpToDate=false;}};Konva.Validators={RGBComponent:function RGBComponent(val){if(val>255){return 255;}else if(val<0){return 0;}return Math.round(val);},alphaComponent:function alphaComponent(val){if(val>1){return 1;}
else if(val<0.0001){return 0.0001;}return val;}};})();(function(Konva){'use strict';var ABSOLUTE_OPACITY='absoluteOpacity',ABSOLUTE_TRANSFORM='absoluteTransform',CHANGE='Change',CHILDREN='children',DOT='.',EMPTY_STRING='',GET='get',ID='id',KONVA='konva',LISTENING='listening',MOUSEENTER='mouseenter',MOUSELEAVE='mouseleave',NAME='name',SET='set',SHAPE='Shape',SPACE=' ',STAGE='stage',TRANSFORM='transform',UPPER_STAGE='Stage',VISIBLE='visible',CLONE_BLACK_LIST=['id'],TRANSFORM_CHANGE_STR=['xChange.konva','yChange.konva','scaleXChange.konva','scaleYChange.konva','skewXChange.konva','skewYChange.konva','rotationChange.konva','offsetXChange.konva','offsetYChange.konva','transformsEnabledChange.konva'].join(SPACE);Konva.Node=function(config){this._init(config);};Konva.Util.addMethods(Konva.Node,{_init:function _init(config){var that=this;this._id=Konva.idCounter++;this.eventListeners={};this.attrs={};this._cache={};this._filterUpToDate=false;this.setAttrs(config);this.on(TRANSFORM_CHANGE_STR,function(){this._clearCache(TRANSFORM);that._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);});this.on('visibleChange.konva',function(){that._clearSelfAndDescendantCache(VISIBLE);});this.on('listeningChange.konva',function(){that._clearSelfAndDescendantCache(LISTENING);});this.on('opacityChange.konva',function(){that._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);});},_clearCache:function _clearCache(attr){if(attr){delete this._cache[attr];}else{this._cache={};}},_getCache:function _getCache(attr,privateGetter){var cache=this._cache[attr];if(cache===undefined){this._cache[attr]=privateGetter.call(this);}return this._cache[attr];},_clearSelfAndDescendantCache:function _clearSelfAndDescendantCache(attr){this._clearCache(attr);if(this.children){this.getChildren().each(function(node){node._clearSelfAndDescendantCache(attr);});}},clearCache:function clearCache(){delete this._cache.canvas;this._filterUpToDate=false;return this;},cache:function cache(config){var conf=config||{},rect=this.getClientRect(true),width=conf.width||rect.width,height=conf.height||rect.height,x=conf.x||rect.x,y=conf.y||rect.y,offset=conf.offset||0,drawBorder=conf.drawBorder||false;if(!width||!height){throw new Error('Width or height of caching configuration equals 0.');}width+=offset*2;height+=offset*2;x-=offset;y-=offset;var cachedSceneCanvas=new Konva.SceneCanvas({width:width,height:height}),cachedFilterCanvas=new Konva.SceneCanvas({width:width,height:height}),cachedHitCanvas=new Konva.HitCanvas({pixelRatio:1,width:width,height:height}),sceneContext=cachedSceneCanvas.getContext(),hitContext=cachedHitCanvas.getContext();cachedHitCanvas.isCache=true;this.clearCache();sceneContext.save();hitContext.save();sceneContext.translate(-x,-y);hitContext.translate(-x,-y);this.drawScene(cachedSceneCanvas,this,true);this.drawHit(cachedHitCanvas,this,true);sceneContext.restore();hitContext.restore();if(drawBorder){sceneContext.save();sceneContext.beginPath();sceneContext.rect(0,0,width,height);sceneContext.closePath();sceneContext.setAttr('strokeStyle','red');sceneContext.setAttr('lineWidth',5);sceneContext.stroke();sceneContext.restore();}this._cache.canvas={scene:cachedSceneCanvas,filter:cachedFilterCanvas,hit:cachedHitCanvas,x:x,y:y};return this;},getClientRect:function getClientRect(){throw new Error('abstract "getClientRect" method call');},_transformedRect:function _transformedRect(rect){var points=[{x:rect.x,y:rect.y},{x:rect.x+rect.width,y:rect.y},{x:rect.x+rect.width,y:rect.y+rect.height},{x:rect.x,y:rect.y+rect.height}];var minX,minY,maxX,maxY;var trans=this.getTransform();points.forEach(function(point){var transformed=trans.point(point);if(minX===undefined){minX=maxX=transformed.x;minY=maxY=transformed.y;}minX=Math.min(minX,transformed.x);minY=Math.min(minY,transformed.y);maxX=Math.max(maxX,transformed.x);maxY=Math.max(maxY,transformed.y);});return{x:Math.round(minX),y:Math.round(minY),width:Math.round(maxX-minX),height:Math.round(maxY-minY)};},_drawCachedSceneCanvas:function _drawCachedSceneCanvas(context){context.save();context._applyOpacity(this);context.translate(this._cache.canvas.x,this._cache.canvas.y);var cacheCanvas=this._getCachedSceneCanvas();var ratio=cacheCanvas.pixelRatio;context.drawImage(cacheCanvas._canvas,0,0,cacheCanvas.width/ratio,cacheCanvas.height/ratio);context.restore();},_drawCachedHitCanvas:function _drawCachedHitCanvas(context){var cachedCanvas=this._cache.canvas,hitCanvas=cachedCanvas.hit;context.save();context.translate(this._cache.canvas.x,this._cache.canvas.y);context.drawImage(hitCanvas._canvas,0,0);context.restore();},_getCachedSceneCanvas:function _getCachedSceneCanvas(){var filters=this.filters(),cachedCanvas=this._cache.canvas,sceneCanvas=cachedCanvas.scene,filterCanvas=cachedCanvas.filter,filterContext=filterCanvas.getContext(),len,imageData,n,filter;if(filters){if(!this._filterUpToDate){var ratio=sceneCanvas.pixelRatio;try{len=filters.length;filterContext.clear();filterContext.drawImage(sceneCanvas._canvas,0,0,sceneCanvas.getWidth()/ratio,sceneCanvas.getHeight()/ratio);imageData=filterContext.getImageData(0,0,filterCanvas.getWidth(),filterCanvas.getHeight());for(n=0;n<len;n++){filter=filters[n];filter.call(this,imageData);filterContext.putImageData(imageData,0,0);}}catch(e){Konva.Util.warn('Unable to apply filter. '+e.message);}this._filterUpToDate=true;}return filterCanvas;}return sceneCanvas;},on:function on(evtStr,handler){var events=evtStr.split(SPACE),len=events.length,n,event,parts,baseEvent,name;for(n=0;n<len;n++){event=events[n];parts=event.split(DOT);baseEvent=parts[0];name=parts[1]||EMPTY_STRING;if(!this.eventListeners[baseEvent]){this.eventListeners[baseEvent]=[];}this.eventListeners[baseEvent].push({name:name,handler:handler});}return this;},off:function off(evtStr){var events=(evtStr||'').split(SPACE),len=events.length,n,t,event,parts,baseEvent,name;if(!evtStr){for(t in this.eventListeners){this._off(t);}}for(n=0;n<len;n++){event=events[n];parts=event.split(DOT);baseEvent=parts[0];name=parts[1];if(baseEvent){if(this.eventListeners[baseEvent]){this._off(baseEvent,name);}}else{for(t in this.eventListeners){this._off(t,name);}}}return this;},dispatchEvent:function dispatchEvent(evt){var e={target:this,type:evt.type,evt:evt};this.fire(evt.type,e);},addEventListener:function addEventListener(type,handler){this.on(type,function(evt){handler.call(this,evt.evt);});},removeEventListener:function removeEventListener(type){this.off(type);},remove:function remove(){var parent=this.getParent();if(parent&&parent.children){parent.children.splice(this.index,1);parent._setChildrenIndices();delete this.parent;}
this._clearSelfAndDescendantCache(STAGE);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);this._clearSelfAndDescendantCache(VISIBLE);this._clearSelfAndDescendantCache(LISTENING);this._clearSelfAndDescendantCache(ABSOLUTE_OPACITY);return this;},destroy:function destroy(){Konva._removeId(this.getId());Konva._removeName(this.getName(),this._id);this.remove();},getAttr:function getAttr(attr){var method=GET+Konva.Util._capitalize(attr);if(Konva.Util._isFunction(this[method])){return this[method]();}
return this.attrs[attr];},getAncestors:function getAncestors(){var parent=this.getParent(),ancestors=new Konva.Collection();while(parent){ancestors.push(parent);parent=parent.getParent();}return ancestors;},getAttrs:function getAttrs(){return this.attrs||{};},setAttrs:function setAttrs(config){var key,method;if(!config){return this;}for(key in config){if(key===CHILDREN){continue;}method=SET+Konva.Util._capitalize(key);if(Konva.Util._isFunction(this[method])){this[method](config[key]);}
else{this._setAttr(key,config[key]);}}return this;},isListening:function isListening(){return this._getCache(LISTENING,this._isListening);},_isListening:function _isListening(){var listening=this.getListening(),parent=this.getParent();if(listening==='inherit'){if(parent){return parent.isListening();}else{return true;}}else{return listening;}},isVisible:function isVisible(){return this._getCache(VISIBLE,this._isVisible);},_isVisible:function _isVisible(){var visible=this.getVisible(),parent=this.getParent();if(visible==='inherit'){if(parent){return parent.isVisible();}else{return true;}}else{return visible;}},shouldDrawHit:function shouldDrawHit(canvas){var layer=this.getLayer();return canvas&&canvas.isCache||layer&&layer.hitGraphEnabled()&&this.isListening()&&this.isVisible();},show:function show(){this.setVisible(true);return this;},hide:function hide(){this.setVisible(false);return this;},getZIndex:function getZIndex(){return this.index||0;},getAbsoluteZIndex:function getAbsoluteZIndex(){var depth=this.getDepth(),that=this,index=0,nodes,len,n,child;function addChildren(children){nodes=[];len=children.length;for(n=0;n<len;n++){child=children[n];index++;if(child.nodeType!==SHAPE){nodes=nodes.concat(child.getChildren().toArray());}if(child._id===that._id){n=len;}}if(nodes.length>0&&nodes[0].getDepth()<=depth){addChildren(nodes);}}if(that.nodeType!==UPPER_STAGE){addChildren(that.getStage().getChildren());}return index;},getDepth:function getDepth(){var depth=0,parent=this.parent;while(parent){depth++;parent=parent.parent;}return depth;},setPosition:function setPosition(pos){this.setX(pos.x);this.setY(pos.y);return this;},getPosition:function getPosition(){return{x:this.getX(),y:this.getY()};},getAbsolutePosition:function getAbsolutePosition(){var absoluteMatrix=this.getAbsoluteTransform().getMatrix(),absoluteTransform=new Konva.Transform(),offset=this.offset();absoluteTransform.m=absoluteMatrix.slice();absoluteTransform.translate(offset.x,offset.y);return absoluteTransform.getTranslation();},setAbsolutePosition:function setAbsolutePosition(pos){var origTrans=this._clearTransform(),it;this.attrs.x=origTrans.x;this.attrs.y=origTrans.y;delete origTrans.x;delete origTrans.y;it=this.getAbsoluteTransform();it.invert();it.translate(pos.x,pos.y);pos={x:this.attrs.x+it.getTranslation().x,y:this.attrs.y+it.getTranslation().y};this.setPosition({x:pos.x,y:pos.y});this._setTransform(origTrans);return this;},_setTransform:function _setTransform(trans){var key;for(key in trans){this.attrs[key]=trans[key];}this._clearCache(TRANSFORM);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);},_clearTransform:function _clearTransform(){var trans={x:this.getX(),y:this.getY(),rotation:this.getRotation(),scaleX:this.getScaleX(),scaleY:this.getScaleY(),offsetX:this.getOffsetX(),offsetY:this.getOffsetY(),skewX:this.getSkewX(),skewY:this.getSkewY()};this.attrs.x=0;this.attrs.y=0;this.attrs.rotation=0;this.attrs.scaleX=1;this.attrs.scaleY=1;this.attrs.offsetX=0;this.attrs.offsetY=0;this.attrs.skewX=0;this.attrs.skewY=0;this._clearCache(TRANSFORM);this._clearSelfAndDescendantCache(ABSOLUTE_TRANSFORM);return trans;},move:function move(change){var changeX=change.x,changeY=change.y,x=this.getX(),y=this.getY();if(changeX!==undefined){x+=changeX;}if(changeY!==undefined){y+=changeY;}this.setPosition({x:x,y:y});return this;},_eachAncestorReverse:function _eachAncestorReverse(func,top){var family=[],parent=this.getParent(),len,n;if(top&&top._id===this._id){func(this);return true;}family.unshift(this);while(parent&&(!top||parent._id!==top._id)){family.unshift(parent);parent=parent.parent;}len=family.length;for(n=0;n<len;n++){func(family[n]);}},rotate:function rotate(theta){this.setRotation(this.getRotation()+theta);return this;},moveToTop:function moveToTop(){if(!this.parent){Konva.Util.warn('Node has no parent. moveToTop function is ignored.');return false;}var index=this.index;this.parent.children.splice(index,1);this.parent.children.push(this);this.parent._setChildrenIndices();return true;},moveUp:function moveUp(){if(!this.parent){Konva.Util.warn('Node has no parent. moveUp function is ignored.');return false;}var index=this.index,len=this.parent.getChildren().length;if(index<len-1){this.parent.children.splice(index,1);this.parent.children.splice(index+1,0,this);this.parent._setChildrenIndices();return true;}return false;},moveDown:function moveDown(){if(!this.parent){Konva.Util.warn('Node has no parent. moveDown function is ignored.');return false;}var index=this.index;if(index>0){this.parent.children.splice(index,1);this.parent.children.splice(index-1,0,this);this.parent._setChildrenIndices();return true;}return false;},moveToBottom:function moveToBottom(){if(!this.parent){Konva.Util.warn('Node has no parent. moveToBottom function is ignored.');return false;}var index=this.index;if(index>0){this.parent.children.splice(index,1);this.parent.children.unshift(this);this.parent._setChildrenIndices();return true;}return false;},setZIndex:function setZIndex(zIndex){if(!this.parent){Konva.Util.warn('Node has no parent. zIndex parameter is ignored.');return false;}var index=this.index;this.parent.children.splice(index,1);this.parent.children.splice(zIndex,0,this);this.parent._setChildrenIndices();return this;},getAbsoluteOpacity:function getAbsoluteOpacity(){return this._getCache(ABSOLUTE_OPACITY,this._getAbsoluteOpacity);},_getAbsoluteOpacity:function _getAbsoluteOpacity(){var absOpacity=this.getOpacity();if(this.getParent()){absOpacity*=this.getParent().getAbsoluteOpacity();}return absOpacity;},moveTo:function moveTo(newContainer){if(this.getParent()!==newContainer){this.remove();newContainer.add(this);}return this;},toObject:function toObject(){var obj={},attrs=this.getAttrs(),key,val,getter,defaultValue;obj.attrs={};for(key in attrs){val=attrs[key];if(Konva.Util._isFunction(val)||Konva.Util._isElement(val)||Konva.Util._isObject(val)||Konva.Util._hasMethods(val)){continue;}getter=this[key];delete attrs[key];defaultValue=getter?getter.call(this):null;attrs[key]=val;if(defaultValue!==val){obj.attrs[key]=val;}}obj.className=this.getClassName();return obj;},toJSON:function toJSON(){return JSON.stringify(this.toObject());},getParent:function getParent(){return this.parent;},getLayer:function getLayer(){var parent=this.getParent();return parent?parent.getLayer():null;},getStage:function getStage(){return this._getCache(STAGE,this._getStage);},_getStage:function _getStage(){var parent=this.getParent();if(parent){return parent.getStage();}else{return undefined;}},fire:function fire(eventType,evt,bubble){if(bubble){this._fireAndBubble(eventType,evt||{});}
else{this._fire(eventType,evt||{});}return this;},getAbsoluteTransform:function getAbsoluteTransform(top){if(top){return this._getAbsoluteTransform(top);}
else{return this._getCache(ABSOLUTE_TRANSFORM,this._getAbsoluteTransform);}},_getAbsoluteTransform:function _getAbsoluteTransform(top){var at=new Konva.Transform(),transformsEnabled,trans;this._eachAncestorReverse(function(node){transformsEnabled=node.transformsEnabled();trans=node.getTransform();if(transformsEnabled==='all'){at.multiply(trans);}else if(transformsEnabled==='position'){at.translate(node.x(),node.y());}},top);return at;},getTransform:function getTransform(){return this._getCache(TRANSFORM,this._getTransform);},_getTransform:function _getTransform(){var m=new Konva.Transform(),x=this.getX(),y=this.getY(),rotation=Konva.getAngle(this.getRotation()),scaleX=this.getScaleX(),scaleY=this.getScaleY(),skewX=this.getSkewX(),skewY=this.getSkewY(),offsetX=this.getOffsetX(),offsetY=this.getOffsetY();if(x!==0||y!==0){m.translate(x,y);}if(rotation!==0){m.rotate(rotation);}if(skewX!==0||skewY!==0){m.skew(skewX,skewY);}if(scaleX!==1||scaleY!==1){m.scale(scaleX,scaleY);}if(offsetX!==0||offsetY!==0){m.translate(-1*offsetX,-1*offsetY);}return m;},clone:function clone(obj){var attrs=Konva.Util.cloneObject(this.attrs),key,allListeners,len,n,listener;for(var i in CLONE_BLACK_LIST){var blockAttr=CLONE_BLACK_LIST[i];delete attrs[blockAttr];}
for(key in obj){attrs[key]=obj[key];}var node=new this.constructor(attrs);for(key in this.eventListeners){allListeners=this.eventListeners[key];len=allListeners.length;for(n=0;n<len;n++){listener=allListeners[n];if(listener.name.indexOf(KONVA)<0){if(!node.eventListeners[key]){node.eventListeners[key]=[];}node.eventListeners[key].push(listener);}}}return node;},toDataURL:function toDataURL(config){config=config||{};var mimeType=config.mimeType||null,quality=config.quality||null,stage=this.getStage(),x=config.x||0,y=config.y||0,pixelRatio=config.pixelRatio||1,canvas=new Konva.SceneCanvas({width:config.width||this.getWidth()||(stage?stage.getWidth():0),height:config.height||this.getHeight()||(stage?stage.getHeight():0),pixelRatio:pixelRatio}),context=canvas.getContext();context.save();if(x||y){context.translate(-1*x,-1*y);}this.drawScene(canvas);context.restore();return canvas.toDataURL(mimeType,quality);},toImage:function toImage(config){if(!config||!config.callback){throw'callback required for toImage method config argument';}Konva.Util._getImage(this.toDataURL(config),function(img){config.callback(img);});},setSize:function setSize(size){this.setWidth(size.width);this.setHeight(size.height);return this;},getSize:function getSize(){return{width:this.getWidth(),height:this.getHeight()};},getWidth:function getWidth(){return this.attrs.width||0;},getHeight:function getHeight(){return this.attrs.height||0;},getClassName:function getClassName(){return this.className||this.nodeType;},getType:function getType(){return this.nodeType;},getDragDistance:function getDragDistance(){if(this.attrs.dragDistance!==undefined){return this.attrs.dragDistance;}else if(this.parent){return this.parent.getDragDistance();}else{return Konva.dragDistance;}},_get:function _get(selector){return this.className===selector||this.nodeType===selector?[this]:[];},_off:function _off(type,name){var evtListeners=this.eventListeners[type],i,evtName;for(i=0;i<evtListeners.length;i++){evtName=evtListeners[i].name;if((evtName!=='konva'||name==='konva')&&(!name||evtName===name)){evtListeners.splice(i,1);if(evtListeners.length===0){delete this.eventListeners[type];break;}i--;}}},_fireChangeEvent:function _fireChangeEvent(attr,oldVal,newVal){this._fire(attr+CHANGE,{oldVal:oldVal,newVal:newVal});},setId:function setId(id){var oldId=this.getId();Konva._removeId(oldId);Konva._addId(this,id);this._setAttr(ID,id);return this;},setName:function setName(name){var oldNames=(this.getName()||'').split(/\s/g);var newNames=(name||'').split(/\s/g);var subname,i;for(i=0;i<oldNames.length;i++){subname=oldNames[i];if(newNames.indexOf(subname)===-1&&subname){Konva._removeName(subname,this._id);}}
for(i=0;i<newNames.length;i++){subname=newNames[i];if(oldNames.indexOf(subname)===-1&&subname){Konva._addName(this,subname);}}this._setAttr(NAME,name);return this;},addName:function addName(name){if(!this.hasName(name)){var oldName=this.name();var newName=oldName?oldName+' '+name:name;this.setName(newName);}return this;},hasName:function hasName(name){var names=(this.name()||'').split(/\s/g);return names.indexOf(name)!==-1;},removeName:function removeName(name){var names=(this.name()||'').split(/\s/g);var index=names.indexOf(name);if(index!==-1){names.splice(index,1);this.setName(names.join(' '));}},setAttr:function setAttr(attr,val){var method=SET+Konva.Util._capitalize(attr),func=this[method];if(Konva.Util._isFunction(func)){func.call(this,val);}
else{this._setAttr(attr,val);}return this;},_setAttr:function _setAttr(key,val){var oldVal;if(val!==undefined){oldVal=this.attrs[key];this.attrs[key]=val;this._fireChangeEvent(key,oldVal,val);}},_setComponentAttr:function _setComponentAttr(key,component,val){var oldVal;if(val!==undefined){oldVal=this.attrs[key];if(!oldVal){this.attrs[key]=this.getAttr(key);}this.attrs[key][component]=val;this._fireChangeEvent(key,oldVal,val);}},_fireAndBubble:function _fireAndBubble(eventType,evt,compareShape){var okayToRun=true;if(evt&&this.nodeType===SHAPE){evt.target=this;}if(eventType===MOUSEENTER&&compareShape&&(this._id===compareShape._id||this.isAncestorOf&&this.isAncestorOf(compareShape))){okayToRun=false;}else if(eventType===MOUSELEAVE&&compareShape&&(this._id===compareShape._id||this.isAncestorOf&&this.isAncestorOf(compareShape))){okayToRun=false;}if(okayToRun){this._fire(eventType,evt);var stopBubble=(eventType===MOUSEENTER||eventType===MOUSELEAVE)&&(compareShape&&compareShape.isAncestorOf&&compareShape.isAncestorOf(this)||!!(compareShape&&compareShape.isAncestorOf));if(evt&&!evt.cancelBubble&&this.parent&&this.parent.isListening()&&!stopBubble){if(compareShape&&compareShape.parent){this._fireAndBubble.call(this.parent,eventType,evt,compareShape.parent);}else{this._fireAndBubble.call(this.parent,eventType,evt);}}}},_fire:function _fire(eventType,evt){var events=this.eventListeners[eventType],i;evt.type=eventType;if(events){for(i=0;i<events.length;i++){events[i].handler.call(this,evt);}}},draw:function draw(){this.drawScene();this.drawHit();return this;}});Konva.Node.create=function(data,container){if(Konva.Util._isString(data)){data=JSON.parse(data);}return this._createNode(data,container);};Konva.Node._createNode=function(obj,container){var className=Konva.Node.prototype.getClassName.call(obj),children=obj.children,no,len,n;if(container){obj.attrs.container=container;}no=new Konva[className](obj.attrs);if(children){len=children.length;for(n=0;n<len;n++){no.add(this._createNode(children[n]));}}return no;};Konva.Factory.addOverloadedGetterSetter(Konva.Node,'position');Konva.Factory.addGetterSetter(Konva.Node,'x',0);Konva.Factory.addGetterSetter(Konva.Node,'y',0);Konva.Factory.addGetterSetter(Konva.Node,'opacity',1);Konva.Factory.addGetter(Konva.Node,'name');Konva.Factory.addOverloadedGetterSetter(Konva.Node,'name');Konva.Factory.addGetter(Konva.Node,'id');Konva.Factory.addOverloadedGetterSetter(Konva.Node,'id');Konva.Factory.addGetterSetter(Konva.Node,'rotation',0);Konva.Factory.addComponentsGetterSetter(Konva.Node,'scale',['x','y']);Konva.Factory.addGetterSetter(Konva.Node,'scaleX',1);Konva.Factory.addGetterSetter(Konva.Node,'scaleY',1);Konva.Factory.addComponentsGetterSetter(Konva.Node,'skew',['x','y']);Konva.Factory.addGetterSetter(Konva.Node,'skewX',0);Konva.Factory.addGetterSetter(Konva.Node,'skewY',0);Konva.Factory.addComponentsGetterSetter(Konva.Node,'offset',['x','y']);Konva.Factory.addGetterSetter(Konva.Node,'offsetX',0);Konva.Factory.addGetterSetter(Konva.Node,'offsetY',0);Konva.Factory.addSetter(Konva.Node,'dragDistance');Konva.Factory.addOverloadedGetterSetter(Konva.Node,'dragDistance');Konva.Factory.addSetter(Konva.Node,'width',0);Konva.Factory.addOverloadedGetterSetter(Konva.Node,'width');Konva.Factory.addSetter(Konva.Node,'height',0);Konva.Factory.addOverloadedGetterSetter(Konva.Node,'height');Konva.Factory.addGetterSetter(Konva.Node,'listening','inherit');Konva.Factory.addGetterSetter(Konva.Node,'filters',undefined,function(val){this._filterUpToDate=false;return val;});Konva.Factory.addGetterSetter(Konva.Node,'visible','inherit');Konva.Factory.addGetterSetter(Konva.Node,'transformsEnabled','all');Konva.Factory.addOverloadedGetterSetter(Konva.Node,'size');Konva.Factory.backCompat(Konva.Node,{rotateDeg:'rotate',setRotationDeg:'setRotation',getRotationDeg:'getRotation'});Konva.Collection.mapMethods(Konva.Node);})(Konva);(function(){'use strict';Konva.Filters.Grayscale=function(imageData){var data=imageData.data,len=data.length,i,brightness;for(i=0;i<len;i+=4){brightness=0.34*data[i]+0.5*data[i+1]+0.16*data[i+2];data[i]=brightness;data[i+1]=brightness;data[i+2]=brightness;}};})();(function(){'use strict';Konva.Filters.Brighten=function(imageData){var brightness=this.brightness()*255,data=imageData.data,len=data.length,i;for(i=0;i<len;i+=4){data[i]+=brightness;data[i+1]+=brightness;data[i+2]+=brightness;}};Konva.Factory.addGetterSetter(Konva.Node,'brightness',0,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Filters.Invert=function(imageData){var data=imageData.data,len=data.length,i;for(i=0;i<len;i+=4){data[i]=255-data[i];data[i+1]=255-data[i+1];data[i+2]=255-data[i+2];}};})();(function(){'use strict';function BlurStack(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null;}var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function filterGaussBlurRGBA(imageData,radius){var pixels=imageData.data,width=imageData.width,height=imageData.height;var x,y,i,p,yp,yi,yw,r_sum,g_sum,b_sum,a_sum,r_out_sum,g_out_sum,b_out_sum,a_out_sum,r_in_sum,g_in_sum,b_in_sum,a_in_sum,pr,pg,pb,pa,rbs;var div=radius+radius+1,widthMinus1=width-1,heightMinus1=height-1,radiusPlus1=radius+1,sumFactor=radiusPlus1*(radiusPlus1+1)/2,stackStart=new BlurStack(),stackEnd=null,stack=stackStart,stackIn=null,stackOut=null,mul_sum=mul_table[radius],shg_sum=shg_table[radius];for(i=1;i<div;i++){stack=stack.next=new BlurStack();if(i===radiusPlus1){stackEnd=stack;}}stack.next=stackStart;yw=yi=0;for(y=0;y<height;y++){r_in_sum=g_in_sum=b_in_sum=a_in_sum=r_sum=g_sum=b_sum=a_sum=0;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);a_out_sum=radiusPlus1*(pa=pixels[yi+3]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;a_sum+=sumFactor*pa;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack.a=pa;stack=stack.next;}for(i=1;i<radiusPlus1;i++){p=yi+((widthMinus1<i?widthMinus1:i)<<2);r_sum+=(stack.r=pr=pixels[p])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[p+1])*rbs;b_sum+=(stack.b=pb=pixels[p+2])*rbs;a_sum+=(stack.a=pa=pixels[p+3])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;a_in_sum+=pa;stack=stack.next;}stackIn=stackStart;stackOut=stackEnd;for(x=0;x<width;x++){pixels[yi+3]=pa=a_sum*mul_sum>>shg_sum;if(pa!==0){pa=255/pa;pixels[yi]=(r_sum*mul_sum>>shg_sum)*pa;pixels[yi+1]=(g_sum*mul_sum>>shg_sum)*pa;pixels[yi+2]=(b_sum*mul_sum>>shg_sum)*pa;}else{pixels[yi]=pixels[yi+1]=pixels[yi+2]=0;}r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;a_sum-=a_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;a_out_sum-=stackIn.a;p=yw+((p=x+radius+1)<widthMinus1?p:widthMinus1)<<2;r_in_sum+=stackIn.r=pixels[p];g_in_sum+=stackIn.g=pixels[p+1];b_in_sum+=stackIn.b=pixels[p+2];a_in_sum+=stackIn.a=pixels[p+3];r_sum+=r_in_sum;g_sum+=g_in_sum;b_sum+=b_in_sum;a_sum+=a_in_sum;stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;a_out_sum+=pa=stackOut.a;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;a_in_sum-=pa;stackOut=stackOut.next;yi+=4;}yw+=width;}for(x=0;x<width;x++){g_in_sum=b_in_sum=a_in_sum=r_in_sum=g_sum=b_sum=a_sum=r_sum=0;yi=x<<2;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);a_out_sum=radiusPlus1*(pa=pixels[yi+3]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;a_sum+=sumFactor*pa;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack.a=pa;stack=stack.next;}yp=width;for(i=1;i<=radius;i++){yi=yp+x<<2;r_sum+=(stack.r=pr=pixels[yi])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[yi+1])*rbs;b_sum+=(stack.b=pb=pixels[yi+2])*rbs;a_sum+=(stack.a=pa=pixels[yi+3])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;a_in_sum+=pa;stack=stack.next;if(i<heightMinus1){yp+=width;}}yi=x;stackIn=stackStart;stackOut=stackEnd;for(y=0;y<height;y++){p=yi<<2;pixels[p+3]=pa=a_sum*mul_sum>>shg_sum;if(pa>0){pa=255/pa;pixels[p]=(r_sum*mul_sum>>shg_sum)*pa;pixels[p+1]=(g_sum*mul_sum>>shg_sum)*pa;pixels[p+2]=(b_sum*mul_sum>>shg_sum)*pa;}else{pixels[p]=pixels[p+1]=pixels[p+2]=0;}r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;a_sum-=a_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;a_out_sum-=stackIn.a;p=x+((p=y+radiusPlus1)<heightMinus1?p:heightMinus1)*width<<2;r_sum+=r_in_sum+=stackIn.r=pixels[p];g_sum+=g_in_sum+=stackIn.g=pixels[p+1];b_sum+=b_in_sum+=stackIn.b=pixels[p+2];a_sum+=a_in_sum+=stackIn.a=pixels[p+3];stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;a_out_sum+=pa=stackOut.a;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;a_in_sum-=pa;stackOut=stackOut.next;yi+=width;}}}Konva.Filters.Blur=function Blur(imageData){var radius=Math.round(this.blurRadius());if(radius>0){filterGaussBlurRGBA(imageData,radius);}};Konva.Factory.addGetterSetter(Konva.Node,'blurRadius',0,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';function pixelAt(idata,x,y){var idx=(y*idata.width+x)*4;var d=[];d.push(idata.data[idx++],idata.data[idx++],idata.data[idx++],idata.data[idx++]);return d;}function rgbDistance(p1,p2){return Math.sqrt(Math.pow(p1[0]-p2[0],2)+Math.pow(p1[1]-p2[1],2)+Math.pow(p1[2]-p2[2],2));}function rgbMean(pTab){var m=[0,0,0];for(var i=0;i<pTab.length;i++){m[0]+=pTab[i][0];m[1]+=pTab[i][1];m[2]+=pTab[i][2];}m[0]/=pTab.length;m[1]/=pTab.length;m[2]/=pTab.length;return m;}function backgroundMask(idata,threshold){var rgbv_no=pixelAt(idata,0,0);var rgbv_ne=pixelAt(idata,idata.width-1,0);var rgbv_so=pixelAt(idata,0,idata.height-1);var rgbv_se=pixelAt(idata,idata.width-1,idata.height-1);var thres=threshold||10;if(rgbDistance(rgbv_no,rgbv_ne)<thres&&rgbDistance(rgbv_ne,rgbv_se)<thres&&rgbDistance(rgbv_se,rgbv_so)<thres&&rgbDistance(rgbv_so,rgbv_no)<thres){var mean=rgbMean([rgbv_ne,rgbv_no,rgbv_se,rgbv_so]);var mask=[];for(var i=0;i<idata.width*idata.height;i++){var d=rgbDistance(mean,[idata.data[i*4],idata.data[i*4+1],idata.data[i*4+2]]);mask[i]=d<thres?0:255;}return mask;}}function applyMask(idata,mask){for(var i=0;i<idata.width*idata.height;i++){idata.data[4*i+3]=mask[i];}}function erodeMask(mask,sw,sh){var weights=[1,1,1,1,0,1,1,1,1];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt;}}}maskResult[so]=a===255*8?255:0;}}return maskResult;}function dilateMask(mask,sw,sh){var weights=[1,1,1,1,1,1,1,1,1];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt;}}}maskResult[so]=a>=255*4?255:0;}}return maskResult;}function smoothEdgeMask(mask,sw,sh){var weights=[1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9,1/9];var side=Math.round(Math.sqrt(weights.length));var halfSide=Math.floor(side/2);var maskResult=[];for(var y=0;y<sh;y++){for(var x=0;x<sw;x++){var so=y*sw+x;var a=0;for(var cy=0;cy<side;cy++){for(var cx=0;cx<side;cx++){var scy=y+cy-halfSide;var scx=x+cx-halfSide;if(scy>=0&&scy<sh&&scx>=0&&scx<sw){var srcOff=scy*sw+scx;var wt=weights[cy*side+cx];a+=mask[srcOff]*wt;}}}maskResult[so]=a;}}return maskResult;}Konva.Filters.Mask=function(imageData){var threshold=this.threshold(),mask=backgroundMask(imageData,threshold);if(mask){mask=erodeMask(mask,imageData.width,imageData.height);mask=dilateMask(mask,imageData.width,imageData.height);mask=smoothEdgeMask(mask,imageData.width,imageData.height);applyMask(imageData,mask);}return imageData;};Konva.Factory.addGetterSetter(Konva.Node,'threshold',0,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Filters.RGB=function(imageData){var data=imageData.data,nPixels=data.length,red=this.red(),green=this.green(),blue=this.blue(),i,brightness;for(i=0;i<nPixels;i+=4){brightness=(0.34*data[i]+0.5*data[i+1]+0.16*data[i+2])/255;data[i]=brightness*red;data[i+1]=brightness*green;data[i+2]=brightness*blue;data[i+3]=data[i+3];}};Konva.Factory.addGetterSetter(Konva.Node,'red',0,function(val){this._filterUpToDate=false;if(val>255){return 255;}else if(val<0){return 0;}else{return Math.round(val);}});Konva.Factory.addGetterSetter(Konva.Node,'green',0,function(val){this._filterUpToDate=false;if(val>255){return 255;}else if(val<0){return 0;}else{return Math.round(val);}});Konva.Factory.addGetterSetter(Konva.Node,'blue',0,Konva.Validators.RGBComponent,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Filters.RGBA=function(imageData){var data=imageData.data,nPixels=data.length,red=this.red(),green=this.green(),blue=this.blue(),alpha=this.alpha(),i,ia;for(i=0;i<nPixels;i+=4){ia=1-alpha;data[i]=red*alpha+data[i]*ia;data[i+1]=green*alpha+data[i+1]*ia;data[i+2]=blue*alpha+data[i+2]*ia;}};Konva.Factory.addGetterSetter(Konva.Node,'red',0,function(val){this._filterUpToDate=false;if(val>255){return 255;}else if(val<0){return 0;}else{return Math.round(val);}});Konva.Factory.addGetterSetter(Konva.Node,'green',0,function(val){this._filterUpToDate=false;if(val>255){return 255;}else if(val<0){return 0;}else{return Math.round(val);}});Konva.Factory.addGetterSetter(Konva.Node,'blue',0,Konva.Validators.RGBComponent,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'alpha',1,function(val){this._filterUpToDate=false;if(val>1){return 1;}else if(val<0){return 0;}else{return val;}});})();(function(){'use strict';Konva.Filters.HSV=function(imageData){var data=imageData.data,nPixels=data.length,v=Math.pow(2,this.value()),s=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,i;var vsu=v*s*Math.cos(h*Math.PI/180),vsw=v*s*Math.sin(h*Math.PI/180);var rr=0.299*v+0.701*vsu+0.167*vsw,rg=0.587*v-0.587*vsu+0.330*vsw,rb=0.114*v-0.114*vsu-0.497*vsw;var gr=0.299*v-0.299*vsu-0.328*vsw,gg=0.587*v+0.413*vsu+0.035*vsw,gb=0.114*v-0.114*vsu+0.293*vsw;var br=0.299*v-0.300*vsu+1.250*vsw,bg=0.587*v-0.586*vsu-1.050*vsw,bb=0.114*v+0.886*vsu-0.200*vsw;var r,g,b,a;for(i=0;i<nPixels;i+=4){r=data[i+0];g=data[i+1];b=data[i+2];a=data[i+3];data[i+0]=rr*r+rg*g+rb*b;data[i+1]=gr*r+gg*g+gb*b;data[i+2]=br*r+bg*g+bb*b;data[i+3]=a;}};Konva.Factory.addGetterSetter(Konva.Node,'hue',0,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'saturation',0,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'value',0,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Factory.addGetterSetter(Konva.Node,'hue',0,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'saturation',0,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'luminance',0,null,Konva.Factory.afterSetFilter);Konva.Filters.HSL=function(imageData){var data=imageData.data,nPixels=data.length,v=1,s=Math.pow(2,this.saturation()),h=Math.abs(this.hue()+360)%360,l=this.luminance()*127,i;var vsu=v*s*Math.cos(h*Math.PI/180),vsw=v*s*Math.sin(h*Math.PI/180);var rr=0.299*v+0.701*vsu+0.167*vsw,rg=0.587*v-0.587*vsu+0.330*vsw,rb=0.114*v-0.114*vsu-0.497*vsw;var gr=0.299*v-0.299*vsu-0.328*vsw,gg=0.587*v+0.413*vsu+0.035*vsw,gb=0.114*v-0.114*vsu+0.293*vsw;var br=0.299*v-0.300*vsu+1.250*vsw,bg=0.587*v-0.586*vsu-1.050*vsw,bb=0.114*v+0.886*vsu-0.200*vsw;var r,g,b,a;for(i=0;i<nPixels;i+=4){r=data[i+0];g=data[i+1];b=data[i+2];a=data[i+3];data[i+0]=rr*r+rg*g+rb*b+l;data[i+1]=gr*r+gg*g+gb*b+l;data[i+2]=br*r+bg*g+bb*b+l;data[i+3]=a;}};})();(function(){'use strict';Konva.Filters.Emboss=function(imageData){var strength=this.embossStrength()*10,greyLevel=this.embossWhiteLevel()*255,direction=this.embossDirection(),blend=this.embossBlend(),dirY=0,dirX=0,data=imageData.data,w=imageData.width,h=imageData.height,w4=w*4,y=h;switch(direction){case'top-left':dirY=-1;dirX=-1;break;case'top':dirY=-1;dirX=0;break;case'top-right':dirY=-1;dirX=1;break;case'right':dirY=0;dirX=1;break;case'bottom-right':dirY=1;dirX=1;break;case'bottom':dirY=1;dirX=0;break;case'bottom-left':dirY=1;dirX=-1;break;case'left':dirY=0;dirX=-1;break;}do{var offsetY=(y-1)*w4;var otherY=dirY;if(y+otherY<1){otherY=0;}if(y+otherY>h){otherY=0;}var offsetYOther=(y-1+otherY)*w*4;var x=w;do{var offset=offsetY+(x-1)*4;var otherX=dirX;if(x+otherX<1){otherX=0;}if(x+otherX>w){otherX=0;}var offsetOther=offsetYOther+(x-1+otherX)*4;var dR=data[offset]-data[offsetOther];var dG=data[offset+1]-data[offsetOther+1];var dB=data[offset+2]-data[offsetOther+2];var dif=dR;var absDif=dif>0?dif:-dif;var absG=dG>0?dG:-dG;var absB=dB>0?dB:-dB;if(absG>absDif){dif=dG;}if(absB>absDif){dif=dB;}dif*=strength;if(blend){var r=data[offset]+dif;var g=data[offset+1]+dif;var b=data[offset+2]+dif;data[offset]=r>255?255:r<0?0:r;data[offset+1]=g>255?255:g<0?0:g;data[offset+2]=b>255?255:b<0?0:b;}else{var grey=greyLevel-dif;if(grey<0){grey=0;}else if(grey>255){grey=255;}data[offset]=data[offset+1]=data[offset+2]=grey;}}while(--x);}while(--y);};Konva.Factory.addGetterSetter(Konva.Node,'embossStrength',0.5,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'embossWhiteLevel',0.5,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'embossDirection','top-left',null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'embossBlend',false,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';function remap(fromValue,fromMin,fromMax,toMin,toMax){var fromRange=fromMax-fromMin,toRange=toMax-toMin,toValue;if(fromRange===0){return toMin+toRange/2;}if(toRange===0){return toMin;}
toValue=(fromValue-fromMin)/fromRange;toValue=toRange*toValue+toMin;return toValue;}Konva.Filters.Enhance=function(imageData){var data=imageData.data,nSubPixels=data.length,rMin=data[0],rMax=rMin,r,gMin=data[1],gMax=gMin,g,bMin=data[2],bMax=bMin,b,i;var enhanceAmount=this.enhance();if(enhanceAmount===0){return;}
for(i=0;i<nSubPixels;i+=4){r=data[i+0];if(r<rMin){rMin=r;}else if(r>rMax){rMax=r;}g=data[i+1];if(g<gMin){gMin=g;}else if(g>gMax){gMax=g;}b=data[i+2];if(b<bMin){bMin=b;}else if(b>bMax){bMax=b;}}
if(rMax===rMin){rMax=255;rMin=0;}if(gMax===gMin){gMax=255;gMin=0;}if(bMax===bMin){bMax=255;bMin=0;}var rMid,rGoalMax,rGoalMin,gMid,gGoalMax,gGoalMin,bMid,bGoalMax,bGoalMin;if(enhanceAmount>0){rGoalMax=rMax+enhanceAmount*(255-rMax);rGoalMin=rMin-enhanceAmount*(rMin-0);gGoalMax=gMax+enhanceAmount*(255-gMax);gGoalMin=gMin-enhanceAmount*(gMin-0);bGoalMax=bMax+enhanceAmount*(255-bMax);bGoalMin=bMin-enhanceAmount*(bMin-0);}else{rMid=(rMax+rMin)*0.5;rGoalMax=rMax+enhanceAmount*(rMax-rMid);rGoalMin=rMin+enhanceAmount*(rMin-rMid);gMid=(gMax+gMin)*0.5;gGoalMax=gMax+enhanceAmount*(gMax-gMid);gGoalMin=gMin+enhanceAmount*(gMin-gMid);bMid=(bMax+bMin)*0.5;bGoalMax=bMax+enhanceAmount*(bMax-bMid);bGoalMin=bMin+enhanceAmount*(bMin-bMid);}
for(i=0;i<nSubPixels;i+=4){data[i+0]=remap(data[i+0],rMin,rMax,rGoalMin,rGoalMax);data[i+1]=remap(data[i+1],gMin,gMax,gGoalMin,gGoalMax);data[i+2]=remap(data[i+2],bMin,bMax,bGoalMin,bGoalMax);}};Konva.Factory.addGetterSetter(Konva.Node,'enhance',0,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Filters.Posterize=function(imageData){var levels=Math.round(this.levels()*254)+1,data=imageData.data,len=data.length,scale=255/levels,i;for(i=0;i<len;i+=1){data[i]=Math.floor(data[i]/scale)*scale;}};Konva.Factory.addGetterSetter(Konva.Node,'levels',0.5,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Filters.Noise=function(imageData){var amount=this.noise()*255,data=imageData.data,nPixels=data.length,half=amount/2,i;for(i=0;i<nPixels;i+=4){data[i+0]+=half-2*half*Math.random();data[i+1]+=half-2*half*Math.random();data[i+2]+=half-2*half*Math.random();}};Konva.Factory.addGetterSetter(Konva.Node,'noise',0.2,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Filters.Pixelate=function(imageData){var pixelSize=Math.ceil(this.pixelSize()),width=imageData.width,height=imageData.height,x,y,i,red,green,blue,alpha,nBinsX=Math.ceil(width/pixelSize),nBinsY=Math.ceil(height/pixelSize),xBinStart,xBinEnd,yBinStart,yBinEnd,xBin,yBin,pixelsInBin;imageData=imageData.data;for(xBin=0;xBin<nBinsX;xBin+=1){for(yBin=0;yBin<nBinsY;yBin+=1){red=0;green=0;blue=0;alpha=0;xBinStart=xBin*pixelSize;xBinEnd=xBinStart+pixelSize;yBinStart=yBin*pixelSize;yBinEnd=yBinStart+pixelSize;pixelsInBin=0;for(x=xBinStart;x<xBinEnd;x+=1){if(x>=width){continue;}for(y=yBinStart;y<yBinEnd;y+=1){if(y>=height){continue;}i=(width*y+x)*4;red+=imageData[i+0];green+=imageData[i+1];blue+=imageData[i+2];alpha+=imageData[i+3];pixelsInBin+=1;}}
red=red/pixelsInBin;green=green/pixelsInBin;blue=blue/pixelsInBin;for(x=xBinStart;x<xBinEnd;x+=1){if(x>=width){continue;}for(y=yBinStart;y<yBinEnd;y+=1){if(y>=height){continue;}i=(width*y+x)*4;imageData[i+0]=red;imageData[i+1]=green;imageData[i+2]=blue;imageData[i+3]=alpha;}}}}};Konva.Factory.addGetterSetter(Konva.Node,'pixelSize',8,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Filters.Threshold=function(imageData){var level=this.threshold()*255,data=imageData.data,len=data.length,i;for(i=0;i<len;i+=1){data[i]=data[i]<level?0:255;}};Konva.Factory.addGetterSetter(Konva.Node,'threshold',0.5,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';Konva.Filters.Sepia=function(imageData){var data=imageData.data,w=imageData.width,y=imageData.height,w4=w*4,offsetY,x,offset,or,og,ob,r,g,b;do{offsetY=(y-1)*w4;x=w;do{offset=offsetY+(x-1)*4;or=data[offset];og=data[offset+1];ob=data[offset+2];r=or*0.393+og*0.769+ob*0.189;g=or*0.349+og*0.686+ob*0.168;b=or*0.272+og*0.534+ob*0.131;data[offset]=r>255?255:r;data[offset+1]=g>255?255:g;data[offset+2]=b>255?255:b;data[offset+3]=data[offset+3];}while(--x);}while(--y);};})();(function(){'use strict';Konva.Filters.Solarize=function(imageData){var data=imageData.data,w=imageData.width,h=imageData.height,w4=w*4,y=h;do{var offsetY=(y-1)*w4;var x=w;do{var offset=offsetY+(x-1)*4;var r=data[offset];var g=data[offset+1];var b=data[offset+2];if(r>127){r=255-r;}if(g>127){g=255-g;}if(b>127){b=255-b;}data[offset]=r;data[offset+1]=g;data[offset+2]=b;}while(--x);}while(--y);};})();(function(){'use strict';var ToPolar=function ToPolar(src,dst,opt){var srcPixels=src.data,dstPixels=dst.data,xSize=src.width,ySize=src.height,xMid=opt.polarCenterX||xSize/2,yMid=opt.polarCenterY||ySize/2,i,x,y,r=0,g=0,b=0,a=0;var rad,rMax=Math.sqrt(xMid*xMid+yMid*yMid);x=xSize-xMid;y=ySize-yMid;rad=Math.sqrt(x*x+y*y);rMax=rad>rMax?rad:rMax;var rSize=ySize,tSize=xSize,radius,theta;var conversion=360/tSize*Math.PI/180,sin,cos;for(theta=0;theta<tSize;theta+=1){sin=Math.sin(theta*conversion);cos=Math.cos(theta*conversion);for(radius=0;radius<rSize;radius+=1){x=Math.floor(xMid+rMax*radius/rSize*cos);y=Math.floor(yMid+rMax*radius/rSize*sin);i=(y*xSize+x)*4;r=srcPixels[i+0];g=srcPixels[i+1];b=srcPixels[i+2];a=srcPixels[i+3];i=(theta+radius*xSize)*4;dstPixels[i+0]=r;dstPixels[i+1]=g;dstPixels[i+2]=b;dstPixels[i+3]=a;}}};var FromPolar=function FromPolar(src,dst,opt){var srcPixels=src.data,dstPixels=dst.data,xSize=src.width,ySize=src.height,xMid=opt.polarCenterX||xSize/2,yMid=opt.polarCenterY||ySize/2,i,x,y,dx,dy,r=0,g=0,b=0,a=0;var rad,rMax=Math.sqrt(xMid*xMid+yMid*yMid);x=xSize-xMid;y=ySize-yMid;rad=Math.sqrt(x*x+y*y);rMax=rad>rMax?rad:rMax;var rSize=ySize,tSize=xSize,radius,theta,phaseShift=opt.polarRotation||0;var x1,y1;for(x=0;x<xSize;x+=1){for(y=0;y<ySize;y+=1){dx=x-xMid;dy=y-yMid;radius=Math.sqrt(dx*dx+dy*dy)*rSize/rMax;theta=(Math.atan2(dy,dx)*180/Math.PI+360+phaseShift)%360;theta=theta*tSize/360;x1=Math.floor(theta);y1=Math.floor(radius);i=(y1*xSize+x1)*4;r=srcPixels[i+0];g=srcPixels[i+1];b=srcPixels[i+2];a=srcPixels[i+3];i=(y*xSize+x)*4;dstPixels[i+0]=r;dstPixels[i+1]=g;dstPixels[i+2]=b;dstPixels[i+3]=a;}}};var tempCanvas=Konva.Util.createCanvasElement();Konva.Filters.Kaleidoscope=function(imageData){var xSize=imageData.width,ySize=imageData.height;var x,y,xoff,i,r,g,b,a,srcPos,dstPos;var power=Math.round(this.kaleidoscopePower());var angle=Math.round(this.kaleidoscopeAngle());var offset=Math.floor(xSize*(angle%360)/360);if(power<1){return;}
tempCanvas.width=xSize;tempCanvas.height=ySize;var scratchData=tempCanvas.getContext('2d').getImageData(0,0,xSize,ySize);ToPolar(imageData,scratchData,{polarCenterX:xSize/2,polarCenterY:ySize/2});var minSectionSize=xSize/Math.pow(2,power);while(minSectionSize<=8){minSectionSize=minSectionSize*2;power-=1;}minSectionSize=Math.ceil(minSectionSize);var sectionSize=minSectionSize;var xStart=0,xEnd=sectionSize,xDelta=1;if(offset+minSectionSize>xSize){xStart=sectionSize;xEnd=0;xDelta=-1;}for(y=0;y<ySize;y+=1){for(x=xStart;x!==xEnd;x+=xDelta){xoff=Math.round(x+offset)%xSize;srcPos=(xSize*y+xoff)*4;r=scratchData.data[srcPos+0];g=scratchData.data[srcPos+1];b=scratchData.data[srcPos+2];a=scratchData.data[srcPos+3];dstPos=(xSize*y+x)*4;scratchData.data[dstPos+0]=r;scratchData.data[dstPos+1]=g;scratchData.data[dstPos+2]=b;scratchData.data[dstPos+3]=a;}}
for(y=0;y<ySize;y+=1){sectionSize=Math.floor(minSectionSize);for(i=0;i<power;i+=1){for(x=0;x<sectionSize+1;x+=1){srcPos=(xSize*y+x)*4;r=scratchData.data[srcPos+0];g=scratchData.data[srcPos+1];b=scratchData.data[srcPos+2];a=scratchData.data[srcPos+3];dstPos=(xSize*y+sectionSize*2-x-1)*4;scratchData.data[dstPos+0]=r;scratchData.data[dstPos+1]=g;scratchData.data[dstPos+2]=b;scratchData.data[dstPos+3]=a;}sectionSize*=2;}}
FromPolar(scratchData,imageData,{polarRotation:0});};Konva.Factory.addGetterSetter(Konva.Node,'kaleidoscopePower',2,null,Konva.Factory.afterSetFilter);Konva.Factory.addGetterSetter(Konva.Node,'kaleidoscopeAngle',0,null,Konva.Factory.afterSetFilter);})();(function(){'use strict';function isValidSelector(selector){if(typeof selector!=='string'){return false;}var firstChar=selector[0];return firstChar==='#'||firstChar==='.'||firstChar===firstChar.toUpperCase();}Konva.Container=function(config){this.__init(config);};Konva.Util.addMethods(Konva.Container,{__init:function __init(config){this.children=new Konva.Collection();Konva.Node.call(this,config);},getChildren:function getChildren(filterFunc){if(!filterFunc){return this.children;}var results=new Konva.Collection();this.children.each(function(child){if(filterFunc(child)){results.push(child);}});return results;},hasChildren:function hasChildren(){return this.getChildren().length>0;},removeChildren:function removeChildren(){var children=Konva.Collection.toCollection(this.children);var child;for(var i=0;i<children.length;i++){child=children[i];delete child.parent;child.index=0;if(child.hasChildren()){child.removeChildren();}child.remove();}children=null;this.children=new Konva.Collection();return this;},destroyChildren:function destroyChildren(){var children=Konva.Collection.toCollection(this.children);var child;for(var i=0;i<children.length;i++){child=children[i];delete child.parent;child.index=0;child.destroy();}children=null;this.children=new Konva.Collection();return this;},add:function add(child){if(arguments.length>1){for(var i=0;i<arguments.length;i++){this.add(arguments[i]);}return this;}if(child.getParent()){child.moveTo(this);return this;}var children=this.children;this._validateAdd(child);child.index=children.length;child.parent=this;children.push(child);this._fire('add',{child:child});if(Konva.DD&&child.isDragging()){Konva.DD.anim.setLayers(child.getLayer());}
return this;},destroy:function destroy(){if(this.hasChildren()){this.destroyChildren();}
Konva.Node.prototype.destroy.call(this);},find:function find(selector){var retArr=[],selectorArr=selector.replace(/ /g,'').split(','),len=selectorArr.length,n,i,sel,arr,node,children,clen;for(n=0;n<len;n++){sel=selectorArr[n];if(!isValidSelector(sel)){Konva.Util.warn('Selector "'+sel+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".');Konva.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".');Konva.Util.warn('Konva is awesome, right?');}
if(sel.charAt(0)==='#'){node=this._getNodeById(sel.slice(1));if(node){retArr.push(node);}}
else if(sel.charAt(0)==='.'){arr=this._getNodesByName(sel.slice(1));retArr=retArr.concat(arr);}
else{children=this.getChildren();clen=children.length;for(i=0;i<clen;i++){retArr=retArr.concat(children[i]._get(sel));}}}return Konva.Collection.toCollection(retArr);},findOne:function findOne(selector){return this.find(selector)[0];},_getNodeById:function _getNodeById(key){var node=Konva.ids[key];if(node!==undefined&&this.isAncestorOf(node)){return node;}return null;},_getNodesByName:function _getNodesByName(key){var arr=Konva.names[key]||[];return this._getDescendants(arr);},_get:function _get(selector){var retArr=Konva.Node.prototype._get.call(this,selector);var children=this.getChildren();var len=children.length;for(var n=0;n<len;n++){retArr=retArr.concat(children[n]._get(selector));}return retArr;},toObject:function toObject(){var obj=Konva.Node.prototype.toObject.call(this);obj.children=[];var children=this.getChildren();var len=children.length;for(var n=0;n<len;n++){var child=children[n];obj.children.push(child.toObject());}return obj;},_getDescendants:function _getDescendants(arr){var retArr=[];var len=arr.length;for(var n=0;n<len;n++){var node=arr[n];if(this.isAncestorOf(node)){retArr.push(node);}}return retArr;},isAncestorOf:function isAncestorOf(node){var parent=node.getParent();while(parent){if(parent._id===this._id){return true;}parent=parent.getParent();}return false;},clone:function clone(obj){var node=Konva.Node.prototype.clone.call(this,obj);this.getChildren().each(function(no){node.add(no.clone());});return node;},getAllIntersections:function getAllIntersections(pos){var arr=[];this.find('Shape').each(function(shape){if(shape.isVisible()&&shape.intersects(pos)){arr.push(shape);}});return arr;},_setChildrenIndices:function _setChildrenIndices(){this.children.each(function(child,n){child.index=n;});},drawScene:function drawScene(can,top,caching){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas(),context=canvas&&canvas.getContext(),cachedCanvas=this._cache.canvas,cachedSceneCanvas=cachedCanvas&&cachedCanvas.scene;if(this.isVisible()){if(!caching&&cachedSceneCanvas){context.save();layer._applyTransform(this,context,top);this._drawCachedSceneCanvas(context);context.restore();}else{this._drawChildren(canvas,'drawScene',top,false,caching);}}return this;},drawHit:function drawHit(can,top,caching){var layer=this.getLayer(),canvas=can||layer&&layer.hitCanvas,context=canvas&&canvas.getContext(),cachedCanvas=this._cache.canvas,cachedHitCanvas=cachedCanvas&&cachedCanvas.hit;if(this.shouldDrawHit(canvas)){if(layer){layer.clearHitCache();}if(!caching&&cachedHitCanvas){context.save();layer._applyTransform(this,context,top);this._drawCachedHitCanvas(context);context.restore();}else{this._drawChildren(canvas,'drawHit',top);}}return this;},_drawChildren:function _drawChildren(canvas,drawMethod,top,caching,skipBuffer){var layer=this.getLayer(),context=canvas&&canvas.getContext(),clipWidth=this.getClipWidth(),clipHeight=this.getClipHeight(),hasClip=clipWidth&&clipHeight,clipX,clipY;if(hasClip&&layer){clipX=this.getClipX();clipY=this.getClipY();context.save();layer._applyTransform(this,context);context.beginPath();context.rect(clipX,clipY,clipWidth,clipHeight);context.clip();context.reset();}this.children.each(function(child){child[drawMethod](canvas,top,caching,skipBuffer);});if(hasClip){context.restore();}},shouldDrawHit:function shouldDrawHit(canvas){var layer=this.getLayer();var dd=Konva.DD;var layerUnderDrag=dd&&Konva.isDragging()&&Konva.DD.anim.getLayers().indexOf(layer)!==-1;return canvas&&canvas.isCache||layer&&layer.hitGraphEnabled()&&this.isVisible()&&!layerUnderDrag;},getClientRect:function getClientRect(skipTransform){var minX,minY,maxX,maxY;var selfRect={x:0,y:0,width:0,height:0};this.children.each(function(child){var rect=child.getClientRect();if(minX===undefined){minX=rect.x;minY=rect.y;maxX=rect.x+rect.width;maxY=rect.y+rect.height;}else{minX=Math.min(minX,rect.x);minY=Math.min(minY,rect.y);maxX=Math.max(maxX,rect.x+rect.width);maxY=Math.max(maxY,rect.y+rect.height);}});if(this.children.length!==0){selfRect={x:minX,y:minY,width:maxX-minX,height:maxY-minY};}if(!skipTransform){return this._transformedRect(selfRect);}return selfRect;}});Konva.Util.extend(Konva.Container,Konva.Node);Konva.Container.prototype.get=Konva.Container.prototype.find;Konva.Factory.addComponentsGetterSetter(Konva.Container,'clip',['x','y','width','height']);Konva.Factory.addGetterSetter(Konva.Container,'clipX');Konva.Factory.addGetterSetter(Konva.Container,'clipY');Konva.Factory.addGetterSetter(Konva.Container,'clipWidth');Konva.Factory.addGetterSetter(Konva.Container,'clipHeight');Konva.Collection.mapMethods(Konva.Container);})();(function(Konva){'use strict';var HAS_SHADOW='hasShadow';var SHADOW_RGBA='shadowRGBA';function _fillFunc(context){context.fill();}function _strokeFunc(context){context.stroke();}function _fillFuncHit(context){context.fill();}function _strokeFuncHit(context){context.stroke();}function _clearHasShadowCache(){this._clearCache(HAS_SHADOW);}function _clearGetShadowRGBACache(){this._clearCache(SHADOW_RGBA);}Konva.Shape=function(config){this.__init(config);};Konva.Util.addMethods(Konva.Shape,{__init:function __init(config){this.nodeType='Shape';this._fillFunc=_fillFunc;this._strokeFunc=_strokeFunc;this._fillFuncHit=_fillFuncHit;this._strokeFuncHit=_strokeFuncHit;var shapes=Konva.shapes;var key;while(true){key=Konva.Util.getRandomColor();if(key&&!(key in shapes)){break;}}this.colorKey=key;shapes[key]=this;Konva.Node.call(this,config);this.on('shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva',_clearHasShadowCache);this.on('shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva',_clearGetShadowRGBACache);},hasChildren:function hasChildren(){return false;},getChildren:function getChildren(){return[];},getContext:function getContext(){return this.getLayer().getContext();},getCanvas:function getCanvas(){return this.getLayer().getCanvas();},hasShadow:function hasShadow(){return this._getCache(HAS_SHADOW,this._hasShadow);},_hasShadow:function _hasShadow(){return this.getShadowEnabled()&&this.getShadowOpacity()!==0&&!!(this.getShadowColor()||this.getShadowBlur()||this.getShadowOffsetX()||this.getShadowOffsetY());},getShadowRGBA:function getShadowRGBA(){return this._getCache(SHADOW_RGBA,this._getShadowRGBA);},_getShadowRGBA:function _getShadowRGBA(){if(this.hasShadow()){var rgba=Konva.Util.colorToRGBA(this.shadowColor());return'rgba('+rgba.r+','+rgba.g+','+rgba.b+','+rgba.a*(this.getShadowOpacity()||1)+')';}},hasFill:function hasFill(){return!!(this.getFill()||this.getFillPatternImage()||this.getFillLinearGradientColorStops()||this.getFillRadialGradientColorStops());},hasStroke:function hasStroke(){return!!this.stroke();},intersects:function intersects(point){var stage=this.getStage(),bufferHitCanvas=stage.bufferHitCanvas,p;bufferHitCanvas.getContext().clear();this.drawScene(bufferHitCanvas);p=bufferHitCanvas.context.getImageData(Math.round(point.x),Math.round(point.y),1,1).data;return p[3]>0;},destroy:function destroy(){Konva.Node.prototype.destroy.call(this);delete Konva.shapes[this.colorKey];},_useBufferCanvas:function _useBufferCanvas(caching){return!caching&&this.perfectDrawEnabled()&&this.getAbsoluteOpacity()!==1&&this.hasFill()&&this.hasStroke()&&this.getStage()||this.perfectDrawEnabled()&&this.hasShadow()&&this.getAbsoluteOpacity()!==1&&this.hasFill()&&this.hasStroke()&&this.getStage();},getSelfRect:function getSelfRect(){var size=this.getSize();return{x:this._centroid?Math.round(-size.width/2):0,y:this._centroid?Math.round(-size.height/2):0,width:size.width,height:size.height};},getClientRect:function getClientRect(skipTransform){var fillRect=this.getSelfRect();var strokeWidth=this.hasStroke()&&this.strokeWidth()||0;var fillAndStrokeWidth=fillRect.width+strokeWidth;var fillAndStrokeHeight=fillRect.height+strokeWidth;var shadowOffsetX=this.shadowOffsetX();var shadowOffsetY=this.shadowOffsetY();var preWidth=fillAndStrokeWidth+Math.abs(shadowOffsetX);var preHeight=fillAndStrokeHeight+Math.abs(shadowOffsetY);var blurRadius=this.hasShadow()&&this.shadowBlur()||0;var width=preWidth+blurRadius*2;var height=preHeight+blurRadius*2;var roundingOffset=0;if(Math.round(strokeWidth/2)!==strokeWidth/2){roundingOffset=1;}var rect={width:width+roundingOffset,height:height+roundingOffset,x:-Math.round(strokeWidth/2+blurRadius)+Math.min(shadowOffsetX,0)+fillRect.x,y:-Math.round(strokeWidth/2+blurRadius)+Math.min(shadowOffsetY,0)+fillRect.y};if(!skipTransform){return this._transformedRect(rect);}return rect;},drawScene:function drawScene(can,top,caching,skipBuffer){var layer=this.getLayer(),canvas=can||layer.getCanvas(),context=canvas.getContext(),cachedCanvas=this._cache.canvas,drawFunc=this.sceneFunc(),hasShadow=this.hasShadow(),hasStroke=this.hasStroke(),stage,bufferCanvas,bufferContext;if(!this.isVisible()){return this;}if(cachedCanvas){context.save();layer._applyTransform(this,context,top);this._drawCachedSceneCanvas(context);context.restore();return this;}if(!drawFunc){return this;}context.save();if(this._useBufferCanvas(caching)&&!skipBuffer){stage=this.getStage();bufferCanvas=stage.bufferCanvas;bufferContext=bufferCanvas.getContext();bufferContext.clear();bufferContext.save();bufferContext._applyLineJoin(this);if(!caching){if(layer){layer._applyTransform(this,bufferContext,top);}else{var m=this.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);}}drawFunc.call(this,bufferContext);bufferContext.restore();if(hasShadow&&!canvas.hitCanvas){context.save();context._applyShadow(this);context._applyOpacity(this);context.drawImage(bufferCanvas._canvas,0,0);context.restore();}else{context._applyOpacity(this);context.drawImage(bufferCanvas._canvas,0,0);}}
else{context._applyLineJoin(this);if(!caching){if(layer){layer._applyTransform(this,context,top);}else{var o=this.getAbsoluteTransform(top).getMatrix();context.transform(o[0],o[1],o[2],o[3],o[4],o[5]);}}if(hasShadow&&hasStroke&&!canvas.hitCanvas){context.save();if(!caching){context._applyOpacity(this);}context._applyShadow(this);drawFunc.call(this,context);context.restore();if(this.hasFill()&&this.getShadowForStrokeEnabled()){drawFunc.call(this,context);}}else if(hasShadow&&!canvas.hitCanvas){context.save();if(!caching){context._applyOpacity(this);}context._applyShadow(this);drawFunc.call(this,context);context.restore();}else{if(!caching){context._applyOpacity(this);}drawFunc.call(this,context);}}context.restore();return this;},drawHit:function drawHit(can,top,caching){var layer=this.getLayer(),canvas=can||layer.hitCanvas,context=canvas.getContext(),drawFunc=this.hitFunc()||this.sceneFunc(),cachedCanvas=this._cache.canvas,cachedHitCanvas=cachedCanvas&&cachedCanvas.hit;if(!this.shouldDrawHit(canvas)){return this;}if(layer){layer.clearHitCache();}if(cachedHitCanvas){context.save();layer._applyTransform(this,context,top);this._drawCachedHitCanvas(context);context.restore();return this;}if(!drawFunc){return this;}context.save();context._applyLineJoin(this);if(!caching){if(layer){layer._applyTransform(this,context,top);}else{var o=this.getAbsoluteTransform(top).getMatrix();context.transform(o[0],o[1],o[2],o[3],o[4],o[5]);}}drawFunc.call(this,context);context.restore();return this;},drawHitFromCache:function drawHitFromCache(alphaThreshold){var threshold=alphaThreshold||0,cachedCanvas=this._cache.canvas,sceneCanvas=this._getCachedSceneCanvas(),hitCanvas=cachedCanvas.hit,hitContext=hitCanvas.getContext(),hitWidth=hitCanvas.getWidth(),hitHeight=hitCanvas.getHeight(),hitImageData,hitData,len,rgbColorKey,i,alpha;hitContext.clear();hitContext.drawImage(sceneCanvas._canvas,0,0,hitWidth,hitHeight);try{hitImageData=hitContext.getImageData(0,0,hitWidth,hitHeight);hitData=hitImageData.data;len=hitData.length;rgbColorKey=Konva.Util._hexToRgb(this.colorKey);for(i=0;i<len;i+=4){alpha=hitData[i+3];if(alpha>threshold){hitData[i]=rgbColorKey.r;hitData[i+1]=rgbColorKey.g;hitData[i+2]=rgbColorKey.b;hitData[i+3]=255;}else{hitData[i+3]=0;}}hitContext.putImageData(hitImageData,0,0);}catch(e){Konva.Util.error('Unable to draw hit graph from cached scene canvas. '+e.message);}return this;}});Konva.Util.extend(Konva.Shape,Konva.Node);Konva.Factory.addGetterSetter(Konva.Shape,'stroke');Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'strokeRed',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'strokeGreen',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'strokeBlue',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'strokeAlpha',1,Konva.Validators.alphaComponent);Konva.Factory.addGetterSetter(Konva.Shape,'strokeWidth',2);Konva.Factory.addGetterSetter(Konva.Shape,'strokeHitEnabled',true);Konva.Factory.addGetterSetter(Konva.Shape,'perfectDrawEnabled',true);Konva.Factory.addGetterSetter(Konva.Shape,'shadowForStrokeEnabled',true);Konva.Factory.addGetterSetter(Konva.Shape,'lineJoin');Konva.Factory.addGetterSetter(Konva.Shape,'lineCap');Konva.Factory.addGetterSetter(Konva.Shape,'sceneFunc');Konva.Factory.addGetterSetter(Konva.Shape,'hitFunc');Konva.Factory.addGetterSetter(Konva.Shape,'dash');Konva.Factory.addGetterSetter(Konva.Shape,'shadowColor');Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'shadowRed',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'shadowGreen',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'shadowBlue',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'shadowAlpha',1,Konva.Validators.alphaComponent);Konva.Factory.addGetterSetter(Konva.Shape,'shadowBlur');Konva.Factory.addGetterSetter(Konva.Shape,'shadowOpacity');Konva.Factory.addComponentsGetterSetter(Konva.Shape,'shadowOffset',['x','y']);Konva.Factory.addGetterSetter(Konva.Shape,'shadowOffsetX',0);Konva.Factory.addGetterSetter(Konva.Shape,'shadowOffsetY',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternImage');Konva.Factory.addGetterSetter(Konva.Shape,'fill');Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'fillRed',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'fillGreen',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'fillBlue',0,Konva.Validators.RGBComponent);Konva.Factory.addDeprecatedGetterSetter(Konva.Shape,'fillAlpha',1,Konva.Validators.alphaComponent);Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternX',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternY',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillLinearGradientColorStops');Konva.Factory.addGetterSetter(Konva.Shape,'fillRadialGradientStartRadius',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillRadialGradientEndRadius',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillRadialGradientColorStops');Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternRepeat','repeat');Konva.Factory.addGetterSetter(Konva.Shape,'fillEnabled',true);Konva.Factory.addGetterSetter(Konva.Shape,'strokeEnabled',true);Konva.Factory.addGetterSetter(Konva.Shape,'shadowEnabled',true);Konva.Factory.addGetterSetter(Konva.Shape,'dashEnabled',true);Konva.Factory.addGetterSetter(Konva.Shape,'strokeScaleEnabled',true);Konva.Factory.addGetterSetter(Konva.Shape,'fillPriority','color');Konva.Factory.addComponentsGetterSetter(Konva.Shape,'fillPatternOffset',['x','y']);Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternOffsetX',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternOffsetY',0);Konva.Factory.addComponentsGetterSetter(Konva.Shape,'fillPatternScale',['x','y']);Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternScaleX',1);Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternScaleY',1);Konva.Factory.addComponentsGetterSetter(Konva.Shape,'fillLinearGradientStartPoint',['x','y']);Konva.Factory.addGetterSetter(Konva.Shape,'fillLinearGradientStartPointX',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillLinearGradientStartPointY',0);Konva.Factory.addComponentsGetterSetter(Konva.Shape,'fillLinearGradientEndPoint',['x','y']);Konva.Factory.addGetterSetter(Konva.Shape,'fillLinearGradientEndPointX',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillLinearGradientEndPointY',0);Konva.Factory.addComponentsGetterSetter(Konva.Shape,'fillRadialGradientStartPoint',['x','y']);Konva.Factory.addGetterSetter(Konva.Shape,'fillRadialGradientStartPointX',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillRadialGradientStartPointY',0);Konva.Factory.addComponentsGetterSetter(Konva.Shape,'fillRadialGradientEndPoint',['x','y']);Konva.Factory.addGetterSetter(Konva.Shape,'fillRadialGradientEndPointX',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillRadialGradientEndPointY',0);Konva.Factory.addGetterSetter(Konva.Shape,'fillPatternRotation',0);Konva.Factory.backCompat(Konva.Shape,{dashArray:'dash',getDashArray:'getDash',setDashArray:'getDash',drawFunc:'sceneFunc',getDrawFunc:'getSceneFunc',setDrawFunc:'setSceneFunc',drawHitFunc:'hitFunc',getDrawHitFunc:'getHitFunc',setDrawHitFunc:'setHitFunc'});Konva.Collection.mapMethods(Konva.Shape);})(Konva);(function(){'use strict';var STAGE='Stage',STRING='string',PX='px',MOUSEOUT='mouseout',MOUSELEAVE='mouseleave',MOUSEOVER='mouseover',MOUSEENTER='mouseenter',MOUSEMOVE='mousemove',MOUSEDOWN='mousedown',MOUSEUP='mouseup',CLICK='click',DBL_CLICK='dblclick',TOUCHSTART='touchstart',TOUCHEND='touchend',TAP='tap',DBL_TAP='dbltap',TOUCHMOVE='touchmove',DOMMOUSESCROLL='DOMMouseScroll',MOUSEWHEEL='mousewheel',WHEEL='wheel',CONTENT_MOUSEOUT='contentMouseout',CONTENT_MOUSEOVER='contentMouseover',CONTENT_MOUSEMOVE='contentMousemove',CONTENT_MOUSEDOWN='contentMousedown',CONTENT_MOUSEUP='contentMouseup',CONTENT_CLICK='contentClick',CONTENT_DBL_CLICK='contentDblclick',CONTENT_TOUCHSTART='contentTouchstart',CONTENT_TOUCHEND='contentTouchend',CONTENT_DBL_TAP='contentDbltap',CONTENT_TOUCHMOVE='contentTouchmove',DIV='div',RELATIVE='relative',KONVA_CONTENT='konvajs-content',SPACE=' ',UNDERSCORE='_',CONTAINER='container',EMPTY_STRING='',EVENTS=[MOUSEDOWN,MOUSEMOVE,MOUSEUP,MOUSEOUT,TOUCHSTART,TOUCHMOVE,TOUCHEND,MOUSEOVER,DOMMOUSESCROLL,MOUSEWHEEL,WHEEL],eventsLength=EVENTS.length;function addEvent(ctx,eventName){ctx.content.addEventListener(eventName,function(evt){ctx[UNDERSCORE+eventName](evt);},false);}Konva.Stage=function(config){this.___init(config);};Konva.Util.addMethods(Konva.Stage,{___init:function ___init(config){this.nodeType=STAGE;Konva.Container.call(this,config);this._id=Konva.idCounter++;this._buildDOM();this._bindContentEvents();this._enableNestedTransforms=false;Konva.stages.push(this);},_validateAdd:function _validateAdd(child){if(child.getType()!=='Layer'){Konva.Util.throw('You may only add layers to the stage.');}},setContainer:function setContainer(container){if((typeof container==='undefined'?'undefined':_typeof(container))===STRING){var id=container;container=Konva.document.getElementById(container);if(!container){throw'Can not find container in document with id '+id;}}this._setAttr(CONTAINER,container);return this;},shouldDrawHit:function shouldDrawHit(){return true;},draw:function draw(){Konva.Node.prototype.draw.call(this);return this;},setHeight:function setHeight(height){Konva.Node.prototype.setHeight.call(this,height);this._resizeDOM();return this;},setWidth:function setWidth(width){Konva.Node.prototype.setWidth.call(this,width);this._resizeDOM();return this;},clear:function clear(){var layers=this.children,len=layers.length,n;for(n=0;n<len;n++){layers[n].clear();}return this;},clone:function clone(obj){if(!obj){obj={};}obj.container=Konva.document.createElement(DIV);return Konva.Container.prototype.clone.call(this,obj);},destroy:function destroy(){var content=this.content;Konva.Container.prototype.destroy.call(this);if(content&&Konva.Util._isInDocument(content)){this.getContainer().removeChild(content);}var index=Konva.stages.indexOf(this);if(index>-1){Konva.stages.splice(index,1);}},getPointerPosition:function getPointerPosition(){return this.pointerPos;},getStage:function getStage(){return this;},getContent:function getContent(){return this.content;},toDataURL:function toDataURL(config){config=config||{};var mimeType=config.mimeType||null,quality=config.quality||null,x=config.x||0,y=config.y||0,canvas=new Konva.SceneCanvas({width:config.width||this.getWidth(),height:config.height||this.getHeight(),pixelRatio:config.pixelRatio}),_context=canvas.getContext()._context,layers=this.children;if(x||y){_context.translate(-1*x,-1*y);}layers.each(function(layer){var width=layer.getCanvas().getWidth();var height=layer.getCanvas().getHeight();var ratio=layer.getCanvas().getPixelRatio();_context.drawImage(layer.getCanvas()._canvas,0,0,width/ratio,height/ratio);});var src=canvas.toDataURL(mimeType,quality);if(config.callback){config.callback(src);}return src;},toImage:function toImage(config){var cb=config.callback;config.callback=function(dataUrl){Konva.Util._getImage(dataUrl,function(img){cb(img);});};this.toDataURL(config);},getIntersection:function getIntersection(pos){var layers=this.getChildren(),len=layers.length,end=len-1,n,shape;for(n=end;n>=0;n--){shape=layers[n].getIntersection(pos);if(shape){return shape;}}return null;},_resizeDOM:function _resizeDOM(){if(this.content){var width=this.getWidth(),height=this.getHeight(),layers=this.getChildren(),len=layers.length,n,layer;this.content.style.width=width+PX;this.content.style.height=height+PX;this.bufferCanvas.setSize(width,height);this.bufferHitCanvas.setSize(width,height);for(n=0;n<len;n++){layer=layers[n];layer.setSize(width,height);layer.draw();}}},add:function add(layer){if(arguments.length>1){for(var i=0;i<arguments.length;i++){this.add(arguments[i]);}return this;}Konva.Container.prototype.add.call(this,layer);layer._setCanvasSize(this.width(),this.height());layer.draw();this.content.appendChild(layer.canvas._canvas);return this;},getParent:function getParent(){return null;},getLayer:function getLayer(){return null;},getLayers:function getLayers(){return this.getChildren();},_bindContentEvents:function _bindContentEvents(){for(var n=0;n<eventsLength;n++){addEvent(this,EVENTS[n]);}},_mouseover:function _mouseover(evt){if(!Konva.UA.mobile){this._setPointerPosition(evt);this._fire(CONTENT_MOUSEOVER,{evt:evt});}},_mouseout:function _mouseout(evt){if(!Konva.UA.mobile){this._setPointerPosition(evt);var targetShape=this.targetShape;if(targetShape&&!Konva.isDragging()){targetShape._fireAndBubble(MOUSEOUT,{evt:evt});targetShape._fireAndBubble(MOUSELEAVE,{evt:evt});this.targetShape=null;}this.pointerPos=undefined;this._fire(CONTENT_MOUSEOUT,{evt:evt});}},_mousemove:function _mousemove(evt){if(Konva.UA.ieMobile){return this._touchmove(evt);}
if((typeof evt.movementX!=='undefined'||typeof evt.movementY!=='undefined')&&evt.movementY===0&&evt.movementX===0){return null;}if(Konva.UA.mobile){return null;}this._setPointerPosition(evt);var shape;if(!Konva.isDragging()){shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){if(!Konva.isDragging()&&(!this.targetShape||this.targetShape._id!==shape._id)){if(this.targetShape){this.targetShape._fireAndBubble(MOUSEOUT,{evt:evt},shape);this.targetShape._fireAndBubble(MOUSELEAVE,{evt:evt},shape);}shape._fireAndBubble(MOUSEOVER,{evt:evt},this.targetShape);shape._fireAndBubble(MOUSEENTER,{evt:evt},this.targetShape);this.targetShape=shape;}else{shape._fireAndBubble(MOUSEMOVE,{evt:evt});}}else{if(this.targetShape&&!Konva.isDragging()){this.targetShape._fireAndBubble(MOUSEOUT,{evt:evt});this.targetShape._fireAndBubble(MOUSELEAVE,{evt:evt});this.targetShape=null;}}
this._fire(CONTENT_MOUSEMOVE,{evt:evt});}},_mousedown:function _mousedown(evt){if(Konva.UA.ieMobile){return this._touchstart(evt);}if(!Konva.UA.mobile){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());Konva.listenClickTap=true;if(shape&&shape.isListening()){this.clickStartShape=shape;shape._fireAndBubble(MOUSEDOWN,{evt:evt});}
this._fire(CONTENT_MOUSEDOWN,{evt:evt});}},_mouseup:function _mouseup(evt){if(Konva.UA.ieMobile){return this._touchend(evt);}if(!Konva.UA.mobile){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition()),clickStartShape=this.clickStartShape,fireDblClick=false,dd=Konva.DD;if(Konva.inDblClickWindow){fireDblClick=true;Konva.inDblClickWindow=false;}
else if(!dd||!dd.justDragged){Konva.inDblClickWindow=true;}else if(dd){dd.justDragged=false;}setTimeout(function(){Konva.inDblClickWindow=false;},Konva.dblClickWindow);if(shape&&shape.isListening()){shape._fireAndBubble(MOUSEUP,{evt:evt});if(Konva.listenClickTap&&clickStartShape&&clickStartShape._id===shape._id){shape._fireAndBubble(CLICK,{evt:evt});if(fireDblClick){shape._fireAndBubble(DBL_CLICK,{evt:evt});}}}
this._fire(CONTENT_MOUSEUP,{evt:evt});if(Konva.listenClickTap){this._fire(CONTENT_CLICK,{evt:evt});if(fireDblClick){this._fire(CONTENT_DBL_CLICK,{evt:evt});}}Konva.listenClickTap=false;}},_touchstart:function _touchstart(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());Konva.listenClickTap=true;if(shape&&shape.isListening()){this.tapStartShape=shape;shape._fireAndBubble(TOUCHSTART,{evt:evt});if(shape.isListening()&&evt.preventDefault){evt.preventDefault();}}
this._fire(CONTENT_TOUCHSTART,{evt:evt});},_touchend:function _touchend(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition()),fireDblClick=false;if(Konva.inDblClickWindow){fireDblClick=true;Konva.inDblClickWindow=false;}else{Konva.inDblClickWindow=true;}setTimeout(function(){Konva.inDblClickWindow=false;},Konva.dblClickWindow);if(shape&&shape.isListening()){shape._fireAndBubble(TOUCHEND,{evt:evt});if(Konva.listenClickTap&&shape._id===this.tapStartShape._id){shape._fireAndBubble(TAP,{evt:evt});if(fireDblClick){shape._fireAndBubble(DBL_TAP,{evt:evt});}}
if(shape.isListening()&&evt.preventDefault){evt.preventDefault();}}
if(Konva.listenClickTap){this._fire(CONTENT_TOUCHEND,{evt:evt});if(fireDblClick){this._fire(CONTENT_DBL_TAP,{evt:evt});}}Konva.listenClickTap=false;},_touchmove:function _touchmove(evt){this._setPointerPosition(evt);var dd=Konva.DD,shape;if(!Konva.isDragging()){shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){shape._fireAndBubble(TOUCHMOVE,{evt:evt});if(shape.isListening()&&evt.preventDefault){evt.preventDefault();}}this._fire(CONTENT_TOUCHMOVE,{evt:evt});}if(dd){if(Konva.isDragging()){evt.preventDefault();}}},_DOMMouseScroll:function _DOMMouseScroll(evt){this._mousewheel(evt);},_mousewheel:function _mousewheel(evt){this._setPointerPosition(evt);var shape=this.getIntersection(this.getPointerPosition());if(shape&&shape.isListening()){shape._fireAndBubble(MOUSEWHEEL,{evt:evt});}},_wheel:function _wheel(evt){this._mousewheel(evt);},_setPointerPosition:function _setPointerPosition(evt){var contentPosition=this._getContentPosition(),x=null,y=null;evt=evt?evt:window.event;if(evt.touches!==undefined){if(evt.touches.length>0){var touch=evt.touches[0];x=touch.clientX-contentPosition.left;y=touch.clientY-contentPosition.top;}}
else{if(!contentPosition){x=evt.offsetX;y=evt.offetY;}
else if(Konva.UA.browser==='mozilla'){x=evt.layerX||evt.clientX-contentPosition.left;y=evt.layerY||evt.clientY-contentPosition.top;}else{x=evt.clientX-contentPosition.left;y=evt.clientY-contentPosition.top;}}if(x!==null&&y!==null){this.pointerPos={x:x,y:y};}},_getContentPosition:function _getContentPosition(){var rect=this.content.getBoundingClientRect?this.content.getBoundingClientRect():{top:0,left:0};return{top:rect.top,left:rect.left};},_buildDOM:function _buildDOM(){var container=this.getContainer();if(!container){if(Konva.Util.isBrowser()){throw'Stage has no container. A container is required.';}else{container=Konva.document.createElement(DIV);}}
container.innerHTML=EMPTY_STRING;this.content=Konva.document.createElement(DIV);this.content.style.position=RELATIVE;this.content.className=KONVA_CONTENT;this.content.setAttribute('role','presentation');container.appendChild(this.content);this.bufferCanvas=new Konva.SceneCanvas({pixelRatio:1});this.bufferHitCanvas=new Konva.HitCanvas();this._resizeDOM();},_onContent:function _onContent(typesStr,handler){var types=typesStr.split(SPACE),len=types.length,n,baseEvent;for(n=0;n<len;n++){baseEvent=types[n];this.content.addEventListener(baseEvent,handler,false);}},cache:function cache(){Konva.Util.warn('Cache function is not allowed for stage. You may use cache only for layers, groups and shapes.');},clearCache:function clearCache(){}});Konva.Util.extend(Konva.Stage,Konva.Container);Konva.Factory.addGetter(Konva.Stage,'container');Konva.Factory.addOverloadedGetterSetter(Konva.Stage,'container');})();(function(){'use strict';Konva.BaseLayer=function(config){this.___init(config);};Konva.Util.addMethods(Konva.BaseLayer,{___init:function ___init(config){this.nodeType='Layer';Konva.Container.call(this,config);},createPNGStream:function createPNGStream(){return this.canvas._canvas.createPNGStream();},getCanvas:function getCanvas(){return this.canvas;},getHitCanvas:function getHitCanvas(){return this.hitCanvas;},getContext:function getContext(){return this.getCanvas().getContext();},clear:function clear(bounds){this.getContext().clear(bounds);return this;},clearHitCache:function clearHitCache(){this._hitImageData=undefined;},setZIndex:function setZIndex(index){Konva.Node.prototype.setZIndex.call(this,index);var stage=this.getStage();if(stage){stage.content.removeChild(this.getCanvas()._canvas);if(index<stage.getChildren().length-1){stage.content.insertBefore(this.getCanvas()._canvas,stage.getChildren()[index+1].getCanvas()._canvas);}else{stage.content.appendChild(this.getCanvas()._canvas);}}return this;},moveToTop:function moveToTop(){Konva.Node.prototype.moveToTop.call(this);var stage=this.getStage();if(stage){stage.content.removeChild(this.getCanvas()._canvas);stage.content.appendChild(this.getCanvas()._canvas);}},moveUp:function moveUp(){var moved=Konva.Node.prototype.moveUp.call(this);if(!moved){return;}var stage=this.getStage();if(!stage){return;}stage.content.removeChild(this.getCanvas()._canvas);if(this.index<stage.getChildren().length-1){stage.content.insertBefore(this.getCanvas()._canvas,stage.getChildren()[this.index+1].getCanvas()._canvas);}else{stage.content.appendChild(this.getCanvas()._canvas);}},moveDown:function moveDown(){if(Konva.Node.prototype.moveDown.call(this)){var stage=this.getStage();if(stage){var children=stage.getChildren();stage.content.removeChild(this.getCanvas()._canvas);stage.content.insertBefore(this.getCanvas()._canvas,children[this.index+1].getCanvas()._canvas);}}},moveToBottom:function moveToBottom(){if(Konva.Node.prototype.moveToBottom.call(this)){var stage=this.getStage();if(stage){var children=stage.getChildren();stage.content.removeChild(this.getCanvas()._canvas);stage.content.insertBefore(this.getCanvas()._canvas,children[1].getCanvas()._canvas);}}},getLayer:function getLayer(){return this;},remove:function remove(){var _canvas=this.getCanvas()._canvas;Konva.Node.prototype.remove.call(this);if(_canvas&&_canvas.parentNode&&Konva.Util._isInDocument(_canvas)){_canvas.parentNode.removeChild(_canvas);}return this;},getStage:function getStage(){return this.parent;},setSize:function setSize(width,height){this.canvas.setSize(width,height);},getWidth:function getWidth(){if(this.parent){return this.parent.getWidth();}},setWidth:function setWidth(){Konva.Util.warn('Can not change width of layer. Use "stage.width(value)" function instead.');},getHeight:function getHeight(){if(this.parent){return this.parent.getHeight();}},setHeight:function setHeight(){Konva.Util.warn('Can not change height of layer. Use "stage.height(value)" function instead.');},_applyTransform:function _applyTransform(shape,context,top){var m=shape.getAbsoluteTransform(top).getMatrix();context.transform(m[0],m[1],m[2],m[3],m[4],m[5]);}});Konva.Util.extend(Konva.BaseLayer,Konva.Container);Konva.Factory.addGetterSetter(Konva.BaseLayer,'clearBeforeDraw',true);Konva.Collection.mapMethods(Konva.BaseLayer);})();(function(){'use strict';var HASH='#',BEFORE_DRAW='beforeDraw',DRAW='draw',INTERSECTION_OFFSETS=[{x:0,y:0},{x:-1,y:0},{x:-1,y:-1},{x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1}],INTERSECTION_OFFSETS_LEN=INTERSECTION_OFFSETS.length;Konva.Layer=function(config){this.____init(config);};Konva.Util.addMethods(Konva.Layer,{____init:function ____init(config){this.nodeType='Layer';this.canvas=new Konva.SceneCanvas();this.hitCanvas=new Konva.HitCanvas({pixelRatio:1});Konva.BaseLayer.call(this,config);},_setCanvasSize:function _setCanvasSize(width,height){this.canvas.setSize(width,height);this.hitCanvas.setSize(width,height);},_validateAdd:function _validateAdd(child){var type=child.getType();if(type!=='Group'&&type!=='Shape'){Konva.Util.throw('You may only add groups and shapes to a layer.');}},getIntersection:function getIntersection(pos){var obj,i,intersectionOffset,shape;if(!this.hitGraphEnabled()||!this.isVisible()){return null;}
var spiralSearchDistance=1;var continueSearch=false;while(true){for(i=0;i<INTERSECTION_OFFSETS_LEN;i++){intersectionOffset=INTERSECTION_OFFSETS[i];obj=this._getIntersection({x:pos.x+intersectionOffset.x*spiralSearchDistance,y:pos.y+intersectionOffset.y*spiralSearchDistance});shape=obj.shape;if(shape){return shape;}
continueSearch=!!obj.antialiased;if(!obj.antialiased){break;}}
if(continueSearch){spiralSearchDistance+=1;}else{return null;}}},_getImageData:function _getImageData(x,y){var width=this.hitCanvas.width||1,height=this.hitCanvas.height||1,index=Math.round(y)*width+Math.round(x);if(!this._hitImageData){this._hitImageData=this.hitCanvas.context.getImageData(0,0,width,height);}return[this._hitImageData.data[4*index+0],this._hitImageData.data[4*index+1],this._hitImageData.data[4*index+2],this._hitImageData.data[4*index+3]];},_getIntersection:function _getIntersection(pos){var ratio=this.hitCanvas.pixelRatio;var p=this.hitCanvas.context.getImageData(Math.round(pos.x*ratio),Math.round(pos.y*ratio),1,1).data,p3=p[3],colorKey,shape;if(p3===255){colorKey=Konva.Util._rgbToHex(p[0],p[1],p[2]);shape=Konva.shapes[HASH+colorKey];if(shape){return{shape:shape};}return{antialiased:true};}
else if(p3>0){return{antialiased:true};}
return{};},drawScene:function drawScene(can,top){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas();this._fire(BEFORE_DRAW,{node:this});if(this.getClearBeforeDraw()){canvas.getContext().clear();}Konva.Container.prototype.drawScene.call(this,canvas,top);this._fire(DRAW,{node:this});return this;},drawHit:function drawHit(can,top){var layer=this.getLayer(),canvas=can||layer&&layer.hitCanvas;if(layer&&layer.getClearBeforeDraw()){layer.getHitCanvas().getContext().clear();}Konva.Container.prototype.drawHit.call(this,canvas,top);this.imageData=null;return this;},clear:function clear(bounds){Konva.BaseLayer.prototype.clear.call(this,bounds);this.getHitCanvas().getContext().clear(bounds);this.imageData=null;return this;},setVisible:function setVisible(visible){Konva.Node.prototype.setVisible.call(this,visible);if(visible){this.getCanvas()._canvas.style.display='block';this.hitCanvas._canvas.style.display='block';}else{this.getCanvas()._canvas.style.display='none';this.hitCanvas._canvas.style.display='none';}return this;},enableHitGraph:function enableHitGraph(){this.setHitGraphEnabled(true);return this;},disableHitGraph:function disableHitGraph(){this.setHitGraphEnabled(false);return this;},setSize:function setSize(width,height){Konva.BaseLayer.prototype.setSize.call(this,width,height);this.hitCanvas.setSize(width,height);}});Konva.Util.extend(Konva.Layer,Konva.BaseLayer);Konva.Factory.addGetterSetter(Konva.Layer,'hitGraphEnabled',true);Konva.Collection.mapMethods(Konva.Layer);})();(function(){'use strict';Konva.FastLayer=function(config){this.____init(config);};Konva.Util.addMethods(Konva.FastLayer,{____init:function ____init(config){this.nodeType='Layer';this.canvas=new Konva.SceneCanvas();Konva.BaseLayer.call(this,config);},_validateAdd:function _validateAdd(child){var type=child.getType();if(type!=='Shape'){Konva.Util.throw('You may only add shapes to a fast layer.');}},_setCanvasSize:function _setCanvasSize(width,height){this.canvas.setSize(width,height);},hitGraphEnabled:function hitGraphEnabled(){return false;},getIntersection:function getIntersection(){return null;},drawScene:function drawScene(can){var layer=this.getLayer(),canvas=can||layer&&layer.getCanvas();if(this.getClearBeforeDraw()){canvas.getContext().clear();}Konva.Container.prototype.drawScene.call(this,canvas);return this;},draw:function draw(){this.drawScene();return this;},setVisible:function setVisible(visible){Konva.Node.prototype.setVisible.call(this,visible);if(visible){this.getCanvas()._canvas.style.display='block';}else{this.getCanvas()._canvas.style.display='none';}return this;}});Konva.Util.extend(Konva.FastLayer,Konva.BaseLayer);Konva.Collection.mapMethods(Konva.FastLayer);})();(function(){'use strict';Konva.Group=function(config){this.___init(config);};Konva.Util.addMethods(Konva.Group,{___init:function ___init(config){this.nodeType='Group';Konva.Container.call(this,config);},_validateAdd:function _validateAdd(child){var type=child.getType();if(type!=='Group'&&type!=='Shape'){Konva.Util.throw('You may only add groups and shapes to groups.');}}});Konva.Util.extend(Konva.Group,Konva.Container);Konva.Collection.mapMethods(Konva.Group);})();(function(Konva){'use strict';var BATCH_DRAW_STOP_TIME_DIFF=500;var now=function(){if(Konva.root.performance&&Konva.root.performance.now){return function(){return Konva.root.performance.now();};}return function(){return new Date().getTime();};}();function FRAF(callback){setTimeout(callback,1000/60);}var RAF=function(){return Konva.root.requestAnimationFrame||Konva.root.webkitRequestAnimationFrame||Konva.root.mozRequestAnimationFrame||Konva.root.oRequestAnimationFrame||Konva.root.msRequestAnimationFrame||FRAF;}();function requestAnimFrame(){return RAF.apply(Konva.root,arguments);}Konva.Animation=function(func,layers){var Anim=Konva.Animation;this.func=func;this.setLayers(layers);this.id=Anim.animIdCounter++;this.frame={time:0,timeDiff:0,lastTime:now()};};Konva.Animation.prototype={setLayers:function setLayers(layers){var lays=[];if(!layers){lays=[];}
else if(layers.length>0){lays=layers;}
else{lays=[layers];}this.layers=lays;return this;},getLayers:function getLayers(){return this.layers;},addLayer:function addLayer(layer){var layers=this.layers,len=layers.length,n;for(n=0;n<len;n++){if(layers[n]._id===layer._id){return false;}}this.layers.push(layer);return true;},isRunning:function isRunning(){var a=Konva.Animation,animations=a.animations,len=animations.length,n;for(n=0;n<len;n++){if(animations[n].id===this.id){return true;}}return false;},start:function start(){var Anim=Konva.Animation;this.stop();this.frame.timeDiff=0;this.frame.lastTime=now();Anim._addAnimation(this);return this;},stop:function stop(){Konva.Animation._removeAnimation(this);return this;},_updateFrameObject:function _updateFrameObject(time){this.frame.timeDiff=time-this.frame.lastTime;this.frame.lastTime=time;this.frame.time+=this.frame.timeDiff;this.frame.frameRate=1000/this.frame.timeDiff;}};Konva.Animation.animations=[];Konva.Animation.animIdCounter=0;Konva.Animation.animRunning=false;Konva.Animation._addAnimation=function(anim){this.animations.push(anim);this._handleAnimation();};Konva.Animation._removeAnimation=function(anim){var id=anim.id,animations=this.animations,len=animations.length,n;for(n=0;n<len;n++){if(animations[n].id===id){this.animations.splice(n,1);break;}}};Konva.Animation._runFrames=function(){var layerHash={},animations=this.animations,anim,layers,func,n,i,layersLen,layer,key,needRedraw;for(n=0;n<animations.length;n++){anim=animations[n];layers=anim.layers;func=anim.func;anim._updateFrameObject(now());layersLen=layers.length;if(func){needRedraw=func.call(anim,anim.frame)!==false;}else{needRedraw=true;}if(!needRedraw){continue;}for(i=0;i<layersLen;i++){layer=layers[i];if(layer._id!==undefined){layerHash[layer._id]=layer;}}}for(key in layerHash){if(!layerHash.hasOwnProperty(key)){continue;}layerHash[key].draw();}};Konva.Animation._animationLoop=function(){var Anim=Konva.Animation;if(Anim.animations.length){requestAnimFrame(Anim._animationLoop);Anim._runFrames();}else{Anim.animRunning=false;}};Konva.Animation._handleAnimation=function(){if(!this.animRunning){this.animRunning=true;this._animationLoop();}};var moveTo=Konva.Node.prototype.moveTo;Konva.Node.prototype.moveTo=function(container){moveTo.call(this,container);};Konva.BaseLayer.prototype.batchDraw=function(){var that=this,Anim=Konva.Animation;if(!this.batchAnim){this.batchAnim=new Anim(function(){if(that.lastBatchDrawTime&&now()-that.lastBatchDrawTime>BATCH_DRAW_STOP_TIME_DIFF){that.batchAnim.stop();}},this);}this.lastBatchDrawTime=now();if(!this.batchAnim.isRunning()){this.draw();this.batchAnim.start();}return this;};Konva.Stage.prototype.batchDraw=function(){this.getChildren().each(function(layer){layer.batchDraw();});return this;};})(Konva);(function(){'use strict';var blacklist={node:1,duration:1,easing:1,onFinish:1,yoyo:1},PAUSED=1,PLAYING=2,REVERSING=3,idCounter=0,colorAttrs=['fill','stroke','shadowColor'];var Tween=function Tween(prop,propFunc,func,begin,finish,duration,yoyo){this.prop=prop;this.propFunc=propFunc;this.begin=begin;this._pos=begin;this.duration=duration;this._change=0;this.prevPos=0;this.yoyo=yoyo;this._time=0;this._position=0;this._startTime=0;this._finish=0;this.func=func;this._change=finish-this.begin;this.pause();};Tween.prototype={fire:function fire(str){var handler=this[str];if(handler){handler();}},setTime:function setTime(t){if(t>this.duration){if(this.yoyo){this._time=this.duration;this.reverse();}else{this.finish();}}else if(t<0){if(this.yoyo){this._time=0;this.play();}else{this.reset();}}else{this._time=t;this.update();}},getTime:function getTime(){return this._time;},setPosition:function setPosition(p){this.prevPos=this._pos;this.propFunc(p);this._pos=p;},getPosition:function getPosition(t){if(t===undefined){t=this._time;}return this.func(t,this.begin,this._change,this.duration);},play:function play(){this.state=PLAYING;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire('onPlay');},reverse:function reverse(){this.state=REVERSING;this._time=this.duration-this._time;this._startTime=this.getTimer()-this._time;this.onEnterFrame();this.fire('onReverse');},seek:function seek(t){this.pause();this._time=t;this.update();this.fire('onSeek');},reset:function reset(){this.pause();this._time=0;this.update();this.fire('onReset');},finish:function finish(){this.pause();this._time=this.duration;this.update();this.fire('onFinish');},update:function update(){this.setPosition(this.getPosition(this._time));},onEnterFrame:function onEnterFrame(){var t=this.getTimer()-this._startTime;if(this.state===PLAYING){this.setTime(t);}else if(this.state===REVERSING){this.setTime(this.duration-t);}},pause:function pause(){this.state=PAUSED;this.fire('onPause');},getTimer:function getTimer(){return new Date().getTime();}};Konva.Tween=function(config){var that=this,node=config.node,nodeId=node._id,duration,easing=config.easing||Konva.Easings.Linear,yoyo=!!config.yoyo,key;if(typeof config.duration==='undefined'){duration=1;}else if(config.duration===0){duration=0.001;}else{duration=config.duration;}this.node=node;this._id=idCounter++;this.anim=new Konva.Animation(function(){that.tween.onEnterFrame();},node.getLayer()||(node instanceof Konva.Stage?node.getLayers():null));this.tween=new Tween(key,function(i){that._tweenFunc(i);},easing,0,1,duration*1000,yoyo);this._addListeners();if(!Konva.Tween.attrs[nodeId]){Konva.Tween.attrs[nodeId]={};}if(!Konva.Tween.attrs[nodeId][this._id]){Konva.Tween.attrs[nodeId][this._id]={};}
if(!Konva.Tween.tweens[nodeId]){Konva.Tween.tweens[nodeId]={};}for(key in config){if(blacklist[key]===undefined){this._addAttr(key,config[key]);}}this.reset();this.onFinish=config.onFinish;this.onReset=config.onReset;};Konva.Tween.attrs={};Konva.Tween.tweens={};Konva.Tween.prototype={_addAttr:function _addAttr(key,end){var node=this.node,nodeId=node._id,start,diff,tweenId,n,len,trueEnd,trueStart;tweenId=Konva.Tween.tweens[nodeId][key];if(tweenId){delete Konva.Tween.attrs[nodeId][tweenId][key];}
start=node.getAttr(key);if(Konva.Util._isArray(end)){diff=[];len=Math.max(end.length,start.length);if(key==='points'&&end.length!==start.length){if(end.length>start.length){trueStart=start;start=Konva.Util._prepareArrayForTween(start,end,node.closed());}else{trueEnd=end;end=Konva.Util._prepareArrayForTween(end,start,node.closed());}}for(n=0;n<len;n++){diff.push(end[n]-start[n]);}}else if(colorAttrs.indexOf(key)!==-1){start=Konva.Util.colorToRGBA(start);var endRGBA=Konva.Util.colorToRGBA(end);diff={r:endRGBA.r-start.r,g:endRGBA.g-start.g,b:endRGBA.b-start.b,a:endRGBA.a-start.a};}else{diff=end-start;}Konva.Tween.attrs[nodeId][this._id][key]={start:start,diff:diff,end:end,trueEnd:trueEnd,trueStart:trueStart};Konva.Tween.tweens[nodeId][key]=this._id;},_tweenFunc:function _tweenFunc(i){var node=this.node,attrs=Konva.Tween.attrs[node._id][this._id],key,attr,start,diff,newVal,n,len,end;for(key in attrs){attr=attrs[key];start=attr.start;diff=attr.diff;end=attr.end;if(Konva.Util._isArray(start)){newVal=[];len=Math.max(start.length,end.length);for(n=0;n<len;n++){newVal.push((start[n]||0)+diff[n]*i);}}else if(colorAttrs.indexOf(key)!==-1){newVal='rgba('+Math.round(start.r+diff.r*i)+','+Math.round(start.g+diff.g*i)+','+Math.round(start.b+diff.b*i)+','+(start.a+diff.a*i)+')';}else{newVal=start+diff*i;}node.setAttr(key,newVal);}},_addListeners:function _addListeners(){var that=this;this.tween.onPlay=function(){that.anim.start();};this.tween.onReverse=function(){that.anim.start();};this.tween.onPause=function(){that.anim.stop();};this.tween.onFinish=function(){var node=that.node;var attrs=Konva.Tween.attrs[node._id][that._id];if(attrs.points&&attrs.points.trueEnd){node.points(attrs.points.trueEnd);}if(that.onFinish){that.onFinish.call(that);}};this.tween.onReset=function(){var node=that.node;var attrs=Konva.Tween.attrs[node._id][that._id];if(attrs.points&&attrs.points.trueStart){node.points(attrs.points.trueStart);}if(that.onReset){that.onReset();}};},play:function play(){this.tween.play();return this;},reverse:function reverse(){this.tween.reverse();return this;},reset:function reset(){this.tween.reset();return this;},seek:function seek(t){this.tween.seek(t*1000);return this;},pause:function pause(){this.tween.pause();return this;},finish:function finish(){this.tween.finish();return this;},destroy:function destroy(){var nodeId=this.node._id,thisId=this._id,attrs=Konva.Tween.tweens[nodeId],key;this.pause();for(key in attrs){delete Konva.Tween.tweens[nodeId][key];}delete Konva.Tween.attrs[nodeId][thisId];}};Konva.Node.prototype.to=function(params){var onFinish=params.onFinish;params.node=this;params.onFinish=function(){this.destroy();if(onFinish){onFinish();}};var tween=new Konva.Tween(params);tween.play();};Konva.Easings={'BackEaseIn':function BackEaseIn(t,b,c,d){var s=1.70158;return c*(t/=d)*t*((s+1)*t-s)+b;},'BackEaseOut':function BackEaseOut(t,b,c,d){var s=1.70158;return c*((t=t/d-1)*t*((s+1)*t+s)+1)+b;},'BackEaseInOut':function BackEaseInOut(t,b,c,d){var s=1.70158;if((t/=d/2)<1){return c/2*(t*t*(((s*=1.525)+1)*t-s))+b;}return c/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+b;},'ElasticEaseIn':function ElasticEaseIn(t,b,c,d,a,p){var s=0;if(t===0){return b;}if((t/=d)===1){return b+c;}if(!p){p=d*0.3;}if(!a||a<Math.abs(c)){a=c;s=p/4;}else{s=p/(2*Math.PI)*Math.asin(c/a);}return-(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p))+b;},'ElasticEaseOut':function ElasticEaseOut(t,b,c,d,a,p){var s=0;if(t===0){return b;}if((t/=d)===1){return b+c;}if(!p){p=d*0.3;}if(!a||a<Math.abs(c)){a=c;s=p/4;}else{s=p/(2*Math.PI)*Math.asin(c/a);}return a*Math.pow(2,-10*t)*Math.sin((t*d-s)*(2*Math.PI)/p)+c+b;},'ElasticEaseInOut':function ElasticEaseInOut(t,b,c,d,a,p){var s=0;if(t===0){return b;}if((t/=d/2)===2){return b+c;}if(!p){p=d*(0.3*1.5);}if(!a||a<Math.abs(c)){a=c;s=p/4;}else{s=p/(2*Math.PI)*Math.asin(c/a);}if(t<1){return-0.5*(a*Math.pow(2,10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p))+b;}return a*Math.pow(2,-10*(t-=1))*Math.sin((t*d-s)*(2*Math.PI)/p)*0.5+c+b;},'BounceEaseOut':function BounceEaseOut(t,b,c,d){if((t/=d)<1/2.75){return c*(7.5625*t*t)+b;}else if(t<2/2.75){return c*(7.5625*(t-=1.5/2.75)*t+0.75)+b;}else if(t<2.5/2.75){return c*(7.5625*(t-=2.25/2.75)*t+0.9375)+b;}else{return c*(7.5625*(t-=2.625/2.75)*t+0.984375)+b;}},'BounceEaseIn':function BounceEaseIn(t,b,c,d){return c-Konva.Easings.BounceEaseOut(d-t,0,c,d)+b;},'BounceEaseInOut':function BounceEaseInOut(t,b,c,d){if(t<d/2){return Konva.Easings.BounceEaseIn(t*2,0,c,d)*0.5+b;}else{return Konva.Easings.BounceEaseOut(t*2-d,0,c,d)*0.5+c*0.5+b;}},'EaseIn':function EaseIn(t,b,c,d){return c*(t/=d)*t+b;},'EaseOut':function EaseOut(t,b,c,d){return-c*(t/=d)*(t-2)+b;},'EaseInOut':function EaseInOut(t,b,c,d){if((t/=d/2)<1){return c/2*t*t+b;}return-c/2*(--t*(t-2)-1)+b;},'StrongEaseIn':function StrongEaseIn(t,b,c,d){return c*(t/=d)*t*t*t*t+b;},'StrongEaseOut':function StrongEaseOut(t,b,c,d){return c*((t=t/d-1)*t*t*t*t+1)+b;},'StrongEaseInOut':function StrongEaseInOut(t,b,c,d){if((t/=d/2)<1){return c/2*t*t*t*t*t+b;}return c/2*((t-=2)*t*t*t*t+2)+b;},'Linear':function Linear(t,b,c,d){return c*t/d+b;}};})();(function(){'use strict';Konva.DD={anim:new Konva.Animation(function(){var b=this.dirty;this.dirty=false;return b;}),isDragging:false,justDragged:false,offset:{x:0,y:0},node:null,_drag:function _drag(evt){var dd=Konva.DD,node=dd.node;if(node){if(!dd.isDragging){var pos=node.getStage().getPointerPosition();var dragDistance=node.dragDistance();var distance=Math.max(Math.abs(pos.x-dd.startPointerPos.x),Math.abs(pos.y-dd.startPointerPos.y));if(distance<dragDistance){return;}}node.getStage()._setPointerPosition(evt);node._setDragPosition(evt);if(!dd.isDragging){dd.isDragging=true;node.fire('dragstart',{type:'dragstart',target:node,evt:evt},true);}
node.fire('dragmove',{type:'dragmove',target:node,evt:evt},true);}},_endDragBefore:function _endDragBefore(evt){var dd=Konva.DD,node=dd.node,layer;if(node){layer=node.getLayer();dd.anim.stop();if(dd.isDragging){dd.isDragging=false;dd.justDragged=true;Konva.listenClickTap=false;if(evt){evt.dragEndNode=node;}}delete dd.node;(layer||node).draw();}},_endDragAfter:function _endDragAfter(evt){evt=evt||{};var dragEndNode=evt.dragEndNode;if(evt&&dragEndNode){dragEndNode.fire('dragend',{type:'dragend',target:dragEndNode,evt:evt},true);}}};Konva.Node.prototype.startDrag=function(){var dd=Konva.DD,stage=this.getStage(),layer=this.getLayer(),pos=stage.getPointerPosition(),ap=this.getAbsolutePosition();if(pos){if(dd.node){dd.node.stopDrag();}dd.node=this;dd.startPointerPos=pos;dd.offset.x=pos.x-ap.x;dd.offset.y=pos.y-ap.y;dd.anim.setLayers(layer||this.getLayers());dd.anim.start();this._setDragPosition();}};Konva.Node.prototype._setDragPosition=function(evt){var dd=Konva.DD,pos=this.getStage().getPointerPosition(),dbf=this.getDragBoundFunc();if(!pos){return;}var newNodePos={x:pos.x-dd.offset.x,y:pos.y-dd.offset.y};if(dbf!==undefined){newNodePos=dbf.call(this,newNodePos,evt);}this.setAbsolutePosition(newNodePos);if(!this._lastPos||this._lastPos.x!==newNodePos.x||this._lastPos.y!==newNodePos.y){dd.anim.dirty=true;}this._lastPos=newNodePos;};Konva.Node.prototype.stopDrag=function(){var dd=Konva.DD,evt={};dd._endDragBefore(evt);dd._endDragAfter(evt);};Konva.Node.prototype.setDraggable=function(draggable){this._setAttr('draggable',draggable);this._dragChange();};var origDestroy=Konva.Node.prototype.destroy;Konva.Node.prototype.destroy=function(){var dd=Konva.DD;if(dd.node&&dd.node._id===this._id){this.stopDrag();}origDestroy.call(this);};Konva.Node.prototype.isDragging=function(){var dd=Konva.DD;return!!(dd.node&&dd.node._id===this._id&&dd.isDragging);};Konva.Node.prototype._listenDrag=function(){var that=this;this._dragCleanup();if(this.getClassName()==='Stage'){this.on('contentMousedown.konva contentTouchstart.konva',function(evt){if(!Konva.DD.node){that.startDrag(evt);}});}else{this.on('mousedown.konva touchstart.konva',function(evt){if(evt.evt.button===1||evt.evt.button===2){return;}if(!Konva.DD.node){that.startDrag(evt);}});}};Konva.Node.prototype._dragChange=function(){if(this.attrs.draggable){this._listenDrag();}else{this._dragCleanup();var stage=this.getStage();var dd=Konva.DD;if(stage&&dd.node&&dd.node._id===this._id){dd.node.stopDrag();}}};Konva.Node.prototype._dragCleanup=function(){if(this.getClassName()==='Stage'){this.off('contentMousedown.konva');this.off('contentTouchstart.konva');}else{this.off('mousedown.konva');this.off('touchstart.konva');}};Konva.Factory.addGetterSetter(Konva.Node,'dragBoundFunc');Konva.Factory.addGetter(Konva.Node,'draggable',false);Konva.Factory.addOverloadedGetterSetter(Konva.Node,'draggable');var html=Konva.document.documentElement;html.addEventListener('mouseup',Konva.DD._endDragBefore,true);html.addEventListener('touchend',Konva.DD._endDragBefore,true);html.addEventListener('mousemove',Konva.DD._drag);html.addEventListener('touchmove',Konva.DD._drag);html.addEventListener('mouseup',Konva.DD._endDragAfter,false);html.addEventListener('touchend',Konva.DD._endDragAfter,false);})();(function(){'use strict';Konva.Rect=function(config){this.___init(config);};Konva.Rect.prototype={___init:function ___init(config){Konva.Shape.call(this,config);this.className='Rect';this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){var cornerRadius=this.getCornerRadius(),width=this.getWidth(),height=this.getHeight();context.beginPath();if(!cornerRadius){context.rect(0,0,width,height);}else{cornerRadius=Math.min(cornerRadius,width/2,height/2);context.moveTo(cornerRadius,0);context.lineTo(width-cornerRadius,0);context.arc(width-cornerRadius,cornerRadius,cornerRadius,Math.PI*3/2,0,false);context.lineTo(width,height-cornerRadius);context.arc(width-cornerRadius,height-cornerRadius,cornerRadius,0,Math.PI/2,false);context.lineTo(cornerRadius,height);context.arc(cornerRadius,height-cornerRadius,cornerRadius,Math.PI/2,Math.PI,false);context.lineTo(0,cornerRadius);context.arc(cornerRadius,cornerRadius,cornerRadius,Math.PI,Math.PI*3/2,false);}context.closePath();context.fillStrokeShape(this);}};Konva.Util.extend(Konva.Rect,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Rect,'cornerRadius',0);Konva.Collection.mapMethods(Konva.Rect);})();(function(){'use strict';var PIx2=Math.PI*2-0.0001,CIRCLE='Circle';Konva.Circle=function(config){this.___init(config);};Konva.Circle.prototype={_centroid:true,___init:function ___init(config){Konva.Shape.call(this,config);this.className=CIRCLE;this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){context.beginPath();context.arc(0,0,this.getRadius(),0,PIx2,false);context.closePath();context.fillStrokeShape(this);},getWidth:function getWidth(){return this.getRadius()*2;},getHeight:function getHeight(){return this.getRadius()*2;},setWidth:function setWidth(width){Konva.Node.prototype.setWidth.call(this,width);if(this.radius()!==width/2){this.setRadius(width/2);}},setHeight:function setHeight(height){Konva.Node.prototype.setHeight.call(this,height);if(this.radius()!==height/2){this.setRadius(height/2);}}};Konva.Util.extend(Konva.Circle,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Circle,'radius',0);Konva.Factory.addOverloadedGetterSetter(Konva.Circle,'radius');Konva.Collection.mapMethods(Konva.Circle);})();(function(){'use strict';var PIx2=Math.PI*2-0.0001,ELLIPSE='Ellipse';Konva.Ellipse=function(config){this.___init(config);};Konva.Ellipse.prototype={_centroid:true,___init:function ___init(config){Konva.Shape.call(this,config);this.className=ELLIPSE;this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){var rx=this.getRadiusX(),ry=this.getRadiusY();context.beginPath();context.save();if(rx!==ry){context.scale(1,ry/rx);}context.arc(0,0,rx,0,PIx2,false);context.restore();context.closePath();context.fillStrokeShape(this);},getWidth:function getWidth(){return this.getRadiusX()*2;},getHeight:function getHeight(){return this.getRadiusY()*2;},setWidth:function setWidth(width){Konva.Node.prototype.setWidth.call(this,width);this.setRadius({x:width/2});},setHeight:function setHeight(height){Konva.Node.prototype.setHeight.call(this,height);this.setRadius({y:height/2});}};Konva.Util.extend(Konva.Ellipse,Konva.Shape);Konva.Factory.addComponentsGetterSetter(Konva.Ellipse,'radius',['x','y']);Konva.Factory.addGetterSetter(Konva.Ellipse,'radiusX',0);Konva.Factory.addGetterSetter(Konva.Ellipse,'radiusY',0);Konva.Collection.mapMethods(Konva.Ellipse);})();(function(){'use strict';var PIx2=Math.PI*2-0.0001;Konva.Ring=function(config){this.___init(config);};Konva.Ring.prototype={_centroid:true,___init:function ___init(config){Konva.Shape.call(this,config);this.className='Ring';this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){context.beginPath();context.arc(0,0,this.getInnerRadius(),0,PIx2,false);context.moveTo(this.getOuterRadius(),0);context.arc(0,0,this.getOuterRadius(),PIx2,0,true);context.closePath();context.fillStrokeShape(this);},getWidth:function getWidth(){return this.getOuterRadius()*2;},getHeight:function getHeight(){return this.getOuterRadius()*2;},setWidth:function setWidth(width){Konva.Node.prototype.setWidth.call(this,width);if(this.outerRadius()!==width/2){this.setOuterRadius(width/2);}},setHeight:function setHeight(height){Konva.Node.prototype.setHeight.call(this,height);if(this.outerRadius()!==height/2){this.setOuterRadius(height/2);}},setOuterRadius:function setOuterRadius(val){this._setAttr('outerRadius',val);this.setWidth(val*2);this.setHeight(val*2);}};Konva.Util.extend(Konva.Ring,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Ring,'innerRadius',0);Konva.Factory.addGetter(Konva.Ring,'outerRadius',0);Konva.Factory.addOverloadedGetterSetter(Konva.Ring,'outerRadius');Konva.Collection.mapMethods(Konva.Ring);})();(function(){'use strict';Konva.Wedge=function(config){this.___init(config);};Konva.Wedge.prototype={_centroid:true,___init:function ___init(config){Konva.Shape.call(this,config);this.className='Wedge';this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){context.beginPath();context.arc(0,0,this.getRadius(),0,Konva.getAngle(this.getAngle()),this.getClockwise());context.lineTo(0,0);context.closePath();context.fillStrokeShape(this);},getWidth:function getWidth(){return this.getRadius()*2;},getHeight:function getHeight(){return this.getRadius()*2;},setWidth:function setWidth(width){Konva.Node.prototype.setWidth.call(this,width);if(this.radius()!==width/2){this.setRadius(width/2);}},setHeight:function setHeight(height){Konva.Node.prototype.setHeight.call(this,height);if(this.radius()!==height/2){this.setRadius(height/2);}}};Konva.Util.extend(Konva.Wedge,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Wedge,'radius',0);Konva.Factory.addGetterSetter(Konva.Wedge,'angle',0);Konva.Factory.addGetterSetter(Konva.Wedge,'clockwise',false);Konva.Factory.backCompat(Konva.Wedge,{angleDeg:'angle',getAngleDeg:'getAngle',setAngleDeg:'setAngle'});Konva.Collection.mapMethods(Konva.Wedge);})();(function(){'use strict';Konva.Arc=function(config){this.___init(config);};Konva.Arc.prototype={_centroid:true,___init:function ___init(config){Konva.Shape.call(this,config);this.className='Arc';this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){var angle=Konva.getAngle(this.angle()),clockwise=this.clockwise();context.beginPath();context.arc(0,0,this.getOuterRadius(),0,angle,clockwise);context.arc(0,0,this.getInnerRadius(),angle,0,!clockwise);context.closePath();context.fillStrokeShape(this);},getWidth:function getWidth(){return this.getOuterRadius()*2;},getHeight:function getHeight(){return this.getOuterRadius()*2;},setWidth:function setWidth(width){Konva.Node.prototype.setWidth.call(this,width);if(this.getOuterRadius()!==width/2){this.setOuterRadius(width/2);}},setHeight:function setHeight(height){Konva.Node.prototype.setHeight.call(this,height);if(this.getOuterRadius()!==height/2){this.setOuterRadius(height/2);}}};Konva.Util.extend(Konva.Arc,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Arc,'innerRadius',0);Konva.Factory.addGetterSetter(Konva.Arc,'outerRadius',0);Konva.Factory.addGetterSetter(Konva.Arc,'angle',0);Konva.Factory.addGetterSetter(Konva.Arc,'clockwise',false);Konva.Collection.mapMethods(Konva.Arc);})();(function(){'use strict';var IMAGE='Image';Konva.Image=function(config){this.___init(config);};Konva.Image.prototype={___init:function ___init(config){Konva.Shape.call(this,config);this.className=IMAGE;this.sceneFunc(this._sceneFunc);this.hitFunc(this._hitFunc);},_useBufferCanvas:function _useBufferCanvas(){return(this.hasShadow()||this.getAbsoluteOpacity()!==1)&&this.hasStroke()&&this.getStage();},_sceneFunc:function _sceneFunc(context){var width=this.getWidth(),height=this.getHeight(),image=this.getImage(),cropWidth,cropHeight,params;if(image){cropWidth=this.getCropWidth();cropHeight=this.getCropHeight();if(cropWidth&&cropHeight){params=[image,this.getCropX(),this.getCropY(),cropWidth,cropHeight,0,0,width,height];}else{params=[image,0,0,width,height];}}if(this.hasFill()||this.hasStroke()){context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this);}if(image){context.drawImage.apply(context,params);}},_hitFunc:function _hitFunc(context){var width=this.getWidth(),height=this.getHeight();context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this);},getWidth:function getWidth(){var image=this.getImage();return this.attrs.width||(image?image.width:0);},getHeight:function getHeight(){var image=this.getImage();return this.attrs.height||(image?image.height:0);}};Konva.Util.extend(Konva.Image,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Image,'image');Konva.Factory.addComponentsGetterSetter(Konva.Image,'crop',['x','y','width','height']);Konva.Factory.addGetterSetter(Konva.Image,'cropX',0);Konva.Factory.addGetterSetter(Konva.Image,'cropY',0);Konva.Factory.addGetterSetter(Konva.Image,'cropWidth',0);Konva.Factory.addGetterSetter(Konva.Image,'cropHeight',0);Konva.Collection.mapMethods(Konva.Image);Konva.Image.fromURL=function(url,callback){var img=new Image();img.onload=function(){var image=new Konva.Image({image:img});callback(image);};img.src=url;};})();(function(){'use strict';var AUTO='auto',CENTER='center',CHANGE_KONVA='Change.konva',CONTEXT_2D='2d',DASH='-',EMPTY_STRING='',LEFT='left',TEXT='text',TEXT_UPPER='Text',MIDDLE='middle',NORMAL='normal',PX_SPACE='px ',SPACE=' ',RIGHT='right',WORD='word',CHAR='char',NONE='none',ATTR_CHANGE_LIST=['fontFamily','fontSize','fontStyle','fontVariant','padding','align','lineHeight','text','width','height','wrap'],attrChangeListLen=ATTR_CHANGE_LIST.length,dummyContext=Konva.Util.createCanvasElement().getContext(CONTEXT_2D);Konva.Text=function(config){this.___init(config);};function _fillFunc(context){context.fillText(this.partialText,0,0);}function _strokeFunc(context){context.strokeText(this.partialText,0,0);}Konva.Text.prototype={___init:function ___init(config){config=config||{};if(!config.fillLinearGradientColorStops&&!config.fillRadialGradientColorStops){config.fill=config.fill||'black';}if(config.width===undefined){config.width=AUTO;}if(config.height===undefined){config.height=AUTO;}
Konva.Shape.call(this,config);this._fillFunc=_fillFunc;this._strokeFunc=_strokeFunc;this.className=TEXT_UPPER;for(var n=0;n<attrChangeListLen;n++){this.on(ATTR_CHANGE_LIST[n]+CHANGE_KONVA,this._setTextData);}this._setTextData();this.sceneFunc(this._sceneFunc);this.hitFunc(this._hitFunc);},_sceneFunc:function _sceneFunc(context){var p=this.getPadding(),textHeight=this.getTextHeight(),lineHeightPx=this.getLineHeight()*textHeight,textArr=this.textArr,textArrLen=textArr.length,totalWidth=this.getWidth(),n;context.setAttr('font',this._getContextFont());context.setAttr('textBaseline',MIDDLE);context.setAttr('textAlign',LEFT);context.save();if(p){context.translate(p,0);context.translate(0,p+textHeight/2);}else{context.translate(0,textHeight/2);}
for(n=0;n<textArrLen;n++){var obj=textArr[n],text=obj.text,width=obj.width;context.save();if(this.getAlign()===RIGHT){context.translate(totalWidth-width-p*2,0);}else if(this.getAlign()===CENTER){context.translate((totalWidth-width-p*2)/2,0);}this.partialText=text;context.fillStrokeShape(this);context.restore();context.translate(0,lineHeightPx);}context.restore();},_hitFunc:function _hitFunc(context){var width=this.getWidth(),height=this.getHeight();context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this);},setText:function setText(text){var str=Konva.Util._isString(text)?text:text.toString();this._setAttr(TEXT,str);return this;},getWidth:function getWidth(){return this.attrs.width===AUTO?this.getTextWidth()+this.getPadding()*2:this.attrs.width;},getHeight:function getHeight(){return this.attrs.height===AUTO?this.getTextHeight()*this.textArr.length*this.getLineHeight()+this.getPadding()*2:this.attrs.height;},getTextWidth:function getTextWidth(){return this.textWidth;},getTextHeight:function getTextHeight(){return this.textHeight;},_getTextSize:function _getTextSize(text){var _context=dummyContext,fontSize=this.getFontSize(),metrics;_context.save();_context.font=this._getContextFont();metrics=_context.measureText(text);_context.restore();return{width:metrics.width,height:parseInt(fontSize,10)};},_getContextFont:function _getContextFont(){return this.getFontStyle()+SPACE+this.getFontVariant()+SPACE+this.getFontSize()+PX_SPACE+this.getFontFamily();},_addTextLine:function _addTextLine(line,width){return this.textArr.push({text:line,width:width});},_getTextWidth:function _getTextWidth(text){return dummyContext.measureText(text).width;},_setTextData:function _setTextData(){var lines=this.getText().split('\n'),fontSize=+this.getFontSize(),textWidth=0,lineHeightPx=this.getLineHeight()*fontSize,width=this.attrs.width,height=this.attrs.height,fixedWidth=width!==AUTO,fixedHeight=height!==AUTO,padding=this.getPadding(),maxWidth=width-padding*2,maxHeightPx=height-padding*2,currentHeightPx=0,wrap=this.getWrap(),shouldWrap=wrap!==NONE,wrapAtWord=wrap!==CHAR&&shouldWrap;this.textArr=[];dummyContext.save();dummyContext.font=this._getContextFont();for(var i=0,max=lines.length;i<max;++i){var line=lines[i],lineWidth=this._getTextWidth(line);if(fixedWidth&&lineWidth>maxWidth){while(line.length>0){var low=0,high=line.length,match='',matchWidth=0;while(low<high){var mid=low+high>>>1,substr=line.slice(0,mid+1),substrWidth=this._getTextWidth(substr);if(substrWidth<=maxWidth){low=mid+1;match=substr;matchWidth=substrWidth;}else{high=mid;}}if(match){if(wrapAtWord){var wrapIndex=Math.max(match.lastIndexOf(SPACE),match.lastIndexOf(DASH))+1;if(wrapIndex>0){low=wrapIndex;match=match.slice(0,low);matchWidth=this._getTextWidth(match);}}this._addTextLine(match,matchWidth);textWidth=Math.max(textWidth,matchWidth);currentHeightPx+=lineHeightPx;if(!shouldWrap||fixedHeight&&currentHeightPx+lineHeightPx>maxHeightPx){break;}line=line.slice(low);if(line.length>0){lineWidth=this._getTextWidth(line);if(lineWidth<=maxWidth){this._addTextLine(line,lineWidth);currentHeightPx+=lineHeightPx;textWidth=Math.max(textWidth,lineWidth);break;}}}else{break;}}}else{this._addTextLine(line,lineWidth);currentHeightPx+=lineHeightPx;textWidth=Math.max(textWidth,lineWidth);}
if(fixedHeight&&currentHeightPx+lineHeightPx>maxHeightPx){break;}}dummyContext.restore();this.textHeight=fontSize;this.textWidth=textWidth;}};Konva.Util.extend(Konva.Text,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Text,'fontFamily','Arial');Konva.Factory.addGetterSetter(Konva.Text,'fontSize',12);Konva.Factory.addGetterSetter(Konva.Text,'fontStyle',NORMAL);Konva.Factory.addGetterSetter(Konva.Text,'fontVariant',NORMAL);Konva.Factory.addGetterSetter(Konva.Text,'padding',0);Konva.Factory.addGetterSetter(Konva.Text,'align',LEFT);Konva.Factory.addGetterSetter(Konva.Text,'lineHeight',1);Konva.Factory.addGetterSetter(Konva.Text,'wrap',WORD);Konva.Factory.addGetter(Konva.Text,'text',EMPTY_STRING);Konva.Factory.addOverloadedGetterSetter(Konva.Text,'text');Konva.Collection.mapMethods(Konva.Text);})();(function(){'use strict';Konva.Line=function(config){this.___init(config);};Konva.Line.prototype={___init:function ___init(config){Konva.Shape.call(this,config);this.className='Line';this.on('pointsChange.konva tensionChange.konva closedChange.konva',function(){this._clearCache('tensionPoints');});this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){var points=this.getPoints(),length=points.length,tension=this.getTension(),closed=this.getClosed(),tp,len,n;if(!length){return;}context.beginPath();context.moveTo(points[0],points[1]);if(tension!==0&&length>4){tp=this.getTensionPoints();len=tp.length;n=closed?0:4;if(!closed){context.quadraticCurveTo(tp[0],tp[1],tp[2],tp[3]);}while(n<len-2){context.bezierCurveTo(tp[n++],tp[n++],tp[n++],tp[n++],tp[n++],tp[n++]);}if(!closed){context.quadraticCurveTo(tp[len-2],tp[len-1],points[length-2],points[length-1]);}}
else{for(n=2;n<length;n+=2){context.lineTo(points[n],points[n+1]);}}
if(closed){context.closePath();context.fillStrokeShape(this);}
else{context.strokeShape(this);}},getTensionPoints:function getTensionPoints(){return this._getCache('tensionPoints',this._getTensionPoints);},_getTensionPoints:function _getTensionPoints(){if(this.getClosed()){return this._getTensionPointsClosed();}else{return Konva.Util._expandPoints(this.getPoints(),this.getTension());}},_getTensionPointsClosed:function _getTensionPointsClosed(){var p=this.getPoints(),len=p.length,tension=this.getTension(),util=Konva.Util,firstControlPoints=util._getControlPoints(p[len-2],p[len-1],p[0],p[1],p[2],p[3],tension),lastControlPoints=util._getControlPoints(p[len-4],p[len-3],p[len-2],p[len-1],p[0],p[1],tension),middle=Konva.Util._expandPoints(p,tension),tp=[firstControlPoints[2],firstControlPoints[3]].concat(middle).concat([lastControlPoints[0],lastControlPoints[1],p[len-2],p[len-1],lastControlPoints[2],lastControlPoints[3],firstControlPoints[0],firstControlPoints[1],p[0],p[1]]);return tp;},getWidth:function getWidth(){return this.getSelfRect().width;},getHeight:function getHeight(){return this.getSelfRect().height;},getSelfRect:function getSelfRect(){var points;if(this.getTension()!==0){points=this._getTensionPoints();}else{points=this.getPoints();}var minX=points[0];var maxX=points[0];var minY=points[1];var maxY=points[1];var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y);}return{x:Math.round(minX),y:Math.round(minY),width:Math.round(maxX-minX),height:Math.round(maxY-minY)};}};Konva.Util.extend(Konva.Line,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Line,'closed',false);Konva.Factory.addGetterSetter(Konva.Line,'tension',0);Konva.Factory.addGetterSetter(Konva.Line,'points',[]);Konva.Collection.mapMethods(Konva.Line);})();(function(){'use strict';Konva.Sprite=function(config){this.___init(config);};Konva.Sprite.prototype={___init:function ___init(config){Konva.Shape.call(this,config);this.className='Sprite';this._updated=true;var that=this;this.anim=new Konva.Animation(function(){var updated=that._updated;that._updated=false;return updated;});this.on('animationChange.konva',function(){this.frameIndex(0);});this.on('frameIndexChange.konva',function(){this._updated=true;});this.on('frameRateChange.konva',function(){if(!this.anim.isRunning()){return;}clearInterval(this.interval);this._setInterval();});this.sceneFunc(this._sceneFunc);this.hitFunc(this._hitFunc);},_sceneFunc:function _sceneFunc(context){var anim=this.getAnimation(),index=this.frameIndex(),ix4=index*4,set=this.getAnimations()[anim],offsets=this.frameOffsets(),x=set[ix4+0],y=set[ix4+1],width=set[ix4+2],height=set[ix4+3],shapeWidth=this.width(),shapeHeight=this.height(),image=this.getImage();if(this.hasFill()||this.hasStroke()){context.beginPath();context.rect(0,0,shapeWidth,shapeHeight);context.closePath();context.fillStrokeShape(this);}if(image){if(offsets){var offset=offsets[anim],ix2=index*2;context.drawImage(image,x,y,width,height,offset[ix2+0],offset[ix2+1],shapeWidth,shapeHeight);}else{context.drawImage(image,x,y,width,height,0,0,shapeWidth,shapeHeight);}}},_hitFunc:function _hitFunc(context){var anim=this.getAnimation(),index=this.frameIndex(),ix4=index*4,set=this.getAnimations()[anim],offsets=this.frameOffsets(),shapeWidth=this.width(),shapeHeight=this.height();context.beginPath();if(offsets){var offset=offsets[anim];var ix2=index*2;context.rect(offset[ix2+0],offset[ix2+1],shapeWidth,shapeHeight);}else{context.rect(0,0,shapeWidth,shapeHeight);}context.closePath();context.fillShape(this);},_useBufferCanvas:function _useBufferCanvas(){return(this.hasShadow()||this.getAbsoluteOpacity()!==1)&&this.hasStroke();},_setInterval:function _setInterval(){var that=this;this.interval=setInterval(function(){that._updateIndex();},1000/this.getFrameRate());},start:function start(){var layer=this.getLayer();this.anim.setLayers(layer);this._setInterval();this.anim.start();},stop:function stop(){this.anim.stop();clearInterval(this.interval);},isRunning:function isRunning(){return this.anim.isRunning();},_updateIndex:function _updateIndex(){var index=this.frameIndex(),animation=this.getAnimation(),animations=this.getAnimations(),anim=animations[animation],len=anim.length/4;if(index<len-1){this.frameIndex(index+1);}else{this.frameIndex(0);}}};Konva.Util.extend(Konva.Sprite,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Sprite,'animation');Konva.Factory.addGetterSetter(Konva.Sprite,'animations');Konva.Factory.addGetterSetter(Konva.Sprite,'frameOffsets');Konva.Factory.addGetterSetter(Konva.Sprite,'image');Konva.Factory.addGetterSetter(Konva.Sprite,'frameIndex',0);Konva.Factory.addGetterSetter(Konva.Sprite,'frameRate',17);Konva.Factory.backCompat(Konva.Sprite,{index:'frameIndex',getIndex:'getFrameIndex',setIndex:'setFrameIndex'});Konva.Collection.mapMethods(Konva.Sprite);})();(function(){'use strict';Konva.Path=function(config){this.___init(config);};Konva.Path.prototype={___init:function ___init(config){this.dataArray=[];var that=this;Konva.Shape.call(this,config);this.className='Path';this.dataArray=Konva.Path.parsePathData(this.getData());this.on('dataChange.konva',function(){that.dataArray=Konva.Path.parsePathData(this.getData());});this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){var ca=this.dataArray,closedPath=false;context.beginPath();for(var n=0;n<ca.length;n++){var c=ca[n].command;var p=ca[n].points;switch(c){case'L':context.lineTo(p[0],p[1]);break;case'M':context.moveTo(p[0],p[1]);break;case'C':context.bezierCurveTo(p[0],p[1],p[2],p[3],p[4],p[5]);break;case'Q':context.quadraticCurveTo(p[0],p[1],p[2],p[3]);break;case'A':var cx=p[0],cy=p[1],rx=p[2],ry=p[3],theta=p[4],dTheta=p[5],psi=p[6],fs=p[7];var r=rx>ry?rx:ry;var scaleX=rx>ry?1:rx/ry;var scaleY=rx>ry?ry/rx:1;context.translate(cx,cy);context.rotate(psi);context.scale(scaleX,scaleY);context.arc(0,0,r,theta,theta+dTheta,1-fs);context.scale(1/scaleX,1/scaleY);context.rotate(-psi);context.translate(-cx,-cy);break;case'z':context.closePath();closedPath=true;break;}}if(closedPath){context.fillStrokeShape(this);}else{context.strokeShape(this);}},getSelfRect:function getSelfRect(){var points=[];this.dataArray.forEach(function(data){points=points.concat(data.points);});var minX=points[0];var maxX=points[0];var minY=points[0];var maxY=points[0];var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y);}return{x:Math.round(minX),y:Math.round(minY),width:Math.round(maxX-minX),height:Math.round(maxY-minY)};}};Konva.Util.extend(Konva.Path,Konva.Shape);Konva.Path.getLineLength=function(x1,y1,x2,y2){return Math.sqrt((x2-x1)*(x2-x1)+(y2-y1)*(y2-y1));};Konva.Path.getPointOnLine=function(dist,P1x,P1y,P2x,P2y,fromX,fromY){if(fromX===undefined){fromX=P1x;}if(fromY===undefined){fromY=P1y;}var m=(P2y-P1y)/(P2x-P1x+0.00000001);var run=Math.sqrt(dist*dist/(1+m*m));if(P2x<P1x){run*=-1;}var rise=m*run;var pt;if(P2x===P1x){pt={x:fromX,y:fromY+rise};}else if((fromY-P1y)/(fromX-P1x+0.00000001)===m){pt={x:fromX+run,y:fromY+rise};}else{var ix,iy;var len=this.getLineLength(P1x,P1y,P2x,P2y);if(len<0.00000001){return undefined;}var u=(fromX-P1x)*(P2x-P1x)+(fromY-P1y)*(P2y-P1y);u=u/(len*len);ix=P1x+u*(P2x-P1x);iy=P1y+u*(P2y-P1y);var pRise=this.getLineLength(fromX,fromY,ix,iy);var pRun=Math.sqrt(dist*dist-pRise*pRise);run=Math.sqrt(pRun*pRun/(1+m*m));if(P2x<P1x){run*=-1;}rise=m*run;pt={x:ix+run,y:iy+rise};}return pt;};Konva.Path.getPointOnCubicBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y,P4x,P4y){function CB1(t){return t*t*t;}function CB2(t){return 3*t*t*(1-t);}function CB3(t){return 3*t*(1-t)*(1-t);}function CB4(t){return(1-t)*(1-t)*(1-t);}var x=P4x*CB1(pct)+P3x*CB2(pct)+P2x*CB3(pct)+P1x*CB4(pct);var y=P4y*CB1(pct)+P3y*CB2(pct)+P2y*CB3(pct)+P1y*CB4(pct);return{x:x,y:y};};Konva.Path.getPointOnQuadraticBezier=function(pct,P1x,P1y,P2x,P2y,P3x,P3y){function QB1(t){return t*t;}function QB2(t){return 2*t*(1-t);}function QB3(t){return(1-t)*(1-t);}var x=P3x*QB1(pct)+P2x*QB2(pct)+P1x*QB3(pct);var y=P3y*QB1(pct)+P2y*QB2(pct)+P1y*QB3(pct);return{x:x,y:y};};Konva.Path.getPointOnEllipticalArc=function(cx,cy,rx,ry,theta,psi){var cosPsi=Math.cos(psi),sinPsi=Math.sin(psi);var pt={x:rx*Math.cos(theta),y:ry*Math.sin(theta)};return{x:cx+(pt.x*cosPsi-pt.y*sinPsi),y:cy+(pt.x*sinPsi+pt.y*cosPsi)};};Konva.Path.parsePathData=function(data){if(!data){return[];}
var cs=data;var cc=['m','M','l','L','v','V','h','H','z','Z','c','C','q','Q','t','T','s','S','a','A'];cs=cs.replace(new RegExp(' ','g'),',');for(var n=0;n<cc.length;n++){cs=cs.replace(new RegExp(cc[n],'g'),'|'+cc[n]);}
var arr=cs.split('|');var ca=[];var cpx=0;var cpy=0;for(n=1;n<arr.length;n++){var str=arr[n];var c=str.charAt(0);str=str.slice(1);str=str.replace(new RegExp(',-','g'),'-');str=str.replace(new RegExp('-','g'),',-');str=str.replace(new RegExp('e,-','g'),'e-');var p=str.split(',');if(p.length>0&&p[0]===''){p.shift();}
for(var i=0;i<p.length;i++){p[i]=parseFloat(p[i]);}while(p.length>0){if(isNaN(p[0])){break;}var cmd=null;var points=[];var startX=cpx,startY=cpy;var prevCmd,ctlPtx,ctlPty;var rx,ry,psi,fa,fs,x1,y1;switch(c){case'l':cpx+=p.shift();cpy+=p.shift();cmd='L';points.push(cpx,cpy);break;case'L':cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'm':var dx=p.shift();var dy=p.shift();cpx+=dx;cpy+=dy;cmd='M';if(ca.length>2&&ca[ca.length-1].command==='z'){for(var idx=ca.length-2;idx>=0;idx--){if(ca[idx].command==='M'){cpx=ca[idx].points[0]+dx;cpy=ca[idx].points[1]+dy;break;}}}points.push(cpx,cpy);c='l';break;case'M':cpx=p.shift();cpy=p.shift();cmd='M';points.push(cpx,cpy);c='L';break;case'h':cpx+=p.shift();cmd='L';points.push(cpx,cpy);break;case'H':cpx=p.shift();cmd='L';points.push(cpx,cpy);break;case'v':cpy+=p.shift();cmd='L';points.push(cpx,cpy);break;case'V':cpy=p.shift();cmd='L';points.push(cpx,cpy);break;case'C':points.push(p.shift(),p.shift(),p.shift(),p.shift());cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'c':points.push(cpx+p.shift(),cpy+p.shift(),cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='C';points.push(cpx,cpy);break;case'S':ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==='C'){ctlPtx=cpx+(cpx-prevCmd.points[2]);ctlPty=cpy+(cpy-prevCmd.points[3]);}points.push(ctlPtx,ctlPty,p.shift(),p.shift());cpx=p.shift();cpy=p.shift();cmd='C';points.push(cpx,cpy);break;case's':ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==='C'){ctlPtx=cpx+(cpx-prevCmd.points[2]);ctlPty=cpy+(cpy-prevCmd.points[3]);}points.push(ctlPtx,ctlPty,cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='C';points.push(cpx,cpy);break;case'Q':points.push(p.shift(),p.shift());cpx=p.shift();cpy=p.shift();points.push(cpx,cpy);break;case'q':points.push(cpx+p.shift(),cpy+p.shift());cpx+=p.shift();cpy+=p.shift();cmd='Q';points.push(cpx,cpy);break;case'T':ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==='Q'){ctlPtx=cpx+(cpx-prevCmd.points[0]);ctlPty=cpy+(cpy-prevCmd.points[1]);}cpx=p.shift();cpy=p.shift();cmd='Q';points.push(ctlPtx,ctlPty,cpx,cpy);break;case't':ctlPtx=cpx;ctlPty=cpy;prevCmd=ca[ca.length-1];if(prevCmd.command==='Q'){ctlPtx=cpx+(cpx-prevCmd.points[0]);ctlPty=cpy+(cpy-prevCmd.points[1]);}cpx+=p.shift();cpy+=p.shift();cmd='Q';points.push(ctlPtx,ctlPty,cpx,cpy);break;case'A':rx=p.shift();ry=p.shift();psi=p.shift();fa=p.shift();fs=p.shift();x1=cpx;y1=cpy;cpx=p.shift();cpy=p.shift();cmd='A';points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;case'a':rx=p.shift();ry=p.shift();psi=p.shift();fa=p.shift();fs=p.shift();x1=cpx;y1=cpy;cpx+=p.shift();cpy+=p.shift();cmd='A';points=this.convertEndpointToCenterParameterization(x1,y1,cpx,cpy,fa,fs,rx,ry,psi);break;}ca.push({command:cmd||c,points:points,start:{x:startX,y:startY},pathLength:this.calcLength(startX,startY,cmd||c,points)});}if(c==='z'||c==='Z'){ca.push({command:'z',points:[],start:undefined,pathLength:0});}}return ca;};Konva.Path.calcLength=function(x,y,cmd,points){var len,p1,p2,t;var path=Konva.Path;switch(cmd){case'L':return path.getLineLength(x,y,points[0],points[1]);case'C':len=0.0;p1=path.getPointOnCubicBezier(0,x,y,points[0],points[1],points[2],points[3],points[4],points[5]);for(t=0.01;t<=1;t+=0.01){p2=path.getPointOnCubicBezier(t,x,y,points[0],points[1],points[2],points[3],points[4],points[5]);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}return len;case'Q':len=0.0;p1=path.getPointOnQuadraticBezier(0,x,y,points[0],points[1],points[2],points[3]);for(t=0.01;t<=1;t+=0.01){p2=path.getPointOnQuadraticBezier(t,x,y,points[0],points[1],points[2],points[3]);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}return len;case'A':len=0.0;var start=points[4];var dTheta=points[5];var end=points[4]+dTheta;var inc=Math.PI/180.0;if(Math.abs(start-end)<inc){inc=Math.abs(start-end);}
p1=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],start,0);if(dTheta<0){for(t=start-inc;t>end;t-=inc){p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}}else{for(t=start+inc;t<end;t+=inc){p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],t,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);p1=p2;}}p2=path.getPointOnEllipticalArc(points[0],points[1],points[2],points[3],end,0);len+=path.getLineLength(p1.x,p1.y,p2.x,p2.y);return len;}return 0;};Konva.Path.convertEndpointToCenterParameterization=function(x1,y1,x2,y2,fa,fs,rx,ry,psiDeg){var psi=psiDeg*(Math.PI/180.0);var xp=Math.cos(psi)*(x1-x2)/2.0+Math.sin(psi)*(y1-y2)/2.0;var yp=-1*Math.sin(psi)*(x1-x2)/2.0+Math.cos(psi)*(y1-y2)/2.0;var lambda=xp*xp/(rx*rx)+yp*yp/(ry*ry);if(lambda>1){rx*=Math.sqrt(lambda);ry*=Math.sqrt(lambda);}var f=Math.sqrt((rx*rx*(ry*ry)-rx*rx*(yp*yp)-ry*ry*(xp*xp))/(rx*rx*(yp*yp)+ry*ry*(xp*xp)));if(fa===fs){f*=-1;}if(isNaN(f)){f=0;}var cxp=f*rx*yp/ry;var cyp=f*-ry*xp/rx;var cx=(x1+x2)/2.0+Math.cos(psi)*cxp-Math.sin(psi)*cyp;var cy=(y1+y2)/2.0+Math.sin(psi)*cxp+Math.cos(psi)*cyp;var vMag=function vMag(v){return Math.sqrt(v[0]*v[0]+v[1]*v[1]);};var vRatio=function vRatio(u,v){return(u[0]*v[0]+u[1]*v[1])/(vMag(u)*vMag(v));};var vAngle=function vAngle(u,v){return(u[0]*v[1]<u[1]*v[0]?-1:1)*Math.acos(vRatio(u,v));};var theta=vAngle([1,0],[(xp-cxp)/rx,(yp-cyp)/ry]);var u=[(xp-cxp)/rx,(yp-cyp)/ry];var v=[(-1*xp-cxp)/rx,(-1*yp-cyp)/ry];var dTheta=vAngle(u,v);if(vRatio(u,v)<=-1){dTheta=Math.PI;}if(vRatio(u,v)>=1){dTheta=0;}if(fs===0&&dTheta>0){dTheta=dTheta-2*Math.PI;}if(fs===1&&dTheta<0){dTheta=dTheta+2*Math.PI;}return[cx,cy,rx,ry,theta,dTheta,psi,fs];};Konva.Factory.addGetterSetter(Konva.Path,'data');Konva.Collection.mapMethods(Konva.Path);})();(function(){'use strict';var EMPTY_STRING='',NORMAL='normal';Konva.TextPath=function(config){this.___init(config);};function _fillFunc(context){context.fillText(this.partialText,0,0);}function _strokeFunc(context){context.strokeText(this.partialText,0,0);}Konva.TextPath.prototype={___init:function ___init(config){var that=this;this.dummyCanvas=Konva.Util.createCanvasElement();this.dataArray=[];Konva.Shape.call(this,config);this._fillFunc=_fillFunc;this._strokeFunc=_strokeFunc;this._fillFuncHit=_fillFunc;this._strokeFuncHit=_strokeFunc;this.className='TextPath';this.dataArray=Konva.Path.parsePathData(this.attrs.data);this.on('dataChange.konva',function(){that.dataArray=Konva.Path.parsePathData(this.attrs.data);});this.on('textChange.konva textStroke.konva textStrokeWidth.konva',that._setTextData);that._setTextData();this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){context.setAttr('font',this._getContextFont());context.setAttr('textBaseline','middle');context.setAttr('textAlign','left');context.save();var glyphInfo=this.glyphInfo;for(var i=0;i<glyphInfo.length;i++){context.save();var p0=glyphInfo[i].p0;context.translate(p0.x,p0.y);context.rotate(glyphInfo[i].rotation);this.partialText=glyphInfo[i].text;context.fillStrokeShape(this);context.restore();}context.restore();},getTextWidth:function getTextWidth(){return this.textWidth;},getTextHeight:function getTextHeight(){return this.textHeight;},setText:function setText(text){Konva.Text.prototype.setText.call(this,text);},_getTextSize:function _getTextSize(text){var dummyCanvas=this.dummyCanvas;var _context=dummyCanvas.getContext('2d');_context.save();_context.font=this._getContextFont();var metrics=_context.measureText(text);_context.restore();return{width:metrics.width,height:parseInt(this.attrs.fontSize,10)};},_setTextData:function _setTextData(){var that=this;var size=this._getTextSize(this.attrs.text);this.textWidth=size.width;this.textHeight=size.height;this.glyphInfo=[];var charArr=this.attrs.text.split('');var p0,p1,pathCmd;var pIndex=-1;var currentT=0;var getNextPathSegment=function getNextPathSegment(){currentT=0;var pathData=that.dataArray;for(var j=pIndex+1;j<pathData.length;j++){if(pathData[j].pathLength>0){pIndex=j;return pathData[j];}else if(pathData[j].command==='M'){p0={x:pathData[j].points[0],y:pathData[j].points[1]};}}return{};};var findSegmentToFitCharacter=function findSegmentToFitCharacter(c){var glyphWidth=that._getTextSize(c).width;var currLen=0;var attempts=0;p1=undefined;while(Math.abs(glyphWidth-currLen)/glyphWidth>0.01&&attempts<25){attempts++;var cumulativePathLength=currLen;while(pathCmd===undefined){pathCmd=getNextPathSegment();if(pathCmd&&cumulativePathLength+pathCmd.pathLength<glyphWidth){cumulativePathLength+=pathCmd.pathLength;pathCmd=undefined;}}if(pathCmd==={}||p0===undefined){return undefined;}var needNewSegment=false;switch(pathCmd.command){case'L':if(Konva.Path.getLineLength(p0.x,p0.y,pathCmd.points[0],pathCmd.points[1])>glyphWidth){p1=Konva.Path.getPointOnLine(glyphWidth,p0.x,p0.y,pathCmd.points[0],pathCmd.points[1],p0.x,p0.y);}else{pathCmd=undefined;}break;case'A':var start=pathCmd.points[4];var dTheta=pathCmd.points[5];var end=pathCmd.points[4]+dTheta;if(currentT===0){currentT=start+0.00000001;}
else if(glyphWidth>currLen){currentT+=Math.PI/180.0*dTheta/Math.abs(dTheta);}else{currentT-=Math.PI/360.0*dTheta/Math.abs(dTheta);}
if(dTheta<0&&currentT<end||dTheta>=0&&currentT>end){currentT=end;needNewSegment=true;}p1=Konva.Path.getPointOnEllipticalArc(pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],currentT,pathCmd.points[6]);break;case'C':if(currentT===0){if(glyphWidth>pathCmd.pathLength){currentT=0.00000001;}else{currentT=glyphWidth/pathCmd.pathLength;}}else if(glyphWidth>currLen){currentT+=(glyphWidth-currLen)/pathCmd.pathLength;}else{currentT-=(currLen-glyphWidth)/pathCmd.pathLength;}if(currentT>1.0){currentT=1.0;needNewSegment=true;}p1=Konva.Path.getPointOnCubicBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3],pathCmd.points[4],pathCmd.points[5]);break;case'Q':if(currentT===0){currentT=glyphWidth/pathCmd.pathLength;}else if(glyphWidth>currLen){currentT+=(glyphWidth-currLen)/pathCmd.pathLength;}else{currentT-=(currLen-glyphWidth)/pathCmd.pathLength;}if(currentT>1.0){currentT=1.0;needNewSegment=true;}p1=Konva.Path.getPointOnQuadraticBezier(currentT,pathCmd.start.x,pathCmd.start.y,pathCmd.points[0],pathCmd.points[1],pathCmd.points[2],pathCmd.points[3]);break;}if(p1!==undefined){currLen=Konva.Path.getLineLength(p0.x,p0.y,p1.x,p1.y);}if(needNewSegment){needNewSegment=false;pathCmd=undefined;}}};for(var i=0;i<charArr.length;i++){findSegmentToFitCharacter(charArr[i]);if(p0===undefined||p1===undefined){break;}var width=Konva.Path.getLineLength(p0.x,p0.y,p1.x,p1.y);var kern=0;var midpoint=Konva.Path.getPointOnLine(kern+width/2.0,p0.x,p0.y,p1.x,p1.y);var rotation=Math.atan2(p1.y-p0.y,p1.x-p0.x);this.glyphInfo.push({transposeX:midpoint.x,transposeY:midpoint.y,text:charArr[i],rotation:rotation,p0:p0,p1:p1});p0=p1;}},getSelfRect:function getSelfRect(){var points=[];var fontSize=this.fontSize();this.glyphInfo.forEach(function(info){points.push(info.p0.x);points.push(info.p0.y);points.push(info.p1.x);points.push(info.p1.y);});var minX=points[0];var maxX=points[0];var minY=points[0];var maxY=points[0];var x,y;for(var i=0;i<points.length/2;i++){x=points[i*2];y=points[i*2+1];minX=Math.min(minX,x);maxX=Math.max(maxX,x);minY=Math.min(minY,y);maxY=Math.max(maxY,y);}return{x:Math.round(minX)-fontSize,y:Math.round(minY)-fontSize,width:Math.round(maxX-minX)+fontSize*2,height:Math.round(maxY-minY)+fontSize*2};}};Konva.TextPath.prototype._getContextFont=Konva.Text.prototype._getContextFont;Konva.Util.extend(Konva.TextPath,Konva.Shape);Konva.Factory.addGetterSetter(Konva.TextPath,'fontFamily','Arial');Konva.Factory.addGetterSetter(Konva.TextPath,'fontSize',12);Konva.Factory.addGetterSetter(Konva.TextPath,'fontStyle',NORMAL);Konva.Factory.addGetterSetter(Konva.TextPath,'fontVariant',NORMAL);Konva.Factory.addGetter(Konva.TextPath,'text',EMPTY_STRING);Konva.Collection.mapMethods(Konva.TextPath);})();(function(){'use strict';Konva.RegularPolygon=function(config){this.___init(config);};Konva.RegularPolygon.prototype={_centroid:true,___init:function ___init(config){Konva.Shape.call(this,config);this.className='RegularPolygon';this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){var sides=this.attrs.sides,radius=this.attrs.radius,n,x,y;context.beginPath();context.moveTo(0,0-radius);for(n=1;n<sides;n++){x=radius*Math.sin(n*2*Math.PI/sides);y=-1*radius*Math.cos(n*2*Math.PI/sides);context.lineTo(x,y);}context.closePath();context.fillStrokeShape(this);},getWidth:function getWidth(){return this.getRadius()*2;},getHeight:function getHeight(){return this.getRadius()*2;},setWidth:function setWidth(width){Konva.Node.prototype.setWidth.call(this,width);if(this.radius()!==width/2){this.setRadius(width/2);}},setHeight:function setHeight(height){Konva.Node.prototype.setHeight.call(this,height);if(this.radius()!==height/2){this.setRadius(height/2);}}};Konva.Util.extend(Konva.RegularPolygon,Konva.Shape);Konva.Factory.addGetterSetter(Konva.RegularPolygon,'radius',0);Konva.Factory.addGetterSetter(Konva.RegularPolygon,'sides',0);Konva.Collection.mapMethods(Konva.RegularPolygon);})();(function(){'use strict';Konva.Star=function(config){this.___init(config);};Konva.Star.prototype={_centroid:true,___init:function ___init(config){Konva.Shape.call(this,config);this.className='Star';this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){var innerRadius=this.innerRadius(),outerRadius=this.outerRadius(),numPoints=this.numPoints();context.beginPath();context.moveTo(0,0-outerRadius);for(var n=1;n<numPoints*2;n++){var radius=n%2===0?outerRadius:innerRadius;var x=radius*Math.sin(n*Math.PI/numPoints);var y=-1*radius*Math.cos(n*Math.PI/numPoints);context.lineTo(x,y);}context.closePath();context.fillStrokeShape(this);},getWidth:function getWidth(){return this.getOuterRadius()*2;},getHeight:function getHeight(){return this.getOuterRadius()*2;},setWidth:function setWidth(width){Konva.Node.prototype.setWidth.call(this,width);if(this.outerRadius()!==width/2){this.setOuterRadius(width/2);}},setHeight:function setHeight(height){Konva.Node.prototype.setHeight.call(this,height);if(this.outerRadius()!==height/2){this.setOuterRadius(height/2);}}};Konva.Util.extend(Konva.Star,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Star,'numPoints',5);Konva.Factory.addGetterSetter(Konva.Star,'innerRadius',0);Konva.Factory.addGetterSetter(Konva.Star,'outerRadius',0);Konva.Collection.mapMethods(Konva.Star);})();(function(){'use strict';var ATTR_CHANGE_LIST=['fontFamily','fontSize','fontStyle','padding','lineHeight','text'],CHANGE_KONVA='Change.konva',NONE='none',UP='up',RIGHT='right',DOWN='down',LEFT='left',LABEL='Label',attrChangeListLen=ATTR_CHANGE_LIST.length;Konva.Label=function(config){this.____init(config);};Konva.Label.prototype={____init:function ____init(config){var that=this;Konva.Group.call(this,config);this.className=LABEL;this.on('add.konva',function(evt){that._addListeners(evt.child);that._sync();});},getText:function getText(){return this.find('Text')[0];},getTag:function getTag(){return this.find('Tag')[0];},_addListeners:function _addListeners(text){var that=this,n;var func=function func(){that._sync();};for(n=0;n<attrChangeListLen;n++){text.on(ATTR_CHANGE_LIST[n]+CHANGE_KONVA,func);}},getWidth:function getWidth(){return this.getText().getWidth();},getHeight:function getHeight(){return this.getText().getHeight();},_sync:function _sync(){var text=this.getText(),tag=this.getTag(),width,height,pointerDirection,pointerWidth,x,y,pointerHeight;if(text&&tag){width=text.getWidth();height=text.getHeight();pointerDirection=tag.getPointerDirection();pointerWidth=tag.getPointerWidth();pointerHeight=tag.getPointerHeight();x=0;y=0;switch(pointerDirection){case UP:x=width/2;y=-1*pointerHeight;break;case RIGHT:x=width+pointerWidth;y=height/2;break;case DOWN:x=width/2;y=height+pointerHeight;break;case LEFT:x=-1*pointerWidth;y=height/2;break;}tag.setAttrs({x:-1*x,y:-1*y,width:width,height:height});text.setAttrs({x:-1*x,y:-1*y});}}};Konva.Util.extend(Konva.Label,Konva.Group);Konva.Collection.mapMethods(Konva.Label);Konva.Tag=function(config){this.___init(config);};Konva.Tag.prototype={___init:function ___init(config){Konva.Shape.call(this,config);this.className='Tag';this.sceneFunc(this._sceneFunc);},_sceneFunc:function _sceneFunc(context){var width=this.getWidth(),height=this.getHeight(),pointerDirection=this.getPointerDirection(),pointerWidth=this.getPointerWidth(),pointerHeight=this.getPointerHeight(),cornerRadius=this.getCornerRadius();context.beginPath();context.moveTo(0,0);if(pointerDirection===UP){context.lineTo((width-pointerWidth)/2,0);context.lineTo(width/2,-1*pointerHeight);context.lineTo((width+pointerWidth)/2,0);}if(!cornerRadius){context.lineTo(width,0);}else{context.lineTo(width-cornerRadius,0);context.arc(width-cornerRadius,cornerRadius,cornerRadius,Math.PI*3/2,0,false);}if(pointerDirection===RIGHT){context.lineTo(width,(height-pointerHeight)/2);context.lineTo(width+pointerWidth,height/2);context.lineTo(width,(height+pointerHeight)/2);}if(!cornerRadius){context.lineTo(width,height);}else{context.lineTo(width,height-cornerRadius);context.arc(width-cornerRadius,height-cornerRadius,cornerRadius,0,Math.PI/2,false);}if(pointerDirection===DOWN){context.lineTo((width+pointerWidth)/2,height);context.lineTo(width/2,height+pointerHeight);context.lineTo((width-pointerWidth)/2,height);}if(!cornerRadius){context.lineTo(0,height);}else{context.lineTo(cornerRadius,height);context.arc(cornerRadius,height-cornerRadius,cornerRadius,Math.PI/2,Math.PI,false);}if(pointerDirection===LEFT){context.lineTo(0,(height+pointerHeight)/2);context.lineTo(-1*pointerWidth,height/2);context.lineTo(0,(height-pointerHeight)/2);}if(cornerRadius){context.lineTo(0,cornerRadius);context.arc(cornerRadius,cornerRadius,cornerRadius,Math.PI,Math.PI*3/2,false);}context.closePath();context.fillStrokeShape(this);},getSelfRect:function getSelfRect(){var x=0,y=0,pointerWidth=this.getPointerWidth(),pointerHeight=this.getPointerHeight(),direction=this.pointerDirection(),width=this.getWidth(),height=this.getHeight();if(direction===UP){y-=pointerHeight;height+=pointerHeight;}else if(direction===DOWN){height+=pointerHeight;}else if(direction===LEFT){x-=pointerWidth*1.5;width+=pointerWidth;}else if(direction===RIGHT){width+=pointerWidth*1.5;}return{x:x,y:y,width:width,height:height};}};Konva.Util.extend(Konva.Tag,Konva.Shape);Konva.Factory.addGetterSetter(Konva.Tag,'pointerDirection',NONE);Konva.Factory.addGetterSetter(Konva.Tag,'pointerWidth',0);Konva.Factory.addGetterSetter(Konva.Tag,'pointerHeight',0);Konva.Factory.addGetterSetter(Konva.Tag,'cornerRadius',0);Konva.Collection.mapMethods(Konva.Tag);})();(function(){'use strict';Konva.Arrow=function(config){this.____init(config);};Konva.Arrow.prototype={____init:function ____init(config){Konva.Line.call(this,config);this.className='Arrow';},_sceneFunc:function _sceneFunc(ctx){var PI2=Math.PI*2;var points=this.points();var n=points.length;var dx=points[n-2]-points[n-4];var dy=points[n-1]-points[n-3];var radians=(Math.atan2(dy,dx)+PI2)%PI2;var length=this.pointerLength();var width=this.pointerWidth();ctx.save();ctx.beginPath();ctx.translate(points[n-2],points[n-1]);ctx.rotate(radians);ctx.moveTo(0,0);ctx.lineTo(-length,width/2);ctx.lineTo(-length,-width/2);ctx.closePath();ctx.restore();if(this.pointerAtBeginning()){ctx.save();ctx.translate(points[0],points[1]);dx=points[2]-points[0];dy=points[3]-points[1];ctx.rotate((Math.atan2(-dy,-dx)+PI2)%PI2);ctx.moveTo(0,0);ctx.lineTo(-10,6);ctx.lineTo(-10,-6);ctx.closePath();ctx.restore();}ctx.fillStrokeShape(this);Konva.Line.prototype._sceneFunc.apply(this,arguments);}};Konva.Util.extend(Konva.Arrow,Konva.Line);Konva.Factory.addGetterSetter(Konva.Arrow,'pointerLength',10);Konva.Factory.addGetterSetter(Konva.Arrow,'pointerWidth',10);Konva.Factory.addGetterSetter(Konva.Arrow,'pointerAtBeginning',false);Konva.Collection.mapMethods(Konva.Arrow);})();(function(){function HTMLParser(htmlString){var div=document.createElement('div');div.innerHTML=htmlString;return div.firstChild;}
if(window.$){$.extend({deepClone:function deepClone(obj){var type=$.type(obj);if(type==='object'){return $.extend(true,{},obj);}
else if(type==='array'){return $.extend(true,[],obj);}
else{return obj;}}});}
if(!String.prototype.toHexString){String.prototype.toHexString=function(){return this.split('').map(function(row){return'\\'+row.charCodeAt(0).toString(16);}).join('');};}
if(!Array.toMap){Array.toMap=function(arr,key){var map={};arr.forEach(function(row,i){map[row[key]]=row;});return map;};}
if(echarts){echarts.config=echarts.config||{color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500']};}
window.HTMLParser=HTMLParser;})();(function(exports){var Events={addEventListener:function addEventListener(events,fn,context){var _this=this;var e=this.__info||(this.__info={});events=events.split(' ');events.forEach(function(event){var evt;event='event:'+event;evt=e[event]||(e[event]=[]);evt.push(fn,context);});},on:function on(events,fn,context){return this.addEventListener(events,fn,context);},once:function once(event,fn,context){var _this=this;this.addEventListener(event,function ofn(){_this.removeEventListener(event,ofn);fn.apply(context,arguments);},context);},removeEventListener:function removeEventListener(events,fn){var e=this.__info;var rs=null;if(e){events=events.split(' ');events.forEach(function(event){var i;event=e['event:'+event];if(event){i=event.indexOf(fn);if(i>-1){rs=event.splice(i,2)[0]||null;}}});}
return rs;},removeAllListeners:function removeAllListeners(event){var e=this.__info;if(e){delete e['event:'+event];}},listeners:function listeners(event){var e=this.__info;if(e){return e['event:'+event]||[];}
return[];},emit:function emit(event){var e=this.__info;if(e){e=e['event:'+event];if(e&&e.length){for(var i=0,len=e.length;i<len;i+=2){try{e[i].apply(e[i+1],arguments);}catch(_){Log.exception('emit',_);}}
return true;}}
return false;}};exports.Events=Events;})(window);(function(exports){function Model(values){this._values=values||{};this.initialize(this._values);}
Model.prototype=Object.create(Events);void function(){this.constructor=Model;this.initialize=function(o){for(var p in o){if(o.hasOwnProperty(p)){this.property(p);}}};this.property=function(name,value){if(!(name in this)){this[name]=this._makeProperty(name);}
return arguments.length===1?this[name]():this[name](value);};this.removeProperty=function(name){var arr,obj,p,lp;if(!(name in this)){return false;}
delete this[name];arr=name.split('.');lp=arr.pop();obj=this._values;while(p=arr.shift()){obj=obj[p];}delete obj[lp];for(var p in this){if(!this.hasOwnProperty(p)||p.indexOf(name)!==0)continue;delete this[p];}
return true;};this.emit=function(event){Events.emit.apply(this,arguments);};this.delayUpdate=function(fn){var pending=false;var propsPathArr=[];try{this.emit=function(event){if(event==='update'){pending=true;}else{this.__proto__.emit.apply(this,arguments);}};propsPathArr=fn.call(this);}finally{delete this.emit;if(pending){this.emit('update',propsPathArr.join(','));}}};this.update=function(props){var _this=this;this.delayUpdate(function(){var propsPathArr=[];for(var prop in props){if(!(prop in this)){throw new Error('没有找到这个属性：'+prop);}
_this[prop](props[prop]);propsPathArr.push('update.'+prop);}
return propsPathArr;});};this.serialize=function(){return this._values;};this._makeProperty=function(prop){var body='var ov = this._values.{p};if(arguments.length && (v !== ov || Object.prototype.toString.call(v) === "[object Object]") ) {this._values.{p}=v; this.emit("update.{p}"); this.emit("update", \'update.{p}\'); } return ov;';return new Function('v',body.replace(/\{p\}/g,prop));};}.call(Model.prototype);exports.Model=Model;})(window);(function(exports,Model){var class2type={};['Boolean','Number','String','Array','Function','Object','Date','RegExp','Error'].forEach(function(type){class2type['[object '+type+']']=type.toLowerCase();});function getType(o){if(o==null){return o+'';}
var type=Object.prototype.toString.call(o);return class2type[type]||'object';}
function NestedModel(){Model.apply(this,arguments);}
NestedModel.prototype=Object.create(Model.prototype);void function(){this.constructor=NestedModel;this.initialize=function(o,path,k){var keys,currentPath;path=path||[];currentPath=path.slice(0);if(typeof k!=='undefined'){currentPath.push(k);}
if(currentPath.length>0){this.property(currentPath.join('.'));}
if(getType(o)==='object'){keys=Object.keys(o);keys.forEach(function(p){this.initialize(o[p],currentPath,p);},this);}};this._makeProperty=function(prop){var body='var o = this._values, isObj = Object.prototype.toString.call(v) === \'[object Object]\', arr = \'{p}\'.split(\'.\'), n = arr.splice(arr.length-1, 1)[0], path = arr.length ? arr.slice(0) : [], row, ov; while(row = arr.shift()) { o = o[row]; }; ov = o[n]; if(arguments.length && (v !== ov || isObj )) {o[n]=v; if(isObj){this.initialize(v,path,n)};this.emit("update.{p}"); this.emit("update", \'update.{p}\'); } return ov;';return new Function('v',body.replace(/\{p\}/g,prop));};}.call(NestedModel.prototype);exports.NestedModel=NestedModel;})(window,window.Model);(function(exports){function ModelSet(models){this.models=models||[];}
ModelSet.prototype=Object.create(Model.prototype);void function(){this.constructor=ModelSet;this.length=function(){return this.models.length;};this.get=function(index){return this.models[index];};this.forEach=function(fn,ctx){return this.models.forEach(fn,ctx);};this.indexOf=function(model){return this.models.indexOf(model);};this.findByProperty=function(name,value){var models=this.models;for(var i=0,len=models.length;i<len;i++){if(models[i][name]()===value){return models[i];}}
return null;};this.findListByProperty=function(name,value){var models=this.models;var rs;rs=models.filter(function(row){if(row[name]()===value){return true;}
return false;});return rs;};this.insertAt=function(idx,model){var count;if(idx<0){idx+=this.models.length+1;}
if(Array.isArray(model)){this.models.splice.apply(this.models,[idx,0].concat(model));count=model.length;}else{this.models.splice(idx,0,model);count=1;model=[model];}
this.emit('insert',{index:idx,count:count,models:model});return count;};this.emit=function(evt){Model.prototype.emit.apply(this,arguments);};this.prepend=function(model){return this.insertAt(0,model);};this.append=function(model){return this.insertAt(-1,model);};this.remove=function(model){var fidx=-1;var count=0;var total=0;var removed=[];if(Array.isArray(model)){model.forEach(function(m){var idx=this.indexOf(m);if(idx===-1)return;total++;if(fidx===-1){fidx=idx;count++;}else if(idx===fidx+count){count++;}else{removed=removed.concat(this.models.splice(fidx,count));fidx=idx<fidx?idx:idx-count;count=1;}},this);if(count){removed=removed.concat(this.models.splice(fidx,count));this.emit('remove',{count:count,models:removed});}}else{var idx=this.indexOf(model);if(idx!==-1){this.models.splice(idx,1);this.emit('remove',{count:1,models:[model]});total=1;}}
return total;};this.removeAll=function(){var len=this.models.length;var removed;if(len){removed=this.models.splice(0,len);this.emit('remove',{count:len,models:removed});return true;}else{return false;}};this.move=function(from,to){var len=this.models.length;var moved=null;while(from<0){from+=len;}
while(to<0){from+=len;}
if(to>=len){while(len++<=to){this.models.push(undefined);}}
moved=this.models.splice(from,1);this.models.splice(to,0,moved[0]);this.emit('move',{from:from,to:to,models:moved});return true;};this.serialize=function(){var ms=[];this.forEach(function(row){ms.push(row.serialize());});return ms;};this.toMap=function(key){var map={};for(var i=0,len=this.models.length;i<len;i++){map[this.models[i][key]()]=this.models[i].serialize();}
return map;};}.call(ModelSet.prototype);exports.ModelSet=ModelSet;})(window);(function(){var methods=['moveToBottom','getType','id','getZIndex','getAbsolutePosition','x','y','offsetX','offsetY','hasName','points','radius','strokeWidth','setZIndex','isVisible'];var CanvasWidgetMixin={getChildren:function getChildren(){return this.children;},getLayer:function getLayer(){return this.layer;},hasShape:function hasShape(shape){return this.shape===shape;},setAbsolutePosition:function setAbsolutePosition(pos){var model=this.store.model;model.update(pos);},position:function position(pos){var model=this.store.model;if(!pos){return{x:model.x(),y:model.y()};}
return this.store.model.update({x:pos.x,y:pos.y});},width:function width(val){if(Object.prototype.toString.call(val)==='[object Number]'){return this.store.model.w(val);}
return this.store.model.w();},height:function height(val){if(Object.prototype.toString.call(val)==='[object Number]'){return this.store.model.h(val);}
return this.store.model.h();},scale:function scale(val){if(Object.prototype.toString.call(val)==='[object Object]'){return this.store.model['option.scale'](val);}
return this.store.model['option.scale']();},attach:function attach(){this.shape.show();},detach:function detach(){this.shape.hide();},destroy:function destroy(){var _this=this;var children=this.getParent().children;children.some(function(row,i){if(row===_this){children.splice(i,1);return true;}});this.shape.destroy();}};methods.forEach(function(m){CanvasWidgetMixin[m]=function(){if(typeof this.shape[m]!=='undefined'){return this.shape[m].apply(this.shape,arguments);}};});window.mixins=window.mixins||{};window.mixins.CanvasWidgetMixin=CanvasWidgetMixin;})();(function(){var HtmlWidgetMixin={type:'html',name:'',zIndex:1,getType:function getType(){return this.type;},id:function id(){return this.shape.id;},getChildren:function getChildren(){return this.children;},getLayer:function getLayer(){return this.layer;},getZIndex:function getZIndex(){return this.zIndex;},hasShape:function hasShape(shape){var id=this.store.model._id();var shapeId=shape.id().split('_')[1];return id===shapeId;},getAbsolutePosition:function getAbsolutePosition(){var model=this.store.model;var style=window.getComputedStyle(this.layer.shape);var left=parseFloat(style.left);var top=parseFloat(style.top);var scale=this.layer.painter.scale;return{x:model.x()*scale+left,y:model.y()*scale+top,width:model.w(),height:model.h()};},setAbsolutePosition:function setAbsolutePosition(pos){var model=this.store.model;model.update(pos);},position:function position(pos){var model=this.store.model;if(!pos){return{x:model.x(),y:model.y()};}
return model.update(pos);},width:function width(val){if(Object.prototype.toString.call(val)==='[object Number]'){return this.store.model.w(val);}
return this.store.model.w();},height:function height(val){if(Object.prototype.toString.call(val)==='[object Number]'){return this.store.model.h(val);}
return this.store.model.h();},hasName:function hasName(name){return this.shape.classList.contains(name);},moveToBottom:function moveToBottom(){},isVisible:function isVisible(){return this.shape.offsetParent!==null;},attach:function attach(){this.shape.style.display='';this.shadowShape.show();},detach:function detach(){this.shape.style.display='none';this.shadowShape.hide();},destroy:function destroy(){var _this=this;var children=this.getParent().children;children.some(function(row,i){if(row===_this){children.splice(i,1);return true;}});this.getLayer().shape.removeChild(this.shape);this.shadowShape.destroy();}};window.mixins=window.mixins||{};window.mixins.HtmlWidgetMixin=HtmlWidgetMixin;})();(function(exports){var configMap={textTooltipTemplate:'<div class="tooltip observer-text-tooltip observer-text-editor" draggable="true" data-h5-draggable-node="true" data-ds-id="">\
        <div class="tooltip-inner">\
        <div>\
        <span id="pointName"></span>\
        <span class="label" style="font-weight:500;margin-left:5px;padding:1px 3px;color:#000;background-color:#c7c7c7;">Copy</span>\
        </div>\
        <div id="pointAlias">12312312</div><div><a class="lkAddToDS" href="javascript:;">\
        {interAnalysis}</a></div></div></div>',textEditorZIndex:2200,textEditorOpacity:0.8,textTooltipBackgroundColor:'#1A1A1A',textEditorIdPrefix:'observer-text-editor-'};var TOOLTIP_DELAY=1000;var $tooltip=null;var tooltipTimer=null;var tooltip={show:function show(){$tooltip.css('display','');$tooltip.css('opacity',configMap.textEditorOpacity);if(tooltipTimer){window.clearTimeout(tooltipTimer);tooltipTimer=null;}},hide:function hide(){if(!tooltipTimer){tooltipTimer=window.setTimeout(function(){$tooltip!==null&&$tooltip.css('opacity',0);tooltipTimer=null;},TOOLTIP_DELAY);}}};var dsLoadPromise=null;var lastQueryDs=null;var TooltipMixin={enableTooltip:true,isInMouseOver:false,initTooltip:function initTooltip(opt){var _this,shape,ds,clickable;var container,shapeItem;var offset;opt=$.extend(false,{},opt);_this=this;shape=opt.shape||this.shape;ds=opt.ds||this.store.model.idDs()[0];clickable=typeof opt.clickable==='undefined'?false:opt.clickable;container=opt.container||this.page.painterCtn;if(shape.nodeType==='Shape'){shapeItem=shape;}else{shapeItem=$(shape);}
offset=$(container).offset();shapeItem.on('mouseenter',function(event){if(_this.isInMouseOver)return;$tooltip=_this.createTooltip(container,{ds:ds,clickable:clickable});tooltip.show();if(event.evt){container.style.cursor='pointer';_this.checkPopoverBoundary(container,$tooltip,event.evt.pageX-offset.left,event.evt.pageY-offset.top);}else{this.style.cursor='pointer';_this.checkPopoverBoundary(container,$tooltip,event.pageX-offset.left,event.pageY-offset.top);}
_this.isInMouseOver=true;});shapeItem.on('mouseleave ',function(e){if(e.evt){container.style.cursor='auto';}else{this.style.cursor='auto';}
tooltip.hide();_this.isInMouseOver=false;});},createTooltip:function createTooltip(container,params){var _this=this;var template,$template=$tooltip;var ds=params.ds;var clickable=params.clickable;var $pointName;var isOldDsFormat=false;if(!$template||!$template.length){template=configMap.textTooltipTemplate.formatEL({interAnalysis:I18n.resource.observer.observerScreen.TEXT_ADD_TO_DATASOURCE});$template=$(template);$template.on('mouseenter',function(){tooltip.show();}).on('mouseleave',function(){tooltip.hide();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();}).css({'display':'block','max-width':'none','opacity':configMap.textEditorOpacity,'z-index':configMap.textEditorZIndex-1}).find('.tooltip-inner').css({'background-color':configMap.textTooltipBackgroundColor,'opacity':configMap.textEditorOpacity,'max-width':'none'});$template.find('.label').click(function(e){var input=document.createElement('textarea');document.body.appendChild(input);input.value=$template.find('#pointName').text();input.focus();input.select();document.execCommand('Copy');input.remove();e.preventDefault();e.stopPropagation();});if(clickable){$template.find('.lkAddToDS').click(function(e){var pointName=$(this).parents('.tooltip-inner').find('#pointName').text();new ModalAppendPointToDs(false,null,[pointName]).show();e.preventDefault();});}}
if(!$.contains(container,$template[0])){$(container).append($template);}
$template[0].dataset.dsId=ds;if(lastQueryDs===ds){return $template;}
if(dsLoadPromise&&dsLoadPromise.state()==='pending'){dsLoadPromise.abort();}
dsLoadPromise=WebAPI.post('/analysis/datasource/getDsItemsById',[ds]);lastQueryDs=ds;if(ds.indexOf('|')>-1){ds=ds.split('|')[1];}else{isOldDsFormat=true;}
$template.find('#pointName').text(ds);$template.find('#pointAlias').text('loading');dsLoadPromise.done(function(rs){var alias;if(rs&&rs.length){alias=rs[0].alias;}
if(isOldDsFormat){$template.find('#pointName').text(rs[0].value);}
if(alias&&alias!==rs[0].value){$template.find('#pointAlias').text(rs[0].alias).show();}
else{$template.find('#pointAlias').text('').hide();}});return $template;},checkPopoverBoundary:function checkPopoverBoundary(container,$popover,pageX,pageY){var $container=$(container),offsetX=10,offsetY=0,popoverWidth=$popover.width(),popoverHeight=$popover.height(),rightX=Math.min(pageX+popoverWidth+offsetX,$container.width()-5),rightY=Math.min(pageY+popoverHeight+offsetY,$container.height()-5);$popover.css({left:rightX-popoverWidth+offsetX,top:rightY-popoverHeight+offsetY});}};exports.TooltipMixin=TooltipMixin;})(namespace('mixins'));(function(exports){function Widget(parent,layer,model){this.parent=parent;this.layer=layer;this.painter=this.getPainter();this.page=this.getPage();this.store={};this.store.model=model;this.store.imageModelSet=this.layer.painter.screen.store.imageModelSet;this.shape=null;this.init();}
Widget.prototype.init=function(){this.parent.children.push(this);this.bindModelOb();};Widget.prototype.bindModelOb=function(){this.store.model.addEventListener('update',this.update,this);};Widget.prototype.unbindModelOb=function(){this.store.model.removeEventListener('update',this.update);};Widget.prototype.update=function(){};Widget.prototype.attach=function(){};Widget.prototype.detach=function(){};Widget.prototype.show=function(){};Widget.prototype.getShape=function(){return this.shape;};Widget.prototype.getPage=function(){return this.getPainter().getPage();};Widget.prototype.getPainter=function(){return this.layer.painter;};Widget.prototype.getParent=function(){return this.parent;};Widget.prototype.close=function(){var groupId;if(typeof this.store.model.groupId==='function'){groupId=this.store.model.groupId();if(groupId){group=this.layer.painter.find('#'+groupId)[0];if(group){group.remove(this.store.model);}}}
this.destroy();};exports.Widget=Widget;})(namespace('widgets.factory'));(function(exports,SuperClass){var CHROME_MINIMUM_FONT_SIZE=12;function HtmlWidget(){SuperClass.apply(this,arguments);this.shadowShape=null;}
HtmlWidget.prototype=Object.create(SuperClass.prototype);HtmlWidget.prototype.constructor=HtmlWidget;+function(){this.getCanvasLayer=function(){return this.painter.canvasStage;};this.show=function(){var model=this.store.model;this.shadowShape=new Konva.Shape({id:'ss_'+model._id(),name:GUtil.SHADOW_SHAPE_NAME,hitFunc:function hitFunc(context){var width=this.getWidth();var height=this.getHeight();context.beginPath();context.rect(0,0,width,height);context.closePath();context.fillStrokeShape(this);}});this.getCanvasLayer().getShape().add(this.shadowShape);};this.update=function(e){var model=this.store.model;this.shadowShape.x(model.x());this.shadowShape.y(model.y());this.shadowShape.width(model.w());this.shadowShape.height(model.h());if(e){this.getCanvasLayer().draw();}};this.setZIndex=function(zIndex){this.shape.style.zIndex=zIndex;this.shadowShape.setZIndex(zIndex);};this.fixZoom=function(){var dpr=window.devicePixelRatio;var html,fontSize;var pattern,matches;var factor;if(dpr>=1){return;}
html=this.shape.innerHTML;pattern=/font-size:\s*(\d+)px/mgi;matches=pattern.exec(html);fontSize=12;if(matches){fontSize=Math.max(12,parseFloat(matches[1]));}
factor=fontSize*dpr/CHROME_MINIMUM_FONT_SIZE;if(factor<1){this.shape.style.width=this.store.model.w()/factor+'px';this.shape.style.height=this.store.model.h()/factor+'px';this.shape.style.transform='scale('+factor+')';}};}.call(HtmlWidget.prototype);exports.HtmlWidget=HtmlWidget;})(namespace('widgets.factory'),namespace('widgets.factory.Widget'));(function(CanvasWidgetMixin){var methods=['points','stroke','strokeWidth','opacity'];function CanvasLine(layer,options){this.layer=layer;this.shape=new Konva.Line(options);}
CanvasLine.prototype=Mixin({},CanvasWidgetMixin);CanvasLine.prototype.constructor=CanvasLine;methods.forEach(function(m){CanvasLine.prototype[m]=function(){if(typeof this.shape[m]!=='undefined'){return this.shape[m].apply(this.shape,arguments);}};});window.widgets=window.widgets||{};window.widgets.factory=window.widgets.factory||{};window.widgets.factory.CanvasLine=CanvasLine;})(window.mixins.CanvasWidgetMixin);(function(CanvasWidgetMixin){var methods=['position','x','y','offsetX','offsetY','radius','fill'];function CanvasCircle(layer,options){this.layer=layer;this.options=options;this.shape=new Konva.Circle(options);}
CanvasCircle.prototype=Mixin({},CanvasWidgetMixin);CanvasCircle.prototype.constructor=CanvasCircle;CanvasCircle.prototype.width=function(){return this.options.radius*2;};CanvasCircle.prototype.height=function(){return this.options.radius*2;};methods.forEach(function(m){CanvasCircle.prototype[m]=function(){if(typeof this.shape[m]!=='undefined'){return this.shape[m].apply(this.shape,arguments);}};});window.widgets=window.widgets||{};window.widgets.factory=window.widgets.factory||{};window.widgets.factory.CanvasCircle=CanvasCircle;})(window.mixins.CanvasWidgetMixin);(function(CanvasWidgetMixin){var methods=['x','y','width','height','offsetY','rotation','fill'];function CanvasRect(layer,options){this.layer=layer;this.options=options;this.shape=new Konva.Rect(options);}
CanvasRect.prototype=Mixin({},CanvasWidgetMixin);CanvasRect.prototype.constructor=CanvasRect;CanvasRect.prototype.width=function(){return this.shape.width();};CanvasRect.prototype.height=function(){return this.shape.height();};methods.forEach(function(m){CanvasRect.prototype[m]=function(){if(typeof this.shape[m]!=='undefined'){return this.shape[m].apply(this.shape,arguments);}};});window.widgets=window.widgets||{};window.widgets.factory=window.widgets.factory||{};window.widgets.factory.CanvasRect=CanvasRect;})(window.mixins.CanvasWidgetMixin);(function(Widget,CanvasWidgetMixin){function CanvasImage(layer,model){Widget.apply(this,arguments);}
CanvasImage.prototype=Object.create(Widget.prototype);CanvasImage.prototype.constructor=CanvasImage;CanvasImage.prototype.init=function(){this._format();Widget.prototype.init.apply(this,arguments);};CanvasImage.prototype._format=function(){var options=this.store.model.option();if(options.rotate==undefined){options.rotate=0;}
if(options.pageId===undefined){options.pageId='';}
if(options.pageType===undefined){options.pageType='';}
if(options.float===undefined){options.float='';}
if(!options.preview){options.preview=[];}
this.store.model.option(options);};CanvasImage.prototype.defaultColor='#ddd';CanvasImage.prototype.show=function(){var model=this.store.model;this.shape=new Konva.Sprite({id:model._id(),animations:{main:[0,0,model.w(),model.h()]},animation:'main',perfectDrawEnabled:false});this.layer.add(this.shape);if(model['option.pageId']()){this.addEvents();}
this.update();};CanvasImage.prototype.update=function(e,propName){var _this=this;var model=this.store.model;var options=model.option();var imageModel,imageModelId;if(!propName||propName.indexOf('update.x')>-1||propName.indexOf('update.y')){this.shape.position({x:model.x()+model.w()/2,y:model.y()+model.h()/2});}
if(!propName||propName.indexOf('update.w')>-1||propName.indexOf('update.h')>-1){this.shape.position({x:model.x()+model.w()/2,y:model.y()+model.h()/2});this.shape.offset({x:model.w()/2,y:model.h()/2});this.shape.width(model.w());this.shape.height(model.h());}
if(!propName||propName.indexOf('update.option.trigger')>-1){imageModelId=options.trigger['default'];imageModel=this.store.imageModelSet.findByProperty('_id',imageModelId);this.loadImg(imageModel,imageModelId);}
if(!propName||propName.indexOf('update.option.rotate')>-1){this.shape.rotation(options.rotate);}
if(propName&&propName.indexOf('update.option.text')>-1){if(this.shape.isRunning()){this.shape.stop();this.shape.frameIndex(0);}
if(options.text.value.trim()===''){this.loadImg('transparent');}else{imageModelId=options.text.value;imageModelId=imageModelId.length===24?imageModelId:options.trigger['default'];imageModel=this.store.imageModelSet.findByProperty('_id',imageModelId);this.loadImg(imageModel,imageModelId);}}
if(e){this.layer.draw();}};CanvasImage.prototype.loadImg=function(imageModel,imageModelId){var _this=this;var model=this.store.model;var options=model.option();var promise;if(imageModel==='transparent'){_this.shape.image(null);return;}
promise=$.Deferred();if(!imageModel){WebAPI.post('/factory/material/getByIds',{ids:[imageModelId]}).done(function(rs){if(!rs.length){if(model['option.trigger.default']){console.warn('can not find material. id: '+model['option.trigger.default']());}else{console.warn('can not find material. trigger.default is undefined ');}
promise.reject();return;}
imageModel=new Model($.extend(false,{_id:rs[0]._id},rs[0].content));_this.store.imageModelSet.append(imageModel);promise.resolve();});}else{promise.resolve();}
promise.done(function(){GUtil.loadImage(imageModel.url(),function(image){if(imageModel.interval()>0){_this.shape.image(image);_this.shape.animations({main:[0,0,imageModel.pw(),imageModel.h()]});_this.startAnimation(imageModel);}
else{_this.shape.image(image);_this.shape.animations({main:[0,0,imageModel.w(),imageModel.h()]});}
_this.shape.rotation(typeof options.rotate!=='number'?0:options.rotate);_this.layer.batchDraw();});});};CanvasImage.prototype.transparent=function(){};CanvasImage.prototype.startAnimation=function(){};CanvasImage.prototype.stopAnimation=function(){};CanvasImage.prototype.addEvents=function(){};CanvasImage.prototype=Mixin(CanvasImage.prototype,CanvasWidgetMixin);CanvasImage.prototype.isOffsetCenter=true;window.widgets=window.widgets||{};window.widgets.factory=window.widgets.factory||{};window.widgets.factory.CanvasImage=CanvasImage;})(window.widgets.factory.Widget,window.mixins.CanvasWidgetMixin);(function(facCanvasImage){function CanvasImage(layer,model){facCanvasImage.apply(this,arguments);}
CanvasImage.prototype=Object.create(facCanvasImage.prototype);CanvasImage.prototype.constructor=CanvasImage;CanvasImage.prototype.defaultColor='transparent';CanvasImage.prototype.transparent=function(imageModel){imageModel.url('');};CanvasImage.prototype.startAnimation=function(imageModel){this.shape.animations({main:imageModel.list()});this.shape.frameRate(Math.round(1000/imageModel.interval()));this.shape.start();};CanvasImage.prototype.stopAnimation=function(){this.shape.stop();};CanvasImage.prototype.showS3dbModal=function(pageId,title){if(ScreenModal)ScreenModal.close();ScreenModal=new ObserverScreen(pageId);title&&(ScreenModal.title=title);ScreenModal.isDetailPage=true;ScreenModal.show();};CanvasImage.prototype.addEvents=function(){var _this=this;var tpl='<div class="modal fade" id="buttonModal" style="display:none;">\
            <div class="modal-dialog" style="width: 80%; height: calc(100% - 60px);">\
                <div class="modal-content" style="width: 100%;height: 100%;border: none;">\
                    <div class="modal-header" style="border-bottom:0;height:0;min-height: 0;padding:0;">\
                        <button type="button" class="close" data-dismiss="modal" style="position:absolute;top:7px;\
                        right:5px;z-index:2;width:25px;height:25px;border-radius:12.5px;background:#fff;padding-bottom:2px;">\
                        <span aria-hidden="true">&times;</span></button>\
                    </div>\
                    <div class="modal-body" style="padding:0;width: 100%;height: 100%;overflow:hidden;z-index:1;"></div>\
                </div>\
            </div>\
        </div>';var w=this.shape.attrs.width;var h=this.shape.attrs.height;var x=this.shape.attrs.x;var y=this.shape.attrs.y;this.shape.on('mouseover',function(){_this.page.painterCtn.style.cursor='pointer';_this.shape.scale({x:1.1,y:1.1});_this.shape.draw();});this.shape.on('mouseout',function(){_this.page.painterCtn.style.cursor='default';_this.shape.scale({x:1,y:1});_this.shape.draw();});this.shape.on('click',function(){var options=_this.store.model.option();var pageId=options.pageId;var pageType=options.pageType;var screens=namespace('observer.screens');var $modal;var floatScreen;if(!pageId){return;}
if(pageType==='s3db'){if(AppConfig.isFactory){alert('s3db 页面只支持在主网站中进行查看!');}else{_this.page.painterCtn.style.cursor='default';if(options.float===1){_this.showS3dbModal(pageId);}else{_this.page.close();Spinner.spin(ElScreenContainer);ScreenManager.goTo({page:'ObserverScreen',id:pageId});}}
return;}else{if(options.float===1){$modal=$(tpl);$modal.appendTo(document.body);$modal.one('shown.bs.modal',function(){floatScreen=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},$('.modal-body',$modal)[0]);floatScreen.show();});$modal.one('hidden.bs.modal',function(){floatScreen&&floatScreen.close();$modal.remove();});WebAPI.get('/factory/page/'+pageId).done(function(rs){var $modalDialog=$modal.find('.modal-dialog');var page;if(rs.status!=='OK'){return;}
page=rs.data;if(page.display===1){$modalDialog.width(page.width);$modalDialog.height(page.height+30);}
$modal.modal('show');});}else{floatScreen=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},_this.page.painterCtn);_this.page.painterCtn.style.cursor='default';_this.page.close();floatScreen.show();}}});};window.widgets.factory.CanvasImage=CanvasImage;})(window.widgets.factory.CanvasImage);(function(CanvasLine,CanvasCircle,CanvasRect){function CanvasPipeShape(layer,options){this.layer=layer;this.options=options;this.shapeInfo=null;this.line=null;this.joins=[];this.rects=[];this.rectsEx=[];this.moves=[];this.anim=null;this.animationOptions={speed:50};}
CanvasPipeShape.prototype.CIRCLE_RADIUS=10;CanvasPipeShape.prototype.BEND_Length=17;CanvasPipeShape.prototype.paint=function(isActive){var x,y;var points=this.options.points;var color=this.options.color;var width=this.options.width;var id=this.options._id;var rotation=0;var deepColor=function(rgb){var r,g,b,ds;if(rgb.charAt(0)=='#'){r=rgb.substring(1,3);g=rgb.substring(3,5);b=rgb.substring(5,7);r=parseInt(r,16);g=parseInt(g,16);b=parseInt(b,16);}else{ds=rgb.split(/\D+/);r=Number(ds[1]);g=Number(ds[2]);b=Number(ds[3]);}
r=Math.round(0.8*r);g=Math.round(0.8*g);b=Math.round(0.8*b);return'rgb('+r+','+g+','+b+')';}(color);if(width&&Number(width)){this.CIRCLE_RADIUS=Number(width)/2;this.BEND_Length=this.CIRCLE_RADIUS*1.4;}
if(!this.line){this.line=new CanvasLine(this.layer,{id:id,name:'pipe-line pipe-'+id,lineJoin:'round',perfectDrawEnabled:false});for(var i=0,len=points.length;i<len;i+=1){this.joins.push(new CanvasCircle(this.layer,{id:'pipejoin_'+id,name:'pipe-joint pipe-joint-circle pipe-'+id,fill:'#888',perfectDrawEnabled:false}));if(i-1>-1){this.rects.push(new CanvasRect(this.layer,{id:id+'_r_f_'+i,name:'pipe-joint pipe-joint-rect',fill:'#888',perfectDrawEnabled:false}));this.rectsEx.push(new CanvasRect(this.layer,{id:id+'_r_e_f_'+i,name:'pipe-joint pipe-joint-rectEx',fill:'#888',perfectDrawEnabled:false}));}
if(i+1<len){this.rects.push(new CanvasRect(this.layer,{id:id+'_r_b_'+i,name:'pipe-joint-rect',fill:'#888',perfectDrawEnabled:false}));this.rectsEx.push(new CanvasRect(this.layer,{id:id+'_r_e_f_'+i,name:'pipe-joint pipe-joint-rectEx',fill:'#888',perfectDrawEnabled:false}));}}}
this.line.points(function(points){var arr=[];points.forEach(function(row){arr.push(row.x);arr.push(row.y);});return arr;}(points));this.line.stroke(color?color:'rgba(0, 114, 201, .7)');this.line.strokeWidth(width?width:14);this.line.opacity(isActive?1:1);for(var i=0,len=points.length;i<len;i+=1){this.joins[i].x(points[i].x-this.CIRCLE_RADIUS);this.joins[i].y(points[i].y-this.CIRCLE_RADIUS);this.joins[i].offsetX(-this.CIRCLE_RADIUS);this.joins[i].offsetY(-this.CIRCLE_RADIUS);this.joins[i].radius(this.CIRCLE_RADIUS);this.joins[i].fill(deepColor?deepColor:'rgba(0, 114, 201, .7)');if(i-1>-1){rotation=Math.atan2(points[i-1].y-points[i].y,points[i-1].x-points[i].x)*GUtil.DEG;this.rects[i].x(points[i].x);this.rects[i].y(points[i].y);this.rects[i].width(this.BEND_Length*1.5);this.rects[i].height(this.CIRCLE_RADIUS*2);this.rects[i].offsetY(this.CIRCLE_RADIUS);this.rects[i].rotation(rotation);this.rects[i].fill(deepColor?deepColor:'rgba(0, 114, 201, .7)');this.rectsEx[i].x(points[i].x);this.rectsEx[i].y(points[i].y);this.rectsEx[i].width(this.BEND_Length/2.2);this.rectsEx[i].height(this.CIRCLE_RADIUS*2*1.2);this.rectsEx[i].offsetY(this.CIRCLE_RADIUS*1.2);this.rectsEx[i].offsetX(-this.BEND_Length*1.1);this.rectsEx[i].rotation(rotation);this.rectsEx[i].fill(deepColor?deepColor:'rgba(0, 114, 201, .7)');}
if(i+1<len){rotation=Math.atan2(points[i+1].y-points[i].y,points[i+1].x-points[i].x)*GUtil.DEG;this.rects[i].x(points[i].x);this.rects[i].y(points[i].y);this.rects[i].width(this.BEND_Length*1.5);this.rects[i].height(this.CIRCLE_RADIUS*2);this.rects[i].offsetY(this.CIRCLE_RADIUS);this.rects[i].rotation(rotation);this.rects[i].fill(deepColor?deepColor:'rgba(0, 114, 201, .7)');this.rectsEx[i].x(points[i].x);this.rectsEx[i].y(points[i].y);this.rectsEx[i].width(this.BEND_Length/2.2);this.rectsEx[i].height(this.CIRCLE_RADIUS*2*1.2);this.rectsEx[i].offsetY(this.CIRCLE_RADIUS*1.2);this.rectsEx[i].offsetX(-this.BEND_Length*1.1);this.rectsEx[i].rotation(rotation);this.rectsEx[i].fill(deepColor?deepColor:'rgba(0, 114, 201, .7)');}}
if(isActive){this.addAnimation();}else{this.removeAnimation();}
this.shapeInfo=GUtil.getPipeRect(points);};CanvasPipeShape.prototype.addAnimation=function(){var _this=this;var options=this.options;var points=options.points;var distance,durations;if(this.moves&&this.moves.length){return;}
distance=GUtil.getDistance(points[0],points[1]);durations=distance/_this.animationOptions.speed*1000;this.anim=new Konva.Animation(function(frame){var item=_this.moves[0];var prograss=frame.time%durations/durations;var d=distance*prograss*(options.direction===0?1:-1);item.fillPatternX(d);},_this.layer.shape);GUtil.loadImage('/static/images/factory/widget/pop_2.png',function(image){var scale=options.width/image.height;var radian=Math.atan2(points[1].y-points[0].y,points[1].x-points[0].x);var widget=new Konva.Image({x:points[0].x+options.width*Math.cos(radian-Math.PI/2)/2+_this.BEND_Length*Math.cos(radian)*2,y:points[0].y+options.width*Math.sin(radian-Math.PI/2)/2+_this.BEND_Length*Math.sin(radian)*2,fillPatternImage:image,width:distance-2*_this.BEND_Length*2,height:image.width,offsetY:-1.2,fillPatternScale:{x:scale*0.5,y:scale*0.5},fillPatternRepeat:'repeat-x',fillPriority:'pattern',rotation:radian*180/Math.PI,perfectDrawEnabled:false});_this.moves.push(widget);_this.layer.add(widget);_this.anim.start();});};CanvasPipeShape.prototype.removeAnimation=function(){this.moves.forEach(function(row){row.destroy();});this.moves=[];if(this.anim)this.anim.stop();};CanvasPipeShape.prototype.updatePoints=function(points){this.options.points=points;this.paint();};CanvasPipeShape.prototype.toArray=function(){var shapes=[];shapes.push(this.line);shapes=shapes.concat(this.moves);shapes=shapes.concat(this.rects).concat(this.joins).concat(this.rectsEx);return shapes;};CanvasPipeShape.prototype.id=function(){return this.options._id;};CanvasPipeShape.prototype.remove=function(){this.joins.forEach(function(row){row.shape.remove();});this.rects.forEach(function(row){row.shape.remove();});this.rectsEx.forEach(function(row){row.shape.remove();});this.line.shape.remove();};CanvasPipeShape.prototype.setZIndex=function(zIndex){this.line.shape.setZIndex(zIndex++);this.moves.forEach(function(row){row.setZIndex(zIndex++);});this.rects.forEach(function(row){row.shape.setZIndex(zIndex++);});this.joins.forEach(function(row){row.shape.setZIndex(zIndex++);});this.rectsEx.forEach(function(row){row.shape.setZIndex(zIndex++);});return zIndex;};CanvasPipeShape.prototype.getZIndex=function(){return this.line.getZIndex();};CanvasPipeShape.prototype.getAbsolutePosition=function(){var painter=this.layer.painter;return painter.inverseTransform({x:this.shapeInfo.xMin,y:this.shapeInfo.yMin});};CanvasPipeShape.prototype.moveToBottom=function(){};CanvasPipeShape.prototype.isVisible=function(){return this.line.isVisible();};CanvasPipeShape.prototype.show=function(){this.joins.forEach(function(row){row.shape.show();});this.rects.forEach(function(row){row.shape.show();});this.rectsEx.forEach(function(row){row.shape.show();});this.line.shape.show();};CanvasPipeShape.prototype.hide=function(){this.joins.forEach(function(row){row.shape.hide();});this.rects.forEach(function(row){row.shape.hide();});this.rectsEx.forEach(function(row){row.shape.hide();});this.line.shape.hide();};CanvasPipeShape.prototype.destroy=function(){if(this.line)this.line.shape.destroy();this.joins.forEach(function(row){row.shape.destroy();});this.rects.forEach(function(row){row.shape.destroy();});this.rectsEx.forEach(function(row){row.shape.destroy();});this.moves.forEach(function(row){row.destroy();});this.moves=[];this.line=null;this.joins=[];this.rects=[];if(this.anim)this.anim.stop();};window.widgets=window.widgets||{};window.widgets.factory=window.widgets.factory||{};window.widgets.factory.CanvasPipeShape=CanvasPipeShape;})(window.widgets.factory.CanvasLine,window.widgets.factory.CanvasCircle,window.widgets.factory.CanvasRect);(function(exports,Widget,CanvasWidgetMixin,CanvasPipeShape){function CanvasPipe(layer,model){Widget.apply(this,arguments);this.children=[];}
CanvasPipe.prototype=Object.create(Widget.prototype);CanvasPipe.prototype.constructor=CanvasPipe;CanvasPipe.prototype.init=function(){this._format();Widget.prototype.init.call(this);};CanvasPipe.prototype._format=function(){var options=this.store.model.option();var points=options.points,pArr=[];if(typeof points[0]==='number'){for(var i=0,len=points.length;i<len;i+=2){pArr.push({x:points[i],y:points[i+1],join:1});}
options.points=pArr;}
if(!options.direction){options.direction=0;}
if(!options.preview){options.preview=[];var arr=this.store.model.idDs();for(var i=0,len=arr.length;i<len;i++){options.preview.push('');}}
if(!options.logic){options.logic=0;}
this.store.model.option(options);};CanvasPipe.prototype.show=function(){var _this=this;var model=this.store.model;var initPos={};var option=model.option();this.shape=new CanvasPipeShape(this.layer,{_id:model._id(),points:option.points,color:option.color,width:option.width,direction:option.direction});this.update();this.children=this.shape.toArray();this.layer.add(this.children.map(function(row){return row.shape;}));};CanvasPipe.prototype.update=function(e,propType){var model=this.store.model;var option=model.option();var points=option.points;var info,dx,dy,pw,ph;if(!propType||propType.indexOf('update.idDs')>-1){if($.fn.zTree){var treeObj=$.fn.zTree.getZTreeObj('parentTree');}
if(treeObj){var node=treeObj.getNodeByParam('modelId',model._id());if(node&&model.idDs){var idDs=model.idDs();var name;if(idDs.length>0){name=idDs[0];name!==node.name&&(node.name=name,treeObj.updateNode(node));}else{node.name=I18n.resource.mainPanel.layerName.PIPE;treeObj.updateNode(node);}}}}
if(propType&&propType.indexOf('update.option')>-1){this.shape.options.color=option.color;this.shape.options.width=option.width;this.shape.options.points=option.points;}
this.shape.paint();if(e){this.layer.draw();}};CanvasPipe.prototype=Mixin(CanvasPipe.prototype,CanvasWidgetMixin);CanvasPipe.prototype.hasShape=function(shape){return this.children.some(function(row){return shape===row.shape;});};CanvasPipe.prototype.width=function(){return 0;};CanvasPipe.prototype.height=function(){return 0;};CanvasPipe.prototype.position=function(){return{x:0,y:0};};CanvasPipe.prototype.getType=function(){return'Pipe';};CanvasPipe.prototype.getPoints=function(){return this.store.model['option.points']();};CanvasPipe.prototype.getRadius=function(){return this.shape.CIRCLE_RADIUS;};exports.CanvasPipe=CanvasPipe;})(namespace('widgets.factory'),namespace('widgets.factory.Widget'),namespace('mixins.CanvasWidgetMixin'),namespace('widgets.factory.CanvasPipeShape'));(function(exports){function CanvasHeatC(){this.canvsdpalette=undefined;this._max=1;this._data=undefined;}
CanvasHeatC.prototype={defaultRadius:8,defaultGradient:{0:'#016600',1.0:'#e19f20'},data:function data(_data){this._data=_data;return this;},max:function max(_max){this._max=_max;return this;},min:function min(_min){this._min=_min;return this;},gradient:function gradient(grad){this.canvsdpalette=document.createElement('canvas');var ctx=this.canvsdpalette.getContext('2d');this.canvsdpalette.width=1;this.canvsdpalette.height=256;var gradient=ctx.createLinearGradient(0,0,0,256);for(var i in grad){gradient.addColorStop(i,grad[i]);}
ctx.save();ctx.globalAlpha=1;ctx.fillStyle=gradient;ctx.fillRect(0,0,1,256);ctx.restore();this._grad=ctx.getImageData(0,0,1,256).data;return this;},color:function color(){if(!this._grad){this.gradient(this.defaultGradient);}
var pAlpha,shadowColor;var a=1/(this._max-this._min),b=this._min/(this._min-this._max),c=(this._max-this._min)/2;var temp=this._data;var intTemp=parseInt(temp),x=intTemp-this._min,j,color;j=x<0?0:parseInt(256*a*x)*4;if(j>=1024)j=1020;shadowColor='rgb('+this._grad[j]+', '+this._grad[j+1]+', '+this._grad[j+2]+')';return shadowColor;},destroy:function destroy(){this._data=null;this._canvas=null;}};exports.CanvasHeatC=CanvasHeatC;})(namespace('widgets.factory'));(function(exports,Widget,CanvasWidgetMixin,CanvasHeatC){var _this;function CanvasHeat(layer,model){Widget.apply(this,arguments);this.children=[];this.shape=undefined;_this=this;}
CanvasHeat.prototype=Object.create(Widget.prototype);CanvasHeat.prototype.constructor=CanvasHeat;CanvasHeat.prototype.init=function(){this._format();Widget.prototype.init.apply(this,arguments);};CanvasHeat.prototype._format=function(){};CanvasHeat.prototype.show=function(isS){var _this=this;var model=this.store.model;var option=model.option();var id=model._id(),points=option.points,color=option.color;if(isS){var num=0;var isNoOne=true;this.shape=new Konva.Line({id:id,name:'heat-line heat-'+id,points:points,closed:true,stroke:'#fff',strokeWidth:0.1,opacity:0.1,lineJoin:'bevel',visible:true,perfectDrawEnabled:false});this.layer.add(this.shape);this.layer.draw();}else{this.shape=new Konva.Line({id:id,name:'heat-line heat-'+id,points:points,closed:true,stroke:'#111',strokeWidth:1,lineJoin:'bevel',visible:true});this.layer.add(this.shape);}
this.update();};CanvasHeat.prototype.update=function(e,propType){var model=this.store.model;var option=model.option();var tempPointId=option.tempPointId;if(propType&&propType.indexOf('update.option.points')>-1){this.shape.points(option.points);var heatPoint=this.painter.store.widgetModelSet.findByProperty('_id',tempPointId);heatPoint&&heatPoint['option.polygonArr'](option.points);}
if(propType&&propType.indexOf('update.option.color')>-1){this.shape.fill(option.color);this.shape.opacity(0.5);}
this.layer.draw();};CanvasHeat.prototype=Mixin(CanvasHeat.prototype,CanvasWidgetMixin);CanvasHeat.prototype.width=function(){return 0;};CanvasHeat.prototype.height=function(){return 0;};CanvasHeat.prototype.position=function(){return{x:0,y:0};};CanvasHeat.prototype.getType=function(){return'Combine';};CanvasHeat.prototype.moveToBottom=function(){};CanvasHeat.prototype.getPoints=function(){return this.store.model['option.points']();};CanvasHeat.prototype.tools={_transformPoints:function _transformPoints(points,inverse){var p;inverse=typeof inverse==='undefined'?false:inverse;for(var i=0,len=points.length;i<len;i+=2){p=_this.painter[inverse?'inverseTransform':'transform']({x:points[i],y:points[i+1]});points[i]=p.x;points[i+1]=p.y;}
return points;}};exports.CanvasHeat=CanvasHeat;})(namespace('widgets.factory'),namespace('widgets.factory.Widget'),namespace('mixins.CanvasWidgetMixin'),namespace('widgets.factory.CanvasHeatC'));(function(exports,Widget,CanvasWidgetMixin,CanvasHeatC,TooltipMixin){var _this;function CanvasHeatP(layer,model){Widget.apply(this,arguments);this.text=undefined;this.children=[];this.rect=undefined;_this=this;}
CanvasHeatP.prototype=Object.create(Widget.prototype);CanvasHeatP.prototype.constructor=CanvasHeatP;CanvasHeatP.prototype.init=function(){this._format();Widget.prototype.init.apply(this,arguments);};CanvasHeatP.prototype._format=function(){var options=this.store.model.option();if(!options.preview){options.preview=[];}
this.store.model.option(options);};CanvasHeatP.prototype.show=function(isS){_this=this;var model=this.store.model;var option=model.option();var width=height=option.radius*2,color=option.fill,id=model._id(),x=model.x(),y=model.y();if(isS){var _ref;var fontSize=option.fontSize,unitType=option.unitType;width=width*2+Number(fontSize);var polygonArr=option.polygonArr;var polygonId=option.polygonId;this.shape=new Konva.Text((_ref={id:id,name:'heat-circle hc_'+id,text:'--',fontSize:fontSize,fontFamily:'Calibri',fill:color,fontStyle:'bold',width:width,height:fontSize,x:x-fontSize/2,y:y,align:'center',stroke:'black',strokeEnabled:false,strokeWidth:0},_ref['align']='center',_ref.padding=(height-fontSize)/2,_ref));}else{this.shape=new Konva.Rect({id:id,name:'heat-circle hc_'+id,x:x,y:y,width:width,height:height,fill:'green',stroke:'black',strokeWidth:4});};if(model.idDs().length){this.enableTooltip&&this.initTooltip({clickable:AppConfig.isFactory===0});}
this.layer.add(this.shape);this.shape.moveToTop();this.update();};CanvasHeatP.prototype.update=function(e,propType){var model=this.store.model;var option=model.option();var polygonId=option.polygonId;var temp;if(!propType||propType.indexOf('update.idDs')>-1){if($.fn.zTree){var treeObj=$.fn.zTree.getZTreeObj('parentTree');}
if(treeObj){var node=treeObj.getNodeByParam('modelId',model._id());if(node&&model.idDs){var idDs=model.idDs();var name;if(idDs.length>0){name=idDs[0];name!==node.name&&(node.name=name,treeObj.updateNode(node));}else{node.name=I18n.resource.mainPanel.layerName.HEATP;treeObj.updateNode(node);}}}}
if(option.text&&propType&&propType.indexOf('update.option.text')>-1){temp=option.text.value;temp=Number(temp).toFixed(1);this.shape.text(temp);var ca=new CanvasHeatC();ca.data(temp);if(window.colorGettings){ca.max(window.colorGettings.max);ca.min(window.colorGettings.min);}else{ca.max(30);ca.min(20);}
var polygonColor=ca.color();var heatPolygon=this.painter.store.widgetModelSet.findByProperty('_id',polygonId);heatPolygon&&heatPolygon.update({'option.color':polygonColor});}
if(propType&&(propType.indexOf('update.x')>-1||propType.indexOf('update.y')>-1)){this.shape.x(model.x());this.shape.y(model.y());}
if(propType&&propType.indexOf('update.option.fill')>-1){}
if(propType&&propType.indexOf('update.option.polygonId')>-1){}
this.layer.draw();};CanvasHeatP.prototype=Mixin(CanvasHeatP.prototype,CanvasWidgetMixin);CanvasHeatP.prototype.x=function(){var model=this.store.model;return model.x()-model['option.radius']()*2;};CanvasHeatP.prototype.y=function(){var model=this.store.model;return model.y()-model['option.radius']();};CanvasHeatP.prototype.width=function(){return this.store.model['option.radius']()*2;};CanvasHeatP.prototype.height=function(){return this.store.model['option.radius']()*2;};CanvasHeatP.prototype.getType=function(){return'Combine';};CanvasHeatP.prototype.moveToBottom=function(){};CanvasHeatP.prototype=Mixin(CanvasHeatP.prototype,TooltipMixin);exports.CanvasHeatP=CanvasHeatP;})(namespace('widgets.factory'),namespace('widgets.factory.Widget'),namespace('mixins.CanvasWidgetMixin'),namespace('widgets.factory.CanvasHeatC'),namespace('mixins.TooltipMixin'));(function(CanvasPipe){function CanvasPipeWithAnimation(layer,model){CanvasPipe.apply(this,arguments);}
CanvasPipeWithAnimation.prototype=Object.create(CanvasPipe.prototype);CanvasPipeWithAnimation.prototype.constructor=CanvasPipeWithAnimation;CanvasPipeWithAnimation.prototype.update=function(){var model=this.store.model;var options=model.option();var isActive=0;if(options.text&&options.text.value){for(var k in options.text.value){if(parseInt(options.text.value[k])===1){isActive=1;}}}
this.shape.paint(isActive===1);this.layer.draw();};window.widgets=window.widgets||{};window.widgets.factory=window.widgets.factory||{};window.widgets.factory.CanvasPipe=CanvasPipeWithAnimation;})(window.widgets.factory.CanvasPipe);(function(exports,Widget,CanvasWidgetMixin){var _this;function CanvasPolygon(layer,model){Widget.apply(this,arguments);this.children=[];this.shape=undefined;_this=this;}
CanvasPolygon.prototype=Object.create(Widget.prototype);CanvasPolygon.prototype.constructor=CanvasPolygon;CanvasPolygon.prototype.init=function(){this._format();Widget.prototype.init.apply(this,arguments);};CanvasPolygon.prototype._format=function(){};CanvasPolygon.prototype.show=function(isPreview){var model=this.store.model;var option=model.option();var id=model._id(),points=option.points,color=option.color;var stroke,strokeWidth,opacity;this.shape=new Konva.Line({id:id,name:'polygon-line polygon-'+id,points:points,closed:true,stroke:!isPreview?'#111':'transparent',strokeWidth:!isPreview?2:0,fill:'transparent',lineJoin:'bevel'});this.layer.add(this.shape);this.layer.draw();this.update();this.attachEvents();};CanvasPolygon.prototype.update=function(e,propType){var model=this.store.model;var option=model.option();if(propType&&propType.indexOf('update.option.points')>-1){this.shape.points(option.points);}
if(e){this.layer.draw();}};CanvasPolygon.prototype.attachEvents=function(){};CanvasPolygon.prototype=Mixin(CanvasPolygon.prototype,CanvasWidgetMixin);CanvasPolygon.prototype.width=function(){return 0;};CanvasPolygon.prototype.height=function(){return 0;};CanvasPolygon.prototype.position=function(){return{x:0,y:0};};CanvasPolygon.prototype.getType=function(){return'Combine';};CanvasPolygon.prototype.moveToBottom=function(){};CanvasPolygon.prototype.getPoints=function(){return this.store.model['option.points']();};exports.CanvasPolygon=CanvasPolygon;})(namespace('widgets.factory'),namespace('widgets.factory.Widget'),namespace('mixins.CanvasWidgetMixin'));;(function(exports,SuperClass){function CanvasPolygon(){SuperClass.apply(this,arguments);}
CanvasPolygon.prototype=Object.create(SuperClass.prototype);+function(){this.constructor=CanvasPolygon;this.show=function(){var model=this.store.model;var events=model['option.events'](),event=events[0];SuperClass.prototype.show.apply(this,arguments);if(event&&event.type==='hover'){this._addToCarousel();}};this._addToCarousel=function(){if(this.painter._registerCarousel){this.painter._registerCarousel(this);}};this._disableCarousel=function(){};this._enableCarousel=function(){};this._fillImage=function(url){var _this=this;GUtil.loadImage(url,function(image){var page=_this.painter.getPageSize();_this.shape.fillPriority('pattern');_this.shape.fillPatternImage(image);_this.shape.fillPatternScaleX(page.w/image.width);_this.shape.fillPatternScaleY(page.h/image.height);_this.shape.cache();_this.shape.filters([Konva.Filters.Brighten]);});};this.playUp=function(){this.shape.fire('mouseenter');};this.playDown=function(){this.shape.fire('mouseleave');};this.attachEvents=function(){var _this=this;var model=this.store.model;var events=model['option.events']();var event;var layerStatus;var background;var tween;if(!events||!events.length){return;}
background=this.painter.getBgLayer().getBackground();if(background.type==='image'){this._fillImage(background.url);}
event=events[0];if(event.type==='hover'){this.shape.on('mouseenter',function(e){var status=event.layerMap;var maskShape;if(e.target){_this._disableCarousel();}
_this.shape.moveToTop();maskShape=_this.painter.getMaskShape();maskShape.setZIndex(_this.shape.getZIndex()-1);maskShape.show();_this.shape.brightness(0.1);if(!layerStatus){layerStatus=_this.painter.getLayerStatus();}
_this.painter.displayLayerByStatusMap(status);if(tween){tween.destroy();tween=null;}
tween=new Konva.Tween({node:maskShape,duration:.2,opacity:.4});tween.play();});this.shape.on('mouseleave',function(e){var maskShape=_this.painter.getMaskShape();if(e.target){_this._enableCarousel();}
maskShape.hide();maskShape.opacity(0);_this.shape.brightness(0);_this.painter.displayLayerByStatusMap(layerStatus);});}else if(event.type==='click'){}};}.call(CanvasPolygon.prototype);exports.CanvasPolygon=CanvasPolygon;})(namespace('widgets.factory'),namespace('widgets.factory.CanvasPolygon'));var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(exports,Widget,CanvasWidgetMixin){function CanvasText(layer,model){Widget.apply(this,arguments);}
CanvasText.prototype=Object.create(Widget.prototype);CanvasText.prototype.constructor=CanvasText;CanvasText.prototype.init=function(){this._format();Widget.prototype.init.apply(this,arguments);};CanvasText.prototype._format=function(){var options=this.store.model.option();this.store.model.option(options);};CanvasText.prototype.show=function(){var model=this.store.model;this.shape=new Konva.Text({id:model._id(),x:model.x(),y:model.y(),text:model['option.text'](),fontSize:model['option.fontSize'](),fontFamily:model['option.fontFamily'](),fill:model['option.fontColor'](),width:model.w(),align:model['option.textAlign']()});this.update();this.layer.add(this.shape);};CanvasText.prototype.update=function(e,propName){var model=this.store.model;var options=model.option();if(!propName||propName.indexOf('update.idDs')>-1){if($.fn.zTree){var treeObj=$.fn.zTree.getZTreeObj('parentTree');}
if(treeObj){var node=treeObj.getNodeByParam('modelId',model._id());if(node&&model.idDs){var idDs=model.idDs();var name;if(idDs.length>0){name=idDs[0];name!==node.name&&(node.name=name,treeObj.updateNode(node));}else{node.name=I18n.resource.mainPanel.layerName.TEXT;treeObj.updateNode(node);}}}}
if(!propName||propName.indexOf('update.x')>-1||propName.indexOf('update.y')>-1){this.shape.position({x:model.x()+model.w()/2,y:model.y()+model.h()/2});}
if(!propName||propName.indexOf('update.w')>-1||propName.indexOf('update.h')>-1){this.shape.position({x:model.x()+model.w()/2,y:model.y()+model.h()/2});this.shape.offset({x:model.w()/2,y:model.h()/2});this.shape.width(model.w());this.shape.height(model.h());}
if(!propName||propName.indexOf('update.option.fontFamily')>-1){this.shape.fontFamily(options.fontFamily);}
if(!propName||propName.indexOf('update.option.fontSize')>-1){this.shape.fontSize(options.fontSize);}
if(!propName||propName.indexOf('update.option.fontStyle')>-1){this.shape.fontStyle(options.fontStyle);}
var changePadding;if(!propName||propName.indexOf('update.option.textAlign')>-1){this.shape.align(options.textAlign);}
if(!propName||propName.indexOf('update.option.fontColor')>-1){this.shape.fill(options.fontColor);}
var value;if(typeof options.text==='string'){this.shape.text(options.text);}
else if(_typeof(options.text)==='object'){if(options.text.value!==''&&!isNaN(options.text.value)){value=parseFloat(options.text.value).toFixed(options.precision||2);}else{value=options.text.value;}
if(options.text.content.indexOf('<%value%>')===-1){this.shape.text(value);}else{this.shape.text(options.text.content.replace('<%value%>',value));}}
if(e){this.layer.draw();}};CanvasText.prototype=Mixin(CanvasText.prototype,CanvasWidgetMixin);CanvasText.prototype.type='CanvasText';exports.CanvasText=CanvasText;})(namespace('widgets.factory'),namespace('widgets.factory.Widget'),namespace('mixins.CanvasWidgetMixin'));(function(exports,facCanvasText,TooltipMixin){function CanvasText(layer,model){facCanvasText.apply(this,arguments);}
CanvasText.prototype=Object.create(facCanvasText.prototype);CanvasText.prototype.constructor=CanvasText;CanvasText.prototype.show=function(){var _this=this;var model=this.store.model;var screens=namespace('observer.screens');var options=model.option();var pageId=options.pageId;var pageType=options.pageType;var tpl='<div class="modal fade" id="buttonModal" style="display:none;">\
            <div class="modal-dialog" style="width: 80%; height: calc(100% - 60px);">\
                <div class="modal-content" style="width: 100%;height: 100%;border: none;">\
                    <div class="modal-header" style="border-bottom:0;height:0;min-height: 0;padding:0;">\
                        <button type="button" class="close" data-dismiss="modal" style="position:absolute;top:7px;\
                        right:5px;z-index:2;width:25px;height:25px;border-radius:12.5px;background:#fff;padding-bottom:2px;">\
                        <span aria-hidden="true">&times;</span></button>\
                    </div>\
                    <div class="modal-body" style="padding:0;width: 100%;height: 100%;overflow:hidden;z-index:1;"></div>\
                </div>\
            </div>\
        </div>';facCanvasText.prototype.show.apply(this,arguments);if(model.idDs().length){this.enableTooltip&&this.initTooltip({clickable:AppConfig.isFactory===0});}
if(pageId&&pageId!=''){this.shape.on('mouseover',function(){_this.page.painterCtn.style.cursor='pointer';});this.shape.on('mouseout',function(){_this.page.painterCtn.style.cursor='auto';});}
this.shape.on('click',function(e){var $modal;var floatScreen;if(!pageId){return;}
if(options.float===1){$modal=$(tpl);$modal.appendTo(document.body);$modal.one('shown.bs.modal',function(){floatScreen=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},$('.modal-body',$modal)[0]);floatScreen.show();});$modal.one('hidden.bs.modal',function(){floatScreen&&floatScreen.close();$modal.remove();});WebAPI.get('/factory/page/'+pageId).done(function(rs){var $modalDialog=$modal.find('.modal-dialog');var page;if(rs.status!=='OK'){return;}
page=rs.data;if(page.display===1){$modalDialog.width(page.width);$modalDialog.height(page.height+30);}
$modal.modal('show');});}else{floatScreen=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},_this.page.painterCtn);_this.page.painterCtn.style.cursor='default';_this.page.close();floatScreen.show();}});};CanvasText.prototype=Mixin(CanvasText.prototype,TooltipMixin);exports.CanvasText=CanvasText;})(namespace('widgets.factory'),namespace('widgets.factory.CanvasText'),namespace('mixins.TooltipMixin'));(function(exports,SuperClass,HtmlWidgetMixin){function HtmlContainer(layer,model){SuperClass.apply(this,arguments);}
HtmlContainer.prototype=Object.create(SuperClass.prototype);HtmlContainer.prototype.constructor=HtmlContainer;HtmlContainer.prototype.tpl='<div class="html-widget html-container"></div>';HtmlContainer.prototype.CSS_FORMAT_PATTERN=/([^\r\n,{}]+)(,(?=[^}]*{)|\s*(?={))/mg;HtmlContainer.prototype.JS_FORMAT_PATTERN=/(<script\b[^>]*>)([\s\S]*?)(<\/script>)/img;HtmlContainer.prototype.init=function(){this._format();SuperClass.prototype.init.apply(this,arguments);};HtmlContainer.prototype._format=function(){var options=this.store.model.option();if(!options.css){options.css='';}
if(!options.js){options.js='';}
if(!options.display){options.display=0;}
this.store.model.option(options);};HtmlContainer.prototype.show=function(){var model=this.store.model;SuperClass.prototype.show.apply(this,arguments);this.shape=HTMLParser(this.tpl);this.shape.id=model._id();this.shape.style.position='absolute';this.shape.style.border='1px dashed #aaa';this.update();this.layer.add(this.shape);};HtmlContainer.prototype.update=function(e,propName){var model=this.store.model;var options=model.option();if(!propName||propName.indexOf('update.x')>-1||propName.indexOf('update.y')>-1){this.shape.style.left=model.x()+'px';this.shape.style.top=model.y()+'px';}
if(!propName||propName.indexOf('update.w')>-1||propName.indexOf('update')>-1){this.shape.style.width=model.w()+'px';this.shape.style.height=model.h()+'px';}
if(!propName||propName.indexOf('update.option')>-1){this.preview();}
SuperClass.prototype.update.apply(this,arguments);Log.info('html container widget has been updated.');};HtmlContainer.prototype.preview=function(){var options=this.store.model.option();var formatCss,guid;if(options.html||options.css){guid=ObjectId();this.shape.style.background='none';formatCss=(options.css||'').replace(this.CSS_FORMAT_PATTERN,function($0,$1,$2){return'#hc_'+guid+' '+$0;}).replace('__container__','');this.shape.innerHTML=['<div class="ps-w-html-contaienr" id="hc_'+guid+'">',options.html||'','</div>','<style>',formatCss,'</style>'].join('');}else{this.shape.innerHTML='';this.shape.style.backgroundImage='url("/static/app/WebFactory/themes/default/images/demo/htmlContainer.png")';this.shape.style.backgroundSize='100% 100%';this.shape.style.backgroundColor='rgba(243, 219, 202, 0.35)';}};HtmlContainer.prototype=Mixin(HtmlContainer.prototype,HtmlWidgetMixin);HtmlContainer.prototype.type='HtmlContainer';exports.HtmlContainer=HtmlContainer;})(namespace('widgets.factory'),namespace('widgets.factory.HtmlWidget'),namespace('mixins.HtmlWidgetMixin'));(function(exports,FacHtmlContainer,ToolTipMixin){function HtmlContainer(){FacHtmlContainer.apply(this,arguments);this.instance=null;}
HtmlContainer.prototype=Object.create(FacHtmlContainer.prototype);HtmlContainer.prototype.constructor=HtmlContainer;HtmlContainer.prototype.show=function(){var model=this.store.model;var options=model.option();FacHtmlContainer.prototype.show.apply(this,arguments);this.shape.style.border='none';HtmlContainer.templateHelper.ins=this;this.instance=HtmlContainer.templateHelper.render(this.shape,options,this.page.options.params);this.store.model.serialize().idDs=this.instance.defer;};HtmlContainer.prototype.preview=function(){};HtmlContainer.prototype.update=function(e,propName){var model=this.store.model;var scale;FacHtmlContainer.prototype.update.apply(this,arguments);if(!propName||propName.indexOf('update.option.display')>-1){if(model['option.display']()===1){scale=this.painter.getScale();this.shape.style.left=model.x()*scale.x+'px';this.shape.style.top=model.y()*scale.y+'px';this.shape.style.width=model.w()*scale.x+'px';this.shape.style.height=model.h()*scale.y+'px';}}
if(propName&&propName.indexOf('update.option.text')>-1){this.instance&&this.instance.update(this.store.model.option().text.value);}};HtmlContainer.prototype.reload=function(params){var options=this.store.model.option();this.instance&&this.instance.close();this.instance=HtmlContainer.templateHelper.render(this.shape,options,params);this.store.model.serialize().idDs=this.instance.defer;};HtmlContainer.prototype.close=function(){this.instance&&this.instance.close();FacHtmlContainer.prototype.close.apply(this,arguments);};HtmlContainer.prototype=Mixin(HtmlContainer.prototype,ToolTipMixin);HtmlContainer.templateHelper={ins:null,render:function render(container,code,params,rootGuid){var _this=this;var guid=ObjectId();var formattedCode,_api;rootGuid=typeof rootGuid==='undefined'?guid:rootGuid;_api=namespace('__f_hc')[guid]=new TemplateAPI(guid,rootGuid,params);if(rootGuid!==guid){namespace('__f_hc')[rootGuid].children.push(guid);}
formattedCode=function(_api,container,code,params,guid){var scriptContent=[];var templateParseInfo=_this.getAttachedTemplate(code.html,params);var html=templateParseInfo.template;var htmlWrapTpl='<div class="ps-w-html-contaienr" id="hc_'+guid+'">|code|</div>';var jsWrapTpl=function(){return'(function(_api) {'+'var _params = _api.params, _container = _api.container = document.querySelector("#hc_'+guid+'");\ntry{\n'+'|code|\n}catch(e){console.error(e);};_api.__run(_container);}).call(null, window.__f_hc["'+guid+'"])';}();var cssWrapTpl='<style>|code|</style>';var formatHtml=html.replace(_this.ins.JS_FORMAT_PATTERN,function($0,$1,$2,$3){if($2.trim()!=='')scriptContent.push($2);return'';});var formatCss=code.css.replace(_this.ins.CSS_FORMAT_PATTERN,function($0,$1,$2){return'#hc_'+guid+' '+$0;}).replace(/\s+__container__/gm,'');var formatJs=jsWrapTpl.replace('|code|',code.js);formatCss=cssWrapTpl.replace('|code|',formatCss);formatHtml=htmlWrapTpl.replace('|code|',formatHtml);_api.tplParamList=templateParseInfo.list;return{html:formatHtml,css:formatCss,js:formatJs};}(_api,container,code,params,guid);(function(code,dsNameList){var parser=TextTemplateParser;code.html=code.html.replace(/([\w-]+?)="([^"]*<%[^<>]+?%>[^"]*)"/mg,function($0,$1,$2){var tokens=parser.parse($2,['<%','%>']);var infoStr;tokens.forEach(function(row){if(row.type===parser.types.binding){row.content='';if(dsNameList.indexOf(row.value)===-1){dsNameList.push(row.value);}}});infoStr=window.encodeURIComponent(JSON.stringify(tokens));return $1+'="" data-inner-ds-info="'+infoStr+'" data-inner-ds-attr="'+$1+'"';});code.html=code.html.replace(/<%([^<>]+?)%>/mg,function($0,$1){if(dsNameList.indexOf($1)===-1){dsNameList.push($1);}
return'<span class="text-node-placeholder" data-name="'+$1+'">'+$1+'</span>';});})(formattedCode,_api.dsNameList);container.innerHTML=[formattedCode.html,formattedCode.css].join('\n');(function(code){var done=false;var script=document.createElement("script");var head=document.getElementsByTagName("head")[0];script.type="text\/javascript";script.text=code;head.appendChild(script);head.removeChild(script);})(formattedCode.js);return{defer:_api.defer,close:function close(){_api.close();window.__f_hc[guid]=null;},update:function update(data){_api.update(data);},reload:function reload(data){}};},bindDs:function bindDs(container,guid){var worker=null;var _api=namespace('__f_hc.'+guid);var childrenGuid=_api.children||[];var dsNameList=[];var dataMap={};var templates=[_api];childrenGuid.forEach(function(id){templates.push(namespace('__f_hc.'+id));});templates.forEach(function(row){dsNameList=dsNameList.concat(row.dsNameList);});dsNameList.forEach(function(dsId){dataMap[dsId]=null;});dsNameList=Object.keys(dataMap).map(function(row){if(row.indexOf(',')>-1){return row.split(',')[0].trim();}
return row;});this.createDsBinding(container,dsNameList,dataMap={});return{screen:{close:function close(){window.__f_hc[guid]=null;}},dsList:dsNameList,dataMap:dataMap};},createDsBinding:function createDsBinding(container,dsNameList,ds){var _this=this;var $container=$(container);var textNodeMap={},attrNodeMap={};var $textNodes=$container.find('.text-node-placeholder');var $attrNodes=$container.find('[data-inner-ds-info]');dsNameList.forEach(function(name){var $nodes;if(($nodes=$textNodes.filter('[data-name^="'+name+'"]')).length){$nodes.each(function(){var text=document.createTextNode('');if(!textNodeMap[name]){textNodeMap[name]=[{name:this.getAttribute('data-name'),node:text}];}else{textNodeMap[name].push({name:this.getAttribute('data-name'),node:text});}
this.parentNode.replaceChild(text,this);});}else{textNodeMap[name]=[];}
if(($nodes=$attrNodes.filter('[data-inner-ds-info*="'+name+'"]')).length){$nodes.each(function(){var $this=$(this);var attr=$this.data('ds.attr');var info=$this.data('ds.info');if(attr===undefined){$this.data('ds.attr',attr=this.getAttribute('data-inner-ds-attr'));}
if(info===undefined){info=window.decodeURIComponent(this.getAttribute('data-inner-ds-info'));$this.data('ds.info',info=JSON.parse(info));}
if(!attrNodeMap[name]){attrNodeMap[name]=[{node:this.getAttributeNode(attr),info:info}];}else{attrNodeMap[name].push({node:this.getAttributeNode(attr),info:info});}});}else{attrNodeMap[name]=[];}
if(!ds.__observerProps)ds.__observerProps={};if(!ds.__observerProps.hasOwnProperty(name)){ds.__observerProps[name]=null;Object.defineProperty(ds,name,{get:function get(){return this.__observerProps[name];},set:function set(value){if(value===this.__observerProps[name])return;this.__observerProps[name]=value;textNodeMap[name].forEach(function(row){var content=row.name;var node=row.node;var idx=content.indexOf(',');var options;if(idx>-1){options=_this._parseOptionStr(content.substr(idx+1));node.data=_this._formatNumber(value,options);_this._formatNode(node,options,{dsId:content.substr(0,idx)});}else{node.data=isNaN(value)?_this._decodeHtml(value):parseFloat(value).toString();}});attrNodeMap[name].forEach(function(row){var info=row.info;var str='';info.forEach(function(row){var idx;if(row.type===TextTemplateParser.types.text){str+=row.value;}else if(row.type===TextTemplateParser.types.binding){if(row.value.indexOf(name)>-1){idx=row.value.indexOf(',');if(idx>-1){row.content=_this._formatNumber(value,_this._parseOptionStr(row.value.substr(idx+1)));}else{row.content=isNaN(value)?value:parseFloat(value).toString();}}
str+=row.content;}});row.node.value=str;});}});}});$attrNodes.each(function(){this.removeAttribute('data-inner-ds-info');this.removeAttribute('data-inner-ds-attr');});},_parseOptionStr:function _parseOptionStr(optionStr){var arr=optionStr.split(',');var opt={};arr.forEach(function(kv){var kvArr=kv.split('=');if(kvArr.length===1){opt[kv]='true';}else{opt[kvArr[0]]=kvArr[1];}});return opt;},_formatNumber:function _formatNumber(num,options){var rs='';var toString=Object.prototype.toString;var decimalPortion;var numstr,isNegative;if(isNaN(num))return num;num=parseFloat(num);isNegative=num<0;num=Math.abs(num);if(!isNaN(options.p)){options.p=parseInt(options.p);num=num.toFixed(options.p);}
decimalPortion=(num+'').split('.')[1]||'';num=parseInt(num);if(options.ts==='true'){numstr=num+'';while(numstr.length>3){rs=','+numstr.substr(-3,3)+rs;numstr=numstr.substr(0,numstr.length-3);}
rs=numstr+rs;}else{rs=num+'';}
rs=decimalPortion===''?rs:rs+'.'+decimalPortion;if(parseFloat(rs)===0){return rs;}
return(isNegative?'-':'')+rs;},_formatNode:function _formatNode(node,options,params){var domWrap;if(options.draggable&&!node.parentNode.dataset.h5DraggableNode){domWrap=document.createElement('span');node.parentNode.insertBefore(domWrap,node);domWrap.appendChild(node);this.ins.enableTooltip&&this.ins.initTooltip({shape:domWrap,ds:params.dsId,container:this.ins.page.painterCtn,clickable:AppConfig.isFactory===0});}},_decodeHtml:function _decodeHtml(html){var txt=document.createElement("textarea");txt.innerHTML=html;return txt.value;},getAttachedTemplate:function getAttachedTemplate(template,params){var pattern=/<#\s*(\w*?)\s*#>/mg;var list=[];if(params){template=template.replace(pattern,function($0,$1){list.push($1);if(!params[$1]){return $0;}
return params[$1];});}
return{template:template,list:list};},getTemplateParamList:function getTemplateParamList(template){var pattern=/<#\s*(\w*?)\s*#>/mg;var match,list=[];while(match=pattern.exec(template)){list.push(match[1]);}
return list;}};var TemplateAPI=function(){var templateLoading={};var templateCache={};function TemplateAPI(guid,rootGuid,params){this.dataMap={};this.obDataMap={};this.__tplRequests=[];this.rootGuid=rootGuid;this.guid=guid;this.params=params;this.tplParamList=[];this.dsNameList=[];this.children=[];this.defer=$.Deferred();}
+function(){this.__getTemplate=function(templateId){var promise;if(templateCache[templateId]){promise=$.Deferred();promise.resolve(templateCache[templateId]);return promise;}
else if(templateLoading[templateId]){return templateLoading[templateId];}
else{promise=WebAPI.get('/factory/template/'+templateId);templateLoading[templateId]=promise;promise.done(function(data){templateCache[templateId]=data;}).always(function(){templateLoading[templateId]=null;});return promise;}};this.__run=function(){var _this=this;var promise=$.Deferred();var requests=this.__tplRequests;var requestMap={};var defers=[];var templateHelper=namespace('widgets.factory.HtmlContainer.templateHelper');var screen=$(this.container).data('f.hc');if(screen)screen.close();if(!requests.length){promise.resolve();}else{requests.forEach(function(req){if(!requestMap.hasOwnProperty(req.templateId)){requestMap[req.templateId]=[];}
requestMap[req.templateId].push(req);});Object.keys(requestMap).forEach(function(templateId){var row=requestMap[templateId];var d=_this.__getTemplate(templateId);var defer=d.then(function(data){var type=data.type;var content=data.content;var deferArr=[];deferArr=row.map(function(item){var container=item['container'];var params=item['params'];var screen=$(container).data('f.hc');var html;if(screen)screen.close();if(type==='page'){if(params)content.template=templateHelper.getAttachedTemplate(content.template,params)['template'];screen=new(namespace('observer.screens').PageScreen)({params:params,template:{page:{width:content.width,height:content.height,display:content.display},data:JSON.parse(content.template)}},container);screen.show();$(container).data('f.hc',screen);return;}
else if(type==='widget.HtmlContainer'){if(params)html=templateHelper.getAttachedTemplate(content.html,params)['template'];screen=namespace('widgets.factory.HtmlContainer.templateHelper').render(container,{html:html,css:content.css,js:content.js},params,_this.rootGuid);$(container).data('f.hc',screen);return screen.defer;}}).filter(function(row){return!!row;});return $.when.apply($,deferArr);});defers.push(defer);});$.when.apply($,defers).fail(function(){console.error('有模板加载失败！');}).always(function(){promise.resolve();});}
return promise.then(function(){var rs;if(_this.rootGuid!==_this.guid){return;}
rs=namespace('widgets.factory.HtmlContainer.templateHelper').bindDs(_this.container,_this.guid);$(_this.container).data('f.hc',rs.screen);templateCache={};_this.obDataMap=rs.dataMap;return rs.dsList;}).always(function(dsList){_this.defer.resolve(dsList);});};this.render=function(container,templateId,params){var _this=this;this.__tplRequests.push({container:container,templateId:templateId,params:params});return;};this.update=function(data){var _this=this;var childrenGuid=this.children||[];var dsNameList=[];var dataMap={};var templates=[this];if(this.guid!==this.rootGuid){Log.warn('Only the top-level template in a "HtmlContainer" can use "_api.update" method!');return;}
childrenGuid.forEach(function(id){templates.push(namespace('__f_hc.'+id));});Object.keys(data).forEach(function(key){_this.obDataMap[key]=data[key];});templates.forEach(function(row){row.dsNameList.forEach(function(dsId){row.dataMap[dsId]=data[dsId];});typeof row.onUpdated==='function'&&row.onUpdated.call(null,row.dataMap);});};this.getHistoryData=function(params){return WebAPI.post('/analysis/startWorkspaceDataGenHistogram',params);};this.close=function(){if(this.container){this.container.innerHTML='';}};}.call(TemplateAPI.prototype);return TemplateAPI;}();var TextTemplateParser=function(){function TextTemplateParser(){}
TextTemplateParser.types={text:0,binding:1};TextTemplateParser.parse=function(template,delimiters){var index,lastIndex,lastToken,length,substring,tokens,value;tokens=[];length=template.length;index=lastIndex=0;while(lastIndex<length){index=template.indexOf(delimiters[0],lastIndex);if(index<0){tokens.push({type:this.types.text,value:template.slice(lastIndex)});break;}else{if(index>0&&lastIndex<index){tokens.push({type:this.types.text,value:template.slice(lastIndex,index)});}
lastIndex=index+delimiters[0].length;index=template.indexOf(delimiters[1],lastIndex);if(index<0){substring=template.slice(lastIndex-delimiters[0].length);lastToken=tokens[tokens.length-1];if((lastToken!==undefined?lastToken.type:void 0)===this.types.text){lastToken.value+=substring;}else{tokens.push({type:this.types.text,value:substring});}
break;}
value=template.slice(lastIndex,index).trim();tokens.push({type:this.types.binding,value:value});lastIndex=index+delimiters[1].length;}}
return tokens;};return TextTemplateParser;}();exports.HtmlContainer=HtmlContainer;})(namespace('widgets.factory'),namespace('widgets.factory.HtmlContainer'),namespace('mixins.TooltipMixin'));var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(exports,SuperClass,HtmlWidgetMixin){function HtmlButton(layer,model){SuperClass.apply(this,arguments);}
HtmlButton.prototype=Object.create(SuperClass.prototype);HtmlButton.prototype.constructor=HtmlButton;HtmlButton.prototype.tpl='<button class="html-widget html-btn"></button>';HtmlButton.prototype.init=function(){this._format();SuperClass.prototype.init.apply(this,arguments);};HtmlButton.prototype._format=function(){var options=this.store.model.option();if(options.pageId==undefined){options.pageId='';}
if(options.pageType==undefined){options.pageType='';}
if(!options.float){options.float=0;}
if(!options.preview){options.preview=[];}
this.store.model.option(options);};HtmlButton.prototype.show=function(){var model=this.store.model;SuperClass.prototype.show.apply(this,arguments);this.shape=HTMLParser(this.tpl);this.shape.id=model._id();this.shape.style.position='absolute';this.update();this.layer.add(this.shape);this.fixZoom();};HtmlButton.prototype.update=function(e,propName){var model=this.store.model;var options=model.option();if(!propName||propName.indexOf('update.x')>-1||propName.indexOf('update.y')>-1){this.shape.style.left=model.x()+'px';this.shape.style.top=model.y()+'px';}
if(!propName||propName.indexOf('update.w')>-1||propName.indexOf('update.h')>-1){this.shape.style.width=model.w()+'px';this.shape.style.height=model.h()+'px';}
this.shape.classList.add(options.class===''?undefined:options.class);this.shape.innerHTML=options.text;if(!propName||propName.indexOf('update.idDs')>-1){if($.fn.zTree){var treeObj=$.fn.zTree.getZTreeObj('parentTree');}
if(treeObj){var node=treeObj.getNodeByParam('modelId',model._id());if(node&&model.idDs){var idDs=model.idDs();var name;if(idDs.length>0){name=idDs[0];name!==node.name&&(node.name=name,treeObj.updateNode(node));}else{node.name=I18n.resource.mainPanel.layerName.BUTTON;treeObj.updateNode(node);}}}}
if(typeof options.text==='string'){this.shape.innerHTML=options.text;}else if(_typeof(options.text)==='object'){if(options.text.content.indexOf('<%value%>')===-1){this.shape.innerHTML=options.text.value;}else{this.shape.innerHTML=options.text.content.replace('<%value%>',options.text.value);}}
if(options.style){var initStyle=options.style;var normalStyle=initStyle.replace(/.Normal/g,'#'+model._id().toHexString());var head=document.head||document.getElementsByTagName('head')[0],style=document.createElement('style');style.id='style-'+model._id();if(style.stylesheet){style.stylesheet.cssText=normalStyle;}else{style.appendChild(document.createTextNode(normalStyle));}
if(document.getElementById(style.id)){$('#'+style.id).remove();}
head.appendChild(style);}else{$('#style-'+model._id()).remove();}
SuperClass.prototype.update.apply(this,arguments);Log.info('html button widget has been updated.');};HtmlButton.prototype=Mixin(HtmlButton.prototype,HtmlWidgetMixin);HtmlButton.prototype.type='HtmlButton';exports.HtmlButton=HtmlButton;})(namespace('widgets.factory'),namespace('widgets.factory.HtmlWidget'),namespace('mixins.HtmlWidgetMixin'));(function(FacHtmlButton){function HtmlButton(layer,model){FacHtmlButton.apply(this,arguments);}
HtmlButton.prototype=Object.create(FacHtmlButton.prototype);HtmlButton.prototype.constructor=HtmlButton;HtmlButton.prototype.showS3dbModal=function(pageId,title){if(ScreenModal)ScreenModal.close();ScreenModal=new ObserverScreen(pageId);title&&(ScreenModal.title=title);ScreenModal.isDetailPage=true;ScreenModal.show();};HtmlButton.prototype.show=function(){var _this=this;var model=this.store.model;var screens=namespace('observer.screens');var options=model.option();var pageId=options.pageId;var pageType=options.pageType;var tpl;FacHtmlButton.prototype.show.apply(this,arguments);if(!pageId){return;}
tpl='<div class="modal fade" id="buttonModal" style="display:none;">\
            <div class="modal-dialog" style="width: 80%; height: calc(100% - 60px);">\
                <div class="modal-content" style="width: 100%;height: 100%;border: none;">\
                    <div class="modal-header" style="border-bottom:0;height:0;min-height: 0;padding:0;">\
                        <button type="button" class="close" data-dismiss="modal" style="position:absolute;top:7px;\
                        right:5px;z-index:2;width:25px;height:25px;border-radius:12.5px;background:#fff;padding-bottom:2px;">\
                        <span aria-hidden="true">&times;</span></button>\
                    </div>\
                    <div class="modal-body" style="padding:0;width: 100%;height: 100%;overflow:hidden;z-index:1;"></div>\
                </div>\
            </div>\
        </div>';$(this.shape).off('click').on('click',function(){var $modal;var floatScreen;if(!pageId){return;}
if(pageType==='s3db'){if(AppConfig.isFactory){alert('s3db 页面只支持在主网站中进行查看!');}else{_this.page.painterCtn.style.cursor='default';if(options.float===1){_this.showS3dbModal(pageId);}else{_this.page.close();Spinner.spin(ElScreenContainer);ScreenManager.goTo({page:'ObserverScreen',id:pageId});}}
return;}else{if(options.float===1){$modal=$(tpl);$modal.appendTo(document.body);$modal.one('shown.bs.modal',function(){floatScreen=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},$('.modal-body',$modal)[0]);floatScreen.show();});$modal.one('hidden.bs.modal',function(){floatScreen&&floatScreen.close();$modal.remove();});WebAPI.get('/factory/page/'+pageId).done(function(rs){var $modalDialog=$modal.find('.modal-dialog');var page;if(rs.status!=='OK'){return;}
page=rs.data;if(page.display===1){$modalDialog.width(page.width);$modalDialog.height(page.height+30);}
$modal.modal('show');});}else{floatScreen=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},_this.page.painterCtn);_this.page.painterCtn.style.cursor='default';_this.page.close();floatScreen.show();}}});};window.widgets.factory.HtmlButton=HtmlButton;})(window.widgets.factory.HtmlButton);(function(exports,Widget,CanvasWidgetMixin){function CanvasDevice(layer,model){Widget.apply(this,arguments);this.painter=layer.painter;this.text=[];this.image=null;this.lastInfo={x:null,y:null,w:null,h:null};}
CanvasDevice.prototype=Object.create(Widget.prototype);CanvasDevice.prototype.constructor=CanvasDevice;CanvasDevice.prototype.tpl='<div class="html-widget html-device"></div>';CanvasDevice.prototype.init=function(){this._format();Widget.prototype.init.apply(this,arguments);};CanvasDevice.prototype._format=function(){};CanvasDevice.prototype.show=function(){var model=this.store.model;this.lastInfo.x=model.x();this.lastInfo.y=model.y();this.lastInfo.w=model.w();this.lastInfo.h=model.h();this.shape=new Konva.Rect({id:model._id(),fill:'transparent'});this.update();this.layer.add(this.shape);};CanvasDevice.prototype.updateChildren=function(){var model=this.store.model;var dx=model.x()-this.lastInfo.x;var dy=model.y()-this.lastInfo.y;var sW=model.w()/this.lastInfo.w;var sH=model.h()/this.lastInfo.h;this.text.forEach(function(row){row.update({x:dx+(row.x()-model.x())*sW+model.x(),y:dy+(row.y()-model.y())*sH+model.y()});});if(this.image){this.image&&this.image.update({x:dx+(this.image.x()-model.x())*sW+model.x(),y:dy+(this.image.y()-model.y())*sH+model.y()});}};CanvasDevice.prototype.update=function(e,propName){var _this=this;var model=this.store.model;var options=model.option();var modelsNeedBeAdded=[],modelsNeedBeRemoved=[];var map;if(!propName||propName.indexOf('update.idDs')>-1){if($.fn.zTree){var treeObj=$.fn.zTree.getZTreeObj('parentTree');}
if(treeObj){var node=treeObj.getNodeByParam('modelId',model._id());if(node&&model.idDs){var idDs=model.idDs();var name;if(idDs.length>0){name=idDs[0];name!==node.name&&(node.name=name,treeObj.updateNode(node));}else{node.name=I18n.resource.mainPanel.layerName.DEVICE;treeObj.updateNode(node);}}}}
this.shape.position({x:model.x(),y:model.y()});this.shape.width(model.w());this.shape.height(model.h());this.updateChildren();this.lastInfo.x=model.x();this.lastInfo.y=model.y();this.lastInfo.w=model.w();this.lastInfo.h=model.h();if(propName&&propName.indexOf('update.option.tag')>-1){map=function(){var map={};_this.text.forEach(function(row){var type=row.option().attrType;if(typeof type!=='undefined'){map[type]=row;}});return map;}();Object.keys(options.tag).forEach(function(row){var opt;if(!map[row]){opt=window.TText.prototype.createEntity();opt._id=ObjectId();opt.x=10+model.x();opt.y=10+model.y();opt.w=100;opt.h=50;opt.option.text=row;opt.option.attrType=row;opt.groupId=model._id();opt.layerId='';if(options.tag[row].ds){opt.idDs=[options.tag[row].ds];}
modelsNeedBeAdded.push(new Model(opt));}else{map[row]=null;}});Object.keys(map).forEach(function(row){if(map[row]!==null){modelsNeedBeRemoved.push(map[row]);}});this.getPainter().store.widgetModelSet.remove(modelsNeedBeRemoved);this.getPainter().store.widgetModelSet.append(modelsNeedBeAdded);}
if(propName&&propName.indexOf('update.option.skin')>-1){WebAPI.get('/iot/getClassDetail/'+options.iotStore.type+'/cn').done(function(rs){var index=options.skin.index;var skin=rs.skin[0]['list'][index];var imageModel,imageId;var promise=$.Deferred();var actualW;if(!skin){Log.warn('has not found skin in '+options.iotStore.type+'\'s skins at index '+index);return;}
imageId=skin.content.trigger['default'];imageModel=_this.store.imageModelSet.findByProperty('_id',imageId);if(!imageModel){WebAPI.post('/factory/material/getByIds',{ids:[imageId]}).done(function(rs){imageModel=new Model($.extend(false,{_id:rs[0]._id,groupId:model._id()},rs[0].content));_this.store.imageModelSet.append(imageModel);promise.resolve();});}else{promise.resolve();}
promise.done(function(){var params;var imageW=imageModel.interval()===0?imageModel.w():imageModel.w()/imageModel.pf();var imageH=imageModel.h();var x=model.x()+(model.w()-imageW)/2;var y=model.y()+(model.h()-imageModel.h())/2;params=$.extend(false,{_id:ObjectId(),layerId:'',groupId:model._id(),x:x,y:y,w:imageW,h:imageH},window.TImage.prototype.createEntity());params.option.trigger=skin.content.trigger;if(!_this.image){_this.getPainter().store.widgetModelSet.append(new NestedModel(params));}else{_this.image.update({x:params.x,y:params.y,w:params.w,h:params.h,'option.trigger':params.option.trigger});}});});}};CanvasDevice.prototype.getCloneModels=function(pos,_id){var arr=[];var options,id;var model=this.store.model;options=$.extend(true,{},model.serialize());options._id=id=_id==undefined?ObjectId():_id;options.x=pos.x;options.y=pos.y;arr.push(new NestedModel(options));arr=arr.concat(this.text.map(function(row){var options=$.extend(true,{},row.serialize());options._id=ObjectId();options.x+=pos.dx;options.y+=pos.dy;options.groupId=id;return new NestedModel(options);}));options=$.extend(true,{},this.image.serialize());options._id=ObjectId();options.x+=pos.dx;options.y+=pos.dy;options.groupId=id;arr.push(new NestedModel(options));return{id:id,list:arr};};CanvasDevice.prototype.add=function(model){var type=model.type();if(type==='HtmlText'){this.text.push(model);}else if(type==='CanvasImage'){this.image=model;}};CanvasDevice.prototype.remove=function(model){var type=model.type();if(type==='HtmlText'){for(var i=0,len=this.text.length;i<len;i+=1){if(this.text[i]===model){return this.text.splice(i,1);}}}else if(type==='CanvasImage'){this.image=null;}};CanvasDevice.prototype.close=function(){var modelSet=this.painter.store.widgetModelSet;Widget.prototype.close.apply(this,arguments);modelSet.remove(this.text);modelSet.remove(this.image);};CanvasDevice.prototype=Mixin(CanvasDevice.prototype,CanvasWidgetMixin);CanvasDevice.prototype.type='CanvasDevice';exports.CanvasDevice=CanvasDevice;})(namespace('widgets.factory'),namespace('widgets.factory.Widget'),namespace('mixins.CanvasWidgetMixin'));(function(exports,SuperClass){function CanvasDevice(layer,model){SuperClass.apply(this,arguments);}
CanvasDevice.prototype=Object.create(SuperClass.prototype);CanvasDevice.prototype.constructor=CanvasDevice;CanvasDevice.prototype.show=function(){var options=_this.store.model.option();};exports.CanvasDevice=CanvasDevice;})(namespace('widgets.observer'),namespace('widgets.factory.CanvasDevice'));var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(exports,SuperClass,HtmlWidgetMixin){function HtmlText(layer,model){SuperClass.apply(this,arguments);}
HtmlText.prototype=Object.create(SuperClass.prototype);HtmlText.prototype.constructor=HtmlText;HtmlText.prototype.tpl='<p class="html-widget html-text"></p>';HtmlText.prototype.init=function(){this._format();SuperClass.prototype.init.apply(this,arguments);};HtmlText.prototype._format=function(){var model=this.store.model;var options=model.option();if(options.pageId==undefined){options.pageId='';}
if(options.pageType==undefined){options.pageType='';}
if(!options.float){options.float=0;}
if(!options.preview){options.preview=[];}
if(typeof options.precision==='string'){options.precision=parseInt(options.precision);}
if(!options.equipments){options.equipments=[];}
this.store.model.option(options);};HtmlText.prototype.show=function(){var model=this.store.model;SuperClass.prototype.show.apply(this,arguments);this.shape=HTMLParser(this.tpl);this.shape.id=model._id();this.shape.style.position='absolute';this.update();this.layer.add(this.shape);this.fixZoom();};HtmlText.prototype.update=function(e,propName){var model=this.store.model;var options=model.option();var value;if(!propName||propName.indexOf('update.idDs')>-1){if($.fn.zTree){var treeObj=$.fn.zTree.getZTreeObj('parentTree');}
if(treeObj){var node=treeObj.getNodeByParam('modelId',model._id());if(node&&model.idDs){var idDs=model.idDs();var name;if(idDs.length>0){name=idDs[0];name!==node.name&&(node.name=name,treeObj.updateNode(node));}else{node.name=I18n.resource.mainPanel.layerName.TEXT;treeObj.updateNode(node);}}}}
if(!propName||propName.indexOf('update.x')>-1||propName.indexOf('update.y')>-1){this.shape.style.left=model.x()+'px';this.shape.style.top=model.y()+'px';}
if(!propName||propName.indexOf('update.w')>-1||propName.indexOf('update.h')>-1){this.shape.style.width=model.w()+'px';this.shape.style.height=model.h()+'px';}
if(typeof options.text==='string'){this.shape.innerHTML=options.text;}
else if(_typeof(options.text)==='object'){if(options.text.value!==''&&!isNaN(options.text.value)){value=parseFloat(options.text.value).toFixed(options.precision||2);}else{value=options.text.value;}
if(options.text.content.indexOf('<%value%>')===-1){this.shape.innerHTML=value;}else{this.shape.innerHTML=options.text.content.replace('<%value%>',value);}}
this.shape.classList.add(options.class===''?undefined:options.class);if(options.style){var initStyle=options.style;var normalStyle=initStyle.replace(/.Normal/g,'#'+model._id().toHexString());var head=document.head||document.getElementsByTagName('head')[0],style=document.createElement('style');style.id='style-'+model._id();if(style.stylesheet){style.stylesheet.cssText=normalStyle;}else{style.appendChild(document.createTextNode(normalStyle));}
if(document.getElementById(style.id)){$('#'+style.id).remove();}
head.appendChild(style);}else{$('#style-'+model._id()).remove();}
SuperClass.prototype.update.apply(this,arguments);Log.info('html text widget has been updated.');};HtmlText.prototype=Mixin(HtmlText.prototype,HtmlWidgetMixin);HtmlText.prototype.type='HtmlText';exports.HtmlText=HtmlText;})(namespace('widgets.factory'),namespace('widgets.factory.HtmlWidget'),namespace('mixins.HtmlWidgetMixin'));(function(exports,FacHtmlText,TooltipMixin){var ERRTIP_DELAY=1000;var $errTip=null;var errTipTimer=null;var errTip={show:function show(){$errTip&&$errTip.css({'display':'','opacity':1});if(errTipTimer){window.clearTimeout(errTipTimer);errTipTimer=null;}},hide:function hide(){if(!errTipTimer){errTipTimer=window.setTimeout(function(){$errTip&&$errTip.css('opacity',0);errTipTimer=null;},ERRTIP_DELAY);}}};var errTipTemplate='<div class="gray-scrollbar" id="errTip"></div>';function HtmlText(layer,model){FacHtmlText.apply(this,arguments);}
HtmlText.prototype=Object.create(FacHtmlText.prototype);HtmlText.prototype.constructor=HtmlText;HtmlText.prototype.show=function(){var _this=this;var model=this.store.model;var screens=namespace('observer.screens');var options=model.option();var pageId=options.pageId;var pageType=options.pageType;var tpl='<div class="modal fade" id="buttonModal" style="display:none;">\
            <div class="modal-dialog" style="width: 80%; height: calc(100% - 60px);">\
                <div class="modal-content" style="width: 100%;height: 100%;border: none;">\
                    <div class="modal-header" style="border-bottom:0;height:0;min-height: 0;padding:0;">\
                        <button type="button" class="close" data-dismiss="modal" style="position:absolute;top:7px;\
                        right:5px;z-index:2;width:25px;height:25px;border-radius:12.5px;background:#fff;padding-bottom:2px;">\
                        <span aria-hidden="true">&times;</span></button>\
                    </div>\
                    <div class="modal-body" style="padding:0;width: 100%;height: 100%;overflow:hidden;z-index:1;"></div>\
                </div>\
            </div>\
        </div>';$(this.shape).off();FacHtmlText.prototype.show.apply(this,arguments);if(model.idDs().length){this.enableTooltip&&this.initTooltip({clickable:AppConfig.isFactory===0});}
if(pageId&&pageId!=''){this.shape.style.cursor='pointer';}
$(this.shape).on('click',function(){var $modal;var floatScreen;if(!pageId){return;}
if(options.float===1){$modal=$(tpl);$modal.appendTo(document.body);$modal.one('shown.bs.modal',function(){floatScreen=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},$('.modal-body',$modal)[0]);floatScreen.show();});$modal.one('hidden.bs.modal',function(){floatScreen&&floatScreen.close();$modal.remove();});WebAPI.get('/factory/page/'+pageId).done(function(rs){var $modalDialog=$modal.find('.modal-dialog');var page;if(rs.status!=='OK'){return;}
page=rs.data;if(page.display===1){$modalDialog.width(page.width);$modalDialog.height(page.height+30);}
$modal.modal('show');});}else{floatScreen=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},_this.page.painterCtn);_this.page.painterCtn.style.cursor='default';_this.page.close();floatScreen.show();}});};HtmlText.prototype.update=function(e,propName){var model=this.store.model;var faults;var maxGrade;if(propName&&propName.indexOf('update.option.faults')>-1){faults=model['option.faults']();this.shape.classList.remove('level-normal','level-warn','level-danger');if(faults.length){faults.forEach(function(row){if(typeof maxGrade==='undefined'||row.grade>maxGrade){maxGrade=row.grade;}});if(maxGrade>1){this.shape.classList.add('level-danger');}else if(maxGrade>0){this.shape.classList.add('level-warn');}else{this.shape.classList.add('level-normal');}}
this._attachHoverEvents();}
FacHtmlText.prototype.update.apply(this,arguments);};HtmlText.prototype._attachHoverEvents=function(){var _this=this;var faults=this.store.model['option.faults']();var $shape=$(this.shape);$shape.off('hover');if(!faults.length){errTip.hide();return;}
$shape.hover(function(e){var container=_this.painter.domContainer;var offset=$(container).offset();_this._createErrTip();_this.checkPopoverBoundary(container,$errTip,e.pageX-offset.left,e.pageY-offset.top);errTip.show();e.stopPropagation();},function(e){errTip.hide();e.stopPropagation();});};HtmlText.prototype._returnToMoment=function(date){this.painter.getPage().enterReplayMode(new Date(date));};HtmlText.prototype._createErrTip=function(){var $find=$(),$each,_this=this;var faults=this.store.model['option.faults']();if(!$errTip||$errTip.length===0){$errTip=$(errTipTemplate);$errTip.on('mouseenter',function(e){errTip.show();e.stopPropagation();}).on('mouseleave',function(e){errTip.hide();e.stopPropagation();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();}).on('click','.err-replay',function(){var $this=$(this);var date=$this.siblings('span[data-time]')[0].dataset.time;_this._returnToMoment(date);});}
if(!$.contains(this.painter.domContainer,errTip[0])){$(this.painter.domContainer).append($errTip);}
for(var i=0,len=faults.length;i<len;i++){$each=$('#divPaneNotice').find('[faultid="'+faults[i].faultId+'"]').clone(true);$each.each(function(){this.onmouseenter=null;this.onmouseleave=null;});$('<span class="glyphicon glyphicon-play span-hover-pointer grow err-replay"></span>').appendTo($each.children('div')[0]);$find=$find.add($each);}
$errTip.html($find);return $errTip;};HtmlText.prototype._checkPopoverBoundary=function(container,$popover,pageX,pageY){var $container=$(container),offsetX=10,offsetY=0,popoverWidth=$popover.width(),popoverHeight=$popover.height(),rightX=Math.min(pageX+popoverWidth+offsetX,$container.width()-5),rightY=Math.min(pageY+popoverHeight+offsetY,$container.height()-5);$popover.css({left:rightX-popoverWidth+offsetX,top:rightY-popoverHeight+offsetY});};HtmlText.prototype=Mixin(HtmlText.prototype,TooltipMixin);exports.HtmlText=HtmlText;})(namespace('widgets.factory'),namespace('widgets.factory.HtmlText'),namespace('mixins.TooltipMixin'));(function(exports,SuperClass,HtmlWidgetMixin){function HtmlScreenContainer(layer,model){SuperClass.apply(this,arguments);}
HtmlScreenContainer.prototype=Object.create(SuperClass.prototype);HtmlScreenContainer.prototype.constructor=HtmlScreenContainer;HtmlScreenContainer.prototype.tpl='<div class="html-widget html-screen"></div>';HtmlScreenContainer.prototype.show=function(){var model=this.store.model;SuperClass.prototype.show.apply(this,arguments);this.shape=HTMLParser(this.tpl);this.shape.id=model._id();this.shape.style.position='absolute';this.shape.style.backgroundImage='url("/static/app/WebFactory/themes/default/images/demo/htmlScreen.png")';this.shape.style.backgroundSize='100% 100%';this.shape.style.backgroundColor='rgba(238, 238, 238,0.6)';this.update();this.layer.add(this.shape);};HtmlScreenContainer.prototype.update=function(){var model=this.store.model;var options=model.option();this.shape.style.left=model.x()+'px';this.shape.style.top=model.y()+'px';this.shape.style.width=model.w()+'px';this.shape.style.height=model.h()+'px';if(!model.option().pageId){model.option().pageId='';}
if(!model.option().pageType){model.option().pageType='';}
if(options.style){var initStyle=options.style;var normalStyle=initStyle.replace(/.Normal/g,'#'+model._id().toHexString());var head=document.head||document.getElementsByTagName('head')[0],style=document.createElement('style');style.id='style-'+model._id();if(style.stylesheet){style.stylesheet.cssText=normalStyle;}else{style.appendChild(document.createTextNode(normalStyle));}
if(document.getElementById(style.id)){$('#'+style.id).remove();}
head.appendChild(style);}else{$('#style-'+model._id()).remove();}
SuperClass.prototype.update.apply(this,arguments);Log.info('html container widget has been updated.');};HtmlScreenContainer.prototype=Mixin(HtmlScreenContainer.prototype,HtmlWidgetMixin);HtmlScreenContainer.prototype.type='HtmlScreenContainer';exports.HtmlScreenContainer=HtmlScreenContainer;})(namespace('widgets.factory'),namespace('widgets.factory.HtmlWidget'),namespace('mixins.HtmlWidgetMixin'));(function(FacHtmlScreenContainer){function HtmlScreenContainer(layer,model){FacHtmlScreenContainer.apply(this,arguments);}
HtmlScreenContainer.prototype=Object.create(FacHtmlScreenContainer.prototype);HtmlScreenContainer.prototype.constructor=HtmlScreenContainer;HtmlScreenContainer.prototype.show=function(){var model=this.store.model;var screens=namespace('observer.screens');var options=model.option();FacHtmlScreenContainer.prototype.show.apply(this,arguments);this.shape.style.background='none';var pageId=options.pageId;var pageType=options.pageType;if(!pageId){return;}
this.page=new screens[pageType||'PageScreen']({id:pageId,isFactory:AppConfig.isFactory},this.shape);this.page.show();};HtmlScreenContainer.prototype.close=function(){FacHtmlScreenContainer.prototype.close.apply(this,arguments);if(this.page){this.page.close();this.page=null;}};window.widgets.factory.HtmlScreenContainer=HtmlScreenContainer;})(window.widgets.factory.HtmlScreenContainer);;(function(exports,SuperClass,HtmlWidgetMixin){function HtmlDashboard(layer,model){SuperClass.apply(this,arguments);this.ins=null;this.modalConfigPane=null;}
HtmlDashboard.prototype=Object.create(SuperClass.prototype);HtmlDashboard.prototype.constructor=HtmlDashboard;HtmlDashboard.prototype.tpl='<div class="html-widget html-container"></div>';HtmlDashboard.prototype.initModalConfigPane=function(){var page=this.painter.getPage();var container;if(page.modalConfigPane){this.modalConfigPane=page.modalConfigPane;return;}
if(!(container=page.windowCtn.querySelector('#energyModal'))){container=document.createElement('div');container.id='energyModal';container.style.position='absolute';container.style.left=0;container.style.top=0;page.windowCtn.appendChild(container);}
this.modalConfigPane=page.modalConfigPane=new modalConfigurePane(container,this,'dashboard');this.modalConfigPane.show();};HtmlDashboard.prototype.init=function(){this._format();SuperClass.prototype.init.apply(this,arguments);};HtmlDashboard.prototype._format=function(){};HtmlDashboard.prototype.show=function(){var model=this.store.model;SuperClass.prototype.show.apply(this,arguments);this.shape=HTMLParser(this.tpl);this.shape.id=model._id();this.shape.style.position='absolute';this.shape.style.border='1px dashed #aaa';this.layer.add(this.shape);this.update();this._initWidget();};HtmlDashboard.prototype._initWidget=function(){var model=this.store.model;var options=this.store.model.option();var clazz,ioc;if(!options.type){Log.warn('html dashboard widgets must have a type.');return;}
ioc=this.painter.getPage().factoryIoC();clazz=ioc.getModel(options.type);if(!clazz){Log.error('Can\' find modal class "'+options.type+'" in factory ioc!');return;}
clazz=this._getWrapClazz(clazz);this.ins=new clazz(this,{modal:options});this.render();};HtmlDashboard.prototype._getWrapClazz=function(clazz){var wrapClazz=function F(){clazz.apply(this,arguments);};wrapClazz.prototype=Object.create(clazz.prototype);wrapClazz.prototype.initContainer=function(){this.container=this.screen.shape;};return wrapClazz;};HtmlDashboard.prototype.update=function(e,propName){var model=this.store.model;var options=model.option();var scale;if(!propName||propName.indexOf('update.x')>-1||propName.indexOf('update.y')>-1){this.shape.style.left=model.x()+'px';this.shape.style.top=model.y()+'px';}
if(!propName||propName.indexOf('update.w')>-1||propName.indexOf('update.h')>-1){this.shape.style.width=model.w()+'px';this.shape.style.height=model.h()+'px';if(propName){typeof this.ins.resize==='function'&&this.ins.resize();}}
if(propName&&propName.indexOf('update.option')>-1){this.render();}
SuperClass.prototype.update.apply(this,arguments);Log.info('html container widget has been updated.');};HtmlDashboard.prototype.render=function(){this.ins.render();};HtmlDashboard.prototype.showConfigModal=function(){this.ins.modalInit();};HtmlDashboard.prototype=Mixin(HtmlDashboard.prototype,HtmlWidgetMixin);HtmlDashboard.prototype.type='HtmlDashboard';exports.HtmlDashboard=HtmlDashboard;})(namespace('widgets.factory'),namespace('widgets.factory.HtmlWidget'),namespace('mixins.HtmlWidgetMixin'));;(function(exports,SuperClass){function HtmlDashboard(layer,model){SuperClass.apply(this,arguments);}
HtmlDashboard.prototype=Object.create(SuperClass.prototype);HtmlDashboard.prototype.constructor=HtmlDashboard;HtmlDashboard.prototype.update=function(e,propName){var model=this.store.model;var scale;var dataMap;SuperClass.prototype.update.apply(this,arguments);if(!propName||propName.indexOf('update.option.display')>-1){if(model['option.display']()===1){scale=this.painter.getScale();this.shape.style.left=model.x()*scale.x+'px';this.shape.style.top=model.y()*scale.y+'px';this.shape.style.width=model.w()*scale.x+'px';this.shape.style.height=model.h()*scale.y+'px';}}
if(propName&&propName.indexOf('update.option.text')>-1){dataMap=model['option.text.value']();this.ins.update(Object.keys(dataMap).map(function(dsId){return{dsItemId:dsId,data:dataMap[dsId]};}));}};exports.HtmlDashboard=HtmlDashboard;})(namespace('widgets.factory'),namespace('widgets.factory.HtmlDashboard'));(function(){window.GUtil={DEG:180/Math.PI,SHADOW_SHAPE_NAME:'__shadowShape',isPointInRect:function isPointInRect(x,y,rx,ry,rw,rh){return x>rx&&x<rx+rw&&y>ry&&y<ry+rh;},isIntersect:function isIntersect(a,b){return!(b.left>a.right||b.right<a.left||b.top>a.bottom||b.bottom<a.top);},getIntersection:function getIntersection(x,y,layer){return layer.getIntersection({x:x,y:y});},getIntersectionByPointInHtmlLayers:function getIntersectionByPointInHtmlLayers(x,y,layer,metrix){var children,pos;var stack=[];metrix=metrix||[1,0,0,1,0,0];if(Object.prototype.toString.call(layer)==='[object Array]'){this.sortShapesByZIndex(layer);stack=stack.concat(layer);layer=stack.pop();}
if(!layer)return null;do{if(['Layer','Group'].indexOf(layer.getType())>-1){children=layer.getChildren();this.sortShapesByZIndex(children);stack=stack.concat(Array.prototype.slice.call(children));continue;}
pos=getShapeRect(layer);if(this.isPointInRect(x,y,pos.x,pos.y,pos.w,pos.h)){return layer;}}while(layer=stack.pop());return null;},getIntersectionByPointInCanvasLayers:function getIntersectionByPointInCanvasLayers(x,y,layer,ignoreType){var layerShape=null;var findShape=null;var shape=null;var stack=[],s;ignoreType=typeof ignoreType==='undefined'?[]:[ignoreType];ignoreType=['Layer','Group'].concat(ignoreType);if(Object.prototype.toString.call(layer)!=='[object Array]'){layer=[layer];}
layer=layer.filter(function(row){return row.getLayerType()==='canvas';});if(layer.length===0)return null;layerShape=layer[0].shape.getLayer();findShape=layerShape.getIntersection({x:x,y:y});if(!findShape)return null;stack=stack.concat(layer);while(s=stack.pop()){if(ignoreType.indexOf(s.getType())>-1){stack=stack.concat(s.children);continue;}
if(s.hasShape(findShape)){shape=s;break;}}
return shape;},getIntersectionByPoint:function getIntersectionByPoint(x,y,canvasLayer,rootLayer,ignoreType){var layerShape=null;var shape=null;var stack=[],s;ignoreType=ignoreType||[];layerShape=canvasLayer.getShape().getLayer();shape=layerShape.getIntersection({x:x,y:y});if(!shape)return null;rootLayer.getWidgets(true).some(function(row){if(ignoreType.indexOf(row.getType())>-1){return false;}
if(row.hasShape(shape)){shape=row;return true;}});return shape;},getIntersectionByRect:function getIntersectionByRect(x,y,w,h,rootLayer){var hitShapes=[];var isHit;var stack=[];var pos;var shape;var point,p1,p2;if(!rootLayer)return[];stack=rootLayer.getWidgets(true).filter(function(row){return row.isVisible();});while(shape=stack.pop()){pos=this.getShapeRect(shape);if(shape.store.model.type()==='CanvasPipe'){point=shape.store.model['option.points']();p1=point[0];p2=point[1];isHit=this.getIntersectionByLine(p1,p2,{x:x,y:y,w:w,h:h});}else if(shape.store.model.type()==='CanvasHeat'||shape.store.model.type()==='CanvasPolygon'){var point=function(points){var arr=[];for(var i=0,len=points.length;i<len;i+=2){arr.push({x:points[i],y:points[i+1]});}
return arr;}(shape.store.model['option.points']());for(var i=0,len=point.length;i<len;i++){var p1=point[i%len],p2=point[(i+1)%len];isHit=this.getIntersectionByLine(p1,p2,{x:x,y:y,w:w,h:h});if(isHit){break;}}}else{isHit=this.isIntersect({left:pos.x,top:pos.y,right:pos.x+pos.w,bottom:pos.y+pos.h},{left:x,top:y,right:x+w,bottom:y+h});}
if(isHit){hitShapes.push(shape);}}
return hitShapes;},getIntersectionByLine:function(){function getDirection(v1,v2){return v1.x*v2.y-v1.y*v2.x;}
return function(p1,p2,rect){var rectPoints=[{x:rect.x,y:rect.y},{x:rect.x+rect.w,y:rect.y},{x:rect.x+rect.w,y:rect.y+rect.h},{x:rect.x,y:rect.y+rect.h}];for(var i=0;i<4;i++){var p3=rectPoints[i],p4=rectPoints[(i+1)%4];var vector12={x:p2.x-p1.x,y:p2.y-p1.y},vector13={x:p3.x-p1.x,y:p3.y-p1.y},vector14={x:p4.x-p1.x,y:p4.y-p1.y};var vector34={x:p4.x-p3.x,y:p4.y-p3.y},vector31={x:p1.x-p3.x,y:p1.y-p3.y},vector32={x:p2.x-p3.x,y:p2.y-p3.y};if(getDirection(vector12,vector13)*getDirection(vector12,vector14)<0&&getDirection(vector34,vector31)*getDirection(vector34,vector32)<0){return true;}}
if(p1.x>rect.x&&p1.x<rect.x+rect.w&&p1.y>rect.y&&p1.y<rect.y+rect.h){return true;}
return false;};}(),sortShapesByZIndex:function sortShapesByZIndex(shapes){if(shapes instanceof Konva.Collection)return;shapes.sort(function(first,second){return first.getZIndex()>second.getZIndex();});},getPipeRect:function getPipeRect(points){var xMin,xMax,yMin,yMax;var pArr=[];points.forEach(function(row){if(typeof row!=='number'){pArr.push(row.x);pArr.push(row.y);return;}
pArr.push(row);});for(var i=0,len=pArr.length;i<len;i+=2){if(typeof xMin==='undefined'||pArr[i]<xMin){xMin=pArr[i];}
if(typeof xMax==='undefined'||pArr[i]>xMax){xMax=pArr[i];}}
for(var i=1,len=pArr.length;i<len;i+=2){if(typeof yMin==='undefined'||pArr[i]<yMin){yMin=pArr[i];}
if(typeof yMax==='undefined'||pArr[i]>yMax){yMax=pArr[i];}}
return{xMin:xMin,yMin:yMin,xMax:xMax,yMax:yMax,w:Math.max(xMax-xMin,10),h:Math.max(yMax-yMin,10)};},transform:function transform(){var x,y,w,h,m,inverse;var pos;if(arguments.length>3){x=arguments[0];y=arguments[1];w=arguments[2];h=arguments[3];m=arguments[4];inverse=arguments[5];}else{pos=arguments[0].getAbsolutePosition();x=pos.x;y=pos.y;w=arguments[0].width();h=arguments[0].height();m=arguments[1];inverse=arguments[2];}
if(w<0){w=Math.abs(w);x=x-w;}
if(h<0){h=Math.abs(h);y=y-h;}
return inverse===true?{x:x,y:y,w:w/m[0],h:h/m[3]}:{x:x,y:y,w:w*m[0],h:h*m[3]};},getDistance:function getDistance(p1,p2){var dx=Math.abs(p1.x-p2.x);var dy=Math.abs(p1.y-p2.y);return Math.sqrt(dx*dx+dy*dy);},getPointProjectionOnLine:function getPointProjectionOnLine(p1,p2,p3){var x;var y;var a;var a2;var b;var b2;var isInRect=false;if(p1[0]===p2[0]){x=p1[0];y=p3[1];}else{a=p2[0]-p1[0];a2=a*a;b=p2[1]-p1[1];b2=b*b;y=(a*b*(p3[0]-p1[0])+b2*p3[1]+a2*p1[1])/(a2+b2);x=p3[0]-b*(y-p3[1])/a;}
if(p1[0]<p2[0]){if(x<p1[0]){x=p1[0];y=p1[1];}else if(x>p2[0]){x=p2[0];y=p2[1];}}else{if(x<p2[0]){x=p2[0];y=p2[1];}else if(x>p1[0]){x=p1[0];y=p1[1];}}
return{x:x,y:y};},getShapeRect:function getShapeRect(shape){var pos=shape.position();return{x:pos.x,y:pos.y,w:shape.width(),h:shape.height()};},loadImage:function(){var cacheMap={};return function(url,callback,crossOrigin){var image=new Image();if(cacheMap[url]){cacheMap[url].done(callback);return;}
cacheMap[url]=$.Deferred();cacheMap[url].done(callback);if(crossOrigin){image.crossOrigin=crossOrigin;}
image.src=url;image.onload=function(){cacheMap[url].resolve(this);};};}()};})();(function(exports){function GStage(painter){this.painter=painter;this.shape=null;this.children=[];this.init();}
GStage.prototype.init=function(){throw new Error('method "init" need to be implemented.');};GStage.prototype.add=function(layer){};GStage.prototype.getShape=function(){return this.shape;};GStage.prototype.getPainter=function(){return this.painter;};GStage.prototype.close=function(){this.painter=null;this.children=null;};exports.GStage=GStage;})(window);(function(exports,SuperClass){var drawCounter=null;function GCanvasStage(painter,model,options){this.options=options||{};SuperClass.apply(this,arguments);}
GCanvasStage.prototype=Object.create(SuperClass.prototype);GCanvasStage.prototype.constructor=GCanvasStage;GCanvasStage.prototype.init=function(){this.shape=new Konva.Layer({id:'__staticLayer',name:'__staticLayer',hitGraphEnabled:typeof this.options.hitGraphEnabled==='undefined'?true:this.options.hitGraphEnabled});this.shape.getCanvas()._canvas.style.zIndex=2;this.painter.stage.add(this.shape);};GCanvasStage.prototype.getChildren=function(){return this.children;};GCanvasStage.prototype.add=function(shape){SuperClass.prototype.add.apply(this,arguments);if(Object.prototype.toString.call(shape)!=='[object Array]'){shape=[shape];}
this.shape.add.apply(this.shape,shape);};GCanvasStage.prototype.draw=function(){var _this=this;var drawMode=this.painter.drawMode();if(drawMode==='manual'){return;}
if(drawMode==='normal'){this.shape.draw();return;}
if(drawMode==='batch'){if(drawCounter){window.clearTimeout(drawCounter);}
drawCounter=window.setTimeout(function(){window.clearTimeout(drawCounter);drawCounter=null;_this.shape.draw();},500);return;}};GCanvasStage.prototype.batchDraw=function(){var _this=this;if(drawCounter){window.clearTimeout(drawCounter);}
drawCounter=window.setTimeout(function(){window.clearTimeout(drawCounter);drawCounter=null;_this.shape.draw();},200);};GCanvasStage.prototype.getTransform=function(){return this.shape.getTransform();};GCanvasStage.prototype.offsetX=function(v){if(v!==undefined){return this.shape.offsetX(v);}
return this.shape.offsetX();};GCanvasStage.prototype.offsetY=function(v){if(v!==undefined){return this.shape.offsetY(v);}
return this.shape.offsetY();};GCanvasStage.prototype.x=function(){return Konva.Layer.prototype.x.apply(this.shape,arguments);};GCanvasStage.prototype.y=function(){return Konva.Layer.prototype.y.apply(this.shape,arguments);};GCanvasStage.prototype.width=function(){return Konva.Layer.prototype.width.apply(this.shape,arguments);};GCanvasStage.prototype.height=function(){return Konva.Layer.prototype.height.apply(this.shape,arguments);};GCanvasStage.prototype.scale=function(){return Konva.Layer.prototype.scale.apply(this.shape,arguments);};GCanvasStage.prototype.getType=function(){return'Stage';};GCanvasStage.prototype.close=function(){SuperClass.prototype.close.call(this);this.shape.destroy();};window.GCanvasStage=GCanvasStage;})(window,namespace('GStage'));(function(exports,SuperClass){function GHtmlStage(){SuperClass.apply(this,arguments);this.store={};this.store.background=null;}
GHtmlStage.prototype=Object.create(SuperClass.prototype);GHtmlStage.prototype.constructor=GHtmlStage;GHtmlStage.prototype.init=function(){var w=this.painter.stage.width();var h=this.painter.stage.height();var pageWidth=this.painter.pageWidth;var pageHeight=this.painter.pageHeight;this.shape=document.createElement('div');this.shape.className='html-layer';this.shape.style.width=pageWidth+'px';this.shape.style.height=pageHeight+'px';this.shape.style.left=(w-pageWidth)/2+'px';this.shape.style.top=(h-pageHeight)/2+'px';this.shape.style.zIndex=3;this.painter.stage.getContent().appendChild(this.shape);};GHtmlStage.prototype.setZIndex=function(zIndex){this.shape.style.zIndex=zIndex;};GHtmlStage.prototype.setBackground=function(background){var $bgShape=$(this.shape);var $userBgShape=$bgShape.find(".html-inner-bg");this.store.background=background;if($userBgShape.length===0){this.shape.style.backgroundImage='url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAIAAABLbSncAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAChJREFUeNpiPHPmDAMMGBsbw9lMDDgA6RKM%2F%2F%2F%2Fh3POnj1LCzsAAgwAQtYIcFfEyzkAAAAASUVORK5CYII%3D)';$bgShape.html('<div style="width:100%;height:100%" class="html-inner-bg" id="innerBg"></div>');$userBgShape=$bgShape.find(".html-inner-bg");}
if(!background){background={type:'color',color:'#e1e3e5'};}
if(background.type=="image"){if(background.display=="tile"){$userBgShape.css({'background-image':'url('+background.url+')',"background-repeat":"repeat","background-size":"contain"});}else{$userBgShape.css({'background-image':'url('+background.url+')',"background-repeat":"no-repeat","background-size":"100% 100%"});}}else{$userBgShape.css("background-color",background.color);}};GHtmlStage.prototype.getBackground=function(){return this.store.background;};GHtmlStage.prototype.getChildren=function(){return this.children;};GHtmlStage.prototype.add=function(shape){this.shape.appendChild(shape);};GHtmlStage.prototype.draw=function(){};GHtmlStage.prototype.position=function(params){if(typeof params!=='undefined'){this.x(params.x);this.y(params.y);return true;}
return{x:this.x(),y:this.y()};};GHtmlStage.prototype.x=function(val){if(Object.prototype.toString.call(val)==='[object Number]'){return this.shape.style.left=val+'px';}
return parseFloat(this.shape.style.left||0);};GHtmlStage.prototype.y=function(val){if(Object.prototype.toString.call(val)==='[object Number]'){return this.shape.style.top=val+'px';}
return parseFloat(this.shape.style.top||0);};GHtmlStage.prototype.offsetX=function(v){var style;if(v!==undefined){return this.shape.style.left=v+'px';}
style=window.getComputedStyle(this.shape);return parseFloat(style.left);};GHtmlStage.prototype.offsetY=function(v){var style;if(v!==undefined){return this.shape.style.top=v+'px';}
style=window.getComputedStyle(this.shape);return parseFloat(style.top);};GHtmlStage.prototype.width=function(){};GHtmlStage.prototype.height=function(){};GHtmlStage.prototype.getType=function(){return'Stage';};GHtmlStage.prototype.scale=function(scaleX,scaleY){var tW=this.painter.stage.width();var tH=this.painter.stage.height();var w=parseFloat(this.painter.pageWidth);var h=parseFloat(this.painter.pageHeight);if(typeof scaleY==='undefined'){scaleY=scaleX;}
this.shape.style.transform='scale('+scaleX+', '+scaleY+')';this.shape.style.width=w+'px';this.shape.style.height=h+'px';this.shape.style.left=(tW-w*scaleX)/2+'px';this.shape.style.top=(tH-h*scaleY)/2+'px';};GHtmlStage.prototype.scaleBound=function(scaleX,scaleY){var tW=this.painter.stage.width();var tH=this.painter.stage.height();var w=parseFloat(this.painter.pageWidth)*scaleX;var h=parseFloat(this.painter.pageHeight)*scaleY;this.shape.style.width=w+'px';this.shape.style.height=h+'px';this.shape.style.left=(tW-w)/2+'px';this.shape.style.top=(tH-h)/2+'px';};GHtmlStage.prototype.fixZoom=function(){var types=['HtmlButton','HtmlText'];var widgets=this.painter.getAllWidgets();widgets.forEach(function(row){if(types.indexOf(row.store.model.type())>-1){row.fixZoom();}});};GHtmlStage.prototype.close=function(){SuperClass.prototype.close.call(this);this.shape.parentNode.removeChild(this.shape);};exports.GHtmlStage=GHtmlStage;})(window,namespace('GStage'));var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(exports){function GLayer(painter,parent,model){this.painter=painter;this.store={};this.store.model=model;this.parent=parent;this.shape=null;this.children=[];this.init();}
GLayer.prototype.init=function(){if(this.parent){this.parent.children.push(this);}
this.bindModelOb();};GLayer.prototype.show=function(){if(this.store.model.isHide()===1){this.update(null,'update.isHide');}};GLayer.prototype.bindModelOb=function(){this.store.model.addEventListener('update',this.update,this);};GLayer.prototype.update=function(e,propName){var model=this.store.model;if(propName&&propName.indexOf('isHide')>-1){if(model.isHide()===1){this.hideLayer();}else{this.showLayer();}}
if(propName&&propName.indexOf('list')>-1){this.children=this.painter.findByIds(model.list());this.painter.updateLayerOrder();}};GLayer.prototype.add=function(){};GLayer.prototype.isVisible=function(){var isParentVisible=this.parent?this.parent.isVisible():true;return isParentVisible&&this.store.model.isHide()===0;};GLayer.prototype.displayLayer=function(isRoot){var action=this.store.model.isHide()===1?'detach':'attach';this.getChildren().forEach(function(row){if(row.getType()==='Layer'){row.displayLayer();}
else{row[action]();}});if(isRoot){this.draw();}};GLayer.prototype.showLayer=function(){this.getChildren(true).forEach(function(row){if(row.getType()==='Layer'){row.store.model.isHide(0);}
else{row.attach();}});this.draw();};GLayer.prototype.hideLayer=function(){this.getChildren(true).forEach(function(row){if(row.getType()==='Layer'){row.store.model.isHide(1);}
else{row.detach();}});this.draw();};GLayer.prototype.getPainter=function(){return this.painter;};GLayer.prototype.getShape=function(){return this.shape;};GLayer.prototype.getChildren=function(deep){var rs;if(!deep){return this.children;}
rs=[];this.children.forEach(function(row){rs.push(row);if(row.getType()==='Layer'){rs=rs.concat(row.getChildren(deep));}});return rs;};GLayer.prototype.getWidgets=function(deep){var children=this.getChildren(deep);return children.filter(function(row){return row.getType()!=='Layer';});};GLayer.prototype.getLayers=function(deep){var children=this.getChildren(deep);return children.filter(function(row){return row.getType()==='Layer';});};GLayer.prototype.findByCondition=function(cond){var ids,type;var argsType=typeof cond==='undefined'?'undefined':_typeof(cond);if(argsType==='function'){return this.getChildren(true).filter(cond);}else{cond=cond||{};ids=cond['ids'];type=cond['type'];return this.getChildren(true).filter(function(row){var model=row.store.model;var flag=true;if(type){if(type==='Layer'){flag=row.getType()==='Layer';}else{falg=row.getType()!=='Layer';}}
if(flag&&ids){flag=ids.indexOf(row.store.model._id())>-1;}
return flag;});}};GLayer.prototype.find=function(selector){var type=selector[0];var rs;selector=selector.substr(1);rs=this.getChildren(true).filter(function(row){switch(type){case'#':if(row.store.model._id()===selector){return true;}
break;case'.':if(row.shape.hasName(selector)){return true;}
break;case'*':return true;}
return false;});return rs;};GLayer.prototype.hasName=function(name){return this.store.model.name().indexOf(name)>-1;};GLayer.prototype.getType=function(){return'Layer';};GLayer.prototype.draw=function(){this.painter.getCanvasLayer().draw();};GLayer.prototype.setZIndex=function(zIndex){};GLayer.prototype.removeChild=function(id){var children=this.children;var removed=[];var idx,list;for(var i=0,len=children.length;i<len;i++){if(children[i].id()===id){removed=children.splice(i,1);break;}}
if(removed.length===0)return false;return true;};GLayer.prototype.destroy=function(){var children=this.parent.children;var removed=[];var id=this.store.model._id();for(var i=0,len=children.length;i<len;i++){if(children[i].id&&children[i].id()===id){removed=children.splice(i,1);break;}}
if(removed.length===0)return false;return true;};GLayer.prototype.close=function(){this.children.forEach(function(row){row.close();});if(this.parent){this.destroy();}};exports.GLayer=GLayer;})(namespace('layers'));(function(){var class2type=Object.prototype.toString;var DEFAULT_PAGE_WIDTH=800;var DEFAULT_PAGE_HEIGHT=600;var dpr=window.devicePixelRatio;var carouselTimer=null,carouselIdx,carouselEnabled=true;function GReadonlyPainter(screen,options){this.screen=screen;this.domContainer=screen.painterCtn;this.domCanvas=undefined;this.context2d=undefined;this.scaleX=undefined;this.scaleY=undefined;this.stage=undefined;this.canvasStage=undefined;this.interactiveLayer=undefined;this.htmlStage=undefined;this.noScaledHtmlStage=undefined;this.bgStage=undefined;this.rootLayer=undefined;this.options=options;this.pageWidth=options.pageWidth||DEFAULT_PAGE_WIDTH;this.pageHeight=options.pageHeight||DEFAULT_PAGE_HEIGHT;this.store={};this.store.layerModelSet=screen.store.layerModelSet;this.store.widgetModelSet=screen.store.widgetModelSet;this.store.pageModel=new Model({id:this.screen.page.id,isHide:0,isLock:0,list:this.screen.page.layerList});this.bindLayerModelSetOb();this.bindWidgetModelSetOb();this._drawMode='normal';this._maskShape=undefined;this._carousel=[];}
GReadonlyPainter.prototype={constructor:GReadonlyPainter,init:function init(){},show:function show(){var styles=window.getComputedStyle(this.domContainer);var width=parseInt(styles.width);var height=parseInt(styles.height);var GLayer=namespace('layers.GLayer');this.stage=new Konva.Stage({container:this.domContainer,width:width,height:height,draggable:false});this.rootLayer=new GLayer(this,null,this.store.pageModel);this.canvasStage=new GCanvasStage(this);this.htmlStage=new GHtmlStage(this);this.noScaledHtmlStage=new GHtmlStage(this);this.noScaledHtmlStage.setZIndex('');this.bgStage=new GHtmlStage(this);this.bgStage.setZIndex(1);this.bgStage.setBackground(this.screen.page.option?this.screen.page.option.background:null);this.scaleX=this.scaleY=1;this.resizePage(width,height);this.initOnResize();},drawMode:function drawMode(mode){var lastMode=this._drawMode;if(typeof mode==='undefined'){return lastMode;}
mode=mode||'normal';this._drawMode=mode;if(mode!=='manual'&&lastMode==='manual'){this.getCanvasLayer().draw();}},onLoad:function onLoad(){var _this=this;;var timer=null;if(this._carousel&&this._carousel.length){this.stage.on('contentMousemove',function(e){if(timer){window.clearTimeout(timer);timer=null;}
if(carouselTimer){window.clearTimeout(carouselTimer);carouselTimer=null;if(typeof carouselIdx!=='undefined'){_this._carousel[carouselIdx].playDown();}}
timer=window.setTimeout(function(){_this.carousel();},_this.options.carouselDelay||5000);});this.stage.fire('contentMousemove');}},onUpdated:function onUpdated(){},carousel:function carousel(idx){var _this=this;var len=this._carousel.length;var lastIdx;if(typeof idx==='undefined'){idx=0;}else{lastIdx=(idx+len-1)%len;}
if(typeof lastIdx!=='undefined'){this._carousel[lastIdx].playDown();}
this._carousel[idx].playUp();carouselIdx=idx;carouselTimer=window.setTimeout(function(){_this.carousel((idx+1)%len);},this.options.carouselInterval||5000);},addWidget:function addWidget(model){var ModalClass=null;var widget=null;var layerId=model.layerId(),parent;var group,groupId=typeof model.groupId==='function'?model.groupId():null;var layer=this.getParentByWidgetType(model.type(),model);if(!(ModalClass=namespace('widgets.factory')[model.type()])){Log.error('Class not found: '+model.type());return;}
if(!layerId){parent=this.getRootLayer();}else{parent=this.find('#'+layerId)[0];if(!parent){Log.warn('one widget that has no parent layer.');return;}}
var isS=true;if(groupId){group=this.find('#'+groupId)[0];if(!group){Log.warn('widget group not found!');return;}
group.add(model);}
widget=new ModalClass(parent,layer,model);widget.show(isS);},removeWidget:function removeWidget(model){var widget;widget=this.find('#'+model._id());if(widget.length===0){Log.error('Can\'t find the widget in page when remove the widget.');return;}
widget[0].close();},addLayer:function addLayer(model){var ModalClass=namespace('layers.GLayer');var parentId=model.parentId();var parent;if(!parentId){parent=this.getRootLayer();}else{parent=this.find('#'+parentId)[0];if(!parent){Log.warn('one widget that has no parent layer.');return;}}
new ModalClass(this,parent,model).show();},removeLayer:function removeLayer(model){var layer;layer=this.find('#'+model._id())[0];if(!layer){Log.error('Can\'t find the layer in page when remove the layer.');return;}
layer.close();},updateLayerOrder:function updateLayerOrder(){var layerList=this.store.pageModel.list().slice();var widgets=this.find('*');var map={};var item,id;var zIndex=11,idx;this.getRootLayer().displayLayer(true);widgets.forEach(function(row){var model=row.store.model;map[model._id()]=row;});while(id=layerList.pop()){item=map[id];if(!item){continue;}
if(item.getType()==='Layer'){layerList=layerList.concat(item.store.model.list());}else{idx=item.setZIndex(zIndex++);if(typeof idx==='number'){zIndex=idx+1;}}}
this.getCanvasLayer().draw();},bindWidgetModelSetOb:function bindWidgetModelSetOb(){this.store.widgetModelSet.addEventListener('insert',function(e,data){data.models.forEach(function(model){this.addWidget(model);},this);this.stage.draw();Log.info('insert {count} widget(s) at index {index}'.formatEL(data));},this);this.store.widgetModelSet.addEventListener('remove',function(e,data){data.models.forEach(function(model){this.removeWidget(model);},this);this.stage.draw();Log.info('remove {count} widget(s)'.formatEL(data));},this);},bindLayerModelSetOb:function bindLayerModelSetOb(){this.store.layerModelSet.addEventListener('insert',function(e,data){data.models.forEach(function(model){this.addLayer(model);},this);this.stage.draw();Log.info('insert {count} layer(s) at index {index}'.formatEL(data));},this);this.store.layerModelSet.addEventListener('remove',function(e,data){data.models.forEach(function(model){this.removeLayer(model);},this);this.stage.draw();Log.info('remove {count} layer(s)'.formatEL(data));},this);},initOnResize:function initOnResize(){var _this=this;window.onresize=function(e){var styles=window.getComputedStyle(_this.domContainer);var width=parseInt(styles.width);var height=parseInt(styles.height);_this.resizePage(width,height);_this.fixZoom();};},resizePage:function resizePage(width,height){width=parseFloat(width);height=parseFloat(height);this.stage.width(width);this.stage.height(height);if(this.options.display===0){this.scaleTo(width/this.pageWidth,height/this.pageHeight);}else{this.scaleTo(1,1);}},getViewportPosition:function getViewportPosition(){var w=this.stage.width();var h=this.stage.height();var vw=this.pageWidth*this.scaleX;var vh=this.pageHeight*this.scaleY;if(this.options.display===0){return{x:0,y:0};}
return{x:(w-vw)/2,y:(h-vh)/2};},getPage:function getPage(){return this.screen;},getPageSize:function getPageSize(){return{w:this.pageWidth,h:this.pageHeight};},getAllLayers:function getAllLayers(){return this.getRootLayer().getLayers('*');},getAllWidgets:function getAllWidgets(){return this.getRootLayer().getWidgets('*');},getRootLayer:function getRootLayer(){return this.rootLayer;},getCanvasLayer:function getCanvasLayer(){return this.canvasStage;},getHtmlLayer:function getHtmlLayer(){return this.htmlStage;},getBgLayer:function getBgLayer(){return this.bgStage;},getNoScaledHtmlLayer:function getNoScaledHtmlLayer(){return this.noScaledHtmlStage;},getLayerStatus:function getLayerStatus(){var map={};var layers=this.getRootLayer().getLayers(false);layers.forEach(function(row){map[row.store.model._id()]=1-row.store.model.isHide();});return map;},displayLayerByStatusMap:function displayLayerByStatusMap(statusMap){var layers=this.findByCondition({ids:Object.keys(statusMap),type:'Layer'});layers.forEach(function(layer){var model=layer.store.model;model.isHide(1-statusMap[model._id()]);});},getScale:function getScale(){return{x:this.scaleX,y:this.scaleY};},getParentByWidgetType:function getParentByWidgetType(widgetType,model){switch(widgetType){case'HtmlText':case'HtmlButton':case'HtmlScreenContainer':case'HtmlDashboard':case'HtmlContainer':if(!model['option.display']||model['option.display']()===0){return this.getHtmlLayer();}else{return this.getNoScaledHtmlLayer();}
default:return this.getCanvasLayer();}},getParentByLayerType:function getParentByLayerType(layerType){switch(layerType){case'canvas':return this.getCanvasLayer();default:return this.getHtmlLayer();}},getMaskShape:function getMaskShape(){if(this._maskShape){return this._maskShape;}
this._maskShape=new Konva.Rect({width:this.pageWidth,height:this.pageHeight,fill:'#000',opacity:0,visible:false,perfectDrawEnabled:false});this.getCanvasLayer().add(this._maskShape);return this._maskShape;},find:function find(selector){return this.getRootLayer().find(selector);},findByCondition:function findByCondition(cond){return this.getRootLayer().findByCondition(cond);},scaleTo:function scaleTo(scaleX,scaleY){var offset;this.scaleX=scaleX;this.scaleY=scaleY;offset=this.getViewportPosition();this.canvasStage.offsetX(-offset.x/scaleX);this.canvasStage.offsetY(-offset.y/scaleY);this.canvasStage.scale({x:scaleX,y:scaleY});this.canvasStage.draw();this.htmlStage.scale(scaleX,scaleY);this.noScaledHtmlStage.scaleBound(scaleX,scaleY);this.bgStage.scale(scaleX,scaleY);},fixZoom:function fixZoom(){if(dpr<1&&window.devicePixelRatio!==dpr){dpr=window.devicePixelRatio;this.htmlStage.fixZoom();}},_registerCarousel:function _registerCarousel(data){this._carousel.push(data);},draw:function draw(){this.canvasStage.draw();this.htmlStage.draw();this.bgStage.draw();},close:function close(){window.onresize=null;this.htmlStage.close();this.bgStage.close();this.canvasStage.close();this.stage.destroy();this.store=null;this.domContainer.innerHTML='';}};window.GReadonlyPainter=GReadonlyPainter;})();(function(){var _this;var Spinner=new LoadingSpinner({color:'#00FFFF'});function PageScreen(options,container,params){_this=this;this.options=options;this.page=null;this.preview='';this.lastDate=undefined;this.painterCtn=function(container){if(typeof container==='string'){return document.querySelector('#'+container);}else if(container instanceof HTMLElement){return container;}else{return null;}}(container);this.painterCtn.classList.add('web-factory-container');this.painter=null;this.store={};this.store.layerModelSet=new ModelSet();this.store.widgetModelSet=new ModelSet();this.store.imageModelSet=new ModelSet();this.store.dictPoints={};this.store.dictTexts={};this.isReplay=false;this.replayCtn=null;this._factoryIoC=null;this.loadPromise=$.Deferred();}
PageScreen.prototype={show:function show(){var _this=this;var promise=$.Deferred();if(typeof this.options.template!=='undefined'){promise.resolveWith(this,[this.options.template]);}else if(typeof this.options.templateId!=='undefined'){WebAPI.get('/factory/template/'+this.options.templateId).done(function(rs){rs=rs.content;this.options.template={page:{width:rs.width,height:rs.height,display:rs.display},data:JSON.parse(rs.template)};promise.resolveWith(this,[this.options.template]);}.bind(this));}else{WebAPI.get('/factory/getPageDetail/'+this.options.id+'/'+AppConfig.isFactory).done(function(rs){promise.resolveWith(this,[rs]);}.bind(this));}
return promise.done(function(rs){var modelIds=[],defers=[];var dictPoints=this.store.dictPoints;var paramList=[];if(!rs||!rs.data||!rs.page){Log.error('get page detail faild!');}
rs.data.list=rs.page.layerList;this.page=rs.page;this.modelInt();this.init();this.updateModelSet(rs.data);if(this.preview==='1'&&AppConfig.isFactory===1){this.store.widgetModelSet.forEach(function(model){dictPoints[model._id()]=[model._id()];});this.startDebugWorker();return;}
this.store.widgetModelSet.forEach(function(model){var dsId=model.property('idDs');var options=model.option();var id=model._id();if(AppConfig.isFactory!==1&&model.type()==='HtmlText'&&options.equipments&&options.equipments.length){options.equipments.forEach(function(row){_this.store.dictTexts[id]=_this.store.dictTexts[id]||[];_this.store.dictTexts[id].push(row);});}
if(model.type()==='HtmlDashboard'&&options.interval>0&&options.points&&options.points.length>0){dictPoints[id]=dictPoints[id]||[];dictPoints[id]=dictPoints[id].concat(options.points);return;}
if(!dsId){return;}
if(typeof dsId.length==='undefined'){modelIds.push(model._id());defers.push(dsId);}else if(dsId.length>0){dictPoints[id]=dictPoints[id]||[];dictPoints[id]=dictPoints[id].concat(dsId);}}.bind(this));$.when.apply($,defers).done(function(){var args=Array.prototype.slice.call(arguments);args.forEach(function(dsIds,i){var id=modelIds[i];if(!dsIds||!dsIds.length){return;}
dictPoints[id]=dictPoints[id]||[];dictPoints[id]=dictPoints[id].concat(dsIds);}.bind(this));this.startWorker();}.bind(this));}).always(function(){this.painter.onLoad();this.loadPromise.resolve();}.bind(this));},factoryIoC:function factoryIoC(){if(!this._factoryIoC){this._factoryIoC=new FactoryIoC('dashboard');}
return this._factoryIoC;},showColorSetBtn:function showColorSetBtn(isShow){if(AppConfig.isFactory==1)return;if(isShow){var tempDistribution=new ModelTempDistribution(this.options.id,null,null,_this);tempDistribution.init();$("#btnTemperatureSetting").show().eventOff('click').eventOn('click',function(e){new TemperatureSetting('co',true).show();});}else{$("#btnTemperatureSetting").hide().eventOff('click');window.colorGettings&&delete window.colorGettings;}},reloadWidgetById:function reloadWidgetById(modelId,data){var widget=this.painter.find('#'+modelId)[0];widget.reload(data);},getModelsByType:function getModelsByType(types){var matches=[];if(typeof types==='string'){types=[types];}
this.store.widgetModelSet.forEach(function(model){if(types.indexOf(model.type())>-1){matches.push(model);}});return matches;},startWorker:function startWorker(){var dsIds=[],dsMap={};Object.keys(this.store.dictPoints).forEach(function(id){dsIds=dsIds.concat(this.store.dictPoints[id]);}.bind(this));dsIds.forEach(function(dsId){dsMap[dsId]=null;});dsIds=Object.keys(dsMap);if(dsIds.length===0){return;}
this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;Spinner.spin(this.painterCtn);this.workerUpdate.addEventListener("message",this.onUpdateCallback,true);this.workerUpdate.addEventListener("error",function(e){Log.error(e);},true);this.workerUpdate.postMessage({pointList:dsIds,type:"datasourceRealtime"});},startDebugWorker:function startDebugWorker(){var _this=this;var fakeData=[];var keys=Object.keys(this.store.dictPoints);this.store.widgetModelSet.forEach(function(model){if(model['option.preview']&&typeof model['option.preview']()!=='undefined'&&keys.indexOf(model._id())>-1){var previewData=model['option.preview']();fakeData.push({data:previewData[0],dsItemId:model._id()});}});window.setTimeout(function(){_this.onUpdateCallback({data:{dsItemList:fakeData}});},1000);},stopWorker:function stopWorker(){if(_this.workerUpdate){_this.workerUpdate.terminate();_this.workerUpdate=null;}},init:function init(){if(this.painter){this.painter.close();}
this.painter=new GReadonlyPainter(this,{pageWidth:this.page.width,pageHeight:this.page.height,display:this.page.display,carouselInterval:this.page.option?this.page.option.carouselInterval:null,carouselDelay:this.page.option?this.page.option.carouselDelay:null});this.showColorSetBtn(true);this.painter.show();if(!AppConfig.isFactory){this.initReplay();}},modelInt:function modelInt(){var $checkPreviewPattern=$('#checkPreviewPattern');var v=localStorage.getItem('preview');var text=(v==='1'?'Debug':'Real')+'<span class="caret"></span>';$('.dropdown-toggle',$checkPreviewPattern).html(text);this.preview=v==='1'?'1':'0';if(this.page.type==='PageScreen'){$checkPreviewPattern.css('display','block');}else{this.preview='0';}
$('li',$checkPreviewPattern).off('click').on('click',function(){var $this=$(this);$this.parent().siblings('.dropdown-toggle').html($this.text()+'<span class="caret"></span>');localStorage.setItem('preview',this.dataset.checkvalue);window.location.reload();});},initReplay:function initReplay(){var _this=this;var $btnTimeShaft=$('#btnDropdownNavList').find('.toolBacktrace');if($btnTimeShaft.length>0){$btnTimeShaft.remove();}
$btnTimeShaft=$('<li class="iconWrap"><a><span class="glyphicon glyphicon-play-circle"></span><span class="dropdownNav"></span></a></li>').addClass('toolBacktrace');$btnTimeShaft.find('.dropdownNav').text(I18n.resource.observer.widgets.BACKTRACE);$('#right-nav').find('#btnOperatingRecord').after($btnTimeShaft);$btnTimeShaft.eventOn('click',function(e){if(_this.isReplay){this.classList.remove('selected');_this.quitReplayMode();}else{this.classList.add('selected');_this.enterReplayMode();}},['navTool-backTrace','btnBackTrace',AppConfig.projectShowName,AppConfig.projectId]);this.replayCtn=document.createElement('div');this.replayCtn.id='replayCtn';this.replayCtn.style.width='100%';this.replayCtn.style.height='0px';this.painterCtn.appendChild(this.replayCtn);},enterReplayMode:function enterReplayMode(d){var styles=window.getComputedStyle(this.painterCtn);var width=parseInt(styles.width);var height=parseInt(styles.height);var promise=$.Deferred();this.stopWorker();this.isReplay=true;if(!this.replayTool){this.replayTool=new TimeShaftPageScreen(this);promise=this.replayTool.show();}else{promise.resolve();}
promise.done(function(){var time;if(d){this.replayTool.showFramePane();time=d.valueOf();this.replayTool.requestData(new Date(time-7200000),new Date(time+7200000),null,true);}}.bind(this));this.painter.resizePage(width,height-100);},quitReplayMode:function quitReplayMode(){var styles=window.getComputedStyle(this.painterCtn);var width=parseInt(styles.width);var height=parseInt(styles.height);this.startWorker();this.isReplay=false;this.replayTool.close();this.replayTool=null;this.painter.resizePage(width,height);},onUpdateCallback:function onUpdateCallback(e){var _this=this.self?this.self:this;Spinner.stop();if(e.data.error||!e.data.dsItemList){Log.error('Refresh Data Failed!');return;}
_this.renderData(e.data.dsItemList);_this.lastDate=e.data.dsItemList;},onUpdateFaultsCallback:function onUpdateFaultsCallback(faults){var _this=this;this.loadPromise.done(function(){var dictTexts=this.store.dictTexts;var faultMap={};if(Object.keys(dictTexts).length===0){return;}
faults=faults||[];faults.forEach(function(row){faultMap[row.equipmentId]=faultMap[row.equipmentId]||[];faultMap[row.equipmentId].push({faultId:row.faultId,grade:row.grade});});Object.keys(dictTexts).forEach(function(modelId){var textFaults=[];var equipments=dictTexts[modelId];var model=_this.store.widgetModelSet.findByProperty('_id',modelId);equipments.forEach(function(row){if(faultMap[row]){textFaults=textFaults.concat(faultMap[row]);}});if(!model['option.faults']){model.property('option.faults',textFaults);}else{model['option.faults'](textFaults);}});}.bind(this));},renderLastData:function renderLastData(){_this.lastDate&&_this.renderData(_this.lastDate);},renderData:function renderData(data){var _this=this.self?this.self:this;var arrModel,model,options,text;var dataMap={};data.forEach(function(row){dataMap[row.dsItemId]=row.data;});this.painter.drawMode('manual');Object.keys(this.store.dictPoints).forEach(function(modelId){var data;var model=_this.store.widgetModelSet.findByProperty('_id',modelId);var options=model.option(),type=model.type();var dsIds=type==='HtmlDashboard'?options.points:_this.store.dictPoints[modelId];var options=model.option();if(type==='HtmlContainer'){text={};dsIds.forEach(function(dsId){text[dsId]=dataMap[dsId];});}else if(type==='CanvasPipe'){text={};dsIds.forEach(function(dsId){data=parseFloat(dataMap[dsId]).toFixed(0);if(options.trigger&&typeof options.trigger[data]!=='undefined'){text[dsId]=options.trigger[data];}else{text[dsId]=dataMap[dsId];}});}else if(type==='HtmlDashboard'){text={};dsIds.forEach(function(dsId){text[dsId]=dataMap[dsId];});}else{data=parseFloat(dataMap[dsIds[0]]).toFixed(0);if(options.trigger&&typeof options.trigger[data]!=='undefined'){text=options.trigger[data];}else{text=dataMap[dsIds[0]];}}
if(typeof options.text==='undefined'){options.text='';}
if(typeof options.text==='string'){model.property('option.text',{content:options.text,value:text});}else{model['option.text.value'](text);}});this.painter.drawMode('normal');this.painter.onUpdated();},resize:function resize(){var styles=window.getComputedStyle(this.painter.domContainer);var width=parseInt(styles.width);var height=parseInt(styles.height);this.painter.resizePage(width,height);},getSortedData:function getSortedData(data){var stack=data.list.slice();var layerMap=Array.toMap(data.layers,'_id');var widgetMap=Array.toMap(data.widgets,'_id');var viewedLayerIds=[],viewedWidgetIds=[];var id,item;var rs={layers:[],widgets:[]};while(id=stack.pop()){item=layerMap[id];if(item){if(viewedLayerIds.indexOf(id)>-1){Log.error('factory 图层出现嵌套循环，id：'+id);continue;}
viewedLayerIds.push(id);stack=item['list'].concat(stack);rs.layers.push(item);}
else{item=widgetMap[id];if(item){if(viewedWidgetIds.indexOf(id)>-1){Log.error('factory 控件出现嵌套循环，id：'+id);continue;}
viewedWidgetIds.push(id);rs.widgets.push(item);}else{Log.warn('未找到控件，id：'+id);}}}
return rs;},updateModelSet:function updateModelSet(data){var layers,widgets,images;var sortedData;this.painter.drawMode('manual');if(data.list){sortedData=this.getSortedData(data);data.layers=sortedData.layers;data.widgets=sortedData.widgets;}
layers=data.layers.map(function(row){var model=new NestedModel(row);return model;},this);widgets=data.widgets.map(function(row){var model=new NestedModel(row);return model;},this);data.images=data.images||[];images=data.images.map(function(row){var model=new NestedModel(row);return model;},this);this.store.imageModelSet.append(images);this.store.layerModelSet.append(layers);this.store.widgetModelSet.append(widgets);this.painter.updateLayerOrder();this.painter.drawMode('normal');},close:function close(){if(this.painter){this.painter.close();this.painter=null;}
if(this.painterCtn){this.painterCtn.classList.remove('web-factory-container');this.painterCtn.innerHTML='';this.painterCtn=null;}
this.page=null;this.store=null;this.showColorSetBtn(false);if(this.workerUpdate){this.workerUpdate.terminate();this.workerUpdate=null;}}};namespace('observer.screens').PageScreen=PageScreen;})();(function(){var _this;var Spinner=new LoadingSpinner({color:'#00FFFF'});function EnergyScreen(options,container){_this=this;this.options=options;this.windowCtn=function(container){if(typeof container==='string'){return document.querySelector('#'+container);}else if(container instanceof HTMLElement){return container;}else{return null;}}(container);this.dataSourcePanelCtn=null;this.modulePanelCtn=null;this.container=null;this.$pageNav=null;this.store={};this.listEntity=[];this.arrEntityOrder=[];this.mapRefresh={};this.popRefresh={};this.requestPoints=[];this.dictPopToEntity={};this.paneDatasource=null;this.workerUpdate=null;}
EnergyScreen.prototype.htmlUrl='/static/app/WebFactory/views/energyScreen.html';EnergyScreen.prototype.show=function(){var _this=this;return WebAPI.get(this.htmlUrl).then(function(html){_this.windowCtn.innerHTML='';_this.initLayout(html);return _this.init();});};EnergyScreen.prototype.getPageData=function(){Spinner.spin(this.windowCtn);var material;if($('#hidPageInfo').length>0){material=JSON.parse($('#hidPageInfo').val()).material;}
if(material===1){return WebAPI.post("/factory/material/getByIds",{'ids':[this.options.id]}).always(function(e){Spinner.stop();});}else{return WebAPI.get("/spring/get/"+this.options.id+'/'+AppConfig.isFactory).always(function(e){Spinner.stop();});}};EnergyScreen.prototype.init=function(){var promise=this.getPageData();AppConfig.datasource=new DataSource(_this);return promise.done(function(rs){var material;if($('#hidPageInfo').length>0){material=JSON.parse($('#hidPageInfo').val()).material;}
if(material===1){rs[0].content.layout=[[rs[0].content.layout]];this.store=rs[0].content;}else{this.store=rs;}
this.initIoc();this.initModuleLayout();this.initWorkerForUpdating();this.attachEvents();}.bind(this));};EnergyScreen.prototype.attachEvents=function(){};EnergyScreen.prototype.initIoc=function(){this.factoryIoC=new FactoryIoC('dashboard');};EnergyScreen.prototype.initLayout=function(html){this.initLayoutDOM(html);};EnergyScreen.prototype.initLayoutDOM=function(html){var divMain,stCt;divMain=document.createElement('div');divMain.className='indexContent st-pusher';divMain.innerHTML=html;stCt=$('<div id="st-container" class="st-container">')[0];stCt.appendChild(divMain);this.windowCtn.appendChild(stCt);this.container=divMain.querySelector('#paneCenter');this.$container=$(_this.container);};EnergyScreen.prototype.initWorkerForUpdating=function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e);},true);this.workerUpdate.postMessage({pointList:this.requestPoints,type:"datasourceRealtime"});};EnergyScreen.prototype.initModuleLayout=function(){if(!(this.store&&this.store.layout))return;for(var i=0,item;i<this.store.layout.length;i++){for(var j=0;j<this.store.layout[i].length;j++){item=this.store.layout[i][j];var modelClass,entity;if(item.modal.type&&(item.modal.type!='ModalNone'||item.isNotRender==true)){modelClass=this.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender)continue;entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);if(item.modal.type=='ModalAppButton'){entity.render();continue;}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(this.requestPoints.indexOf(point)<0){this.requestPoints.push(point);}}}
entity.render();}else if(item.modal.type=='ModalNone'){modelClass=this.factoryIoC.getModel(item.modal.type);entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);entity.render();}}}
var $springCtn=$('#paneCenter').children('.springContainer');if($springCtn.length==1&&parseFloat($springCtn[0].style.height)>=parseFloat("99%")&&parseFloat($springCtn[0].style.width)>=parseFloat("99%")){$springCtn.children('.panel-default').css({border:'none',left:0,top:0,width:'100%',height:'100%'});}
if(this.options.isForMobile)this.$container.addClass('forMobile');};EnergyScreen.prototype.refreshData=function(e){var _this=this.self?this.self:this;if(!e.data.error&&e.data.dsItemList){var point;for(var i=0,iLen=e.data.dsItemList.length;i<iLen;i++){point=e.data.dsItemList[i];_this.mapRefresh[point.dsItemId]=point;if(_this.dictPopToEntity[point.dsItemId]){_this.popRefresh[point.dsItemId]=point;}}
var entity,arrUpdataData;for(var key in _this.listEntity){entity=_this.listEntity[key];if(entity.entity.modal.type=="ModalNone"||entity.entity.modal.type=="ModalMix")continue;arrUpdataData=[];if(entity.entity.modal&&entity.entity.modal.points){for(var i=0,iLen=entity.entity.modal.points.length;i<iLen;i++){var point=entity.entity.modal.points[i];if(!point)continue;if(entity.entity.modal.points.indexOf(point)!=i)continue;if(_this.mapRefresh[point]!=undefined)arrUpdataData.push(_this.mapRefresh[point]);}
if(entity.entity.modal.type=="ModalAppGauge"){arrUpdataData.push({'guageTitle':entity.entity.modal.option.guageTitle,'guageFulTitle':entity.entity.modal.option.guageFulTitle,'guageFixed':entity.entity.modal.option.guageFixed,'guageUnit':entity.entity.modal.option.guageUnit,'timeLocal':entity.entity.modal.option.timeLocal,'guageDirect':entity.entity.modal.option.guageDirect,'guageBgColor':entity.entity.modal.option.guageBgColor,'transDataDot':entity.entity.modal.option.transDataDot});}
entity.update(arrUpdataData);}}}else{}},EnergyScreen.prototype.close=function(){$('.datetimepicker').remove();this.listEntity.forEach(function(row){row.close();});if(this.workerUpdate){this.workerUpdate.terminate();this.workerUpdate=null;}
if(this.windowCtn){this.windowCtn.innerHTML='';this.windowCtn=null;}
this.store=null;this.listEntity=null;this.arrEntityOrder=null;this.dsInfolist=null;this.mapRefresh=null;this.requestPoints=null;this.dictPopToEntity=null;};namespace('observer.screens').EnergyScreen=EnergyScreen;})();(function(){function EnergyScreen_M(options,container){if(options){options.isForMobile=true;}else{options={isForMobile:true};}
namespace('observer.screens').EnergyScreen.call(this,options,container);}
EnergyScreen_M.prototype=Object.create(namespace('observer.screens.EnergyScreen').prototype);namespace('observer.screens').EnergyScreen_M=EnergyScreen_M;})();(function(exports){var configMap={textTooltipTemplate:'<div class="tooltip observer-text-tooltip observer-text-editor" draggable="true" data-h5-draggable-node="true" data-ds-id="">\
        <div class="tooltip-inner">\
        <div>\
        <span id="pointName"></span>\
        <span class="label" style="font-weight:500;margin-left:5px;padding:1px 3px;color:#000;background-color:#c7c7c7;">Copy</span>\
        </div>\
        <div id="pointAlias">12312312</div><div><a class="lkAddToDS" href="javascript:;">\
        {interAnalysis}</a></div></div></div>',textEditorZIndex:2200,textEditorOpacity:0.8,textTooltipBackgroundColor:'#1A1A1A',textEditorIdPrefix:'observer-text-editor-'};var TOOLTIP_DELAY=1000;var $tooltip=null;var tooltipTimer=null;var tooltip={show:function show(){$tooltip.css('display','');$tooltip.css('opacity',configMap.textEditorOpacity);if(tooltipTimer){window.clearTimeout(tooltipTimer);tooltipTimer=null;}},hide:function hide(){if(!tooltipTimer){tooltipTimer=window.setTimeout(function(){$tooltip!==null&&$tooltip.css('opacity',0);tooltipTimer=null;},TOOLTIP_DELAY);}}};var dsLoadPromise=null;var lastQueryDs=null;var TooltipMixin={enableTooltip:true,isInMouseOver:false,initTooltip:function initTooltip(opt){var _this,shape,ds,clickable;var container,shapeItem;var offset;opt=$.extend(false,{},opt);_this=this;shape=opt.shape||this.shape;ds=opt.ds||this.store.model.idDs()[0];clickable=typeof opt.clickable==='undefined'?false:opt.clickable;container=opt.container||this.page.painterCtn;if(shape.nodeType==='Shape'){shapeItem=shape;}else{shapeItem=$(shape);}
offset=$(container).offset();shapeItem.on('mouseenter',function(event){if(_this.isInMouseOver)return;$tooltip=_this.createTooltip(container,{ds:ds,clickable:clickable});tooltip.show();if(event.evt){container.style.cursor='pointer';_this.checkPopoverBoundary(container,$tooltip,event.evt.pageX-offset.left,event.evt.pageY-offset.top);}else{this.style.cursor='pointer';_this.checkPopoverBoundary(container,$tooltip,event.pageX-offset.left,event.pageY-offset.top);}
_this.isInMouseOver=true;});shapeItem.on('mouseleave ',function(e){if(e.evt){container.style.cursor='auto';}else{this.style.cursor='auto';}
tooltip.hide();_this.isInMouseOver=false;});},createTooltip:function createTooltip(container,params){var _this=this;var template,$template=$tooltip;var ds=params.ds;var clickable=params.clickable;var $pointName;var isOldDsFormat=false;if(!$template||!$template.length){template=configMap.textTooltipTemplate.formatEL({interAnalysis:I18n.resource.observer.observerScreen.TEXT_ADD_TO_DATASOURCE});$template=$(template);$template.on('mouseenter',function(){tooltip.show();}).on('mouseleave',function(){tooltip.hide();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();}).css({'display':'block','max-width':'none','opacity':configMap.textEditorOpacity,'z-index':configMap.textEditorZIndex-1}).find('.tooltip-inner').css({'background-color':configMap.textTooltipBackgroundColor,'opacity':configMap.textEditorOpacity,'max-width':'none'});$template.find('.label').click(function(e){var input=document.createElement('textarea');document.body.appendChild(input);input.value=$template.find('#pointName').text();input.focus();input.select();document.execCommand('Copy');input.remove();e.preventDefault();e.stopPropagation();});if(clickable){$template.find('.lkAddToDS').click(function(e){var pointName=$(this).parents('.tooltip-inner').find('#pointName').text();new ModalAppendPointToDs(false,null,[pointName]).show();e.preventDefault();});}}
if(!$.contains(container,$template[0])){$(container).append($template);}
$template[0].dataset.dsId=ds;if(lastQueryDs===ds){return $template;}
if(dsLoadPromise&&dsLoadPromise.state()==='pending'){dsLoadPromise.abort();}
dsLoadPromise=WebAPI.post('/analysis/datasource/getDsItemsById',[ds]);lastQueryDs=ds;if(ds.indexOf('|')>-1){ds=ds.split('|')[1];}else{isOldDsFormat=true;}
$template.find('#pointName').text(ds);$template.find('#pointAlias').text('loading');dsLoadPromise.done(function(rs){var alias;if(rs&&rs.length){alias=rs[0].alias;}
if(isOldDsFormat){$template.find('#pointName').text(rs[0].value);}
if(alias&&alias!==rs[0].value){$template.find('#pointAlias').text(rs[0].alias).show();}
else{$template.find('#pointAlias').text('').hide();}});return $template;},checkPopoverBoundary:function checkPopoverBoundary(container,$popover,pageX,pageY){var $container=$(container),offsetX=10,offsetY=0,popoverWidth=$popover.width(),popoverHeight=$popover.height(),rightX=Math.min(pageX+popoverWidth+offsetX,$container.width()-5),rightY=Math.min(pageY+popoverHeight+offsetY,$container.height()-5);$popover.css({left:rightX-popoverWidth+offsetX,top:rightY-popoverHeight+offsetY});}};exports.TooltipMixin=TooltipMixin;})(namespace('mixins'));var ModelPipeline=function(){function ModelPipeline(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[{execute:this.executeAnimation}];this.idCom=undefined;this.dictIdCom={};this.startX=undefined;this.startY=undefined;this.endX=undefined;this.endY=undefined;this.layer=undefined;this.lineWidth=10;this.color=undefined;this.pathLengthX=undefined;this.pathLengthY=undefined;this.originX=undefined;this.originY=undefined;this.direction=undefined;this.speed=undefined;this.pointX=undefined;this.pointY=undefined;this.radius=10;this.waterType=undefined;this.isRunning=false;};ModelPipeline.prototype=new Sprite();ModelPipeline.prototype.paint=function(ctx){ctx.save();var alpha=this.isRunning?'0.7':'0.2';switch(this.waterType){case"0":ctx.strokeStyle='rgba(0, 114, 201, '+alpha+')';break;case"1":ctx.strokeStyle='rgba(78, 157, 50, '+alpha+')';break;case"2":ctx.strokeStyle='rgba(244, 191, 88, '+alpha+')';break;case"3":ctx.strokeStyle='rgba(196, 101, 105, '+alpha+')';break;default:ctx.strokeStyle='#ccc';break;}
ctx.lineWidth=this.lineWidth;ctx.beginPath();ctx.moveTo(this.startX,this.startY);ctx.lineTo(this.endX,this.endY);ctx.closePath();ctx.stroke();ctx.restore();if(this.isRunning){ctx.fillStyle='#017db6';ctx.save();if(this.waterType)ctx.fillStyle=this.waterType==0?"#017db6":"#6fc88f";ctx.beginPath();ctx.arc(this.pointX,this.pointY,this.lineWidth/2-1,0,Math.PI*2);ctx.closePath();ctx.fill();ctx.restore();}};ModelPipeline.prototype.executeAnimation=function(sprite,ctx,time){sprite.isRunning=false;for(var item in sprite.dictIdCom){if(sprite.dictIdCom[item]){sprite.isRunning=true;break;}}
if(!sprite.isRunning)return;if(sprite.pointX==undefined||sprite.pointY==undefined)sprite.initAnimationParams();if(sprite.endY==sprite.startY){if(Math.abs(sprite.pointX-sprite.originX)>sprite.pathLengthX)sprite.initAnimationParams();sprite.pointX+=sprite.speed;}else{if(Math.abs(sprite.pointY-sprite.originY)>sprite.pathLengthY)sprite.initAnimationParams();sprite.pointY+=sprite.speed;}};ModelPipeline.prototype.initAnimationParams=function(){this.pathLengthX=Math.abs(this.endX-this.startX)-this.radius;this.pathLengthY=Math.abs(this.endY-this.startY)-this.radius;if(this.direction){this.originX=this.startX;this.originY=this.startY;if(this.speed>0&&(this.endX<this.startX||this.endY<this.startY))this.speed=-1*this.speed;}else{this.originX=this.endX;this.originY=this.endY;if(this.speed>0&&(this.endX>this.startX||this.endY>this.startY))this.speed=-1*this.speed;}
this.pointX=this.originX;this.pointY=this.originY;};return ModelPipeline;}();var ModelEquipment=function(){function ModelEquipment(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[{execute:this.updateImageIndex}];this.url=undefined;this.image=undefined;this.rotate=undefined;this.value=undefined;this.hasAnimation=undefined;this.animation=undefined;this.idCom=undefined;this.indexImage=0;this.layer=undefined;this.link=undefined;this.history=undefined;this.timeLastRefresh=0;};ModelEquipment.prototype=new Sprite();ModelEquipment.prototype.paint=function(ctx){if(this.image){if(this.image.complete){this.drawImage(this,ctx);}else{var _this=this;this.image.onload=function(e){_this.drawImage(_this,ctx);};}}},ModelEquipment.prototype.drawImage=function(_this,ctx){ctx.save();if(!_this.width||!_this.height){_this.width=_this.image.width;_this.height=_this.image.height;}
try{if(_this.rotate){ctx.translate(_this.x,_this.y);ctx.translate(_this.width/2,_this.height/2);ctx.rotate(_this.rotate*Math.PI/180);if(Math.abs(_this.rotate)>90&&Math.abs(_this.rotate<270)){ctx.drawImage(_this.image,-_this.width/2,-_this.height/2,_this.width,_this.height);}else{ctx.drawImage(_this.image,-_this.height/2,-_this.width/2,_this.height,_this.width);}}else{ctx.drawImage(_this.image,_this.x,_this.y,_this.width,_this.height);}}catch(e){}
ctx.restore();},ModelEquipment.prototype.updateImageIndex=function(_this,ctx,time){_this.value=parseInt(_this.value);if(!(_this.animation[_this.value]&&_this.animation[_this.value].frameCount))return;if(_this.animation[_this.value].frameCount>1&&_this.indexImage<_this.animation[_this.value].frameCount){if(time&&time-_this.timeLastRefresh>_this.animation[_this.value].interval){_this.indexImage++;_this.timeLastRefresh=time;}}else{_this.indexImage=0;}};ModelEquipment.prototype.refreshImage=function(dictList,dictImages){if(this.hasAnimation==undefined){this.hasAnimation=false;for(var item in this.animation){this.hasAnimation=true;break;}}
if(this.hasAnimation&&this.animation[this.value]&&this.animation[this.value].frameCount){var id=this.animation[this.value].frameCount>1?"animation_":"";if(this.animation[this.value].frameCount>1&&dictList[this.animation[this.value].animationId])id+=dictList[this.animation[this.value].animationId][this.indexImage];else id=this.animation[this.value].animationId;if(dictImages[id]){this.image=dictImages[id];}}},ModelEquipment.prototype.mouseEnter=function(){if(this.history==undefined){this.history={};this.history.width=this.width;this.history.height=this.height;this.history.x=this.x;this.history.y=this.y;this.width+=30;this.height+=30;this.x-=15;this.y-=15;var _this=this;setTimeout(function(){_this.mouseOut();},1000);}},ModelEquipment.prototype.mouseOut=function(){if(this.history){this.width=this.history.width;this.height=this.history.height;this.x=this.history.x;this.y=this.history.y;this.history=undefined;}};return ModelEquipment;}();var ModelButton=function(){function ModelButton(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.image=undefined;this.imageComm=undefined;this.imageOver=undefined;this.imageDown=undefined;this.imageDisable=undefined;this.url=undefined;this.idCom=undefined;this.text=undefined;this.link=undefined;this.description=undefined;this.fontSize=undefined;this.fontColor=undefined;this.idCom=undefined;this.setValue=undefined;this.status=undefined;this.history=undefined;};ModelButton.prototype=new Sprite();ModelButton.prototype.paint=function(ctx){if(this.image!==undefined){if(this.image.complete){this.drawImage(this,ctx);}else{var _this=this;this.image.onload=function(e){_this.drawImage(_this,ctx);};}}},ModelButton.prototype.drawImage=function(_this,ctx){ctx.save();if(!_this.width||!_this.height){_this.width=_this.image.width;_this.height=_this.image.height;}
try{ctx.drawImage(_this.image,_this.x,_this.y,_this.width,_this.height);if(_this.text){if(this.fontSize)strFont=_this.fontSize+"px Arial";ctx.fillStyle=_this.fontColor?"rgb("+_this.fontColor.r+","+_this.fontColor.g+","+_this.fontColor.b+")":"#333333";ctx.textBaseline="middle";ctx.textAlign="center";ctx.fillText(_this.text,_this.x+_this.width/2,_this.y+_this.height/2);}}catch(e){}
ctx.restore();},ModelButton.prototype.mouseEnter=function(){if(this.status=="down")return;this.image=this.imageOver;},ModelButton.prototype.mouseOut=function(){this.image=this.imageComm;this.status=undefined;};ModelButton.prototype.mouseDown=function(){this.image=this.imageDown;this.status="down";};return ModelButton;}();var ModelText=function(){var textEditorTemplate='<div class="popover observer-text-editor" style="padding: 10px;"><button type="button" class="close"><span>×</span></button>'+'<div class="popover-content">'+'<div class="form-horizontal">'+'<div class="form-group">'+'<div class="col-sm-9" id="pointName"></div>'+'</div>'+'<button class="btn btn-default btn-sm pull-right text-editor-btn-ok"></button>'+'</div>'+'</div>'+'</div>';var textTooltipTemplate='<div class="tooltip observer-text-tooltip observer-text-editor"><div class="tooltip-inner"><div id="pointName"></div><div><a class="lkAddToDS" href="javascript:;">'+'{0}</a></div></div></div>';var errTipTemplate='<div id="errTip">\
    </div>';var errTipTpNew='<div id="errTipNew">\
        <div class="errTipHeader"></div>\
        <div class="vavBox"><div class="airVolume">实际风量：  <span></span></div>\
        <div class="floStptVol">设定风量：  <span></span></div>\
        <div class="dmprPos">风阀开度：  <span></span></div>\
        <div class="roomTemp">房间温度：  <span></span></div>\
        </div>\
        <div class="fptuBox"><div class="spaceTemp">空间温度：  <span></span></div>\
        <div class="tempSetpoint">温度设定：  <span></span></div>\
        <div class="fanOp">风机状态：  <span></span></div>\
        <div class="inAlarm">风机故障：  <span></span></div>\
        <div class="boxFlowOP">流量开关：  <span></span></div>\
        <div class="fanSpeed_S">风速设定：  <span></span></div>\
        <div class="fanSpeed_V">风速：  <span></span></div>\
        </div>\
        <div class="rxcBox"><div class="autoMode">手自动模式：  <span></span></div>\
        <div class="fanSpeedmode">风速模式反馈：  <span></span></div>\
        <div class="fanSpeedLevel">风速档位反馈：  <span></span></div>\
        <div class="spaceTemp">区域温度：  <span></span></div>\
        <div class="sAT">送风温度：  <span></span></div>\
        <div class="hCValvePosition">水阀开度反馈：  <span></span></div>\
        </div>\
        </div>';var TOOLTIP_DELAY=1000;var $tooltip=null;var tooltipTimer=null;var tooltip={show:function show(){$tooltip.css('display','');$tooltip.css('opacity',configMap.textEditorOpacity);if(tooltipTimer){window.clearTimeout(tooltipTimer);tooltipTimer=null;}},hide:function hide(){if(!tooltipTimer){tooltipTimer=window.setTimeout(function(){$tooltip!==null&&$tooltip.css('opacity',0);tooltipTimer=null;},TOOLTIP_DELAY);}}};var ERRTIP_DELAY=1000;var $errTip=null;var errTipTimer=null;var errTip={show:function show(){$errTip.css('display','');$errTip.css('opacity',1);if(errTipTimer){window.clearTimeout(errTipTimer);errTipTimer=null;}},hide:function hide(){if(!errTipTimer){errTipTimer=window.setTimeout(function(){$errTip!==null&&$errTip.css('opacity',0);errTipTimer=null;},ERRTIP_DELAY);}}};var ERRTIPNEW_DELAY=1000;var $errTipNew=null;var errTipNewTimer=null;var errTipNew={show:function show(){$errTipNew.css('display','');$errTipNew.css('opacity',1);if(errTipNewTimer){window.clearTimeout(errTipNewTimer);errTipNewTimer=null;}},hide:function hide(){if(!errTipNewTimer){errTipNewTimer=window.setTimeout(function(){$errTipNew!==null&&$errTipNew.css('opacity',0);errTipNewTimer=null;},ERRTIPNEW_DELAY);}}};var configMap={textTooltipTemplate:null,textErrTipTemplate:errTipTemplate,textErrTipTpNew:errTipTpNew,textEditorTemplate:textEditorTemplate,textEditorZIndex:2200,textEditorOpacity:0.8,textTooltipBackgroundColor:'#1A1A1A',textEditorIdPrefix:'observer-text-editor-'};function ModelText(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[{execute:this.executeAnimation}];this.value=undefined;this.isDiffValue=undefined;this.font=undefined;this.color=undefined;this.fontSize=undefined;this.align=undefined;this.decimalplace=undefined;this.idCom=undefined;this.dictBindString=[];this.showMode=undefined;this.tooltipTemplate=configMap.textTooltipTemplate;this.editorTemplate=configMap.textEditorTemplate;this.enableTooltip=true;this.isInMouserOver=false;this.errTipTimerout=null;this.isNeedMark=undefined;if(!configMap.textTooltipTemplate){configMap.textTooltipTemplate=textTooltipTemplate.format(I18n.resource.observer.observerScreen.TEXT_ADD_TO_DATASOURCE);}};ModelText.prototype=new Sprite();ModelText.prototype.isTextEditorOpen=function(){return $(ElScreenContainer).find('#'+configMap.textEditorIdPrefix+this.id).length>0;};ModelText.prototype.clearTextTooltip=function(){$(ElScreenContainer).find('.observer-text-tooltip').remove();};ModelText.prototype.paint=function(ctx){var _this=this;ctx.save();var curColor=this.color;var strFont;if(this.fontSize)strFont=this.fontSize+"px ";strFont+=_this.font?_this.font:"Arial";ctx.font=strFont;if(this.bgColor){curColor="#ffffff";paintDiagNoticeBg();}
if(!this.isDiffValue){paintText(curColor);}else{strFont='bold '+strFont;paintText("#ff7200");}
ctx.restore();function paintText(color){ctx.save();ctx.textBaseline="middle";if(color)ctx.fillStyle=color;var str;if(!isNaN(_this.value)&&_this.decimalplace!=undefined){str=parseFloat(_this.value).toFixed(_this.decimalplace);if(str=="NaN")str="--";}else{str=_this.value;}
var strX=_this.align===1?_this.x+_this.width:_this.x;ctx.textAlign=_this.align===1?'right':'left';var index=parseInt(_this.value);if(_this.dictBindString[index])str=_this.dictBindString[index];if(_this.width&&ctx.measureText(str).width<_this.width){if(!_this.isNeedMark){ctx.fillText(str,strX,_this.y);}else{ctx.strokeStyle='#222';ctx.strokeText(str,strX,_this.y);}}else{StringTools.wordWrap(ctx,strX,_this.y-_this.height/2+15,_this.width,str,null);}
ctx.restore();}
function paintDiagNoticeBg(){if(!_this.alphaBg)_this.alphaBg=1;if(!(_this.grade==0||_this.grade==undefined)){if(_this.alphaBg<0.3||_this.alphaBg>1){_this.isFade=!_this.isFade;}
_this.alphaBg=_this.isFade?_this.alphaBg+0.02:_this.alphaBg-0.02;}
ctx.save();ctx.fillStyle=_this.bgColor;ctx.globalAlpha=_this.alphaBg.toFixed(2);if(_this.width&&ctx.measureText(_this.value).width<_this.width){CanvasGeometry.fillRadiusRect(ctx,_this.x-5,_this.y-_this.height/2,ctx.measureText(_this.value).width+12,_this.height,3);}else{CanvasGeometry.fillRadiusRect(ctx,_this.x-5,_this.y-_this.height/2,ctx.measureText(_this.value).width-30,_this.height,3);}
ctx.fill();ctx.restore();}};ModelText.prototype.update=function(value,isNeedMark){this.isDiffValue=!(this.value==value);if(this.value=='--')this.isDiffValue=false;this.isNeedMark=isNeedMark;this.value=value;};ModelText.prototype.updateDiagnosisGrade=function(grade){this.grade=grade;switch(grade){case 0:this.bgColor='#5bc0de';break;case 1:this.bgColor='#f0ad4e';break;case 2:this.bgColor='#d9534f';break;default:this.bgColor='#d9534f';break;}};ModelText.prototype.createTooltip=function(){var _this=this;var template,$template=$tooltip;if(!$template||!$template.length){template=this.tooltipTemplate;$template=$(template);$template.on('mouseenter',function(){tooltip.show();}).on('mouseleave',function(){tooltip.hide();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();}).css({'display':'block','max-width':'none','opacity':configMap.textEditorOpacity,'z-index':configMap.textEditorZIndex-1}).find('.tooltip-inner').css({'background-color':configMap.textTooltipBackgroundColor,'opacity':configMap.textEditorOpacity,'max-width':'none'});$template.find('.lkAddToDS').click(function(e){var pointName=$(this).parents('.tooltip-inner').find('#pointName').text();new ModalAppendPointToDs(false,null,[pointName]).show();e.preventDefault();});$(ElScreenContainer).append($template);}
$template.find('#pointName').text(this.idCom);return $template;};ModelText.prototype.createTextEditor=function(){var $template=$(this.editorTemplate),_this=this,$operation,$select;if(this.dictBindString&&this.dictBindString.length>0){$operation=$('<div class="form-group"><input type="hidden" id="pointValue"></input><select class="form-control" style="width: 150px;margin: 0 auto;"></select></div>'),$select=$operation.find('select');for(var m=0,len=this.dictBindString.length;m<len;m++){var selected=parseInt(this.value)===m?'selected':'';$select.append('<option value="'+m+'" '+selected+'>'+this.dictBindString[m]+'</option>');}
$select.change(function(){$operation.find('#pointValue').val($(this).val());});}else{$operation=$('<div class="form-group">'+'<input type="text" class="form-control" id="pointValue" placeholder="'+this.value+'" style="width: 150px;margin: 0 auto;">'+'</div>');}
$template.css({'display':'block','min-width':'230px','z-index':configMap.textEditorZIndex}).attr('id',configMap.textEditorIdPrefix+this.id).find('.text-editor-btn-ok').text(I18n.resource.observer.observerScreen.TEXT_EDITOR_CONFIRM).before($operation);$template.on('click','.close',function(){$(this).closest('.popover').remove();}).on('click','.text-editor-btn-ok',function(){var value=$template.find('#pointValue').val(),projectId=AppConfig.projectId,idCom=_this.idCom,alert;if(!value||!projectId||!idCom||parseInt(_this.value)===value||isNaN(parseInt(_this.value))){return;}
var data={db:projectId,point:idCom,value:$template.find('#pointValue').val()};Spinner.spin($template[0]);WebAPI.post('/set_realtimedata',data).pipe(function(result){if(result.indexOf('succeeded')!=-1){return WebAPI.post("/get_realtimedata",{proj:AppConfig.projectId,pointList:[_this.idCom]}).done(function(resultJson){var resultItem,latestValue;resultItem=resultJson[0];if(!resultItem){latestValue=null;}
latestValue=resultItem.value;if(latestValue===_this.value){alert=new Alert($template[0],Alert.type.danger,I18n.resource.observer.observerScreen.TEXT_EDITOR_SEND_FAIL);}else{alert=new Alert($template[0],Alert.type.success,I18n.resource.observer.observerScreen.TEXT_EDITOR_SEND_SUCCESS);}});}else{alert=new Alert($template[0],Alert.type.danger,I18n.resource.observer.observerScreen.TEXT_EDITOR_SEND_FAIL);}}).fail(function(){alert=new Alert($template[0],Alert.type.danger,I18n.resource.observer.observerScreen.TEXT_EDITOR_SEND_FAIL);}).always(function(){alert.setStyle({width:'70%',fontSize:'10px'});alert.show(1000);Spinner.stop();});});$template.find('#pointName').text(this.idCom);return $template;};ModelText.prototype.createErrTip=function(data){var $find=$(),$each,_this=this;if(!$errTip||$errTip.length===0){$(ElScreenContainer).append($errTip=$(configMap.textErrTipTemplate));$errTip.on('mouseenter',function(e){errTip.show();e.stopPropagation();}).on('mouseleave',function(e){errTip.hide();e.stopPropagation();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();}).on('click','.err-replay',function(){var $this=$(this);var date=$this.siblings('span[data-time]').attr('data-time');_this.retrunToMoment(date);});}
for(var i=0,len=data.length;i<len;i++){$each=$('#divPaneNotice').find('[faultid="'+data[i]+'"]').clone(true);$each.each(function(){this.onmouseenter=null;this.onmouseleave=null;});$('<span class="glyphicon glyphicon-play span-hover-pointer grow err-replay"></span>').appendTo($each.children('div')[0]);$find=$find.add($each);}
$errTip.html($find);return $errTip;};ModelText.prototype.createErrTipNew=function(modelType,errTipNewRe){if(!$errTipNew||$errTipNew.length===0){$(ElScreenContainer).append($errTipNew=$(configMap.textErrTipTpNew));}
$errTipNew.on('mouseenter',function(e){errTipNew.show();e.stopPropagation();}).on('mouseleave',function(e){errTipNew.hide();e.stopPropagation();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();});return $errTipNew;};ModelText.prototype.checkPopoverBoundary=function($popover,pageX,pageY){if(!pageX){pageX=this.x;}
if(!pageY){pageY=this.y;}
var documentWidth=$(document).width(),documentHeight=$(document).height(),popoverWidth=$popover.width(),popoverHeight=$popover.height(),popoverX=this.width+pageX+popoverWidth,popoverY=this.height+pageY+popoverHeight,popoverXOffset,popoverYOffset;popoverXOffset=popoverX>documentWidth?pageX-popoverWidth:pageX+15;popoverYOffset=popoverY>documentHeight?pageY-popoverHeight:pageY-45;$popover.css({left:popoverXOffset,top:popoverYOffset});};ModelText.prototype.dotMode=function(){var _this=this;var dataNew,modelType;var requestDataNew=[];dataNew=_this.getErrDataNew?_this.getErrDataNew(_this.id):[];if(dataNew.length!==0&&dataNew.length<2){var dataNewIndexOne=dataNew[0].split('_')[1];if(dataNewIndexOne.indexOf('RXC')>=0){modelType=dataNew[0]?dataNewIndexOne.substring(0,3):'';}else{modelType=dataNew[0]?dataNewIndexOne.substring(3,7):'';}
if(!dataNew)return;_this.errTipTimerout=window.setTimeout(function(e){if(!_this.errTipTimerout)return;if(modelType=='VAV'){requestDataNew.push(dataNew[0]+'_AirVolume');requestDataNew.push(dataNew[0]+'_FloStptVol');requestDataNew.push(dataNew[0]+'_DmprPos');requestDataNew.push(dataNew[0]+'_RoomTemp');}else if(modelType=='FPTU'){requestDataNew.push(dataNew[0]+'_SpaceTemp');requestDataNew.push(dataNew[0]+'_TempSetpoint');requestDataNew.push(dataNew[0]+'_FanOp');requestDataNew.push(dataNew[0]+'_InAlarm');requestDataNew.push(dataNew[0]+'_BoxFlowOP');requestDataNew.push(dataNew[0]+'_FanSpeed_S');requestDataNew.push(dataNew[0]+'_FanSpeed_V');}else if(modelType=='RXC'){requestDataNew.push(dataNew[0]+'_AutoMode');requestDataNew.push(dataNew[0]+'_FanSpeedmode');requestDataNew.push(dataNew[0]+'_FanSpeedLevel');requestDataNew.push(dataNew[0]+'_SpaceTemp');requestDataNew.push(dataNew[0]+'_SAT');requestDataNew.push(dataNew[0]+'_HCValvePosition');}
WebAPI.post('/get_realtimedata',{pointList:requestDataNew,proj:AppConfig.projectId}).done(function(errTipNewRe){var vavPara,vavValue,ftpuPara,ftpuValue,getValue,getPara,getDataLen,getParaClass;$errTipNew=_this.createErrTipNew(modelType,errTipNewRe);getDataLen=errTipNewRe.length;if(modelType=='VAV'){$errTipNew.find('.errTipHeader').html('VAV');$errTipNew.find('.vavBox').show();$errTipNew.find('.fptuBox').hide();$errTipNew.find('.rxcBox').hide();}else if(modelType=='FPTU'){$errTipNew.find('.errTipHeader').html('FPTU');$errTipNew.find('.vavBox').hide();$errTipNew.find('.fptuBox').show();$errTipNew.find('.rxcBox').hide();}else{$errTipNew.find('.errTipHeader').html('RXC');$errTipNew.find('.vavBox').hide();$errTipNew.find('.fptuBox').hide();$errTipNew.find('.rxcBox').show();}
for(var i=0;i<errTipNewRe.length;i++){getValue=errTipNewRe[i].value;var errNameArr=errTipNewRe[i].name.split('_');getPara=errNameArr.length>3?errNameArr[2]+'_'+errNameArr[3]:errNameArr[2];getParaClass=getPara.substring(0,1).toLowerCase()+getPara.substring(1,getPara.length);if(getValue==null){getValue='N / A';}else{getValue=getValue;}
$('#errTipNew .'+getParaClass).find('span').html(getValue);}
errTipNew.show();_this.checkPopoverBoundary($errTipNew,event.pageX,event.pageY);});window.clearTimeout(_this.errTipTimerout);},1000);}};ModelText.prototype.mouseEnter=function(event){var _this=this;var data,dataNew,modelType;var requestDataNew=[];if(_this.enableTooltip){if(_this.isInMouserOver)return;if(_this.isErrTip){if(AppConfig.projectId==80){_this.dotMode();}
data=_this.getErrData(_this.id);if(!data||data.length===0)return;if(_this.grade===0)return;$errTip=_this.createErrTip(data);errTip.show();_this.checkPopoverBoundary($errTip,event.pageX,event.pageY);}else{if(AppConfig.projectId==80){_this.dotMode();}
if(this.isTextEditorOpen())return;if(!this.idCom)return;$tooltip=this.createTooltip();tooltip.show();this.checkPopoverBoundary($tooltip,event.pageX,event.pageY);}
this.isInMouserOver=true;}};ModelText.prototype.mouseOut=function(event){var _this=this;this.errTipTimerout=null;if(this.enableTooltip){if(this.isErrTip){if(AppConfig.projectId==80){errTipNew.hide();}
errTip.hide();}else{tooltip.hide();}
this.isInMouserOver=false;}};ModelText.prototype.mouseDown=function(event){};ModelText.destroy=function(){if(tooltipTimer){window.clearTimeout(tooltipTimer);tooltipTimer=null;}
if($tooltip!==null){$tooltip.remove();$tooltip=null;}
if(errTipTimer){window.clearTimeout(errTipTimer);errTipTimer=null;}
if($errTip!==null){$errTip.remove();$errTip=null;}};return ModelText;}();var ModelChart=function(){function ModelChart(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.interval=5000;this.units=undefined;this.dataTable={};this.maxPointCount=30;this.chartData=[];this.chartlabels=undefined;this.chart=undefined;this.chartOptions={animation:false,bezierCurve:false,scaleStartValue:0};this.canvasOffline=undefined;this.ctxOffline=undefined;this.isRunning=false;this.receivedDate={};};ModelChart.prototype=new Sprite();ModelChart.prototype.close=function(){this.isRunning=false;this.canvasOffline=null;this.ctxOffline=null;};ModelChart.prototype.drawLegend=function(){this.ctxOffline.textBaseline="middle";this.ctxOffline.textAlign="left";var legendItemBeginX=0,legendItemHeight=14,legendItemLine=0;for(var i=0;i<this.units.length;i++){if(legendItemBeginX>this.width*0.8){legendItemBeginX=0;legendItemLine+=1;}
if(!text||text=='')continue;var text=this.units[i].title,itemHeight=legendItemHeight*legendItemLine;this.ctxOffline.fillStyle=this.units[i].color;this.ctxOffline.fillRect(legendItemBeginX+50,8+itemHeight,10,4);this.ctxOffline.fillStyle="#333333";this.ctxOffline.fillText(text,legendItemBeginX+70,10+itemHeight);legendItemBeginX+=this.ctxOffline.measureText(text).width+50;}};ModelChart.prototype.paint=function(ctx){ctx.drawImage(this.canvasOffline,this.x,this.y);},ModelChart.prototype.update=function(pointName,value){this.receivedDate[pointName]=value;if(value<0)this.chartOptions.scaleStartValue=null;};return ModelChart;}();var LineChart=function(){function LineChart(id,painter,behaviors){ModelChart.call(this,id,painter,behaviors);}
LineChart.prototype=new ModelChart();LineChart.prototype.constructor=LineChart;LineChart.prototype.renderChart=function(_this){if(!_this.isRunning)return;_this.chartlabels.shift();_this.chartlabels.push(new Date().toLocaleTimeString());for(var pointName in _this.receivedDate){_this.dataTable[pointName].shift();_this.dataTable[pointName].push(_this.receivedDate[pointName]);for(var i=0;i<_this.chartData.length;i++){if(_this.chartData[i].pointName==pointName){_this.chartData[i].data=_this.dataTable[pointName];break;}}}
_this.canvasOffline.width=this.width;_this.canvasOffline.height=this.height;_this.ctxOffline.clearRect(0,0,_this.canvasOffline.width,_this.canvasOffline.height);_this.chart=new Chart(_this.ctxOffline);_this.chart.Line({labels:_this.chartlabels,datasets:_this.chartData},_this.chartOptions);this.drawLegend();setTimeout(function(){_this.renderChart(_this);},_this.interval);};LineChart.prototype.init=function(){this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;var unit,sbColor,arr;for(var i=0;i<this.units.length;i++){unit=this.units[i];arr=[];for(var j=0;j<this.maxPointCount;j++){arr.push(null);}this.dataTable[unit.pointName]=arr;this.receivedDate[unit.pointName]=null;sbColor=new StringBuilder();sbColor.append("rgba(").append(unit.color.b).append(",").append(unit.color.g).append(",").append(unit.color.r);this.units[i].color=sbColor.toString().replace("rgba","rgb")+")";this.chartData.push({fillColor:sbColor.toString()+", 0.5)",strokeColor:sbColor.toString()+", 1)",pointColor:sbColor.toString()+", 1)",pointStrokeColor:"#fff",data:this.dataTable[unit.pointName],pointName:unit.pointName});}
this.chartlabels=new Array();for(var i=0;i<this.maxPointCount;i++){this.chartlabels.push('');}};return LineChart;}();var BarChart=function(){function BarChart(id,painter,behaviors){ModelChart.call(this,id,painter,behaviors);}
BarChart.prototype=new ModelChart();BarChart.prototype.constructor=BarChart;BarChart.prototype.renderChart=function(_this){if(!_this.isRunning)return;for(var i=0;i<_this.units.length;i++){var unit=_this.units[i],pointName=unit.pointName;!_this.chartlabels[i]&&(_this.chartlabels[i]=unit.title);for(var j=0;j<_this.chartData.length;j++){if(_this.chartData[j].pointName===pointName){_this.chartData[j].data[0]=Number(_this.receivedDate[pointName]);}}}
_this.canvasOffline.width=this.width;_this.canvasOffline.height=this.height;_this.ctxOffline.clearRect(0,0,_this.canvasOffline.width,_this.canvasOffline.height);_this.chart=new Chart(_this.ctxOffline);_this.chart.Bar({labels:[' '],datasets:_this.chartData},_this.chartOptions);this.drawLegend();setTimeout(function(){_this.renderChart(_this);},_this.interval);};BarChart.prototype.init=function(){this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;this.chartlabels=[];var unit,sbColor;for(var i=0;i<this.units.length;i++){unit=this.units[i];this.dataTable[unit.pointName]=[];this.receivedDate[unit.pointName]=null;sbColor=new StringBuilder();sbColor.append("rgba(").append(unit.color.b).append(",").append(unit.color.g).append(",").append(unit.color.r);this.units[i].color=sbColor.toString().replace("rgba","rgb")+")";this.chartData.push({fillColor:sbColor.toString()+", 0.5)",strokeColor:sbColor.toString()+", 1)",data:this.dataTable[unit.pointName],pointName:unit.pointName});}};return BarChart;}();var PieChart=function(){function PieChart(id,painter,behaviors){ModelChart.call(this,id,painter,behaviors);this.painter={paint:this.paint};}
PieChart.prototype=new ModelChart();PieChart.prototype.constructor=PieChart;PieChart.prototype.paint=function(ctx){ctx.drawImage(this.canvasOffline,this.x+this.width*0.1,this.y+this.height*0.2);ctx.save();ctx.textBaseline="middle";ctx.textAlign="left";var legendItemBeginX=0,legendItemHeight=14,legendItemLine=0;for(var i=0;i<this.units.length;i++){if(legendItemBeginX>this.width*0.8){legendItemBeginX=0;legendItemLine+=1;}
var text=this.units[i].title,itemHeight=legendItemHeight*legendItemLine;ctx.fillStyle=this.units[i].color;ctx.fillRect(legendItemBeginX+50+this.x,8+itemHeight+this.y,10,4);ctx.fillStyle="#333333";ctx.font="bold 14px 微软雅黑";ctx.fillText(text,legendItemBeginX+70+this.x,10+itemHeight+this.y);legendItemBeginX+=ctx.measureText(text).width+50;}
ctx.restore();},PieChart.prototype.renderChart=function(_this){if(!_this.isRunning)return;for(var i=0;i<_this.units.length;i++){var unit=_this.units[i],pointName=unit.pointName;for(var j=0;j<_this.chartData.length;j++){if(_this.chartData[j].pointName===pointName){_this.chartData[j].value=Number(_this.receivedDate[pointName]);_this.chartData[j].label=unit.title;}}}
_this.canvasOffline.width=this.width*0.8;_this.canvasOffline.height=this.height*0.8;_this.ctxOffline.clearRect(0,0,_this.canvasOffline.width,_this.canvasOffline.height);_this.chart=new Chart(_this.ctxOffline);_this.chart.Pie(_this.chartData,_this.chartOptions);setTimeout(function(){_this.renderChart(_this);},_this.interval);};PieChart.prototype.init=function(){this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.canvasOffline.width=this.width*0.8;this.canvasOffline.height=this.height*0.8;this.chartlabels=[];var unit,sbColor;for(var i=0;i<this.units.length;i++){unit=this.units[i];this.dataTable[unit.pointName]=[];this.receivedDate[unit.pointName]=null;sbColor=new StringBuilder();sbColor.append("rgba(").append(unit.color.b).append(",").append(unit.color.g).append(",").append(unit.color.r);this.units[i].color=sbColor.toString().replace("rgba","rgb")+")";this.chartData.push({color:sbColor.toString()+", 1)",value:0,label:'',pointName:unit.pointName});}};return PieChart;}();var ModelGage=function(){function ModelGage(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.value=0;this.maxValue=1.5;this.minValue=0;this.idCom=undefined;this.imgMeterPan=new Image();this.imgMeterPan.src="/static/images/meterpan.png";this.imgMeterPointer=new Image();this.imgMeterPointer.src="/static/images/meterpointer.png";};ModelGage.prototype=new Sprite();ModelGage.prototype.close=function(){this.canvasOffline=null;this.ctxOffline=null;};ModelGage.prototype.paint=function(ctx){ctx.drawImage(this.canvasOffline,this.x,this.y);},ModelGage.prototype.renderGage=function(){this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;this.ctxOffline.clearRect(0,0,this.canvasOffline.width,this.canvasOffline.height);var _this=this;if(this.imgMeterPan!=undefined){if(this.imgMeterPan.complete){this.drawMeterPan(this,this.ctxOffline);}else{this.imgMeterPan.onload=function(e){_this.drawMeterPan(_this,_this.ctxOffline);};}}
if(this.imgMeterPointer!=undefined){if(this.imgMeterPointer.complete){this.drawMeterPointer(this,this.ctxOffline);}else{this.imgMeterPointer.onload=function(e){_this.drawMeterPointer(_this,_this.ctxOffline);};}}},ModelGage.prototype.drawMeterPan=function(_this,ctx){_this.ctxOffline.drawImage(_this.imgMeterPan,0,0,_this.width,_this.height);gradient=_this.ctxOffline.createLinearGradient(0,0,_this.width,_this.height);gradient.addColorStop(0,'blue');gradient.addColorStop(0.25,'blue');gradient.addColorStop(0.5,'white');gradient.addColorStop(0.75,'red');gradient.addColorStop(1.0,'yellow');_this.ctxOffline.font="22pt Arial";_this.ctxOffline.fillStyle=gradient;_this.ctxOffline.strokeStyle='white';_this.ctxOffline.shadowColor='rgba(1,1,1,0.8)';_this.ctxOffline.shadowOffsetX=2;_this.ctxOffline.shadowOffsetY=2;_this.ctxOffline.shadowBlur=5;_this.ctxOffline.textAlign='center';var valueDisplay=Math.round(_this.value*100)/100;_this.ctxOffline.fillText(valueDisplay.toString(),_this.width*0.5,_this.height*0.75);_this.ctxOffline.font="9pt Arial";_this.ctxOffline.fillStyle='#4ebaff';var interval=(_this.maxValue-_this.minValue)/5,pi=Math.PI,angleInterval=pi/5,radius=_this.width*0.25,centerX=_this.width*0.5,centerY=_this.width*0.5;for(var n=0;n<6;n++){var value=_this.minValue+n*interval;if(value%1!==0){value=value.toFixed(1);}
var angle=angleInterval*n;_this.ctxOffline.fillText(value,centerX-Math.cos(angle)*radius,centerY-Math.sin(angle)*radius);}};ModelGage.prototype.drawMeterPointer=function(_this,ctx){_this.ctxOffline.save();var maxValueAsAngle=Math.PI/2.0*3.0;var minValueAsAngle=Math.PI/2.0;var curValueAngle=0.0;if(Number(_this.value)>_this.maxValue){curValueAngle=maxValueAsAngle;}else if(Number(_this.value)<_this.minValue){curValueAngle=minValueAsAngle;}else{if(_this.maxValue>_this.minValue){curValueAngle=minValueAsAngle+(maxValueAsAngle-minValueAsAngle)/(_this.maxValue-_this.minValue)*(_this.value-_this.minValue);}}
var pointerbasex=_this.width*0.5;var pointerbasey=_this.height*0.5;_this.ctxOffline.translate(pointerbasex,pointerbasey);_this.ctxOffline.rotate(curValueAngle);_this.ctxOffline.drawImage(_this.imgMeterPointer,-_this.imgMeterPointer.width/2.0,-_this.imgMeterPointer.width/2.0,_this.imgMeterPointer.width,_this.imgMeterPointer.height);_this.ctxOffline.restore();};ModelGage.prototype.update=function(value){if(value==this.value)return;this.value=value;this.renderGage();};return ModelGage;}();var ModelRuler=function(){var PANEL_DECIMAL_PRECISION=2,GRADUATION_MAIN_HEIGHT=28,GRADUATION_HALF_HEIGHT=10,GRADUATION_TENTH_HEIGHT=5,COLOR_IMPROVEMENT='#d17965',COLOR_FAIR='#d4861e',COLOR_GOOD='#5b9d00',COLOR_EXCELLENT='#0078b6';var isLoaded=false;var panel_change_max=300,panel_change_rate=6,panel_change_current=0,panel_change_value=0,panel_change_value_direc=1;function changeRangeIndex(){if(panel_change_value===0){panel_change_value_direc=1;}else if(panel_change_value===1){panel_change_value_direc=-1;}
panel_change_value=panel_change_value+panel_change_value_direc;}
function drawReferrencePanel(context,x,y,w,h,isCurrentProject){context.save();context.shadowColor="RGBA(100,100,100,1)";context.shadowOffsetX=0;context.shadowOffsetY=2;context.shadowBlur=0;if(isCurrentProject){if(panel_change_current>panel_change_max){panel_change_current=0;changeRangeIndex();}else{panel_change_current+=panel_change_rate;}
switch(panel_change_value){case 0:context.fillStyle="#FF9900";break;case 1:context.fillStyle="#FFF";break;}}else{context.fillStyle="RGBA(255,255,255,1)";}
CanvasGeometry.fillRadiusRect(context,x,y,w,h,3);context.fill();context.restore();}
function drawbutton(ctx,x,y,text){if($('.check-big-data').size()!=0){return;}
var btn=$('<div class="btn btn-default check-big-data i18n="observer.entities.BIG_DATA_COMPARISON""></div>');btn.css({'position':'absolute','top':y+100,'left':x,'float':'right','font-size':'18px','font-family':'微软雅黑','box-shadow':'0px 2px #666'});btn.click(function(){isBigDataLoad=!isBigDataLoad;});$('#divMain').append(btn);}
function getColorByAppraise(appraisement){if(!appraisement)return'';var result=null;var o=I18n.resource.observer.entities;switch(appraisement){case o.RELATIVELY_POOR:result=COLOR_IMPROVEMENT;break;case o.GENERAL:result=COLOR_FAIR;break;case o.GOOD:result=COLOR_GOOD;break;case o.EXCELLENT:result=COLOR_EXCELLENT;break;}
return result;}
function ModelRuler(screen,id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.screen=screen;this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.maxValue=undefined;this.minValue=undefined;this.name=undefined;this.decimal=undefined;this.mainScale=undefined;this.minorScale=undefined;this.idCom=undefined;this.list=new Array();this.levels=new Array();this.references=new Array();this.isInitFinished=false;this.plantIcon=new Image();this.plantIcon.src='/static/images/plant_icon.png';this.isBigDataLoad=false;};ModelRuler.prototype=new Sprite();ModelRuler.prototype.close=function(){this.canvasOffline=null;this.ctxOffline=null;$('#divMain').find('.check-big-data').remove();};ModelRuler.prototype.paint=function(ctx){var _this=this;ctx.drawImage(this.canvasOffline,this.x,this.y);if(!this.references||this.references.length===0){return;}
if(!this.isInitFinished){var ANIMATION_INTERVAL=0.01,ANIMATION_DECIMAL_PRECISION=3;}else{var ANIMATION_INTERVAL=this.mainScale?Number(this.mainScale)/20:0.01,ANIMATION_DECIMAL_PRECISION=3;}
var that=this,PANEL_WIDTH=147,tempHeigth=this.height/5,PANEL_MARGIN=5;for(var rInd=0,rLen=this.references.length;rInd<rLen;rInd++){var ref=this.references[rInd];ref.joinPoint=null;ref.arrowPoint=null;ref.panel=null;ref.value=Number(ref.value).toFixed(PANEL_DECIMAL_PRECISION);if(Number(ref.isInUp)===1){this.references[rInd]=new ModelRulerCurrentReference(ref,this);}else{this.references[rInd]=new ModelRulerReference(ref,this);}}
function checkValue(value,maxValue,minValue){if(value>maxValue){return maxValue;}else if(value<minValue){return minValue;}else{return value;}}
var getDownJoinPoint=function getDownJoinPoint(item){var itemValue=checkValue(item.currentDrawValue,that.maxValue,that.minValue);return{X:that.x+20+(that.width-40)*(itemValue-that.minValue)/(that.maxValue-that.minValue),Y:that.y+that.height-tempHeigth+10};},getUpJoinPoint=function getUpJoinPoint(item){var itemValue=checkValue(item.currentDrawValue,that.maxValue,that.minValue);return{X:that.x+20+(that.width-40)*(itemValue-that.minValue)/(that.maxValue-that.minValue),Y:that.y+tempHeigth-10};},getUpArrowPoint=function getUpArrowPoint(item){var itemValue=checkValue(item.currentDrawValue,that.maxValue,that.minValue);return{X:that.x+20+(that.width-40)*(itemValue-that.minValue)/(that.maxValue-that.minValue),Y:that.y+that.height/2-35};},getDownArrowPoint=function getDownArrowPoint(item){var itemValue=checkValue(item.currentDrawValue,that.maxValue,that.minValue);return{X:that.x+20+(that.width-40)*(itemValue-that.minValue)/(that.maxValue-that.minValue),Y:that.y+that.height/2+35};};var compareJoinPoint=function compareJoinPoint(thisJoinPoint,comparedPoint){var comparedValue=thisJoinPoint.X-comparedPoint.X;if(Math.abs(comparedValue)<PANEL_WIDTH){thisJoinPoint.X+=Math.abs(PANEL_WIDTH-comparedValue)+5;return thisJoinPoint;}
return null;};this.references.sort(function(itemA,itemB){return Number(itemA.currentDrawValue)-Number(itemB.currentDrawValue);});var upRefs=this.references.filter(function(val,index){return Number(val.isInUp)==0&&index%2===1;});var downRefs=this.references.filter(function(val,index){return Number(val.isInUp)==0&&index%2===0;});upRefs.push(this.references.filter(function(val,index){return Number(val.isInUp)!=0;})[0]);upRefs.sort(function(itemA,itemB){return Number(itemA.currentDrawValue)-Number(itemB.currentDrawValue);});downRefs.sort(function(itemA,itemB){return Number(itemA.currentDrawValue)-Number(itemB.currentDrawValue);});var reverseCheck=function reverseCheck(refs,index,item,itemIndex,getJoinPoint){for(var n=index-1;n>-1;n--){if(n===itemIndex){continue;}
var comparedJoinPoint=refs[n].joinPoint?refs[n].joinPoint:getJoinPoint(refs[n]);var comparedResult=compareJoinPoint(item.joinPoint,comparedJoinPoint);if(comparedResult){item.joinPoint=comparedResult;return true;}}
return false;};var handleRefs=function handleRefs(refs,isUpRef){if(isUpRef){var getJoinPoint=getUpJoinPoint,getArrowPoint=getUpArrowPoint;}else{var getJoinPoint=getDownJoinPoint,getArrowPoint=getDownArrowPoint;}
for(var i=0;i<refs.length;i++){var currentRef=refs[i];currentRef.isUpRef=isUpRef;if(!currentRef.currentDrawValue){currentRef.currentDrawValue=currentRef.value;}
if(isLoaded&&Number(currentRef.value)===0){currentRef.currentDrawValue=Number(currentRef.value);}
if(Number(currentRef.currentDrawValue)<Number(currentRef.value)){currentRef.currentDrawValue=(Number(currentRef.currentDrawValue)+ANIMATION_INTERVAL).toFixed(ANIMATION_DECIMAL_PRECISION);}else if(Number(currentRef.currentDrawValue)>Number(currentRef.value)){currentRef.currentDrawValue=(Number(currentRef.currentDrawValue)-ANIMATION_INTERVAL).toFixed(ANIMATION_DECIMAL_PRECISION);}else if(Number(currentRef.value)!=0){isLoaded=true;}else{this.isInitFinished=true;}
var currentJoinPoint=getJoinPoint(currentRef);currentRef.arrowPoint=getArrowPoint(currentRef);if(i===0){currentRef.joinPoint=currentJoinPoint;}else{var lastRef=refs[i-1],lastJoinPoint=lastRef.joinPoint;var comparedResult;lastJoinPoint&&(comparedResult=compareJoinPoint(currentJoinPoint,lastJoinPoint));if(comparedResult){currentRef.joinPoint=comparedResult;}
if(!currentRef.joinPoint){currentRef.joinPoint=currentJoinPoint;}}
while(reverseCheck(refs,i,currentRef,i,getJoinPoint)){};currentRef.panel={};currentRef.panel.x=currentJoinPoint.X-PANEL_WIDTH/2;currentRef.panel.y=isUpRef?currentJoinPoint.Y-tempHeigth:currentJoinPoint.Y;currentRef.panel.w=PANEL_WIDTH;currentRef.panel.h=tempHeigth;}};if(!this.isBigDataLoad){downRefs=[];upRefs=upRefs.filter(function(item){if(Number(item.isInUp)===1){return true;}});}
handleRefs(upRefs,true);handleRefs(downRefs,false);var refs=upRefs.concat(downRefs);for(var i=0;i<refs.length;i++){refs[i].value&&Number(refs[i].value)&&this.drawReference(ctx,refs[i]);}
updateToHitModel();function updateToHitModel(){var ScreenCurrent=_this.screen;if(!ScreenCurrent){return;};ScreenCurrent.hitModel.remove(ScreenCurrent.enmuElementType.ruler);for(var n=0,len=that.references.length;n<len;n++){var ref=that.references[n];Number(ref.value)!==0&&ref.panel&&ScreenCurrent.hitModel.add(that.id+'_'+n,ScreenCurrent.enmuElementType.ruler,ref.panel.x,ref.panel.y,ref.panel.w,ref.panel.h);}}},ModelRuler.prototype.init=function(){this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;var ctx=this.ctxOffline;var geometry=new CanvasGeometry(ctx);ctx.clearRect(0,0,this.canvasOffline.width,this.canvasOffline.height);var length=this.maxValue-this.minValue;var paneY=this.height/3,paneHeight=this.height/3,paneX,paneWidth;var gradient=ctx.createLinearGradient(0,paneY,0,paneY+paneHeight);gradient.addColorStop(0,"#f1f1f1");gradient.addColorStop(0.2,"#fff");gradient.addColorStop(0.6,"#fff");gradient.addColorStop(1,"#e3e3e3");ctx.fillStyle=gradient;ctx.lineWidth=0;CanvasGeometry.fillRadiusRect(ctx,0,paneY,this.width,paneHeight,15);ctx.fill();paneX=15;paneY+=paneHeight/3-3;paneHeight=paneHeight/3+6;paneWidth=this.width-30;var gradient=ctx.createLinearGradient(0,paneY,0,paneY+paneHeight);gradient.addColorStop(0,"#989898");gradient.addColorStop(0.2,"#e3e3e3");gradient.addColorStop(0.8,"#fff");ctx.fillStyle=gradient;ctx.lineWidth=0;CanvasGeometry.fillRadiusRect(ctx,paneX,paneY,paneWidth,paneHeight,5);ctx.fill();paneX+=5;paneY+=3;paneHeight-=6;paneWidth-=10;ctx.textBaseline="middle";ctx.textAlign="center";ctx.fillStyle="#323232";for(var i=0;i<this.levels.length;i++){var tempX=paneX+paneWidth*(this.levels[i].min-this.minValue)/length;var tempWidth=paneWidth*(this.levels[i].max-this.levels[i].min)/length;ctx.save();ctx.fillStyle=this.levels[i].color;ctx.fillRect(tempX,paneY,tempWidth,paneHeight);ctx.restore();ctx.save();ctx.font="22px 微软雅黑";ctx.fillText(this.levels[i].text,tempX+tempWidth/2,paneY+paneHeight/2);ctx.restore();}
if(this.mainScale==0){alert(I18n.resource.observer.entities.MAIN_SCALE_INFO);return;}
var scaleY=paneY-4;var unitWidth=paneWidth/length*this.mainScale,tenthUnitWidth=unitWidth/10;ctx.lineWidth=1;ctx.fillStyle="#666666";for(var i=0;i<=length/this.mainScale+1;i++){var tempX=paneX+i*unitWidth;ctx.strokeStyle="#999999";ctx.beginPath();ctx.moveTo(tempX,scaleY);ctx.lineTo(tempX,scaleY-15);ctx.closePath();ctx.stroke();ctx.save();ctx.font="16px 微软雅黑";ctx.fillText((parseFloat(this.minValue)+this.mainScale*i).toFixed(this.decimal),tempX,scaleY-GRADUATION_MAIN_HEIGHT);ctx.restore();ctx.strokeStyle="#cccccc";ctx.beginPath();ctx.moveTo(tempX+unitWidth/2,scaleY);ctx.lineTo(tempX+unitWidth/2,scaleY-GRADUATION_HALF_HEIGHT);ctx.closePath();ctx.stroke();var tenthX=0;for(var count=1;count<10;count++){tenthX=tempX+tenthUnitWidth*count;if(tenthX<tempX+unitWidth){ctx.strokeStyle="#cccccc";ctx.beginPath();ctx.moveTo(tenthX,scaleY);ctx.lineTo(tenthX,scaleY-GRADUATION_TENTH_HEIGHT);ctx.closePath();ctx.stroke();}}}
scaleY=paneY+paneHeight+1;unitWidth=paneWidth/length*this.mainScale;for(var i=0;i<=length/this.mainScale+1;i++){var tempX=paneX+i*unitWidth;ctx.strokeStyle="#999999";ctx.beginPath();ctx.moveTo(tempX,scaleY);ctx.lineTo(tempX,scaleY+15);ctx.closePath();ctx.stroke();ctx.save();ctx.font="16px 微软雅黑";ctx.fillText((parseFloat(this.minValue)+this.mainScale*i).toFixed(this.decimal),tempX,scaleY+GRADUATION_MAIN_HEIGHT);ctx.restore();ctx.strokeStyle="#cccccc";ctx.beginPath();ctx.moveTo(tempX+unitWidth/2,scaleY);ctx.lineTo(tempX+unitWidth/2,scaleY+GRADUATION_HALF_HEIGHT);ctx.closePath();ctx.stroke();var tenthX=0;for(var count=1;count<10;count++){tenthX=tempX+tenthUnitWidth*count;if(tenthX<tempX+unitWidth){ctx.strokeStyle="#cccccc";ctx.beginPath();ctx.moveTo(tenthX,scaleY);ctx.lineTo(tenthX,scaleY+GRADUATION_TENTH_HEIGHT);ctx.closePath();ctx.stroke();}}}},ModelRuler.prototype.update=function(pointName,value){for(var i=0;i<this.references.length;i++){if(this.references[i].idCom==pointName){this.references[i].value=value;}}},ModelRuler.prototype.drawReference=function(ctx,item){if(Number(item.value)===0){return;}
ctx.save();var tempHeigth=this.height/5;var joinPoint=item.joinPoint,arrowPoint=item.arrowPoint,panelPoint=item.panel,isCurrentProject=Number(item.isInUp)===1;if(item.isZoom){panelPoint.w+=30;panelPoint.h+=20;panelPoint.x-=15;panelPoint.y-=15;item.isUpRef?joinPoint.Y+=5:joinPoint.Y-=14;}
ctx.textBaseline="middle";ctx.textAlign="center";ctx.save();ctx.beginPath();ctx.moveTo(arrowPoint.X,arrowPoint.Y);ctx.lineTo(joinPoint.X,joinPoint.Y);ctx.lineTo(joinPoint.X+7,joinPoint.Y);ctx.closePath();ctx.fillStyle="#939393";ctx.fill();ctx.beginPath();ctx.fillStyle="#fff";ctx.moveTo(arrowPoint.X,arrowPoint.Y);ctx.lineTo(joinPoint.X,joinPoint.Y);ctx.lineTo(joinPoint.X-7,joinPoint.Y);ctx.closePath();ctx.fill();ctx.restore();ctx.save();ctx.fillStyle="#ddd";ctx.fillRect(arrowPoint.X-1,item.isUpRef?arrowPoint.Y:arrowPoint.Y-18,2,18);ctx.restore();drawReferrencePanel(ctx,panelPoint.x,panelPoint.y,panelPoint.w,panelPoint.h,isCurrentProject);ctx.save();var zoomChangeHeight=item.isZoom?5:0;var itemValue=parseFloat(item.currentDrawValue).toFixed(PANEL_DECIMAL_PRECISION);if(isCurrentProject){switch(panel_change_value){case 0:ctx.fillStyle="#FFF";break;case 1:ctx.fillStyle="#FF9900";break;}
ctx.font="25px 微软雅黑";ctx.fillText(itemValue,joinPoint.X,panelPoint.y+tempHeigth/7*5+zoomChangeHeight);}else{if(itemValue<this.levels[0].min){ctx.fillStyle=COLOR_EXCELLENT;}else if(itemValue>this.levels[this.levels.length-1].max){ctx.fillStyle=COLOR_IMPROVEMENT;}else{for(var j=0;j<this.levels.length;j++){if(Number(itemValue)>=Number(this.levels[j].min)&&Number(itemValue)<=Number(this.levels[j].max)){ctx.fillStyle=getColorByAppraise(this.levels[j].text);break;}}}
ctx.font="25px 微软雅黑";ctx.fillText(itemValue,joinPoint.X+8,panelPoint.y+tempHeigth/7*5+zoomChangeHeight);}
var valueStyle=ctx.fillStyle;if(isCurrentProject){switch(panel_change_value){case 0:ctx.fillStyle="#FFF";break;case 1:ctx.fillStyle="#FF9900";break;}
ctx.font="18px 微软雅黑";var itemNm=I18n.resource.observer.entities.CURRENT_PROJECT;ctx.fillText(itemNm,joinPoint.X,panelPoint.y+tempHeigth/7*2+zoomChangeHeight);}else{ctx.fillStyle=valueStyle;ctx.fillRect(joinPoint.X-70,panelPoint.y+tempHeigth/7*2+zoomChangeHeight-15,35,33);ctx.fillStyle="#FFF";ctx.font="35px 微软雅黑";var itemNm=item.name;if(itemNm.match(/\w/)){itemNm=itemNm.match(/\w/)[0];}
ctx.fillText(itemNm,joinPoint.X-53,panelPoint.y+tempHeigth/7*2+zoomChangeHeight);ctx.font="14px 微软雅黑";ctx.fillStyle="#232323";ctx.fillText(I18n.resource.observer.entities.WORKING_CONDITION_RATE,joinPoint.X+10,panelPoint.y+tempHeigth/7*2+zoomChangeHeight);ctx.lineWidth=1;ctx.strokeStyle='#CCC';ctx.beginPath();ctx.moveTo(joinPoint.X-35,panelPoint.y+tempHeigth/7*2+zoomChangeHeight-14);ctx.lineTo(joinPoint.X-35,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+50);ctx.moveTo(joinPoint.X-35,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+18);ctx.lineTo(joinPoint.X-70,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+18);ctx.closePath();ctx.stroke();if(this.plantIcon!==undefined){if(!this.plantIcon.complete){this.plantIcon.onload=function(e){ctx.drawImage(this.plantIcon,joinPoint.X-70,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+20,30,30);};}else{ctx.drawImage(this.plantIcon,joinPoint.X-70,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+20,30,30);}}}
ctx.restore();ctx.restore();};function ModelRulerReference(item,ruler){this.ruler=ruler;for(var prop in item){if(item.hasOwnProperty(prop)){this[prop]=item[prop];}}}
ModelRulerReference.prototype=new Sprite();ModelRulerReference.prototype.constructor=ModelRulerReference;ModelRulerReference.prototype.mouseEnter=function(){for(var n=0;n<this.ruler.references.length;n++){this.ruler.references[n].isZoom=false;}
this.isZoom=true;};ModelRulerReference.prototype.mouseOut=function(){this.isZoom=false;};function ModelRulerCurrentReference(item,ruler){this.ruler=ruler;for(var prop in item){if(item.hasOwnProperty(prop)){this[prop]=item[prop];}}}
ModelRulerCurrentReference.prototype=new Sprite();ModelRulerCurrentReference.prototype.constructor=ModelRulerCurrentReference;ModelRulerCurrentReference.prototype.mouseDown=function(){this.ruler.isBigDataLoad=!this.ruler.isBigDataLoad;};ModelRuler.ModelRulerCurrentReference=ModelRulerCurrentReference;ModelRuler.ModelRulerReference=ModelRulerReference;return ModelRuler;}();var ModelCheckbox=function(){function ModelCheckbox(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.idCom=undefined;this.type=undefined;this.fontColor=undefined;this.fontSize=undefined;this.setValue=undefined;this.unsetValue=undefined;this.text=undefined;this.idGroup=undefined;this.expression=undefined;};ModelCheckbox.prototype=new Sprite();ModelCheckbox.prototype.paint=function(ctx){},ModelCheckbox.prototype.update=function(_this,ctx){};return ModelCheckbox;}();var ModelTempDistribution=function(){var configMap={heat_radius:15,heat_blur:40,heat_interval_y:15,heat_interval_x:20,maxDistanceToCalc:200,limitedDistance:50,TEMP_RANGE:{min:20,max:30}};function getHeatData(data){var result=[];for(var n=0,len=data.length;n<len;n++){var item=data[n],temp=+item.value;result.push([item.x,item.y,temp?temp:0]);}
return result;}
function getTwoPointDistance(x1,y1,x2,y2){return Math.sqrt(Math.pow(Math.abs(x2)-Math.abs(x1),2)+Math.pow(Math.abs(y2)-Math.abs(y1),2));}
function calcPointTemp(x,y,heatData){if(!heatData||heatData.length===0){return;}
var temp=0,distanceTotal=0,confortableLength=(configMap.TEMP_RANGE.max-configMap.TEMP_RANGE.min)/2,confortableTemp=configMap.TEMP_RANGE.max-confortableLength;for(var m=0,mlen=heatData.length;m<mlen;m++){var heatDataItem=heatData[m],distance=getTwoPointDistance(x,y,heatDataItem[0],heatDataItem[1]);var heatDataItemTemp=heatDataItem[2];if(distance===0){return Number(heatDataItemTemp);}
if(distance>configMap.maxDistanceToCalc){continue;}
if(heatDataItemTemp>50||heatDataItemTemp<0){continue;}
if(distance<configMap.limitedDistance){if(heatDataItemTemp>configMap.TEMP_RANGE.max){return configMap.TEMP_RANGE.max;}
if(heatDataItemTemp<configMap.TEMP_RANGE.min){return configMap.TEMP_RANGE.min;}
return heatDataItemTemp;}
temp+=heatDataItemTemp&&distance?heatDataItemTemp/distance:heatDataItemTemp;distanceTotal+=1/(distance*0.9);}
if(!distanceTotal){distanceTotal=1;}
temp=temp/distanceTotal;return Number(temp);}
function calcAllTempData(rawData,x,y,w,h){if(!rawData){return[];}
var heatData=getHeatData(rawData),maxX=x+w,maxY=y+h,yInterval=configMap.heat_interval_y,xInterval=configMap.heat_interval_x,allTempPoint=[];for(var m=x-5*xInterval;m<maxX+5*xInterval;m=m+xInterval){for(var n=y-5*yInterval;n<maxY+5*yInterval;n=n+yInterval){var temp=calcPointTemp(m,n,heatData);if(typeof temp==='undefined'){continue;}
temp=Number(temp.toFixed(2));if(typeof temp!='number'||temp<0){temp=0;}
allTempPoint.push([Number(m.toFixed(2)),Number(n.toFixed(2))-y,temp]);}}
return allTempPoint;}
function ModelTempDistribution(id,painter,behaviors,pageScreen){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.heat=undefined;this.data=[];this.pageScreen=pageScreen;}
ModelTempDistribution.prototype=new Sprite();ModelTempDistribution.prototype.constructor=ModelTempDistribution;ModelTempDistribution.prototype.close=function(){this.canvasOffline=null;this.ctxOffline=null;this.data=[];this.heat.destroy();this.heat=null;$(ElScreenContainer).off('refreshHeatMap');};ModelTempDistribution.prototype.init=function(){this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;this.loadColorSetting();var _this=this;$(ElScreenContainer).off('refreshHeatMap').on('refreshHeatMap',function(){_this.loadColorSetting();_this.renderTempDistribution();});};ModelTempDistribution.prototype.loadColorSetting=function(){var _this=this;this.loadColorSettingPromise=WebAPI.post('/admin/getColorSetting',{userId:AppConfig.userId,heatType:this.heatType||'co'}).done(function(result){if(result.success){_this.colorSettings=result.data;if(result.data){window.colorGettings={max:result.data.max.value,min:result.data.min.value};}}});};ModelTempDistribution.prototype.resetMaxMinTemp=function(){configMap.TEMP_RANGE.max=30;configMap.TEMP_RANGE.min=20;};ModelTempDistribution.prototype.setMaxMinTemp=function(){var tempSetType,setValue;if(this.colorSettings){for(tempSetType in this.colorSettings){if(this.colorSettings.hasOwnProperty(tempSetType)){if(tempSetType=='max'){setValue=this.colorSettings[tempSetType].value;configMap.TEMP_RANGE.max=typeof setValue=='undefined'||setValue===''?30:Number(setValue);}else if(tempSetType=='min'){setValue=this.colorSettings[tempSetType].value;configMap.TEMP_RANGE.min=typeof setValue=='undefined'||setValue===''?20:Number(setValue);}}}}else{this.resetMaxMinTemp();}};ModelTempDistribution.prototype.paint=function(ctx){ctx.rect(this.x,this.y,this.canvasOffline.width,this.canvasOffline.height);ctx.drawImage(this.canvasOffline,this.x,this.y);};ModelTempDistribution.prototype.update=function(updateData){if(!updateData||!this.width||!this.height){return;}
for(var m=0;m<this.data.length;m++){for(var n=0;n<updateData.length;n++){if(this.data[m].idCom===updateData[n].name){this.data[m].value=updateData[n].value;break;}}}
this.renderTempDistribution();};ModelTempDistribution.prototype.filterBadPoint=function(rowData){if(!rowData){return[];}
var result=[];for(var i=0;i<rowData.length;i++){if(rowData[i].idCom&&rowData[i].value&&rowData[i].value>0&&rowData[i].value<50){result.push(rowData[i]);}}
return result;};ModelTempDistribution.prototype.renderTempDistribution=function(){var _this=this,heat;this.loadColorSettingPromise.done(function(){Spinner.spin(ElScreenContainer);_this.setMaxMinTemp();_this.data=_this.filterBadPoint(_this.data);var allHeatData=calcAllTempData(_this.data,_this.x,_this.y,_this.width,_this.height);if(_this.pageScreen){_this.pageScreen.renderLastData();Spinner.stop();}
if(!allHeatData||!allHeatData.length){return;}
_this.heat=simpleHeat(_this.ctxOffline.canvas).data(allHeatData);_this.heat.max(configMap.TEMP_RANGE.max);_this.heat.min(configMap.TEMP_RANGE.min);_this.heat.draw();Spinner.stop();});};ModelTempDistribution.prototype.createHeatRuler=function(ctx,x,y){var x=x?x:20,y=y?y:ctx.canvas.height-280;var _this=this;this.loadColorSettingPromise.done(function(){if(!_this.heat)return;ctx.save();ctx.globalAlpha=0.95;ctx.fillStyle='#eee';CanvasGeometry.fillRadiusRect(ctx,x-3,y-3,40,262,3);ctx.fill();ctx.drawImage(_this.heat.canvsdpalette,x,y,34,256);ctx.fillStyle='#eee';ctx.font='bold 20px Arial';ctx.fillText(configMap.TEMP_RANGE.min,x+6,y+26);ctx.fillText(configMap.TEMP_RANGE.max,x+6,y+246);ctx.restore();});};return ModelTempDistribution;}();var ModelRect=function(){function ModelRect(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.x=null;this.y=null;this.width=null;this.height=null;this.layer=null;this.lineStyle=[6];};ModelRect.prototype=Object.create(Sprite.prototype);ModelRect.prototype.paint=function(ctx){ctx.save();ctx.setLineDash(this.lineStyle);ctx.lineWidth="4";ctx.strokeRect(this.x,this.y,this.width,this.height);ctx.restore();},ModelRect.prototype.mouseEnter=function(){},ModelRect.prototype.mouseOut=function(){};ModelRect.prototype.mouseDown=function(){};return ModelRect;}();var SharpViewScreen=function($,window,undefined){var _this=null;var showMode={TILE:'Tile',LINEAR:'Linear'};var layoutClasses={'Tile':TileLayout,'Linear':LinearLayout};function SharpViewScreen(sliders,store){_this=this;this.options=SharpViewScreen.DEFAULTS;this.cur=null;this.total=sliders.length;this.sliderList=sliders;this.slidersStatus={};this.layoutHandler=null;this.store=store;this.factoryIoC=new FactoryIoC('analysis');this.curModal=null;this.datasource=new DataSource(this);this.dataSourceConflict=AppConfig.datasource;AppConfig.datasource=this.datasource;this.saveModalJudge=$.Deferred();this.$stage=null;this.$sliders=null;}
SharpViewScreen.prototype={constructor:SharpViewScreen,show:function show(){WebAPI.get('/static/views/observer/sharpViewScreen.html').done(function(resultHtml){$('<div class="sharpview-wrap sharpview" id="sharpViewWrap">').appendTo('body').html(resultHtml);_this.init();});},init:function init(){var arrHtml=[];this.$stage=$('#sharpViewStage');for(var i=0,len=this.sliderList.length;i<len;i++){arrHtml.push(this.options.itemTmpl.format(i));}
this.$stage.html(arrHtml.join(''));this.$sliders=this.$stage.children('*');this.layout(showMode.LINEAR);},onresize:function onresize(){if(ScreenCurrent.paneCenter&&ScreenCurrent.paneCenter.chart){ScreenCurrent.paneCenter.chart.resize();}},layout:function layout(mode){var _this=this;var options={};mode=mode||showMode.TILE;if(this.layoutHandler)this.layoutHandler.destroy();switch(mode){case showMode.TILE:break;case showMode.LINEAR:options.onFlipStart=function(e){var pos=e.pos;if(pos===_this.cur)return;};options.onFlipEnd=function(e){var pos=e.pos;_this.cur=pos;_this.renderSlider();};break;}
this.layoutHandler=new layoutClasses[mode](this.$stage,this.$sliders,options);this.layoutHandler.layout();},renderSlider:function renderSlider(container){this.renderModal(this.cur);this.renderModal(Math.min(this.total-1,Math.max(this.cur-1,0)));this.renderModal(Math.min(this.total-1,Math.max(this.cur+1,0)));},renderModal:function renderModal(index){var container=this.$sliders.eq(index).children('div')[0];var modal=this.sliderList[index];var modalId=modal.id;this.curModal=modal.option;if(this.slidersStatus[modalId]==='loaded')return;if(this.curModal.type){var modalClass=this.factoryIoC.getModel(this.curModal.type);this.slidersStatus[modalId]='loaded';new modalClass(container,this.curModal,this).show();}else{this.alertNoData();}},updateModal:function updateModal(){},showConfigMode:function showConfigMode(){},setModalOption:function setModalOption(){},spinnerStop:function spinnerStop(){},saveModal:function saveModal(){},alertNoData:function alertNoData(){},destroy:function destroy(){$('#sharpViewWrap').remove();this.layoutHandler.destroy();AppConfig.datasource=this.dataSourceConflict;}};SharpViewScreen.DEFAULTS={itemTmpl:'<div class="play-slider-ctn" data-index="{0}"><div style="padding: 20px;z-index: 100;position: absolute;left:0;top:0;right:0;bottom:0;overflow-x: hidden;overflow-y: auto;">This page has no data.</div></div>'};function Layout($stage,$sliders){this.$stage=$stage;this.$sliders=$sliders;this.curPos=null;this.total=null;}
Layout.prototype={constructor:Layout,layout:function layout(){this.total=this.$sliders.length;this._layout.apply(this,arguments);},destroy:function destroy(){this._destroy();}};function TileLayout($stage,$sliders){Layout.apply(this,arguments);this.name='Tile';}
TileLayout.prototype=Object.create(Layout.prototype);TileLayout.prototype.constructor=TileLayout;TileLayout.prototype._layout=function(){var per;for(var i=0;i<this.total;i++){per=(i-1)*105;this.$sliders.eq(i).css({'transform':'translateZ(-2500px) translate('+per+'%, 0%)'});}};function LinearLayout($stage,$sliders,options){Layout.apply(this,arguments);this.options=$.extend({},LinearLayout.DEFAULTS,options);this.name='linear';}
LinearLayout.prototype=Object.create(Layout.prototype);LinearLayout.prototype.constructor=LinearLayout;LinearLayout.prototype._layout=function(startPos){var per;this.$stage.addClass(this.options.animateCls);this.attachEvents();this.to(startPos||0);};LinearLayout.prototype.to=function(pos){var _this=this;var direction=pos<this.curPos?'left':'right';var pos=pos===undefined?0:Math.min(Math.max(pos,0),this.total-1);if(pos===this.curPos){this.doBoundAnimation(direction);return;}
this.curPos=pos;typeof _this.options.onFlipStart==='function'&&_this.options.onFlipStart({pos:pos});this.$sliders.each(function(i){if(i<pos)$(this).removeClass().addClass('past');if(i>pos)$(this).removeClass().addClass('future');});window.setTimeout(function(pos){return function(){_this.$sliders.eq(pos).removeClass().addClass('present');};}(pos),50);this.$sliders.off().on('transitionend',function(e){e=e.originalEvent;if(e.target.className!=='present')return;if(e.propertyName==='transform'){typeof _this.options.onFlipEnd==='function'&&_this.options.onFlipEnd({pos:pos});}});};LinearLayout.prototype.prev=function(){this.to(this.curPos-1);};LinearLayout.prototype.next=function(){this.to(this.curPos+1);};LinearLayout.prototype.doBoundAnimation=function(direction){direction=direction||'left';$slider=this.$sliders.eq(this.curPos);if(direction==='left'){$slider.addClass('bound-left');}else{$slider.addClass('bound-right');}
if(this.curPos===0);else $slider.addClass('bound-right');};LinearLayout.prototype.attachEvents=function(){var _this=this;$(window).on('keydown.sharpview',function(e){switch(e.keyCode){case 37:_this.prev();break;case 38:break;case 39:_this.next();break;case 40:break;}});$(window).on('keyup.sharpview',function(e){switch(e.keyCode){case 37:_this.$sliders.eq(_this.curPos).removeClass('bound-left');break;case 38:break;case 39:_this.$sliders.eq(_this.curPos).removeClass('bound-right');break;case 40:break;}});};LinearLayout.prototype.detachEvents=function(){$(window).off('keydown.sharpview');$(window).off('keyup.sharpview');};LinearLayout.prototype._destroy=function(){this.detachEvents();};LinearLayout.DEFAULTS={animateCls:'linear-1'};var Parallex={step:1000,rateBg1:1,rateBg2:0.5,rateBg3:0.2,direction:1,flowLeft:function flowLeft(){this.direction=-1;this.flow();},flowRight:function flowRight(){this.direction=1;this.flow();},flow:function flow(){var posBg1=parseFloat(this.$bg1.css('background-position-x'));var posBg2=parseFloat(this.$bg2.css('background-position-x'));var posBg3=parseFloat(this.$bg3.css('background-position-x'));this.changeTransition('.5s','cubic-bezier(0.26,.86,.44,.985)');if(this.direction>0){this.$bg1.css('background-position-x',posBg1+this.step*this.rateBg1+'px');this.$bg2.css('background-position-x',posBg2+this.step*this.rateBg2+'px');this.$bg3.css('background-position-x',posBg3+this.step*this.rateBg3+'px');}
else{this.$bg1.css('background-position-x',posBg1-this.step*this.rateBg1+'px');this.$bg2.css('background-position-x',posBg2-this.step*this.rateBg2+'px');this.$bg3.css('background-position-x',posBg3-this.step*this.rateBg3+'px');}},changeTransition:function changeTransition(duration,TimingFn){this.$bg1.css({'transition-duration':duration,'transition-timing-function':TimingFn});this.$bg2.css({'transition-duration':duration,'transition-timing-function':TimingFn});this.$bg3.css({'transition-duration':duration,'transition-timing-function':TimingFn});},init:function init(){var _this=this;this.$bg1=$('#bg1');this.$bg2=$('#bg2');this.$bg3=$('#bg3');this.$bg1.off().on('transitionend',function(e){var distance=1500;var posBg1=parseFloat(_this.$bg1.css('background-position-x'));var posBg2=parseFloat(_this.$bg2.css('background-position-x'));var posBg3=parseFloat(_this.$bg3.css('background-position-x'));e=e.originalEvent;_this.changeTransition('30s','linear');if(e.propertyName==='background-position-x'){if(_this.direction>0){_this.$bg1.css('background-position-x',posBg1+distance*_this.rateBg1+'px');_this.$bg2.css('background-position-x',posBg2+distance*_this.rateBg2+'px');_this.$bg3.css('background-position-x',posBg3+distance*_this.rateBg3+'px');}else{_this.$bg1.css('background-position-x',posBg1-distance*_this.rateBg1+'px');_this.$bg2.css('background-position-x',posBg2-distance*_this.rateBg2+'px');_this.$bg3.css('background-position-x',posBg3-distance*_this.rateBg3+'px');}}});}};return SharpViewScreen;}(jQuery,window);var DrawGraph=function(){var _this;function DrawGraph(screenPre,graph,container,color){_this=this;this.container=container;this.color=color;this.screenPre=screenPre;this.graph=graph;this.svgW=undefined;this.svgH=undefined;}
DrawGraph.prototype={show:function show(){},render:function render(){},createBoard:function createBoard(){var $svgGraph=$('.svgGraph');var $boxWOrH;if($svgGraph.length===0){$svgGraph=$('<svg class="svgGraph" style="position:absolute;z-index:149;">\
                        <defs><marker id="arrowHead" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="red"/></marker>\
                        </defs>\
                        <path id="arrow-line" marker-end="url(#arrowHead)" stroke-width="4" fill="none" stroke="red" d=""/>\
                        <ellipse style="fill:rgba(0,0,0,0);stroke-width:2px;" orient="auto" class="circle" orient="auto"/>\
                        <rect style="fill:rgba(0,0,0,0);stroke-width:2px;" class="rect" orient="auto"/>\
                        </svg>');_this.$svgBox.append($svgGraph);}
if(_this.screenPre.curModal.type==='AnlzTendency'){$boxWOrH=$('#anlsPaneContain .panel-body .containerChi');}else{$boxWOrH=$('#anlsPaneContain .panel-body');}
this.svgW=$boxWOrH.width();this.svgH=$boxWOrH.height();$svgGraph[0].setAttribute("viewBox","0 0 "+this.svgW+" "+this.svgH);$svgGraph[0].setAttribute("width",this.svgW);$svgGraph[0].setAttribute("height",this.svgH);return $svgGraph;},deleteGraph:function deleteGraph(){if($('.deleteGraph').length===0){return;}
$('.deleteGraph').hover(function(e){$(this).css('cursor','pointer');},function(){$(this).css('cursor','');});$('.deleteGraph').off('click').click(function(){$(this).parent('.svgCopyBox').remove();var index=_this.getGraphListIndex($(this).parent('.svgCopyBox').children('.svgGraphCopy').attr('id'));if(index!=undefined){_this.screenPre.curModal.graphList.splice(index,1);_this.screenPre.saveModal();_this.screenPre.saveModalJudge.resolveWith(_this.screenPre,[_this.screenPre,1,_this.chart,$('#divWSPane .selected'),_this.screenPre.curModal,false]);}});},graphHover:function graphHover($svgCopyBox){$svgCopyBox.hover(function(){_this.deleteGraph();$(this).children('.deleteGraph').show();$(this).css({'cursor':'move'}).addClass('svgCopyBoxTem');},function(){$(this).removeClass('svgCopyBoxTem');$(this).children('.deleteGraph').hide();$(this).css('border','none');});},graphDrag:function graphDrag(graphDraw){var $target=$('#'+graphDraw.id);if($target.length===0){return;}
var svgGraphCopy=$target[0];var disX=0,disY=0;svgGraphCopy.onmousedown=function(e){var svgCopyBox=svgGraphCopy.parentNode;var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=e.clientX+scrollLeft-svgCopyBox.offsetLeft;disY=e.clientY+scrollTop-svgCopyBox.offsetTop;this.onmousemove=function(e){var ol=e.clientX+scrollLeft;var ot=e.clientY+scrollTop;var l=ol-disX;var t=ot-disY;svgCopyBox.style.left=l+"px";svgCopyBox.style.top=t+"px";var isTop=svgCopyBox.offsetTop<0;var isLeft=svgCopyBox.offsetLeft<0;var isRight=svgCopyBox.offsetParent.offsetWidth-svgCopyBox.offsetLeft<svgCopyBox.offsetWidth;var isBottom=svgCopyBox.offsetParent.offsetHeight-svgCopyBox.offsetTop<svgCopyBox.offsetHeight;if(isTop){svgCopyBox.style.top='0px';}
if(isLeft){svgCopyBox.style.left='0px';}
if(isRight){svgCopyBox.style.left=svgCopyBox.parentNode.offsetWidth-svgCopyBox.offsetWidth+'px';}
if(isBottom){svgCopyBox.style.top=svgCopyBox.parentNode.offsetHeight-svgCopyBox.offsetHeight+'px';}};this.onmouseup=function(e){this.onmousemove=null;this.onmouseup=null;var graph={id:graphDraw.id,downX:svgCopyBox.offsetLeft/_this.$svgBox.width(),downY:svgCopyBox.offsetTop/_this.$svgBox.height(),upX:svgCopyBox.offsetLeft/_this.$svgBox.width()+graphDraw.upX-graphDraw.downX,upY:svgCopyBox.offsetTop/_this.$svgBox.height()+graphDraw.upY-graphDraw.downY};_this.saveGraph(graph);};};},getGraphListIndex:function getGraphListIndex(id){for(var i=0;i<_this.screenPre.curModal.graphList.length;i++){if(_this.screenPre.curModal.graphList[i].id==id){return i;}}},saveGraph:function saveGraph(graph){var isSave=false;var index=_this.getGraphListIndex(graph.id);if(index==undefined){_this.screenPre.curModal.graphList.push(graph);doSave();}else{var graph_old=_this.screenPre.curModal.graphList[index];if(graph.downX&&graph.downX!=graph_old.downX){isSave=true;}
if(!isSave&&graph.downY&&graph.downY!=graph_old.downY){isSave=true;}
if(!isSave&&graph.upX&&graph.upX!=graph_old.upX){isSave=true;}
if(!isSave&&graph.upY&&graph.upY!=graph_old.upY){isSave=true;}
if(isSave){_this.screenPre.curModal.graphList[index].downX=graph.downX;_this.screenPre.curModal.graphList[index].downY=graph.downY;_this.screenPre.curModal.graphList[index].upX=graph.upX;_this.screenPre.curModal.graphList[index].upY=graph.upY;doSave();}}
function doSave(){_this.screenPre.saveModal();_this.screenPre.saveModalJudge.resolveWith(_this.screenPre,[_this.screenPre,1,_this.chart,$('#divWSPane .selected'),_this.screenPre.curModal,false]);}}};return DrawGraph;}();var DrawArrow=function(){var _this;function DrawArrow(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.screenPre=screenPre;this.graph=graph;this.container=container;if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
this.$svgBox=$(this.container).find('.svgBox');this.$parentContainer=$(this.container);if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=null;this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
_this=this;}
DrawArrow.prototype=new DrawGraph();DrawArrow.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawArrow.prototype.showArrow=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;var xDiffer=Math.abs(upX-downX);var yDiffer=Math.abs(upY-downY);if(xDiffer<20){xDiffer=20;}
if(yDiffer<20){yDiffer=20;}
if(upX>=downX&&upY<downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+downX*100/svgBoxW+'%;top:'+(upY*100/svgBoxH-0.6)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy"  id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line2" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M0 , '+yDiffer+'L'+Math.abs(upX-downX-8)+',8"/>'+'</svg>');}
else if(upX>downX&&upY>=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+downX*100/svgBoxW+'%;top:'+downY*100/svgBoxH+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M0 ,0 '+'L'+Math.abs(upX-downX-8)+','+Math.abs(upY-downY-8)+'"/>'+'</svg>');}
else if(upX<=downX&&upY<=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+upX*100/svgBoxW+'%;top:'+upY*100/svgBoxH+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" id="new Date().getTime()" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M '+xDiffer+','+yDiffer+'L8,8"/>'+'</svg>');}
else if(upX<downX&&upY>=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+upX*100/svgBoxW+'%;top:'+downY*100/svgBoxH+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow" >\
                            <defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>\
                            <path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M'+xDiffer+' ,0 '+' L8,'+Math.abs(upY-downY-8)+'"/>\
                            </svg>');}
$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawArrow.prototype.render=function(graph){var $box_arrow=_this.showArrow(graph);this.$svgBox.append($box_arrow);};DrawArrow.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function rotate(angle){var arrowLine=$('#arrow-line')[0];arrowLine.setAttribute("transform","rotate("+angle+")");}
function lineTo(start,end){var arrowLine=$('#arrow-line')[0];var arrowHeadP=$('#arrowHead path')[0];arrowLine.setAttribute('d','M'+start.join(',')+' L'+end.join(','));arrowLine.setAttribute("stroke",_this.color);arrowHeadP.setAttribute('fill',_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;lineTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return;}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'arrow',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()};$svgCopyBox=_this.showArrow(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);$('.svgGraph').remove();_this.saveGraph(graphDraw);$('#graphBox').hide();$('.graphActive').click();$('.svgGraph').remove();};};};return DrawArrow;}();var DrawCircle=function(){var _this;function DrawCircle(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.graph=graph;this.container=container;this.screenPre=screenPre;this.$svgBox=$(this.container).find('.svgBox');;this.$parentContainer=$(this.container).parent();if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
_this=this;}
DrawCircle.prototype=new DrawGraph();DrawCircle.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawCircle.prototype.showCircle=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(Math.abs(upX-downX)+8)+'px;height:'+(Math.abs(upY-downY)+8)+'px;position:absolute;left:'+downX*100/svgBoxW+'%;top:'+downY*100/svgBoxH+'%;z-index:149;padding:2px;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+Math.abs(upX-downX)+' '+Math.abs(upY-downY)+'" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'" type="circle">'+'<ellipse style="fill:rgba(0,0,0,0);stroke-width:3px;stroke:'+graphDraw.color+'" orient="auto" cx="'+Math.abs(upX-downX)/2+'" cy="'+Math.abs(upY-downY)/2+'" rx="'+Math.abs(upX-downX-4)/2+'" ry="'+Math.abs(upY-downY-4)/2+'" x="0" y="0"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawCircle.prototype.render=function(graph){var $box_cicle=_this.showCircle(graph);this.$svgBox.append($box_cicle);};DrawCircle.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function circleTo(start,end){var circle=$('.circle')[0];circle.setAttribute("cx",start[0]+Math.abs(end[0]-start[0])/2);circle.setAttribute("cy",start[1]+Math.abs(end[1]-start[1])/2);circle.setAttribute("rx",Math.abs(end[0]-start[0])/2);circle.setAttribute("ry",Math.abs(end[1]-start[1])/2);circle.setAttribute("stroke",_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;circleTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return;}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'circle',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()};$svgCopyBox=_this.showCircle(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);_this.saveGraph(graphDraw);$('#graphBox').hide();$('.svgGraph').remove();};};};return DrawCircle;}();var DrawRect=function(){var _this;function DrawRect(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.graph=graph;this.container=container;this.screenPre=screenPre;this.$svgBox=$(this.container).find('.svgBox');;this.$parentContainer=$(this.container).parent();if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
_this=this;}
DrawRect.prototype=new DrawGraph();DrawRect.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawRect.prototype.showRect=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(Math.abs(upX-downX)+8)+'px;height:'+(Math.abs(upY-downY)+8)+'px;padding:2px;position:absolute;left:'+downX*100/svgBoxW+'%;top:'+downY*100/svgBoxH+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+Math.abs(upX-downX)+' '+Math.abs(upY-downY)+'" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'" type="rect">'+'<rect style="fill:rgba(0,0,0,0);stroke-width:4px;stroke:'+graphDraw.color+'" orient="auto" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawRect.prototype.render=function(graph){var $box_rect=_this.showRect(graph);this.$svgBox.append($box_rect);};DrawRect.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function rectTo(start,end){var rect=$('.rect')[0];rect.setAttribute('width',Math.abs(end[0]-start[0]));rect.setAttribute('height',Math.abs(end[1]-start[1]));rect.setAttribute('x',start[0]);rect.setAttribute('y',start[1]);rect.setAttribute('stroke',_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;rectTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return;}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'rect',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()};$svgCopyBox=_this.showRect(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);_this.saveGraph(graphDraw);$('#graphBox').hide();$('.svgGraph').remove();};};};return DrawRect;}();var AnlzBase=function(){var _this;function AnlzBase(container,option,screen){_this=this;this.container=container;this.options=option;this.screen=screen;this.paneChart=undefined;this.paneNotes=undefined;this.chart=undefined;this.noteCount=0;this.chartAnimationDuration=500;this.spinnerRender=new LoadingSpinner({color:'#00FFFF'});this.noteDefaultWidth=440;this.noteDefaultHeight=220;this.dockArea=[];this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;}
AnlzBase.prototype={show:function show(){this.initTools();this.container.innerHTML='';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.noteList){this.screen.curModal.noteList=[];}else{_this.initNotes();}
$divBackgroundContainer=$('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">');if(!this.paneChart){this.paneChart=$('<div style="width: 100%; height: 100%;">')[0];$(this.container).append($divBackgroundContainer).append(this.paneChart);}else{$(this.container).append($divBackgroundContainer);}
_this.spinnerRender.spin(this.container.parentElement);if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;var containerChilBox;if(_this.screen.curModal.type==='AnlzTendency'){containerChilBox=$(_this.container).find('.containerChi')[0];}else{containerChilBox=_this.container;}
for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],containerChilBox,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],containerChilBox,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],containerChilBox,'');}
graph.show();}}
this.init();},renderModal:function renderModal(data){_this=this;_this.spinnerRender.stop();try{_this.render(data);}catch(e){console.warn(e);}
setTimeout(function(){_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);_this.spinnerRender.stop();},_this.chartAnimationDuration);},spinnerStop:function spinnerStop(){Spinner.stop();_this.spinnerRender.stop();},close:function close(){this.spinnerRender.stop();this.screen=null;this.options=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;},init:function init(){},errAlert:function errAlert(err){var $dataAlert=$('#dataAlert');switch(err){case'no data history':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE6+"</strong>").show().close();break;case'time':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE7+"</strong>").show().close();break;case'invalid time string':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE8+"</strong>").show().close();break;default:new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE9+"</strong>").show().close();break;}},initDock:function initDock(){var arrHtml=[],previewerHtml=[];var $paneDock=$('.pane-dock',this.$parentContainer);if($paneDock.length){this.$paneDock=$paneDock;this.$dockManager=$('.dock-manager',$paneDock);this.$dockPreviewer=$('.dock-previewer-manager',$paneDock);return;}
arrHtml.push('<div class="dock-wheel dock-wheel-fill-icon" data-type="fill"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-fill" data-type="fill" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-top-icon" data-type="top"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-top" data-type="top" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-right-icon" data-type="right"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-right" data-type="right" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-down-icon" data-type="bottom"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-down" data-type="bottom" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-left-icon" data-type="left"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-left" data-type="left" style="display:none;"></div>');this.$paneDock=$('<div class="pane-dock" style="position: absolute; left: 0; top: 0; width:100%; height:100%;">');this.$dockManager=$('<div class="dock-manager" style="position: absolute;left: 0; top: 0; width:100%; height:100%;">');this.$dockPreviewer=$('<div class="dock-previewer-manager" style="position: absolute; left:0; top:0; width:100%;height:100%;">');this.$dockManager[0].innerHTML=arrHtml.join('');this.$dockPreviewer[0].innerHTML=previewerHtml.join('');this.$paneDock[0].appendChild(this.$dockManager[0]);this.$paneDock[0].appendChild(this.$dockPreviewer[0]);this.$parentContainer[0].appendChild(this.$paneDock[0]);},resetDock:function resetDock(){this.$parentContainer.children('.dock-window-ctn').remove();this.$parentContainer.children('.dock-note-toolbar').remove();this.$paneDock.remove();$(this.container).css({'top':0,'left':0,'bottom':0,'right':0});},initTools:function initTools(){var _this=this;var $noteHideShow=$('#btnNoteHideOrShow');var $graphsBox=$('#graphBox');$('.itemTools .glyphicon-log-out').off('click').on('click',function(){if(!_this.screen)return;_this.screen.refreshPaneCenter(new window.analysis.panels.AnalysisTemplate(_this.screen));$('.divPage.selected').removeClass('selected');$('.itemTools .glyphicon-cog').off('click');$('#rightCt').trigger('click');});$('.itemTools .glyphicon-cog').off('click').on('click',function(){var optionTemplate=_this.screen.factoryIoC.getModel(_this.screen.curModal.type).prototype.optionTemplate;var data=[];for(var i=0;i<_this.screen.curModal.itemDS.length;i++){data.push({});data[i].dsType=_this.screen.curModal.itemDS[i].type;data[i].dsId=_this.screen.curModal.itemDS[i].arrId;data[i].dsName=[];var arrId=_this.screen.curModal.itemDS[i].arrId;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);for(var j=0;j<arrId.length;j++){var id=arrId[j];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){data[i].dsName.push(arrItem[m].alias);break;}}}}
var option={modeUsable:optionTemplate.chartConfig,allDataNeed:optionTemplate.templateParams.paraAnlysMode=='all',rowDataType:optionTemplate.templateParams.paraName,dataTypeMaxNum:optionTemplate.templateParams.dataTypeMaxNum,templateType:_this.screen.curModal.type,dsChartCog:_this.screen.curModal.dsChartCog,optionPara:{mode:_this.screen.curModal.mode,startTime:_this.screen.curModal.startTime,endTime:_this.screen.curModal.endTime,interval:_this.screen.curModal.format,dataItem:data}};_this.screen.modalConfig.showModalInit(false,option);});$('.itemTools .glyphicon-edit').off('click').click(function(){_this.createNote();$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$('.divNote').show();});$('#btnDownLoadExcel_a').off('click').click(function(){var xAxisList=_this.options.xAxisData;var str='坐标轴';var dataListArr=[];var dictDataList=_this.options.dataList?_this.options.dataList:{};if(dictDataList){for(var item in dictDataList){var itemL=dictDataList[item];if(itemL.length>1&&Object.prototype.toString.call(itemL[0])==='[object Array]'){for(var m=0,lens=itemL.length;m<lens;m++){dataListArr.push(itemL[m]);}}else{dataListArr.push(itemL);}
str+=','+item;}
if(xAxisList&&xAxisList.length!==0){for(var i=0,len=xAxisList.length;i<len;i++){str+='\n'+xAxisList[i];for(var j=0,lens=dataListArr.length;j<lens;j++){str+=','+dataListArr[j][i];}}}else{for(var n=0;n<1;n++){str+='\n';for(var p=0,length=dataListArr.length;p<length;p++){str+=','+dataListArr[p][n];}}}}else{str='无数据';}
$(this).attr('download',_this.screen.path[_this.screen.path.length-1].title+'.csv');str='\uFEFF'+str;var blob=new Blob([str],{type:'text/csv;charset=utf-8'});var csvUrl=URL.createObjectURL(blob);document.getElementById("btnDownLoadExcel_a").href=csvUrl;});$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$noteHideShow.off('click').click(function(){if($noteHideShow.hasClass('glyphicon-eye-close')){$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$('.divNote').show();}else if($noteHideShow.hasClass('glyphicon-eye-open')){$noteHideShow.removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');$('.divNote').hide();}});if($graphsBox.length===0){$graphsBox=$('<ul id="graphBox" style="top:36px;left:auto;right:18px;width:118px;float:right;padding:5px 10px;position:absolute;z-index:150;border:1px solid #DDDDDE;border-radius:5px;background:#fff;display:none;">'+'<li style="width:98px;margin:0 auto;list-style:none;" class="graphSel"><span class="glyphicon glyphicon-arrow-right firstSpan" value="arrow" style="font-size:18px;color:#B6B4B4;margin-right:15px;display:inline-block!important;" id="arrowActive"></span>'+'<span class="icon-check-empty" id="rectActive" value="rect" style="width:16px;height:16px;border:2px solid #B6B4B4;margin-right:15px;display:inline-block!important;"></span>'+'<span class="icon-circle-blank" id="circleActive" value="circle" style="width:18px;height:18px;border:2px solid #B6B4B4;border-radius:9px;display:inline-block!important;"></span></li>'+'<li class="colorTotal" style="width:98px;margin:10px auto 0px;list-style:none;display:none;"><div style="width:24px;height:24px;border:1px solid #BDBEBF;float:left;margin-right:10px;">'+'<span class="colorSelect" style="display:block;width:20px;height:20px;margin:1px;background:red;"></span></div>'+'<div class="colorList" style="float:left;width:60px;margin-top:-5px;">'+'<span style="display:inline-block;width:11px;height:11px;background:#000;margin-right:3px;line-height:11px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;background:#7ab900;margin-right:3px;line-height:11px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#007acc;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ecede5;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ff2525;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#fcd209;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ff5500;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#a6b16c;font-size:11px;"></span></div>'+'<br style="clear:both;"></li>'+'</ul>');$('#anlsPaneContain').append($graphsBox);}
$('#anlsPaneContain').css('position','relative');$('#graphSelsect').off('click').click(function(){if($graphsBox.is(':hidden')){$graphsBox.show();}else{$graphsBox.hide();}});$('#btnDataFilter').off('click').click(function(){new DataCalcFilterContain(_this).show();});$('#anlsPaneContain .colorList span').hover(function(){$(this).css({'border-width':'1px','border-style':'solid','border-color':'#ddddde','border-radius':'5px'});},function(){$(this).css({'border':'none','border-radius':'0px'});});$('#anlsPaneContain .colorList span').off('click').click(function(){var graphType=$('.graphActive').attr('value');$('#anlsPaneContain .colorSelect').css('background-color',$(this).css('background-color'));var color=$('#anlsPaneContain .colorSelect').css('background-color');$('.svgGraph').remove();drawGraph(graphType,color);});$('#anlsPaneContain .graphSel span').off('click').click(function(){var color=$('#anlsPaneContain .colorSelect').css('background-color');var $graphSel=$(this);var graphType=$graphSel.attr('value');if(!$graphSel.hasClass('graphActive')){if($graphSel.hasClass('firstSpan')){$graphSel.css('color','#000');}else{$graphSel.css('border','2px solid #000');}
$graphSel.siblings().css('color','#B6B4B4');$graphSel.siblings().removeClass('graphActive');$graphSel.addClass('graphActive');}else{if($graphSel.hasClass('firstSpan')){$graphSel.css('color','#B6B4B4');}else{$graphSel.css('border','2px solid #B6B4B4');}
$graphSel.removeClass('graphActive');}
if($('#anlsPaneContain .graphSel span').hasClass('graphActive')){$('#anlsPaneContain .colorTotal').show();}else{$('#anlsPaneContain .colorTotal').hide();}
drawGraph(graphType,color);});function drawGraph(graphType,color){var drawGraph=undefined;var containerChilBox;if(_this.screen.curModal.type==='AnlzTendency'){containerChilBox=$(_this.container).find('.containerChi')[0];}else{containerChilBox=_this.container;}
if(graphType=='arrow'){drawGraph=new DrawArrow(_this.screen,{},containerChilBox,color);}else if(graphType=='rect'){drawGraph=new DrawRect(_this.screen,{},containerChilBox,color);}else if(graphType=='circle'){drawGraph=new DrawCircle(_this.screen,{},containerChilBox,color);}
drawGraph.drawing();}},createNote:function createNote(note){var _this2=this;var origZIndex;var notePos=getDivNotePos();var dockTriggerIndex=null;var $divNote=$('<div class="divNote">').click(function(){if($('.divNote').length>1){_this.curtNote=$divNote[0];if(this.style.zIndex<_this.getNoteMaxZIndex()){this.style.zIndex=_this.getNoteMaxZIndex()+1;origZIndex=this.style.zIndex;}}}).hover(function(e){if(this.style.zIndex<_this.getNoteMaxZIndex()){origZIndex=getComputedStyle(this).zIndex;this.style.zIndex=_this.getNoteMaxZIndex()+1;}}).attr('id',note?note.id:new Date().valueOf()).css({zIndex:_this.getNoteMaxZIndex()+1,left:note?note.x:'auto',right:note?'auto':notePos.x+'px',top:note?note.y:notePos.y,width:note?note.width:this.noteDefaultWidth+'px',height:note?note.height:this.noteDefaultHeight+'px',backgroundColor:note?note.bgColor:''}).mousedown(_this.doDown).mouseup(_this.doUp);var $divDrag=$('<div class="divDrag">').appendTo($divNote);var $divTitle=$('<div class="title">').appendTo($divDrag);$divDrag[0].draggable=true;setDrag($divDrag[0]);var disX=0;var disY=0;function setDrag(obj){obj.onmouseover=function(){obj.style.cursor="move";};obj.onmousedown=function(event){var realDragObj=obj.parentNode;var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=event.clientX+scrollLeft-realDragObj.offsetLeft;disY=event.clientY+scrollTop-realDragObj.offsetTop;_this.showDockWheel();document.onmousemove=function(event){var ol=event.clientX+scrollLeft;var ot=event.clientY+scrollTop;var l=ol-disX;var t=ot-disY;realDragObj.style.left=l+"px";realDragObj.style.top=t+"px";var isTop=realDragObj.offsetTop<0;var isLeft=realDragObj.offsetLeft<0;var isRight=realDragObj.offsetParent.offsetWidth-realDragObj.offsetLeft<realDragObj.offsetWidth;var isBottom=realDragObj.offsetParent.offsetHeight-realDragObj.offsetTop<realDragObj.offsetHeight;if(isTop){realDragObj.style.top='0px';}
if(isLeft){realDragObj.style.left='0px';}
if(isRight){realDragObj.style.left=realDragObj.parentNode.offsetWidth-realDragObj.offsetWidth+'px';}
if(isBottom){realDragObj.style.top=realDragObj.parentNode.offsetHeight-realDragObj.offsetHeight+'px';}
var area;if(dockTriggerIndex!==null){area=_this.dockArea[dockTriggerIndex];if(ol>area.left&&ol<area.right&&ot>area.top&&ot<area.bottom){}else{dockTriggerIndex=null;area.$ele.removeClass('on');_this.hideDockPreviewer();}
return;}
for(var i=0,len=_this.dockArea.length;i<len;i++){area=_this.dockArea[i];if(ol>area.left&&ol<area.right&&ot>area.top&&ot<area.bottom){dockTriggerIndex=i;area.$ele.addClass('on');_this.showDockPreviewer(area.$ele[0].dataset.type);return;}}};document.onmouseup=function(){var area=_this.dockArea[dockTriggerIndex];document.onmousemove=null;document.onmouseup=null;var note={id:realDragObj.id,x:(realDragObj.offsetLeft/realDragObj.offsetParent.offsetWidth*100).toFixed(2)+'%',y:(realDragObj.offsetTop/realDragObj.offsetParent.offsetHeight*100).toFixed(2)+'%'};_this.hideDockPreviewer();_this.hideDockWheel();if(dockTriggerIndex!==null){_this.saveDockNoteLayout(note.id,area.$ele[0].dataset.type);note.x='10%';note.y='10%';_this.saveDockLayout();return false;}
_this.saveNote(note);};return false;};}
var $divPin=$('<div class="glyphicon pinIcon grow">&times;</div>').appendTo($divTitle);$divPin.mousedown(function(e){_this.removeNote(this);e.stopPropagation();});var $divText=$('<div class="divText gray-scrollbar">').appendTo($divDrag);if(_this.isShareMode!==1){(function(){var showEditor=function showEditor(e){var $modalConfig;WebAPI.get('/static/views/observer/widgets/modalUEditor.html').done(function(resultHTML){$('.divNote').hide();$('.dock-layout').hide();$('.svgBox').hide();$(_this.container).append(resultHTML);$modalConfig=$('#modalUEditor');$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$('.divNote').show();$('.dock-layout').show();$('#modalUEditorContainer').remove();$('#edui_fixedlayer').remove();$('#anlsPane').css({overflowX:'hidden',overflowY:'auto'});$('.svgBox').show();UE.delEditor('ueditor');});$modalConfig.off('show.bs.modal').on('show.bs.modal',function(){$('#anlsPane').css({overflow:'visible'});UE.getEditor('ueditor',{lang:I18n.type=='zh'?'zh-cn':'en'}).ready(function(){UE.insertPic(this);$(document.querySelector('iframe')).addClass('gray-scrollbar');var bodyEditor=document.querySelector('iframe').contentWindow.document.querySelector('body');note&&note.bgColor&&(bodyEditor.style.backgroundColor=note.bgColor);bodyEditor.innerHTML=note?note.text:'';});});$modalConfig.off('shown.bs.modal').on('shown.bs.modal',function(){});$modalConfig.modal('show');$(_this.container).find('#saveNote').off('click').on('click',function(){var body=$('iframe','.edui-editor-iframeholder')[0].contentWindow.document.querySelector('body');var content=body.innerHTML;var newNote={id:$divNote[0].id};if(note){newNote.text=content;newNote.bgColor=body.style.backgroundColor;}else{newNote.text=content;newNote.bgColor=body.style.backgroundColor;newNote.height=_this.noteDefaultHeight+'px';newNote.width=_this.noteDefaultWidth+'px';$divNote[0].style.right='';$divNote[0].style.left=$divNote.parent().width()-_this.noteDefaultWidth+'px';}
_this.saveNote(newNote);$divText.html(content);$divNote.css({backgroundColor:newNote.bgColor});$modalConfig.modal('hide');if(note){note.text=content;note.bgColor=newNote.bgColor;}else{note=newNote;}});});};+function(){var timer=null,mousePos=null;$divText.off('mousedown').mousedown(function(e){mousePos={x:e.clientX,y:e.clientY};});$divText.off('mouseup').mouseup(function(e){if(timer!==null){return;}
timer=window.setTimeout(function(){timer=null;},500);if(Math.abs(mousePos.x-e.clientX)<10&&Math.abs(mousePos.y-e.clientY)<10){showEditor();}
mousePos=null;});}.call(_this2);})();}
$divText.html(note?note.text:'');note&&note.bgColor&&$divNote.css({backgroundColor:note.bgColor});$(this.paneNotes).append($divNote);$(document).on('click','#st-container',_this.doClick);$(document).on('mousemove','#st-container',_this.doMove);function getDivNotePos(){var pos={};var $lastNote=$('.divNote:nth-last-child(1)');if($lastNote[0]){if($lastNote[0].offsetLeft<100){pos.x=0;pos.y=$lastNote[0].offsetTop+$lastNote[0].offsetHeight+20;_this.noteCount=0;}else{++_this.noteCount;pos.x=_this.noteCount*130;pos.y=$lastNote[0].offsetTop;}}else{pos.x=0;pos.y=0;}
return pos;}},removeNote:function removeNote(obj){confirm(i18n_resource.analysis.workspace.CONFIRM_NOTE_DELETE,function(){var $divNote=$(obj).closest('.divNote');$divNote.remove();var index=_this.getNoteListIndex($divNote.attr('id'));if(index!=undefined){_this.screen.curModal.noteList.splice(index,1);_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);}});},initNotes:function initNotes(){var _this=this;var notes=this.screen.curModal.noteList;var layout=this.screen.curModal.layout||{};if(!notes.length)return;notes.forEach(function(row){var dockPosition=null;for(var t in layout){if(!layout.hasOwnProperty(t)){continue;}
if(!layout[t]||!layout[t].length){continue;}
if(layout[t].indexOf(row.id)>-1){dockPosition=t;break;}}
if(!!dockPosition){_this.createDockNote(row,dockPosition);}else{_this.createNote(row);}});_this.layoutDockNotes();},hideNotes:function hideNotes(){},showNotes:function showNotes(){},getNoteMaxZIndex:function getNoteMaxZIndex(){var divNoteList=$('.divNote');var maxZIndex=102;for(var i=0;i<divNoteList.length;i++){var zIndex=parseInt(getComputedStyle(divNoteList[i]).zIndex);if(zIndex>maxZIndex){maxZIndex=zIndex;}}
return maxZIndex;},getNoteListIndex:function getNoteListIndex(id){for(var i=0;i<_this.screen.curModal.noteList.length;i++){if(_this.screen.curModal.noteList[i].id==id){return i;}}},showDockWheel:function showDockWheel(){var _this=this;var $dockFill=this.$dockManager.children('.dock-wheel-fill-icon');var $dockTop=this.$dockManager.children('.dock-wheel-top-icon');var $dockRight=this.$dockManager.children('.dock-wheel-right-icon');var $dockDown=this.$dockManager.children('.dock-wheel-down-icon');var $dockLeft=this.$dockManager.children('.dock-wheel-left-icon');var offset;this.$parentContainer.addClass('on');[$dockFill,$dockTop,$dockRight,$dockDown,$dockLeft].forEach(function($dock,i){offset=$dock.offset();_this.dockArea.push({'left':offset.left,'top':offset.top,'right':offset.left+$dock.width(),'bottom':offset.top+$dock.height(),'$ele':$dock});});},hideDockWheel:function hideDockWheel(){this.$parentContainer.removeClass('on');this.$dockManager.children().removeClass('on');},showDockPreviewer:function showDockPreviewer(type){this.$dockPreviewer.show();this.$dockPreviewer.children('[data-type="'+type+'"]').show();},hideDockPreviewer:function hideDockPreviewer(){this.$dockPreviewer.children().hide();this.$dockPreviewer.hide();},saveDockNoteLayout:function saveDockNoteLayout(noteId,direction){var layout=this.screen.curModal.layout;var notes=this.screen.curModal.noteList;var note;if(['top','right','bottom','left'].indexOf(direction)===-1)return;if(!layout){layout=this.screen.curModal.layout={};}
layout[direction]=layout[direction]||[];if(layout[direction].indexOf(noteId)>-1)return;layout[direction].push(noteId);$('#'+noteId).remove();note=notes.filter(function(row,i){return row.id===noteId;});if(note&&note.length){this.createDockNote(note[0],direction);this.layoutDockNotes();_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},createDockNote:function createDockNote(note,direction){var _this=this;var $ctn=this.$parentContainer.children('.dock-window-ctn');var $divNote=$('<div class="dock-note" style="background-color: '+note.bgColor+'">'+'<div class="dock-note-resizer" data-direction="'+direction+'"></div>'+'<button type="button" class="close editor"><span aria-hidden="true">'+I18n.resource.analysis.workspace.EDIT_NOTE+'</span></button>'+'<button type="button" class="close cancel"><span aria-hidden="true">'+I18n.resource.analysis.workspace.CANCEL_FIX+'</span></button>'+'<div class="dock-note-ct gray-scrollbar" data-id="'+note.id+'"></div>'+'<button id="saveDockNote" type="button" class="" style="display:none;position:absolute;bottom:5px;right:5px;z-index: 9999;color: #333;border-radius: 4px;box-shadow: 0px 3px 8px 2px #ccc;border: 1px solid #ccc;">Save</button>'+'</div>');var $divNoteCt=$divNote.children('.dock-note-ct');var $noteResizer=$divNote.children('.dock-note-resizer');var $layoutCtn,$layoutCtnWrap;var $layoutContainer;if($ctn.length===0){$ctn=$('<div class="dock-window-ctn">');this.$parentContainer.append($ctn[0]);}
if(['top','bottom'].indexOf(direction)>-1){$layoutContainer=$ctn;$divNoteCt.height(note.height);}
if(['left','right'].indexOf(direction)>-1){$layoutCtnWrap=$ctn.children('.dock-layout-wrap');if($layoutCtnWrap.length===0){$layoutCtnWrap=$('<div class="dock-layout-wrap">');$ctn.append($layoutCtnWrap);}
$layoutContainer=$layoutCtnWrap;$divNoteCt.width(note.width);}
$layoutCtn=$layoutContainer.children('.dock-layout-'+direction);if($layoutCtn.length===0){$layoutCtn=$('<div class="dock-layout dock-layout-'+direction+'" data-direction="'+direction+'">');$layoutContainer.append($layoutCtn);}
$divNoteCt.html(note.text);$layoutCtn.append($divNote);$divNote.children('.cancel').off().click(function(){var $this=$(this);var $curNote=$this.closest('.dock-note');var $curNoteCt=$curNote.children('.dock-note-ct');var id=$curNoteCt[0].dataset.id;var index=_this.getNoteListIndex(id);var note=_this.screen.curModal.noteList[index];var arr=_this.screen.curModal.layout[direction];for(var i=0,len=arr.length;i<len;i++){if(arr[i]===id){arr.splice(i,1);break;}}
_this.createNote({id:id,text:$curNoteCt.html(),x:note.x,y:note.y,width:note.width,height:note.height,bgColor:note.bgColor});$curNote.remove();_this.layoutDockNotes('top');_this.saveDockLayout();});$divNote.children('.editor').off().click(function(e){$(document).click();var realHeight=getComputedStyle($divNoteCt[0]).height;var height=realHeight<'100px'?'100px':realHeight;var width=getComputedStyle($divNoteCt[0]).width;var $saveDockNote=$('#saveDockNote');$divNoteCt.hide();$('.divNote').hide();$('.svgBox').hide();$divNote.append('<div style="width: '+width+';height: '+height+';"><script id="ueditor" type="text/plain" style="height:calc(100% - 20px);"></script></div>');UE.delEditor('ueditor');UE.getEditor('ueditor',{lang:I18n.type=='zh'?'zh-cn':'en'}).ready(function(){UE.insertPic(this);$saveDockNote.show();var iframe=document.querySelector('iframe');var iframeHtml=iframe.contentWindow.document.querySelector('html');var bodyEditor=iframe.contentWindow.document.querySelector('body');$(iframe).addClass('gray-scrollbar');$(iframeHtml).css({overflowX:'hidden'});note&&note.bgColor&&(bodyEditor.style.backgroundColor=note.bgColor);$('.edui-editor-iframeholder').css({height:parseInt(height.split('px')[0])-$('.edui-editor-toolbarbox').height()});bodyEditor.innerHTML=note?note.text:'';$saveDockNote.off('click').on('click',function(){Spinner.spin($('.dock-layout')[0]);$divNoteCt[0].innerHTML=bodyEditor.innerHTML;var newNote={id:$divNoteCt.attr('data-id'),text:$divNoteCt[0].innerHTML,bgColor:bodyEditor.style.backgroundColor};_this.saveNote(newNote);note.text=$divNoteCt[0].innerHTML;note.bgColor=bodyEditor.style.backgroundColor;$(this).hide();var timer=setTimeout(function(){UE.delEditor('ueditor');$('#ueditor').parent().remove();$divNoteCt.show();$('.divNote').show();$('.svgBox').show();clearTimeout(timer);Spinner.stop();},500);});});});$noteResizer.off('mousedown').mousedown(function(e){$(document).click();var $resizer=$(this);var $note=$resizer.closest('.dock-note');var $noteCt=$note.children('.dock-note-ct');var $wrap=_this.$parentContainer.find('.dock-layout-wrap');var $container=$(_this.container);var direction=$resizer[0].dataset.direction;var downX,downY;var downWidth=$noteCt.width();var downHeight=$noteCt.height();var ctnPos={left:parseFloat($container.css('left'))||0,right:parseFloat($container.css('right'))||0,top:parseFloat($container.css('top'))||0,bottom:parseFloat($container.css('bottom'))||0};downX=e.pageX;downY=e.pageY;$(document).mousemove(function(e){var moveX=e.pageX;var moveY=e.pageY;var delta;if(direction==='left'){delta=moveX-downX;$noteCt.width(downWidth+delta);}else if(direction==='right'){delta=downX-moveX;$noteCt.width(downWidth+delta);}else if(direction==='top'){delta=moveY-downY;$noteCt.height(downHeight+delta);$wrap.css('top',ctnPos.top+delta);}else if(direction==='bottom'){delta=downY-moveY;$noteCt.height(downHeight+delta);$wrap.css('bottom',ctnPos.bottom+delta);}});$(document).mouseup(function(e){var $this=$(this);var id=$noteCt[0].dataset.id;var params={id:id};var moveX=e.pageX;var moveY=e.pageY;var delta;if(direction==='left'){delta=moveX-downX;$noteCt.width(downWidth+delta);$container.css('left',ctnPos.left+delta);}else if(direction==='right'){delta=downX-moveX;$noteCt.width(downWidth+delta);$container.css('right',ctnPos.right+delta);}else if(direction==='top'){delta=moveY-downY;$noteCt.height(downHeight+delta);$wrap.css('top',ctnPos.top+delta);$container.css('top',ctnPos.top+delta);}else if(direction==='bottom'){delta=downY-moveY;$noteCt.height(downHeight+delta);$wrap.css('bottom',ctnPos.bottom+delta);$container.css('bottom',ctnPos.bottom+delta);}
if(direction==='left'||direction==='right'){params['width']=$note.width();}else{params['height']=$note.height();}
_this.saveNote(params);_this.screen.onresize();$this.off('mousemove');$this.off('mouseup');});e.stopPropagation();});},layoutDockNotes:function layoutDockNotes(){var _this=this;var $ctn=this.$parentContainer.children('.dock-window-ctn');var $layoutCtnWrap=$ctn.children('.dock-layout-wrap');var $container=$(this.container);$ctn.find('.dock-layout').each(function(i,dom){var $this=$(this);var direction=$this[0].dataset.direction;var $notes=$this.children('.dock-note');var sum=0;if($notes.length===0){$this.remove();}
if(['left','right'].indexOf(direction)>-1){$notes.each(function(i,dom){var $this=$(this);var width=$this.outerWidth();sum+=width;});}
if(['top','bottom'].indexOf(direction)>-1){$notes.each(function(i,dom){var $this=$(this);var height=$this.outerHeight();sum+=height;});$layoutCtnWrap.css(direction,sum);}
$container.css(direction,sum);});_this.screen.onresize();},saveDockLayout:function saveDockLayout(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);},resizeObject:function resizeObject(){this.el=null;this.dir="";this.grabx=null;this.graby=null;this.width=null;this.height=null;this.left=null;this.top=null;},getDirection:function getDirection(el){var xPos,yPos,offset,dir;dir="";xPos=window.event.offsetX;yPos=window.event.offsetY;offset=8;if(yPos<offset)dir+="n";else if(yPos>el.offsetHeight-offset)dir+="s";if(xPos<offset)dir+="w";else if(xPos>el.offsetWidth-offset)dir+="e";return dir;},doDown:function doDown(){if(this.style.cursor.indexOf('-resize')>-1){$('.divTextEditor').blur();var el=_this.getReal(event.srcElement,"className","divNote");if(el==null){_this.theobject=null;return;}
if(el.className&&el.className.indexOf('divNote')<0)return;_this.dir=_this.getDirection(el);if(_this.dir=="")return;_this.leftObject=new _this.resizeObject();_this.leftObject.el=el;_this.leftObject.dir=_this.dir;_this.leftObject.grabx=window.event.clientX;_this.leftObject.graby=window.event.clientY;_this.leftObject.width=el.offsetWidth;_this.leftObject.height=el.offsetHeight;_this.leftObject.left=el.offsetLeft;_this.leftObject.top=el.offsetTop;window.event.returnValue=false;window.event.cancelBubble=true;}},doUp:function doUp(e){if(e.target.classList.contains('pinIcon'))return;if(_this.leftObject!=null){var note={id:_this.leftObject.el.id,width:_this.leftObject.el.style.width,height:_this.leftObject.el.style.height};_this.saveNote(note);_this.leftObject=null;}},doMove:function doMove(e){var el,str,xMin,yMin;xMin=_this.noteDefaultWidth/4;yMin=_this.noteDefaultHeight/5;el=event.srcElement;if(!el)return;if(el.className&&typeof el.className=='string'&&el.className.indexOf("divNote")>-1){str=_this.getDirection(el);if(str=="")str="default";else str+="-resize";el.style.cursor=str;}
if(_this.leftObject!=null){if(_this.dir.indexOf("e")!=-1)_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width+window.event.clientX-_this.leftObject.grabx)+"px";if(_this.dir.indexOf("s")!=-1)_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height+window.event.clientY-_this.leftObject.graby)+"px";if(_this.dir.indexOf("w")!=-1){_this.leftObject.el.style.left=Math.min(_this.leftObject.left+window.event.clientX-_this.leftObject.grabx,_this.leftObject.left+_this.leftObject.width-xMin)+"px";_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width-window.event.clientX+_this.leftObject.grabx)+"px";}
if(_this.dir.indexOf("n")!=-1){_this.leftObject.el.style.top=Math.min(_this.leftObject.top+window.event.clientY-_this.leftObject.graby,_this.leftObject.top+_this.leftObject.height-yMin)+"px";_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height-window.event.clientY+_this.leftObject.graby)+"px";}
window.event.returnValue=false;window.event.cancelBubble=true;}},doClick:function doClick(e){if(!_this.screen||!_this.screen.curModal)return;if(_this.curtNote){if(e.target.classList.contains('pinIcon'))return;if(e.target==_this.curtNote||$(e.target).closest('.divNote')[0]==_this.curtNote){_this.curtNote.style.zIndex=_this.getNoteMaxZIndex()+1;}else{var $thisEditor=$(_this.curtNote).find('.divTextEditor');$(_this.curtNote).find('.btn-toolbar').slideUp('1000',function(){$thisEditor.hide();$(_this.curtNote).find('.divText').html($thisEditor.html()).show();_this.curtNote.style.minWidth='';_this.curtNote.style.minHeight='';});$thisEditor.removeClass('editing');var id=$(_this.curtNote).attr('id');var index=_this.getNoteListIndex(id);var note={id:id,text:$(_this.curtNote).find('.divTextEditor').html(),width:$(_this.curtNote).css('width'),height:$(_this.curtNote).css('height')};_this.saveNote(note);}}},getReal:function getReal(el,type,value){var temp=el;while(temp!=null&&temp.tagName!="BODY"){if(eval("temp."+type)==value){el=temp;return el;}
temp=temp.parentElement;}
return el;},saveNote:function saveNote(note){var id=note.id;var isSave=false;if(_this.screen.curModal.noteList==undefined)return;var index=_this.getNoteListIndex(id);if(index==undefined){if(!note.text||$.trim(note.text.length)==0)return;var $divNote=$('#'+id);var note={id:id,x:(parseInt(getComputedStyle($divNote[0]).left.split('px')[0])/$divNote.parent().width()*100).toFixed(2)+'%',y:(parseInt(getComputedStyle($divNote[0]).top.split('px')[0])/$divNote.parent().height()*100).toFixed(2)+'%',width:note.width,height:note.height,text:note.text,bgColor:note.bgColor};_this.screen.curModal.noteList.push(note);doSave();}else{var note_old=_this.screen.curModal.noteList[index];if(note.x&&note.x!=note_old.x){isSave=true;}
if(!isSave&&note.y&&note.y!=note_old.y){isSave=true;}
if(!isSave&&note.width&&note.width!=note_old.width){isSave=true;}
if(!isSave&&note.height&&note.height!=note_old.height){isSave=true;}
if(!isSave&&note.text&&note.text!=note_old.text){isSave=true;}
if(isSave){_this.screen.curModal.noteList[index]={id:id,x:note.x?note.x:note_old.x,y:note.y?note.y:note_old.y,width:note.width?note.width:note_old.width,height:note.height?note.height:note_old.height,text:note.text?note.text:note_old.text,bgColor:note.bgColor?note.bgColor:note_old.bgColor};doSave();}}
function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},initPointAlias:function initPointAlias(arrPointsAlias){var lastRepeatIndex=-1;var tempAlias;var repeatNum=0;var tempIndex;for(var i=0;i<arrPointsAlias.length;++i){lastRepeatIndex=arrPointsAlias.lastIndexOf(arrPointsAlias[i]);if(lastRepeatIndex>i){repeatNum=1;tempAlias=arrPointsAlias[i];arrPointsAlias[i]=tempAlias+'_No1';tempIndex=i;for(var j=tempIndex+1;j<lastRepeatIndex+1;++j){repeatNum+=1;tempIndex=arrPointsAlias.indexOf(tempAlias);if(tempIndex==-1)break;arrPointsAlias[tempIndex]=tempAlias+'_No'+repeatNum;}}}
return arrPointsAlias;}};return AnlzBase;}();var AnlzChart=function(){function AnlzChart(containerId,entityParams){}
AnlzChart.prototype.renderModal=function(){this.container.innerHTML=template;},AnlzChart.prototype.updateModal=function(name,value){},AnlzChart.prototype.showConfigMode=function(){};return AnlzChart;}();var AnlzPieRealtime=function(){var _this;function AnlzPieRealtime(container,option,screen){AnlzBase.call(this,container,option,screen);_this=this;this.paneChart=undefined;this.chart=undefined;this.dictLegend={};this.postData={};this.interv=undefined;this.options.dataList={};}
AnlzPieRealtime.prototype=new AnlzBase();AnlzPieRealtime.prototype.optionTemplate={imgName:'anlsPieRealtime.png',imgIndex:5,imgColor:'211,97,78',templateName:'analysis.modalType.PIE_REAL_TIME',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['realTime']};AnlzPieRealtime.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.dictLegend=null;clearInterval(_this.interv);this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzPieRealtime.prototype.init=function(){_this.postData={dsItemIds:_this.options.itemDS[0].arrId};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',_this.postData).done(function(result){if(result&&result.dsItemList){var rslt=result.dsItemList;if(rslt.error&&rslt.error.length>0){alert(rslt.error);_this.spinnerStop();return;}
_this.renderModal(rslt);}}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});_this.interv=setInterval(function(){_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',_this.postData).done(function(result){var data=result.dsItemList;if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
if(data&&data!=''){var arrData=[];var arrId=[];var arrItem=[];for(var i=0;i<data.length;i++){arrId.push(data[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,item;i<data.length;i++){item=data[i];for(var m=0;m<arrItem.length;m++){if(item.dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;arrData.push({value:parseFloat(item.data),name:itemName});break;}}}
var series=[{type:'pie',radius:'55%',center:['50%','60%'],data:arrData}];_this.chart&&_this.chart.getOption().series.push(series);}
_this.spinnerStop();}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});},60000);};AnlzPieRealtime.prototype.render=function(data){var arrLabel=[],arrData=[];var arrId=[];var arrItem=[];for(var i=0;i<data.length;i++){arrId.push(data[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,item;i<data.length;i++){item=data[i];for(var m=0;m<arrItem.length;m++){if(item.dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;arrLabel.push(itemName);arrData.push({value:parseFloat(item.data),name:itemName});this.options.dataList[itemName]=this.options.dataList[itemName]?this.options.dataList[itemName]:[];this.options.dataList[itemName].push(parseFloat(item.data));break;}}}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:'',x:'center'},tooltip:{trigger:'item',formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:'vertical',x:'left',data:arrLabel},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc'}}},calculable:true,series:[{type:'pie',center:['50%','60%'],data:arrData}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzPieRealtime;}();var AnlzHistoryCompare=function(){var _this;function AnlzHistoryCompare(container,option,screen){AnlzBase.call(this,container,option,screen);_this=this;this.curIndex=1;if(this.options){this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}}
AnlzHistoryCompare.prototype=new AnlzBase();AnlzHistoryCompare.prototype.optionTemplate={imgName:'anlsHistory.png',imgIndex:3,imgColor:'65,131,189',templateName:'analysis.modalType.HISTORY_COMPARE',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easyCompareAnalyz','compareSensor','compareMeter']};AnlzHistoryCompare.prototype.show=function(){this.container.innerHTML='';this.initTools();this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});var temp;this.paneChart=document.createElement('div');temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='100% ';this.container.appendChild(this.paneChart);temp=null;_this.spinnerRender.spin(this.container.parentElement);this.init();};AnlzHistoryCompare.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.dictLegend=null;this.curIndex=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzHistoryCompare.prototype.init=function(){AppConfig.datasource.getDSItemDataMulti(this,this.options.itemDS[0].arrId);};AnlzHistoryCompare.prototype.render=function(data){this.chart?this.refreshChart(data):this.initChart(data);};AnlzHistoryCompare.prototype.initChart=function(data){this.createSeries(data);var i18nEcharts=I18n.resource.echarts;var option={title:{text:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{x:'right',data:this.arrLegendData},toolbox:{show:false,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,grid:{x:60,x2:20,y:60,borderColor:'#eee'},xAxis:[{type:'category',data:this.options.arrComparePeriodLabel}],yAxis:[{type:'value'}],series:this.arrSeries};this.options.xAxisData=this.options.arrComparePeriodLabel;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);var _this=this;};AnlzHistoryCompare.prototype.refreshChart=function(data){var arrData=[],item=data.list[0];if(this.dictLegend[item.dsItemId])return;var tempOption=this.chart.getOption();var arrTemp=tempOption.series;arrTemp.push(this.createSeries(item.data));this.chart.setOption(tempOption);arrTemp=null;this.options.itemDS[0].arrId.push(item.dsItemId);var _this=this;this.screen.saveModal();};AnlzHistoryCompare.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],calcResult=[],arrId=[];var mode=this.options.mode;if(mode=='easyCompareAnalyz'||mode=='compareSensor'){for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];var dsItemIdName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;calcResult[i][j]=0;if(i==0){arrId.push(point.dsItemId);arrLegendData.push(dsItemIdName);}
for(var k=0;k<point.data.length;k++){calcResult[i][j]+=parseFloat(point.data[k]);}
calcResult[i][j]=calcResult[i][j]/point.data.length;this.options.dataList[dsItemIdName]=this.options.dataList[dsItemIdName]?this.options.dataList[dsItemIdName]:[];this.options.dataList[dsItemIdName].push(calcResult[i][j]);}}}else if(mode=='compareMeter'){for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];if(i==0){arrLegendData.push(AppConfig.datasource.getDSItemById(point.dsItemId).alias);}
calcResult[i][j]=point.data[point.data.length-1]-point.data[0];this.options.dataList[dsItemIdName]=this.options.dataList[dsItemIdName]?this.options.dataList[dsItemIdName]:[];this.options.dataList[dsItemIdName].push(calcResult[i][j]);}}}
arrLegendData=_this.initPointAlias(arrLegendData);var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(data[0].list[0].dsItemId);for(var i=0;i<data[0].list.length;i++){var seriesData=[];for(var j=0;j<data.length;j++){seriesData.push(calcResult[j][i]);}
var color=echarts.config.color[this.curIndex++];var series={name:arrLegendData[i],type:'bar',data:seriesData,itemStyle:{normal:{lineStyle:{color:color},barBorderRadius:[5,5,5,5]}}};arrSeries.push(series);}
this.arrSeries=arrSeries;this.arrLegendData=arrLegendData;};return AnlzHistoryCompare;}();var AnlzHistoryCompare_Line=function(){var _this;function AnlzHistoryCompare_Line(container,option,screen){_this=this;AnlzHistoryCompare.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzHistoryCompare_Line.prototype=new AnlzHistoryCompare();AnlzHistoryCompare_Line.prototype.optionTemplate={imgName:'anlsHistory.png',imgIndex:3,imgColor:'65,131,189',templateName:'analysis.modalType.HISTORY_COMPARE_LINE',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easyCompareAnalyz','compareSensor','compareMeter']};AnlzHistoryCompare_Line.prototype.initChart=function(data){this.createSeries(data);var xAxis=[];for(var i=0;i<data[0].timeShaft.length;++i){xAxis.push('Day'+new Date(data[0].timeShaft[i]).getDate()+' '+new Date(data[0].timeShaft[i]).format("HH:mm:ss"));}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'},formatter:function formatter(params){var strToolTip='',date;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(_this.options.itemDS[0].arrId);for(var i=0;i<params.length;i++){if(i%2==0){for(var m=0;m<arrItem.length;m++){if(_this.options.itemDS[0].arrId[i/2]==arrItem[m].id){strToolTip+=arrItem[m].alias+'<br/>';strToolTip+=data[0].timeShaft[params[i].dataIndex]+'<br/>Value: '+params[i].value+'<br/>';break;}}}else{strToolTip+=data[1].timeShaft[params[i].dataIndex]+'<br/>Value: '+params[i].value+'<br/>';}}
return strToolTip;}},legend:{x:'right',data:this.arrLegendData},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:false,grid:{x:60,x2:20,y:60,borderColor:'#eee'},dataZoom:{show:false},xAxis:[{type:'category',data:xAxis,splitLine:{show:false}}],yAxis:[{type:'value',scale:true}],series:this.arrSeries};this.options.xAxisData=xAxis;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);var _this=this;};AnlzHistoryCompare_Line.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],pointData=[],arrId=[];var mode=this.options.mode;if(mode=='easyCompareAnalyz'||mode=='compareSensor'){for(var i=0;i<data.length;i++){var item=data[i];pointData[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];var pointName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;pointData[i][j]=[];if(i==0){arrId.push(point.dsItemId);arrLegendData.push(this.options.arrComparePeriodLabel[0]+':'+pointName);arrLegendData.push(this.options.arrComparePeriodLabel[1]+':'+pointName);}
for(var k=0;k<point.data.length;k++){pointData[i][j].push(parseFloat(point.data[k]));}
this.options.dataList[pointName]=this.options.dataList[pointName]?this.options.dataList[pointName]:[];this.options.dataList[pointName].push(pointData[i][j]);}}}else if(mode=='compareMeter'){for(var i=0;i<data.length;i++){pointData[i]=[];var item=data[i];for(var j=0;j<item.list.length;j++){pointData[i][j]=[];var point=item.list[j];var pointName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;if(i==0){arrLegendData.push(this.options.arrComparePeriodLabel[0]+':'+pointName);arrLegendData.push(this.options.arrComparePeriodLabel[1]+':'+pointName);}
for(var k=0;k<point.data.length;k++){pointData[i][j].push(parseFloat(point.data[k]));}
this.options.dataList[pointName]=this.options.dataList[pointName]?this.options.dataList[pointName]:[];this.options.dataList[pointName].push(pointData[i][j]+'\n');}}}
if(arrLegendData[0]==arrLegendData[1]){arrLegendData[0]+='_No1';arrLegendData[1]+='_No2';}
var index=0;for(var i=0;i<data[0].list.length;i++){var seriesData=[];for(var j=0;j<data.length;j++){seriesData=pointData[j][i];var color=echarts.config.color[this.curIndex++];var series={name:arrLegendData[index],type:'line',data:seriesData,itemStyle:{normal:{barBorderRadius:[5,5,5,5]}}};arrSeries.push(series);index=index+1;}}
this.arrSeries=arrSeries;this.arrLegendData=arrLegendData;};return AnlzHistoryCompare_Line;}();var AnlzScatter=function(){function AnlzScatter(container,option,screen){AnlzBase.call(this,container,option,screen);this.animation=true;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzScatter.prototype=new AnlzBase();AnlzScatter.prototype.optionTemplate={imgName:'anlsScatter.png',imgIndex:2,imgColor:'211,97,78',templateName:'analysis.modalType.SCATTER',templateParams:{paraName:['X','Y'],paraAnlysMode:'all',dataTypeMaxNum:[1,5]},chartConfig:['easy','fixed','recent']};AnlzScatter.prototype.init=function(){var _this=this;var arrIds=[];arrIds.push(this.options.itemDS[0].arrId[0]);arrIds=arrIds.concat(this.options.itemDS[1].arrId);var postData={dsItemIds:arrIds,timeStart:new Date(this.options.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(this.options.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.options.format};WebAPI.post('/analysis/startWorkspaceDataGenScatterChart',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});};AnlzScatter.prototype.render=function(data){var arrXAxis=data.list[0].data,arrData=[],arrLegend=[],arrSeries=[];var arrId=[];var arrItem=[];var dataListBack={};for(var i=1;i<data.list.length;i++){arrId.push(data.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<data.list.length;i++){if(i===0){this.options.xAxisData=data.list[i].data;}else{arrData.push([]);for(var m=0;m<arrItem.length;m++){if(data.list[i].dsItemId==arrItem[m].id){arrLegend.push(arrItem[m].alias);this.options.dataList[arrItem[m].alias]=data.list[i].data;break;}}}}
for(var dictItems in this.options.dataList){var dictYItem=this.options.dataList[dictItems];dataListBack[dictItems]=[];for(var n=0,len=dictYItem.length;n<len;n++){dataListBack[dictItems].push('('+this.options.xAxisData[n]+'、'+dictYItem[n]+')');}}
this.options.dataList=dataListBack;for(var i=0,valueX;i<arrXAxis.length;i++){valueX=data.list[0].data[i];for(var j=0,jLen=data.list.length-1;j<jLen;j++){arrData[j].push([valueX,data.list[j+1].data[i]]);}}
for(var i=0;i<arrData.length;i++){arrSeries.push({name:arrLegend[i],type:'scatter',data:arrData[i],markLine:{data:[{type:'average',name:I18n.resource.observer.analysis.AVERAGE}]}});}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:'X: '+AppConfig.datasource.getDSItemById(data.list[0].dsItemId).alias,subtext:'Scatter'},tooltip:{trigger:'axis',showDelay:0,axisPointer:{show:true,type:'cross',lineStyle:{type:'dashed',width:1}}},legend:{data:arrLegend},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc'}}},xAxis:[{type:'value',scale:true}],yAxis:[{type:'value',scale:true}],series:arrSeries,animation:this.animation,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzScatter;}();var AnlzSpectrum=function(){function AnlzSpectrum(container,option,screen){AnlzBase.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzSpectrum.prototype=new AnlzBase();AnlzSpectrum.prototype.optionTemplate={imgName:'anlsSpectrum.png',imgIndex:1,imgColor:'148,193,142',templateName:'analysis.modalType.SPECTRUM',templateParams:{paraName:['X'],paraAnlysMode:'all',dataTypeMaxNum:[1]},chartConfig:['easy','fixed','recent']};AnlzSpectrum.prototype.init=function(){var _this=this;var postData={dsItemIds:[this.options.itemDS[0].arrId[0]],timeStart:new Date(this.options.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(this.options.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.options.format};WebAPI.post('/analysis/startWorkspaceDataGenPattern',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});};AnlzSpectrum.prototype.render=function(data){var arrLabel=[],arrData=[];for(var i=0,item;i<data.list.length;i++){item=data.list[i];arrLabel.push(item.data);arrData.push(item.pattern);}
var i18nEcharts=I18n.resource.echarts;var name=AppConfig.datasource.getDSItemById(this.options.itemDS[0].arrId[0]).alias;var option={title:{text:name,subtext:'Spectrum'},tooltip:{trigger:'axis'},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc'}}},calculable:true,xAxis:[{type:'category',boundaryGap:true,data:arrLabel}],yAxis:[{type:'value'}],series:[{type:'bar',data:arrData,itemStyle:{normal:{color:'#5bc0de',barBorderRadius:[5,5,0,0]}},markLine:{data:[{type:'average',name:I18n.resource.observer.analysis.AVERAGE}]}}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.options.xAxisData=arrLabel;this.options.dataList[name]=arrData;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzSpectrum;}();var AnlzTendency=function(){var _this;function AnlzTendency(container,option,screen){AnlzBase.call(this,container,option,screen);this.paneLegend=undefined;this.dictLegend={};this.dictTooltip={};this.curIndex=0;this.legendType={NORMAL:0,Prediction:1,Regression:2};this.screen=screen;this.animation=true;this.timeType=!option?'h1':option.format;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};if(this.options.chartOption){this.modifyData=this.options.chartOption;if(!this.modifyData.chartName){this.modifyData.chartName='';}
if(!this.modifyData.xUnit){this.modifyData.xUnit='';}
if(!this.modifyData.yUnit){this.modifyData.yUnit='';}
if(!this.modifyData.yMark){this.modifyData.yMark='';}
if(!this.modifyData.yMax){this.modifyData.yMax='';}
if(this.modifyData.yMin||this.modifyData.yMin==0){this.modifyData.yMin=this.modifyData.yMin;}else{this.modifyData.yMin='';}}else{this.modifyData={};}
if(!this.options.dictShowData){this.options.dictShowData={};}
this.dictShowData=this.options.dictShowData;for(var key in this.dictShowData){for(var i=0,len=this.dictShowData[key].length;i<len;i++){this.dictShowData[key][i]=this.fillData(this.dictShowData[key][i]);}}
if(!this.options.dictShowFlag){this.options.dictShowFlag={};}
this.dictShowFlag=this.options.dictShowFlag;_this=this;}
AnlzTendency.prototype=new AnlzBase();AnlzTendency.prototype.optionTemplate={imgName:'anlsTendency.png',imgIndex:0,imgColor:'65,131,189',templateName:'analysis.modalType.TENDENCY',templateParams:{paraName:['X','X2'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent']};AnlzTendency.prototype.show=function(){this.container.innerHTML='';this.initTools();this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();$('#chartModify').hide();$('#btnDataFilter').hide();if(this.container.id==='anlsPane'&&!$(this.container).hasClass('panel-readonly')){$('#chartModify').show();$('#btnDataFilter').show();}
_this.modifyEcharts();$('#modifyChart .row').hide();if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});var temp,wrap;this.paneChart=document.createElement('div');this.paneChart.className='divPaneChart';temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='calc(100% - 170px)';this.paneLegend=document.createElement('div');this.paneLegend.className='divHover';temp=this.paneLegend.style;temp.marginTop='10px';temp.padding='10px';temp.cssFloat='left';temp.width='100%';temp.height='160px';temp.position='relative';this.container.appendChild(this.paneChart);this.container.appendChild(this.paneLegend);if(this.isShareMode===1)$(this.container).addClass('read-mode');temp=null;_this.spinnerRender.spin(this.container.parentElement);this.init();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;var containerChilBox='<div class="containerChi" style=""></div>';$(this.container).prepend(containerChilBox);$('.containerChi').css({width:'100%',height:'calc(100% - 210px)',position:'absolute',top:'20px',left:0});for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}
graph.show();}}};AnlzTendency.prototype.modifyEcharts=function(){var _this=this;var $modifyLayer=$('.modifyLayer');if($modifyLayer.length===0){$modifyLayer=$('<div class="modal fade modifyLayer" style="position:absolute;z-index:151;"><div class="modal-dialog" style="width:65%;"><div class="modal-content">'+'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">'+I18n.resource.modalConfig.editChart.TITLE+'</h4></div>'+'<div class="modal-body">'+'<div width="100%" style="margin-top:20px;"><div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.CHART_NAME+':</span><input type="text" id="changeEchName" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.X_AXIS_UNIT+':</span><input type="text" id="addXUnit" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_UNIT+':</span><input type="text" id="addYUnit" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_SCALE+':</span><input type="text" id="changeYMark" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_MAX+':</span><input type="text" id="changeYMax" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 40px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_MIN+':</span><input type="text" id="changeYMin" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div></div>'+'<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="modifyBtn">'+I18n.resource.modalConfig.editChart.BTN_CONFIRM+'</button></div>'+'</div></div></div>');$(_this.container).parents('#anlsPaneContain').append($modifyLayer);}
$('#chartModify').off('click').click(function(){_this.modifyEcharts();if($modifyLayer.is(':hidden')){$modifyLayer.modal('show');$('#changeEchName')[0].value=_this.modifyData.chartName?_this.modifyData.chartName:'';$('#addXUnit')[0].value=_this.modifyData.xUnit?_this.modifyData.xUnit:'';$('#addYUnit')[0].value=_this.modifyData.yUnit?_this.modifyData.yUnit:'';$('#changeYMark')[0].value=_this.modifyData.yMark?_this.modifyData.yMark:'';$('#changeYMax')[0].value=_this.modifyData.yMax?_this.modifyData.yMax:'';$('#changeYMin')[0].value=_this.modifyData.yMin===0||_this.modifyData.yMin?_this.modifyData.yMin:'';}else{$modifyLayer.modal('hide');}});$('#modifyBtn').off('click').click(function(){if($('#addYUnit').val()==null||$('#addYUnit').val()==0||$('#addYUnit').val()==undefined){_this.modifyData.yUnit='';}else{_this.modifyData.yUnit=$('#addYUnit').val();}
if($('#addXUnit').val()==null||$('#addXUnit').val()==0||$('#addXUnit').val()==undefined){_this.modifyData.xUnit='';}else{_this.modifyData.xUnit=$('#addXUnit').val();}
if($('#changeEchName').val()==null||$('#changeEchName').val()==0||$('#changeEchName').val()==undefined){_this.modifyData.chartName='';}else{_this.modifyData.chartName=$('#changeEchName').val();}
if($('#changeYMark').val()==null||$('#changeYMark').val()==0||$('#changeYMark').val()==undefined){_this.modifyData.yMark=null;}else{if(isNaN($('#changeYMark').val())){_this.modifyData.yMark=null;}else{_this.modifyData.yMark=parseInt($('#changeYMark').val());}}
if($('#changeYMax').val()==null||$('#changeYMax').val()==0||$('#changeYMax').val()==undefined){_this.modifyData.yMax=null;}else{if(isNaN($('#changeYMax').val())){_this.modifyData.yMax=null;}else{_this.modifyData.yMax=parseInt($('#changeYMax').val());}}
if($('#changeYMin').val()==null||$('#changeYMin').val()==undefined){_this.modifyData.yMin=null;}else{if(isNaN($('#changeYMin').val())){_this.modifyData.yMin=null;}else{_this.modifyData.yMin=parseInt($('#changeYMin').val());}}
if(parseInt(_this.yMin)>=parseInt(_this.yMax)){_this.modifyData.yMin=0;_this.modifyData.yMax=100;}
_this.saveChartModify();$('.divPage.selected').trigger('click');});},AnlzTendency.prototype.saveChartModify=function(){_this.options.chartOption={chartName:_this.modifyData.chartName?_this.modifyData.chartName:null,xUnit:_this.modifyData.xUnit?_this.modifyData.xUnit:null,yUnit:_this.modifyData.yUnit?_this.modifyData.yUnit:null,yMark:_this.modifyData.yMark?parseInt(_this.modifyData.yMark):null,yMax:_this.modifyData.yMax?parseInt(_this.modifyData.yMax):null,yMin:_this.modifyData.yMin||_this.modifyData.yMin===0?parseInt(_this.modifyData.yMin):null};doSave();function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,false]);}},AnlzTendency.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.dropMaskLayer=null;this.paneLegend=null;this.paneChart=null;this.chart=null;this.dictLegend=null;this.curIndex=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();$('#chartModify').hide();$('#btnDataFilter').hide();$('#modifyChart .row').hide();this.chartName=null;this.xUnit=null;this.yUnit=null;this.yMark=null;this.yMax=null;this.yMin=null;this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzTendency.prototype.init=function(){var _this=this;var itemDSLength=this.options.itemDS?this.options.itemDS.length:0;var arrIdList=[];if(itemDSLength){for(var j=0;j<itemDSLength;j++){var arrDsId=this.options.itemDS[j].arrId;if(arrDsId){for(var i=0,len=arrDsId.length;i<len;i++){var bFind=false;for(var key in this.dictShowFlag){if(key==arrDsId[i]){bFind=true;break;}}
if(!bFind){this.dictShowFlag[arrDsId[i]]=true;}}}}}
arrIdList=arrIdList.concat(this.options.itemDS[0].arrId);arrIdList=this.options.itemDS[1]?arrIdList.concat(this.options.itemDS[1].arrId):arrIdList;AppConfig.datasource.getDSItemData(this,arrIdList);this.paneLegend.ondragenter=function(e){var $ele=$(_this.paneLegend);if($ele.hasClass('dis'))return;$ele.addClass('dragHover');e.stopPropagation();e.preventDefault();};this.paneLegend.ondragleave=function(e){$(_this.paneLegend).removeClass('dragHover');e.stopPropagation();e.preventDefault();};this.paneLegend.ondragover=function(e){e.preventDefault();};this.paneLegend.ondrop=function(e){_this.spinnerRender.spin(_this.container.parentElement);var dsItemId=EventAdapter.getData().dsItemId;var $ele=$(_this.paneLegend);$ele.removeClass('dragHover dis');if(dsItemId){if(Object.prototype.toString.call(dsItemId)==='[object Array]'){var len=dsItemId.length;for(var i=0,len=dsItemId.length;i<len;i++){if($ele.find('[id="lg_'+dsItemId[i]+'"]').length>0){dsItemId.splice(i,1);len=len-1;i=i-1;}}
if(dsItemId.length<1){_this.spinnerStop();}else{AppConfig.datasource.getDSItemData(_this,dsItemId);}}else{if($ele.find('[id="lg_'+dsItemId+'"]').length>0){_this.spinnerStop();return;}
AppConfig.datasource.getDSItemData(_this,[dsItemId]);}}else _this.spinnerStop();};};AnlzTendency.prototype.render=function(data){if(data){this.chart?this.refreshChart(data):this.initChart(data);}
this.spinnerRender.stop();};AnlzTendency.prototype.initChart=function(data){var arrSeries=[],legend=[];var series,item,i,option;for(i=0;i<data.list.length;i++){item=data.list[i];series=this.createSeries(item.dsItemId,item.data);arrSeries.push(series);}
this.showFilterCharts(arrSeries);for(i=0;i<arrSeries.length;i++){legend.push(arrSeries[i].name);}
this.resetShowData(data,0);for(var key in this.dictShowFlag){for(var j=0,lenJ=arrSeries.length;j<lenJ;j++){if(key==arrSeries[j].id){if(!this.dictShowFlag[key]){arrSeries[j].data=[];}
break;}}}
var itemDsList=this.options.itemDS;if(itemDsList[0].arrId&&itemDsList.length>1){if(itemDsList[0].arrId.length>0&&itemDsList[1].arrId.length>0){for(var n=0,len=itemDsList.length;n<len;n++){var item=itemDsList[n];if(item){if(item.type==='X2'){var itemOneArrId=item.arrId;for(var p=0,lenP=itemOneArrId.length;p<lenP;p++){for(var m=0,lenJ=arrSeries.length;m<lenJ;m++){if(itemOneArrId[p]===arrSeries[m].id){arrSeries[m].yAxisIndex=1;}}}}else if(item.type==='X'){continue;}}}}}
option=this.initOption(arrSeries,data.timeShaft);if(this.isShareMode===1)option.legend={data:legend};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};AnlzTendency.prototype.initOption=function(series,timeSHaft){var i18nEcharts=I18n.resource.echarts;var option={tooltip:{trigger:'axis'},grid:{x:60,x2:60,y:60,y2:70,borderColor:'#eee'},toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc'}}},calculable:true,dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,data:timeSHaft,axisLabel:{formatter:'{value} '}}],yAxis:[{type:'value',scale:true,axisLabel:{formatter:function formatter(value){var ret;if(value<1000){ret=value;}else if(value<1000000){ret=value/1000+'k';}else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0.8}}}],series:series,animation:this.animation,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};if(this.modifyData&&this.modifyData.chartName){option.title={text:this.modifyData.chartName};}
if(this.modifyData&&this.modifyData.xUnit){option.xAxis[0].name=this.modifyData.xUnit;option.xAxis[0].nameLocation='start';}
if(this.modifyData&&this.modifyData.yUnit){option.yAxis[0].name=this.modifyData.yUnit;}
if(this.modifyData&&this.modifyData.yMax){option.yAxis[0].max=this.modifyData.yMax;}
if(this.modifyData&&this.modifyData.yMin!==null&&this.modifyData.yMin!==''){option.yAxis[0].min=this.modifyData.yMin;}
if(this.modifyData&&this.modifyData.yMark){option.yAxis[0].splitNumber=(this.modifyData.yMax-this.modifyData.yMin)/this.modifyData.yMark;}
this.options.xAxisData=option.xAxis[0].data;var itemDsList=this.options.itemDS;if(itemDsList.length>1){if(itemDsList[0].arrId.length>0&&itemDsList[1].arrId.length>0){var yAxisTwo={type:'value',scale:true,axisLabel:{formatter:function formatter(value){var ret;if(value<1000){ret=value;}else if(value<1000000){ret=value/1000+'k';}else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0}}};option.yAxis.push(yAxisTwo);}else{var isRight=0;for(var i=0;i<itemDsList.length;i++){var item=itemDsList[i];if(item.type==='X2'&&item.arrId.length>0){isRight+=1;}else if(item.type==='X'&&item.arrId.length<=0){isRight+=1;}}
if(isRight===2){option.yAxis[0].position='right';}}}
return option;};AnlzTendency.prototype.refreshChart=function(data){for(var i=0,len=data.list.length;i<len;i++){var item=data.list[i];if(this.dictLegend[item.dsItemId])return;this.resetShowData(data,0);this.dictShowFlag[item.dsItemId]=true;var tempOption=this.chart.getOption();if(tempOption.xAxis[0].data.length===0&&data.timeShaft.length>0){tempOption.xAxis[0].data=data.timeShaft;this.timeShift=data.timeShaft;}
var arrTemp=tempOption.series;arrTemp.push(this.createSeries(item.dsItemId,item.data));this.chart.setOption(tempOption);arrTemp=null;this.options.itemDS[0].arrId.push(item.dsItemId);var _this=this;this.screen.saveModal();}};AnlzTendency.prototype.createSeries=function(id,data,type){if(!type)type=this.legendType.NORMAL;var name,len;if(type==this.legendType.NORMAL){name=AppConfig.datasource.getDSItemById(id).alias;}else{name=id.split('_');name=AppConfig.datasource.getDSItemById(name[0]).alias+'_'+id[1];}
this.options.dataList[name]=data;len=echarts.config.color.length;var color=echarts.config.color[this.curIndex%len];this.curIndex++;var div=this.renderLegend(id,name,type,color);var tipInf=this.getStatisticsInfo(data);if(Boolean(tipInf)){this.initTendencyTips($(div),tipInf.max,tipInf.min,tipInf.avg,tipInf.sum);}
return{id:id,name:name,type:'line',symbol:'none',data:data,itemStyle:{normal:{color:color}}};};AnlzTendency.prototype.refreshChartFilter=function(data,condition,series){var item=data.list[0];if(this.dictLegend[item.dsItemId])return;var newFilterId=item.dsItemId+'_filter';var bFilterFind=false;for(var i=0,len=series.length;i<len;i++){if(newFilterId==series[i].id){bFilterFind=true;break;}}
if(bFilterFind){series[i].data=item.data;var $div=$('#lg_'+newFilterId);var tipTmp=$div.data('bs.tooltip');if(!tipTmp){return;}
var tip=tipTmp.$tip;if(tip){var tipInf=this.getStatisticsInfo(item.data);tip.find('.filterMax').text(I18n.resource.observer.widgets.MAXIMUM+': '+tipInf.max);tip.find('.filterMin').text(I18n.resource.observer.widgets.MINIMUM+': '+tipInf.min);tip.find('.filterAvg').text(I18n.resource.observer.widgets.AVERAGE+': '+tipInf.avg);tip.find('.filterSum').text(I18n.resource.observer.widgets.TOTAL_AMOUNT+': '+tipInf.sum);tip.find('.filterCondition').text(I18n.resource.observer.widgets.FILTER_FORMULA+': '+condition);}
var appendId=item.dsItemId+'_append';var arrAppend=[];for(var i=0,len=series.length;i<len;i++){if(appendId==series[i].id){arrAppend.push(i);}}
if(arrAppend.length>0){for(var j=0,len2=arrAppend.length;j<len2;j++){series.splice(arrAppend[j],1);}}}else{series.unshift(this.createSeriesFilter(item.dsItemId,item.data,newFilterId,condition));}
this.spinnerRender.stop();};AnlzTendency.prototype.createSeriesFilter=function(id,data,newId,condition){var name,len;name=AppConfig.datasource.getDSItemById(id).alias+'_filter';len=echarts.config.color.length;var color=echarts.config.color[this.curIndex%len];this.curIndex++;var div=this.renderLegend(newId,name,0,color);var tipInf=this.getStatisticsInfo(data);if(Boolean(tipInf)){this.initTendencyTipsFilter($(div),tipInf.max,tipInf.min,tipInf.avg,tipInf.sum,condition);}
return{id:newId,name:name,type:'line',symbol:'none',data:data,itemStyle:{normal:{lineStyle:{color:color}}}};};AnlzTendency.prototype.removeSeries=function(id){var _this=this;delete this.dictLegend[id];$('#lg_'+id).remove();var option=this.chart.getOption();var arrSeries=option.series;for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].id==id){arrSeries.splice(i,1);break;}}
var arrIds=this.options.itemDS[0].arrId;for(var i=0;i<arrIds.length;i++){if(arrIds[i]==id){arrIds.splice(i,1);}}
this.options.itemDS[0].arrId=arrIds;var nIdx=id.indexOf('_filter');if(-1!=nIdx){var origId=id.substr(0,nIdx);var arrFilter=this.options.arrFilter;if(arrFilter){for(var i=0,len=arrFilter.length;i<len;i++){if(origId==arrFilter[i].pointId){arrFilter.splice(i,1);break;}}}}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,option.xAxis[0].data));window.setTimeout(function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,true]);},500);};AnlzTendency.prototype.getDataById=function(id){var arrSeries=this.chart.getOption().series;for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].id==id){return arrSeries[i].data;}}};AnlzTendency.prototype.renderLegend=function(id,name,type,color){var _this=this;var name=name;var div=document.createElement("div");var closeBtn='<button type="button" class="close"><span>&times;</span></button>';var btnShow;if(this.dictShowFlag[id]){btnShow='<span class="glyphicon glyphicon-eye-open btnShow" aria-hidden="true"></span>';}else{btnShow='<span class="glyphicon glyphicon-eye-close btnShow" aria-hidden="true"></span>';}
div.id='lg_'+id;div.dataset.id=id;div.className="divLegend";div.draggable=true;div.style.backgroundColor=color;div.setAttribute('ty',type);switch(type){case this.legendType.Regression:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split('_Regression_')[0]+"_Regression</div>"+btnShow+closeBtn;this.initGeneralRegressorTooltip(id,div);};break;case this.legendType.Prediction:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split('_Prediction_')[0]+"_Prediction</div>"+btnShow+closeBtn;this.initGeneralPredictorTooltip(id,div);};break;default:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-stats' style='margin-right: 10px;'></span>"+name+'</div>'+btnShow+closeBtn;};break;}
div.getElementsByClassName('close')[0].onclick=function(e){var $ele=$(e.currentTarget).parent();var id=$ele[0].dataset.id;if($('.divLegend').length>1){var option=_this.chart.getOption();if(option){var arrSeries=option.series;if(arrSeries){var cnt=0;for(var key in _this.options.dataList){cnt++;}if(cnt<=1){alert('The only parameters can\'t be removed');return;}}}
var doct=$ele.eq(0).find('.divTxtWrap').text();delete _this.options.dataList[doct];$ele.tooltip('destroy');_this.removeSeries(id);var cnt=id.indexOf('_filter');if(-1!=cnt){var preId=id.substr(0,cnt);if(preId){_this.removeSeries(preId+'_append');}}}else{alert('The only parameters can\'t be removed');}
e.stopPropagation();};div.getElementsByClassName('btnShow')[0].onclick=function(e){var $ele=$(e.currentTarget).parent();var id=$ele[0].dataset.id;_this.switchSeries(id);e.stopPropagation();};div.ondragstart=function(e){$(_this.paneLegend).addClass('dis');e.dataTransfer.effectAllowed="move";e.dataTransfer.setData("id",e.currentTarget.dataset.id);e.dataTransfer.setData("source","legend");};div.ondragenter=function(e){e.preventDefault();e.stopPropagation();};div.ondragover=function(e){e.preventDefault();e.stopPropagation();};div.ondrop=function(e){var srcId=e.dataTransfer.getData('id');var toId=e.currentTarget.dataset.id;$(_this.paneLegend).removeClass('dis');e.stopPropagation();if(srcId===''||srcId===toId)return;var source=e.dataTransfer.getData("source");if(source&&source=="legend"){if(e.currentTarget.getAttribute('ty')==_this.legendType.Regression)generatePredictor(e,srcId,toId);else generateRegressor(e,srcId,toId);}
function generateRegressor(e,sourceId,targetId){var data={source:[_this.getDataById(sourceId).map(function(row,i){return row+'';})],target:_this.getDataById(targetId).map(function(row,i){return row+'';}),sourceNames:sourceId,targetName:targetId};_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/generalRegressor',data).done(function(data){var id=targetId+"_Regression_"+ +new Date();var tempOption=_this.chart.getOption();var arrTemp=tempOption.series;data.SourceId=sourceId;data.TargetId=targetId;_this.dictTooltip[id]=data;arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Regression));_this.chart.setOption(tempOption);arrTemp=null;_this.spinnerRender.stop();}).error(function(result){_this.spinnerRender.stop();});}
function generatePredictor(e,sourceId,targetId){var arrCoefficient=_this.dictTooltip[e.currentTarget.dataset.id].Coefficients;for(var i=0;i<arrCoefficient.length;i++){arrCoefficient[i]=arrCoefficient[i].toString();}var data={source:[_this.getDataById(sourceId).map(function(row,i){return row+'';})],Coefficients:arrCoefficient};_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/generalPredictor',data).done(function(data){var id=targetId.split('_')[0]+"_Prediction_"+ +new Date();var tempOption=_this.chart.getOption();var arrTemp=tempOption.series;if(data.PredicatedResults){arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Prediction));_this.chart.setOption(tempOption);}
_this.spinnerRender.stop();}).error(function(result){_this.spinnerRender.stop();});}};this.paneLegend.appendChild(div);return div;};AnlzTendency.prototype.initGeneralRegressorTooltip=function(id,element){var data=this.dictTooltip[id];var arrId=[];arrId.push(data.SourceId);arrId.push(data.TargetId);var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);var srcAlias,tarAlias;for(var m=0;m<arrItem.length;m++){if(data.SourceId==arrItem[m].id){srcAlias=arrItem[m].alias;}
if(data.TargetId==arrItem[m].id){tarAlias=arrItem[m].alias;}}
var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip" style="position: fixed;">');sb.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">RSquared: ').append(data.RSquared).append('</p> ');sb.append('        <p>Formula: </p><p style="margin-left: 20px; white-space:nowrap;">').append(data.Formula).append('</p> ');sb.append('        <p style="margin-left: 20px; white-space:nowrap;">x: ').append(srcAlias).append('</p>');sb.append('        <p style="margin-left: 20px; white-space:nowrap;">y: ').append(tarAlias).append('</p>');sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={placement:'top',title:'GeneralRegressor',template:sb.toString()};$(element).tooltip(options);};AnlzTendency.prototype.initGeneralPredictorTooltip=function(id,element){var data=this.dictTooltip[id];var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip" style="position: fixed;">');sb.append('    <div class="tooltipTitle tooltip-inner">GeneralPredictor</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">Source: ').append(AppConfig.datasource.getDSItemById(id.split('_')[0]).alias).append('</p> ');sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={placement:'top',title:'GeneralPredictor',template:sb.toString()};$(element).tooltip(options);};AnlzTendency.prototype.initTendencyTips=function(parent,max,min,avg,sum){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">Statistics</div>');show.append('    <div class="tooltipContent">');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MAXIMUM).append('</span>: ').append(max).append('</p>');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MINIMUM).append('</span>: ').append(min).append('</p> ');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.AVERAGE).append('</span>: ').append(avg).append('</p> ');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.TOTAL_AMOUNT).append('</span>: ').append(sum).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'top',title:I18n.resource.observer.widgets.PARAMETER,template:show.toString()};parent.tooltip(options);};AnlzTendency.prototype.initTendencyTipsFilter=function(parent,max,min,avg,sum,condition){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">Statistics</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="filterMax" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MAXIMUM).append('</span>: ').append(max).append('</p>');show.append('        <p class="filterMin" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MINIMUM).append('</span>: ').append(min).append('</p> ');show.append('        <p class="filterAvg" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.AVERAGE).append('</span>: ').append(avg).append('</p> ');show.append('        <p class="filterSum" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.TOTAL_AMOUNT).append('</span>: ').append(sum).append('</p> ');show.append('        <p class="filterCondition" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.FILTER_FORMULA).append('</span>: ').append(condition).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'top',title:I18n.resource.observer.widgets.PARAMETER,template:show.toString()};parent.tooltip(options);};AnlzTendency.prototype.getStatisticsInfo=function(data){if(!data||data.length<=0){return{'max':0,'min':0,'avg':0,'sum':0};}
var max=0;var min=0;for(var i=0,len=data.length;i<len;i++){if(data[i]){max=data[i];min=data[i];break;}}
var avg=0;var sum=0;var flag=2;var len=data.length;var lenAct=len;if('h1'==this.timeType||'d1'==this.timeType||'M1'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
sum+=data[i];}}else if('m5'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
if(0==i%12){sum+=data[i];}}}else if('m1'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
if(0==i%60){sum+=data[i];}}}else{return null;}
avg=sum/lenAct;return{'max':max,'min':min,'avg':avg.toFixed(flag),'sum':sum.toFixed(flag)};};AnlzTendency.prototype.showFilterCharts=function(series){if(!series){series=this.chart.getOption().series;}
if(this.options.arrFilter){for(var i=0,len=this.options.arrFilter.length;i<len;i++){var item=this.options.arrFilter[i];for(var j=0,len2=item.appendData.length;j<len2;j++){if(!item.appendData[j]){item.appendData[j]=undefined;}}
for(var k=0,len3=item.filterDrawObj.list[0].data.length;k<len3;k++){if(!item.filterDrawObj.list[0].data[k]){item.filterDrawObj.list[0].data[k]=undefined;}}
if(item.filterDrawObj){this.refreshChartFilter(item.filterDrawObj,item.filterCondition,series);}
if(0==item.showType){this.removeAppendCharts(item,series);}else{this.setAppendCharts(item,series);}}}};AnlzTendency.prototype.setAppendCharts=function(itemFilter,series){var colorShow;var id=itemFilter.pointId;var idLen=id.length;var bFind=false;for(var i=0,len=series.length;i<len;i++){var tempLen=series[i].id.length;var tempEx=tempLen>idLen?series[i].id.substr(idLen,tempLen-idLen):'';if(series[i].id.substr(0,idLen)==id&&'_filter'==tempEx){bFind=true;break;}}
if(bFind){var itemAppend={id:itemFilter.pointId+'_append',name:'',type:'line',symbol:'none',data:itemFilter.appendData,smooth:false,itemStyle:{normal:{lineStyle:{width:3,type:'dotted'}}}};series.push(itemAppend);}};AnlzTendency.prototype.removeAppendCharts=function(itemFilter,series){var id=itemFilter.pointId;var idLen=id.length;var bFind=false;for(var i=0,len=series.length;i<len;i++){var tempLen=series[i].id.length;var tempEx=tempLen>idLen?series[i].id.substr(idLen,tempLen-idLen):'';if(series[i].id.substr(0,idLen)==id&&'_append'==tempEx){bFind=true;series.splice(i,1);break;}}};AnlzTendency.prototype.switchSeries=function(id){var option=this.chart.getOption();if(!option){return;}
var arrSeries=option.series;if(!arrSeries){return;}
var cnt=0;var flag=false;for(var i=0;i<arrSeries.length;i++){if(-1!=arrSeries[i].id.indexOf('_append')){continue;}
if(arrSeries[i].data.length>0){cnt++;}
if(arrSeries[i].id==id&&arrSeries[i].data.length>0){flag=true;}}
if(cnt<=1&&flag){alert('The only parameters can\'t be removed');return;}
var spanPic=$('#lg_'+id).children('.btnShow');if(spanPic){var bIsExist=false;for(var key in this.dictShowFlag){if(id==key){bIsExist=true;break;}}
if(!bIsExist){return;}
var bIsShow=!this.dictShowFlag[id];this.dictShowFlag[id]=bIsShow;if(bIsShow){spanPic.attr('class','glyphicon glyphicon-eye-open btnShow');}else{spanPic.attr('class','glyphicon glyphicon-eye-close btnShow');}
for(var i=0,len=arrSeries.length;i<len;i++){if(arrSeries[i].id==id){if(bIsShow){arrSeries[i].data=this.dictShowData[id];}else{arrSeries[i].data=[];}
break;}}
var appendId='';var nIdx=id.indexOf('_filter');if(-1!=nIdx){appendId=id.substr(0,nIdx)+'_append';for(var i=0,len=arrSeries.length;i<len;i++){if(arrSeries[i].id==appendId){if(bIsShow){arrSeries[i].data=this.dictShowData[appendId];}else{arrSeries[i].data=[];}
break;}}}}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,option.xAxis[0].data));window.setTimeout(function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,true]);},500);};AnlzTendency.prototype.setTendencyOption=function(series){if(!series){series=this.chart.getOption().series;}
var opt=this.chart.getOption();opt.series=series;this.chart.clear();this.chart.setOption(opt);};AnlzTendency.prototype.resetIcon=function(arrCloseId){if(!arrCloseId){return;}
var legend=$('.divHover').find('.divLegend');if(legend){for(var i=0,lenI=legend.length;i<lenI;i++){var bFind=false;for(var j=0,lenJ=arrCloseId.length;j<lenJ;j++){if('lg_'+arrCloseId[j]==legend[i].id){bFind=true;break;}}
if(bFind){var icon=legend.eq(i).children('.btnShow');if(icon){icon.attr('class','glyphicon glyphicon-eye-close btnShow');}}}}};AnlzTendency.prototype.resetShowData=function(data,nFlag){if(!data){return;}
var list=data.list;if(list){var nLenTime=data.timeShaft.length;if(0==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId]=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId][j]=this.fillData(list[i].data[j]);}}}else if(1==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId+'_filter']=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId+'_filter'][j]=this.fillData(list[i].data[j]);}}}else if(2==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId+'_append']=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId+'_append'][j]=this.fillData(list[i].data[j]);}}}}};AnlzTendency.prototype.fillData=function(data){if(!data&&0!=data){data=undefined;}
return data;};AnlzTendency.prototype.getExistDsData=function(arrSrc){var arrPoints=AppConfig.datasource.m_allPointList;if(arrPoints.length<=0){return arrSrc;}
var arrRet=[];if(!arrSrc||arrSrc.length<=0||!arrPoints||arrPoints.length<=0){return arrRet;}
for(var i=0,len=arrSrc.length;i<len;i++){for(var j=0,len2=arrPoints.length;j<len2;j++){if(arrSrc[i]==arrPoints[j].itemId){arrRet.push(arrSrc[i]);break;}}}
return arrRet;};return AnlzTendency;}();var AnlzStack=function(){var _this;function AnlzStack(container,option,screen){AnlzBase.call(this,container,option,screen);this.screen=screen;_this=this;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzStack.prototype=new AnlzBase();AnlzStack.prototype.optionTemplate={imgName:'anlsStack.png',imgIndex:4,imgColor:'148,193,142',templateName:'analysis.modalType.STACK',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzStack.prototype.show=function(){this.initTools();this.container.innerHTML='';var temp;this.paneChart=document.createElement('div');temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='100%';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
this.container.appendChild(this.paneChart);this.spinnerRender.spin(this.container.parentElement);this.init();if(!this.options.noteList){this.options.noteList=[];}else{_this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});};AnlzStack.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzStack.prototype.init=function(){var _this=this;AppConfig.datasource.getDSItemData(this,this.options.itemDS[0].arrId);};AnlzStack.prototype.render=function(data){this.initChart(data);var _this=this;};AnlzStack.prototype.initChart=function(data){var arrSeries=[];var arrLengend=[];this.options.xAxisData=data.timeShaft;for(var i=0;i<data.list.length;i++){var item=data.list[i];arrSeries.push(this.createSeries(item.dsItemId,item.data));arrLengend.push(arrSeries[i].name);this.options.dataList[arrSeries[i].name]=item.data;}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,arrLengend,data.timeShaft));};AnlzStack.prototype.initOption=function(series,arrLengend,timeSHaft){var i18nEcharts=I18n.resource.echarts;return{tooltip:{trigger:'axis'},legend:{data:arrLengend},grid:{x:60,x2:20,y:60,borderColor:'#eee'},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar','stack','tiled'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR,stack:i18nEcharts.STACK,tiled:i18nEcharts.TILED}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc'}}},calculable:true,dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,data:timeSHaft}],yAxis:[{type:'value',scale:true}],series:series,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};};AnlzStack.prototype.createSeries=function(id,data,type){return{id:id,name:AppConfig.datasource.getDSItemById(id).alias,type:'line',smooth:true,itemStyle:{normal:{areaStyle:{type:'default'}}},symbol:'none',stack:I18n.resource.observer.analysis.TOTAL_AMOUNT,data:data};};return AnlzStack;}();var AnlzCluster=function(){function AnlzCluster(container,option,screen){AnlzBase.call(this,container,option,screen);this.m_panelTrend=undefined;this.m_panelScatter=undefined;}
AnlzCluster.prototype=new AnlzBase();AnlzCluster.prototype.optionTemplate={imgName:'anlsPattern.png',imgIndex:6,imgColor:'65,131,189',templateName:'analysis.modalType.CLUSTER',templateParams:{paraName:['X'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:''};AnlzCluster.prototype.show=function(){var _this=this;this.initTools();this.container.innerHTML='';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});$(this.container).append($('<div style="width: 100%; height: 450px;">\
                <ul class="nav nav-tabs" role="tablist" id="myTab">\
                    <li role="presentation" class="active">\
                        <a id="aTendency" href="#tabTendency" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TREND_DISTRIBUTE"></span></a>\
                    </li>\
                    <li role="presentation">\
                        <a id="aScatter" href="#tabScatter" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TYPE_POINT"></span></a>\
                    </li>\
                </ul>\
                <div class="tab-content">\
                    <div role="tabpanel" class="tab-pane fade in active" id="tabTendency" style="height: 400px;"></div>\
                    <div role="tabpanel" class="tab-pane fade" id="tabScatter" style="height: 400px;"></div>\
                </div>\
             </div>\
             <div class="panel panel-default" style="position: absolute; height: calc(100% - 450px); top: 450px; left: 0; right: 0;">\
                 <div class="panel-heading"><span i18n="analysis.paneConfig.TYPICAL_CONDITION"></span></div>\
                 <div class="panel-body" style="padding: 0; height: calc(100% - 40px); overflow-y: auto;">\
                     <table class="table" id="tableGroup" style="overflow-x: auto;"></table>\
                 </div>\
             </div>'));I18n.fillArea($(this.container));_this.spinnerRender.spin(this.container.parentElement);this.init();};AnlzCluster.prototype.close=function(){this.spinnerRender.stop();this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();};AnlzCluster.prototype.init=function(){var _this=this;var arrIds=[];var arrType=[];var arrDSItems=this.options.itemDS;for(var i=0;i<arrDSItems.length;i++){var arrTemp=arrDSItems[i].arrId;if(arrTemp&&arrTemp.length>0){arrIds=arrIds.concat(arrTemp);arrType.push(this.optionTemplate.templateParams.paraName[i]);}}
var postData={dsItemIds:arrIds,timeStart:new Date(this.options.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(this.options.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.options.format,pointType:arrType,systemType:this.optionTemplate.type};WebAPI.post('/analysis/startWorkspaceDataGenCluster',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});},AnlzCluster.prototype.render=function(data){var _this=this;this.initTable(data);this.initTendency(data);$('#aScatter').on('shown.bs.tab',function(e){if($("#tabScatter div").length==0){_this.initScatter(data);}});_this.spinnerStop();$('#btnDownLoadExcel').hide();};AnlzCluster.prototype.initTable=function(data){var table=$("#tableGroup");table.html("");$('#btnDownLoadExcel').hide();var tbody=document.createElement("tbody");var tr,td,divLegend,details;if(!data.dataAnalysisResult.Pattern)return;for(var i=0;i<data.dataAnalysisResult.Pattern.length;i++){details=data.dataAnalysisResult.Pattern[i].Diagnosis;tr=document.createElement("tr");td=document.createElement("td");td.rowSpan=details?details.length:1;divLegend=document.createElement("span");divLegend.textContent="Group "+data.dataAnalysisResult.Pattern[i].name;divLegend.className='label label-warning';divLegend.style.padding='3px';divLegend.style.backgroundColor=echarts.config.color[i];td.appendChild(divLegend);tr.appendChild(td);td=document.createElement('td');if(details)td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[0].name+'</span>'+details[0].detail;tr.appendChild(td);tbody.appendChild(tr);if(details&&details.length>1){for(var j=1;j<details.length;j++){tr=document.createElement("tr");td=document.createElement("td");td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[j].name+'</span>'+details[j].detail;tr.appendChild(td);tbody.appendChild(tr);}}}
$("#tableGroup").append(tbody);};AnlzCluster.prototype.initTendency=function(data){var arrSeries=new Array();var arrLegend=new Array();for(var i=0;i<data.dataAnalysisResult.Pattern.length;i++){var item=data.dataAnalysisResult.Pattern[i];arrLegend.push(item.name);arrSeries.push({name:item.name,type:'line',stack:'总量',itemStyle:{normal:{areaStyle:{type:'default'}}},data:item.TrendValue});}
var i18nEcharts=I18n.resource.echarts;var option={tooltip:{trigger:'axis'},legend:{data:arrLegend},toolbox:{show:true,feature:{magicType:{show:true,type:['line','bar','stack','tiled'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR,stack:i18nEcharts.STACK,tiled:i18nEcharts.TILED}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,xAxis:[{type:'category',boundaryGap:false,data:data.dataAnalysisResult.Pattern[0].TrendLabel}],yAxis:[{min:0,max:100,type:'value'}],series:arrSeries,animationDuration:this.chartAnimationDuration};this.m_panelTrend=echarts.init(document.getElementById("tabTendency"),AppConfig.chartTheme);this.m_panelTrend.setOption(option);this.chart=this.m_panelTrend;};AnlzCluster.prototype.initScatter=function(data){var series=new Array();var seriesNames=new Array();for(var i=0,item,name,arrData,len=data.dataAnalysisResult.ScatterChart.length;i<len;i++){item=data.dataAnalysisResult.ScatterChart[i];name=item.name[0];arrData=new Array();for(var j=0,itemPoint;j<item.data.length;j++){itemPoint=item.data[j];arrData.push(itemPoint.split(','));}
seriesNames.push(name);series.push({name:name,type:'scatter',symbolSize:5,data:arrData});}
var i18nEcharts=I18n.resource.echarts;var option={title:{},tooltip:{trigger:'item',formatter:function formatter(params){return params.seriesName+'<br/>'+params.value[0]+', '+params.value[1];}},toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},legend:{data:seriesNames},xAxis:[{type:'value',scale:true}],yAxis:[{type:'value',scale:true}],animation:true,series:series,animationDuration:this.chartAnimationDuration};var myChart=echarts.init(document.getElementById("tabScatter"),AppConfig.chartTheme);myChart.setOption(option);};return AnlzCluster;}();var AnlzCluster_AHU=function(){function AnlzCluster_AHU(container,option,screen){AnlzCluster.call(this,container,option,screen);}
AnlzCluster_AHU.prototype=new AnlzCluster();AnlzCluster_AHU.prototype.optionTemplate={imgName:'anlsClusterAhu.png',imgIndex:7,imgColor:'148,193,142',templateName:'analysis.modalType.CLUSTER_AHU',templateParams:{paraName:['MATemp','SATemp','RACO2','OATemp','RATemp','RATempSetting','SATempSetting','RACO2Setting','HWTemp','CWTemp','OperationMode','OADamperRatio','HCDamperRatio','CCDamperRatio','SAStaticPressure','SAStaticPressureSetting','FanVSDFrequency','CWRetrunTemp'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:'AHU'};return AnlzCluster_AHU;}();var AnlzCluster_Chiller=function(){function AnlzCluster_Chiller(container,option,screen){AnlzCluster.call(this,container,option,screen);}
AnlzCluster_Chiller.prototype=new AnlzCluster();AnlzCluster_Chiller.prototype.optionTemplate={imgName:'anlsClusterChiller.png',imgIndex:8,imgColor:'211,97,78',templateName:'analysis.modalType.CLUSTER_CHILLER',templateParams:{paraName:['OADryTemp','OAWetBulbTemp','AmperRatio','ChwSupplyTemp','ChwReturnTemp','CwReturnTemp','CwSupplyTemp','EvpTemp','CondTemp'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:'Chiller'};return AnlzCluster_Chiller;}();var AnlzEnergy=function(){function AnlzEnergy(container,option,screen){AnlzBase.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzEnergy.prototype=new AnlzBase();AnlzEnergy.prototype.optionTemplate={imgName:'anlsEnergy.png',imgIndex:9,imgColor:'65,131,189',templateName:'analysis.modalType.ENERGY',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzEnergy.prototype.init=function(){AppConfig.datasource.getDSItemData(this,this.options.itemDS[0].arrId);};AnlzEnergy.prototype.getDefaultOption=function(){var i18nEcharts=I18n.resource.echarts;return{tooltip:{trigger:'axis'},toolbox:{show:true,feature:{dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc'}}},calculable:false,dataZoom:{show:false},grid:{"x":70,"x2":10,"y2":24},xAxis:[{type:'category',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}]};};AnlzEnergy.prototype.render=function(dataSrc){var _this=this;if(undefined==dataSrc||dataSrc.length<=0||undefined==dataSrc.timeShaft||dataSrc.timeShaft.length<=0){_this.screen.saveModalJudge.rejectWith(_this.screen,[_this.screen]);alert('No data');return;}
var xAxis;var arrXAxis=[];var len=dataSrc.timeShaft.length;for(var i=0;i<len;i++){arrXAxis.push(dataSrc.timeShaft[i]);}
xAxis=[{type:'category',data:arrXAxis}];this.options.xAxisData=arrXAxis;var dataName=[];var arrSeries=[];var showColor;len=dataSrc.list.length;var arrId=[];var arrItem=[];for(var i=0;i<len;i++){arrId.push(dataSrc.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<len;i++){showColor=echarts.config.color[i];for(var m=0;m<arrItem.length;m++){if(dataSrc.list[i].dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;dataName.push(itemName);var arrData=[];var len2=dataSrc.list[i].data.length;var defVal;for(var j=1;j<len2;j++){defVal=dataSrc.list[i].data[j]-dataSrc.list[i].data[j-1];arrData.push(parseFloat(defVal.toFixed(1)));}
this.options.dataList[itemName]=arrData;arrSeries.push({name:dataName[i],type:'bar',data:arrData,markPoint:{data:[{type:'max',name:'最大值'},{type:'min',name:'最小值'}]},itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,5,5]},emphasis:{color:showColor,barBorderRadius:[5,5,5,5]}}});break;}}}
dataOption={title:{text:'',subtext:''},legend:{data:dataName},dataZoom:{show:false},grid:{"x":70,"x2":10,"y2":24},xAxis:xAxis,series:arrSeries};_this.chart=echarts.init(_this.paneChart,AppConfig.chartTheme);_this.chart.setOption($.extend(true,{},_this.getDefaultOption(),dataOption));};return AnlzEnergy;}();(function($){function ModalDBHistory(){this.options=undefined;this.modal=null;this.refChart=null;this.$wrap=null;this.showOptions={};}
ModalDBHistory.prototype.show=function(){var _this=this;var domPanelContent=document.getElementById('paneCenter');if(!this.modal)return;this.options=getDefaultOption();if(this.$wrap){this.$wrap.appendTo(document.body);this.initCustomShow();return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalDBHistory.html').done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-db-history-wrap" id="modalDBHistoryWrap">').appendTo(document.body).html(html);_this.$modal=_this.$wrap.children('.modal');I18n.fillArea(_this.$wrap);_this.init();_this.initCustomShow();});};ModalDBHistory.prototype.displayCustomShow=function(options){if(!options)return;this.$selMode.val(options.mode);this.$selMode.trigger('change');if(options.mode==='fast'){this.$selTimerange.val(options.timeRange);}else{this.$selInterval.val(options.timeFmt);this.$selInterval.trigger('change');this.$iptTimeStart.val(options.startTimeStr);this.$iptTimeEnd.val(options.endTimeStr);}
this.$modal.modal('show');};ModalDBHistory.prototype.initCustomShow=function(){var showOptions=this.showOptions;var now;if(this.modal.type==="ModalMultiple"){now=new Date();showOptions.mode='custom';showOptions.timeFmt='h1';showOptions.startTimeStr=function(){return new Date(now.valueOf()-360000000).format('yyyy-MM-dd HH:00');}.call(this);showOptions.endTimeStr=function(){return now.format('yyyy-MM-dd HH:00');}.call(this);}else{showOptions=this.showOptions={mode:'fast',timeRange:'day'};}
this.displayCustomShow(showOptions);};ModalDBHistory.prototype.getOptionsByType=function(data){var options=[];if(this.modal.type==='ModalMultiple'){options=function(){var series=[];var legend=[];var typeMap={};var paraType=this.modal.option.paraType||[];var usedDsNameMap={};paraType.forEach(function(row){if(!row.arrId||!row.arrId.length)return;row.arrId.forEach(function(dsId){if(typeMap[dsId]===undefined){typeMap[dsId]=[row.type];}else{typeMap[dsId].push(row.type);}});});var arrId=[];var arrItem=[];data.list.forEach(function(row){var dsId=row.dsItemId;if(dsId){arrId.push(dsId);}});arrItem=AppConfig.datasource.getDSItemById(arrId);data.list.forEach(function(row){var type=typeMap[row.dsItemId].shift();var dsId=row.dsItemId;var name;for(var i=0,len=arrItem.length;i<len;i++){if(dsId==arrItem[i].id){name=arrItem[i].alias;usedDsNameMap[dsId]=usedDsNameMap[dsId]||0;usedDsNameMap[dsId]+=1;if(usedDsNameMap[dsId]>1){name=name+'_'+usedDsNameMap[dsId];}
legend.push(name);switch(type){case'line':series.push({name:name,type:'line',symbol:'none',data:row.data,yAxisIndex:1,z:4});break;case'bar':series.push({name:name,type:'bar',symbol:'none',data:row.data,yAxisIndex:0});break;case'area':series.push({name:name,type:'line',itemStyle:{normal:{areaStyle:{type:'default'}}},symbol:'none',data:row.data,yAxisIndex:0,z:3});break;case'cumulativeBar':series.push({name:name,type:'bar',stack:'realtime total',symbol:'none',data:row.data,yAxisIndex:0});break;default:break;}
break;}}});return{series:series,legend:{data:legend},yAxis:[{type:'value',scale:false,splitArea:{show:false}},{type:'value',scale:false,splitArea:{show:false}}]};}.call(this);}else{options=function(){var series=[];var legend=[];var usedDsNameMap={};data.list=data.list.filter(function(row,i){if((!row.data||!row.data.length)&&this.modal.type==='ModalNote'){return false;}
var dsId=row.dsItemId;var name=AppConfig.datasource.getDSItemById(dsId).alias||dsId;usedDsNameMap[dsId]=usedDsNameMap[dsId]||0;usedDsNameMap[dsId]+=1;if(usedDsNameMap[dsId]>1){name=name+'_'+usedDsNameMap[dsId];}
series.push({name:name,symbol:'none',type:'line',markLine:{data:[{type:'average',name:'average'}]},data:row.data});legend.push(name);return true;},this);return{series:series,legend:{data:legend}};}.call(this);}
if(this.refChart){try{options.color=this.refChart.getOption().color||[];}catch(e){}}
return options;};ModalDBHistory.prototype.init=function(){this.$chartContainer=$('.chart-container',this.$modal);this.$btnSearch=$('.btn-search',this.$modal);this.$selMode=$('.sel-mode',this.$modal);this.$selTimerange=$('.sel-timerange',this.$modal);this.$selInterval=$('.sel-interval',this.$modal);this.$iptTimeStart=$('.ipt-timestart',this.$modal);this.$iptTimeEnd=$('.ipt-timeend',this.$modal);this.$groupFast=$('[data-group="fast"]',this.$modal);this.$groupCustom=$('[data-group="custom"]',this.$modal);this.initValidator();this.attachEvents();};ModalDBHistory.prototype.initValidator=function(){var _this=this;this.validator=new Validator({elements:[{name:'endTime',selector:this.$iptTimeEnd,rules:[{valid:function valid(val){var startTimeVal=_this.$iptTimeStart.val();if(val<=startTimeVal){this.fail();}else{this.success();}},msg:'the end time should later than start time.'}]}],icon:false});};ModalDBHistory.prototype.initTimePlugin=function(fmt){var now=new Date();var formatStr;if(!fmt){formatStr=timeFormatChange('yyyy-mm-dd hh:ii');fmt={format:formatStr,showFormat:formatStr,minView:'hour',startView:'month',startTime:new Date(now.valueOf()-60*60*24*1000)};}else{this.$iptTimeStart.datetimepicker('remove').val('');this.$iptTimeEnd.datetimepicker('remove').val('');}
this.$iptTimeStart.datetimepicker({format:fmt.format,minView:fmt.minView,startView:fmt.startView,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:new Date(),initialDate:new Date(fmt.startTime)});this.$iptTimeStart.val(timeFormat(fmt.startTime,fmt.showFormat));this.$iptTimeEnd.datetimepicker({format:fmt.format,minView:fmt.minView,startView:fmt.startView,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:new Date(),initialDate:now});this.$iptTimeEnd.val(now.timeFormat(fmt.showFormat));};ModalDBHistory.prototype.initChart=function(){if(!this.chart){this.chart=echarts.init(this.$chartContainer[0],'macarons');}};ModalDBHistory.prototype.setOptions=function(options){this.options=options;};ModalDBHistory.prototype.setModal=function(modal,chart){this.modal=modal;this.refChart=chart;};ModalDBHistory.prototype.attachEvents=function(){var _this=this;this.$selMode.off('change').on('change',function(e){var mode=$(this).val();if(mode==='fast'){_this.$selTimerange.val('hour');_this.$groupFast.show();_this.$groupCustom.hide();}else{_this.$groupFast.hide();_this.$groupCustom.show();_this.$selInterval.trigger('change');}
_this.showOptions.mode=mode;});this.$selInterval.off('change').on('change',function(e){var interval=$(this).val();var fmt={};var now=new Date(),nowTick=now.valueOf();var formatStr;fmt.endTime=now;switch(interval){case'm1':formatStr=timeFormatChange("yyyy-mm-dd hh:ii");fmt.startTime=new Date(nowTick-60000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='hour';fmt.startView='month';break;case'm5':formatStr=timeFormatChange("yyyy-mm-dd hh:ii");fmt.startTime=new Date(nowTick-300000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='hour';fmt.startView='month';break;case'h1':formatStr=timeFormatChange("yyyy-mm-dd hh");fmt.startTime=new Date(nowTick-3600000);fmt.format=formatStr+":00";fmt.showFormat=formatStr+":00";fmt.minView='day';fmt.startView='month';break;case'd1':formatStr=timeFormatChange("yyyy-mm-dd");fmt.startTime=new Date(nowTick-86400000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='month';fmt.startView='month';break;case'M1':formatStr=timeFormatChange("yyyy-mm");fmt.startTime=new Date(nowTick-2592000000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='year';fmt.startView='year';break;}
_this.initTimePlugin(fmt);});this.$btnSearch.off('click').on('click',function(e){var startTime,endTime,timeFmt;var rangeTick;if(_this.showOptions.mode==='fast'){switch(_this.$selTimerange.val()){case'hour':rangeTick=3600000;timeFmt='m5';break;case'day':rangeTick=86400000;timeFmt='h1';break;case'week':rangeTick=604800000;timeFmt='h1';break;case'month':rangeTick=2592000000;timeFmt='d1';break;case'quarter':rangeTick=7776000000;timeFmt='d1';break;default:break;}
endTime=new Date();startTime=new Date(endTime.valueOf()-rangeTick);_this.updateChart(startTime,endTime,timeFmt);}else{startTime=timeFormat(_this.$iptTimeStart.val()).toDate();endTime=timeFormat(_this.$iptTimeEnd.val()).toDate();timeFmt=_this.$selInterval.val();_this.updateChart(startTime,endTime,timeFmt);}
e.stopPropagation();});this.$modal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.reset();_this.$wrap.detach();e.preventDefault();e.stopPropagation();});this.$modal.off('shown.bs.modal').on('shown.bs.modal',function(e){_this.initChart();_this.$btnSearch.trigger('click');});};ModalDBHistory.prototype.updateChart=function(start,end,timeFmt){var _this=this;var startTick,endTick;var points=this.modal.points;if(!points||!points.length){this.chart.getOption().series=[];return;}
this.chart.showLoading({text:'Loading',effect:'spin',textStyle:{fontSize:20}});return WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:points,timeStart:start.format('yyyy-MM-dd HH:mm:ss'),timeEnd:end.format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeFmt}).then(function(rs){var seriesData=[];var timeShaft=rs.timeShaft;var list=rs.list;var optionsFromType;if(!rs.timeShaft||!rs.timeShaft.length){_this.chart.setOption({series:[]},true);return;}
optionsFromType=_this.getOptionsByType(rs);_this.options.chartOptions.xAxis=[{boundaryGap:false,type:'category',data:timeShaft}];_this.options.chartOptions=$.extend(false,_this.options.chartOptions,optionsFromType);_this.chart.setOption(_this.options.chartOptions,true);},function(){_this.chart.setOption({series:[]},true);}).always(function(){_this.chart.hideLoading();});};ModalDBHistory.prototype.reset=function(){if(!!this.chart){this.chart.clear();this.chart.dispose();this.chart=null;}};ModalDBHistory.prototype.close=function(){this.$wrap.remove();this.$wrap=null;};function getDefaultOption(){var i18nEcharts=I18n.resource.echarts;return{chartOptions:{toolbox:{show:true,feature:{dataZoom:{show:false,title:{zoom:i18nEcharts.DATAZOOM,back:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},tooltip:{trigger:'axis'},dataZoom:{show:true},grid:{y:50,y2:80},yAxis:[{type:'value',boundaryGap:[0.1,0.1]}],series:[]}};}
this.ModalDBHistory=ModalDBHistory;}).call(this,jQuery);var ModalBase=function(){function ModalBase(parent,entity,_funcRender,_funcUpdate,_funcConfigMode,configModalOpt){if(!parent)return;this.screen=parent;this.entity=entity;this.wikis={};this.container=undefined;this.chart=undefined;this.spinner=undefined;this.subEntity=undefined;this.executeRender=_funcRender;this.executeConfigMode=_funcConfigMode;this.executeUpdate=_funcUpdate;this.hasEdit=false;this.spanRange={};if(this.configModalOptDefault)this.configModalOpt=$.extend(true,{},this.configModalOptDefault,configModalOpt);this.initContainer();!AppConfig.datasource&&(AppConfig.datasource={getDSItemById:DataSource.prototype.getDSItemById.bind({m_parent:{store:{dsInfoList:[]}},m_arrCloudTableInfo:[]})});};ModalBase.prototype={UNIT_WIDTH:100/12,UNIT_HEIGHT:100/6,initContainer:function initContainer(replacedElementId){var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass='';if(!divParent||replacedElementId){var isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
$(divParent).addClass('springContainer');if(AppConfig.isMobile||this.screen.isForMobile||this.screen.options&&this.screen.options.isForMobile||this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile){this.spanRange={minWidth:1,maxWidth:3,minHeight:1,maxHeight:4.5,yScale:4/3,xScale:4};}else{this.spanRange={minWidth:this.optionTemplate.minWidth,maxWidth:this.optionTemplate.maxWidth,minHeight:this.optionTemplate.minHeight,maxHeight:this.optionTemplate.maxHeight,yScale:1,xScale:1};}
if(AppConfig.isMobile||this.screen.options&&this.screen.options.isForMobile||this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile){var height=100;if((this.optionTemplate.scroll===false||this.entity.scroll===false)&&!(this.screen.options&&this.screen.options.isConfig)){divParent.className+=' noScroll';}else{height=this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale;height>100&&(height=100);divParent.style.height=height+'%';}
divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale+'%';if(this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale>100){divParent.style.width='100%';}
if(this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale>100){divParent.style.height='100%';}}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.type=='ModalNote'||this.entity.modal.type=='ModalMix'){scrollClass=' gray-scrollbar scrollY';}
if(this.entity.modal.title&&this.entity.modal.title!=''&&!this.entity.isNotRender){divParent.innerHTML='<div class="panel panel-default">\
                    <div class="panel-heading springHead">\
                        <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                    </div>\
                    <div class="panel-body springContent'+scrollClass+'" style="position: relative;"></div>\
                </div>';}else{divParent.innerHTML='<div class="panel panel-default">\
                    <span class="springSeHead fontTemp6">'+(this.entity.modal.title?this.entity.modal.title:'')+'</span>\
                    <div class="panel-body springContent'+scrollClass+'" style="position: relative;height:100%;"></div>\
                </div>';}
if(!(this instanceof ModalAnalysis)){var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];var lkHistory;if('ModalInteract'==this.entity.modal.type){var aInterCfg;aInterCfg=document.createElement('a');aInterCfg.className='springLinkBtn';aInterCfg.title='Config time parameter';aInterCfg.href='javascript:;';aInterCfg.innerHTML='<span class="glyphicon glyphicon-cog"></span>';divBtnCtn.appendChild(aInterCfg);aInterCfg.onclick=function(){new ModalInteractCfgPanel(_this).show();};}
if(this.entity.modal.points&&this.entity.modal.points.length>0){var lkJump;lkJump=document.createElement('a');lkJump.className='springLinkBtn';lkJump.title='Add to datasource';lkJump.href='javascript:;';lkJump.innerHTML='<span class="glyphicon glyphicon-export"></span>';divBtnCtn.appendChild(lkJump);lkJump.onclick=function(){new ModalAppendPointToDs(true,_this.entity.modal.points,null).show();};}
if(['ModalHtml','ModalMix','ModalObserver','ModalRank','ModalRankNormal','ModalNone','ModalInteract'].indexOf(this.entity.modal.type)>-1||!this.entity.modal.points||!this.entity.modal.points.length){}else{lkHistory=document.createElement('a');lkHistory.className='springLinkBtn';lkHistory.title='Show History';lkHistory.href='javascript:;';lkHistory.innerHTML='<span class="glyphicon glyphicon-stats"></span>';divBtnCtn.appendChild(lkHistory);this.attachLkHistoryEvents(lkHistory);}
var link=this.entity.modal.link;var _this=this;if(link&&AppConfig.menu[link]){var linkBtn=document.createElement('a');linkBtn.className='springLinkBtn';linkBtn.innerHTML='<span class="glyphicon glyphicon-link"></span>';linkBtn.setAttribute('pageid',link);linkBtn.title='Link to '+AppConfig.menu[link];divBtnCtn.appendChild(linkBtn);linkBtn.onclick=function(e){var $ev=$('#ulPages [pageid="'+link+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');};}
domPanel.appendChild(divBtnCtn);}
this.container=divParent.getElementsByClassName('springContent')[0];if(this.entity.modal.type!=='ModalMix'&&this.entity.modal.type!=='ModalAppBlind'&&this.entity.modal.type!=='ModalAppPie'){this.spinner=new LoadingSpinner({color:'#00FFFF'});this.spinner.spin(this.container);}
return this;},initToolTips:function initToolTips(parent){var _this=this;if(!parent)return;var descTip=new StringBuilder();descTip.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');descTip.append('    <div class="tooltipTitle tooltip-inner" style="display:none">GeneralRegressor</div>');descTip.append('    <div class="tooltipContent" style="border:1px solid black">');descTip.append('        <p class="containerDesc" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.entity.modal.desc).append('</span> ').append('</p>');descTip.append('    </div>');descTip.append('    <div class="tooltip-arrow"></div>');descTip.append('</div>');var options={placement:'bottom',title:_this.entity.modal.title,template:descTip.toString()};if(_this.entity.modal.desc&&_this.entity.modal.desc!=''){$(parent).tooltip(options);}},render:function render(){try{this.executeRender();}catch(e){console.warn(e);}
if(this.chart){this.chart.on('resize',function(param){this.resize();});}},update:function update(options){var modal,dsChartConfig,accuracy;var num,specialCond;if(!options||options.length==0)return;modal=this.entity.modal;dsChartConfig=modal.dsChartCog&&modal.dsChartCog.length?modal.dsChartCog[0]:{};accuracy=dsChartConfig.accuracy;if(accuracy!==''&&!isNaN(accuracy)){specialCond=['',null,undefined];options=options.map(function(row,i){if(specialCond.indexOf(row.data)>-1||isNaN(row.data)){return row;}else{num=+row.data;row.data=num.toFixed(accuracy);return row;}});}
try{this.executeUpdate(options);}catch(e){console.warn(e);}},configure:function configure(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e,callback){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this.screen.isScreenChange=true;_this=null;callback&&callback(true);});};divMask.appendChild(btnRemove);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||this.screen.options&&this.screen.options.isForMobile){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;this.entity.spanR>this.optionTemplate.maxHeight&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);if(!(this instanceof ModalAnalysis)){var $divLink=$('<div class="divResize chartLink">');var $labelLink=$('<label>').text(I18n.resource.dashboard.show.LINK_TO);var chartLink=document.createElement('select');chartLink.className='form-control';chartLink.options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,''));for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);if(this.entity.modal.link==i){option.selected='selected';}
chartLink.options.add(option);}
chartLink.onchange=function(){_this.entity.modal.link=chartLink.value;_this.screen.isScreenChange=true;};$divLink.append($labelLink).append($(chartLink));divMask.appendChild($divLink[0]);}
var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();if(this.entity.isNotRender){var parentId=undefined,subChartIds;if(this.screen.entity&&this.screen.entity.id){parentId=this.screen.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'){if(!entity.modal.option)break;if(entity.modal.option.arrItem.length>0&&entity.modal.option.arrItem[0].subChartIds.length>0){var opts=entity.modal.option.arrItem;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}}
if(parentId){if(this.container.parentNode.parentNode.parentNode.className.indexOf('chartsCt')>=0)return;$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();if(!$sourceParent[0].classList.contains('chartsCt')&&$targetParent[0].classList.contains('chartsCt')){_this.screen.insertChartIntoMix(sourceId,$(e.target).closest('.chartsCt')[0]);}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}
_this.screen.isScreenChange=true;};this.executeConfigMode();},modalInit:function modalInit(){var _this=this;var dataItem=[],option;var dataTypeUnit;var type=false;if(_this.entity.modal.points!=undefined){if(_this.entity.modal.option&&_this.entity.modal.option.paraType){for(var i=0;i<_this.entity.modal.option.paraType.length;i++){dataTypeUnit={dsId:[],dsType:'',dsName:[]};dataTypeUnit.type=_this.entity.modal.option.paraType[i].type;var arrId=[];var arrItem=[];for(var j=0;j<_this.entity.modal.option.paraType[i].arrId.length;j++){arrId.push(_this.entity.modal.option.paraType[i].arrId[j]);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var j=0;j<_this.entity.modal.option.paraType[i].arrId.length;j++){var id=_this.entity.modal.option.paraType[i].arrId[j];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){dataTypeUnit.dsId.push(id);dataTypeUnit.dsName.push(arrItem[m].alias);break;}}}
dataItem.push(dataTypeUnit);}}else{dataTypeUnit={dsId:[],dsType:'',dsName:[]};var arrId=[];var arrItem=[];for(var i=0;i<_this.entity.modal.points.length;i++){arrId.push(_this.entity.modal.points[i]);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<_this.entity.modal.points.length;i++){var id=_this.entity.modal.points[i];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){dataTypeUnit.dsId.push(id);dataTypeUnit.dsName.push(arrItem[m].alias===""?arrItem[m].value:arrItem[m].alias);break;}}}
dataItem.push(dataTypeUnit);}}
if(_this.optionTemplate.mode==='custom'){_this.showConfigModal&&_this.showConfigModal();return;}
if(['ModalReportChapter','ModalReportFactory'].indexOf(_this.optionTemplate.type)>-1){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalMonitor'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalAppButton'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalAppKPICollect'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalReportFactory'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalDiagnosisPanelHtml'){return;}
var tempOptionPara;_this.entity.modal.option?tempOptionPara=_this.entity.modal.option:tempOptionPara={};tempOptionPara.dataItem=dataItem;option={modeUsable:_this.optionTemplate.mode,allDataNeed:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraAnlysMode:true,rowDataType:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraName:[I18n.resource.analysis.paneConfig.DATA_TYPE_DEFAULT],rowDataTypeShowName:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraShowName:undefined,dataTypeMaxNum:[_this.optionTemplate.maxNum],templateType:_this.optionTemplate.type,dsChartCog:_this.entity.modal.dsChartCog?_this.entity.modal.dsChartCog:null,optionPara:tempOptionPara};if(dataItem.length==0){type=true;}
if(_this.screen.screen){_this.screen.screen.modalConfigPane.showModalInit(type,option,_this);}else{if(!_this.screen.modalConfigPane){_this.screen.initModalConfigPane();}
_this.screen.modalConfigPane.showModalInit(type,option,_this);}
_this.screen.isScreenChange=true;},showConfigModal:function showConfigModal(){this.initConfigModalOpt();var ctn;try{var ctn=this.screen.container.querySelector('.cfgModal');}catch(e){var ctn=this.screen.shape.parentNode.parentNode.querySelector('.cfgModal');}
if(!ctn){if(this.screen.shape&&this.screen.shape.parentNode.parentNode){ctn=this.screen.shape.parentNode.parentNode;}else if(this.screen.screen){ctn=this.screen.screen.container;}else{ctn=this.screen.container;}}
this.configModal=new ConfigModal(this.configModalOpt,ctn,this);this.configModal.init();this.configModal.show();},initConfigModalOpt:function initConfigModalOpt(){var _this=this;this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.render();};},setModalOption:function setModalOption(option){},divResizeByToolInit:function divResizeByToolInit(){var _this=this;var $divContainer=$('#divContainer_'+_this.entity.id);$divContainer.find('#heightResize').mousedown(function(e){$('.springConfigMask').attr('draggable','false');$('.springContent').attr('draggable','false');$(e.target).mousemove(function(e){$(e.target).closest('.springContainer').css('height',$(e.target).val()*_this.UNIT_HEIGHT*_this.spanRange.yScale+'%');_this.entity.spanR=Number($(e.target).val());$(e.target).next().text($(e.target).val()+' /'+_this.spanRange.maxHeight);if(_this.screen.screen){_this.screen.screen.setEntity(_this.entity);}else{_this.screen.setEntity(_this.entity);}});}).mouseup(function(e){$('.springConfigMask').attr('draggable','true');$('.springContent').attr('draggable','true');$(e.target).off('mousemove');if(_this.chart)_this.chart.resize();_this.screen.isScreenChange=true;_this.hasEdit=true;});$divContainer.find('#widthResize').mousedown(function(e){$('.springConfigMask').attr('draggable','false');$('.springContent').attr('draggable','false');$(e.target).mousemove(function(e){$(e.target).closest('.springContainer').css('width',$(e.target).val()*_this.UNIT_WIDTH*_this.spanRange.xScale+'%');_this.entity.spanC=Number($(e.target).val());$(e.target).next().text($(e.target).val()+' /'+_this.spanRange.maxWidth);if(_this.screen.screen){_this.screen.screen.setEntity(_this.entity);}else{_this.screen.setEntity(_this.entity);}});}).mouseup(function(e){$('.springConfigMask').attr('draggable','true');$('.springContent').attr('draggable','true');$(e.target).off('mousemove');if(_this.chart)_this.chart.resize();_this.screen.isScreenChange=true;_this.hasEdit=true;});$divContainer.find('.rangeVal').click(function(e){e.stopPropagation();var valueCurrent=Number($(e.target).prev().val());var valuePre=$(e.target).prev().val();var valueMax=Number($(e.target).prevAll('.inputResize').attr('max'));var valueMin=Number($(e.target).prevAll('.inputResize').attr('min'));$(e.target).nextAll('.rangeChange').css('display','inline-block').focus().off('blur').blur(function(e){valueCurrent=Number($(e.target).val());if(valueCurrent<=valueMax&&valueCurrent>=valueMin){$(e.target).prevAll('.inputResize').val(valueCurrent.toString());if($(e.target).prevAll('.inputResize').attr('id')=='widthResize'){$(e.target).closest('.springContainer').css('width',$(e.target).val()*_this.UNIT_WIDTH*_this.spanRange.xScale+'%');_this.entity.spanC=Number($(e.target).val());_this.screen.setEntity(_this.entity);$(e.target).prev().text($(e.target).val()+' /'+_this.spanRange.maxWidth);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{$(e.target).closest('.springContainer').css('height',$(e.target).val()*_this.UNIT_HEIGHT*_this.spanRange.yScale+'%');_this.entity.spanR=Number($(e.target).val());_this.screen.setEntity(_this.entity);$(e.target).prev().text($(e.target).val()+' /'+_this.spanRange.maxHeight);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
$(e.target).css('display','none');}else if(valueCurrent>valueMax){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR1+"</strong>").show().close();$(e.target).val(valuePre).css('display','none');}else if(valueCurrent<valueMin){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR2+"</strong>").show().close();$(e.target).val(valuePre).css('display','none');}else{if($(e.target).val()!=""){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR3+"</strong>").show().close();}
$(e.target).val(valuePre).css('display','none');}
_this.hasEdit&&(_this.screen.isScreenChange=true);});});},divResizeByMouseInit:function divResizeByMouseInit(){var _this=this;var $widthResize;var $heightResize;var divContainer=$('#divContainer_'+_this.entity.id).get(0);var resizeOnRight=document.createElement('div');resizeOnRight.className='resizeOnRight';divContainer.appendChild(resizeOnRight);var resizeOnBottom=document.createElement('div');resizeOnBottom.className='resizeOnBottom';divContainer.appendChild(resizeOnBottom);var resizeOnCorner=document.createElement('div');resizeOnCorner.className='resizeOnCorner';divContainer.appendChild(resizeOnCorner);var mouseStart={};var divStart={};var rightStart={};var bottomStart={};var w,h,tempSpanR,tempSpanC;resizeOnRight.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false);}
$(e.target).prev().children(':last-child').attr('draggable',false);$widthResize=$(e.target).parent().find('#widthResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;rightStart.x=resizeOnRight.offsetLeft;doResizeOnRight(e);if(resizeOnRight.setCapture){resizeOnRight.onmousemove=doResizeOnRight;resizeOnRight.onmouseup=stopResizeOnRight;resizeOnRight.setCapture();}else{document.addEventListener("mousemove",doResizeOnRight,false);document.addEventListener("mouseup",stopResizeOnRight,false);}};function doResizeOnRight(e){var oEvent=e||event;var l=oEvent.clientX-mouseStart.x+rightStart.x;w=l+resizeOnCorner.offsetWidth;if(w<resizeOnCorner.offsetWidth){w=resizeOnCorner.offsetWidth;}else if(w>document.documentElement.clientWidth-divContainer.offsetLeft){w=document.documentElement.clientWidth-divContainer.offsetLeft-2;}
divContainer.style.width=w+"px";}
function stopResizeOnRight(e){if(resizeOnRight.releaseCapture){tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";_this.entity.spanC=tempSpanC;resizeOnRight.onmousemove=null;resizeOnRight.onmouseup=null;resizeOnRight.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";_this.entity.spanC=tempSpanC;document.removeEventListener("mousemove",doResizeOnRight,false);document.removeEventListener("mouseup",stopResizeOnRight,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;$(e.target).prev().children(':last-child').attr('draggable',true);var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true);}}
resizeOnBottom.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false);}
$(e.target).prev().children(':last-child').attr('draggable',false);$heightResize=$(e.target).parent().find('#heightResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;bottomStart.y=resizeOnBottom.offsetTop;doResizeOnBottom(e);if(resizeOnBottom.setCapture){resizeOnBottom.onmousemove=doResizeOnBottom;resizeOnBottom.onmouseup=stopResizeOnBottom;resizeOnBottom.setCapture();}else{document.addEventListener("mousemove",doResizeOnBottom,false);document.addEventListener("mouseup",stopResizeOnBottom,false);}};function doResizeOnBottom(e){var oEvent=e||event;var t=oEvent.clientY-mouseStart.y+bottomStart.y;h=t+resizeOnCorner.offsetHeight;if(h<resizeOnCorner.offsetHeight){h=resizeOnCorner.offsetHeight;}else if(h>document.documentElement.clientHeight-divContainer.offsetTop){h=document.documentElement.clientHeight-divContainer.offsetTop-2;}
divContainer.style.height=h+"px";}
function stopResizeOnBottom(e){if(resizeOnBottom.releaseCapture){tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanR=tempSpanR;resizeOnBottom.onmousemove=null;resizeOnBottom.onmouseup=null;resizeOnBottom.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanR=tempSpanR;document.removeEventListener("mousemove",doResizeOnBottom,false);document.removeEventListener("mouseup",stopResizeOnBottom,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;$(e.target).prev().children(':last-child').attr('draggable',true);var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true);}}
resizeOnCorner.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false);}
$(e.target).prev().children(':last-child').attr('draggable',false);$widthResize=$(e.target).parent().find('#widthResize');$heightResize=$(e.target).parent().find('#heightResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;divStart.x=resizeOnCorner.offsetLeft;divStart.y=resizeOnCorner.offsetTop;doResizeOnCorner(e);if(resizeOnCorner.setCapture){resizeOnCorner.onmousemove=doResizeOnCorner;resizeOnCorner.onmouseup=stopResizeOnCorner;resizeOnCorner.setCapture();}else{document.addEventListener("mousemove",doResizeOnCorner,false);document.addEventListener("mouseup",stopResizeOnCorner,false);}};function doResizeOnCorner(e){var oEvent=e||event;var l=oEvent.clientX-mouseStart.x+divStart.x;var t=oEvent.clientY-mouseStart.y+divStart.y;w=l+resizeOnCorner.offsetWidth;h=t+resizeOnCorner.offsetHeight;if(w<resizeOnCorner.offsetWidth){w=resizeOnCorner.offsetWidth;}else if(w>document.documentElement.clientWidth-divContainer.offsetLeft){w=document.documentElement.clientWidth-divContainer.offsetLeft-2;}
if(h<resizeOnCorner.offsetHeight){h=resizeOnCorner.offsetHeight;}else if(h>document.documentElement.clientHeight-divContainer.offsetTop){h=document.documentElement.clientHeight-divContainer.offsetTop-2;}
divContainer.style.width=w+"px";divContainer.style.height=h+"px";}
function stopResizeOnCorner(e){if(resizeOnCorner.releaseCapture){tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$widthResize.val(tempSpanC.toString()).get(0).setAttribute('value',tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());$heightResize.val(tempSpanR.toString()).get(0).setAttribute('value',tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanC=tempSpanC;_this.entity.spanR=tempSpanR;resizeOnCorner.onmousemove=null;resizeOnCorner.onmouseup=null;resizeOnCorner.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanC=tempSpanC;_this.entity.spanR=tempSpanR;document.removeEventListener("mousemove",doResizeOnCorner,false);document.removeEventListener("mouseup",stopResizeOnCorner,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true);}
$(e.target).prev().children(':last-child').attr('draggable',true);}
function rangeJudge(){if(tempSpanC>_this.spanRange.maxWidth){tempSpanC=_this.spanRange.maxWidth;}else if(tempSpanC<_this.spanRange.minWidth){tempSpanC=_this.spanRange.minWidth;}
if(tempSpanR>_this.spanRange.maxHeight){tempSpanR=_this.spanRange.maxHeight;}else if(tempSpanR<_this.spanRange.minHeight){tempSpanR=_this.spanRange.minHeight;}}},attachLkHistoryEvents:function attachLkHistoryEvents(domItem){var _this=this;domItem.onclick=function(e){_this.modalDBHistory.setModal(_this.entity.modal,_this.chart);_this.modalDBHistory.show();e.preventDefault();e.stopPropagation();};},modalDBHistory:new ModalDBHistory(),initPointAlias:function initPointAlias(arrPoints){var arrPointsAlias=[];var lastRepeatIndex=-1;var tempAlias;var repeatNum=0;var tempIndex;var arrId=[];var arrItem=[];for(var i=0;i<arrPoints.length;++i){arrId.push(arrPoints[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<arrPoints.length;++i){for(var m=0;m<arrItem.length;m++){if(arrPoints[i].dsItemId==arrItem[m].id){arrPointsAlias.push(arrItem[m].alias);break;}}}
for(var i=0;i<arrPoints.length;++i){lastRepeatIndex=arrPointsAlias.lastIndexOf(arrPointsAlias[i]);if(lastRepeatIndex>i){repeatNum=1;tempAlias=arrPointsAlias[i];arrPointsAlias[i]=tempAlias+'_No1';tempIndex=i;for(var j=tempIndex+1;j<lastRepeatIndex+1;j++){repeatNum+=1;tempIndex=arrPointsAlias.indexOf(tempAlias);if(tempIndex==-1)break;arrPointsAlias[tempIndex]=tempAlias+'_No'+repeatNum;}}}
return arrPointsAlias;},close:function close(){if(this.chart){this.chart.dispose();}
this.container=null;this.entity=null;this.executeConfigMode=null;this.executeRender=null;this.executeUpdate=null;this.screen=null;this.isConfigMode=null;this.reportScreen=null;typeof this._close==='function'&&this._close();},renderPop:function renderPop(pop){if(!pop)return;var $target=$('#divContainer_'+this.entity.id).find('.panel');var $panePop=$target.find('.panePop');var tpl='<div class="divMove"><span>{popMsg}</span></div>\
                <span class="glyphicon glyphicon-remove-circle btnClosePop" title="Close"></span>';if(!$panePop[0]){$panePop=$('<div class="panel-body panePop"></div>');$target.append($panePop);}
$panePop.html(tpl.formatEL({popMsg:pop.data}));var spanWidth=$panePop.find('span').width();var $divMove=$panePop.find('.divMove');if(spanWidth>$divMove.width()){var $marquee=$('<marquee direction="left" onmouseover="this.stop()" onmouseout="this.start()" scrollAmount="3" style="height: 40px; width: calc(100% - 28px);"></marquee>');$marquee.html($panePop.find('span').html());$marquee.appendTo($panePop);$divMove.remove();}
$panePop.find('.btnClosePop').off().click(function(){$panePop.hide();});},toggleDataSource:function toggleDataSource(bool){var colCount=$('#paneContent')[0].classList.contains('col-sm-10');var ele=null;if(bool&&colCount){ele=document.getElementById('rightCt');ele&&ele.click();}
if(!bool&&!colCount){ele=document.getElementById('rightCt');ele&&ele.click();}},getSiblingChart:function getSiblingChart(){var arrChartId=Object.keys(this.screen.listEntity);var arrChart=[];for(var i=0;i<arrChartId.length;i++){if(arrChartId[i]==this.entity.id)continue;arrChart.push({id:arrChartId[i],title:this.screen.listEntity[arrChartId[i]].entity.modal.title,name:this.screen.listEntity[arrChartId[i]].entity.modal.title});}
return arrChart;},initSubEntity:function initSubEntity(ctn,entity,cls){var id=+new Date();ctn.id='divContainer_'+id;entity.id=id;if(!cls)cls=ModalHtml;this.subEntity=new cls(this,entity);this.subEntity.render();},updateSubEntity:function updateSubEntity(){this.subEntity.render();}};return ModalBase;}();var ModalNone=function(){function ModalNone(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,null,null);}
ModalNone.prototype=new ModalBase();ModalNone.prototype.optionTemplate={name:'',mode:['realTime'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalNone'};ModalNone.prototype.renderModal=function(){I18n.fillArea($('#coalSaveName').parent());$(this.container).parent().css('visibility','hidden');this.spinner.stop();},ModalNone.prototype.configure=function(){this.spinner.stop();var _this=this;$(_this.container).parent().css('visibility','');var divAdd=document.createElement('span');divAdd.className='springConfigTips';divAdd.innerHTML='Drag data meta from left panel';this.container.appendChild(divAdd);var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this=null;};this.container.appendChild(btnRemove);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||this.screen.options&&this.screen.options.isForMobile||this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;this.entity.spanR>this.optionTemplate.maxHeight&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';this.container.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';this.container.appendChild(btnWidthResize);this.divResizeByMouseInit();this.divResizeByToolInit();if(this.entity.isNotRender&&this.screen.entity){$(document.getElementById('divContainer_'+this.screen.entity.id)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}
if(this.entity.isNotRender){var parentId=undefined,subChartIds;if(this.screen.entity&&this.screen.entity.id){parentId=this.screen.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}
if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
var divParent=$(this.container).closest('.springContainer')[0];var divContent=$(divParent).find('.springContent')[0];divContent.draggable='true';divContent.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divContent.ondragover=function(e){e.preventDefault();};divContent.ondragleave=function(e){e.preventDefault();};divParent.ondrop=function(e){e.stopPropagation();if(e.dataTransfer.getData("type")&&e.dataTransfer.getData("title")){if(_this.screen.screen){var entity=_this.entity;if(_this.screen.entity.modal.type==='ModalAppBlind'){if(e.dataTransfer.getData("type")=='ModalMix'){alert('百叶窗内不能拖入组合图');return;}if(e.dataTransfer.getData("type")=="ModalPointKPI"){alert('百叶窗内不能拖入KPI尊享版');return false;}
if(e.dataTransfer.getData("type")=="ModalReportFactory"){alert('百叶窗内不能拖入报表章节');return false;}
if(e.dataTransfer.getData("type")=="ModalAppBlind"){alert('百叶窗内不能拖入百叶窗');return false;}else{_this.screen.screen.rebornEntity(entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"));}}else{if(e.dataTransfer.getData("type")=='ModalMix'){alert(I18n.resource.toolBox.modal.MSG_MIX_NOT_ALLOW_TO_MIX);return;}
if(e.dataTransfer.getData("type")=="ModalPointKPI"){alert(I18n.resource.toolBox.modal.MSG_KPI_NOT_ALLOW_TO_MIX);return false;}else{_this.screen.screen.rebornEntity(entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"));}}}else{_this.screen.rebornEntity(_this.entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"),_this.hasEdit);}}else if(e.dataTransfer.getData("id")){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');_this.screen.replaceEntity(e.dataTransfer.getData("id"),targetId);}};};return ModalNone;}();var ModalAnalysis=function(){var _this=undefined;function ModalAnalysis(screen,entityParams){entityParams.spanR=6;entityParams.spanC=12;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.spinner.stop();this.container=$('<div style="padding: 20px;position: absolute;left:0;top:0;right:0;bottom:0; z-index: 102; overflow-y: auto;"></div>').appendTo(this.container)[0];_this=this;this.curModal=this.entity.modal.option.option;this.entityAnalysis=undefined;this.saveModalJudge=$.Deferred();}
ModalAnalysis.prototype=new ModalBase();ModalAnalysis.prototype.optionTemplate={name:'toolBox.modal.TRANSIT',parent:2,mode:['realTimeWithoutRange'],maxNum:1,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalAnalysis'};ModalAnalysis.prototype.renderModal=function(){var modalClass=this.screen.factoryIoCAnalysis.getModel(this.entity.modal.option.type);this.screen.curModal=this.curModal;this.entityAnalysis=new modalClass(this.container,this.curModal,this);this.entityAnalysis.isShareMode=1;this.entityAnalysis.paneChart=null;this.entityAnalysis.chartAnimationDuration=500;this.entityAnalysis.animation=false;this.entityAnalysis.show();};ModalAnalysis.prototype.onresize=function(){if(this.entityAnalysis.chart)this.entityAnalysis.chart.resize();};ModalAnalysis.prototype.updateModal=function(points){};ModalAnalysis.prototype.showConfigMode=function(){};ModalAnalysis.prototype.setModalOption=function(option){};ModalAnalysis.prototype.alertNoData=function(){};ModalAnalysis.prototype.spinnerStop=function(){};ModalAnalysis.prototype.saveModal=function(){};return ModalAnalysis;}();var ModalConfig=function($,undefined){var arrForEach=Array.prototype.forEach;function ModalConfig(options){this.options=$.extend({},this.DEFAULTS,options);this.$wrap=null;};ModalConfig.prototype={constructor:ModalConfig,show:function show(){var _this=this;var htmlUrl=this.options.htmlUrl;var matches=htmlUrl.match(/\/?(\w+)(?:\.html)/);var id,domPanelContent,$ele;var promise=$.Deferred();if(!matches||matches[1]===undefined){console.error('the url of config modal is illigal: '+htmlUrl);return false;}
id=matches[1]+'Wrap';domPanelContent=document.getElementById(this.options.container||'paneContent');if(($ele=$('#'+id)).length>0){if(!$.contains(domPanelContent,$ele[0])){domPanelContent.appendChild($ele[0]);}
promise.resolve();}else{Spinner.spin(domPanelContent);WebAPI.get(htmlUrl).then(function(html){var rs;Spinner.stop();_this.$wrap=$('<div class="modal-config-wrap" id="'+id+'">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this._attachEvents();return _this.init();}).always(function(){promise.resolve();});}
return promise.done(function(){_this.$modal.modal('show');});},_setField:function _setField(type,$ele,value){var itemMap,name;var _this=this;switch(type){case'dropdown':itemMap=$ele.data('dropdown-items');if(!itemMap){$ele.data('dropdown-items',itemMap=function(){var rs={};$ele.siblings('ul').find('a').each(function(i,item){var $item=$(item);var value=$item.attr('data-value');var text=$item.text();if(!rs[value])rs[value]=text;});return rs;}());}
$ele.attr('data-value',value).children('span').eq(0).text(itemMap[value]);break;case'input':case'textarea':value=value||'';$ele.val(value);break;case'droparea':if(!value||value.trim()===''){$ele.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');}
else{name=AppConfig.datasource.getDSItemById(value).alias;$ele.attr({'data-value':value,'title':name}).html('<span>'+name+'</span>');}
break;case'select':$ele.val(value);break;default:break;}},_attachEvents:function _attachEvents(){var _this=this;var $modal;$('.dropdown-menu',this.$wrap).off('click.selected').on('click.selected','a',function(e){var $this=$(this);var $btn=$this.parents('.dropdown-wrap').children('button');var value=$this.attr('data-value');var text=$this.text();$btn.attr('data-value',value);$btn.children('span').eq(0).text(text);e.preventDefault();});$modal=$('.modal',this.$wrap);$modal.off('show.bs.modal').on('show.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.recoverForm(_this.options.modalIns.entity.modal);if(!$rightCt.hasClass('rightCtOpen'))$rightCt.click();});$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.reset();if($rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$wrap.off('dragover').on('dragover','.drop-area',function(e){e.preventDefault();});this.$wrap.off('dragenter').on('dragenter','.drop-area',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});this.$wrap.off('dragleave').on('dragleave','.drop-area',function(e){$(e.target).removeClass('on');e.stopPropagation();});this.$wrap.off('drop').on('drop','.drop-area',function(e){_this.onDropActionPerformed(e);});},onDropActionPerformed:function onDropActionPerformed(e){var _this=this;var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');_this._setField('droparea',$target,itemId);e.stopPropagation();},setOptions:function setOptions(options){this.options=$.extend({},this.options,options);}};return ModalConfig;}(jQuery);var ModalChart=function(){function ModalChart(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.dicPeriod={'30s':30000,'m1':60000,'m5':300000,'10m':600000,'30m':1800000,'h1':3600000,'d1':86400000,'M1':2592000000};}
ModalChart.prototype=new ModalBase();ModalChart.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART',parent:0,mode:['realTime'],maxNum:10,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalChart'};ModalChart.prototype.optionDefault={color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500'],title:{textStyle:{fontWeight:'normal',color:'#008acd'}},legend:{textStyle:{fontFamily:"Microsoft YaHei",fontSize:10},top:'10',left:'center'},dataRange:{itemWidth:15,color:['#5ab1ef','#e0ffff']},toolbox:{x:'right',y:'center',feature:{mark:{show:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}},color:['#1e90ff','#1e90ff','#1e90ff','#1e90ff'],effectiveColor:'#ff4500'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{color:'#008acd'},crossStyle:{color:'#008acd'},shadowStyle:{color:'rgba(200,200,200,0.2)'}}},dataZoom:{dataBackgroundColor:'#efefff',fillerColor:'rgba(182,162,222,0.2)',handleColor:'#008acd'},grid:function(isMobile){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:50,top:40};if(isMobile){grid.x=40;}
return grid;}(AppConfig.isMobile),categoryAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitLine:{lineStyle:{color:['#eee']}}},valueAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']}},splitLine:{lineStyle:{color:['#eee']}}},polar:{axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{lineStyle:{color:'#008acd'},controlStyle:{normal:{color:'#008acd'},emphasis:{color:'#008acd'}},symbol:'emptyCircle',symbolSize:3},bar:{itemStyle:{normal:{barBorderRadius:5},emphasis:{barBorderRadius:5}},barMaxWidth:80},line:{smooth:true,symbol:'none',symbolSize:3},k:{itemStyle:{normal:{color:'#d87a80',color0:'#2ec7c9',lineStyle:{color:'#d87a80',color0:'#2ec7c9'}}}},scatter:{symbol:'circle',symbolSize:4},radar:{symbol:'emptyCircle',symbolSize:3},map:{itemStyle:{normal:{areaStyle:{color:'#ddd'},label:{textStyle:{color:'#d87a80'}}},emphasis:{areaStyle:{color:'#fe994e'}}}},force:{itemStyle:{normal:{linkStyle:{color:'#1e90ff'}}}},chord:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}},emphasis:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}}}},gauge:{axisLine:{lineStyle:{color:[[0.2,'#2ec7c9'],[0.8,'#5ab1ef'],[1,'#d87a80']],width:10}},axisTick:{splitNumber:10,length:15,lineStyle:{color:'auto'}},splitLine:{length:22,lineStyle:{color:'auto'}},pointer:{width:5}},textStyle:{fontFamily:'微软雅黑, Arial, Verdana, sans-serif'}};ModalChart.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption(this.options);},ModalChart.prototype.updateModal=function(pointName,pointValue){},ModalChart.prototype.showConfigMode=function(){},ModalChart.prototype.dsChartCog=function(cog,option){if(!cog)return;if(cog[0].upper)option.yAxis[0].max=cog[0].upper;if(cog[0].lower)option.yAxis[0].min=cog[0].lower;if(cog[0].unit)option.yAxis[0].name=cog[0].unit;if(cog[0].markLine){if(!option.series[0].markLine){option.series[0].markLine={};option.series[0].markLine.data=new Array();}
for(var i in cog[0].markLine){var markLine=cog[0].markLine[i];if(!markLine.value)continue;var arr=[{name:markLine.name,xAxis:-1,yAxis:markLine.value},{name:markLine.name,xAxis:option.series[0].data.length,yAxis:markLine.value}];option.series[0].markLine.data.push(arr);}}};ModalChart.prototype.coordinate=function(timeShaft){var arr=[],timeFormat=this.entity.modal.option.timeFormat,format;switch(timeFormat){case'm5':format='HH:mm';break;case'h1':format='HH:00';break;case'd1':format='yyyy-MM-dd';break;case'M1':format='yyyy-MM';break;default:format='yyyy-MM-dd HH:mm';break;}
for(var i=0,l=timeShaft.length;i<l;i++){arr.push(timeShaft[i].toDate().format(format));}
return[{data:arr}];},ModalChart.prototype.resize=function(){this.chart&&this.chart.resize();};ModalChart.prototype.getData=function(params){var startTime,endTime,timeFormat,unit,postData={},arrPoint;var now=new Date();if(params&&params.dsItemIds){arrPoint=params.dsItemIds;}else{arrPoint=this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points;}
if(params&&params.timeFormat){timeFormat=params.timeFormat;}else{timeFormat=this.entity.modal.option.format;}
if(!params||!params.startTime||!params.endTime){if(this.entity.modal.option.mode==0){switch(this.entity.modal.option.recentTime){case'today':startTime=new Date(now.getTime()-86400000+3600000).format('yyyy-MM-dd HH:00:00');endTime=now.format('yyyy-MM-dd HH:00:00');break;case'threeDay':startTime=new Date(now.getTime()-86400000*3+3600000).format('yyyy-MM-dd HH:00:00');endTime=now.format('yyyy-MM-dd HH:00:00');break;case'yesterday':endTime=now;endTime.setHours(0);endTime.setMinutes(0);endTime.setSeconds(0);startTime=new Date(endTime.getTime()-86400000+3600000).format('yyyy-MM-dd HH:00:00');endTime=endTime.format('yyyy-MM-dd HH:00:00');break;case'thisWeek':endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(endTime);startTime.setDate(startTime.getDate()-6);startTime=startTime.format('yyyy-MM-dd 00:00:00');break;case'lastWeek':endTime=new Date(now.getTime()-now.getDay()*86400000).format('yyyy-MM-dd 00:00:00');;startTime=new Date(now.getTime()-(now.getDay()+6)*86400000).format('yyyy-MM-dd 00:00:00');;break;case'thisYear':endTime=now.format('yyyy-MM-01 00:00:00');startTime=now;startTime.setMonth(startTime.getMonth()-12);startTime=startTime.format('yyyy-MM-01 00:00:00');break;}}else if(this.entity.modal.option.mode==1){if(this.entity.modal.option.startTime&&this.entity.modal.option.endTime){startTime=new Date(this.entity.modal.option.startTime).format('yyyy-MM-dd HH:mm:ss');endTime=new Date(this.entity.modal.option.endTime).format('yyyy-MM-dd HH:mm:ss');}else{alert('请配置开始时间/结束时间');return;}}else if(this.entity.modal.option.mode==2){if(this.entity.modal.option.unit==='hour'){unit=3600000;endTime=new Date();if(timeFormat==='h1'){endTime.setMinutes(0);endTime.setSeconds(0);}
startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+1000).format('yyyy-MM-dd HH:mm:ss');}else if(this.entity.modal.option.unit==='day'){unit=86400000;endTime=new Date();endTime.setMinutes(0);endTime.setSeconds(0);if(timeFormat==='h1'){startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+3600000).format('yyyy-MM-dd HH:mm:ss');}else if(timeFormat==='d1'){startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+1000).format('yyyy-MM-dd HH:mm:ss');}}else if(this.entity.modal.option.unit==='month'){unit=2592000000;if(timeFormat==='d1'){endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(now.getTime()-86400000*30).format('yyyy-MM-dd 00:00:00');}else if(timeFormat==='M1'){alert('开发中');return;}}
endTime=endTime.format('yyyy-MM-dd HH:mm:ss');}}else{startTime=params.startTime;endTime=params.endTime;}
if(!arrPoint||arrPoint.length===0){postData.errorMsg='Data source is error';}
if(!startTime||!endTime){postData.errorMsg='Start time or end time is error';}
if(!timeFormat){postData.errorMsg='timeFormat is error';}
if(postData.errorMsg){alert(postData.errorMsg);return;}
postData.dsItemIds=arrPoint;postData.timeStart=startTime;postData.timeEnd=endTime;postData.timeFormat=timeFormat;return WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData);};return ModalChart;}();var ModalRealtimePie=function(){function ModalRealtimePie(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalRealtimePie.prototype=new ModalBase();ModalRealtimePie.prototype.optionTemplate={name:'',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};ModalRealtimePie.prototype.optionDefault={tooltip:{trigger:'item',formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:'vertical',x:'left',y:'center'},toolbox:{show:false,feature:{mark:{show:true},dataView:{show:true,readOnly:false},magicType:{show:true,type:['pie','funnel'],option:{funnel:{x:'25%',width:'50%',funnelAlign:'center',max:1548}}},restore:{show:true},saveAsImage:{show:true}}},calculable:true,color:['#E2583A','#FD9F08','#FEC500','#1D74A9','#04A0D6','#689C0F','#109d83'],series:[{type:'pie',radius:['50%','70%'],center:['50%','50%'],labelLine:{normal:{show:true,length:6,length2:60,lineStyle:{width:[2]}}},itemStyle:{normal:{label:{show:true,formatter:'{d}%'},labelLine:{show:true}},emphasis:{label:{show:true,position:'center',textStyle:{fontSize:'20',fontWeight:'bold'}}}}}]};ModalRealtimePie.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},ModalRealtimePie.prototype.updateModal=function(points){},ModalRealtimePie.prototype.showConfigMode=function(){},ModalRealtimePie.prototype.dealWithData=function(points,len){var arr=[];var arrLegend=this.initPointAlias(points);var arrSeries=[];for(var i=0;i<points.length;i++){var seriesData={value:tofixed(points[i].data),name:arrLegend[i]};arrSeries.push(seriesData);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimePie.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePie;}();var ModalRealtimeLine=function(){function ModalRealtimeLine(screen,entityParams){if(!entityParams)return;ModalChart.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalRealtimeLine.prototype=new ModalChart();ModalRealtimeLine.prototype.optionTemplate={name:'',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};ModalRealtimeLine.prototype.optionDefault=$.extend(true,{},{grid:ModalChart.prototype.optionDefault.grid,legend:ModalChart.prototype.optionDefault.legend},{tooltip:{trigger:'axis'},legend:{data:[],orient:'horizontal'},toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']}}},calculable:function(){if(AppConfig.isMobile){return false;}else{return true;}}(),color:['#E2583A','#FEC500','#04A0D6','#FD9F08','#1D74A9','#689C0F','#109d83'],xAxis:[{type:'category',boundaryGap:false,splitLine:{show:false},splitArea:{show:false},axisTick:{show:false}}],yAxis:[{type:'value',scale:true,splitLine:{show:function(){if(AppConfig.isMobile){return false;}else{return true;}}()},splitArea:{show:false},axisLabel:{formatter:function formatter(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],series:[{type:'line',symbol:'none',smooth:true}],animation:true});ModalRealtimeLine.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},ModalRealtimeLine.prototype.updateModal=function(points){},ModalRealtimeLine.prototype.showConfigMode=function(){},ModalRealtimeLine.prototype.dealWithData=function(points,dsChartCog){var arr=[],arrLegend=[],arrSeries=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);}
arrLegend=this.initPointAlias(points.list);for(var i=0;i<points.list.length;i++){var dataList=[];for(var j in points.list[i].data){if(typeof points.list[i].data[j]==='number'){dataList.push(points.list[i].data[j].toFixed(accuracy));}}
var series={name:arrLegend[i],type:this.entity.modal.option.showType?this.entity.modal.option.showType:'line',symbol:'none',smooth:true,data:dataList,z:3,itemStyle:{normal:{label:{show:false,position:'top',formatter:'{b}\n{c}'},barBorderRadius:[5,5,0,0]}}};arrSeries.push(series);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimeLine.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimeLine;}();var modalRealtimeBar=function(){function modalRealtimeBar(screen,entityParams){if(!entityParams)return;ModalChart.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};modalRealtimeBar.prototype=new ModalChart();modalRealtimeBar.prototype.optionTemplate={parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};modalRealtimeBar.prototype.optionDefault=$.extend(true,{},{grid:ModalChart.prototype.optionDefault.grid,legend:ModalChart.prototype.optionDefault.legend},{tooltip:{trigger:'item'},calculable:function(){if(AppConfig.isMobile){return false;}else{return true;}}(),xAxis:[{type:'category',show:true,splitLine:{show:false},splitArea:{show:false},axisTick:{show:false}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:function(){if(AppConfig.isMobile){return false;}else{return true;}}()},axisLabel:{formatter:function formatter(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true});modalRealtimeBar.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},modalRealtimeBar.prototype.updateModal=function(points){},modalRealtimeBar.prototype.showConfigMode=function(){},modalRealtimeBar.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return modalRealtimeBar;}();var ModalRealtimeBarEnegBrkd=function(){function ModalRealtimeBarEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;modalRealtimeBar.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimeBarEnegBrkd.prototype=new modalRealtimeBar();ModalRealtimeBarEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_BAR_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeBarEnegBrkd'};ModalRealtimeBarEnegBrkd.prototype.renderModal=function(){},ModalRealtimeBarEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){this.lastRenderTime=now;var _this=this;var dsChartCog=this.entity.modal.dsChartCog;var entityItem=dealWithData(points,dsChartCog);var optionDefault={tooltip:{trigger:'item'},toolbox:{show:false},calculable:true,xAxis:[{type:'category',show:true}],yAxis:[{type:'value',show:true}],series:[{type:'bar',itemStyle:{normal:{color:function color(params){var colorList=['#C1232B','#B5C334','#FCCE10','#E87C25','#27727B','#FE8463','#9BCA63','#FAD860','#F3A43B','#60C0DD','#D7504B','#C6E579','#F4E001','#F0805A','#26C0C0'];return colorList[params.dataIndex];},label:{show:true,position:'top',formatter:'{c}'}}},barMaxWidth:80}]};var entityData={xAxis:[{data:entityItem[0]}],series:[{data:entityItem[1],markPoint:{data:entityItem[2]}}]};this.dsChartCog(dsChartCog,entityData);!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption($.extend(true,{},this.optionDefault,optionDefault,entityData));}
function dealWithData(points,dsChartCog){var arr=[],arrXAxis=[],arrData=[],arrMpData=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);};arrXAxis=_this.initPointAlias(points);for(var i=0,temp;i<points.length;i++){temp=points[i];arrData.push(tofixed(temp.data,accuracy));arrMpData.push({xAxis:i,value:tofixed(temp.data,accuracy),name:arrXAxis[i],symbol:'none'});}
arr.push(arrXAxis);arr.push(arrData);arr.push(arrMpData);return arr;}},ModalRealtimeBarEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimeBarEnegBrkd;}();var ModalRealtimeBarSub=function(){function ModalRealtimeBarSub(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;modalRealtimeBar.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalRealtimeBarSub.prototype=new modalRealtimeBar();ModalRealtimeBarSub.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_BAR',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeBarSub'};ModalRealtimeBarSub.prototype.renderModal=function(){},ModalRealtimeBarSub.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var pointNameList=function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId);}
return arr;}(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date();_this.optionDefault.animation=true;}else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime);_this.optionDefault.animation=false;}
if(!this.entity.modal.option)this.entity.modal.option={};if(!this.entity.modal.option.timeFormat){this.entity.modal.option.timeFormat='h1';}
if(this.entity.modal.option.timeFormat==='m1'||this.entity.modal.option.timeFormat==='m5'||this.entity.modal.option.timeFormat==='h1'){var startTime=new Date(endTime-86400000);}else if(this.entity.modal.option.timeFormat==='d1'){var startTime=new Date(endTime-2592000000);}else if(this.entity.modal.option.timeFormat==='M1'){var startTime=new Date(endTime-31536000000);}
this.lastRenderTime=now;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime.format('yyyy-MM-dd HH:mm:ss'),timeEnd:endTime.format('yyyy-MM-dd HH:mm:ss'),timeFormat:_this.entity.modal.option.timeFormat}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10},xAxis:_this.coordinate(dataSrc.timeShaft),yAxis:[{}],toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']}}},series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,entityData));}).error(function(e){}).always(function(e){});}},ModalRealtimeBarSub.prototype.dealWithData=function(points,dsChartCog){var arr=[],arrLegend=[],arrSeries=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);}
arrLegend=this.initPointAlias(points.list);for(var i=0;i<points.list.length;i++){var key=points.list[i].dsItemId,dataList=[];for(var j in points.list[i].data){dataList.push(points.list[i].data[j].toFixed(accuracy));}
var series={name:arrLegend[i],type:'bar',symbol:'none',smooth:true,data:dataList,itemStyle:{normal:{label:{show:false,position:'top',formatter:'{b}\n{c}'},barBorderRadius:[5,5,0,0]}}};arrSeries.push(series);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimeBarSub.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeBarSub.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalRealtimeBarSub;}();var ModalRealtimePieEnegBrkd=function(){function ModalRealtimePieEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimePie.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimePieEnegBrkd.prototype=new ModalRealtimePie();ModalRealtimePieEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_PIE_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimePieEnegBrkd'};ModalRealtimePieEnegBrkd.prototype.renderModal=function(){};ModalRealtimePieEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){this.lastRenderTime=now;var entityItem=this.dealWithData(points,4);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10,top:20},series:[{data:entityItem[1]}]};this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},this.optionDefault,entityData));}},ModalRealtimePieEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePieEnegBrkd;}();var ModalRealtimeLineOutdoor=function(){function ModalRealtimeLineOutdoor(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalRealtimeLineOutdoor.prototype=new ModalRealtimeLine();ModalRealtimeLineOutdoor.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_LINE_OUTDOOR',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeLineOutdoor'},ModalRealtimeLineOutdoor.prototype.renderModal=function(){this.updateModal();};ModalRealtimeLineOutdoor.prototype.updateModal=function(points){var pointNameList=[];if(!points&&this.entity.modal.points){if(this.entity.modal.points[0]instanceof Array){pointNameList=this.entity.modal.points[0];}else{pointNameList=this.entity.modal.points;}}else{points&&points.length>0&&(pointNameList=function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId);}
return arr;}(points));}
if(pointNameList.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var endTime,startTime;if(!_this.m_bIsGoBackTrace){endTime=new Date();_this.optionDefault.animation=true;}else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime);_this.optionDefault.animation=false;}
if(!this.entity.modal.option)this.entity.modal.option={};if(!this.entity.modal.option.timeFormat){this.entity.modal.option.timeFormat='h1';}
if(this.entity.modal.option.timeFormat==='m1'||this.entity.modal.option.timeFormat==='m5'||this.entity.modal.option.timeFormat==='h1'){startTime=new Date(endTime-86400000);}else if(this.entity.modal.option.timeFormat==='d1'){startTime=new Date(endTime-2592000000);}else if(this.entity.modal.option.timeFormat==='M1'){startTime=new Date(endTime-31536000000);}
this.lastRenderTime=now;this.getData({dsItemIds:pointNameList,timeFormat:this.entity.modal.option.timeFormat}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10},xAxis:_this.coordinate(dataSrc.timeShaft),yAxis:[{}],series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,entityData));}).error(function(e){}).always(function(e){});}},ModalRealtimeLineOutdoor.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeLineOutdoor.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};ModalRealtimeLineOutdoor.prototype.modalInit=function(){var _this2=this;!this.entity.modal.option&&(this.entity.modal.option={});var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,format:this.entity.modal.option.format,recentTime:this.entity.modal.option.recentTime,val:this.entity.modal.option.val,unit:this.entity.modal.option.unit,startTime:this.entity.modal.option.startTime,endTime:this.entity.modal.option.endTime}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]}],result:{func:function func(data){!_this2.entity.modal.option&&(_this2.entity.modal.option={});_this2.entity.modal.option.mode=data.mode;_this2.entity.modal.option.format=data.format;if(data.mode==='1'){_this2.entity.modal.option.startTime=data.startTime;_this2.entity.modal.option.endTime=data.endTime;}else if(data.mode==='2'){_this2.entity.modal.option.unit=data.unit;_this2.entity.modal.option.val=data.val;}
_this2.entity.modal.option.recentTime=data.recentTime;_this2.entity.modal.option.showType=data.selChartType.val;_this2.entity.modal.points=data.points[0];_this2.lastRenderTime=null;_this2.setModalOption();_this2.updateModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalRealtimeLineOutdoor;}();var ModalRealtimeGauge=function(){function ModalRealtimeGauge(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalRealtimeGauge.prototype=new ModalBase();ModalRealtimeGauge.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_GAUGE',parent:0,mode:['gauge'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeGauge'};ModalRealtimeGauge.prototype.optionDefault={tooltip:{formatter:"{c}"},animation:true,animationDuration:1000,animationDurationUpdate:1000,series:[{name:'PUE',type:'gauge',splitNumber:10,axisLine:{show:true,lineStyle:{width:8}},axisTick:{show:true,splitNumber:5,length:15,lineStyle:{width:1,type:'solid',color:'auto'}},axisLabel:{textStyle:{color:'auto'},formatter:function formatter(v){return v.toFixed(2);}},splitLine:{show:true,length:20,lineStyle:{color:'auto'}},pointer:{width:5},detail:{formatter:'{value}',textStyle:{fontSize:12}}}]};ModalRealtimeGauge.prototype.renderModal=function(){},ModalRealtimeGauge.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var scaleList=[];for(var i=0;i<_this.entityOption.scaleList.length;i++){scaleList.push(_this.entityOption.scaleList[i]);}
var colorList=['#1abc9c','#3598db','#e84c3d'];if(scaleList[scaleList.length-1]<scaleList[0]){scaleList.reverse();colorList=['#e84c3d','#3598db','#1abc9c'];}
this.optionDefault.series[0].max=scaleList[scaleList.length-1];this.optionDefault.series[0].min=scaleList[0];this.optionDefault.series[0].data=[{value:parseFloat(points[0].data).toFixed(2)}];this.optionDefault.series[0].axisLine.lineStyle.color=function(option){var arr=[],colorIndex=0;for(var i=0;i<option.length;i++){if(i==0){continue;}
arr.push([((option[i]-option[0])/(_this.optionDefault.series[0].max-_this.optionDefault.series[0].min)).toFixed(3),colorList[colorIndex]]);colorIndex++;}
return arr;}(scaleList);!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption(this.optionDefault);},ModalRealtimeGauge.prototype.showConfigMode=function(){},ModalRealtimeGauge.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.scaleList=option.scaleList;this.entity.modal.interval=5;};return ModalRealtimeGauge;}();function tofixed(str,accuracy){if(!accuracy)accuracy=2;return parseFloat(str).toFixed(accuracy);}
var ModalHistoryChart=function(){function ModalHistoryChart(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalHistoryChart.prototype=new ModalChart();ModalHistoryChart.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChart'};ModalHistoryChart.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:true},grid:function(){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:40,top:40};if(AppConfig.isMobile){grid.x=40;}
return grid;}(),xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:function(){if(AppConfig.isMobile){return false;}else{return true;}}()},axisLabel:{formatter:function formatter(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true};ModalHistoryChart.prototype.renderModal=function(){!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var _this=this;if(!_this.m_bIsGoBackTrace){_this.optionDefault.animation=true;}
this.getData().done(function(dataSrc){if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var option=_this.initOption(dataSrc);if(undefined==option||undefined==option.series[0].data||0==option.series[0].data.length){return;}
var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChart.prototype.updateModal=function(options){},ModalHistoryChart.prototype.showConfigMode=function(){},ModalHistoryChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;};ModalHistoryChart.prototype.resize=function(){this.chart&&this.chart.resize();};return ModalHistoryChart;}();var ModalHistoryChartNormal=function(){var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];var m_colorLen=m_color.length;function ModalHistoryChartNormal(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartNormal.prototype=new ModalHistoryChart();ModalHistoryChartNormal.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ENERGY_LINE',parent:1,mode:['easyHistorySelect'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartNormal'};ModalHistoryChartNormal.prototype.initOption=function(dataSrc){if(!dataSrc||!dataSrc.list[0].data){return;}
var xLen=dataSrc.timeShaft.length;var xAxis,format;var arrXAxis=[];if('month'==this.entity.modal.option.timeType||this.entity.modal.option.format==='d1'){format="MM-dd";}else if('week'==this.entity.modal.option.timeType){format="yyyy-MM-dd";}else if('day'==this.entity.modal.option.timeType||this.entity.modal.option.format==='h1'){format="MM-dd HH:00";}else if(this.entity.modal.option.format==='m5'){format="MM-dd HH:mm";}else if(this.entity.modal.option.format==='M1'){format="yyyy-MM";}
for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format(format));}
xAxis=[{type:'category',data:arrXAxis}];var dataName=this.initPointAlias(dataSrc.list);var arrSeries=[];var showColor='#1abd9b';for(var i=0;i<dataSrc.list.length;i++){if(dataSrc.list.length>1){showColor=m_color[i%m_colorLen];}
arrSeries.push({name:dataName[i],type:this.entity.modal.option.showType,data:dataSrc.list[i].data,itemStyle:{normal:{barBorderRadius:[5,5,0,0]},emphasis:{barBorderRadius:[5,5,0,0]}}});}
var dataOption={title:{text:'',subtext:''},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},dataZoom:{show:false},xAxis:xAxis,series:arrSeries};return dataOption;};ModalHistoryChartNormal.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType=option.showType;this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartNormal.prototype.modalInit=function(){var _this2=this;!this.entity.modal.option&&(this.entity.modal.option={});var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,format:this.entity.modal.option.format,recentTime:this.entity.modal.option.recentTime,val:this.entity.modal.option.val,unit:this.entity.modal.option.unit,startTime:this.entity.modal.option.startTime,endTime:this.entity.modal.option.endTime}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]}],result:{func:function func(data){!_this2.entity.modal.option&&(_this2.entity.modal.option={});_this2.entity.modal.option.mode=data.mode;_this2.entity.modal.option.format=data.format;if(data.mode==='1'){_this2.entity.modal.option.startTime=data.startTime;_this2.entity.modal.option.endTime=data.endTime;}else if(data.mode==='2'){_this2.entity.modal.option.unit=data.unit;_this2.entity.modal.option.val=data.val;}
_this2.entity.modal.option.showType=data.selChartType.val;_this2.entity.modal.option.recentTime=data.recentTime;_this2.entity.modal.points=data.points[0];_this2.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalHistoryChartNormal;}();var ModalHistoryChartEnergyConsume=function(){function ModalHistoryChartEnergyConsume(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartEnergyConsume.prototype=new ModalHistoryChart();ModalHistoryChartEnergyConsume.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ENERGY_BAR',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartEnergyConsume'};ModalHistoryChartEnergyConsume.prototype.initOption=function(dataSrc){if(!dataSrc||!dataSrc.list||!dataSrc.list[0]){return;}
var xLen=dataSrc.timeShaft.length;var xAxis,format;var arrXAxis=[];if('month'==this.entity.modal.option.timeType||this.entity.modal.option.format==='d1'){format="MM-dd";}else if('week'==this.entity.modal.option.timeType){format="yyyy-MM-dd";}else if('day'==this.entity.modal.option.timeType||this.entity.modal.option.format==='h1'){format="MM-dd HH:00";}else if(this.entity.modal.option.format==='m5'){format="MM-dd HH:mm";}else if(this.entity.modal.option.format==='M1'){format="yyyy-MM";}
for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format(format));}
xAxis=[{type:'category',data:arrXAxis}];var dataName=this.initPointAlias(dataSrc.list);var arrSeries=[];for(var i=0;i<dataSrc.list.length;i++){if(dataSrc.list.length>1){}
var arrData=[];var hisLen=dataSrc.list[0].data.length;var defVal;var fixNum=0;for(var j=1;j<hisLen;j++){var preVal=dataSrc.list[0].data[j-1];if(0==preVal){arrData.push(0);continue;}
defVal=dataSrc.list[0].data[j]-preVal;if(defVal<100){fixNum=2;}else{fixNum=0;}
arrData.push(parseFloat(defVal.toFixed(fixNum)));}
arrSeries.push({name:dataName[i],type:this.entity.modal.option.showType,data:arrData,itemStyle:{normal:{barBorderRadius:[5,5,5,5]},emphasis:{barBorderRadius:[5,5,5,5]}}});i++;}
var dataOption={title:{text:'',subtext:''},legend:{show:true,data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},dataZoom:{show:false},xAxis:xAxis,series:arrSeries};return dataOption;};ModalHistoryChartEnergyConsume.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='bar';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartEnergyConsume.prototype.modalInit=function(){var _this3=this;!this.entity.modal.option&&(this.entity.modal.option={});var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,format:this.entity.modal.option.format,recentTime:this.entity.modal.option.recentTime,val:this.entity.modal.option.val,unit:this.entity.modal.option.unit,startTime:this.entity.modal.option.startTime,endTime:this.entity.modal.option.endTime}},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]}],result:{func:function func(data){!_this3.entity.modal.option&&(_this3.entity.modal.option={});_this3.entity.modal.option.mode=data.mode;_this3.entity.modal.option.format=data.format;if(data.mode==='1'){_this3.entity.modal.option.startTime=data.startTime;_this3.entity.modal.option.endTime=data.endTime;}else if(data.mode==='2'){_this3.entity.modal.option.unit=data.unit;_this3.entity.modal.option.val=data.val;}
_this3.entity.modal.option.recentTime=data.recentTime;_this3.entity.modal.option.showType='bar';_this3.entity.modal.points=data.points[0];_this3.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalHistoryChartEnergyConsume;}();var ModalHistoryChartYearOnYearLine=function(){var _this;function ModalHistoryChartYearOnYearLine(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigModal=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigModal);this.option=entityParams.option;this.spinner&&this.spinner.spin(this.container);this.store={};this.pointAlias=this.entity.modal.points?AppConfig.datasource.getDSItemById(this.entity.modal.points[0]).alias:'';this.m_bIsGoBackTrace=false;this.m_traceData=undefined;_this=this;!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartYearOnYearLine.prototype=new ModalHistoryChart();ModalHistoryChartYearOnYearLine.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_YEAR_LINE',parent:1,mode:['easyCompareToggle'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartYearOnYearLine'};ModalHistoryChartYearOnYearLine.prototype.optionDefault={tooltip:{trigger:'axis',formatter:function formatter(params){var tar0=params[0];var tar1=params[1];var pointAlias=_this.pointAlias;return pointAlias+' : '+tar0.name+'<br/>'+tar0.seriesName+' : '+tar0.value+'<br/>'+tar1.seriesName+' : '+tar1.value;}},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:false},color:['#E2583A','#FD9F08','#FEC500','#1D74A9','#04A0D6','#689C0F','#109d83'],xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChartYearOnYearLine.prototype.renderModal=function(){var _this=this;!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var hourMilSec=3600000;var dayMilSec=86400000;var startDate=new Date();var endDate=new Date();var tmFlag=new Date();var timeType=_this.entity.modal.option.format?_this.entity.modal.option.format:'h1';if('hour'==_this.entity.modal.option.timeType||'m5'===timeType){startDate.setTime(endDate.getTime()-hourMilSec);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(endDate.getTime());tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}else if('day'==_this.entity.modal.option.timeType||'h1'==timeType){startDate.setTime(endDate.getTime()-dayMilSec);startDate.setHours(0);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(endDate.getTime());tmFlag.setHours(0);tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}else{return;}
var curDate,startTime,endTime;if(!_this.m_bIsGoBackTrace){startTime=startDate.format('yyyy-MM-dd 00:00:00');endTime=endDate.format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('hour'==_this.entity.modal.option.timeType){timeType='m5';startDate.setTime(curDate.getTime()-hourMilSec);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(curDate.getTime());tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}else if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(curDate.getTime()-dayMilSec);startDate.setHours(0);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(curDate.getTime());tmFlag.setHours(0);tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}else{return;}
startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=curDate.format('yyyy-MM-dd HH:mm:ss');}
this.getData({startTime:startTime,endTime:endTime,timeFormat:timeType}).done(function(dataSrc){if(!dataSrc||!dataSrc.list||!dataSrc.list[0]||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var arrXAxis=[];var flagCount=0;var len=dataSrc.timeShaft.length;tmFlag=tmFlag.format('yyyy-MM-dd HH:mm:ss');for(flagCount=0;flagCount<len;flagCount++){if(dataSrc.timeShaft[flagCount]>=tmFlag){break;}}
_this.store.timeShaft=dataSrc.timeShaft.slice(0,flagCount);_this.store.deadline=dataSrc.timeShaft[flagCount-1].toDate().valueOf();var fixNum=0;var setVal;var dataName=[];var arrSeries=[];for(var k=0,lenK=Math.min(flagCount,dataSrc.timeShaft.length);k<lenK;k++){arrXAxis.push(dataSrc.timeShaft[k].toDate().format("HH:mm"));}
var chartType=_this.entity.modal.option.showType?_this.entity.modal.option.showType:'line';var currentCount=0;for(var n=0;n<dataSrc.list.length;n++){var key=dataSrc.list[n].dsItemId;var dataSrc1=[];var dataSrc2=[];var eachName=[];if(1==dataSrc.list.length){dataName.push(I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(I18n.resource.dataSource.TIME_TODAY);eachName.push(I18n.resource.dataSource.TIME_YESTERDAY);eachName.push(I18n.resource.dataSource.TIME_TODAY);}else{dataName.push(key+'_'+I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(key+'_'+I18n.resource.dataSource.TIME_TODAY);eachName.push(key+'_'+I18n.resource.dataSource.TIME_YESTERDAY);eachName.push(key+'_'+I18n.resource.dataSource.TIME_TODAY);}
for(var j=0,len=dataSrc.list[n].data.length;j<len;j++){setVal=dataSrc.list[n].data[j];if(setVal<100){fixNum=2;}else{fixNum=0;}
setVal=parseFloat(setVal.toFixed(fixNum));if(j<flagCount){dataSrc1.push(setVal);}else{dataSrc2.push(setVal);}}
var showColor;var showData;var showMark;for(var i=0;i<2;i++){if(0==i){if(0==currentCount){showColor='#1abd9b';}else{showColor=echarts.config.color[currentCount*2];}
showData=dataSrc1;showMark={data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.MAXIMUM},{type:'min',name:I18n.resource.dashboard.modalHistoryChart.MINIMUM}]};}else if(1==i){if(0==currentCount){showColor='#e74a37';}else{showColor=echarts.config.color[currentCount*2+1];}
showData=dataSrc2;var lastCntX=dataSrc2.length-1;var lastCntY=Number(dataSrc2[lastCntX]);showMark={symbol:'emptyCircle',symbolSize:10,effect:{show:true,shadowBlur:0},itemStyle:{normal:{label:{show:false}},emphasis:{label:{position:'top'}}},data:[{name:'',value:lastCntY,xAxis:lastCntX,yAxis:lastCntY}]};}
arrSeries.push({name:eachName[i],type:chartType,data:showData,itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,0,0]},emphasis:{color:showColor,barBorderRadius:[5,5,0,0]}},symbolSize:3});if(i===1){arrSeries[1].symbol='rect';var blingDot=$.extend(true,{},arrSeries[1]);var seriesOne=arrSeries[1];seriesOne.type='effectScatter';seriesOne.symbolSize=10;seriesOne.symbol='circle';seriesOne.rippleEffect={brushType:'stroke'};seriesOne.itemStyle.normal.shadowBlur=10;var blingDotData=$.extend(true,{},showData);for(var p=0,lens=showData.length;p<lens;p++){if(p<lens-1){showData[p]='-';}}
var blingDotDataArr=[];for(var item in blingDotData){blingDotDataArr.push(blingDotData[item]);}
blingDot.data=showData;arrSeries[1]=blingDot;arrSeries[1].data=blingDotDataArr;arrSeries.push(seriesOne);}
showColor='';}
currentCount++;}
var xAxis=[{type:'category',boundaryGap:false,data:arrXAxis}];var option={title:{text:'',subtext:''},dataZoom:{show:false},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},xAxis:xAxis,series:arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=option.series[i].data[j].toFixed(n);}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}};}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChartYearOnYearLine.prototype.updateModal=function(options){var _this=this;var modalOptions=this.entity.modal.option;var lastIndex,lastTick,nowTick;if(undefined===options||options.length<1||undefined===options[0]){return;}
lastIndex=this.chart.getOption().series[1].data.length-1;lastTick=this.store.timeShaft[lastIndex].toDate().valueOf();nowTick=new Date().valueOf();if(lastTick===undefined)return;if('hour'===modalOptions.timeType){lastTick+=3600000;refreshInterval=300000;}
if('day'===modalOptions.timeType){lastTick+=86400000;refreshInterval=3600000;}else{return;}
if(nowTick<lastTick+refreshInterval)return;var opt=_this.chart.getOption();for(var i=0,len=options.length;i<len;i++){if(options[i].data!==null){opt.series[1].data.push(options[i].data);}}
_this.chart.setOption(opt);var dataSeries=_this.chart.getOption().series;if(dataSeries.length<2){return;}
var temp=dataSeries[1].data;var lastCntX=temp.length-1;var lastCntY=Number(temp[lastCntX]);var showMark={symbol:'emptyCircle',symbolSize:10,effect:{show:true,shadowBlur:0},itemStyle:{normal:{label:{show:false}},emphasis:{label:{position:'top'}}},data:[{name:'',value:lastCntY,xAxis:lastCntX,yAxis:lastCntY}]};_this.chart.addMarkPoint(1,showMark);},ModalHistoryChartYearOnYearLine.prototype.showConfigMode=function(){},ModalHistoryChartYearOnYearLine.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType=option.showType?option.showType:'line';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartYearOnYearLine.prototype.modalInit=function(){var _this4=this;!this.entity.modal.option&&(this.entity.modal.option={});var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:'0',format:'h1',recentTime:'yesterday'}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]}],result:{func:function func(data){!_this4.entity.modal.option&&(_this4.entity.modal.option={});_this4.entity.modal.option.mode=0;_this4.entity.modal.option.format='h1';_this4.entity.modal.option.showType=data.selChartType.val;_this4.entity.modal.option.recentTime='yesterday';_this4.entity.modal.points=data.points[0];_this4.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.modalBody.querySelector('.divMode select').disabled=true;this.configModal.modalBody.querySelector('.divRecentTime select').disabled=true;this.configModal.show();};return ModalHistoryChartYearOnYearLine;}();var ModalHistoryChartYearOnYearBar=function(){var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];function ModalHistoryChartYearOnYearBar(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigModal=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigModal);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;this.option=entityParams.option;this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartYearOnYearBar.prototype=new ModalHistoryChart();ModalHistoryChartYearOnYearBar.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_YEAR_BAR',parent:1,mode:['easyCompare'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartYearOnYearBar'};ModalHistoryChartYearOnYearBar.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:false},xAxis:[{type:'category',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChartYearOnYearBar.prototype.renderModal=function(){var _this=this;!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var dayMilSec=86400000;var startDate=new Date();var endDate=new Date();var startDateZero=new Date();var endDateZero=new Date();var timeType=_this.entity.modal.option.format?_this.entity.modal.option.format:'h1';if('day'==_this.entity.modal.option.timeType||'h1'==timeType){startDate.setTime(endDate.getTime()-dayMilSec);startDateZero.setTime(startDate.getTime());startDateZero.setHours(0);startDateZero.setMinutes(0);startDateZero.setSeconds(0);endDateZero.setTime(endDate.getTime());endDateZero.setHours(0);endDateZero.setMinutes(0);endDateZero.setSeconds(0);}else{return;}
var curDate;if(!_this.m_bIsGoBackTrace){_this.optionDefault.animation=true;}else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(curDate.getTime()-dayMilSec);startDateZero.setTime(startDate.getTime());startDateZero.setHours(0);startDateZero.setMinutes(0);startDateZero.setSeconds(0);endDateZero.setTime(curDate.getTime());endDateZero.setHours(0);endDateZero.setMinutes(0);endDateZero.setSeconds(0);}else{return;}}
this.getData({startTime:startDateZero.format('yyyy-MM-dd HH:mm:ss'),endTime:endDate.format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeType}).done(function(dataSrc){if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var flag1,flag2;var len=dataSrc.timeShaft.length;for(var i=0;i<len;i++){if(dataSrc.timeShaft[i].toDate()>=startDate){flag1=i;break;}}
for(var i=0;i<len;i++){if(dataSrc.timeShaft[i].toDate()>=endDateZero){flag2=i;break;}}
var arrVal1=[];var arrVal2=[];var val1=0;var val2=0;var fixNum1=0;var fixNum2=0;var preVal=0;for(var i=0;i<dataSrc.list.length;i++){for(var j=0,len=dataSrc.list[i].data.length;j<len;j++){if(j==flag1){preVal=dataSrc.list[i].data[0];if(0==preVal){val1=0;}else{val1=dataSrc.list[i].data[j]-preVal;}}else if(j==flag2){preVal=dataSrc.list[i].data[j];if(0==preVal){val2=0;}else{val2=dataSrc.list[i].data[len-1]-preVal;}}}
if(val1<100){fixNum1=2;}else{fixNum1=0;}
if(val2<100){fixNum2=2;}else{fixNum2=0;}
arrVal1.push(parseFloat(val1.toFixed(fixNum1)));arrVal2.push(parseFloat(val2.toFixed(fixNum2)));break;}
var tmFlag=new Date();var arrXAxis=[];tmFlag=tmFlag.format('yyyy-MM-dd HH:mm:ss');for(var flagCount=0;flagCount<len;flagCount++){if(dataSrc.timeShaft[flagCount]>=tmFlag){break;}}
for(var k=0,lenK=Math.min(flagCount,dataSrc.timeShaft.length);k<lenK;k++){arrXAxis.push(dataSrc.timeShaft[k].toDate().format("HH:mm"));}
var xAxis=[{type:'category',boundaryGap:true,data:arrXAxis}];var chartType=_this.entity.modal.option.showType?_this.entity.modal.option.showType:'bar';var dataName=[];dataName.push(I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(I18n.resource.dataSource.TIME_TODAY);var arrSeries=[{name:dataName[0],type:chartType,data:arrVal1,itemStyle:{normal:{color:m_color[2],barBorderRadius:[5,5,0,0]},emphasis:{color:m_color[2],barBorderRadius:[5,5,0,0]}},markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.EnergyConsumption}]}},{name:dataName[1],type:chartType,data:arrVal2,itemStyle:{normal:{color:m_color[1],barBorderRadius:[5,5,0,0]},emphasis:{color:m_color[1],barBorderRadius:[5,5,0,0]}},markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.EnergyConsumption}]}}];var option={title:{text:'',subtext:''},dataZoom:{show:false},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},xAxis:xAxis,series:arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=option.series[i].data[j].toFixed(n);}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}};}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChartYearOnYearBar.prototype.updateModal=function(options){},ModalHistoryChartYearOnYearBar.prototype.showConfigMode=function(){},ModalHistoryChartYearOnYearBar.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='bar';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartYearOnYearBar.prototype.modalInit=function(){var _this5=this;!this.entity.modal.option&&(this.entity.modal.option={});var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:'0',format:'h1',recentTime:'yesterday'}},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]}],result:{func:function func(data){!_this5.entity.modal.option&&(_this5.entity.modal.option={});_this5.entity.modal.option.mode=0;_this5.entity.modal.option.format='h1';_this5.entity.modal.option.recentTime='yesterday';_this5.entity.modal.points=data.points[0];_this5.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.modalBody.querySelector('.divMode select').disabled=true;this.configModal.modalBody.querySelector('.divRecentTime select').disabled=true;this.configModal.show();};return ModalHistoryChartYearOnYearBar;}();var ModalHistoryDataAnalyze=function(){function ModalHistoryDataAnalyze(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.store=[];!AppConfig.datasource&&(AppConfig.datasource={getDSItemById:DataSource.prototype.getDSItemById.bind({m_parent:{store:{dsInfoList:[]}},m_arrCloudTableInfo:[]})});}
ModalHistoryDataAnalyze.prototype=new ModalHistoryChart();ModalHistoryDataAnalyze.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ANALYSE',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryDataAnalyze'};ModalHistoryDataAnalyze.prototype.renderModal=function(){this.container.innerHTML='\
        <div class="ctnTimeConfig"><div class="divTimeConfig clearfix"></div>\
            <!--<div class="divDataConfig"></div>-->\
            <div class="btnTimeConfigGrp">\
            <div class="divConfigConfirm btn btn-primary" i18n="dashboard.modalHistoryDataAnalyze.DATE_CONFIRM">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DATE_CONFIRM+'</div>\
            <div class="divConfigCancel btn btn-default" i18n="dashboard.modalHistoryDataAnalyze.DATE_CANCEL">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DATE_CANCEL+'</div>\
            </div>\
        </div>\
        <div class="btnShowTimeConfig glyphicon glyphicon-cog"></div>\
        <div class="dragTip" i18n="dashboard.modalHistoryDataAnalyze.DRAG_TIP_FOR_CHART">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DRAG_TIP_FOR_CHART+'</div>\
        <div class="divHistoryChart"></div>\
        ';this.container.parentNode.className+=' widgetHistoryAnalyze forDashboard';this.ctnTimeConfig=this.container.querySelector('.ctnTimeConfig');this.divTimeConfig=this.container.querySelector('.divTimeConfig');this.ctnChart=this.container.querySelector('.divHistoryChart');this.createTimeConfig();this.attachEvent();I18n.fillArea($(this.container));};ModalHistoryDataAnalyze.prototype.createTimeConfig=function(){var mode=document.createElement('div');mode.className='divTimeMode';mode.innerHTML='\
        <label i18n="modalConfig.option.LABEL_MODE">'+I18n.resource.modalConfig.option.LABEL_MODE+'</label>\
        <select class="form-control iptTimeMode">\
            <option value="0" i18n="modalConfig.option.MODE_CURRENT">'+I18n.resource.modalConfig.option.MODE_CURRENT+'</option>\
            <option value="1" i18n="modalConfig.option.MODE_RECENT">'+I18n.resource.modalConfig.option.MODE_RECENT+'</option>\
            <option value="2" i18n="modalConfig.option.MODE_FIXED">'+I18n.resource.modalConfig.option.MODE_FIXED+'</option>\
        </select>';this.divTimeConfig.appendChild(mode);this.createTimeRange(0);I18n.fillArea($(this.ctnTimeConfig));};ModalHistoryDataAnalyze.prototype.createTimeRange=function(mode){$(this.divTimeConfig).find('.divTimeInterval').remove();$(this.divTimeConfig).find('.divTimeRange').remove();var divTimeRange=document.createElement('div');divTimeRange.className='divTimeRange form-group';switch(mode){case 0:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <select class="form-control selRecentTimeRange">\
                    <option value="today" i18n="modalConfig.option.PERIOD_DROP_DOWN_TODAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_TODAY+'</option>\
                    <option value="threeDay"  i18n="modalConfig.option.PERIOD_DROP_DOWN_THREE_DAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THREE_DAY+'</option>\
                    <option value="yesterday" selected=""  i18n="modalConfig.option.PERIOD_DROP_DOWN_YESTERDAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_YESTERDAY+'</option>\
                    <option value="thisWeek" i18n="modalConfig.option.PERIOD_DROP_DOWN_THIS_WEEK">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THIS_WEEK+'</option>\
                    <option value="lastWeek" i18n="modalConfig.option.PERIOD_DROP_DOWN_LAST_WEEK">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_LAST_WEEK+'</option>\
                    <option value="thisYear" i18n="modalConfig.option.PERIOD_DROP_DOWN_THIS_YEAR">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THIS_YEAR+'</option>\
                </select>\
                ';break;case 1:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <div class="input-group" style="width:100%">\
                    <input class="iptRecentTimeVal form-control" style="width:60%">\
                    <select class="selRecentTimeUnit form-control" style="width:40%">\
                        <option value="minute" i18n="modalConfig.option.PERIOD_UNIT_MIN">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MIN+'</option>\
                        <option value="hour" i18n="modalConfig.option.PERIOD_UNIT_HOUR">'+I18n.resource.modalConfig.option.PERIOD_UNIT_HOUR+'</option>\
                        <option value="day" i18n="modalConfig.option.PERIOD_UNIT_DAY">'+I18n.resource.modalConfig.option.PERIOD_UNIT_DAY+'</option>\
                        <option value="month" i18n="modalConfig.option.PERIOD_UNIT_MON">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MON+'</option>\
                    </select>\
                </div>\
                ';this.divTimeConfig.insertBefore(this.createTimeInterval('minute'),divTimeRange);var _this=this;$(divTimeRange).find('.selRecentTimeUnit').off('change').on('change',function(e){$(_this.divTimeConfig).find('.divTimeInterval').remove();_this.divTimeConfig.insertBefore(_this.createTimeInterval(e.currentTarget.value),e.currentTarget.parentNode.parentNode);I18n.fillArea($(_this.ctnTimeConfig));});break;case 2:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <div class="input-group">\
                    <input class="form-control form_datetime iptStartTime" size="16" type="text" data-format="yyyy-mm-dd hh:ii" datetimepicker>\
                    <span class="input-group-addon" i18n="modalConfig.option.TIP_RANGE_TO">${I18n.resource.modalConfig.option.TIP_RANGE_TO}</span>\
                    <input class="form-control form_datetime iptEndTime" size="16" type="text" data-format="yyyy-mm-dd hh:ii" datetimepicker>\
                </div>\
                ';this.divTimeConfig.insertBefore(this.createTimeInterval(),divTimeRange);break;default:break;I18n.fillArea($(this.ctnTimeConfig));}};ModalHistoryDataAnalyze.prototype.setFixedRangeInterval=function(interval){var iptStartTime=this.divTimeConfig.querySelector('.iptStartTime');var iptEndTime=this.divTimeConfig.querySelector('.iptEndTime');var format='yyyy-MM-dd HH:mm';var datePikerFormat='yyyy-mm-dd hh:ii';$(iptStartTime).attr('value',new Date().format(format)).datetimepicker({todayBtn:'linked',endTime:new Date(),format:datePikerFormat,autoclose:true,initialDate:new Date().format(format)});$(iptEndTime).attr('value',new Date().format(format)).datetimepicker({todayBtn:'linked',endTime:new Date(),format:datePikerFormat,autoclose:true,initialDate:new Date().format(format)});};ModalHistoryDataAnalyze.prototype.getTimeConfig=function(){var mode=this.divTimeConfig.querySelector('.iptTimeMode').value;var dateTimeRange=this.divTimeConfig.querySelector('.divTimeRange');var dateInterval=$(this.divTimeConfig).find('.divTimeInterval>select')[0];var startTime,endTime,interval,range;var now=new Date();if(mode==0){var timeRangeVal=dateTimeRange.querySelector('.selRecentTimeRange').value;switch(timeRangeVal){case'today':startTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='h1';break;case'threeDay':startTime=new Date(now.getTime()-259200000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='h1';break;case'yesterday':startTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd 00:00:00');endTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd 23:59:59');interval='h1';break;case'thisWeek':startTime=new Date(now.getTime()-604800000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='d1';break;case'lastWeek':var weekVal=DateUtil.getWeekNumber(now);var dateRange=DateUtil.getDateRangeOnWeekNumber(weekVal[0],weekVal[1]-1);startTime=new Date(dateRange[0].getTime()-604800000).format('yyyy-MM-dd 00:00:00');endTime=new Date(dateRange[1].getTime()-604800000).format('yyyy-MM-dd 23:59:59');interval='d1';break;case'thisYear':startTime=new Date(now.getTime()-31536000000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='M1';break;}}else if(mode==1){var dateTimeUnit=dateTimeRange.querySelector('.selRecentTimeUnit').value;var unitTime=0;var dataTimeVal=parseInt(dateTimeRange.querySelector('.iptRecentTimeVal').value);if(isNaN(dataTimeVal))return;switch(dateTimeUnit){case'minute':unitTime=60000;break;case'hour':unitTime=3600000;break;case'day':unitTime=86400000;break;case'month':unitTime=2592000000;break;}
interval=dateInterval.value;startTime=new Date(now.getTime()-unitTime*dataTimeVal).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');}else if(mode==2){interval=dateInterval.value;startTime=new Date(dateTimeRange.querySelector('.iptStartTime').value).format('yyyy-MM-dd HH:mm:ss');endTime=new Date(dateTimeRange.querySelector('.iptEndTime').value).format('yyyy-MM-dd HH:mm:ss');}
return{startTime:startTime,endTime:endTime,interval:interval};};ModalHistoryDataAnalyze.prototype.createTimeInterval=function(unit){var interval=document.createElement('div');interval.className='divTimeInterval';switch(unit){case'minute':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="m1" i18n="modalConfig.option.INTERVAL_MIN1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                </select>\
                ';break;case'hour':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                </select>\
                ';break;case'day':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                </select>\
                ';break;case'month':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                    <option value="M1" i18n="modalConfig.option.INTERVAL_MON1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                </select>\
                ';break;default:interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">${I18n.resource.modalConfig.option.LABEL_INTERVAL}</label>\
                <select class="form-control">\
                    <option value="m1" i18n="modalConfig.option.INTERVAL_MIN1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                    <option value="M1" i18n="modalConfig.option.INTERVAL_MON1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                </select>\
                ';this.setFixedRangeInterval('m1');var _this=this;interval.getElementsByTagName('select')[0].onchange=function(e){_this.setFixedRangeInterval(e.currentTarget.value);};break;}
I18n.fillArea($(this.ctnTimeConfig));return interval;};ModalHistoryDataAnalyze.prototype.chartPreSet=function(){var _this=this;$(this.container).find('.dragTip').hide();var timeConfig=this.getTimeConfig();this.getData({startTime:timeConfig.startTime,endTime:timeConfig.endTime,timeFormat:timeConfig.interval,dsItemIds:_this.store.map(function(pt){return pt.id;})}).done(function(dataSrc){_this.renderChart(dataSrc,timeConfig.interval);});};ModalHistoryDataAnalyze.prototype.renderChart=function(data,interval){var formatDate='';var formatTime='';switch(interval){case'm1':formatTime='HH:mm';break;case'm5':formatTime='HH:mm';break;case'h1':formatTime='HH:mm';break;case'd1':formatDate='MM-dd';break;case'M1':formatDate='yyyy-MM-dd';formatTime='';break;}
var timeInit=data.timeShaft;var timeShaft=[].concat(data.timeShaft);for(var i=0;i<timeShaft.length;i++){if(formatDate&&formatTime){timeShaft[i]=new Date(timeShaft[i]).format(formatDate)+'\n\r'+new Date(timeShaft[i]).format(formatTime);}else if(formatDate){timeShaft[i]=new Date(timeShaft[i]).format(formatDate);}else{timeShaft[i]=new Date(timeShaft[i]).format(formatTime);}}
var dsName='';var legend=[];var series=[];for(var i=0;i<data.list.length;i++){if(data.list[i].data.length==0)continue;dsName=AppConfig.datasource.getDSItemById(data.list[i].dsItemId).alias;this.store[i].name=dsName;legend.push(dsName);series.push({name:dsName,data:data.list[i].data,type:'line',itemStyle:{normal:{color:AppConfig.chartTheme.color[i%7]}}});}
var option={title:{show:false,left:'center',text:I18n.resource.dashboard.modalHistoryDataAnalyze.HISTORY_DATA,textStyle:{color:'#fff'}},legend:{data:legend,padding:2,textStyle:{color:'#fff',fontSize:8,fontWeight:'lighter'},formatter:function formatter(opt){var str='';if(opt.length>10){str=opt.slice(0,5)+'...'+opt.slice(opt.length-5);}else{str=opt;}
return str;},orient:'horizontal',left:'center',top:'10'},grid:{x:45,y:25,x2:25,y2:25},toolbox:{},tooltip:{trigger:'axis',formatter:function formatter(data){var strTip='';strTip+=new Date(timeInit[data[0].dataIndex]).format('yyyy-MM-dd HH:mm')+'</br>';for(var i=0;i<data.length;i++){strTip+=data[i].seriesName+' : '+data[i].data;if(i!=data.length-1){strTip+='</br>';}}
return strTip;}},xAxis:{type:'category',boundaryGap:false,data:timeShaft,axisLine:{lineStyle:{color:'#fff'}}},yAxis:{type:'value',scale:true,axisLabel:{formatter:function formatter(value){var ret;if(value<1000){ret=value;}else if(value<1000000){ret=value/1000+'k';}else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0.8}},axisLine:{lineStyle:{color:'#fff'}}},series:series};var _this=this;var hisChart=echarts.init(this.ctnChart,AppConfig.chartTheme);hisChart.setOption(option);hisChart.on('legendselectchanged',function(params){for(var i=0;i<_this.store.length;i++){if(_this.store[i].name==params.name){_this.store.splice(i,1);series.splice(i,1);legend.splice(i,1);hisChart.setOption(option);break;}}});};ModalHistoryDataAnalyze.prototype.attachEvent=function(){var _this=this;$(this.divTimeConfig).find('.divTimeMode>select').off('change').on('change',function(e){_this.createTimeRange(parseInt(e.currentTarget.value));});var $btnShowTimeConfig=$(this.container.querySelector('.btnShowTimeConfig'));$(_this.ctnTimeConfig).hide();$(this.container).find('.divConfigCancel').off('click').on('click',function(e){$(_this.ctnTimeConfig).hide();$btnShowTimeConfig.show();});$(this.container).find('.divConfigConfirm').off('click').on('click',function(e){$(_this.ctnTimeConfig).hide();$btnShowTimeConfig.show();_this.chartPreSet();});$(this.divTimeConfig).find('.divTimeMode>select').off('change').on('change',function(e){_this.createTimeRange(parseInt(e.currentTarget.value));});$('#paneCenter').off('dragstart').on('dragstart','[data-h5-draggable-node]',function(e){EventAdapter.setData({dsItemId:e.currentTarget.dataset.dsId});});var $ctnChart=$(this.ctnChart);$ctnChart.off('dragover').on('dragover',function(e){e.preventDefault();});$ctnChart.off('dragleave').on('dragleave',function(e){e.preventDefault();});$ctnChart.off('drop').on('drop',function(e){e.preventDefault();var id=EventAdapter.getData().dsItemId;for(var i=0;i<this.store.length;i++){if(this.store[i].id==id){typeof infoBox!='undefined'&&infoBox.alert(I18n.resource.dashboard.modalHistoryDataAnalyze.POINT_EXIST_TIP);return;}}
this.store.push({id:id});this.chartPreSet();});$btnShowTimeConfig.off('click').on('click',function(){$(_this.ctnTimeConfig).show();$btnShowTimeConfig.hide();});};ModalHistoryDataAnalyze.prototype.showConfigMode=function(){};return ModalHistoryDataAnalyze;}();var ModalCarbonFootprint=function(){function ModalCarbonFootprint(containerId,entityParams){ModalBase.call(this,containerId,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.isFirstTime=true;this.widthRuler=undefined;this.$elMask=undefined;this.elPaneValue=undefined;this.elPaneTitle=undefined;this.maxValue=undefined;};ModalCarbonFootprint.prototype=new ModalBase();ModalCarbonFootprint.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CARBON_FOOTPRINT',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:3,minWidth:4,maxHeight:6,maxWidth:12,type:'ModalCarbonFootprint'};ModalCarbonFootprint.prototype.renderModal=function(){if(this.isFirstTime)this.init();},ModalCarbonFootprint.prototype.init=function(){var _this=this;WebAPI.get('/static/scripts/spring/entities/modalCarbonFootprint.html').done(function(resultHTML){_this.container.innerHTML=resultHTML;_this.initStandard();_this.isFirstTime=false;I18n.fillArea($('.divCFTitle').parent());});},ModalCarbonFootprint.prototype.initStandard=function(){$divMain=$(this.container);this.widthRuler=$divMain.find('.cfProcessScale').width();this.$elMask=$divMain.find('.cfProcessMask');this.elPaneValue=document.getElementById('cfFootprintDashboardCurrent');this.elPaneTitle=document.getElementById('divCFTitle');var unitValue=this.entity.modal.option.valueStandard/4;this.maxValue=unitValue*5;var tdScaleNums=this.container.getElementsByClassName('cfProcessScaleNum');for(var i=0,len=tdScaleNums.length;i<len;i++){tdScaleNums[i].textContent=parseInt(unitValue*i).toString();}
$divMain.find('.cfLegendBarWarning').animate({width:this.widthRuler*0.2+'px'},1000);document.getElementById('cfFootprintDashboardStandard').textContent=this.entity.modal.option.valueStandard;},ModalCarbonFootprint.prototype.updateModal=function(points){var value=parseFloat(points[0].data).toFixed(1).toString();this.elPaneValue.textContent=value;this.elPaneTitle.textContent=value;this.$elMask.animate({width:this.widthRuler-value*this.widthRuler/this.maxValue+'px'},1000);},ModalCarbonFootprint.prototype.showConfigMode=function(){};ModalCarbonFootprint.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.valueStandard=3500;};return ModalCarbonFootprint;}();var ModalAppChart=function(){function ModalAppChart(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.dicPeriod={'30s':30000,'m1':60000,'m5':300000,'10m':600000,'30m':1800000,'h1':3600000,'d1':86400000,'M1':2592000000};}ModalAppChart.prototype=new ModalBase();ModalAppChart.prototype.optionTemplate={name:'toolBox.modal.APP_CHART',parent:3,mode:['realTime'],maxNum:10,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalAppChart'};ModalAppChart.prototype.optionDefault={color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500'],title:{textStyle:{fontWeight:'normal',color:'#008acd'}},legend:{textStyle:{fontFamily:"Microsoft YaHei",fontSize:10}},dataRange:{itemWidth:15,color:['#5ab1ef','#e0ffff']},toolbox:{x:'right',y:'center',feature:{mark:{show:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}},color:['#1e90ff','#1e90ff','#1e90ff','#1e90ff'],effectiveColor:'#ff4500'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{color:'#008acd'},crossStyle:{color:'#008acd'},shadowStyle:{color:'rgba(200,200,200,0.2)'}}},dataZoom:{dataBackgroundColor:'#efefff',fillerColor:'rgba(182,162,222,0.2)',handleColor:'#008acd'},grid:function(isMobile){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:50,top:40};if(isMobile){grid.x=40;}return grid;}(AppConfig.isMobile),categoryAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitLine:{lineStyle:{color:['#eee']}}},valueAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']}},splitLine:{lineStyle:{color:['#eee']}}},polar:{axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{lineStyle:{color:'#008acd'},controlStyle:{normal:{color:'#008acd'},emphasis:{color:'#008acd'}},symbol:'emptyCircle',symbolSize:3},bar:{itemStyle:{normal:{barBorderRadius:5},emphasis:{barBorderRadius:5}},barMaxWidth:80},line:{smooth:true,symbol:'none',symbolSize:3},k:{itemStyle:{normal:{color:'#d87a80',color0:'#2ec7c9',lineStyle:{color:'#d87a80',color0:'#2ec7c9'}}}},scatter:{symbol:'circle',symbolSize:4},radar:{symbol:'emptyCircle',symbolSize:3},map:{itemStyle:{normal:{areaStyle:{color:'#ddd'},label:{textStyle:{color:'#d87a80'}}},emphasis:{areaStyle:{color:'#fe994e'}}}},force:{itemStyle:{normal:{linkStyle:{color:'#1e90ff'}}}},chord:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}},emphasis:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}}}},gauge:{axisLine:{lineStyle:{color:[[0.2,'#2ec7c9'],[0.8,'#5ab1ef'],[1,'#d87a80']],width:10}},axisTick:{splitNumber:10,length:15,lineStyle:{color:'auto'}},splitLine:{length:22,lineStyle:{color:'auto'}},pointer:{width:5}},textStyle:{fontFamily:'微软雅黑, Arial, Verdana, sans-serif'}};ModalAppChart.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption(this.options);},ModalAppChart.prototype.updateModal=function(pointName,pointValue){},ModalAppChart.prototype.showConfigMode=function(){},ModalAppChart.prototype.dsChartCog=function(cog,option){if(!cog)return;if(cog[0].upper)option.yAxis[0].max=cog[0].upper;if(cog[0].lower)option.yAxis[0].min=cog[0].lower;if(cog[0].unit)option.yAxis[0].name=cog[0].unit;if(cog[0].markLine){if(!option.series[0].markLine){option.series[0].markLine={};option.series[0].markLine.data=new Array();}for(var i in cog[0].markLine){var markLine=cog[0].markLine[i];if(!markLine.value)continue;var arr=[{name:markLine.name,xAxis:-1,yAxis:markLine.value},{name:markLine.name,xAxis:option.series[0].data.length,yAxis:markLine.value}];option.series[0].markLine.data.push(arr);}}};ModalAppChart.prototype.coordinate=function(e){var arr=[];var endTime=new Date().valueOf();if(e=='m1'){var startTime=endTime-21600000;var interval=60000;while(startTime<=endTime){arr.push(new Date(startTime).format('HH:mm'));startTime+=interval;}}else if(e=='m5'){var startTime=endTime-86100000;var interval=300000;while(startTime<=endTime){arr.push(new Date(startTime-startTime%300000).format('HH:mm'));startTime+=interval;}}else if(e=='h1'){var startTime=endTime-82800000;var interval=3600000;while(startTime<=endTime){arr.push(new Date(startTime).format('HH:00'));startTime+=interval;}}else if(e=='d1'){var startTime=endTime-2592000000;var interval=86400000;while(startTime<=endTime){arr.push(new Date(startTime).format('yyyy-MM-dd'));startTime+=interval;}}else if(e=='M1'){var fullYear=new Date().getFullYear()-1;var month=new Date().getMonth()+1;var interval=1;for(var i=0;i<12;i++){var startTime=fullYear+'-'+month;arr.push(startTime);month=month%12+interval;if(month===1){fullYear+=1;}}}return[{data:arr}];};return ModalAppChart;}();var ModalAppGauge=function(){function ModalAppGauge(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppGauge.prototype=new ModalBase();ModalAppGauge.prototype.optionTemplate={name:'toolBox.modal.APP_GAUGE_CHART',parent:3,mode:['appGauge'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppGauge'};ModalAppGauge.prototype.optionDefault={tooltip:{formatter:"{a} <br/>{b} : {c}"},backgroundColor:'#2f91e8',animation:true,animationDuration:1000,animationDurationUpdate:1000,toolbox:{show:false},title:{show:true,text:'项目实时评估得分',textStyle:{fontWeight:'100',fontFamily:'Microsoft Yahei',fontSize:16,color:'#fff'},x:'center'},series:[{type:'gauge',splitNumber:4,center:['50%','55%'],radius:'75%',startAngle:-270,endAngle:89.9999,axisLine:{show:false,lineStyle:{width:13,opacity:0}},axisTick:{splitNumber:20,length:12,lineStyle:{color:'auto',width:2}},axisLabel:{show:true,textStyle:{color:'#eee'}},splitLine:{show:true,length:12,lineStyle:{width:2,color:'auto'}},pointer:{show:false},itemStyle:{normal:{opacity:0}},title:{show:true,textStyle:{fontWeight:'bolder',color:'white'},offsetCenter:[0,'-40%']},detail:{formatter:'{value}',offsetCenter:['0%','-5%'],textStyle:{color:'#fff',fontSize:36}}}]};ModalAppGauge.prototype.renderModal=function(){},ModalAppGauge.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var dataSeries;if(points[1]){if(points[1].guageTitle){this.optionDefault.title.text=points[1].guageTitle;}var guageFulTitle=points[1].guageFulTitle?points[1].guageFulTitle:'';if(points[1].guageFixed===0||points[1].guageFixed){dataSeries=parseFloat(points[0].data).toFixed(points[1].guageFixed);}else{dataSeries=parseFloat(points[0].data).toFixed(2);}if(parseFloat(points[0].data)>100){this.optionDefault.series[0].max=parseFloat(points[0].data).toFixed(0);this.optionDefault.series[0].formatter=function(v){switch(v+''){case(parseFloat(points[0].data)/4).toFixed(0):return(parseFloat(points[0].data)/4).toFixed(0);case(parseFloat(points[0].data)/2).toFixed(0):return(parseFloat(points[0].data)/2).toFixed(0);case(parseFloat(points[0].data)*3/4).toFixed(0):return(parseFloat(points[0].data)*3/4).toFixed(0);case parseFloat(points[0].data).toFixed(0):return parseFloat(points[0].data).toFixed(0);default:return'';}};}else{this.optionDefault.series[0].max=100;this.optionDefault.series[0].formatter=function(v){switch(v+''){case'25':return'25';case'50':return'50';case'75':return'75';case'0':return'0';default:return'';}};}
if(points[1].guageUnit){this.optionDefault.series[0].detail.formatter='{value}'+points[1].guageUnit;}var guageDirect=points[1].guageDirect?points[1].guageDirect:'';if(guageDirect==='antiClockwise'){this.optionDefault.series[0].startAngle=-270;this.optionDefault.series[0].endAngle=89.9999;}else{this.optionDefault.series[0].startAngle=90;this.optionDefault.series[0].endAngle=-269.9999;}if(points[1].guageBgColor){this.optionDefault.backgroundColor=points[1].guageBgColor;}if(points[1].transDataDot){var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};var currentRGB=points[1].guageBgColor.colorRgb();var rgb=currentRGB.split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var finalRGB='rgba('+r+','+g+','+b+','+points[1].transDataDot+')';this.optionDefault.backgroundColor=finalRGB;}}this.optionDefault.series[0].data=[{value:dataSeries,name:guageFulTitle}];this.optionDefault.series[0].axisLine.lineStyle.color=function(){var arrColor=['tomato','#f7ba49','#11fff1','#89dd4b'];var seriesDataInt=parseInt(dataSeries);var numCount=dataSeries.toString().length;var numCount1=numCount-2<=0?1:numCount-2;var numFinally=Math.pow(10,numCount1);var kpiColor;if(seriesDataInt>100){kpiColor='#89dd4b';}else{kpiColor=arrColor[Math.floor(Math.abs(seriesDataInt-1)/25)];}return[[seriesDataInt/100,kpiColor],[1,'#87a8c5']];}();!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption(this.optionDefault);var spanTime='<span class="spanTime" style="position:absolute;color:#fff">'+new Date().format('yyyy-MM-dd')+'</span>';$(this.container).find('.spanTime').empty().remove();$(this.container).append(spanTime);var timeLocal=points[1].timeLocal?points[1].timeLocal:'leftTop';if(timeLocal){var $spanTimeDom=$(this.container).find('.spanTime');if(timeLocal==='leftTop'){$spanTimeDom.css({'top':'10px','left':'10px'});}else if(timeLocal==='rightTop'){$spanTimeDom.css({'top':'10px','right':'10px'});}else if(timeLocal==='leftBottom'){$spanTimeDom.css({'bottom':'10px','left':'10px'});}else{$spanTimeDom.css({'bottom':'10px','right':'10px'});}}},ModalAppGauge.prototype.showConfigMode=function(){},ModalAppGauge.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.guageTitle=option.guageTitle;this.entity.modal.option.guageFulTitle=option.guageFulTitle;this.entity.modal.option.guageFixed=option.guageFixed;this.entity.modal.option.guageUnit=option.guageUnit;this.entity.modal.option.timeLocal=option.timeLocal;this.entity.modal.option.guageDirect=option.guageDirect;this.entity.modal.option.guageBgColor=option.guageBgColor;this.entity.modal.option.transDataDot=option.transDataDot;this.entity.modal.interval=5;};return ModalAppGauge;}();var ModalAppButton=function(){var _this;function ModalAppButton(screen,entityParams,_renderModal,_updateModal,_showConfigMode){_this=this;if(!screen)return;this.screen=screen;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppButton.prototype=new ModalBase();ModalAppButton.prototype.optionTemplate={name:'toolBox.modal.APP_BUTTON',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:1.5,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppButton'};ModalAppButton.prototype.show=function(){this.init();};ModalAppButton.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalAppButton.prototype.configure=function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}$('#divContainer_'+_this.entity.id).remove();_this.screen.isScreenChange=true;_this=null;});};divMask.appendChild(btnRemove);if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}var btnHeightResize=document.createElement('div');var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};_this.entity.modal.interval='300000';this.container.parentNode.appendChild(divMask);if(this.entity.isNotRender&&this.screen.listEntity){var parentId=undefined,subChartIds;if(this.entity&&this.entity.id){parentId=this.entity.id;}if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}this.divResizeByToolInit();this.executeConfigMode();};ModalAppButton.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();var divAppButton,divIcon,divDetail,spName,spValue,spUnit;var $springContentCur=$(this.container);$springContentCur.css("overflow","auto");var appButtonArr=_this.entity.modal.option.appButton;var len=appButtonArr.length;var staticColor=['#5A95F7','#FBDE54','#89D164','#89D164','#5A95F7','#23D29C'];for(var i=0;i<len;i++){divAppButton=document.createElement('div');divAppButton.className='divAppButton';if(appButtonArr[i].link!==''){divAppButton.setAttribute('data-link-to',appButtonArr[i].link);}if(appButtonArr[i].linkType!==''){divAppButton.setAttribute('data-type',appButtonArr[i].linkType);}$(divAppButton).on('tap',function(){var triggerId=$(this).attr('data-link-to');var dataType=$(this).attr('data-type');var linkName=$(this).find('.divMonitorInfo .spName').text();if(!triggerId)return;if(!AppConfig.isMobile){ScreenManager.show(EnergyScreen,triggerId);}else{var isIndex=dataType=='EnergyScreen_M';router.to({typeClass:ProjectDashboard,data:{menuId:triggerId,isIndex:isIndex,name:linkName}});}});switch(len){case 1:divAppButton.className+=' divAppButtonOne col-xs-6 zepto-ev';break;case 2:divAppButton.className+=' divAppButtonTwo col-xs-6 zepto-ev';break;case 3:divAppButton.className+=' divAppButtonThree col-xs-4 zepto-ev';break;case 4:divAppButton.className+=' divAppButtonFour col-xs-6 zepto-ev';break;case 5:divAppButton.className+=' divAppButtonFive col-xs-4 zepto-ev';break;case 6:divAppButton.className+=' divAppButtonSix col-xs-4 zepto-ev';break;default:divAppButton.className+=' divAppButtonSix col-xs-4 zepto-ev';break;}divIcon=document.createElement('div');divIcon.className='divIcon '+appButtonArr[i].icon;if(appButtonArr[i].icon)divIcon.style.color=appButtonArr[i].iconColor;divDetail=document.createElement('div');divDetail.className='divMonitorInfo';spName=document.createElement('span');spName.className='spName';spName.textContent=appButtonArr[i].name;if(appButtonArr[i].backColor==""){divIcon.style.background=staticColor[i];}else{divIcon.style.background=appButtonArr[i].backColor;}divDetail.appendChild(spName);divAppButton.appendChild(divIcon);divAppButton.appendChild(divDetail);_this.container.appendChild(divAppButton);}if($springContentCur.height()<200){$springContentCur.find('.divIcon').addClass('divIconLittle');$springContentCur.find('.divMonitorInfo').addClass('divMonitorInfoLit');}else{$springContentCur.find('.divIcon').removeClass('divIconLittle');$springContentCur.find('.divMonitorInfo').removeClass('divMonitorInfoLit');}};ModalAppButton.prototype.showConfigMode=function(){};ModalAppButton.prototype.showConfigModal=function(){_this.tempOpt=$.extend(true,{},this.entity.modal);var configModalTpl='\
                <div id="ModalAppButtonConfig" class="modal fade"  role="dialog" aria-labelledby="ttlNodeTool">\
                    <div class="modal-dialog">\
                        <div class="modal-content">\
                            <div class="modal-header">\
                                <span id="btnMonitorAdd" class="glyphicon glyphicon-plus-sign btnMonitorAdd grow"></span>\
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                                <h4 class="modal-title" id="ttlNodeTool">Diagnosis Edit</h4>\
                            </div>\
                            <div class="modal-body gray-scrollbar" id="ctnMonitor">\
                            </div>\
                            <div class="modal-footer">\
                                <input type ="color">\
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
                                <button type="button" class="btn btnSure btn-primary">Save</button>\
                            </div>\
                        </div>\
                    </div>\
                </div>';_this.$configModal=$('#ModalAppButtonConfig');if(_this.$configModal.length==0)_this.$configModal=$(configModalTpl);_this.$configModal.appendTo($(_this.container).parentsUntil('.springContainer').parent().parent());var $ctnMonitor=_this.$configModal.find('#ctnMonitor').html('');var btnAdd=_this.$configModal.find('#btnMonitorAdd')[0];btnAdd.title='Monitor Type Add';btnAdd.onclick=function(){$ctnMonitor.append(_this.createDivMonitor());_this.attachMonitorEvent();};if(this.entity.modal.option&&this.entity.modal.option.appButton&&this.entity.modal.option.appButton.length>0){for(var i=0;i<this.entity.modal.option.appButton.length;i++){if(this.entity.modal.option.appButton[i].entityId===this.entity.id){$ctnMonitor[0].appendChild(_this.createDivMonitor(this.entity.modal.option.appButton[i]));}}}else{$ctnMonitor[0].appendChild(_this.createDivMonitor());}_this.$configModal.modal('show');_this.$configModal.find('.btnSure').off('click').on('click',function(){if(_this.tempOpt.option.appButton&&_this.tempOpt.option.appButton.length>0){var appButtonArr=_this.tempOpt.option.appButton;for(var i=0;i<appButtonArr.length;i++){if(!appButtonArr[i].entityId){appButtonArr[i].entityId=_this.entity.id;}}}_this.entity.modal=$.extend(true,{},_this.tempOpt);_this.$configModal.modal('hide');});_this.attachMonitorEvent();};ModalAppButton.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalAppButton.prototype.close=function(){_this.entity=null;this.entity=null;};ModalAppButton.prototype.createDivMonitor=function(opt){var divMonitor=document.createElement('div');divMonitor.className='divMonitor';var $divMonitor=$(divMonitor);divMonitor.innerHTML='\
            <div class="divIcon"></div>\
            <div class="divMonitorInfo">\
                <div class="divName">\
                    <label>name:</label>\
                    <span class="spName"></span>\
                    <input class="iptName form-control" ></input>\
                </div>\
                <div class="divLink">\
                    <label>link:</label>\
                    <select class="form-control linkList"></select>\
                </div>\
            </div>\
            <div class="divMonitorDel glyphicon glyphicon-remove-circle"></div>';var $linkList=$divMonitor.find('select.linkList');$linkList[0].options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,''));if(AppConfig.menu.length>0){for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);if(opt&&opt.link&&opt.link==i){option.selected='selected';}$linkList[0].options.add(option);}}else{if(_this.screen.facScreen){var pageDataMenus=_this.screen.facScreen.pagePanel.getPageList();for(var i=0;i<pageDataMenus.length;i++){var option=new Option(pageDataMenus[i].text,pageDataMenus[i]._id);$(option).attr('data-type',pageDataMenus[i].type);if(opt&&opt.link&&opt.link==pageDataMenus[i]._id){option.selected='selected';}$linkList[0].options.add(option);}}}$linkList[0].onchange=function(){var index=$('#ctnMonitor').children().index($divMonitor);_this.tempOpt.option.appButton[index].link=$linkList[0].value;_this.tempOpt.option.appButton[index].linkType=$(this).find('option:selected').attr('data-type');};if(opt&&opt.icon){$divMonitor.find('.divIcon').addClass(opt.icon);if(opt.iconColor)$divMonitor.find('.divIcon').css({'color':opt.iconColor,'box-shadow':'0 0 15px '+opt.iconColor});}else{$divMonitor.find('.divIcon').addClass('glyphicon glyphicon-plus').css('color','black');}if(opt&&opt.name){$divMonitor.find('.spName').show().text(opt.name);$divMonitor.find('.iptName').hide().val(opt.name);}else{$divMonitor.find('.spName').hide();$divMonitor.find('.iptName').show();}if(opt&&opt.backColor){$divMonitor.css('background',opt.backColor);}
if(!opt){if(!_this.tempOpt.option){_this.tempOpt.option={};}if(!_this.tempOpt.option.appButton){_this.tempOpt.option.appButton=[];}_this.tempOpt.option.appButton.push({icon:'glyphicon glyphicon-plus',iconColor:'#000000',name:'',link:'',backColor:'',linkType:''});}return divMonitor;};ModalAppButton.prototype.attachMonitorEvent=function(){var $ctnMonitor=_this.$configModal.find('#ctnMonitor');var $iptColor;var indexDivMonitor;$ctnMonitor.find(".divMonitor").off('click').on('click',function(){var currentBg=$(this).css('background');$ctnMonitor.find(".divMonitor").css("border","1px dotted");indexDivMonitor=$ctnMonitor.find(".divMonitor").index($(this));$(this).css("border","1px solid black");});$(".modal-footer").find("input").off("change").on("change",function(){var colorVal=$(this).val();var rgb=colorVal.colorRgb().split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var hsl=rgbToHsl(r,g,b);var hslEndL=hsl[2]+0.05;var rgbStartColor=hslToRgb(hsl[0],hsl[1],hsl[2]);var rgbEndColor=hslToRgb(hsl[0],hsl[1],hslEndL);var backColor='-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(rgb('+rgbStartColor[0]+','+rgbStartColor[1]+','+rgbStartColor[2]+')), to(rgb('+rgbEndColor[0]+','+rgbEndColor[1]+','+rgbEndColor[2]+'))';if(indexDivMonitor!==0){if(!indexDivMonitor)return;}_this.tempOpt.option.appButton[indexDivMonitor].backColor=colorVal;$ctnMonitor.find(".divMonitor").eq(indexDivMonitor).css("background",colorVal);});var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6;}return[h,s,l];}function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var hue2rgb=function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
$(".divMonitor").on('click','.divIcon',function(e){e.stopPropagation();$('#ctnMonitor .divMonitor.selected').removeClass('selected');var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').addClass('selected');var index=$ctnMonitor.children().index($divMonitor);if(_this.$modal){_this.$modal.modal('show');$iptColor=_this.$modal.find('#iptColorSel');if(_this.tempOpt.option.appButton[index].iconColor){$iptColor.val(_this.tempOpt.option.appButton[index].iconColor);}if(_this.tempOpt.option.appButton[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option.appButton[index].icon.split(' ')[1]).parent().addClass('selected');}}else{WebAPI.get('static/scripts/spring/entities/modalMonitor.html').done(function(resultHTML){_this.$modal=$(resultHTML);$iptColor=_this.$modal.find('#iptColorSel');_this.$modal.modal('show');if(_this.tempOpt.option.appButton[index].iconColor){_this.$modal.find('#iptColorSel').val(_this.tempOpt.option.appButton[index].iconColor);}if(_this.tempOpt.option.appButton[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option.appButton[index].icon.split(' ')[1]).parent().addClass('selected');}_this.$modal.find('.bs-glyphicons-list>li').click(function(e){if($(e.currentTarget).hasClass('selected'))return;$('.bs-glyphicons-list>li.selected').removeClass('selected');$(e.currentTarget).addClass('selected');});_this.$modal.find('.btnSure').click(function(e){e.stopPropagation();var $divMonitor=$('#ctnMonitor .divMonitor.selected');var index=$ctnMonitor.children().index($divMonitor);var icon=$('.bs-glyphicons-list>li.selected>.glyphicon-class').text();_this.tempOpt.option.appButton[index].icon=icon;_this.tempOpt.option.appButton[index].iconColor=$iptColor.val();$divMonitor.find('.divIcon')[0].className='divIcon '+icon;$divMonitor.find('.divIcon').css({'color':$iptColor.val(),'box-shadow':'0 0 15px '+$iptColor.val()});_this.tempOpt.option.appButton[index].entityId=_this.entity.id;_this.$modal.modal('hide');});});}});$(".divMonitor").on('click','.divMonitorDel',function(e){var index=$ctnMonitor.children().index($(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor'));$ctnMonitor.children().eq(index).remove();_this.tempOpt.option.appButton.splice(index,1);_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}});$(".divMonitor").on('click','.spName',function(e){$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptName').show().focus();});$ctnMonitor.off('blur').on('blur','input',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();if($(e.currentTarget).hasClass('iptName')){_this.tempOpt.option.appButton[index].name=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spName').text(value).show();}_this.tempOpt.option.appButton[index].entityId=_this.entity.id;});$ctnMonitor.find('.linkList').off('change').on('change',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();_this.tempOpt.option.appButton[index].entityId=_this.entity.id;if($(e.currentTarget).hasClass('linkList')){_this.tempOpt.option.appButton[index].link=value;if(!value)return;}});};return ModalAppButton;}();var ModalAppHistory=function(){function ModalAppHistory(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.attachEvent();};ModalAppHistory.prototype=new ModalBase();ModalAppHistory.prototype.optionTemplate={name:'toolBox.modal.APP_HISTORY_QUERY',parent:3,mode:['appGauge'],maxNum:1,title:'',minHeight:4,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppHistory',scroll:false};ModalAppHistory.prototype.optionDefault={title:{text:"1"},color:['rgb(250,214,74)'],tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:[]},grid:{left:'3%',right:'4%',bottom:'3%',containLabel:true},xAxis:[{type:'category',axisTick:{alignWithLabel:true},data:['Mon','Tue','Wed','Thu','Fri','Sat','Sun']}],yAxis:[{type:'value'}],series:[{name:'直接访问',type:'bar',barWidth:'60%',data:0}]};ModalAppHistory.prototype.renderPreviewModal=function(points){var _this=this;var pointsId=[];var pointsData=[];for(var i=0,length=points.length;i<length;i++){pointsId.push(points[i].dsItemId);pointsData.push(points[i].data);}
WebAPI.post('/analysis/datasource/getDsItemsById',pointsId).done(function(result){if($(_this.container).find(".listDataBox").html()===""){for(var j=0,jLength=result.length;j<jLength;j++){if(j===0){var singlePointer='<div class="singleContent activeSingle" data-id='+result[j].id+'>\
                                            <div class="singleTitle">'+result[j].alias+'</div>\
                                            <div class="singleValue">'+Number(pointsData[j]).toFixed(2)+'</div>\
                                        </div>';}else{var singlePointer='<div class="singleContent" data-id='+result[j].id+'>\
                                            <div class="singleTitle">'+result[j].alias+'</div>\
                                            <div class="singleValue">'+Number(pointsData[j]).toFixed(2)+'</div>\
                                        </div>';}$(singlePointer).appendTo($(_this.container).find(".listDataBox"));}}else{var $list=$(_this.container).find(".singleContent");$list.each(function(){var index=$list.index($(this));$(this).find(".singleValue").text(Number(pointsData[index]).toFixed(2));});}var $allSingleContent=$(_this.container).find(".singleContent");var sumWidth=0;$allSingleContent.each(function(){sumWidth+=$(this).width()+5;});$(_this.container).find(".listDataBox").width(sumWidth);});if($(_this.container).find("#bottomPoints").length===0){var content='<div id="bottomPoints">\
                        </div>\
                        <div id="bottomSearchHistory">\
                            <div class="bottomTitle">历史查询</div>\
                            <div class="bottomContent">\
                                <div class="clearfix hisCommenBox">\
                                    <div class="col-xs-4 hisCommen">采样周期</div>\
                                    <select class="col-xs-6 hisCommen" id="timePeriod" value="h1">\
                                        <option value="m5">5分钟</option>\
                                        <option value="h1">1小时</option>\
                                        <option value="d1">1天</option>\
                                        <option value="M1">1月</option>\
                                    </select>\
                                </div>\
                                <div class="clearfix hisCommenBox">\
                                    <div class="col-xs-4 hisCommen">开始时间</div>\
                                    <div class="input-append date col-xs-8">\
                                        <input id="datetimepickerStarts" class="form_datetime hisCommen" data-date="12-02-2012" type="text" readonly />\
                                        <span class="add-on"><i class="icon-th"></i></span>\
                                    </div>\
                                </div>\
                                <div class="clearfix hisCommenBox">\
                                    <div class="col-xs-4 hisCommen">结束时间</div>\
                                    <div class="input-append date col-xs-8">\
                                        <input id="datetimepickerEnds" class="form_datetime hisCommen" data-date="12-02-2012" type="text" readonly />\
                                        <span class="add-on"><i class="icon-th"></i></span>\
                                    </div>\
                                </div>\
                                <div class="text-center">\
                                    <button class="btnQuery" id="btnQuery"><span>查询</span></button>\
                                </div>\
                            </div>\
                        </div>';$(_this.container).find(".bottomBox").html(content);var nowDate=new Date();var endTime=nowDate.timeFormat(timeFormatChange('yyyy-mm-dd hh:ii:ss'));var startTime=nowDate.timeFormat(timeFormatChange("yyyy-mm-dd"))+' 00:00:00';var $datetimepickerStart=$(_this.container).find('#datetimepickerStarts');var $datetimepickerEnd=$(_this.container).find('#datetimepickerEnds');$datetimepickerStart.val(startTime);$datetimepickerEnd.val(endTime);$datetimepickerStart.datetimepicker({format:timeFormatChange("yyyy-mm-dd")+' 00:00:00',pickerPosition:'bottom-left',pickerReferer:'input',startView:2,minView:2,autoclose:true,forceParse:false});$datetimepickerEnd.datetimepicker({format:timeFormatChange('yyyy-mm-dd hh:ii:ss'),pickerPosition:'bottom-right',pickerReferer:'input',startView:2,minView:2,autoclose:true,forceParse:false});}},ModalAppHistory.prototype.updateModal=function(points){this.renderPreviewModal(points);},ModalAppHistory.prototype.renderModal=function(id,startTime,endTime,tPeriod){if($(this.container).find(".middlePointers").length===0&&$(this.container).find(".bottomBox").length===0&&$(this.container).find("#chartBox").length===0){var $middlePointers=$('<div class="middlePointers gray-scrollbar"><div class="listDataBox"></div></div>');$middlePointers.appendTo(this.container);var $bottomBox=$('<div class="bottomBox" style="height:40%"></div>');$bottomBox.appendTo(this.container);var $chartBox=$('<div id="chartBox" style="height:235px"></div>');$middlePointers.before($chartBox);}var _this=this;var todayEndTime=new Date().format('yyyy-MM-dd HH:mm:ss');var todayStartTime=new Date().format("yyyy-MM-dd 00:00:00");var id=id===undefined?this.entity.modal.points:[id];var startTime=startTime===undefined?todayStartTime:startTime;var endTime=endTime===undefined?todayEndTime:endTime;var tPeriod=tPeriod===undefined?'h1':tPeriod;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:id,timeStart:startTime,timeEnd:endTime,timeFormat:tPeriod}).done(function(dataSrc){var dataArr;var time=dataSrc.timeShaft;if($("#chartBox").html()===""){WebAPI.post('/analysis/datasource/getDsItemsById',id).done(function(result){for(var i=0,length=dataSrc.list.length;i<length;i++){dataArr=dataSrc.list[0].data;_this.optionDefault.title.text=result[0].alias;_this.optionDefault.series[0].name=result[0].alias;_this.optionDefault.legend.data[0]=result[0].alias;}_this.optionDefault.series[0].data=dataArr;_this.optionDefault.xAxis[0].data=time;var $chartContainer=$(_this.container).find("#chartBox");!_this.chart&&(_this.chart=echarts.init($chartContainer[0],AppConfig.chartTheme));_this.chart.setOption(_this.optionDefault);_this.spinner&&_this.spinner.stop();});}else{var $firstSelected=$(_this.container).find(".activeSingle");var singlePointerId=$firstSelected.attr("data-id");var singlePointerTitle=$firstSelected.find(".singleTitle").text();for(var i=0,length=dataSrc.list.length;i<length;i++){if(dataSrc.list[i].dsItemId===singlePointerId){var dataArr=dataSrc.list[i].data;_this.optionDefault.title.text=singlePointerTitle;_this.optionDefault.series[0].name=singlePointerTitle;_this.optionDefault.legend.data[0]=singlePointerTitle;}}_this.optionDefault.series[0].data=dataArr;_this.optionDefault.xAxis[0].data=time;var $chartContainer=$(_this.container).find("#chartBox");!_this.chart&&(_this.chart=echarts.init($chartContainer[0],AppConfig.chartTheme));_this.chart.setOption(_this.optionDefault);_this.spinner&&_this.spinner.stop();}});},ModalAppHistory.prototype.attachEvent=function(){var _this=this;$(this.container).off('click').on("click","#btnQuery",function(){var tPeriod=$(_this.container).find("#timePeriod").val();var startTime=$(_this.container).find("#datetimepickerStarts").val().toDate().timeFormat('yyyy-mm-dd hh:ii:ss');var endTime=$(_this.container).find("#datetimepickerEnds").val().toDate().timeFormat('yyyy-mm-dd hh:ii:ss');var id=$(_this.container).find(".activeSingle").attr("data-id");_this.renderModal(id,startTime,endTime,tPeriod);});$(this.container).off('click.singleContent').on("click.singleContent",".singleContent",function(){var $this=$(this);$(_this.container).find('.singleContent').removeClass('activeSingle');$this.addClass('activeSingle');var id=$this.attr("data-id");_this.renderModal(id);});},ModalAppHistory.prototype.showConfigMode=function(){},ModalAppHistory.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.interval=5;};return ModalAppHistory;}();var ModalAppDiagRanking=function(){function ModalAppDiagRanking(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalAppDiagRanking.prototype=new ModalBase();ModalAppDiagRanking.prototype.optionTemplate={name:'toolBox.modal.APP_DIAGNOSTIC_RANKING',parent:3,mode:['appDiagRanking'],maxNum:1,title:'',minHeight:4,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppDiagRanking',scroll:false};ModalAppDiagRanking.prototype.optionDefault={};ModalAppDiagRanking.prototype.updateModal=function(points){},ModalAppDiagRanking.prototype.renderModal=function(){var _this=this;var dsItemIds=this.entity.modal.points;var diagType=this.entity.modal.option.diagType?this.entity.modal.option.diagType:'fault';var rankName;if(diagType==='equipment'){rankName=I18n.resource.modalConfig.modalApp.EQUIPMENT_NAME;}else if(diagType==='zone'){rankName=I18n.resource.modalConfig.modalApp.ZONE_NAME;}else{rankName=I18n.resource.modalConfig.modalApp.FAULT_NAME;}var str='<table class="diagRanking" data-type="'+diagType+'">\
                        <thead class="bgColorTemp2">\
                            <tr>\
                                <th width="15%" title="'+I18n.resource.modalConfig.modalApp.RANKING+'">'+I18n.resource.modalConfig.modalApp.RANKING+'</th>\
                                <th title="'+rankName+'">'+rankName+'</th>\
                                <th title="'+I18n.resource.modalConfig.modalApp.MOTH_TIME+'">'+I18n.resource.modalConfig.modalApp.TIMES+'</th>\
                                <th title="'+I18n.resource.modalConfig.modalApp.AVE_DURATION+'">'+I18n.resource.modalConfig.modalApp.DURATION+'</th>\
                            </tr>\
                        </thead>\
                        <tbody>\
                        </tbody>\
                    </table>';WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:dsItemIds}).done(function(result){if($(_this.container).find(".alertError")||$(_this.container).find(".diagRanking")){$(_this.container).find(".alertError").remove();$(_this.container).find(".diagRanking").remove();}$(_this.container).append($(str));var dataArr=result.dsItemList;if(result.dsItemList[0].data.indexOf('MonthRankList')!==-1){var data=JSON.parse(result.dsItemList[0].data).MonthRankList;for(var j=0,jLength=data.length;j<jLength;j++){var sonContent='<tr class="diagnosisTr borderColorTemp3">\
                                    <td>'+(j+1)+'</td>\
                                    <td class="disgnosisName">'+data[j].name+'</td>\
                                    <td>'+data[j].count+'</td>\
                                    <td>'+data[j].timespan+'</td>\
                                </tr>';$(_this.container).find(".diagRanking").find("tbody").append($(sonContent));}_this.spinner&&_this.spinner.stop();$(_this.container).find('.diagnosisTr').off('click').click(function(){var faultName=$(this).find('.disgnosisName').text().trim();var diagType=$(this).parents('table.diagRanking').attr('data-type');var faultInfos={};var postData={value:faultName,type:diagType,startTime:new Date(new Date().valueOf()-86400000*7).format('yyyy-MM-dd ')+'00:00:00',endTime:new Date().format('yyyy-MM-dd HH:mm:ss'),projId:AppConfig.projectId};Spinner.spin($(_this.container).parents('.indexContent')[0]);WebAPI.post('/diagnosis/getFaultDetails',postData).done(function(faultDetail){var faultDetailData=faultDetail.data;faultInfos['faultName']=faultName;faultInfos['faultDetailData']=faultDetailData;faultInfos['containerScreen']=$(_this.container).parents('.indexContent');new DiagnosisInfo().show(faultInfos);});});}else{var alertError='<div class="alertError" style="width:40%;height:12%;position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;z-index:1200;background:#eee;color:#aaa;border-radius:6px;padding:10px;">所填数据点的格式不符合该控件所需的数据格式</div></div>';$(_this.container).append($(alertError));}});},ModalAppDiagRanking.prototype.attachEvent=function(){},ModalAppDiagRanking.prototype.showConfigMode=function(){},ModalAppDiagRanking.prototype.setModalOption=function(option){this.entity.modal.option.diagType=option.diagType;};return ModalAppDiagRanking;}();var ModalAPPMonthHistory=function(){function ModalAPPMonthHistory(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;this.dsItems=undefined;this.layout();this.attachEvent();};ModalAPPMonthHistory.prototype=new ModalBase();ModalAPPMonthHistory.prototype.optionTemplate={name:'toolBox.modal.APP_MONTH_HISTORY_QUERY',parent:3,mode:['appMonthHistory'],maxNum:1,title:'',minHeight:2.5,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAPPMonthHistory'};ModalAPPMonthHistory.prototype.optionDefault={title:{left:'center',textStyle:{color:'#000000'}},tooltip:{trigger:'axis',axisPointer:{type:'shadow'},backgroundColor:'rgba(0,0,0,0.6)',textStyle:{color:'#ffffff'}},legend:{data:[]},grid:{left:'3%',right:'4%',bottom:'4%',containLabel:true},xAxis:[{type:'category',axisTick:{alignWithLabel:true},data:['Mon','Tue','Wed','Thu','Fri','Sat','Sun']}],yAxis:[{type:'value'}],series:[]};ModalAPPMonthHistory.prototype.updateModal=function(points){},ModalAPPMonthHistory.prototype.layout=function(){var showMonth='<div id="topMonthShow" style="height:9%">\
                            <div class="col-xs-4 leftButton">\
                                <span class="glyphicon glyphicon-arrow-left"></span>\
                            </div>\
                            <div class="col-xs-4 month">\
                            </div>\
                            <div class="col-xs-4 rightButton">\
                                <span class="glyphicon glyphicon-arrow-right"></span>\
                            </div>\
                        </div>';var chartContainer='<div id="chartContainer" style="height:91%"></div>';$(this.container).append(showMonth);$(this.container).append(chartContainer);},ModalAPPMonthHistory.prototype.getDsItemsById=function(){var ids=this.entity.modal.points;var _this=this;WebAPI.post('/analysis/datasource/getDsItemsById',ids).done(function(result){_this.dsItems=result;});;},ModalAPPMonthHistory.prototype.renderModal=function(start,end,month){this.getDsItemsById();var nowYear=Number(new Date().format("yyyy"));var nowMonth=Number(new Date().format('yyyy-MM-dd').split("-")[1]);var showYear,showMonth,startTime,endTime;if(1<nowMonth&&nowMonth<=10){showYear=nowYear;showMonth='0'+(nowMonth-1);}else if(10<nowMonth&&nowMonth<=12){showYear=nowYear;showMonth=nowMonth-1;}else if(nowMonth===1){showYear=nowYear-1;showMonth=12;}startTime=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(startTime));endTime=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");var topMonth=month===undefined?showMonth:month;$(this.container).find(".month").html(topMonth+" 月");var id=this.entity.modal.points;var tPeriod='d1';var timeStart=start===undefined?startTime:start;var timeEnd=end===undefined?endTime:end;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:id,timeStart:timeStart,timeEnd:timeEnd,timeFormat:tPeriod}).done(function(result){this.optionDefault.xAxis[0].data=[];this.optionDefault.series=[];this.optionDefault.title.text=[];this.optionDefault.legend.data=[];var dataList=result.list;var timeData=result.timeShaft;var timeArr=[];var datas=[];var ids=[];var obj={name:'1',type:'bar',data:[]};for(var i=0,length=dataList.length;i<length;i++){datas.push(dataList[i].data);ids.push(dataList[i].dsItemId);}for(var j=0,jLength=datas.length;j<jLength;j++){for(var k=0,kLength=this.dsItems.length;k<kLength;k++){if(this.dsItems[k].id===ids[j]){obj.data=datas[j];obj.name=this.dsItems[k].alias;this.optionDefault.series.push(obj);this.optionDefault.title.text=this.dsItems[k].alias;this.optionDefault.legend.data.push(this.dsItems[k].alias);}}}for(var t=0,tLength=timeData.length;t<tLength;t++){timeArr.push(timeData[t].split(" ")[0].split("-")[2]);}this.optionDefault.xAxis[0].data=timeArr;var $chartContainer=$(this.container).find("#chartContainer");!this.chart&&(this.chart=echarts.init($chartContainer[0],AppConfig.chartTheme));this.chart.setOption(this.optionDefault);this.spinner&&this.spinner.stop();}.bind(this));},ModalAPPMonthHistory.prototype.attachEvent=function(){var _this=this;var leftCount=0,rightCount=0;var nowYear=Number(new Date().format("yyyy"));var current;$(this.container).find(".leftButton").click(function(){leftCount=leftCount+1;if(leftCount===1){current=Number($(_this.container).find(".month").html().split(" ")[0]);}var value=(leftCount-current)/12;var yearNums,showYear,showMonth;if(value>0){yearNums=parseInt(value)+1;}else if(value===0){yearNums=1;}else{yearNums=0;}showYear=nowYear-yearNums;var showCurrentMonth=Number($(_this.container).find(".month").html().split(" ")[0]);if(1<showCurrentMonth&&showCurrentMonth<=10){showMonth='0'+(showCurrentMonth-1);}else if(10<showCurrentMonth&&showCurrentMonth<=12){showMonth=showCurrentMonth-1;}else if(showCurrentMonth===1){showMonth=12;}$(_this.container).find(".month").html(showMonth);timeStart=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(timeStart));timeEnd=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");_this.renderModal(timeStart,timeEnd,showMonth);});$(this.container).find(".rightButton").click(function(){rightCount=rightCount+1;if(rightCount===1){current=Number($(_this.container).find(".month").html().split(" ")[0]);}var value=(rightCount-(12-current))/12;var yearNums,showYear,showMonth;if(value>0){yearNums=parseInt(value)+1;}else if(value===0){yearNums=1;}else{yearNums=0;}showYear=nowYear-yearNums;var showCurrentMonth=Number($(_this.container).find(".month").html().split(" ")[0]);if(showCurrentMonth>=1&&showCurrentMonth<9){showMonth='0'+(showCurrentMonth+1);}else if(showCurrentMonth>=9){showMonth=showCurrentMonth+1;}else if(showCurrentMonth===12){showMonth='01';}$(_this.container).find(".month").html(showMonth);timeStart=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(timeStart));timeEnd=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");_this.renderModal(timeStart,timeEnd,showMonth);});},ModalAPPMonthHistory.prototype.showConfigMode=function(){},ModalAPPMonthHistory.prototype.setModalOption=function(option){this.entity.modal.option={};};return ModalAPPMonthHistory;}();var ModalAppBlind=function(){function ModalAppBlind(screen,entityParams){if(!screen)return;if(!entityParams)return;this.screen=screen;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.tempOpt=undefined;};ModalAppBlind.prototype=new ModalBase();ModalAppBlind.prototype.optionTemplate={name:'toolBox.modal.APP_BLIND',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppBlind',scroll:false};ModalAppBlind.prototype.show=function(){this.init();};ModalAppBlind.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalAppBlind.prototype.renderModal=function(){var _this=this;if(this.entity.modal.option&&this.entity.modal.option instanceof Array){var arrItem=this.entity.modal.option;this.entity.modal.option={};this.entity.modal.option.arrItem=arrItem;}var blindOpt=undefined;_this.entity.modal.option&&(blindOpt=_this.entity.modal.option.arrItem);if(!blindOpt||blindOpt.length===0)return;var $currentContainer=$(_this.container);var blindDivBox='<div id="blindDivBox" class="gray-scrollbar"></div>';$currentContainer.append(blindDivBox);var $blindDivBox=$currentContainer.find('#blindDivBox');for(var m=0;m<blindOpt.length;m++){var isExist=false;var classNameFlag;if(m%2===0){classNameFlag='blindContainerOdd';}else{classNameFlag='blindContainerEven';}for(var i=0,item;i<_this.screen.store.layout.length;i++){$currentContainer.css({'display':'flex','overflow-y':'hidden','flex-flow':'wrap'});for(var j=0;j<_this.screen.store.layout[i].length;j++){item=_this.screen.store.layout[i][j];if(blindOpt[m].subChartIds[0].id!=item.id)continue;isExist=true;var modelClass,entity;var blindContainerSin='<div class="blindContainerSin '+classNameFlag+'">\
                                        <div class="blindConTitle bgColorTemp1 borderColorTemp1" style="border-radius:0"><span class="glyphicon glyphicon-align-justify" style="color:#ca2929;padding-right:10px;"></span>'+blindOpt[m].blindTitle+'</div>\
                                        <div class="blindConContent gray-scrollbar" style="width:100%;overflow-y:auto"></div>\
                                    </div>';$blindDivBox.append(blindContainerSin);$currentContainer.find('.blindConTitle').off('click').click(function(){var $this=$(this);if($this.siblings('.blindConContent').hasClass('showSibling'))return;$currentContainer.find('.blindConContent').removeClass('showSibling').hide();$this.siblings('.blindConContent').addClass('showSibling').show().css({maxHeight:$blindDivBox.parent().height()-$('.blindContainerSin',$currentContainer).length*$('.blindContainerSin',$currentContainer).height()});});if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalAppBlind'){item.scroll=false;entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){entity.container.style.overflowY="auto";entity.render();var $currentBlindCon=$blindDivBox.find('.blindContainerSin').eq(m).children('.blindConContent');$currentBlindCon.height($currentContainer.children('.springContainer').height());$currentBlindCon.append($currentContainer.children('.springContainer'));continue;}if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}if(entity.optionTemplate.scroll!==false){if(AppConfig.isMobile){entity.container.style.height=ElScreenContainer.offsetHeight*entity.entity.spanR*2/9+'px';}else{entity.container.style.height=$blindDivBox.height()*entity.entity.spanR/6+'px';}}entity.container.style.width=$(entity.container).parent().parent('.springContainer').width()+'px';entity.container.style.overflowY="auto";entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);entity.render();_this.screen.isForReport&&entity.configure();}var $currentBlindCon=$blindDivBox.find('.blindContainerSin').eq(m).children('.blindConContent');if(entity.optionTemplate.scroll!==false){if(!AppConfig.isMobile){$currentBlindCon.height($currentContainer.children('.springContainer').height());}}$currentBlindCon.append($currentContainer.children('.springContainer'));}}}$currentContainer.find('#blindDivBox').find('.blindContainerSin').find('.blindConContent').hide();$currentContainer.find('#blindDivBox').find('.blindContainerSin:first-child').find('.blindConContent').addClass('showSibling').show();Spinner&&Spinner.stop();};ModalAppBlind.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalAppBlind.prototype.configureModalNone=function($chartsCt,opt){var spanC=12,spanR=3;if($chartsCt.children().length>0){var lastDiv=$chartsCt.children()[$chartsCt.children().length-1];spanC=Math.round(parseInt(lastDiv.style.width.split('%')[0])/10)*12/10;spanR=Math.round(parseInt(lastDiv.style.height.split('%')[0])/10)*6/10;}if(!this.container.classList.contains('chartsCt')){this.container=this.container.parentElement.getElementsByClassName('chartsCt')[0];}var entity=new ModalNone(this,{id:(+new Date()).toString(),spanC:spanC,spanR:spanR,modal:{type:"ModalNone"},isNotRender:true});this.screen.arrEntityOrder.push(entity.entity.id);this.screen.listEntity[entity.entity.id]=entity;opt.subChartIds=new Array();opt.subChartIds.push({id:entity.entity.id});entity.render();entity.configure();this.entity.modal=this.tempOpt;};ModalAppBlind.prototype.showConfigMode=function(){};ModalAppBlind.prototype.configure=function(){var _this=this;if(this.spinner)this.spinner.stop();if(this.chart)this.chart.clear();this.divResizeByMouseInit();if(this.entity.modal.option&&this.entity.modal.option instanceof Array){var arrItem=this.entity.modal.option;this.entity.modal.option={};this.entity.modal.option.arrItem=arrItem;}var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();_this.tempOpt=_this.tempOpt?_this.tempOpt:_this.entity.modal;if(_this.tempOpt.option&&_this.tempOpt.option.arrItem&&_this.tempOpt.option.arrItem.length>0){for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(_this.tempOpt.option.arrItem[i].subChartIds.length===0)continue;if(_this.tempOpt.option.arrItem[i].subChartIds[0].id===_this.screen.arrEntityOrder[j]){_this.screen.removeEntity(_this.screen.arrEntityOrder[j]);}}}_this.tempOpt.option=[];}_this.screen.removeEntity(_this.entity.id);$('#divContainer_'+_this.entity.id).remove();};divMask.appendChild(btnRemove);var btnInstall=document.createElement('span');btnInstall.className='glyphicon glyphicon-cog springBlindConfigInstallBtn grow';btnInstall.title='config';btnInstall.onclick=function(e){_this.showConfigModal();};divMask.appendChild(btnInstall);var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $chartCt=$('<div class="divResize chartsCt gray-scrollbar">');divMask.appendChild($chartCt[0]);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};this.showConfigMode();};ModalAppBlind.prototype.attBlindEvent=function(){var _this=this;$('.blindNameEnter').off('blur').blur(function(){var $this=$(this);var currentTitle=$this.val().trim();if(currentTitle==='')return;var $currentBlind=$this.parents('.divBlind');$this.hide();$this.siblings('.blindNameShow').text(currentTitle).css('display','inline-block');var index=$('.divBlind').index($currentBlind);_this.tempOpt.option.arrItem[index].blindTitle=currentTitle;});$('.blindNameShow').off('click').click(function(){var $this=$(this);var currentTitle=$this.text();$this.hide();$this.siblings('.blindNameEnter').val(currentTitle).css('display','inline-block').focus();});$('.deleteBlind').off('click').click(function(){var $this=$(this);var $parents=$this.parents('.divBlind');var parentId=$parents.attr('data-id');for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){var currentOpt;if(_this.tempOpt.option.arrItem[i].domDataId.toString()===parentId){currentOpt=_this.tempOpt.option.arrItem[i];if(currentOpt&&currentOpt.subChartIds.length!==0){for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(currentOpt.subChartIds[0].id===_this.screen.arrEntityOrder[j]){var callback=function callback(isDelete){if(isDelete){if(_this.chart)_this.chart.clear();_this.tempOpt.option.arrItem.splice(num,1);$parents.empty().remove();}};var isNotModalNone=false;if($('#divContainer_'+_this.screen.arrEntityOrder[j]).length>0&&$('#divContainer_'+_this.screen.arrEntityOrder[j]).find('.divTitleAndType').length>0){isNotModalNone=true;}if(!isNotModalNone){if(_this.chart)_this.chart.clear();_this.tempOpt.option.arrItem.splice(i,1);$parents.empty().remove();i=i-1;}var num=i;$('#divContainer_'+_this.screen.arrEntityOrder[j]).find('span.springConfigRemoveBtn').trigger('click',callback);}}}else{_this.tempOpt.option.arrItem.splice(i,1);$parents.empty().remove();i=i-1;}}}_this.entity.modal.option=_this.tempOpt.option;});};ModalAppBlind.prototype.createDivBlind=function(opt){var divBlind=document.createElement('div');divBlind.className='divBlind';if(opt&&opt.domDataId){divBlind.setAttribute('data-id',opt.domDataId);}else{var nowValue=new Date().valueOf();divBlind.setAttribute('data-id',nowValue);}var $divBlind=$(divBlind);divBlind.innerHTML='<label class="blindName">标题：</label>\
            <span class="blindNameShow"></span>\
            <input type="text" class="blindNameEnter"/>\
            <span class="deleteBlind glyphicon glyphicon-remove-circle"></span>\
            ';if(opt&&opt.blindTitle){$divBlind.find('.blindNameShow').text(opt.blindTitle).css('display','inline-block');$divBlind.find('.blindNameEnter').hide();}if(!opt){if(!this.tempOpt.option){this.tempOpt.option={};this.tempOpt.option.arrItem=[];}else if(this.tempOpt.option instanceof Array){var arrItem=this.tempOpt.option;this.tempOpt.option={};this.tempOpt.option.arrItem=arrItem;}this.tempOpt.option.arrItem.push({id:'',domDataId:nowValue,title:'',blindTitle:'',modalType:'',subChartIds:[]});};return divBlind;};ModalAppBlind.prototype.showConfigModal=function(){var _this=this;var $blindChartShow=$('#blindChartShow');$blindChartShow.empty().remove();if($blindChartShow.length===0){$blindChartShow=$('<div class="modal fade" id="blindChartShow"></div>');}$('#paneContent').append($blindChartShow);var blindChartCon='<div class="modal-dialog"><div class="modal-content">'+'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">APP百叶窗</h4><span class="glyphicon glyphicon-plus-sign blindAddBtn grow" style=""></span></div>'+'<div class="modal-body gray-scrollbar">'+'</div>'+'<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="btnBlindListShow">确定</button></div>'+'</div></div>';$blindChartShow.append(blindChartCon);_this.tempOpt=_this.tempOpt?_this.tempOpt:$.extend(true,{},_this.entity.modal);$blindChartShow.find('.modal-body').html('<div class="row" style="margin:15px 0;">\
                        <div class="col-xs-3">背景颜色</div>\
                        <div class="col-xs-2">\
                        <select id="selBgColor">\
                        <option value="transparent">无</option>\
                        <option value="#ffffff">白</option>\
                        <option value="#000000">黑</option>\
                        <option value="#337ab7">蓝</option>\
                        <option value="#5cb85c">绿</option>\
                        <option value="custom">自定义</option>\
                        </select>\
                        </div>\
                        <div class="col-xs-2"><input type="input" id="iptBgColor" placeholder="#ffffff" style="width:60px;display:none;"/></div>\
                        <div class="col-xs-2"><input type="color" class="" id="bgColorView" style="display:none;"/></div>\
                        </div>');if(!_this.tempOpt.option||!_this.tempOpt.option.arrItem||_this.tempOpt.option.arrItem.length===0){$blindChartShow.find('.modal-body').append(_this.createDivBlind());}else{for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){var item=_this.tempOpt.option.arrItem[i];var isExist=false;for(var j in _this.screen.listEntity){if(item.subChartIds.length===0){continue;}if(item.subChartIds[0].id===j){isExist=true;break;}}if(!isExist){_this.tempOpt.option.arrItem.splice(i,1);i=i-1;}else{$blindChartShow.find('.modal-body').append(_this.createDivBlind(_this.tempOpt.option.arrItem[i]));}}}$blindChartShow.modal('show');$blindChartShow.find('.blindAddBtn').off('click').click(function(e){$blindChartShow.find('.modal-body').append(_this.createDivBlind());_this.attBlindEvent();});_this.attBlindEvent();var $iptBgColor=$('#iptBgColor',$blindChartShow);var $bgColorView=$('#bgColorView',$blindChartShow);var $selBgColor=$('#selBgColor',$blindChartShow);$('#btnBlindListShow').off('click').click(function(){var opts=_this.tempOpt.option.arrItem;if(opts){var $chartsCt=_this.container.classList.contains('chartsCt')?$(_this.container):$(_this.container).siblings().find('.chartsCt');if(opts[0].subChartIds.length===0){$chartsCt.children().empty().remove();for(var i=0;i<opts.length;i++){_this.configureModalNone($chartsCt,opts[i]);}}else{var $containerChartsCt=$(_this.container);if(_this.screen.arrEntityOrder.length===1){_this.tempOpt.option=[];return;}for(var i=0;i<opts.length;i++){var isExist=false;var currentOption=$containerChartsCt.children('.springContainer').length>0?$containerChartsCt.children('.springContainer'):$containerChartsCt.siblings('.springConfigMask').find('.chartsCt').find('.springContainer');for(var j=0;j<currentOption.length;j++){var currentId=currentOption[j].id.split('_')[1];if(opts[i].subChartIds.length!==0){if(currentId===opts[i].subChartIds[0].id){isExist=true;continue;}}}if(!isExist){_this.configureModalNone($chartsCt,opts[i]);}}}_this.entity.modal.option.bgColor=$iptBgColor.val();}});_this.entity.modal.option&&setShow(_this.entity.modal.option.bgColor);$selBgColor.off('change').on('change',function(e){setShow(this.value,e);});$iptBgColor.off('input').on('input',function(){$bgColorView.val(this.value);});$blindChartShow.children('.modal').modal();function setShow(selected,event){if(selected==='transparent'){$bgColorView.hide();}else{$bgColorView.val(selected);$bgColorView.show();}if(selected==='custom'){$iptBgColor.show();$iptBgColor.val('').focus();}else{$iptBgColor.hide();$iptBgColor.val(selected);}if(!event){$selBgColor.val(selected);if(!$selBgColor.val()){$selBgColor.val('custom');$iptBgColor.val(selected).show().focus();}}}};return ModalAppBlind;}();var ModalAppPie=function(){function ModalAppPie(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;this.screen=screen;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppPie.prototype=new ModalBase();ModalAppPie.prototype.optionTemplate={name:'toolBox.modal.APP_PIE',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppPie'};ModalAppPie.prototype.show=function(){this.init();};ModalAppPie.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalAppPie.prototype.renderModal=function(){this.entity.modal.interval=5;var $appPieTotalBox=$(this.container).find('.appPieTotalBox');if($appPieTotalBox.length>0)return;var appPieTotalBox='<div class="appPieTotalBox"><div class="appPieTextShow">\
                <div class="appPieTotalBoxTitle"><span>能耗统计</span></div>\
                <div class="leftAppChartLegend divAppChartTip row">\
                </div>\
                <div class="divAppEnergyLabel">\
                    <div class="ctnRealVal">\
                        <div class="divRealVal">\
                            <span class="spLabelName">今日能耗：</span></br>\
                            <span class="spRealVal spTodayEnergy"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">昨日能耗：</span></br>\
                            <span class="spRealVal spYestEnergy"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">今日费用：</span></br>\
                            <span class="spRealVal spAppTodayCost"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">昨日费用：</span></br>\
                            <span class="spRealVal spAppYestCost"></span>\
                        </div>\
                    </div>\
                    <div class="ctnPercentage">\
                        <div class="divPercentage">\
                            <span class="spPercentVal spTodayEnergyPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spYestEnergyPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spAppTodayCostPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spAppYestCostPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                    </div>\
                </div>\
            </div>\
            <div class="divAppChart " id="divEnergyChart">\
                <div class="divAppChildChart divAppItemEnergy"></div>\
                <div class="divAppChildChart divAppTotalEnergy"></div>\
            </div>\
            </div>';$(this.container).append(appPieTotalBox);$(this.container).find('.divAppItemEnergy').css({width:$(this.container).width()*0.6,height:$(this.container).height()});$(this.container).find('.divAppTotalEnergy').css({width:$(this.container).width()*0.37,height:$(this.container).height()});};ModalAppPie.prototype.updateModal=function(point){var $currentContainer=$(this.container);$currentContainer.find('.panel-default').css('background-color','#fff');var data=JSON.parse(point[0].data);var nameList=[];var pointList=[];var spIconColor=['#6dbef3','#008ae2','#028f68','#00a045','#6cc332','#eeed00'];var colorJ=0;var $leftAppChartLegend=$currentContainer.find('.leftAppChartLegend');$leftAppChartLegend.children().empty().remove();var projectId=data.EnergyList[0].projectId;if(!projectId){if(AppConfig.project&&AppConfig.project.bindId){projectId=AppConfig.project.bindId;}else{projectId=AppConfig.projectId;}}for(var i=0;i<data.EnergyList[0].children.length;i++){var item=data.EnergyList[0].children[i];nameList.push(item.name);pointList.push('@'+projectId+'|'+item.accumEnergyPoint);var singleLegendDiv='<div class="spAppChartLegend col-xs-6">\
                                <span class="spIcon" style="background-color:'+spIconColor[colorJ]+'"></span>\
                                <span class="spName">\
                                </span>\
                            </div>';$leftAppChartLegend.append(singleLegendDiv);if(colorJ===data.EnergyList[0].children.length-1)colorJ=0;$currentContainer.find('.appPieTotalBox').find('.spAppChartLegend').eq(i).find('.spName').text(item.name);colorJ++;}var accumPostData={dsItemIds:pointList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'m5',timeStart:new Date().format('yyyy-MM-dd')+' 00:00:00'};WebAPI.post('/analysis/startWorkspaceDataGenHistogram',accumPostData).done(function(result){if(result&&result.list&&result.list.length!==0){var dataArr=[];for(var i=0;i<result.list.length;i++){if(result.list[i].data&&result.list[i].data.length>0){dataArr.push({value:(result.list[i].data[result.list[i].data.length-1]-result.list[i].data[0]).toFixed(2),name:nameList[i]});}else{dataArr.push({value:0,name:nameList[i]});}}var $divAppItemEnergy=$currentContainer.find('.divAppItemEnergy');var leftOption={color:['#6dbef3','#008ae2','#028f68','#00a045','#6cc332','#eeed00'],tooltip:{trigger:'item'},calculable:false,legend:{show:false,data:nameList},toolbox:{show:false},series:[{name:'能耗(kWh)',type:'pie',radius:['40%','60%'],clockWise:false,center:['48%','46%'],itemStyle:{normal:{borderColor:'white',label:{show:true,formatter:function formatter(params){return params.percent.toFixed(1)+'%';},textStyle:{color:'#646464',fontFamily:'Microsoft Yahei'}},labelLine:{show:true,length:0}}},data:dataArr}]};var chart=echarts.init($divAppItemEnergy[0]);chart.setOption(leftOption);}});var dsItemIds=[];dsItemIds.push('@'+projectId+'|'+data.EnergyList[0].accumCostPoint);dsItemIds.push('@'+projectId+'|'+data.EnergyList[0].accumEnergyPoint);var postData={dsItemIds:dsItemIds,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'m5',timeStart:new Date().format('yyyy-MM-dd')+' 00:00:00'};var yestodayEnergy,yestodayCost,todayEnergy,todayCost,todayEnergyEnd,todayCostEnd;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(resultData){if(resultData.list.length>0){var todayEnergyDataAll=resultData.list[1].data;var todayCostDataAll=resultData.list[0].data;if(point.length===2){todayEnergyEnd=point[1].data;todayCostEnd=point[1].data;}else if(point.length===3){todayEnergyEnd=point[2].data;todayCostEnd=point[1].data;}else{todayEnergyEnd=todayEnergyDataAll[todayEnergyDataAll.length-1];todayCostEnd=todayCostDataAll[todayCostDataAll.length-1];}if(todayEnergyDataAll.length!==0){todayEnergy=todayEnergyEnd-todayEnergyDataAll[0];}else{todayEnergy=0;}if(todayCostDataAll.length!==0){todayCost=todayCostEnd-todayCostDataAll[0];}else{todayCost=0;}}var $divAppEnergyLabel=$currentContainer.find('.divAppEnergyLabel');$divAppEnergyLabel.find('.spTodayEnergy').text(kIntSeparate(todayEnergy)+' kwh');$divAppEnergyLabel.find('.spAppTodayCost').text('￥ '+kIntSeparate(todayCost));var postDataYes={dsItemIds:dsItemIds,timeEnd:new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd')+' 23:59:59',timeFormat:'m5',timeStart:new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd')+' 00:00:00'};WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postDataYes).done(function(resultDataYes){if(resultDataYes.list.length>0){var yestodayEnergyDataAll=resultDataYes.list[1].data;var yestodayCostDataAll=resultDataYes.list[0].data;if(yestodayEnergyDataAll.length!==0){yestodayEnergy=yestodayEnergyDataAll[yestodayEnergyDataAll.length-1]-yestodayEnergyDataAll[0];}else{yestodayEnergy=0;}if(yestodayCostDataAll.length!==0){yestodayCost=yestodayCostDataAll[yestodayCostDataAll.length-1]-yestodayCostDataAll[0];}else{yestodayCost=0;}$divAppEnergyLabel.find('.spYestEnergy').text(kIntSeparate(yestodayEnergy)+' kwh');$divAppEnergyLabel.find('.spAppYestCost').text('￥ '+kIntSeparate(yestodayCost));$divAppEnergyLabel.find('.spTodayEnergyPercent').text((todayEnergy*100/(todayEnergy+yestodayEnergy)).toFixed(0)+'%');$divAppEnergyLabel.find('.spYestEnergyPercent').text((yestodayEnergy*100/(todayEnergy+yestodayEnergy)).toFixed(0)+'%');$divAppEnergyLabel.find('.spAppTodayCostPercent').text((todayCost*100/(todayCost+yestodayCost)).toFixed(0)+'%');$divAppEnergyLabel.find('.spAppYestCostPercent').text((yestodayCost*100/(todayCost+yestodayCost)).toFixed(0)+'%');var labelTop={normal:{color:'#6aa7fd',label:{show:false,position:'center',formatter:'{b}',textStyle:{baseline:'bottom'}},labelLine:{show:false}}};var labelFromatter={normal:{label:{show:false,formatter:function formatter(params){return 100-params.value+'%';},textStyle:{baseline:'top'}}}};var labelBottom={normal:{color:'white',label:{show:false,position:'center'},labelLine:{show:false}},emphasis:{color:'rgba(0,0,0,0)'}};var borderItemStyle={normal:{color:'#6aa7fd',label:{show:false},labelLine:{show:false}}};var radius=[0,'16%'];var borderRadius=['17%','21%'];var rightOption={legend:{show:false,data:['今日能耗','昨日能耗','今日费用','昨日费用']},title:{text:'The App World',show:false},toolbox:{show:false},series:[{type:'pie',center:['75%','25%'],radius:radius,x:'0%',itemStyle:labelFromatter,data:[{name:'other',value:yestodayEnergy,itemStyle:labelBottom},{name:'今日能耗',value:todayEnergy,itemStyle:labelTop}]},{type:'pie',center:['75%','25%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','45%'],radius:radius,x:'20%',itemStyle:labelFromatter,data:[{name:'other',value:todayEnergy,itemStyle:labelBottom},{name:'昨日能耗',value:yestodayEnergy,itemStyle:labelTop}]},{type:'pie',center:['75%','45%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','65%'],radius:radius,x:'40%',itemStyle:labelFromatter,data:[{name:'other',value:yestodayCost,itemStyle:labelBottom},{name:'今日费用',value:todayCost,itemStyle:labelTop}]},{type:'pie',center:['75%','65%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','85%'],radius:radius,x:'60%',itemStyle:labelFromatter,data:[{name:'other',value:todayCost,itemStyle:labelBottom},{name:'昨日费用',value:yestodayCost,itemStyle:labelTop}]},{type:'pie',center:['75%','85%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]}]};var $divAppTotalEnergy=$currentContainer.find('.divAppTotalEnergy');var chart=echarts.init($divAppTotalEnergy[0]);chart.setOption(rightOption);}}).always(function(){this.spinner&&this.spinner.stop();});});};ModalAppPie.prototype.showConfigMode=function(){};return ModalAppPie;}();function tofixed(str,accuracy){if(!accuracy)accuracy=2;return parseFloat(str).toFixed(accuracy);}
var ModalKPIStruct=function(){function ModalKPIStruct(screen,entityParams){this.$configModal=undefined;this.$modal=undefined;this.tempOpt=undefined;this.subEntity=undefined;this.store={};if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalKPIStruct.prototype=new ModalBase();ModalKPIStruct.prototype.optionTemplate={name:'toolBox.modal.KPI_STRUCT',parent:3,mode:'custom',maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalKPIStruct',scroll:false};ModalKPIStruct.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"type":'option',"widget":[{id:'needDetail',type:'checkbox',name:'是否显示细节'}]},{"module":"dsDrag","data":[{type:'point',name:'KPI分项统计来源',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalKPIStruct.prototype.show=function(){this.init();};ModalKPIStruct.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.needDetail)this.configModalOpt.area[0].widget[0].data=this.entity.modal.option.needDetail;if(this.entity.modal.option.structPoint)this.configModalOpt.area[1].data[0].data=this.entity.modal.option.structPoint;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();};};ModalKPIStruct.prototype.getRealTimePoint=function(list,arr){var _this=this;if(!arr)arr=[];list.forEach(function(item){if(item.point){arr.push(_this.entity.modal.option.prefix+item.point);}
if(item.children instanceof Array&&item.children.length>0){_this.getRealTimePoint(item.children,arr);}});return arr;};ModalKPIStruct.prototype.init=function(){};ModalKPIStruct.prototype.renderModal=function(e){$(this.container).addClass('widgetKPIItemEval gray-scrollbar');var _this=this;var postData={'dsItemIds':this.entity.modal.option.structPoint};this.container.innerHTML='<div class="divKPIIndex"></div><div class="divKPIDetail"></div>';if(this.entity.modal.option.needDetail){_this.renderDetailContainer();$(_this.container).addClass('showSubContainer');}
_this.attachEvent();};ModalKPIStruct.prototype.renderDetailContainer=function(){var containerDetail=this.container.querySelector('.divKPIDetail');var item={modal:{type:'ModalHtml',interval:60000,option:{html:'<div>开发中</div>'},points:[],title:''},spanC:9,spanR:6};this.initSubEntity(containerDetail,item);};ModalKPIStruct.prototype.attachEvent=function(){var _this=this;var clickEvent=AppConfig.isMobile?'tap':'click';$(this.container).off(clickEvent).on(clickEvent,'.divStructTtl',function(e){$(e.currentTarget).parent().toggleClass('focus');});$(this.container).on(clickEvent,'.divStructItem',function(e){var $target=$(e.currentTarget);if($target.hasClass('focus')){$target.removeClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().removeClass('focus');}else{$(_this.container).find('.rowPointDetail.focus').removeClass('focus');$(_this.container).find('.divStructItem.focus').removeClass('focus');$target.addClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().addClass('focus');_this.subEntity&&_this.refreshSubEntity($target);}});};ModalKPIStruct.prototype.refreshSubEntity=function($target){var itemIndex=$target.parentsUntil('.divKPIIndex','.divStructCtn')[0].dataset.itemIndex;var childIndex=$target[0].dataset.itemChildIndex;if(!this.store.KPIList)return;var arrPoint=[],strPoint;try{arrPoint=this.store.KPIList[itemIndex].children[childIndex].relatedPoints;strPoint=arrPoint.map(function(point){return point.point;}).toString();}catch(e){strPoint='数据格式不符合';}
var _this=this;this.subEntity.entity.modal.points=arrPoint.map(function(point){return _this.entity.modal.option.prefix+point.point;});this.subEntity.entity.modal.option.html='<div>'+strPoint+'</div><script>this.onUpdateComplete=function(data){console.log(data)}</script>';this.updateSubEntity();};ModalKPIStruct.prototype.initPointMap=function(points){var _this=this;var $dom;points.forEach(function(point){_this.initPointDetail(point.dsItemId,point.data);});};ModalKPIStruct.prototype.initPointDetail=function(id,strData){var $dom=$('[data-point="'+id+'"]');if($dom.length==0)return;var data;if(!isNaN(Number(strData))){data={score:Number(strData)};}else{try{data=JSON.parse(strData);}catch(e){$dom.text('No Data');$('.pointDetail[data-detail="'+id+'"]').text('No Data');return;}}
var status='';if(parseFloat(data.score)>=60){status='success';$dom.text(parseFloat(data.score.toFixed(2))+'%');}else if(parseInt(data.score)>=0){status='danger';$dom.text(parseFloat(data.score.toFixed(2))+'%');}else{status='default';$dom.text('--');}
$dom.removeClass('success danger default').addClass(status);var $detail=$('.pointDetail[data-detail="'+id+'"]');if($detail.length>0){$detail.removeClass('success danger default').addClass(status);$detail.text(data.detail);}
if($dom.hasClass('spItemInfo')){$dom.next().removeClass('success danger default').addClass(status);}};ModalKPIStruct.prototype.initStruct=function(struct,index){var _this=this;var structDom=this.container.querySelector('[data-item="'+struct.name+'"]');var kpiIndexDom=this.container.querySelector('.divKPIIndex');if(!structDom){structDom=document.createElement('div');structDom.className='divStructCtn focus';structDom.dataset.item=struct.name;structDom.dataset.itemIndex=index;var defaultSvg='<svg version="1.1" id="图形" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                    <path class="svgpath" data-index="path_0" fill="#272636" d="M1002.496 414.208c-5.44-28.672-22.592-47.04-43.456-46.528l-4.352 0c-71.808 0-130.24-58.432-130.24-130.24 0-23.68 11.264-49.6 11.328-49.792 11.072-24.96 2.56-55.616-19.84-71.232l-1.216-0.832-125.248-69.568-1.28-0.576c-7.424-3.2-15.552-4.864-24.192-4.864-17.856 0-35.328 7.104-46.784 19.008-15.296 15.808-63.488 56.768-102.4 56.768-39.296 0-87.808-41.792-103.168-57.856-11.52-12.16-29.12-19.392-47.168-19.392-8.448 0-16.448 1.6-23.744 4.672L339.2 44.224 209.536 115.456l-1.28 0.896C185.792 131.968 177.216 162.56 188.288 187.52c0.128 0.256 11.328 26.24 11.328 49.856 0 71.808-58.432 130.24-130.24 130.24L65.024 367.616c-20.928-0.512-38.08 17.92-43.456 46.528C21.12 416.448 11.072 470.144 11.072 512.384c0 42.304 10.048 95.936 10.496 98.176 5.376 28.288 22.08 46.592 42.688 46.592 0.256 0 0.512 0 0.768 0l4.352 0c71.808 0 130.24 58.432 130.24 130.24 0 23.68-11.264 49.6-11.328 49.792-11.072 24.96-2.56 55.616 19.776 71.232l1.216 0.832 122.88 68.736 1.28 0.576c7.424 3.264 15.488 4.928 24.128 4.928 18.048 0 35.648-7.424 47.04-19.84 14.4-15.68 64.576-60.352 104.704-60.352 40.448 0 89.792 44.416 105.408 61.504 11.456 12.608 29.184 20.16 47.36 20.16l0 0 0 0c8.448 0 16.384-1.6 23.68-4.736l1.344-0.576 127.36-70.4 1.28-0.896c22.4-15.616 30.976-46.272 19.904-71.168-0.128-0.256-11.328-26.24-11.328-49.856 0-71.808 58.432-130.24 130.24-130.24l4.352 0c20.928 0.448 38.08-17.92 43.456-46.528 0.448-2.24 10.496-55.936 10.496-98.176C1012.928 470.144 1002.88 416.448 1002.496 414.208L1002.496 414.208zM509.824 685.248c-95.68 0-173.504-77.824-173.504-173.504 0-95.68 77.824-173.504 173.504-173.504 95.68 0 173.504 77.824 173.504 173.504C683.264 607.424 605.44 685.248 509.824 685.248L509.824 685.248zM509.824 685.248"></path>\
                    <path class="svgpath" data-index="path_1" fill="#272636" d="M509.824 397.248 509.824 397.248c-63.104 0-114.496 51.328-114.496 114.496 0 63.104 51.328 114.496 114.496 114.496 63.104 0 114.496-51.328 114.496-114.496C624.256 448.64 572.928 397.248 509.824 397.248L509.824 397.248zM509.824 397.248"></path>\
                </svg>';var structTtl=document.createElement('div');structTtl.className='divStructTtl';structTtl.innerHTML='\
            <span class="spStructIcon">'+defaultSvg+'</span>\
            <span class="spStructName">'+struct.name+'</span>\
            <span class="spStructValue">综合达标率：<span class="spStructPt" data-point="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'">Loading</span></span>\
            <!--<span class="pointDetail" data-detail="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'">Loading</span>-->';var structBody=document.createElement('div');structBody.className='divStuctBody';structBody.appendChild(this.createStructItemTtl(struct.children));if(struct.children instanceof Array&&struct.children.length>0){struct.children.forEach(function(item,index){structBody.appendChild(_this.createStructItem(item,index));structBody.appendChild(_this.createPointDetail(item));});}
structDom.appendChild(structTtl);structBody.appendChild(_this.createPointDetail(struct));structDom.appendChild(structBody);kpiIndexDom.appendChild(structDom);}};ModalKPIStruct.prototype.createStructItemTtl=function(){var structItemTtl=document.createElement('div');structItemTtl.className='divStructItemTtl';structItemTtl.innerHTML='\
            <span class="spStructItemTtl">考核项</span>\
            <span class="spStructItemTtl">月达标率</span>\
            <span class="spStructItemTtl">考核结果</span>\
            ';return structItemTtl;};ModalKPIStruct.prototype.createPointDetail=function(item){var structDetail=document.createElement('tr');structDetail.className='rowPointDetail';if(item.desc){structDetail.innerHTML='<td class="divPointDetail" colspan="5"><span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">'+item.desc+'</span></td>';}else{structDetail.innerHTML='<td class="divPointDetail" colspan="5"><span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">'+I18n.resource.dashboard.modalKPIStruct.NO_DATA_TEMP+'</span></td>';}
return structDetail;};ModalKPIStruct.prototype.createStructItem=function(item,index){var structItem=document.createElement('div');structItem.dataset.itemChildIndex=index;structItem.className='divStructItem';structItem.innerHTML='\
            <span class="spItemInfo">'+(item.name?item.name:'')+'</span>\
            <span class="spItemInfo" data-point="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">Loading</span>\
            <span class="spItemInfo spItemKPIRs">\
                <span class="label label-success">达&nbsp;&nbsp;&nbsp;标</span>\
                <span class="label label-danger">不达标</span>\
                <span class="label label-default">未开启</span>\
            </span>\
            <!--<span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">Loading</span>-->';return structItem;};ModalKPIStruct.prototype.updateModal=function(points){this.spinner.stop();if(!(points[0]&&points[0].data))return;var structList;var _this=this;try{structList=JSON.parse(points[0].data).KPIList;}catch(e){return;}
this.store.KPIList=structList;structList.forEach(function(struct,index){_this.initStruct(struct,index);});var arrPoint=this.getRealTimePoint(structList);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:arrPoint}).done(function(result){if(!result.dsItemList)return;_this.initPointMap(result.dsItemList);});};ModalKPIStruct.prototype.showConfigMode=function(){};ModalKPIStruct.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];var projectId=1;if(AppConfig.project&&AppConfig.project.bindId){projectId=AppConfig.project.bindId;}else{projectId=AppConfig.projectId;}
this.entity.modal.option.prefix='@'+projectId+'|';};return ModalKPIStruct;}();var ModalKPIManage=function(){function ModalKPIManage(screen,entityParams){this.$configModal=undefined;this.$modal=undefined;this.tempOpt=undefined;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalKPIManage.prototype=new ModalBase();ModalKPIManage.prototype.optionTemplate={name:'toolBox.modal.KPI_STRUCT',parent:0,mode:'custom',maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalKPIManage',scroll:false};ModalKPIManage.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"module":"dsDrag","data":[{type:'point',name:'KPI分项统计来源',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalKPIManage.prototype.show=function(){this.init();};ModalKPIManage.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.points)this.configModalOpt.area[0].data[0].data=this.entity.modal.option.structPoint;this.configModalOpt.result.func=function(option){_this.setModalOption(option).done(function(resultData){_this.entity.modal.points=[];if(!(resultData.dsItemList&&resultData.dsItemList[0]&&resultData.dsItemList[0].data))return;var structList;try{structList=JSON.parse(resultData.dsItemList[0].data).KPIList;}catch(e){return;}
_this.getRealTimePoint(structList,_this.entity.modal.points);}).always(function(){_this.configModal.hide();_this.toggleDataSource(false);});};};ModalKPIManage.prototype.getRealTimePoint=function(list,arr){var _this=this;if(!arr)arr=[];list.forEach(function(item){if(item.point){arr.push(_this.entity.modal.option.prefix+item.point);}
if(item.children instanceof Array&&item.children.length>0){_this.getRealTimePoint(item.children,arr);}});return arr;};ModalKPIManage.prototype.init=function(){};ModalKPIManage.prototype.renderModal=function(e){this.spinner.stop();$(this.container).addClass('widgetKPIItemEval');var _this=this;var postData={'dsItemIds':this.entity.modal.option.structPoint};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(resultData){if(!(resultData.dsItemList&&resultData.dsItemList[0]&&resultData.dsItemList[0].data))return;var structList;try{structList=JSON.parse(resultData.dsItemList[0].data).KPIList;}catch(e){return;}
structList.forEach(function(struct){_this.initStruct(struct);});_this.attachEvent();});};ModalKPIManage.prototype.attachEvent=function(){var clickEvent=AppConfig.isMobile?'tap':'click';$(this.container).off(clickEvent).on(clickEvent,'.divStructTtl',function(e){$(e.currentTarget).parent().toggleClass('focus');});$(this.container).on(clickEvent,'.divStructItem',function(e){var $target=$(e.currentTarget);if($target.hasClass('focus')){$target.removeClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().removeClass('focus');}else{$target.addClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().addClass('focus');}});};ModalKPIManage.prototype.initPointMap=function(points){var _this=this;var $dom;points.forEach(function(point){_this.initPointDetail(point.dsItemId,point.data);});};ModalKPIManage.prototype.initPointDetail=function(id,strData){var $dom=$('[data-point="'+id+'"]');if($dom.length==0)return;var data;try{data=JSON.parse(strData);}catch(e){$dom.text('No Data');$('.pointDetail[data-detail="'+id+'"]').text('No Data');return;}
$dom.text(parseFloat(data.score)+'%');var status='';if(parseFloat(data.score)>=60){status='success';}else if(parseInt(data.score)>=0){status='danger';}else{status='default';}
$dom.removeClass('success danger default').addClass(status);var $detail=$('.pointDetail[data-detail="'+id+'"]');if($detail.length>0){$detail.removeClass('success danger default').addClass(status);$detail.text(data.detail);}
if($dom.hasClass('spItemInfo')){$dom.prev().removeClass('success danger default').addClass(status);}};ModalKPIManage.prototype.initStruct=function(struct){var _this=this;var structDom=document.createElement('div');structDom.className='divStructCtn focus';var defaultSvg='<svg version="1.1" id="图形" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                    <path class="svgpath" data-index="path_0" fill="#272636" d="M1002.496 414.208c-5.44-28.672-22.592-47.04-43.456-46.528l-4.352 0c-71.808 0-130.24-58.432-130.24-130.24 0-23.68 11.264-49.6 11.328-49.792 11.072-24.96 2.56-55.616-19.84-71.232l-1.216-0.832-125.248-69.568-1.28-0.576c-7.424-3.2-15.552-4.864-24.192-4.864-17.856 0-35.328 7.104-46.784 19.008-15.296 15.808-63.488 56.768-102.4 56.768-39.296 0-87.808-41.792-103.168-57.856-11.52-12.16-29.12-19.392-47.168-19.392-8.448 0-16.448 1.6-23.744 4.672L339.2 44.224 209.536 115.456l-1.28 0.896C185.792 131.968 177.216 162.56 188.288 187.52c0.128 0.256 11.328 26.24 11.328 49.856 0 71.808-58.432 130.24-130.24 130.24L65.024 367.616c-20.928-0.512-38.08 17.92-43.456 46.528C21.12 416.448 11.072 470.144 11.072 512.384c0 42.304 10.048 95.936 10.496 98.176 5.376 28.288 22.08 46.592 42.688 46.592 0.256 0 0.512 0 0.768 0l4.352 0c71.808 0 130.24 58.432 130.24 130.24 0 23.68-11.264 49.6-11.328 49.792-11.072 24.96-2.56 55.616 19.776 71.232l1.216 0.832 122.88 68.736 1.28 0.576c7.424 3.264 15.488 4.928 24.128 4.928 18.048 0 35.648-7.424 47.04-19.84 14.4-15.68 64.576-60.352 104.704-60.352 40.448 0 89.792 44.416 105.408 61.504 11.456 12.608 29.184 20.16 47.36 20.16l0 0 0 0c8.448 0 16.384-1.6 23.68-4.736l1.344-0.576 127.36-70.4 1.28-0.896c22.4-15.616 30.976-46.272 19.904-71.168-0.128-0.256-11.328-26.24-11.328-49.856 0-71.808 58.432-130.24 130.24-130.24l4.352 0c20.928 0.448 38.08-17.92 43.456-46.528 0.448-2.24 10.496-55.936 10.496-98.176C1012.928 470.144 1002.88 416.448 1002.496 414.208L1002.496 414.208zM509.824 685.248c-95.68 0-173.504-77.824-173.504-173.504 0-95.68 77.824-173.504 173.504-173.504 95.68 0 173.504 77.824 173.504 173.504C683.264 607.424 605.44 685.248 509.824 685.248L509.824 685.248zM509.824 685.248"></path>\
                    <path class="svgpath" data-index="path_1" fill="#272636" d="M509.824 397.248 509.824 397.248c-63.104 0-114.496 51.328-114.496 114.496 0 63.104 51.328 114.496 114.496 114.496 63.104 0 114.496-51.328 114.496-114.496C624.256 448.64 572.928 397.248 509.824 397.248L509.824 397.248zM509.824 397.248"></path>\
                </svg>';var structTtl=document.createElement('div');structTtl.className='divStructTtl';structTtl.innerHTML='\
            <span class="spStructIcon">'+defaultSvg+'</span>\
            <span class="spStructName">'+struct.name+'</span>\
            <span class="spStructValue">综合达标率：<span class="spStructPt" data-point="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'">Loading</span></span>\
            <!--<span class="pointDetail" data-detail="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'">Loading</span>-->';var structBody=document.createElement('div');structBody.className='divStuctBody';structBody.appendChild(this.createStructItemTtl(struct.children));if(struct.children instanceof Array&&struct.children.length>0){struct.children.forEach(function(item,index){structBody.appendChild(_this.createStructItem(item));structBody.appendChild(_this.createPointDetail(item));});}
structDom.appendChild(structTtl);structBody.appendChild(_this.createPointDetail(struct));structDom.appendChild(structBody);this.container.appendChild(structDom);};ModalKPIManage.prototype.createStructItemTtl=function(){var structItemTtl=document.createElement('div');structItemTtl.className='divStructItemTtl';structItemTtl.innerHTML='\
            <span class="spStructItemTtl">考核项</span>\
            <span class="spStructItemTtl">考核结果</span>\
            <span class="spStructItemTtl">月达标率</span>\
            ';return structItemTtl;};ModalKPIManage.prototype.createPointDetail=function(item){var structDetail=document.createElement('tr');structDetail.className='rowPointDetail';structDetail.innerHTML='<td class="divPointDetail" colspan="5"><span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">Loading</span></td>';return structDetail;};ModalKPIManage.prototype.createStructItem=function(item){var structItem=document.createElement('div');structItem.className='divStructItem';structItem.innerHTML='\
            <span class="spItemInfo">'+(item.name?item.name:'')+'</span>\
            <span class="spItemInfo spItemKPIRs">\
                <span class="label label-success">达&nbsp;&nbsp;&nbsp;标</span>\
                <span class="label label-danger">不达标</span>\
                <span class="label label-default">未开启</span>\
            </span>\
            <span class="spItemInfo" data-point="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">Loading</span>\
            <!--<span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">Loading</span>-->';return structItem;};ModalKPIManage.prototype.updateModal=function(points){this.initPointMap(points);};ModalKPIManage.prototype.showConfigMode=function(){};ModalKPIManage.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0]};this.entity.modal.option.prefix='@'+AppConfig.datasource.getDSItemById(option.points[0]).projId+'|';return WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:this.entity.modal.option.structPoint});};return ModalKPIManage;}();var ModalEnergySaveRate=function(){function ModalEnergySaveRate(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalEnergySaveRate.prototype=new ModalBase();ModalEnergySaveRate.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_ENERGY_SAVE_RATE',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalEnergySaveRate'};ModalEnergySaveRate.prototype.renderModal=function(){var _this=this;WebAPI.get('/static/scripts/spring/entities/modalEnergySaveRate.html').done(function(resultHtml){_this.container.innerHTML=resultHtml;I18n.fillArea($('#energySaveName').parent());});},ModalEnergySaveRate.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+'%';$('#energySavePerVal').text(show);$('#progressItem').css('width',show);},ModalEnergySaveRate.prototype.showConfigMode=function(){var _this=this;},ModalEnergySaveRate.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalEnergySaveRate;}();var ModalCoalSaveTotal=function(){function ModalCoalSaveTotal(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalCoalSaveTotal.prototype=new ModalBase();ModalCoalSaveTotal.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_COAL_SAVE_TOTAL',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalCoalSaveTotal'};ModalCoalSaveTotal.prototype.renderModal=function(){this.container.innerHTML=template;I18n.fillArea($('#coalSaveName').parent());},ModalCoalSaveTotal.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+' Ton';$('#coalSaveVal').text(show);},ModalCoalSaveTotal.prototype.showConfigMode=function(){var _this=this;},ModalCoalSaveTotal.prototype.setModalOption=function(option){this.entity.modal.interval=5;};var template='<style type="text/css">\
        .frameCtl {position: relative;height: 100%;}\
        .imgBackground {position: absolute;width: 100%;height: 100%;right: 0;bottom: 0;top: 0;left: 0;z-index: -1;}\
        #coalSaveVal {position: absolute;left: 60px;top: 40px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
        #coalSaveName {position: absolute;left: 60px;top: 80px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
    </style>\
    <div class="frameCtl">\
        <img src="/static/images/spring/entities/modalCoalSaveTotal.png" class="imgBackground" alt="Background image">\
        <div id="coalSaveVal"> Ton</div>\
        <div id="coalSaveName" i18n="dashboard.carbonFootprint.STANDARD_COAL_SAVING"></div>\
    </div>';return ModalCoalSaveTotal;}();var ModalCo2SaveTotal=function(){function ModalCo2SaveTotal(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalCo2SaveTotal.prototype=new ModalBase();ModalCo2SaveTotal.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CO2_SAVE_TOTAL',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalCo2SaveTotal'};ModalCo2SaveTotal.prototype.renderModal=function(){this.container.innerHTML=template;I18n.fillArea($('#co2Name').parent());},ModalCo2SaveTotal.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+' Ton';$('#co2SaveVal').text(show);},ModalCo2SaveTotal.prototype.showConfigMode=function(){var _this=this;};ModalCo2SaveTotal.prototype.setModalOption=function(option){this.entity.modal.interval=5;};var template='<style type="text/css">\
        .frameCtl {position: relative;height: 100%;}\
        .imgBackground {position: absolute;width: 100%;height: 100%;right: 0;bottom: 0;top: 0;left: 0;z-index: -1;}\
        #co2SaveVal {position: absolute;left: 60px;top: 40px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
        #co2Name {position: absolute;left: 60px;top: 80px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
    </style>\
    <div class="frameCtl">\
        <img src="/static/images/spring/entities/modalCo2SaveTotal.png" class="imgBackground" alt="Background image">\
        <div id="co2SaveVal"></div>\
        <div id="co2Name" i18n="dashboard.carbonFootprint.CO2_SAVING"></div>\
    </div>';return ModalCo2SaveTotal;}();var ModalKPIConfig=function($,window,undefined){var _this;function ModalKPIConfig(options){_this=this;this.options=$.extend({},DEFAULTS,options);this.$wrap=null;}
ModalKPIConfig.prototype.show=function(){var domPanelContent=document.getElementById('paneContent');if($('#modalKPIConfigWrap').length>0){this.$modal.modal('show');return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalKPIConfig.html').done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-kpi-config-wrap" id="modalKPIConfigWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this.init();_this.$modal.modal('show');});};ModalKPIConfig.prototype.init=function(){this.$formWrap=$("#formWrap",this.$wrap);this.$btnClose=$('.close',this.$wrap);this.$btnWarnMode=$('#btnWarnMode',this.$formWrap);this.$ulWarnMode=$('#ulWarnMode',this.$formWrap);this.$btnWarnTimeMode=$('#btnWarnTimeMode',this.$formWrap);this.$ulWarnTimeMode=$('#ulWarnTimeMode',this.$formWrap);this.$btnPreWarnMode=$('#btnPreWarnMode',this.$formWrap);this.$ulPreWarnMode=$('#ulPreWarnMode',this.$formWrap);this.$btnPreWarnTimeMode=$('#btnPreWarnTimeMode',this.$formWrap);this.$ulPreWarnTimeMode=$('#ulPreWarnTimeMode',this.$formWrap);this.$btnDataCycleMode=$('#btnDataCycleMode',this.$formWrap);this.$ulDataCycleMode=$('#ulDataCycleMode',this.$formWrap);this.$btnStartMonth=$('#btnStartMonth',this.$formWrap);this.$ulStartMonth=$('#ulStartMonth',this.$formWrap);this.$btnHistoryValUsage=$('#btnHistoryValUsage',this.$formWrap);this.$btnPreHistoryValUsage=$('#btnPreHistoryValUsage',this.$formWrap);this.$fgWarnRange=$('#fgWarnRange',this.$formWrap);this.$fgWarnTime=$('#fgWarnTime',this.$formWrap);this.$fgWarnTimeRange=$('#fgWarnTimeRange',this.$formWrap);this.$fgPreWarnRange=$('#fgPreWarnRange',this.$formWrap);this.$fgPreWarnTime=$('#fgPreWarnTime',this.$formWrap);this.$fgPreWarnTimeRange=$('#fgPreWarnTimeRange',this.$formWrap);this.$fgiStartMonth=$('#fgiStartMonth',this.$formWrap);this.$iptChartName=$('#iptChartName',this.$formWrap);this.$iptChartLowerLimit=$('#iptChartLowerLimit',this.$formWrap);this.$iptChartUpperLimit=$('#iptChartUpperLimit',this.$formWrap);this.$divTargetPoint=$('#divTargetPoint',this.$formWrap);this.$divReferencePoint=$('#divReferencePoint',this.$formWrap);this.$btnCondition=$('#btnCondition',this.$formWrap);this.$iptConditionVal=$('#iptConditionVal',this.$formWrap);this.$btnIsShowRC=$('#btnIsShowRC',this.$formWrap);this.$iptLowerWarnVal=$('#iptLowerWarnVal',this.$formWrap);this.$iptUpperWarnVal=$('#iptUpperWarnVal',this.$formWrap);this.$iptPreGreaterThan=$('#iptPreGreaterThan',this.$formWrap);this.$iptPreLessThan=$('#iptPreLessThan',this.$formWrap);this.$iptWarnTimeRangeStart=$('#iptWarnTimeRangeStart',this.$formWrap);this.$iptPreWarnTimeRangeStart=$('#iptPreWarnTimeRangeStart',this.$formWrap);this.$dropArea=$('.drop-area',this.$formWrap);this.$btnSubmit=$('#btnSubmit',this.$wrap);this.attachEvents();this.initValidator();$(".datetime").datetimepicker('remove');$(".datetime").datetime({pickerPosition:'top-right'});};ModalKPIConfig.prototype.initValidator=function(){};ModalKPIConfig.prototype.displayField=function(animArr,doAnim){var $animWrap=animArr[0].$ele.parent('.optional');var actionGroup={$show:$(),$hide:$()};var showLen,curShowLen=$animWrap.children('.on').length;var $all;if(doAnim===undefined)doAnim=true;for(var i=0,len=animArr.length;i<len;i++){actionGroup['$'+animArr[i].action]=actionGroup['$'+animArr[i].action].add(animArr[i].$ele);}
showLen=actionGroup.$show.length;if(!doAnim){actionGroup.$hide.removeClass('on').css('display','none');actionGroup.$show.addClass('on').css('display','');$animWrap.height(49*showLen);return;}
$all=actionGroup.$hide.add(actionGroup.$show).filter('.on');$all.filter('.on').eq(0).one('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'){$all.css('display','none');if(showLen!==curShowLen){$animWrap.height(49*showLen);$animWrap.off('transitionend').on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='height'){actionGroup.$show.css('display','');window.setTimeout(function(){actionGroup.$show.addClass('on');},0);}
e.stopPropagation();});}else{actionGroup.$show.css('display','');window.setTimeout(function(){actionGroup.$show.addClass('on');},0);}}
e.stopPropagation();});$all.removeClass('on');};ModalKPIConfig.prototype.reset=function(name){var animArr=[];name=typeof name==='string'?[name]:name;if(!name){this.$iptChartName.val('');this.$iptChartLowerLimit.val('');this.$iptChartUpperLimit.val('');this.$divTargetPoint.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');this.$divReferencePoint.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');this.$btnCondition.attr('data-value',0).children('span').eq(0).text('Equal To (=)');this.$iptConditionVal.val('');this.$btnWarnMode.attr('data-value',0).children('span').eq(0).text('From User Input');this.$btnHistoryValUsage.attr('data-value',0).children('span').eq(0).text('Use As Lower Limit');this.$iptWarnTimeRangeStart.val('');this.$iptLowerWarnVal.val('');this.$iptUpperWarnVal.val('');this.$btnPreWarnMode.attr('data-value',0).children('span').eq(0).text('From User Input');this.$iptPreGreaterThan.val('');this.$iptPreLessThan.val('');animArr=[];animArr.push({$ele:this.$fgWarnRange,action:'show'});animArr.push({$ele:this.$fgWarnTime,action:'hide'});animArr.push({$ele:this.$fgWarnTimeRange,action:'hide'});this.displayField(animArr,false);animArr=[];animArr.push({$ele:this.$fgPreWarnRange,action:'show'});animArr.push({$ele:this.$fgPreWarnTime,action:'hide'});animArr.push({$ele:this.$fgPreWarnTimeRange,action:'hide'});this.displayField(animArr,false);}
if(!name||name.indexOf('warn-time')>-1){this.$btnWarnTimeMode.attr('data-value',0);this.$btnWarnTimeMode.children('span').eq(0).text('From User Input');this.$btnHistoryValUsage.attr('data-value',0);this.$btnHistoryValUsage.children('span').eq(0).text('Use As Lower Limit');}
if(!name||name.indexOf('start-month')>-1){this.$btnStartMonth.attr('data-value','');this.$btnStartMonth.children('span').eq(0).text('Start Month');}
if(!name||name.indexOf('pre-warn-time')>-1){this.$btnPreWarnTimeMode.attr('data-value',0);this.$btnPreWarnTimeMode.children('span').eq(0).text('From User Input');}};ModalKPIConfig.prototype.recoverForm=function(form){var name,animArr=[],animArr2=[];var _this=this;if(!form)return;this.$iptChartName.val(form.chartName);this.$iptChartLowerLimit.val(form.chartLowerLimit);this.$iptChartUpperLimit.val(form.chartUpperLimit);name=AppConfig.datasource.getDSItemById(form.targetPointId).alias;this.$divTargetPoint.attr({'data-value':form.targetPointId,'title':name}).html('<span>'+name+'</span>');name=AppConfig.datasource.getDSItemById(form.referencePointId).alias;if(name){this.$divReferencePoint.attr({'data-value':form.referencePointId,'title':name}).html('<span>'+name+'</span>');}
this.$btnCondition.attr('data-value',form.referenceCondition).children('span').eq(0).text(form.referenceConditionName);this.$iptConditionVal.val(form.referenceConditionVal);this.$btnDataCycleMode.attr('data-value',form.dataCycleMode).children('span').eq(0).text(form.dataCycleModeName);this.$btnWarnMode.attr('data-value',form.warnMode).children('span').eq(0).text(form.warnModeName);this.$btnWarnTimeMode.attr('data-value',form.warnTimeMode).children('span').eq(0).text(form.warnTimeModeName);this.$btnHistoryValUsage.attr('data-value',form.historyValUsage).children('span').eq(0).text(form.historyValUsageName);this.$iptWarnTimeRangeStart.val(form.warnTimeRangeStart);if(form.warnMode===1){animArr.push({$ele:this.$fgWarnRange,action:'hide'});animArr.push({$ele:this.$fgWarnTime,action:'show'});if(form.warnTimeMode===0){animArr.push({$ele:this.$fgWarnTimeRange,action:'show'});}else{animArr.push({$ele:this.$fgWarnTimeRange,action:'hide'});}
window.setTimeout(function(){_this.displayField(animArr);},1200);}
this.$iptLowerWarnVal.val(form.warnLowerLimit);this.$iptUpperWarnVal.val(form.warnUpperLimit);this.$btnPreWarnMode.attr('data-value',form.preWarnMode).children('span').eq(0).text(form.preWarnModeName);this.$iptPreGreaterThan.val(form.preGreaterThan);this.$iptPreLessThan.val(form.preLessThan);this.$btnPreWarnTimeMode.attr('data-value',form.preWarnTimeMode).children('span').eq(0).text(form.preWarnTimeModeName);this.$btnPreHistoryValUsage.attr('data-value',form.preHistoryValUsage).children('span').eq(0).text(form.preHistoryValUsageName);this.$iptPreWarnTimeRangeStart.val(form.preWarnTimeRangeStart);if(form.preWarnMode===1){animArr2.push({$ele:this.$fgPreWarnRange,action:'hide'});animArr2.push({$ele:this.$fgPreWarnTime,action:'show'});if(form.preWarnTimeMode===0){animArr2.push({$ele:this.$fgPreWarnTimeRange,action:'show'});}else{animArr2.push({$ele:this.$fgPreWarnTimeRange,action:'hide'});}
window.setTimeout(function(){_this.displayField(animArr2);},1200);}};ModalKPIConfig.prototype.setOptions=function(options){this.options=$.extend({},this.options,options);};ModalKPIConfig.prototype.attachEvents=function(){$('.dropdown-menu',this.$wrap).off('click.selected').on('click.selected','a',function(e){var $this=$(this);var $btn=$this.parents('.dropdown-wrap').children('button');var value=$this.attr('data-value');var text=$this.text();$btn.attr('data-value',value);$btn.children('span').eq(0).text(text);e.preventDefault();});this.$modal.off('show.bs.modal').on('show.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.recoverForm(_this.options.modalIns.entity.modal.option);if(!$rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.reset();if($rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$ulWarnMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnWarnMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnWarnMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgWarnRange,action:'show'});animArr.push({$ele:_this.$fgWarnTime,action:'hide'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'hide'});}else{_this.reset(['warn-time']);animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'show'});}
_this.displayField(animArr);});this.$ulWarnTimeMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnWarnTimeMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnWarnTimeMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'show'});}else{animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'hide'});}
_this.displayField(animArr);});this.$ulPreWarnMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnPreWarnMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnPreWarnMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgPreWarnRange,action:'show'});animArr.push({$ele:_this.$fgPreWarnTime,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'hide'});}else{_this.reset('pre-warn-time');animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'show'});}
_this.displayField(animArr);});this.$ulPreWarnTimeMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnPreWarnTimeMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnPreWarnTimeMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'show'});}else{animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'hide'});}
_this.displayField(animArr);});this.$ulDataCycleMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnDataCycleMode.attr('data-value'));var lastMonth,lastMonth2,nowMonth,lang,arrHtml=[];var liTmpl='<li><a href="javascript:;" data-value="{0}">{1}</a></li>';if(value===lastValue)return;_this.$btnDataCycleMode.attr('data-value',value);if(value===0)_this.$fgiStartMonth.removeClass('on');else{lang=I18n.type;nowMonth=DateUtil.getNextMonth(new Date().getMonth());lastMonth=DateUtil.getLastMonth(nowMonth);lastMonth2=DateUtil.getLastMonth(lastMonth);arrHtml.push(liTmpl.format(lastMonth2,DateUtil.getMonthNameShort(lastMonth2-1,lang)));arrHtml.push(liTmpl.format(lastMonth,DateUtil.getMonthNameShort(lastMonth-1,lang)));arrHtml.push(liTmpl.format(nowMonth,DateUtil.getMonthNameShort(nowMonth-1,lang)));_this.$ulStartMonth.html(arrHtml.join(''));_this.reset('start-month');_this.$fgiStartMonth.addClass('on');}});this.$dropArea.off('dragover').on('dragover',function(e){e.preventDefault();});this.$dropArea.off('dragenter').on('dragenter',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});this.$dropArea.off('dragleave').on('dragleave',function(e){$(e.target).removeClass('on');e.stopPropagation();});this.$dropArea.off('drop').on('drop',function(e){var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');name=AppConfig.datasource.getDSItemById(itemId).alias;$target.attr({'data-value':itemId,'title':name});$target.html('<span>'+name+'</span>');e.stopPropagation();});this.$btnSubmit.off().click(function(){var form={};form.chartName=_this.$iptChartName.val();form.chartLowerLimit=parseFloat(_this.$iptChartLowerLimit.val());form.chartUpperLimit=parseFloat(_this.$iptChartUpperLimit.val());form.targetPointId=_this.$divTargetPoint.attr('data-value');form.referencePointId=_this.$divReferencePoint.attr('data-value');form.referenceCondition=parseInt(_this.$btnCondition.attr('data-value'));form.referenceConditionName=_this.$btnCondition.children('span').eq(0).text();form.referenceConditionVal=parseFloat(_this.$iptConditionVal.val());form.dataCycleMode=parseInt(_this.$btnDataCycleMode.attr('data-value'));form.dataCycleModeName=_this.$btnDataCycleMode.children('span').eq(0).text();form.btnStartMonth=_this.$btnStartMonth.attr('data-value');form.warnMode=parseInt(_this.$btnWarnMode.attr('data-value'));form.warnModeName=_this.$btnWarnMode.children('span').eq(0).text();form.isShowRC=parseInt(_this.$btnIsShowRC.attr('data-value'));form.isShowRCName=_this.$btnIsShowRC.children('span').eq(0).text();form.warnLowerLimit=parseFloat(_this.$iptLowerWarnVal.val());form.warnUpperLimit=parseFloat(_this.$iptUpperWarnVal.val());form.warnTimeMode=parseInt(_this.$btnWarnTimeMode.attr('data-value'));form.warnTimeModeName=_this.$btnWarnTimeMode.children('span').eq(0).text();form.historyValUsage=parseInt(_this.$btnHistoryValUsage.attr('data-value'));form.historyValUsageName=_this.$btnHistoryValUsage.children('span').eq(0).text();form.warnTimeRangeStart=_this.$iptWarnTimeRangeStart.val();form.preWarnMode=parseInt(_this.$btnPreWarnMode.attr('data-value'));form.preWarnModeName=_this.$btnPreWarnMode.children('span').eq(0).text();form.preGreaterThan=parseFloat(_this.$iptPreGreaterThan.val());form.preLessThan=parseFloat(_this.$iptPreLessThan.val());form.preWarnTimeMode=parseInt(_this.$btnPreWarnTimeMode.attr('data-value'));form.preWarnTimeModeName=_this.$btnPreWarnTimeMode.children('span').eq(0).text();form.preHistoryValUsage=parseInt(_this.$btnPreHistoryValUsage.attr('data-value'));form.preHistoryValUsageName=_this.$btnPreHistoryValUsage.children('span').eq(0).text();form.preWarnTimeRangeStart=_this.$iptPreWarnTimeRangeStart.val();_this.options.onSubmit.call(_this.options.modalIns,form);_this.$btnClose.trigger('click');});};ModalKPIConfig.prototype.detachEvents=function(){};ModalKPIConfig.prototype.destroy=function(){this.detachEvents();this.$wrap.remove();};var DEFAULTS={};return ModalKPIConfig;}(jQuery,window);var ModalKPIChart=function($){var PRECISION=2;function ModalKPIChart(screen,entityParams){ModalBase.call(this,screen,entityParams,this._render,null,this._showConfig);this.options=$.extend(true,{},DEFAULTS);this.historyChartOptions=$.extend(true,{},HISTORY_CHART_DEFAULTS);this.startline=null;this.endline=null;this.targetPointData=null;this.referencePointData=null;this.refreshTimesInOneHour=1;this.period=null;this.indicators={};this.samplingPeriod={format:'h1',value2ms:3600000};this.historyChart=null;this.$lkUpdateTime=null;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;}
ModalKPIChart.prototype=Object.create(ModalBase.prototype);ModalKPIChart.prototype.constructor=ModalKPIChart;ModalKPIChart.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_KPI_CHART',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalKPIChart'};ModalKPIChart.prototype.init=function(){var $panel=$(this.container).closest('.panel');this.$lkUpdateTime=$('<div class="lk-update-time" title="Last Update Time"><span class="glyphicon glyphicon-time"></span><span>updating...</span></div>').appendTo($panel);};ModalKPIChart.prototype._render=function(){var _this=this;var option=this.entity.modal.option;var min=option.chartLowerLimit||0;var max=option.chartUpperLimit||100;var warnMode=option.warnMode;var warnLower=option.warnLowerLimit;var warnUpper=option.warnUpperLimit;var preWarnMode=option.preWarnMode;var preWarnLower=warnLower+option.preGreaterThan;var preWarnUpper=warnUpper-option.preLessThan;var historyValUsage=option.historyValUsage;var targetPointId=option.targetPointId;var referencePointId=option.referencePointId;var dataCycleMode=option.dataCycleMode;var period=this.period=this.getTimePeriod();var postData;var ids=referencePointId?[targetPointId,referencePointId]:[targetPointId];postData=[{dsItemIds:ids,timeStart:period.nowStart,timeEnd:period.nowEnd,timeFormat:this.samplingPeriod.format}];if(warnMode===1){postData.push({dsItemIds:ids,timeStart:period.refStart,timeEnd:period.refEnd,timeFormat:this.samplingPeriod.format});}
this.init();this.options.series[0].data[0].value=min;this.options.series[0].min=min;this.options.series[0].max=max;this.historyChartOptions.yAxis[0].min=min;this.historyChartOptions.yAxis[0].max=max;this.options.tooltip.formatter=function(p){return p.seriesName+': <strong>'+p.value+'</strong><br/>From: '+_this.store.timeShaft[0]+'<br/>To: '+_this.store.timeShaft[_this.store.timeShaft.length-1];};this.spinner.spin(this.container);WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(rs){var axisColor=_this.options.series[0].axisLine.lineStyle.color;var range=max-min;var maxIndex;_this.store={list:{},timeShaft:rs[0].timeShaft};for(var i=0,len=rs[0].list.length;i<len;i++){_this.store.list[rs[0].list[i].dsItemId]=rs[0].list[i].data;}
if(rs[1]!==undefined){_this.store2={list:{},timeShaft:rs[1].timeShaft};for(i=0,len=rs[1].list.length;i<len;i++){_this.store2.list[rs[1].list[i].dsItemId]=rs[1].list[i].data;}}
_this.filterPointData();_this.initIndicators();_this.setTimeParams();maxIndex=_this.store.fullTimeShaft.length-1;if(warnMode===0){if(warnLower!==undefined&&warnLower-min>0){axisColor.push([(warnLower-min)/range,'#ff4500']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Warn Line',value:warnLower,xAxis:0,yAxis:warnLower,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:warnLower}]);}
if(preWarnLower!==undefined&&preWarnLower-min>0){axisColor.push([(preWarnLower-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:preWarnLower,xAxis:0,yAxis:preWarnLower,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnLower}]);}
if(preWarnUpper!==undefined&&preWarnUpper-min>0){axisColor.push([(preWarnUpper-min)/range,'lightgreen']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:preWarnUpper,xAxis:0,yAxis:preWarnUpper,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:maxIndex,yAxis:preWarnUpper}]);}
if(warnUpper!==undefined&&warnUpper-min>0){axisColor.push([(warnUpper-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Warn Line',value:warnUpper,xAxis:0,yAxis:warnUpper,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:maxIndex,yAxis:warnUpper}]);}
axisColor.push([1,'#ff4500']);}
else{if(historyValUsage===0){axisColor.push([(_this.indicators.average2-min)/range,'#ff4500']);if(preWarnMode===0){preWarnLower=_this.indicators.average2+option.preGreaterThan;if(preWarnLower!==undefined&&preWarnLower-min>0){axisColor.push([(preWarnLower-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:preWarnLower.toFixed(PRECISION),xAxis:0,yAxis:preWarnLower,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnLower}]);}}else if(preWarnMode===1&&_this.indicators.preWarnValue>_this.indicators.average2){axisColor.push([(_this.indicators.preWarnValue-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:_this.indicators.preWarnValue.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.preWarnValue,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.preWarnValue}]);}
axisColor.push([1,'lightgreen']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Warn Line',value:_this.indicators.average2.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.average2,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.average2}]);}
else{if(preWarnMode===0){preWarnUpper=_this.indicators.average2-option.preLessThan;if(preWarnUpper!==undefined&&preWarnUpper-min>0){axisColor.push([(preWarnUpper-min)/range,'lightgreen']);axisColor.push([(_this.indicators.average2-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:preWarnUpper.toFixed(PRECISION),xAxis:0,yAxis:preWarnUpper,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnUpper}]);}}else if(preWarnMode===1&&_this.indicators.preWarnValue<_this.indicators.average2){axisColor.push([(_this.indicators.preWarnValue-min)/range,'lightgreen']);axisColor.push([(_this.indicators.average2-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:_this.indicators.preWarnValue.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.preWarnValue,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.preWarnValue}]);}else{axisColor.push([(_this.indicators.average2-min)/range,'lightgreen']);}
axisColor.push([1,'#ff4500']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Warn Line',value:_this.indicators.average2.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.average2,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.average2}]);}}
_this.fitContainer();_this.chart=echarts.init(_this.container,AppConfig.chartTheme);_this.chart.clear();_this.chart.setOption(_this.options);_this.reloadChart();}).always(function(){_this.spinner.stop();});};ModalKPIChart.prototype.filterPointData=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var cond=option.referenceCondition;var condVal=option.referenceConditionVal;var tPoints=null,rPoints=null;if(!option.referencePointId)return;tPoints=this.store.list[option.targetPointId];rPoints=this.store.list[option.referencePointId];if(tPoints.length!==rPoints.length)return;for(var i=0,len=rPoints.length;i<len;i++){tPoints[i]=parseFloat(tPoints[i]);rPoints[i]=parseFloat(rPoints[i]);if(!this.isPointRuled(rPoints[i],condVal,cond)){tPoints[i]='-';}}
if(warnMode===1){tPoints=this.store2.list[option.targetPointId];rPoints=this.store2.list[option.referencePointId];if(tPoints.length!==rPoints.length)return;for(var i=0,len=rPoints.length;i<len;i++){tPoints[i]=parseFloat(tPoints[i]);rPoints[i]=parseFloat(rPoints[i]);if(!this.isPointRuled(rPoints[i],condVal,cond)){tPoints[i]='-';}}}};ModalKPIChart.prototype.isPointRuled=function(pointVal,condVal,cond){if(condVal===null)return true;switch(cond){case 0:return pointVal===condVal;case 1:return pointVal<condVal;case 2:return pointVal>condVal;default:return true;}};ModalKPIChart.prototype.setAnimation=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var historyValUsage=option.historyValUsage;var warnLower=option.warnLowerLimit;var warnUpper=option.warnUpperLimit;var preWarnLower=warnLower+option.preGreaterThan;var preWarnUpper=warnUpper-option.preLessThan;var $parent=$(this.container).parents('.panel');var curVal=this.indicators.average;$parent.removeClass('warn-anim pre-warn-anim');if(warnMode===1){if(historyValUsage===0&&curVal<this.indicators.average2||historyValUsage===1&&curVal>this.indicators.average2){$parent.addClass('warn-anim');}}else{switch(true){case curVal<preWarnLower:$parent.addClass('pre-warn-anim');break;case curVal<warnLower:$parent.addClass('warn-anim');break;case curVal<preWarnUpper:break;case curVal<warnUpper:$parent.addClass('pre-warn-anim');break;default:$parent.addClass('warn-anim');break;}}};ModalKPIChart.prototype.update=function(rs){var option=this.entity.modal.option;var targetPointId=option.targetPointId;var referencePointId=option.referencePointId;var targetPointData,referencePointData;var lastTick,nowTick;if(!this.store)return;lastTick=this.store.timeShaft[this.store.timeShaft.length-1];lastTick=lastTick.toDate().valueOf()+60000;nowTick=new Date().valueOf();if(nowTick<lastTick){return;}
for(var i=0,len=rs.length;i<len;i++){if(targetPointId===rs[i].dsItemId){targetPointData=parseFloat(rs[i].data);}
if(referencePointId===rs[i].dsItemId){referencePointData=parseFloat(rs[i].data);}}
if(isNaN(targetPointData))return;this.appendData(targetPointData,referencePointData);this.reloadChart();};ModalKPIChart.prototype.reloadChart=function(){this.options.series[0].data[0].value=this.indicators.average.toFixed(PRECISION);var opt=this.chart.getOption();opt.series=this.options.series;this.chart.setOption(opt);this.setAnimation();this.$lkUpdateTime.children('span').eq(1).text(new Date().format('HH:mm'));};ModalKPIChart.prototype._showConfig=function(){};ModalKPIChart.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalKPIChart.prototype.setOptions=function(options){this.options=$.extend({},this.opitons,options);};ModalKPIChart.prototype.destroy=function(){};ModalKPIChart.prototype.saveConfig=function(form){this.entity.modal.title=form.chartName;this.entity.modal.points=[form.targetPointId];if(form.referencePointId)this.entity.modal.points.push(form.referencePointId);this.entity.modal.option=form;this.entity.modal.interval=60000;};ModalKPIChart.prototype.configModal=new ModalKPIConfig({onSubmit:function onSubmit(form){this.saveConfig(form);}});ModalKPIChart.prototype.getTimePeriod=function(){var now;var period={};var option=this.entity.modal.option;var warnMode=option.warnMode;var historyValUsage=option.historyValUsage;var warnStart=option.warnTimeRangeStart;var warnTimeMode=option.warnTimeMode;var startDate=option.warnTimeRangeStart;var circleMode=option.dataCycleMode;var startMonth;if(!this.m_bIsGoBackTrace){now=new Date();this.DEFAULTS=true;this.HISTORY_CHART_DEFAULTS=true;}else{now=this.m_traceData.currentTime;this.DEFAULTS=false;this.HISTORY_CHART_DEFAULTS=false;}
if(circleMode===0){period.nowStart=now.format('yyyy-MM-01 00:00:00');period.nowEnd=now.format('yyyy-MM-dd HH:mm:ss');if(warnMode===0)return period;if(warnTimeMode===0){period.refStart=warnStart.toDate().format('yyyy-MM');period.refEnd=period.refStart+'-'+DateUtil.daysInMonth(period.refStart.toDate())+' 23:59:59';period.refStart+='-01 00:00:00';}else{period.refStart=now.format('yyyy')-1+now.format('-MM');period.refEnd=period.refStart+'-'+DateUtil.daysInMonth(period.refStart.toDate())+' 23:59:59';period.refStart+='-01 00:00:00';}
period.lag=period.nowStart.toDate().valueOf()-period.refStart.toDate().valueOf();}
else{}
return period;};ModalKPIChart.prototype.initIndicators=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var preWarnMode=option.preWarnMode;var dsId=option.targetPointId;var data=this.store.list[dsId];var average=0,sum=0;var list1,list2;for(var i=0,len=data.length;i<len;i++){if(isNaN(data[i]))continue;average+=data[i]*1;};if(isNaN(average))this.indicators.average=this.entity.modal.option.chartLowerLimit;else this.indicators.average=average/len;if(warnMode===1){average=0;data=this.store2.list[dsId];for(var i=0,len=data.length;i<len;i++){if(isNaN(parseFloat(data[i])))continue;average+=data[i]*1;};if(isNaN(average))this.indicators.average2=this.entity.modal.option.chartLowerLimit;else this.indicators.average2=average/len;}
if(preWarnMode===1){this.setPreWarnValue();}};ModalKPIChart.prototype.setPreWarnValue=function(){var option=this.entity.modal.option;var targetPointId=option.targetPointId;var warnMode=option.warnMode;var preHistoryValUsage=option.preHistoryValUsage;var list1=this.store.list[targetPointId];var list2=this.store2.list[targetPointId];var average=0;var sum=0;var validNum=0;for(var i=0,len1=list1.length,len2=list2.length;i<len2;i++){if(i>=len1){if(isNaN(list2[i]))continue;sum+=list2[i];}else{if(isNaN(list1[i]))continue;sum+=list1[i];}
validNum+=1;}
if(warnMode===1){this.indicators.preWarnValue=this.indicators.average+this.indicators.average2-sum/validNum;}else{if(preHistoryValUsage===0){this.indicators.preWarnValue=this.indicators.average+option.warnLowerLimit-sum/validNum;}else{this.indicators.preWarnValue=this.indicators.average+option.warnUpperLimit-sum/validNum;}}};ModalKPIChart.prototype.appendData=function(tValue,rValue){var lastTick=this.store.timeShaft[this.store.timeShaft.length-1];var option=this.entity.modal.option;var preWarnMode=option.preWarnMode;var targetPointId=option.targetPointId;var targetPointList=this.store.list[targetPointId];var cond=option.referenceCondition;var condVal=option.referenceConditionVal;var len=this.store.list[targetPointId].length;var nowStr=new Date().format('yyyy-MM-dd HH:00:00');var lastValue,newLastValue;var timeStamp;if(isNaN(rValue)||this.isPointRuled(rValue,condVal,cond)){tValue=tValue.toFixed(3)*1;if(lastTick!==nowStr){timeStamp=lastTick.toDate().valueOf();if(nowStr.toDate().valueOf()-timeStamp>3600000){this.store.timeShaft.push(new Date(timeStamp+3600000).format('yyyy-MM-dd HH:00:00'));}
this.store.timeShaft.push(nowStr);this.refreshTimesInOneHour=0;this.indicators.average=(this.indicators.average*len+tValue)/(len+1);targetPointList.push(tValue);}else{lastValue=targetPointList[targetPointList.length-1];newLastValue=(lastValue*this.refreshTimesInOneHour+tValue)/(this.refreshTimesInOneHour+1);targetPointList[targetPointList.length-1]=newLastValue.toFixed(3)*1;this.indicators.average=(this.indicators.average*len-lastValue+newLastValue)/len;this.refreshTimesInOneHour+=1;}
if(preWarnMode===1){this.setPreWarnValue();}}};ModalKPIChart.prototype.setTimeParams=function(){if(this.store.timeShaft.length==0)return;var lastTick=this.store.timeShaft[this.store.timeShaft.length-1].toDate().valueOf();var option=this.entity.modal.option;var tick=lastTick+this.samplingPeriod.value2ms;var now=new Date();this.store.fullTimeShaft=this.store.timeShaft.concat();if(option.dataCycleMode===0){this.store.deadline=now.format('yyyy-MM-'+DateUtil.daysInMonth(now)+' 23:55:00').toDate();while(tick<=this.store.deadline){tick+=this.samplingPeriod.value2ms;this.store.fullTimeShaft.push(tick.toDate().format('yyyy-MM-dd HH:mm:ss'));}}
else{}};ModalKPIChart.prototype.fitContainer=function(){var row=this.entity.spanR;var column=this.entity.spanC;if(Math.min(row,column)<3){this.options.series[0].splitLine.length=15;this.options.series[0].axisLine.lineStyle.width=6;this.options.series[0].axisTick.length=12;this.options.series[0].pointer.width=4;this.options.series[0].detail.textStyle.fontSize=16;}};ModalKPIChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this._render();this.m_bIsGoBackTrace=false;};var DEFAULTS={tooltip:{},visualMap:{show:false},series:[{name:'KPI Indicator',type:'gauge',precision:2,splitNumber:10,axisTick:{show:true,splitNumber:5,length:20,lineStyle:{color:'auto',width:1,type:'solid'}},axisLine:{show:true,lineStyle:{color:[],width:1}},axisLabel:{textStyle:{color:'#a2adbc'}},splitLine:{show:true,length:30,lineStyle:{color:'auto',width:2,type:'solid'}},pointer:{length:'80%',width:4},detail:{offsetCenter:['0','-30%'],textStyle:{color:'#ccc',fontSize:20}},data:[{name:''}]}],animation:true};var HISTORY_CHART_DEFAULTS={title:{text:'History Data'},legend:{data:['Target Point']},tooltip:{trigger:'axis'},dataZoom:{show:false,realtime:true,start:0,end:100},grid:{y2:80},xAxis:[{type:'category'}],yAxis:[{type:'value'}],series:[{name:'Target Point',type:'line',symbolSize:0,markLine:{precision:3,symbol:'none',data:[]},markPoint:{symbol:'emptyCircle',effect:{show:true,shadowBlur:0},data:[]}}],animation:true};return ModalKPIChart;}(jQuery);var ModalObserverConfig=function($,window,undefined){var _this;function ModalObserverConfig(options){_this=this;this.options=$.extend({},DEFAULTS,options);this.$wrap=null;}
ModalObserverConfig.prototype.show=function(){var domPanelContent=document.getElementById('paneContent');if($('#modalObserverConfigWrap').length>0){this.$modal.modal('show');return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalObserverConfig.html').done(function(html){_this.$wrap=$('<div class="modal-observer-config-wrap" id="modalObserverConfigWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');WebAPI.get("/get_s3db_pages/"+AppConfig.projectId+"/"+AppConfig.userId).done(function(result){_this.init(result.pages);_this.$modal.modal('show');}).always(function(msg){Spinner.stop();});});};ModalObserverConfig.prototype.init=function(data){this.$formWrap=$('#obFormWrap','#modalObserverConfigWrap');this.$btnClose=$('.close','#modalObserverConfigWrap');this.$sltObserverId=$('#sltObserverId','#obFormWrap');this.$btnSubmit=$('#btnObSubmit','#modalObserverConfigWrap');var sb=new StringBuilder();for(var i=0,item,len=data.length;i<len;i++){item=data[i];sb.append('<option value="').append(item.id).append('">').append(item.name+' (width: '+item.width+', height: '+item.height+')</option>');}
this.$sltObserverId.html(sb.toString());this.attachEvents();};ModalObserverConfig.prototype.attachEvents=function(){this.$btnSubmit.off().click(function(e){var form={};form.id=_this.$sltObserverId.val().trim();_this.options.onSubmit.call(_this.options.modalIns,form);_this.$btnClose.trigger('click');e.preventDefault();});};ModalObserverConfig.prototype.setOptions=function(options){this.options=$.extend({},this.options,options);};var DEFAULTS={};return ModalObserverConfig;}(jQuery,window);var ModalObserver=function ModalObserver($,window,undefined){function ModalObserver(screen,entityParams){ModalBase.call(this,screen,entityParams,this._render,null,this._showConfig);this.options=$.extend(true,{},DEFAULTS);this.obScreen=null;};ModalObserver.prototype=Object.create(ModalBase.prototype);ModalObserver.prototype.constructor=ModalObserver;ModalObserver.prototype.optionTemplate={name:'toolBox.modal.OBSERVER',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalObserver'};ModalObserver.prototype._render=function(){var options=this.entity.modal.option;var id=options.id||'200000360';this.obScreen=new ObserverScreen(id);this.container=$(this.container).html('<div class="divMain" style="width: 100%; height: 100%;">\
                <div class="div-canvas-ctn" style="padding: 0; margin: 0 auto; height: 100%; width: 100%;">\
                    <canvas class="canvas-ctn" style="width: 100%; height: 100%;">浏览器不支持</canvas>\
                </div>\
                <div id="divObserverTools" style="height: 0"></div>\
            </div>')[0];this.obScreen.isInDashBoard=true;this.obScreen.show(this.container);};ModalObserver.prototype._showConfig=function(){};ModalObserver.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalObserver.prototype.saveConfig=function(form){this.entity.modal.option=form;this.entity.modal.points=[];};ModalObserver.prototype.configModal=new ModalObserverConfig({onSubmit:function onSubmit(form){this.saveConfig(form);}});ModalObserver.prototype._close=function(){if(this.obScreen)this.obScreen.close();};var DEFAULTS={};return ModalObserver;}(jQuery,window);var ModalMultiple=function(){function ModalMultiple(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalMultiple.prototype=new ModalRealtimeLine();ModalMultiple.prototype.optionTemplate={name:'toolBox.modal.MULTIPLE',parent:0,mode:['multiple'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMultiple',modelParams:{paraName:['line','bar','area','cumulativeBar'],paraShowName:{'line':'Line Chart Parameters','bar':"Bar Chart Parameters",'area':"Area Chart Parameters",'cumulativeBar':"Cumulative Bar Chart Parameters"},paraAnlysMode:'part'}};ModalMultiple.prototype.renderModal=function(){};ModalMultiple.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var pointNameList=function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId);}
return arr;}(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime).format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
var startTime=endTime.split(' ')[0]+' 00:00:00';this.lastRenderTime=now;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var entityItem=_this.dealWithData(dataSrc,2);var option={legend:{data:entityItem.arrLegend},grid:function(){if(AppConfig.isMobile){return{x2:40};}else{return{x2:50};}}(),xAxis:[{data:['00:00','01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00'],boundaryGap:true}],yAxis:[{type:'value',scale:false,splitArea:{show:false}},{type:'value',scale:false,splitArea:{show:false},splitLine:{show:function(){if(AppConfig.isMobile){return false;}else{return true;}}()}}],series:entityItem.arrSeries};if(_this.entity.modal.dsChartCog){var ptIndex=0;if(_this.entity.modal.dsChartCog[0].upper!=''){option.yAxis[1].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){option.yAxis[1].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){option.yAxis[1].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<_this.entity.modal.option.paraType[0].arrId.length;i++){for(var j=0;j<option.series[ptIndex].data.length;j++){option.series[ptIndex].data[j]=Number(option.series[ptIndex].data[j]).toFixed(n);}
ptIndex+=1;}}
var tempChartMax,tempChartMin;for(var m=1;m<4;++m){tempChartMax=null;tempChartMin=null;if(_this.entity.modal.dsChartCog[m].upper!=''){if(tempChartMax==null||tempChartMax<Number(_this.entity.modal.dsChartCog[m].upper)){tempChartMax=Number(_this.entity.modal.dsChartCog[m].upper);}}
if(_this.entity.modal.dsChartCog[m].lower!=''){if(tempChartMin==null||tempChartMin>Number(_this.entity.modal.dsChartCog[m].lower)){tempChartMin=Number(_this.entity.modal.dsChartCog[m].lower);}}
if(_this.entity.modal.dsChartCog[m].unit!=''){option.yAxis[0].name=_this.entity.modal.dsChartCog[m].unit;}
if(_this.entity.modal.dsChartCog[m].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[m].accuracy);for(var i=0;i<_this.entity.modal.option.paraType[m].arrId.length;i++){for(var j=0;j<option.series[ptIndex].data.length;j++){option.series[ptIndex].data[j]=Number(option.series[ptIndex].data[j]).toFixed(n);}
ptIndex+=1;}}}
if(tempChartMax!=null){option.yAxis[0].max=Number(tempChartMax);}
if(tempChartMin!=null){option.yAxis[0].min=Number(tempChartMin);}
var tempMarkLine;var seriesNum=0;for(var l=0;l<4;l++){for(var index=0;index<_this.entity.modal.option.paraType[l].arrId.length;++index){for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[l].markLine[k].value){if(!option.series[seriesNum].markLine){option.series[seriesNum].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}};}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[l].markLine[k].name,value:_this.entity.modal.dsChartCog[l].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[l].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[l].markLine[k].value)}];option.series[seriesNum].markLine.data.push(tempMarkLine);}}
seriesNum++;}}}
!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,option));}).error(function(e){}).always(function(e){});}};ModalMultiple.prototype.dealWithData=function(points){if(points.error){this.container.innerHTML='<div id="dataAlert" ></div>';new Alert($("#dataAlert"),"danger","<strong>"+points.error+"</strong>").show();return;}
var arr={arrLegend:{},arrSeries:{}};arr.arrLegend=[];arr.arrSeries=[];var arrTempPoints=[];var dataType=this.entity.modal.option.paraType;for(var i=0;i<dataType.length;++i){for(var j=0;j<dataType[i].arrId.length;++j){arrTempPoints.push({dsItemId:dataType[i].arrId[j]});}}
var arrPointAlias=this.initPointAlias(arrTempPoints);var tempNum=0;for(var i=0;i<dataType.length;i++){switch(dataType[i].type){case'bar':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'bar',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'line':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'line',symbol:'none',smooth:true,data:points.list[k].data,yAxisIndex:1,z:3};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'area':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'line',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0,z:3};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'cumulativeBar':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'bar',stack:'实时累计图',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;}}
return arr;};ModalMultiple.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.interval=5;this.entity.modal.option.paraType=option.paraType;};ModalMultiple.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalMultiple;}();var ModalPredictPointLineConfig=function($,window,undefined){var _this;function ModalPredictPointLineConfig(options){_this=this;ModalConfig.call(this,options);}
ModalPredictPointLineConfig.prototype=Object.create(ModalConfig.prototype);ModalPredictPointLineConfig.prototype.constructor=ModalPredictPointLineConfig;ModalPredictPointLineConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalPredictPointLineConfig.html'};ModalPredictPointLineConfig.prototype.init=function(){this.$formWrap=$('.form-wrap',this.$wrap);this.$iptChartYaxisMin=$('.ipt-chart-y-axis-min',this.$formWrap);this.$iptChartYaxisMax=$('.ipt-chart-y-axis-max',this.$formWrap);this.$iptChartValUnits=$('.ipt-chart-val-units',this.$formWrap);this.$iptChartValPrecision=$('.ipt-chart-val-precision',this.$formWrap);this.$btnOptionMode=$('.btn-option-mode',this.$formWrap);this.$btnTimeMode=$('.btn-time-mode',this.$formWrap);this.$btnPredictMode=$('.btn-predict-mode',this.$formWrap);this.$divTargetPoint=$('.div-target-point',this.$formWrap);this.$divPredictPoint=$('.div-predict-point',this.$formWrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$dropArea=$('.drop-area',this.$formWrap);this.attachEvents();};ModalPredictPointLineConfig.prototype.recoverForm=function(modal){var name,form,dsChartConfig;if(!modal)return;form=modal.option;dsChartConfig=modal.dsChartCog&&modal.dsChartCog.length?modal.dsChartCog[0]:{};if(!form)return;this._setField('input',this.$iptChartYaxisMin,dsChartConfig.lower);this._setField('input',this.$iptChartYaxisMax,dsChartConfig.upper);this._setField('input',this.$iptChartValUnits,dsChartConfig.unit);this._setField('input',this.$iptChartValPrecision,dsChartConfig.accuracy);this._setField('droparea',this.$divTargetPoint,form.targetPointId);this._setField('droparea',this.$divPredictPoint,form.predictPointId);this._setField('dropdown',this.$btnOptionMode,form.optionsMode);this._setField('dropdown',this.$btnTimeMode,form.timeMode);this._setField('dropdown',this.$btnPredictMode,form.predictMode);};ModalPredictPointLineConfig.prototype.reset=function(){this._setField('input',this.$iptChartYaxisMin);this._setField('input',this.$iptChartYaxisMax);this._setField('input',this.$iptChartValUnits);this._setField('input',this.$iptChartValPrecision);this._setField('droparea',this.$divTargetPoint);this._setField('droparea',this.$divPredictPoint);this._setField('dropdown',this.$btnOptionMode);this._setField('dropdown',this.$btnTimeMode);this._setField('dropdown',this.$btnPredictMode);};ModalPredictPointLineConfig.prototype.attachEvents=function(){this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var dsChartConfig={},form={};var val;val=parseFloat(_this.$iptChartYaxisMin.val());dsChartConfig.lower=!isNaN(val)?val:'';val=parseFloat(_this.$iptChartYaxisMax.val());dsChartConfig.upper=!isNaN(val)?val:'';val=parseInt(_this.$iptChartValPrecision.val());dsChartConfig.accuracy=!isNaN(val)?val:'';dsChartConfig.unit=_this.$iptChartValUnits.val();form.optionMode=parseInt(_this.$btnOptionMode.attr('data-value'));form.timeMode=parseInt(_this.$btnTimeMode.attr('data-value'));form.predictMode=parseInt(_this.$btnPredictMode.attr('data-value'));form.targetPointId=_this.$divTargetPoint.attr('data-value');form.predictPointId=_this.$divPredictPoint.attr('data-value');modal.dsChartCog=[dsChartConfig];modal.option=form;modal.points=form.predictMode===0?[form.targetPointId,form.predictPointId]:[form.targetPointId];modal.interval=60000;_this.$modal.modal('hide');e.preventDefault();});};return ModalPredictPointLineConfig;}(jQuery,window);var ModalPredictPointLine=function($,window,undefined){function ModalPredictPointLine(screen,entityParams,_renderModal,_updateModal,_showConfigMode){var _this=this;if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.chart=null;this.chartOptions=$.extend(true,{},this.optionDefault,DEFAULTS_CHARTS_OPTIONS);this.period=null;this.firstload=$.Deferred();this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalPredictPointLine.prototype=Object.create(ModalRealtimeLine.prototype);ModalPredictPointLine.prototype.constructor=ModalPredictPointLine;ModalPredictPointLine.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_PREDICT_POINT_LINE',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalPredictPointLine'};ModalPredictPointLine.prototype.renderModal=function(){var _this=this;var modal=this.entity.modal;var dsChartOption=modal.dsChartCog&&modal.dsChartCog.length?modal.dsChartCog[0]:{};var option=modal.option;var chartYaxisMin=dsChartOption.lower;var chartYaxisMax=dsChartOption.upper;var chartValUnits=dsChartOption.unit;var chartValPrecision=dsChartOption.accuracy;var timeMode=option.timeMode;var targetPointId=this.entity.modal.points[0];var predictPointId=option.predictPointId;var predictMode=option.predictMode;var period=this.period=this.getPeriod(timeMode);var params=[];var dsName=[];if(predictMode===undefined)predictMode=option.predictMode=0;params.push({dsItemIds:[targetPointId],timeStart:period.startTime,timeEnd:period.endTime,timeFormat:period.tmFmt});dsName=AppConfig.datasource.getDSItemById(targetPointId).alias||targetPointId;this.chartOptions.legend.data=[dsName];this.chartOptions.series[0].name=dsName;if(predictMode===1&&period.endTime<period.rangeEndTime){params.push({dsItemIds:[predictPointId],timeStart:period.endTime,timeEnd:period.rangeEndTime,timeFormat:period.tmFmt});this.chartOptions.legend.data.push('Predict Line');}
if(chartYaxisMin!=='')this.chartOptions.yAxis[0].min=chartYaxisMin;if(chartYaxisMax!=='')this.chartOptions.yAxis[0].max=chartYaxisMax;this.chartOptions.yAxis[0].name=chartValUnits;if(chartValPrecision==='')chartValPrecision=2;WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',params).done(function(rsList){var predictData;var i,t,leni,lent;for(i=0,leni=rsList.length;i<leni;i++){rsList[i].list[0].data=rsList[i].list[0].data.map(function(row,i){return row.toFixed(chartValPrecision);});}
_this.chartOptions.xAxis[0].data=_this.period.timeShaft;predictData=rsList[0].list[0].data;predictData[0]=rsList[0].list[0].data[rsList[0].list[0].data.length-1];predictData=predictData.concat(new Array(_this.period.timeShaft.length-predictData.length+1).join('-').split(''));_this.chartOptions.series[0].data=predictData;if(_this.chart){_this.chart.clear();_this.chart=null;}
_this.chart=echarts.init(_this.container,AppConfig.chartTheme);if(predictMode===1&&rsList[1]){_this.chartOptions.legend.data.push();predictData=rsList[1].list[0].data;predictData[0]=rsList[0].list[0].data[rsList[0].list[0].data.length-1];predictData=new Array(_this.period.timeShaft.length-predictData.length+1).join('-').split('').concat(predictData);_this.chartOptions.series.push({type:'line',name:'Predict Line',symbol:'none',itemStyle:{normal:{lineStyle:{type:'dotted'},color:'#6495ed',label:{position:'right'}}},data:predictData});_this.chart.clear();_this.chart.setOption(_this.chartOptions);return;}
_this.firstload.done(function(points){_this.updateModal(points,true);});});};ModalPredictPointLine.prototype.updateModal=function(points,force){if(this.firstload.state()==='pending')return this.firstload.resolve(points);if(!points||points.length===0)return;var _this=this;var data=this.chartOptions.series[0].data,predictData;var timeShaft=this.chartOptions.xAxis[0].data;var modal=this.entity.modal;var predictMode=modal.option.predictMode;var pointVal,predictPointVal;var pointId=modal.points[0],predictPointId=modal.points[1];var timeInterval=this.period.tmInterval;var dataLen=data.indexOf('-')-1,timeLen=timeShaft.length;var lastTickVal=timeShaft[dataLen].toDate().valueOf();var nowTick=new Date().valueOf();var row,i,len;force=force===undefined?false:force;if(nowTick-lastTickVal<this.period.tmInterval&&!force)return;for(i=0,len=points.length;i<len;i++){row=points[i];if(row.dsItemId===pointId){pointVal=parseFloat(row.data);}
if(row.dsItemId===predictPointId){predictPointVal=parseFloat(row.data);}}
if(pointVal!==undefined&&!force){pointVal=Math.round(pointVal*1000)/1000;data.push(pointVal);}
if(predictMode===1){if(!this.chartOptions.series[1])return;predictData=this.chartOptions.series[1].data;if(predictData[predictData.length-1]==='-'){this.chartOptions.series.pop();}
else{predictData.splice(predictData.lastIndexOf('-')+1,1,'-');}
if(predictData[predictData.length-1]!=='-'){predictData.splice(predictData.lastIndexOf('-')+1,1,pointVal);}}
else if(predictPointVal!==undefined){dataLen=data.indexOf('-')-1;if(dataLen===timeLen){timeShaft.push(new Date(lastTickVal+timeInterval).format('yyyy-MM-dd HH:00:00'));}
this.chartOptions.series[0].markPoint.data=[{name:'Predict Value',value:predictPointVal,xAxis:dataLen+1,yAxis:predictPointVal}];lastVal=data[data.indexOf('-')-1];var seriesRepeat=$.extend(true,{},this.chartOptions.series[0]);var seriesOne=this.chartOptions.series[0];seriesRepeat.data[dataLen+1]=predictPointVal;for(var i=0;i<=dataLen;i++){seriesRepeat.data[i]='-';}
seriesRepeat['lineStyle']={normal:{color:'#81a9f0',type:'dotted'}};seriesRepeat.type='effectScatter';seriesRepeat.markLine.data=[[{xAxis:dataLen,yAxis:lastVal},{xAxis:dataLen+1,yAxis:predictPointVal}]];seriesRepeat.markLine.label.normal.show=false;seriesRepeat.showEffectOn='render';seriesRepeat.rippleEffect={brushType:'stroke'};seriesRepeat.itemStyle={normal:{color:'#6898ed',shadowBlur:10,shadowColor:'#333'}};seriesRepeat.symbol='circle';seriesRepeat.symbolSize=10;seriesOne['lineStyle']={normal:{color:'#e84c3d'}};this.chartOptions.series.push(seriesRepeat);}
this.chart.setOption(this.chartOptions);};ModalPredictPointLine.prototype.getPeriod=function(timeMode){var _this=this;var now,tmFmt,tmInterval,tick,endTick;var start,end;var timeShaft=[];if(!this.m_bIsGoBackTrace){now=new Date();_this.optionDefault.animation=true;}else{now=this.m_traceData.currentTime;_this.optionDefault.animation=false;}
switch(timeMode){case 0:tmFmt='h1';tmInterval=3600000;start=now.format('yyyy-MM-dd')+' 00:00:00';end=now.format('yyyy-MM-dd HH:00:00');endTick=end.toDate().valueOf();deadlineTick=Math.max(start.toDate().valueOf()+86400000,endTick+28800000);break;case 1:default:tmFmt='d1';tmInterval=86400000;start=now.format('yyyy-MM')+'-01 00:00:00';end=now.format('yyyy-MM-dd 00:00:00');endTick=end.toDate().valueOf();if(this.entity.modal.option.predictMode===1){deadlineTick=now.valueOf()+604800000;}else{deadlineTick=Math.max(start.toDate().valueOf()+DateUtil.daysInMonth(now)*86400000,endTick+604800000);}
break;case 2:tmFmt='h1';tmInterval=3600000;start=new Date(now.valueOf()-(now.getDay()+6)%7*86400000).format('yyyy-MM-dd 00:00:00');end=now.format('yyyy-MM-dd HH:00:00');endTick=end.toDate().valueOf();deadlineTick=Math.max(start.toDate().valueOf()+604800000,endTick+144000000);break;};tick=start.toDate().valueOf();while(tick<deadlineTick){timeShaft.push(tick.toDate().format('yyyy-MM-dd HH:00:00'));tick+=tmInterval;};return{startTime:start,endTime:end,rangeStartTime:start,rangeEndTime:timeShaft[timeShaft.length-1],tmFmt:tmFmt,tmInterval:tmInterval,timeShaft:timeShaft,deadlineTick:deadlineTick};};ModalPredictPointLine.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalPredictPointLine.prototype.setOptions=function(options){this.options=$.extend({},this.opitons,options);};ModalPredictPointLine.prototype.setModalOption=function(option){};ModalPredictPointLine.prototype.configModal=new ModalPredictPointLineConfig();ModalPredictPointLine.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;};var DEFAULTS_CHARTS_OPTIONS={tooltip:{formatter:function formatter(p){var arrHtml=[p[0].name];p.forEach(function(row){if(row.value==='-')return;arrHtml.push(row.seriesName+': '+row.value);});return arrHtml.join('<br/>');}},series:[{markPoint:{symbol:'emptyCircle',symbolSize:5,effect:{show:true,shadowBlur:0},itemStyle:{normal:{color:'#6495ed',label:{position:'top'}}},data:[]},markLine:{symbol:'circle',symbolSize:1.5,itemStyle:{normal:{lineStyle:{type:'dotted'},color:'#6495ed',label:{position:'right'}}},label:{normal:{show:true}},tooltip:{show:false},data:[]}}],toolbox:{show:false}};return ModalPredictPointLine;}(jQuery,window);var ModalNote=function(){function ModalNote(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalNote.prototype=new ModalBase();ModalNote.prototype.optionTemplate={name:'toolBox.modal.NOTE',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalNote'};ModalNote.prototype.show=function(){this.init();};ModalNote.prototype.init=function(){};ModalNote.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();if(!this.entity.modal.modalText)return;var temp=this.entity.modal.modalText;temp=temp.replace(/&lt;%\S+\.*\S+%&gt;/g,'--');this.container.style.padding='8px';this.container.innerHTML=temp;};ModalNote.prototype.showConfigMode=function(){};ModalNote.prototype.updateModal=function(points){var arrId=[];for(var i=0;i<points.length;i++){var data=points[i].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
var $target=$('#divContainer_'+this.entity.id).find('#'+points[i].dsItemId);var textUrl=this.entity.modal.modalTextUrl?this.entity.modal.modalTextUrl:undefined;var index=$target.closest('.springContent').find('.pointValue').index($target);$target.html(data);arrId.push('');if(textUrl&&textUrl.length>0){for(var j=0;j<textUrl[index].ptTextUrl.length;++j){if(textUrl[index].ptTextUrl[j].value==parseInt(data)){arrId[index]=textUrl[index].ptTextUrl[j].url;if(arrId[index]!=''){$target.css({'cursor':'pointer','text-decoration':'underline'});if(textUrl[index].ptTextUrl[j].name&&textUrl[index].ptTextUrl[j].name!=''){$target.html(textUrl[index].ptTextUrl[j].name);}}
break;}}}}
var _this=this;arrId.forEach(function(value,index){if(arrId[index]=='')return;var $target=$('#ulPages').find('[pageId="'+arrId[index]+'"]');var ScreenType;for(var i=0;i<AppConfig.navItems.length;i++){if(AppConfig.navItems[i].id==arrId[index]){ScreenType=AppConfig.navItems[i].type;break;}}
if(!ScreenType){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){ScreenManager.show(ScreenType,arrId[index]);});}else{if(ScreenType=='ReportScreen'){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){var $ev=$('#ulPages [pageid="'+arrId[index]+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');});}else if(ScreenType=='EnergyScreen'){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){ScreenManager.show(EnergyScreen,arrId[index]);});}}});};ModalNote.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalNote;}();var ModalRankConfig=function($,window,undefined){function ModalRankConfig(options){ModalConfig.call(this,options);}
ModalRankConfig.prototype=Object.create(ModalConfig.prototype);ModalRankConfig.prototype.constructor=ModalRankConfig;ModalRankConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalRank.html'};ModalRankConfig.prototype.init=function(){this.$dropArea=$('.drop-area',this.$wrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$rankPointList=$('#rankPointList',this.$wrap);this.$radioRankAsc=$('#radioRankAsc',this.$wrap);this.$radioRankDesc=$('#radioRankDesc',this.$wrap);this.attachEvents();};ModalRankConfig.prototype.recoverForm=function(modal){this._setField('input',this.$rankPointList,modal.points);if(0==modal.desc||null==modal.desc){this.$radioRankAsc.prop('checked',true);this.$radioRankDesc.prop('checked',false);}else{this.$radioRankAsc.prop('checked',false);this.$radioRankDesc.prop('checked',true);}};ModalRankConfig.prototype.reset=function(){this._setField('input',this.$rankPointList);};ModalRankConfig.prototype.attachEvents=function(){var _this=this;_this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var ptList=_this.$rankPointList.val();modal.points=ptList.split(',');var radioVal=0;if($('#radioRankAsc')[0].checked){radioVal=0;}else{radioVal=1;}
modal.desc=radioVal;_this.$modal.modal('hide');e.preventDefault();});};return ModalRankConfig;}(jQuery,window);var ModalRank=function(){function ModalRank(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag='zh'==localStorage['language']?0:1;this.spinner.spin(this.container);};ModalRank.prototype=new ModalBase();ModalRank.prototype.optionTemplate={name:'toolBox.modal.WHIRLWIND_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRank'};ModalRank.prototype.show=function(){this.init();};ModalRank.prototype.init=function(){};ModalRank.prototype.renderModal=function(e){var _this=this;var arrPrjId=[];for(var i=0,len=AppConfig.projectList.length;i<len;i++){arrPrjId.push(AppConfig.projectList[i].id);}
var arrRankPt=_this.modal.points;var rankDesc=_this.modal.desc;var postData={'projectIds':arrPrjId,'points':arrRankPt,'desc':rankDesc};var showlist={list:[]};var descFlag=0;if(AppConfig.benchMark!=undefined){for(var i=0,len=arrRankPt.length;i<len;i++){for(var j=0,len2=AppConfig.benchMark.length;j<len2;j++){for(var k=0,len3=AppConfig.benchMark[j].points.length;k<len3;k++){if(arrRankPt[i]==AppConfig.benchMark[j].points[k]){showlist.list=AppConfig.benchMark[j].list;descFlag=AppConfig.benchMark[j].desc;break;}}}}}
if(showlist.list.length>0){var flag=true;if(rankDesc!=descFlag){flag=false;}
_this.drawRankChart(showlist,arrRankPt.length,flag);}else{WebAPI.post('/benchmark/getListByPointsAndProjectIds',postData).done(function(result){_this.drawRankChart(result,arrRankPt.length,true);}).always(function(e){});}
_this.spinner.stop();};ModalRank.prototype.updateModal=function(){};ModalRank.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalRank.prototype._showConfig=function(){};ModalRank.prototype.setModalOption=function(option){};ModalRank.prototype.drawRankChart=function(dataSrc,ptLen,sortFlag){var _this=this;var showValue=[];var yAxis=[];var prjId,prjName,ptVal;var curPrjId=AppConfig.projectId;if(sortFlag){for(var i=dataSrc.list.length-1;i>=0;i--){ptVal=dataSrc.list[i].value;if(-1==ptVal){continue;}
prjId=dataSrc.list[i].projectId;if(prjId==curPrjId){showValue.push({value:ptVal,itemStyle:{normal:{color:'#ff6347'}}});}else{showValue.push(ptVal);}
var findName=false;for(var j=0,len2=AppConfig.projectList.length;j<len2;j++){if(prjId==AppConfig.projectList[j].id){findName=true;break;}}
if(1==ptLen){if(0==_this.m_langFlag){yAxis.push(AppConfig.projectList[j].name_cn);}else{yAxis.push(AppConfig.projectList[j].name_english);}}else{if(findName){if(0==_this.m_langFlag){prjName=AppConfig.projectList[j].name_cn;}else{prjName=AppConfig.projectList[j].name_english;}
yAxis.push(prjName+'-'+dataSrc.list[i].name);}else{yAxis.push(dataSrc.list[i].name);}}}}else{for(var i=0,len=dataSrc.list.length;i<len;i++){ptVal=dataSrc.list[i].value;if(-1==ptVal){continue;}
prjId=dataSrc.list[i].projectId;if(prjId==curPrjId){showValue.push({value:ptVal,itemStyle:{normal:{color:'#ff6347'}}});}else{showValue.push(ptVal);}
var findName=false;for(var j=0,len2=AppConfig.projectList.length;j<len2;j++){if(prjId==AppConfig.projectList[j].id){findName=true;break;}}
if(1==ptLen){if(0==_this.m_langFlag){yAxis.push(AppConfig.projectList[j].name_cn);}else{yAxis.push(AppConfig.projectList[j].name_english);}}else{if(findName){if(0==_this.m_langFlag){prjName=AppConfig.projectList[j].name_cn;}else{prjName=AppConfig.projectList[j].name_english;}
yAxis.push(prjName+'-'+dataSrc.list[i].name);}else{yAxis.push(dataSrc.list[i].name);}}}}
var chartOption={title:{subtext:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:['value'],show:false},calculable:false,grid:{x:100,y:10,x2:20,y2:60},xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},axisLabel:{show:true,rotate:45},data:yAxis}],series:[{name:'value',type:'bar',data:showValue,itemStyle:{normal:{label:{show:true,position:'inside'},barBorderRadius:[0,5,5,0]},emphasis:{barBorderRadius:[0,5,5,0]}}}]};_this.chart.setOption(chartOption);};ModalRank.prototype.configModal=new ModalRankConfig();return ModalRank;}();var ModalRankNormal=function(){function ModalRankNormal(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag='zh'==localStorage['language']?0:1;this.spinner.spin(this.container);};ModalRankNormal.prototype=new ModalBase();ModalRankNormal.prototype.optionTemplate={name:'toolBox.modal.RANK_CHART',parent:0,mode:['modalRankNormal'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRankNormal'};ModalRankNormal.prototype.show=function(){this.init();};ModalRankNormal.prototype.init=function(){};ModalRankNormal.prototype.renderModal=function(e){var _this=this;var arrPoint=_this.modal.points;var postData={'dataSourceId':0,'dsItemIds':arrPoint};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(data){_this.drawRankChart(data.dsItemList);}).always(function(e){_this.spinner.stop();});};ModalRankNormal.prototype.updateModal=function(){};ModalRankNormal.prototype.showConfigModal=function(){};ModalRankNormal.prototype._showConfig=function(){};ModalRankNormal.prototype.setModalOption=function(option){};ModalRankNormal.prototype.drawRankChart=function(dataSrc){var _this=this;var yAxis=[];var showValue=[];var arrId=[];var arrItem=[];for(var i=dataSrc.length-1;i>=0;i--){arrId.push(dataSrc[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=arrItem.length;i<len;i++){var item=arrItem[i];yAxis.push(item.alias);for(var j=0,len2=dataSrc.length;j<len2;j++){if(item.id==dataSrc[j].dsItemId){showValue.push(parseInt(dataSrc[j].data));break;}}}
for(var i=dataSrc.length-1;i>=0;i--){for(var m=0;m<arrItem.length;m++){if(dataSrc[i].dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;yAxis.push(itemName);showValue.push(parseInt(dataSrc[i].data));break;}}}
var chartOption={title:{subtext:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:[],show:false},calculable:false,grid:{x:100,y:10,x2:20,y2:40},xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},axisLabel:{show:true,rotate:45},data:yAxis}],series:[{name:'value',type:'bar',data:showValue,itemStyle:{normal:{label:{show:true,position:'inside'},barBorderRadius:[0,5,5,0]},emphasis:{barBorderRadius:[0,5,5,0]}}}]};_this.chart.setOption(chartOption);};return ModalRankNormal;}();var ModalMix=function(){function ModalMix(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.subChartIds&&(this.entity.modal.option.subChartIds=[]);};ModalMix.prototype=new ModalBase();ModalMix.prototype.optionTemplate={name:'toolBox.modal.MIX',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMix'};ModalMix.prototype.show=function(){this.init();};ModalMix.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalMix.prototype.initContainer=function(replacedElementId){var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass=' gray-scrollbar scrollY';if(!divParent||replacedElementId){isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
$(divParent).addClass('springContainer');if(AppConfig.isMobile||this.screen.isForMobile||this.screen.options&&this.screen.options.isForMobile||this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile){this.spanRange={minWidth:1,maxWidth:3,minHeight:1,maxHeight:4.5,yScale:4/3,xScale:4};}else{this.spanRange={minWidth:this.optionTemplate.minWidth,maxWidth:this.optionTemplate.maxWidth,minHeight:this.optionTemplate.minHeight,maxHeight:this.optionTemplate.maxHeight,yScale:1,xScale:1};}
if(AppConfig.isMobile||this.screen.options&&this.screen.options.isForMobile||this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile){var height=100;if((this.optionTemplate.scroll===false||this.entity.scroll===false)&&!(this.screen.options&&this.screen.options.isConfig)){divParent.className+=' noScroll';}else{height=this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale;height>100&&(height=100);divParent.style.height=height+'%';}
divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale+'%';if(this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale>100){divParent.style.width='100%';}
if(this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale>100){divParent.style.height='100%';}}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.title&&this.entity.modal.title!=''&&!this.entity.isNotRender){divParent.innerHTML='<div class="panel panel-default">\
                <div class="panel-heading springHead">\
                    <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                </div>\
                <div class="panel-body springContent'+scrollClass+'" style="position: relative;"></div>\
            </div>';}else{divParent.innerHTML='<div class="panel panel-default">\
                <span class="springSeHead fontTemp6">'+(this.entity.modal.title?this.entity.modal.title:'')+'</span>\
                <div class="panel-body springContent'+scrollClass+'" style="position: relative;height:100%;"></div>\
            </div>';}
if(!(this instanceof ModalAnalysis)){var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];if(this.entity.modal.points&&this.entity.modal.points.length>0){var lkJump;lkJump=document.createElement('a');lkJump.className='springLinkBtn';lkJump.title='Add to datasource';lkJump.href='javascript:;';lkJump.innerHTML='<span class="glyphicon glyphicon-export"></span>';divBtnCtn.appendChild(lkJump);lkJump.onclick=function(){new ModalAppendPointToDs(true,_this.entity.modal.points,null).show();};}
var link=this.entity.modal.link;var _this=this;if(link&&AppConfig.menu[link]){var linkBtn=document.createElement('a');linkBtn.className='springLinkBtn';linkBtn.innerHTML='<span class="glyphicon glyphicon-link"></span>';linkBtn.setAttribute('pageid',link);linkBtn.title='Link to '+AppConfig.menu[link];divBtnCtn.appendChild(linkBtn);linkBtn.onclick=function(e){var $ev=$('#ulPages [pageid="'+link+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');};}
domPanel.appendChild(divBtnCtn);}
this.container=divParent.getElementsByClassName('springContent')[0];return this;};ModalMix.prototype.renderModal=function(e){var _this=this;var $sliderCont;var $sliderDiv=$('.sliderDiv');if(_this.entity.modal.option.displaySlider&&!_this.entity.modal.option.displayInterval){_this.entity.modal.option.displayInterval=5;}
var displaySlider=_this.entity.modal.option.displayInterval;var carouselTime=new Date();this.container.classList.add('modalMix');if(displaySlider){$sliderDiv=$('\
                                <div id="carousel_'+carouselTime.getTime()+'" class="carousel slide sliderDiv" data-ride="carousel">'+'<ol class="carousel-indicators" style="bottom:0">'+'</ol><div class="carousel-inner" role="listbox">'+'</div>'+'<a class="left carousel-control" href="#carousel_'+carouselTime.getTime()+'" role="button" data-slide="prev">'+'<span class="glyphicon glyphicon-chevron-left" aria-hidden="true" style="transform: scale(1,1.3)"></span><span class="sr-only">Previous</span></a>'+'<a class="right carousel-control" href="#carousel_'+carouselTime.getTime()+'" role="button" data-slide="next">'+'<span class="glyphicon glyphicon-chevron-right" aria-hidden="true" style="transform: scale(1,1.3)"></span><span class="sr-only">Next</span></a>'+'</div>');$(_this.container).append($sliderDiv);if(AppConfig.isMobile){$(_this.container).append('<style>.carousel-indicators .active{background-image: -webkit-radial-gradient(center,#fff 0%,#F7B702 80%,#fff 85%);border: none;}.carousel-indicators li{border-color:#aaa}</style>');}}
if(!this.entity.modal.option||!this.entity.modal.option.subChartIds)return;var index=0;this.entity.modal.option.subChartIds.forEach(function(obj){for(var i=0,item;i<_this.screen.store.layout.length;i++){if(displaySlider){$(_this.container).css({'display':'block','overflow-y':'hidden'});for(var z=0;z<_this.screen.store.layout[i].length;z++){item=_this.screen.store.layout[i][z];if(obj.id!=item.id)continue;var modelClass,entity;_this.screen.store.layout[i][z].spanC=12;var $sliderIner=$('<div class="item sliderIner"><div class="carousel-caption" style="height:100%;width:100%;right:0;left:0;padding-bottom:0;bottom:0px;padding-top:0px;"></div></div>');var $sliderDot=$('<li data-target="#carousel_'+carouselTime.getTime()+'" data-slide-to="'+index+'" style="border-color:#aaa;box-shadow:1px rgba(0,0,0,.05);margin:1.5px 3px;"></li>');if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalMix'){entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){if(entity){$(entity.container).height($(_this.container).height()-30);$(entity.container).width($(_this.container).width());}
entity.render();$sliderCont=$(_this.container).children('.springContainer');$sliderIner.children('.carousel-caption').append($sliderCont);$sliderIner.height($(_this.container).height());$sliderDiv.children('.carousel-inner').append($sliderIner);$sliderDiv.children('.carousel-indicators').append($sliderDot);++index;continue;}
if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
if(entity){if(AppConfig.isMobile){$(entity.container).height($(_this.container).height()-40);}else{$(entity.container).height($(_this.container).height()-30);}
$(entity.container).width($(_this.container).width());}
entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);if(entity){$(entity.container).height($(_this.container).height()-30);$(entity.container).width($(_this.container).width());}
entity.render();_this.screen.isForReport&&entity.configure();}
$sliderCont=$(_this.container).children('.springContainer');$sliderIner.children('.carousel-caption').append($sliderCont);$sliderIner.height($(_this.container).height());$sliderDiv.children('.carousel-inner').append($sliderIner);$sliderDiv.children('.carousel-indicators').append($sliderDot);++index;}}else{$(_this.container).css({'display':'flex','overflow-y':'auto','flex-flow':'wrap'});for(var j=0;j<_this.screen.store.layout[i].length;j++){item=_this.screen.store.layout[i][j];if(obj.id!=item.id)continue;var modelClass,entity;if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalMix'){entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){entity.render();continue;}
if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);entity.render();_this.screen.isForReport&&entity.configure();}}}}});if(displaySlider){if($(_this.container).find('.item:first')){$(_this.container).find('.item:first').addClass('active');}
if($(_this.container).find('.carousel-indicators').children(':first')){$(_this.container).find('.carousel-indicators').children(':first').addClass('active');}
$(_this.container).find('.sliderDiv').carousel({interval:this.entity.modal.option.displayInterval*1000});}
if(this.entity.modal.option.bgColor){this.container.style.backgroundColor=this.entity.modal.option.bgColor;$(this.container).find('.panel.panel-default').css('cssText','background-color:transparent !important');}};ModalMix.prototype.showConfigMode=function(){};ModalMix.prototype.updateModal=function(points){for(var i in points){var data=points[i].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
$('#'+points[i].dsItemId).html(data);}};ModalMix.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalMix.prototype.configure=function(){if(this.spinner)this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();if(_this.entity.modal.option.subChartIds.length>0){var subChartsIdsMix=_this.entity.modal.option.subChartIds;for(var i=0;i<subChartsIdsMix.length;i++){var item=subChartsIdsMix[i];for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(item.id===_this.screen.arrEntityOrder[j]){_this.screen.removeEntity(_this.screen.arrEntityOrder[j]);}}}
_this.entity.modal.option.subChartIds=[];}
_this.screen.removeEntity(_this.entity.id);$('#divContainer_'+_this.entity.id).remove();_this=null;};divMask.appendChild(btnRemove);var btnAdd=document.createElement('span');btnAdd.className='glyphicon glyphicon-plus-sign springConfigAddBtn grow';btnAdd.title='Add';btnAdd.onclick=function(e){var spanC=6,spanR=6;var $chartsCt=_this.container.classList.contains('chartsCt')?$(_this.container):$(_this.container).siblings().find('.chartsCt');if($chartsCt.children().length>0){var lastDiv=$chartsCt.children()[$chartsCt.children().length-1];spanR=Number(lastDiv.querySelector('#heightResize').value);spanC=Number(lastDiv.querySelector('#widthResize').value);}
if(!_this.container.classList.contains('chartsCt')){_this.container=_this.container.parentElement.getElementsByClassName('chartsCt')[0];}
var entity=new ModalNone(_this,{id:(+new Date()).toString(),spanC:spanC,spanR:spanR,modal:{type:"ModalNone"},isNotRender:true});_this.screen.arrEntityOrder.push(entity.entity.id);_this.screen.listEntity[entity.entity.id]=entity;if(!_this.entity.modal.option){_this.entity.modal.option={};_this.entity.modal.option.subChartIds=new Array();}
_this.entity.modal.option.subChartIds.push({id:entity.entity.id});entity.render();entity.configure();};divMask.appendChild(btnAdd);var btnInstall=document.createElement('span');btnInstall.className='glyphicon glyphicon-cog springConfigInstallBtn grow';btnInstall.title='config';btnInstall.onclick=function(e){_this.showConfigModal();};divMask.appendChild(btnInstall);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||this.screen.options&&this.screen.options.isForMobile){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;this.entity.spanR>this.optionTemplate.maxHeight&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $chartCt=$('<div class="divResize chartsCt gray-scrollbar">');divMask.appendChild($chartCt[0]);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent,$chartsCt;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();$chartsCt=e.target.classList.contains('chartsCt')?$(e.target):$(e.target).closest('.chartsCt');if(!$sourceParent[0].classList.contains('chartsCt')&&($targetParent[0].classList.contains('chartsCt')||$chartsCt.length==1)){if($targetParent[0].classList.contains('chartsCt')){_this.insertChartIntoMix(sourceId,$targetParent[0]);}else if($chartsCt.length==1){_this.insertChartIntoMix(sourceId,$chartsCt[0]);}}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}};this.executeConfigMode();},ModalMix.prototype.insertChartIntoMix=function(sourceId,container){if(sourceId){if(this.screen.listEntity[sourceId].entity.modal.type=='ModalMix'){alert(I18n.resource.toolBox.modal.MSG_MIX_NOT_ALLOW_TO_MIX);return false;}
var modelClass,item,entity=this.screen.listEntity[sourceId].entity;$('#divContainer_'+sourceId).remove();entity.isNotRender=true;if(!this.entity.modal.option){this.entity.modal.option={};}
if(!this.entity.modal.option.subChartIds){this.entity.modal.option.subChartIds=[];}
modelClass=this.screen.factoryIoC.getModel(entity.modal.type);this.screen.container=container;if(container.children.length>0){var lastDiv=container.children[container.children.length-1];entity.spanC=Math.round(parseInt(lastDiv.style.width.split('%')[0])/10)*12/10;entity.spanR=Math.round(parseInt(lastDiv.style.height.split('%')[0])/10)*6/10;}else{entity.spanC=6;entity.spanR=6;}
item=new modelClass(this.screen,entity);item.configure();this.entity.modal.option.subChartIds.push({id:entity.id});}};ModalMix.prototype.showConfigModal=function(){var _this=this;var $mixChartShow=$('#mixChartShow');if($mixChartShow.length===0){$mixChartShow=$('\
                            <style>.mixChartShow .row{margin-top: 15px;margin-bottom: 15px;}</style>\
                            <div id="mixChartShow" class="mixChartShow"><div class="modal fade"  style="position:absolute;"><div class="modal-dialog"><div class="modal-content">\
                            <div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                            <h4 class="modal-title">组合图显示模式</h4></div>\
                            <div class="modal-body">\
                            <div class="row">\
                            <div class="col-xs-3">组合图轮播</div>\
                            <div class="col-xs-6"><input type="number" id="iptInterval" placeholder="时间间隔" style="width:100px"/>s(0或者不填写表示不轮播)</div>\
                            </div>\
                            <div class="row">\
                            <div class="col-xs-3">背景颜色</div>\
                            <div class="col-xs-2">\
                            <select id="selBgColor">\
                            <option value="transparent">无</option>\
                            <option value="#ffffff">白</option>\
                            <option value="#000000">黑</option>\
                            <option value="#337ab7">蓝</option>\
                            <option value="#5cb85c">绿</option>\
                            <option value="custom">自定义</option>\
                            </select>\
                            </div>\
                            <div class="col-xs-2"><input type="input" id="iptBgColor" placeholder="#ffffff" style="width:60px"/></div>\
                            <div class="col-xs-2"><input type="color" class="" id="bgColorView"/></div>\
                            </div>\
                            <div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="btnSaveConfig">确定</button></div>\
                            </div></div></div></div>');}
$('#paneContent').append($mixChartShow);var $iptBgColor=$('#iptBgColor',$mixChartShow);var $bgColorView=$('#bgColorView',$mixChartShow);var $selBgColor=$('#selBgColor',$mixChartShow);var $iptInterval=$('#iptInterval',$mixChartShow);$iptInterval.val(_this.entity.modal.option.displayInterval?_this.entity.modal.option.displayInterval:20);setShow(_this.entity.modal.option.bgColor?_this.entity.modal.option.bgColor:'transparent');$selBgColor.off('change').on('change',function(e){setShow(this.value,e);});$iptBgColor.off('input').on('input',function(){$bgColorView.val(this.value);});$bgColorView.off('change').on('change',function(e){$iptBgColor.val(this.value);});$('#btnSaveConfig',$mixChartShow).off('click').click(function(){_this.entity.modal.option.displayInterval=$iptInterval.val();_this.entity.modal.option.bgColor=$iptBgColor.val();});$mixChartShow.children('.modal').modal();function setShow(selected,event){if(selected==='transparent'){$bgColorView.hide();}else{$bgColorView.val(selected);$bgColorView.show();}
if(selected==='custom'){$iptBgColor.show();$iptBgColor.val('').focus();}else{$iptBgColor.hide();$iptBgColor.val(selected);}
if(!event){$selBgColor.val(selected);if(!$selBgColor.val()){$selBgColor.val('custom');$iptBgColor.val(selected).show().focus();}}}};return ModalMix;}();var ModalMonitor=function(){var _this;function ModalMonitor(screen,entityParams){_this=this;_this.$configModal=undefined;_this.$modal=undefined;_this.tempOpt=undefined;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalMonitor.prototype=new ModalBase();ModalMonitor.prototype.optionTemplate={name:'toolBox.modal.Monitor',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMonitor'};ModalMonitor.prototype.show=function(){this.init();};ModalMonitor.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalMonitor.prototype.configure=function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this.screen.isScreenChange=true;_this=null;});};divMask.appendChild(btnRemove);if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
var btnHeightResize=document.createElement('div');var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};_this.entity.modal.interval='300000';this.container.parentNode.appendChild(divMask);if(this.entity.isNotRender&&this.screen.entity){$(document.getElementById('divContainer_'+this.screen.entity.id)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}
if(this.entity.isNotRender&&this.screen.listEntity){var parentId=undefined,subChartIds;if(this.entity&&this.entity.id){parentId=this.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}
if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
this.divResizeByToolInit();this.executeConfigMode();};ModalMonitor.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();var divMonitor,divIcon,divDetail,spName,spValue,spUnit;var isSemi=false;$(_this.container).addClass('clearfix');$(".springContent").css("overflow","auto");for(var i=0;i<_this.entity.modal.option.length;i++){divMonitor=document.createElement('div');divMonitor.className='divMonitor';isSemi=false;_this.entity.modal.option[i].col=='1'&&(isSemi=true);isSemi&&(divMonitor.className+=' semiCol');divMonitor.setAttribute("type",_this.entity.modal.option[i].type);divIcon=document.createElement('div');divIcon.className='divIcon';divIcon.innerHTML='<span class="'+_this.entity.modal.option[i].icon+'"></span>';if(_this.entity.modal.option[i].icon){divIcon.style.color=_this.entity.modal.option[i].iconColor;if(isSemi){divIcon.querySelector('span').style.border='2px solid '+_this.entity.modal.option[i].iconColor;}}
divDetail=document.createElement('div');divDetail.className='divMonitorInfo';spName=document.createElement('span');spName.className='spName';spName.textContent=_this.entity.modal.option[i].name;spValue=document.createElement('span');spValue.dataset.dsId=_this.entity.modal.option[i].dsId;spValue.className='spValue';spUnit=document.createElement('span');spUnit.className='spUnit';spUnit.textContent=_this.entity.modal.option[i].unit;if(_this.entity.modal.option[i].backColor==""){}else{divMonitor.style.background=_this.entity.modal.option[i].backColor;}
divDetail.appendChild(spValue);divDetail.appendChild(spUnit);divDetail.appendChild(spName);divMonitor.appendChild(divIcon);divMonitor.appendChild(divDetail);!isSemi&&(divMonitor.style.height=100/Math.ceil(_this.entity.spanR)+'%');_this.container.appendChild(divMonitor);}};ModalMonitor.prototype.showConfigMode=function(){};ModalMonitor.prototype.showConfigModal=function(){_this.tempOpt=$.extend(true,{},_this.entity.modal);var configModalTpl='\
                <div id="modalMonitorConfig" class="modal fade"  role="dialog" aria-labelledby="ttlNodeTool">\
                    <div class="modal-dialog">\
                        <div class="modal-content">\
                            <div class="modal-header">\
                                <span id="btnMonitorAdd" class="glyphicon glyphicon-plus-sign btnMonitorAdd grow"></span>\
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                                <h4 class="modal-title" id="ttlNodeTool">Diagnosis Edit</h4>\
                            </div>\
                            <div class="modal-body gray-scrollbar" id="ctnMonitor">\
                            </div>\
                            <div class="modal-footer">\
                                <input type ="color">\
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
                                <button type="button" class="btn btnSure btn-primary">Save</button>\
                            </div>\
                        </div>\
                    </div>\
                </div>';_this.$configModal=$('#modalMonitorConfig');if(_this.$configModal.length==0){_this.$configModal=$(configModalTpl);}else{_this.$configModal.modal('show');return;}
_this.$configModal.appendTo($(_this.container).parentsUntil('.springContainer').parent().parent());var $ctnMonitor=_this.$configModal.find('#ctnMonitor').html('');var btnAdd=_this.$configModal.find('#btnMonitorAdd')[0];btnAdd.title='Monitor Type Add';btnAdd.onclick=function(){$ctnMonitor.append(_this.createDivMonitor());};if(_this.entity.modal.option&&_this.entity.modal.option.length>0){for(var i=0;i<_this.entity.modal.option.length;i++){$ctnMonitor[0].appendChild(_this.createDivMonitor(_this.entity.modal.option[i]));}}else{$ctnMonitor[0].appendChild(_this.createDivMonitor());}
_this.$configModal.modal('show');_this.$configModal.find('.btnSure').off('click').on('click',function(){_this.entity.modal=$.extend(true,{},_this.tempOpt);_this.$configModal.modal('hide');});_this.attachMonitorEvent();};ModalMonitor.prototype.updateModal=function(points){this.spinner&&this.spinner.stop();var MonitorInfoS=$(_this.container).find('.divMonitor');var arrSpVal=$(_this.container).find('.spValue');for(var i=0;i<arrSpVal.length;i++){for(var j in points){var data=points[j].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
if(points[j].dsItemId==arrSpVal[i].dataset.dsId){if(MonitorInfoS[i].getAttribute("type")=="数值型"){arrSpVal[i].textContent=data;}else{if(!data==""||!data==0){arrSpVal[i].textContent=data;}else{$(MonitorInfoS[i]).css("background","-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(#D31212), to(#FC1B1B))");arrSpVal[i].textContent=data;}}
break;}}}};ModalMonitor.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalMonitor.prototype.createDivMonitor=function(opt){var divMonitor=document.createElement('div');divMonitor.className='divMonitor';var $divMonitor=$(divMonitor);divMonitor.innerHTML='\
            <div class="divIcon"></div>\
            <div class="divMonitorInfo">\
                <div class="divName">\
                    <label>name:</label>\
                    <span class="spName"></span>\
                    <input class="iptName form-control" ></input>\
                </div>\
                <div class="divValue">\
                    <label>value:</label>\
                    <span class="spValueTip glyphicon glyphicon-plus"></span>\
                    <span class="spValue"></span>\
                </div>\
                <div class="divUnit">\
                    <label>unit:</label>\
                    <span class="spUnit"></span>\
                    <input class="iptUnit form-control"></input>\
                </div>\
                <div class="divType">\
                    <label>type:</label>\
                    <span class="spTypeShow"></span>\
                    <select class="spType">\
                        <option>数值型</option>\
                        <option>报警型</option>\
                    </select>\
                </div>\
                <div class="divCol">\
                    <label>col:</label>\
                    <select class="iptCol form-control" value="1">\
                        <option value="0">一行</option>\
                        <option value="1">半行</option>\
                    </select>\
                </div>\
            </div>\
            <div class="divMonitorDel glyphicon glyphicon-remove-circle"></div>';if(opt&&opt.icon){$divMonitor.find('.divIcon').addClass(opt.icon);if(opt.iconColor)$divMonitor.find('.divIcon').css({'color':opt.iconColor,'box-shadow':'0 0 15px '+opt.iconColor});}else{$divMonitor.find('.divIcon').addClass('glyphicon glyphicon-plus').css('color','#f6c700');}
if(opt&&opt.name){$divMonitor.find('.spName').show().text(opt.name);$divMonitor.find('.iptName').hide().val(opt.name);}else{$divMonitor.find('.spName').hide();$divMonitor.find('.iptName').show();}
if(opt&&opt.dsId){$divMonitor.find('.spValue').show().text(AppConfig.datasource.getDSItemById(opt.dsId).alias)[0];$divMonitor.find('.divValue')[0].dataset.dsId=opt.dsId;$divMonitor.find('.spValueTip').hide();}else{$divMonitor.find('.spValue').hide();$divMonitor.find('.spValueTip').show();}
if(opt&&opt.unit){$divMonitor.find('.spUnit').show().text(opt.unit);$divMonitor.find('.iptUnit').hide().val(opt.unit);}else{$divMonitor.find('.spUnit').hide();$divMonitor.find('.iptUnit').show();}
if(opt&&opt.type){$divMonitor.find('.spTypeShow').show().text(opt.type);$divMonitor.find('.spType').hide();}else{$divMonitor.find('.spTypeShow').hide();$divMonitor.find('.spType').show();}
if(opt&&opt.col){$divMonitor.find('.iptCol').val(opt.col);}
if(opt&&opt.backColor){$divMonitor.css("background",opt.backColor);}else{$divMonitor.css("background","#fff");}
if(!opt){if(!_this.tempOpt.option){_this.tempOpt.option=[];}
_this.tempOpt.option.push({icon:'glyphicon glyphicon-plus',iconColor:'#f6c700',name:'',unit:'',dsId:'',type:'',backColor:'',col:'6'});}
return divMonitor;};ModalMonitor.prototype.attachMonitorEvent=function(){var $ctnMonitor=_this.$configModal.find('#ctnMonitor');var $iptColor;var indexDivMonitor;$ctnMonitor.off('click').on('click','.divMonitor',function(){$ctnMonitor.find(".divMonitor").css("border","1px dotted");indexDivMonitor=$ctnMonitor.find(".divMonitor").index($(this));$(this).css("border","1px solid black");});$(".modal-footer").find("input").off("change").on("change",function(){var colorVal=$(this).val();var rgb=colorVal.colorRgb().split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var hsl=rgbToHsl(r,g,b);var hslEndL=hsl[2]+0.05;var rgbStartColor=hslToRgb(hsl[0],hsl[1],hsl[2]);var rgbEndColor=hslToRgb(hsl[0],hsl[1],hslEndL);var backColor='-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(rgb('+rgbStartColor[0]+','+rgbStartColor[1]+','+rgbStartColor[2]+')), to(rgb('+rgbEndColor[0]+','+rgbEndColor[1]+','+rgbEndColor[2]+'))';_this.tempOpt.option[indexDivMonitor].backColor=backColor;$ctnMonitor.find(".divMonitor").eq(indexDivMonitor).css("background",backColor);});var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return[h,s,l];}
function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var hue2rgb=function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
$ctnMonitor.on('click','.divIcon',function(e){e.stopPropagation();$('#ctnMonitor .divMonitor.selected').removeClass('selected');var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').addClass('selected');var index=$ctnMonitor.children().index($divMonitor);if(_this.$modal){_this.$modal.modal('show');$iptColor=_this.$modal.find('#iptColorSel');if(_this.tempOpt.option[index].iconColor){$iptColor.val(_this.tempOpt.option[index].iconColor);}
if(_this.tempOpt.option[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option[index].icon.split(' ')[1]).parent().addClass('selected');}}else{WebAPI.get('static/scripts/spring/entities/modalMonitor.html').done(function(resultHTML){_this.$modal=$(resultHTML);$iptColor=_this.$modal.find('#iptColorSel');_this.$modal.modal('show');if(_this.tempOpt.option[index].iconColor){_this.$modal.find('#iptColorSel').val(_this.tempOpt.option[index].iconColor);}
if(_this.tempOpt.option[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option[index].icon.split(' ')[1]).parent().addClass('selected');}
_this.$modal.find('.bs-glyphicons-list>li').click(function(e){if($(e.currentTarget).hasClass('selected'))return;$('.bs-glyphicons-list>li.selected').removeClass('selected');$(e.currentTarget).addClass('selected');});_this.$modal.find('.btnSure').click(function(e){var $divMonitor=$('#ctnMonitor .divMonitor.selected');var index=$ctnMonitor.children().index($divMonitor);var icon=$('.bs-glyphicons-list>li.selected>.glyphicon-class').text();_this.tempOpt.option[index].icon=icon;_this.tempOpt.option[index].iconColor=$iptColor.val();$divMonitor.find('.divIcon')[0].className='divIcon '+icon;$divMonitor.find('.divIcon').css({'color':$iptColor.val(),'box-shadow':'0 0 15px '+$iptColor.val()});_this.$modal.modal('hide');});});}});$ctnMonitor.on('click','.divMonitorDel',function(e){e.stopPropagation();var index=$ctnMonitor.children().index($(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor'));$ctnMonitor.children().eq(index).remove();_this.tempOpt.option.splice(index,1);_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}});$ctnMonitor.on('click','.spName',function(e){e.stopPropagation();$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptName').show().focus();});$ctnMonitor.on('click','.spUnit',function(e){e.stopPropagation();$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptUnit').show().focus();});$ctnMonitor.off('blur').on('blur','input',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();if($(e.currentTarget).hasClass('iptName')){_this.tempOpt.option[index].name=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spName').text(value).show();}else if($(e.currentTarget).hasClass('iptUnit')){_this.tempOpt.option[index].unit=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spUnit').text(value).show();}});$ctnMonitor.off('blur').on('blur','select',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var type=this.value;if($(e.currentTarget).hasClass('iptCol')){if(!type)return;_this.tempOpt.option[index].col=type;}else{_this.tempOpt.option[index].type=type;$(this).hide();$divMonitor.find(".spTypeShow").show().html(type);}});$ctnMonitor.on('click','.spTypeShow',function(e){var $divMonitor=$(this).parentsUntil('.ctnMonitor','.divMonitor');$(this).hide();$divMonitor.find(".spType").show();});$ctnMonitor[0].ondragenter=function(e){e.preventDefault();};$ctnMonitor[0].ondragover=function(e){e.preventDefault();};$ctnMonitor[0].ondragleave=function(e){e.preventDefault();};$ctnMonitor[0].ondrop=function(e){e.preventDefault();var dsItemId=EventAdapter.getData().dsItemId;if(!dsItemId)return;var $divValue=$(e.target).parentsUntil('.ctnMonitor','.divValue');if($divValue.length>0){var index=$ctnMonitor.children().index($divValue.parentsUntil('.ctnMonitor','.divMonitor'));_this.tempOpt.option[index].dsId=dsItemId;$divValue[0].dataset.dsId=dsItemId;$divValue.find('.spValue').text(AppConfig.datasource.getDSItemById(dsItemId).alias).show();$divValue.find('.spValueTip').hide();_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}}};};return ModalMonitor;}();(function(){var tags={};var TOOLBOX=['DataSource','LinkTo'];var PATTERN_STR='<('+TOOLBOX.join('|')+').*?(/|'+TOOLBOX.join('|')+')>';window.__spring_html_modal={};function runScript(content){var done=false;var script=document.createElement("script");var head=document.getElementsByTagName("head")[0];script.type="text\/javascript";script.text=content;head.appendChild(script);head.removeChild(script);}
tags.Base=function(){function Base(modal){this.$textarea=modal.$textarea;this.$modalCt=modal.$modalCt;this.$toolBtn=null;this.init();}
Base.prototype.init=function(){throw new Error('init 方法未被实现，不可直接调用');};Base.prototype.render=function($container){throw new Error('render 方法未被实现，不可直接调用');};return Base;}();tags.DataSource=function(){var _this;function DataSource(modal){_this=this;tags.Base.call(this,modal);}
DataSource.prototype=Object.create(tags.Base.prototype);DataSource.prototype.constructor=DataSource;DataSource.prototype.insertTpl='<DataSource data-id="{id}"{linkTo}/>';DataSource.prototype.init=function(){var arrHtml=[];this.$toolBtn=$('<button type="button" class="btn btn-default" data-toggle="collapse" data-target="#panelDataSourceConfig" aria-expanded="false">\
                DataSource\
                </button>');this.$toolConfig=$('#panelDataSourceConfig',this.$modalCt);};DataSource.prototype.render=function($btnCtn){$btnCtn.append(this.$toolBtn);this.attachEvents();};DataSource.prototype.attachEvents=function(){};DataSource.save=function(dataset,modal){var id;if(!dataset)return;id=dataset.id;if(id&&modal.points.indexOf(id)===-1)modal.points.push(id);};DataSource.getStaticRender=function(dom){var dataset=dom.dataset;var menuId=dataset.linkTo;var $ele;if(menuId){$ele=$('<a href="javascript:;" data-is="DataSource" data-id="'+dataset.id+'">Loading</a>');$ele.click(function(e){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');});return $ele;}else return $('<span data-is="DataSource" data-id="'+dataset.id+'">Loading</span>');};DataSource.getRealTimeRender=function($ele,map){var dataset=$ele[0].dataset;if(isNaN(map[dataset.id])){$ele.html(map[dataset.id]);}else{$ele.html(parseFloat(map[dataset.id]));}};return DataSource;}();tags.LinkTo=function(){var _this;function LinkTo(modal){_this=this;tags.Base.call(this,modal);}
LinkTo.prototype=Object.create(tags.Base.prototype);LinkTo.prototype.constructor=LinkTo;LinkTo.prototype.insertTpl='<LinkTo data-id="{id}" ></LinkTo>';LinkTo.prototype.init=function(){var arrHtml=[];this.$toolBtn=$('<button type="button" class="btn btn-default" data-parent="#collapseList" data-toggle="collapse" data-target="#panelLinkToConfig" aria-expanded="false">LinkTo</button>');this.$toolConfig=$('#panelLinkToConfig',this.$modalCt);};LinkTo.prototype.render=function($btnCtn){$btnCtn.append(this.$toolBtn);this.attachEvents();};LinkTo.prototype.attachEvents=function(){};LinkTo.save=function(dataset,modal){};LinkTo.getStaticRender=function(dom,doc){var dataset=dom.dataset;var menuId=dataset.id;doc=doc||window.document;$ele=$('<a href="javascript:;">'+(dom.innerHTML||'Link To')+'</a>',doc);$ele.click(function(){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');});return $ele;};return LinkTo;}();var ModalHtmlConfig=function(){var _this;var gMenusHtml;function ModalHtmlConfig(options){_this=this;ModalConfig.call(this,options);this.toolbox=[];}
ModalHtmlConfig.prototype=Object.create(ModalConfig.prototype);ModalHtmlConfig.prototype.constructor=ModalHtmlConfig;ModalHtmlConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalHtmlConfig.html'};ModalHtmlConfig.prototype.init=function(){this.$modal=$('.modal',this.$wrap);this.$modalCt=$('.modal-content',this.$wrap);this.$formWrap=$('.form-wrap',this.$wrap);this.$dsGroupList=$('.form-horizontal','#panelDataSourceConfig');this.$linkGroupList=$('.form-horizontal','#panelLinkToConfig');this.$textarea=$('.form-textarea',this.$formWrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$toolboxCtn=$('.toolbox-ctn',this.$formWrap);this.$btnResizeFull=$('.btn-resize-full',this.$wrap);this.$btnResizeSmall=$('.btn-resize-small',this.$wrap);this.attachEvents();this.initToolbox();};ModalHtmlConfig.prototype.initToolbox=function(){var $toolboxGroup=$('<div class="btn-group" role="group">').appendTo(this.$toolboxCtn);TOOLBOX.forEach(function(row){var labelClass=tags[row];var labelIns;if(typeof labelClass!=='function'){console.warn(I18n.resource.dashboard.modalJumpPages.NO_LABLE+row);return;}
labelIns=new labelClass(_this);labelIns.render($toolboxGroup);});var $tools=$('.btn',$toolboxGroup);$toolboxGroup.on('click','.btn',function(){$(this).toggleClass('btn-primary');});};ModalHtmlConfig.prototype.recoverForm=function(form){var _this=this;var options;if(!form||!form.option){this.addDsFormGroup();return;}
options=form.option;var arrId=[];form.points.forEach(function(row){arrId.push(row);});var arrItem=AppConfig.datasource.getDSItemById(arrId);form.points.forEach(function(row){for(var m=0;m<arrItem.length;m++){if(row==arrItem[m].id){var $ele=_this.addDsFormGroup({id:row,cls:' dropped',value:row,name:arrItem[m].alias||'未找到名称',display:'inline'});break;}}});this.addDsFormGroup();this._setField('textarea',this.$textarea,options.html);};ModalHtmlConfig.prototype.reset=function(){this.$dsGroupList.empty();this._setField('textarea',this.$textarea);};ModalHtmlConfig.prototype.addDsFormGroup=function(data){if(data===undefined){data={id:I18n.resource.dashboard.modalJumpPages.PARAM_INTRO,cls:'',value:'',name:'<span class="glyphicon glyphicon-plus"></span>'};}
return $('<div class="form-group{cls}">\
                <label class="col-md-2 control-label" for="">Point</label>\
                <div class="col-md-4">\
                    <div class="label-area div-ds-id">{id}</div>\
                </div>\
                <div class="col-md-4">\
                    <div class="drop-area div-ds-point" data-value="{value}">\
                        {name}\
                    </div>\
                </div>\
                <div class="col-md-2">\
                    <div class="opt-icon-area">\
                        <span class="glyphicon glyphicon-remove"></span>\
                    </div>\
                </div>\
            </div>'.formatEL(data)).appendTo(_this.$dsGroupList);};ModalHtmlConfig.prototype.initLinkFormGroup=function(){var arrHtml=[];for(var i in AppConfig.menu){if(!AppConfig.menu.hasOwnProperty(i))continue;arrHtml.push('<div class="form-group">\
                    <label class="col-md-2 control-label" for="">Link</label>\
                    <div class="col-md-4">\
                        <div class="label-area">{id}</div>\
                    </div>\
                    <div class="col-md-4"><div class="label-area">{name}</div></div>\
                </div>'.formatEL({id:i,name:AppConfig.menu[i]}));}
return this.$linkGroupList.html(arrHtml.join(''));};ModalHtmlConfig.prototype.onDropActionPerformed=function(e){$(e.target).removeClass('on');var itemId=EventAdapter.getData().dsItemId;var isNotShowMsg=true;if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){addPointDrag(itemId[i]);}}else{addPointDrag(itemId);}
if(isNotShowMsg){alert(I18n.resource.dashboard.modalJumpPages.DATA_EXIST);return false;}
function addPointDrag(itemId){var $target=$('.drop-area[data-value=""]');_this._setField('droparea',$target,itemId);var dsId=$target[0].dataset.value;var $formGroup=$target.closest('.form-group');if(_this.$dsGroupList.find('[data-value="'+dsId+'"]').length>1){_this._setField('droparea',$formGroup.find('.drop-area'));}else{$formGroup.addClass('dropped');$formGroup.find('.label-area').text(dsId);isNotShowMsg=false;_this.addDsFormGroup();}}
e.stopPropagation();};ModalHtmlConfig.prototype.attachEvents=function(){var _this=this;this.$modal.on('show.bs.modal',function(){_this.initLinkFormGroup();});this.$wrap.on('click','.opt-icon-area',function(e){$(this).closest('.form-group').remove();});this.$btnResizeFull.off().click(function(){var height=_this.$modal.height();_this.$modal.addClass('maxium-screen');_this.$textarea.height(height-208);});this.$btnResizeSmall.off().click(function(){_this.$modal.removeClass('maxium-screen');_this.$textarea.height('auto');});this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var form={};var html;var toolboxStr,pattern,match;html=form.html=_this.$textarea.val();modal.points=[];_this.$dsGroupList.find('.dropped .drop-area').each(function(){modal.points.push($(this)[0].dataset.value);});toolboxStr=TOOLBOX.join('|');pattern=new RegExp(PATTERN_STR,'ig');while((match=pattern.exec(html))!==null){try{var dom=$(match[0])[0];}catch(e){continue;}
tags[match[1]].save(dom.dataset,modal);}
pattern=new RegExp('<%([^,<>%]+).*?%>','mg');while((match=pattern.exec(html))!==null){if(modal.points.indexOf(match[1])===-1){modal.points.push(match[1]);}}
modal.option=form;modal.dsChartCog=[{accuracy:2}];modal.interval=60000;_this.$modal.modal('hide');modalIns.preview();e.preventDefault();});this.$textarea[0].addEventListener("dragover",function(event){event.preventDefault();});this.$textarea[0].addEventListener("drop",function(event){event.preventDefault();var itemId=EventAdapter.getData().dsItemId;if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){dotIsExist(itemId[i]);}}else{dotIsExist(itemId);}
function dotIsExist(itemId){var dropAreaList=$('.drop-area',_this.$wrap);var lens=dropAreaList.length;var isExist=false;for(var j=0;j<lens;j++){if(dropAreaList.eq(j).attr('data-value')===itemId){isExist=true;}}
if(!isExist){var text='<%'+itemId+'%>';insertText(event.target,text);}else{return false;}}
_this.$wrap.find('.drop-area[data-value=""]').trigger('drop',true);});function insertText(obj,str){if(typeof obj.selectionStart==='number'&&typeof obj.selectionEnd==='number'){var startPos=obj.selectionStart,endPos=obj.selectionEnd,cursorPos=startPos,tmpStr=obj.value;obj.value=tmpStr.substring(0,startPos)+str+tmpStr.substring(endPos,tmpStr.length);cursorPos+=str.length;obj.selectionStart=obj.selectionEnd=cursorPos;}else{obj.value+=str;}}};return ModalHtmlConfig;}();this.ModalHtml=function(ToolTipMixin){function ModalHtml(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.promise=$.Deferred();this.firstUpdateData=null;this.lastUpdateTimeTick=null;this.customTags={};this.initCustomVaribles();}
ModalHtml.prototype=Object.create(ModalBase.prototype);ModalHtml.prototype.constructor=ModalHtml;ModalHtml.prototype=Mixin(ModalHtml.prototype,ToolTipMixin);ModalHtml.prototype.optionTemplate={name:'toolBox.modal.MODAL_HTML',parent:0,mode:'custom',maxNum:10,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,defaultHeight:4.5,defaultWidth:3,type:'ModalHtml'};ModalHtml.prototype.initCustomVaribles=function(){var container=this.container;var screen;window.__spring_html_modal[this.entity.id]=this.customVaribles={};this.customVaribles.dataMap={};var arrParams=window.location.hash.split('&');if(arrParams&&arrParams.length>0){for(var i=0;i<arrParams.length;i++){if(arrParams[i].indexOf('response=')>-1){this.customVaribles.dataParams=arrParams[i];}}}
this.customVaribles.linkTo=function(menuId,ctnSelector,linkType,linkName,linkParams){var $ev,ctn;if(!ctnSelector&&!linkType){$ev=$('#ulPages [pageid="'+menuId+'"]');if($ev.length>0){if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');if(linkParams){window.location.hash=window.location.hash+'&response='+linkParams;}
return;}}
if(ctnSelector){ctn=document.querySelector(ctnSelector);if(!ctn)return;ctn.innerHTML='';if(screen){screen.close();screen=null;}}
linkType=linkType||'EnergyScreen';switch(linkType){case'EnergyScreen_M':case'EnergyScreen':if(!ctn){if(!AppConfig.isMobile){ScreenManager.show(EnergyScreen,menuId);}else{var isIndex=linkType=='EnergyScreen_M';router.to({typeClass:ProjectDashboard,data:{menuId:menuId,isIndex:isIndex,name:linkName}});}}else{screen=new EnergyScreen();screen.id=menuId;screen.container=ctn;screen.isForBencMark=true;screen.init();}
break;case'ObserverScreen':if(!ctn){ScreenManager.show(ObserverScreen,menuId);}else{screen=new ObserverScreen(menuId);ctn.innerHTML='<div class="divMain" style="width: 100%; height: 100%;">\
                                    <div class="div-canvas-ctn" style="padding: 0; margin: 0 auto; height: 100%; width: 100%;">\
                                        <canvas class="canvas-ctn" style="width: 100%; height: 100%;">浏览器不支持</canvas>\
                                    </div>\
                                    <div id="divObserverTools" style="height: 0"></div>\
                                </div>';screen.isInDashBoard=true;screen.show(ctn);}
break;case'FacReportScreen':if(!ctn){ScreenManager.goTo({page:'observer.screens.FacReportScreen',options:{id:menuId},container:'indexMain'});}
break;case'FacReportWrapScreen':if(!ctn){if(AppConfig.isMobile){router.to({typeClass:MessageFactoryReport,data:{}});}else{ScreenManager.goTo({page:'observer.screens.FacReportWrapScreen',options:{id:menuId},container:'indexMain',response:linkParams});}}
break;default:return;}};};ModalHtml.prototype.initCustomTags=function(doc){var _this=this;doc=doc||document;TOOLBOX.forEach(function(row,i){var $tagEle=$(row,doc);var thisTags=[];var staticHtmlRender;if(!$tagEle.length)return;if(typeof(staticHtmlRender=tags[row].getStaticRender)!=='function')return;[].forEach.call($tagEle,function(rowt,t){var $rs=staticHtmlRender(rowt);if(!$rs)return;thisTags.push($rs);$(rowt).replaceWith($rs);});if(thisTags.length)_this.customTags[row]=thisTags;});};ModalHtml.prototype.initCustomAttrs=function(){var _this=this;var $container=$(this.container);var energyScreen;$container.on('click','[data-link-to]',function(e){var linkType=this.dataset['linkType'];var ctnSelector=this.dataset['linkTarget'];var menuId=this.dataset['linkTo'];var linkName=this.dataset['linkName'];var linkParams=this.dataset['linkParams'];try{linkParams=JSON.parse(linkParams);}catch(e){}
_this.customVaribles.linkTo(menuId,ctnSelector,linkType,linkName,linkParams);e.preventDefault();});};ModalHtml.prototype._parseOptionStr=function(optionStr){var arr=optionStr.split(',');var opt={};arr.forEach(function(kv){var kvArr=kv.split('=');if(kvArr.length===1){opt[kv]='true';}else{opt[kvArr[0]]=kvArr[1];}});return opt;};ModalHtml.prototype._formatNumber=function(num,options){var rs='';var toString=Object.prototype.toString;var decimalPortion;var numstr,isNegative;if(isNaN(num))return num;num=parseFloat(num);isNegative=num<0;num=Math.abs(num);if(!isNaN(options.p)){options.p=parseInt(options.p);num=num.toFixed(options.p);}
decimalPortion=(num+'').split('.')[1]||'';num=parseInt(num);if(options.ts==='true'){numstr=num+'';while(numstr.length>3){rs=','+numstr.substr(-3,3)+rs;numstr=numstr.substr(0,numstr.length-3);}
rs=numstr+rs;}else{rs=num+'';}
rs=decimalPortion===''?rs:rs+'.'+decimalPortion;if(parseFloat(rs)===0){return rs;}
return(isNegative?'-':'')+rs;};ModalHtml.prototype._formatNode=function(node,options,params){var domWrap;if(options.draggable&&!node.parentNode.dataset.h5DraggableNode){domWrap=document.createElement('span');domWrap.draggable='true';domWrap.dataset.h5DraggableNode='true';domWrap.dataset.dsId=params.dsId||'';node.parentNode.insertBefore(domWrap,node);domWrap.appendChild(node);}};ModalHtml.prototype.setToolTip=function(node,params){var domWrap;if(node.parentNode.dataset.h5DraggableNode==='true'){domWrap=node.parentNode;}else{domWrap=document.createElement('span');domWrap.dataset.dsId=params.dsId||'';domWrap.dataset.h5DraggableNode='true';node.parentNode.insertBefore(domWrap,node);domWrap.appendChild(node);}
this.initTooltip({shape:domWrap,ds:params.dsId,container:this.screen.container,clickable:AppConfig.isFactory===0});};ModalHtml.prototype.buildDsBinding=function(){var _this=this;var dataMap=this.customVaribles.dataMap={};var $container=$(this.container);var ds=dataMap;var textNodeMap={},attrNodeMap={};var dsNameList=this.entity.modal.points;var $textNodes=$container.find('.text-node-placeholder');var $attrNodes=$container.find('[data-inner-ds-info]');dsNameList.forEach(function(name){var $nodes;if(($nodes=$textNodes.filter('[data-name^="'+name+'"]')).length){$nodes.each(function(){var nodeDataName=$(this).attr('data-name');if(nodeDataName.split(',')[0]!==name)return;var text=document.createTextNode('');if(!textNodeMap[name]){textNodeMap[name]=[{name:this.getAttribute('data-name'),node:text}];}else{textNodeMap[name].push({name:this.getAttribute('data-name'),node:text});}
this.parentNode.replaceChild(text,this);});}else{textNodeMap[name]=[];}
if(($nodes=$attrNodes.filter('[data-inner-ds-info*="'+name+'"]')).length){$nodes.each(function(){var $this=$(this);var attr=$this.data('ds.attr');var info=$this.data('ds.info');if(attr===undefined){$this.data('ds.attr',attr=this.getAttribute('data-inner-ds-attr'));}
if(info===undefined){info=window.decodeURIComponent(this.getAttribute('data-inner-ds-info'));$this.data('ds.info',info=JSON.parse(info));}
if(!attrNodeMap[name]){attrNodeMap[name]=[{node:this.getAttributeNode(attr),info:info}];}else{attrNodeMap[name].push({node:this.getAttributeNode(attr),info:info});}});}else{attrNodeMap[name]=[];}
if(!ds.__observerProps)ds.__observerProps={};if(!ds.__observerProps.hasOwnProperty(name)){ds.__observerProps[name]=null;Object.defineProperty(ds,name,{get:function get(){return this.__observerProps[name];},set:function set(value){if(value===this.__observerProps[name])return;this.__observerProps[name]=value;textNodeMap[name].forEach(function(row){var content=row.name;var node=row.node;var idx=content.indexOf(',');var options;if(idx>-1){options=_this._parseOptionStr(content.substr(idx+1));node.data=_this._formatNumber(value,options);_this._formatNode(node,options,{dsId:content.substr(0,idx)});}else{node.data=isNaN(value)?_this._decodeHtml(value):parseFloat(value).toString();}
if(!isNaN(value)&&!AppConfig.isMobile){_this.setToolTip(node,{dsId:idx>-1?content.substr(0,idx):content});}});attrNodeMap[name].forEach(function(row){var info=row.info;var str='';info.forEach(function(row){var idx;if(row.type===TextTemplateParser.types.text){str+=row.value;}else if(row.type===TextTemplateParser.types.binding){if(row.value.indexOf(name)>-1){idx=row.value.indexOf(',');if(idx>-1){row.content=_this._formatNumber(value,_this._parseOptionStr(row.value.substr(idx+1)));}else{row.content=isNaN(value)?value:parseFloat(value).toString();}}
str+=row.content;}});row.node.value=str;});}});}});$attrNodes.each(function(){this.removeAttribute('data-inner-ds-info');this.removeAttribute('data-inner-ds-attr');});};ModalHtml.prototype._decodeHtml=function(html){var txt=document.createElement("textarea");txt.innerHTML=html;return txt.value;};ModalHtml.prototype.renderModal=function(){var _this=this;var options=this.entity.modal.option;var info;var parser=TextTemplateParser;if(!options){$(this.container).html('');this.spinner.stop();return;}
info=this.getFormatHtml(options.html);info.html=info.html.replace(/([\w-]+?)="([^"]*<%[^<>]+?%>[^"]*)"/mg,function($0,$1,$2){var tokens=parser.parse($2,['<%','%>']);var infoStr;tokens.forEach(function(row){if(row.type===parser.types.binding){row.content='';}});infoStr=window.encodeURIComponent(JSON.stringify(tokens));return $1+'="" data-inner-ds-info="'+infoStr+'" data-inner-ds-attr="'+$1+'"';});info.html=info.html.replace(/<%(.+?)%>/mg,function($0,$1){return'<span class="text-node-placeholder" data-name="'+$1+'">'+$1+'</span>';});$(this.container).html(info.html);runScript(info.scriptContent);_this.initCustomTags();_this.initCustomAttrs();_this.buildDsBinding();if(typeof _this.customVaribles.onRenderComplete==='function'){_this.customVaribles.onRenderComplete.call(null);}
_this.promise.done(function(data){if(!data)return;_this.updateModal(data);});_this.promise.resolve(_this.firstUpdateData);_this.spinner.stop();};ModalHtml.prototype.updateModal=function(data){var _this=this;var modal,updateInterval,options,now;var thisTags;var dataMap=this.customVaribles.dataMap;var customEventHandlers;if(this.promise.state()==='pending'){this.firstUpdateData=data;return;}
modal=this.entity.modal;updateInterval=modal.interval;options=this.entity.options;nowTick=new Date().valueOf();data.forEach(function(row){dataMap[row.dsItemId]=row.data;});for(var tagName in this.customTags){if(!this.customTags.hasOwnProperty(tagName))continue;thisTags=this.customTags[tagName];thisTags.forEach(function($row,i){var handler=tags[tagName].getRealTimeRender;if(typeof handler!=='function')return;handler($row,dataMap);});}
if(typeof this.customVaribles.onUpdateComplete==='function'){this.customVaribles.onUpdateComplete.call(null,dataMap);}};ModalHtml.prototype.showConfigMode=function(){};ModalHtml.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalHtml.prototype.configModal=new ModalHtmlConfig();ModalHtml.prototype.getFormatHtml=function(html){var _this=this;var patternScript=/(<script\b[^>]*>)([\s\S]*?)(<\/script>)/img;var scriptContent=[];var wrapTpl='(function() { |code| }).call(window.__spring_html_modal[\''+_this.entity.id+'\'])';var formatHtml=html.replace(patternScript,function($0,$1,$2,$3){if($2.trim()!=='')scriptContent.push($2);return'';});return{scriptContent:wrapTpl.replace('|code|',scriptContent.join(';\n')),html:formatHtml};};ModalHtml.prototype.preview=function(){};ModalHtml.prototype.close=function(){this.container.innerHTML='';};return ModalHtml;}(namespace('mixins.TooltipMixin'));var TextTemplateParser=function(){function TextTemplateParser(){}
TextTemplateParser.types={text:0,binding:1};TextTemplateParser.parse=function(template,delimiters){var index,lastIndex,lastToken,length,substring,tokens,value;tokens=[];length=template.length;index=lastIndex=0;while(lastIndex<length){index=template.indexOf(delimiters[0],lastIndex);if(index<0){tokens.push({type:this.types.text,value:template.slice(lastIndex)});break;}else{if(index>0&&lastIndex<index){tokens.push({type:this.types.text,value:template.slice(lastIndex,index)});}
lastIndex=index+delimiters[0].length;index=template.indexOf(delimiters[1],lastIndex);if(index<0){substring=template.slice(lastIndex-delimiters[0].length);lastToken=tokens[tokens.length-1];if((lastToken!==undefined?lastToken.type:void 0)===this.types.text){lastToken.value+=substring;}else{tokens.push({type:this.types.text,value:substring});}
break;}
value=template.slice(lastIndex,index).trim();tokens.push({type:this.types.binding,value:value});lastIndex=index+delimiters[1].length;}}
return tokens;};return TextTemplateParser;}();}).call(this);var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var ModalChartCustomConfig=function($,window,undefined){function ModalChartCustomConfig(options){ModalConfig.call(this,options);this.m_bIsRealTime=true;this.m_bIsHisFixCycle=true;}
ModalChartCustomConfig.prototype=Object.create(ModalConfig.prototype);ModalChartCustomConfig.prototype.constructor=ModalChartCustomConfig;ModalChartCustomConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalChartCustom.html'};ModalChartCustomConfig.prototype.init=function(){var _this=this;_this.$btnSubmit=$('#btnSubmit',_this.$wrap);_this.$editor=$('#editor',_this.$wrap);_this.$selectMode=$('#inputMode',_this.$wrap);_this.$selRealInterval=$('#selRealInterval',_this.$wrap);_this.$tmStart=$('#timeStart',_this.$wrap);_this.$tmEnd=$('#timeEnd',_this.$wrap);_this.$tmGroup=$('#rangeSel',_this.$wrap);_this.$divRealtmCycle=$('#divRealTimeCycle',_this.$wrap);_this.$selectHisCycleMode=$('#hisCycleMode',_this.$wrap);_this.$selectHisInterval=$('#selHisInterval',_this.$wrap);_this.$divHisTmRange=$('#historyTmRange',_this.$wrap);_this.$divHisTmCycle=$('#historyTmCycle',_this.$wrap);_this.$inputPeriodVal=$('#inputPeriodValue',_this.$wrap);_this.$selPeriUnit=$('#inputPeriodUnit',_this.$wrap);var modal=_this.options.modalIns.entity.modal;EventAdapter.on($(_this.$editor[0]),'drop',function(e){e.preventDefault();this.focus();var itemId=EventAdapter.getData().dsItemId;if(Boolean(itemId)){var dropTextInter=function dropTextInter(itemId,itemName){var spanCtl=$('<span id="'+itemId+'" title="'+itemName+'" class="pointValue"></span>');spanCtl.text('"<%'+itemName+'%>"');var sel,range;if(window.getSelection){sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var insertDiv=$('<div>');insertDiv.append('&nbsp;');insertDiv.append(spanCtl);insertDiv.append('&nbsp;');var el=insertDiv[0];var frag=document.createDocumentFragment(),node,lastNode;while(node=el.firstChild){lastNode=frag.appendChild(node);}
range.insertNode(frag);if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range);}}}
_this.$editor.append('&nbsp;');};if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){var itemName=AppConfig.datasource.getDSItemById(itemId[i]).alias;dropTextInter(itemId[i],itemName);}}else{var itemName=AppConfig.datasource.getDSItemById(itemId).alias;dropTextInter(itemId,itemName);}}});EventAdapter.on($(_this.$editor[0]),'dragover',function(e){e.preventDefault();});if(Boolean(modal.option)){if(!modal.option.isRealTime){_this.m_bIsRealTime=false;_this.$selectMode.val('history');_this.$tmGroup.css('display','block');_this.$divRealtmCycle.css('display','none');}else{_this.m_bIsRealTime=true;_this.$selectMode.val('realTime');_this.$tmGroup.css('display','none');_this.$divRealtmCycle.css('display','block');}
if(!modal.option.isHisFixCycle){_this.m_bIsHisFixCycle=false;_this.$selectHisCycleMode.val('recent');_this.$divHisTmRange.css('display','none');_this.$divHisTmCycle.css('display','block');}else{_this.m_bIsHisFixCycle=true;_this.$selectHisCycleMode.val('fixed');_this.$divHisTmRange.css('display','block');_this.$divHisTmCycle.css('display','none');}
switch(modal.interval){case'm1':case'm5':case'h1':case'd1':case'M1':_this.$selRealInterval.val(modal.interval);_this.$selectHisInterval.val(modal.interval);break;default:_this.$selRealInterval.val('h1');_this.$selectHisInterval.val('h1');break;}
_this.$tmStart.val(modal.option.timeStart);_this.$tmEnd.val(modal.option.timeEnd);_this.$inputPeriodVal.val(modal.option.timeCycleValue);if(!modal.option.timeCycleUnit){_this.$selPeriUnit.val(modal.option.timeCycleUnit);}else{_this.$selPeriUnit.val('hour');}}else{_this.$selectMode.val('realTime');_this.$tmGroup.css('display','none');}
_this.$selectMode.change(function(e){var flag=$(e.currentTarget).val();if('history'==flag){_this.$tmGroup.css('display','block');_this.m_bIsRealTime=false;_this.$divRealtmCycle.css('display','none');}else{_this.m_bIsRealTime=true;_this.$tmGroup.css('display','none');_this.$divRealtmCycle.css('display','block');}});_this.$selectHisCycleMode.change(function(e){var $opt=_this.$selectHisInterval.children('option');var flag=$(e.currentTarget).val();if('fixed'==flag){_this.m_bIsHisFixCycle=true;$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$divHisTmRange.css('display','block');_this.$divHisTmCycle.css('display','none');}else{_this.m_bIsHisFixCycle=false;_this.$selPeriUnit.change();_this.$divHisTmRange.css('display','none');_this.$divHisTmCycle.css('display','block');}});_this.$selPeriUnit.change(function(e){var $opt=_this.$selectHisInterval.children('option');$opt.eq(0).css('display','none');var flag=$(e.currentTarget).val();switch(flag){case'hour':$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','none');$opt.eq(4).css('display','none');_this.$selectHisInterval.val('m5');break;case'day':$opt.eq(1).css('display','none');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','none');_this.$selectHisInterval.val('h1');break;case'month':$opt.eq(1).css('display','none');$opt.eq(2).css('display','none');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$selectHisInterval.val('d1');break;default:break;}});if(!_this.m_bIsHisFixCycle){_this.$selPeriUnit.change();}
$(".form_datetime").datetimepicker('remove');$(".form_datetime").datetime();_this.attachEvents();I18n.fillArea($('#modalCustom'));};ModalChartCustomConfig.prototype.recoverForm=function(modal){if(Boolean(modal.modalText)){this.$editor.html(modal.modalText);}};ModalChartCustomConfig.prototype.reset=function(){};ModalChartCustomConfig.prototype.attachEvents=function(){var _this=this;_this.$btnSubmit.off().click(function(e){var modal=_this.options.modalIns.entity.modal;var customOption=$('#modalCustom').find('#editor');modal.modalText=customOption.html();modal.modalTextUrl=customOption.text();modal.option=new Object();modal.option.list=[];modal.points=[];var arraySpan=customOption.find('.pointValue');for(var i=0,len=arraySpan.length;i<len;i++){modal.option.list.push({dsItemId:arraySpan[i].id,name:arraySpan[i].title,data:0});modal.points.push(arraySpan[i].id);}
modal.interval=_this.m_bIsRealTime?_this.$selRealInterval.val():_this.$selectHisInterval.val();modal.option.isRealTime=_this.m_bIsRealTime;modal.option.isHisFixCycle=_this.m_bIsHisFixCycle;if(_this.m_bIsHisFixCycle){modal.option.timeStart=_this.$tmStart.val();modal.option.timeEnd=_this.$tmEnd.val();}else{var tmStart=new Date();var tmEnd=new Date();var periodVal=parseInt(_this.$inputPeriodVal.val());var periodUnit=_this.$selPeriUnit.val();switch(periodUnit){case'hour':var time=tmEnd.getTime()-3600000*periodVal;tmStart.setTime(time);break;case'day':var time=tmEnd.getTime()-86400000*periodVal;tmStart.setTime(time);break;case'month':var month=tmEnd.getMonth();if(0==month){tmStart.setFullYear(tmEnd.getFullYear()-1);tmStart.setMonth(11);}else{tmStart.setMonth(month-1);}
break;default:break;}
modal.option.timeStart=tmStart.format('yyyy-MM-dd HH:mm:ss');modal.option.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:ss');modal.option.timeCycleValue=_this.$inputPeriodVal.val();modal.option.timeCycleUnit=_this.$selPeriUnit.val();}
_this.$modal.modal('hide');e.preventDefault();});};return ModalChartCustomConfig;}(jQuery,window);var ModalChartCustom=function(){function ModalChartCustom(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag='zh'==localStorage['language']?0:1;this.spinner.spin(this.container);};ModalChartCustom.prototype=new ModalBase();ModalChartCustom.prototype.optionTemplate={name:'toolBox.modal.CUSTOM_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalChartCustom'};ModalChartCustom.prototype.show=function(){this.init();};ModalChartCustom.prototype.init=function(){};ModalChartCustom.prototype.renderModal=function(e){var _this=this;var optList=_this.modal.option.list;if(!optList){_this.spinner.stop();return;}
var len=optList.length;if(len>0){if(_this.modal.option.isRealTime){var postData={'dataSourceId':0,'dsItemIds':_this.modal.points};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(res){var data=res.dsItemList;if(!data){return;}
if(data.length>0){for(var i=0,len=data.length;i<len;i++){for(var j=0,len2=optList.length;j<len2;j++){if(optList[j].dsItemId==data[i].dsItemId){optList[j].data=parseFloat(parseFloat(data[i].data).toFixed(2));break;}}}
_this.updateModal(data);}}).always(function(e){_this.spinner.stop();});}else{WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:_this.modal.points,timeStart:new Date(_this.modal.option.timeStart).format('yyyy-MM-dd HH:mm:00'),timeEnd:new Date(_this.modal.option.timeEnd).format('yyyy-MM-dd HH:mm:00'),timeFormat:'m5'}).done(function(dataSrc){if(!dataSrc||dataSrc.timeShaft.length<=0){return;}
_this.updateHistoryChart(dataSrc.list,dataSrc.timeShaft);}).error(function(e){}).always(function(e){_this.spinner.stop();});}}else{try{var showOption=eval('({'+_this.modal.modalTextUrl+'})');_this.drawChart(showOption);_this.spinner.stop();}catch(e){_this.spinner.stop();return;}}};ModalChartCustom.prototype.updateModal=function(src){if(this.modal.option.isRealTime){this.updateRealTimeChart(src);}};ModalChartCustom.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalChartCustom.prototype._showConfig=function(){};ModalChartCustom.prototype.setModalOption=function(option){};ModalChartCustom.prototype.drawChart=function(chartOption){this.chart.setOption(chartOption);};ModalChartCustom.prototype.close=function(){};ModalChartCustom.prototype.updateRealTimeChart=function(src){var _this=this;if(!src){return;}
if(src.length>0){var optList=_this.modal.option.list;for(var m=0,lenM=optList.length;m<lenM;m++){for(var n=0,lenN=src.length;n<lenN;n++){if(optList[m].dsItemId==src[n].dsItemId){optList[m].data=src[n].data;break;}}}
var showOption=_this.modal.modalTextUrl;var arr=showOption.split('<%');for(var j=1,len2=arr.length;j<len2;j++){var name=arr[j].split('%>')[0];if(''==name){continue;}
var data=-1;for(var k=0,len3=optList.length;k<len3;k++){if(optList[k].name==name){data=optList[k].data;break;}}
if(-1!=data&&Boolean(data)){if('object'==(typeof data==='undefined'?'undefined':_typeof(data))){var temp;for(var p=0,lenP=data.length;p<lenP;p++){temp+=data[p]+',';}
showOption=showOption.replace(name,temp);}else{showOption=showOption.replace(name,data);}}}
showOption=showOption.replace(/"<%/g,'');showOption=showOption.replace(/%>"/g,'');try{showOption=eval('({'+showOption+'})');_this.drawChart(showOption);}catch(e){_this.spinner.stop();return;}}};ModalChartCustom.prototype.updateHistoryChart=function(list,timeShaft){var _this=this;if(!list){return;}
if(list.length>0){var infoList=[];var arrId=[];for(var i=0,len=list.length;i<len;i++){arrId.push(list[i].dsItemId);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=list.length;i<len;i++){var id=list[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var itemName=arrItem[m].alias;var item={id:id,name:itemName,data:list[i].data};infoList.push(item);break;}}}
var showOption=_this.modal.modalTextUrl;var arr=showOption.split('<%');for(var j=1,len2=arr.length;j<len2;j++){var name=arr[j].split('%>')[0];if(''==name){continue;}
var data;for(var k=0,len3=infoList.length;k<len3;k++){if(infoList[k].name==name){data=infoList[k].data;break;}}
if(Boolean(data)){if('object'==(typeof data==='undefined'?'undefined':_typeof(data))){var temp='';for(var p=0,lenP=data.length-1;p<lenP;p++){temp+=data[p]+',';}
temp+=data[lenP-1];showOption=showOption.replace(name,temp);}else{showOption=showOption.replace(name,data);}}}
showOption=showOption.replace(/"<%/g,'');showOption=showOption.replace(/%>"/g,'');try{showOption=eval('({'+showOption+'})');if(!showOption.xAxis||0==showOption.xAxis.length){var arrAxis=[{type:'category',boundaryGap:false,data:timeShaft}];showOption.xAxis=arrAxis;}else if(!showOption.xAxis[0].data||0==showOption.xAxis[0].data.length){showOption.xAxis[0].data=timeShaft;}
_this.drawChart(showOption);}catch(e){_this.spinner.stop();return;}}};ModalChartCustom.prototype.configModal=new ModalChartCustomConfig();return ModalChartCustom;}();var ModalPointKPI=function(){function ModalPointKPI(screen,entityParams){if(!entityParams)return;this.isConfigMode=false;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalPointKPI.prototype=new ModalBase();ModalPointKPI.prototype.optionTemplate={name:'toolBox.modal.POINT_KPI',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalPointKPI'};ModalPointKPI.prototype.show=function(){this.init();};ModalPointKPI.prototype.init=function(){this.pointKPIWiki=undefined;};ModalPointKPI.prototype.renderModal=function(e){var _this=this,tempHtml='',level=1,rootId;this.spinner&&this.spinner.stop();if(!(this.entity.modal.option&&this.entity.modal.option.kpiList))return;this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});$(this.container).append(tempHtml);function traverseTree(tree){new PointKPIItem(tree,_this,0);rootId=tree.id;traverse(tree,0);}
function traverse(node,i){var children=node.list;node.pointPassData=[];node.show=true;if(children!=null&&children.length>0){if(node.parentId==rootId){level=2;}
new PointKPIItem(children[i],_this,level);if(i==children.length-1){for(var j=0;j<children.length;j++){j==0&&level++;traverse(children[j],0);}}else{traverse(node,i+1);}}}};ModalPointKPI.prototype.showConfigMode=function(){};ModalPointKPI.prototype.updateModal=function(points){};ModalPointKPI.prototype.configure=function(){var _this=this;this.spinner&&this.spinner.stop();this.isConfigMode=true;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};var $btnRemove=$('<span class="glyphicon glyphicon-remove-circle springConfigRemoveBtn"></span>');var $btnAdd=$('<span class="glyphicon glyphicon-remove-circle springConfigRemoveBtn addTree" style="transform: rotateZ(45deg);color: #333;right: 50px !important;"></span>');divMask.appendChild($btnAdd[0]);divMask.appendChild($btnRemove[0]);this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer&&(divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');if(sourceId==targetId)return;$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();if(!$sourceParent[0].classList.contains('chartsCt')&&$targetParent[0].classList.contains('chartsCt')){_this.screen.insertChartIntoMix(sourceId,$(e.target).closest('.chartsCt')[0]);}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}
_this.screen.isScreenChange=true;});var $select='<div class="form-group" style="position: absolute;top: 5px;left: 5px;">\
            <label for="inputEmail3" class="col-sm-2 control-label" style="height: 34px;line-height: 34px;">Cycle</label>\
            <div class="col-sm-8" style="display:inline-block;">\
                <select id="selectCycle" class="form-control" style="width: 100px;padding: 0;"> \
                    <option value="month">'+I18n.resource.dashboard.modalPointKPI.MONTH+'</option> \
                    <option value="season">'+I18n.resource.dashboard.modalPointKPI.QUARTER+'</option> \
                    </select>\
            </div>\
            </div>';$(this.container).append($select);var $selectCycle=$(this.container).find('#selectCycle');if(_this.entity.modal.option&&_this.entity.modal.option.dateCycle&&_this.entity.modal.option.dateCycle=='season'){$selectCycle.find('option:nth-of-type(2)')[0].selected='selected';}else{$selectCycle.find('option:nth-of-type(1)')[0].selected='selected';}
$selectCycle[0].onchange=function(){_this.entity.modal.option.dateCycle=$selectCycle[0].value;};var $chartCt=$('<div class="divResize chartsCt gray-scrollbar" style="overflow:auto;">');$chartCt.append($(this.container));divMask.appendChild($chartCt[0]);if($('.level_2').width()>$chartCt.width()-320){$('.domTree',$chartCt).width($('.level_2').width()+40);}
if($(this.container).find('.domTree').length==1){$btnAdd.attr('title','Already exists a root').addClass('btnDisabled');}
this.executeConfigMode();$btnRemove.off('click').on('click',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this=null;});$btnAdd.off('click').on('click',function(){if($(_this.container).find('.domTree').length==0){new PointKPIItem({parentId:''},_this,0);$('#divContainer_'+_this.entity.id).find('.addTree').attr('title','Already exists a root').addClass('btnDisabled');_this.screen.isScreenChange=true;}});};ModalPointKPI.prototype.initContainer=function(replacedElementId){var _this=this;var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass=' gray-scrollbar';if(!divParent||replacedElementId){isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
divParent.className='springContainer';if(AppConfig.isMobile){divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR*2+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*2+'%';}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.title&&this.entity.modal.title!=''&&!this.entity.isNotRender){divParent.innerHTML='<div class="panel panel-default">\
                <div class="panel-heading springHead">\
                    <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                </div>\
                <div class="panel-body springContent'+scrollClass+'" style="overflow:auto;"></div>\
            </div>';}else{divParent.innerHTML='<div class="panel panel-default" style="background: none;">\
                <div class="panel-body springContent'+scrollClass+'" style="height:100%;overflow:auto;"></div>\
            </div>';}
var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];var lkHistory=document.createElement('a');lkHistory.className='springLinkBtn';lkHistory.title='Show History';lkHistory.href='javascript:;';lkHistory.innerHTML='<span class="glyphicon glyphicon-stats"></span>';divBtnCtn.appendChild(lkHistory);lkHistory.onclick=function(){var dataTree=_this.entity.modal.option.kpiList[0];var dateCycle=!_this.entity.modal.option.dateCycle?'month':_this.entity.modal.option.dateCycle;if(Boolean(dataTree)){new ModalPointKpiGrid(dataTree,dateCycle).show();}};domPanel.appendChild(divBtnCtn);this.initToolTips(divParent.getElementsByClassName('springHead'));this.container=divParent.getElementsByClassName('springContent')[0];};ModalPointKPI.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalPointKPI;}();var PointKPIItem=function(){function PointKPIItem(item,entity,i){this.parentArgt=entity;this.entity=entity.entity;this.container=entity.container;this.kpiItem={id:!item.id?new Date().getTime():item.id,parentId:!item.parentId?'':item.parentId,name:!item.name?'Unaming':item.name,pointKPI:!item.pointKPI?'':item.pointKPI,pointGrade:!item.pointGrade?'':item.pointGrade,pointPass:!item.pointPass?'':item.pointPass,rule:!item.rule?'':item.rule,weight:!item.weight?'':item.weight,wikiId:!item.wikiId?'':item.wikiId,list:!item.list?[]:item.list};if(i===0&&!item.id&&item.parentId==''){!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.kpiList&&(this.entity.modal.option.kpiList=[]);this.entity.modal.option.kpiList.push(this.kpiItem);}
this.addItemDom(this.kpiItem,i);this.attachEventsItem(this.kpiItem);}
PointKPIItem.prototype.addItem=function(id){var _this=this;var level=1;var pointKPIItem;this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(id==node.id){pointKPIItem=new PointKPIItem({parentId:id},_this.parentArgt,level);node.list.push(pointKPIItem.kpiItem);return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){j==0&&level++;traverse(children[j],0);}}else{traverse(node,i+1);}}}};var btn_tpl='\
            <div class="btnGroup">\
                <span class="glyphicon glyphicon-remove-circle btnAddItem" style="transform: rotateZ(45deg);"></span>\
                <span class="glyphicon glyphicon-cog btnConfigItem"></span>\
                <span class="glyphicon glyphicon-info-sign btnConfigWiki"></span>\
                <span class="glyphicon glyphicon-remove-circle btnRemoveItem"></span>\
                <span class="glyphicon glyphicon-info-sign btnViewWiki{isShow}" wikiId="{wikiId}"></span>\
            </div>';PointKPIItem.prototype.tpl={treeWrap:'<div class="domTree"></div>',level_1_Tpl:'\
            <div class="totalLevel">\
                <div class="itemWrap" id="kpi_{id}">\
                    <div class="hrLine"></div>\
                    <span class="pointName">{name}</span>\
                    <span class="glyphicon glyphicon-pencil"></span>\
                    <div class="circle {bgColor}">\
                        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                        <span>{pointPassVal}</span>\
                    </div>'+btn_tpl+'</div>\
            </div>',level_2_Ctn:'\
            <div class="level_2">\
                <div class="hrLine1"></div>\
                <ul></ul>\
            </div>',level_2_Tpl:'<li class="level_3" parentId="{parentId}" id="item_{id}">\
            	<div class="thirdCon1">\
                	<div class="itemWrap" id="kpi_{id}">\
                	    <div class="circle {bgColor}">\
                	        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                	        <span>{pointPassVal}</span>\
                	    </div>\
                	    <span class="pointName">{name}</span><span class="glyphicon glyphicon-pencil"></span><br class="clear"><div class="hrLine2"></div>'+btn_tpl+'</div>\
                </div>\
                <ul class="childLevel">\
                </ul>\
            </li>',level_3_Tpl:'<li parentId="{parentId}" id="item_{id}">\
                <div class="hrLine3"></div>\
                <div class="itemWrap" id="kpi_{id}">\
                    <div class="smCircle {bgColor}">\
                        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                        <span>{pointPassVal}</span>\
                    </div>\
                    <span class="pointName">{name}</span>\
                    <span class="glyphicon glyphicon-pencil"></span><br class="clear">\
                    <div class="hrLine4"></div>'+btn_tpl+'</div>\
                <ul class="childLevel">\
                </ul>\
            </li>'};PointKPIItem.prototype.addItemDom=function(kpiItem,i){var kpiItemForEl={id:kpiItem.id,parentId:kpiItem.parentId,name:kpiItem.name,isShow:kpiItem.wikiId!=''?' showWiki':'',pointPassVal:kpiItem.pointPass!=''?I18n.resource.dashboard.modalPointKPI.UNPASS:I18n.resource.dashboard.modalPointKPI.PASS,bgColor:kpiItem.pointPass!=''?'unpass':'pass'};var $domTree=$(this.container).children('.domTree'),$level_2_ul,$level_3_ul;$domTree&&($level_2_ul=$domTree.find('.level_2>ul'));$level_2_ul&&($level_3_ul=$level_2_ul.find('#item_'+kpiItem.parentId+' > .childLevel'));if(kpiItem.parentId==''){$(this.container).append(this.tpl.treeWrap);$domTree=$(this.container).children('.domTree');$domTree.html(this.tpl.level_1_Tpl.formatEL(kpiItemForEl));}else if(i==1&&$domTree){if($level_2_ul.length==0){$domTree.append(this.tpl.level_2_Ctn);$level_2_ul=$domTree.find('.level_2>ul');}
if($domTree.parent().width()-$level_2_ul.width()<270){$domTree.width($domTree.width()+255);}
$level_2_ul.append(this.tpl.level_2_Tpl.formatEL(kpiItemForEl));}else if($level_2_ul){$level_3_ul.append(this.tpl.level_3_Tpl.formatEL(kpiItemForEl));if($level_3_ul.find('.itemWrap').width()<140){$level_3_ul.find('.btnAddItem').hide();}}};PointKPIItem.prototype.removeItem=function(id){var _this=this;this.entity.modal.option.kpiList.forEach(function(kpiItem,index){if(kpiItem.id==id&&kpiItem.parentId==''){_this.entity.modal.option.kpiList.splice(index,1);$('#kpi_'+id).closest('.domTree').remove();$('#divContainer_'+_this.entity.id).find('.addTree').removeClass('btnDisabled').attr('title','');}else{traverseTree(kpiItem);}});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(children!=null&&children.length>0){if(id==children[i].id){node.list.splice(i,1);$('#kpi_'+id).closest('li').remove();return;}else{if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}};PointKPIItem.prototype.showConfigModal=function(){var _this=this,$modalConfig=$('#modalConfig');var tempHtml='\
            <div class="modal-body" id="pointKPI">\
                <div class="form-horizontal">\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divKPI">KPI</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divKPI">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divGrade">Grade</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divGrade">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divIsPass">Is pass</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divIsPass">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divDashboard">Config dashboard</label>\
                        <div class="col-md-4">\
                            <button type="button" id="btnDashboard" class="btn btn-default">Config</button>\
                        </div>\
                    </div>\
                </div>\
            </div>';$modalConfig.off('show.bs.modal').on('show.bs.modal',function(e){var pointKPIAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointKPI).alias;var pointGradeAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointGrade).alias;var pointPassAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointPass).alias;$modalConfig.find('.modal-body').hide();$modalConfig.find('.modal-footer').before(tempHtml);$modalConfig.find('#divKPI').attr('data-value',_this.kpiItem.pointKPI).attr('title',pointKPIAlias).html(pointKPIAlias);$modalConfig.find('#divGrade').attr('data-value',_this.kpiItem.pointGrade).attr('title',pointKPIAlias).html(pointGradeAlias);$modalConfig.find('#divIsPass').attr('data-value',_this.kpiItem.pointPass).attr('title',pointKPIAlias).html(pointPassAlias);if(pointPassAlias){$modalConfig.find('#startConfig').removeClass('disabled');}
_this.parentArgt.screen.modalConfigPane.toggleDataSource(true);_this.attachEventsConfig($modalConfig);});$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$modalConfig.find('#pointKPI').remove();_this.parentArgt.screen.modalConfigPane.toggleDataSource(false);});$modalConfig.modal('show');};PointKPIItem.prototype.viewDetail=function(){var $dialog=$('#dialogModal');var energyScreen=new EnergyScreen();var $dialogContent=$dialog.find('#dialogContent').css({height:'90%',width:'90%',margin:'auto',marginTop:'2.5%',backgroundColor:'#fff'});$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$dialogContent.removeAttr('style').html('');energyScreen.workerUpdate&&energyScreen.workerUpdate.terminate();}).modal({});energyScreen.id=this.kpiItem.id+'_'+AppConfig.userId;energyScreen.container=$dialogContent[0];energyScreen.isForBencMark=true;energyScreen.init();};PointKPIItem.prototype.attachEventsItem=function(kpiItem){var $kpiWrap=$('#kpi_'+kpiItem.id),_this=this;$('.btnAddItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.addItem(_this.kpiItem.id);_this.parentArgt.screen.isScreenChange=true;});$('.btnRemoveItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.removeItem(_this.kpiItem.id);var $domTree=$('.domTree');if($(this).closest('.thirdCon1').length==1&&$domTree.width()-$('.level_2').width()>260){$domTree.width($domTree.width()-255);}
_this.parentArgt.screen.isScreenChange=true;});$('.btnConfigItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.showConfigModal();});$('.btnConfigWiki',$kpiWrap).off().on('click',function(e){e.stopPropagation();if(_this.kpiItem.wikiId){_this.showWikiEditModal();}else{_this.showWikiSearchModal();}});$('.btnViewWiki',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.viewWikiInfoModal();});$('.glyphicon-pencil',$kpiWrap).off().on('click',function(e){e.stopPropagation();if(_this.parentArgt.isConfigMode==true){_this.editPointKPIName();}});$kpiWrap.off().on('click',function(e){e.stopPropagation();if(_this.parentArgt.isConfigMode==false){_this.viewDetail(_this.kpiItem.id);}});};PointKPIItem.prototype.attachEventsConfig=function($modalConfig){var _this=this;var $dropArea=$modalConfig.find('.drop-area');var $btnConfig=$modalConfig.find('#startConfig');var $btnDashboard=$modalConfig.find('#btnDashboard');$dropArea.off('dragover').on('dragover',function(e){e.preventDefault();});$dropArea.off('dragenter').on('dragenter',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});$dropArea.off('dragleave').on('dragleave',function(e){$(e.target).removeClass('on');e.stopPropagation();});$dropArea.off('drop').on('drop',function(e){var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');name=AppConfig.datasource.getDSItemById(itemId).alias;$target.attr({'data-value':itemId,'title':name});$target.html('<span>'+name+'</span>');e.stopPropagation();if($target.attr('id')=='divIsPass'){$btnConfig.removeClass('disabled');}
_this.parentArgt.screen.isScreenChange=true;});$btnConfig.off().on('click',function(){var KPI=$('#divKPI').attr('data-value');var grade=$('#divGrade').attr('data-value');var pass=$('#divIsPass').attr('data-value');_this.kpiItem.pointKPI=!KPI?'':KPI;_this.kpiItem.pointGrade=!grade?'':grade;_this.kpiItem.pointPass=!pass?'':pass;_this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.kpiItem.id){node.pointKPI=_this.kpiItem.pointKPI;node.pointGrade=_this.kpiItem.pointGrade;node.pointPass=_this.kpiItem.pointPass;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}
$('#modalConfig').modal('hide');});$btnDashboard.off('click').on('click',function(){ScreenManager.show(EnergyScreen,_this.kpiItem.id+'_'+AppConfig.userId);});};PointKPIItem.prototype.showWikiSearchModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.showWikiSearch();};PointKPIItem.prototype.showWikiEditModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.getWikiById();};PointKPIItem.prototype.viewWikiInfoModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.viewWikiInfo(this.kpiItem.wikiId);};PointKPIItem.prototype.editPointKPIName=function(){var _this=this,$divKPI=$('#kpi_'+this.kpiItem.id),$input=$divKPI.find('.pointNameInput'),$springConfigMask;if($input.length==0){var $input=$('<input type="text" class="form-control pointNameInput"/>').val(_this.kpiItem.name);var $spanName=$('.pointName','#kpi_'+this.kpiItem.id).hide().after($input);$springConfigMask=$divKPI.closest('.springConfigMask[draggable="true"]').attr('draggable',false);$input.blur(function(){savePointName(this);}).keyup(function(e){if(e.keyCode==13){savePointName(this);}});}else{savePointName($input[0]);}
function savePointName(divInput){_this.kpiItem.name=$(divInput).val();$(divInput).remove();$spanName.html(_this.kpiItem.name).show();$springConfigMask.attr('draggable',true);_this.parentArgt.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});_this.parentArgt.screen.isScreenChange=true;function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.kpiItem.id){node.name=_this.kpiItem.name;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}};return PointKPIItem;}();var ModalPointKpiGrid=function(){var _this;function ModalPointKpiGrid(data,dateCycle){if(Boolean(data)){this.m_kpiDataTree=data;this.m_dateCycle=dateCycle;this.m_selectYear=0;this.m_htmlPage;this.m_htmlTreeTemp;this.m_htmlGridTemp;this.m_bIsCurrentYear=false;this.m_nCurrentSeason=0;this.m_nCurrentMonth=0;this.m_strGood='达标';this.m_strBad='未达标';this.m_strCurrentGood='当前达标';this.m_strCurrentBad='当前超标';this.m_strCurrentWarn='警戒';this.m_nStartYear=0;this.m_nEndYear=0;_this=this;}}
ModalPointKpiGrid.prototype=new ModalPointKpiGrid();ModalPointKpiGrid.prototype.show=function(){this.init();};ModalPointKpiGrid.prototype.init=function(){WebAPI.get('/static/views/observer/widgets/modalPointKpiGrid.html').done(function(resultHtml){_this.m_htmlPage=$(resultHtml);var timeControl=_this.m_htmlPage.find('#timeSelect');var tmNow=new Date();var tmStart=new Date();tmStart.setFullYear(tmNow.getFullYear()-10);_this.m_nStartYear=tmStart.getFullYear();_this.m_nEndYear=tmNow.getFullYear();timeControl.val(tmNow.format('yyyy'));timeControl.datetimepicker({format:'yyyy',startView:'decade',minView:'decade',autoclose:true,todayBtn:false,pickerPosition:'bottom-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){_this.m_selectYear=timeControl.val();var tmNow=new Date();var nCurYear=tmNow.getFullYear();if(nCurYear==_this.m_selectYear){_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;}else{_this.m_bIsCurrentYear=false;}
_this.postDataShow(false);});var yearPre=_this.m_htmlPage.find('#btnYearPre');if(Boolean(yearPre)){yearPre.click(function(e){var year=parseInt(timeControl.val());if(year<=_this.m_nStartYear){year=_this.m_nStartYear;return;}else{year-=1;}
timeControl.val(year);_this.timeSetting(timeControl.val());_this.postDataShow(false);});}
var yearNext=_this.m_htmlPage.find('#btnYearNext');if(Boolean(yearNext)){yearNext.click(function(e){var year=parseInt(timeControl.val());if(year>=_this.m_nEndYear){year=_this.m_nEndYear;return;}else{year+=1;}
timeControl.val(year);_this.timeSetting(timeControl.val());_this.postDataShow(false);});}
var tmNow=new Date();_this.m_selectYear=tmNow.getFullYear();_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;_this.postDataShow(true);}).always(function(){});};ModalPointKpiGrid.prototype.postDataShow=function(bIsFirst){var ptPassArray=[];ptPassArray=_this.recursiveTreeGetPointPassId(_this.m_kpiDataTree);var tmStart=new Date();tmStart.setMonth(0);tmStart.setDate(1);tmStart.setHours(0);tmStart.setMinutes(0);tmStart.setSeconds(0);var tmEnd=new Date();if(!bIsFirst&&tmStart.getFullYear()!=_this.m_selectYear){tmStart.setFullYear(_this.m_selectYear);tmEnd.setFullYear(_this.m_selectYear);tmEnd.setMonth(11);tmEnd.setDate(31);tmEnd.setHours(23);tmEnd.setMinutes(59);tmEnd.setSeconds(59);}
var postData={};postData.dataSourceId='';postData.dsItemIds=ptPassArray;postData.timeStart=tmStart.format('yyyy-MM-dd hh:mm:ss');postData.timeEnd=tmEnd.format('yyyy-MM-dd hh:mm:ss');postData.timeFormat='M1';if(bIsFirst){Spinner.spin($('#paneCenter')[0]);}else{Spinner.spin(_this.m_htmlPage[2]);}
var tree=_this.m_htmlPage.find('#treeCtl');tree.html('');var table=_this.m_htmlPage.find('#tableCtl');table.html('');WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(res){if(!res||!res.list){return;}
for(var i=0,len=res.list.length;i<len;i++){_this.recursiveTreeSetPointPassData(_this.m_kpiDataTree,res.list[i].dsItemId,res.list[i].data);}
var divContain=$('<div style="cursor:pointer"></div>');divContain.append('<ul class="kpiGridHeader" style="height:32px;margin-bottom:0px"></ul>');tree.append(divContain);var head=$('<thead class="kpiGridHeader"></thead>');var headTr=$('<tr></tr>');if('season'==_this.m_dateCycle){for(var i=0;i<4;i++){var headTh=$('<th colspan="3" class="colSeason">'+(i+1)+'季度</th>');headTr.append(headTh);}
head.append(headTr);}else if('month'==_this.m_dateCycle){headTr=$('<tr></tr>');for(var i=0;i<12;i++){var headTh=$('<th class="colMonth">'+(i+1)+'月</th>');headTr.append(headTh);}
head.append(headTr);}
table.append(head);_this.showControlInfo();if(bIsFirst){_this.m_htmlPage.modal('show');}}).always(function(){Spinner.stop();});};ModalPointKpiGrid.prototype.showControlInfo=function(){_this.m_htmlTreeTemp=$('<div style="cursor:pointer"></div>');_this.m_htmlGridTemp=$('<tbody class="kpiGridBody"></tbody>');_this.recursiveTreeSetting(_this.m_kpiDataTree);_this.m_htmlPage.find('#treeCtl').append(_this.m_htmlTreeTemp);_this.m_htmlPage.find('#tableCtl').append(_this.m_htmlGridTemp);};ModalPointKpiGrid.prototype.recursiveTreeSetting=function(item){var parentNode;if(''==item.parentId){parentNode=_this.m_htmlTreeTemp;}else{parentNode=_this.m_htmlTreeTemp.find('#tree_'+item.parentId).find('.rows').eq(0);}
if(parentNode.length>0){var bLeaf=0==item.list.length?true:false;_this.insertTreeCtrl(item.id,item.name,parentNode,bLeaf);}
var nLen=item.pointPassData.length;if(nLen<12){for(var i=nLen,len=12-nLen;i<12;i++){item.pointPassData.push(-1);}}
nLen=12;var gridTr1=$('<tr class="kpiGridRow" id="grid1_'+item.id+'"></tr>');var gridTd1='';var nLen=item.pointPassData.length;var bIsCurrent=false;var strShow;if('season'==_this.m_dateCycle){var arrSeason=[item.pointPassData[0],item.pointPassData[3],item.pointPassData[6],item.pointPassData[9]];for(var i=0;i<4;i++){if(_this.m_bIsCurrentYear&&i==_this.m_nCurrentSeason){bIsCurrent=true;}else{bIsCurrent=false;}
if(-1==arrSeason[i]){gridTd1+='<td colspan=3></td>';}else if(Boolean(arrSeason[i])){strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=3 class="kpiGridGood">'+strShow+'</td>';}else{strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=3 class="kpiGridBad">'+strShow+'</td>';}}}else if('month'==_this.m_dateCycle){for(var i=0;i<nLen;i++){if(_this.m_bIsCurrentYear&&i==_this.m_nCurrentMonth){bIsCurrent=true;}else{bIsCurrent=false;}
if(-1==item.pointPassData[i]){gridTd1+='<td colspan=1></td>';}else if(Boolean(item.pointPassData[i])){strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=1 class="kpiGridGood">'+strShow+'</td>';}else{strShow=bIsCurrent?_this.m_strCurrentBad:_this.m_strBad;gridTd1+='<td colspan=1 class="kpiGridBad">'+strShow+'</td>';}}}
gridTr1.append($(gridTd1));_this.m_htmlGridTemp.append(gridTr1);var nChildNum=item.list.length;if(0==nChildNum){}else{for(var i=0;i<nChildNum;i++){arguments.callee(item.list[i]);}}};ModalPointKpiGrid.prototype.recursiveTreeSetShow=function(item,nFindId,bIsShow){if(nFindId==item.id){for(var i=0,len=item.list.length;i<len;i++){item.list[i].show=bIsShow;}
return;}else{for(var i=0,len=item.list.length;i<len;i++){arguments.callee(item.list[i],nFindId,bIsShow);}}};ModalPointKpiGrid.prototype.recursiveTreeGetShow=function(item){var arr=[];var nLen=item.list.length;if(nLen>0){if(item.show){arr.push(item.id);for(var i=0;i<nLen;i++){var temp=arguments.callee(item.list[i]);arr=arr.concat(temp);}}}else{if(item.show){return[item.id];}}
return arr;};ModalPointKpiGrid.prototype.recursiveTreeGetPointPassId=function(item){var arr=[];var nLen=item.list.length;if(nLen>0){if(item.show){arr.push(item.pointPass);for(var i=0;i<nLen;i++){var temp=arguments.callee(item.list[i]);arr=arr.concat(temp);}}}else{if(item.show){return[item.pointPass];}}
return arr;};ModalPointKpiGrid.prototype.recursiveTreeSetPointPassData=function(item,nPtPassId,ptPassData){if(nPtPassId==item.pointPass){item.pointPassData=ptPassData;return;}else{for(var i=0,len=item.list.length;i<len;i++){arguments.callee(item.list[i],nPtPassId,ptPassData);}}};ModalPointKpiGrid.prototype.insertTreeCtrl=function(groupId,groupName,parentNode,bIsLeaf){var $ul=$('<ul class="nav nav-list kpiTreeGroup" id="tree_'+groupId+'">');var $liHd;if(bIsLeaf){$liHd=$('<li class="kpiTreeHeader"><span style="margin-left:40px"></span></li>');}else{$liHd=$('<li class="kpiTreeHeader"><img src="/static/images/dataSource/group_head_sel.png" alt="png" class="dsTreeHeaderIcon"></li>');}
var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);$liHd.click(function(e){var tar=$(e.currentTarget);if(Boolean(tar)){var treeItemId=tar.closest('.kpiTreeGroup')[0].id;var num=treeItemId.substring(5);var bindRow=tar.next('.rows');if(Boolean(bindRow)){var bIsShow=true;var showFlag=bindRow.eq(0).css('display');if('block'==showFlag){bIsShow=false;}else{bIsShow=true;}
_this.recursiveTreeSetShow(_this.m_kpiDataTree,num,bIsShow);var arr=_this.recursiveTreeGetShow(_this.m_kpiDataTree);var arrGrid=[];for(var k=0,len3=arr.length;k<len3;k++){arrGrid.push('grid1_'+arr[k]);arrGrid.push('grid2_'+arr[k]);}
var body=_this.m_htmlPage.find('#tableCtl tbody tr');for(var i=0,len=body.length;i<len;i++){var trFind=false;for(var j=0,len2=arrGrid.length;j<len2;j++){if(body[i].id==arrGrid[j]){trFind=true;break;}}
if(!trFind){$(body[i]).css('display','none');}else{$(body[i]).css('display','');}}
bindRow.slideToggle();}}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow);parentNode.append($ul);};ModalPointKpiGrid.prototype.timeSetting=function(selYear){_this.m_selectYear=selYear;var tmNow=new Date();var nCurYear=tmNow.getFullYear();if(nCurYear==_this.m_selectYear){_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;}else{_this.m_bIsCurrentYear=false;}};return ModalPointKpiGrid;}();var ModalReportChapter=function(){function ModalReportChapter(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalReportChapter.prototype=new ModalBase();ModalReportChapter.prototype.optionTemplate={name:'toolBox.modal.REPORT_CHAPTER',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalReportChapter'};ModalReportChapter.prototype.show=function(){this.init();};ModalReportChapter.prototype.init=function(){};ModalReportChapter.prototype.renderModal=function(e){var _this=this;var postData={projectId:AppConfig.projectId,menuId:this.entity.modal.option.menuId,chapter:this.entity.modal.option.chapter,unit:this.entity.modal.option.unit};WebAPI.post('/report/getReportHtml/',postData).done(function(result){if(result.success){_this.spinner&&_this.spinner.stop();_this.container.innerHTML=result.data;_this.reportScreen=new ReportScreen();_this.reportScreen.renderCharts($('#beopReport .report-unit'));}else{alert(result.msg);}}).always(function(){_this.spinner&&_this.spinner.stop();});};ModalReportChapter.prototype.showConfigMode=function(){};ModalReportChapter.prototype.updateModal=function(points){};ModalReportChapter.prototype.setModalOption=function(option){};ModalReportChapter.prototype.modalDialog='\
        <div class="modal-content">\
            <div class="modal-header">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>\
                <h4 class="modal-title" id="">Config</h4>\
            </div>\
            <div class="modal-body">\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Type</label>\
                    </div>\
                    <div class="col-xs-4">\
                        <select id="typeList" class="form-control type"></select>\
                    </div>\
                </div>\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Chapter</label>\
                    </div>\
                    <div class="col-xs-4" id="chapterList">\
                    </div>\
                </div>\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Section</label>\
                    </div>\
                    <div class="col-xs-4" id="unitList">\
                    </div>\
                </div>\
            </div>\
            <div class="modal-footer">\
                <div id="configAlert"></div>\
                <button type="button" class="btn btn-primary" id="confirm">Confirm</button>\
            </div>\
        </div>';ModalReportChapter.prototype.showConfigModal=function(){var _this=this;var $dialogModal=$('#dialogModal');var $dialogContent=$dialogModal.find('#dialogContent').html(this.modalDialog);var $modalBody=$dialogContent.find('.modal-body');var $confirm=$dialogContent.find('#confirm');$dialogModal.modal('show');Spinner.spin($dialogContent.find('.modal-content')[0]);WebAPI.get('/report/getReportMenu/'+AppConfig.projectId).done(function(result){var $typeList=$modalBody.find('#typeList').empty();var $chapterList=$modalBody.find('#chapterList').empty();var $unitList=$modalBody.find('#unitList').empty();var typeTemp='',$firstUnitSelect,$firstChapterSelect;if(result.data&&result.data.length>0){for(var i=0;i<result.data.length;i++){var type=result.data[i];typeTemp+='<option value="'+type._id+'" id="'+i+'">'+type.text+'</option>';var $selectChapter=$('<select id="chapter_'+i+'" class="form-control chapter" style="display: none;"></select>');if(type.structure&&type.structure.data&&type.structure.data.length>0){$selectChapter.append('<option value="all" class="type">All Chapter</option>');for(var j=0;j<type.structure.data.length;j++){var chapter=type.structure.data[j];$selectChapter.append('<option value="'+chapter.name+'" id="'+j+'" parentId="'+i+'">'+chapter.name+'</option>');var $selectUnit=$('<select id="unit_'+i+'_'+j+'" class="form-control unit" style="display: none;"></select>');if(chapter.units&&chapter.units.length>0){$selectUnit.append('<option value="all">All Section</option>');for(var k=0;k<chapter.units.length;k++){var unit=chapter.units[k];$selectUnit.append('<option value="'+unit.unitName+'" id="'+k+'" parentId="'+j+'">'+unit.unitName+'</option>');}}else{$selectUnit.append('<option value="no">No Section</option>');}
$unitList.append($selectUnit);}}else{$selectChapter.append('<option value="no" class="type">No Chapter</option>');}
$chapterList.append($selectChapter);}}else{typeTemp+='<option value="no" class="type">No type</option>';}
$typeList.html(typeTemp);$firstChapterSelect=$chapterList.find('select:eq(0)').show();$firstUnitSelect=$unitList.find('select:eq(0)').show();if($firstChapterSelect.length==0){$chapterList.append('<select class="form-control chapter no"><option value="no" class="type">No Section</option></select>');}
if($firstUnitSelect.length==0){$unitList.append('<select class="form-control unit no"><option value="no" class="type">No Section</option></select>');}
if(_this.entity.modal.option&&result.data&&result.data.length>0){var $selectedChapter=undefined;var $selectedUnit=undefined;var $typeOption=undefined;var $chapterOption=undefined;if(_this.entity.modal.option.menuId){$typeList.val(_this.entity.modal.option.menuId);$typeOption=$typeList.find('option[value="'+_this.entity.modal.option.menuId+'"]');}
if(_this.entity.modal.option.chapter!=undefined){$chapterList.children().hide();$selectedChapter=$chapterList.find('#chapter_'+$typeOption.attr('id'));$selectedChapter.show();if(_this.entity.modal.option.chapter!=''){$selectedChapter.val(_this.entity.modal.option.chapter);$chapterOption=$selectedChapter.find('option[value="'+_this.entity.modal.option.chapter+'"]');}}
if(_this.entity.modal.option.unit!=undefined&&$chapterOption!=undefined&&$chapterOption.length>0){$unitList.children().hide();$selectedUnit=$unitList.find('#unit_'+$chapterOption.attr('parentId')+'_'+$chapterOption.attr('id'));$selectedUnit.show();if(_this.entity.modal.option.unit!=''){$selectedUnit.val(_this.entity.modal.option.unit);}}}
$modalBody.off('change').on('change','select',function(){$modalBody.find('select.no').remove();if($(this).hasClass('type')){var typeId=$(this).find('option[value="'+this.value+'"]')[0].id;var $chapterSelect=$('#chapter_'+typeId);$chapterList.children().hide();$chapterSelect.show();var chapterId=$chapterSelect.find('option[value="'+$chapterSelect[0].value+'"]').attr('id');$unitList.children().hide();if(chapterId){var $unitSelect=$('#unit_'+typeId+'_'+chapterId);$unitSelect.show();}else if($chapterSelect[0].value=='all'){$unitList.append('<select class="form-control unit no"><option value="all">All Section</option></select>');}else{$unitList.append('<select class="form-control unit no"><option value="no" class="type">No Section</option></select>');}}
if($(this).hasClass('chapter')){var $typeList=$('#typeList');var typeId=$typeList.find('option[value="'+$typeList[0].value+'"]')[0].id;var $chapterSelect=$('#chapter_'+typeId);var chapterId=$chapterSelect.find('option[value="'+this.value+'"]').attr('id');$unitList.children().hide();if(chapterId){var $unitSelect=$('#unit_'+typeId+'_'+chapterId);$unitSelect.show();}else if($chapterSelect[0].value=='all'){$unitList.append('<select class="form-control unit no"><option value="all">All Section</option></select>');}else{$unitList.append('<select class="form-control unit no"><option value="no">No Section</option></select>');}}});$dialogModal.off('shown.bs.modal').on('shown.bs.modal',function(){});$dialogModal.off('hidden.bs.modal').on('hidden.bs.modal',function(){$dialogContent.empty();});$confirm.off('click').on('click',function(){var chapterVal=$chapterList.find('select:not(:hidden)')[0].value;var unitVal=$unitList.find('select:not(:hidden)')[0].value;var menuId=$typeList[0].value;!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.menuId=menuId=='no'?'':menuId;_this.entity.modal.option.chapter=chapterVal=='no'||chapterVal=='all'?'':chapterVal;_this.entity.modal.option.unit=unitVal=='no'||unitVal=='all'?'':unitVal;$dialogModal.modal('hide');if(_this.entity.modal.option.menuId&&_this.entity.modal.option.menuId!=''){_this.screen.isScreenChange=true;}});}).fail(function(){}).always(function(){Spinner.stop();});};return ModalReportChapter;}();var ModalInteractConfig=function($,window,undefined){var _this;function ModalInteractConfig(options){_this=this;ModalConfig.call(_this,options);}
ModalInteractConfig.prototype=Object.create(ModalConfig.prototype);ModalInteractConfig.prototype.constructor=ModalInteractConfig;ModalInteractConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalInteract.html'};ModalInteractConfig.prototype.init=function(){this.$contain=$('#modalInteract',this.$wrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$divCfgData=$('.divConfigData',this.$wrap);this.$divDataGrid=$('#divDataGrid',this.$wrap);this.$divDataTip=$('.dataDragTip',this.$wrap);I18n.fillArea(this.$contain);this.attachEvents();};ModalInteractConfig.prototype.recoverForm=function(modal){var item=_this.$divDataGrid.children('.item');if(item.length>0){item.remove();}
if(modal.points){var dictPtStat=modal.option.dictPtStatus;if(dictPtStat){var num=1;for(var id in dictPtStat){this.insertItem(id,dictPtStat[id].unit,num,dictPtStat[id].name,dictPtStat[id].projName);num++;}}}};ModalInteractConfig.prototype.reset=function(){};ModalInteractConfig.prototype.attachEvents=function(){this.$divCfgData.on('dragover',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');});this.$divCfgData.on('dragleave',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');});this.$divCfgData.on('drop',function(e,arg){$('.addData').removeClass('addData');var dragItemId=EventAdapter.getData().dsItemId;if(!dragItemId){return;}
var item=_this.$divDataGrid.find('.divDsGridItem');var len=item.length;if(Object.prototype.toString.call(dragItemId)==='[object Array]'){var lens=dragItemId.length;for(var j=0;j<lens;j++){var isExist=false;for(var i=0;i<len;i++){if(dragItemId[j]==item.eq(i).attr('dsid')){dragItemId.splice(j,1);lens=lens-1;j=j-1;isExist=true;continue;}}
if(!isExist){dotAdd(dragItemId[j],'array');}}
if(lens<1){return;}}else{var bFind=false;for(var i=0;i<len;i++){if(dragItemId==item.eq(i).attr('dsid')){bFind=true;break;}}
if(bFind){return;}
dotAdd(dragItemId);}
function dotAdd(dragItemId,isArray){if(len>=20){return;}
if(dragItemId){var item=AppConfig.datasource.getDSItemById(dragItemId);if(item&&item.alias){var parent=_this.options.modalIns;var prjName;if(parent){var temp=parent.getProjectNameFromId(item.projId,parent.m_langFlag);if(0==parent.m_langFlag){prjName='项目名：'+temp;}else{prjName='Project Name:'+temp;}}
_this.insertItem(dragItemId,'',len+1,item.alias,prjName);len=_this.$divDataGrid.find('.divDsGridItem').length;}}}});this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;modal.points=[];if(!modal.option){modal.option={};modal.option.dictPtStatus={};}
if(modal.option){modal.option.dictPtStatus={};}
var arrGrid=_this.$divDataGrid.find('.grow');for(var i=0,len=arrGrid.length;i<len;i++){var item=arrGrid.eq(i);var id=item.attr('dsid');var name=item.find('input').val();var proName=item.find('.contentDS').attr('title');modal.points.push(id);modal.option.dictPtStatus[id]={show:0==i?true:false,count:i,unit:'',name:name,projName:proName};}
if(!modal.option.timeMode){var tmEnd=new Date();tmEnd.setHours(23);tmEnd.setMinutes(59);var tmStart=new Date();tmStart.setTime(tmEnd.getTime()-172800000);tmStart.setHours(0);tmStart.setMinutes(0);modal.option.timeMode='recent';modal.option.interval='h1';modal.option.timeStart=tmStart.format('yyyy-MM-dd HH:mm:00');modal.option.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:00');modal.option.periodVal=3;modal.option.periodUnit='day';modal.interval=3;}
_this.$modal.modal('hide');e.preventDefault();});};ModalInteractConfig.prototype.insertItem=function(id,unit,num,name,projName){if(name==undefined){name=AppConfig.datasource.getDSItemById(id).alias;}
if(!projName){projName='';}
var $item=$('<div class="col-lg-3 col-xs-4 divDsGrid item">\
            <span class="divDsGridNum">'+num+'</span>\
            <span class="divDsGridItem grow" dsid="'+id+'">\
                <span class="contentDS" title="'+projName+'">'+name+'</span>\
                <input type="text" value="'+name+'" style="display:none">\
                <span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true"></span>\
            </span></div>');$item.click(function(e){var $tar=$(e.currentTarget);var $name=$tar.find('.contentDS');var $input=$tar.find('input');$name.hide();$input.show();$input.focus();$input.select();$input.keyup(function(e){if(13==e.keyCode){var newVal=$input.val();$name.text(newVal);$input.blur();}});$input.blur(function(e){$input.val($name.text());$name.show();$input.hide();});});_this.$divDataTip.before($item);_this.$divDataGrid.find('.btnRemoveDS').last().click(function(e){var $dsGrid=$(e.currentTarget).closest('.divDsGrid');if($dsGrid){$dsGrid.remove();}
var gridNum=_this.$divDataGrid.find('.divDsGridNum');if(gridNum){for(var i=0;i<gridNum.length;i++){gridNum.eq(i).text(i+1);}}});_this.$divDataGrid.find('.contentDS').last().dblclick(function(e){var $spanTar=$(e.currentTarget);var name=$spanTar.text();var $inputName=$spanTar.next('input');$inputName.keydown(function(e){if(13==e.keyCode){var $inputTar=$(e.currentTarget);var newName=$inputTar.val();$inputTar.hide();$spanTar.text(newName);$spanTar.show();}});$inputName.blur(function(e){var $inputTar=$(e.currentTarget);var newName=$inputTar.val();$inputTar.hide();$spanTar.text(newName);$spanTar.show();});$spanTar.hide();$inputName.show();$inputName.focus();$inputName.select();});};ModalInteractConfig.prototype.destroy=function(){this.detachEvents();this.$wrap.remove();};return ModalInteractConfig;}(jQuery,window);var ModalInteract=function(){var _this;var g_dictChart={};function ModalInteract(screen,entityParams){_this=this;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.modalId=entityParams.id;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag='zh'==localStorage['language']?0:1;this.m_lang=I18n.resource.dataSource;this.screen=screen;this.init();this.arrColor=echarts.config.color;this.timeFlag=undefined;this.arrModal=screen.store.layout[0];g_dictChart[this.modalId]={chart:this.chart,contain:this.container};this.spinner.spin(this.container);};ModalInteract.prototype=new ModalBase();ModalInteract.prototype.optionTemplate={name:'toolBox.modal.INTERACT_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:3,minWidth:9,maxHeight:12,maxWidth:12,type:'ModalInteract'};ModalInteract.prototype.defaultOptions={title:{text:''},tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},dataZoom:{show:true},yAxis:[{type:'value',axisLabel:{textStyle:{color:'#777'}},splitLine:{show:true,lineStyle:{color:'#777',width:1,type:'dashed'}}}],animation:false,grid:[{bottom:70}]};ModalInteract.prototype.init=function(){var containWidth=$(this.container).width();var containHeight=$(this.container).height();var $divLeftPart=$('<div style="display:inline-block;height:100%"></div>');$divLeftPart.css('width',containWidth-220+'px');var $divChartCtrl=$('<div id="chartShow"></div>');$divChartCtrl.css('height',containHeight-10+'px');$divLeftPart.append($divChartCtrl);var $divDataCtrl=$('<div id="dataList" style="display:inline-block;position:absolute;top:10px;right:0;width:220px;height:100%;overflow-y:auto"><div class="form-group"></div></div>');if(this.modal.points&&this.modal.option.dictPtStatus){var arrId=[];for(var id in this.modal.option.dictPtStatus){arrId.push(id);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var id in this.modal.option.dictPtStatus){for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var name=this.modal.option.dictPtStatus[id].name;var unit=this.modal.option.dictPtStatus[id].unit;this.insertInteractData($divDataCtrl,id,name,unit);var target=$divDataCtrl.find('.form-inline').last();if(0==arrItem[m].type){}else if(1==arrItem[m].type){var showFormula=AppConfig.datasource.getShowNameFromFormula(arrItem[m].value);this.setFormulaToolTips(target,name,showFormula,arrItem[m].note);}
break;}}}}
$(this.container).empty();$(this.container).append($divLeftPart);$(this.container).append($divDataCtrl);};ModalInteract.prototype.renderModal=function(e){this.drawCharts();this.spinner.stop();};ModalInteract.prototype.updateModal=function(e){var dsId=e[0].dsItemId;var modeName;for(var i=0;i<_this.arrModal.length;i++){var arrPt=_this.arrModal[i].modal.points;for(var j=0;j<arrPt.length;j++){if(dsId==arrPt[j]){modeName=_this.arrModal[i].modal.option.timeMode;break;}}
if(modeName){break;}}
if('recent'==modeName){var newOption=_this.chart.getOption();var newSeries=newOption.series;var arrId=[];for(var i=0,len=e.length;i<len;i++){arrId.push(e[i].dsItemId);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=e.length;i<len;i++){var id=e[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var name=arrItem[m].alias;var bFind=false;var j=0;for(var len2=newSeries.length;j<len2;j++){if(name==newSeries[j].name){bFind=true;break;}}
if(bFind){var flag=false;for(var k=0;k<newSeries[j].data.length;k++){if(undefined==newSeries[j].data[k]){newSeries[j].data[k]=e[i].data;flag=true;break;}}
if(!flag){newSeries[j].data.push(e[i].data);}}
break;}}}
_this.chart.setOption(newOption);_this.chart.refresh();}
var spanReal=$('#dataList').find('.frontCtrl');if(spanReal){for(var j=0,len2=e.length;j<len2;j++){var id=e[j].dsItemId;for(var k=0,len3=spanReal.length;k<len3;k++){if(id==spanReal.eq(k).attr('pId')){spanReal.eq(k).find('.interactRealVal').text(e[j].data);break;}}}}};ModalInteract.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalInteract.prototype._showConfig=function(){};ModalInteract.prototype.setModalOption=function(option){};ModalInteract.prototype.drawCharts=function(parmOption,parmChart,parmContain){if(!parmOption){parmOption=_this.modal.option;}
if(!parmChart){parmChart=_this.chart;}
if(!parmContain){parmContain=_this.container;}
if(parmOption){var arrPoints=[];for(var itemId in parmOption.dictPtStatus){if(parmOption.dictPtStatus[itemId].show){arrPoints.push(itemId);}}
if(0==arrPoints.length){parmChart.clear();_this.setDataListColor();return;}
if('recent'==parmOption.timeMode){var tmEnd=new Date();tmEnd.setHours(23);tmEnd.setMinutes(59);var tmTemp=tmEnd.getTime()-86400000*(parmOption.periodVal-1);var tmStart=new Date();tmStart.setTime(tmTemp);tmStart.setHours(0);tmStart.setMinutes(0);parmOption.timeStart=tmStart.format('yyyy-MM-dd HH:mm:00');parmOption.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:00');}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:arrPoints,timeStart:new Date(parmOption.timeStart).format('yyyy-MM-dd HH:mm:00'),timeEnd:new Date(parmOption.timeEnd).format('yyyy-MM-dd HH:mm:00'),timeFormat:parmOption.interval}).done(function(result){if(result.timeShaft.length<=0){parmChart=echarts.init($(parmContain,AppConfig.chartTheme).find('#chartShow')[0]).clear();return;}
var arrName=[];var series=[];var arrId=[];var arrItem=[];for(var i=0,len=result.list.length;i<len;i++){arrId.push(result.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);var cntNow=new Date().getTime();var dictLastData={};for(var i=0,len=result.list.length;i<len;i++){var id=result.list[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var showData=[];var lastData;var flag=false;if('recent'==parmOption.timeMode){var n=0;for(;n<result.timeShaft.length;n++){if(Date.parse(result.timeShaft[n])>cntNow){if(!flag){lastData=result.list[i].data[n];flag=true;}
showData.push(undefined);}else{showData.push(result.list[i].data[n]);}}
dictLastData[id]=lastData;}else{showData=result.list[i].data;}
var name=arrItem[m].alias;arrName.push(name);var count=parmOption.dictPtStatus[id].count;var color=_this.arrColor[count];series.push({name:name,type:'line',data:showData,itemStyle:{normal:{color:color}}});break;}}}
var options={legend:{show:false,data:arrName},xAxis:[{type:'category',boundaryGap:false,data:result.timeShaft,axisLabel:{textStyle:{color:'#777'}},splitLine:{show:true,lineStyle:{color:'#777',width:1,type:'dashed'}}}],series:series};var drawOptions={};jQuery.extend(drawOptions,ModalInteract.prototype.defaultOptions,options);parmChart=echarts.init($(parmContain).find('#chartShow')[0],AppConfig.chartTheme);parmChart.setOption(drawOptions);_this.chart=parmChart;_this.setDataListColor(parmContain);if('recent'==parmOption.timeMode){var spanReal=$(parmContain).find('.frontCtrl');if(spanReal){for(var p=0;p<spanReal.length;p++){var $item=spanReal.eq(p);var id=$item.attr('pid');$item.find('.interactRealVal').text(dictLastData[id]);}}}else{var spanReal=$(parmContain).find('.frontCtrl');if(spanReal){for(var p=0;p<spanReal.length;p++){var $item=spanReal.eq(p);var id=$item.attr('pid');$item.find('.interactRealVal').text('');}}}});}};ModalInteract.prototype.drawChartsEx=function(parmOption,modalId){_this.drawCharts(parmOption,g_dictChart[modalId].chart,g_dictChart[modalId].contain);};ModalInteract.prototype.insertInteractData=function($divDst,ptId,ptName,ptUnit){$divDst.append('\
            <form class="form-inline">\
                <span class="form-control frontCtrl interactDsFrame" pId="'+ptId+'" style="cursor:pointer;width:200px;border-radius: 0em 0em 0em 0em;margin-right: -4px;border-width: 0;color: #ccc;border-bottom:1px solid #465b85;">\
                    <span class="interactSpanDsName" style="display:inline-block;width:100px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;vertical-align: bottom;">'+ptName+'</span>\
                    <span class="interactRealVal" style="display:inline-block;width:70px;overflow: hidden;text-overflow:ellipsis;white-space:nowrap;vertical-align:bottom;"></span>\
                </span>\
            </form>\
        ');var $front=$divDst.find('.frontCtrl');$front.off().click(function(e){if(_this.modal.option&&_this.modal.option.dictPtStatus){var $tar=$(e.currentTarget);var id=$tar.attr('pId');var $contain=$tar.closest('.springContainer');var modalId;if($contain){var temp=$contain.attr('id');modalId=temp.split('_')[1];for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(modalId==item.id){item.modal.option.dictPtStatus[id].show=!item.modal.option.dictPtStatus[id].show;break;}}}
_this.screen.saveLayoutOnly();_this.drawCharts(item.modal.option,g_dictChart[modalId].chart,g_dictChart[modalId].contain);}});};ModalInteract.prototype.initInteractTime=function($divDst){$divDst.append('\
            <form class="form-inline" style="margin-top: 3px;font-family:Microsoft YaHei;font-size:14px">\
                <div class="form-group" style="width:140px">\
                    <label for="selMode" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_MODE+'</label>\
                    <select class="form-control" id="selMode" style="background-color:#f4f6f8;border:1px solid #465b85;color:#646464;width:inherit">\
                        <option value="fixed">'+I18n.resource.modalConfig.option.MODE_FIXED+'</option>\
                        <option value="recent">'+I18n.resource.modalConfig.option.MODE_RECENT+'</option>\
                    </select>\
                </div>\
                <div class="form-group" style="width:120px">\
                    <label for="selInterval" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                    <select class="form-control" id="selInterval" style="background-color:#f4f6f8;border:1px solid #465b85;color:#646464;width:inherit">\
                        <option value="m1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                        <option value="m5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                        <option value="h1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                        <option value="d1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                        <option value="M1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                    </select>\
                </div>\
                <div class="form-group" id="divTmRange" style="width:380px">\
                    <label for="divRange" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                    <div id="divRange" style="display:inline">\
                        <input class="form-control" type="text" id="tmStart" style="width:165px;cursor:pointer;text-align:center" readonly>\
                        <span class="input-group-addon" style="display: inline;padding-top:6px;padding-bottom:7px;text-align:center;border:1px solid rgb(39, 51, 75);color:#646464;margin-right:-6px;background-color:#f4f6f8;">'+I18n.resource.modalConfig.option.TIP_RANGE_TO+'</span>\
                        <input class="form-control" type="text" id="tmEnd" style="width:165px;cursor:pointer;text-align:center" readonly>\
                    </div>\
                </div>\
                <div class="form-group" id="divTmLast" style="width:340px;display:none">\
                    <label for="divLast" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_PERIOD+'</label>\
                    <div id="divLast">\
                        <input class="form-control" type="text" id="inputPeriodValue" style="width:165px;background-color:#f4f6f8;border:1px solid #27334b;border-radius:0.5em 0 0 0.5em;margin-right:-5px;color:#646464">\
                        <select class="form-control" id="selPeriodUnit" style="width:165px;background-color:#f4f6f8;border:1px solid #27334b;border-radius:0 0.5em 0.5em 0;color:#646464">\
                            <option value="hour">'+I18n.resource.modalConfig.option.PERIOD_UNIT_HOUR+'</option>\
                            <option value="day">'+I18n.resource.modalConfig.option.PERIOD_UNIT_DAY+'</option>\
                            <option value="month">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MON+'</option>\
                        </select>\
                    </div>\
                </div>\
                <button class="btn" type="button" id="btnOk" modalId="'+_this.modalId+'" style="width:70px;vertical-align:bottom;color:#f4f6f8;background-color:#288add;">'+I18n.resource.observer.widgets.YES+'</button>\
            </form>\
        ');var $selMode=$divDst.find('#selMode');var $selInter=$divDst.find('#selInterval');var $divTmRange=$divDst.find('#divTmRange');var $divTmLast=$divDst.find('#divTmLast');$selMode.change(function(e){var $opt=$selInter.children('option');var flag=$(e.currentTarget).val();switch(flag){case'fixed':$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');$divTmRange.css('display','inline-block');$divTmLast.css('display','none');break;case'recent':$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','none');$divTmRange.css('display','none');$divTmLast.css('display','inline-block');break;default:break;}});var tmNow=new Date();var tmStart=new Date();tmStart.setFullYear(tmNow.getFullYear()-10);var $inputStart=$divDst.find('#tmStart');$inputStart.val(tmNow.format('yyyy-MM-dd HH:mm:00'));$inputStart.css('background-color','#f4f6f8');$inputStart.css('border','1px solid #27334b');$inputStart.css('color','#646464');$inputStart.css('border-radius','0.5em 0 0 0.5em');$inputStart.css('margin-right','-5px');$inputStart.datetimepicker({format:'yyyy-mm-dd hh:mm:00',startView:'month',minView:'hour',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){});var $inputEnd=$divDst.find('#tmEnd');$inputEnd.val(tmNow.format('yyyy-MM-dd HH:mm:00'));$inputEnd.css('background-color','#f4f6f8');$inputEnd.css('border','1px solid #27334b');$inputEnd.css('color','#646464');$inputEnd.css('border-radius','0 0.5em 0.5em 0');$inputEnd.datetimepicker({format:'yyyy-mm-dd hh:mm:00',startView:'month',minView:'hour',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){});var $inputPerVal=$divDst.find('#inputPeriodValue');var $selPerUnit=$divDst.find('#selPeriodUnit');var $btnOk=$divDst.find('#btnOk');$btnOk.off().click(function(e){var tmMode=$selMode.val();var strStart,strEnd;if('fixed'==tmMode){strStart=$inputStart.val();strEnd=$inputEnd.val();}else if('recent'==tmMode){var tmStart=new Date();var periodVal=parseInt($inputPerVal.val());if(!periodVal){alert('Please input time !');return;}
var periodUnit=$selPerUnit.val();switch(periodUnit){case'hour':var time=tmNow.getTime()-3600000*periodVal;tmStart.setTime(time);break;case'day':var time=tmNow.getTime()-86400000*periodVal;tmStart.setTime(time);break;case'month':var month=tmNow.getMonth();if(0==month){tmStart.setFullYear(tmNow.getFullYear()-1);tmStart.setMonth(11);}else{tmStart.setMonth(month-1);}
break;default:break;}
strStart=tmStart.format('yyyy-MM-dd HH:mm:00');strEnd=tmNow.format('yyyy-MM-dd HH:mm:00');}else{alert('Please select mode !');return;}
var modalId=$(e.currentTarget).attr('modalId');if(modalId){for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(item){if(modalId==item.id){if(!item.modal.option){item.modal.option={};item.modal.option.dictPtStatus={};}
item.modal.option.timeMode=tmMode;item.modal.option.interval=$selInter.val();item.modal.option.timeStart=strStart;item.modal.option.timeEnd=strEnd;item.modal.option.periodVal=periodVal;item.modal.option.periodUnit=periodUnit;if('recent'==tmMode){item.interval=1000;}else{item.interval=null;}
break;}}}}
_this.screen.saveLayoutOnly();_this.drawCharts(item.modal.option,g_dictChart[modalId].chart,g_dictChart[modalId].contain);});if(_this.modal.option){$selMode.val(_this.modal.option.timeMode);$selInter.val(_this.modal.option.interval);$inputStart.val(_this.modal.option.timeStart);$inputEnd.val(_this.modal.option.timeEnd);$inputPerVal.val(_this.modal.option.periodVal);$selPerUnit.val(_this.modal.option.periodUnit);if('recent'==_this.modal.option.timeMode){$selMode.change();}}};ModalInteract.prototype.setDataListColor=function(contain){var dataListName;if(!contain){dataListName=$('#dataList').find('.frontCtrl');}else{dataListName=$(contain).find('.frontCtrl');}
if(dataListName){for(var j=0,len=dataListName.length;j<len;j++){var $item=dataListName.eq(j);var id=$item.attr('pId');var $contain=$item.closest('.springContainer');var modalId;if($contain){var temp=$contain.attr('id');modalId=temp.split('_')[1];for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(modalId==item.id){var count=item.modal.option.dictPtStatus[id].count;var bShow=item.modal.option.dictPtStatus[id].show;var $spanDsName=$item.find('.interactSpanDsName');if($spanDsName){if(bShow){$spanDsName.css('color',_this.arrColor[count]);}else{$spanDsName.css('color','');}}
break;}}}}}};ModalInteract.prototype.setToolTips=function(target,customName,projectName,pointName,pointDesc){var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px">');show.append('    <div class="tooltipContent interactTipsBackground">');show.append('        <p class="customName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="projectName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.PROJECT_NAME).append('</span>: ').append(projectName).append('</p> ');show.append('        <p class="pointName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_NAME).append('</span>: ').append(pointName).append('</p> ');show.append('        <p class="pointDesc interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(pointDesc).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'left',title:_this.m_lang.PARAM,template:show.toString()};target.tooltip(options);};ModalInteract.prototype.setFormulaToolTips=function(target,customName,formula,desc){var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:400px;">');show.append('    <div class="tooltipContent interactTipsBackground">');show.append('        <p class="customName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="formula interactTipsStyle" style="word-break:normal;"><span class="interactTipsTitleStyle">').append(_this.m_lang.FORMULA_NAME).append('</span>: ').append('</p>');show.append('        <p class="pointDesc interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(desc).append('</p>');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var showFormula=$('<span>'+formula+'</span>');var showObj=$(show.toString());showFormula.appendTo(showObj.find('.formula')).mathquill();var options={placement:'left',title:_this.m_lang.PARAM,template:showObj};target.tooltip(options);};ModalInteract.prototype.getProjectNameFromId=function(id,langFlag){var name;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(id==item.id){if(0==langFlag){name=item.name_cn;}else{name=item.name_en;}
break;}}
return name;};ModalInteract.prototype.configModal=new ModalInteractConfig();return ModalInteract;}();var ModalMobile=function(){function ModalMobile(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalMobile.prototype=new ModalChart();ModalMobile.prototype.optionTemplate={name:'toolBox.modal.MOBILE_CHART',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMobile'};ModalMobile.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:true},grid:function(){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:40,top:40};if(AppConfig.isMobile){grid.x=40;}
return grid;}(),xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:function(){if(AppConfig.isMobile){return false;}else{return true;}}()},axisLabel:{formatter:function formatter(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true};ModalMobile.prototype.renderModal=function(){},ModalMobile.prototype.updateModal=function(options){},ModalMobile.prototype.showConfigMode=function(){},ModalMobile.prototype.goBackTrace=function(data){};return ModalMobile;}();var ModalAppKPICollect=function(){function ModalAppKPICollect(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalAppKPICollect.prototype=new ModalBase();ModalAppKPICollect.prototype.optionTemplate={name:'toolBox.modal.APP_KPI_COLLECT',parent:3,mode:'custom',maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppKPICollect',scroll:false};ModalAppKPICollect.prototype.configModalOptDefault={header:{'title':'配置','needBtnClose':true},area:[{'module':'multiDataConfig','data':{'variable':[],'param':[{'type':'name','name':'数据标题'},{'type':'data','name':'数据点位'},{'type':'unit','name':'数据单位'},{'type':'scale','name':'小数点位'}]}}],result:{}};ModalAppKPICollect.prototype.renderModal=function(){this.spinner.stop();var _this=this;var divAppKPi=document.createElement('div');var divKpiList=document.createElement('div');divAppKPi.className='appKpi';divKpiList.className='divKPIList';this.container.appendChild(divAppKPi);divAppKPi.appendChild(divKpiList);divKpiList.innerHTML='';var optTitle=_this.entity.modal.option.title;if(optTitle){if(optTitle.text||optTitle.data){divKpiList.innerHTML='\
				<div class="divSingleType divListTitle">\
	                <div class="divTypeTitle ">'+_this.entity.modal.option.title.text+'</div>\
	                <div class="divKPIListRight">\
						<div class="divTypeVal divKPINow" data-pt="'+_this.entity.modal.option.title.data+'" data-scale="'+_this.entity.modal.option.title.scale+'"></div>\
	               		<div class="divTypeUnit divKPIUnit">'+(_this.entity.modal.option.title.unit?_this.entity.modal.option.title.unit:'')+'</div>\
	                </div>\
	            </div>';}}
for(var i=0;i<_this.entity.modal.option.param.length;i++){divKpiList.innerHTML+='\
	        	<div class="divSingleType">\
	                <div class="divTypeTitle ">'+_this.entity.modal.option.param[i].name+'</div>\
	                <div class="divKPIListRight">\
						<div class="divTypeVal" data-scale="'+_this.entity.modal.option.param[i].scale+'" data-pt="'+_this.entity.modal.option.param[i].data+'"></div>\
	               		<div class="divTypeUnit ">'+_this.entity.modal.option.param[i].unit+'</div>\
	                </div>\
	            </div>\
			';}
this.container.appendChild(divAppKPi);};ModalAppKPICollect.prototype.updateModal=function(points){var data;for(var i=0;i<points.length;i++){var dom=this.container.querySelector('[data-pt="'+points[i].dsItemId+'"]');if(dom){if(!isNaN(Number(points[i].data))){if(dom.dataset.scale&&!isNaN(parseInt(dom.dataset.scale))){if(parseInt(dom.dataset.scale)>10){data=parseFloat(points[i].data).toFixed(10);}else{data=parseFloat(points[i].data).toFixed(parseInt(dom.dataset.scale));}}else{data=parseFloat(points[i].data).toFixed(2);}}else{data=points[i].data;}
dom.innerText=data;}}};ModalAppKPICollect.prototype.showConfigMode=function(){};ModalAppKPICollect.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option)this.configModalOpt.area[0].data.variable=[this.entity.modal.option];this.configModalOpt.result.func=function(option){_this.setModalOption(option);};};ModalAppKPICollect.prototype.setModalOption=function(option){this.entity.modal.points=[];this.entity.modal.option={};for(var i=0;i<option.dataInfoList.length;i++){option.dataInfoList[i].title.data&&this.entity.modal.points.push(option.dataInfoList[i].title.data);this.entity.modal.option=option.dataInfoList[i];for(var j=0;j<option.dataInfoList[i].param.length;j++){if(option.dataInfoList[i].param[j].data)this.entity.modal.points.push(option.dataInfoList[i].param[j].data);}}
this.entity.modal.interval=5;};ModalAppKPICollect.prototype.goBackTrace=function(data){};return ModalAppKPICollect;}();var ModalDataMonitorList=function(){function ModalDataMonitorList(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalDataMonitorList.prototype=new ModalBase();ModalDataMonitorList.prototype.optionTemplate={name:'toolBox.modal.DATA_MONITOR_LIST',parent:0,mode:['dataMonitorList'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDataMonitorList',scroll:false};ModalDataMonitorList.prototype.configModalOpt={};ModalDataMonitorList.prototype.initLeftMonitorList=function(monitorList,data){var _this=this;var _value;var listLeft=document.createElement('div');listLeft.className='monitorListLeft gray-scrollbar';var listLeftContentGroup=document.createElement('div');listLeftContentGroup.className='listLeftContentGroup';for(var i=0;i<monitorList.content.length;i++){var item=monitorList.content[i];var listLeftContent=document.createElement('div');listLeftContent.className='panel panel-default';var listLeftTitle=document.createElement('div');listLeftTitle.className='listLeftTitle';var listLeftContentList=document.createElement('div');listLeftContentList.className='listLeftContentList';listLeftTitle.innerHTML+='\
                    <div class="panel-title">\
                        <table class="table table-hover">\
                            <tbody>\
                                <tr class="kpi-tr-index show-detail">\
                                    <td>'+item.system+'</td>\
                                </tr>\
                            </tbody>\
                        </table>\
                    </div>\
                    ';listLeftContentList.innerHTML='\
                <table>\
                    <tbody>\
                        <tr>\
                            <td>参数</td>\
                            <td>当前值</td>\
                            <td>选择</td>\
                        </tr>\
                    </tbody>\
                </table>\
                ';listLeftContent.appendChild(listLeftTitle);for(var j=0;j<item.parameter.length;j++){for(var m=0;m<data.length;m++){if(item.parameter[j].point!=data[m].name){continue;}else{_value=data[m].value;}};listLeftContentList.innerHTML+='\
                    <div id="para-collapse" class="">\
                        <div class="bodyPn borderColorTemp4">\
                            <table class="table table-hover">\
                                <tbody>\
                                    <tr class="kpi-tr-index show-detail">\
                                        <td>'+item.parameter[j].legend+'</td>\
                                        <td>'+Number(_value).toFixed(1)+'</td>\
                                        <td>\
                                            <form>\
                                                <input type="checkbox" id="selectedCheckbox" value="'+item.parameter[i].point+'" name="'+item.parameter[j].legend+'">\
                                            </form>\
                                       </td>\
                                    </tr>\
                                </tbody>\
                            </table>\
                        </div>\
                    </div>\
                ';listLeftContent.appendChild(listLeftContentList);};listLeftContentGroup.appendChild(listLeftContent);};listLeft.appendChild(listLeftContentGroup);this.container.appendChild(listLeft);this.attachEvent();if($._data($('#selectedCheckbox')[0],"events")&&$._data($('.table tr'),"events")){$('.monitorListLeft').css("width","24%");}else{$('.monitorListLeft').css("width","100%");}};ModalDataMonitorList.prototype.renderModal=function(){this.spinner.stop();var _this=this;var _pId=393;var postData=this.entity.modal.points;WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:postData}).done(function(result){if($(_this.container).find(".alertErrorInfo")){$(_this.container).find(".alertErrorInfo").remove();}
if(!(result.dsItemList[0]&&result.dsItemList[0].data))return;if(result.dsItemList[0].data.indexOf('content')!==-1){var monitorList=JSON.parse(result.dsItemList[0].data);var pArr=[];for(var i=0;i<monitorList.content.length;i++){var arr=monitorList.content[i].parameter;for(var j=0;j<arr.length;j++){pArr.push(arr[j].point);}}
var opt1={pointList:pArr,proj:_pId};console.log(opt1);WebAPI.post('/get_realtimedata',opt1).done(function(data){console.log(data);_this.initLeftMonitorList(monitorList,data);});}else{var alertErrorInfo=document.createElement('div');alertErrorInfo.className='alertErrorInfo';alertErrorInfo.innerHTML='所拖入数据点的格式不符合该控件所需的数据格式,数据点格式参考上海来福士的Proj_ParaQueyInfo';_this.container.appendChild(alertErrorInfo);}});};ModalDataMonitorList.prototype.updateModal=function(points){var _this=this;};ModalDataMonitorList.prototype.attachEvent=function(){$('.listLeftTitle').on('click',function(e){var index=$(".listLeftTitle").index($(this));$('.listLeftContentList').eq(index).toggle('slow');});};ModalDataMonitorList.prototype.showConfigMode=function(){};ModalDataMonitorList.prototype.initConfigModalOpt=function(){};ModalDataMonitorList.prototype.setModalOption=function(option){};return ModalDataMonitorList;}();var ModalDiagnosisPanel=function(){var _this=undefined;function ModalDiagnosisPanel(dom){this.ElScreenContainer=window.ElScreenContainer||$('body')[0];this.parent=dom||this.ElScreenContainer;this.dictZone=undefined;this.dictEquipment=undefined;this.dictObserverText=undefined;this.arrLastNotice=[];this.workerUpdate=undefined;this.tabelModelData=undefined;this.tableModelUpdate=undefined;this.floorCount=0;this.dialog=undefined;this.langCfg=I18n.resource.diagnosis.config;this.noticeId=0;this.faId=0;this.faUserId=0;this.obScreen=undefined;this.$obContainer=undefined;this.urgentCount=0;this.criticalCount=0;_this=this;}
ModalDiagnosisPanel.prototype={show:function show(){Spinner.spin(this.ElScreenContainer);WebAPI.get("/static/views/observer/widgets/modalDiagnosisPanel.html").done(function(resultHtml){$(_this.parent).html(resultHtml);I18n.fillArea($(_this.parent));_this.init();}).always(function(){Spinner.stop();});},optionTemplate:{name:'toolBox.modal.DIAGNOSIS_PANEL',parent:0,mode:[''],maxNum:1,title:'',minHeight:2,minWidth:4,maxHeight:6,maxWidth:12,type:'ModalDiagnosisPanel'},initStructData:function initStructData(data){var item,arr;this.dictZone=new Object();this.dictEquipment=new Object();this.buildings=[];arr=data.equipments;for(var i=0,len=arr.length;i<len;i++){item=arr[i];item.faultIds=new Array();this.dictEquipment[item.id]=item;}
arr=data.zones;this.floorCount=arr.length;var index=-1,tempBuildingId=undefined;for(var i=0,len=arr.length;i<len;i++){item=arr[i];var equipments=[];for(var j=0;j<data.equipments.length;j++){if(data.equipments[j].zoneId==item.id){equipments.push({equipmentId:data.equipments[j].id,equipmentName:data.equipments[j].name});}}
this.dictZone[item.id]=item;if(tempBuildingId!=item.buildingId){tempBuildingId=item.buildingId;index++;var building={buildId:item.buildingId,buildName:item.buildingName,subBuilds:[{subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}]};this.buildings.push(building);}else{var subBuilding={subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments};this.buildings[index].subBuilds.push(subBuilding);}}},close:function close(){this.dictZone=null;this.dictEquipment=null;this.dictObserverText=null;this.tabelModelData=null;this.arrLastNotice=null;this.floorCount=null;if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;if(this.tableModelUpdate)this.tableModelUpdate.terminate();this.tableModelUpdate=null;if(this.dialog)this.dialog.close();if(this.obScreen)this.obScreen.close();if(ToolCurrent)ToolCurrent.close();},onresize:function onresize(){ScreenCurrent.obScreen.resize();},init:function init(){this.$obContainer=$('#obContainer');this.dictObserverText={};WebAPI.get('/diagnosis/getStruct/'+AppConfig.projectId).done(function(result){_this.initStructData(result);_this.initPaneNav();$('.subBuildingBtn','#paneIcon').eq(0).trigger('click');$('.div-nav-row','#paneIcon').eq(0).children('span:first').trigger('click');});function tabelModelClose(){$('#panelIconNew').hide();if(_this.tableModelUpdate)_this.tableModelUpdate.terminate();_this.tableModelUpdate=null;}
$("#btnNoticeHistory").off().click(function(e){ScreenModal=new DiagnosisLogHistory(_this);ScreenModal.setIsModal(true);ScreenModal.show();});var $flootCt=$('#floorCt');var $floorPB=$flootCt.find('.showCont');var $floorPH=$flootCt.find('.panel-default');$flootCt.find('.panel-heading').off('click').click(function(){$floorPH.hide();$floorPB.show();});$floorPB.off('click').click(function(){$(this).hide();$floorPH.show();});},initWorkerForUpdating:function initWorkerForUpdating(){if(this.workerUpdate){this.workerUpdate.terminate();}
this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e);},true);this.workerUpdate.postMessage({projectId:AppConfig.projectId,type:"allDiagnosisScreen"});},initObScreen:function initObScreen(){this.obScreen.isInDiagnosis=true;this.obScreen.diagScreen=this;},resetFloor:function resetFloor(){this.refreshData({data:{notice:this.arrLastNotice}},true);},clearNullArr:function clearNullArr(arr){for(var i=0,len=arr.length;i<len;i++){if(arr[i]==""||typeof arr[i]=="undefined"){arr.splice(i,1);len--;i--;}}
return arr;},gradientColors:function gradientColors(colorArr,$gradientDom,valueCurrent,max,min){var valueMark=(max-min)/(colorArr.length-1);var regexp=/[0-9]{0,3}/g;for(var i=0;i<colorArr.length-1;i++){var colorMaxValue=min+(i+1)*valueMark;if(valueCurrent>colorMaxValue)continue;var colorSelPre=colorArr[i];var colorSelTo=colorArr[i+1];var colorValPreArr=[];colorValPreArr=colorSelPre.match(regexp);_this.clearNullArr(colorValPreArr);var colorValToArr=[];colorValToArr=colorSelTo.match(regexp);_this.clearNullArr(colorValToArr);var colorMinValue=min+i*valueMark;if(i==colorArr.length-2){colorMaxValue=max;}
if(valueCurrent<=colorMaxValue){$gradientDom.css('background','rgb('+(parseInt((parseInt(colorValToArr[0]-colorValPreArr[0])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[0]))+','+(parseInt((parseInt(colorValToArr[1]-colorValPreArr[1])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[1]))+','+(parseInt((parseInt(colorValToArr[2]-colorValPreArr[2])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[2]))+')');i=colorArr.length-1;}}},refreshData:function refreshData(e,isOnlyRenderDictFault){if(!e.data||$.isEmptyObject(e.data)||e.data.error){Spinner.stop();}
_this=this.self?this.self:this;if(e.data.notice&&e.data.notice[0]){_this.arrLastNotice=e.data.notice;var existedIds=[];for(var i in _this.arrLastNotice){existedIds.push(_this.arrLastNotice[i].id);}
if($.inArray(e.data.notice[0].id,existedIds)<0){Array.prototype.push.apply(e.data.notice,_this.arrLastNotice);_this.arrLastNotice=e.data.notice;}
for(var key in _this.dictEquipment){_this.dictEquipment[key].faultIds=new Array();}
try{var dictFaultHighestGrade={};for(var i=0;i<e.data.notice.length;i++){var faultId=e.data.notice[i].faultId,equipmentId=e.data.notice[i].equipmentId;var grade;var eq=_this.dictEquipment[equipmentId];eq.faultIds.push(faultId);grade=dictFaultHighestGrade[eq.modalTextId];if(!grade||e.data.notice[i].grade>grade)dictFaultHighestGrade[eq.modalTextId]=e.data.notice[i].grade;}
for(var key in dictFaultHighestGrade){if(_this.dictObserverText[key])_this.dictObserverText[key].updateDiagnosisGrade(dictFaultHighestGrade[key]);}}catch(e){console.log(e);}
$('#spinnerLoadingNotice').remove();$('#btnWarningLog').fadeIn();$('#navigation').fadeIn();$('#diagnosisLogCt').slideDown();}else{$('#spinnerLoadingNotice').remove();}
Spinner.stop();if(isOnlyRenderDictFault)return;$('.badge.warningCount','#paneIcon').empty();$('.badge.alertCount','#paneIcon').empty();if(e.data.count&&e.data.count instanceof Array){e.data.count.forEach(function(obj){for(var i in obj){var warningCount=parseInt(obj[i].warning);var alertCount=parseInt(obj[i].alert);var $targetWarning=$('#navFloor-'+i).next('.warningCount');var $targetAlert=$('#navFloor-'+i).siblings('.alertCount');if(warningCount>0){$targetWarning.html(warningCount);}else{$targetWarning.html('');}
if(alertCount>0){$targetAlert.html(alertCount);}else{$targetAlert.html('');}}});}
_this.statisticFaultCount();_this.renderPaneNoticeGroup();},initPaneNav:function initPaneNav(){var pane=document.createElement('div');var div,zoneItem,itemI,itemJ;var zoneItemList=[];var $buildingBox,$subBuilding=$('.subBuilding'),$subBuildingList,countHtml;var $dropdownBtn=$('#dropdownBtn');for(var zoneId in this.dictZone){zoneItem=this.dictZone[zoneId];zoneItemList.push(zoneItem);}
var paneIcon=document.getElementById('paneIcon');paneIcon.innerHTML="";paneIcon.appendChild(pane);for(var i=0;i<zoneItemList.length;i++){countHtml='';var isSameBuild=false;itemI=zoneItemList[i];for(var j=0;j<zoneItemList.length;j++){itemJ=zoneItemList[j];if(itemI.buildingId==itemJ.buildingId){isSameBuild=true;break;}}
if(isSameBuild){$buildingBox=$('.div-nav-box'+itemI.buildingId);if($buildingBox.length===0){$buildingBox=$('<div class="div-nav-box'+itemI.buildingId+'"><span id="building_'+itemI.buildingId+'" class="grow subBuildingBtn"></span><span class="badge warningCount"></span><span class="badge alertCount"></span></div>');$buildingBox.find('#building_'+itemI.buildingId).html(itemI.buildingName);$subBuildingList=$('<div class="subBuildingList" id="subList_'+itemI.buildingId+'"></div>');$buildingBox.append($subBuildingList);$(pane).append($buildingBox);}
if(itemI.count&&itemI.count>0){countHtml='<span class="badge warningCount">'+itemI.count+'</span><span class="badge alertCount"></span>';}else{countHtml='<span class="badge warningCount"></span><span class="badge alertCount"></span>';}
var $subBuildings=$('#subList_'+itemI.buildingId).children('.subBuilding');var countArry=[];for(var k=0;k<$subBuildings.length;k++){countArry.push(parseInt($subBuildings.eq(k).attr('count')));}
if(countArry.length===0||itemI.count>countArry[countArry.length-1]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$('#subList_'+itemI.buildingId).append($subBuilding);}else{for(var q=0;q<countArry.length;q++){if(itemI.count<countArry[q]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$($subBuildings[q]).before($subBuilding);break;}else if(itemI.count===countArry[q]){if(countArry[q]===countArry[countArry.length-1]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$('#subList_'+itemI.buildingId).append($subBuilding);break;}else{for(var p=q;p<countArry.length;p++){if(itemI.count<countArry[p]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$($subBuildings[p]).before($subBuilding);break;}}
break;}}}}
$dropdownBtn.off('click').on('click',function(){$(this).siblings('.dropdownList').toggleClass('hidden');});$subBuilding.find('.subBuildingItem').off('click').click(function(){var $this=$(this);var id=$this.attr('pageId');AppConfig.zoneId=this.id.split('-')[1];$('.subBuildingItem.selected').removeClass('selected');$this.addClass('selected');$dropdownBtn.html($this.text()+'<span class="caret"></span>');_this.arrLastNotice.length=0;_this.initWorkerForUpdating();$this.closest('.dropdownList').addClass('hidden');});}}
this.statisticFaultCount();$('.subBuildingBtn').off('click').click(function(){$(this).toggleClass('selected');var $subBuildListCur=$(this).siblings('.subBuildingList');if($subBuildListCur.is(':visible')){$subBuildListCur.hide();}else{$subBuildListCur.show();}});},statisticFaultCount:function statisticFaultCount(){$('[class ^="div-nav-box"]').each(function(){var warningCount=0,alertCount=0;$(this).children('.subBuildingList').find('.warningCount').not(':empty').each(function(){var text=$(this).text();if(Number(text).toString()!='NaN'){warningCount+=parseInt(text);}});if(warningCount>0){$(this).children('.warningCount').html(warningCount);}else{$(this).children('.warningCount').html('');}
$(this).children('.subBuildingList').find('.alertCount').not(':empty').each(function(){var text=$(this).text();if(Number(text).toString()!='NaN'){alertCount+=parseInt(text);}});if(alertCount>0){$(this).children('.alertCount').html(alertCount);}else{$(this).children('.alertCount').html('');}});},renderPaneNoticeGroup:function renderPaneNoticeGroup(){var _this=this;var urgentCount=0,criticalCount=0,className;this.insertLogGroup();var item,parent;for(var i=0,len=_this.arrLastNotice.length;i<len;i++){item=_this.arrLastNotice[i];var grade=item.grade;if(1==grade){className='adNormal';criticalCount++;}else if(2==grade){className='faultPro';urgentCount++;}else{continue;}
_this.insertLogItem(item,i,className);}
_this.criticalCount=_this.arrLastNotice.length;if(_this.criticalCount>0){$('#btnWarningLog').find('.badge').html(_this.criticalCount);}else{$('#btnWarningLog').find('.badge').html('');}
var $btnErr=$('#abNomalP');if($btnErr&&$btnErr.length>0){$btnErr.change();}},insertLogGroup:function insertLogGroup(){var $abNomalP=$('#abNomalP');var $faultP=$('#faultP');var $divPaneNoticeItem=$('#divPaneNoticeItem');$divPaneNoticeItem.children().remove();$abNomalP.on('change',function(){var $adNormalOne=$divPaneNoticeItem.find('.adNormal');var $faultProOne=$divPaneNoticeItem.find('.faultPro');if($abNomalP.is(':checked')&&$faultP.is(':checked')||!$abNomalP.is(':checked')&&!$faultP.is(':checked')){$adNormalOne.show();$faultProOne.show();}else if($abNomalP.is(':checked')&&!$faultP.is(':checked')){$adNormalOne.show();$faultProOne.hide();}else if(!$abNomalP.is(':checked')&&$faultP.is(':checked')){$adNormalOne.hide();$faultProOne.show();}});$faultP.on('change',function(){var $adNormalTwo=$divPaneNoticeItem.find('.adNormal');var $faultProTwo=$divPaneNoticeItem.find('.faultPro');if($abNomalP.is(':checked')&&$faultP.is(':checked')||!$abNomalP.is(':checked')&&!$faultP.is(':checked')){$adNormalTwo.show();$faultProTwo.show();}else if($abNomalP.is(':checked')&&!$faultP.is(':checked')){$adNormalTwo.show();$faultProTwo.hide();}else if(!$abNomalP.is(':checked')&&$faultP.is(':checked')){$adNormalTwo.hide();$faultProTwo.show();}});},insertLogItem:function insertLogItem(item,itemNum,className){var divParent=$('#divPaneNoticeItem');var _this=this;var divNotice,equipment,zone,sb,span,textId,spanFirst;equipment=this.dictEquipment[item.equipmentId];textId=equipment.modalTextId;zone=this.dictZone[equipment.zoneId];divNotice=document.createElement('div');divNotice.id='divLog-'+itemNum;divNotice.setAttribute('path',zone.id+'-'+equipment.id);divNotice.setAttribute('faultid',item.faultId);divNotice.setAttribute('noticeId',item.id);if(textId!==null)divNotice.setAttribute('data-modaltextid',textId);divNotice.className='div-pane-log';$(divNotice).addClass(className);var parent=$(divNotice);var $spWrap=$('<div style="white-space: nowrap;">');spanFirst=$('<span>');switch(item.grade){case 0:break;case 1:spanFirst.addClass('badge wrongTag').html(_this.langCfg.LEVEL_SET.CRITICAL);break;case 2:spanFirst.addClass('badge dangerTag').html(_this.langCfg.LEVEL_SET.URGENT);break;default:break;}
$spWrap.append(spanFirst);span=$('<span>').addClass('badge grow span-hover-pointer').attr('title','Equipment name').attr('equipment',equipment.pageId).text(equipment.name);span.click(function(e){});$spWrap.append(span);$('<span>').addClass('badge grow span-hover-pointer').attr({'pageId':zone.pageId,'title':'Zone ID','data-zoneId':zone.id}).text(zone.subBuildingName).click(function(e){}).appendTo($spWrap);$('<span>').attr({'title':'Triggering time','data-time':item.time}).text(timeFormat(item.time,timeFormatChange('mm-dd hh:ii'))).addClass('dateTime').appendTo($spWrap);parent.append($spWrap);$('<p>').addClass('pFaultName').css({'font-weight':'bold','padding':'0 8px 0 0'}).text(item.name).appendTo(parent);var strDesc=item.description;if(item.detail){var arr=item.detail.toString().split(',');for(var j=0;j<arr.length;j++){strDesc=strDesc.replace('{'+j.toString()+'}','<span class="variable"> '+arr[j]+' </span>');}}
$('<p>').html(strDesc).appendTo(parent);divParent.append(parent);}};return ModalDiagnosisPanel;}();var ModalDiagnosisPanelHtml=function(){function ModalDiagnosisPanelHtml(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.screen=screen;this.entity=entityParams;}
ModalDiagnosisPanelHtml.prototype=Object.create(ModalHtml.prototype);ModalDiagnosisPanelHtml.prototype.constructor=ModalDiagnosisPanelHtml;ModalDiagnosisPanelHtml.prototype.optionTemplate={name:'toolBox.modal.DIAGNOSIS_PANEL',parent:0,mode:[''],maxNum:1,title:'',minHeight:4,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDiagnosisPanelHtml'};return ModalDiagnosisPanelHtml;}();var ModalKpiOverview=function(){function ModalKpiOverview(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.lastFiveMinutes=undefined;this.option=undefined;};ModalKpiOverview.prototype=new ModalBase();ModalKpiOverview.prototype.optionTemplate={name:'toolBox.modal.KPI_OVERVIEW',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:6,maxHeight:6,maxWidth:12,type:'ModalKpiOverview',scroll:false};ModalKpiOverview.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"module":"dsDrag","data":[{type:'point',name:'KPI总览',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalKpiOverview.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.structPoint)this.configModalOpt.area[0].data[0].data=_this.entity.modal.points;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();_this.renderModal();};};ModalKpiOverview.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];};ModalKpiOverview.prototype.updateModal=function(points){this.getDsItemsById(points);};ModalKpiOverview.prototype.renderModal=function(){var _this=this;var dsItemIds=_this.entity.modal.points;if(dsItemIds!==undefined){WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:dsItemIds}).done(function(result){_this.getDsItemsById(result.dsItemList);});}};ModalKpiOverview.prototype.getDsItemsById=function(data){var _this=this;var remarks=[],ids=[],scores=[];for(var i=0,length=data.length;i<length;i++){ids.push(data[i].dsItemId);scores.push(Number(data[i].data).toFixed(2));}
WebAPI.post('/analysis/datasource/getDsItemsById',ids).done(function(result){for(var i=0,length=result.length;i<length;i++){remarks.push(result[i].alias);}
_this.spinner&&_this.spinner.stop();if($(_this.container).html()===""||$(_this.container).find(".kpiInfoBox>div").length!==remarks.length){_this.firstRenderModal(remarks,scores,ids);}else{_this.laterRenderModal(remarks,scores,ids);}});};ModalKpiOverview.prototype.firstRenderModal=function(names,values,ids){var $container=$(this.container);$container.html("");var kpiOverviewCtn='<div class="kpiOverviewCtn"></div>';$container.html(kpiOverviewCtn);var colorClass,num=0,noIncluded=0;var topTitle='';var leftContainer='<div class="leftKpiOverview">\
                                <div class="circleContainer">\
                                    <canvas id="myCanvas" width="180px" height="180px"></canvas>\
                                    <div class="smallCircleContainer">\
                                        <div class="smallWhite"></div>\
                                    </div>\
                                    <span class="percentageNum">91%</span>\
                                </div>\
                            </div>';var rightContainer='<div class="rightKpiOverview gray-scrollbar container">\
                                <h3>KPI</h3>\
                                <div class="kpiInfoBox row"></div>\
                            </div>';$container.find(".kpiOverviewCtn").append($(leftContainer));$container.find(".kpiOverviewCtn").append($(rightContainer));$(rightContainer).html(topTitle);for(var i=0,length=names.length;i<length;i++){if(values[i]>=60){colorClass='passGreen';num+=1;}else{if(values[i]<0){noIncluded+=1;}
colorClass='noPassGreen';}
var str='<div class="col-xs-6">\
                            <div class="kpiInfo '+colorClass+'" data-id="'+ids[i]+'">\
                                <div>\
                                    <span title="'+names[i]+'">'+names[i]+' </span>\
                                    <span title="'+values[i]+'"> '+values[i]+'</span>\
                                    <span></span>\
                                </div>\
                            </div>\
                        </div>';$(this.container).find(".kpiInfoBox").append($(str));}
this.resize();var option=this.option;var c=$container.find("#myCanvas")[0];var ctx=c.getContext("2d");ctx.beginPath();var gradient=ctx.createLinearGradient(0,0,170,0);gradient.addColorStop("0","#63b15b");gradient.addColorStop("1.0","#f1b23e");ctx.strokeStyle=gradient;ctx.lineWidth=option.divWidth*9/180;ctx.arc(option.divWidth/2,option.divWidth/2,option.divWidth/2-ctx.lineWidth/2,0,2*Math.PI);ctx.stroke();var percentage=(num/(names.length-noIncluded)*100).toFixed(0);$container.find(".percentageNum").html(percentage+'%');option.r=option.divWidth/2-option.divWidth*8/180/2;this.smallCircle(Number(percentage),option);};ModalKpiOverview.prototype.resize=function(){var option={};var $container=$(this.container);var height=$(this.container).height(),width=$(this.container).width();var leftHeight,leftWidth;leftHeight=leftWidth=Math.min(height,width)*0.6;$('.leftKpiOverview',$container).css({'height':leftHeight+'px','width':leftWidth+'px','margin-top':'-'+leftHeight/2+'px'});$('.percentageNum',$container).css("fontSize",leftWidth/4+'px');$('#myCanvas',$container).attr("width",leftWidth+'px');$('#myCanvas',$container).attr("height",leftHeight+'px');var smallBoxWidth=leftWidth*16/180;$('.smallCircleContainer',$container).css({'height':smallBoxWidth+'px','width':smallBoxWidth+'px'});$('.rightKpiOverview',$container).css({'height':leftHeight+'px','width':'calc(100% - '+(leftWidth+20)+'px)','margin-top':'-'+leftHeight/2+'px'});$('.rightKpiOverview h3',$container).css({'fontSize':leftWidth*24/180+'px'});$('.rightKpiOverview .kpiInfo>div span',$container).css({'fontSize':leftWidth*12/180+'px'});$('.rightKpiOverview .kpiInfo:before',$container).css({'width':leftWidth*12/180+'px','height':leftWidth*12/180+'px'});option.divWidth=leftWidth;option.smallBoxWidth=smallBoxWidth;this.option=option;if($container.html()!==""&&window.location.href.indexOf("preview/page")===-1){var percentage=$container.find(".percentageNum").html().split("%")[0];var c=$container.find("#myCanvas")[0];var ctx=c.getContext("2d");ctx.beginPath();var gradient=ctx.createLinearGradient(0,0,170,0);gradient.addColorStop("0","#63b15b");gradient.addColorStop("1.0","#f1b23e");ctx.strokeStyle=gradient;ctx.lineWidth=option.divWidth*9/180;ctx.arc(option.divWidth/2,option.divWidth/2,option.divWidth/2-ctx.lineWidth/2,0,2*Math.PI);ctx.stroke();option.r=option.divWidth/2-option.divWidth*8/180/2;this.smallCircle(Number(percentage),option);}};ModalKpiOverview.prototype.smallCircle=function(percentage,option){var $container=$(this.container);var deg=percentage/100*360;var top,left;var param=Math.PI/180;if(0<percentage&&percentage<25){deg=deg-270;y=Math.sin(deg*param)*option.r;x=Math.cos(deg*param)*option.r;top=option.divWidth/2-y;left=option.divWidth/2-x;}else if(25<=percentage&&percentage<50){if(percentage===25){top=option.divWidth/2;left=option.divWidth-option.divWidth*9/180/2;}else{deg=deg-180;x=Math.sin(deg*param)*option.r;y=Math.cos(deg*param)*option.r;top=option.divWidth/2+y;left=option.divWidth/2-x;}}else if(50<=percentage&&percentage<75){if(percentage===50){top=option.divWidth-option.divWidth*9/180/2;left=option.divWidth/2;}else{deg=deg-90;y=Math.sin(deg*param)*option.r;x=Math.cos(deg*param)*option.r;top=option.divWidth/2+y;left=option.divWidth/2+x;}}else if(75<=percentage&&percentage<100){if(percentage===75){top=option.divWidth/2;left=option.divWidth*9/180/2;}else{deg=deg;x=Math.sin(deg*param)*option.r;y=Math.cos(deg*param)*option.r;top=option.divWidth/2-y;left=option.divWidth/2+x;}}else if(percentage===0||percentage===100){top=option.divWidth*9/180/2;left=option.divWidth/2;}
$container.find(".smallCircleContainer").css({'top':top-option.smallBoxWidth/2+'px','left':left-option.smallBoxWidth/2+'px'});};ModalKpiOverview.prototype.laterRenderModal=function(names,values,ids){var colorClass,fontColor,num=0,noIncluded=0;$(this.container).find(".kpiInfoBox>div").each(function(){var $kpiInfo=$(this).find(".kpiInfo");var $infos=$(this).find(".kpiInfo span");for(var i=0,length=ids.length;i<length;i++){if(ids[i]===$kpiInfo.attr("data-id")){if(values[i]>=60){colorClass='passGreen';num+=1;}else{if(values[i]<0){noIncluded+=1;}
colorClass='noPassGreen';}
$kpiInfo.removeClass().addClass("kpiInfo "+colorClass);var value=Number($infos.eq(1).html());var arrowClass;if(values[i]>value){arrowClass="glyphicon glyphicon-arrow-up";fontColor="#63b15b";}else if(values[i]<value){arrowClass="glyphicon glyphicon-arrow-down";fontColor="#f1b23e";}else if(values[i]==value){arrowClass="";}
$kpiInfo.find("span").eq(2).removeClass().addClass(arrowClass).css("color",fontColor);$infos.eq(1).html(values[i]);}}});var percentage=(num/(names.length-noIncluded)*100).toFixed(0);$(this.container).find(".percentageNum").html(percentage+'%');this.smallCircle(Number(percentage),this.option);};ModalKpiOverview.prototype.attachEvent=function(){};ModalKpiOverview.prototype.showConfigMode=function(){};return ModalKpiOverview;}();var ModalDiagnosisStruct=function(){function ModalDiagnosisStruct(screen,entityParams){this.$configModal=undefined;this.$modal=undefined;this.tempOpt=undefined;this.store={};this.subEntity=undefined;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalDiagnosisStruct.prototype=new ModalBase();ModalDiagnosisStruct.prototype.optionTemplate={name:'toolBox.modal.DIAGNOSIS_SUMMARY',parent:3,mode:'custom',maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDiagnosisStruct',scroll:false};ModalDiagnosisStruct.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"type":'option',"widget":[{id:'needDetail',type:'check',name:'是否显示细节'}]},{"module":"dsDrag","data":[{type:'point',name:'KPI分项统计来源',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalDiagnosisStruct.prototype.show=function(){this.init();};ModalDiagnosisStruct.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.needDetail)this.configModalOpt.area[0].widget[0].data=this.entity.modal.option.needDetail;if(this.entity.modal.option.structPoint)this.configModalOpt.area[1].data[0].data=this.entity.modal.option.structPoint;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();};};ModalDiagnosisStruct.prototype.getRealTimePoint=function(list,arr){var _this=this;if(!arr)arr=[];list.forEach(function(item){if(item.point){arr.push(_this.entity.modal.option.prefix+item.point);}
if(item.children instanceof Array&&item.children.length>0){_this.getRealTimePoint(item.children,arr);}});return arr;};ModalDiagnosisStruct.prototype.init=function(){};ModalDiagnosisStruct.prototype.renderModal=function(e){$(this.container).addClass('widgetKPIItemEval');this.container.innerHTML='<div class="divKPIIndex diagnosisCtn"></div><div class="divKPIDetail"></div>';if(this.entity.modal.option.needDetail){this.renderDetailContainer();$(this.container).addClass('showSubContainer');}
this.attachEvent();};ModalDiagnosisStruct.prototype.renderDetailContainer=function(){var containerDetail=this.container.querySelector('.divKPIDetail');var item={modal:{type:'ModalHtml',interval:60000,option:{html:'<div>开发中</div>'},points:[],title:''},spanC:9,spanR:6};this.initSubEntity(containerDetail,item);};ModalDiagnosisStruct.prototype.attachEvent=function(){var _this=this;var clickEvent=AppConfig.isMobile?'tap':'click';$(this.container).off(clickEvent).on(clickEvent,'.divStructTtl',function(e){$(e.currentTarget).parent().toggleClass('focus');});$(this.container).on(clickEvent,'.divStructItem',function(e){var $target=$(e.currentTarget);if($target.hasClass('focus')){$target.removeClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().removeClass('focus');}else{$(_this.container).find('.rowPointDetail.focus').removeClass('focus');$(_this.container).find('.divStructItem.focus').removeClass('focus');$target.addClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().addClass('focus');_this.refreshSubEntity($target);}});};ModalDiagnosisStruct.prototype.refreshSubEntity=function($target){var arrPoint=[],strPoint;try{arrPoint=$target.data('bindPoints');strPoint=arrPoint.map(function(point){return point.pointname;}).toString();}catch(e){strPoint='数据格式不符合';}
var _this=this;this.subEntity.entity.modal.points=arrPoint.map(function(point){return _this.entity.modal.option.prefix+point.point;});this.subEntity.entity.modal.option.html='<div>'+strPoint+'</div><script>this.onUpdateComplete=function(data){console.log(data)}</script>';this.updateSubEntity();};ModalDiagnosisStruct.prototype.updateSubEntity=function($target){this.subEntity.render();};ModalDiagnosisStruct.prototype.initPointMap=function(points){var _this=this;var $dom;points.forEach(function(point){_this.initPointDetail(point.dsItemId,point.data);});};ModalDiagnosisStruct.prototype.initPointDetail=function(id,strData){var $dom=$('[data-point="'+id+'"]');if($dom.length==0)return;var data;if(!isNaN(Number(strData))){data={score:Number(strData)};}else{try{data=JSON.parse(strData);}catch(e){$dom.text('No Data');$('.pointDetail[data-detail="'+id+'"]').text('No Data');return;}}
var status='';if(parseFloat(data.score)>=60){status='success';$dom.text(parseFloat(data.score)+'%');}else if(parseInt(data.score)>=0){status='danger';$dom.text(parseFloat(data.score)+'%');}else{status='default';$dom.text('--');}
$dom.removeClass('success danger default').addClass(status);var $detail=$('.pointDetail[data-detail="'+id+'"]');if($detail.length>0){$detail.removeClass('success danger default').addClass(status);$detail.text(data.detail);}
if($dom.hasClass('spItemInfo')){$dom.next().removeClass('success danger default').addClass(status);}};ModalDiagnosisStruct.prototype.initStruct=function(struct){var _this=this;var structDom=this.container.querySelector('[data-item="'+struct.name+'"]');if(!structDom){structDom=document.createElement('div');structDom.className='divStructCtn focus';structDom.dataset.item=struct.name;var structTtl=document.createElement('div');structTtl.className='divStructTtl';structTtl.innerHTML='\
            <span class="spStructIcon glyphicon glyphicon-dashboard"></span>\
            <span class="spStructName">'+struct.name+'</span>\
            <!--<span class="pointDetail" data-detail="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'"></span>-->';var structBody=document.createElement('div');structBody.className='divStuctBody';if(struct.items instanceof Array&&struct.items.length>0){struct.items.forEach(function(item,index){structBody.appendChild(_this.createStructItem(item));});}
structDom.appendChild(structTtl);structDom.appendChild(structBody);this.container.querySelector('.diagnosisCtn').appendChild(structDom);}};ModalDiagnosisStruct.prototype.createStructItem=function(item){var structItem=document.createElement('div');structItem.className='divStructItem';structItem.innerHTML='\
            <span class="spItemInfo">'+(item.name?item.name:'')+'</span>\
            <span class="spItemInfo">'+(item.result?item.result:'')+'</span>\
            <span class="spItemInfo spItemKPIRs">'+(item.description?item.description:'')+'</span>';$(structItem).data('bindPoints',item.bindPoints);return structItem;};ModalDiagnosisStruct.prototype.updateModal=function(points){this.spinner.stop();if(!(points[0]&&points[0].dsItemId))return;var structList;var _this=this;try{structList=JSON.parse(points[0].data).content;}catch(e){return;}
structList.forEach(function(struct){_this.initStruct(struct);});this.store.structList=structList;};ModalDiagnosisStruct.prototype.showConfigMode=function(){};ModalDiagnosisStruct.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];this.entity.modal.option.prefix='@'+AppConfig.project.bindId+'|';};return ModalDiagnosisStruct;}();var ModalRealtimeWeather=function(){var weatherImgs={yin:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.291,34.467C70.5,26.344,61.767,21.32,52.311,21.32c-12.728,0-23.524,8.832-26.105,21.158  c-6.569,2.188-11.324,8.382-11.324,15.676c0,9.111,7.414,16.525,16.526,16.525c3.289,0,6.415-0.945,9.119-2.745  c3.647,1.8,7.688,2.745,11.785,2.745c4.251,0,8.451-1.029,12.205-2.966c3.149,1.939,6.733,2.966,10.492,2.966  c11.089,0,20.11-9.021,20.11-20.109C95.118,43.577,86.249,34.621,75.291,34.467z M75.007,69.104c-3.247,0-6.315-1.046-8.877-3.023  c-1.219-0.941-2.969-0.716-3.91,0.503c-0.018,0.021-0.027,0.047-0.045,0.07c-3.019,1.6-6.42,2.45-9.865,2.45  c-3.653,0-7.255-0.947-10.41-2.74c-0.795-0.451-1.713-0.461-2.488-0.123c-0.447,0.072-0.883,0.245-1.263,0.542  c-1.94,1.519-4.271,2.32-6.744,2.32c-6.038,0-10.95-4.911-10.95-10.949s4.912-10.951,10.95-10.951c3.048,0,5.979,1.285,8.048,3.521  c1.044,1.132,2.809,1.201,3.938,0.157c1.131-1.045,1.202-2.809,0.157-3.938c-2.941-3.187-7.042-5.088-11.354-5.296  C34.91,32.951,42.94,26.893,52.31,26.893c6.688,0,12.931,3.178,16.885,8.443c-2.639,0.797-5.108,2.118-7.232,3.93  c-1.171,0.999-1.311,2.761-0.313,3.932c1,1.172,2.762,1.31,3.932,0.31c2.624-2.239,5.973-3.472,9.428-3.472  c8.014,0,14.535,6.52,14.535,14.534C89.542,62.584,83.021,69.104,75.007,69.104z"/>\
                </g>\
                </svg>',dayu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.293,23.69c-4.791-8.123-13.525-13.147-22.981-13.147c-12.726,0-23.525,8.832-26.107,21.159   c-6.568,2.188-11.323,8.381-11.323,15.675c0,9.112,7.414,16.526,16.525,16.526c3.289,0,6.415-0.945,9.119-2.744   c3.648,1.797,7.689,2.744,11.786,2.744c4.25,0,8.452-1.029,12.206-2.966c3.149,1.938,6.732,2.966,10.492,2.966   c11.088,0,20.108-9.021,20.108-20.11C95.118,32.798,86.251,23.841,75.293,23.69z M75.01,58.326c-3.246,0-6.315-1.045-8.877-3.023   c-1.22-0.941-2.971-0.717-3.91,0.503c-0.019,0.021-0.027,0.047-0.043,0.069c-3.021,1.601-6.422,2.451-9.867,2.451   c-3.656,0-7.256-0.947-10.411-2.74c-0.794-0.453-1.713-0.461-2.491-0.123c-0.444,0.074-0.879,0.244-1.26,0.543   c-1.938,1.52-4.271,2.32-6.743,2.32c-6.038,0-10.951-4.912-10.951-10.95c0-6.038,4.913-10.951,10.951-10.951   c3.045,0,5.979,1.285,8.047,3.523c1.047,1.131,2.81,1.202,3.939,0.156c1.131-1.045,1.201-2.81,0.156-3.938   c-2.942-3.185-7.043-5.086-11.354-5.294c2.718-8.697,10.748-14.755,20.117-14.755c6.69,0,12.929,3.177,16.885,8.443   c-2.64,0.797-5.109,2.118-7.233,3.93c-1.17,0.999-1.311,2.76-0.312,3.931c0.999,1.172,2.759,1.311,3.931,0.311   c2.624-2.239,5.973-3.472,9.43-3.472c8.014,0,14.533,6.52,14.533,14.534C89.544,51.806,83.023,58.326,75.01,58.326z"/>\
                    <path d="M44.751,79.875c0,3.084-2.5,5.582-5.583,5.582s-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S44.751,76.791,44.751,79.875z"/>\
                    <path d="M59.557,79.875c0,3.084-2.5,5.582-5.582,5.582c-3.084,0-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S59.557,76.791,59.557,79.875z"/>\
                    <path d="M74.362,79.875c0,3.084-2.499,5.582-5.583,5.582c-3.083,0-5.583-2.498-5.583-5.582   s5.583-11.408,5.583-11.408S74.362,76.791,74.362,79.875z"/>\
                </g>\
                </svg>',baoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.292,23.756c-4.791-8.123-13.524-13.146-22.98-13.146c-12.729,0-23.527,8.832-26.107,21.159   c-6.569,2.187-11.324,8.381-11.324,15.675c0,9.112,7.414,16.526,16.526,16.526c3.29,0,6.416-0.946,9.118-2.745   c3.648,1.799,7.69,2.745,11.787,2.745c4.25,0,8.452-1.03,12.206-2.967c3.148,1.939,6.731,2.967,10.492,2.967   c11.088,0,20.109-9.021,20.109-20.11C95.119,32.865,86.25,23.909,75.292,23.756z M75.008,58.394c-3.246,0-6.316-1.046-8.878-3.024   c-1.219-0.94-2.969-0.716-3.909,0.503c-0.019,0.021-0.027,0.047-0.045,0.07c-3.02,1.6-6.421,2.451-9.865,2.451   c-3.655,0-7.256-0.948-10.412-2.741c-0.795-0.451-1.713-0.461-2.49-0.122c-0.445,0.074-0.881,0.244-1.261,0.542   c-1.94,1.519-4.271,2.321-6.743,2.321c-6.038,0-10.951-4.912-10.951-10.95s4.913-10.951,10.951-10.951   c3.046,0,5.979,1.285,8.047,3.522c1.044,1.132,2.808,1.2,3.938,0.156c1.132-1.045,1.202-2.809,0.157-3.938   c-2.94-3.187-7.042-5.087-11.354-5.295c2.717-8.697,10.748-14.755,20.118-14.755c6.688,0,12.928,3.177,16.884,8.442   c-2.641,0.797-5.11,2.118-7.234,3.931c-1.171,0.999-1.31,2.76-0.313,3.931c1,1.172,2.762,1.31,3.932,0.31   c2.623-2.238,5.973-3.472,9.428-3.472c8.016,0,14.535,6.521,14.535,14.534C89.543,51.872,83.021,58.394,75.008,58.394z"/>\
                    <path d="M30.448,85.391c-0.531,0-1.067-0.149-1.543-0.47c-1.281-0.854-1.628-2.584-0.773-3.864l9.026-13.539   c0.854-1.28,2.584-1.629,3.865-0.772c1.281,0.854,1.627,2.584,0.773,3.865L32.77,84.151C32.232,84.955,31.348,85.391,30.448,85.391   z"/>\
                    <path d="M45.313,85.391c-0.53,0-1.067-0.149-1.543-0.47c-1.281-0.854-1.627-2.584-0.772-3.864l9.026-13.539   c0.854-1.28,2.585-1.629,3.865-0.772c1.281,0.854,1.627,2.584,0.773,3.865l-9.026,13.541   C47.099,84.955,46.214,85.391,45.313,85.391z"/>\
                    <path d="M60.182,85.391c-0.53,0-1.067-0.149-1.543-0.47c-1.283-0.854-1.627-2.584-0.772-3.864l9.024-13.539   c0.854-1.28,2.586-1.629,3.867-0.772c1.279,0.854,1.627,2.584,0.772,3.865l-9.027,13.541   C61.967,84.955,61.083,85.391,60.182,85.391z"/>\
                </g>\
                </svg>',duoyun:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <g>\
                            <path d="M59.271,34.332c-4.592-8.123-12.961-13.146-22.021-13.146c-12.197,0-22.546,8.832-25.019,21.159    C5.936,44.531,1.379,50.726,1.379,58.02c0,9.111,7.104,16.525,15.836,16.525c3.152,0,6.148-0.945,8.739-2.745    c3.495,1.8,7.368,2.745,11.295,2.745c4.074,0,8.098-1.029,11.696-2.966c3.017,1.939,6.451,2.966,10.053,2.966    c10.627,0,19.271-9.021,19.271-20.109C78.271,43.441,69.772,34.485,59.271,34.332z M58.998,68.97    c-3.109,0-6.051-1.047-8.506-3.024c-1.168-0.94-2.845-0.715-3.747,0.503c-0.017,0.021-0.025,0.047-0.042,0.07    c-2.893,1.601-6.153,2.452-9.453,2.452c-3.504,0-6.953-0.948-9.977-2.741c-0.759-0.45-1.639-0.46-2.384-0.123    c-0.428,0.074-0.846,0.244-1.211,0.542c-1.86,1.519-4.096,2.321-6.463,2.321c-5.787,0-10.494-4.912-10.494-10.95    s4.707-10.951,10.494-10.951c2.92,0,5.729,1.285,7.711,3.521c1.003,1.134,2.692,1.202,3.775,0.157    c1.084-1.045,1.15-2.809,0.147-3.938c-2.817-3.187-6.749-5.087-10.88-5.295c2.604-8.697,10.3-14.755,19.277-14.755    c6.411,0,12.39,3.177,16.181,8.442c-2.528,0.797-4.897,2.118-6.934,3.93c-1.121,0.999-1.254,2.761-0.296,3.932    c0.959,1.171,2.645,1.31,3.767,0.31c2.514-2.238,5.722-3.472,9.033-3.472c7.682,0,13.93,6.52,13.93,14.534    C72.928,62.448,66.68,68.97,58.998,68.97z"/>\
                            <g>\
                                <path d="M93.438,42.01c-3.744-6.411-10.431-10.365-17.66-10.365c-3.071,0-6.082,0.715-8.819,2.063     c1.803,1.117,3.451,2.482,4.896,4.05c1.271-0.351,2.588-0.537,3.923-0.537c4.587,0,8.882,2.146,11.767,5.744     c-1.765,0.665-3.414,1.654-4.861,2.941c-1.121,1-1.254,2.759-0.297,3.931c0.957,1.17,2.644,1.312,3.767,0.313     c1.874-1.67,4.269-2.59,6.735-2.59c5.729,0,10.388,4.861,10.388,10.839c0,5.977-4.659,10.84-10.388,10.84     c-2.319,0-4.514-0.78-6.344-2.256c-1.148-0.927-2.791-0.718-3.701,0.452c-2.168,1.176-4.6,1.804-7.064,1.804     c-0.736,0-1.473-0.063-2.195-0.17c-1.275,1.733-2.77,3.286-4.441,4.603c2.129,0.752,4.373,1.145,6.638,1.145     c3.188,0,6.343-0.781,9.181-2.25c2.396,1.469,5.099,2.25,7.93,2.25c8.675,0,15.73-7.365,15.73-16.416     C108.619,49.538,101.856,42.316,93.438,42.01z"/>\
                            </g>\
                        </g>\
                        <path d="M59.271,34.332c-4.592-8.123-12.961-13.146-22.021-13.146c-12.197,0-22.546,8.832-25.019,21.159   C5.936,44.531,1.379,50.726,1.379,58.02c0,9.111,7.104,16.525,15.836,16.525c3.152,0,6.148-0.945,8.739-2.745   c3.495,1.8,7.368,2.745,11.295,2.745c4.074,0,8.098-1.029,11.696-2.966c3.017,1.939,6.451,2.966,10.053,2.966   c10.627,0,19.271-9.021,19.271-20.109C78.271,43.441,69.772,34.485,59.271,34.332z M58.998,68.97c-3.109,0-6.051-1.047-8.506-3.024   c-1.168-0.94-2.845-0.715-3.747,0.503c-0.017,0.021-0.025,0.047-0.042,0.07c-2.893,1.601-6.153,2.452-9.453,2.452   c-3.504,0-6.953-0.948-9.977-2.741c-0.759-0.45-1.639-0.46-2.384-0.123c-0.428,0.074-0.846,0.244-1.211,0.542   c-1.86,1.519-4.096,2.321-6.463,2.321c-5.787,0-10.494-4.912-10.494-10.95s4.707-10.951,10.494-10.951   c2.92,0,5.729,1.285,7.711,3.521c1.003,1.134,2.692,1.202,3.775,0.157c1.084-1.045,1.15-2.809,0.147-3.938   c-2.817-3.187-6.749-5.087-10.88-5.295c2.604-8.697,10.3-14.755,19.277-14.755c6.411,0,12.39,3.177,16.181,8.442   c-2.528,0.797-4.897,2.118-6.934,3.93c-1.121,0.999-1.254,2.761-0.296,3.932c0.959,1.171,2.645,1.31,3.767,0.31   c2.514-2.238,5.722-3.472,9.033-3.472c7.682,0,13.93,6.52,13.93,14.534C72.928,62.448,66.68,68.97,58.998,68.97z"/>\
                    </g>\
                    </svg>',xiaoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.293,23.69c-4.791-8.123-13.523-13.147-22.98-13.147c-12.727,0-23.526,8.831-26.107,21.159   c-6.567,2.188-11.323,8.382-11.323,15.675c0,9.112,7.414,16.526,16.525,16.526c3.289,0,6.415-0.945,9.119-2.744   c3.647,1.799,7.688,2.744,11.786,2.744c4.25,0,8.451-1.029,12.205-2.966c3.147,1.938,6.731,2.966,10.492,2.966   c11.09,0,20.108-9.021,20.108-20.11C95.118,32.798,86.25,23.842,75.293,23.69z M75.009,58.326c-3.246,0-6.316-1.047-8.877-3.023   c-1.22-0.941-2.971-0.717-3.91,0.501c-0.02,0.021-0.027,0.048-0.045,0.069c-2.15,1.142-4.495,1.896-6.912,2.238l-6.184-0.043   c-2.521-0.39-4.963-1.224-7.183-2.482c-0.795-0.453-1.716-0.463-2.493-0.121c-0.443,0.074-0.877,0.244-1.256,0.539   c-1.942,1.52-4.274,2.322-6.745,2.322c-6.038,0-10.951-4.912-10.951-10.951c0-6.038,4.913-10.951,10.951-10.951   c3.046,0,5.979,1.285,8.048,3.523c1.044,1.13,2.811,1.2,3.939,0.156c1.129-1.044,1.2-2.81,0.155-3.938   c-2.941-3.185-7.043-5.086-11.354-5.294c2.716-8.697,10.747-14.755,20.116-14.755c6.689,0,12.929,3.177,16.885,8.443   c-2.639,0.797-5.107,2.118-7.232,3.93c-1.173,1-1.313,2.76-0.313,3.931c0.997,1.17,2.758,1.312,3.93,0.313   c2.625-2.24,5.975-3.473,9.431-3.473c8.015,0,14.534,6.519,14.534,14.534C89.544,51.808,83.024,58.326,75.009,58.326z"/>\
                    <path d="M59.558,79.875c0,3.084-2.5,5.582-5.583,5.582s-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S59.558,76.791,59.558,79.875z"/>\
                </g>\
                </svg>',qing_duoyun:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <g>\
                        <g>\
                            <path d="M90.923,16.534c1.333,0.771,1.79,2.479,1.021,3.811l-3.938,6.816c-0.77,1.334-2.475,1.791-3.809,1.021     c-1.332-0.771-1.79-2.477-1.02-3.811l3.938-6.814C87.885,16.225,89.588,15.768,90.923,16.534z"/>\
                        </g>\
                        <g>\
                            <path d="M103.951,29.564c0.771,1.334,0.313,3.039-1.021,3.809l-6.818,3.938c-1.332,0.771-3.039,0.313-3.809-1.02     c-0.77-1.336-0.314-3.039,1.02-3.811l6.818-3.938C101.477,27.773,103.18,28.232,103.951,29.564z"/>\
                        </g>\
                        <g>\
                            <path d="M108.721,47.36c0,1.541-1.25,2.787-2.787,2.787h-7.873c-1.541,0.002-2.789-1.248-2.789-2.787     c0-1.541,1.248-2.785,2.789-2.787l7.873,0.002C107.471,44.575,108.719,45.819,108.721,47.36z"/>\
                        </g>\
                        <g>\
                            <path d="M103.951,65.157c-0.77,1.334-2.475,1.789-3.809,1.021l-6.817-3.938c-1.333-0.77-1.79-2.475-1.021-3.807     c0.771-1.336,2.475-1.791,3.809-1.021l6.818,3.938C104.266,62.118,104.721,63.823,103.951,65.157z"/>\
                        </g>\
                        <path d="M62.053,28.184c-1.332,0.77-3.037,0.313-3.808-1.021l-3.937-6.818c-0.771-1.332-0.314-3.035,1.02-3.809    c1.333-0.77,3.038-0.313,3.807,1.021l3.938,6.814C63.844,25.708,63.387,27.413,62.053,28.184z"/>\
                        <g>\
                            <path d="M73.126,25.215c-1.541,0-2.788-1.247-2.788-2.787v-7.873c0-1.539,1.247-2.787,2.788-2.787     c1.54,0,2.787,1.248,2.787,2.787v7.873C75.913,23.969,74.666,25.215,73.126,25.215z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M61.691,44.021c-4.791-8.123-13.524-13.15-22.981-13.15c-12.727,0-23.525,8.83-26.105,21.16    C6.035,54.22,1.279,60.412,1.279,67.707c0,9.111,7.414,16.525,16.526,16.525c3.29,0,6.415-0.947,9.118-2.746    c3.648,1.799,7.691,2.746,11.787,2.746c4.251,0,8.451-1.031,12.205-2.965c3.15,1.938,6.732,2.965,10.493,2.965    c11.088,0,20.108-9.021,20.108-20.109C81.518,53.127,72.648,44.172,61.691,44.021z M61.406,78.654    c-3.247,0-6.317-1.045-8.879-3.025c-1.217-0.939-2.969-0.715-3.909,0.505c-0.017,0.022-0.027,0.048-0.046,0.067    c-3.02,1.604-6.42,2.453-9.864,2.453c-3.655,0-7.255-0.945-10.411-2.742c-0.792-0.449-1.71-0.457-2.485-0.121    c-0.447,0.074-0.884,0.244-1.266,0.541c-1.939,1.521-4.271,2.322-6.742,2.322c-6.038,0-10.951-4.912-10.951-10.949    c0-6.039,4.913-10.951,10.951-10.951c3.047,0,5.979,1.283,8.048,3.523c1.045,1.131,2.809,1.201,3.938,0.156    s1.201-2.809,0.156-3.939c-2.942-3.186-7.042-5.086-11.354-5.295c2.719-8.697,10.748-14.754,20.117-14.754    c6.688,0,12.929,3.176,16.884,8.441c-2.638,0.799-5.109,2.117-7.232,3.932c-1.17,0.998-1.312,2.76-0.312,3.93    s2.761,1.311,3.931,0.313c2.625-2.24,5.973-3.475,9.429-3.475c8.014,0,14.534,6.521,14.534,14.535    C75.941,72.134,69.421,78.654,61.406,78.654z"/>\
                        <g>\
                            <path d="M91.902,47.586c0-10.354-8.422-18.775-18.775-18.775c-5.336,0.002-10.3,2.225-13.822,6.068     c1.295,1.174,2.498,2.453,3.584,3.846c2.557-2.959,6.254-4.684,10.238-4.686c7.469,0,13.544,6.076,13.544,13.547     c0,3.023-0.987,5.854-2.702,8.139c0.727,1.932,1.217,3.977,1.42,6.1C89.443,58.344,91.902,53.208,91.902,47.586z"/>\
                            <g>\
                                <path d="M91.943,74.377l-3.938-6.816c-0.55-0.951-1.574-1.445-2.604-1.379c-0.172,2.033-0.6,3.998-1.25,5.855      l2.961,5.126c0.77,1.334,2.475,1.791,3.808,1.021C92.256,77.414,92.713,75.711,91.943,74.377z"/>\
                            </g>\
                        </g>\
                    </g>\
                    <path d="M61.691,44.021c-4.791-8.123-13.524-13.15-22.981-13.15c-12.727,0-23.525,8.83-26.105,21.16   C6.035,54.22,1.279,60.412,1.279,67.707c0,9.111,7.414,16.525,16.526,16.525c3.29,0,6.415-0.947,9.118-2.746   c3.648,1.799,7.691,2.746,11.787,2.746c4.251,0,8.451-1.031,12.205-2.965c3.15,1.938,6.732,2.965,10.493,2.965   c11.088,0,20.108-9.021,20.108-20.109C81.518,53.127,72.648,44.172,61.691,44.021z M61.406,78.654   c-3.247,0-6.317-1.045-8.879-3.025c-1.217-0.939-2.969-0.715-3.909,0.505c-0.017,0.022-0.027,0.048-0.046,0.067   c-3.02,1.604-6.42,2.453-9.864,2.453c-3.655,0-7.255-0.945-10.411-2.742c-0.792-0.449-1.71-0.457-2.485-0.121   c-0.447,0.074-0.884,0.244-1.266,0.541c-1.939,1.521-4.271,2.322-6.742,2.322c-6.038,0-10.951-4.912-10.951-10.949   c0-6.039,4.913-10.951,10.951-10.951c3.047,0,5.979,1.283,8.048,3.523c1.045,1.131,2.809,1.201,3.938,0.156   s1.201-2.809,0.156-3.939c-2.942-3.186-7.042-5.086-11.354-5.295c2.719-8.697,10.748-14.754,20.117-14.754   c6.688,0,12.929,3.176,16.884,8.441c-2.638,0.799-5.109,2.117-7.232,3.932c-1.17,0.998-1.312,2.76-0.312,3.93   s2.761,1.311,3.931,0.313c2.625-2.24,5.973-3.475,9.429-3.475c8.014,0,14.534,6.521,14.534,14.535   C75.941,72.134,69.421,78.654,61.406,78.654z"/>\
                </g>\
                </svg>',qing:'<svg style="fill: #eee;"  x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
				<g>\
					<path d="M54.999,67c-10.354,0-18.776-8.424-18.776-18.774c0-10.354,8.425-18.776,18.776-18.776   c10.354,0,18.775,8.424,18.775,18.776C73.776,58.576,65.354,67,54.999,67z M54.999,34.681c-7.469,0-13.545,6.076-13.545,13.545   c0,7.47,6.076,13.545,13.545,13.545c7.468,0,13.545-6.075,13.545-13.545C68.544,40.756,62.468,34.681,54.999,34.681z"/>\
					<g>\
						<g>\
							<path d="M43.927,67.176c1.333,0.771,1.79,2.479,1.021,3.811l-3.938,6.816c-0.769,1.332-2.476,1.791-3.808,1.023     c-1.334-0.773-1.791-2.479-1.021-3.813l3.938-6.818C40.889,66.865,42.594,66.408,43.927,67.176z"/>\
							<path d="M72.796,17.174c1.333,0.771,1.79,2.476,1.021,3.81l-3.938,6.815c-0.771,1.334-2.476,1.791-3.808,1.022     c-1.334-0.77-1.791-2.475-1.021-3.809l3.938-6.818C69.758,16.861,71.462,16.404,72.796,17.174z"/>\
						</g>\
						<g>\
							<path d="M35.821,59.07c0.771,1.334,0.313,3.039-1.021,3.811l-6.817,3.936c-1.334,0.77-3.039,0.313-3.81-1.02     c-0.771-1.334-0.313-3.036,1.021-3.809l6.816-3.938C33.346,57.281,35.052,57.738,35.821,59.07z"/>\
							<path d="M85.825,30.204c0.77,1.334,0.313,3.039-1.021,3.807l-6.816,3.938c-1.334,0.77-3.039,0.313-3.811-1.021     c-0.77-1.336-0.313-3.039,1.021-3.809l6.816-3.938C83.351,28.413,85.054,28.87,85.825,30.204z"/>\
						</g>\
						<g>\
							<path d="M32.854,48c0,1.539-1.246,2.785-2.787,2.785h-7.873c-1.539,0-2.787-1.248-2.787-2.785     c0-1.541,1.246-2.787,2.787-2.787l7.873-0.002C31.608,45.211,32.854,46.459,32.854,48z"/>\
							<path d="M90.593,48c0,1.539-1.248,2.785-2.788,2.785h-7.872c-1.541,0.002-2.787-1.248-2.787-2.785     c0-1.541,1.246-2.787,2.787-2.789l7.872,0.002C89.345,45.213,90.593,46.459,90.593,48z"/>\
						</g>\
						<g>\
							<path d="M35.821,36.926c-0.771,1.336-2.475,1.791-3.809,1.021l-6.816-3.938c-1.334-0.768-1.791-2.473-1.021-3.807     c0.771-1.334,2.477-1.791,3.809-1.021l6.817,3.938C36.134,33.89,36.591,35.595,35.821,36.926z"/>\
							<path d="M85.825,65.797c-0.771,1.334-2.475,1.789-3.811,1.02l-6.816-3.936c-1.332-0.77-1.791-2.477-1.021-3.809     c0.771-1.334,2.476-1.791,3.81-1.021l6.817,3.937C86.137,62.758,86.594,64.463,85.825,65.797z"/>\
						</g>\
						<g>\
							<path d="M43.927,28.822c-1.334,0.769-3.038,0.312-3.809-1.021l-3.938-6.817c-0.77-1.334-0.313-3.037,1.021-3.808     c1.332-0.771,3.037-0.313,3.808,1.021l3.938,6.818C45.717,26.349,45.26,28.054,43.927,28.822z"/>\
							<path d="M72.796,78.824c-1.333,0.771-3.038,0.313-3.809-1.021l-3.938-6.815c-0.77-1.334-0.313-3.039,1.021-3.809     c1.332-0.77,3.037-0.313,3.808,1.021l3.938,6.816C74.586,76.35,74.129,78.053,72.796,78.824z"/>\
						</g>\
						<g>\
							<path d="M54.999,25.854c-1.54,0-2.788-1.248-2.788-2.787v-7.873c0-1.538,1.248-2.786,2.788-2.786     c1.539,0,2.787,1.248,2.787,2.786v7.873C57.788,24.607,56.54,25.854,54.999,25.854z"/>\
							<path d="M54.999,83.592c-1.54,0-2.788-1.246-2.788-2.787v-7.871c0-1.541,1.248-2.789,2.788-2.789     c1.539,0,2.787,1.248,2.787,2.789v7.871C57.788,82.346,56.54,83.592,54.999,83.592z"/>\
						</g>\
					</g>\
				</g>\
			</svg>',duoyun_zhenyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                        <g>\
                            <g>\
                                <g>\
                                    <g>\
                                        <path d="M90.924,5.36c1.334,0.771,1.791,2.476,1.021,3.81l-3.938,6.817c-0.77,1.334-2.475,1.791-3.809,1.021      c-1.332-0.771-1.789-2.476-1.021-3.81l3.939-6.815C87.885,5.049,89.59,4.592,90.924,5.36z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M103.953,18.39c0.77,1.334,0.313,3.039-1.021,3.807l-6.818,3.938c-1.332,0.771-3.037,0.313-3.809-1.021      c-0.77-1.334-0.313-3.039,1.021-3.809l6.818-3.938C101.477,16.599,103.18,17.056,103.953,18.39z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M108.721,36.187c0,1.541-1.248,2.787-2.787,2.787h-7.873c-1.543,0-2.787-1.248-2.787-2.787      c0-1.541,1.244-2.787,2.785-2.787h7.873C107.473,33.399,108.719,34.646,108.721,36.187z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M103.953,53.983c-0.771,1.334-2.477,1.789-3.811,1.021l-6.816-3.937      c-1.334-0.771-1.791-2.476-1.021-3.808c0.771-1.336,2.477-1.79,3.809-1.021l6.816,3.938      C104.264,50.944,104.721,52.649,103.953,53.983z"/>\
                                    </g>\
                                    <path d="M62.053,17.008c-1.332,0.771-3.037,0.313-3.807-1.021l-3.938-6.818c-0.77-1.334-0.313-3.037,1.021-3.808     c1.332-0.771,3.037-0.313,3.807,1.021l3.939,6.815C63.844,14.534,63.387,16.239,62.053,17.008z"/>\
                                    <g>\
                                        <path d="M73.127,14.041c-1.539,0-2.787-1.247-2.787-2.788V3.38c0-1.539,1.248-2.786,2.787-2.786      c1.541,0,2.789,1.247,2.789,2.786v7.873C75.916,12.794,74.668,14.041,73.127,14.041z"/>\
                                    </g>\
                                </g>\
                                <g>\
                                    <path d="M61.691,32.845c-4.791-8.121-13.523-13.148-22.98-13.148c-12.729,0-23.527,8.83-26.107,21.16     C6.035,43.043,1.279,49.235,1.279,56.532c0,9.111,7.414,16.523,16.525,16.523c3.291,0,6.416-0.945,9.121-2.742     c3.646,1.797,7.689,2.742,11.785,2.742c4.252,0,8.453-1.031,12.207-2.966c3.148,1.938,6.73,2.966,10.492,2.966     c11.088,0,20.107-9.021,20.107-20.109C81.516,41.952,72.65,32.998,61.691,32.845z M61.408,67.48     c-3.246,0-6.316-1.045-8.879-3.025c-1.219-0.939-2.971-0.716-3.91,0.505c-0.018,0.021-0.027,0.047-0.043,0.067     c-3.02,1.604-6.422,2.453-9.867,2.453c-3.654,0-7.254-0.947-10.41-2.742c-0.793-0.449-1.711-0.459-2.488-0.121     c-0.445,0.074-0.883,0.244-1.264,0.541c-1.939,1.521-4.271,2.322-6.744,2.322c-6.039,0-10.951-4.912-10.951-10.949     c0-6.041,4.914-10.953,10.951-10.953c3.047,0,5.98,1.285,8.047,3.523c1.045,1.133,2.811,1.203,3.941,0.155     c1.131-1.043,1.199-2.808,0.154-3.938c-2.939-3.187-7.043-5.088-11.354-5.295c2.717-8.697,10.748-14.756,20.115-14.756     c6.689,0,12.93,3.178,16.885,8.442c-2.639,0.799-5.109,2.116-7.234,3.931c-1.172,1-1.311,2.76-0.311,3.932     c1,1.17,2.76,1.31,3.93,0.312c2.623-2.239,5.973-3.474,9.43-3.474c8.014,0,14.533,6.521,14.533,14.533S69.422,67.48,61.408,67.48     z"/>\
                                    <g>\
                                        <path d="M91.904,36.411c0-10.354-8.424-18.773-18.777-18.773c-5.336,0-10.301,2.225-13.822,6.068      c1.295,1.173,2.498,2.453,3.584,3.846c2.557-2.96,6.254-4.684,10.238-4.686c7.469,0,13.547,6.076,13.547,13.545      c0,3.025-0.99,5.854-2.705,8.141c0.727,1.932,1.217,3.977,1.42,6.098C89.445,47.166,91.904,42.034,91.904,36.411z"/>\
                                        <g>\
                                            <path d="M91.945,63.203l-3.939-6.819c-0.549-0.948-1.574-1.442-2.604-1.377c-0.174,2.034-0.6,3.998-1.248,5.856       l2.959,5.125c0.771,1.336,2.477,1.791,3.809,1.021C92.258,66.24,92.715,64.537,91.945,63.203z"/>\
                                        </g>\
                                    </g>\
                                </g>\
                                <path d="M61.691,32.845c-4.791-8.121-13.523-13.148-22.98-13.148c-12.729,0-23.527,8.83-26.107,21.16    C6.035,43.043,1.279,49.235,1.279,56.532c0,9.111,7.414,16.523,16.525,16.523c3.291,0,6.416-0.945,9.121-2.742    c3.646,1.797,7.689,2.742,11.785,2.742c4.252,0,8.453-1.031,12.207-2.966c3.148,1.938,6.73,2.966,10.492,2.966    c11.088,0,20.107-9.021,20.107-20.109C81.516,41.952,72.65,32.998,61.691,32.845z M61.408,67.48c-3.246,0-6.316-1.045-8.879-3.025    c-1.219-0.939-2.971-0.716-3.91,0.505c-0.018,0.021-0.027,0.047-0.043,0.067c-3.02,1.604-6.422,2.453-9.867,2.453    c-3.654,0-7.254-0.947-10.41-2.742c-0.793-0.449-1.711-0.459-2.488-0.121c-0.445,0.074-0.883,0.244-1.264,0.541    c-1.939,1.521-4.271,2.322-6.744,2.322c-6.039,0-10.951-4.912-10.951-10.949c0-6.041,4.914-10.953,10.951-10.953    c3.047,0,5.98,1.285,8.047,3.523c1.045,1.133,2.811,1.203,3.941,0.155c1.131-1.043,1.199-2.808,0.154-3.938    c-2.939-3.187-7.043-5.088-11.354-5.295c2.717-8.697,10.748-14.756,20.115-14.756c6.689,0,12.93,3.178,16.885,8.442    c-2.639,0.799-5.109,2.116-7.234,3.931c-1.172,1-1.311,2.76-0.311,3.932c1,1.17,2.76,1.31,3.93,0.312    c2.623-2.239,5.973-3.474,9.43-3.474c8.014,0,14.533,6.521,14.533,14.533S69.422,67.48,61.408,67.48z"/>\
                            </g>\
                            <path d="M39.525,89.822c0,3.086-2.5,5.584-5.582,5.584c-3.084,0-5.584-2.498-5.584-5.584   c0-3.082,5.584-11.406,5.584-11.406S39.525,86.74,39.525,89.822z"/>\
                            <path d="M54.332,89.822c0,3.086-2.5,5.584-5.582,5.584c-3.084,0-5.584-2.498-5.584-5.584   c0-3.082,5.584-11.406,5.584-11.406S54.332,86.74,54.332,89.822z"/>\
                        </g>\
                        </svg>',dalei:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <g>\
                        <path d="M75.294,27.418c-4.791-8.121-13.525-13.146-22.98-13.146c-12.729,0-23.527,8.83-26.107,21.16    c-6.57,2.187-11.324,8.379-11.324,15.674c0,9.11,7.414,16.524,16.525,16.524c3.291,0,6.416-0.945,9.119-2.744    c0.365,0.181,0.738,0.347,1.111,0.508c0.352-0.805,1.945-5.232,1.945-5.232c-0.57-0.261-1.137-0.537-1.682-0.849    c-0.795-0.449-1.51-0.694-2.453-0.248c-0.445,0.073-0.918,0.37-1.301,0.67c-1.938,1.519-4.271,2.319-6.742,2.319    c-6.037,0-10.949-4.912-10.949-10.948c0-6.039,4.912-10.951,10.949-10.951c3.047,0,5.979,1.283,8.047,3.523    c1.047,1.131,2.811,1.201,3.939,0.156s1.199-2.808,0.156-3.938c-2.943-3.187-7.045-5.088-11.354-5.293    c2.717-8.699,10.746-14.756,20.115-14.756c6.689,0,12.93,3.176,16.887,8.441c-2.641,0.801-5.109,2.118-7.234,3.934    c-1.172,0.998-1.311,2.758-0.311,3.928c0.996,1.172,2.758,1.312,3.93,0.312c2.623-2.24,5.973-3.474,9.43-3.474    c8.014,0,14.535,6.521,14.535,14.535c0,8.015-6.521,14.532-14.535,14.532c-2.246,0-4.402-0.51-6.369-1.475    c-0.469,1.172-2.086,5.172-2.086,5.172c2.625,1.228,5.48,1.879,8.455,1.879c11.088,0,20.107-9.021,20.107-20.108    C95.118,36.528,86.251,27.571,75.294,27.418z"/>\
                    </g>\
                    <path d="M56.185,45.789c0.055-0.529-0.09-0.57-0.32-0.093l-9.371,19.437c-0.23,0.479,0.016,0.871,0.545,0.871h6.012   c0.529,0,0.936,0.432,0.896,0.961l-1,14.333c-0.035,0.529,0.129,0.576,0.367,0.103l10.475-20.774c0.24-0.476,0-0.869-0.529-0.881   l-7.525-0.149c-0.527-0.011-0.92-0.451-0.863-0.979L56.185,45.789z"/>\
                </g>\
                </svg>',dalei_baoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                        <g>\
                            <g>\
                                <g>\
                                    <path d="M75.293,20.978C70.502,12.855,61.768,7.832,52.311,7.832c-12.727,0-23.523,8.83-26.104,21.159     c-6.57,2.187-11.326,8.38-11.326,15.675c0,9.11,7.414,16.524,16.525,16.524c3.289,0,6.416-0.944,9.119-2.744     c0.365,0.181,0.738,0.345,1.111,0.509c0.35-0.806,1.947-5.234,1.947-5.234c-0.572-0.26-1.137-0.535-1.684-0.848     c-0.795-0.449-1.508-0.695-2.453-0.248c-0.445,0.073-0.918,0.373-1.301,0.668c-1.938,1.52-4.27,2.319-6.742,2.319     c-6.037,0-10.949-4.909-10.949-10.946c0-6.039,4.912-10.953,10.949-10.953c3.047,0,5.979,1.285,8.049,3.524     c1.047,1.132,2.809,1.201,3.938,0.156s1.201-2.809,0.156-3.938c-2.939-3.187-7.043-5.089-11.354-5.295     c2.719-8.697,10.748-14.755,20.115-14.755c6.691,0,12.932,3.175,16.887,8.441c-2.641,0.799-5.109,2.119-7.234,3.932     c-1.17,1-1.311,2.759-0.311,3.929c1,1.174,2.76,1.311,3.932,0.313c2.623-2.24,5.971-3.473,9.426-3.473     c8.016,0,14.535,6.521,14.535,14.535c0,8.012-6.521,14.53-14.535,14.53c-2.244,0-4.4-0.511-6.367-1.476     c-0.471,1.174-2.086,5.174-2.086,5.174c2.625,1.229,5.482,1.88,8.453,1.88c11.09,0,20.111-9.021,20.111-20.108     C95.119,30.088,86.252,21.131,75.293,20.978z"/>\
                                </g>\
                                <path d="M56.182,39.349c0.055-0.529-0.09-0.57-0.32-0.092L46.49,58.693c-0.229,0.479,0.018,0.869,0.547,0.869    h6.012c0.531,0,0.936,0.435,0.896,0.961l-1,14.332c-0.035,0.529,0.129,0.576,0.365,0.104l10.479-20.774    c0.236-0.476,0-0.869-0.529-0.881l-7.525-0.15c-0.529-0.01-0.92-0.45-0.865-0.979L56.182,39.349z"/>\
                            </g>\
                            <path d="M69.432,88.168c-0.484,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.965-3.821l5.5-9.219   c0.787-1.322,2.502-1.753,3.82-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.502,9.219C71.307,87.68,70.383,88.168,69.432,88.168z   "/>\
                            <path d="M40.76,88.168c-0.486,0-0.98-0.127-1.426-0.396c-1.322-0.786-1.756-2.495-0.967-3.821l5.5-9.219   c0.789-1.322,2.502-1.753,3.822-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.502,9.219C42.635,87.68,41.709,88.168,40.76,88.168z   "/>\
                            <path d="M26.424,88.168c-0.486,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.967-3.821l5.502-9.219   c0.789-1.322,2.502-1.753,3.82-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.5,9.219C28.299,87.68,27.375,88.168,26.424,88.168z"/>\
                            <path d="M55.096,88.168c-0.486,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.967-3.821l5.5-9.219   c0.789-1.322,2.504-1.753,3.822-0.968c1.322,0.793,1.754,2.502,0.967,3.824l-5.502,9.219C56.971,87.68,56.047,88.168,55.096,88.168   z"/>\
                        </g>\
                        </svg>',daxue:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.294,18.086C70.503,9.963,61.771,4.94,52.313,4.94c-12.729,0-23.525,8.828-26.107,21.158   c-6.568,2.187-11.324,8.381-11.324,15.676c0,9.11,7.414,16.524,16.525,16.524c3.291,0,6.416-0.946,9.119-2.745   c3.648,1.797,7.689,2.745,11.787,2.745c4.25,0,8.451-1.032,12.205-2.967c3.146,1.938,6.73,2.967,10.492,2.967   c11.088,0,20.107-9.022,20.107-20.11C95.12,27.196,86.251,18.237,75.294,18.086z M75.011,52.721c-3.248,0-6.316-1.048-8.877-3.022   c-1.219-0.941-2.971-0.716-3.91,0.5c-0.02,0.022-0.027,0.049-0.045,0.073c-3.021,1.599-6.42,2.449-9.865,2.449   c-3.654,0-7.254-0.944-10.41-2.742c-0.795-0.45-1.715-0.461-2.492-0.123c-0.445,0.074-0.881,0.248-1.26,0.546   c-1.939,1.518-4.271,2.319-6.744,2.319c-6.037,0-10.951-4.912-10.951-10.946c0-6.041,4.914-10.955,10.951-10.955   c3.047,0,5.98,1.284,8.047,3.526c1.045,1.129,2.809,1.198,3.939,0.153c1.129-1.045,1.201-2.812,0.156-3.938   c-2.941-3.185-7.043-5.088-11.355-5.295c2.717-8.696,10.748-14.754,20.117-14.754c6.689,0,12.93,3.176,16.885,8.44   c-2.639,0.799-5.111,2.119-7.234,3.932c-1.172,1-1.311,2.763-0.311,3.932c1,1.17,2.76,1.313,3.93,0.313   c2.623-2.241,5.973-3.477,9.428-3.477c8.016,0,14.533,6.521,14.533,14.536C89.544,46.204,83.026,52.721,75.011,52.721z"/>\
                    <g>\
                        <g>\
                            <path d="M45.401,65.618c0.529,0.918,0.217,2.09-0.701,2.621l-10.115,5.84c-0.918,0.528-2.09,0.215-2.617-0.703     c-0.529-0.918-0.217-2.088,0.699-2.619l10.117-5.84C43.7,64.387,44.872,64.702,45.401,65.618z"/>\
                        </g>\
                        <g>\
                            <path d="M45.401,73.375c-0.529,0.918-1.701,1.232-2.619,0.703l-10.115-5.84c-0.918-0.531-1.229-1.703-0.701-2.621     c0.529-0.916,1.701-1.229,2.617-0.701l10.117,5.84C45.616,71.288,45.931,72.457,45.401,73.375z"/>\
                        </g>\
                        <g>\
                            <path d="M38.683,77.255c-1.059,0-1.916-0.856-1.916-1.92v-11.68c0-1.059,0.857-1.918,1.916-1.918     s1.918,0.859,1.918,1.918v11.68C40.601,76.398,39.741,77.255,38.683,77.255z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M76.196,65.618c0.529,0.918,0.215,2.09-0.701,2.621l-10.115,5.84c-0.918,0.528-2.09,0.215-2.619-0.701     c-0.529-0.92-0.215-2.09,0.701-2.621l10.115-5.84C74.495,64.387,75.667,64.702,76.196,65.618z"/>\
                        </g>\
                        <g>\
                            <path d="M76.196,73.375c-0.529,0.918-1.701,1.232-2.617,0.703l-10.117-5.84c-0.916-0.531-1.23-1.703-0.701-2.621     c0.529-0.916,1.701-1.229,2.619-0.701l10.115,5.84C76.411,71.288,76.726,72.457,76.196,73.375z"/>\
                        </g>\
                        <g>\
                            <path d="M69.479,77.255c-1.061,0-1.916-0.856-1.916-1.92v-11.68c0-1.059,0.855-1.918,1.916-1.918     c1.059,0,1.916,0.859,1.916,1.918v11.68C71.396,76.398,70.538,77.255,69.479,77.255z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M60.798,79.425c0.529,0.916,0.217,2.089-0.701,2.615l-10.115,5.842c-0.916,0.527-2.088,0.218-2.619-0.7     c-0.529-0.916-0.215-2.091,0.703-2.619l10.115-5.839C59.097,78.192,60.269,78.505,60.798,79.425z"/>\
                        </g>\
                        <g>\
                            <path d="M60.798,87.182c-0.527,0.918-1.701,1.229-2.617,0.7l-10.115-5.84c-0.918-0.528-1.232-1.701-0.703-2.617     c0.531-0.919,1.703-1.233,2.619-0.702l10.117,5.839C61.013,85.091,61.327,86.266,60.798,87.182z"/>\
                        </g>\
                        <g>\
                            <path d="M54.079,91.06c-1.059,0-1.916-0.857-1.916-1.916V77.462c0-1.059,0.857-1.916,1.916-1.916     c1.061,0,1.918,0.857,1.918,1.916v11.682C55.997,90.202,55.138,91.06,54.079,91.06z"/>\
                        </g>\
                    </g>\
                </g>\
                </svg>',yujiaxue:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <path d="M60.281,85.717c0,3.082-2.5,5.582-5.582,5.582c-3.084,0-5.584-2.5-5.584-5.582s5.584-11.406,5.584-11.406   S60.281,82.635,60.281,85.717z"/>\
                        <path d="M75.291,17.851C70.5,9.728,61.766,4.701,52.311,4.701c-12.727,0-23.525,8.832-26.107,21.16   c-6.568,2.187-11.322,8.381-11.322,15.674c0,9.115,7.414,16.525,16.525,16.525c3.289,0,6.414-0.944,9.117-2.74   c3.648,1.796,7.691,2.74,11.787,2.74c4.252,0,8.451-1.028,12.205-2.964c3.15,1.939,6.734,2.964,10.494,2.964   c11.088,0,20.109-9.021,20.109-20.107C95.117,26.961,86.248,18.004,75.291,17.851z M75.006,52.488   c-3.246,0-6.316-1.048-8.877-3.025c-1.219-0.94-2.969-0.717-3.91,0.5c-0.018,0.022-0.029,0.049-0.045,0.074   c-3.02,1.598-6.42,2.451-9.865,2.451c-3.656,0-7.256-0.949-10.412-2.742c-0.795-0.453-1.713-0.463-2.492-0.123   c-0.441,0.074-0.879,0.246-1.258,0.543c-1.939,1.521-4.27,2.322-6.744,2.322c-6.037,0-10.951-4.913-10.951-10.954   c0-6.037,4.914-10.948,10.951-10.948c3.047,0,5.98,1.284,8.049,3.522c1.043,1.131,2.809,1.201,3.939,0.156   c1.131-1.045,1.201-2.81,0.158-3.938c-2.941-3.184-7.043-5.086-11.355-5.297c2.717-8.694,10.746-14.752,20.117-14.752   c6.689,0,12.928,3.176,16.883,8.441c-2.639,0.799-5.109,2.119-7.232,3.932c-1.17,1.002-1.311,2.76-0.311,3.928   c1,1.175,2.76,1.313,3.93,0.313c2.623-2.24,5.971-3.473,9.428-3.473c8.014,0,14.535,6.521,14.535,14.534   C89.543,45.969,83.021,52.488,75.006,52.488z"/>\
                        <g>\
                            <g>\
                                <path d="M45.396,65.385c0.531,0.916,0.215,2.088-0.701,2.617L34.58,73.844c-0.918,0.529-2.09,0.213-2.619-0.7     c-0.529-0.918-0.215-2.091,0.701-2.621l10.115-5.838C43.695,64.154,44.869,64.469,45.396,65.385z"/>\
                            </g>\
                            <g>\
                                <path d="M45.396,73.142c-0.529,0.913-1.701,1.229-2.619,0.7L32.662,68c-0.916-0.529-1.23-1.701-0.701-2.617     s1.701-1.229,2.617-0.701l10.117,5.839C45.611,71.053,45.928,72.223,45.396,73.142z"/>\
                            </g>\
                            <g>\
                                <path d="M38.68,77.021c-1.061,0-1.918-0.858-1.918-1.918V63.42c0-1.057,0.857-1.918,1.918-1.918     c1.059,0,1.916,0.861,1.916,1.918v11.683C40.596,76.162,39.738,77.021,38.68,77.021z"/>\
                            </g>\
                        </g>\
                        <g>\
                            <g>\
                                <path d="M76.191,65.383c0.531,0.918,0.217,2.09-0.699,2.619l-10.117,5.842c-0.918,0.529-2.09,0.213-2.619-0.7     c-0.529-0.918-0.215-2.091,0.701-2.621l10.117-5.838C74.492,64.154,75.666,64.469,76.191,65.383z"/>\
                            </g>\
                            <g>\
                                <path d="M76.193,73.142c-0.529,0.913-1.701,1.229-2.617,0.7L63.459,68c-0.918-0.529-1.23-1.701-0.703-2.617     c0.529-0.916,1.701-1.229,2.619-0.701l10.117,5.839C76.408,71.053,76.723,72.223,76.193,73.142z"/>\
                            </g>\
                            <g>\
                                <path d="M69.475,77.021c-1.061,0-1.916-0.858-1.916-1.918V63.42c0-1.057,0.855-1.918,1.916-1.918     s1.918,0.861,1.918,1.918v11.683C71.393,76.162,70.535,77.021,69.475,77.021z"/>\
                            </g>\
                        </g>\
                    </g>\
                    </svg>',leizhenyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M44.017,83.052c0,3.084-2.5,5.582-5.582,5.582c-3.084,0-5.582-2.498-5.582-5.582   c0-3.085,5.582-11.407,5.582-11.407S44.017,79.967,44.017,83.052z"/>\
                    <path d="M61.212,83.052c0,3.084-2.5,5.582-5.584,5.582c-3.082,0-5.582-2.498-5.582-5.582   c0-3.085,5.582-11.407,5.582-11.407S61.212,79.967,61.212,83.052z"/>\
                    <path d="M78.733,83.052c0,3.084-2.498,5.582-5.58,5.582c-3.084,0-5.584-2.498-5.584-5.582   c0-3.085,5.584-11.407,5.584-11.407S78.733,79.967,78.733,83.052z"/>\
                    <g>\
                        <g>\
                            <path d="M48.616,38.884c0.053-0.528-0.09-0.569-0.32-0.091l-9.371,19.436c-0.23,0.479,0.016,0.869,0.545,0.869     h6.012c0.531,0,0.936,0.435,0.896,0.963l-1,14.336c-0.035,0.528,0.129,0.573,0.367,0.102l10.477-20.775     c0.238-0.474,0-0.869-0.529-0.881l-7.523-0.15c-0.529-0.011-0.92-0.449-0.865-0.979L48.616,38.884z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M48.616,38.884c0.053-0.528-0.09-0.569-0.32-0.091l-9.371,19.436c-0.23,0.479,0.016,0.869,0.545,0.869    h6.012c0.531,0,0.936,0.435,0.896,0.963l-1,14.336c-0.035,0.528,0.129,0.573,0.367,0.102l10.477-20.775    c0.238-0.474,0-0.869-0.529-0.881l-7.523-0.15c-0.529-0.011-0.92-0.449-0.865-0.979L48.616,38.884z"/>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M68.927,38.884c0.055-0.528-0.092-0.569-0.32-0.091l-9.373,19.436c-0.23,0.479,0.016,0.869,0.545,0.869     h6.012c0.531,0,0.936,0.435,0.898,0.963l-1,14.336c-0.037,0.528,0.127,0.573,0.367,0.102L76.53,53.723     c0.238-0.474,0-0.869-0.531-0.881l-7.523-0.15c-0.531-0.011-0.92-0.449-0.865-0.979L68.927,38.884z"/>\
                        </g>\
                        <g>\
                            <path d="M95.118,40.618c0-10.994-8.869-19.951-19.826-20.104c-4.791-8.123-13.523-13.148-22.98-13.148     c-12.727,0-23.523,8.834-26.105,21.157c-6.57,2.189-11.324,8.386-11.324,15.679c0,9.11,7.414,16.521,16.523,16.521     c1.021,0,2.023-0.098,3.008-0.273c-0.52-1.365-0.461-2.908,0.207-4.295l0.863-1.793c-1.283,0.514-2.654,0.788-4.078,0.788     c-6.039,0-10.949-4.911-10.949-10.948c0-6.041,4.91-10.953,10.949-10.953c3.045,0,5.98,1.285,8.049,3.524     c1.043,1.132,2.809,1.199,3.938,0.154c1.131-1.045,1.201-2.807,0.156-3.938c-2.941-3.184-7.043-5.086-11.354-5.293     c2.717-8.699,10.746-14.754,20.117-14.754c6.689,0,12.928,3.176,16.885,8.442c-2.641,0.797-5.111,2.115-7.236,3.928     c-1.17,1.002-1.309,2.761-0.309,3.933c1,1.17,2.76,1.311,3.93,0.311c2.623-2.242,5.973-3.475,9.428-3.475     c8.016,0,14.533,6.521,14.533,14.537c0,5.723-3.336,10.674-8.156,13.041c-0.041,0.752-0.23,1.506-0.588,2.213l-2.289,4.543     C87.935,58.754,95.118,50.512,95.118,40.618z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M68.927,38.884c0.055-0.528-0.092-0.569-0.32-0.091l-9.373,19.436c-0.23,0.479,0.016,0.869,0.545,0.869    h6.012c0.531,0,0.936,0.435,0.898,0.963l-1,14.336c-0.037,0.528,0.127,0.573,0.367,0.102L76.53,53.723    c0.238-0.474,0-0.869-0.531-0.881l-7.523-0.15c-0.531-0.011-0.92-0.449-0.865-0.979L68.927,38.884z"/>\
                    </g>\
                </g>\
                </svg>',ye_yin:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M77.502,43.357c-5.789-9.226-3.951-21.271,3.67-29.865c-2.723,0.771-5.41,1.939-7.963,3.545   C65.748,21.723,61.068,29,59.826,36.529c-4.893-4.662-11.439-7.381-18.389-7.381c-12.727,0-23.525,8.832-26.105,21.161   C8.764,52.496,4.008,58.689,4.008,65.982c0,9.109,7.414,16.525,16.525,16.525c3.287,0,6.416-0.949,9.117-2.744   c3.648,1.793,7.691,2.744,11.787,2.744c4.252,0,8.451-1.031,12.205-2.967c3.15,1.938,6.734,2.967,10.492,2.967   c10.787,0,19.611-8.535,20.088-19.205c5.082-0.135,10.33-1.639,15.113-4.643c2.555-1.604,4.775-3.51,6.656-5.631   C94.941,56.162,83.291,52.578,77.502,43.357z M64.137,76.932c-3.246,0-6.314-1.047-8.877-3.021c-1.219-0.943-2.969-0.717-3.91,0.5   c-0.018,0.021-0.025,0.049-0.043,0.068c-3.02,1.604-6.422,2.453-9.867,2.453c-3.654,0-7.256-0.945-10.41-2.74   c-0.795-0.451-1.713-0.459-2.488-0.123c-0.445,0.072-0.881,0.248-1.262,0.545c-1.941,1.518-4.273,2.318-6.744,2.318   c-6.037,0-10.949-4.91-10.949-10.949c0-6.037,4.912-10.949,10.949-10.949c3.047,0,5.979,1.283,8.049,3.521   c1.045,1.129,2.809,1.201,3.938,0.156s1.201-2.809,0.156-3.939c-2.943-3.184-7.045-5.086-11.354-5.297   c2.717-8.693,10.746-14.754,20.115-14.754c6.691,0,12.93,3.177,16.887,8.441c-2.639,0.799-5.109,2.117-7.234,3.932   c-1.17,1-1.313,2.758-0.313,3.93c0.998,1.172,2.758,1.311,3.932,0.313c2.625-2.24,5.973-3.475,9.428-3.475   c8.016,0,14.535,6.521,14.535,14.534C78.672,70.412,72.15,76.932,64.137,76.932z"/>\
                    <polygon points="91.719,25.223 95.803,23.078 95.021,27.626 98.326,30.843 93.762,31.509 91.719,35.648    89.676,31.509 85.109,30.843 88.412,27.626 87.635,23.078  "/>\
                    <polygon points="52.994,19.479 55.869,17.97 55.32,21.171 57.648,23.441 54.432,23.908 52.994,26.824    51.555,23.908 48.338,23.441 50.664,21.171 50.117,17.97  "/>\
                </g>\
                </svg>',ye_qing:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <polygon points="64.13,36.086 68.216,33.936 67.435,38.487 70.739,41.709 66.173,42.369 64.13,46.507    62.087,42.369 57.522,41.709 60.825,38.487 60.046,33.936  "/>\
                        <polygon points="68.909,51.216 71.786,49.707 71.237,52.91 73.565,55.179 70.347,55.645 68.909,58.559    67.472,55.645 64.253,55.179 66.581,52.91 66.032,49.707  "/>\
                        <g>\
                            <path d="M61.856,77.953c-0.002,0-0.002,0-0.002,0c-11.102-0.002-21.279-5.582-27.236-14.936    c-4.629-7.266-6.15-15.896-4.283-24.311c1.865-8.414,6.896-15.594,14.162-20.224c0.977-0.623,2.24-0.575,3.17,0.119    c0.928,0.697,1.328,1.896,1.004,3.011c-0.043,0.15-4.369,15.786,4.723,29.371c8.965,13.393,24.672,16.801,24.828,16.83    c1.109,0.23,1.973,1.111,2.176,2.229c0.203,1.115-0.285,2.246-1.242,2.854C73.962,76.203,67.981,77.953,61.856,77.953z     M42.101,27.705c-3.113,3.405-5.299,7.582-6.324,12.209c-1.543,6.959-0.285,14.102,3.545,20.109    c4.926,7.734,13.35,12.352,22.533,12.352c0,0,0,0,0.002,0c2.838,0,5.639-0.453,8.309-1.332    c-6.154-2.521-15.107-7.549-21.402-16.953C42.384,44.563,41.64,34.421,42.101,27.705z"/>\
                        </g>\
                    </g>\
                    </svg>'};function ModalRealtimeWeather(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimeWeather.prototype=Object.create(ModalBase.prototype);ModalRealtimeWeather.prototype.constructor=ModalRealtimeWeather;ModalRealtimeWeather.prototype.optionTemplate={name:'toolBox.modal.REALTIME_WEATHER',parent:0,mode:['realTimeWeather'],maxNum:0,title:'',minHeight:1,minWidth:2,maxHeight:3,maxWidth:6,type:'ModalRealtimeWeather'};ModalRealtimeWeather.prototype.modalInit=function(){var _this2=this;!this.entity.modal.option&&(this.entity.modal.option={});var configModalOpt={area:[{type:'option',widget:[{type:'select',opt:{option:[{val:'degreesCelsius',name:'摄氏度'},{val:'degreesFahrenheit',name:'华氏度'}],data:{val:this.entity.modal.option?this.entity.modal.option.tempUnit:'degreesCelsius'}}}]},{data:[{type:'point',name:'数据点位',data:this.entity.modal.points?this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points:[]}],module:"dsDrag",style:".divDsWorkspace .spVarLabel {font-size: 14px;background-color: white; }.divDsWorkspace .btnChartCog {background: white;}"},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]}],header:{needBtnClose:true,title:"配置"},result:{func:function func(data){!_this2.entity.modal.option&&(_this2.entity.modal.option={});_this2.entity.modal.points=data.points[0];_this2.entity.modal.option.tempUnit=data.select.val;_this2.entity.modal.interval=5;_this2.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};ModalRealtimeWeather.prototype.setModalOption=function(option){this.entity.modal.option.tempUnit=option&&option.tempUnit?option.tempUnit:'degreesCelsius';this.entity.modal.interval=5;};ModalRealtimeWeather.prototype.updateModal=function(result){console.log(result);if(!result||!result[0]||!result[0].data)return;var tempDare=JSON.parse(result[0].data);this.renderWeatherStatus(tempDare);};ModalRealtimeWeather.prototype.renderModal=function(){var _this=this;var options=this.entity.modal.option;var weatherImg=weatherImgs['qing'];var html='<style>\n                        #weatherWrap{\n                            width: 100%;\n                            height: 100%;\n                            animation: appear 500ms ease-out forwards;\n                        }\n                        @keyframes appear{\n\t\t\t                0% {\n\t\t\t                    -webkit-transform: scale(0);\n\t\t\t                    transform: scale(0);\n\t\t\t                }\n\t\t\t                50% {\n\t\t\t                    -webkit-transform: scale(1.05);\n\t\t\t                    transform: scale(1.05);\n\t\t\t                }\n\n\t\t\t                75% {\n\t\t\t                    -webkit-transform: scale(0.95);\n\t\t\t                    transform: scale(0.95);\n\t\t\t                }\n\t\t\t                100% {\n\t\t\t                    -webkit-transform: scale(1);\n\t\t\t                    transform: scale(1);\n\t\t\t                }\n                        }\n                        #imgWrap{\n                            width: 50%;\n                            height: 100%;\n                            float: left;\n                        }\n                        #imgWrap svg{\n                            fill: #eee;\n                            float: right;\n                            width: 80%;\n                            height: 80%;\n                        }\n                        #tempWrap{\n                            width: 50%;\n                            height: 100%;\n                            float: left;\n                        }\n                        #tempWrap>div{\n                            height: 50%;\n                            width: 100%;\n                            padding-left: 10%;\n                            color: #eee;\n                            font-weight: bolder;\n                            text-align: left;\n                        }\n                        #tempWrap>div>div{\n                            height: 50%;\n                            width: 100%;\n                            padding-left: 10%;\n                            color: #eee;\n                            font-weight: bolder;\n                            text-align: left;\n                        }\n                    </style>\n                    <div id="weatherWrap">\n                        <div id="imgWrap">\n                                '+weatherImg+'\n                        </div>\n\t                    <div id="tempWrap">\n\t\t                    <div id="temp"></div>\n\t\t                    <div id="humidity"></div>\n\t                    </div>\n                    </div>';this.container.innerHTML=html;this.resize();};ModalRealtimeWeather.prototype.resize=function(){var $container=$(this.container);var height=$('#tempWrap',$container).height(),width=$('#tempWrap',$container).width();var svgHeight,svgWidth;svgHeight=svgWidth=Math.min(height,width)*0.8;$container.find('#imgWrap').siblings('#tempWrap').find('#temp').css({'line-height':height*0.75+'px','font-size':height/8}).siblings('#humidity').css({'line-height':height/4+'px','font-size':height/8});$('svg',$container).css({'height':svgHeight+'px','width':svgWidth+'px','margin-top':(height-svgHeight)/2+'px'});};ModalRealtimeWeather.prototype.renderWeatherStatus=function(rslt){if(rslt&&rslt.tmp){var temp=rslt.tmp,humidity=rslt.hum,weather=rslt.cond.txt.replace(' ',''),weatherImg,weatherType;switch(weather){case'阴':case'Overcast':weatherType='yin';break;case'大雨':case'HeavyRain':weatherType='dayu';break;case'暴雨':case'Storm':weatherType='baoyu';break;case'多云':case'Cloudy':weatherType='duoyun';break;case'小雨':case'LightRain':weatherType='xiaoyu';break;case'晴转多云':case'PartlyCloudy':weatherType='qing_duoyun';break;case'晴':case'Sunny':weatherType='qing';break;case'阵雨':case'ShowerRain':weatherType='duoyun_zhenyu';break;case'打雷':case'Thundershower':weatherType='dalei';break;case'打雷暴雨':case'HeavyThunderstorm':weatherType='dalei_baoyu';break;case'大雪':case'HeavySnow':weatherType='daxue';break;case'雨夹雪':case'Sleet':weatherType='yujiaxue';break;case'雷阵雨':case'Thundershower':weatherType='leizhenyu';break;default:weatherType='qing';}
weatherImg=weatherImgs[weatherType];$(this.container).find('#imgWrap').html(weatherImg).siblings('#tempWrap').find('#temp').html(temp+(this.entity.modal.option.tempUnit=='degreesFahrenheit'?'℉':'℃')).siblings('#humidity').html(humidity+'%');this.resize();}};ModalRealtimeWeather.prototype.showConfigMode=function(){};return ModalRealtimeWeather;}();var ModalCumulantChart=function(){function ModalCumulantChart(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalCumulantChart.prototype=new ModalBase();ModalCumulantChart.prototype.optionTemplate={name:'toolBox.modal.CUMULANT_CHART',parent:0,mode:'custom',maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalCumulantChart',scroll:false,needRefresh:false};ModalCumulantChart.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"module":'timeConfig'},{'type':'option',widget:[{type:'select',name:'图表类型',id:'chartType',opt:{attr:{class:'form-inline'},option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]}},{type:'checkbox',name:'启用堆叠',id:'isStack',opt:{}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],"result":{}};ModalCumulantChart.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){this.entity.modal.option.dsItemIds instanceof Array&&(this.configModalOpt.area[2].data[0].data=this.entity.modal.option.dsItemIds);this.entity.modal.option.chartType&&(this.configModalOpt.area[1].widget[0].data={val:this.entity.modal.option.chartType});this.entity.modal.option.isStack&&(this.configModalOpt.area[1].widget[1].data=this.entity.modal.option.isStack);this.entity.modal.option.timeStart&&this.entity.modal.option.timeEnd&&(this.configModalOpt.area[0].data={mode:'1',date:{startTime:this.entity.modal.option.timeStart,endTime:this.entity.modal.option.timeEnd},format:this.entity.modal.option.timeFormat});}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();};};ModalCumulantChart.prototype.optionDefault={};ModalCumulantChart.prototype.renderModal=function(){var postData={timeStart:this.entity.modal.option.timeStart,timeEnd:this.entity.modal.option.timeEnd,timeFormat:this.entity.modal.option.timeFormat,dsItemIds:this.entity.modal.option.dsItemIds};var _this=this;WebAPI.post('/analysis/startWorkspaceDataGenHistogram/increment',postData).done(function(result){var arrLegend=_this.entity.modal.option.dsItemIds.map(function(point){var point=AppConfig.datasource.getDSItemById(point);return point.alias?point.alias:point.value;});var arrSeries=[];for(var i=0;i<result.list.length;i++){arrSeries.push({name:arrLegend[i],type:_this.entity.modal.option.chartType,areaStyle:{normal:{}},stack:_this.entity.modal.option.isStack,data:result.list[i].data.map(function(data){var val=parseFloat(data);if(!isNaN(val)){return val.toFixed(2);}else{return 0;}})});}
var opt={text:'历史累积量折线图',legend:{data:arrLegend,top:10},grid:{left:40,right:20,top:35},tooltip:{trigger:'axis'},toolbox:{showTitle:true,feature:{magicType:{type:['line','bar','stack','tiled']}}},xAxis:{data:result.timeShaft.slice(1),type:'category',axisLabel:{formatter:function formatter(value,index){var date=new Date(value);var texts;if(index===0){texts=date.format('yyyy-MM-dd')+'\n'+date.format('HH:mm:ss');}else{var preDate=new Date(result.timeShaft[index-1]);if(preDate.format('yyyy-MM-dd')==date.format('yyyy-MM-dd')){texts=date.format('HH:mm:ss');}else{texts=date.format('yyyy-MM-dd')+'\n'+date.format('HH:mm:ss');}}
return texts;}}},yAxis:[{type:'value'}],series:arrSeries};var chart=echarts.init(_this.container,AppConfig.chartTheme);chart.setOption(opt);_this.spinner.stop();});};ModalCumulantChart.prototype.updateModal=function(points){};ModalCumulantChart.prototype.showConfigMode=function(){};ModalCumulantChart.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.points=[];this.entity.modal.option={timeStart:option.startTime,timeEnd:option.endTime,timeFormat:option.format,dsItemIds:option.points[0],isStack:option.isStack?1:0,chartType:option.chartType.val};};ModalCumulantChart.prototype.goBackTrace=function(data){};return ModalCumulantChart;}();var ModalReportFactory=function(FacReportScreen){function ModalReportFactory(screen,entityParams,configModalOpt){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode,configModalOpt);this.reportList=[];this.getReportWrap();};ModalReportFactory.prototype=new ModalBase();ModalReportFactory.prototype.optionTemplate={name:'toolBox.modal.REPORT_CHAPTER',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalReportFactory'};ModalReportFactory.prototype.show=function(){this.init();};ModalReportFactory.prototype.init=function(){};ModalReportFactory.prototype.renderModal=function(e){var _this=this;var arr=this.entity.modal.option.arrReport;var domWrap=this.container;domWrap.style.overflowY='auto';domWrap.innerHTML='';arr.forEach(function(row){var container=document.createElement('div');container.style.width='100%';container.style.position='relative';domWrap.appendChild(container);namespace('api.report').renderReport(container,row.pageId,row.chapterId,{onlySummary:row.isSummary===1}).done(function(){var a=document.createElement('a');a.href='/factory/preview/report/'+row.pageId+'/'+AppConfig.isFactory+'?projectId='+AppConfig.projectId;a.innerText='查看更多';a.target="_blank";if(container.offsetHeight>20){a.style.position='absolute';a.style.bottom='20px';a.style.left='35px';}else{a.style.marginTop='10px';a.style.marginBottom='30px';a.style.marginLeft='35px';a.style.color='#fff';}
a.className='btn btn-primary';container.appendChild(a);var reportName,report,date,title;for(var i=0,l=_this.reportList.length;i<l;i++){if(row.pageId===_this.reportList[i].reportId){report=_this.reportList[i];break;}}
if(report){reportName=report.reportName;if(report.period==='day'){date=new Date().format('MM月dd日');}else if(report.period==='month'){date=new Date().format('MM月');}
title=document.createElement('h4');title.style.marginLeft='35px';title.innerText=reportName+'-'+date;$(container).prepend(title);}});});this.spinner&&_this.spinner.stop();};ModalReportFactory.prototype.showConfigMode=function(){};ModalReportFactory.prototype.updateModal=function(points){};ModalReportFactory.prototype.setModalOption=function(option){};ModalReportFactory.prototype.getReportWrap=function(){var _this=this,projectId;_this.reportList=[];if(AppConfig.project&&AppConfig.project.id){projectId=AppConfig.project.id;}else if(this.entity.modal.option.facProjectId){projectId=this.entity.modal.option.facProjectId;}
if(!projectId){return;}
WebAPI.get('/factory/getFirstLevelReports/'+projectId).done(function(result){if(!result.data||result.data.length==0)return;result.data.forEach(function(item){if(item.list&&item.list.length>0){item.list.forEach(function(report){_this.reportList.push(report);});}});});};ModalReportFactory.prototype.modalDialog='\
                <style>.btnRemove{height: 34px;line-height: 34px;font-size: 16px;}</style>\
                <div style="position: absolute;top: 0;right: 10px;z-index: 1;padding: 15px 10px;font-size: 24px;">\
                    <span class="glyphicon glyphicon-plus-sign" id="btnAddSummary"></span>\
                </div>\
                <div class="row" style="margin-bottom: 15px;"><div class="col-xs-4 col-xs-offset-1"><input class="form-control" id="title" type="text" placeholder="标题"/></div></div>';ModalReportFactory.prototype.showConfigModal=function(){var _this=this;this.configModal=new ConfigModal(this.configModalOptDefault,this.screen.container,this);this.configModal.init();this.configModal.modalBody.innerHTML=this.modalDialog;this.attachEvents();if(this.entity.modal.option&&this.entity.modal.option.arrReport){this.entity.modal.option.arrReport.forEach(function(report){_this.createItem(report);});}else{$('#btnAddSummary',this.configModal.modal).click();}
if(this.entity.modal.title){$('#title',this.configModal.modal).val(this.entity.modal.title);}
this.configModal.show();};ModalReportFactory.prototype.attachEvents=function(){var _this=this;$('#btnAddSummary',this.configModal.modal).off('click').on('click',function(){_this.createItem();});$('.btnConfirm',this.configModal.modal).off('click').on('click',function(){var title=$('#title',_this.configModal.modal).val();_this.configModal.hide();if(!_this.entity.modal.option)_this.entity.modal.option={};if(!_this.entity.modal.option.arrReport)_this.entity.modal.option.arrReport=[];var arrParams=[];$('.summaryRow',_this.configModal.modal).each(function(){arrParams.push({pageId:$(this).find('.pageList').val(),isSummary:$(this).find('.isSummary').prop('checked')?1:0});});_this.entity.modal.option.arrReport=arrParams;_this.entity.modal.option.facProjectId=AppConfig.project.id;_this.entity.modal.title=title;_this.render();});};ModalReportFactory.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalReportFactory.prototype.getChapterListByReportId=function(reportId){return WebAPI.get("/spring/get/"+reportId+'/'+AppConfig.isFactory).then(function(rs){var list=[];var data=rs.layout;var layouts=rs.layout[0];var layout,modal,path=[1];while(layout=layouts.shift()){modal=layout.modal;if(layout==='end'){path.pop();path[path.length-1]+=1;continue;}
if(modal.type==='ReportContainer'){list.push({name:'全部',value:layout.id});layouts.unshift('end');layouts=modal.option.layouts.concat(layouts);}else if(modal.type==='ChapterContainer'){list.push({name:'第'+path.join('.')+'章 - '+(modal.option.chapterTitle||'未命名'),value:layout.id});layouts.unshift('end');layouts=modal.option.layouts.concat(layouts);path.push(1);}}
return list;});};ModalReportFactory.prototype.initOption=function($row,report){var _this=this;var strHtml='';var $pageList=$('.pageList',$row),$isSummary=$('.isSummary',$row);if(!report){report={};}
if(report.isSummary==0){$isSummary.prop('checked',false);}
if(this.reportList&&this.reportList.length>0){this.reportList.forEach(function(item){strHtml+='<option value="'+item.reportId+'">'+item.reportName+'</option>';});$pageList.append(strHtml);setValue($pageList,report.pageId);}
$pageList.change(function(){var pageVal=this.value;var $typeList=$(this).closest('.row').find('.typeList');$typeList.children().hide();$typeList.children('[parent-id="'+pageVal+'"]').show();$typeList.val($typeList.children('[parent-id="'+pageVal+'"]:eq(0)').val());});$('.btnRemove',$row).off('click').on('click',function(){for(var i=0,l=_this.entity.modal.option.arrReport.length;i<l;i++){if(_this.entity.modal.option.arrReport[i].pageId===report.pageId){_this.entity.modal.option.arrReport.splice(i,1);break;}}
$(this).closest('.summaryRow').remove();});function setValue($select,val){if(!!val){$select.val(val);}}};ModalReportFactory.prototype.createItem=function(report){$('.modal-body',this.configModal.modal).append('<div class="row summaryRow" style="margin-bottom: 15px;">\
            <div class="col-xs-4 col-xs-offset-1">\
                <select class="form-control pageList"></select>\
            </div>\
            <div class="col-xs-4">\
                <label class="checkbox-inline form-control" style="border: none;box-shadow: none;"> <input type="checkbox" class="isSummary" checked disabled> 仅显示摘要 </label>\
            </div>\
            <div class="col-xs-2">\
                <span class="glyphicon glyphicon-remove-sign btnRemove"></span>\
            </div>\
        </div>');this.initOption($('.modal-body .summaryRow',this.configModal.modal).last(),report);};return ModalReportFactory;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(beop){var configMap={htmlURL:'/static/views/workflow/memberSelected.v2.html',htmlTemplateId:'#wf-memberSelected-container',settable_map:{cb_dialog_hide:true,cb_dialog_show:true,userHasSelected:true,userMemberMap:true,maxSelected:true,enableDeleteMember:true,enableAddMember:true,maxDelete:true,hasFrame:false,userReadOnly:false},cb_dialog_hide:$.noop,cb_dialog_show:$.noop,userMemberMap:null,userHasSelected:[],maxSelected:null,enableDeleteMember:true,enableAddMember:true,KEY_PY_STORY:'BEOP.WF.PY',maxDelete:null,userReadOnly:false,hasFrame:false},stateMap={usersMap:[],addedUserList:[],userHasSelected:[],userHasSelectedDefault:[],allUserList:[],PYMap:[],selectedClassPrefix:'wf-member-selected',memberSelectedDiff:[],isConfirm:false,userReadOnly:false,hasFrame:false},jqueryMap={},setJqueryMap,configModel,init;var progressResultData,bindEvents,renderCheckedUsers,isPYStored;var filterCheckedUser,searchByFirstName,getPYLocalStorage,getZH_EN,addActiveSearchBtn,setPYMap,searchByInput,showSearchByID,resetData,renderAddedUsers,onClickUser,onClickRemoveUser,removeMember,addMember,isMemberAdded,checkUserSelectedAmount,checkUserDeletedAmount,restoreSearchResult;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$add_user_dialog:$container.find('#wf-add-person'),$wf_check_result:$container.find('.wf-check-result')};jqueryMap.$wf_search_by_firstName_li=jqueryMap.$add_user_dialog.find('.wf-search-result-title ul li');jqueryMap.$wf_search_byInput=jqueryMap.$add_user_dialog.find('#input-search-name');jqueryMap.$wf_search_result=jqueryMap.$add_user_dialog.find('.wf-search-result');jqueryMap.$wf_search_result_list=jqueryMap.$add_user_dialog.find('.wf-member');jqueryMap.$wf_added_user_list=jqueryMap.$add_user_dialog.find('.wf-added-user-list');jqueryMap.$wf_seaych_byInput=jqueryMap.$add_user_dialog.find('#input-search-name');jqueryMap.$wf_close_btn1=jqueryMap.$add_user_dialog.find('.modal-header button');jqueryMap.$wf_search_result_list.removeClass(stateMap.selectedClassPrefix);jqueryMap.$wf_check_result.empty();jqueryMap.$wf_search_byInput.val('');};configModel=function configModel(input_map){beop.util&&beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container,options){if(arguments.length>2){console.warn('人物选择框现在需要1个必选参数$container和一个可选参数来配置configModel');return false;}
if((typeof options==='undefined'?'undefined':_typeof(options))==='object'){var configModel=options.configModel;if((typeof configModel==='undefined'?'undefined':_typeof(configModel))==='object'){for(var key in configModel){if(configModel.hasOwnProperty(key)){configMap[key]=configModel[key];}}
if(!configMap.userHasSelected)configMap.userHasSelected=[];if(!configModel.userMemberMap)configModel.userMemberMap=[];var validUsers=[];for(var i=0;i<configMap.userHasSelected.length;i++){var selectedUser=configMap.userHasSelected[i];if(selectedUser){validUsers.push(selectedUser);}}
configMap.userHasSelected=validUsers;configMap.userHasSelected.forEach(function(item,index,array){if(item){configModel.userMemberMap.forEach(function(members){if(item==members.id||item.id==members.id){array[index]=$.extend(true,{},members);return true;}});}});}else{console.error('调用方式失败,第二个参数的configModel属性不是Object'+arguments[1]);return false;}}
stateMap.userHasSelected=configMap.userHasSelected?configMap.userHasSelected:[];if(!configMap.userMemberMap||Object.prototype.toString.call(configMap.userMemberMap)!=="[object Array]"){console.error('现在人物选择框需要提前预制人员列表');return false;}
Spinner.spin($container.get(0));stateMap.$container=$container;WebAPI.get(configMap.htmlURL+'?='+new Date().getTime().toString(16)).done(function(html){stateMap.$container.append(html);resetData();setJqueryMap();var $title=jqueryMap.$container.find('#wf-add-person .modal-title');if(options&&options.configModel){options.configModel.hasFrame?stateMap.hasFrame=true:stateMap.hasFrame=false;if(options.configModel.userReadOnly){stateMap.userReadOnly=true;$title.attr('i18n','workflow.memberSelected.TITLE1');}}else{stateMap.hasFrame=false;stateMap.userReadOnly=false;$title.attr('i18n','workflow.memberSelected.TITLE');}
progressResultData();}).always(function(){Spinner.stop();}).fail(function(){infoBox.alert('获取人物选择框模板失败！');});};bindEvents=function bindEvents(){jqueryMap.$wf_search_result.off().on('click','.wf-member',onClickUser);jqueryMap.$wf_check_result.off().on('click','.glyphicon-remove',onClickRemoveUser);jqueryMap.$wf_search_by_firstName_li.off().on('click',searchByFirstName);jqueryMap.$wf_seaych_byInput.off().on('keyup',searchByInput);jqueryMap.$wf_comfirm_btn=jqueryMap.$add_user_dialog.find('#wf-member-comfirm-btn');jqueryMap.$wf_comfirm_btn.off().on('click',renderAddedUsers);jqueryMap.$add_user_dialog.off().on('show.bs.modal',function(){restoreSearchResult();stateMap.isConfirm=false;}).on('hidden.bs.modal',function(){if(stateMap.hasFrame){jqueryMap.$wf_check_result.empty().html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.userHasSelectedDefault},document.getElementById("tpl_wf_dialog_added_member").innerHTML));}else{jqueryMap.$wf_check_result.empty().html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.userHasSelectedDefault}));}
jqueryMap.$wf_search_result_list.removeClass(stateMap.selectedClassPrefix);jqueryMap.$wf_search_result_list.each(function(){var $this=$(this);stateMap.userHasSelectedDefault.forEach(function(item){if(item.id==$this.data('user-id')){$this.addClass(stateMap.selectedClassPrefix);}});});[].slice.call(document.querySelectorAll(configMap.htmlTemplateId)).forEach(function(item){item.parentNode.removeChild(item);});});};renderAddedUsers=function renderAddedUsers(){if(stateMap.hasFrame){jqueryMap.$wf_added_user_list.html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.userHasSelectedDefault},document.getElementById("tpl_wf_dialog_added_member").innerHTML));}else{jqueryMap.$wf_added_user_list.html(beopTmpl('tpl_wf_added_member',{members:stateMap.addedUserList}));}
stateMap.userHasSelectedDefault=[];stateMap.addedUserList.forEach(function(item){stateMap.userHasSelectedDefault.push(item);});configMap.cb_dialog_hide(stateMap.addedUserList);jqueryMap.$add_user_dialog.modal('hide');};renderCheckedUsers=function renderCheckedUsers(data){if(!data){data=stateMap.addedUserList;}
if(stateMap.hasFrame){jqueryMap.$wf_check_result.html(beopTmpl('tpl_wf_dialog_added_member',{members:data},document.getElementById("tpl_wf_dialog_added_member").innerHTML));}else{jqueryMap.$wf_check_result.html(beopTmpl('tpl_wf_dialog_added_member',{members:data}));}};progressResultData=function progressResultData(){var addedUserMap={};stateMap.addedUserList=[];stateMap.userHasSelectedDefault=[];stateMap.userHasSelected.forEach(function(item){stateMap.addedUserList.push(item);stateMap.userHasSelectedDefault.push(item);addedUserMap[''+item.id]=item;});stateMap.allUserList=[];configMap.userMemberMap.forEach(function(item){stateMap.allUserList.push(item);});if(stateMap.hasFrame){jqueryMap.$wf_search_result.html(beopTmpl('tpl_wf_member',{members:stateMap.allUserList,addUserMap:addedUserMap},document.getElementById("tpl_wf_member").innerHTML));}else{jqueryMap.$wf_search_result.html(beopTmpl('tpl_wf_member',{members:stateMap.allUserList,addUserMap:addedUserMap}));}
stateMap.allUserList.forEach(function(item){stateMap.usersMap[''+item.id]=item;});I18n.fillArea(stateMap.$container);setPYMap();jqueryMap.$wf_search_result_list=jqueryMap.$add_user_dialog.find('.wf-member');bindEvents();renderCheckedUsers(stateMap.userHasSelectedDefault);restoreSearchResult();Spinner.stop();jqueryMap.$add_user_dialog.modal('show');};restoreSearchResult=function restoreSearchResult(){stateMap.addedUserList=[];stateMap.userHasSelectedDefault.forEach(function(item){stateMap.addedUserList.push(item);});jqueryMap.$wf_search_result_list.show();addActiveSearchBtn(null,2);};setPYMap=function setPYMap(){var PYFormat=new pyFormat(),itemPY={};PYFormat.getPYLocalStorage().done(function(result){stateMap.usersMap.forEach(function(item){if(item.userfullname){itemPY=PYFormat.getPYMap(result.data,item.userfullname.charAt(0))[0];}else{itemPY={id:item.id,key:undefined,pinyin:undefined,acronym:undefined};}
if(item.id&&itemPY){itemPY.id=item.id;}
stateMap.PYMap.push(itemPY);});});PYFormat=null;};showSearchByID=function showSearchByID(result){if(Object.prototype.toString.call(result)!=='[object Array]')return;jqueryMap.$wf_search_result_list.hide();var i;for(i=0;i<result.length;i++){jqueryMap.$wf_search_result_list.each(function(){if($(this).data('user-id')==result[i]){$(this).show();}});}};removeMember=function removeMember(userId){for(var m=0;m<stateMap.addedUserList.length;m++){if(stateMap.addedUserList[m].id==userId){stateMap.addedUserList.splice(m,1);}}};addMember=function addMember(member){if((typeof member==='undefined'?'undefined':_typeof(member))==="object"){if(member.id&&member.userfullname&&member.useremail){!isMemberAdded(member.id)&&stateMap.addedUserList.push(member);}}else{if(stateMap.usersMap[String(member)]){!isMemberAdded(member)&&stateMap.addedUserList.push(stateMap.usersMap[String(member)]);}}
return this;};isMemberAdded=function isMemberAdded(userId){for(var m=0;m<stateMap.addedUserList.length;m++){if(stateMap.addedUserList[m].id==userId){return true;}}
return false;};resetData=function resetData(){stateMap.usersMap=[];stateMap.addedUserList=[];stateMap.allUserList=[];stateMap.PYMap=[];stateMap.memberSelectedDiff=[];stateMap.isConfirm=false;stateMap.userHasSelectedDefault=[];};checkUserSelectedAmount=function checkUserSelectedAmount(){if(configMap.maxSelected){var li=jqueryMap.$wf_check_result.find('li');var length=li.length=='undefined'?0:li.length;if(configMap.maxSelected<=length){return false;}}
return true;};checkUserDeletedAmount=function checkUserDeletedAmount(){if(configMap.maxDelete){var li=jqueryMap.$wf_check_result.find('li');var length=li.length=='undefined'?0:li.length;if(configMap.maxDelete<length){return true;}
return false;}
return true;};onClickUser=function onClickUser(){if(stateMap.userReadOnly){alert(I18n.resource.workflow.memberSelected.INFO_READONLY);return;}
var $this=$(this),selectedClass=stateMap.selectedClassPrefix;var userId=''+$this.data('user-id');if(configMap.maxSelected==1){if(!$this.hasClass(selectedClass)){if(!isMemberAdded(userId)){stateMap.addedUserList=[];addMember(userId);jqueryMap.$wf_search_result_list.removeClass(selectedClass);$this.addClass(selectedClass);}}}else{if(!$this.hasClass(selectedClass)){if(configMap.enableAddMember){if(checkUserSelectedAmount()){if(!isMemberAdded(userId)){addMember(userId);$this.addClass(selectedClass);}}else{Alert.danger(ElScreenContainer,'超过最大选择数量').showAtTop(300);return false;}}else{Alert.danger(ElScreenContainer,'不能添加人物').showAtTop(300);return false;}}else{if(configMap.enableDeleteMember){if(checkUserDeletedAmount()){$this.removeClass(selectedClass);removeMember(userId);}}else{Alert.danger(ElScreenContainer,'不能删除人物').showAtTop(300);return false;}}}
renderCheckedUsers();};onClickRemoveUser=function onClickRemoveUser(){var $this=$(this),userId=$this.data('user-id');if(configMap.enableDeleteMember){if(checkUserDeletedAmount()){$this.parent().remove();removeMember(userId);filterCheckedUser(userId);}}else{Alert.danger(ElScreenContainer,'不能删除已经存在的人物').showAtTop(300);return false;}};searchByFirstName=function searchByFirstName(){var $this=$(this),searchIndex=$this.text(),result=[],key,i;addActiveSearchBtn($this,1);if($this.index()==0){jqueryMap.$wf_search_result_list.show();}else{for(i=0;i<stateMap.PYMap.length;i++){if(stateMap.PYMap[i]&&stateMap.PYMap[i].pinyin&&(stateMap.PYMap[i].pinyin.charAt(0).toLowerCase()==searchIndex||stateMap.PYMap[i].acronym.charAt(0).toLowerCase()==searchIndex)){result.push(stateMap.PYMap[i].id);}}
showSearchByID(result);}};searchByInput=function searchByInput(ev){ev.preventDefault();ev.stopPropagation();var $this=$(this);var value=$.trim($this.val());if(value==''){jqueryMap.$wf_search_result_list.show();addActiveSearchBtn(null,2);}else{var result=[];for(var i=0;i<stateMap.allUserList.length;i++){(function(i){var member=stateMap.allUserList[i];if(member.userfullname.toLowerCase().indexOf(value.toLowerCase())!=-1||member.useremail&&member.useremail.toLowerCase().indexOf(value.toLowerCase())!=-1){result.push(member.id);}})(i);}
showSearchByID(result);}};filterCheckedUser=function filterCheckedUser(userId){jqueryMap.$wf_search_result_list.each(function(){var $this=$(this);if($this.data('user-id')==userId){$this.removeClass(stateMap.selectedClassPrefix);}});};addActiveSearchBtn=function addActiveSearchBtn($which,type){if($which&&type==1){jqueryMap.$wf_search_by_firstName_li.removeClass('active');$which.addClass('active');}else if(type==2){jqueryMap.$wf_search_by_firstName_li.removeClass('active').eq(0).addClass('active');}};beop.view=beop.view||{};beop.view.memberSelectedv2={addMember:addMember,configModel:configModel,init:init,renderCheckedUsers:renderCheckedUsers};})(beop||(beop={}));$.fn.editableTableWidget=function(options){'use strict';return $(this).each(function(){var buildDefaultOptions=function buildDefaultOptions(){var opts=$.extend({},$.fn.editableTableWidget.defaultOptions);opts.editor=opts.editor.clone();return opts;},activeOptions=$.extend(buildDefaultOptions(),options),ARROW_LEFT=37,ARROW_UP=38,ARROW_RIGHT=39,ARROW_DOWN=40,ENTER=13,ESC=27,TAB=9,DELETE=46,CTRL=17,V=86,C=67,X=88,is_CTRL_Down=false,element=$(this),editor=activeOptions.editor.css('position','absolute').hide().appendTo(element.parent()),active,showEditor=function showEditor(select){active=element.find('td:focus');if(active.attr('readonly')){return;}
if(active.length){editor.val(active.text()).removeClass('error').show().offset(active.offset()).css(active.css(activeOptions.cloneProperties)).width(active.width()).height(active.height()).focus();if(select){editor.select();}}},setActiveText=function setActiveText(){var text=editor.val(),evt=$.Event('change'),originalContent;if(active.text()===text||editor.hasClass('error')){return true;}
originalContent=active.html();active.text(text).trigger(evt,text);if(evt.result===false){active.html(originalContent);}},clearActiveText=function clearActiveText(){element.find('td.selected').html('');},movement=function movement(element,keycode){if(keycode===ARROW_RIGHT){return element.next('td');}else if(keycode===ARROW_LEFT){return element.prev('td');}else if(keycode===ARROW_UP){return element.parent().prev().children().eq(element.index());}else if(keycode===ARROW_DOWN){return element.parent().next().children().eq(element.index());}
return[];};editor.blur(function(){setActiveText();editor.hide();}).keydown(function(e){if(e.keyCode===ENTER){setActiveText();editor.hide();active.focus();e.preventDefault();e.stopPropagation();}else if(e.keyCode===ESC){editor.val(active.text());e.preventDefault();e.stopPropagation();editor.hide();active.focus();}else if(e.keyCode===TAB){active.focus();}else if(this.selectionEnd-this.selectionStart===this.value.length){var possibleMove=movement(active,e.keyCode);if(possibleMove.length>0){possibleMove.focus();e.preventDefault();e.stopPropagation();}}}).on('input paste',function(){var evt=$.Event('validate');active.trigger(evt,editor.val());if(evt.result===false){editor.addClass('error');}else{editor.removeClass('error');}});element.on('keypress dblclick',showEditor).css('cursor','pointer').keydown(function(e){var prevent=true,_this=this,possibleMove=movement($(e.target),e.keyCode);if(possibleMove.length>0){possibleMove.focus();}else if(e.keyCode===ENTER){showEditor(false);}else if(is_CTRL_Down&&e.keyCode===V){prevent=false;}else if(is_CTRL_Down&&e.keyCode===C){prevent=false;}else if(is_CTRL_Down&&e.keyCode===X){prevent=false;}else if(e.keyCode===DELETE){clearActiveText();}else{prevent=false;}
if(prevent){e.stopPropagation();e.preventDefault();}});var shouldCopy=true;$(document).off('copy.editableTable').on('copy.editableTable',function(e){if(!element.find('.selected').length){return;}
if(!shouldCopy){shouldCopy=true;return;}
var text='';element.find('td.selected').each(function(index,item){text+=$(item).text()+'\n';});copyToClipboard(text);});$(document).off('cut.editableTable').on('cut.editableTable',function(e){if(!element.find('.selected').length){return;}
if(!shouldCopy){shouldCopy=true;return;}
var text='';element.find('td.selected').each(function(index,item){text+=$(item).text()+'\n';});element.find('td.selected').text('');copyToClipboard(text);});$(document).off('paste.editableTable').on('paste.editableTable',function(e){if(!element.find('.selected').length){return;}
var clipboardData,pastedData,pastedEvent=e.originalEvent;clipboardData=pastedEvent.clipboardData||window.clipboardData;pastedData=clipboardData.getData('text');var pastedDataList=pastedData.split('\n');pastedDataList=removeListEmptyElement(pastedDataList);var selectedTD=element.find('td.selected');if(pastedDataList.length===1){selectedTD.each(function(index,item){$(item).text(pastedDataList[0].trim());});}else{for(var m=0;m<pastedDataList.length;m++){if(!selectedTD.get(m)){continue;}
var $td=$(selectedTD.get(m));$td.text(pastedDataList[m].trim());}}});var removeListEmptyElement=function removeListEmptyElement(list){if(!list||!list.length){return[];}
var newList=[];list.forEach(function(element){if(!!element){newList.push(element);}});return newList;};element.find('td').prop('tabindex',1);element.addClass('editableTableWidget');$(document).keydown(function(e){if(e.keyCode==CTRL)is_CTRL_Down=true;}).keyup(function(e){if(e.keyCode==CTRL)is_CTRL_Down=false;});$(window).on('resize',function(){if(editor.is(':visible')){editor.offset(active.offset()).width(active.width()).height(active.height());}});var allCells=element.find('td');allCells.mousedown(rangeMouseDown).mouseup(rangeMouseUp).mousemove(rangeMouseMove);var dragStart=0;var dragEnd=0;var isDragging=false;var columnNum=element.find('th').length;function rangeMouseDown(e){if(isRightClick(e)){return false;}else{var $this=$(this);dragStart=allCells.index($this);isDragging=true;allCells.removeClass('selected');$this.addClass('selected');document.documentElement.onselectstart=function(){return false;};}}
function rangeMouseUp(e){if(isRightClick(e)){return false;}else{dragEnd=allCells.index($(this));isDragging=false;if(dragEnd!=0){selectRange();}
document.documentElement.onselectstart=function(){return true;};}}
function rangeMouseMove(e){if(isDragging){dragEnd=allCells.index($(this));selectRange();}}
function isSameColumn(start,end){return start%columnNum===end%columnNum;}
function isSameRow(start,end){return Math.floor(start/columnNum)===Math.floor(end/columnNum);}
function makeCellSelected(cell){if(cell){var $cell=$(cell);if(!$cell.attr('readonly')){$cell.addClass('selected');}}}
function selectRange(){allCells.removeClass('selected');var start=0,end=0;if(dragEnd+1<dragStart){start=dragEnd;end=dragStart;}else{start=dragStart;end=dragEnd;}
if(isSameColumn(start,end)){var endCeil=Math.ceil(end/columnNum);for(var c_index=start;c_index<endCeil*columnNum+1;c_index=c_index+columnNum){makeCellSelected(allCells[c_index]);}
return;}
if(isSameRow(start,end)){for(var r_index=start;r_index<end+1;r_index++){makeCellSelected(allCells[r_index]);}
return;}
var minColumn=Math.min(start%columnNum,end%columnNum),maxColumn=Math.max(start%columnNum,end%columnNum),minRow=Math.min(Math.floor(start/columnNum),Math.floor(end/columnNum)),maxRow=Math.max(Math.floor(start/columnNum),Math.floor(end/columnNum));for(var i=minRow;i<maxRow+1;i++){for(var j=minColumn;j<maxColumn+1;j++){makeCellSelected(allCells[i*columnNum+j]);}}}
function isRightClick(e){if(e.keyCode){return e.keyCode==3;}else if(e.button){return e.button==2;}
return false;}
function copyToClipboard(text){if(!text){return;}
var success=true,range=document.createRange(),selection;if(window.clipboardData){window.clipboardData.setData("Text",text);}else{var tmpElem=$('<pre>');tmpElem.css({position:"absolute",left:"-1000px",top:"-1000px"});tmpElem.text(text);$("body").append(tmpElem);range.selectNodeContents(tmpElem.get(0));selection=window.getSelection();selection.removeAllRanges();selection.addRange(range);try{shouldCopy=false;success=document.execCommand("copy",false,null);}catch(e){shouldCopy=true;}
if(success){tmpElem.remove();}}}});};$.fn.editableTableWidget.defaultOptions={cloneProperties:['padding','padding-top','padding-bottom','padding-left','padding-right','text-align','font','font-size','font-family','font-weight','border','border-top','border-bottom','border-left','border-right'],editor:$('<input>')};var PointManager=function(){function PointManager(projectId){this.projectId=projectId;this.$container=null;this.layoutHtmlURL='/static/views/observer/pointManager.html';this.htmlUrl='';this.jqueryMap={};this.stateMap={};}
PointManager.prototype={init:function init(){var _this=this;this.$ElScreenContainer=$(ElScreenContainer);this.$container=this.$ElScreenContainer.find('#dataManagerContainer');if(this.$container.length){return WebAPI.get(this.htmlUrl).done(function(htmlResult){_this.$container.find('.dataManagerContent').html(htmlResult);_this.setJqueryMap();_this.highlightMenu();_this.bindEvents();});}else{return $.when(WebAPI.get(this.layoutHtmlURL),WebAPI.get(this.htmlUrl)).done(function(layoutHtmlResult,contentHtmlResult){_this.$ElScreenContainer.html(layoutHtmlResult[0]);_this.$container=_this.$ElScreenContainer.find('#dataManagerContainer');_this.$container.find('.dataManagerContent').html(contentHtmlResult[0]);_this.setJqueryMap();_this.makeMenu();_this.highlightMenu();_this.bindEvents();I18n.fillArea(_this.$ElScreenContainer);});}},bindEvents:function bindEvents(){},highlightMenu:function highlightMenu(){this.jqueryMap.$menuContainer.find('.page-link').removeClass('active').each(function(index,item){var $item=$(item);if($item.attr('href')===location.hash){$item.addClass('active');}});},makeMenu:function makeMenu(){var _this=this;this.jqueryMap.$menuContainer.find('a').each(function(index,menuItem){var $menuItem=$(menuItem);if($menuItem.closest('#pointManagerCloudPointUl').length){$menuItem.closest('ul').find('a').removeClass('active');$menuItem.closest('a').addClass('active');}else{var href=$menuItem.attr('href');if(/projectId=/.test(href)){href=href.replace(/(projectId=)([^&]?)(&?)/,'$1'+_this.projectId+'$3');$menuItem.attr('href',href);}}});},setJqueryMap:function setJqueryMap(){var $container=this.$container;this.jqueryMap={$container:$container,$pointManagerCloudPointUl:$container.find('#pointManagerCloudPointUl'),$pointManagerCloudPoint:$container.find('.pointManagerCloudPoint'),$menuContainer:$container.find('#dataManagerCloudMenu')};if(this.setPageJqueryMap){this.setPageJqueryMap();}},setPageJqueryMap:function setPageJqueryMap(){},resetData:function resetData(){this.jqueryMap={};this.stateMap={};this.$container=null;this.$ElScreenContainer=null;},close:function close(){this.resetData();this.detachEvents();},detachEvents:function detachEvents(){}};return PointManager;}();var PointManagerRealTimeData=function(){function PointManagerRealTimeData(projectId){PointManager.call(this,projectId);this.htmlUrl='/static/views/observer/pointManagerRealTimeData.html';this.i18=I18n.resource.observer.widgets;this.pointInfoList=[];this.hasMonitoredNameList=[];this.hasMonitoredList=[];this.projectId=projectId;this.currentPage=1;this.pageSizeKey='PointManagerPageSize';this.defaultPageSize=50;this.pointDateStartInstance=null;this.pointDateEndInstance=null;this.filterType={'name':0,'value':1,'range':2,'time':3,'explain':4,'define':5};this.searchModel={filterType:0,isAdvance:false,text:''};this.pointType={mapping:0||null,Algorithm:1,Calculation:2};}
PointManagerRealTimeData.prototype=Object.create(PointManager.prototype);PointManagerRealTimeData.prototype.constructor=PointManagerRealTimeData;var PointManagerRealTimeDataFunc={show:function show(){var _this=this;this.init().done(function(){_this.historyStatusPopover=$('#deleteExpiredData').popover({html:true,placement:'bottom',content:'clear time setting',container:$("#realTimeBtnBox"),template:$('#tpl_real_time_popover').html()});_this.refreshFilter(_this.filterType.name);_this.initProjectPointList();_this.attachEvents();$('#pageSizeSelector').val(_this.getPageSize());});},close:function close(){this.detachEvents();},setFilterSort:function setFilterSort(sortId){switch(sortId){case'0':{this.searchModel.order='pointname asc';break;}
case'1':{this.searchModel.order='pointname desc';break;}
case'2':{this.searchModel.order='pointvalue desc';break;}
case'3':{this.searchModel.order='pointvalue asc';break;}
case'4':{this.searchModel.order='time desc';break;}
case'5':{this.searchModel.order='time asc';break;}
default:{this.searchModel.order=null;}}},setSearchModel:function setSearchModel(){this.currentPage=1;var value;this.searchModel.isRemark=false;if(this.searchModel.filterType==this.filterType.name){value=$('#searchPoint').val().trim();this.searchModel.text=value;}else if(this.searchModel.filterType==this.filterType.value){value=$('#searchPoint').val().trim();if(!value){this.searchModel.text='1 = 1';}else{this.searchModel.text='pointvalue = "'+value+'"';}}else if(this.searchModel.filterType==this.filterType.range){var filterMin=$('#filterMin').val().trim(),filterMax=$('#filterMax').val().trim();if(filterMin===''&&filterMax!==''){this.searchModel.text=' pointvalue <= '+filterMax;}else if(filterMin!==''&&filterMax===''){this.searchModel.text='pointvalue >= '+filterMin;}else{this.searchModel.text='pointvalue >= '+filterMin+' and pointvalue <= '+filterMax;}
this.searchModel.text+=' and pointvalue REGEXP "^[0-9]+\\.?[0-9]*$" ';}else if(this.searchModel.filterType==this.filterType.time){var pointDateStart=$('#pointDateStart').val().trim(),pointDateEnd=$('#pointDateEnd').val().trim();if(pointDateStart===''&&pointDateEnd!==''){this.searchModel.text=' time <= "'+pointDateEnd+'"';}else if(pointDateStart!==''&&pointDateEnd===''){this.searchModel.text='time >= "'+pointDateStart+'"';}else{this.searchModel.text='time >= "'+pointDateStart+'" and time <= "'+pointDateEnd+'"';}}else if(this.searchModel.filterType==this.filterType.explain){this.searchModel.text=$('#searchPoint').val().trim();this.searchModel.isRemark=true;}},attachEvents:function attachEvents(){var _this=this;var $divPointsList=$('#divPointsList'),$filterDefineWin=$('#filterDefineWin');$(".pointList").on('click','tbody tr',function(){$(this).toggleClass('active');}).on('click','tbody tr .data-manager-star',function(e){var $this=$(this);var pointName=$this.closest('tr').data('point');if($this.hasClass('glyphicon-star-empty')){_this.addHasMonitoredNameList(pointName);WebAPI.post('/admin/dataManager/update/',{userId:AppConfig.userId,projectId:_this.projectId,points:_this.hasMonitoredNameList.join(',')}).done(function(result){if(result.success==true){$this.removeClass('glyphicon-star-empty').addClass('glyphicon-star');}else{console.log('error :',result.msg);}});}else{_this.deleteHasMonitoredNameList(pointName);WebAPI.post('/admin/dataManager/update/',{userId:AppConfig.userId,projectId:_this.projectId,points:_this.hasMonitoredNameList.join(',')}).done(function(result){if(result.success==true){$this.removeClass('glyphicon-star').addClass('glyphicon-star-empty');}else{console.log('error :',result.msg);}});}
e.stopPropagation();});$('#deleteExpiredData').click(function(){var startTime=$("#expiredDataStartTime").datetime({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii'});var endTime=$("#expiredDataEndTime").datetime({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii'});I18n.fillArea($(".realTimePopover"));});$(document).on("click.hideExpiredTimeBox",function(e){var $target=$(e.target);if(!$target.closest("#deleteExpiredData").length&&!$target.closest(".popover").length){if(_this.historyStatusPopover.data("bs.popover")){_this.historyStatusPopover.data("bs.popover").inState.click=false;}
_this.historyStatusPopover.popover('hide');}});$('#realTimeBtnBox').on('click','#expiredDataConfirm',function(){var startTimeVal;var endTimeVal=new Date($('#expiredDataEndTime').val().trim()).format('yyyy-MM-dd HH:mm:59');if(!$('#expiredDataEndTime').val().trim()){alert('The end time can\'t be empty.');return;}else if(new Date()<new Date(endTimeVal)||/[a-zA-Z]/.test($('#expiredDataEndTime').val().trim())){alert('End time error');return;}else if(/[a-zA-Z]/.test($('#expiredDataStartTime').val().trim())){alert('Start time error');return;}
if($('#expiredDataStartTime').val().trim()){startTimeVal=new Date($('#expiredDataStartTime').val().trim()).format('yyyy-MM-dd HH:mm:00');}else{startTimeVal=new Date(new Date(endTimeVal)-30*60*1000).format('yyyy-MM-dd HH:mm:00');$('#expiredDataStartTime').val(new Date(startTimeVal).format('yyyy-MM-dd HH:mm'));}
if(new Date(startTimeVal)>new Date(endTimeVal)){alert(I18n.resource.common.TIME_COMPARE);return;}
infoBox.confirm(I18n.resource.dataManage.IS_DELETE_EXPIRED_DATA+' '+startTimeVal+' '+I18n.resource.dataManage.TO+' '+endTimeVal+' '+I18n.resource.dataManage.OF_DATA,function(){WebAPI.post('/sitedata/clear',{'projId':AppConfig.projectId,'startTime':startTimeVal,'endTime':endTimeVal}).done(function(result){if(result.success){_this.refreshPointList().done(function(){_this.historyStatusPopover.popover('hide');_this.historyStatusPopover.data("bs.popover").inState.click=false;});}else{console.log('error'+result.data);}});});});$("#isMonitoring").click(function(){var $this=$(this),$span=$this.find('span');if($span.hasClass("glyphicon-star")){_this.refreshPaginationTable();$('#dataManagePagination').show();$('#dataManagePaginationWrapper').show();$span.removeClass("glyphicon-star").addClass('glyphicon-star-empty');}else{Spinner.spin(ElScreenContainer);WebAPI.get('/admin/dataPointManager/loadData/'+_this.projectId).done(function(result){if(result.list&&result.list.length){_this.hasMonitoredList=result.list;}
_this.refreshPaginationTable('isMonitored');$('#dataManagePagination').hide();$('#dataManagePaginationWrapper').hide();$span.removeClass("glyphicon-star-empty").addClass('glyphicon-star');}).always(function(){Spinner.stop();});}});$("#joinCurve").click(function(){var $selectedItem=$("#tableWatch tr.active, #tableMonitor tr.active"),$point_name_list,point_name_list,alert,date_start,data_end,format;if(!$selectedItem.length){return;}
if($selectedItem.length>10){alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.dataManage.UP_TO_TEN_RECORDS);alert.showAtTop(2000);return;}
$point_name_list=$selectedItem.map(function(index,item){return $(item).data('point').toString();});point_name_list=$point_name_list.toArray();point_name_list=point_name_list.filter(function(item,pos){return point_name_list.indexOf(item)==pos;});if(localStorage.getItem('dataManagerStartDate')){date_start=localStorage.getItem('dataManagerStartDate');data_end=localStorage.getItem('dataManagerEndDate');format=localStorage.getItem('dataManagerFormat')?localStorage.getItem('dataManagerFormat'):'m5';}else{date_start=new Date(new Date()-24*60*60*1000).format("yyyy-MM-dd HH:mm:00");data_end=new Date().format("yyyy-MM-dd HH:mm:00");format='m5';}
Spinner.spin(ElScreenContainer);WebAPI.post("/get_history_data_padded_reduce",{projectId:_this.projectId,pointList:point_name_list,timeStart:date_start.format("yyyy-MM-dd HH:mm:00"),timeEnd:data_end.format("yyyy-MM-dd HH:mm:00"),timeFormat:format}).done(function(data){var obj={data:data,startDate:date_start,endDate:data_end,format:format,pointList:point_name_list,projectId:_this.projectId,isShowRepairData:false};new HistoryChart(obj).show();}).fail(function(e){alert(I18n.resource.observer.widgets.HISTORY_CURVE_FAILED);}).always(function(){Spinner.stop();});});$("#pointRefresh").click(function(){_this.currentPage=1;_this.initProjectPointList();});$("#doSearch").click(function(){_this.currentPage=1;_this.initProjectPointList();});$('#pageSizeSelector').change(function(){_this.setPageSize($(this).val());_this.initProjectPointList();_this.paginationRefresh(1);});$('#filterDefineConfirm').click(function(){_this.searchModel.text=$('#filterContent').val().trim();if(!_this.searchModel.text){return;}
_this.refreshPointList();$filterDefineWin.modal('hide');});$divPointsList.on('change','#filterType',function(){var val=$(this).val().trim();_this.refreshFilter(val);_this.searchModel={filterType:val,isAdvance:true};if(val==_this.filterType.name){_this.searchModel.isAdvance=false;}else if(val==_this.filterType.define){_this.destroyDatePicker();$filterDefineWin.modal();}else if(val==_this.filterType.time){_this.pointDateStartInstance=$("#pointDateStart").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:ss'});_this.pointDateEndInstance=$("#pointDateEnd").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:ss'});}else{_this.destroyDatePicker();}}).on('change','#filterSort',function(){_this.setFilterSort($(this).val());_this.refreshPointList();}).on('click','#filterConfirm',function(){_this.setSearchModel();_this.refreshPointList();}).on('keyup','#searchPoint',function(e){if(e.keyCode==13){_this.setSearchModel();_this.refreshPointList();}}).on('click','#defineFilterEdit',function(){$filterDefineWin.modal();});},destroyDatePicker:function destroyDatePicker(){if(this.pointDateStartInstance){this.pointDateStartInstance=null;this.pointDateEndInstance=null;}},refreshFilter:function refreshFilter(type){$("#filterBox").empty().html(beopTmpl('tpl_data_manage_filter',{'type':type}));I18n.fillArea($(ElScreenContainer));},detachEvents:function detachEvents(){$(document).on("click.hideExpiredTimeBox");},paginationRefresh:function paginationRefresh(totalNum){var _this=this;var totalPages=Math.ceil(totalNum/this.getPageSize());if(!totalNum){return;}
while(totalPages<this.currentPage&&this.currentPage>1){this.currentPage=this.currentPage-1;}
var pageOption={first:'&laquo;&laquo',prev:'&laquo;',next:'&raquo;',last:'&raquo;&raquo;',startPage:this.currentPage?this.currentPage:1,totalPages:!totalPages?1:totalPages,onPageClick:function onPageClick(event,page){_this.currentPage=page;_this.refreshPointList();}};if(this.currentPage){pageOption['startPage']=this.currentPage?this.currentPage:1;}
$("#dataManagePagination").replaceWith('<ul class="pagination fr" id="dataManagePagination"></ul>');$("#dataManagePagination").twbsPagination(pageOption);},renderSearchList:function renderSearchList(){if(this.pointInfoList.length){this.refreshSearchTable(this.searchModel.text);}},refreshSearchTable:function refreshSearchTable(keyWordVal){var _this=this,pointListHtml='';var keywordList=keyWordVal.replace(/[^\w\d\s]/g,' ').split(/\s/g);for(var i=0;i<this.pointInfoList.length;i++){var point=this.pointInfoList[i];var keyWordName=point.pointname;keywordList.forEach(function(item){if(item){keyWordName=keyWordName.replace(new RegExp("("+item+")(?![^<]*>|[^<>]*</)","gi"),'<span class="keyword">$1</span>');}});pointListHtml+='<tr data-point="'+point.pointname+'">'+'<td>'+keyWordName+'</td><td>'+point.pointvalue+'</td>'+'<td>'+timeFormat(point.time,timeFormatChange('yyyy-mm-dd hh:ii'))+'</td>'+'<td>'+(point.alias?point.alias:'')+'</td><td><span class="glyphicon cp data-manager-star '+(_this.arrayToObject(_this.hasMonitoredNameList)[point.pointname]?'glyphicon-star':'glyphicon-star-empty')+'"></span></td>'+'</tr>';}
$("#tableWatch tbody").html(pointListHtml);},refreshPointList:function refreshPointList(){if(!this.projectId){alert('invalid project, please try again.');return;}
var _this=this;Spinner.spin($('#tableWatch').get(0));return WebAPI.post("/admin/dataPointManager/search/",{projectId:this.projectId,current_page:this.currentPage,page_size:this.getPageSize(),text:this.searchModel.text?this.searchModel.text:'',isAdvance:this.searchModel.isAdvance?this.searchModel.isAdvance:false,order:this.searchModel.order?this.searchModel.order:null,isRemark:this.searchModel.isRemark,flag:0}).done(function(result){var total=result.total;$('#totalPointsNum').text(total);if(!total){_this.currentPage=1;$("#tableWatch tbody").html("");_this.paginationRefresh(1);return;}
_this.pointInfoList=result.list;_this.refreshPaginationTable();_this.paginationRefresh(total);if(_this.searchModel.filterType==_this.filterType.name&&_this.searchModel.text){_this.renderSearchList();}}).fail(function(){alert(I18n.resource.analysis.paneConfig.ERR1);}).always(function(){Spinner.stop();});},refreshPaginationTable:function refreshPaginationTable(isMonitoredList){var _this=this,pointListHtml='',list=isMonitoredList?_this.hasMonitoredList:_this.pointInfoList;for(var i=0;i<list.length;i++){var point=list[i];pointListHtml+='<tr data-point="'+(point.pointname||point.name)+'">'+'<td>'+(point.pointname||point.name)+'</td><td title="'+(point.pointvalue||point.value||'')+'">'+(point.pointvalue||point.value||'')+'</td>'+'<td>'+timeFormat(point.time,timeFormatChange('yyyy-mm-dd hh:ii'))+'</td>'+'<td>'+(point.alias?point.alias:'')+'</td>'+'<td><span class="glyphicon cp data-manager-star '+(_this.arrayToObject(_this.hasMonitoredNameList)[point.pointname]||_this.arrayToObject(_this.hasMonitoredNameList)[point.name]?'glyphicon-star':'glyphicon-star-empty')+'"></span></td>'+'</tr>';}
$("#tableWatch tbody").empty().html(pointListHtml);$('.gray-scrollbar').last().scrollTop(0);},deleteHasMonitoredNameList:function deleteHasMonitoredNameList(name){var hasMonitoredNameList=this.hasMonitoredNameList;for(var i=0,iLen=hasMonitoredNameList.length;i<iLen;i++){if(hasMonitoredNameList[i]==name){hasMonitoredNameList.splice(i--,1);}}},addHasMonitoredNameList:function addHasMonitoredNameList(name){var hasMonitoredNameList=this.hasMonitoredNameList;for(var i=0,iLen=hasMonitoredNameList.length;i<iLen;i++){if(hasMonitoredNameList[i]==name){return;}}
this.hasMonitoredNameList.push(name+'');},arrayToObject:function arrayToObject(arr){var obj={};for(var i=0;i<arr.length;i++){obj[arr[i]]=true;}
return obj;},initProjectPointList:function initProjectPointList(){var _this=this,savedPointsPromise=WebAPI.get('/admin/dataPointManager/loadData/'+_this.projectId);Spinner.spin(ElScreenContainer);$.when(_this.refreshPointList(),savedPointsPromise).done(function(pointListResult,hasMonitoredResult){if(pointListResult[1]=='success'&&hasMonitoredResult[1]=='success'){hasMonitoredResult[0].list.forEach(function(item){_this.hasMonitoredNameList.push(item.name);});_this.refreshPaginationTable();}else{console.log(error+'获取报表数据失败');}}).always(function(){Spinner.stop();});},getPageSize:function getPageSize(){if(!localStorage.getItem(this.pageSizeKey)){localStorage.setItem(this.pageSizeKey,this.defaultPageSize);}
return localStorage.getItem(this.pageSizeKey);},setPageSize:function setPageSize(pageSize){localStorage.setItem(this.pageSizeKey,pageSize?Number(pageSize):this.defaultPageSize);}};$.extend(PointManagerRealTimeData.prototype,PointManagerRealTimeDataFunc);return PointManagerRealTimeData;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var PointManagerImportData=function(){function PointManagerImportData(projectId){PointManager.call(this,projectId);this.htmlUrl='/static/views/observer/pointManagerImportData.html';}
PointManagerImportData.prototype=Object.create(PointManager.prototype);PointManagerImportData.prototype.constructor=PointManagerImportData;var PointManagerImportDataFunc={show:function show(){var _this=this;this.init().done(function(){if(AppConfig.projectName!=null){$('#stPjName').html(AppConfig.projectName);}
_this.attachEvents();I18n.fillArea($(ElScreenContainer));});},close:function close(){this.detachEvents();},attachEvents:function attachEvents(){var _this=this;var $pjData=$('#iptPjData');var $btnConfirm=$('#btnConfirmUpload');var $spUploadInfo=$('#spUploadInfo');var $btnUploadCSV=$('#btnUploadCSV');var $divPjDataDropHandler=$('#divPjDataDropHandler');var $tip=$divPjDataDropHandler.children('p');var $uploadMask=$('#uploadMask');var $body=$('body');var uploadStatus=-1;var fileSelected;var dragFix=false;$spUploadInfo.tooltip({title:'',trigger:'manual',placement:'right'});var uploadHandler=function uploadHandler(file){var formData=new FormData();var match=file.name.match(/\.[A-Za-z0-9]+$/);var supportFiles=['.csv','.xls','.xlsx'];if(!file||!match||supportFiles.indexOf(match[0].toLowerCase())<0){util.tooltip.show($spUploadInfo,I18n.resource.dataManage.INVALID_FILE_TYPE);isDataUploadReady=false;return;}
fileSelected=file;formData.append('config-file',file);$.ajax({url:'/get_config_data/'+AppConfig.userId,type:'post',data:formData,dataType:'json',xhr:function xhr(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener('progress',function(e){var progress=Math.round(e.loaded/e.total);if(e.lengthComputable){$('#spUploadInfo').html(I18n.resource.dataManage.UPLOADING+progress*100+'%');}},false);xhr.upload.addEventListener('load',function(e){$('#spUploadInfo').html(I18n.resource.dataManage.PROCESSING);},false);}
return xhr;},cache:false,contentType:false,processData:false}).done(function(rs){$('#spUploadInfo').removeClass().addClass('text-success').html(I18n.resource.dataManage.UPLOAD_SUCCESS+file.name);uploadStatus=0;$('#btnConfirmUpload').removeAttr('disabled');}).fail(function(err){$('#spUploadInfo').removeClass().addClass('text-danger').html(I18n.resource.dataManage.UPLOAD_FAILED);uploadStatus=-1;});};var fileNameList=[];var uploadHandlerEx=function uploadHandlerEx(file){fileNameList=[];var formData=new FormData();for(var i=0;i<file.length;i++){var match=file[i].name.match(/\.[A-Za-z0-9]+$/);var supportFiles=['.csv','.xls','.xlsx'];if(!file[i]||!match||supportFiles.indexOf(match[0].toLowerCase())<0){util.tooltip.show($spUploadInfo,I18n.resource.dataManage.INVALID_FILE_TYPE);isDataUploadReady=false;return;}
fileSelected=file[i];formData.append('config-file',file[i]);fileNameList.push(file[i].name);}
Spinner.spin(ElScreenContainer);$.ajax({url:'/get_config_data/'+AppConfig.userId,type:'post',data:formData,dataType:'json',xhr:function xhr(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener('progress',function(e){var progress=Math.round(e.loaded/e.total);if(e.lengthComputable){$('#spUploadInfo').html(I18n.resource.dataManage.UPLOADING+progress*100+'%');}},false);xhr.upload.addEventListener('load',function(e){$('#spUploadInfo').html(I18n.resource.dataManage.PROCESSING);},false);}
return xhr;},cache:false,contentType:false,processData:false}).done(function(rs){$('#spUploadInfo').removeClass().addClass('text-success').html(I18n.resource.dataManage.UPLOAD_SUCCESS+fileNameList.join(','));uploadStatus=0;$('#btnConfirmUpload').removeAttr('disabled');}).fail(function(err){$('#spUploadInfo').removeClass().addClass('text-danger').html(I18n.resource.dataManage.UPLOAD_FAILED);uploadStatus=-1;}).always(function(){Spinner.stop();});};$btnUploadCSV.click(function(e){$pjData.click();});$pjData.change(function(){uploadHandlerEx($(this)[0].files);});$divPjDataDropHandler.on('dragenter',function(e){dragFix=true;$tip.html(I18n.resource.dataManage.DRAG_RELEASE_TIP);e.stopPropagation();e.preventDefault();});$divPjDataDropHandler.on('dragleave',function(e){dragFix=false;$tip.html(I18n.resource.dataManage.DRAG_TIP);e.stopPropagation();e.preventDefault();});$divPjDataDropHandler.on('drop',function(e){var files,file;$divPjDataDropHandler.hide();$uploadMask.hide();$tip.html(I18n.resource.dataManage.DRAG_TIP);files=e.originalEvent.dataTransfer.files;if(files.length>1)alert(I18n.resource.dataManage.NOT_SUPPORT_MULTI_UPLOAD);file=files[0];uploadHandler(file);e.stopPropagation();e.preventDefault();});$uploadMask.on('dragleave',function(e){e.stopPropagation();if(dragFix)return;$uploadMask.hide();$divPjDataDropHandler.hide();});$body.on('dragenter',function(e){$divPjDataDropHandler.show();$uploadMask.show();e.preventDefault();});$body.add($uploadMask).add($divPjDataDropHandler).on('dragover',function(e){e.preventDefault();});$body.on('keydown',function(e){if(e.keyCode===27){$uploadMask.hide();$divPjDataDropHandler.hide();e.preventDefault();}});$body.on('drop',function(e){$uploadMask.hide();$divPjDataDropHandler.hide();e.preventDefault();});$btnConfirm.click(function(){if(_this.projectId==null){alert(I18n.resource.dataManage.CHOOSE_PROJECT_FIRST);return;}
if(uploadStatus!==0){alert(I18n.resource.dataManage.UPLOAD_DATA_FIRST);return;}
Spinner.spin($body[0]);WebAPI.post('/project/import_user_data/'+AppConfig.userId,{dataFileName:fileNameList,projId:_this.projectId}).done(function(rs){if((typeof rs==='undefined'?'undefined':_typeof(rs))==='object'&&rs.error==='successful'){alert(I18n.resource.dataManage.DATA_IMPORT_SUCCESS);ScreenManager.show(PointManager);}else{alert(I18n.resource.dataManage.DATA_IMPORT_FAILED);}}).fail(function(){alert(I18n.resource.dataManage.DATA_IMPORT_FAILED);}).always(function(){Spinner.stop();});});},detachEvents:function detachEvents(){$('#divPjDataDropHandler').off();$('#uploadMask').off();$('body').off();}};$.extend(PointManagerImportData.prototype,PointManagerImportDataFunc);return PointManagerImportData;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var PointManagerImportTags=function(){var _this;var TagType={equipment:'equipment',sensor:'sensor'};var ThingType={group:'group',thing:'thing'};function PointManagerImportTags(projectId){PointManager.call(this,projectId);this.htmlUrl='/static/views/observer/pointManagerImportTags.html';_this=this;this.isInTagsContent=false;this.importTagUrl='/tag/import/'+AppConfig.projectId;this.uploadSupportFileType=['.csv','.xls','.xlsx'];this.stateMap={tId:null,treeNode:null,explorerPath:{path:[],index:-1,shouldLog:true},currentNode:null,iotOption:{}};this.tagDict=[];}
PointManagerImportTags.prototype=Object.create(PointManager.prototype);PointManagerImportTags.prototype.constructor=PointManagerImportTags;var PointManagerImportTagsFunc={setPageJqueryMap:function setPageJqueryMap(){var jqueryMap={$tagContent:this.$container.find('.tag-content'),$tagsRightHeader:this.$container.find('.tags-right-header'),$tbWrap:this.$container.find('.tb-wrap'),$tagList:this.$container.find('.tag-list'),$tagsRightContent:this.$container.find('.tags-right-content'),$tagsLeftContainer:this.$container.find('.tagsLeftContainer'),$uploadInput:this.$container.find('#iptPjData'),$importTags:this.$container.find('#importTags'),$syncPointToTree:this.$container.find('#syncPointToTree'),$tagsPath:this.$container.find('#tags-path'),$tagSearch:this.$container.find('#tag_search'),$tagSearchBox:this.$container.find('#tag-search-box'),$tagExplorer:this.$container.find('#tagsExplorer')};$.extend(this.jqueryMap,jqueryMap);},show:function show(){var _this=this;WebAPI.get('/tag/getGlobalDictionary/zh-CN').done(function(result){_this.tagDict=result.tag;});this.init().done(function(){_this.attachEvents();_this.renderRightTagsContent();I18n.fillArea($(ElScreenContainer));$(window).resize(function(){if(window.outerWidth/window.innerWidth<=0.75){$('.tag-list-item-name').css('min-height','64px');}});});},initPanelFilter:function initPanelFilter(){this.filterPanel=new HierFilter(this.jqueryMap.$tbWrap,110,this);this.filterPanel.init();this.filterPanel.setOption(this.stateMap.iotOption);},showTags:function showTags(node){var $tagItems=$('<div></div>');_this.jqueryMap.$tagList.empty();for(var m=0;m<node.length;m++){var tagItemHtml='';tagItemHtml=beopTmpl('tpl_tag_explorer_item',{item:node[m]});$tagItems.append(tagItemHtml);}
_this.$tagItems=$tagItems;_this.jqueryMap.$tagList.append($tagItems.children());},searchTag:function searchTag(){_this.jqueryMap.$tagsRightContent.off('scroll.rightShow');var searchText=$('#tag_search').val()||'';if(!searchText.trim()){_this.nodes=_this.allNodesInCurrentPath;_this._showRightSlowly();}else{Spinner.spin(ElScreenContainer);var path='';if(_this.path&&_this.path.length){for(var i=0,iLen=_this.path.length;i<iLen;i++){path+='/'+_this.path[i].name;}}
WebAPI.post('/tag/search',{"projId":AppConfig.projectId,"searchName":searchText,"path":path,"isRecursive":false,"Prt":_this.currentNode._id||''}).done(function(result){if(result.status){var keywordList=searchText.replace('/[^\w\d\s]/g',' ').split(/\s/g);result.thingsList.forEach(function(parentItem){parentItem.keywordName=parentItem.name;keywordList.forEach(function(item){if(item){parentItem.keywordName=parentItem.keywordName.replace(new RegExp("("+item+")(?![^<]*>|[^<>]*</)","gi"),'<span style="color:orange">$1</span>');}});});_this.nodes=result.thingsList;_this._showRightSlowly();_this.jqueryMap.$tagsRightContent.scrollTop(0);}else{alert('error:'+result.message);}}).always(function(){Spinner.stop();});}},_dr_dragMove:function _dr_dragMove(){},_dr_dropTree2Dom:function _dr_dropTree2Dom(evnet,treeId,treeNodes,targetNode,moveType,isCopy){var thingIds=[];for(var i=0,iLen=treeNodes.length;i<iLen;i++){thingIds.push(treeNodes[i]._id);}
Spinner.spin(_this.jqueryMap.$tagContent.get(0));WebAPI.post('/tag/moveThings',{Prt:targetNode._id,thingsId:thingIds,projId:AppConfig.projectId}).done(function(result){if(result.status){for(var i=0;i<thingIds.length;i++){if(thingIds[i]){var $tagDrapItem=$('.tag-list-item[data-id='+thingIds[i]+']');if($tagDrapItem){$tagDrapItem.remove();}}}
_this.moveTreeNodes(targetNode._id,thingIds);if(_this.currentNode._id==targetNode._id){this.$container.find('#'+_this.currentNode.tId+'_span').click();}}else{alert.danger('move failed');}}).always(function(){Spinner.stop();});},_dr_dragTree2Dom:function _dr_dragTree2Dom(treeId,treeNodes){return!(treeNodes[0].type=='group');},_beforeDrop:function _beforeDrop(treeId,treeNodes,targetNode,moveType){return targetNode.type=='group';},_dr_itemToTree:function _dr_itemToTree(event,treeId,treeNode){if(!treeNode){return;}
if(treeNode.type==ThingType.group){_this.movePointsToGroup(treeNode._id);}else{$('#drag_box').remove();_this.stateMap.isDragging=false;}},asyncSuccess:function asyncSuccess(event,treeId,treeNode,msg){if(_this.isRenderRight){_this.stateMap.tId=treeNode.tId;_this.path=treeNode.getPath();_this.jqueryMap.$tagsPath.find('.breadcrumb').empty().append(beopTmpl('tpl_tags_path',{paths:_this.path}));_this._showRightSlowly();_this.isRenderRight=false;if(_this.currentNode.tId==treeNode.tId){_this.jqueryMap.$tagExplorer.find('.fileNumber').empty().append(beopTmpl('tpl_tags_fileNumber',{node:_this.tree.getNodesByParam('parentTId',_this.currentNode.tId)}));}}},addDiyDom:function addDiyDom(treeId,treeNode){if(treeNode&&treeNode.isParent){$('#'+treeNode.tId+'_ico').addClass('tree-folder');}},_click_tree_item:function _click_tree_item(event,treeId,treeNode,clickFlag){_this.path=treeNode.getPath();if(!treeNode||treeNode.type!==ThingType.group){_this.jqueryMap.$tagExplorer.find('.detailed_information').empty().append(beopTmpl('tpl_tags_detailed_information',{paths:_this.path}));return false;}
_this.isRenderRight=true;this.tree.reAsyncChildNodes(treeNode,'refresh');_this._menuIsAvailable(treeNode);_this.jqueryMap.$tagExplorer.find('.detailed_information').empty().append(beopTmpl('tpl_tags_detailed_information',{paths:_this.path}));_this.jqueryMap.$tagExplorer.find('.fileNumber').empty().append(beopTmpl('tpl_tags_fileNumber',{node:_this.tree.getNodesByParam('parentTId',_this.currentNode.tId)}));},_right_click_tree_item:function _right_click_tree_item(event,treeId,treeNode){_this.openContextMenu($('#contextMenu-panel'),event.pageX,event.pageY);_this.addTagPid=treeNode._id;},_before_right_click:function _before_right_click(treeId,treeNode){return treeNode.type=="group";},_makeIconSkin:function _makeIconSkin(icon){return'iconfont icon-'+icon;},_makeTreeNodeIcon:function _makeTreeNodeIcon(nodes){if(!nodes||!nodes.length){return false;}
for(var i=0,iLen=nodes.length;i<iLen;i++){if(nodes[i].children){this._makeTreeNodeIcon(nodes[i].children);}
if(nodes[i].tag&&nodes[i].tag.icon){nodes[i].iconSkin=this._makeIconSkin(nodes[i].tag.icon);nodes[i].isParent&&(nodes[i].iconSkin+=' tree-folder ');}}},renderRightTagsContent:function renderRightTagsContent(event,treeId,treeNode,isShowAll){if(treeNode){_this.stateMap.tId=treeNode.tId;_this.path=treeNode.getPath();this.jqueryMap.$tagsPath.find('.breadcrumb').empty().append(beopTmpl('tpl_tags_path',{paths:_this.path}));}else{_this.path=null;this.jqueryMap.$tagsPath.find('.breadcrumb').empty().append(beopTmpl('tpl_tags_path',{paths:[]}));}
Spinner.spin(_this.jqueryMap.$tbWrap[0]);var requestData={projId:AppConfig.projectId};if(treeNode&&treeNode._id){requestData['Prt']=treeNode._id;}
WebAPI.post('/tag/getThingTree',requestData).done(function(result){if(result.status){_this._makeTreeNodeIcon(result.thingTree);_this.nodes=result.thingTree;_this.allNodesInCurrentPath=result.thingTree;if(!_this.tree){var setting={edit:{enable:true,showRemoveBtn:false,showRenameBtn:false,drag:{inner:true,isCopy:false,isMove:true}},callback:{onClick:_this._click_tree_item.bind(_this),beforeDrag:_this._dr_dragTree2Dom.bind(this),beforeDrop:_this._beforeDrop.bind(this),onDrop:_this._dr_dropTree2Dom.bind(this),onDragMove:_this._dr_dragMove.bind(this),onMouseUp:_this._dr_itemToTree.bind(this),onRightClick:_this._right_click_tree_item.bind(_this),beforeRightClick:_this._before_right_click.bind(this),beforeAsync:function beforeAsync(){return true;},onAsyncSuccess:_this.asyncSuccess.bind(this)},view:{selectedMulti:true,addDiyDom:_this.addDiyDom},async:{enable:true,type:'post',url:'/tag/getThingTree',otherParam:{"projId":AppConfig.projectId},autoParam:["_id=Prt"],dataFilter:function dataFilter(treeId,parentNode,responseData){_this.nodes=responseData.thingTree;_this.allNodesInCurrentPath=responseData.thingTree;_this._makeTreeNodeIcon(_this.nodes);return _this.nodes;}}};if(isShowAll||_this.nodes.length<1000){_this.tree=$.fn.zTree.init($('#projectDataTree'),setting,_this.nodes);}else{_this.tree=$.fn.zTree.init($('#projectDataTree'),setting,_this.nodes.slice(0,1000));}}
_this._showRightSlowly();_this.jqueryMap.$tagExplorer.find('.fileNumber').empty().append(beopTmpl('tpl_tags_fileNumber',{node:_this.tree.getNodesByParam('parentTId',_this.currentNode.tId)}));}}).always(function(){Spinner.stop();});_this._menuIsAvailable(treeNode);},_menuIsAvailable:function _menuIsAvailable(treeNode){if(!treeNode){this.currentNode={_id:null};}else{this.currentNode=treeNode;}
if(_this.stateMap.explorerPath.shouldLog){_this.logPath(treeNode);}
_this.stateMap.explorerPath.shouldLog=true;var pathState=_this.stateMap.explorerPath;if(pathState.path.length!=1){$('.next-path').removeClass('disable');$('.last-path').removeClass('disable');}
if(pathState.index===pathState.path.length-1){$('.next-path').addClass('disable');}
if(pathState.index===0){$('.last-path').addClass('disable');}
if(treeNode){$('.glyphicon-arrow-up').removeClass('disable');}else{$('.glyphicon-arrow-up').addClass('disable');}},_showRightSlowly:function _showRightSlowly(){var showCount=0;var scrollLoad=function scrollLoad(){showCount+=200;if(_this.nodes.length>showCount){var showNodes=_this.nodes.slice(0,showCount);_this.showTags(showNodes);}else{_this.showTags(_this.nodes);}};scrollLoad();_this.jqueryMap.$tagsRightContent.on('scroll.rightShow',function(){var scrollTop=$(this).scrollTop();var scrollHeight=$(this).height();var containerHeight=$(this)[0].scrollHeight;if(scrollTop+scrollHeight==containerHeight){scrollLoad();}});},_endTagSelection:function _endTagSelection(e){if(!this.isInTagsContent){$('#drag_box').remove();return false;}
$('#active_box').remove();var $allFiles=_this.jqueryMap.$tagsRightContent.find('.tag-list-item');if(!e.ctrlKey){$allFiles.removeClass('active');}
_this.endClientX=e.clientX;_this.endClientY=e.clientY;var minClientX=Math.min(_this.startClientX,_this.endClientX);var maxClientX=Math.max(_this.startClientX,_this.endClientX);var minClientY=Math.min(_this.startClientY,_this.endClientY);var maxClientY=Math.max(_this.startClientY,_this.endClientY);for(var i=0;i<$allFiles.length;i++){var offset=$($allFiles[i]).offset();var left=offset.left;var top=offset.top;var width=$($allFiles[i]).width();var height=$($allFiles[i]).height();var NoCollisionFirstCase=top>maxClientY;var NoCollisionSecondCase=top+height<minClientY;var NoCollisionThirdCase=left+width<minClientX;var NoCollisionForthCase=left>maxClientX;if(!(NoCollisionFirstCase||NoCollisionSecondCase||NoCollisionThirdCase||NoCollisionForthCase)){if(!e.ctrlKey){$($allFiles[i]).addClass('active');}}}
this.isInTagsContent=false;$(document.body).off('mouseup.tagsSelection');},_processTagSelection:function _processTagSelection(e){if(document.getElementById("active_box")){if(e.clientX>_this.startClientX){var active_box=document.getElementById("active_box");active_box.style.width=Math.abs(e.clientX-_this.startClientX)+'px';active_box.style.height=Math.abs(e.clientY-_this.startClientY)+'px';if(e.clientX<_this.startClientX){active_box.style.left=e.clientX+'px';}
if(e.clientY<_this.startClientY){active_box.style.top=e.clientY+'px';}}else{var $target=$(e.target);var $tagItem=$target.closest('.tag-list-item');if($tagItem.length>0){_this.jqueryMap.$tagsRightContent.find('.tag-list-item').removeClass('active');$('#active_box').remove();_this.stateMap.isDragging=true;$tagItem.addClass('active');$(document.body).off('mouseup.tagsSelection');}}}
if(_this.stateMap.isDragging){var $target=$(e.target);if($target.closest('#projectDataTree').length>0){if($target.closest('li').length>0){$('#projectDataTree').find('li').removeClass('active');$target.closest('li').addClass('active');}}
var $tagItem=$target.closest('.tag-folder');_this.jqueryMap.$tagsRightContent.find('.tag-list-item').removeClass('dropTarget');if($tagItem.length>0){$tagItem.addClass('dropTarget');}
var drag_box=document.getElementById("drag_box");if(!drag_box){var selectedItems=_this.jqueryMap.$tagsRightContent.find('.active'),seleLen=selectedItems.length;drag_box=document.createElement('div');drag_box.id='drag_box';drag_box.style.border='1px dashed #aaa';drag_box.style.padding='5px';drag_box.style.position='absolute';var dragContent='<ul style="list-style:none;padding:0" class="clearfix">';for(var i=0;i<seleLen;i++){var $selectedItem=$(selectedItems[i]),id=$selectedItem.data('id');dragContent+='<li class="clearfix drag-item" data-id="'+id+'">';dragContent+=$selectedItem.html();dragContent+='</li>';}
dragContent+='</ul>';drag_box.innerHTML=dragContent;_this.jqueryMap.$tagContent.append(drag_box);}
drag_box.style.left=e.pageX-_this.jqueryMap.$tagContent.offset().left+15+'px';drag_box.style.top=e.pageY-_this.jqueryMap.$tagContent.offset().top+50+'px';}},_startTagSelection:function _startTagSelection(e){if(e.which!=1){return false;}
_this.startClientX=e.clientX;_this.startClientY=e.clientY;$('#drag_box').remove();if($(e.target.closest('li')).hasClass('active')&&_this.startClientX!==_this.stateMap.lastClickEvent.clientX&&_this.startClientY!==_this.stateMap.lastClickEvent.clientY){_this.stateMap.isDragging=true;}else{_this.isInTagsContent=true;$('#active_box').remove();var active_box=document.createElement('div');active_box.id='active_box';active_box.style.top=_this.startClientY+'px';active_box.style.left=_this.startClientX+'px';active_box.style.position='absolute';document.body.appendChild(active_box);}
_this.stateMap.lastClickEvent=e;$(document.body).on('mouseup.tagsSelection',_this._endTagSelection.bind(_this));},_uploadHandler:function _uploadHandler(file){var formData=new FormData();var match=file.name.match(/\.[A-Za-z0-9]+$/);if(!file||!match||this.uploadSupportFileType.indexOf(match[0].toLowerCase())<0){alert(I18n.resource.dataManage.INVALID_FILE_TYPE);return;}
formData.append('file',file);Spinner.spin(ElScreenContainer);$.ajax({url:this.importTagUrl,type:'post',data:formData,dataType:'json',cache:false,contentType:false,processData:false}).done(function(result){if(result.success){_this.filterPanel.init();}}).fail(function(err){}).always(function(){Spinner.stop();});},_dropTags:function _dropTags(e){if(!_this.stateMap.isDragging){return;}
var $targetEl=$(e.target);if($targetEl.closest('.tagsLeftContainer').length>0){var $selectedTags=_this.jqueryMap.$tagsRightContent.find('.active');var targetNodes=_this.tree.getNodeByTId($targetEl.closest('li')[0].id);if(!targetNodes.isParent){return;}
for(var i=0,iLen=$selectedTags.length;i<iLen;i++){_this.tree.moveNode(targetNodes,_this.getTreeNodeByItem($selectedTags)[i],"inner");}
_this.clickTreeNode(_this.stateMap.tId);}else{$('#drag_box').remove();}
_this.stateMap.isDragging=false;},_getTagsByType:function _getTagsByType(type){if(!this.tagDict||!this.tagDict.length){return[];}
var ret=[];for(var i=0;i<this.tagDict.length;i++){var tag=this.tagDict[i];if(tag.type==type){ret.push(tag);}}
return ret;},_getTagById:function _getTagById(id){if(!this.tagDict||!this.tagDict.length){return null;}
for(var i=0;i<this.tagDict.length;i++){var tag=this.tagDict[i];if(tag._id==id){return tag;}}},_showMark:function _showMark(e){var $selected=_this.jqueryMap.$tagsRightContent.find('.active');if($selected.length>1){return;}
var $this=$(this);var tags=[];if($selected.data('type')==ThingType.group){tags=_this._getTagsByType(TagType.equipment);}else{tags=_this._getTagsByType(TagType.sensor);}
if(tags&&tags.length){if($this.find('ul').length){return;}
var mark_content='<ul class="dropdown-menu" style="display:block;position:absolute;">';for(var i=0,iLen=tags.length;i<iLen;i++){var type=tags[i].type;var icon=tags[i].icon?tags[i].icon:'';var name=tags[i].name;if($.isArray(tags[i].name)){name=tags[i].name.join(' ');}
var id=tags[i]._id;mark_content+='<li data-type="'+type+'" data-id="'+id+'"><a tabindex="-1"><span style="margin-right:10px;" class="iconfont icon-'+icon+'" aria-hidden="true"></span>'+name+'</a></li>';}
mark_content+='</ul>';$(mark_content).css({'left':$this.width()+25+'px','top':'-12px'}).appendTo($this);}},_selectTagItem:function _selectTagItem(e){var $this=$(this);if(e.ctrlKey){$this.toggleClass('active');_this.currentFileIndex=$this.index();}else{if(e.shiftKey){var minIndex=Math.min(_this.currentFileIndex,$this.index());var maxIndex=Math.max(_this.currentFileIndex,$this.index());var $allFiles=_this.jqueryMap.$tagsRightContent.find('.tag-list-item');$allFiles.removeClass('active');for(;minIndex<maxIndex+1;minIndex++){$($allFiles[minIndex]).addClass('active');}
_this.currentFileIndex=$this.index();}else{$this.addClass('active');_this.jqueryMap.$tagsRightContent.find('.tag-list-item').not(this).removeClass('active');_this.currentFileIndex=$this.index();}}
_this.path=_this.tree.getNodeByParam("_id",$(this).data("id")).getPath();_this.jqueryMap.$tagExplorer.find('.detailed_information').empty().append(beopTmpl('tpl_tags_detailed_information',{paths:_this.path}));},openContextMenu:function openContextMenu($contextMenu,mouseX,mouseY){$('.contextMenu').hide();if($contextMenu){$contextMenu.css({display:"block",left:mouseX-245,top:mouseY-56});}},closeContextMenu:function closeContextMenu(){$('.contextMenu').hide();},getTreeNodeByItem:function getTreeNodeByItem($el){var ret=[];if(!$el){return[];}
$el.each(function(index,item){var _id=item.dataset.id;_id&&ret.push(_this.tree.getNodeByParam('_id',_id));});return ret;},getParentTreeNodeByItem:function getParentTreeNodeByItem($el){var tid=$el.data('ptid');return tid&&_this.filterPanel.tree.getNodeByTId(tid);},updateTreeNodeById:function updateTreeNodeById(nodeId,option){var node=this.tree.getNodeByParam('_id',nodeId);if(!node){return;}
if(node.type=='group'&&option.iconSkin){option.iconSkin+=' tree-folder ';}
$.extend(node,option);this.tree.updateNode(node);},moveTreeNodes:function moveTreeNodes(targetId,nodeIds,moveType,isSilent){var targetNode=this.tree.getNodeByParam('_id',targetId);if(!targetNode){return false;}
if(!moveType){moveType='inner';}
if(!isSilent){isSilent=false;}
_this.expandTreeNode(targetNode,true,function(){});for(var i=0;i<nodeIds.length;i++){var nodeId=nodeIds[i];var node=this.tree.getNodeByParam('_id',nodeId);if(node){this.tree.moveNode(targetNode,node,moveType,isSilent);_this.jqueryMap.$tagExplorer.find('.fileNumber').empty().append(beopTmpl('tpl_tags_fileNumber',{node:_this.tree.getNodesByParam('parentTId',_this.currentNode.tId)}));}}},removeTreeNodes:function removeTreeNodes(treeNodes){if(treeNodes){var ids=[];treeNodes.forEach(function(node){ids.push(node._id);});WebAPI.post('/tag/del',{"projId":AppConfig.projectId,"thingsIds":ids}).done(function(result){if(result.status){treeNodes.forEach(function(node){_this.tree.removeNode(node);});}
_this.clickTreeNode(_this.currentNode.tId);});}},renameTreeNodes:function renameTreeNodes(treeNode,name){if(!name||!name.trim()){return;}
treeNode.name=name.trim();var request_data={'projId':AppConfig.projectId,'name_new':name.trim(),'thingsId':treeNode._id};WebAPI.post('/tag/ThingsTree/rename',request_data).done(function(result){if(result.status){_this.jqueryMap.$tagsRightContent.find('.tag-list-item.active .tag-list-item-name').text(name);_this.tree.updateNode(treeNode);}else{if(result.message=='This name already exists'){infoBox.prompt(I18n.resource.common.ALREADY_THERE+name.trim()+I18n.resource.common.ALREADY_FOLDERS,function(text){if(!text||!text.trim()){alert(I18n.resource.common.EMPTY_NAME);}
_this.renameTreeNodes(treeNode,text);});}else{alert.danger(result.message);}}});},addTreeNodes:function addTreeNodes(ptid,treeNodes,isAddThisPage){if(!treeNodes||!treeNodes.length){return false;}
var parentNode=ptid?_this.tree.getNodeByTId(ptid):null;this.tree.addNodes(parentNode,0,treeNodes);if(isAddThisPage){for(var i=0;i<treeNodes.length;i++){this.jqueryMap.$tagList.prepend(beopTmpl('tpl_tag_explorer_item',{item:treeNodes[i]}));_this.jqueryMap.$tagExplorer.find('.fileNumber').empty().append(beopTmpl('tpl_tags_fileNumber',{node:_this.tree.getNodesByParam('parentTId',_this.currentNode.tId)}));}}},getSelectedTreeNodes:function getSelectedTreeNodes(){return this.filterPanel.tree.getSelectedNodes();},clickTreeNode:function clickTreeNode(tid){if(!tid){_this.renderRightTagsContent();}
this.$container.find('#'+tid+'_span').click();return this;},expandTreeNode:function expandTreeNode(pTreeNode,isDispatchEvent,func){if((typeof isDispatchEvent==='undefined'?'undefined':_typeof(isDispatchEvent))===(typeof undefined==='undefined'?'undefined':_typeof(undefined))){isDispatchEvent=true;}
if(pTreeNode&&!pTreeNode.open){_this.tree.expandNode(pTreeNode,true,false,true,true);}
func();return this;},logPath:function logPath(treeNode){var pathState=this.stateMap.explorerPath;if(pathState.index===pathState.path.length-1){var lastPath=pathState.path[pathState.path.length-1];if(treeNode){if(treeNode.tId===lastPath){return;}
pathState.path.push(treeNode.tId);}else{pathState.path.push('');}
pathState.index++;}else{pathState.path=pathState.path.slice(0,pathState.index+1);treeNode?pathState.path.push(treeNode.tId):pathState.path.push('');pathState.index=pathState.path.length-1;}},lastPath:function lastPath(){var pathState=this.stateMap.explorerPath;pathState.shouldLog=false;pathState.index--;return pathState.path[pathState.index];},nextPath:function nextPath(){var pathState=this.stateMap.explorerPath;pathState.shouldLog=false;pathState.index++;return pathState.path[pathState.index];},getThingFromTree:function getThingFromTree(parent,thingId){if(!parent){parent=_this.nodes;}
var ret;for(var i=0;i<parent.length;i++){var item=parent[i];if(item._id&&item._id===thingId){ret=item;break;}
if(item.children&&item.children.length){ret=this.getThingFromTree(item.children,thingId);}}
return ret;},movePointsToGroup:function movePointsToGroup(id){var $dragBox=$('#drag_box');if($dragBox.length){var thingIds=[];$dragBox.find('.drag-item').each(function(index,item){thingIds.push(item.dataset.id);});if(!thingIds||!thingIds.length){return false;}
if($.inArray(id,thingIds)!=-1){return false;}
Spinner.spin(_this.jqueryMap.$tagContent.get(0));WebAPI.post('/tag/moveThings',{Prt:id,thingsId:thingIds,projId:AppConfig.projectId}).done(function(result){if(result.status){for(var i=0;i<thingIds.length;i++){if(thingIds[i]){$('.tag-list-item[data-id='+thingIds[i]+']',_this.jqueryMap.$tagList).remove();}}
_this.jqueryMap.$tagsRightContent.find('.tag-list-item').removeClass('dropTarget');_this.moveTreeNodes(id,thingIds);}else{alert.danger('move failed');}}).always(function(){Spinner.stop();});$dragBox.remove();_this.stateMap.isDragging=false;}},addTag:function addTag(id){infoBox.prompt(I18n.resource.common.ENTER_NAME,function(text){var textHandle=text.trim();if(!textHandle){confirm(I18n.resource.common.EMPTY_NAME,function(){_this.addTag(id);});return;}
var request_data={'projId':AppConfig.projectId,'name':textHandle,'type':'group'};if(id){request_data['Prt']=id;}
WebAPI.post('/tag/ThingsTree/create',request_data).done(function(result){if(result.status){var pId=id?_this.tree.getNodeByParam('_id',id).tId:null;var isCurrentNode=_this.currentNode._id==id;if(!isCurrentNode){_this.expandTreeNode(_this.tree.getNodeByParam('_id',id),true,function(){});}
_this.addTreeNodes(pId,[{_id:result.id,name:textHandle,type:ThingType.group,isParent:true}],isCurrentNode);}else{if(result.message=='This name already exists'){confirm(I18n.resource.common.ALREADY_THERE+textHandle+I18n.resource.common.ALREADY_FOLDERS,function(){_this.addTag(id);});}else{alert.danger(result.message);}}});});},attachEvents:function attachEvents(){this.jqueryMap.$tagsRightContent.on('mousedown.tagsSelection',this._startTagSelection);this.jqueryMap.$tagContent.mousemove(this._processTagSelection);this.jqueryMap.$tagsRightContent.off('click.fileSelect').on('click.flieSelect','.tag-list-item',this._selectTagItem);this.jqueryMap.$tagContent.on('mouseup.tagsdrop',this._dropTags);this.jqueryMap.$tagsRightHeader.off('click.orderList').on('click.orderList','.glyphicon-th-list',function(){$('.tags-right-content').addClass('orderList');$(this).removeClass('btn-default').addClass('btn-primary').siblings('.glyphicon-th').removeClass('btn-primary').addClass('btn-default');});this.jqueryMap.$tagsRightHeader.off('click.orderNormal').on('click.orderNormal','.glyphicon-th',function(){$('.tags-right-content').removeClass('orderList');$(this).removeClass('btn-default').addClass('btn-primary').siblings('.glyphicon-th-list').removeClass('btn-primary').addClass('btn-default');});this.jqueryMap.$tagExplorer.off('click.backToTags').on('click.backToTags','#backToTags',function(){_this.jqueryMap.$tagExplorer.html(_this.$tagsExplorerChild);});this.jqueryMap.$tagExplorer.off('click.beginToIdentify').on('click.beginToIdentify','#beginToIdentify',function(){var opt={};opt.type=_this.identifyNode.type;opt.arrVariable=Object.keys(_this.allAttrType[_this.identifyNode.type].attrs);opt.arrClass=[];if(_this.identifyNode.unArrP&&_this.identifyNode.unArrP.length){for(var i=0,iLen=_this.identifyNode.unArrP.length;i<iLen;i++){opt.arrClass.push({"name":_this.identifyNode.unArrP[i]});}}
WebAPI.post('/diagnosisEngine/matchPoints',opt).done(function(result){console.log(result);});});$('.menu-mark-as').mouseenter(this._showMark).mouseleave(function(){$(this).find('ul').remove();}).on('click','li',function(){var $this=$(this),$selectedFiles=_this.jqueryMap.$tagsRightContent.find('.active'),thing_ids=[];for(var i=0;i<$selectedFiles.length;i++){thing_ids.push($selectedFiles[i].dataset.id);}
Spinner.spin(_this.jqueryMap.$tagExplorer[0]);WebAPI.post('/tag/setTag',{tagId:$this.data('id'),thingsIds:thing_ids,projId:AppConfig.projectId}).done(function(result){if(result.status){var tag=_this._getTagById($this.data('id'));$selectedFiles.each(function(index,selectedFile){var $selectedFile=$(selectedFile);var $selectedFileSpan=$selectedFile.find('.tag-list-icon');if(tag.icon){$selectedFileSpan.removeClass().addClass('iconfont tag-list-icon icon-'+tag.icon);}else{$selectedFileSpan.removeClass().addClass('glyphicon glyphicon-folder-close tag-list-icon folder');}
$selectedFile.data('tagid',tag._id);_this.updateTreeNodeById($selectedFile.data('id'),{'iconSkin':tag.icon?_this._makeIconSkin(tag.icon):''});if(tag.type===TagType.equipment){$selectedFile.data('ismarked',true);}});}}).always(function(){Spinner.stop();});});this.jqueryMap.$uploadInput.change(function(){var $this=$(this);_this._uploadHandler($this[0].files[0]);$this.val(null);});this.jqueryMap.$importTags.click(function(){_this.jqueryMap.$uploadInput.click();});this.jqueryMap.$syncPointToTree.click(function(){Spinner.spin(ElScreenContainer);WebAPI.get('/tag/syncCloudPointToThingTree/'+AppConfig.projectId).done(function(result){_this.tree=null;_this.renderRightTagsContent();}).always(function(){Spinner.stop();});});this.jqueryMap.$tagsRightContent.on('dblclick','.tag-folder',function(){var $this=$(this);var _id=$this.data('id');var treeNode=_this.tree.getNodeByParam('_id',_id);_this.expandTreeNode(treeNode,true,function(){_this.clickTreeNode(treeNode.tId);}.bind(this));});this.jqueryMap.$tagsRightContent.on('mouseup','.tag-folder',function(){if(_this.stateMap.isDragging){_this.movePointsToGroup($(this).data('id'));}});this.jqueryMap.$tagsPath.on('click','.tag-path',function(){_this.clickTreeNode($(this).data('tid'));});this.jqueryMap.$tagsRightContent.on('contextmenu','.tag-list-item',function(e){var $this=$(this);if(!$this.hasClass('active')){_this.jqueryMap.$tagsRightContent.find('.tag-list-item.active').removeClass('active');$this.addClass('active');}
var $selected_files=_this.jqueryMap.$tagsRightContent.find('.tag-list-item.active');var $firstSelectedFile=$($selected_files[0]);var $contentMenu=$('#contextMenu-item');$contentMenu.removeClass('hide_mark_as');if(!!$firstSelectedFile.data('ismarked')){$contentMenu.removeClass('hide-auto-identify');}else{$contentMenu.addClass('hide-auto-identify');}
if($firstSelectedFile.hasClass('tag-folder')){$contentMenu.removeClass('not_group_file');}else{$contentMenu.addClass('not_group_file');}
if($selected_files.length>1){if($selected_files&&$selected_files.length){var type=$($selected_files[0]).data('type');$contentMenu.removeClass('not_group_file');for(var i=1,iLen=$selected_files.length;i<iLen;i++){if(!$($selected_files[i]).hasClass('tag-folder')){$contentMenu.addClass('not_group_file');}}
for(var i=1,iLen=$selected_files.length;i<iLen;i++){if($($selected_files[i]).data('type')!=type){$contentMenu.addClass('hide_mark_as');break;}}}
$contentMenu.addClass('multiple-item');}else{$contentMenu.removeClass('multiple-item');}
_this.openContextMenu($contentMenu,e.pageX,e.pageY);return false;});this.jqueryMap.$tagsRightContent.contextmenu(function(e){_this.openContextMenu($('#contextMenu-panel'),e.pageX,e.pageY);return false;});this.jqueryMap.$container.on('click','.menu-new-tag',function(){_this.addTag(_this.addTagPid?_this.addTagPid:_this.currentNode._id);_this.addTagPid=null;});this.jqueryMap.$container.off('click.menu-delete').on('click.menu-delete','.menu-delete',function(){confirm(I18n.resource.common.DELETE_IT,function(){var $selectedItem=_this.jqueryMap.$tagsRightContent.find('.tag-list-item.active');_this.removeTreeNodes(_this.getTreeNodeByItem($selectedItem));$selectedItem.remove();});});this.jqueryMap.$container.off('click.menu-rename').on('click.menu-rename','.menu-rename',function(){infoBox.prompt('Please enter the new name.',function(text){if(!text||!text.trim()){alert(I18n.resource.common.EMPTY_NAME);}
var $selectedItem=_this.jqueryMap.$tagsRightContent.find('.tag-list-item.active');_this.renameTreeNodes(_this.getTreeNodeByItem($selectedItem)[0],text);});});this.jqueryMap.$container.off('click.menu-copy-file').on('click.menu-copy-file','.menu-copy-file',function(){_this.copyFiles=_this.jqueryMap.$tagsRightContent.find('.tag-list-item.active');$('.menu-paste').show();});this.jqueryMap.$container.off('click.paste').on('click.paste','.menu-paste',function(){var opt={};opt.projId=AppConfig.projectId;opt.Prt=_this.currentNode._id||'';opt.arrfolder=[];for(var i=0,iLen=_this.copyFiles.length;i<iLen;i++){opt.arrfolder.push(_this.tree.getNodeByParam('_id',$(_this.copyFiles[i]).data('id')));}
WebAPI.post('/tag/ThingsTree/copy',opt).done(function(result){if(result.status){_this.clickTreeNode(_this.currentNode.tId);if(!opt.Prt){_this.tree=null;}}});});this.jqueryMap.$container.off('click.menu-auto-identify').on('click.menu-auto-identify','.menu-auto-identify',function(){var $selectedItem=_this.jqueryMap.$tagsRightContent.find('.tag-list-item.active');var deviceTypePageMap={'57bd945b04c0960c84b7be2a':'1472524202584001fbddd71c','57bd946204c0960c84b7be2b':'14724400181410017ea9c796'};var tags=_this.tagDict,dictVariable={};var id=$selectedItem.data('id');var tagId=$selectedItem.data('tagid');if(!tagId||!deviceTypePageMap[tagId]){alert.danger('can\'t find the model');return;}
for(var i=0;i<tags.length;i++){var tag=tags[i];if(tag._id===tagId){for(var j=0;j<tag.attrP.length;j++){var attr=tag.attrP[j];dictVariable[attr.name]='';}
break;}}
var thing=_this.getThingFromTree(null,id);var arrVariable=[];for(var k=0;k<thing.children.length;k++){var point=thing.children[k];arrVariable.push(point._id);}
_this.diagnosisScreen=new DiagnosisConfigScreen({name:$selectedItem.data('name'),projId:AppConfig.projectId,thingId:id,srcPageId:deviceTypePageMap[tagId],dictVariable:dictVariable,arrVariable:arrVariable});_this.$tagsExplorerChild=_this.jqueryMap.$tagExplorer.children().detach();_this.diagnosisScreen.show(_this.jqueryMap.$tagExplorer,_this.filterPanel);_this.diagnosisScreen.showDeferred.done(function(){_this.jqueryMap.$container.find('#container-right').html(beopTmpl('tpl_auto_identify_list',{matchPoints:thing.children}));$('.identifyItem').on('dragstart',function(){EventAdapter.setData({'dsItemId':$(this).data('id')});});});});$(window).on('click.tag.contextMenu',_this.closeContextMenu);this.jqueryMap.$tagsLeftContainer.on('click','.glyphicon-chevron-down',function(){});this.jqueryMap.$tagsLeftContainer.on('click','.glyphicon-chevron-up',function(){_this.filterPanel.tree.expandAll(false);});this.jqueryMap.$tagsLeftContainer.on('click','#tagTreeShowAll',function(){_this.tree=null;_this.renderRightTagsContent(null,null,null,true);});this.jqueryMap.$tagsLeftContainer.on('click','.glyphicon-arrow-up',function(){if($(this).hasClass('disable')){return;}
if(_this.currentNode.parentTId){_this.clickTreeNode(_this.currentNode.parentTId);}else{_this.renderRightTagsContent();}});this.jqueryMap.$tagsLeftContainer.on('click','.next-path',function(){if($(this).hasClass('disable')){return;}
_this.clickTreeNode(_this.nextPath());});this.jqueryMap.$tagsLeftContainer.on('click','.last-path',function(){if($(this).hasClass('disable')){return;}
_this.clickTreeNode(_this.lastPath());});this.jqueryMap.$tagSearchBox.on('click','.glyphicon-search',function(){_this.searchTag();});this.jqueryMap.$tagSearch.on('keyup',function(e){if(e.which!=13){return;}
_this.searchTag();});},detachEvents:function detachEvents(){$(window).off('click.tag.contextMenu');}};$.extend(PointManagerImportTags.prototype,PointManagerImportTagsFunc);return PointManagerImportTags;}();var PointManagerExportData=function(){var _this;function PointManagerExportData(projectId){PointManager.call(this,projectId);_this=this;this.htmlUrl='/static/views/observer/pointManagerExportData.html';this.pageSize=20;this.currentPage=1;this.timeFormatMap={};this.configMap={cloudPointType:{MAPPING_POINT:0,VIRTUAL_POINT:1,CALC_POINT:2}};this.data={'projId':AppConfig.projectId,'startTime':'','endTime':'','isAll':false,'format':''};_this.selectPoints=[];}
PointManagerExportData.prototype=Object.create(PointManager.prototype);PointManagerExportData.prototype.constructor=PointManagerExportData;var PointManagerExportDataFunc={show:function show(){var _this=this;this.init().done(function(){_this.expertContainerUrlPromise=$.ajax({url:"/getExpertContainerUrl",type:"GET"}).done(function(result){if(result.success){_this.ExpertContainerUrl=result.data;$.ajax({url:_this.ExpertContainerUrl+'dataManage/exportData/file/delete',type:"POST",data:{projId:parseInt(AppConfig.projectId),fileName:JSON.stringify(['dataExport_1_201611021240_201611021640_m5.zip','dataExport_1_201611021220_201611021720_m5.zip','dataExport_1_201611021320_201611021720_m5.zip'])}}).done(function(result){console.log('delete ok');if(result.success){}});}else{alert('can\'t connect the ExpertContainer server.');}});_this.attachEvents();_this.loadSheet();I18n.fillArea($(ElScreenContainer));});},close:function close(){this.detachEvents();},attachEvents:function attachEvents(){var _this=this;var $exportDataBox=$("#exportDataBox");var $batchHistoryTimeStart=$("#batchHistoryTimeStart");var $batchHistoryTimeEnd=$("#batchHistoryTimeEnd");var $point_format=$("#point_format");_this.timeFormatMap={startView:'month',autoclose:true,minView:'hour',format:'yyyy-mm-dd hh:ii'};$point_format.change(function(){_this.data.format=$point_format.val();$batchHistoryTimeStart.val('');$batchHistoryTimeEnd.val('');$batchHistoryTimeStart.datetimepicker('remove');$batchHistoryTimeEnd.datetimepicker('remove');if(_this.data.format=='m5'){_this.timeFormatMap.minView='hour';_this.timeFormatMap.format='yyyy-mm-dd hh:ii';}else if(_this.data.format=='h1'){_this.timeFormatMap.minView='day';_this.timeFormatMap.format='yyyy-mm-dd hh:00';}else if(_this.data.format=='d1'){_this.timeFormatMap.minView='month';_this.timeFormatMap.format='yyyy-mm-dd 00:00';}
$batchHistoryTimeStart.datetimepicker(_this.timeFormatMap);$batchHistoryTimeEnd.datetimepicker(_this.timeFormatMap);});$batchHistoryTimeStart.datetimepicker(_this.timeFormatMap);$batchHistoryTimeEnd.datetimepicker(_this.timeFormatMap);$exportDataBox.off('click.exportData').on('click.exportData','#exportData',function(){_this.data.startTime=$batchHistoryTimeStart.val().trim();_this.data.endTime=$batchHistoryTimeEnd.val().trim();_this.data.format=$point_format.val();_this.data.userId=AppConfig.userId;if(!_this.data.startTime){alert('开始时间不可为空.');return;}
if(!_this.data.endTime){alert('结束时间不可为空.');return;}
if(_this.data.startTime&&_this.data.endTime){if(new Date(_this.data.endTime)>new Date()){alert('结束时间不能晚于现在的时间');return;}else if(new Date(_this.data.startTime)>new Date(_this.data.endTime)){alert('开始时间不能晚于结束时间');return;}}
if($('#batchAllPoints').is(':checked')){_this.data.isAll=true;if(_this.data.points){delete _this.data.points;}}else{_this.data.isAll=false;_this.data.points=JSON.stringify(_this.selectPoints);}
Spinner.spin(document.body);_this.expertContainerUrlPromise.done(function(){$.ajax({url:_this.ExpertContainerUrl+'dataManage/exportData/task/new',type:"POST",data:_this.data}).done(function(result){if(result){$.ajax({url:_this.ExpertContainerUrl+'dataManage/exportData/tasks',type:"POST",data:{projId:parseInt(AppConfig.projectId)}}).done(function(result){if(result&&result.length){$("#exportDataListTBody").html(beopTmpl('tpl_exportData_List',{list:result}));$exportDataBox.find("#exportDataList").modal();}});}else{alert('请求失败');}}).always(function(){Spinner.stop();});});});},loadSheet:function loadSheet(){_this.selectPoints=[];var $table=$("#exportData_list_table");var pageSizeIndex,$pageSizeSelect=$table.find(".pageSizeSelect");if($pageSizeSelect.length){pageSizeIndex=$pageSizeSelect.find("option:selected").index();}else{pageSizeIndex=1;}
var $batchAllPoints=$("#batchAllPoints");var dataTableOptions={url:'/point_tool/getCloudPointTable/',post:WebAPI.post,postData:{projectId:AppConfig.projectId,searchText:'',t_time:'',pageSize:_this.pageSize,currentPage:_this.currentPage},searchOptions:{pageSize:'pageSize',pageNum:'currentPage'},searchInput:$("#exportData_Search"),rowsNums:[5,25,50,100,200,500,1000],pageSizeIndex:pageSizeIndex,filters:[{param:'status',element:$batchAllPoints,event:'change',type:'checkbox'}],dataFilter:function dataFilter(result){if(result.success){return result.data.pointTable;}},onBeforeRender:function onBeforeRender(){Spinner.spin(document.body);},onAfterRender:function onAfterRender(){Spinner.stop();},totalNumIndex:'data.pointTotal',colNames:[I18n.resource.debugTools.exportData.SELECT,I18n.resource.debugTools.exportData.CONFIGURATION_POINT,I18n.resource.debugTools.exportData.REMARK,I18n.resource.debugTools.exportData.TYPE,I18n.resource.debugTools.exportData.UPDATE_TIME],colModel:[{index:'',checkbox:true,disabled:false,width:'60px'},{index:'value',width:'200px'},{index:'alias'},{index:'params.flag',converter:function converter(data){return _this.converterExportDataType(data.params.flag);}},{index:'pointTime'}],onCheckboxSelect:function onCheckboxSelect(checkbox,data,e){if($(checkbox).is(':checked')){_this.selectPoints.push(data.value);}else{var index=_this.selectPoints.indexOf(data.value);_this.selectPoints.slice(index,1);}
e.stopPropagation();}};if(_this.$datatable){_this.$datatable.removeData();_this.$datatable=null;}
_this.$datatable=$table.off().simpleDataTable(dataTableOptions);},converterExportDataType:function converterExportDataType(type){if(type==_this.configMap.cloudPointType.MAPPING_POINT){return'现场点';}else if(type==_this.configMap.cloudPointType.VIRTUAL_POINT){return'虚拟点';}else if(type==_this.configMap.cloudPointType.CALC_POINT){return'计算点';}}};$.extend(PointManagerExportData.prototype,PointManagerExportDataFunc);return PointManagerExportData;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(beop){var configMap={settable_map:{sheetModel:true},operateType:{NEW:'new',EDIT:'edit'},timeFormatMap:{startView:'month',autoclose:true,format:timeFormatChange('yyyy-mm-dd hh:ii'),forceParse:false},dataType:{HISTORY:'history',REAL_TIME:'realTime'},cloudPointType:{MAPPING_POINT:0,VIRTUAL_POINT:1,CALC_POINT:2},isWriteToRealTimeDb:{NOT_WRITE:0,WRITE:1},folderList:[{id:9,name:'系统功能'},{id:1,name:'时间函数'},{id:4,name:'取数'},{id:5,name:'能耗计算'}],sheetModel:null},stateMap={page_size:50,order:null,autoCompleteList:[],currentPage:1,logCurrentPage:1,allPointCurrentPage:1,pointTotal:0,currentPointIndex:-1,operateType:'',editor:null,ExpertContainerUrl:'',currentEditorText:'',pointId:'',moduleName:'',datePickerInstanceStart:null,datePickerInstanceEnd:null,templateInstance:null,dateFormat:{},transmitLogic:'',onlineTestType:1,addMultiplePointFormulaSearchValue:null,addMultiplePointValueFormulaValueArr:null,addMultiplePointValueFormulaIndex:-1,selectedPointValueList:[],selectedPointModuleNameList:[],selectedPointFormatList:[],selectedPointIdList:[],selectedPointLogicList:[],pointFormat:'m5',historyInfoList:[],multiplePointList:[],pointErrorLogName:'',scrollTop:0,requestTreeList:[],treeList:[],thingTreeList:[],zTreeInstance:null},jqueryMap={},setJqueryMap,configModel,importSheet,init,loadSheet,onNewPoint,onEditPoint,cloudPointConfirm,calcPointConfirm,logPaginationRefresh,deleteRows,deleteAllRows,onChangePointType,onfilerSort,setFilterSort,online_test,help,refreshDatePick,onPointTypeSelected,getPointsHandler,requestTimeHandler,online_test_request,setIsBatch,onConvertToCloud,import_from_template,save_as_template,loadPointTable,destroy,refreshEditor,onRefreshCloudPoint,loadLogPage,onOpenSinglePointSearchLog,onOpenSearchLog,onLogSearchCancel,logPageSizeChange,searchLogOfAWeek,searchLogOftoday,searchLogOfyesterday,searchLogOfOneHour,logSearch,logSinglePointSearch,logSearchDeleteAll,setDateFormat,serverRequestError,batch_history_quick_generate_data,batch_history_win,batchHistorySaveParam,batchHistoryPointValueAdd,refreshBatchHistoryUl,batchHistoryGenerate,batchGenerate,batchHistoryPointDelete,batchHistoryPointChange,getBatchHistoryPointMap,batchHistoryWinHideEvents,_getModuleName,loadAutoCompleteList,getBatchHistorySelectedPointInfoList,dateTimeCheck,getStartTime,projectCheckDataSync,setRealTimeDb,pointNameCheck,setCloudPointTypeName,editCancel,changeAddType,renderAddPointForm,submitMultiplePoint,testMultiplePoint,makeHeaderFixedTableScroll,showMorePointValue,loadPointDetailPage,backToRefreshTable,sendPointRequest,confirmCalcPointRequest,getPointModel,getMultiplePointsByForm,multiplePointListCheck,getTestPromiseList,multiplePointHandle,pointRefresh,joinCurve,changePageSize,setPointErrorNum,tryParseJSON,historyPointsSearchConfirm,historyStatus,realTimeStatus,clearInputTime,hidePointTimeBox,isValidPointName,allPointsCalc,allPointPaginationRefresh,refreshAllPointTable,calcPointSave,requestCalcPointSave,getCalcPointModel,loadApiTree,zTreeOnDrag,zTreeOnDrop,zTreeOnDblClick,changeToZTreeNodes,showNodeTitle,insertContent,_setTreeNodeIcon,enlargeFullScreen,treeSearch,batchAllPointsChange,cloudPoint_SetUp,btnPreservation;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$sheet:$container.find('.sheet'),$cloudPointWrapper:$('#cloudPointWrapper'),$point_add_btn:$container.find('#point_add'),$point_delete_btn:$container.find('#point_delete'),$point_refresh_btn:$container.find('#point_refresh'),$point_export:$container.find('#point_export'),$log_btn:$container.find('#log'),$logSearchBtn:$container.find('#logSearchBtn'),$text_search:$container.find('#text_search'),$cloudPointfilterSort:$container.find('#cloudPointfilterSort'),$uploadInput:$container.find('#uploadInput'),$count:$container.find('.count'),$paginationWrapper:$container.find('#paginationWrapper'),$editPointConfirm:$container.find('#editPointConfirm'),$editMappingPointConfirm:$container.find('#editMappingPointConfirm'),$editCalcPointConfirm:$container.find('#editCalcPointConfirm'),$pointForm:$container.find('#pointForm'),$point_edit:$container.find('#point_edit'),$point_id:$container.find('#point_id'),$point_name:$container.find('#point_name'),$pt_batchModal:$container.find('#pt_batchModal'),$point_notes:$container.find('#point_notes'),$point_notes_en:$container.find('#point_notes_en'),$editTitle:$container.find('#editTitle'),$datePickBox:$container.find('#datePickBox'),$point_format:$container.find('#point_format'),$online_test:$container.find('#online_test'),$online_test_process:$container.find('#test_process'),$onlineTestReturnInfo:$container.find('#onlineTestReturnInfo'),$dateTimeStart:$container.find('#dateTimeStart'),$dateTimeEnd:$container.find('#dateTimeEnd'),$pointConvert:$("#point_convert"),$setRealTimeDb:$("#setRealTimeDb"),$templateImportWinBox:$container.find('#templateImportWinBox'),$saveAsTemplateWinBox:$container.find('#saveAsTemplateWinBox'),$buttonGroup:$container.find('#buttonGroup'),$log:$container.find('#log'),$batchHistoryWin:$container.find('#batchHistoryWin'),$cloudPointSetUp:$container.find('#cloudPointSetUp'),$batchHistoryTimeStart:$container.find('#batchHistoryTimeStart'),$batchHistoryTimeEnd:$container.find('#batchHistoryTimeEnd'),$batchHistoryPointValue:$container.find('#batchHistoryPointValue'),$batchHistoryPoints:$container.find('#batchHistoryPoints'),$batchHistoryProgress:$container.find('#batchHistoryProgress'),$isBatch:$container.find('#isBatch'),$batchHistoryProgressInfo:$container.find('#batchHistoryProgressInfo'),$pointManagerCloudPointUl:$("#pointManagerCloudPointUl"),$cloudPointSourceSetBox:$("#cloudPointSourceSetBox"),$cloudPointTypeName:$("#cloudPointTypeName"),$pointManageWrapper:$container.find('#pointManageWrapper'),$isShowSubItem:$('#isShowSubItem'),$codeMirrorBox:$('#codeMirrorBox'),$cloudPointBtnBox:$('#cloudPointBtnBox'),$batchHistoryPointTime:$('#batchHistoryPointTime'),$historyStatus:$('#historyStatus'),$realTimeStatus:$('#realTimeStatus'),$historyPointsTimeStart:$('#historyPointsTimeStart'),$dataTypeStatusBox:$('#dataTypeStatusBox'),$historyPointsSearchConfirm:$('#historyPointsSearchConfirm'),$realTimeStatusTime:$('#realTimeStatusTime'),$historyTestTimePicker:$('#historyTestTimePicker'),$batchHistoryPointsBox:$('#batchHistoryPointsBox')};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};function CaclPoint(){this.input=null;this.formula=null;this.output=null;this.alias=null;this.flag=configMap.cloudPointType.CALC_POINT;this.format='m5';}CaclPoint.prototype={getLogic:function getLogic(){if(!this.formula){return null;}return BEOPUtil.logicContentHandle(this.formula+'('+this.input+')');},getModuleName:function getModuleName(){return _getModuleName(this.output);},test:function test(){if(!this.input||!this.formula||!this.output||!this.getLogic()){return $.Deferred().reject('input is empty');}if(!this.formula){return $.Deferred().reject('formula is empty');}if(!this.output){return $.Deferred().reject('output is empty');}return online_test_request(this.getLogic(),this.output,this.getModuleName());},getSaveModel:function getSaveModel(){return{value:this.output,logic:this.getLogic(),alias:this.alias,format:'m5',flag:this.flag,moduleName:this.getModuleName()};}};init=function init($container,page,pointType){stateMap.currentPointIndex=-1;stateMap.dataType=configMap.dataType.REAL_TIME;stateMap.$container=$container;stateMap.pointType=pointType;setJqueryMap();jqueryMap.$cloudPointBtnBox.html(beopTmpl('tpl_btn_group',{'pointType':pointType}));$.ajax({url:"/getExpertContainerUrl",type:"GET"}).done(function(result){if(result){stateMap.ExpertContainerUrl=result.data;loadAutoCompleteList();}});stateMap.tagTreePromise=WebAPI.post('tag/getThingTree',{projId:AppConfig.projectId,onlyGroupForRoot:true}).done(function(result){if(result.thingTree.length){stateMap.thingTreeList=result.thingTree;}});if(stateMap.historyStatusPopover){stateMap.historyStatusPopover.popover('destroy');$("#historyPointsTimeStart").closest('.popover').remove();}loadPointTable(page);stateMap.currentPage=parseInt(page);makeHeaderFixedTableScroll();$(window).resize(function(){makeHeaderFixedTableScroll();});};allPointPaginationRefresh=function allPointPaginationRefresh(){stateMap.allPointPageSize=50;var totalPages=Math.ceil(stateMap.allPointList.length/stateMap.allPointPageSize);$("#allPointPaginationContainer").empty().html('<ul id="allPointPagination" class="pagination fr"></ul>');while(totalPages<stateMap.allPointCurrentPage&&stateMap.allPointCurrentPage>1){stateMap.allPointCurrentPage=stateMap.allPointCurrentPage-1;}var pageOption={first:'&laquo;&laquo',prev:'&laquo;',next:'&raquo;',last:'&raquo;&raquo;',startPage:stateMap.allPointCurrentPage?parseInt(stateMap.allPointCurrentPage):1,totalPages:!totalPages?1:parseInt(totalPages),onPageClick:function onPageClick(event,page){stateMap.allPointCurrentPage=page;refreshAllPointTable(page);}};stateMap.pagination=$("#allPointPagination").twbsPagination(pageOption);};logPaginationRefresh=function logPaginationRefresh(totalNum){var totalPages=Math.ceil(totalNum/stateMap.logPageSize);$('#paginationContainer').empty().html('<ul id="logPagination" class="pagination"></ul>');while(totalPages<stateMap.logCurrentPage&&stateMap.logCurrentPage>1){stateMap.logCurrentPage=stateMap.logCurrentPage-1;}var pageOption={first:'&laquo;&laquo',prev:'&laquo;',next:'&raquo;',last:'&raquo;&raquo;',startPage:stateMap.logCurrentPage?parseInt(stateMap.logCurrentPage):1,totalPages:!totalPages?1:parseInt(totalPages),onPageClick:function onPageClick(event,page){stateMap.logCurrentPage=page;logSearch(page);}};$("#logPagination").twbsPagination(pageOption);$('.logContainer').scrollTop(0);};refreshAllPointTable=function refreshAllPointTable(currentPage){var page=currentPage?currentPage:1;var pointList=[];for(var i=(page-1)*stateMap.allPointPageSize;i<page*stateMap.allPointPageSize;i++){pointList.push(stateMap.allPointList[i]);if(i==stateMap.allPointList.length-1){break;}}$("#pointCalcTbody").empty().html(beopTmpl('tpl_all_point_calc',{'pointList':pointList}));$("#pointCalcTableBox").scrollTop(0);};clearInputTime=function clearInputTime(){jqueryMap.$historyTestTimePicker.val('');};realTimeStatus=function realTimeStatus(){stateMap.historyStatusPopover.popover('hide');stateMap.historyStatusPopover.data("bs.popover").inState.click=false;stateMap.dataType=configMap.dataType.REAL_TIME;jqueryMap.$cloudPointBtnBox.removeClass('history').addClass('real-time');loadSheet(1);};historyStatus=function historyStatus(){stateMap.historyPointsTimeStart=$("#historyPointsTimeStart").datetime({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii'});I18n.fillArea($("#cloudPointBtnBox"));};historyPointsSearchConfirm=function historyPointsSearchConfirm(){var timeVal=$("#historyPointsTimeStart").val().trim();if(!timeVal){alert('The time can\'t be empty.');return;}stateMap.dataType=configMap.dataType.HISTORY;stateMap.historyDataTime=timeVal;loadSheet();stateMap.historyStatusPopover.popover('hide');stateMap.historyStatusPopover.data("bs.popover").inState.click=false;jqueryMap.$realTimeStatusTime.val(timeVal);jqueryMap.$cloudPointBtnBox.removeClass('real-time').addClass('history');};loadAutoCompleteList=function loadAutoCompleteList(){var urlSuffix=localStorage.getItem('language')==='zh'?'apiTree':'apiTree/en';$.ajax({url:stateMap.ExpertContainerUrl+urlSuffix,type:"GET"}).done(function(result){if(result&&result.length){stateMap.requestTreeList=[];stateMap.autoCompleteList=[];for(var i=0;i<result.length;i++){if(result[i].api_type!=2){stateMap.requestTreeList.push(result[i]);stateMap.autoCompleteList.push({text:result[i].sample,displayText:result[i].name});}}}});};deleteRows=function deleteRows(){if(!stateMap.$datatable.simpleDataTable('getSelectedData').length){alert(i18n_resource.common.SELECT_RECORDS_REQUIRED);return;}confirm(I18n.resource.debugTools.sitePoint.IS_DELETE_POINTS,function(){Spinner.spin(document.body);var pointNameList=[],pointIdList=[];for(var i=0;i<stateMap.$datatable.simpleDataTable('getSelectedData').length;i++){var item=stateMap.$datatable.simpleDataTable('getSelectedData')[i];pointNameList.push(item.value);pointIdList.push(item._id);}
WebAPI.post('/point_tool/deleteCloudPoint/'+AppConfig.projectId+'/',{points:pointNameList,pointIds:pointIdList}).done(function(result){if(result.success){$.ajax({url:stateMap.ExpertContainerUrl+"clearData/"+AppConfig.projectId,type:"POST",data:{pointList:JSON.stringify(pointNameList)}}).done(function(result){try{if(result.error==0){loadSheet(stateMap.currentPage);}else{alert(I18n.resource.debugTools.info.DELETE_FAILED+':'+result.msg);Spinner.stop();}}catch(e){alert(I18n.resource.debugTools.info.DELETE_FAILED+':'+result.msg);Spinner.stop();}});}else{alert(I18n.resource.debugTools.info.DELETE_FAILED+':'+result.msg);Spinner.stop();}}).always(function(){Spinner.stop();});});};deleteAllRows=function deleteAllRows(){confirm(I18n.resource.debugTools.sitePoint.IS_DELETE_POINTS,function(){Spinner.spin(document.body);WebAPI.post('/point_tool/deleteCloudPoint/all/'+AppConfig.projectId+'/').done(function(result){if(result.success){$("#pointManageWrapper").find('.sheet tbody').empty();}else{alert(I18n.resource.debugTools.info.DELETE_FAILED+':'+result.msg);Spinner.stop();}}).always(function(){Spinner.stop();});});};destroy=function destroy(){stateMap.moduleName='';stateMap.onlineTestType=configMap.isWriteToRealTimeDb.WRITE;stateMap.historyInfoList=[];if(stateMap.$datatable){stateMap.$datatable.removeData();stateMap.$datatable=null;}if(stateMap.editor){stateMap.editor=null;}if(stateMap.datePickerInstanceStart){stateMap.datePickerInstanceStart=null;stateMap.datePickerInstanceEnd=null;}if(stateMap.containerDetach){stateMap.containerDetach=null;}if(stateMap.zTreeInstance){stateMap.zTreeInstance=null;}if(stateMap.zTreeSearchInstance){stateMap.zTreeSearchInstance=null;}stateMap.multiplePointList=[];stateMap.scrollTop=0;repairStatusTimeout&&clearTimeout(repairStatusTimeout);$(document).off("click.hidePointTimeBox");};setPointErrorNum=function setPointErrorNum(){return WebAPI.post('/api/errorlog/countoflog',{projId:AppConfig.projectId,type:''}).done(function(result){if(result.success){var total=0,$errorLogTotal=$('#errorLogTotal');for(var prop in result.data){total+=result.data[prop];}if(total){$errorLogTotal.text(total).show();}else{$errorLogTotal.text(total).hide();}var $sheetBody=stateMap.$datatable.find('tbody'),$sheetBodyClone=$sheetBody.clone(true);var $pointName=$sheetBodyClone.find('.point-name');$sheetBodyClone.find('.errorPoint').remove();$pointName.each(function(index,item){var $item=$(item);var pointName=$item.text().trim();if(result.data[pointName]){$('<span class="fl errorPoint">'+result.data[pointName]+'</span>').insertAfter($item);}});$sheetBody.replaceWith($sheetBodyClone);}});};makeHeaderFixedTableScroll=function makeHeaderFixedTableScroll(){$(".gray-scrollbar").find('.table').css("width",$(".table-responsive").find('table').css("width"));};loadPointTable=function loadPointTable(page){setJqueryMap();jqueryMap.$point_add_btn.off().on('click',onNewPoint);jqueryMap.$point_delete_btn.off().on('click',deleteRows);$("#point_delete_all").off().on('click',deleteAllRows);jqueryMap.$point_refresh_btn.off().click(onRefreshCloudPoint);jqueryMap.$log_btn.off().on('click',onOpenSearchLog);jqueryMap.$container.off('click.errorPoint').on('click.errorPoint','.sheet .errorPoint',onOpenSinglePointSearchLog);jqueryMap.$cloudPointfilterSort.off().on('change',onfilerSort);jqueryMap.$container.off('click.mappingPointConfirm').on('click.mappingPointConfirm','#mappingPointConfirm',cloudPointConfirm);jqueryMap.$container.off('click.calcPointConfirm').on('click.calcPointConfirm','#calcPointConfirm',calcPointConfirm);jqueryMap.$container.off('click.calcPointSave').on('click.calcPointSave','#calcPointSave',calcPointSave);jqueryMap.$uploadInput.off().change(importSheet);jqueryMap.$point_edit.off().on('click',onEditPoint);jqueryMap.$container.off('click.online_test').on('click.online_test','#online_test',online_test);jqueryMap.$container.off('click.import_from_template').on('click.import_from_template','#import_from_template',import_from_template);jqueryMap.$container.off('click.save_as_template').on('click.save_as_template','#save_as_template',save_as_template);jqueryMap.$container.off('click.help_document').on('click.help_document','.help-document',help);jqueryMap.$container.off('click.batch_history_quick_generate_data').on('click.batch_history_quick_generate_data','.batch_history_quick_generate_data',batch_history_quick_generate_data);jqueryMap.$container.off('click.batch_history').on('click.batch_history','#batch_history',batch_history_win);jqueryMap.$container.off('click.batchHistoryPointValueAdd').on('click.batchHistoryPointValueAdd','#batchHistoryPointValueAdd',batchHistoryPointValueAdd);jqueryMap.$container.off('click.batchHistoryGenerate').on('click.batchHistoryGenerate','#batchHistoryGenerate',batchHistoryGenerate);jqueryMap.$container.off('click.batchHistoryPointDelete').on('click.batchHistoryPointDelete','.batchHistoryPointDelete',batchHistoryPointDelete);jqueryMap.$container.off('click.cancelEdit').on('click.cancelEdit','.cancelEdit',editCancel);jqueryMap.$container.off('click.header').on('click.header','.header .btn',changeAddType);jqueryMap.$container.off('click.editMultiplePointConfirm').on('click.editMultiplePointConfirm','#editMultiplePointConfirm',submitMultiplePoint);jqueryMap.$container.off('click.searchCancel').on('click.searchCancel','#logSearchCancelBtn',onLogSearchCancel);jqueryMap.$container.off('change.logPageSizeChange').on('change.logPageSizeChange','#logPageSizeSelector',logPageSizeChange);jqueryMap.$container.off('click.searchLogsOfOneHour').on('click.searchLogOfOneHour','#searchLogOfOneHour',searchLogOfOneHour);jqueryMap.$container.off('click.searchLogsOfyesterday').on('click.searchLogOfyesterday','#searchLogOfyesterday',searchLogOfyesterday);jqueryMap.$container.off('click.searchLogsOftoday').on('click.searchLogOftoday','#searchLogOftoday',searchLogOftoday);jqueryMap.$container.off('click.searchLogsOfAWeek').on('click.searchLogOfAWeek','#searchLogOfAWeek',searchLogOfAWeek);jqueryMap.$container.off('click.searchLogsOfAWeek').on('click.searchLogOfAWeek','#searchLogOfAWeek',searchLogOfAWeek);jqueryMap.$container.off('click.logSearch').on('click.logSearch','#logSearchBtn',logSearch);jqueryMap.$container.off('click.editMultiplePointTest').on('click.editMultiplePointTest','#editMultiplePointTest',testMultiplePoint);jqueryMap.$container.off('click.algorithmPointConfirm').on('click.algorithmPointConfirm','#algorithmPointConfirm',cloudPointConfirm);jqueryMap.$batchHistoryWin.off('hide.bs.modal').on('hide.bs.modal',batchHistoryWinHideEvents);jqueryMap.$container.off('click.pointRefresh').on('click.pointRefresh','#pointRefresh',pointRefresh);jqueryMap.$container.off('click.joinCurve').on('click.joinCurve','#joinCurve',joinCurve);jqueryMap.$container.off('change.changePageSize').on('change.changePageSize','.cloudPageSizeSelector',changePageSize);jqueryMap.$pointConvert.click(onConvertToCloud);jqueryMap.$point_format.change(setDateFormat);jqueryMap.$setRealTimeDb.click(setRealTimeDb);jqueryMap.$container.off('click.logSearchDeleteAllBtn').on('click.logSearchDeleteAllBtn','#logSearchDeleteAllBtn',logSearchDeleteAll);jqueryMap.$container.off('click.batchHistoryPointTime').on('click.batchHistoryPointTime','#batchHistoryPointTime',batchHistoryPointChange);jqueryMap.$container.off('click.historyStatus').on('click.historyStatus','#historyStatus',historyStatus);jqueryMap.$container.off('click.realTimeStatus').on('click.realTimeStatus','#realTimeStatus',realTimeStatus);jqueryMap.$container.off('click.historyPointsSearchConfirm').on('click.historyPointsSearchConfirm','#historyPointsSearchConfirm',historyPointsSearchConfirm);jqueryMap.$container.off('click.clearInputTime').on('click.clearInputTime','#clearInputTime',clearInputTime);jqueryMap.$container.off('click.allPointsCalc').on('click.allPointsCalc','#allPointsCalc',allPointsCalc);jqueryMap.$container.off('click.enlargeFullScreen').on('click.enlargeFullScreen','#enlargeFullScreen',enlargeFullScreen);jqueryMap.$container.off('keydown.treeSearch').on('keydown.treeSearch','#treeSearch',treeSearch);jqueryMap.$container.off('click.batchAllPoints').on('click.batchAllPoints','#batchAllPoints',batchAllPointsChange);jqueryMap.$container.off('click.cloudPoint_SetUp').on('click.cloudPoint_SetUp','#cloudPoint_SetUp',cloudPoint_SetUp);jqueryMap.$container.off('click.btnPreservation').on('click.btnPreservation','#btnPreservation',btnPreservation);$(document).on("click.hidePointTimeBox",hidePointTimeBox);jqueryMap.$isBatch.change(setIsBatch);setFilterSort('0');loadSheet(page);$(".cloudPageSizeSelector").val(stateMap.page_size);stateMap.historyStatusPopover=jqueryMap.$historyStatus.popover({html:true,placement:'bottom',content:'history time setting',container:$("#cloudPointBtnBox"),template:$('#tpl_popover_template').html()});jqueryMap.$batchHistoryTimeStart.datetimepicker(configMap.timeFormatMap);jqueryMap.$batchHistoryTimeEnd.datetimepicker(configMap.timeFormatMap);I18n.fillArea(stateMap.$container);};allPointsCalc=function allPointsCalc(){confirm(I18n.resource.dataManage.IS_CALCULATE_ALL_POINTS,function(){Spinner.spin(document.body);$.ajax({url:stateMap.ExpertContainerUrl+"calcpoint/calcAllReal",type:"POST",data:{"projId":AppConfig.projectId}}).done(function(result){if(result){stateMap.allPointList=[];for(var prop in result){stateMap.allPointList.push({'name':prop,'value':result[prop]});}stateMap.allPointCurrentPage=1;allPointPaginationRefresh(stateMap.allPointList.length);refreshAllPointTable(stateMap.allPointCurrentPage);$("#isAllPointCalcWin").modal({keyboard:false,backdrop:'static'});}}).fail(function(e){serverRequestError(e);}).always(function(){Spinner.stop();});});};enlargeFullScreen=function enlargeFullScreen(){stateMap.editor.setOption("fullScreen",true);};hidePointTimeBox=function hidePointTimeBox(e){var $target=$(e.target);if(!$target.closest("#dataTypeStatusBox").length&&!$target.closest(".popover").length){stateMap.historyStatusPopover.data("bs.popover").inState.click=false;stateMap.historyStatusPopover.popover('hide');}};showMorePointValue=function showMorePointValue(tr,data){var prettyValue=data.pointValue;if(prettyValue&&prettyValue.indexOf('{')!=-1){try{eval('prettyValue = '+prettyValue);prettyValue=JSON.stringify(prettyValue,null,4);}catch(e){prettyValue=data.pointValue;}}alert('<pre style="border:none;">'+StringUtil.htmlEscape(prettyValue)+'</pre>',{icon:false,title:data.value,buttons:{copy:{i18n:'common.COPY',css:'btn-success',callback:function callback(){BEOPUtil.copyToClipboard(prettyValue);alert.success(I18n.resource.common.COPY_SUCCESS);}}},hasResize:true});};getStartTime=function getStartTime(dateType){var date=new Date();if(dateType==='today'){return date.format('yyyy-MM-dd 00:00:00');}else if(dateType==='week'){var getDay=date.getDay()==0?7:date.getDay();return new Date(date-(getDay-1)*86400000).format('yyyy-MM-dd 00:00:00');}else if(dateType==='month'){return new Date(date.getFullYear(),date.getMonth(),1).format('yyyy-MM-dd 00:00:00');}};setRealTimeDb=function setRealTimeDb(){infoBox.prompt(I18n.resource.debugTools.sitePoint.THE_PROJECT_DATA_NOT_CONNEDTED_WITH_THE_REAL_TIME_PROJECT_DATA,function(value){if($.trim(value)){WebAPI.post("/point_tool/setPJRealityTable",{"mysqlname":value,"projectId":AppConfig.projectId}).fail(function(){alert.danger(I18n.resource.debugTools.sitePoint.FAILED_TO_SYNCHRONIZE_DATA);}).done(function(){alert.success(I18n.resource.debugTools.sitePoint.SYNCHRONIZE_DATA_SUCCESSFULLY);});}else{alert.danger(I18n.resource.debugTools.sitePoint.FAILED_TO_SYNCHRONIZE_DATA_EMPTY);}},{buttons:{cancel:{callback:function callback(){window.localStorage.setItem("dataSyncCheckNotNotification",true);}}}});};getBatchHistoryPointMap=function getBatchHistoryPointMap(){var idList=[],valueList=[],logicList=[],formatList=[],moduleNameList=[];for(var i=0;i<stateMap.sheetData.length;i++){var data=stateMap.sheetData[i];idList.push(data._id);valueList.push(data.value);moduleNameList.push(_getModuleName(data.value));logicList.push(data.params.logic);formatList.push(data.params.format);}stateMap.batchHistoryPointMap={'idList':idList,'valueList':valueList,'logicList':logicList,'formatList':formatList,'moduleNameList':moduleNameList};};var stopRepairing=function stopRepairing(processId){return $.ajax({url:stateMap.ExpertContainerUrl+"repairData/stop",type:"POST",data:{'projId':AppConfig.projectId,'userId':AppConfig.userId,'obId':processId}});};var repairStatusTimeout=0;var isRepairing=function isRepairing(){var $batchHistoryFilterBox=$('#batchHistoryFilterBox');var $batchHistoryProgressBox=$('#batchHistoryProgressBox');var $batchHistoryWin=$('#batchHistoryWin');var sort=function sort(list){if(!list||!list.length){return[];}for(var i=0;i<list.length;i++){for(var j=i;j<list.length;j++){if(list[i]<list[j]){var tmp=list[i];list[i]=list[j];list[j]=tmp;}}}return list;};return $.ajax({url:stateMap.ExpertContainerUrl+"repairData/status/"+AppConfig.projectId,type:"GET"}).done(function(result){if(result){if(!result){return;}var sortedTasks=[];sort(Object.keys(result)).forEach(function(key){result[key].id=key;sortedTasks.push(result[key]);});$batchHistoryWin.addClass('repairing');$batchHistoryProgressBox.find('#repairTasks tbody').html(beopTmpl('tpl_task_progress',{tasks:sortedTasks}));repairStatusTimeout&&clearTimeout(repairStatusTimeout);repairStatusTimeout=setTimeout(isRepairing,3000);}else{$('#batchHistoryWin').removeClass('repairing');$batchHistoryFilterBox.show();}});};batch_history_win=function batch_history_win(){setJqueryMap();stateMap.selectedPointFormatList=[];stateMap.selectedPointIdList=[];stateMap.selectedPointModuleNameList=[];stateMap.selectedPointValueList=[];stateMap.selectedPointLogicList=[];stateMap.batchHistoryPointMap={};jqueryMap.$batchHistoryWin.modal({keyboard:false,backdrop:'static'});var $batchHistoryFilterBox=jqueryMap.$container.find('#batchHistoryFilterBox');if(localStorage.getItem('batchHistoryGenerateType')=='point'){jqueryMap.$batchHistoryPointTime.get(0).checked=true;jqueryMap.$batchHistoryTimeStart.val(localStorage.getItem('batchHistoryStartTimePoint')?localStorage.getItem('batchHistoryStartTime'):new Date().format('yyyy-MM-dd HH:mm:00'));jqueryMap.$batchHistoryTimeEnd.val('');$batchHistoryFilterBox.removeClass().addClass('batchHistoryTimePoint');}else{jqueryMap.$batchHistoryPointTime.get(0).checked=false;jqueryMap.$batchHistoryTimeStart.val(localStorage.getItem('batchHistoryStartTime')?localStorage.getItem('batchHistoryStartTime'):new Date().format('yyyy-MM-dd HH:mm:00'));jqueryMap.$batchHistoryTimeEnd.val(localStorage.getItem('batchHistoryEndTime')?localStorage.getItem('batchHistoryEndTime'):new Date().format('yyyy-MM-dd HH:mm:00'));$batchHistoryFilterBox.removeClass();}jqueryMap.$point_format.val(localStorage.getItem('batchHistoryFormat')?localStorage.getItem('batchHistoryFormat'):'m5');jqueryMap.$batchHistoryPointValue.val('');jqueryMap.$batchHistoryPoints.empty();jqueryMap.$batchHistoryProgress.empty().removeClass('progress').html('<span i18n="debugTools.sitePoint.NO_PROGRESS"></span>');jqueryMap.$batchHistoryProgressInfo.text("");getBatchHistorySelectedPointInfoList();stateMap.$datatable.simpleDataTable('getSelectedData').length&&refreshBatchHistoryUl();getBatchHistoryPointMap();if(!stateMap.selectedPointValueList||!stateMap.selectedPointValueList.length){jqueryMap.$batchHistoryWin.addClass('noPoints');}else{jqueryMap.$batchHistoryWin.removeClass('noPoints');}jqueryMap.$container.off('click.repair.stop').on('click.repair.stop','#batchHistoryWin .stop',function(){var $this=$(this);confirm(i18n_resource.dataManage.CONFIRM_STOP_REPAIR,function(){stopRepairing($this.closest('tr').attr('id')).done(function(result){if(result&&result.success){$this.closest('tr').find('.history-progress').text('已取消');}});});});Spinner.spin(jqueryMap.$batchHistoryWin.get(0));isRepairing().done(function(){}).always(function(){Spinner.stop();});};batchHistoryPointValueAdd=function batchHistoryPointValueAdd(){var val=jqueryMap.$batchHistoryPointValue.val().trim();if(val){if($.inArray(val,stateMap.selectedPointValueList)!==-1){alert(I18n.resource.debugTools.sitePoint.THIS_POINT_HAS_BEEN_ADDED_TO_THE_LIST_BELOW);}else{var index=$.inArray(val,stateMap.batchHistoryPointMap.valueList);if(index===-1){alert(I18n.resource.debugTools.sitePoint.ONLY_EXISTING_CALCULATION_POINTS_ARE_ALLOWED);}else{stateMap.selectedPointValueList.push(val);stateMap.selectedPointModuleNameList.push(stateMap.batchHistoryPointMap.moduleNameList[index]);stateMap.selectedPointFormatList.push(stateMap.batchHistoryPointMap.formatList[index]);stateMap.selectedPointIdList.push(stateMap.batchHistoryPointMap.idList[index]);stateMap.selectedPointLogicList.push(stateMap.batchHistoryPointMap.logicList[index]);refreshBatchHistoryUl();}}}else{alert(I18n.resource.debugTools.sitePoint.POINT_VALUE_CAN_NOT_BE_EMPTY);}};batchHistoryPointDelete=function batchHistoryPointDelete(){var val=$(this).closest('.batchHistoryPoint').find('.batchHistoryPointName').val();for(var i=0;i<stateMap.selectedPointValueList.length;i++){if(val==stateMap.selectedPointValueList[i]){stateMap.selectedPointValueList.splice(i,1);stateMap.selectedPointModuleNameList.splice(i,1);stateMap.selectedPointFormatList.splice(i,1);stateMap.selectedPointIdList.splice(i,1);stateMap.selectedPointLogicList.splice(i,1);break;}}refreshBatchHistoryUl();};batchHistoryPointChange=function batchHistoryPointChange(){var $batchHistoryFilterBox=jqueryMap.$container.find('#batchHistoryFilterBox');if(jqueryMap.$batchHistoryPointTime.is(':checked')){$batchHistoryFilterBox.removeClass().addClass('batchHistoryTimePoint');}else{$batchHistoryFilterBox.removeClass();}};batchAllPointsChange=function batchAllPointsChange(){if($('#batchAllPoints').is(':checked')){jqueryMap.$batchHistoryPointsBox.css('background','#ccc');jqueryMap.$batchHistoryPoints.empty().append(beopTmpl('tpl_batch_AllPoints',{allPoints:stateMap.sheetData}));}else{jqueryMap.$batchHistoryPointsBox.css('background','#eee');jqueryMap.$batchHistoryPoints.empty().html(beopTmpl('tpl_batch_history_add_point',{'valueList':stateMap.selectedPointValueList}));}I18n.fillArea(jqueryMap.$batchHistoryWin);};cloudPoint_SetUp=function cloudPoint_SetUp(){jqueryMap.$cloudPointSetUp.modal();WebAPI.post("/getCalcSettings/"+AppConfig.projectId,{projId:AppConfig.projectId}).done(function(returnData){$("#fixedTimeMode").prop("checked",!!returnData.data.triggerReal.fixed_time);$("#rawDataMode").prop('checked',!!returnData.data.triggerReal.raw_data);});};btnPreservation=function btnPreservation(){var data={projId:AppConfig.projectId,triggerReal:{fixed_time:$("#fixedTimeMode").prop('checked')?1:0,raw_data:$("#rawDataMode").prop('checked')?1:0}};WebAPI.post("/setCalcSettings/"+AppConfig.projectId,data).done(function(result){if(result.success){jqueryMap.$cloudPointSetUp.modal("hide");}else{alert.danger('server: set failed.');}});};batch_history_quick_generate_data=function batch_history_quick_generate_data(e){jqueryMap.$batchHistoryProgressInfo.text("");batchGenerate(getStartTime($(e.target).attr('dateType')),new Date().format('yyyy-MM-dd HH:00:00'));};batchHistorySaveParam=function batchHistorySaveParam(timeFrom,timeTo){jqueryMap.$batchHistoryPointTime.is(':checked')?localStorage.setItem('batchHistoryGenerateType','point'):localStorage.setItem('batchHistoryGenerateType','area');localStorage.setItem('batchHistoryStartTime',timeFrom);localStorage.setItem('batchHistoryEndTime',timeTo);localStorage.setItem('batchHistoryFormat',jqueryMap.$point_format.val().trim());localStorage.setItem('batchHistoryStartTimePoint',timeFrom);};batchHistoryGenerate=function batchHistoryGenerate(){jqueryMap.$batchHistoryProgressInfo.text("");var timeFrom=jqueryMap.$batchHistoryTimeStart.val().trim(),timeTo=jqueryMap.$batchHistoryTimeEnd.val().trim();if(jqueryMap.$batchHistoryPointTime.is(':checked')){timeTo=timeFrom;}else{try{if(dateTimeCheck(timeFrom,timeTo)){if(!stateMap.selectedPointValueList.length&&!$('#batchAllPoints').is(':checked')){alert.danger(I18n.resource.debugTools.sitePoint.NO_POINT_PLEASE_ADD);return;}timeFrom=new Date(timeFrom).format('yyyy-MM-dd HH:mm:00');timeTo=new Date(timeTo).format('yyyy-MM-dd HH:mm:00');}else{return;}}catch(e){alert.danger('the date format is invalid.');return false;}}batchGenerate(timeFrom,timeTo);};batchGenerate=function batchGenerate(timeFrom,timeTo){var requestRepairHistory=function requestRepairHistory(){Spinner.spin(document.body);$.ajax({url:stateMap.ExpertContainerUrl+"repairData/batch",type:"POST",data:{'list':JSON.stringify(stateMap.selectedPointValueList),'timeFrom':timeFrom,'timeTo':timeTo,'projId':AppConfig.projectId,'format':jqueryMap.$point_format.val().trim(),'userId':AppConfig.userId,'all':isAll}}).done(function(result){if(result){alert.success('start to repair history data...');isRepairing();}}).fail(function(e){serverRequestError(e);}).always(function(){Spinner.stop();});};if(jqueryMap.$batchHistoryPointTime.is(':checked')){timeTo=timeFrom;}batchHistorySaveParam(new Date(timeFrom).format('yyyy-MM-dd HH:mm'),new Date(timeTo).format('yyyy-MM-dd HH:mm'));var isAll=$('#batchAllPoints').is(':checked');if(isAll){confirm(I18n.resource.debugTools.sitePoint.CONFIRM_REPAIR_ALL_POINTS_HISTORY,function(){requestRepairHistory();});}else{requestRepairHistory();}};refreshBatchHistoryUl=function refreshBatchHistoryUl(){jqueryMap.$batchHistoryPoints.empty().html(beopTmpl('tpl_batch_history_add_point',{'valueList':stateMap.selectedPointValueList}));};setIsBatch=function setIsBatch(){stateMap.isBatch=jqueryMap.$isBatch.is(":checked");};getPointsHandler=function getPointsHandler(){var pointName=jqueryMap.$point_name.val().trim(),batchModel=jqueryMap.$pt_batchModal.val(),alias=jqueryMap.$point_notes.val()?jqueryMap.$point_notes.val().trim():'',model={},pointContent=stateMap.editor.doc.getValue().trim(),ret=[];if(!stateMap.isBatch){ret.push({name:pointName,content:pointContent,alias:alias});return ret;}try{batchModel=batchModel.trim().replace(/([^{:\s]+)(:)/g,"\"$1\"$2").replace(/'/g,"\"");model=JSON.parse(batchModel);}catch(e){alert(I18n.resource.debugTools.sitePoint.TEMPLATE_VARIABLE_IS_NOT_CORRECT);console.error('can\' parse the content'+e);return ret;}var handler=function handler(pointName,content,alias,replaceModel){for(var replaceItem in replaceModel){if(!replaceModel.hasOwnProperty(replaceItem)){continue;}var regex=new RegExp('<#'+replaceItem+'#>','gi');pointName=pointName.replace(regex,replaceModel[replaceItem]);content=content.replace(regex,replaceModel[replaceItem]);alias=alias.replace(regex,replaceModel[replaceItem]);}return{name:pointName,content:content,alias:alias};};var replaceModelList=[];var replaceListPlaceholder=function replaceListPlaceholder(item){if(replaceModelList.length){if(item.length>replaceModelList.length){item.splice(replaceModelList.length,item.length-replaceModelList.length);}else if(item.length<replaceModelList.length){replaceModelList.splice(item.length,replaceModelList.length-item.length);}}item.forEach(function(replaceItem,index){if(!replaceModelList[index]){replaceModelList[index]={};}replaceModelList[index][prop]=replaceItem;});};for(var prop in model){if(!model.hasOwnProperty(prop)){continue;}var item=model[prop];if($.isArray(item)){replaceListPlaceholder(item);}else if($.isPlainObject(item)){var min=parseInt(item["min"]);var max=parseInt(item["max"]);var step=parseInt(item["step"])||1;if(!min){item.min=1;}if(!max){alert(prop+' missing max value.');return[];}if(min>max){alert(prop+' min larger than max.');return[];}var propValueList=[];for(var k=min;k<=max;k=k+step){if(parseInt(item["pad"])&&parseInt(item["pad"])>0){propValueList.push(StringUtil.padLeft(k,parseInt(item["pad"]),'0'));}else{propValueList.push(k);}}replaceListPlaceholder(propValueList);}}replaceModelList.forEach(function(replaceModel){ret.push(handler(pointName,pointContent,alias,replaceModel));});return ret;};setDateFormat=function setDateFormat(){jqueryMap.$datePickBox.html(beopTmpl('tpl_date_item_refresh'));var val=jqueryMap.$point_format.val();stateMap.pointFormat=val;if(val=='d1'){stateMap.dateFormat={startView:'month',autoclose:true,minView:'month',format:'yyyy-mm-dd'};}else if(val=='h1'){stateMap.dateFormat={startView:'month',autoclose:true,minView:'day',format:'yyyy-mm-dd hh:00:00'};}else{stateMap.dateFormat={startView:'month',autoclose:true,minView:'hour',format:'yyyy-mm-dd hh:ii:00'};}refreshDatePick();};online_test=function online_test(){stateMap.onlineTestType=configMap.isWriteToRealTimeDb.NOT_WRITE;jqueryMap.$online_test.addClass('disabled');var newPoints=getPointsHandler();var testPromises=[];var historyTestTime=$("#historyTestTimePicker").val()||'';for(var m=0,len=newPoints.length;m<len;m++){var point=newPoints[m];testPromises.push(online_test_request(point.content,point.name));}var opt={};setJqueryMap();$.when.apply(null,testPromises).done(function(result){if(testPromises.length==1){opt.historyTestTime=historyTestTime;opt.newDate=new Date().format('yyyy-MM-dd HH:mm:ss');if(stateMap.isMultiple){for(var key in result.value){opt.process=result.value[key].process;if(parseInt(result.error)==1){opt.errorResult=result.value[key].value;}else{if($.isPlainObject(result.value[key].value)){opt.result=key+' = '+JSON.stringify(result.value[key].value,null,4);}else{opt.result=key+' = '+result.value[key].value;}}jqueryMap.$online_test_process.show().prepend(beopTmpl('tpl_test_progress',{opt:opt}));}}else{opt.process=result.process;if(parseInt(result.error)==1){opt.errorResult=result.value;}else{if($.isPlainObject(result.value)){opt.result=newPoints[0].name+' = '+JSON.stringify(result.value,null,4);}else{opt.result=newPoints[0].name+' = '+result.value;}}jqueryMap.$online_test_process.show().prepend(beopTmpl('tpl_test_progress',{opt:opt}));}}}).always(function(){Spinner.stop();jqueryMap.$online_test.removeClass('disabled');});};online_test_request=function online_test_request(content,pointName,moduleName){if((typeof content==='undefined'?'undefined':_typeof(content))===(typeof undefined==='undefined'?'undefined':_typeof(undefined))){content=stateMap.editor&&stateMap.editor.doc&&stateMap.editor.doc.getValue();}if(content.trim()===''){alert('code is required');return $.Deferred().reject();}if((typeof pointName==='undefined'?'undefined':_typeof(pointName))===(typeof undefined==='undefined'?'undefined':_typeof(undefined))){pointName=jqueryMap.$point_name.val().trim();}if((typeof moduleName==='undefined'?'undefined':_typeof(moduleName))===(typeof undefined==='undefined'?'undefined':_typeof(undefined))){moduleName=_getModuleName(pointName);}if(!stateMap.isMultiple&&(pointName==""||!pointNameCheck(pointName))){alert(I18n.resource.debugTools.info.POINT_NAME_PROMPT);return $.Deferred().reject();}var url=stateMap.ExpertContainerUrl,sendData={'content':BEOPUtil.logicContentHandle(content),'projId':AppConfig.projectId,'pointName':pointName,'moduleName':moduleName,'writeToReal':stateMap.onlineTestType};jqueryMap.$historyTestTimePicker=$("#historyTestTimePicker");if(stateMap.isMultiple){url+='cloudPoint/onlinetest/batch';}else{if(jqueryMap.$historyTestTimePicker.val()){url+='cloudPoint/history/onlinetest';sendData.timeAt=requestTimeHandler(new Date(jqueryMap.$historyTestTimePicker.val().format('yyyy-MM-dd HH:mm:ss')),'m5');}else{url+='cloudPoint/onlinetest';}}Spinner.spin(document.body);return $.ajax({url:url,type:"POST",data:sendData}).fail(function(e){jqueryMap.$onlineTestReturnInfo.text(I18n.resource.debugTools.sitePoint.SERVER_REQUEST_FAILED);serverRequestError(e);}).always(function(){jqueryMap.$online_test.removeClass('disabled');Spinner.stop();});};requestTimeHandler=function requestTimeHandler(time,format){var dateTime=new Date(time);if(format=='m1'){return dateTime.format('yyyy-MM-dd HH:mm:00');}if(format=='m5'){var minute=Math.floor(dateTime.getMinutes()/5)*5;return dateTime.format('yyyy-MM-dd HH:'+StringUtil.padLeft(minute,2,'0')+':00');}if(format=='h1'){return dateTime.format('yyyy-MM-dd HH:00:00');}if(format=='d1'){return dateTime.format('yyyy-MM-dd 00:00:00');}};serverRequestError=function serverRequestError(mes){console.log(mes);alert(I18n.resource.debugTools.sitePoint.SERVER_REQUEST_FAILED);};_getModuleName=function _getModuleName(str){return'calcpoint_'+AppConfig.projectId+'_'+str;};import_from_template=function import_from_template(){stateMap.currentEditorText=stateMap.editor.doc.getValue();beop.template.init({'container':jqueryMap.$templateImportWinBox,'opType':'import','confirmCallBack':function confirmCallBack(){stateMap.transmitLogic+=beop.template.getLogic();$('.templateWin').modal('hide');refreshEditor();}});};save_as_template=function save_as_template(){beop.template.init({'container':jqueryMap.$saveAsTemplateWinBox,'opType':'save','logic':stateMap.editor.doc.getValue()});};help=function help(){window.open("/static/help/"+localStorage.getItem('language')+"/cloud_point_api.html","BeOP help");};refreshDatePick=function refreshDatePick(){if(stateMap.datePickerInstanceStart){stateMap.datePickerInstanceStart=null;stateMap.datePickerInstanceEnd=null;}setJqueryMap();jqueryMap.$dateTimeStart.datetimepicker(stateMap.dateFormat);jqueryMap.$dateTimeEnd.datetimepicker(stateMap.dateFormat);stateMap.datePickerInstanceStart=jqueryMap.$dateTimeStart.data('datetimepicker');stateMap.datePickerInstanceEnd=jqueryMap.$dateTimeEnd.data('datetimepicker');};onfilerSort=function onfilerSort(){setFilterSort($(this).val());jqueryMap.$sheet.simpleDataTable('setSearch','order',stateMap.order);};setFilterSort=function setFilterSort(sortId){switch(sortId){case'0':{stateMap.order=[['_id',-1]];break;}case'1':{stateMap.order=[['value',1]];break;}case'2':{stateMap.order=[['value',-1]];break;}default:{stateMap.order=[['_id',-1]];}}};onChangePointType=function onChangePointType(){if(stateMap.pointType==configMap.cloudPointType.CALC_POINT){refreshEditor();jqueryMap.$codeMirrorBox.show();if(stateMap.operateType===configMap.operateType.NEW){jqueryMap.$point_format.val('m5');stateMap.pointFormat='m5';}}else{stateMap.editor=null;jqueryMap.$codeMirrorBox.empty().hide();}};batchHistoryWinHideEvents=function batchHistoryWinHideEvents(){repairStatusTimeout&&clearTimeout(repairStatusTimeout);$('#batchAllPoints').attr('checked',false);};refreshEditor=function refreshEditor(){stateMap.editor=null;jqueryMap.$codeMirrorBox.empty().append(beopTmpl('tpl_point_related_fun'));if(stateMap.transmitLogic){if(stateMap.currentEditorText==''){stateMap.currentEditorText+=stateMap.transmitLogic;}else{stateMap.currentEditorText+='\n\n'+stateMap.transmitLogic;}stateMap.transmitLogic='';}else{if(stateMap.operateType==configMap.operateType.NEW){stateMap.currentEditorText='';}else{var data=stateMap.sheetData[stateMap.currentPointIndex];if(data.params&&data.params.flag){if(data.params.flag==configMap.cloudPointType.CALC_POINT){stateMap.currentEditorText=data.params.logic;}else{stateMap.currentEditorText='';}}}}$("#codeEditor").text(stateMap.currentEditorText);jqueryMap.$codeMirrorBox.show();CodeMirror.commands.autocomplete=function(cm){cm.showHint({hint:function hint(editor,options){var WORD=/[\w$]+/;var word=options&&options.word||WORD;var cur=editor.getCursor(),curLine=editor.getLine(cur.line);var end=cur.ch,start=end;while(start&&word.test(curLine.charAt(start-1))){--start;}var curWord=start!=end&&curLine.slice(start,end);var candidates=stateMap.autoCompleteList.filter(function(item){return item.displayText.startsWith(curWord);});if(candidates.length===1){candidates.unshift({text:'',displayText:''});}return{list:candidates,from:CodeMirror.Pos(cur.line,start),to:CodeMirror.Pos(cur.line,end)};}});};stateMap.editor=CodeMirror.fromTextArea(document.getElementById('codeEditor'),{mode:"python",lineNumbers:true,indentUnit:4,tabMode:'spaces',autofocus:true});stateMap.editor.setOption("extraKeys",{Tab:function Tab(cm){if(cm.somethingSelected()){cm.indentSelection('add');}else{var spaces=new Array(cm.getOption("indentUnit")+1).join(" ");cm.replaceSelection(spaces);}},"F11":function F11(cm){cm.setOption("fullScreen",!cm.getOption("fullScreen"));},"Esc":function Esc(cm){if(cm.getOption("fullScreen"))cm.setOption("fullScreen",false);}});stateMap.editor.refresh();stateMap.editor.on("keyup",function(cm,e){if(e.keyCode!=8&&e.keyCode!=37&&e.keyCode!=38&&e.keyCode!=39&&e.keyCode!=40){CodeMirror.commands.autocomplete(cm);}});};setCloudPointTypeName=function setCloudPointTypeName(){jqueryMap.$cloudPointTypeName=$("#cloudPointTypeName");if(stateMap.pointType==configMap.cloudPointType.MAPPING_POINT){jqueryMap.$cloudPointTypeName.attr('i18n','dataManage.MAPPING_POINT');}else if(stateMap.pointType==configMap.cloudPointType.VIRTUAL_POINT){jqueryMap.$cloudPointTypeName.attr('i18n','dataManage.VIRTUAL_POINT');}else{jqueryMap.$cloudPointTypeName.attr('i18n','dataManage.CALCULATION_POINT');}I18n.fillArea(jqueryMap.$container);};editCancel=function editCancel(){stateMap.$treeDomDetach=$("#dmSysTreeInner").detach();if(stateMap.cloudPointWrapperDetach){jqueryMap.$cloudPointWrapper.html(stateMap.cloudPointWrapperDetach);jqueryMap.$container.find('#pointManageWrapper .table-body').scrollTop(stateMap.scrollTop);}};changeAddType=function changeAddType(){var $this=$(this);if($this.hasClass('btn-success')){return false;}stateMap.isMultiple=$this.hasClass('multiple');if(stateMap.isMultiple){$('#historyTestTimePicker').closest('.input-group').hide();$('#point_name').closest('.form-group').hide();}else{$('#historyTestTimePicker').closest('.input-group').show();$('#point_name').closest('.form-group').show();}$this.closest('.header').find('.btn').removeClass('btn-success').addClass('btn-default');$this.removeClass('btn-default').addClass('btn-success');renderAddPointForm();};getMultiplePointsByForm=function getMultiplePointsByForm(){stateMap.multiplePointList=[];$('#multiplePointTable tbody tr').each(function(index,tr){var $tr=$(tr);var pointIndex=jqueryMap.$multiplePointTable.find('tr').index($tr)-1;$tr.find('td').each(function(index,td){var $td=$(td);var prop=$td.data('prop');if($td.text()){if(!stateMap.multiplePointList[pointIndex]){stateMap.multiplePointList[pointIndex]=new CaclPoint();}stateMap.multiplePointList[pointIndex][prop]=$td.text().trim();if(prop=='output'){$tr.addClass($td.text().trim());}}});});};multiplePointListCheck=function multiplePointListCheck(){getMultiplePointsByForm();if(!stateMap.multiplePointList||!stateMap.multiplePointList.length){alert('the points is emtpy.');return false;}return true;};getTestPromiseList=function getTestPromiseList(){stateMap.testPromiseList=[];stateMap.isAllPassed=true;jqueryMap.$multiplePointTable=$('#multiplePointTable');jqueryMap.$multiplePointTable.find('.test').text('');stateMap.multiplePointList.forEach(function(point){stateMap.testPromiseList.push(point.test().done(function(result){if(result.error||!result.value){stateMap.isAllPassed=false;}jqueryMap.$multiplePointTable.find('tr.'+point.output).find('.test').text(''+result.value);}));});};multiplePointHandle=function multiplePointHandle(successCallback){if(multiplePointListCheck()){Spinner.spin(jqueryMap.$container.get(0));getTestPromiseList();$.when.apply(null,stateMap.testPromiseList).done(function(result){successCallback();}).fail(function(){alert('not all points passed, please check the failed point');return false;}).always(function(){Spinner.stop();});}};testMultiplePoint=function testMultiplePoint(){multiplePointHandle(function(){if(stateMap.isAllPassed){alert('all points passed.');}else{alert('not all points passed, please check the failed point');return false;}});};submitMultiplePoint=function submitMultiplePoint(){multiplePointHandle(function(){var savePromiseList=[];stateMap.multiplePointList.forEach(function(point){if(!point.isSaved){var addPointPromise=$.post('/point_tool/addCloudPoint/'+AppConfig.projectId+'/',point.getSaveModel()).done(function(result){if(result.success){point.isSaved=true;jqueryMap.$multiplePointTable.find('tr.'+point.output).remove();}else{if(I18n.resource.dataManage[result.msg]){alert(I18n.resource.dataManage[result.msg]);}else{alert(I18n.resource.dataManage.EXISTS_POINT);}}});savePromiseList.push(addPointPromise);}});$.when.apply(null,savePromiseList).done(function(result){if(stateMap.cloudPointWrapperDetach){jqueryMap.$cloudPointWrapper.html(stateMap.cloudPointWrapperDetach);}loadSheet(stateMap.currentPage);});});return false;};renderAddPointForm=function renderAddPointForm(){$('#pointForm').show();};loadPointDetailPage=function loadPointDetailPage(isEdit){stateMap.cloudPointWrapperDetach=jqueryMap.$cloudPointWrapper.children().detach();var pointModel={point:false};if(isEdit){pointModel={point:stateMap.sheetData[stateMap.currentPointIndex]};}if(stateMap.pointType==configMap.cloudPointType.MAPPING_POINT){jqueryMap.$cloudPointWrapper.html(beopTmpl('tpl_point_form_mapping',pointModel));var $pointMapping=$("#point_mapping"),$point_name=$("#point_name");if(stateMap.operateType==configMap.operateType.NEW){$pointMapping.removeAttr('readonly');}else{$pointMapping.attr('readonly',true);}}else if(stateMap.pointType==configMap.cloudPointType.VIRTUAL_POINT){jqueryMap.$cloudPointWrapper.html(beopTmpl('tpl_point_form_algorithm',pointModel));}else{jqueryMap.$cloudPointWrapper.html(beopTmpl('tpl_point_form_calc',pointModel));if(stateMap.zTreeInstance){$("#dmSysTree").html(stateMap.$treeDomDetach);}else{loadApiTree();}if(stateMap.operateType==configMap.operateType.EDIT){jqueryMap.$cloudPointWrapper.find('.header button').hide();}else{jqueryMap.$cloudPointWrapper.find('.header .point_translate').hide();}setDateFormat();refreshEditor();}configMap.timeFormatMap.format=timeFormatChange('yyyy-mm-dd hh:ii');$("#historyTestTimePicker").datetimepicker(configMap.timeFormatMap);setCloudPointTypeName();};backToRefreshTable=function backToRefreshTable(){if(stateMap.cloudPointWrapperDetach){jqueryMap.$cloudPointWrapper.html(stateMap.cloudPointWrapperDetach);}loadSheet(stateMap.currentPage);};onNewPoint=function onNewPoint(){stateMap.scrollTop=0;stateMap.operateType=configMap.operateType.NEW;stateMap.isMultiple=false;loadPointDetailPage();};onEditPoint=function onEditPoint(){stateMap.scrollTop=jqueryMap.$container.find('#pointManageWrapper .table-body').scrollTop();stateMap.operateType=configMap.operateType.EDIT;stateMap.isMultiple=false;if(stateMap.currentPointIndex==-1){alert('please select one point first.');return;}loadPointDetailPage(true);if(stateMap.pointType==configMap.cloudPointType.CALC_POINT){onChangePointType();stateMap.isBatch=false;var data=stateMap.sheetData[stateMap.currentPointIndex];if(data&&data.params.flag==configMap.cloudPointType.CALC_POINT){stateMap.moduleName=_getModuleName(data.value);stateMap.currentEditorText=data.params.logic;jqueryMap.$point_format.val(data.params.format);stateMap.pointFormat=data.params.format;}else{jqueryMap.$codeMirrorBox.empty().hide();}jqueryMap.$editTitle.attr('i18n','debugTools.sitePoint.EDIT_POINTS');I18n.fillArea(jqueryMap.$container);}};requestCalcPointSave=function requestCalcPointSave(url,point){Spinner.spin(document.body);return $.post(url,point).then(function(result){if(result.success){stateMap.pointId=result.data._id;Alert.success(document.body,I18n.resource.debugTools.info.MODIFY_SUCCESS).showAtTop(2000);stateMap.$treeDomDetach=$("#dmSysTreeInner").detach();backToRefreshTable();}else{var msg=I18n.resource.dataManage.EXISTS_POINT;if(I18n.resource.dataManage[result.msg]){msg=I18n.resource.dataManage[result.msg];if(result.data&&result.data.length){msg+=': '+'\n'+result.data.join('\n');}}alert(msg);$(".infoBox-msg").css('width','294px');return $.Deferred().reject();}}).always(function(){Spinner.stop();});};getPointModel=function getPointModel(){jqueryMap.$pointForm=$('#pointForm');var url,pointModel=jqueryMap.$pointForm.serializeObject();if(stateMap.operateType===configMap.operateType.NEW){if(stateMap.isMultiple){url='/point_tool/addCloudPoints/'+AppConfig.projectId+'/';}else{url='/point_tool/addCloudPoint/'+AppConfig.projectId+'/';}}else{url='/point_tool/editCloudPoint/'+AppConfig.projectId+'/';}if(pointModel){pointModel.flag=parseInt(stateMap.pointType);}if(stateMap.pointType==configMap.cloudPointType.CALC_POINT){$.extend(pointModel,{'logic':BEOPUtil.logicContentHandle(stateMap.editor.doc.getValue()),'moduleName':_getModuleName(jqueryMap.$point_name.val()),'format':jqueryMap.$point_format.val()});}return{'url':url,'pointModel':pointModel};};cloudPointConfirm=function cloudPointConfirm(){sendPointRequest(getPointModel().url,getPointModel().pointModel);};getCalcPointModel=function getCalcPointModel(){var model=getPointModel();stateMap.onlineTestType=configMap.isWriteToRealTimeDb.WRITE;$.extend(model.pointModel,{'logic':BEOPUtil.logicContentHandle(stateMap.editor.doc.getValue()),'moduleName':_getModuleName(jqueryMap.$point_name.val())});return{'url':model.url,'pointModel':model.pointModel};};isValidPointName=function isValidPointName(pointName){if(!/^[a-zA-Z]\w+$/.test(pointName)){alert(I18n.resource.admin.panelManagement.POINT_NAME);return false;}return true;};calcPointSave=function calcPointSave(){var model=getCalcPointModel();if(!stateMap.isMultiple&&!isValidPointName(model.pointModel.value)){return;}requestCalcPointSave(model.url,model.pointModel);};calcPointConfirm=function calcPointConfirm(){var model=getCalcPointModel();if(!stateMap.isMultiple&&!isValidPointName(model.pointModel.value)){return;}confirmCalcPointRequest(model.url,model.pointModel);};sendPointRequest=function sendPointRequest(url,pointModel){Spinner.spin(document.body);$.post(url,pointModel).done(function(result){if(result.success){Alert.success(document.body,I18n.resource.debugTools.info.MODIFY_SUCCESS).showAtTop(2000);backToRefreshTable();}else{if(I18n.resource.dataManage[result.msg]){alert(I18n.resource.dataManage[result.msg]);}else{alert(I18n.resource.dataManage.EXISTS_POINT);}Spinner.stop();}});};confirmCalcPointRequest=function confirmCalcPointRequest(url,pointModel){var points=getPointsHandler();var requestPromises=[];jqueryMap.$online_test_process=jqueryMap.$container.find('#test_process');points.forEach(function(point){$.extend(point,pointModel);point['alias']=pointModel['alias'];point['logic']=BEOPUtil.logicContentHandle(point['content']);point['moduleName']=_getModuleName(point['name']);point['value']=point['name'];delete point['name'];delete point['content'];var one_point_request=online_test_request(point['logic'],point['value'],point['moduleName']).then(function(resultDict){var historyTestTime=$("#historyTestTimePicker").val()||'';var opt={};opt.historyTestTime=historyTestTime;opt.newDate=new Date().format('yyyy-MM-dd HH:mm:ss');if(parseInt(resultDict.error)==0){return $.post(url,point).then(function(result){if(result.success){!stateMap.isMultiple?stateMap.pointId=result.data._id:'';}else{if(stateMap.isMultiple){var msg=I18n.resource.dataManage.EXISTS_POINT;if(I18n.resource.dataManage[result.msg]){msg=I18n.resource.dataManage[result.msg];if(result.data&&result.data.length){msg+=': '+result.data.join(',');}}alert(msg);}else{if(I18n.resource.dataManage[result.msg]){opt.errorResult=I18n.resource.dataManage[result.msg];}else{opt.errorResult=I18n.resource.dataManage.EXISTS_POINT;}jqueryMap.$online_test_process.show().prepend(beopTmpl('tpl_test_progress',{opt:opt}));}return $.Deferred().reject();}}).always(function(){Spinner.stop();});}else{if(stateMap.isMultiple){for(var key in resultDict.value){var opt={};opt.process=resultDict.value[key].process;if(parseInt(resultDict.value[key].error)==1){opt.errorResult=resultDict.value[key].value;}else{opt.result=key+' = '+resultDict.value[key].value;}'#test_process'.show().prepend(beopTmpl('tpl_test_progress',{opt:opt}));}}else{opt.errorResult=resultDict.value;jqueryMap.$online_test_process.show().prepend(beopTmpl('tpl_test_progress',{opt:opt}));Spinner.stop();}return $.Deferred().reject();}});requestPromises.push(one_point_request);});$.when.apply(null,requestPromises).done(function(){Alert.success(document.body,I18n.resource.debugTools.info.MODIFY_SUCCESS).showAtTop(2000);stateMap.$treeDomDetach=$("#dmSysTreeInner").detach();backToRefreshTable();});};pointNameCheck=function pointNameCheck(val){return/^[_a-zA-Z]\w+$/.test(val);};getBatchHistorySelectedPointInfoList=function getBatchHistorySelectedPointInfoList(){var selectedPoints=stateMap.$datatable.simpleDataTable('getSelectedData');for(var i=0;i<selectedPoints.length;i++){stateMap.selectedPointValueList.push(selectedPoints[i].value);stateMap.selectedPointModuleNameList.push(selectedPoints[i].params.moduleName);stateMap.selectedPointFormatList.push(selectedPoints[i].params.format);stateMap.selectedPointIdList.push(selectedPoints[i]._id);stateMap.selectedPointLogicList.push(selectedPoints[i].params.logic);}};dateTimeCheck=function dateTimeCheck(timeFrom,timeTo){if(timeFrom==''){alert(I18n.resource.debugTools.sitePoint.START_DATE_EMPTY_TIP);return false;}if(timeTo==''){alert(I18n.resource.debugTools.sitePoint.END_DATE_EMPTY_TIP);return false;}if(timeFrom>timeTo){alert(I18n.resource.debugTools.sitePoint.DATE_ERROR_TIP);return false;}return true;};changePageSize=function changePageSize(){stateMap.page_size=Number($(this).val());loadSheet();};tryParseJSON=function tryParseJSON(jsonString){try{var o=JSON.parse(jsonString);if(o&&(typeof o==='undefined'?'undefined':_typeof(o))==="object"){return o;}}catch(e){}return false;};joinCurve=function joinCurve(){var point_list=[],date_start,data_end,format,structure_list={};var selectedPoints=stateMap.$datatable.simpleDataTable('getSelectedData');if(!selectedPoints.length){return;}else if(selectedPoints.length<=10){selectedPoints.forEach(function(item){if(stateMap.pointType==configMap.cloudPointType.MAPPING_POINT){if(item.params.mapping&&item.params.mapping.point){point_list.push(item.params.mapping.point);}}else{var structure=tryParseJSON(item.pointValue);if(structure){var attrList=[];for(var attr in structure){attrList.push(attr);}structure_list[item.value]=attrList;}point_list.push(item.value);}});}else{alert(I18n.resource.dataManage.UP_TO_TEN_RECORDS);return;}Spinner.spin(ElScreenContainer);if(localStorage.getItem('dataManagerStartDate')){date_start=localStorage.getItem('dataManagerStartDate');data_end=localStorage.getItem('dataManagerEndDate');format=localStorage.getItem('dataManagerFormat')?localStorage.getItem('dataManagerFormat'):'m5';}else{date_start=new Date(new Date()-24*60*60*1000).format("yyyy-MM-dd HH:mm:00");data_end=new Date().format("yyyy-MM-dd HH:mm:00");format='m5';}var getHistoryDataReduce=function getHistoryDataReduce(hidePointList){hidePointList=hidePointList?hidePointList:[];WebAPI.post("/get_history_data_padded_reduce",{projectId:AppConfig.projectId,pointList:point_list.concat(hidePointList),timeStart:date_start.format("yyyy-MM-dd HH:mm:00"),timeEnd:data_end.format("yyyy-MM-dd HH:mm:00"),timeFormat:format,prop:structure_list}).done(function(data){var treeList=[];for(var key in data.data){treeList.push(key);}var obj={data:data,startDate:date_start,endDate:data_end,format:format,hidePointList:hidePointList,pointList:treeList,projectId:AppConfig.projectId,isShowRepairData:stateMap.pointType==configMap.cloudPointType.CALC_POINT};new HistoryChart(obj).show();}).fail(function(e){alert(I18n.resource.observer.widgets.HISTORY_CURVE_FAILED);}).always(function(){Spinner.stop();});};if(point_list.length==1){$.ajax({url:stateMap.ExpertContainerUrl+"calcpoint/getdepend/"+AppConfig.projectId+"/"+point_list[0],type:"GET"}).done(function(result){if(result.error==0){if(result.value){var hidePointList=[];if(result.value.flag0){hidePointList=hidePointList.concat(result.value.flag0);}if(result.value.flag1){hidePointList=hidePointList.concat(result.value.flag1);}if(result.value.flag2){hidePointList=hidePointList.concat(result.value.flag2);}}
hidePointList=hidePointList.filter(function(point){return point!=point_list[0];});getHistoryDataReduce(hidePointList);}else{alert('错误信息为：'+result.value);}}).fail(function(e){serverRequestError(e);});}else{getHistoryDataReduce();}};pointRefresh=function pointRefresh(){$("#cloudPointfilterSort").val(0);setFilterSort('0');loadSheet(stateMap.currentPage);};loadSheet=function loadSheet(page){Spinner.spin(jqueryMap.$container.get(0));setJqueryMap();onPointTypeSelected();page=(typeof page==='undefined'?'undefined':_typeof(page))=="object"||(typeof page==='undefined'?'undefined':_typeof(page))==(typeof undefined==='undefined'?'undefined':_typeof(undefined))?1:page;stateMap.currentPage=parseInt(page);var queryData={projectId:parseInt(AppConfig.projectId),currentPage:page,pointType:stateMap.pointType,searchOrder:stateMap.order,searchText:!jqueryMap.$text_search.val()||jqueryMap.$text_search.val().trim()===''?'':jqueryMap.$text_search.val().trim()};if(_typeof(stateMap.pointType)!==(typeof undefined==='undefined'?'undefined':_typeof(undefined))){queryData.pointType=stateMap.pointType;}if(stateMap.dataType==='history'){queryData.t_time=stateMap.historyDataTime+':00';}else{queryData.t_time='';}jqueryMap.$point_export.attr('href','/point_tool/export/cloud/'+AppConfig.projectId);projectCheckDataSync();var $pageSizeSelect=$("#pageSizeSelect");var pageSizeIndex;if($pageSizeSelect.length){pageSizeIndex=$pageSizeSelect.find("option:selected").index();}else{pageSizeIndex=1;}var dataTableOptions={url:'/point_tool/getCloudPointTable/',post:WebAPI.post,postData:queryData,searchOptions:{pageSize:'pageSize',pageNum:'currentPage'},searchInput:$("#text_search"),rowsNums:[25,50,100,200,500,1000],pageSizeIndex:pageSizeIndex,dataFilter:function dataFilter(result){if(result.success){stateMap.sheetData=result.data.pointTable;return result.data.pointTable;}},onBeforeRender:function onBeforeRender(){Spinner.spin($(".sheet").get(0));},onAfterRender:function onAfterRender(){setPointErrorNum();Spinner.stop();},onRowClick:function onRowClick(tr,data){stateMap.currentPointIndex=$(tr).index();},onRowDbClick:function onRowDbClick(tr,data){stateMap.currentPointIndex=$(tr).index();onEditPoint();},onShowMore:function onShowMore(tr,data,e){showMorePointValue(tr,data);e.stopPropagation();},totalNumIndex:'data.pointTotal'};if(stateMap.pointType==configMap.cloudPointType.MAPPING_POINT){dataTableOptions=$.extend(dataTableOptions,{colNames:[I18n.resource.debugTools.sheetHeaders.CONFIGURATION_POINT,I18n.resource.dataManage.REMARK,I18n.resource.debugTools.sheetHeaders.MAPPING_POINT,I18n.resource.dataManage.POINT_VALUE,I18n.resource.dataManage.UPDATE_TIME,I18n.resource.debugTools.sheetHeaders.CHANGE_MAN],colModel:[{index:'value',width:'20%'},{index:'alias',width:'20%'},{index:'params.mapping.point',width:'20%'},{index:'pointValue',copy:true,width:'20%'},{index:'pointTime',type:'time',width:'140px'},{index:'modify_by',width:'100px'}]});}else if(stateMap.pointType==configMap.cloudPointType.CALC_POINT||stateMap.pointType==configMap.cloudPointType.VIRTUAL_POINT){dataTableOptions=$.extend(dataTableOptions,{colNames:[I18n.resource.debugTools.sheetHeaders.CONFIGURATION_POINT,I18n.resource.dataManage.REMARK,I18n.resource.dataManage.POINT_VALUE,I18n.resource.dataManage.UPDATE_TIME,I18n.resource.debugTools.sheetHeaders.CHANGE_MAN],colModel:[{index:'value',width:'25%',itemClass:'point-name'},{index:'alias',width:'25%'},{index:'pointValue',copy:true,width:'30%'},{index:'pointTime',type:'time',width:'140px'},{index:'modify_by',width:'100px'}]});}else{return;}if(stateMap.$datatable){stateMap.$datatable.removeData();stateMap.$datatable=null;}stateMap.$datatable=jqueryMap.$sheet.off().simpleDataTable(dataTableOptions);};projectCheckDataSync=function projectCheckDataSync(){if(!window.localStorage.getItem("dataSyncCheckNotNotification")){WebAPI.get('/point_tool/dataSyncCheck/'+AppConfig.projectId).done(function(result){if(result.success){if(!result.data&&result.data.dataSync){infoBox.prompt(I18n.resource.debugTools.sitePoint.THE_PROJECT_DATA_NOT_CONNEDTED_WITH_THE_REAL_TIME_PROJECT_DATA,function(value){if($.trim(value)){WebAPI.post("/point_tool/setPJRealityTable",{"mysqlname":value,"projectId":AppConfig.projectId}).fail(function(){alert(I18n.resource.debugTools.sitePoint.FAILED_TO_SYNCHRONIZE_DATA);}).done(function(){alert(I18n.resource.debugTools.sitePoint.SYNCHRONIZE_DATA_SUCCESSFULLY);});}},{buttons:{cancel:{callback:function callback(){window.localStorage.setItem("dataSyncCheckNotNotification",true);}}}});}}});}};onPointTypeSelected=function onPointTypeSelected(){jqueryMap.$cloudPointSourceSetBox.hide();if(stateMap.pointType==configMap.cloudPointType.MAPPING_POINT){jqueryMap.$cloudPointSourceSetBox.show();}jqueryMap.$buttonGroup.addClass('pointType');};importSheet=function importSheet(event){var fileData=event.target.files[0];var formData=new FormData();formData.append('file',fileData);formData.append('projectId',AppConfig.projectId);formData.append('userId',68);var _this=$(this);Spinner.spin(document.body);$.ajax({url:"/point_tool/cloudPoint/import/",type:"POST",data:formData,enctype:'multipart/form-data',processData:false,contentType:false}).done(function(result){if(result.success){alert.success(i18n_resource.dataManage.DATA_IMPORT_SUCCESS);loadSheet(stateMap.currentPage);}else{alert.danger(result.msg||i18n_resource.common.REQUEST_ERROR);}}).always(function(){Spinner.stop();_this.val(null);});return false;};onRefreshCloudPoint=function onRefreshCloudPoint(){confirm(I18n.resource.debugTools.sitePoint.SYNCHRONIZE_ALL_POINTS_OR_NOT,function(){Spinner.spin(document.body);WebAPI.post('/point_tool/syncCloudPoint',{projectId:AppConfig.projectId}).done(function(result){alert(I18n.resource.debugTools.sitePoint.SYNCHRONIZATION_SUCCESSFUL+result.data+I18n.resource.debugTools.sitePoint.POINTS);loadSheet();}).always(function(){Spinner.stop();});});};onOpenSinglePointSearchLog=function onOpenSinglePointSearchLog(e){stateMap.scrollTop=jqueryMap.$container.find('#pointManageWrapper .table-body').scrollTop();var val=$(this).closest('td').find('.point-name').text();stateMap.pointErrorLogName=val;loadLogPage();e.stopPropagation();logSinglePointSearch(val);I18n.fillArea(jqueryMap.$container);};onOpenSearchLog=function onOpenSearchLog(){stateMap.scrollTop=0;stateMap.pointErrorLogName='';loadLogPage();logSearch();I18n.fillArea(jqueryMap.$container);};onLogSearchCancel=function onLogSearchCancel(){if(stateMap.cloudPointWrapperDetach){jqueryMap.$cloudPointWrapper.html(stateMap.cloudPointWrapperDetach);jqueryMap.$container.find('#pointManageWrapper .table-body').scrollTop(stateMap.scrollTop);setPointErrorNum();}};loadLogPage=function loadLogPage(){jqueryMap.$cloudPointWrapper=$('#cloudPointWrapper');stateMap.cloudPointWrapperDetach=jqueryMap.$cloudPointWrapper.children().detach();jqueryMap.$cloudPointWrapper.append(beopTmpl('tpl_search_log',{}));$("#logDateStart").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:ss'});$("#logDateEnd").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:ss'});if(!stateMap.logPageSize){stateMap.logPageSize=200;}setJqueryMap();};logPageSizeChange=function logPageSizeChange(){stateMap.logPageSize=$(this).val();logSearch();};searchLogOfOneHour=function searchLogOfOneHour(){var now=new Date();$('#logDateStart').attr('value',new Date(now.getTime()-60*60*1000).format('yyyy-MM-dd HH:mm:ss'));$('#logDateEnd').attr('value',now.format('yyyy-MM-dd HH:mm:ss'));logSearch();};searchLogOfyesterday=function searchLogOfyesterday(){var now=new Date();$('#logDateStart').attr('value',new Date(now-24*60*60*1000).format('yyyy-MM-dd 00:00:00'));$('#logDateEnd').attr('value',new Date(now-24*60*60*1000).format('yyyy-MM-dd 23:59:59'));logSearch();};searchLogOftoday=function searchLogOftoday(){$('#logDateStart').attr('value',new Date().format('yyyy-MM-dd 00:00:00'));$('#logDateEnd').attr('value',new Date().format('yyyy-MM-dd HH:mm:ss'));logSearch();};searchLogOfAWeek=function searchLogOfAWeek(){var now=new Date();$('#logDateStart').attr('value',new Date(now.getTime()-7*24*60*60*1000).format('yyyy-MM-dd HH:mm:ss'));$('#logDateEnd').attr('value',new Date().format('yyyy-MM-dd HH:mm:ss'));logSearch();};logSearch=function logSearch(page){Spinner.spin(document.body);var timeFrom=$('#logDateStart').val();var timeTo=$('#logDateEnd').val();var url='',data={projId:AppConfig.projectId,pageSize:stateMap.logPageSize,pageNum:+page?+page:1,type:''};if(stateMap.pointErrorLogName){url='/api/errorlog/onepoint';data.pointname=stateMap.pointErrorLogName;}else{url='/api/errorlog';if(!timeFrom){timeFrom=new Date().format('yyyy-MM-dd 00:00:00');$('#logDateStart').attr('value',timeFrom);}if(!timeTo){timeTo=new Date().format('yyyy-MM-dd 23:59:59');$('#logDateEnd').attr('value',timeTo);}}data.timeFrom=timeFrom;data.timeTo=timeTo;WebAPI.post(url,data).done(function(result){if(result.success==true){$('#totalLogsNum').text(result.data.total);stateMap.logCurrentPage=parseInt(page);logPaginationRefresh(result.data.total);$('#logReport').html(beopTmpl('tpl_search_log_result',{logList:result.data.records}));}else{alert(result.msg);}}).always(function(){Spinner.stop();});};logSinglePointSearch=function logSinglePointSearch(pointName,page){Spinner.spin(document.body);WebAPI.post('/api/errorlog/onepoint',{projId:AppConfig.projectId,pageSize:stateMap.logPageSize,pageNum:+page?+page:1,pointname:pointName,type:''}).done(function(result){if(result.success){$('#totalLogsNum').text(result.data.total);stateMap.logCurrentPage=parseInt(page);logPaginationRefresh(result.data.total);$('#logReport').html(beopTmpl('tpl_search_log_result',{logList:result.data.records}));}else{alert(result.msg);}}).always(function(){Spinner.stop();});};logSearchDeleteAll=function logSearchDeleteAll(){confirm(I18n.resource.debugTools.info.IS_CLEAR_LOG,function(){Spinner.spin(document.body);WebAPI.post('/api/errorlog/dellog',{projId:AppConfig.projectId,pointname:stateMap.pointErrorLogName?stateMap.pointErrorLogName:'',type:''}).done(function(result){if(result.success){$("#logReport").empty();$("#logPagination").hide();alert(I18n.resource.common.DELETE_SUCCESS);}else{alert(result.msg);}}).always(function(){Spinner.stop();});});};treeSearch=function treeSearch(e){var val=$("#treeSearch").val().trim();var $apiTreeUl=$("#apiTreeUl"),$apiTreeSearchUl=$("#apiTreeSearchUl");if(val==''){$apiTreeUl.show();$apiTreeSearchUl.hide();}else{if(e.keyCode===13){WebAPI.post('/tag/search',{"projId":AppConfig.projectId,"searchName":val,"path":''}).done(function(result){if(result.status){stateMap.treeSearchList=[];var treeNodeList,requestSearchTreeList=[];for(var i=0;i<stateMap.requestTreeList.length;i++){if(stateMap.requestTreeList[i].name.indexOf(val)!=-1){requestSearchTreeList.push(stateMap.requestTreeList[i]);}}treeNodeList=requestSearchTreeList.concat(result.thingsList);for(var i=0;i<treeNodeList.length;i++){var folderFlag,item=treeNodeList[i];folderFlag=item.type&&item.type=='group'?true:false;stateMap.treeSearchList.push({id:ObjectId(),name:item.name,sample:item.sample?item.sample:'',isFolder:folderFlag,isParent:folderFlag});}var zTreeSetting={view:{selectedMulti:false,addHoverDom:showNodeTitle.bind(this)},edit:{enable:true,showRemoveBtn:false,showRenameBtn:false},data:{simpleData:{enable:true}},callback:{onDblClick:zTreeOnDblClick,onDrag:zTreeOnDrag,onDrop:zTreeOnDrop.bind(this)}};$apiTreeUl.hide();stateMap.zTreeSearchInstance=$.fn.zTree.init($apiTreeSearchUl,zTreeSetting,stateMap.treeSearchList);var $span=$apiTreeSearchUl.find('a span[id$=_span]');var keywordList=val.replace('/[^\w\d\s]/g',' ').split(/\s/g);$span.each(function(index,item){var $item=$(item);var text=$item.text();keywordList.forEach(function(char){if(char){text=text.replace(new RegExp("("+char+")(?![^<]*>|[^<>]*</)","gi"),'<span class="search-tree-text">$1</span>');}});$item.html(text);});$apiTreeSearchUl.show();}else{alert('error:'+result.message);}}).always(function(){Spinner.stop();});}}};loadApiTree=function loadApiTree(){var zTreeSetting={view:{selectedMulti:false,addHoverDom:showNodeTitle.bind(this)},edit:{enable:true,showRemoveBtn:false,showRenameBtn:false},data:{simpleData:{enable:true}},callback:{onDblClick:zTreeOnDblClick,onDrag:zTreeOnDrag,onDrop:zTreeOnDrop.bind(this)},async:{enable:true,type:'post',url:'/tag/getThingTree',otherParam:{"projId":AppConfig.projectId,onlyGroupForRoot:true},autoParam:["_id=Prt"],dataFilter:function dataFilter(treeId,parentNode,responseData){return responseData.thingTree;}}};stateMap.tagTreePromise.done(function(){changeToZTreeNodes();stateMap.zTreeInstance=$.fn.zTree.init($("#apiTreeUl"),zTreeSetting,stateMap.treeList);});};zTreeOnDblClick=function zTreeOnDblClick(event,treeId,treeNode){if(treeNode.sample){insertContent(treeNode.sample);}else{insertContent(treeNode.name);}};zTreeOnDrag=function zTreeOnDrag(event,treeId,treeNodes){if(treeNodes[0].isParent){return false;}};zTreeOnDrop=function zTreeOnDrop(e,treeId,treeNodes,targetNode,moveType){if(!treeNodes[0].isParent){if($(e.target).closest('#codeMirrorBox').length){if(treeNodes[0].sample){insertContent(treeNodes[0].sample);}else{insertContent(treeNodes[0].name);}}}};changeToZTreeNodes=function changeToZTreeNodes(){stateMap.treeList=[];for(var i=0;i<stateMap.requestTreeList.length;i++){stateMap.treeList.push({id:ObjectId(),name:stateMap.requestTreeList[i].name,sample:stateMap.requestTreeList[i].sample,pId:stateMap.requestTreeList[i].api_type=='0'?9:stateMap.requestTreeList[i].api_type});}for(var j=0;j<configMap.folderList.length;j++){stateMap.treeList.push({id:configMap.folderList[j].id,name:configMap.folderList[j].name,pId:10,open:false,isFolder:true});}stateMap.treeList.push({id:10,name:I18n.resource.dataManage.SYSTEM_API,pId:0,open:false,isFolder:true});var tagFolderId=15;stateMap.treeList.push({id:tagFolderId,name:'Tag Structure',pId:0,open:false,isFolder:true,isParent:true});_setTreeNodeIcon(stateMap.thingTreeList,tagFolderId);stateMap.treeList=stateMap.treeList.concat(stateMap.thingTreeList);};_setTreeNodeIcon=function setTreeNodeIcon(node,rootId){for(var i=0;i<node.length;i++){if(rootId){node[i].pId=rootId;}if(node[i].tag&&node[i].tag.icon){node[i].iconSkin='iconfont icon-'+node[i].tag.icon;}if(node[i].children&&node[i].children.length){_setTreeNodeIcon(node[i].children,node[i]._id);}}};showNodeTitle=function showNodeTitle(treeId,treeNode){if(!treeNode.isParent){for(var i=0;i<stateMap.requestTreeList.length;i++){var item=stateMap.requestTreeList[i];if(treeNode.name==item.name){var titleHtml='api:  '+item.name+'\n'+I18n.resource.common.DESCRIPTION+':  '+item.dis_cription+'\n'+I18n.resource.common.EXAMPLE+':  '+item.sample;$("#"+treeNode.tId+"_a").attr('title',titleHtml);break;}}}};insertContent=function insertContent(value){stateMap.editor.replaceSelection(value);};beop.view=beop.view||{};beop.view.cloudSheet={configModel:configModel,init:init,destroy:destroy,loadSheet:loadSheet};})(beop||(beop={}));var PointManagerCloudPoint=function(){function PointManagerCloudPoint(projectId,pointType){PointManager.call(this,projectId);this.pointType=pointType;this.htmlUrl="/static/views/observer/pointManagerCloudPoint.html";}
PointManagerCloudPoint.prototype=Object.create(PointManager.prototype);PointManagerCloudPoint.prototype.constructor=PointManagerCloudPoint;var PointManagerCloudPointFunc={show:function show(){var _this=this;this.init().done(function(){beop.view.cloudSheet.init($("#cloudPointWrapper"),1,_this.pointType);I18n.fillArea($(ElScreenContainer));$('[data-toggle="tooltip"]').tooltip();});},close:function close(){beop.view.cloudSheet.destroy();}};$.extend(PointManagerCloudPoint.prototype,PointManagerCloudPointFunc);return PointManagerCloudPoint;}();var PointManagerDataAlarm=function(){var _this;function PointManagerDataAlarm(projectId){PointManager.call(this,projectId);_this=this;this.htmlUrl='/static/views/observer/pointManagerDataAlarm.html';this.pageSize=20;this.currentPage=1;this.pointNameList=[];this.ExpertContainerUrl='';this.treeList=[];this.userData=null;this.userHasSelected=null;this.configMap={page:{'list':'list','new':'new','edit_bool':'edit_bool','edit_limit':'edit_limit'},alarmType:{bool:1,limit:2}};this.statusMap={page:'list',alarmType:1};this.timeFormat={weekStart:1,autoclose:1,todayHighlight:1,startView:1,minView:0,maxView:1,format:'hh:ii',forceParse:0};}
PointManagerDataAlarm.prototype=Object.create(PointManager.prototype);PointManagerDataAlarm.prototype.constructor=PointManagerDataAlarm;var PointManagerDataAlarmFunc={show:function show(){this.init().done(function(){_this.$alarmBox=$("#dataAlarmBox");_this.pageInit();_this.requestUserMap();_this.attachEvents();I18n.fillArea($(ElScreenContainer));_this.expertContainerUrlPromise=$.ajax({url:"/getExpertContainerUrl",type:"GET"}).done(function(result){if(result.success){_this.ExpertContainerUrl=result.data;}else{alert('can\'t connect the ExpertContainer server.');}});});},pageInit:function pageInit(){this.tagTreePromise=WebAPI.post('tag/getThingTree',{projId:AppConfig.projectId,onlyGroupForRoot:true}).done(function(result){if(result.thingTree.length){_this.treeList=result.thingTree;}});$('#dataAlarmBox').html(beopTmpl('tpl_data_alarm_list'));_this.loadSheet();},close:function close(){this.detachEvents();this.resetParam();},resetParam:function resetParam(){if(_this.$treeDomDetach){_this.$treeDomDetach=null;}
if(_this.zTreeInstance){_this.zTreeInstance=null;}
if(_this.zTreeSearchInstance){_this.zTreeSearchInstance=null;}},loadSheet:function loadSheet(){var $table=$("#data_alarm_list_table");var pageSizeIndex,i18n=I18n.resource.dataManage,$pageSizeSelect=$table.find(".pageSizeSelect");if($pageSizeSelect.length){pageSizeIndex=$pageSizeSelect.find("option:selected").index();}else{pageSizeIndex=1;}
var $isShowAlarm=$("#isShowAlarm");var dataTableOptions={url:'/alarm/list',post:WebAPI.post,postData:{projectId:AppConfig.projectId,searchText:'',pageSize:_this.pageSize,pageNum:_this.currentPage},searchOptions:{pageSize:'pageSize',pageNum:'pageNum'},searchInput:$("#text_search"),rowsNums:[5,25,50,100,200,500,1000],pageSizeIndex:pageSizeIndex,filters:[{param:'status',element:$isShowAlarm,event:'change',type:'checkbox'}],dataFilter:function dataFilter(result){if(result.success){return result.data.records;}},onBeforeRender:function onBeforeRender(){Spinner.spin(document.body);},onAfterRender:function onAfterRender(){Spinner.stop();},totalNumIndex:'data.total',colNames:[i18n.ALARM_POINT,'是否启用','级别','类型','报警状态','更新时间','修改人'],colModel:[{index:'point',width:'200px'},{index:'',checkbox:true,checkboxParam:'beused',disabled:false},{index:'grade'},{index:'type',converter:function converter(data){return _this.converterAlarmType(data.type);}},{index:'alarm_result',converter:function converter(data){return _this.converterAlarmStatus(data.type,data.alarm_result);}},{index:'createtime',type:'time'},{index:'user_id'}],onRowClick:function onRowClick(tr,data){_this.currentPointData=data;_this.statusMap.page=_this.currentPointData.type==1?'edit_bool':'edit_limit';},onRowDbClick:function onRowDbClick(tr,data){_this.currentPointData=data;_this.statusMap.page=_this.currentPointData.type==1?'edit_bool':'edit_limit';_this.loadModifyCommon();_this.userHasSelected=_this.currentPointData.userHasSelected;$("#dataAlarmBox").find(".showPushList").html(beopTmpl('tpl_data_alarm_pushList',{members:_this.currentPointData.notify,notifyData:true}));},onCheckboxSelect:function onCheckboxSelect(checkbox,data,e){_this.currentPointData=data;_this.isEnableAlarm(checkbox,data,e);e.stopPropagation();}};if(_this.$datatable){_this.$datatable.removeData();_this.$datatable=null;}
_this.$datatable=$table.off().simpleDataTable(dataTableOptions);},converterAlarmType:function converterAlarmType(type){if(type==1){return'布尔量报警';}else if(type==2){return'高低限报警';}},converterAlarmStatus:function converterAlarmStatus(type,value){if(!value&&typeof value!="undefined"&&value!=0){return'';}
if(type==_this.configMap.alarmType.bool){if(value==1){return'正常';}else if(value==0){return'异常';}}else{if(value==1){return'正常';}else if(value==0){return'低于低限';}else if(value==-1){return'低于低低限';}else if(value==2){return'高于高限';}else if(value==3){return'高于高高限';}}},isEnableAlarm:function isEnableAlarm(checkbox,data,e){Spinner.spin(document.body);_this.currentPointData.beused=$(checkbox).is(':checked')?1:0;WebAPI.post('/alarm/add',_this.currentPointData).done(function(result){if(!result.success){alert(result.msg);}}).always(function(){Spinner.stop();});},refreshPointNameList:function refreshPointNameList(){$("#alarmPointListUl").empty().html(beopTmpl('tpl_data_alarm_name_list',{nameList:_this.pointNameList}));},getPersonnelInformation:function getPersonnelInformation(){var addPersonnelInformation=[];if(_this.userHasSelected==null||!_this.userHasSelected.length){return[];}else{for(var i=0;i<_this.userHasSelected.length;i++){var personnelInformation={id:null,userfullname:null,useremail:null,userpic:null};personnelInformation.id=_this.userHasSelected[i].id;personnelInformation.userfullname=_this.userHasSelected[i].userfullname;personnelInformation.useremail=_this.userHasSelected[i].useremail;personnelInformation.userpic=_this.userHasSelected[i].userpic;addPersonnelInformation.push(personnelInformation);}
return addPersonnelInformation;}},pushListData:function pushListData(){var notify=[];var pushListTr=$('#pushList tbody tr');if(_this.userHasSelected==null||!_this.userHasSelected.length){return notify;}else{for(var i=0;i<_this.userHasSelected.length;i++){var getObject={userId:null,userfullname:null,useremail:null,isWebSite:false,isEmail:false,isApp:false,isSMS:false};var fetchIndex=pushListTr.eq(i);if(fetchIndex.find('.isWebSite').is(':checked')){getObject.isWebSite=true;}
if(fetchIndex.find('.isApp').is(':checked')){getObject.isApp=true;}
if(fetchIndex.find('.isEmail').is(':checked')){getObject.isEmail=true;}
if(fetchIndex.find('.isSMS').is(':checked')){getObject.isSMS=true;}
getObject.userId=_this.userHasSelected[i].id;getObject.userfullname=_this.userHasSelected[i].userfullname;getObject.useremail=_this.userHasSelected[i].useremail;notify.push(getObject);}
return notify;}},loadTree:function loadTree(){var zTreeSetting={view:{selectedMulti:true},edit:{enable:true,showRemoveBtn:false,showRenameBtn:false},data:{simpleData:{enable:true}},callback:{onDrag:_this.zTreeOnDrag,onDrop:_this.zTreeOnDrop.bind(this)},async:{enable:true,type:'post',url:'/tag/getThingTree',otherParam:{"projId":AppConfig.projectId,onlyGroupForRoot:true},autoParam:["_id=Prt"],dataFilter:function dataFilter(treeId,parentNode,responseData){return responseData.thingTree;}}};this.tagTreePromise.done(function(){var tagFolderId=15;_this.treeList.push({id:tagFolderId,name:'Tag Structure',pId:0,open:false,isFolder:true,isParent:true});_this.setTreeNodeIcon(_this.treeList,tagFolderId);_this.zTreeInstance=$.fn.zTree.init($("#apiTreeUl"),zTreeSetting,_this.treeList);});},zTreeOnClick:function zTreeOnClick(event,treeId,treeNode){},zTreeOnDrag:function zTreeOnDrag(event,treeId,treeNodes){if(treeNodes[0].isParent){return false;}},zTreeOnDrop:function zTreeOnDrop(e,treeId,treeNodes,targetNode,moveType){if(treeNodes[0].isParent){return false;}
if($(e.target).closest('#alarm_limit_high').length){$("#alarm_limit_high").val(treeNodes[0].name);}else if($(e.target).closest('#alarm_limit_low').length){$("#alarm_limit_low").val(treeNodes[0].name);}else if($(e.target).closest('#alarmPointListUl').length){for(var i=0;i<treeNodes.length;i++){var node=treeNodes[i];if($.inArray(node.name,_this.pointNameList)<0){_this.pointNameList.push(node.name);_this.refreshPointNameList();}}}},setTreeNodeIcon:function setTreeNodeIcon(node,rootId){for(var i=0;i<node.length;i++){if(rootId){node[i].pId=rootId;}
if(node[i].tag&&node[i].tag.icon){node[i].iconSkin='iconfont icon-'+node[i].tag.icon;}
if(node[i].children&&node[i].children.length){this.setTreeNodeIcon(node[i].children,node[i]._id);}}},treeSearch:function treeSearch(e){var val=$("#treeSearch").val().trim();var $apiTreeUl=$("#apiTreeUl"),$apiTreeSearchUl=$("#apiTreeSearchUl");if(val==''){$apiTreeUl.show();$apiTreeSearchUl.hide();}else{if(e.keyCode===13){WebAPI.post('/tag/search',{"projId":AppConfig.projectId,"searchName":val,"path":''}).done(function(result){if(result.status){_this.treeSearchList=[];for(var i=0;i<result.thingsList.length;i++){var folderFlag,item=result.thingsList[i];folderFlag=item.type&&item.type=='group'?true:false;_this.treeSearchList.push({id:ObjectId(),name:item.name,sample:item.sample?item.sample:'',isFolder:folderFlag,isParent:folderFlag});}
var zTreeSetting={view:{selectedMulti:true},edit:{enable:true,showRemoveBtn:false,showRenameBtn:false},data:{simpleData:{enable:true}},callback:{onClick:_this.zTreeOnClick,onDrag:_this.zTreeOnDrag,onDrop:_this.zTreeOnDrop.bind(this)}};$apiTreeUl.hide();_this.zTreeSearchInstance=$.fn.zTree.init($apiTreeSearchUl,zTreeSetting,_this.treeSearchList);var $span=$apiTreeSearchUl.find('a span[id$=_span]');var keywordList=val.replace('/[^\w\d\s]/g',' ').split(/\s/g);$span.each(function(index,item){var $item=$(item);var text=$item.text();keywordList.forEach(function(char){if(char){text=text.replace(new RegExp("("+char+")(?![^<]*>|[^<>]*</)","gi"),'<span class="search-tree-text">$1</span>');}});$item.html(text);});$apiTreeSearchUl.show();}else{alert('error:'+result.message);}}).always(function(){Spinner.stop();});}}},newAlarmConfirm:function newAlarmConfirm(){if(!this.pointNameList.length){alert('点位列表不能为空！');return;}
var data={projectId:AppConfig.projectId,type:this.statusMap.alarmType,grade:$("#alarm_grade").val(),points:this.pointNameList,notify:this.pushListData(),userHasSelected:this.getPersonnelInformation()};if(_this.statusMap.alarmType==_this.configMap.alarmType.limit){data.threshold={};var upperVal=$("#alarm_limit_high").val().trim(),lowerVal=$("#alarm_limit_low").val().trim();if(upperVal&&lowerVal){if($.isNumeric(upperVal)&&$.isNumeric(lowerVal)&&+upperVal<+lowerVal){alert('报警上限不能低于报警下限！');return;}}
if(upperVal){data.threshold.high={};if($.isNumeric(upperVal)){data.threshold.high.type=1;data.threshold.high.value=Number(upperVal);}else{data.threshold.high.type=2;data.threshold.high.value=upperVal;}}
if(lowerVal){data.threshold.low={};if($.isNumeric(lowerVal)){data.threshold.low.type=1;data.threshold.low.value=Number(lowerVal);}else{data.threshold.low.type=2;data.threshold.low.value=lowerVal;}}}
Spinner.spin(document.body);this.requestAlarmAdd(data,'添加成功');},boolAlarmConfirm:function boolAlarmConfirm(){_this.currentPointData.grade=parseInt($("#alarm_grade").val());_this.currentPointData.advice=parseInt($("#alarm_advice").val());_this.currentPointData.msg=$("#alarm_msg").val();_this.currentPointData.interval=$("#alarm_interval").val();_this.currentPointData.notify=this.pushListData();_this.currentPointData.userHasSelected=this.getPersonnelInformation();Spinner.spin(document.body);this.requestAlarmAdd(_this.currentPointData,'修改成功');},limitAlarmConfirm:function limitAlarmConfirm(){_this.currentPointData.interval=$("#alarm_interval").val();_this.currentPointData.notify=this.pushListData();_this.currentPointData.userHasSelected=this.getPersonnelInformation();var threshold={highhigh:{},high:{},low:{},lowlow:{}};var $alarmSetBox=$("#dataAlarmForm").find('.alarm-set-box');for(var i=0;i<$alarmSetBox.length;i++){var type,$item=$alarmSetBox.eq(i);var val=$item.find('.alarm-value').val().trim(),grade=parseInt($item.find('.alarm-grade').val()),advice=$item.find('.alarm-advice').val(),msg=$item.find('.alarm-msg').val();if($.isNumeric(val)){type=1;val=Number(val);}else{type=2;}
if(i==0){threshold.highhigh.type=type;threshold.highhigh.value=val;threshold.highhigh.grade=grade;threshold.highhigh.advice=advice;threshold.highhigh.msg=msg;}else if(i==1){threshold.high.type=type;threshold.high.value=val;threshold.high.grade=grade;threshold.high.advice=advice;threshold.high.msg=msg;}else if(i==2){threshold.low.type=type;threshold.low.value=val;threshold.low.grade=grade;threshold.low.advice=advice;threshold.low.msg=msg;}else if(i==3){threshold.lowlow.type=type;threshold.lowlow.value=val;threshold.lowlow.grade=grade;threshold.lowlow.advice=advice;threshold.lowlow.msg=msg;}}
_this.currentPointData.threshold=threshold;Spinner.spin(document.body);this.requestAlarmAdd(_this.currentPointData,'修改成功');},requestAlarmAdd:function requestAlarmAdd(data,msg){data.type=parseInt(data.type);WebAPI.post('/alarm/add',data).done(function(result){if(result.success){_this.$treeDomDetach=$("#dmSysTreeInner").detach();if(_this.statusMap.page=='new'){_this.currentPage=1;}
alert(msg);$('#dataAlarmBox').html(beopTmpl('tpl_data_alarm_list'));_this.statusMap.page='list';_this.loadSheet();I18n.fillArea(_this.$alarmBox);}else{alert(result.msg);}}).always(function(){Spinner.stop();});},loadModifyCommon:function loadModifyCommon(){this.$alarmListDetach=this.$alarmBox.children().detach();this.$alarmBox.html(beopTmpl('tpl_data_alarm_modify'));_this.pointNameList=[];$("#data_alarm_content").html(beopTmpl('tpl_data_alarm_'+this.statusMap.page));if(this.$treeDomDetach){$("#dmSysTree").html(this.$treeDomDetach);}else{this.loadTree();}
if(this.statusMap.page!=this.configMap.page.new){$("#freeTimeStart").datetimepicker(this.timeFormat);$("#freeTimeEnd").datetimepicker(this.timeFormat);this.loadEditData();}
I18n.fillArea(_this.$alarmBox);},loadEditData:function loadEditData(){var $interval=$("#alarm_interval");$("#alarmPointName").val(this.currentPointData.point);this.currentPointData.interval?$interval.val(this.currentPointData.interval):$interval.val(2);if(this.currentPointData.type==this.configMap.alarmType.bool){$("#alarm_msg").val(this.currentPointData.msg);$("#alarm_grade").val(this.currentPointData.grade);$("#alarm_advice").val(this.currentPointData.advice);}else{var $alarmSetBox=$("#dataAlarmForm").find('.alarm-set-box');var threshold=this.currentPointData.threshold;for(var i=0;i<$alarmSetBox.length;i++){var $item=$alarmSetBox.eq(i);var $value=$item.find('.alarm-value'),$grade=$item.find('.alarm-grade'),$advice=$item.find('.alarm-advice'),$msg=$item.find('.alarm-msg');if(i==0){if(threshold.highhigh&&threshold.highhigh.value){$value.val(threshold.highhigh.value);$grade.val(threshold.highhigh.grade);$advice.val(threshold.highhigh.advice);$msg.val(threshold.highhigh.msg);}}else if(i==1){if(threshold.high&&threshold.high.value){$value.val(threshold.high.value);$grade.val(threshold.high.grade);$advice.val(threshold.high.advice);$msg.val(threshold.high.msg);}}else if(i==2){if(threshold.low&&threshold.low.value){$value.val(threshold.low.value);$grade.val(threshold.low.grade);$advice.val(threshold.low.advice);$msg.val(threshold.low.msg);}}else if(i==3){if(threshold.lowlow&&threshold.lowlow.value){$value.val(threshold.lowlow.value);$grade.val(threshold.lowlow.grade);$advice.val(threshold.lowlow.advice);$msg.val(threshold.lowlow.msg);}}}}},showInfoTable:function showInfoTable(){var getSelectedDataList=_this.$datatable.simpleDataTable('getSelectedData');if(!getSelectedDataList.length){alert(i18n_resource.common.SELECT_RECORDS_REQUIRED);return;}
var $alarmInfoTable=$("#alarmInfoTable");var pageSizeIndex,date_start,data_end,$pageSizeSelect=$alarmInfoTable.find(".pageSizeSelect");if($pageSizeSelect.length){pageSizeIndex=$pageSizeSelect.find("option:selected").index();}else{pageSizeIndex=1;}
if(localStorage.getItem('alarmInfoStartDate')){date_start=localStorage.getItem('alarmInfoStartDate');data_end=localStorage.getItem('alarmInfoEndDate');}else{date_start=new Date(new Date()-30*24*60*60*1000).format("yyyy-MM-dd HH:mm:00");data_end=new Date().format("yyyy-MM-dd HH:mm:00");}
var idList=[];for(var i=0;i<getSelectedDataList.length;i++){idList.push(getSelectedDataList[i]._id);}
var dataTableOptions={url:_this.ExpertContainerUrl+'alarm/history',postData:{projId:AppConfig.projectId,alarm_id:JSON.stringify(idList),s_time:date_start,e_time:data_end},searchOptions:{pageSize:'pageSize',pageNum:'pageNum'},rowsNums:[5,25,50,100,200,500,1000],pageSizeIndex:pageSizeIndex,dataFilter:function dataFilter(result){if(result){return result;}},onBeforeRender:function onBeforeRender(){Spinner.spin(document.body);},onAfterRender:function onAfterRender(){Spinner.stop();},colNames:['报警点名','报警类型','报警状态','报警时间'],colModel:[{index:'pointName'},{index:'alarm_type',converter:function converter(data){return _this.converterAlarmType(data.alarm_type);}},{index:'alarm_result',converter:function converter(data){return _this.converterAlarmStatus(data.alarm_type,data.alarm_result);}},{index:'alarm_time'}]};if(_this.$dataInfoTable){_this.$dataInfoTable.removeData();_this.$dataInfoTable=null;}
$("#alarmInfoModal").modal();_this.$dataInfoTable=$alarmInfoTable.off().simpleDataTable(dataTableOptions);},requestUserMap:function requestUserMap(){WebAPI.get('/workflow/group/user_team_dialog_list/'+window.parent.AppConfig.userId).done(function(result){if(result.success){_this.userData=result.data;}}).fail(function(){alert('服务器请求出错');});},attachEvents:function attachEvents(){this.$alarmBox.off('click.point_edit').on('click.point_edit','#point_edit',function(){if(_this.currentPointData&&_this.currentPointData.type){_this.statusMap.page=_this.currentPointData.type==1?'edit_bool':'edit_limit';_this.loadModifyCommon();}});this.$alarmBox.off('click.point_add').on('click.point_add','#point_add',function(){_this.statusMap.page=_this.configMap.page.new;if(_this.statusMap.page=='new'){_this.userHasSelected=[];}
_this.loadModifyCommon();});this.$alarmBox.off('click.point_delete').on('click.point_delete','#point_delete',function(){var getSelectedDataList=_this.$datatable.simpleDataTable('getSelectedData');if(!getSelectedDataList.length){alert(i18n_resource.common.SELECT_RECORDS_REQUIRED);return;}
confirm(I18n.resource.debugTools.sitePoint.IS_DELETE_POINTS,function(){Spinner.spin(document.body);var pidList=[];for(var i=0;i<getSelectedDataList.length;i++){pidList.push(getSelectedDataList[i]._id);}
WebAPI.post('/alarm/delete',{_id:pidList}).done(function(result){if(result.success){_this.loadSheet(_this.currentPage);}else{alert(I18n.resource.debugTools.info.DELETE_FAILED+':'+result.msg);Spinner.stop();}}).always(function(){Spinner.stop();});});});this.$alarmBox.off('click.alarm-type').on('click.alarm-type','.alarm-type',function(){var $alarm_new_limit_box=$("#alarm_new_limit_box");_this.statusMap.alarmType=$(this).val();if($(this).val()==_this.configMap.alarmType.bool){$alarm_new_limit_box.hide();}else{$alarm_new_limit_box.show();}});this.$alarmBox.off('click.freeTime').on('click.freeTime','#freeTime',function(){var $startTime=$("#freeTimeStart"),$startEnd=$("#freeTimeEnd");if($("#freeTime").is(':checked')){$startTime.attr('disabled',false).val('22:00');$startEnd.attr('disabled',false).val('06:30');}else{$startTime.attr('disabled',true).val('');$startEnd.attr('disabled',true).val('');}});this.$alarmBox.off('click.dataAlarmConfirm').on('click.dataAlarmConfirm','#dataAlarmConfirm',function(){if(_this.statusMap.page==_this.configMap.page.new){_this.newAlarmConfirm();}else if(_this.statusMap.page==_this.configMap.page.edit_bool){_this.boolAlarmConfirm();}else if(_this.statusMap.page==_this.configMap.page.edit_limit){_this.limitAlarmConfirm();}});this.$alarmBox.off('click.dataAlarmCancel').on('click.dataAlarmCancel','#dataAlarmCancel',function(){if(_this.$alarmListDetach){_this.$treeDomDetach=$("#dmSysTreeInner").detach();_this.$alarmBox.empty().html(_this.$alarmListDetach);}});this.$alarmBox.off('click.alarm-point-remove').on('click.alarm-point-remove','.alarm-point-remove',function(){for(var i=0;i<_this.pointNameList.length;i++){if($(this).closest('.alarm-point-li').find('.alarm-point-name').text()==_this.pointNameList[i]){_this.pointNameList.splice(i,1);break;}}
_this.refreshPointNameList();});this.$alarmBox.off('click.wf-people-add').on('click.wf-people-add','.wf-people-add',function(){beop.view.memberSelectedv2.init($("#dataManagerContainer"),{configModel:{userMemberMap:_this.userData,userHasSelected:_this.userHasSelected,cb_dialog_hide:function cb_dialog_hide(addedUserList){var thePreviousNotifyDate=_this.pushListData();_this.userHasSelected=addedUserList;var hasNotifyData=false;if(!(_this.statusMap.page=='new')&&thePreviousNotifyDate.length){var newAddUser=[];var recordedPersonnel=[];for(var j=0;j<thePreviousNotifyDate.length;j++){recordedPersonnel.push(thePreviousNotifyDate[j].userId);}
for(var i=0;i<addedUserList.length;i++){var indexValue=$.inArray(addedUserList[i].id,recordedPersonnel);if(indexValue<0){addedUserList[i].isWebSite=true;addedUserList[i].isEmail=true;newAddUser.push(addedUserList[i]);}else{newAddUser.push(thePreviousNotifyDate[indexValue]);}}
hasNotifyData=true;addedUserList=newAddUser;}
$("#pushList").html(beopTmpl('tpl_data_alarm_pushList',{members:addedUserList,notifyData:hasNotifyData}));},hasFrame:true}});});this.$alarmBox.off('keydown.treeSearch').on('keydown.treeSearch','#treeSearch',_this.treeSearch);this.$alarmBox.off('click.showInfoTable').on('click.showInfoTable','#showInfoTable',_this.showInfoTable);},detachEvents:function detachEvents(){this.$alarmBox.off('keydown.treeSearch');}};$.extend(PointManagerDataAlarm.prototype,PointManagerDataAlarmFunc);return PointManagerDataAlarm;}();var Diagnosis=function(){var _this;function Diagnosis(projectId){_this=this;PointManager.call(this,projectId);this.htmlUrl='/static/views/observer/diagnosis.html';this.url_prefix='/cloudDiagnosis/';this.currentFile=null;this.currentDiagnosisId='';this.editor=null;this.testResult=[];this.moduleNameRegex=/^[a-zA-Z]\w+$/;this.ExpertContainerUrl='';this.transmitLogic='';this.currentEditorText='';this.requestTreeList=[];this.treeList=[];this.thingTreeList=[];this.autoCompleteList=[];this.zTreeInstance=null;this.zTreeFaultInstance=null;this.moduleStatusMap=null;this.countofLogMap=null;this.pointErrorLogName='';this.logPageSize=200;this.logCurrentPage=1;this.diagnosisPromise=$.Deferred();this.clipboardData=[];this.pointLogTypeMap={all:'all',single:'single'};this.newNode=null;this.currentPointLogType=this.pointLogTypeMap.single;this.folderList=[{id:9,name:'系统功能'},{id:1,name:'时间函数'},{id:2,name:'诊断函数'},{id:4,name:'取数'},{id:5,name:'能耗计算'}];}
Diagnosis.prototype=Object.create(PointManager.prototype);Diagnosis.prototype.constructor=Diagnosis;var DiagnosisFunc={show:function show(){this.init().done(function(){$.ajax({url:"/getExpertContainerUrl",type:"GET"}).done(function(result){if(result.success){_this.ExpertContainerUrl=result.data;_this.diagnosisPromise.resolve();}else{alert('can\'t connect the ExpertContainer server.');}}).fail(function(){_this.diagnosisPromise.reject();});_this.attachEvents();_this.getTreeData();_this.initDiagnosisTree();_this.tagTreePromise=WebAPI.post('tag/getThingTree',{projId:AppConfig.projectId,onlyGroupForRoot:true}).done(function(result){if(result.thingTree.length){_this.thingTreeList=result.thingTree;}});_this.diagnosisPromise.done(function(){_this.moduleStatusPromise=$.ajax({url:_this.ExpertContainerUrl+'diagnosis/get/moduleStatus/'+AppConfig.projectId,type:"GET"}).done(function(result){if(result){_this.moduleStatusMap=result;}});_this.countofLogPromise=WebAPI.post('/api/errorlog/countoflog',{projId:AppConfig.projectId,type:'diag'}).done(function(result){if(result.success){_this.countofLogMap=result.data;_this.setDiagnosisFaultTotal();}});});I18n.fillArea($(ElScreenContainer));});},close:function close(){this.detachEvents();if(this.editor){this.editor=null;}
$(document).off('keydown.CopyAndPaste');},attachEvents:function attachEvents(){var $diagnosisCodeMainBox=$("#diagnosisCodeMainBox");this.$container.off('click.diagnosisFileAdd').on('click.diagnosisFileAdd','#diagnosisFileAdd',function(){$diagnosisCodeMainBox.html(beopTmpl('tpl_diagnosis_code_Info'));if(!_this.zTreeInstance){_this.loadTree();}
$("#diagnosisCodeTitle").attr('i18n','common.ADD');_this.currentDiagnosisId='';$diagnosisCodeMainBox.find("input").val('');_this.currentEditorText='';_this.refreshEditor();I18n.fillArea(_this.$container);$("#diagnosisFilesUl").find('.active').removeClass('active');var newNode={name:I18n.resource.diagnosis.config.faultAlarm.NAME};_this.newNode=_this.zTreeFaultInstance.addNodes(_this.getParentNodeByAdd(),newNode);_this.zTreeFaultInstance.selectNode(_this.newNode[0]);}).off('click.diagnosisConfirm').on('click.diagnosisConfirm','#diagnosisConfirm',function(){var moduleNameVal=$("#diagnosisModuleName").val().trim();var codeVal=_this.editor.doc.getValue();if(!moduleNameVal){alert.danger('diagnosis name code can\'t be empty.');return;}
if(!codeVal){alert.danger('diagnosis code can\'t be empty.');return;}
if(!_this.moduleNameRegex.test(moduleNameVal)){alert(I18n.resource.admin.panelManagement.POINT_NAME);return;}
Spinner.spin(_this.$container[0]);var parent=_this.getParentNodeByAdd();WebAPI.post(_this.url_prefix+'saveCustomDiagnosis',{moduleName:moduleNameVal,logic:BEOPUtil.logicContentHandle(codeVal),faultDescription:$("#diagnosisFaultDescription").val().trim(),projId:AppConfig.projectId,_id:_this.currentDiagnosisId,Parent:parent?parent._id:-1}).done(function(result){if(result.success){var node;if(_this.currentDiagnosisId){node=_this.getCurrentNode();if(node){$.extend(node,_this._convertDiagnosisToNode(result.data));_this.zTreeFaultInstance.updateNode(node);}}else{_this.currentDiagnosisId=result.data._id;$.extend(_this.newNode[0],_this._convertDiagnosisToNode(result.data));_this.zTreeFaultInstance.updateNode(_this.newNode[0]);_this.zTreeFaultInstance.selectNode(_this.zTreeFaultInstance.getNodeByParam('_id',result.data._id));}
alert('Save diagnosis '+moduleNameVal+' success');}else{alert('Save diagnosis '+moduleNameVal+' failed \n'+result.msg);}}).always(function(){Spinner.stop();});}).off('click.diagnosis_SetUp').on('click.diagnosis_SetUp','#diagnosis_SetUp',function(){$("#cloudPointSetUp").modal();WebAPI.post("/getCalcSettings/"+AppConfig.projectId,{projId:AppConfig.projectId}).done(function(returnData){$("#fixedTimeMode").prop("checked",!!returnData.data.triggerDiagnosis.fixed_time);$("#rawDataMode").prop('checked',!!returnData.data.triggerDiagnosis.raw_data);});}).off('click.btnPreservation').on('click.btnPreservation','#btnPreservation',function(){var data={projId:AppConfig.projectId,triggerDiagnosis:{fixed_time:$("#fixedTimeMode").prop('checked')?1:0,raw_data:$("#rawDataMode").prop('checked')?1:0}};WebAPI.post("/setCalcSettings/"+AppConfig.projectId,data).done(function(result){if(result.success){$("#cloudPointSetUp").modal("hide");}else{alert.danger('server: set failed.');}});}).off('click.fault-type-code1').on('click.fault-type-code1','#diagnosisFilesUl .fault-type-code1',function(){$("#diagnosis_alarm").modal();WebAPI.post('/v2/fault/getRealtime',{'projId':AppConfig.projectId,'moduleId':_this.currentDiagnosisId}).done(function(result){if(result){var diagnosisAlarmData=result.data[0];$("#folderName").text(_this.pointErrorLogName);$("#alarmTime").text(diagnosisAlarmData.time);$("#problemDescription").text(diagnosisAlarmData.problem);$("#causeAnalysis").text(diagnosisAlarmData.analysis);$("#consequence").text(diagnosisAlarmData.affect);$("#suggestionMeasure").text(diagnosisAlarmData.suggestion);}else{$("#diagnosis_alarm").modal("hide");alert.danger('Failed to load');}});}).off('click.btnAlarmDetailsConfirm').on('click.btnAlarmDetailsConfirm','#btnAlarmDetailsConfirm',function(){$("#diagnosis_alarm").modal("hide");}).off('click.diagnosisTest').on('click.diagnosisTest','#diagnosisTest',function(){var moduleNameVal=$("#diagnosisModuleName").val().trim();var codeVal=_this.editor.doc.getValue();if(!moduleNameVal||!moduleNameVal.trim()){alert.danger('diagnosis name can\'t be empty.');return;}
if(!codeVal||!codeVal.trim()){alert.danger('diagnosis code can\'t be empty.');return;}
Spinner.spin(ElScreenContainer);var timer,confirmInstance;var testPromise=_this.diagnosisPromise.then(function(){return $.ajax({url:_this.ExpertContainerUrl+'diagnosis/onlinetest',type:"POST",data:{'moduleName':moduleNameVal,'content':BEOPUtil.logicContentHandle(codeVal),'projId':AppConfig.projectId}}).done(function(result){var opt={};opt.newDate=new Date().format('yyyy-MM-dd HH:mm:ss');$('.diagnosisTestResult').show();opt.process=result.process;if(!result.error){for(var i=0;i<_this.testResult.length;i++){if(_this.testResult[i].id==_this.currentDiagnosisId){_this.testResult.splice(i--,1);}}
_this.testResult.push({"id":_this.currentDiagnosisId,"value":$("#diagnosisTestProgress").html()});}else{opt.errorResult=result.value;}
$("#diagnosisTestProgress").show().prepend(beopTmpl('tpl_test_progress',{opt:opt}));clearTimeout(timer);}).error(function(){alert.danger('Test Failed: the server is busy.');}).always(function(){Spinner.stop();confirmInstance&&confirmInstance.close();});});timer=setTimeout(function(){if(testPromise.state!=='resolved'||testPromise.state!=='rejected'){confirmInstance=confirm(I18n.resource.debugTools.info.REQUEST_TIMEOUT,function(){Spinner.stop();});}},2000);}).off('click.addTreeFolder').on('click.addTreeFolder','#addTreeFolder',function(){infoBox.prompt('please input the folder name',function(val){if(!val){alert.danger('The folder name can\'t be empty.');return;}
Spinner.spin(_this.$container[0]);var parent=_this.getParentNodeByAdd();WebAPI.post(_this.url_prefix+'saveCustomDiagnosis',{'isFolder':true,'Parent':parent?parent._id:-1,'moduleName':val,'projId':AppConfig.projectId}).done(function(result){if(result.success){_this.zTreeFaultInstance.addNodes(parent,{'isParent':true,'open':false,'name':result.data.moduleName,'_id':result.data._id});}else{alert('Add diagnosis '+val+' failed \n'+result.msg);}}).always(function(){Spinner.stop();});});}).off('click.import_from_template').on('click.import_from_template','#import_from_template',function(){_this.currentEditorText=_this.editor.doc.getValue();beop.template.init({'container':$('#templateImportWinBox'),'opType':'import','confirmCallBack':function confirmCallBack(){_this.transmitLogic+=beop.template.getLogic();$('.templateWin').modal('hide');_this.refreshEditor();}});}).off('click.save_as_template').on('click.save_as_template','#save_as_template',function(){beop.template.init({'container':$("#saveAsTemplateWinBox"),'opType':'save','logic':_this.editor.doc.getValue()});}).off('click.generateCurve').on('click.generateCurve','#generateCurve',function(){_this.generateCurve();}).off('click.searchLogOfOneHour').on('click.searchLogOfOneHour','#searchLogOfOneHour',_this.searchLogOfOneHour).off('click.searchLogOfYesterday').on('click.searchLogOfYesterday','#searchLogOfYesterday',_this.searchLogOfYesterday).off('click.searchLogOfToday').on('click.searchLogOfToday','#searchLogOfToday',_this.searchLogOfToday).off('click.searchLogOfAWeek').on('click.searchLogOfAWeek','#searchLogOfAWeek',_this.searchLogOfAWeek).off('click.logSearch').on('click.logSearch','#logSearchBtn',_this.logSearch).off('click.logSearchDeleteAllBtn').on('click.logSearchDeleteAllBtn','#logSearchDeleteAllBtn',_this.logSearchDeleteAll).off('change.logPageSizeChange').on('change.logPageSizeChange','#logPageSizeSelector',_this.logPageSizeChange).off('click.editorFullScreen').on('click.editorFullScreen','#editorFullScreen',_this.editorFullScreen).off('click.diagnosisFaultTotal').on('click.diagnosisFaultTotal','#diagnosisFaultTotal',_this.loadLogPage);$(document).off('keydown.CopyAndPaste').on("keydown.CopyAndPaste",function(e){if(!_this.currentDiagnosisId||$(e.target).closest('#diagnosisCodeBoxInner').length||!e.ctrlKey){return true;}
if(e.keyCode==67){_this.clipboardData=_this.zTreeFaultInstance.getSelectedNodes();}else if(e.keyCode==86){var selectedIds=[];_this.clipboardData.forEach(function(node){selectedIds.push(node._id);});if(!selectedIds.length){alert.danger('Please select diagnosis first.');return;}
var parent_id=-1;var parent=_this.getParentNodeByAdd();if(parent){parent_id=parent._id;}
Spinner.spin(_this.$container[0]);WebAPI.post('cloudDiagnosis/copyCustomDiagnosis',{diagnosisIds:selectedIds,parent_id:parent_id}).done(function(result){if(!result.success){alert.danger('copy failed '+result.msg);}
_this.zTreeFaultInstance.addNodes(_this.getParentNodeByAdd(),_this._convertDiagnosisToNode(result.data));}).always(function(){Spinner.stop();});}});},detachEvents:function detachEvents(){},getCountOfLogRequest:function getCountOfLogRequest(){WebAPI.post('/api/errorlog/countoflog',{projId:AppConfig.projectId,type:'diag'}).done(function(result){if(result.success){_this.countofLogMap=result.data;_this.setDiagnosisFaultTotal();}});},setDiagnosisFaultTotal:function setDiagnosisFaultTotal(){var total=0,$diagnosisFaultTotal=$('#diagnosisFaultTotal');for(var prop in this.countofLogMap){total+=this.countofLogMap[prop];}
if(total){$diagnosisFaultTotal.text(total).show();}else{$diagnosisFaultTotal.text(total).hide();}},generateCurve:function generateCurve(){Spinner.spin(ElScreenContainer);var date_start,data_end;if(localStorage.getItem('diagnosisCurveStartDate')){date_start=localStorage.getItem('diagnosisCurveStartDate');data_end=localStorage.getItem('diagnosisCurveEndDate');}else{date_start=new Date(new Date()-5*24*60*60*1000).format("yyyy-MM-dd HH:mm:00");data_end=new Date().format("yyyy-MM-dd HH:mm:00");}
var sendData={'projId':AppConfig.projectId,'diagname':_this.currentFile.name,'diagObid':_this.currentFile._id,'s_time':date_start,'e_time':data_end,'formatTime':_this.currentFile.format};$.ajax({url:_this.ExpertContainerUrl+'diagnosis/get/moduleStatus/single',data:sendData,type:"POST"}).done(function(result){if(result){new DiagnosisHistoryChart({result:result,sendData:sendData,ExpertContainerUrl:_this.ExpertContainerUrl}).show();}}).always(function(){Spinner.stop();});},logPaginationRefresh:function logPaginationRefresh(totalNum){var totalPages=Math.ceil(totalNum/_this.logPageSize);$('#paginationContainer').empty().html('<ul id="logPagination" class="pagination"></ul>');while(totalPages<_this.logCurrentPage&&_this.logCurrentPage>1){_this.logCurrentPage=_this.logCurrentPage-1;}
var pageOption={first:'&laquo;&laquo',prev:'&laquo;',next:'&raquo;',last:'&raquo;&raquo;',startPage:_this.logCurrentPage?parseInt(_this.logCurrentPage):1,totalPages:!totalPages?1:parseInt(totalPages),onPageClick:function onPageClick(event,page){_this.logCurrentPage=page;_this.logSearch(page);}};$("#logPagination").twbsPagination(pageOption);$('.logContainer').scrollTop(0);},logPageSizeChange:function logPageSizeChange(){_this.logPageSize=$(this).val();_this.logSearch();},editorFullScreen:function editorFullScreen(){_this.editor.setOption("fullScreen",true);},loadLogPage:function loadLogPage(){var $diagnosisCodeMainBox=$("#diagnosisCodeMainBox");$diagnosisCodeMainBox.html(beopTmpl('tpl_search_log',{}));var dataFormat={startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:ss'};$("#logDateStart").datetimepicker(dataFormat);$("#logDateEnd").datetimepicker(dataFormat);if(!_this.logPageSize){_this.logPageSize=200;}
I18n.fillArea($diagnosisCodeMainBox);if($(this).closest('#diagnosisFaultTotal').length){_this.currentPointLogType=_this.pointLogTypeMap.all;_this.logSinglePointSearch();}else{_this.currentPointLogType=_this.pointLogTypeMap.single;_this.logSinglePointSearch(1,this.currentFile.moduleName);}},logSinglePointSearch:function logSinglePointSearch(page,pointName){Spinner.spin(document.body);var url,data={projId:AppConfig.projectId,pageSize:_this.logPageSize,pageNum:+page?+page:1,type:'diag'};if(_this.currentPointLogType==_this.pointLogTypeMap.single){url='/api/errorlog/onepoint';data.pointname=pointName;}else{url='/api/errorlog';data.timeFrom=new Date().format('yyyy-MM-dd 00:00:00');data.timeTo=new Date().format('yyyy-MM-dd 23:59:59');$('#logDateStart').attr('value',data.timeFrom);$('#logDateEnd').attr('value',data.timeTo);}
WebAPI.post(url,data).done(function(result){if(result.success){$('#totalLogsNum').text(result.data.total);_this.logCurrentPage=parseInt(page);_this.logPaginationRefresh(result.data.total);$('#logReport').html(beopTmpl('tpl_search_log_result',{logList:result.data.records}));}else{alert(result.msg);}}).always(function(){Spinner.stop();});},logSearch:function logSearch(page){Spinner.spin(document.body);var $logDateStart=$('#logDateStart'),$logDateEnd=$('#logDateEnd');var timeFrom=$logDateStart.val();var timeTo=$logDateEnd.val();var url='',data={projId:AppConfig.projectId,pageSize:_this.logPageSize,pageNum:+page?+page:1,type:'diag'};if(_this.currentPointLogType==_this.pointLogTypeMap.single){url='/api/errorlog/onepoint';data.pointname=_this.pointErrorLogName;}else{url='/api/errorlog';if(!timeFrom){timeFrom=new Date().format('yyyy-MM-dd 00:00:00');$logDateStart.attr('value',timeFrom);}
if(!timeTo){timeTo=new Date().format('yyyy-MM-dd 23:59:59');$logDateEnd.attr('value',timeTo);}}
data.timeFrom=timeFrom;data.timeTo=timeTo;WebAPI.post(url,data).done(function(result){if(result.success==true){$('#totalLogsNum').text(result.data.total);_this.logCurrentPage=parseInt(page);_this.logPaginationRefresh(result.data.total);$('#logReport').html(beopTmpl('tpl_search_log_result',{logList:result.data.records}));}else{alert(result.msg);}}).always(function(){Spinner.stop();});},logSearchDeleteAll:function logSearchDeleteAll(){confirm(I18n.resource.debugTools.info.IS_CLEAR_LOG,function(){Spinner.spin(document.body);WebAPI.post('/api/errorlog/dellog',{projId:AppConfig.projectId,pointname:_this.pointErrorLogName?_this.pointErrorLogName:'',type:'diag'}).done(function(result){if(result.success){$("#logReport").empty();$("#logPagination").hide();if(_this.currentPointLogType==_this.pointLogTypeMap.single){var nodeId=_this.zTreeFaultInstance.getSelectedNodes()[0].tId;$("#"+nodeId).find('.errorPoint').remove();}else{$("#diagnosisFilesUl").find('.errorPoint').remove();$("#diagnosisFaultTotal").remove();}
_this.getCountOfLogRequest();alert(I18n.resource.common.DELETE_SUCCESS);}else{alert(result.msg);}}).always(function(){Spinner.stop();});});},searchLogOfOneHour:function searchLogOfOneHour(){var now=new Date();$('#logDateStart').attr('value',new Date(now.getTime()-60*60*1000).format('yyyy-MM-dd HH:mm:ss')).val(new Date(now.getTime()-60*60*1000).format('yyyy-MM-dd HH:mm:ss'));$('#logDateEnd').attr('value',now.format('yyyy-MM-dd HH:mm:ss')).val(now.format('yyyy-MM-dd HH:mm:ss'));_this.logSearch();},searchLogOfYesterday:function searchLogOfYesterday(){var now=new Date();$('#logDateStart').attr('value',new Date(now-24*60*60*1000).format('yyyy-MM-dd 00:00:00')).val(new Date(now-24*60*60*1000).format('yyyy-MM-dd 00:00:00'));$('#logDateEnd').attr('value',new Date(now-24*60*60*1000).format('yyyy-MM-dd 23:59:59')).val(new Date(now-24*60*60*1000).format('yyyy-MM-dd 23:59:59'));_this.logSearch();},searchLogOfToday:function searchLogOfToday(){$('#logDateStart').attr('value',new Date().format('yyyy-MM-dd 00:00:00')).val(new Date().format('yyyy-MM-dd 00:00:00'));$('#logDateEnd').attr('value',new Date().format('yyyy-MM-dd HH:mm:ss')).val(new Date().format('yyyy-MM-dd HH:mm:ss'));_this.logSearch();},searchLogOfAWeek:function searchLogOfAWeek(){var now=new Date();$('#logDateStart').attr('value',new Date(now.getTime()-7*24*60*60*1000).format('yyyy-MM-dd HH:mm:ss')).val(new Date(now.getTime()-7*24*60*60*1000).format('yyyy-MM-dd HH:mm:ss'));$('#logDateEnd').attr('value',new Date().format('yyyy-MM-dd HH:mm:ss')).val(new Date().format('yyyy-MM-dd HH:mm:ss'));_this.logSearch();},getFaultTypeName:function getFaultTypeName(value){if(value==0||value==1){return I18n.resource.common['FAULT_TYPE_CODE_'+value];}else{return I18n.resource.common.FAULT_TYPE_CODE_UNKNOWN;}},initDiagnosisTree:function initDiagnosisTree(){var $diagnosisFilesUl=$("#diagnosisFilesUl");$diagnosisFilesUl.empty();var zTreeSettings={view:{selectedMulti:true,addDiyDom:_this.addDiyDom},edit:{enable:true,showRemoveBtn:true,showRenameBtn:_this.zTreeShowRenameBtn},data:{simpleData:{enable:true},keep:{parent:true,leaf:true}},callback:{onDrop:_this.zTreeFaultOnDrop,onDrag:_this.zTreeFaultOnDrag,onRemove:_this.zTreeFaultOnRemove,onRename:_this.zTreeFaultOnRename,onClick:_this.zTreeFaultOnClick,beforeDrop:_this.zTreeFaultOnBeforeDrop,beforeClick:_this.zTreeFaultBeforeClick,beforeRemove:_this.zTreeFaultBeforeRemove},async:{enable:true,type:'post',url:'/cloudDiagnosis/getCustomDiagnosis/tree',otherParam:{"projId":AppConfig.projectId,'isDelete':false},autoParam:["_id=Parent"],dataFilter:function dataFilter(treeId,parentNode,responseData){if(responseData.success){return _this._convertDiagnosisToNode(responseData.data);}else{return[];}}}};this.zTreeFaultInstance=$.fn.zTree.init($diagnosisFilesUl,zTreeSettings);},zTreeShowRenameBtn:function zTreeShowRenameBtn(treeId,treeNode){return treeNode.isParent;},addDiyDom:function addDiyDom(treeId,treeNode){if(treeNode.isParent){return;}
$.when(_this.moduleStatusPromise,_this.countofLogPromise).done(function(){var str='';if(_this.moduleStatusMap&&_this.moduleStatusMap[treeNode.moduleName]){str+='<span class="mr5 diagnosis-type fault-type-code fault-type-code'+_this.moduleStatusMap[treeNode.moduleName].value+'">'+_this.getFaultTypeName(_this.moduleStatusMap[treeNode.moduleName].value)+'</span>';}
if(_this.countofLogMap&&_this.countofLogMap[treeNode.moduleName]){str+='<span class="mr5 diagnosis-num errorPoint">'+_this.countofLogMap[treeNode.moduleName]+'</span>';treeNode.hasLog=true;}
$("#"+treeNode.tId+"_a").append(str);});},_convertDiagnosisToNode:function _convertDiagnosisToNode(diagnosisList){var _converter=function _converter(item){item.name=item.moduleName;item.isParent=item.isFolder;return item;};if(!$.isArray(diagnosisList)){return _converter(diagnosisList);}
for(var i=0;i<diagnosisList.length;i++){_converter(diagnosisList[i]);}
return diagnosisList;},zTreeFaultBeforeRemove:function zTreeFaultBeforeRemove(treeId,treeNode){confirm(I18n.resource.dataManage.REMOVE_CONFIRM,function(){var fileId=treeNode._id;Spinner.spin(_this.$container[0]);WebAPI.post(_this.url_prefix+'removeCustomDiagnosis',{'IdList':[fileId]}).done(function(result){if(result.success){_this.zTreeFaultInstance.removeNode(treeNode);$("#diagnosisCodeBoxInner").hide();$("#diagnosisLogBox").hide();var delLogFlag=false;for(var prop in _this.countofLogMap){if(prop==treeNode.name){delLogFlag=true;break;}}
if(delLogFlag){Spinner.spin(document.body);WebAPI.post('/api/errorlog/dellog',{projId:AppConfig.projectId,pointname:treeNode.name,type:'diag'}).done(function(result){if(result.success){_this.getCountOfLogRequest();}else{alert(result.msg);}}).always(function(){Spinner.stop();});}}else{alert.danger('delete failed '+result.msg?result.msg:'');}}).fail(function(){alert.danger('delete failed, server is busy.');}).always(function(){Spinner.stop();});});return false;},zTreeFaultOnRemove:function zTreeFaultOnRemove(e,treeId,treeNode){return false;},zTreeFaultOnRename:function zTreeFaultOnRename(event,treeId,treeNode,isCancel){WebAPI.post(_this.url_prefix+'saveCustomDiagnosis',{moduleName:treeNode.name,projId:AppConfig.projectId,_id:treeNode._id}).done(function(result){if(!result.success){alert.danger('Diagnosis node rename '+treeNode.moduleName+' failed \n'+result.msg);}
return false;}).always(function(){Spinner.stop();});},zTreeFaultOnDrag:function zTreeFaultOnDrag(event,treeId,treeNodes){if(treeNodes[0].isFolder){return false;}},zTreeFaultOnBeforeDrop:function zTreeFaultOnBeforeDrop(treeId,treeNodes,targetNode,moveType){if(!targetNode){return false;}},zTreeFaultOnDrop:function zTreeFaultOnDrop(e,treeId,treeNodes,targetNode,moveType){if(!targetNode){return false;}
var parent_id=-1;if(targetNode.isParent){parent_id=targetNode._id;}else{var parentNode=targetNode.getParentNode();parent_id=parentNode?parentNode._id:-1;}
Spinner.spin($("#diagnosisFilesUl")[0]);var diagnosisList=[];for(var i=0;i<treeNodes.length;i++){diagnosisList.push({Parent:parent_id,_id:treeNodes[i]._id,projId:AppConfig.projectId});}
WebAPI.post(_this.url_prefix+'saveCustomDiagnosis',diagnosisList).done(function(result){if(!result.success){alert.danger('Diagnosis node'+treeNodes[0].moduleName+' failed \n'+result.msg);}
_this.zTreeFaultOnClick(treeNodes[0]);return false;}).always(function(){Spinner.stop();});},getCurrentNode:function getCurrentNode(){var nodes=_this.zTreeFaultInstance.getSelectedNodes();if(!nodes.length){return null;}else if(nodes.length===1){return nodes[0].isParent?null:nodes[0];}else{return null;}},getParentNodeByAdd:function getParentNodeByAdd(){var nodes=_this.zTreeFaultInstance.getSelectedNodes();if(!nodes.length){return null;}else{return nodes[0].isParent?nodes[0]:nodes[0].getParentNode();}},isDiagnosisChanged:function isDiagnosisChanged(){var $moduleName=$("#diagnosisModuleName");var $diagnosisFaultDescription=$("#diagnosisFaultDescription");if(!$moduleName.length){return false;}
return $moduleName.val()!==_this.currentFile.moduleName||$diagnosisFaultDescription.val()!==_this.currentFile.faultDescription||BEOPUtil.logicContentHandle(_this.editor.doc.getValue())!==_this.currentFile.logic;},zTreeFaultBeforeClick:function zTreeFaultBeforeClick(treeId,treeNode){if(_this.currentFile&&_this.isDiagnosisChanged()){confirm(I18n.resource.diagnosis.config.faultAlarm.MODIFY_PROMPT,function(){},function(){_this.zTreeFaultOnClick(null,null,treeNode);_this.zTreeFaultInstance.selectNode(treeNode);});return false;}else{return true;}},zTreeFaultOnClick:function zTreeFaultOnClick(e,treeId,treeNode){if(treeNode.isParent){return;}
_this.currentDiagnosisId=treeNode._id;_this.currentFile=treeNode;_this.pointErrorLogName=treeNode.name;if(e&&$(e.target).hasClass('diagnosis-num')){_this.loadLogPage();}else{$("#diagnosisCodeMainBox").html(beopTmpl('tpl_diagnosis_code_Info'));$("#diagnosisCodeBoxInner").show();if(!_this.zTreeInstance){_this.loadTree();}
$("#diagnosisCodeTitle").attr('i18n','common.EDIT');$("#diagnosisModuleName").val(_this.currentFile.moduleName);$("#diagnosisFaultDescription").val(_this.currentFile.faultDescription);$("#diagnosisTestProgress").empty().hide();_this.currentEditorText=_this.currentFile.logic;_this.refreshEditor();}
window.focus();if(document.activeElement){document.activeElement.blur();}
I18n.fillArea(_this.$container);},refreshEditor:function refreshEditor(){this.$container.find('.CodeMirror').remove();this.editor=null;if(this.transmitLogic){if(this.currentEditorText==''){this.currentEditorText+=this.transmitLogic;}else{this.currentEditorText+='\n\n'+this.transmitLogic;}
this.transmitLogic='';}
$("#diagnosisCodeMirror").text(this.currentEditorText);CodeMirror.commands.autocomplete=function(cm){cm.showHint({hint:function hint(editor,options){var WORD=/[\w$]+/;var word=options&&options.word||WORD;var cur=editor.getCursor(),curLine=editor.getLine(cur.line);var end=cur.ch,start=end;while(start&&word.test(curLine.charAt(start-1))){--start;}var curWord=start!=end&&curLine.slice(start,end);var candidates=_this.autoCompleteList.filter(function(item){return item.displayText.startsWith(curWord);});if(candidates.length===1){candidates.unshift({text:'',displayText:''});}
return{list:candidates,from:CodeMirror.Pos(cur.line,start),to:CodeMirror.Pos(cur.line,end)};}});};this.editor=CodeMirror.fromTextArea(document.getElementById('diagnosisCodeMirror'),{mode:"python",lineNumbers:true,indentUnit:4,tabMode:'spaces',autofocus:true});this.editor.setOption("extraKeys",{Tab:function Tab(cm){var spaces=new Array(cm.getOption("indentUnit")+1).join(" ");cm.replaceSelection(spaces);},"F11":function F11(cm){cm.setOption("fullScreen",!cm.getOption("fullScreen"));},"Esc":function Esc(cm){if(cm.getOption("fullScreen"))cm.setOption("fullScreen",false);}});this.editor.refresh();this.editor.on("keyup",function(cm,e){if(e.keyCode!=8&&e.keyCode!=37&&e.keyCode!=38&&e.keyCode!=39&&e.keyCode!=40){CodeMirror.commands.autocomplete(cm);}});},getTreeData:function getTreeData(){_this.diagnosisPromise.done(function(){var urlSuffix=localStorage.getItem('language')==='zh'?'apiTree':'apiTree/en';$.ajax({url:_this.ExpertContainerUrl+urlSuffix,type:"GET"}).done(function(result){if(result&&result.length){_this.requestTreeList=result;for(var i=0;i<_this.requestTreeList.length;i++){_this.autoCompleteList.push({text:_this.requestTreeList[i].sample,displayText:_this.requestTreeList[i].name});}}});});},loadTree:function loadTree(){var zTreeSetting={view:{selectedMulti:false,addHoverDom:this.showNodeTitle.bind(this)},edit:{enable:true,showRemoveBtn:false,showRenameBtn:false},data:{simpleData:{enable:true}},callback:{onDblClick:this.zTreeOnDblClick,onDrag:this.zTreeOnDrag,onDrop:this.zTreeOnDrop.bind(this)},async:{enable:true,type:'post',url:'/tag/getThingTree',otherParam:{projId:AppConfig.projectId,onlyGroupForRoot:true},autoParam:["_id=Prt"],dataFilter:function dataFilter(treeId,parentNode,responseData){return responseData.thingTree;}}};_this.tagTreePromise.done(function(){_this.changeToZTreeNodes();_this.zTreeInstance=$.fn.zTree.init($("#diagnosisTree"),zTreeSetting,_this.treeList);});},zTreeOnDblClick:function zTreeOnDblClick(event,treeId,treeNode){if(!treeNode.isParent){if(treeNode.sample){_this.insertContent(treeNode.sample);}else{_this.insertContent(treeNode.name);}}},zTreeOnDrag:function zTreeOnDrag(event,treeId,treeNodes){if(treeNodes[0].isParent){return false;}},zTreeOnDrop:function zTreeOnDrop(e,treeId,treeNodes,targetNode,moveType){if(!treeNodes[0].isParent){if($(e.target).closest('#diagnosisCodeMirrorBox').length){if(treeNodes[0].sample){this.insertContent(treeNodes[0].sample);}else{this.insertContent(treeNodes[0].name);}}}},changeToZTreeNodes:function changeToZTreeNodes(){for(var i=0;i<this.requestTreeList.length;i++){this.treeList.push({id:ObjectId(),sample:this.requestTreeList[i].sample,name:this.requestTreeList[i].name,pId:this.requestTreeList[i].api_type=='0'?9:this.requestTreeList[i].api_type});}
for(var j=0;j<this.folderList.length;j++){this.treeList.push({id:this.folderList[j].id,name:this.folderList[j].name,pId:10,open:false,isFolder:true});}
this.treeList.push({id:10,name:I18n.resource.dataManage.SYSTEM_API,pId:0,open:false,isFolder:true});var tagFolderId=15;this.treeList.push({id:tagFolderId,name:'Tag Structure',pId:0,open:false,isFolder:true,isParent:true});this.setTreeNodeIcon(this.thingTreeList,tagFolderId);this.treeList=this.treeList.concat(this.thingTreeList);},setTreeNodeIcon:function setTreeNodeIcon(node,rootId){for(var i=0;i<node.length;i++){if(rootId){node[i].pId=rootId;}
if(node[i].tag&&node[i].tag.icon){node[i].iconSkin='iconfont icon-'+node[i].tag.icon;}
if(node[i].children&&node[i].children.length){this.setTreeNodeIcon(node[i].children,node[i]._id);}}},showNodeTitle:function showNodeTitle(treeId,treeNode){if(!treeNode.isParent){for(var i=0;i<this.requestTreeList.length;i++){var item=this.requestTreeList[i];if(treeNode.name==item.name){var titleHtml='api:  '+item.name+'\n'+I18n.resource.common.DESCRIPTION+':  '+item.dis_cription+'\n'+I18n.resource.common.EXAMPLE+':  '+item.sample;$("#"+treeNode.tId+"_a").attr('title',titleHtml);break;}}}},insertContent:function insertContent(value){this.editor.replaceSelection(value);}};$.extend(Diagnosis.prototype,DiagnosisFunc);return Diagnosis;}();var DiagnosisHistoryChart=function(){var _this;function DiagnosisHistoryChart(obj){_this=this;this.$container=$("#dialogContent");this.diagnosisList=obj.result.records;this.pointMap=obj.result.bindPoints;this.ExpertContainerUrl=obj.ExpertContainerUrl;this.sendData=obj.sendData;this.pointList=obj.pointList||[];this.hidePointList=obj.hidePointList||[];this.startDate=this.sendData.s_time;this.endDate=this.sendData.e_time;this.timeList=[];this.valueList=[];this.treeList=[];this.treeSelectPointMap={};this.charts=[];this.historyData=$.extend(true,{},this.pointMap);this.chart_bindPoints=null;}
DiagnosisHistoryChart.prototype={show:function show(){$('#dialogModal').one('hidden.bs.modal',function(){$(this).find('#container').removeClass('wr80');_this.close();}).one('shown.bs.modal',function(){_this.$container.addClass('wr80');_this.init();}).modal({backdrop:'static'});},close:function close(){this.charts.forEach(function(chart){chart&&chart.dispose&&chart.dispose();chart=null;});this.charts=[];this.chart_bindPoints=null;this.pointList=null;this.$container.empty();_this.$container.removeClass('wr80');},init:function init(){return WebAPI.get("/static/views/observer/widgets/diagnosisHistoryChart.html").done(function(resultHtml){_this.$container.empty().html(resultHtml);if(window.localStorage.getItem("systemSkin_"+AppConfig.userId)=="default"){$('.modal-content').addClass('default');}else{$('.modal-content').addClass('dark');}
I18n.fillArea(_this.$container);_this.refreshDateTimePicker();_this.renderFilter();_this.loadTree();_this.getDataInfo();_this.refreshData();_this.attachEvent();});},attachEvent:function attachEvent(){var _this=this;var $diagnosisCurveDateStart=$("#diagnosisCurveDateStart"),$diagnosisCurveDateEnd=$("#diagnosisCurveDateEnd");this.$container.off('click.filterCurveConfirm').on('click.filterCurveConfirm','#filterCurveConfirm',function(){var startTime=$diagnosisCurveDateStart.val(),endTime=$diagnosisCurveDateEnd.val();if(!startTime){alert(I18n.resource.common.START_TIME_REQUIRED);return;}
if(!endTime){alert(I18n.resource.common.END_TIME_REQUIRED);return;}
if(endTime<startTime){alert(I18n.resource.common.TIME_COMPARE);return;}
_this.startDate=startTime;_this.endDate=endTime;_this.fetchData();}).off('click.searchCurveOfTime').on('click.searchCurveOfTime','.searchCurveOfTime',function(){_this.startDate=_this.getStartTime($(this).attr('dateType'));_this.endDate=new Date().format("yyyy-MM-dd HH:mm:00");$diagnosisCurveDateStart.val(_this.startDate);$diagnosisCurveDateEnd.val(_this.endDate);_this.fetchData();});},loadTree:function loadTree(){if($.isEmptyObject(this.pointMap)||this.pointMap.error){return;}
var zTreeSetting={view:{selectedMulti:false,showIcon:false},check:{enable:true},data:{simpleData:{enable:true}},callback:{onCheck:this.zTreeOnCheck.bind(this),beforeClick:this.zTreeBeforeClick,onClick:this.zTreeClick.bind(this)}};this.changeToZTreeNodes();this.zTreeInstance=$.fn.zTree.init($("#diagnosisTreeUL"),zTreeSetting,this.treeList);},changeToZTreeNodes:function changeToZTreeNodes(){for(var prop in this.pointMap.data){this.treeList.push({id:ObjectId(),name:prop,pId:1,checked:true});}
this.treeList.push({id:1,pId:0,name:"all",open:true,checked:true});},zTreeBeforeClick:function zTreeBeforeClick(){return true;},zTreeClick:function zTreeClick(e,treeId,treeNode){this.zTreeInstance.checkNode(treeNode,null,true,true);},zTreeOnCheck:function zTreeOnCheck(e,treeId,treeNode){if(treeNode.isParent){if(treeNode.checked){this.historyData.data=$.extend(true,{},this.pointMap.data);this.hidePointList=[];}else{this.historyData.data={};if(treeNode.children&&treeNode.children.length){for(var i=0;i<treeNode.children.length;i++){$('#'+treeNode.children[i].tId+'_span').css('color','#fff');}}}}else{for(var prop in this.pointMap.data){if(prop==treeNode.name){if(treeNode.checked){this.historyData.data[prop]=this.pointMap.data[prop];if($.inArray(treeNode.name,this.hidePointList)!==-1){for(var i=0;i<this.hidePointList.length;i++){if(treeNode.name==this.hidePointList[i]){this.hidePointList.splice(i,1);break;}}}}else{delete this.historyData.data[prop];$('#'+treeNode.tId+'_span').css('color','#fff');}
break;}}}
this.refreshData();},resetParam:function resetParam(obj){this.diagnosisList=obj.records;this.pointMap=obj.bindPoints;this.treeList=[];this.getDataInfo();},getDataInfo:function getDataInfo(){this.timeList=[];this.valueList=[];for(var i=0;i<this.diagnosisList.length;i++){this.timeList.push(this.diagnosisList[i].time);this.valueList.push(this.diagnosisList[i].value);}},getStartTime:function getStartTime(dateType){var date=new Date();if(dateType==='hour'){return new Date(date.getTime()-60*60*1000).format('yyyy-MM-dd HH:mm:00');}else if(dateType==='today'){return date.format('yyyy-MM-dd 00:00:00');}else if(dateType==='week'){var getDay=date.getDay()==0?7:date.getDay();return new Date(date-(getDay-1)*86400000).format('yyyy-MM-dd 00:00:00');}else if(dateType==='month'){return new Date(date.getFullYear(),date.getMonth(),1).format('yyyy-MM-dd 00:00:00');}},serverRequestError:function serverRequestError(mes){console.log(mes);alert(I18n.resource.debugTools.sitePoint.SERVER_REQUEST_FAILED);},renderFilter:function renderFilter(){$('#diagnosisCurveDateStart').val(this.startDate.format("yyyy-MM-dd HH:mm:00"));$('#diagnosisCurveDateEnd').val(this.endDate.format("yyyy-MM-dd HH:mm:00"));},refreshDateTimePicker:function refreshDateTimePicker(){$("#diagnosisCurveDateStart").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:00'});$("#diagnosisCurveDateEnd").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:00'});},fetchData:function fetchData(){Spinner.spin(this.$container.get(0));_this.sendData.s_time=_this.startDate;_this.sendData.e_time=_this.endDate;$.ajax({url:_this.ExpertContainerUrl+'diagnosis/get/moduleStatus/single',data:_this.sendData,type:"POST"}).done(function(result){if(result&&result.records.length){localStorage.setItem('diagnosisCurveStartDate',_this.startDate);localStorage.setItem('diagnosisCurveEndDate',_this.endDate);_this.resetParam(result);_this.refreshData();}else{alert(result.bindPoints.msg);}}).fail(function(){alert('Request data failed!');}).always(function(){Spinner.stop();});},refreshData:function refreshData(){var bindPointSeries=[],faultSeries=[];var $curveBox=$('.curveBox');if(!this.diagnosisList.length){$curveBox.empty();return;}else{var pointIndex=0;var len=echarts.config.color.length;for(var prop in this.historyData.data){if(this.historyData.data.hasOwnProperty(prop)){var color=echarts.config.color[pointIndex%len];if($.inArray(prop,this.hidePointList)===-1){var treeNode=this.zTreeInstance.getNodeByParam('name',prop,null);$('#'+treeNode.tId+'_span').css('color',color);}
pointIndex++;}
bindPointSeries.push({name:prop,type:'line',data:this.historyData.data[prop],smooth:true});}
faultSeries.push({name:this.diagnosisList[0].name,type:'line',data:this.valueList,smooth:true});}
var option_bindPoints={title:{text:'绑定点曲线',textStyle:{fontSize:'16',fontWeight:'700',color:'#eee'}},tooltip:{trigger:'axis',enterable:true,showDelay:0},toolbox:{feature:{dataZoom:{yAxisIndex:true},brush:{type:['lineX','clear']}}},dataZoom:{y:600,realtime:true,show:true,start:0,end:100},grid:{x:80,y:40,x2:20,y2:25},xAxis:{type:'category',axisTick:{onGap:false},splitLine:{show:false},axisLabel:{show:false},data:this.timeList},yAxis:[{type:'value',scale:true,boundaryGap:[0.05,0.05],splitArea:{show:false}}],series:bindPointSeries};var option_faults={title:{text:'诊断曲线',textStyle:{fontSize:'16',fontWeight:'700',color:'#eee'}},tooltip:{trigger:'axis',triggerOn:'mousemove',showDelay:0,enterable:true,formatter:function formatter(params){if(!params.length){return true;}
var fault=_this.diagnosisList[params[0].dataIndex];var $faults_info=$('.faults_info');switch(params[0].value){case-1:$faults_info.css('display','none');return params[0].name+"<br />"+params[0].seriesName+': '+'未知';case 0:$faults_info.css('display','none');return params[0].name+"<br />"+params[0].seriesName+': '+'正常';case 1:$faults_info.css('display','block').html(params[0].name+"<br />"+params[0].seriesName+': '+'报警'+"<br />"+fault.affect+"，"+fault.analysis+"<br />"+fault.problem+"&nbsp;"+"<br />"+fault.suggestion);return params[0].name+"<br />"+params[0].seriesName+': '+'报警';}}},dataZoom:{show:true,realtime:true,start:0,end:100,textStyle:{color:'#fff'}},grid:{x:80,y:50,x2:20,y2:40,height:'65%'},xAxis:{type:'category',axisTick:{onGap:false},splitLine:{show:false},data:this.timeList},yAxis:{show:true,min:-1,max:1,type:'value',axisLabel:{show:true,formatter:function formatter(value){switch(value){case-1:return'未知';case 0:return'正常';case 1:return'报警';}}}},series:faultSeries};var chart_faults,$oneChart=$('.one-chart'),$multiChart=$('.multi-chart'),$faults_info=$('.faults_info');if($.isEmptyObject(this.pointMap)||this.pointMap.error){$multiChart.hide();$oneChart.show();$curveBox.css('width',($oneChart.width()*0.95).toFixed(1)+'px');$faults_info.css('width',($oneChart.width()*0.95).toFixed(1)+'px');chart_faults=echarts.init(document.getElementById('curveBox'),AppConfig.chartTheme);chart_faults.setOption(option_faults);this.charts.push(chart_faults);}else{$multiChart.show();$oneChart.hide();$curveBox.css('width',($multiChart.width()*0.80).toFixed(1)+'px');$faults_info.css('width',($multiChart.width()*0.75).toFixed(1)+'px');this.chart_bindPoints=echarts.init(document.getElementById('curveBox_bindPoints'),AppConfig.chartTheme);this.chart_bindPoints.setOption(option_bindPoints);chart_faults=echarts.init(document.getElementById('curveBox_faults'),AppConfig.chartTheme);chart_faults.setOption(option_faults);echarts.connect([this.chart_bindPoints,chart_faults]);this.charts.push(this.chart_bindPoints);this.charts.push(chart_faults);}}};return DiagnosisHistoryChart;}();(function($){$.fn.fixedHeaderTable=function(){return this.each(function(){var instance=$(this);var headers=$(this).find('.table-header th:not(:last-child)');var $tableHeader=$(this).find('.table-header');var cells=$(this).find('.table-body tr:first td:not(:last-child)');function setPixelWidths(i,pixelWidth){headers.eq(i).css('width',pixelWidth);cells.eq(i).css('width',pixelWidth);}
function setPercentageWidths(i,pixelWidth){var percentWidth=pixelWidth/instance.outerWidth()*100;headers.eq(i).css('width',percentWidth+'%');cells.eq(i).css('width',percentWidth+'%');headers.eq(i).data('width',percentWidth);headers.eq(i).attr('data-width',percentWidth);}
headers.each(function(idx){var header=$(this);var startX=null;var resizeHandle=$("<div class='resize-handle'></div>");if(header.data('width')){setPercentageWidths(idx,header.data('width')*$tableHeader.width()/100);}else{setPercentageWidths(idx,header.outerWidth());}
$(this).append(resizeHandle.on('mousedown',onDragStart));function adjustWidth(offset){var column_width=header.outerWidth()-offset;if(column_width<=8)return;setPixelWidths(idx,column_width);}
function onDragStart(e){resizeHandle.addClass('dragging');startX=e.screenX;$(window).on('mousemove',onDrag);$(window).on('mouseup',onDragEnd);return false;}
function onDrag(e){var endX=e.screenX;adjustWidth(startX-endX);startX=endX;}
function onDragEnd(e){resizeHandle.removeClass('dragging');setPercentageWidths(idx,header.outerWidth());$(window).off('mousemove',onDrag);$(window).off('mouseup',onDragEnd);}});return this;});};})(jQuery);var DragPanel=function(){function DragPanel(){this.isShow=false;this.arrInstance=[];}
DragPanel.prototype.show=function(){var _this=this;var localPanel,arrPanel=[];var localKey='historyPanel'+'_'+AppConfig.userId;localPanel=localStorage.getItem(localKey);if(localPanel){arrPanel=JSON.parse(localPanel);}
if(!this.isShow||!arrPanel||arrPanel.length<1){if(arrPanel&&arrPanel instanceof Array&&arrPanel.length>0){arrPanel.forEach(function(data){var isAdd=true;for(var i=0;i<_this.arrInstance.length;i++){if(_this.arrInstance[i].timeVal===data.time){isAdd=false;}}
if(isAdd){new HistoryDragPanel(data);}});}else{new HistoryDragPanel();}
this.isShow=true;}else{this.hide();this.isShow=false;}};DragPanel.prototype.hide=function(){this.arrInstance.forEach(function(instance){instance.close();});this.arrInstance.length=0;};return new DragPanel();}();var HistoryDragPanel=function(){function HistoryDragPanel(data){var _this=this;this.$panel=undefined;this.store=[];this.panelDefaultW=500;this.panelDefaultY=300;this.hisChart=undefined;this.themeOpt={dark:{legend:{textStyle:{color:'#ccc'}},xAxis:{axisLine:{lineStyle:{color:'#ccc'}},axisLabel:{textStyle:{color:'#ccc'}}},yAxis:{axisLine:{lineStyle:{color:'#ccc'}},axisLabel:{textStyle:{color:'#ccc'}}}},light:{legend:{textStyle:{color:'#333'}},xAxis:{axisLine:{lineStyle:{color:'#333'}},axisLabel:{textStyle:{color:'#333'}}},yAxis:{axisLine:{lineStyle:{color:'#333'}},axisLabel:{textStyle:{color:'#333'}}}},transparent:{legend:{textStyle:{color:'#aaa'}},xAxis:{axisLine:{lineStyle:{color:'#aaa'}},axisLabel:{textStyle:{color:'#aaa'}}},yAxis:{axisLine:{lineStyle:{color:'#aaa'}},axisLabel:{textStyle:{color:'#aaa'}}}}};this.theme=undefined;this.timeVal=new Date().getTime();if(data&&data.time){this.data=data;this.timeVal=data.time;data.dsItemIds&&data.dsItemIds.forEach(function(id){_this.store.push({id:id});});}else{this.timeVal=new Date().getTime();}
this.localKey='historyPanel'+'_'+AppConfig.userId;!AppConfig.datasource&&(AppConfig.datasource={getDSItemById:DataSource.prototype.getDSItemById.bind({m_parent:{store:{dsInfoList:[]}},m_arrCloudTableInfo:[]})});DragPanel.arrInstance.push(this);this.show();}
HistoryDragPanel.prototype.show=function(){var _this=this;this.$indexMain=$('body');WebAPI.get('/static/views/observer/widgets/historyDragPanel.html').done(function(rsHtml){_this.$indexMain.append(rsHtml);_this.init();_this.saveToLocal({},_this.data?1:2);});};HistoryDragPanel.prototype.init=function(){this.theme=localStorage.getItem('historyDragPanelBg');this.$panel=$('#divHistoryDrag',this.$indexMain);this.$panel.attr('id','divHistoryDrag'+this.timeVal);this.ctnTimeConfig=$('.ctnTimeConfig',this.$panel);this.$ctnChart=$('.divHistoryChart',this.$panel);this.divTimeConfig=$('.divTimeConfig',this.$panel)[0];this.ctnChart=$('.divHistoryChart',this.$panel)[0];this.$btnClosePanel=$('.btnClosePanel',this.$panel);if(!this.theme){this.theme='dark';localStorage.setItem('historyDragPanelBg',this.theme);}
this.$panel.addClass(this.theme);$('.'+this.theme,this.$panel).addClass('selected');var $title=$('.divChartTtl',this.$panel);this.attachEvent();I18n.fillArea(this.$panel);$title.text($title.text());if(this.data){this.renderChartByData();}};HistoryDragPanel.prototype.renderChartByData=function(){var _this=this;var postData;this.$panel.css({top:this.data.top*screen.height,left:this.data.left*screen.width,width:this.data.width,height:this.data.height});var timeConfig=this.getTimeConfig();if(!this.data.dsItemIds||this.data.dsItemIds.length===0){return;}else{this.$panel.find('.dragTip').hide();}
postData={dsItemIds:this.data.dsItemIds,timeStart:this.data.timeStart,timeEnd:this.data.timeEnd,timeFormat:this.data.timeFormat};WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(dataSrc){_this.renderChart(dataSrc,timeConfig.interval);});};HistoryDragPanel.prototype.close=function(){this.$panel&&this.$panel.remove();this.$panel=null;this.store=null;this.panelDefaultW=null;this.panelDefaultY=null;this.ctnTimeConfig=null;this.$ctnChart=null;this.divTimeConfig=null;this.ctnChart=null;this.$btnClosePanel=null;this.themeOpt=null;this.theme=null;this.hisChart=null;this.timeVal=null;this.localKey=null;this.data=null;},HistoryDragPanel.prototype.attachEvent=function(){var _this2=this;var _this=this;var $btnShowTimeConfig=$('.btnShowTimeConfig',this.$panel);var $btnShowAddPanel=$('.btnShowAddPanel',this.$panel);var $divBackground=$('.divBackground',this.$panel);this.$panel.mousedown(function(e){_this.doDown(e);}).mouseup(function(e){_this.doUp(e);});this.$indexMain.on('mousemove',function(e){_this.doMove(e);});this.setDrag($('.divChartTtl',this.$panel)[0]);$(this.ctnTimeConfig).hide();this.$panel.find('.divConfigCancel').off('click').on('click',function(e){$(_this.ctnTimeConfig).slideUp();});this.$panel.find('.divConfigConfirm').off('click').on('click',function(e){$(_this.ctnTimeConfig).slideUp();_this2.chartPreSet();});$(this.divTimeConfig).find('.divTimeMode>select').off('change').on('change',function(e){_this2.createTimeRange(parseInt(e.currentTarget.value));});$(document).off('dragstart').on('dragstart','[data-h5-draggable-node]',function(e){EventAdapter.setData({dsItemId:e.currentTarget.dataset.dsId});});this.$ctnChart.off('dragover').on('dragover',function(e){e.preventDefault();});this.$ctnChart.off('dragleave').on('dragleave',function(e){e.preventDefault();});this.$ctnChart.off('drop').on('drop',function(e){e.preventDefault();e.stopPropagation();var id=EventAdapter.getData().dsItemId;for(var i=0;i<_this2.store.length;i++){if(_this2.store[i].id==id){typeof infoBox!='undefined'&&infoBox.alert(I18n.resource.dashboard.modalHistoryDataAnalyze.POINT_EXIST_TIP);return;}}
_this2.store.push({id:id});_this2.chartPreSet();});$btnShowAddPanel.off('click').on('click',function(e){e.stopPropagation();new HistoryDragPanel();});$btnShowTimeConfig.off('click').on('click',function(e){e.stopPropagation();if($(_this.ctnTimeConfig).is(':hidden')){$(_this.ctnTimeConfig).slideDown();}else{$(_this.ctnTimeConfig).slideUp();}});this.$btnClosePanel.off('click').on('click',function(e){e.stopPropagation();_this.saveToLocal(null,0);_this.close();});$divBackground.off('click').on('click','.bg',function(){$(this).addClass('selected').siblings('span').removeClass('selected');_this.$panel.removeClass(_this.theme);if(this.classList.contains('dark')){_this.theme='dark';}else if(this.classList.contains('light')){_this.theme='light';}else if(this.classList.contains('transparent')){_this.theme='transparent';}
localStorage.setItem('historyDragPanelBg',_this.theme);_this.$panel.addClass(_this.theme);_this.hisChart&&_this.hisChart.setOption($.extend(true,_this.hisChart.getOption(),_this.themeOpt[_this.theme]));});};HistoryDragPanel.prototype.chartPreSet=function(){var _this=this;var postData;$(this.$panel).find('.dragTip').hide();var timeConfig=this.getTimeConfig();if(_this.store.length===0){alert(I18n.resource.dashboard.modalHistoryDataAnalyze.NEED_DATA_SOURCE);}
postData={dsItemIds:_this.store.map(function(pt){return pt.id;}),timeStart:timeConfig.startTime,timeEnd:timeConfig.endTime,timeFormat:timeConfig.interval};this.saveToLocal(postData,1);WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(dataSrc){_this.renderChart(dataSrc,timeConfig.interval);});};HistoryDragPanel.prototype.renderChart=function(data,interval){if($.isEmptyObject(data)){return;}
var colorList=["#E2583A","#FD9F08","#1D74A9","#04A0D6","#689C0F","#109d83","#FEC500"];var formatDate='';var formatTime='';switch(interval){case'm1':formatTime='HH:mm';break;case'm5':formatTime='HH:mm';break;case'h1':formatTime='HH:mm';break;case'd1':formatDate='MM-dd';break;case'M1':formatDate='yyyy-MM-dd';formatTime='';break;}
var timeInit=data.timeShaft;var timeShaft=[].concat(data.timeShaft);for(var i=0;i<timeShaft.length;i++){if(formatDate&&formatTime){timeShaft[i]=new Date(timeShaft[i]).format(formatDate)+'\n\r'+new Date(timeShaft[i]).format(formatTime);}else if(formatDate){timeShaft[i]=new Date(timeShaft[i]).format(formatDate);}else{timeShaft[i]=new Date(timeShaft[i]).format(formatTime);}}
var dsName='';var legend=[];var series=[];for(var _i=0;_i<data.list.length;_i++){if(data.list[_i].data.length==0)continue;dsName=AppConfig.datasource.getDSItemById(data.list[_i].dsItemId).alias;this.store[_i].name=dsName;legend.push(dsName);series.push({name:dsName,data:data.list[_i].data,type:'line',itemStyle:{normal:{color:colorList[_i]}}});}
var option={title:{show:false,left:'center',text:I18n.resource.dashboard.modalHistoryDataAnalyze.HISTORY_DATA,textStyle:{color:'#fff'}},legend:{data:legend,padding:2,textStyle:{color:'#fff',fontSize:8,fontWeight:'lighter'},formatter:function formatter(opt){var str='';if(opt.length>10){str=opt.slice(0,5)+'...'+opt.slice(opt.length-5);}else{str=opt;}
return str;},orient:'horizontal',left:'center',top:'10'},grid:{x:45,y:25,x2:25,y2:25},toolbox:{},tooltip:{trigger:'axis',formatter:function formatter(data){var strTip='';strTip+=new Date(timeInit[data[0].dataIndex]).format('yyyy-MM-dd HH:mm')+'</br>';for(var i=0;i<data.length;i++){strTip+=data[i].seriesName+' : '+data[i].data;if(i!=data.length-1){strTip+='</br>';}}
return strTip;}},xAxis:{type:'category',boundaryGap:false,data:timeShaft,axisLine:{lineStyle:{color:'#fff'}}},yAxis:{type:'value',scale:true,axisLabel:{formatter:function formatter(value){var ret;if(value<1000){ret=value;}else if(value<1000000){ret=value/1000+'k';}else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0.8}},axisLine:{lineStyle:{color:'#fff'}}},series:series};var _this=this;this.hisChart=echarts.init(this.ctnChart,AppConfig.chartTheme);this.hisChart.setOption($.extend(true,option,this.themeOpt[this.theme]));this.hisChart.on('legendselectchanged',function(params){var arr=[];for(var i=0;i<_this.store.length;i++){if(_this.store[i].name==params.name){_this.store.splice(i,1);series.splice(i,1);legend.splice(i,1);_this.hisChart.setOption($.extend(true,option,_this.themeOpt[_this.theme]));}else{arr.push(_this.store[i].id);}}
_this.saveToLocal({dsItemIds:arr},1);});};HistoryDragPanel.prototype.getTimeConfig=function(){var mode=this.divTimeConfig.querySelector('.iptTimeMode').value;var dateTimeRange=this.divTimeConfig.querySelector('.divTimeRange');var dateInterval=$(this.divTimeConfig).find('.divTimeInterval>select')[0];var startTime,endTime,interval;var now=new Date();if(mode==0){var timeRangeVal=dateTimeRange.querySelector('.selRecentTimeRange').value;switch(timeRangeVal){case'today':startTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='h1';break;case'threeDay':startTime=new Date(now.getTime()-259200000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='h1';break;case'yesterday':startTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd 00:00:00');endTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd 23:59:59');interval='h1';break;case'thisWeek':startTime=new Date(now.getTime()-604800000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='d1';break;case'lastWeek':var weekVal=DateUtil.getWeekNumber(now);var dateRange=DateUtil.getDateRangeOnWeekNumber(weekVal[0],weekVal[1]-1);startTime=new Date(dateRange[0].getTime()-604800000).format('yyyy-MM-dd 00:00:00');endTime=new Date(dateRange[1].getTime()-604800000).format('yyyy-MM-dd 23:59:59');interval='d1';break;case'thisYear':startTime=new Date(now.getTime()-31536000000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='M1';break;}}else if(mode==1){var dateTimeUnit=dateTimeRange.querySelector('.selRecentTimeUnit').value;var unitTime=0;var dataTimeVal=parseInt(dateTimeRange.querySelector('.iptRecentTimeVal').value);if(isNaN(dataTimeVal))return;switch(dateTimeUnit){case'minute':unitTime=60000;break;case'hour':unitTime=3600000;break;case'day':unitTime=86400000;break;case'month':unitTime=2592000000;break;}
interval=dateInterval.value;startTime=new Date(now.getTime()-unitTime*dataTimeVal).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');}else if(mode==2){interval=dateInterval.value;startTime=new Date(dateTimeRange.querySelector('.iptStartTime').value).format('yyyy-MM-dd HH:mm:ss');endTime=new Date(dateTimeRange.querySelector('.iptEndTime').value).format('yyyy-MM-dd HH:mm:ss');}
return{startTime:startTime,endTime:endTime,interval:interval};};HistoryDragPanel.prototype.createTimeRange=function(mode){var _this3=this;$(this.divTimeConfig).find('.divTimeInterval').remove();$(this.divTimeConfig).find('.divTimeRange').remove();var divTimeRange=document.createElement('div');divTimeRange.className='divTimeRange form-group';switch(mode){case 0:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\n                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\n                <select class="form-control selRecentTimeRange">\n                    <option value="today" i18n="modalConfig.option.PERIOD_DROP_DOWN_TODAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_TODAY+'</option>\n                    <option value="threeDay"  i18n="modalConfig.option.PERIOD_DROP_DOWN_THREE_DAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THREE_DAY+'</option>\n                    <option value="yesterday" selected=""  i18n="modalConfig.option.PERIOD_DROP_DOWN_YESTERDAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_YESTERDAY+'</option>\n                    <option value="thisWeek" i18n="modalConfig.option.PERIOD_DROP_DOWN_THIS_WEEK">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THIS_WEEK+'</option>\n                    <option value="lastWeek" i18n="modalConfig.option.PERIOD_DROP_DOWN_LAST_WEEK">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_LAST_WEEK+'</option>\n                    <option value="thisYear" i18n="modalConfig.option.PERIOD_DROP_DOWN_THIS_YEAR">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THIS_YEAR+'</option>\n                </select>\n                ';break;case 1:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\n                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\n                <div class="input-group" style="width:100%">\n                    <input class="iptRecentTimeVal form-control" style="width:60%">\n                    <select class="selRecentTimeUnit form-control" style="width:40%">\n                        <option value="minute" i18n="modalConfig.option.PERIOD_UNIT_MIN">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MIN+'</option>\n                        <option value="hour" i18n="modalConfig.option.PERIOD_UNIT_HOUR">'+I18n.resource.modalConfig.option.PERIOD_UNIT_HOUR+'</option>\n                        <option value="day" i18n="modalConfig.option.PERIOD_UNIT_DAY">'+I18n.resource.modalConfig.option.PERIOD_UNIT_DAY+'</option>\n                        <option value="month" i18n="modalConfig.option.PERIOD_UNIT_MON">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MON+'</option>\n                    </select>\n                </div>\n                ';this.divTimeConfig.insertBefore(this.createTimeInterval('minute'),divTimeRange);$(divTimeRange).find('.selRecentTimeUnit').off('change').on('change',function(e){$(_this3.divTimeConfig).find('.divTimeInterval').remove();_this3.divTimeConfig.insertBefore(_this3.createTimeInterval(e.currentTarget.value),e.currentTarget.parentNode.parentNode);I18n.fillArea($(_this3.ctnTimeConfig));});break;case 2:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\n                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\n                <div class="input-group">\n                    <input class="form-control form_datetime iptStartTime" size="16" type="text" data-format="yyyy-mm-dd hh:ii" datetimepicker>\n                    <span class="input-group-addon" i18n="modalConfig.option.TIP_RANGE_TO">'+I18n.resource.modalConfig.option.TIP_RANGE_TO+'</span>\n                    <input class="form-control form_datetime iptEndTime" size="16" type="text" data-format="yyyy-mm-dd hh:ii" datetimepicker>\n                </div>\n                ';this.divTimeConfig.insertBefore(this.createTimeInterval(),divTimeRange);break;default:break;I18n.fillArea($(this.ctnTimeConfig));}};HistoryDragPanel.prototype.createTimeInterval=function(unit){var interval=document.createElement('div');interval.className='divTimeInterval';switch(unit){case'minute':interval.innerHTML='\n                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\n                <select class="form-control">\n                    <option value="m1" i18n="modalConfig.option.INTERVAL_MIN1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\n                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\n                </select>\n                ';break;case'hour':interval.innerHTML='\n                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\n                <select class="form-control">\n                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\n                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\n                </select>\n                ';break;case'day':interval.innerHTML='\n                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\n                <select class="form-control">\n                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\n                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\n                </select>\n                ';break;case'month':interval.innerHTML='\n                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\n                <select class="form-control">\n                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\n                    <option value="M1" i18n="modalConfig.option.INTERVAL_MON1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\n                </select>\n                ';break;default:interval.innerHTML='\n                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\n                <select class="form-control">\n                    <option value="m1" i18n="modalConfig.option.INTERVAL_MIN1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\n                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\n                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\n                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\n                    <option value="M1" i18n="modalConfig.option.INTERVAL_MON1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\n                </select>\n                ';this.setFixedRangeInterval('m1');var _this=this;interval.getElementsByTagName('select')[0].onchange=function(e){_this.setFixedRangeInterval(e.currentTarget.value);};break;}
I18n.fillArea($(this.ctnTimeConfig));return interval;};HistoryDragPanel.prototype.setFixedRangeInterval=function(interval){var iptStartTime=this.divTimeConfig.querySelector('.iptStartTime');var iptEndTime=this.divTimeConfig.querySelector('.iptEndTime');var format='';var datePikerFormat='';switch(interval){default:format='yyyy-MM-dd HH:mm';datePikerFormat='yyyy-mm-dd hh:ii';break;}
$(iptStartTime).attr('value',new Date().format(format)).datetimepicker({todayBtn:'linked',endTime:new Date(),format:datePikerFormat,autoclose:true,initialDate:new Date().format(format)});$(iptEndTime).attr('value',new Date().format(format)).datetimepicker({todayBtn:'linked',endTime:new Date(),format:datePikerFormat,autoclose:true,initialDate:new Date().format(format)});};HistoryDragPanel.prototype.resizeObject=function(){this.el=null;this.dir="";this.grabx=null;this.graby=null;this.width=null;this.height=null;this.left=null;this.top=null;},HistoryDragPanel.prototype.getDirection=function(el){var xPos,yPos,offset,dir;dir="";xPos=window.event.offsetX;yPos=window.event.offsetY;offset=8;if(yPos<offset)dir+="n";else if(yPos>el.offsetHeight-offset)dir+="s";if(xPos<offset)dir+="w";else if(xPos>el.offsetWidth-offset)dir+="e";return dir;},HistoryDragPanel.prototype.doDown=function(e){if(e.target.style.cursor.indexOf('-resize')>-1){var el=getReal(e.target,"className","historyDrag");if(el==null){this.el=null;return;}
if(el.className&&el.className.indexOf('historyDrag')<0)return;this.dir=this.getDirection(el);if(this.dir=="")return;this.leftObject=new this.resizeObject();this.leftObject.el=el;this.leftObject.dir=this.dir;this.leftObject.grabx=window.event.clientX;this.leftObject.graby=window.event.clientY;this.leftObject.width=el.offsetWidth;this.leftObject.height=el.offsetHeight;this.leftObject.left=el.offsetLeft;this.leftObject.top=el.offsetTop;window.event.returnValue=false;window.event.cancelBubble=true;}
function getReal(el,type,value){var temp=el;while(temp!=null&&temp.tagName!="BODY"){if(eval("temp."+type)==value){el=temp;return el;}
temp=temp.parentElement;}
return el;}},HistoryDragPanel.prototype.doUp=function(e){this.saveToLocal({width:this.$panel.width(),height:this.$panel.height(),top:this.$panel.position().top/screen.height,left:this.$panel.position().left/screen.width},1);if(this.leftObject!=null){this.leftObject=null;}},HistoryDragPanel.prototype.doMove=function(e){var el,str,xMin,yMin;xMin=this.panelDefaultW/4;yMin=this.panelDefaultY/5;el=event.srcElement;if(!el)return;if(el.className&&typeof el.className=='string'&&el.className.indexOf("historyDrag")>-1){str=this.getDirection(el);if(str=="")str="default";else str+="-resize";el.style.cursor=str;}
if(this.leftObject!=null){if(this.dir.indexOf("e")!=-1)this.leftObject.el.style.width=Math.max(xMin,this.leftObject.width+window.event.clientX-this.leftObject.grabx)+"px";if(this.dir.indexOf("s")!=-1)this.leftObject.el.style.height=Math.max(yMin,this.leftObject.height+window.event.clientY-this.leftObject.graby)+"px";if(this.dir.indexOf("w")!=-1){this.leftObject.el.style.left=Math.min(this.leftObject.left+window.event.clientX-this.leftObject.grabx,this.leftObject.left+this.leftObject.width-xMin)+"px";this.leftObject.el.style.width=Math.max(xMin,this.leftObject.width-window.event.clientX+this.leftObject.grabx)+"px";}
if(this.dir.indexOf("n")!=-1){this.leftObject.el.style.top=Math.min(this.leftObject.top+window.event.clientY-this.leftObject.graby,this.leftObject.top+this.leftObject.height-yMin)+"px";this.leftObject.el.style.height=Math.max(yMin,this.leftObject.height-window.event.clientY+this.leftObject.graby)+"px";}
window.event.returnValue=false;window.event.cancelBubble=true;this.hisChart&&this.hisChart.resize();}};HistoryDragPanel.prototype.setDrag=function(obj){var _this=this;var disX=0;var disY=0;obj.onmouseover=function(){obj.style.cursor="move";};obj.onmousedown=function(event){var realDragObj=obj.parentNode;var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=event.clientX+scrollLeft-realDragObj.offsetLeft;disY=event.clientY+scrollTop-realDragObj.offsetTop;document.onmousemove=function(event){var ol=event.clientX+scrollLeft;var ot=event.clientY+scrollTop;var l=ol-disX;var t=ot-disY;realDragObj.style.left=l+"px";realDragObj.style.top=t+"px";var isTop=realDragObj.offsetTop<0;var isLeft=realDragObj.offsetLeft<0;var isRight=realDragObj.offsetParent.offsetWidth-realDragObj.offsetLeft<realDragObj.offsetWidth;var isBottom=realDragObj.offsetParent.offsetHeight-realDragObj.offsetTop<realDragObj.offsetHeight;if(isTop){realDragObj.style.top='0px';}
if(isLeft){realDragObj.style.left='0px';}
if(isRight){realDragObj.style.left=realDragObj.parentNode.offsetWidth-realDragObj.offsetWidth+'px';}
if(isBottom){realDragObj.style.top=realDragObj.parentNode.offsetHeight-realDragObj.offsetHeight+'px';}};document.onmouseup=function(e){_this.saveToLocal({top:_this.$panel.position().top/screen.height,left:_this.$panel.position().left/screen.width},1);document.onmousemove=null;document.onmouseup=null;};return false;};};HistoryDragPanel.prototype.saveToLocal=function(params,type){var _this=this;var arrPanel=[],localPanel,isNew=true;localPanel=localStorage.getItem(this.localKey);if(localPanel){arrPanel=JSON.parse(localPanel);}
if(type==0){for(var i=0,l=arrPanel.length;i<l;i++){if(arrPanel[i].time==this.timeVal){arrPanel.splice(i,1);break;}}}else if(type==1){if(arrPanel&&arrPanel instanceof Array){arrPanel.map(function(data){if(data.time==_this.timeVal){data=$.extend(true,data,params);if(params.hasOwnProperty('dsItemIds')){data.dsItemIds=params.dsItemIds;}
return data;}});}}else if(type==2){arrPanel.push({time:this.timeVal,top:this.$panel.position().top/screen.height,left:this.$panel.position().left/screen.width,width:this.$panel.width(),height:this.$panel.height()});}
localStorage.setItem(this.localKey,JSON.stringify(arrPanel));};return HistoryDragPanel;}();var WorkflowInsert=function(){var ConfigMap={el:{"container":"#workflow-insert-container","modalContainer":"#wf-add-person","faultCurveContainer":"#workflow-insert-curve","userGroupContainer":"#wf-user-group-list","calendarContainer":"#dueTime","confirmBtn":"#workflow-insert-submit-btn"}};var _this=null;function WorkflowInsert(insertData){_this=this;this.insertData=insertData;this.eventCbList={};this.modalType="default";this.echartsInstance=null;this.jqueryMap={};this.modalBodyDetach=null;this.pendingFiles=[];this.taskModelInfo=null;this.formData=new FormData();this.spinner=new LoadingSpinner({color:'#00FFFF'});this.stateMap={userSelectedMap:{"verifiers":[],"executor":[],"watchers":[]},userGroupList:[]};}
WorkflowInsert.prototype={show:function show(){Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/workflow/workflowInsert.html"+'?='+new Date().getTime()).done(function(resultHtml){$('body').append(resultHtml);this.jqueryMap.$container=$(ConfigMap.el.container).find('.modal');this.jqueryMap.$workflowInsertTitle=this.jqueryMap.$container.find('.modal-title');this._setModalJqueryMap();this._init();I18n.fillArea(this.jqueryMap.$container);}.bind(this));return this;},close:function close(){this._destroy();},submitSuccess:function submitSuccess(fn){this.eventCbList.submitSuccess=fn?fn:this._noop;return this;},cancel:function cancel(fn){this.eventCbList.cancel=fn?fn:this._noop;return this;},fail:function fail(fn){this.eventCbList.fail=fn?fn:this._noop;return this;},_destroy:function _destroy(){this.echartsInstance&&this.echartsInstance.dispose();$(ConfigMap.el.container).remove();this.jqueryMap=null;this.pendingFiles=null;this.modalBodyDetach=null;},_init:function _init(){var _this=this;_this._bindEventsCommon();_this._loadDataNormal().done(function(){_this._bindEventsNormal();}).fail(function(err){console.error(err);});I18n.fillArea(_this.jqueryMap.$container);Spinner.stop();_this.jqueryMap.$container.modal({backdrop:'static'});},_setModalJqueryMap:function _setModalJqueryMap(){this.jqueryMap.$modalHeader=this.jqueryMap.$container.find('.modal-header');this.jqueryMap.$modalBody=this.jqueryMap.$container.find('.modal-body');this.jqueryMap.$modalFooter=this.jqueryMap.$container.find('.modal-footer');this.jqueryMap.$fileUploadBtn=this.jqueryMap.$container.find('#wf-attachment-input-btn');},_bindEventsCommon:function _bindEventsCommon(){var _this=this;this.jqueryMap.$container.off();this.jqueryMap.$container.on('hidden.bs.modal',this._onModalHide.bind(this)).on('show.bs.modal',this._onModalShow.bind(this));this.jqueryMap.$container.on('click.workflow-insert-cancel-btn','#workflow-insert-cancel-btn',this._onCancelClick.bind(this));this.jqueryMap.$container.on('click.wf-people-add','.wf-people-add',this._addUserSelectDialog.bind(this));this.jqueryMap.$container.on('click.workflow-insert-submit-btn',ConfigMap.el.confirmBtn,this._onConfirm.bind(this));this.jqueryMap.$container.on('click.wf-attachment-input-btn','#wf-attachment-input-btn',this._uploadFile.bind(this));},_loadDataNormal:function _loadDataNormal(){var failed=function failed(data){console.error('Get loadInsertPage error !');console.log(data);};if($.isEmptyObject(this.insertData)){return $.Deferred().reject('insertData'+'isn\'t a unEmptyObject! ');}
this.jqueryMap.$workflowInsertTitle.html(I18n.resource.workflow.main.NEW_FAULT_ORDER).attr("i18n",'workflow.main.NEW_FAULT_ORDER');this.jqueryMap.$modalBody.empty().html(beopTmpl('temp_fault_new_order',{fault:this.insertData}));this._refreshGroupMenuList();I18n.fillArea(this.jqueryMap.$container);return this._renderFaultChart().done(function(result){if(result.success){I18n.fillArea(this.jqueryMap.$container);}}.bind(this)).always(function(){Spinner.stop();}).fail(function(){failed(this.insertData);}.bind(this));},_noop:function _noop(){return false;},_addUserSelectDialog:function _addUserSelectDialog(ev){var $modalBody=this.jqueryMap.$modalBody,$this=$(ev.target);this.modalType="addPerson";this._openUserSelectDialog($this.data('type'));I18n.fillArea($(this.jqueryMap.$container));},_openUserSelectDialog:function _openUserSelectDialog(type){var _this=this;var setUserSelectedNormal=function setUserSelectedNormal(result,type){var flag=null;beop.view.memberSelected.configModel({userMemberMap:result.data,cb_dialog_hide:_this._renderAddedUsersNormal(type),userHasSelected:_this.stateMap.userSelectedMap[type],maxSelected:type=='executor'?1:null,maxDelete:flag,enableDeleteMember:true,enableAddMember:true});beop.view.memberSelected.init($('body'));};var groupUserPromise=null;if(beop.model.stateMap.groupId){groupUserPromise=WebAPI.get('/workflow/group/group_user_list/'+AppConfig.userId+'/'+beop.model.stateMap.groupId);}else{groupUserPromise=WebAPI.get('/workflow/group/user_dialog_list/'+AppConfig.userId);}
groupUserPromise.done(function(result){if(result.success){setUserSelectedNormal(result,type);}}).fail(function(){alert('获取人物选择框模板失败');});},_renderAddedUsersNormal:function _renderAddedUsersNormal(type){return function(addedUserList){this.stateMap.userSelectedMap[type]=addedUserList;var _this=this;this.jqueryMap.$modalBody.find(".wf-detail-userInfoWrapper").each(function(index,item){var $item=$(item);var picType=$item.data("type");$item.html(beopTmpl('temp_wf_added_member_personal',{members:_this.stateMap.userSelectedMap[picType],userListName:picType?picType:'addedUserList'}));}).end().find('.wf-detail-userInfoWrapper dl').on('click',function(event){event.stopPropagation();});this.modalType='default';}.bind(this);},_restoreModalBodyDetach:function _restoreModalBodyDetach(){if(this.modalBodyDetach){this.jqueryMap.$modalBody.empty().append(this.modalBodyDetach);}else{throw new SyntaxError('there is no modalBody Detach in here !');}},_uploadFile:function _uploadFile(){Spinner.spin(ElScreenContainer);var _this=this;var fileUploadInstance=new WfFileUpload(true,this.pendingFiles.length,true);fileUploadInstance.init(function(){Spinner.stop();}).uploadSuccess(function(list){_this._showUploadFile(list,this);}).close(function(file){});},_showUploadFile:function _showUploadFile(list,fileUploadInstance){this.pendingFiles=this.pendingFiles.concat(list);fileUploadInstance=null;var html='',_this=this;this.pendingFiles.forEach(function(item){html+=beopTmpl('wf_file_list_temp',{file:item.file,fileId:item.id,iconClass:item.iconClass,fileBase64:item.fileBase64,uid:item.uid,fileName:item.file.name});});var AUTOSENDFILE=true;this.jqueryMap.$container.find('.wf-attachment-nav').empty().html(html);this.jqueryMap.$container.off('click.wf-remove-upload-item').on('click.wf-remove-upload-item','.wf-remove-upload-item',function(){var $this=$(this),$files=$this.closest('div.files'),fileId=$files.attr('data-file-id'),uid=$files.attr('data-file-uid'),fileName=$files.attr('data-file-name');var removeAttachmentLi=function removeAttachmentLi(){_this.pendingFiles.forEach(function(item,index,array){if(item.id==fileId){array.splice(index,1);}});_this.jqueryMap.$container.find('.wf-attachment-nav').find('li').each(function(){var $that=$(this);if($that.find('.files').attr('data-file-id')==fileId){$that.fadeOut();}});};if(AUTOSENDFILE){confirm(I18n.resource.workflow.task.ATTACHMENT_DELETE_NOTE,function(){Spinner.spin(ElScreenContainer);WebAPI.post('/workflow/attachment/deleteByName',{fileId:fileId,uid:uid,name:fileName}).done(function(result){if(result.success){removeAttachmentLi();}}).always(function(){Spinner.stop();});});}else{confirm(I18n.resource.workflow.task.ATTACHMENT_DELETE_NOTE,function(){if(!fileId){return false;}else{removeAttachmentLi();}});}});},_onCancelClick:function _onCancelClick(){if(this.modalType=='default'){this.jqueryMap.$container.modal('hide');}else if(this.modalType=='addPerson'){this.modalType='default';}},_onConfirm:function _onConfirm(){var _this=this;if(this.modalType=='addPerson'){this.jqueryMap.$container.find('#wf-member-comfirm-btn').click();}else if(this.modalType=='default'){if(_this._pageTaskCheck()){this._newTaskSubmit();}}},_pageTaskCheck:function _pageTaskCheck(){var $dialog=$("#workflow-insert-container"),i18n=I18n.resource.workflow.common;var title_val=$dialog.find('input[name="title"]').val().trim(),detail_val=$dialog.find('textarea[name="detail"]').val().trim();if(title_val===""){Alert.danger($dialog,i18n.TITLE_REQUIRED).showAtTop(2000);return false;}
if(detail_val===""){Alert.danger($dialog,i18n.DETAIL_REQUIRED).showAtTop(2000);return false;}
return true;},_onModalShow:function _onModalShow(){},_onModalHide:function _onModalHide(){this._destroy();this.eventCbList.cancel&&this.eventCbList.cancel.call(this);},_bindEventsNormal:function _bindEventsNormal(){var _this=this;$(ConfigMap.el.calendarContainer).datetimepicker({minView:2,format:timeFormatChange('yyyy-mm-dd'),autoclose:true,forceParse:false});this.jqueryMap.$container.on('submit',this._newTaskSubmit.bind(this));this.jqueryMap.$container.find(ConfigMap.el.userGroupContainer).off().on('change',function(){_this._setUserTaskGroupId($(this).val());});},_setUserTaskGroupId:function _setUserTaskGroupId(value){if(beop.model&&beop.model.stateMap){beop.model.stateMap.groupId=value;}else{if(beop.model){beop.model.stateMap={};beop.model.stateMap.groupId=value;}else{beop.model={};beop.model.stateMap={};beop.model.stateMap.groupId=value;}}},_returnCreateTask:function _returnCreateTask(){Spinner.spin(this.jqueryMap.$container.get(0));this._loadDataNormal();Spinner.stop();},_newTaskSubmit:function _newTaskSubmit(){var _this=this;Spinner.spin(this.jqueryMap.$container.get(0));this._submitData().done(function(result){if(result.success){_this.pendingFiles=[];if(_this.pendingFiles&&_this.pendingFiles.length){_this._submitFileUpload(result.data).done(function(uploadResult){if(uploadResult&&uploadResult.success){Alert.success(_this.jqueryMap.$container.get(0),I18n.resource.workflow.main.THE_WORK_ORDER+I18n.resource.workflow.main.IS_CREATED_SUCCESSFULLY).showAtTop(2000);_this.eventCbList.submitSuccess&&_this.eventCbList.submitSuccess.call(_this,_this.taskModelInfo,_this.pendingFiles);}else{Alert.danger(_this.jqueryMap.$container.get(0),I18n.resource.workflow.task.ATTACHMENT_FILE_FAIL_INFO).showAtTop(2000);}}).fail(function(){Alert.danger(_this.jqueryMap.$container.get(0),I18n.resource.workflow.task.ATTACHMENT_FILE_FAIL_INFO).showAtTop(2000);_this.eventCbList.fail&&_this.eventCbList.fail.call(_this);});}else{Alert.success(_this.jqueryMap.$container.get(0),I18n.resource.workflow.main.IS_CREATED_SUCCESSFULLY).showAtTop(2000);_this.eventCbList.submitSuccess&&_this.eventCbList.submitSuccess.call(_this,_this.taskModelInfo);}}else{Alert.danger(_this.jqueryMap.$container.get(0),result.msg).showAtTop(2000);_this.eventCbList.fail&&_this.eventCbList.fail.call(_this);}}).fail(function(){Alert.danger(_this.jqueryMap.$container.get(0),I18n.resource.workflow.main.CREATE_WORKFLOW_FAILED).showAtTop(2000);_this.eventCbList.fail&&_this.eventCbList.fail.call(_this);}).always(function(){Spinner.stop();});},_submitData:function _submitData(){return WebAPI.post('/workflow/transaction/new/',this._getSubmitData());},_submitFileUpload:function _submitFileUpload(transId){var _this=this;this.pendingFiles.forEach(function(item){_this.formData.append('file',item.file);});_this.formData.append('transId',transId);_this.formData.append('userId',AppConfig.userId);return $.ajax({url:'workflow/attachment/upload',type:'post',data:_this.formData,cache:false,contentType:false,processData:false});},_getSubmitData:function _getSubmitData(){var $formData=this.jqueryMap.$container.find('#wf-detail-form').serializeObject();$formData["pendingFiles"]=[];this.pendingFiles.forEach(function(item){$formData.pendingFiles.push({fileName:item.file.name,uid:item.uid});});console.log(this.insertData.chartStartTime,this.insertData.chartEndTime);var param={chartPointList:this.insertData.chartPointList,chartQueryCircle:this.insertData.chartQueryCircle,chartStartTime:this.insertData.chartStartTime,chartEndTime:this.insertData.chartEndTime,userId:AppConfig.userId,projectId:AppConfig.projectId||Number(this.insertData.projectId),noticeId:this.insertData.noticeId};this.taskModelInfo=$.extend(true,{},param,$formData);this.taskModelInfo.dueDate=new Date($('#wf-detail-form #dueTime').val()).format('yyyy-MM-dd');return this.taskModelInfo;},_refreshGroupMenuList:function _refreshGroupMenuList(){var html="";this.stateMap.userGroupList.forEach(function(item){if(item.type==0){html+="<option value='"+item.id+"' selected>"+I18n.resource.workflow.main.DEFAULT_GROUP+"</option>";}else{if(beop.model.stateMap.groupId==item.id){html+='<option value="'+item.id+'" selected>'+item.name+'</option>';}else{html+='<option value="'+item.id+'">'+item.name+'</option>';}}});if(!html){html="<option value='default' selected>"+I18n.resource.workflow.main.DEFAULT_GROUP+"</option>";}
$(ConfigMap.el.userGroupContainer).html(html);},_renderFaultChart:function _renderFaultChart(){if(!this.insertData.chartPointList){$('#wf-detail-curve-box').hide();return $.Deferred().resolve({success:true});}
this.spinner.spin($(ConfigMap.el.faultCurveContainer).get(0));beop.view.faultCurve.configModel({transactions_model:beop.model.transactionsModel});return beop.view.faultCurve.init($('#workflow-insert-curve'),{projectId:Number(this.insertData.projectId),chartPointList:this.insertData.chartPointList,chartQueryCircle:this.insertData.chartQueryCircle,chartStartTime:this.insertData.chartStartTime,chartEndTime:this.insertData.chartEndTime}).always(function(){_this.spinner.stop();});}};return WorkflowInsert;}();var WorkflowRemind=function(){function WorkflowRemind(remindData){this.timer=null;this.remindData=!remindData?[]:remindData;}
WorkflowRemind.prototype={show:function show(){this.init();},close:function close(){var $wfMessageBox=$("#wfMessageBox");$wfMessageBox.slideUp(1000);$wfMessageBox.remove();},init:function init(){if(this.remindData.length){this._createBox();this._bindEvents();}},_createBox:function _createBox(){var messageLi='<ul id="wfMessageUl">',timer;for(var i=0;i<this.remindData.length;i++){var item=this.remindData[i],taskInfo=item.taskInfo,taskId=taskInfo&&taskInfo.id,creator=taskInfo&&taskInfo.creatorInfo;messageLi+='<li class="wfMessageLi oh" trans_id = "'+taskId+'">'+'<img src="'+creator.userpic+'" class="userImg fl">'+'<div class="fl oh">'+'<span class="db wfMessageInfo">'+'<span class="wfMessageUserName">'+creator.userfullname+'</span>'+'<span class="wfMessageOp">'+this._translateOp(item.task.op)+'</span>'+'</span>'+'<span class="db wfMessageInfo wfMessageIdAndTitle ellipsis" title="'+taskId+' '+taskInfo.title+'">'+'<span>'+taskId+' </span>'+'<span>'+taskInfo.title+'</span>'+'</span>'+'<span class="db wfMessageTime">'+item.task.optime+'</span>'+'</div>'+'</li>';}
messageLi+='</ul>';var remindRemindInstance=remindInfoBox(messageLi);timer=setTimeout(function(){remindRemindInstance._destroy();},30000);},_translateOp:function _translateOp(text){switch(text){case'reply':return I18n.resource.workflow.notice.TASK_REPLY;case'new':return I18n.resource.workflow.notice.TASK_CREATE;case"complete":return I18n.resource.workflow.notice.TASK_FINISH;case"verified":return I18n.resource.workflow.notice.TASK_VERIFIED;case"not_verified":return I18n.resource.workflow.notice.TASK_VERIFIED_FAILED;default:return text;}},_bindEvents:function _bindEvents(){var _this=this;$("#wfMessageClose").off().on('click',function(){_this.close();});$("#wfMessageUl .wfMessageLi").off().on('click',function(){ScreenCurrent.container='undefined';location.hash='#page=workflow&type=transaction&transactionId='+$(this).attr('trans_id');});}};return WorkflowRemind;}();(function(beop){beop.apiMethod={get:'GET',post:'POST'};beop.apiMap={'addGroup':{'method':beop.apiMethod.post,'url':'/workflow/group/new/<user_id>'},'editGroup':{'method':beop.apiMethod.post,'url':'/workflow/group/edit/<group_id>/<user_id>'},'deleteGroup':{'method':beop.apiMethod.get,'url':'/workflow/group/delete/<group_id>/<user_id>'},'getGroupData':{'method':beop.apiMethod.get,'url':'/workflow/group/get/<group_id>/<user_id>'},'addTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/new/'},'updateTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/update/'},'completeTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/complete/'},'verifyPass':{'method':beop.apiMethod.post,'url':'/workflow/transaction/pass_verify/'},'verifyNotPass':{'method':beop.apiMethod.post,'url':'/workflow/transaction/not_pass_verify/'},'listOneGroup':{'method':beop.apiMethod.get,'url':'/workflow/group/<user_id>/<project_id>'},'listGroupActivities':{'method':beop.apiMethod.post,'url':'/workflow/group_activities/<userId>/<activity_time_type>/<limit>'},'getTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/<trans_id>'},'delTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/delete/<trans_id>'},'getTransactionStar':{'method':beop.apiMethod.get,'url':'/workflow/transaction/star/<user_id>/<page_num>/<page_size>'},'getTransactionWorking':{'method':beop.apiMethod.post,'url':'/workflow/transaction/working/<user_id>/<page_num>/<page_size>'},'getTransactionCreatedBy':{'method':beop.apiMethod.post,'url':'/workflow/transaction/created_by/<user_id>/<page_num>/<page_size>'},'getTransactionFinishedBy':{'method':beop.apiMethod.post,'url':'/workflow/transaction/finished_by/<user_id>/<page_num>/<page_size>'},'getTransactionJoinedBy':{'method':beop.apiMethod.post,'url':'/workflow/transaction/joined_by/<user_id>/<page_num>/<page_size>'},'getWorkflowDetailBy':{'method':beop.apiMethod.get,'url':'/workflow/detail/<record_id>'},'addReply':{'method':beop.apiMethod.post,'url':'/workflow/transaction/insert_reply/'},'listMenu':{'method':beop.apiMethod.post,'url':'/workflow/menu/listMenu/'},'listSecondMenu':{'method':beop.apiMethod.post,'url':'/workflow/menu/list_second_menu/'},'insertReply':{'method':beop.apiMethod.post,'url':'/workflow/insert/reply'},'deleteReply':{'method':beop.apiMethod.post,'url':'/workflow/insert/delete/<user_id>'},'getReply':{'method':beop.apiMethod.get,'url':'/workflow/transaction/get_reply/<trans_id>'},'getProgress':{'method':beop.apiMethod.get,'url':'/workflow/transaction/get_progress/<trans_id>'},'faultCurve':{'method':beop.apiMethod.get,'url':'/workflow/transaction/fault_curve_data/<trans_id>'},'faultCurveByParam':{'method':beop.apiMethod.post,'url':'/workflow/loadFaultData'},'userGroups':{'method':beop.apiMethod.get,'url':'/workflow/users/group/<user_id>'},'transInGroups':{'method':beop.apiMethod.post,'url':'/workflow/group/transaction/<group_id>/<user_id>/<page_num>/<page_size>'},'searchTasks':{'method':beop.apiMethod.post,'url':'/workflow/transaction/search/<page_num>/<page_size>'},'userDialogList':{'method':beop.apiMethod.get,'url':'/workflow/group/user_dialog_list/<user_id>'},'userListByGroup':{'method':beop.apiMethod.get,'url':'/workflow/group/group_user_list/<user_id>/<group_id>'},'getUserTags':{'method':beop.apiMethod.get,'url':'/workflow/tag/user/<user_id>'},'addTag':{'method':beop.apiMethod.post,'url':'/workflow/user/tag/add/<user_id>'},'deleteTag':{'method':beop.apiMethod.get,'url':'/workflow/user/tag/delete/<user_id>/<tag_id>'},'editTag':{'method':beop.apiMethod.post,'url':'/workflow/user/tag/update/<user_id>'},'addTransTag':{'method':beop.apiMethod.get,'url':'/workflow/tag/add/<trans_id>/<tag_id>'},'transTagDelete':{'method':beop.apiMethod.get,'url':'/workflow/tag/delete/<trans_id>/<tag_id>'},'transTag':{'method':beop.apiMethod.post,'url':'/workflow/tag/trans/<user_id>/<tag_id>/<page_num>/<page_size>'},'tagTrans':{'method':beop.apiMethod.get,'url':'/workflow/trans/tag/<trans_id>'},'toggleStarred':{'method':beop.apiMethod.get,'url':'/workflow/transaction/star/<user_id>/<trans_id>'},'getTransactionNewCreated':{'method':beop.apiMethod.post,'url':'/workflow/transaction/get_new_created/<user_id>/<page_num>/<page_size>'},'getTransactionStarted':{'method':beop.apiMethod.post,'url':'/workflow/transaction/get_started_trans/<user_id>/<page_num>/<page_size>'},'getTransactionWaitVerify':{'method':beop.apiMethod.post,'url':'/workflow/transaction/get_wait_verify_trans/<user_id>/<page_num>/<page_size>'},'startTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/start_trans/<user_id>/<trans_id>'},'updateExecutor':{'method':beop.apiMethod.post,'url':'/workflow/transaction/update_executor/<user_id>/<trans_id>'},'closeTask':{'method':beop.apiMethod.post,'url':'/workflow/transaction/close_task/<user_id>/<trans_id>'},'getCompleteVerifiedTask':{'method':beop.apiMethod.post,'url':'/workflow/transaction/get_complete_verified/<user_id>/<page_num>/<page_size>'},'getStopVerifiedTask':{'method':beop.apiMethod.post,'url':'/workflow/transaction/get_stop_verified/<user_id>/<page_num>/<page_size>'},'getListTodayTasks':{'method':beop.apiMethod.post,'url':'/workflow/listTodayTasks'},'updateTransactionStatus':{'method':beop.apiMethod.post,'url':'/workflow/transaction/updateStatus'},'waitMeToVerifier':{'method':beop.apiMethod.post,'url':'/workflow/transaction/waitMeToVerifier/<user_id>/<page_num>/<page_size>'},'getAttachmentByTransId':{'method':beop.apiMethod.get,'url':'/workflow/attachment/getFiles/<trans_id>'},'deleteAttachment':{'method':beop.apiMethod.post,'url':'/workflow/attachment/delete'},'team':{'method':beop.apiMethod.post,'url':'/workflow/team/'},'taskGroup':{'method':beop.apiMethod.post,'url':'/workflow/taskGroup/'},'saveTask':{'method':beop.apiMethod.post,'url':'/workflow/saveTask/'}};})(beop||(beop={}));(function(beop){var emit,api,param,data,apiURL,paramRegex=/\<([^\<\>]+)\>/g;emit=function emit(){if(arguments.length===0||!arguments[0]){beop.util.makeError('request error','api name is Null');return false;}
api=arguments[0],apiURL=api.url;if(arguments.length===2){if(paramRegex.test(api.url)){param=arguments[1];}else{data=arguments[1];}}else if(arguments.length===3){param=arguments[1];data=arguments[2];}
if(param){apiURL=api.url.replace(paramRegex,function(match,p0){return param[p0];});}
if(api.method===beop.apiMethod.get){return WebAPI.get(apiURL);}else if(api.method===beop.apiMethod.post){return WebAPI.post(apiURL,data);}};if(beop.data){beop.data.emit=emit;beop.data.paramRegex=paramRegex;}else{beop.data={emit:emit,paramRegex:paramRegex};}})(beop||(beop={}));(function(beop){var transactionId=177,dfd,makeFakeTransactionId,getApiName,emit,api,param,data;makeFakeTransactionId=function makeFakeTransactionId(){return String(transactionId++);};getApiName=function getApiName(api){if(!api){return false;}
for(var apiName in beop.apiMap){if(beop.apiMap[apiName].url===api.url&&beop.apiMap[apiName].method===api.method){return apiName;}}
return false;};emit=function emit(){if(arguments.length===0||!arguments[0]){beop.util.makeError('request error','api name is Null');return false;}
api=arguments[0];if(arguments.length===2){if(beop.data.paramRegex.test(api.url)){param=arguments[1];}else{data=arguments[1];}}else if(arguments.length===3){param=arguments[1];data=arguments[2];}
dfd=$.Deferred();switch(getApiName(api)){case getApiName(beop.apiMap.addGroup):return dfd.resolve({success:true});case getApiName(beop.apiMap.listActivities):return $.getJSON('/static/scripts/workflow2.0/fakeData/activities.json').then(function(result){if(param.startTime){result.data=result.data.filter(function(item){return moment(param.startTime).isBefore(item.opTime);});}
return dfd.resolve(result);});case getApiName(beop.apiMap.getTransactionCreatedBy):return $.getJSON('/static/scripts/workflow2.0/fakeData/transactions.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getTransactionFinishedBy):return $.getJSON('/static/scripts/workflow2.0/fakeData/transactions.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getTransactionJoinedBy):return $.getJSON('/static/scripts/workflow2.0/fakeData/transactions.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getTransaction):return $.getJSON('/static/scripts/workflow2.0/fakeData/details.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getReply):return $.getJSON('/static/scripts/workflow2.0/fakeData/replyList.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getProgress):return $.getJSON('/static/scripts/workflow2.0/fakeData/progress.json').then(function(result){return dfd.resolve(result);});default:{return dfd.reject('can\'t find the api');}}};beop.fake={emit:emit,makeFakeTransactionId:makeFakeTransactionId};})(beop||(beop={}));(function($){var subEvent,pubEvent,unSubEvent,eventMap={};subEvent=function subEvent($obj,topic,fn){if(!$obj){return false;}
$obj.off(topic).on(topic,fn);if(eventMap[topic]){eventMap[topic]=$obj;}else{eventMap[topic]=$obj;}};pubEvent=function pubEvent(topic,data){if(!eventMap[topic]){return false;}
if(data){eventMap[topic].trigger(topic,$.isArray(data)?data:[data]);}else{eventMap[topic].trigger(topic);}
return true;};unSubEvent=function unSubEvent($obj,topic){if(!eventMap[topic]){return false;}
eventMap[topic]=eventMap[topic].not($obj);if(eventMap[topic].length===0){delete eventMap[topic];}
return true;};$.spEvent={subEvent:subEvent,pubEvent:pubEvent,unSubEvent:unSubEvent};})(jQuery);(function(beop){var makeError,setConfigMap;makeError=function makeError(name_text,msg_text,data){var error=new Error();error.name=name_text;error.message=msg_text;if(data){error.data=data;}
return error;};setConfigMap=function setConfigMap(arg_map){var input_map=arg_map.input_map,settable_map=arg_map.settable_map,config_map=arg_map.config_map,key_name,error;for(key_name in input_map){if(input_map.hasOwnProperty(key_name)){if(settable_map.hasOwnProperty(key_name)){config_map[key_name]=input_map[key_name];}else{error=makeError('Bad Input','Setting config key |'+key_name+'| is not supported');throw error;}}}};$.fn.serializeObject=function(){var obj={};this.serializeArray().map(function(item){if(/\[\]$/.test(item.name)){if(obj[item.name]){obj[item.name].push(item.value);}else{obj[item.name]=[item.value];}}else{obj[item.name]=item.value;}});return obj;};beop.util=$.extend(beop.util?beop.util:{},{makeError:makeError,setConfigMap:setConfigMap});})(beop||(beop={}));var WorkflowTool=function(){var pic_path='/static/images/workflow/',templateStorage;function getStatusText(status){if(status==0){status='new';}
switch(status){case'new':return I18n.resource.workflow.main.NEW;case 1||'closed':return I18n.resource.workflow.main.CLOSE;case 2||'start':return I18n.resource.workflow.main.DEALING;case 3||'pause':return I18n.resource.workflow.main.PAUSED;case 4||'completed':return I18n.resource.workflow.main.FINISHED;case 5||'deleted':return I18n.resource.workflow.main.DELETED;}}
function translate(text){if(!text){return'';}
try{text=JSON.parse(text);}catch(e){}
var Translation=function Translation(text){switch(text){case'detail':return I18n.resource.workflow.main.FAULT_INFO;case'dueDate':return I18n.resource.workflow.notice.DEADLINE;case'title':return I18n.resource.workflow.main.FAULT_TITLE;case'due_date':return I18n.resource.workflow.common.DEADLINE;case'critical':return I18n.resource.workflow.urgencyLevel.URGENCY_LEVEL;case'executor':return I18n.resource.workflow.common.EXECUTOR;case'assignTime':return I18n.resource.workflow.notice.TASK_ASSIGN_TIME;case'groupid':return I18n.resource.workflow.task.TASK_GROUP;case'tags':return I18n.resource.workflow.task.TAGS;case'verifiers':return I18n.resource.workflow.task.VERIFIERS;case'watchers':return I18n.resource.workflow.task.WATCHERS;case'op':return I18n.resource.workflow.task.STATUS;default:return text;}};var criticalTranslate=function criticalTranslate(num){var level=I18n.resource.workflow.urgencyLevel[parseInt(num)];if(level=='undefined'||level==undefined||level==null){return'';}else{return level;}};var groupIdTranslate=function groupIdTranslate(num){for(var i=0;i<beop.model.stateMap.group_list.length;i++){var groupItem=beop.model.stateMap.group_list[i];if(groupItem.id==num){if(groupItem.name=='undefined'||groupItem.name==undefined||groupItem.name==null){return'';}else{return groupItem.name;}}}};var listObjTranslate=function listObjTranslate(list){if(!list){return"";}
var text="";for(var i=0;i<list.length;i++){if(i!=list.length-1){text+=list[i].userfullname+", ";}else{text+=list[i].userfullname;}}
if(text=='undefined'||text==null||text==undefined){return'';}else{return text;}};var html='<ul class="historyEdit list-unstyled">';if($.isPlainObject(text)){for(var prop in text){if(prop=='critical'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(criticalTranslate(text[prop].old)?criticalTranslate(text[prop].old):'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(criticalTranslate(text[prop].new)?criticalTranslate(text[prop].new):'')+'</span></li>';}else if(prop=='groupid'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(groupIdTranslate(text[prop].old)?groupIdTranslate(text[prop].old):'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(groupIdTranslate(text[prop].new)?groupIdTranslate(text[prop].new):'')+'</span></li>';}else if(prop=='watchers'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(listObjTranslate(text[prop].old)?listObjTranslate(text[prop].old):'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(listObjTranslate(text[prop].new)?listObjTranslate(text[prop].new):'')+'</span></li>';}else if(prop=='verifiers'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(listObjTranslate(text[prop].old)?listObjTranslate(text[prop].old):'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(listObjTranslate(text[prop].new)?listObjTranslate(text[prop].new):'')+'</span></li>';}else if(prop=='op'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(text[prop]?text[prop]:'')+'</span></li>';}else if(prop=='delete_reply'){html+='<li><span class="historyConTitle"></span> '+'<strong class="historyAction"></strong><span class="newName">'+(text[prop]?text[prop]?text[prop]:'':'')+'</span></li>';}else if(prop=='reply'){html+='<li><span class="historyConTitle"></span> '+'<strong class="historyAction"></strong><span class="newName">'+(text[prop]?text[prop]?text[prop]:'':'')+'</span></li>';}else{if(prop!='forward'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(text[prop].old?text[prop].old:'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(text[prop].new?text[prop].new:'')+'</span></li>';}else{html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(text[prop].old?text[prop].old:'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(text[prop].new?text[prop].new:'')+'</span></li>';}}}
html+='</ul>';return html;}else{var textList=text.split('was renamed');if(textList.length!=2){switch(text){case'edit':return I18n.resource.workflow.notice.TASK_EDIT;case'complete':return I18n.resource.workflow.notice.TASK_FINISH;case'restart':return I18n.resource.workflow.notice.TASK_RESTART;case'start':return I18n.resource.workflow.notice.TASK_START;case'pause':return I18n.resource.workflow.notice.TASK_PAUSE;case'reply':return I18n.resource.workflow.notice.TASK_REPLY+':';case'new':return I18n.resource.workflow.notice.TASK_CREATE;case'verified':return I18n.resource.workflow.notice.TASK_VERIFIED;case'not_pass':return I18n.resource.workflow.notice.TASK_VERIFIED_FAILED;case'delete':return I18n.resource.workflow.notice.TASK_DELETE;case'forward':return I18n.resource.workflow.notice.TASK_FORWARD;case'close':return I18n.resource.workflow.notice.TASK_CLOSED;case'delete_reply':return I18n.resource.workflow.notice.DELETE_REPLY+':';default:return text;}}else{return'<p>'+'title'+':'+textList[0]+' <strong>'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong>'+textList[1]+'</p>';}}}
function recordTranslate(text){switch(text){case'complete':return I18n.resource.workflow.record.FINISH;case'start':return I18n.resource.workflow.record.START;case'new':return I18n.resource.workflow.record.CREATE;case'verified':return I18n.resource.workflow.record.VERIFIED;default:return text;}}
function updateBadge(count,list){var $badge=$('#paneWorkflow').find('li[screen="mine"]').find('.badge');if(!count){$badge.text('').data('new-tasks','');}else{$badge.text(count).data('new-tasks',list);}}
function updateNewTaskCount(){if(!AppConfig['userId']){return;}
WebAPI.get('/workflow/new_task_count/'+AppConfig['userId']).done(function(r_obj){if(!r_obj.length)return false;var storageNewTask=localStorage.getItem('new_task_'+AppConfig['userId']);if(!storageNewTask){updateBadge(r_obj.length,r_obj);}else{try{storageNewTask=JSON.parse(storageNewTask);}catch(e){return false;}
var unreadList=[];for(var n=0,len=r_obj.length;n<len;n++){if($.inArray(r_obj[n],storageNewTask)===-1){unreadList.push(r_obj[n]);}}
updateBadge(unreadList.length,unreadList);localStorage.setItem('new_task_temp_'+AppConfig['userId'],result);}});}
function getTemplate(template,selector){templateStorage=templateStorage||{};var promise;if(templateStorage[template]){promise=templateStorage[template];}else{promise=templateStorage[template]=WebAPI.get(template);}
var dfd=$.Deferred();promise.done(function(result){var $result=$(result),$template=$result.find(selector).children();var $return=$template.clone();I18n.fillArea($return);dfd.resolve($return);});return dfd;}
function getWorkflowTemplate(selector){return getTemplate('/static/views/workflow/template.html',selector);}
function inherits(clazz,base){var clazzPrototype=clazz.prototype;function F(){}
F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;}
function getUserName(rawUserName){if(rawUserName.indexOf('@')>0){return rawUserName.substring(0,rawUserName.indexOf('@'));}
return rawUserName;}
function delArrInvalidValue(arr){for(var i=0;i<arr.length;i++){if(arr[i]==''||arr[i]==null){arr.splice(i,1);i=i-1;}}
return arr;}
function screeningItem($obj,str,num){if($obj.hasClass("selectAll")){$(".task-item").show();return;}
var text=$obj.text();if(!num){$.each($(".task-item ."+str),function(index,item){var $item=$(item);var itemStatus=$item.text();if(text!==itemStatus){$item.closest(".task-item").hide();}else{$item.closest(".task-item").show();}});}else{var urgencyClass=$obj.attr("urgencyClass");$(".task-item").hide();$(".task-item ."+urgencyClass).closest(".task-item").show();}}
return{pic_path:pic_path,getStatusText:getStatusText,updateBadge:updateBadge,updateNewTaskCount:updateNewTaskCount,getWorkflowTemplate:getWorkflowTemplate,inherits:inherits,getUserName:getUserName,translate:translate,recordTranslate:recordTranslate,delArrInvalidValue:delArrInvalidValue,screeningItem:screeningItem};}();(function(beop){var isSmallScreen=Math.max(document.documentElement.clientHeight,window.innerHeight||0)<=768;var configMap={date_format_full:'yyyy-MM-dd HH:mm:ss',date_format_YMD:'yyyy-MM-dd',activities_number:10,task_page_size:isSmallScreen?14:19,activities_store_key:'activities',activities_type:{today:'1',yesterday:'0',thisWeek:'2',thisMonth:'3',latestCompleted:'4',latestCreated:'5'},activities_op_type:{'new':'new','complete':'complete'}},stateMap={trans_cid_map:{},activity_cid_map:{},record_detail:{},group_list:[],tag_list:[],totalCount:null,activities:[],filter:{type:null,param:null},isShowTaskFilter:false,task_page_size:isSmallScreen?14:19},isFake,emit,init;isFake=false;emit=isFake?beop.fake.emit:beop.data.emit;var noop=function noop(){};var activitiesModel,transactionsModel,menuModel,replyModel,groupModel,tagsModel,attachmentModel;var getActivities,getNextPageActivities,startTime,getActivitiesFilter,storedActivities,editGroup;activitiesModel=function(){getActivities=function getActivities(type,page){Spinner.spin($('#wf-level-menu').get(0));beop.view.activities.configModel({activities_number:configMap.activities_number});return emit(beop.apiMap.listGroupActivities,{userId:stateMap.userId,activity_time_type:type,page:page?page:1,limit:configMap.activities_number},{lastActivityID:stateMap.lastActivityID}).done(function(result){if(result.success){try{window.localStorage.removeItem("beopcache/activities");}catch(ex){}
storedActivities=result.data;if(!storedActivities.activities||!storedActivities.activities.length){stateMap.activities=[];}else{stateMap.activities=storedActivities.activities;}
stateMap.totalCount=storedActivities.totalCount;stateMap.activity_type=type;stateMap.backup_activity_type=storedActivities.backup_activity_type;stateMap.lastActivityID=stateMap.activities.length>=1?stateMap.activities[stateMap.activities.length-1].id:null;}}).always(function(){Spinner.stop();});};getActivitiesFilter=function getActivitiesFilter(type){var now=moment(new Date()),yesterday=now.clone().subtract(1,'days');var isLatestReply=function isLatestReply(activity,checkFunc){if(!activity.reply||!activity.reply.length){return false;}
var latestReply=activity.reply[0];return checkFunc(latestReply.replyTime);};var checkFunc=noop;switch(type){case configMap.activities_type.today:{checkFunc=function checkFunc(datetime){return now.isSame(new Date(datetime),'days');};return function(item){return item&&(checkFunc(item.opTime)||isLatestReply(item,checkFunc));};}
case configMap.activities_type.yesterday:{checkFunc=function checkFunc(datetime){return yesterday.isSame(new Date(datetime),'days');};return function(item){return item&&(checkFunc(item.opTime)||isLatestReply(item,checkFunc));};}
case configMap.activities_type.thisWeek:{checkFunc=function checkFunc(datetime){return moment(new Date(datetime)).isBetween(now.clone().startOf('weeks'),now.clone().endOf('weeks'));};return function(item){return item&&(checkFunc(item.opTime)||isLatestReply(item,checkFunc));};}
case configMap.activities_type.thisMonth:{checkFunc=function checkFunc(datetime){return moment(new Date(datetime)).isBetween(now.clone().startOf('months'),now.clone().endOf('months'));};return function(item){return item&&(checkFunc(item.opTime)||isLatestReply(item,checkFunc));};}
case configMap.activities_type.latestCompleted:{var count=configMap.activities_number;return function(item){return--count>0&&item.op===configMap.activities_op_type.complete;};}
case configMap.activities_type.latestCreated:{var count=configMap.activities_number;return function(item){return--count>0&&item.op===configMap.activities_op_type.new;};}
default:{return function(){return true;};}}};getNextPageActivities=function getNextPageActivities(){return emit(beop.apiMap.listActivities,{userId:stateMap.userId,rownumber:stateMap.rownumber+1}).done(function(result){if(result.success){stateMap.activities=result.data;stateMap.rownumber=++stateMap.rownumber;}});};return{getActivities:getActivities,getNextPageActivities:getNextPageActivities};}();var trans_id,getTrans,delTrans,addTrans,searchTrans,listTransWorking,listTransCreatedBy,listTransFinishedBy,listTransJoinedBy,listGroupTrans,updateTrans,addReply,faultCurve,faultCurveByParam,getReply,getProgress,completeTrans,verifyPass,verifyNotPass,toggleStarred,collectionTrans,listTransStarBy,listNewCreated,listStartedTrans,listWaitVerify,startTransaction,updateExecutor,closeTask,getCompleteVerifiedTask,getStopVerifiedTask,getListTodayTasks,updateTransactionStatus,userListByGroup,waitMeToVerifier;transactionsModel=function(){getTrans=function getTrans(trans_id){return emit(beop.apiMap.getTransaction,{trans_id:trans_id},{user_id:stateMap.userId}).done(function(result){stateMap.cur_trans=result.data;stateMap.trans_cid_map[trans_id]=result.data;});};delTrans=function delTrans(trans_id){if(!trans_id){trans_id=stateMap.cur_trans.id;}
return emit(beop.apiMap.delTransaction,{trans_id:trans_id},{user_id:stateMap.userId}).done(function(result){stateMap.cur_trans=null;if(stateMap.trans_cid_map[trans_id]){delete stateMap.trans_cid_map[trans_id];}});};listTransWorking=function listTransWorking(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionWorking,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listTransStarBy=function listTransStarBy(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionStar,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listTransCreatedBy=function listTransCreatedBy(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionCreatedBy,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listTransFinishedBy=function listTransFinishedBy(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionFinishedBy,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};getCompleteVerifiedTask=function getCompleteVerifiedTask(user_id,currentPage,orderObject){return emit(beop.apiMap.getCompleteVerifiedTask,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};getStopVerifiedTask=function getStopVerifiedTask(user_id,currentPage,orderObject){return emit(beop.apiMap.getStopVerifiedTask,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listTransJoinedBy=function listTransJoinedBy(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionJoinedBy,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};searchTrans=function searchTrans(user_id,text,currentPage,orderObject){var param={};for(var key in orderObject){param[key]=orderObject[key];}
param['text']=text;param['userId']=user_id?user_id:stateMap.userId;return emit(beop.apiMap.searchTasks,{page_num:currentPage||1,page_size:configMap.task_page_size},param).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listGroupTrans=function listGroupTrans(currentPage,orderObject){return emit(beop.apiMap.transInGroups,{group_id:stateMap.currentGroupId,user_id:AppConfig.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){stateMap.trans_list=result.data;});};addTrans=function addTrans(trans){trans.userId=stateMap.userId;return emit(beop.apiMap.addTransaction,trans);};updateTrans=function updateTrans(trans){trans.userId=stateMap.userId;trans.transId=stateMap.cur_trans.id;return emit(beop.apiMap.updateTransaction,trans);};completeTrans=function completeTrans(trans){if(!trans){trans={};}
trans.userId=stateMap.userId;trans.transId=stateMap.cur_trans.id;return emit(beop.apiMap.completeTransaction,trans);};verifyPass=function verifyPass(trans){if(!trans){trans={};}
trans.userId=stateMap.userId;trans.transId=stateMap.cur_trans.id;return emit(beop.apiMap.verifyPass,trans);};verifyNotPass=function verifyNotPass(trans){if(!trans){trans={};}
trans.userId=stateMap.userId;trans.transId=stateMap.cur_trans.id;return emit(beop.apiMap.verifyNotPass,trans);};addReply=function addReply(){};faultCurve=function faultCurve(trans_id){if(!trans_id){trans_id=stateMap.cur_trans.id;}
return emit(beop.apiMap.faultCurve,{trans_id:trans_id}).done(function(result){stateMap.cur_fault_curve=result.data;});};faultCurveByParam=function faultCurveByParam(params){return emit(beop.apiMap.faultCurveByParam,{projectId:params.projectId,chartPointList:params.chartPointList,chartQueryCircle:params.chartQueryCircle,chartStartTime:params.chartStartTime,chartEndTime:params.chartEndTime}).done(function(result){stateMap.cur_fault_curve=result.data;});};getReply=function getReply(trans_id){if(!trans_id){trans_id=stateMap.cur_trans.id;}
return emit(beop.apiMap.getReply,{trans_id:trans_id}).done(function(result){stateMap.replyList=result.data;});};getProgress=function getProgress(trans_id){if(!trans_id){trans_id=stateMap.cur_trans.id;}
return emit(beop.apiMap.getProgress,{trans_id:trans_id}).done(function(result){stateMap.progress=result.data;});};toggleStarred=function toggleStarred(trans_id,user_id){if(!trans_id){trans_id=stateMap.cur_trans.id;}
return emit(beop.apiMap.toggleStarred,{trans_id:trans_id,user_id:user_id}).done(function(result){});};listNewCreated=function listNewCreated(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionNewCreated,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listStartedTrans=function listStartedTrans(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionStarted,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listWaitVerify=function listWaitVerify(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionWaitVerify,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};startTransaction=function startTransaction(user_id,trans_id){return emit(beop.apiMap.startTransaction,{user_id:user_id,trans_id:trans_id}).done(function(){});};updateExecutor=function updateExecutor(user_id,trans_id,userObject){return emit(beop.apiMap.updateExecutor,{user_id:user_id,trans_id:trans_id},userObject).done(function(){});};closeTask=function closeTask(user_id,trans_id){return emit(beop.apiMap.closeTask,{user_id:user_id,trans_id:trans_id}).done(function(){});};getListTodayTasks=function getListTodayTasks(userId){return emit(beop.apiMap.getListTodayTasks,{userId:userId}).done(function(){});};updateTransactionStatus=function updateTransactionStatus(param){return emit(beop.apiMap.updateTransactionStatus,{transId:param.transId,userId:param.userId}).done(function(){});};waitMeToVerifier=function waitMeToVerifier(user_id,currentPage,orderObject){return emit(beop.apiMap.waitMeToVerifier,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};return{getTrans:getTrans,delTrans:delTrans,addTrans:addTrans,completeTrans:completeTrans,verifyPass:verifyPass,verifyNotPass:verifyNotPass,updateTrans:updateTrans,addReply:addReply,getReply:getReply,getProgress:getProgress,faultCurve:faultCurve,faultCurveByParam:faultCurveByParam,listTransWorking:listTransWorking,listTransCreatedBy:listTransCreatedBy,listTransFinishedBy:listTransFinishedBy,listTransJoinedBy:listTransJoinedBy,listTransStarBy:listTransStarBy,listGroupTrans:listGroupTrans,searchTrans:searchTrans,toggleStarred:toggleStarred,listNewCreated:listNewCreated,listWaitVerify:listWaitVerify,listStartedTrans:listStartedTrans,startTransaction:startTransaction,updateExecutor:updateExecutor,closeTask:closeTask,getCompleteVerifiedTask:getCompleteVerifiedTask,getStopVerifiedTask:getStopVerifiedTask,getListTodayTasks:getListTodayTasks,updateTransactionStatus:updateTransactionStatus,waitMeToVerifier:waitMeToVerifier};}();var getMenu,getSecondMenu;menuModel=function(){getMenu=function getMenu(){return emit(beop.apiMap.listMenu,{userId:stateMap.userId}).done(function(result){});};getSecondMenu=function getSecondMenu(firstMenu){return emit(beop.apiMap.listSecondMenu,{userId:stateMap.userId,firstMenu:firstMenu}).done(function(result){});};return{getMenu:getMenu,getSecondMenu:getSecondMenu};}();var insertReply,deleteReply;replyModel=function(){insertReply=function insertReply(param){param['userId']=stateMap.userId;if(!param['ofTransactionId']){param['ofTransactionId']=stateMap.cur_trans.id;}
return emit(beop.apiMap.insertReply,param);};deleteReply=function deleteReply(user_id,param){return emit(beop.apiMap.deleteReply,{'user_id':user_id},param);};return{insertReply:insertReply,deleteReply:deleteReply};}();var getUserGroups,userDialogList,addGroup,deleteGroup,getGroupData;groupModel=function(){getUserGroups=function getUserGroups(){return emit(beop.apiMap.userGroups,{'user_id':stateMap.userId}).done(function(result){if(result.success){stateMap.group_list=[];for(var prop in result.data){if(result.data.hasOwnProperty(prop)){stateMap.group_list=stateMap.group_list.concat(result.data[prop]);}}}});};userDialogList=function userDialogList(){return emit(beop.apiMap.userDialogList,{'user_id':stateMap.userId});};addGroup=function addGroup(param){return emit(beop.apiMap.addGroup,{'user_id':stateMap.userId},param);};deleteGroup=function deleteGroup(param){return emit(beop.apiMap.deleteGroup,{group_id:param,user_id:stateMap.userId});};getGroupData=function getGroupData(param){return emit(beop.apiMap.getGroupData,{group_id:param,user_id:stateMap.userId});};editGroup=function editGroup(group_id,param){return emit(beop.apiMap.editGroup,{group_id:group_id,user_id:stateMap.userId},param);};userListByGroup=function userListByGroup(user_id,group_id){return emit(beop.apiMap.userListByGroup,{user_id:user_id?user_id:stateMap.userId,group_id:group_id}).done(function(result){});};return{getUserGroups:getUserGroups,userDialogList:userDialogList,addGroup:addGroup,deleteGroup:deleteGroup,getGroupData:getGroupData,editGroup:editGroup,userListByGroup:userListByGroup};}();var getUserTags,addTag,deleteTag,editTag,addTransTag,transTag,transTagDelete,tagTrans;tagsModel=function(){getUserTags=function getUserTags(){return emit(beop.apiMap.getUserTags,{'user_id':stateMap.userId}).done(function(result){if(result.success){stateMap.tag_list=result.data;}});};addTag=function addTag(param,tagInfo){return emit(beop.apiMap.addTag,param,tagInfo).done(function(result){if(result.success){stateMap.tag_list=result.data;}});};deleteTag=function deleteTag(param){return emit(beop.apiMap.deleteTag,param).done(function(result){if(result.success){stateMap.tag_list=result.data;}});};editTag=function editTag(param,tagInfo){return emit(beop.apiMap.editTag,param,tagInfo);};addTransTag=function addTransTag(param){return emit(beop.apiMap.addTransTag,param);};transTagDelete=function transTagDelete(param){return emit(beop.apiMap.transTagDelete,param).done(function(result){if(result.success){}});};transTag=function transTag(user_id,tag_id,currentPage,orderObject){return emit(beop.apiMap.transTag,{user_id:user_id?user_id:stateMap.userId,tag_id:tag_id,page_num:currentPage||1,page_size:configMap.task_page_size},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};tagTrans=function tagTrans(param){return emit(beop.apiMap.tagTrans,param).done(function(result){if(result.success){}});};return{getUserTags:getUserTags,addTag:addTag,deleteTag:deleteTag,editTag:editTag,addTransTag:addTransTag,transTagDelete:transTagDelete,transTag:transTag,tagTrans:tagTrans};}();var getAttachment;attachmentModel=function(){getAttachment=function getAttachment(transId){return emit(beop.apiMap.getAttachmentByTransId,{trans_id:transId}).done(function(result){if(result.success){}});};return{getAttachment:getAttachment};}();init=function init(){stateMap.userId=AppConfig.userId;stateMap.userProfile=AppConfig.userProfile;};beop.model={init:init,activitiesModel:activitiesModel,transactionsModel:transactionsModel,menuModel:menuModel,replyModel:replyModel,stateMap:stateMap,groupModel:groupModel,tagsModel:tagsModel,attachmentModel:attachmentModel,taskPageSize:configMap.task_page_size};})(beop||(beop={}));(function(){var configMap={htmlURL:'',settable_map:{menu_model:true},highlightClass:'active',menu_model:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init,showDefaultLevelMenu,showLevelMenu,gotoTaskGroup,onMenuItemClick,onLoadTaskList,attachEvent,onExtraProgressClick;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_menu:$container.find('#wf-menu'),$wf_main_menu:$container.find('#wf-main-ul'),$wf_level_menu:$container.find('#wf-level-menu'),$wf_content:$container.find('#wf-content'),$wf_content_box:$container.find('#wf-content-box'),$wf_task_groups:$container.find('#wf-task-group'),$wf_label_ul:$container.find('#wf-label-ul'),$wf_del_win:$("#wf-del-win"),$wf_label_toggle:$container.find("#wf-label-toggle"),$wf_label_edit:$container.find("#wf-label-edit"),$wf_level_search:$container.find("#wf-level-search"),$wf_label_plus:$container.find("#wf-label-plus"),$wf_label_name:$container.find(".wf-label-name"),$wfPromptWin:$container.find("#wfPromptWin"),$wfInfoConfirm:$container.find("#wfInfoConfirm")};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){stateMap.$container=$container;setJqueryMap();attachEvent();jqueryMap.$wf_menu.eventOn('click','[data-topic-not-hash]',function(){var topic=$(this).attr('data-topic-not-hash'),param=$(this).attr('data-param').split(';');onMenuItemClick(topic,param);},true);jqueryMap.$wfPromptWin.off().on('click',gotoTaskGroup);};attachEvent=function attachEvent(){jqueryMap.$wf_level_search.keyup(function(e){if(e.keyCode==13){beop.view.taskList.configModel({enableBack:false});beop.view.taskList.init(jqueryMap.$wf_content).done(function(){if(jqueryMap.$wf_level_search.val()==""){$.spEvent.pubEvent('wf-task-list','workingTask');}else{$.spEvent.pubEvent('wf-task-list','search');}});}});};showDefaultLevelMenu=function showDefaultLevelMenu(firstMenuSelector,levelMenuSelector){var highlight=configMap.highlightClass;jqueryMap.$wf_main_menu.children().removeClass(highlight).end().children(firstMenuSelector+'-hash').addClass(highlight);jqueryMap.$wf_level_menu.children().removeClass(highlight).filter(levelMenuSelector).addClass(highlight);jqueryMap.$wf_level_menu.find('li').removeClass(highlight);var $levelMenuDefaultItem=jqueryMap.$wf_level_menu.children(levelMenuSelector).find('[data-type=default]');if($levelMenuDefaultItem.length){$levelMenuDefaultItem.addClass(highlight);}
if(levelMenuSelector==''){jqueryMap.$wf_content.css({'left':100+'px','width':'calc(100% - 80px)','padding':0});}else{if(levelMenuSelector=='#levelMeunCalendar'){jqueryMap.$wf_content.css({'left':341+'px','width':'calc(100% - 345px)','padding':'5px 10px'});}else{jqueryMap.$wf_content.css({'left':280+'px','width':'calc(100% - 340px)','padding':'20px'});}}};showLevelMenu=function showLevelMenu($menuItem){if(!$menuItem.hasClass('main-menu')||$menuItem.attr('data-param')=='workingTask'){jqueryMap.$wf_level_menu.find('.'+configMap.highlightClass+':not(section)').removeClass(configMap.highlightClass);}
if($menuItem.attr('id')=='wf-main-task'){jqueryMap.$container.find('#wf-task-type').find("li[data-param='workingTask']").addClass(configMap.highlightClass);}
$menuItem.addClass(configMap.highlightClass);var hash,id;if(location.hash.indexOf('taskGroup')!==-1){hash=location.hash.substr(1).split('&');id=hash[hash.length-1].split('=')[1];$('.wf-task-groups').find('li').removeClass('active').end().find('li[data-group-id="'+id+'"]').addClass('active');}
if(location.hash.indexOf('myTags')!==-1&&location.hash.indexOf('transaction')!==-1){hash=location.hash.substr(1).split('&');id=hash[hash.length-1].split('=')[1];$('#wf-label-toggle').removeClass('wf-tags-ul-hide').addClass('wf-tags-ul-show');$('#wf-label-form').show().find('li').removeClass('active').end().find('li[labelid="'+id+'"]').addClass('active');}};onMenuItemClick=function onMenuItemClick(topic,param){var $this=$(this),$level_menu=$("#wf-level-menu");var navigationI18n={'wf-group-add':I18n.resource.workflow.navigation.WF_GROUP_ADD,'wf-group-edit':I18n.resource.workflow.navigation.WF_GROUP_EDIT,'wf-group-see':I18n.resource.workflow.navigation.WF_GROUP_SEE,'wf-task-add':I18n.resource.workflow.navigation.WF_TASK_ADD};if(beop.model.stateMap.UEInstance){beop.model.stateMap.UEInstance.destroy();beop.model.stateMap.UEInstance=null;}
var initPromise;switch(topic){case'wf-group-add':{beop.view.groupAdd.configModel({navigation:navigationI18n[topic]});jqueryMap.$wf_content.attr("data-group-no","");showDefaultLevelMenu('#wf-main-task','#level-menu-task');initPromise=beop.view.groupAdd.init(jqueryMap.$wf_content);break;}
case'wf-group-edit':{jqueryMap.$wf_content.attr("data-group-no",param[1]);beop.view.groupEdit.configModel({data:{param:param[1],type:'taskGroup'},enableEdit:true,navigation:navigationI18n[topic]});initPromise=beop.view.groupEdit.init(jqueryMap.$wf_content);break;}
case'wf-group-see':{jqueryMap.$wf_content.attr("data-group-no","");beop.view.groupEdit.configModel({data:{param:param[1],type:'taskGroup'},navigation:navigationI18n[topic],enableEdit:false});initPromise=beop.view.groupEdit.init(jqueryMap.$wf_content);break;}
case'wf-group-delete':{jqueryMap.$wf_del_win.attr("data-param",param[0]);jqueryMap.$wf_del_win.attr("data-type","taskGroup");initPromise=beop.view.groupDelete.init(jqueryMap.$wf_content);break;}
case'wf-group-show':{initPromise=beop.view.groupShow.init(jqueryMap.$wf_content);break;}
case'wf-task-list':case'taskGroup':case'transaction':{topic='wf-task-list';$level_menu.show();beop.view.taskList.configModel({enableBack:false});initPromise=beop.view.taskList.init(jqueryMap.$wf_content);beop.view.menu_group_list.configModel({whereComeFrom:'default'});beop.view.menu_tag_list.configModel({whereComeFrom:'default'});showDefaultLevelMenu('#wf-main-task','#level-menu-task');if($this.attr('id')==='wf-main-task'){beop.view.menu_group_list.init(jqueryMap.$wf_task_groups);beop.view.menu_tag_list.init(jqueryMap.$wf_label_ul);}
if($this.hasClass('group-name')){beop.model.stateMap.currentGroupId=param[1];}
break;}
case'wf-firstMenu-change':{$level_menu.show();showDefaultLevelMenu('#wf-main-calender','#levelMeunCalendar');Spinner.spin(stateMap.$container.get(0));new WorkflowCalendar().show('#wf-content','#calendar-time').Done(function(){Spinner.stop();});beop.view.menu_group_list.configModel({whereComeFrom:'calendar'});beop.view.menu_group_list.init(jqueryMap.$wf_level_menu.find('#levelMeunCalendar'));break;}
case'wf-task-add':{jqueryMap.$wf_content.attr("data-group-no","");if(!beop.model.stateMap.group_list.length){initPromise=$.Deferred();var getUserGroups=function getUserGroups(){return WebAPI.get('/workflow/users/group/'+AppConfig.userId);};getUserGroups().done(function(result){if(!result.data.created.length&&!result.data.joined.length){jqueryMap.$wfPromptWin.find(".infoPrompt").text(I18n.resource.workflow.task.NO_GROUP_PROMPT);jqueryMap.$wfPromptWin.modal();showDefaultLevelMenu('#wf-main-task','#level-menu-task');return false;}else{beop.view.taskDetail.configModel({navigation:navigationI18n[topic],isAddNewTaskForVerifiersSelected:true});beop.view.taskDetail.init(jqueryMap.$wf_content,'new').done(function(){initPromise.resolve();});}});}else{beop.view.taskDetail.configModel({navigation:navigationI18n[topic],isAddNewTaskForVerifiersSelected:true});initPromise=beop.view.taskDetail.init(jqueryMap.$wf_content,'new');}
showDefaultLevelMenu('#wf-main-task','#level-menu-task');break;}
case'wf-activities-change':{$level_menu.show();beop.model.stateMap.lastActivityID=null;initPromise=beop.view.activities.init(jqueryMap.$wf_content,true);showDefaultLevelMenu('#wf-main-activity','#level-menu-activity');beop.view.taskList.configModel({spEventActivities:{param:param,topic:topic}});break;}
case"taskProject":{topic="wf-task-list";beop.view.menu_group_list.configModel({whereComeFrom:'default'});beop.view.taskList.configModel({enableBack:false});beop.view.menu_tag_list.configModel({whereComeFrom:'default'});showDefaultLevelMenu('#wf-main-project','#level-menu-task');$('#wf-level-menu').show();var $levelMenuTask=$('#level-menu-task');$levelMenuTask.addClass('task-project');$levelMenuTask.find('.wf-task-group-container').show();beop.view.menu_group_list.init($('#wf-outline'),'taskProject');initPromise=beop.view.taskList.init(jqueryMap.$wf_content);}
break;case'wf-task-list-calendar':{initPromise=$.Deferred().resolve();break;}
case'wf-team-show':{$level_menu.hide();showDefaultLevelMenu('#wf-main-team','');initPromise=beop.view.team.init(jqueryMap.$wf_content);break;}}
showLevelMenu($this);initPromise&&initPromise.done(function(){$.spEvent.pubEvent(topic,param);});};gotoTaskGroup=function gotoTaskGroup(){var $this=$(this),paramData=$this.data('param');var topic=$this.data('topic'),param=null;if(paramData){if(typeof paramData==='string'){param=paramData.split(';');}else{param=paramData;}}
var navigationI18n={'wf-group-add':I18n.resource.workflow.navigation.WF_GROUP_ADD};var initPromise;beop.view.groupAdd.configModel({navigation:navigationI18n[topic]});jqueryMap.$wf_content.attr("data-group-no","");initPromise=beop.view.groupAdd.init(jqueryMap.$wf_content);showLevelMenu($this);initPromise&&initPromise.done(function(){$.spEvent.pubEvent("wf-group-add",param);});jqueryMap.$wfPromptWin.modal("hide");};onExtraProgressClick=function onExtraProgressClick(ev){ev.stopPropagation();ev.preventDefault();};onLoadTaskList=function onLoadTaskList(event,type){beop.view.taskList.init(jqueryMap.$wf_content,type);};beop.view=beop.view||{};beop.view.menu={configModel:configModel,init:init,onMenuItemClick:onMenuItemClick,showDefaultLevelMenu:showDefaultLevelMenu};})(beop||(beop={}));var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(beop){var configMap={htmlURL:'/static/views/workflow/memberSelected.html',htmlTemplateId:'#wf-memberSelected-container',settable_map:{cb_dialog_hide:true,cb_dialog_show:true,userHasSelected:true,userMemberMap:true,maxSelected:true,enableDeleteMember:true,enableAddMember:true,maxDelete:true,hasFrame:false,userReadOnly:false},cb_dialog_hide:$.noop,cb_dialog_show:$.noop,userMemberMap:null,userHasSelected:[],maxSelected:null,enableDeleteMember:true,enableAddMember:true,KEY_PY_STORY:'BEOP.WF.PY',maxDelete:null,userReadOnly:false,hasFrame:false},stateMap={usersMap:[],addedUserList:[],userHasSelected:[],userHasSelectedDefault:[],allUserList:[],PYMap:[],selectedClassPrefix:'wf-member-selected',memberSelectedDiff:[],isConfirm:false,userReadOnly:false,hasFrame:false},jqueryMap={},setJqueryMap,configModel,init;var progressResultData,bindEvents,renderCheckedUsers,isPYStored;var filterCheckedUser,searchByFirstName,getPYLocalStorage,getZH_EN,addActiveSearchBtn,setPYMap,searchByInput,showSearchByID,resetData,renderAddedUsers,onClickUser,onClickRemoveUser,removeMember,addMember,isMemberAdded,checkUserSelectedAmount,checkUserDeletedAmount,restoreSearchResult;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$add_user_dialog:$container.find('#wf-add-person'),$wf_check_result:$container.find('.wf-check-result')};jqueryMap.$wf_search_by_firstName_li=jqueryMap.$add_user_dialog.find('.wf-search-result-title ul li');jqueryMap.$wf_search_byInput=jqueryMap.$add_user_dialog.find('#input-search-name');jqueryMap.$wf_search_result=jqueryMap.$add_user_dialog.find('.wf-search-result');jqueryMap.$wf_search_result_list=jqueryMap.$add_user_dialog.find('.wf-member');jqueryMap.$wf_added_user_list=jqueryMap.$add_user_dialog.find('.wf-added-user-list');jqueryMap.$wf_seaych_byInput=jqueryMap.$add_user_dialog.find('#input-search-name');jqueryMap.$wf_close_btn1=jqueryMap.$add_user_dialog.find('.modal-header button');jqueryMap.$wf_search_result_list.removeClass(stateMap.selectedClassPrefix);jqueryMap.$wf_check_result.empty();jqueryMap.$wf_search_byInput.val('');};configModel=function configModel(input_map){beop.util&&beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container,options){if(arguments.length>2){console.warn('人物选择框现在需要1个必选参数$container和一个可选参数来配置configModel');return false;}
if((typeof options==='undefined'?'undefined':_typeof(options))==='object'){var configModel=options.configModel;if((typeof configModel==='undefined'?'undefined':_typeof(configModel))==='object'){for(var key in configModel){if(configModel.hasOwnProperty(key)){configMap[key]=configModel[key];}}
if(!configMap.userHasSelected)configMap.userHasSelected=[];if(!configModel.userMemberMap)configModel.userMemberMap=[];configMap.userHasSelected.forEach(function(item,index,array){configModel.userMemberMap.forEach(function(members){if(item.id==members.id){array[index]=$.extend(true,{},members);return true;}});});}else{console.error('调用方式失败,第二个参数的configModel属性不是Object'+arguments[1]);return false;}}
stateMap.userHasSelected=configMap.userHasSelected?configMap.userHasSelected:[];if(!configMap.userMemberMap||Object.prototype.toString.call(configMap.userMemberMap)!=="[object Array]"){console.error('现在人物选择框需要提前预制人员列表');return false;}
Spinner.spin($container.get(0));stateMap.$container=$container;WebAPI.get(configMap.htmlURL+'?='+new Date().getTime().toString(16)).done(function(html){stateMap.$container.append(html);resetData();setJqueryMap();var $title=jqueryMap.$container.find('#wf-add-person .modal-title');if(options&&options.configModel){options.configModel.hasFrame?stateMap.hasFrame=true:stateMap.hasFrame=false;if(options.configModel.userReadOnly){stateMap.userReadOnly=true;$title.attr('i18n','workflow.memberSelected.TITLE1');}}else{stateMap.hasFrame=false;stateMap.userReadOnly=false;$title.attr('i18n','workflow.memberSelected.TITLE');}
progressResultData();}).always(function(){Spinner.stop();}).fail(function(){infoBox.alert('获取人物选择框模板失败！');});};bindEvents=function bindEvents(){jqueryMap.$wf_search_result.off().on('click','.wf-member',onClickUser);jqueryMap.$wf_check_result.off().on('click','.glyphicon-remove',onClickRemoveUser);jqueryMap.$wf_search_by_firstName_li.off().on('click',searchByFirstName);jqueryMap.$wf_seaych_byInput.off().on('keyup',searchByInput);jqueryMap.$wf_comfirm_btn=jqueryMap.$add_user_dialog.find('#wf-member-comfirm-btn');jqueryMap.$wf_comfirm_btn.off().on('click',renderAddedUsers);jqueryMap.$add_user_dialog.off().on('show.bs.modal',function(){restoreSearchResult();stateMap.isConfirm=false;}).on('hidden.bs.modal',function(){if(stateMap.hasFrame){jqueryMap.$wf_check_result.empty().html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.userHasSelectedDefault},window.frames[0].document.getElementById("tpl_wf_dialog_added_member").innerHTML));}else{jqueryMap.$wf_check_result.empty().html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.userHasSelectedDefault}));}
jqueryMap.$wf_search_result_list.removeClass(stateMap.selectedClassPrefix);jqueryMap.$wf_search_result_list.each(function(){var $this=$(this);stateMap.userHasSelectedDefault.forEach(function(item){if(item.id==$this.data('user-id')){$this.addClass(stateMap.selectedClassPrefix);}});});[].slice.call(document.querySelectorAll(configMap.htmlTemplateId)).forEach(function(item){item.parentNode.removeChild(item);});});};renderAddedUsers=function renderAddedUsers(){if(stateMap.hasFrame){jqueryMap.$wf_added_user_list.html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.userHasSelectedDefault},window.frames[0].document.getElementById("tpl_wf_dialog_added_member").innerHTML));}else{jqueryMap.$wf_added_user_list.html(beopTmpl('tpl_wf_added_member',{members:stateMap.addedUserList}));}
stateMap.userHasSelectedDefault=[];stateMap.addedUserList.forEach(function(item){stateMap.userHasSelectedDefault.push(item);});configMap.cb_dialog_hide(stateMap.addedUserList);jqueryMap.$add_user_dialog.modal('hide');};renderCheckedUsers=function renderCheckedUsers(data){if(!data){data=stateMap.addedUserList;}
if(stateMap.hasFrame){jqueryMap.$wf_check_result.html(beopTmpl('tpl_wf_dialog_added_member',{members:data},window.frames[0].document.getElementById("tpl_wf_dialog_added_member").innerHTML));}else{jqueryMap.$wf_check_result.html(beopTmpl('tpl_wf_dialog_added_member',{members:data}));}};progressResultData=function progressResultData(){var addedUserMap={};stateMap.addedUserList=[];stateMap.userHasSelectedDefault=[];stateMap.userHasSelected.forEach(function(item){stateMap.addedUserList.push(item);stateMap.userHasSelectedDefault.push(item);addedUserMap[''+item.id]=item;});stateMap.allUserList=[];configMap.userMemberMap.forEach(function(item){stateMap.allUserList.push(item);});if(stateMap.hasFrame){jqueryMap.$wf_search_result.html(beopTmpl('tpl_wf_member',{members:stateMap.allUserList,addUserMap:addedUserMap},window.frames[0].document.getElementById("tpl_wf_member").innerHTML));}else{jqueryMap.$wf_search_result.html(beopTmpl('tpl_wf_member',{members:stateMap.allUserList,addUserMap:addedUserMap}));}
stateMap.allUserList.forEach(function(item){stateMap.usersMap[''+item.id]=item;});I18n.fillArea(stateMap.$container);setPYMap();jqueryMap.$wf_search_result_list=jqueryMap.$add_user_dialog.find('.wf-member');bindEvents();renderCheckedUsers(stateMap.userHasSelectedDefault);restoreSearchResult();Spinner.stop();jqueryMap.$add_user_dialog.modal('show');};restoreSearchResult=function restoreSearchResult(){stateMap.addedUserList=[];stateMap.userHasSelectedDefault.forEach(function(item){stateMap.addedUserList.push(item);});jqueryMap.$wf_search_result_list.show();addActiveSearchBtn(null,2);};setPYMap=function setPYMap(){var PYFormat=new pyFormat(),itemPY={};PYFormat.getPYLocalStorage().done(function(result){stateMap.usersMap.forEach(function(item){if(item.userfullname){itemPY=PYFormat.getPYMap(result.data,item.userfullname.charAt(0))[0];}else{itemPY={id:item.id,key:undefined,pinyin:undefined,acronym:undefined};}
if(item.id&&itemPY){itemPY.id=item.id;}
stateMap.PYMap.push(itemPY);});});PYFormat=null;};showSearchByID=function showSearchByID(result){if(Object.prototype.toString.call(result)!=='[object Array]')return;jqueryMap.$wf_search_result_list.hide();var i;for(i=0;i<result.length;i++){jqueryMap.$wf_search_result_list.each(function(){if($(this).data('user-id')==result[i]){$(this).show();}});}};removeMember=function removeMember(userId){for(var m=0;m<stateMap.addedUserList.length;m++){if(stateMap.addedUserList[m].id==userId){stateMap.addedUserList.splice(m,1);}}};addMember=function addMember(member){if((typeof member==='undefined'?'undefined':_typeof(member))==="object"){if(member.id&&member.userfullname&&member.useremail){!isMemberAdded(member.id)&&stateMap.addedUserList.push(member);}}else{if(stateMap.usersMap[String(member)]){!isMemberAdded(member)&&stateMap.addedUserList.push(stateMap.usersMap[String(member)]);}}
return this;};isMemberAdded=function isMemberAdded(userId){for(var m=0;m<stateMap.addedUserList.length;m++){if(stateMap.addedUserList[m].id==userId){return true;}}
return false;};resetData=function resetData(){stateMap.usersMap=[];stateMap.addedUserList=[];stateMap.allUserList=[];stateMap.PYMap=[];stateMap.memberSelectedDiff=[];stateMap.isConfirm=false;stateMap.userHasSelectedDefault=[];};checkUserSelectedAmount=function checkUserSelectedAmount(){if(configMap.maxSelected){var li=jqueryMap.$wf_check_result.find('li');var length=li.length=='undefined'?0:li.length;if(configMap.maxSelected<=length){return false;}}
return true;};checkUserDeletedAmount=function checkUserDeletedAmount(){if(configMap.maxDelete){var li=jqueryMap.$wf_check_result.find('li');var length=li.length=='undefined'?0:li.length;if(configMap.maxDelete<length){return true;}
return false;}
return true;};onClickUser=function onClickUser(){if(stateMap.userReadOnly){alert(I18n.resource.workflow.memberSelected.INFO_READONLY);return;}
var $this=$(this),selectedClass=stateMap.selectedClassPrefix;var userId=''+$this.data('user-id');if(configMap.maxSelected==1){if(!$this.hasClass(selectedClass)){if(!isMemberAdded(userId)){stateMap.addedUserList=[];addMember(userId);jqueryMap.$wf_search_result_list.removeClass(selectedClass);$this.addClass(selectedClass);}}}else{if(!$this.hasClass(selectedClass)){if(configMap.enableAddMember){if(checkUserSelectedAmount()){if(!isMemberAdded(userId)){addMember(userId);$this.addClass(selectedClass);}}else{Alert.danger(ElScreenContainer,'超过最大选择数量').showAtTop(300);return false;}}else{Alert.danger(ElScreenContainer,'不能添加人物').showAtTop(300);return false;}}else{if(configMap.enableDeleteMember){if(checkUserDeletedAmount()){$this.removeClass(selectedClass);removeMember(userId);}}else{Alert.danger(ElScreenContainer,'不能删除人物').showAtTop(300);return false;}}}
renderCheckedUsers();};onClickRemoveUser=function onClickRemoveUser(){var $this=$(this),userId=$this.data('user-id');if(configMap.enableDeleteMember){if(checkUserDeletedAmount()){$this.parent().remove();removeMember(userId);filterCheckedUser(userId);}}else{Alert.danger(ElScreenContainer,'不能删除已经存在的人物').showAtTop(300);return false;}};searchByFirstName=function searchByFirstName(){var $this=$(this),searchIndex=$this.text(),result=[],key,i;addActiveSearchBtn($this,1);if($this.index()==0){jqueryMap.$wf_search_result_list.show();}else{for(i=0;i<stateMap.PYMap.length;i++){if(stateMap.PYMap[i]&&stateMap.PYMap[i].pinyin&&(stateMap.PYMap[i].pinyin.charAt(0).toLowerCase()==searchIndex||stateMap.PYMap[i].acronym.charAt(0).toLowerCase()==searchIndex)){result.push(stateMap.PYMap[i].id);}}
showSearchByID(result);}};searchByInput=function searchByInput(ev){ev.preventDefault();ev.stopPropagation();var $this=$(this);var value=$.trim($this.val());if(value==''){jqueryMap.$wf_search_result_list.show();addActiveSearchBtn(null,2);}else{var result=[];for(var i=0;i<stateMap.allUserList.length;i++){(function(i){var member=stateMap.allUserList[i];if(member.userfullname.toLowerCase().indexOf(value.toLowerCase())!=-1||member.useremail&&member.useremail.toLowerCase().indexOf(value.toLowerCase())!=-1){result.push(member.id);}})(i);}
showSearchByID(result);}};filterCheckedUser=function filterCheckedUser(userId){jqueryMap.$wf_search_result_list.each(function(){var $this=$(this);if($this.data('user-id')==userId){$this.removeClass(stateMap.selectedClassPrefix);}});};addActiveSearchBtn=function addActiveSearchBtn($which,type){if($which&&type==1){jqueryMap.$wf_search_by_firstName_li.removeClass('active');$which.addClass('active');}else if(type==2){jqueryMap.$wf_search_by_firstName_li.removeClass('active').eq(0).addClass('active');}};beop.view=beop.view||{};beop.view.memberSelected={addMember:addMember,configModel:configModel,init:init,renderCheckedUsers:renderCheckedUsers};})(beop||(beop={}));(function(beop){var stateMap={structure:null,currentGroup:null,currentGroupId:null,viewType:'',selectedPeoples:{},groupUserRoleType:{"superAdmin":1,'admin':2,"member":3}},jqueryMap={},setJqueryMap,init;var _structureShow,_wfGroupNameEdit,_wfGroupNameSave,_wfAddTeamGroup,_wfTeamGroupAddInput,_wfTeamPeopleAddWin,_renderStructure,_resetData,getStructureItem,addStructureItem,changeStructureItemName,changeStructureItemMember,deleteStructureItem,getStructure,_getTeamId;var initTeamProcess;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_outline:$("#wf-outline"),$team_structure:$("#team_structure"),$wf_team_group_add_input:$("#wf_team_group_add_input"),$wf_team_groups_box:$("#wf_team_groups_box"),$wf_add_team_group:$("#wf_add_team_group")};};init=function init($box,structure,viewType){_resetData();if(!structure||!structure.length||structure.length<2){structure=[{id:ObjectId(),name:'超级管理员',members:[],type:stateMap.groupUserRoleType.superAdmin},{id:ObjectId(),name:'管理员',members:[],type:stateMap.groupUserRoleType.admin}];}else{structure[0].name='超级管理员';structure[1].name='管理员';}
stateMap.structure=structure;stateMap.$container=$box;stateMap.viewType=viewType;setJqueryMap();stateMap.$container.off('click.wf-group-name-edit').on('click.wf-group-name-edit','.wf-group-name-edit',_wfGroupNameEdit);stateMap.$container.off('click.wf-group-name-save').on('click.wf-group-name-save','.wf-group-name-save',_wfGroupNameSave);stateMap.$container.off('click.wf_team_group_add_input').on('click.wf_team_group_add_input','#wf_team_group_add_input',_wfTeamGroupAddInput);stateMap.$container.off('click.wf_team_group_add_input').on('click.wf_team_group_add_input','#wf_team_group_add_input',_wfTeamGroupAddInput);stateMap.$container.off('click.wf-team-people-add').on('click.wf-team-people-add','.wf-team-people-add',_wfTeamPeopleAddWin);stateMap.$container.off('keydown.wf_add_team_group').on('keydown.wf_add_team_group','#wf_add_team_group',_wfAddTeamGroup);_structureShow();initTeamProcess();};initTeamProcess=function initTeamProcess(){};_resetData=function _resetData(){stateMap.structure=null;stateMap.currentGroup=null;stateMap.currentGroupId=null;stateMap.viewType='';stateMap.selectedPeoples={};};_structureShow=function _structureShow(){setJqueryMap();jqueryMap.$container.addClass(stateMap.viewType);jqueryMap.$container.append(beopTmpl('tpl_wf_team_structure',{'structure':stateMap.structure,'viewType':stateMap.viewType}));};getStructureItem=function getStructureItem(id){for(var m=0,n=stateMap.structure.length;m<n;m++){if(stateMap.structure[m].id==id){return stateMap.structure[m];}}};addStructureItem=function addStructureItem(item){if(!item.name||!item.name){}
stateMap.structure.push({id:item.id,name:item.name,members:[],type:stateMap.groupUserRoleType.member});};changeStructureItemName=function changeStructureItemName(id,name){var item=getStructureItem(id);if(!item){return false;}
if(!name||!name.trim()){alert('名字不能为空');return false;}
item.name=name;};changeStructureItemMember=function changeStructureItemMember(id,members){var item=getStructureItem(id);if(!item){}
if(!members){}
item.members=members;};deleteStructureItem=function deleteStructureItem(id){for(var m=0,n=stateMap.structure.length;m<n;m++){if(stateMap.structure[m].id==id){stateMap.structure.splice(m,1);}}};getStructure=function getStructure(){return stateMap.structure;};_getTeamId=function _getTeamId($dom){if(!$dom.hasClass('form-team')){$dom=$dom.closest('.form-team');}
if($dom.length){return $dom.attr('wf-team-id');}
alert('error: can find the id ');};_wfGroupNameEdit=function _wfGroupNameEdit(){var $this=$(this);var $groupNameBox=$this.closest('.team-group-name-title');$groupNameBox.find('.wf-group-name').attr('contenteditable','true').addClass('wf-name-editable');$this.hide();$groupNameBox.find('.wf-group-name-save').show();};_wfGroupNameSave=function _wfGroupNameSave(){var $this=$(this);var $userNameBox=$this.closest('.wf-user-name-box'),$wfGroupName=$userNameBox.find('.wf-group-name');if(!$wfGroupName.text().trim().length){alert('组名不能为空');return;}else if($wfGroupName.text().trim().length>15){alert('组名不能超过15个字符');return;}
$wfGroupName.attr('contenteditable','false').removeClass('wf-name-editable');$this.hide();$userNameBox.find('.wf-group-name-edit').show();if(!changeStructureItemName(_getTeamId($this),$wfGroupName.text())){$wfGroupName.text(getStructureItem(_getTeamId($this)).name);}};_wfTeamGroupAddInput=function _wfTeamGroupAddInput(){setJqueryMap();jqueryMap.$wf_team_groups_box.show();jqueryMap.$wf_team_group_add_input.hide();};_wfAddTeamGroup=function _wfAddTeamGroup(e){if(e.keyCode==13){var val=jqueryMap.$wf_add_team_group.val().trim();if(val!=''){var newStructureItem={'name':val,'id':ObjectId()};jqueryMap.$team_structure.append(beopTmpl('tpl_wf_add_group',newStructureItem));jqueryMap.$wf_add_team_group.val('');jqueryMap.$wf_team_groups_box.hide();jqueryMap.$wf_team_group_add_input.show();addStructureItem(newStructureItem);}}};_wfTeamPeopleAddWin=function _wfTeamPeopleAddWin(){var selectNum=null,$this=$(this);var teamId=_getTeamId($this);var structureItem=getStructureItem(teamId);if(structureItem.type==stateMap.groupUserRoleType.superAdmin){selectNum=1;}else if(structureItem.type==stateMap.groupUserRoleType.admin){selectNum=5;}else if(structureItem.type==stateMap.groupUserRoleType.member){selectNum=null;}
Spinner.spin(stateMap.$container.get(0));WebAPI.get('/workflow/group/user_dialog_list/'+AppConfig.userId).done(function(result){if(result.success){beop.view.memberSelected.configModel({cb_dialog_hide:function cb_dialog_hide(addedUserList){structureItem.members=addedUserList;_renderStructure(teamId);},maxSelected:selectNum,userMemberMap:result.data,userHasSelected:getStructureItem(teamId).members});beop.view.memberSelected.init(jqueryMap.$wf_outline);}}).always(function(){Spinner.stop();});};_renderStructure=function _renderStructure(teamId){$('[wf-team-id='+teamId+']').find('.wf-group-people-box').html(beopTmpl('tpl_wf_added_member',{members:getStructureItem(teamId).members}));};beop.view=beop.view||{};beop.view.structure={init:init,getStructure:getStructure};})(beop||(beop={}));(function(beop){var stateMap={tagList:[]},jqueryMap={},setJqueryMap,init;var _tagsShow,_tagEdit,_tagDelete,_tagSave,_tagAddWin,_tagAdd;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_add_tag_win:$("#wf_add_tag_win"),$wf_add_tag_confirm:$("#wf_add_tag_confirm"),$wf_add_tag_name:$("#wf_add_tag_name"),$wf_team_tags_wrapper:$container.find('#wf_team_tags_wrapper'),$wf_team_tags_List:$container.find('#wf_team_tags_List')};};init=function init($box,tagList,viewType){stateMap.tagList=tagList;stateMap.$container=$box;setJqueryMap();stateMap.$container.off('click.wf-add-tags').on('click.wf-add-tags','.wf-add-tags',_tagAddWin);stateMap.$container.off('click.wf-tag-delete').on('click.wf-tag-delete','.wf-tag-delete',_tagDelete);stateMap.$container.off('click.wf-tag-edit').on('click.wf-tag-edit','.wf-tag-edit',_tagEdit);stateMap.$container.off('click.wf-tag-save').on('click.wf-tag-save','.wf-tag-save',_tagSave);jqueryMap.$wf_add_tag_confirm.off().on('click',_tagAdd);_tagsShow(viewType);};_tagsShow=function _tagsShow(opType){setJqueryMap();if(opType=='show'){jqueryMap.$wf_team_tags_wrapper.append(beopTmpl('tpl_team_add_tags',{'tags':stateMap.tagList,'opType':opType}));}else if(opType=='edit'){jqueryMap.$wf_team_tags_wrapper.append(beopTmpl('tpl_team_add_tags',{'tags':stateMap.tagList,'opType':opType}));jqueryMap.$container.append('<span class="glyphicon glyphicon-plus-sign wf-add-tags"></span>');}else if(opType=='create'){jqueryMap.$container.append('<span class="glyphicon glyphicon-plus-sign wf-add-tags"></span>');}};_tagAddWin=function _tagAddWin(){jqueryMap.$wf_add_tag_name.val('');if(jqueryMap.$wf_team_tags_wrapper.find('.wf-tag-wrapper').length<10){jqueryMap.$wf_add_tag_win.modal();}else{alert('最多只能加十个标签');}};_tagAdd=function _tagAdd(){var val=jqueryMap.$wf_add_tag_name.val().trim();if(val!==''){jqueryMap.$wf_team_tags_wrapper.append(beopTmpl('tpl_wf_add_tag',{'opType':'edit','name':val}));jqueryMap.$wf_add_tag_win.modal('hide');}else{alert('标签名不能为空');}};_tagDelete=function _tagDelete(){$(this).closest('.wf-tag-wrapper').remove();};_tagSave=function _tagSave(){var $this=$(this),$parentsBox=$this.closest('.wf-tag-wrapper'),$name=$parentsBox.find('.wf-tag-name');if($name.text().trim().length<15){$this.hide();$parentsBox.find('.wf-tag-edit').show();$parentsBox.find('.wf-tag-val').val($name.text());$name.attr('contenteditable','false').removeClass('wf-tag-name-editable');}else{alert('标签名不能超过15个字符');}};_tagEdit=function _tagEdit(){var $this=$(this),$parentsBox=$this.closest('.wf-tag-wrapper');$this.hide();$parentsBox.find('.wf-tag-save').show();$parentsBox.find('.wf-tag-name').attr('contenteditable','true').addClass('wf-tag-name-editable');};beop.view=beop.view||{};beop.view.teamTagsCurd={init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'/static/views/workflow/activity.html',settable_map:{activities_number:true,activities_model:true,transactions_model:true,reply_mode:true},activities_number:null,activities_model:null,transactions_model:null,reply_mode:null},stateMap={maxIMGWidth:$('body').width()/2,activityType:{"yesterday":0,"today":1,"thisWeek":2,"thisMonth":3,latestCompleted:'4',latestCreated:'5'}},jqueryMap={},setJqueryMap,configModel,init,renderActivities,onChangeActivities,onReplyFocusout,onReplyFocusin,onReplySubmit,onTaskClick,onUserClick,_onGetMoreActivitiesClick,bindImgZoom,imgZoom,getLimitData;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_activity_container:$container.find('.wf-activity-container'),$wf_activity_container_box:$container.find('.wf-activity-container-box'),$wf_activity_empty:$container.find('.wf-activity-empty'),$wf_activity_getMore:$container.find('.wf-activity-get-more').find('button')};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container,notPubEvent){stateMap.$container=$container;$.spEvent.subEvent(stateMap.$container,'wf-activities-change',onChangeActivities);return WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();jqueryMap.$wf_activity_container.on('click','.wf-close-replay-box',onReplyFocusout);jqueryMap.$wf_activity_container.on('click','.wf-open-replay-box',onReplyFocusin);jqueryMap.$wf_activity_container.on('submit','form.add-reply-form',onReplySubmit);jqueryMap.$wf_activity_container.on('click','.task-name',onTaskClick);jqueryMap.$wf_activity_container.on('click','.task-user',onUserClick);bindImgZoom();!notPubEvent&&$.spEvent.pubEvent('wf-activities-change',stateMap.activityType.today,configMap.activities_number);});};renderActivities=function renderActivities(){if(beop.model.stateMap.activities.length>0){Spinner.spin(jqueryMap.$wf_activity_container.parent().get(0));var html=beopTmpl('tpl_wf_activity_empty',{stateMap:stateMap,showPosition:true,noData:false})+beopTmpl('tpl_wf_activity',{activities:getLimitData(),stateMap:stateMap,showPosition:true});jqueryMap.$wf_activity_container_box.html(html);if(jqueryMap.$container.find(".wf-activity-person-box").length<beop.model.stateMap.totalCount){jqueryMap.$wf_activity_getMore.parent().show();}
bindImgZoom();Spinner.stop();}else{Spinner.spin(jqueryMap.$wf_activity_container.parent().get(0));jqueryMap.$wf_activity_container.html(beopTmpl('tpl_wf_activity_empty',{stateMap:stateMap,showPosition:beop.model.stateMap.activity_type>=4,noData:beop.model.stateMap.activity_type<4}));Spinner.stop();}
I18n.fillArea(jqueryMap.$container);};_onGetMoreActivitiesClick=function onGetMoreActivitiesClick(){configMap.activities_model.getActivities(beop.model.stateMap.activity_type,configMap.activities_number).done(function(result){jqueryMap.$wf_activity_container_box.append(beopTmpl('tpl_wf_activity',{activities:getLimitData(),stateMap:stateMap,showPosition:false}));bindImgZoom();if(jqueryMap.$container.find(".wf-activity-person-box").length<beop.model.stateMap.totalCount){jqueryMap.$wf_activity_getMore.parent().show();}else{jqueryMap.$wf_activity_getMore.parent().hide();}
jqueryMap.$wf_activity_getMore.off().on('click',_onGetMoreActivitiesClick);I18n.fillArea(jqueryMap.$wf_activity_container_box);});};getLimitData=function getLimitData(limt){var activities=beop.model.stateMap.activities;if(!limt){return activities;}
if(activities&&activities.length){if(activities.length<=configMap.activities_number){return activities;}else{jqueryMap.$wf_activity_getMore.parent().show();return activities.splice(0,configMap.activities_number);}}
return[];};bindImgZoom=function bindImgZoom(){jqueryMap.$wf_activity_IMGZoom=jqueryMap.$container.find('.media-body img');jqueryMap.$wf_activity_IMGZoom.each(function(){var $this=$(this);$this.on('load',function(){if($this.context.naturalWidth>=stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css({cursor:'-webkit-zoom-in',maxWidth:'30%'});}});});jqueryMap.$container.find('.wf-activity-person-avatar-body').find('img').each(function(){var $this=$(this);$this.on('load',function(){if($this.context.naturalWidth>=stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css({cursor:'-webkit-zoom-in',maxWidth:'50%'});}});});};imgZoom=function imgZoom(ev){ev.stopPropagation();ev.preventDefault();var imgSRC=$(this).attr('src'),$body=$('body'),$htmlMask=$('<div id="wf-img-zoom" class=""><img style="cursor: -webkit-zoom-out;" src="'+imgSRC+' "/> </div>');$htmlMask.off().on('click',function(){$(this).remove();});$body.append($htmlMask);};onChangeActivities=function onChangeActivities(event,type,page){beop.view.taskDetail.configModel({whereBack:"taskDetail"});configMap.activities_model.getActivities(stateMap.activityType[type],page).done(function(){stateMap.activity_type=type;renderActivities();bindImgZoom();jqueryMap.$wf_activity_getMore.off().on('click',_onGetMoreActivitiesClick);});};onReplyFocusin=function onReplyFocusin(){var $this=$(this);$this.parent().next().slideDown();$this.parent().find('.wf-close-replay-box').removeClass('dn');$this.addClass('dn-important');};onReplyFocusout=function onReplyFocusout(){var $this=$(this);$this.parent().next().slideUp();$this.parent().find('.wf-open-replay-box').removeClass('dn-important');$this.addClass('dn');};onReplySubmit=function onReplySubmit(){var $form=$(this);configMap.reply_mode.insertReply($form.serializeObject()).done(function(result){if(result.success){Alert.success(ElScreenContainer,'reply success!').showAtTop(2000);beop.model.stateMap.lastActivityID=null;$.spEvent.pubEvent('wf-activities-change',stateMap.activity_type);}});};onTaskClick=function onTaskClick(){var $this=$(this),trans_id=$this.data('trans-id');if(!trans_id){return false;}
beop.view.returnActivitiesList=jqueryMap.$container.children().detach();beop.view.taskDetail.configModel({canClose:true,canBack:true,whereBack:'activities'});beop.view.taskDetail.configModel({navigation:false});beop.view.taskDetail.init(jqueryMap.$container,'show',trans_id);return false;};onUserClick=function onUserClick(){var $this=$(this),user_id=$this.data('user-id');beop.view.taskList.configModel({enableBack:true});beop.model.stateMap.lastActivityID=null;beop.view.taskList.init(jqueryMap.$container).done(function(){$.spEvent.pubEvent('wf-task-list',['joinedBy',user_id]);});};beop.view=beop.view||{};beop.view.activities={configModel:configModel,init:init};})(beop||(beop={}));var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(beop){var configMap={htmlURL:'/static/views/workflow/task_mine.html',settable_map:{taskList_model:true,transactions_model:true,tags_model:true,enableBack:true,spEventActivities:true},transactions_model:null,tags_model:null,enableBack:true,spEventActivities:{}},stateMap={task_list_user:AppConfig.userId,task_list_type:'',orderProperty:'',ASC:true,isFirstFilter:true},jqueryMap={},setJqueryMap,configModel,init,starSelect,onTableHeadClick,resetState,renderTaskList,loadTaskList,loadTaskDetail,changeOrderIcon,searchTaskList,paginationRefresh,onClickReturnActivities,bindTaskFilterEvent,dealTaskFilter,searchTaskFilter,initTaskFilterDateTimePicker,bindTaskFilterCustomDate,resetTaskFilter;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_level_search:$("#wf-level-search"),$wf_task_filter:$container.find('#wf-task-filter'),$wf_taskList_table:$container.find('#wf-task-table'),$wf_taskList_tbody:$container.find('#wf-task-table tbody')};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){resetState();stateMap.$container=$container;$.spEvent.subEvent(stateMap.$container,'wf-task-list',loadTaskList);$.spEvent.subEvent(stateMap.$container,'wf-search-list',searchTaskList);$.spEvent.subEvent(stateMap.$container,'wf-load-detail',loadTaskDetail);return WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);if(configMap.enableBack){var html='<a href="javascript:void (0)" class="btn btn-white btn-sm" id="wf-task-return-activities"><i class="glyphicon glyphicon-arrow-left"></i><span  i18n="workflow.task.BACK"></span></a>';stateMap.$container.prepend(html);jqueryMap.returnActivitiesList=stateMap.$container.find('#wf-task-return-activities');jqueryMap.$wf_content=stateMap.$container;jqueryMap.returnActivitiesList.on('click',onClickReturnActivities);}
I18n.fillArea(stateMap.$container);setJqueryMap();jqueryMap.$wf_taskList_table.on('click','th.order',onTableHeadClick);jqueryMap.$wf_taskList_table.on('click','.wf-task-star',function(e){var $this=$(this);var trans_id=$this.attr("trans_id");if($this.hasClass("glyphicon-star-empty")){$this.removeClass("glyphicon-star-empty").addClass("glyphicon-star");}else{$this.removeClass("glyphicon-star").addClass("glyphicon-star-empty");}
return configMap.transactions_model.toggleStarred(trans_id,AppConfig.userId).done(function(result){if(result.success){}});});});};renderTaskList=function renderTaskList(groupNo){if(groupNo){jqueryMap.$container.attr("data-group-no",groupNo);}else{jqueryMap.$container.attr("data-group-no","");}
var tplStr=$(window).width()<=1366?'tpl_wf_taskList_min':'tpl_wf_taskList_max';jqueryMap.$wf_taskList_table.html(beopTmpl(tplStr,{transactions:beop.model.stateMap.trans_list.records?beop.model.stateMap.trans_list.records:[],listTodayTasks:Array.isArray(beop.model.stateMap.listTodayTasks)?beop.model.stateMap.listTodayTasks.length?beop.model.stateMap.listTodayTasks:[]:[]}));if(beop.model.stateMap.isShowTaskFilter&&!Object.keys(beop.model.stateMap.filter.param).length){try{jqueryMap.$wf_task_filter.empty().html(beopTmpl("tpl_task_filter",{groupList:beop.model.stateMap.group_list,tagList:beop.model.stateMap.tag_list}));}catch(e){}
bindTaskFilterEvent();}
if(beop.model.stateMap.isFilterAfterBack){$("#wf-task-filter").empty().html(beop.model.stateMap.filterDetach);bindTaskFilterEvent();}
jqueryMap.$wf_task_star=$(".wf-task-star");jqueryMap.$wf_task_pagination=$("#task-pagination");paginationRefresh(beop.model.stateMap.trans_list.total);if(stateMap.orderObject&&stateMap.orderObject.orderProperty){var $theadTh=jqueryMap.$wf_taskList_table.find('thead tr').children('th'),orderObject=stateMap.orderObject;$theadTh.find('span.glyphicon').remove();$theadTh.each(function(){var $this=$(this);if($this.attr('data-order-property')==orderObject.orderProperty){if(orderObject.asc){$this.prepend('<span class="glyphicon glyphicon-sort-by-attributes"></span>');}else{$this.prepend('<span class="glyphicon glyphicon-sort-by-attributes-alt"></span>');}}});}
I18n.fillArea(stateMap.$container);};bindTaskFilterEvent=function bindTaskFilterEvent(){jqueryMap.$wf_task_filter.find('label').off().change(function(ev){var $this=$(this),$select=$this.find('select'),type=$this.attr('data-filter-type'),selectValue=$select.val();var allowFilterType=["group","creator","urgency","status","tags","dueDate"];if(allowFilterType.indexOf(type)==-1){console.error('unknown transaction filter type'+type);}else{dealTaskFilter($this,type,selectValue);}}).end().find('#wf-task-filter-reset').off().click(function(ev){resetTaskFilter();});};resetTaskFilter=function resetTaskFilter(){var model=beop.model.stateMap.filter;if(Object.keys(model.param).length){model.param={};loadTaskList(null,stateMap.task_list_type,stateMap.task_list_user,1,{orderProperty:stateMap.orderProperty,asc:stateMap.asc});}};dealTaskFilter=function dealTaskFilter($label,type,selectValue){var model=beop.model.stateMap.filter.param;if(stateMap.isFirstFilter){stateMap.currentPage=1;stateMap.isFirstFilter=false;}
if(type==="dueDate"){if(selectValue==5){model.dueDate={};initTaskFilterDateTimePicker($label);}else if(selectValue==-1){delete model[type];$label.closest('#wf-task-filter').find('.wf-filter-custom-date-select').remove();}else{$label.closest('#wf-task-filter').find('.wf-filter-custom-date-select').remove();model.dueDate=selectValue;searchTaskFilter();}}else{if(selectValue==-1){delete model[type];}else{model[type]=selectValue;}}
if(model&&_typeof(model.dueDate)=='object'&&Object.keys(model.dueDate).length==0){return;}
if(Object.keys(model).length){searchTaskFilter();}else{loadTaskList(null,stateMap.task_list_type,stateMap.task_list_user,1,{orderProperty:stateMap.orderProperty,asc:stateMap.asc});}};searchTaskFilter=function searchTaskFilter(orderProperty,asc){var model=beop.model.stateMap.filter;Spinner.spin(ElScreenContainer);WebAPI.post('workflow/transaction/filter/'+AppConfig.userId,{type:model.type,filter:model.param,page:stateMap.currentPage,limit:beop.model.stateMap.task_page_size,order:{orderProperty:orderProperty?orderProperty:"id",asc:asc?asc:"DESC"}}).done(function(result){if(result.success){beop.model.stateMap.trans_list=result.data;beop.model.stateMap.trans_list.total=result.data.total;renderTaskList();$('#wf-task-table').find('glyphicon').remove();}}).always(function(){Spinner.stop();});};initTaskFilterDateTimePicker=function initTaskFilterDateTimePicker($label){var $parent=$label.closest("#wf-task-filter");$label.after(beopTmpl('tpl_TaskFilterDateTimePicker',{}));$parent.find('input[name="startTIME"]').datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true});$parent.find('input[name="endTIME"]').datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true});I18n.fillArea($parent);bindTaskFilterCustomDate($parent);};bindTaskFilterCustomDate=function bindTaskFilterCustomDate($parent){var $inputStartTime=$parent.find('input[name="startTIME"]'),$inputEndTime=$parent.find('input[name="endTIME"]');var startTime="",endTime="";var checkTime=function checkTime(){if(startTime.toDate()>endTime.toDate()){alert(I18n.resource.workflow.task.TIME_GREATER_CHECK_INFO_1);return false;}
if(endTime.toDate()<startTime.toDate()){alert(I18n.resource.workflow.task.TIME_GREATER_CHECK_INFO_2);return false;}
return true;};$inputStartTime.off('change').change(function(){startTime=$(this).val();checkTime();});$inputEndTime.off('change').change(function(){endTime=$(this).val();checkTime();});$parent.find('.TaskFilterDateTimePickerBtn').off().click(function(){if(!startTime||!endTime){return false;}
if(checkTime()){beop.model.stateMap.filter.param.dueDate={startTime:startTime,endTime:endTime};searchTaskFilter();}});};paginationRefresh=function paginationRefresh(totalNum){var totalPages=Math.ceil(totalNum/beop.model.taskPageSize);if(!totalNum){return;}
while(totalPages<stateMap.currentPage&&stateMap.currentPage>1){stateMap.currentPage=stateMap.currentPage-1;}
var getPageClickCallback=function getPageClickCallback(){if(beop.model.stateMap.isShowTaskFilter&&Object.keys(beop.model.stateMap.filter.param).length){return function(event,page){stateMap.currentPage=page;searchTaskFilter();};}else{return function(event,page){stateMap.currentPage=page;loadTaskList(null,stateMap.task_list_type,stateMap.task_list_user,page,{orderProperty:stateMap.orderProperty,asc:stateMap.asc});};}};var pageOption={first:'&laquo;&laquo',prev:'&laquo;',next:'&raquo;',last:'&raquo;&raquo;',startPage:stateMap.currentPage?stateMap.currentPage:1,totalPages:!totalPages?1:totalPages,onPageClick:getPageClickCallback()};if(stateMap.currentPage){pageOption['startPage']=stateMap.currentPage?stateMap.currentPage:1;}
jqueryMap.$wf_task_pagination.off().removeData('twbs-pagination').empty();stateMap.pagination=jqueryMap.$wf_task_pagination.twbsPagination(pageOption);};starSelect=function starSelect(event,type,param){if(jqueryMap.$wf_task_star.hasClass("glyphicon-star-empty")){jqueryMap.$wf_task_star.removeClass("glyphicon-star-empty").addClass("glyphicon-star");}else{jqueryMap.$wf_task_star.removeClass("glyphicon-star").addClass("glyphicon-star-empty");}};changeOrderIcon=function changeOrderIcon(){jqueryMap.$wf_taskList_table.find('th .glyphicon').remove();};onClickReturnActivities=function onClickReturnActivities(){beop.view.returnActivitiesList=jqueryMap.$container.children().detach();beop.view.activities.init(stateMap.$container,true).done(function(){$.spEvent.pubEvent(configMap.spEventActivities.topic,configMap.spEventActivities.param);});};resetState=function resetState(){stateMap.pagination=null;};loadTaskList=function loadTaskList(event,type,user_id,currentPage,orderObject,isFilterAfterBack){currentPage=currentPage||1;stateMap.task_list_user=user_id;stateMap.task_list_type=type;stateMap.orderObject=orderObject;stateMap.currentPage=currentPage;var navigationI18n={'workingTask':I18n.resource.workflow.navigation.WORKING_TASK,'inDoing':I18n.resource.workflow.navigation.IN_DOING,'waitVerifier':I18n.resource.workflow.navigation.WAIT_VERIFY,'newCreate':I18n.resource.workflow.navigation.NEW_CREATED,'createdBy':I18n.resource.workflow.navigation.CREATED_BY,'finishedBy':I18n.resource.workflow.navigation.FINISH_BY,'taskStop':I18n.resource.workflow.navigation.STOPED_BY,'taskComplete':I18n.resource.workflow.navigation.COMPLETED_BY,'joinedBy':I18n.resource.workflow.navigation.JOINED_BY,'myCollection':I18n.resource.workflow.navigation.MY_COLLECTION,'tag':I18n.resource.workflow.navigation.TAG,'group':I18n.resource.workflow.navigation.GROUP,'search':I18n.resource.workflow.navigation.SEARCH,"waitMeToVerifier":I18n.resource.workflow.navigation.WAIT_ME_TO_VERIFIER};beop.view.taskDetail.configModel({navigation:navigationI18n[type]});jqueryMap.$wfExtraList1=stateMap.$container.parent().find('.wf-extra-list-1');jqueryMap.$wfExtraList2=stateMap.$container.parent().find('.wf-extra-list-2');if(type=='workingTask'){jqueryMap.$wfExtraList1.slideDown();jqueryMap.$wfExtraList2.slideUp();}
if(beop.model.stateMap.UEInstance){beop.model.stateMap.UEInstance.destroy();beop.model.stateMap.UEInstance=null;}
var switchType=function switchType(type){if(!type||type==='undefined'){type='workingTask';}
stateMap.isFirstFilter=true;beop.model.stateMap.isShowTaskFilter=true;beop.model.stateMap.filter.type=type;beop.model.stateMap.isFilterAfterBack=isFilterAfterBack;if(!isFilterAfterBack){beop.model.stateMap.filter.param={};}
switch(type){case'workingTask':{return configMap.transactions_model.listTransWorking(user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}
configMap.transactions_model.getListTodayTasks(AppConfig.userId).done(function(result){if(result.success&&result.data){var data=result.data,$wfTransitionNumber=$('#wf-transaction-number'),$wfSchedulersNumber=$('#wf-schedulers-number'),$wfHasCreatorNumber=$('#wf-has-new-creator-number');var transLength,schedulersLength,totalLength;try{transLength=data.transaction&&data.transaction.length||0,schedulersLength=data.scheduler&&data.scheduler.length||0;}catch(ex){transLength=0;schedulersLength=0;}
totalLength=transLength+schedulersLength;if(transLength){$wfTransitionNumber.text(transLength).show();$wfHasCreatorNumber.text(transLength).show();}else{$wfTransitionNumber.hide();$wfHasCreatorNumber.hide();}
if(schedulersLength){$wfSchedulersNumber.text(schedulersLength).show();}else{$wfSchedulersNumber.hide();}
if(totalLength){$('#iconList').find('span.badge').show();$('#paneWorkflow').find('span.badge').text(totalLength);}else{$('#iconList').find('span.badge').hide();$('#paneWorkflow').find('span.badge').remove();}
beop.model.stateMap.listTodayTasks=result.data.transaction;}});});}
case'createdBy':{return configMap.transactions_model.listTransCreatedBy(user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'taskComplete':{return configMap.transactions_model.getCompleteVerifiedTask(user_id,currentPage,orderObject,type).done(function(result){if(result.success){renderTaskList();}});}
case'taskStop':{return configMap.transactions_model.getStopVerifiedTask(user_id,currentPage,orderObject,type).done(function(result){if(result.success){renderTaskList();}});}
case'finishedBy':{return configMap.transactions_model.listTransFinishedBy(user_id,currentPage,orderObject,type).done(function(result){if(result.success){renderTaskList();}});}
case'joinedBy':{return configMap.transactions_model.listTransJoinedBy(user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'group':case"taskGroup":{return configMap.transactions_model.listGroupTrans(currentPage,orderObject).done(function(result){if(result.success){renderTaskList(user_id);}});}
case'search':{var text=$.trim(jqueryMap.$wf_level_search.val());return configMap.transactions_model.searchTrans(AppConfig.userId,text,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'tag':{return configMap.tags_model.transTag(AppConfig.userId,user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'myCollection':{return configMap.transactions_model.listTransStarBy(AppConfig.userId,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'inDoing':{return configMap.transactions_model.listStartedTrans(AppConfig.userId,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'waitMeToVerifier':{return configMap.transactions_model.waitMeToVerifier(AppConfig.userId,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'waitVerifier':{return configMap.transactions_model.listWaitVerify(AppConfig.userId,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'newCreate':{return configMap.transactions_model.listNewCreated(AppConfig.userId,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
default:{return $.Deferred().resolve();}}};return switchType(type).done(function(){Spinner.stop();});};searchTaskList=function searchTaskList(event,type,user_id,currentPage,orderObject){jqueryMap.$wf_level_search.keyup(function(e){if(e.keyCode==13){loadTaskList(null,stateMap.task_list_type,AppConfig.userId,1,{orderProperty:stateMap.orderProperty,asc:stateMap.asc});}});currentPage=currentPage||1;stateMap.task_list_user=user_id;stateMap.task_list_type=type;switch(type){case'search':{var text=$.trim(jqueryMap.$wf_level_search.val());if(text!=""){return configMap.transactions_model.searchTrans(AppConfig.userId,text,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}}}};loadTaskDetail=function loadTaskDetail(event,type,param){beop.model.stateMap.filterDetach=$('#wf-task-filter').detach();beop.view.returnTaskList=jqueryMap.$container.children().detach();beop.view.taskDetail.configModel({canBack:true,canEdit:true,whereBack:'taskDetail',taskListType:stateMap.task_list_type,taskListPage:stateMap.currentPage,taskListUserId:stateMap.task_list_user,taskListOrderObject:stateMap.orderObject});beop.view.taskDetail.configModel({isAddNewTaskForVerifiersSelected:false});beop.view.taskDetail.init(stateMap.$container,type,param);};onTableHeadClick=function onTableHeadClick(){var model=beop.model.stateMap;if(model.isShowTaskFilter&&Object.keys(model.filter.param).length){return true;}else{var $this=$(this),index=$('#wf-task-table').find('thead').find('th').index($this);stateMap.orderProperty=$this.data('order-property');stateMap.asc=$this.find('.glyphicon').hasClass('glyphicon-sort-by-attributes-alt');loadTaskList(null,stateMap.task_list_type,stateMap.task_list_user,1,{orderProperty:stateMap.orderProperty,asc:stateMap.asc}).done(function(result){if(result.success){$this=$('#wf-task-table').find('thead').find('th').eq(index);$this.siblings('th').find('.glyphicon').remove();var flag=$this.find('.glyphicon').hasClass('glyphicon-sort-by-attributes-alt');if(stateMap.asc){if(flag){$this.find('.glyphicon').remove();}
if(!$this.find('.glyphicon').hasClass('glyphicon-sort-by-attributes')){$this.prepend('<span class="glyphicon glyphicon-sort-by-attributes"></span>');}}else{if(flag){$this.find('.glyphicon').remove();}
$this.prepend('<span class="glyphicon glyphicon-sort-by-attributes-alt"></span>');}
stateMap.currentPage=1;paginationRefresh(beop.model.stateMap.trans_list.total);}});}};beop.view=beop.view||{};beop.view.taskList={configModel:configModel,loadTaskList:loadTaskList,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_group.html',settable_map:{group_model:true},group_model:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init,loadTaskDetail,onItemClick;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){stateMap.$container=$container;WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();stateMap.$container.on('click','[data-topic]',onItemClick);stateMap.$container.on('click','.wf-task-star',function(e){var $this=$(this);if($this.hasClass("glyphicon-star-empty")){$this.removeClass("glyphicon-star-empty").addClass("glyphicon-star");}else{$this.removeClass("glyphicon-star").addClass("glyphicon-star-empty");}});});$.spEvent.subEvent(stateMap.$container,'wf-load-detail',loadTaskDetail);};onItemClick=function onItemClick(){var $this=$(this);var topic=$this.data('topic'),param=$this.data('param');$.spEvent.pubEvent(topic,param);};loadTaskDetail=function loadTaskDetail(event,type,param){beop.view.taskDetail.configModel({isAddNewTaskForVerifiersSelected:false});beop.view.taskDetail.init(stateMap.$container,type);};beop.view=beop.view||{};beop.view.groupShow={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_group_add.html',settable_map:{group_model:true,data:true,navigation:true},group_model:null,data:null,navigation:null},stateMap={usersMap:{},addedUserList:[]},jqueryMap={},setJqueryMap,configModel,init,renderCheckedUsers,renderAddedUsers,onAddUserDialogOpen,onSubmit;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$add_group_form:$container.find('#wf-add-group-form'),$initMemberSelectedBtn:$container.find('.wf-people-add'),$wf_check_result:$container.find('.wf-check-result'),$wf_added_user_list:$container.find('.wf-added-user-list'),$wf_add_edit_title:$container.find('#wf-group-addOrEdit'),$wf_task_group:$container.parent().find('#wf-task-group')};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){stateMap.$container=$container;setJqueryMap();WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();jqueryMap.$add_group_form.html(beopTmpl('tpl_wf_group_add'),{navigation:configMap.navigation});stateMap.$container.find('.wf-people-add').off().on('click',onAddUserDialogOpen);jqueryMap.$add_group_form.submit(onSubmit);jqueryMap.$wf_added_user_list=jqueryMap.$container.find('.wf-added-user-list');jqueryMap.$wf_add_edit_title.attr('i18n','workflow.task.ADD_NEW_TASK_GROUP');}).always(function(){Spinner.stop();I18n.fillArea(jqueryMap.$container);});};renderCheckedUsers=function renderCheckedUsers(){jqueryMap.$wf_check_result.html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.addedUserList}));};renderAddedUsers=function renderAddedUsers(addedUserList){stateMap.addedUserList=addedUserList;jqueryMap.$wf_added_user_list.html(beopTmpl('tpl_wf_added_member',{members:stateMap.addedUserList}));};onAddUserDialogOpen=function onAddUserDialogOpen(){configMap.group_model.userDialogList().done(function(result){if(result.success){beop.view.memberSelected.configModel({cb_dialog_hide:renderAddedUsers,userMemberMap:result.data,maxSelected:null,userHasSelected:stateMap.addedUserList});beop.view.memberSelected.init(jqueryMap.$container.parent());}});};onSubmit=function onSubmit(){var $form=$(this),i18n=I18n.resource.workflow.common;var title_val=$form.find('input[name="name"]').val().trim(),detail_val=$form.find('textarea[name="description"]').val().trim();if(title_val===""){Alert.danger($form,i18n.GROUP_NAME_REQUIRED).showAtTop(2000);return;}
if(detail_val===""){Alert.danger($form,i18n.DETAIL_REQUIRED).showAtTop(2000);return;}
Spinner.spin(jqueryMap.$wf_task_group.get(0));configMap.group_model.addGroup($form.serializeObject()).done(function(result){if(result.success){Alert.success(ElScreenContainer,i18n_resource.workflow.task.ADD_GROUP_SUCCESS).showAtTop(2000);jqueryMap.$container.find('#wf-group-name').val('');jqueryMap.$container.find('#wf-group-des').val('');jqueryMap.$container.find('#wf-workflow-memberList').empty();}
beop.view.menu_group_list.configModel({whereComeFrom:'default'});location.href="#page=workflow&type=transaction&subType=taskGroup&id="+result.data;beop.view.menu_group_list.init($('#wf-outline'));Spinner.stop();});};beop.view=beop.view||{};beop.view.groupAdd={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={settable_map:{group_model:true},group_model:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_del_win:$("#wf-del-win"),$wf_event_confirm:$("#wf-event-confirm"),$wf_task_groups:$("#wf-task-groups")};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){stateMap.$container=$container;setJqueryMap();jqueryMap.$wf_del_win.modal();jqueryMap.$wf_event_confirm.off().on('click',function(e){if(jqueryMap.$wf_del_win.attr("data-type")==="taskGroup"){var param=jqueryMap.$wf_del_win.attr("data-param");beop.view.menu_group_list.configModel({whereComeFrom:'default'});configMap.group_model.deleteGroup(param).done(function(result){if(result.success){if(jqueryMap.$container.attr("data-group-no")==param){jqueryMap.$container.html("");}
jqueryMap.$wf_del_win.attr("data-type","");jqueryMap.$wf_del_win.modal("hide");Spinner.spin($container.parent().find('#wf-task-group').get(0));beop.view.menu_group_list.init($container.parent()).done(function(){}).always(function(){Spinner.stop();}).fail(function(){});}});}});};beop.view=beop.view||{};beop.view.groupDelete={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_edit.html',settable_map:{transactions_model:true,attachmentModel:true,tags_model:true,group_model:true,canClose:true,canBack:true,canEdit:true,whereBack:true,taskListType:true,taskListPage:true,taskListUserId:true,taskListOrderObject:true,navigation:true,isAddNewTaskForVerifiersSelected:true},transactions_model:null,tags_model:null,group_model:null,canClose:false,canBack:false,canEdit:false,whereBack:'taskDetail',taskListType:null,taskListPage:null,taskListUserId:null,taskListOrderObject:null,navigation:null,attachmentModel:null,isAddNewTaskForVerifiersSelected:true},stateMap={userSelectedMap:{'verifiers':[],'executor':[],'watchers':[]},labelList:[],tag_list:[],supposeFileReader:true,attachmentMaxSize:5242880,attachmentPrefix:'-',isFileUploadInNewTask:false,pendingFiles:[],maxUploadFileAmount:5},jqueryMap={},setJqueryMap,configModel,init,attachEvent,renderTags,renderTagsSelector,onPubEvent,starSelect,funChange,addComment,onNewTaskSubmit,loadTaskDetail,initDatePicker,returnTaskList,showTaskDetail,editTaskDetail,loadFaultCurve,loadBottomSection,onAddUserDialogOpen,onTaskSave,onTaskDelete,onCompleteTask,onVerifyPass,onVerifyNotPass,onTagDelete,onAddTag,addTagOnPage,removeTagOnPage,getTag,isExistTag,pageTaskCheck,renderAddedUsers,resetData,setUserHasSelectedMap,startTaskDetail,forwardTaskDetail,dealForwardExecutor,closeTaskDetail,updateStatusNumber,bindEditTaskGroup,editTaskGroup,fileUploadInit,getAttachmentIconClassByType,getAttachmentTime,deleteAttachment,downloadAttachment,dispatchDownload,checkAttachmentAmount;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap=$.extend(jqueryMap?jqueryMap:{},{$outline:$("#wf-outline"),$container:$container,$wf_taskDetail_container:$container.find('#wf-detail-container'),$wf_taskDetail_form:$container.find('#wf-detail-form'),$begin_time:$container.find("#beginTime"),$due_time:$container.find("#dueTime"),$label_name:$container.find("#labelName"),$wf_detail_star:$container.find("#wf-detail-star"),$wf_labelName_error:$container.find("#wf-labelName-error"),$wf_comment_btn:$container.find("#wf-comment-btn"),$wf_comment_text:$container.find("#wf-comment-text"),$wf_comment_table:$container.find("#wf-comment-table"),$wf_task_label:$container.find(".wf-task-label"),$wf_fault_curve:$container.find('#wf-fault-curve'),$wf_task_return:$container.find('#wf-task-return'),$wf_detail_show:$container.find('#wf-detail-show'),$wf_detail_edit:$container.find('#wf-detail-edit'),$wf_detail_submit:$container.find('#wf-detail-submit'),$wf_detail_other_fun_wrapper:$container.find('#wf-detail-other-fun-wrapper'),$wf_del_win:$("#wf-del-win"),$wf_event_confirm:$("#wf-event-confirm"),$wf_show_tags_text:$("#wf-detail-show-tags-wrapper"),$wf_detail_collection:$("#wf-detail-collection"),$wf_detail_start:$container.find('#wf-detail-start'),$wf_detail_forward:$container.find('#wf-detail-forward'),$wf_detail_end:$container.find('#wf-detail-end')});};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container,type,transId){Spinner.spin(ElScreenContainer);stateMap.$container=$container;$.spEvent.subEvent(stateMap.$container,'wf-fun-change',funChange);$.spEvent.subEvent(stateMap.$container,'wf-add-comment',addComment);$.spEvent.subEvent(stateMap.$container,'wf-task-return',returnTaskList);$.spEvent.subEvent(stateMap.$container,'wf-detail-show',showTaskDetail);if(typeof FileReader==='undefined'){stateMap.supposeFileReader=false;}
return WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);stateMap.transId=transId;jqueryMap.$wf_taskDetail_container=stateMap.$container.find('#wf-detail-container');stateMap.$container.off('click.pubEvent').on('click.pubEvent','[data-topic]',onPubEvent);stateMap.$container.off('click.wf-detail-save').on('click.wf-detail-save','#wf-detail-save',onTaskSave);stateMap.$container.off('click.wf-detail-delete').on('click.wf-detail-delete','#wf-detail-delete',onTaskDelete);stateMap.$container.off('click.wf-add-user').on('click.wf-add-user','.wf-add-user',onAddUserDialogOpen);stateMap.$container.off('click.wf-detail-edit').on('click.wf-detail-edit','#wf-detail-edit',editTaskDetail);stateMap.$container.off('click.wf-detail-complete').on('click.wf-detail-complete','#wf-detail-complete',onCompleteTask);stateMap.$container.off('click.wf-verify-pass').on('click.wf-verify-pass','#wf-verify-pass',onVerifyPass);stateMap.$container.off('click.wf-verify-not-pass').on('click.wf-verify-not-pass','#wf-verify-not-pass',onVerifyNotPass);stateMap.$container.off('click.wf-detail-tag-delete').on('click.wf-detail-tag-delete','.wf-detail-tag-delete',onTagDelete);stateMap.$container.off('click.wf-star-select').on('click.wf-star-select','#wf-detail-star',starSelect);stateMap.$container.off('change.labelName').on('change.labelName','#labelName',onAddTag);stateMap.$container.off('click.wf-detail-start').on('click.wf-detail-edit','#wf-detail-start',startTaskDetail);stateMap.$container.off('click.wf-detail-forward').on('click.wf-detail-edit','#wf-detail-forward',forwardTaskDetail);stateMap.$container.off('click.wf-detail-end').on('click.wf-detail-edit','#wf-detail-end',closeTaskDetail);stateMap.$container.off('click.wf-attachment-input-btn').on('click.wf-attachment-input-btn','#wf-attachment-input-btn',fileUploadInit);stateMap.$container.off('click.wf-attachment-delete').on('click.wf-attachment-delete','.wf-attachment-delete',deleteAttachment);resetData();loadTaskDetail(type).done(function(){I18n.fillArea(stateMap.$container);setJqueryMap();attachEvent();initDatePicker();bindEditTaskGroup(type);}).always(function(){Spinner.stop();});});};attachEvent=function attachEvent(e){jqueryMap.$wf_event_confirm.off().on('click',function(e){if(jqueryMap.$wf_del_win.attr("data-type")==="taskItem"){configMap.transactions_model.delTrans(stateMap.transId).done(function(result){if(result.success){beop.view.taskList.init(jqueryMap.$container).done(function(){$.spEvent.pubEvent('wf-task-list',[configMap.taskListType,configMap.taskListUserId,configMap.taskListPage,configMap.taskListOrderObject]);jqueryMap.$wf_del_win.attr("data-type","");jqueryMap.$wf_del_win.modal("hide");});}});}});};renderTags=function renderTags(tags){jqueryMap.$wf_detail_labelWrapper=stateMap.$container.find("#wf-detail-labelWrapper");jqueryMap.$wf_detail_labelWrapper.html(beopTmpl('tpl_wf_detail_labels',{tags:tags}));};starSelect=function starSelect(){if(jqueryMap.$wf_detail_star.hasClass("glyphicon-star-empty")){jqueryMap.$wf_detail_star.removeClass("glyphicon-star-empty").addClass("glyphicon-star");jqueryMap.$wf_detail_collection.val(1);}else{jqueryMap.$wf_detail_star.removeClass("glyphicon-star").addClass("glyphicon-star-empty");jqueryMap.$wf_detail_collection.val(0);}};returnTaskList=function returnTaskList(){switch(configMap.whereBack){case'activities':stateMap.$container.html("").append(beop.view.returnActivitiesList);break;case'taskDetail':history.go(-1);return true;}
if(beop.model.stateMap.UEInstance){beop.model.stateMap.UEInstance.destroy();beop.model.stateMap.UEInstance=null;}};funChange=function funChange(event,type,param){if(type=="comment"){jqueryMap.$wf_detail_comment.show();jqueryMap.$wf_detail_progress.hide();jqueryMap.$wf_detail_comment_nav.addClass("active").siblings().removeClass("active");}else if(type=="progress"){jqueryMap.$wf_detail_comment.hide();jqueryMap.$wf_detail_progress.show();jqueryMap.$wf_detail_progress_nav.addClass("active").siblings().removeClass("active");beop.view.progress.init(jqueryMap.$wf_detail_progress);}};addComment=function addComment(event,type,param){var val=$.trim(jqueryMap.$wf_comment_text.val());if(val!=''){jqueryMap.$wf_comment_table.prepend(jqueryMap.$wf_comment_table.find("tbody tr").eq(0).clone());jqueryMap.$wf_comment_table.find("tbody tr").eq(0).find(".wf-comment-content").text(val);}};renderAddedUsers=function renderAddedUsers(type){return function(addedUserList){stateMap.userSelectedMap[type]=addedUserList;jqueryMap.$wf_added_user_list.filter(function(index,item){return $(item).data('type')===type;}).html(beopTmpl('tpl_wf_added_member_personal',{members:addedUserList,userListName:type?type:'addedUserList'}));};};bindEditTaskGroup=function bindEditTaskGroup(type){jqueryMap.$group_type_selector=jqueryMap.$container.find('#wf-group-type');if(type=='new'){if(beop.model.stateMap&&beop.model.stateMap.groupId){jqueryMap.$group_type_selector.val(beop.model.stateMap&&beop.model.stateMap.groupId);}
jqueryMap.$group_type_selector.off().on('change',editTaskGroup);}else{jqueryMap.$group_type_selector.off().on('change',editTaskGroup);}};deleteAttachment=function deleteAttachment(ev){var $file=$(ev.target).closest('div.files');if(stateMap.isFileUploadInNewTask){$file.remove();}else{var fileUid=$file.attr('data-file-uid'),fileName=$file.attr('data-file-name');if(fileUid){confirm(I18n.resource.workflow.task.ATTACHMENT_DELETE_NOTE,function(){Spinner.spin(ElScreenContainer);WebAPI.post('workflow/attachment/delete',{fileName:fileName,uid:fileUid,userId:AppConfig.userId,transId:beop.model.stateMap.cur_trans.id}).done(function(result){if(result.success){loadTaskDetail().done(function(){checkAttachmentAmount();});}}).always(function(){Spinner.stop();}).fail(function(){alert(I18n.resource.workflow.task.ATTACHMENT_DELETE_FAIL_INFO);});});}}};downloadAttachment=function downloadAttachment(ev){var $file=$(ev.target).closest('div.files'),fileUid=$file.attr('data-file-uid'),fileName=$file.attr('data-file-name');Spinner.spin(ElScreenContainer);WebAPI.post('workflow/attachment/download',{userId:AppConfig.userId,fileName:fileName,fileUid:fileUid,transId:beop.model.stateMap.cur_trans.id}).done(function(result){if(result.success&&result.data){dispatchDownload(result);}}).fail(function(){}).always(function(){Spinner.stop();});};dispatchDownload=function dispatchDownload(result){var a=$("<a  download='"+fileName+"' target='_self'' href='"+result.data.url+"'>Download</a>")[0];var evObj=document.createEvent('MouseEvents');evObj.initEvent('click',true,true,window);a.dispatchEvent(evObj);};getAttachmentIconClassByType=function getAttachmentIconClassByType(name){var mineType=[{type:['png','jpeg','jpg','bmp','webpg'],class:'icon-file-pic'},{type:['docx','doc','wps'],class:"icon-file-doc"},{type:['ppt'],class:"icon-file-ppt"},{type:['pdf'],class:'icon-file-pdf'},{type:['xlsx','xls','xlsb','xlsm','xlst'],class:'icon-file-excel'},{type:['exe'],class:'icon-file-exe'},{type:['zip','rar','jar'],class:'icon-file-zip'},{type:['rar'],class:'icon-file-rar'}];var fileType=name.split('.'),defaultFileClassName='icon-file-file';fileType=fileType[fileType.length-1];if(fileType){mineType.forEach(function(item,index,array){if(item.type.indexOf(String(fileType).toLowerCase())!==-1){defaultFileClassName=item.class;return true;}});}
return defaultFileClassName;};getAttachmentTime=function getAttachmentTime(time){var monthShort=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];var date=new Date(time);return monthShort[date.getMonth()]+' '+date.getDate()+' '+date.getFullYear();};fileUploadInit=function fileUploadInit(){var currentAttachmentLength=$('#wf-attachment-labelWrapper').find('.wf-attachment-nav li').length;Spinner.spin(ElScreenContainer);var AUTOSENDFILE=true;var fileUploadInstance=new WfFileUpload(AUTOSENDFILE,currentAttachmentLength,stateMap.isFileUploadInNewTask);fileUploadInstance.init(function(){Spinner.stop();}).uploadSuccess(function(list){if(stateMap.isFileUploadInNewTask){stateMap.pendingFiles=stateMap.pendingFiles.concat(list);$(this.uploadModalContainerId).remove();fileUploadInstance=null;var html='';stateMap.pendingFiles.forEach(function(item){html+=beopTmpl('wf_file_list_temp',{file:item.file,fileId:item.id,iconClass:item.iconClass,fileBase64:item.fileBase64,fileUid:item.uid});});jqueryMap.$container.find('.wf-attachment-nav').empty().html(html);stateMap.$container.off('click.wf-remove-upload-item').on('click.wf-remove-upload-item','.wf-remove-upload-item',function(){var _this=this;var $this=$(_this),$files=$this.closest('div.files'),fileId=$files.attr('data-file-id'),uid=$files.attr('data-file-uid'),fileName=$files.attr('data-file-name');var removeAttachmentLi=function removeAttachmentLi(){stateMap.pendingFiles.forEach(function(item,index,array){if(item.id==fileId){array.splice(index,1);}});jqueryMap.$container.find('.wf-attachment-nav').find('li').each(function(){if($(this).find('.files').attr('data-file-id')==fileId){$(this).fadeOut();}});};if(AUTOSENDFILE){confirm(I18n.resource.workflow.task.ATTACHMENT_DELETE_NOTE,function(){Spinner.spin(ElScreenContainer);WebAPI.post('/workflow/attachment/deleteByName',{fileId:fileId,uid:uid,name:fileName}).done(function(result){if(result.success){removeAttachmentLi();}}).always(function(){Spinner.stop();});});}else{confirm(I18n.resource.workflow.task.ATTACHMENT_DELETE_NOTE,function(){if(!fileId){return false;}else{removeAttachmentLi();}});}});}else{}
checkAttachmentAmount();}).close(function(file){fileUploadInstance=null;if(!stateMap.isFileUploadInNewTask&&file.length>0){stateMap.pendingFiles=[];loadTaskDetail();}});};checkAttachmentAmount=function checkAttachmentAmount(length){var $uploadArea=$('#wf-attachment-input-btn').closest('.file-add-btn');length=length||$('#wf-attachment-labelWrapper').find('.wf-attachment-nav li').length+1;if(length>=stateMap.maxUploadFileAmount){$uploadArea.hide();}else{$uploadArea.show();}};editTaskGroup=function editTaskGroup(){beop.model.stateMap.groupId=$(this).val();};onPubEvent=function onPubEvent(){var $this=$(this);var topic=$this.data('topic'),param=$this.data('param');$.spEvent.pubEvent(topic,param);};resetData=function resetData(){for(var key in stateMap.userSelectedMap){if(stateMap.userSelectedMap.hasOwnProperty(key)){stateMap.userSelectedMap[key]=[];}}
stateMap.tag_list=[];};initDatePicker=function initDatePicker(){jqueryMap.$due_time=jqueryMap.$container.find('#dueTime');jqueryMap.$due_time.datetimepicker({minView:2,format:"yyyy-mm-dd",startDate:new Date().format('yyyy-MM-dd 00:00:00'),autoclose:true});};loadTaskDetail=function loadTaskDetail(param,newTransId,isRead){if(param=="new"){jqueryMap.$wf_taskDetail_container.html("");jqueryMap.$wf_taskDetail_container.append(beopTmpl('tpl_wf_detail_new',{navigation:configMap.navigation}));jqueryMap.$wf_taskDetail_container.on('submit','form.task-new',onNewTaskSubmit);setJqueryMap();renderTagsSelector();stateMap.isFileUploadInNewTask=true;stateMap.pendingFiles=[];return $.Deferred().resolve();}else{stateMap.isFileUploadInNewTask=false;}
resetData();if(!stateMap.transId){stateMap.transId=newTransId;}
return configMap.transactions_model.getTrans(stateMap.transId).done(function(result){if(result.success){if(param=="show"){jqueryMap.$wf_taskDetail_container.html(beopTmpl('tpl_wf_detail_show',{trans:beop.model.stateMap.cur_trans,navigation:configMap.navigation}));}else if(param=="edit"){jqueryMap.$wf_taskDetail_container.html(beopTmpl('tpl_wf_detail_edit',{trans:beop.model.stateMap.cur_trans,labels:stateMap.labelList,navigation:configMap.navigation}));renderTagsSelector();}
stateMap.tag_list=beop.model.stateMap.cur_trans.tags.slice();renderTags(stateMap.tag_list);stateMap.dataDefault=Object.freeze({verifiers:result.data.verifiers,executor:[result.data.executor],watchers:result.data.watchers});setUserHasSelectedMap(result.data);I18n.fillArea($('#wf-content'));$('[data-toggle="tooltip"]').tooltip();if(window.localStorage.getItem('taskGroupID')){window.localStorage.removeItem('taskGroupID');}
beop.model.stateMap.groupId=result.data.groupid;result.data&&result.data.id&&configMap.attachmentModel.getAttachment(result.data.id).done(function(result){if(result.success){var htmlStr='';result.data.length&&result.data.forEach(function(item){htmlStr+=beopTmpl('attachment_item_templ',{file:{uid:item.uid,name:item.file,time:getAttachmentTime(item.time),icon:getAttachmentIconClassByType(item.file),url:'http://images.rnbtech.com.hk/workflow/attachment/'+item.uid+'-'+item.file,userId:item.userId,userInfo:item.userInfo}});});$('#wf-attachment-labelWrapper').find('.wf-attachment-nav').empty().html(htmlStr);checkAttachmentAmount(result.data.length);}});if(!isRead&&result.data&&result.data.isRead==0){configMap.transactions_model.updateTransactionStatus({transId:stateMap.transId,userId:AppConfig.userId}).done(function(result){if(result.success){updateStatusNumber();}});}}else{jqueryMap.$wf_taskDetail_container.html(beopTmpl('tpl_wf_detail_empty',{}));}
stateMap.type=param;loadFaultCurve();loadBottomSection();I18n.fillArea(stateMap.$container);}).fail(function(result){if(result.status===404){alert(I18n.resource.workflow.navigation.CANNOT_FIND_FILE);}});};loadFaultCurve=function loadFaultCurve(){if(beop.model.stateMap.cur_trans.chartPointList){jqueryMap.$wf_fault_curve=stateMap.$container.find('#wf-fault-curve');beop.view.faultCurve.init(jqueryMap.$wf_fault_curve);}};loadBottomSection=function loadBottomSection(){jqueryMap.$wf_detail_other_fun_wrapper=$("#wf-detail-other-fun-wrapper");jqueryMap.$wf_detail_other_fun_wrapper.html(beopTmpl('tpl_wf_detail_fun'));jqueryMap.$wf_detail_comment_nav=stateMap.$container.find("#wf-detail-comment-nav");jqueryMap.$wf_detail_progress_nav=stateMap.$container.find("#wf-detail-progress-nav");jqueryMap.$wf_detail_comment=stateMap.$container.find("#wf-detail-comment");jqueryMap.$wf_detail_progress=stateMap.$container.find("#wf-detail-progress");beop.view.replyList.init(jqueryMap.$wf_detail_comment);};setUserHasSelectedMap=function setUserHasSelectedMap(result){var executor=result.executor,verifiers=result.verifiers||[],watchers=result.watchers||[];if(executor){stateMap.userSelectedMap.executor=[{"id":executor.id,"userfullname":executor.userfullname,"username":executor.username,"userpic":executor.userpic}];}
verifiers.forEach(function(item,index,array){stateMap.userSelectedMap.verifiers.push({"id":item.id,"userfullname":item.userfullname,"username":item.username,"userpic":item.userpic});});watchers.forEach(function(item,index,array){stateMap.userSelectedMap.watchers.push({"id":item.id,"userfullname":item.userfullname,"username":item.username,"userpic":item.userpic});});};pageTaskCheck=function pageTaskCheck(){if(jqueryMap.$outline.find('input[name="title"]:visible').length){if(jqueryMap.$outline.find('input[name="title"]:visible').val().trim()===""){Alert.danger(ElScreenContainer,I18n.resource.workflow.common.TITLE_REQUIRED).showAtTop(2000);return false;}}
if(jqueryMap.$outline.find('input[name="dueDate"]:visible').length){if(jqueryMap.$outline.find('input[name="dueDate"]:visible').val().trim()===""){Alert.danger(ElScreenContainer,I18n.resource.workflow.common.DEADLINE_REQUIRED).showAtTop(2000);return false;}}
if(jqueryMap.$outline.find('textarea[name="detail"]:visible').length){if(jqueryMap.$outline.find('textarea[name="detail"]:visible').val().trim()===""){Alert.danger(ElScreenContainer,I18n.resource.workflow.common.DETAIL_REQUIRED).showAtTop(2000);return false;}}
return true;};onTaskSave=function onTaskSave(){if(pageTaskCheck()){setJqueryMap();Spinner.spin(jqueryMap.$container[0]);configMap.transactions_model.updateTrans(jqueryMap.$wf_taskDetail_form.serializeObject()).done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).always(function(){Spinner.stop();});}};onTaskDelete=function onTaskDelete(){jqueryMap.$wf_del_win.modal();jqueryMap.$wf_del_win.attr("data-type","taskItem");};onAddUserDialogOpen=function onAddUserDialogOpen(){var type=$(this).data('type');jqueryMap.$wf_added_user_list=$(this).siblings('.wf-detail-userInfoWrapper');var flag=null;if(type=='verifiers'){if(configMap.isAddNewTaskForVerifiersSelected){flag=null;}else{if(beop.model.stateMap.cur_trans&&beop.model.stateMap.cur_trans.verifiers&&beop.model.stateMap.cur_trans.verifiers.length>0){flag=1;}else{flag=null;}}}
var getUserMap=function getUserMap(){if(beop.model.stateMap.groupId){return configMap.group_model.userListByGroup(AppConfig.userId,beop.model.stateMap.groupId).done();}else{return configMap.group_model.userDialogList().done();}};getUserMap().done(function(result){if(result.success){beop.view.memberSelected.configModel({userMemberMap:result.data,cb_dialog_hide:renderAddedUsers(type),userHasSelected:stateMap.userSelectedMap[type],maxSelected:type=='executor'?1:null,maxDelete:flag,enableDeleteMember:true,enableAddMember:true});beop.view.memberSelected.init(jqueryMap.$container.parent());}});};showTaskDetail=function showTaskDetail(){var empty={};stateMap.userSelectedMap=$.extend(true,empty,stateMap.dataDefault);jqueryMap.$wf_taskDetail_form.html(beopTmpl('tpl_wf_detail_show',{trans:beop.model.stateMap.cur_trans,navigation:jqueryMap.$wf_taskDetail_form.find('.breadcrumb').find('li').eq(1).text()}));setJqueryMap();I18n.fillArea(jqueryMap.$container);$('[data-toggle="tooltip"]').tooltip();stateMap.type="show";stateMap.tag_list=[];renderTags(beop.model.stateMap.cur_trans.tags);};renderTagsSelector=function renderTagsSelector(){jqueryMap.$label_name.html(beopTmpl('tpl_wf_detail_new_tags_option',{tags:beop.model.stateMap.tag_list}));I18n.fillArea(jqueryMap.$label_name);};startTaskDetail=function startTaskDetail(){var trans_id=beop.model.stateMap.cur_trans.id,$this=$(this);Spinner.spin(jqueryMap.$container.get(0));return configMap.transactions_model.startTransaction(AppConfig.userId,trans_id).done(function(result){if(result.success){Alert.success(ElScreenContainer,I18n.resource.workflow.navigation.START_TASK_SUCCESS).showAtTop(2000);loadTaskDetail("show").done(function(){showTaskDetail();updateStatusNumber('-');});}}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.workflow.navigation.START_TASK_FAILED).showAtTop(2000);}).always(function(){Spinner.stop();});};updateStatusNumber=function updateStatusNumber(type){var $wfTransitionNumber=$('#wf-transaction-number'),$wfHasCreatorNumber=$('#wf-has-new-creator-number');var $countContainer=$('#paneWorkflow').find('span.badge'),totalCount=Number($countContainer.text()),transCount=Number($wfTransitionNumber.text());var checkTotal=function checkTotal(){if(transCount>0){$wfTransitionNumber.text(transCount);$wfHasCreatorNumber.text(transCount);}else{$wfTransitionNumber.hide();$wfHasCreatorNumber.hide();}
if(totalCount>0){$countContainer.text(totalCount);}else{$countContainer.remove();$('#iconList').find('span.badge').remove();$wfTransitionNumber.hide();$wfHasCreatorNumber.hide();}};switch(type){case'-':totalCount--;transCount--;checkTotal();break;default:totalCount--;transCount--;checkTotal();}};forwardTaskDetail=function forwardTaskDetail(){var global=beop.model.stateMap.cur_trans;var currentExecutor=global.executor;configMap.group_model.userListByGroup(AppConfig.userId,beop.model.stateMap.groupId).done(function(result){if(result.success){beop.view.memberSelected.configModel({userMemberMap:result.data,userHasSelected:[currentExecutor],maxSelected:1,enableDeleteMember:true,enableAddMember:true,cb_dialog_hide:function cb_dialog_hide(user){dealForwardExecutor(user,global);}});beop.view.memberSelected.init(jqueryMap.$container.parent());}});};dealForwardExecutor=function dealForwardExecutor(user,global){var userObject={"new":user[0],"old":global.executor};Spinner.spin(jqueryMap.$container[0]);configMap.transactions_model.updateExecutor(AppConfig.userId,global.id,userObject).done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();}).always(function(){Spinner.stop();});}});};closeTaskDetail=function closeTaskDetail(){Spinner.spin(jqueryMap.$container.get(0));var global=beop.model.stateMap.cur_trans;configMap.transactions_model.closeTask(AppConfig.userId,global.id).done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).always(function(){Spinner.stop();});};editTaskDetail=function editTaskDetail(){jqueryMap.$wf_taskDetail_form.html(beopTmpl('tpl_wf_detail_edit',{trans:beop.model.stateMap.cur_trans,labels:stateMap.labelList}));setJqueryMap();initDatePicker();I18n.fillArea(jqueryMap.$container);$('[data-toggle="tooltip"]').tooltip();stateMap.type="edit";stateMap.tag_list=beop.model.stateMap.cur_trans.tags.slice();renderTags(beop.model.stateMap.cur_trans.tags);renderTagsSelector();bindEditTaskGroup();};addTagOnPage=function addTagOnPage(tagId){if(stateMap.tag_list.length>=3){jqueryMap.$wf_labelName_error.show();return false;}
jqueryMap.$wf_labelName_error.hide();if(isExistTag(tagId)){return false;}
var tag=getTag(tagId);if(tag){stateMap.tag_list.push(tag);}};isExistTag=function isExistTag(tagId){for(var m=0;m<stateMap.tag_list.length;m++){if(stateMap.tag_list[m].id==tagId){return true;}}
return false;};removeTagOnPage=function removeTagOnPage(tagId){for(var m=0;m<stateMap.tag_list.length;m++){if(stateMap.tag_list[m].id==tagId){stateMap.tag_list.splice(m,1);}}};getTag=function getTag(tagId){for(var m=0;m<beop.model.stateMap.tag_list.length;m++){if(beop.model.stateMap.tag_list[m].id==tagId){return beop.model.stateMap.tag_list[m];}}
return null;};onAddTag=function onAddTag(){addTagOnPage($(this).val());renderTags(stateMap.tag_list);};onTagDelete=function onTagDelete(){removeTagOnPage($(this).data('id'));renderTags(stateMap.tag_list);};onNewTaskSubmit=function onNewTaskSubmit(){if(!beop.model.stateMap.group_list.length){Alert.danger(ElScreenContainer,I18n.resource.workflow.task.NO_GROUP_PROMPT).showAtTop(2000);return;}
if(pageTaskCheck()){var $form=$(this),$formData=$form.serializeObject();$formData["pendingFiles"]=[];stateMap.pendingFiles.forEach(function(item){$formData.pendingFiles.push({fileName:item.file.name,uid:item.uid});});Spinner.spin(jqueryMap.$container[0]);configMap.transactions_model.addTrans($formData).done(function(result){if(result.success){var loadTask=function loadTask(result){location.href="#page=workflow&type=transaction&transactionId="+result.data;};Spinner.stop();loadTask(result);}else{if(result.msg){Spinner.stop();Alert.danger(ElScreenContainer,'add new task fail!'+'<br/>'+result.msg).showAtTop(2000);}}}).fail(function(result){if(result.success){Alert.danger(ElScreenContainer,'add new task fail!').showAtTop(2000);Spinner.stop();}});}};onCompleteTask=function onCompleteTask(){Spinner.spin(jqueryMap.$container.get(0));configMap.transactions_model.completeTrans().done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).fail(function(result){if(result.success){Alert.danger(ElScreenContainer,'update fail!').showAtTop(2000);}}).always(function(){Spinner.stop();});};onVerifyPass=function onVerifyPass(){if($(this).hasClass('active')){return false;}
Spinner.spin(jqueryMap.$container.get(0));configMap.transactions_model.verifyPass().done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).fail(function(result){if(result.success){Alert.danger(ElScreenContainer,'update fail!').showAtTop(2000);}}).always(function(){Spinner.stop();});};onVerifyNotPass=function onVerifyNotPass(){if($(this).hasClass('active')){return false;}
Spinner.spin(jqueryMap.$container.get(0));configMap.transactions_model.verifyNotPass().done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).fail(function(result){if(result.success){Alert.danger(ElScreenContainer,'update fail!').showAtTop(2000);}}).always(function(){Spinner.stop();});};beop.view=beop.view||{};beop.view.taskDetail={configModel:configModel,loadTaskDetail:loadTaskDetail,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'',settable_map:{transactions_model:true},transactions_model:null},stateMap={chartInstance:null},jqueryMap={},setJqueryMap,configModel,init,renderChart;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container,fault){if(!$container||!$container.length){return;}
stateMap.$container=$container;stateMap.$container.show();setJqueryMap();stateMap.chartInstance=echarts.init(jqueryMap.$container.get(0));stateMap.chartInstance.showLoading({text:'loading',effect:'spin',textStyle:{fontSize:20}});var faultPromise=null;if(fault){faultPromise=configMap.transactions_model.faultCurveByParam(fault);}else{faultPromise=configMap.transactions_model.faultCurve();}
return faultPromise.done(function(result){if(result.success){renderChart(result.data);}});};renderChart=function renderChart(record){var list_description=record.description,list_value=record.value,arrXAxis=[];if(list_description.length!==list_value.length){jqueryMap.$container.hide();}
if(record.time.length>0){var result=record.time[0].split(',');result.forEach(function(item){item=timeFormat(item,timeFormatChange('yyyy-mm-dd hh:ii:ss'));arrXAxis.push(item);});}
var arrSeriesTemp=[];for(var i=0;i<list_value.length;i++){var arrDatas=[];if(i<8){var item=list_value[i];if(item){var strDatas=item.split(",");for(var j=0;j<strDatas.length;++j){arrDatas.push(parseFloat(strDatas[j]).toFixed(1));}}
arrSeriesTemp.push({name:list_description[i],type:'line',itemStyle:{normal:{lineStyle:{type:'solid'}}},data:arrDatas});}}
var option={color:['#03d5c6','#288add','#fdbf05','#f34704','#f903d9','#6d23dd','#c088f9','#2d05fb'],tooltip:{trigger:'axis',formatter:function formatter(params){if(params[0].name.length>0){var strResult=params[0].name+'<br/>';for(var i=0;i<params.length;++i){strResult+=params[i].seriesName+' : '+params[i].value;if(i!=params.length-1){strResult+='<br/>';}}}
return strResult;}},toolbox:{show:true,feature:{dataZoom:{show:true,title:{zoom:"zoom",back:"back"}}}},legend:{data:list_description,x:'center'},dataZoom:[{show:true,type:'slider',textStyle:{color:'#000'},start:41.6,end:58.4,bottom:-3}],xAxis:[{type:'category',boundaryGap:false,axisLine:{onZero:false},data:arrXAxis}],yAxis:[{type:'value',scale:true}],series:arrSeriesTemp};stateMap.chartInstance.hideLoading();stateMap.chartInstance.setOption(option);window.onresize=stateMap.chartInstance.resize;};beop.view=beop.view||{};beop.view.faultCurve={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'',settable_map:{transactions_model:true,reply_mode:true},transactions_model:null,reply_mode:null},stateMap={maxIMGWidth:$('body').width()/2,UEEditorDefaultContent:'',UEContainer:''},jqueryMap={},setJqueryMap,configModel,init,onReplySubmit,refreshReply,bindImgZoom,imgZoom,deleteReply,initUE;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_reply_table:$container.find("#wf-reply-table"),$wf_editor:$container.find('#wf-editor'),$wf_btn_reply:$container.find('#wf-btn-reply'),$wf_detail_comment:$container.find("#wf-detail-comment")};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){stateMap.$container=$container;stateMap.$container.show();setJqueryMap();configMap.transactions_model.getReply().done(function(result){if(result.success){$container.empty().html(beopTmpl('tpl_detail_reply',result));$container.find('#wf-reply-table').empty().html(beopTmpl('tpl_reply_table_body',result));setTimeout(function(){bindImgZoom('new');},0);setJqueryMap();initUE();jqueryMap.$wf_btn_reply.off().on("click",onReplySubmit);$container.find('#wf-reply-table').off('.delete-btn').on('click','.delete-btn',deleteReply);}}).always(function(){I18n.fillArea($container);});};initUE=function initUE(){var UEEditor,width=jqueryMap.$wf_editor.width();UEEditor=new UE.ui.Editor({lang:I18n.type=='zh'?'zh-cn':'en',initialFrameHeight:'250',initialFrameWidth:width,enableAutoSave:false,saveInterval:5000000000000000});UEEditor.setOpt(window.UEDITOR_CONFIG.toolbars);UEEditor.render(jqueryMap.$wf_editor.get(0));UEEditor.ready(function(){UE.insertPic(this);beop.model.stateMap.UEInstance=UEEditor;UEEditor.setContent(stateMap.UEEditorDefaultContent);});};refreshReply=function refreshReply(){configMap.transactions_model.getReply().done(function(result){if(result.success){jqueryMap.$container.find('#wf-reply-table').html(beopTmpl('tpl_reply_table_body',result));setTimeout(function(){bindImgZoom('new');},0);}});};bindImgZoom=function bindImgZoom(type){var imgList=jqueryMap.$container.find('#wf-reply-table').find('.wf-reply-info img');if(type==='new'){imgList.eq(0).off().on('load',function(){var $this=$(this);if($this.context.naturalWidth>stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css({cursor:'-webkit-zoom-in',maxWidth:'50%'});}});imgList.each(function(){var $this=$(this);if($this.context.naturalWidth>stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css({cursor:'-webkit-zoom-in',maxWidth:'50%'});}});}else{imgList.each(function(){var $this=$(this);$this.off().on('load',function(){if($this.context.naturalWidth>stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css('cursor','-webkit-zoom-in');$this.css({cursor:'-webkit-zoom-in',maxWidth:'50%'});}});});}};imgZoom=function imgZoom(ev){ev.stopPropagation();ev.preventDefault();var imgSRC=$(this).attr('src'),$body=$('body'),$htmlMask=$('<div id="wf-img-zoom" class=""><img style="cursor: -webkit-zoom-out;" src="'+imgSRC+' "/> </div>');$htmlMask.off().on('click',function(){$(this).remove();});$body.append($htmlMask);};onReplySubmit=function onReplySubmit(e){var val=$.trim(beop.model.stateMap.UEInstance.getContent());if(!val){e.preventDefault();e.stopPropagation();alert('reply can\'t be empty');}else{Spinner.spin(ElScreenContainer);configMap.reply_mode.insertReply({'detail':val}).done(function(result){if(result.success){Spinner.stop();beop.model.stateMap.UEInstance.setContent('');refreshReply();}});}};deleteReply=function deleteReply(){var $this=$(this),replyId=$this.data('reply-id');if(replyId){Spinner.spin(jqueryMap.$wf_reply_table.get(0));configMap.reply_mode.deleteReply(AppConfig.userId,{"reply_id":replyId}).done(function(result){if(result.success){Alert.success(ElScreenContainer,'删除成功').showAtTop(300);beop.view.replyList.init(jqueryMap.$container);}}).fail(function(){Alert.danger(ElScreenContainer,'删除失败').showAtTop(300);}).always(function(){Spinner.stop();});}};beop.view=beop.view||{};beop.view.replyList={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'',settable_map:{transactions_model:true},transactions_model:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){stateMap.$container=$container;stateMap.$container.show();setJqueryMap();configMap.transactions_model.getProgress().done(function(result){if(result.success){$container.html(beopTmpl('tpl_detail_progress',result));jqueryMap.$wf_detail_verticalLine=$container.find("#wf-detail-verticalLine");if($container.find("li").length>1){var height=$("#wf-detail-progress .timeLineIcon:last").offset().top-$("#wf-detail-progress .timeLineIcon:first").offset().top;jqueryMap.$wf_detail_verticalLine.css("height",height+"px");}}});};beop.view=beop.view||{};beop.view.progress={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_group_add.html',settable_map:{group_model:true,data:true,enableEdit:true,navigation:true},group_model:null,data:null,enableEdit:null,navigation:null},stateMap={usersMap:{},addedUserList:[]},jqueryMap={},setJqueryMap,configModel,init;var getGroupData,setEditJqueryMap,renderAddedUsers,onAddUserDialogOpen,onSubmit;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$add_group_form:$container.find('#wf-add-group-form'),$add_user_dialog:$container.parent().find('#wf-add-person'),$wf_added_user_list:$container.find('.wf-added-user-list'),$wf_add_edit_title:$container.find('#wf-group-addOrEdit'),$wf_task_group:$container.parent().find('#wf-task-group')};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){stateMap.$container=$container;Spinner.spin($container.get(0));WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();getGroupData().done(function(result){if(result.success){jqueryMap.$add_group_form.html(beopTmpl('tpl_wf_group_edit',{data:result.data,enableEdit:configMap.enableEdit,navigation:configMap.navigation}));setEditJqueryMap();jqueryMap.$container.find('.wf-people-add').off().click(onAddUserDialogOpen);if(configMap.enableEdit){jqueryMap.$wf_add_edit_title.attr('i18n','workflow.task.EDIT_TASK_GROUP');jqueryMap.$add_group_form.submit(onSubmit).find('button.wf-btn-add-group').attr('i18n','workflow.task.EDIT_TASK_GROUP_BTN;value=workflow.task.EDIT_TASK_GROUP_BTN;title=workflow.task.EDIT_TASK_GROUP_BTN');}else{jqueryMap.$wf_add_edit_title.attr('i18n','workflow.task.SEE_TASK_GROUP_INFO');}
jqueryMap.$wf_added_user_list=jqueryMap.$container.find('.wf-added-user-list');jqueryMap.$workflowMemberContainer.html(beopTmpl('tpl_wf_added_member',{members:result.data.members}));beop.view.memberSelected.configModel({maxSelected:null,userHasSelected:result.data.members});}}).fail(function(){Alert.danger(ElScreenContainer,'Got Data Failed').showAtTop(300);}).always(function(result){if(result.msg){Alert.danger(ElScreenContainer,result.msg).showAtTop(300);}
I18n.fillArea(jqueryMap.$container);Spinner.stop();});});};setEditJqueryMap=function setEditJqueryMap(){jqueryMap.$workflowMemberContainer=jqueryMap.$container.find('#wf-workflow-memberList');};renderAddedUsers=function renderAddedUsers(addedUserList){jqueryMap.$wf_added_user_list.html(beopTmpl('tpl_wf_added_member',{members:addedUserList}));};getGroupData=function getGroupData(){return configMap.group_model.getGroupData(configMap.data.param);};onAddUserDialogOpen=function onAddUserDialogOpen(){configMap.group_model.userDialogList().done(function(result){if(result.success){beop.view.memberSelected.configModel({cb_dialog_hide:renderAddedUsers,userMemberMap:result.data,maxSelected:null});beop.view.memberSelected.init(jqueryMap.$container.parent());}});};onSubmit=function onSubmit(){var $form=$(this),i18n=I18n.resource.workflow.common;var title_val=$form.find('input[name="name"]').val().trim(),detail_val=$form.find('textarea[name="description"]').val().trim();if(title_val===""){Alert.danger($form,i18n.GROUP_NAME_REQUIRED).showAtTop(2000);return;}
if(detail_val===""){Alert.danger($form,i18n.DETAIL_REQUIRED).showAtTop(2000);return;}
Spinner.spin(jqueryMap.$wf_task_group.get(0));configMap.group_model.editGroup(configMap.data.param,$form.serializeObject()).done(function(result){if(result.success){Alert.success(ElScreenContainer,i18n_resource.workflow.task.EDIT_GROUP_SUCCESS).showAtTop(2000);beop.view.menu_group_list.configModel({whereComeFrom:'default'});beop.view.menu_group_list.init(jqueryMap.$wf_task_group);Spinner.stop();}});};beop.view.groupEdit={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'',settable_map:{group_model:true,whereComeFrom:true},group_model:null,whereComeFrom:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init,bindCalendarEvents,onGroupTypeChange,onToggleGroup;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$group_ul:$container.find('#wf-task-groups'),$group_type_selector:$container.find('#wf-group-type')};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container,type){stateMap.$container=$container;setJqueryMap();if(configMap.whereComeFrom=='calendar'){return configMap.group_model.getUserGroups().done(function(result){jqueryMap.$group_ul.html(beopTmpl('tpl_wf_group_list_calendar',result.data));jqueryMap.$group_type_selector.on('change',onGroupTypeChange);I18n.fillArea(jqueryMap.$container);});}else if(configMap.whereComeFrom=='default'){return configMap.group_model.getUserGroups().done(function(result){if(type=="taskProject"){result.data.hashHrefType="taskProject";}else{result.data.hashHrefType="transaction";}
jqueryMap.$group_ul.html(beopTmpl('tpl_wf_group_list',result.data));jqueryMap.$edit_group=jqueryMap.$container.find('.edit-group');jqueryMap.$edit_group.off().on('click',onToggleGroup);I18n.fillArea(jqueryMap.$container);jqueryMap.$group_type_selector.on('change',onGroupTypeChange);});}};onToggleGroup=function onToggleGroup(){var $this=$(this);var $editPanel=$this.closest(".group-item").find(".wf-group-edit");$this.closest('#wf-task-groups').find('.wf-group-edit').not($editPanel).hide();$editPanel.toggle();};onGroupTypeChange=function onGroupTypeChange(){var $this=$(this);if($this.val()==0){jqueryMap.$group_ul.find('li').show();}else{jqueryMap.$group_ul.find('li').not('.wf-get-crumbs').hide();jqueryMap.$group_ul.find('li[grouptype='+$this.val()+']').show();}
jqueryMap.$group_ul.find('.wf-group-edit').hide();};beop.view=beop.view||{};beop.view.menu_group_list={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'',settable_map:{tags_model:true,whereComeFrom:true},tags_model:null,whereComeFrom:null},stateMap={labelTagList:[],tagDataList:{update:[],new:[]}},jqueryMap={},setJqueryMap,configModel,init,onToggleUl,onLabelEdit,onLabelPlus,onLabelDelete,progressData,resetTagDataList,sendDataToBack,restoreEditStatus;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$wrapper:$("#wf-outline"),$wf_label_form:$("#wf-label-form"),$wf_label_edit:$("#wf-label-edit"),$wf_label_plus:$("#wf-label-plus"),$wf_label_icon_wrapper:$("#wf-label-icon-wrapper"),$container:$container};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){stateMap.$container=$container;setJqueryMap();restoreEditStatus();configMap.tags_model.getUserTags().done(function(result){if(result.data){stateMap.labelTagList=result.data;stateMap.$container.html(beopTmpl('tpl_wf_tags_list_text',{labels:stateMap.labelTagList}));}
jqueryMap.$wrapper.off('click.wf-label-toggle').on('click.wf-label-toggle','#wf-label-toggle',onToggleUl);jqueryMap.$wrapper.off('click.wf-label-edit').on('click.wf-label-edit','#wf-label-edit',onLabelEdit);jqueryMap.$wrapper.off('click.wf-label-plus').on('click.wf-label-plus','#wf-label-plus',onLabelPlus);jqueryMap.$wrapper.off('click.wf-label-delete').on('click.wf-label-delete','.wf-label-delete',onLabelDelete);}).fail(function(result){}).always(function(){I18n.fillArea(jqueryMap.$container);});};resetTagDataList=function resetTagDataList(){stateMap.tagDataList.new=[];stateMap.tagDataList.update=[];};onToggleUl=function onToggleUl(){var $this=$(this);if($this.hasClass("wf-tags-ul-hide")){jqueryMap.$container.show();jqueryMap.$wf_label_icon_wrapper.show();$this.removeClass("wf-tags-ul-hide").addClass("wf-tags-ul-show");}else if($this.hasClass("wf-tags-ul-show")){jqueryMap.$container.hide();jqueryMap.$wf_label_icon_wrapper.hide();$this.removeClass("wf-tags-ul-show").addClass("wf-tags-ul-hide");}};restoreEditStatus=function restoreEditStatus(){jqueryMap.$wrapper.find('#wf-label-edit').removeClass("glyphicon-ok-circle").addClass("glyphicon-edit");jqueryMap.$wf_label_plus.hide();jqueryMap.$container.hide();jqueryMap.$wf_label_icon_wrapper.hide();jqueryMap.$wrapper.find('#wf-label-toggle').removeClass("wf-tags-ul-show").addClass("wf-tags-ul-hide");};onLabelEdit=function onLabelEdit(){var $this=$(this);if($this.hasClass("glyphicon-edit")){$this.removeClass("glyphicon-edit").addClass("glyphicon-ok-circle");jqueryMap.$wf_label_plus.show();stateMap.$container.html(beopTmpl('tpl_wf_tags_list_input',{labels:stateMap.labelTagList}));stateMap.$container.find('input').off().on('focus',function(){$(this).select();});}else{sendDataToBack().done(function(){configMap.tags_model.getUserTags().done(function(result){if(result.data){stateMap.labelTagList=result.data;stateMap.$container.html(beopTmpl('tpl_wf_tags_list_text',{labels:stateMap.labelTagList}));}}).always(function(){jqueryMap.$wf_label_plus.hide();$this.removeClass("glyphicon-ok-circle").addClass("glyphicon-edit");Spinner.stop();I18n.fillArea(jqueryMap.$container);}).fail(function(){Alert.danger(ElScreenContainer,'Edit Tags Failed').showAtTop(300);});}).fail(function(){Alert.danger(ElScreenContainer,'Edit Tags To DATABASE Failed').showAtTop(300);}).always(function(){Spinner.stop();});}};onLabelPlus=function onLabelPlus(){jqueryMap.$container.append(beopTmpl('tpl_wf_tags_list_input_empty'));jqueryMap.$wf_label_form.scrollTop(3000);I18n.fillArea($(ElScreenContainer));};onLabelDelete=function onLabelDelete(){var $this=$(this);if($(this).closest(".wf-label-li").attr("labelId")){Spinner.spin(jqueryMap.$container.get(0));configMap.tags_model.deleteTag({'user_id':AppConfig.userId,'tag_id':$(this).closest(".wf-label-li").attr("labelId")}).done(function(result){if(result.data){stateMap.labelTagList=result.data;}}).fail(function(result){}).always(function(){Spinner.stop();});}
$this.closest(".wf-label-li").remove();};progressData=function progressData(){Spinner.spin(jqueryMap.$container.get(0));jqueryMap.$wf_lable_list=jqueryMap.$container.find('li');var updateList=jqueryMap.$container.find("li[labeltype!='new']"),newTagList=jqueryMap.$container.find("li[labeltype='new']");resetTagDataList();if(newTagList.length!==0){newTagList.each(function(){var $this=$(this),value=$.trim($this.find('input').val());if(value!==''){stateMap.tagDataList.new.push({name:value,color:"#fff"});}});}
updateList.each(function(){var $this=$(this),value=$.trim($this.find('input').val()),id=$this.attr('labelid');stateMap.labelTagList.forEach(function(item,index,array){if(id==$.trim(item.id)){if($.trim(item.name)!==value){stateMap.tagDataList.update.push({id:$.trim($this.attr('labelid')),name:value,color:"#fff"});}}});});};sendDataToBack=function sendDataToBack(){progressData();var UserID=AppConfig.userId;var updateTagsLength=stateMap.tagDataList.update.length,newTagsLength=stateMap.tagDataList.new.length;if(updateTagsLength==0&&newTagsLength==0){return $.Deferred().resolve();}
function updateTag(){if(updateTagsLength!==0){return configMap.tags_model.editTag({user_id:UserID},stateMap.tagDataList.update).fail(function(){});}else{return true;}}
function addNewTag(){if(newTagsLength!==0){return configMap.tags_model.addTag({user_id:UserID},stateMap.tagDataList.new).fail(function(){});}else{return true;}}
return $.when(addNewTag(),updateTag()).then(function(){});};beop.view=beop.view||{};beop.view.menu_tag_list={configModel:configModel,init:init};})(beop||(beop={}));var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function(beop){var configMap={htmlURL:'/static/views/workflow/task_team.html',settable_map:{team_model:true},team_model:null,spEventActivities:{}},stateMap={hasTeamFlag:false,team:null,process_select_person:null,user_type:'',TEAM:{name:'',desc:'',tags:[],teamStructure:[],teamProcess:[]}},jqueryMap={},setJqueryMap,configModel,init,wfTeamEdit,wfTeamEditConfirm,wfDeleteItem,wfDeleteTeam,wfTeamShow,wfProcessCreateFinish,wfTeamCreateConfirm,wfTeamEditCancel,wfTeamCreatePage,returnAddTeamPage;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_team_wrapper:$("#wf_team_wrapper"),$wf_add_team:$("#wf_add_team"),$wf_team_no_join:$("#wf_team_no_join"),$wf_team_edit:$("#wf_team_edit"),$wf_team_edit_confirm:$("#wf_team_edit_confirm"),$wf_team_create_confirm:$("#wf_team_create_confirm"),$wf_team_tags_wrapper_box:$("#wf_team_tags_wrapper_box"),$team_structure_box:$("#team_structure_box"),$wf_team_process:$("#wf_team_process"),$delete_team:$("#delete_team"),$wf_team_edit_cancel:$("#wf_team_edit_cancel"),$wf_team_create_cancel:$("#wf_team_create_cancel"),$wfTeamProcessContainer:null};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container){Spinner.stop();stateMap.$container=$container;stateMap.$container.off('click.wf_team_edit').on('click.wf_team_edit','#wf_team_edit',wfTeamEdit);stateMap.$container.off('click.wf_team_edit_confirm').on('click.wf_team_edit_confirm','#wf_team_edit_confirm',wfTeamEditConfirm);stateMap.$container.off('click.wf-delete').on('click.wf-delete','.wf-delete',wfDeleteItem);stateMap.$container.off('click.wf_add_team').on('click.wf_add_team','#wf_add_team',wfTeamCreatePage);stateMap.$container.off('click.delete_team').on('click.delete_team','#delete_team',wfDeleteTeam);stateMap.$container.off('click.wf_process_create_finish').on('click.wf_process_create_finish','#wf_process_create_finish',wfProcessCreateFinish);stateMap.$container.off('click.wf_team_create_confirm').on('click.wf_team_create_confirm','#wf_team_create_confirm',wfTeamCreateConfirm);stateMap.$container.off('click.wf_team_edit_cancel').on('click.wf_team_edit_cancel','#wf_team_edit_cancel',wfTeamEditCancel);stateMap.$container.off('click.wf_team_create_cancel').on('click.wf_team_create_cancel','#wf_team_create_cancel',returnAddTeamPage);return WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();return configMap.team_model.getTeam().done(function(result){if(result.success){var team=result.data.team;stateMap.team=team;stateMap.user_type=result.data.user_type;if(team){wfTeamShow('show');}else{jqueryMap.$wf_team_wrapper.empty().html(beopTmpl('tpl_wf_team_none'));}}});});};returnAddTeamPage=function returnAddTeamPage(){jqueryMap.$wf_team_wrapper.empty().html(beopTmpl('tpl_wf_team_none'));};wfTeamEdit=function wfTeamEdit(){wfTeamShow('edit');};wfDeleteTeam=function wfDeleteTeam(){WebAPI.get('workflow/team/delete/'+$('.wf_team_box').attr('team_id')).done(function(result){if(result){jqueryMap.$wf_team_wrapper.empty().html(beopTmpl('tpl_wf_team_none'));alert("删除团队成功");}});};wfTeamEditCancel=function wfTeamEditCancel(){return configMap.team_model.getTeam().done(function(result){if(result.success){var team=result.data.team;stateMap.team=team;stateMap.user_type=result.data.user_type;wfTeamShow('show');}});};wfTeamEditConfirm=function wfTeamEditConfirm(){var formData=$('#wf_team_edit_form').serializeObject(),tags=formData['tags[]'];if(!tags){infoBox.alert('一个团队必须包含一个标签');return false;}
var data={name:formData.name,desc:formData.des,tags:formData['tags[]'],teamMember:beop.view.structure.getStructure(),process:beop.view.teamProcess.getTeamProcess(),creator:AppConfig.userId,teamId:$('.wf_team_box').attr('team_id')};WebAPI.post('workflow/team/edit',data).done(function(result){if(result.success){return configMap.team_model.getTeam().done(function(result){if(result.success){var team=result.data.team;stateMap.team=team;stateMap.user_type=result.data.user_type;wfTeamShow('show');}});}});};wfProcessCreateFinish=function wfProcessCreateFinish(){};wfTeamCreateConfirm=function wfTeamCreateConfirm(){var formData=$('#wf_team_create_form').serializeObject(),tags=formData['tags[]'];if(!tags){infoBox.alert('请填写标签名');return false;}
var data={name:formData.name,desc:formData.des,tags:formData['tags[]'],teamMember:beop.view.structure.getStructure(),process:beop.view.teamProcess.getTeamProcess(),creator:AppConfig.userId};data.process.forEach(function(process){delete process.isNewProcess;process.nodes.forEach(function(node){node.arch_type=node.arch_type.type;});});WebAPI.post('workflow/team/new',data).done(function(result){if(result.success){var team=result.data.team;stateMap.team=team;stateMap.user_type=result.data.user_type;if(team){wfTeamShow('show');}}});};wfTeamShow=function wfTeamShow(viewType){var user_type;if(stateMap.user_type===1){user_type='super_admin';}else if(stateMap.user_type===2){user_type='admin';}else{user_type='common';}
jqueryMap.$wf_team_wrapper.empty().html(beopTmpl('tpl_wf_team_'+viewType,{'user_type':user_type,'team':stateMap.team}));setJqueryMap();beop.view.teamTagsCurd.init(jqueryMap.$wf_team_tags_wrapper_box,stateMap.team.tags,viewType);beop.view.structure.init(jqueryMap.$team_structure_box,stateMap.team.arch,viewType);stateMap.team.process.forEach(function(item){item.nodes.forEach(function(node){if(_typeof(node.arch_type)!='object'){var arch_id=node.arch_id;stateMap.team.arch.forEach(function(arch){if(arch.id==arch_id){node.arch_type={type:node.arch_type,name:arch.name};return true;}});}});});beop.view.teamProcess.init(jqueryMap.$wf_team_process,stateMap.team.process,viewType);};wfTeamCreatePage=function wfTeamCreatePage(){jqueryMap.$wf_team_wrapper.empty().html(beopTmpl('tpl_wf_team_create'));setJqueryMap();beop.view.teamTagsCurd.init(jqueryMap.$wf_team_tags_wrapper_box,[],'create');beop.view.structure.init(jqueryMap.$team_structure_box,[],'create');beop.view.teamProcess.init(jqueryMap.$wf_team_process);};wfDeleteItem=function wfDeleteItem(){$(this).closest('.wf-delete-parent').remove();};beop.view=beop.view||{};beop.view.team={configModel:configModel,init:init};})(beop||(beop={}));(function(beop){var configMap={htmlURL:'/static/views/workflow/taskTeamProcess.html',settable_map:{transactions_model:true,members_load:$.noop},transactions_model:null,members_load:$.noop},stateMap={type:'',currentProcessClone:[],processList:[],teamProcessUserMap:[],teamProcessUserGroupRole:[],teamProcessUserBehaviorType:[1,2]},jqueryMap={},setJqueryMap,configModel,init;var addProcess,confirmProcess,wfDeleteProcessItem,addProcessItem,renderAddedUsersToProcess,addPeopleToProcessDialog,bindEvents,onProcessModalOpen,onProcessModalClose,closeProcessModal,refreshModelView,editProcess,removeProcess;var addProcessItemFromId,removeProcessItemFromId,removeProcessFromId,refreshProcessItemFromId,bindLabelChangeEvent,getUserHasSelected,getTeamProcessUserMap;var getTeamProcess,getTeamProcessInitData;var defaultProcess=[];setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap={$container:$container,$taskTeamProcessContainer:$container.find('#taskTeamProcessContainer'),$wf_add_process_win:$container.find("#wf_add_process_win"),$wf_process_item_box:$container.find('#wf_process_item_box'),$processModal:$container.find('#wf_process_box'),process_select_person_box:null};};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};getTeamProcess=function getTeamProcess(){return stateMap.processList;};init=function init($container,data,type){stateMap.$container=$container;stateMap.processList=[];data?stateMap.processList=data:stateMap.processList=[];stateMap.type=type;Spinner.spin(stateMap.$container.get(0));stateMap.$container.off('click.wf_add_process').on('click.wf_add_process','#wf_add_process',addProcess);stateMap.$container.off('click.wf-add-process-item').on('click.wf-add-process-item','.wf-add-process-item',addProcessItem);stateMap.$container.off('click.wf-delete-process-item').on('click.wf-delete-process-item','.wf-delete-process-item',wfDeleteProcessItem);stateMap.$container.off('click.add-people-to-process').on('click.add-people-to-process','.add-people-to-process',addPeopleToProcessDialog);stateMap.$container.off('click.edit-process').on('click.edit-process','.wf_team_process_edit',editProcess);stateMap.$container.off('click.remove-process').on('click.wf_team_process_remove','.wf_team_process_remove',removeProcess);WebAPI.get(configMap.htmlURL).done(function(html){getTeamProcessInitData().done(function(result){stateMap.processList=result;stateMap.$container.empty().html(html);setJqueryMap();refreshModelView();bindEvents();});}).always(function(){Spinner.stop();});};refreshModelView=function refreshModelView(){jqueryMap.$taskTeamProcessContainer.empty().html($(beopTmpl('wf_task_process',{process:defaultProcess.concat(stateMap.processList),viewType:stateMap.type})).fadeIn(function(){I18n.fillArea(jqueryMap.$container);}));};bindEvents=function bindEvents(){jqueryMap.$wf_add_process_win.off().on('hide.bs.modal',function(ev){onProcessModalClose(ev);}).on('show.bs.modal',function(ev){onProcessModalOpen(ev);}).find('.closeProcessModal').off().click(function(){closeProcessModal();});jqueryMap.$wf_add_process_win.find('#wf_process_name').off().keyup(function(){var $parent=$(this).closest('#wf_process_box'),exitsId=$parent.attr('data-process-id'),id,name=$(this).val();if(name==""&&!exitsId)return;if(exitsId){stateMap.processList.forEach(function(item){if(item._id&&item._id==exitsId){item.name=name;}});}else{id=ObjectId();$parent.attr('data-process-id',id);stateMap.processList.push({"_id":id,"name":name,"nodes":[],"type":1,"isNewProcess":true});addProcessItem();$('#wf_process_nodes').show();}});jqueryMap.$wf_add_process_win.find('#wf_process_create_finish').off().click(function(ev){var $target=$(ev.target),processId=$target.closest('#wf_process_box').attr('data-process-id'),isSuccess=true;stateMap.processList.forEach(function(item){if(item._id&&item._id==processId){item.nodes.forEach(function(nodes){isSuccess=Object.keys(nodes.arch_type).length&&nodes.behaviour;if(!isSuccess){return true;}});}});if(isSuccess){refreshModelView();jqueryMap.$wf_process_item_box.empty();jqueryMap.$wf_add_process_win.modal('hide');}else{infoBox.alert('还有尚未填写完成的流程!');return false;}});};bindLabelChangeEvent=function bindLabelChangeEvent(){jqueryMap.$wf_add_process_win.find('select').off().change(function(){var $this=$(this),$parent=$this.closest('label'),childId=$this.closest('.wf_process_item').attr('data-process-item-id'),type=$parent.attr('data-type'),parentId=$this.closest('#wf_process_box').attr('data-process-id');if(type=='arch_type'){refreshProcessItemFromId(parentId,childId,type,{type:$this.val(),name:$this.find("option:selected").text()});}else{refreshProcessItemFromId(parentId,childId,type,$this.val());}});};getTeamProcessUserMap=function getTeamProcessUserMap(){stateMap.teamProcessUserMap=[];stateMap.teamProcessUserGroupRole=[];var memberIdList=[];configMap.members_load().forEach(function(item){stateMap.teamProcessUserGroupRole.push({type:item.type,name:item.name});item.members.forEach(function(member){if(memberIdList.indexOf(member.id)===-1){stateMap.teamProcessUserMap.push({id:member.id,useremail:member.useremail,userfullname:member.userfullname,userpic:member.userpic,type:item.type});memberIdList.push(member.id);}});});};addProcess=function addProcess(){I18n.fillArea(jqueryMap.$wf_add_process_win);getTeamProcessUserMap();jqueryMap.$processModal.attr('data-process-id','');jqueryMap.$wf_add_process_win.modal({keyboard:false,backdrop:'static'});jqueryMap.$processModal.attr('data-type','new');bindLabelChangeEvent();};editProcess=function editProcess(){var id=$(this).closest('li').attr('data-process-id');if(id){I18n.fillArea(jqueryMap.$wf_add_process_win);jqueryMap.$processModal.attr('data-process-id',id);jqueryMap.$wf_add_process_win.modal({keyboard:false,backdrop:'static'});var data={};stateMap.processList.forEach(function(item){if(item._id&&item._id==id){data=item;return true;}});jqueryMap.$processModal.attr('data-type','edit');$('#wf_process_nodes').show();jqueryMap.$processModal.find('#wf_process_name').val(data.name);getTeamProcessUserMap();jqueryMap.$wf_process_item_box.append($(beopTmpl('tpl_wf_team_process_nodes',{nodes:data.nodes,teamProcessUserGroupRole:stateMap.teamProcessUserGroupRole})).fadeIn());bindLabelChangeEvent();stateMap.currentProcessClone=[];data.nodes.forEach(function(item){stateMap.currentProcessClone.push($.extend(true,[],item));});}else{infoBox.alert('当前process没有id');}};removeProcess=function removeProcess(){var id=$(this).closest('li').attr('data-process-id');if(id){removeProcessFromId(id);refreshModelView();}else{infoBox.alert('当前process没有id');}};confirmProcess=function confirmProcess(){jqueryMap.$wf_add_process_win.modal('hide');};addProcessItem=function addProcessItem(){if(jqueryMap.$wf_process_item_box.find('.wf_process_item').length<6){var parentId=jqueryMap.$processModal.attr('data-process-id'),childId=ObjectId();jqueryMap.$wf_process_item_box.append($(beopTmpl('tpl_wf_add_process_one',{teamProcessUserGroupRole:stateMap.teamProcessUserGroupRole,teamProcessUserBehaviorType:stateMap.teamProcessUserBehaviorType})).attr('data-process-item-id',childId).fadeIn());addProcessItemFromId(parentId,childId);bindLabelChangeEvent();}else{alert('创建流程最多包含6项');}};wfDeleteProcessItem=function wfDeleteProcessItem(){if(jqueryMap.$wf_process_item_box.find('.wf_process_item').length>1){removeProcessItemFromId($(this).closest('.wf_process_box').attr('data-process-id'),$(this).closest('.wf_process_item').attr('data-process-item-id'));$(this).closest('.wf_process_item').remove();}else{alert('创建流程最少包含一项');}};getTeamProcessInitData=function getTeamProcessInitData(){var $def=$.Deferred();if((stateMap.type=='show'||stateMap.type=='edit')&&stateMap.processList){$def.resolve(stateMap.processList);}else{$def.resolve([]);}
return $def;};removeProcessFromId=function removeProcessFromId(id){stateMap.processList.forEach(function(item,index,array){if(item._id&&item._id==id){array.splice(index,1);}});};removeProcessItemFromId=function removeProcessItemFromId(parentId,childId){stateMap.processList.forEach(function(item){if(item._id){if(item._id==parentId){item.nodes.forEach(function(nodes,index,array){if(nodes.arch_id==childId){array.splice(index,1);}});}}else{console.error('当前process item 没有 arch_id !');}});};addProcessItemFromId=function addProcessItemFromId(parentId,childId){stateMap.processList.forEach(function(item,index,array){if(item._id){if(item._id==parentId){item.nodes.push({"arch_id":childId,"arch_type":{},"behaviour":"","members":[]});}}else{console.error('当前process item 没有 _id !');}});};refreshProcessItemFromId=function refreshProcessItemFromId(parentId,childId,type,nodeValue){stateMap.processList.forEach(function(item,index,array){if(item._id&&item._id==parentId){if(item.nodes){item.nodes.forEach(function(nodesItem){if(nodesItem.arch_id){if(nodesItem.arch_id==childId){nodesItem[type]=nodeValue;if(type=='members'){console.info('指定到人');}else if(type=="arch_type"){nodesItem.arch_type={type:nodeValue.type,"name":nodeValue.name};}}}else{console.error('当前process item nodes 没有 arch_id !');}});}else{console.error('当前process item 没有 nodes !');}}});};onProcessModalClose=function onProcessModalClose(ev){};onProcessModalOpen=function onProcessModalOpen(ev){$('#wf_process_nodes').hide();jqueryMap.$processModal.find('#wf_process_name').val('');};closeProcessModal=function closeProcessModal(){var id=jqueryMap.$processModal.attr('data-process-id'),type=jqueryMap.$processModal.attr('data-type');infoBox.confirm("关闭后将会失去已经配置好的流程，确定关闭？",function(){jqueryMap.$wf_add_process_win.modal('hide');jqueryMap.$processModal.attr('data-process-id','');jqueryMap.$wf_process_item_box.empty();if(id){if(type=='new'){removeProcessFromId(id);}else if(type=='edit'){stateMap.processList.forEach(function(item){if(item._id==id){item.nodes=[];stateMap.currentProcessClone.forEach(function(clone){item.nodes.push(clone);});}});refreshModelView();}}},function(){return false;});};getUserHasSelected=function getUserHasSelected(parentId,childId){var userHasSelected=[];stateMap.processList.forEach(function(item){if(item._id&&item._id==parentId){item.nodes.forEach(function(nodes){if(nodes.arch_id&&nodes.arch_id==childId){if(nodes.arch_type==0){userHasSelected=false;return true;}else{userHasSelected=nodes.members||[];return true;}}});}});return userHasSelected;};addPeopleToProcessDialog=function addPeopleToProcessDialog(ev){var $el=$(ev.target);var parentId=$el.closest('.wf_process_box').attr('data-process-id'),childId=$el.closest('.wf_process_item').attr('data-process-item-id');var userHasSelectedMap=getUserHasSelected(parentId,childId);if(userHasSelectedMap){jqueryMap.process_select_person_box=$el.closest('.wf_process_item').find('.add-person-to-process-box');beop.view.memberSelected.configModel({userMemberMap:stateMap.teamProcessUserMap,cb_dialog_hide:renderAddedUsersToProcess(parentId,childId),maxSelected:null,userHasSelected:userHasSelectedMap});beop.view.memberSelected.init($('#wf-outline'));}else{alert('请先指定人员类型然后进行选人');}};renderAddedUsersToProcess=function renderAddedUsersToProcess(parentId,childId){return function(addedUserList){jqueryMap.process_select_person_box.html(beopTmpl('tpl_wf_added_member',{members:addedUserList}));refreshProcessItemFromId(parentId,childId,'members',addedUserList);};};beop.view=beop.view||{};beop.view.teamProcess={configModel:configModel,init:init,getTeamProcess:getTeamProcess};})(beop||(beop={}));var WorkflowCalendar=function(){function WorkflowCalendar(){this.noticeList=[];this.eventType={'notice':1,'workflow':2};this.currentEvent=null;this.currentElement=null;this.$calendar=null;this.displayType=2;this.oldColor=null;this.addedNoticedMap={};this.$dateTimePicker=null;this.isManager=false;this.DOMDone=null;this.noticePromiseMap={};this.projectId=window.localStorage.getItem('calendarDefault')==null?AppConfig.projectList[0].id:window.localStorage.getItem('calendarDefault');this.firstRender=true;this.equipments_list=[];this.zones_list=[];this.currentPage=1;this.pageSize=20;this.overdue_type='all';this.user_level='all';this.fault_time_type='all';}
WorkflowCalendar.prototype={show:function show(wrapper,dateTimePicker){var _this=this;$.get("/static/views/workflow/calendar.html").done(function(resultHtml){if(wrapper){var arr=resultHtml.split('<div class="datetimepicker-container"></div>'),html='';for(var i=0;i<arr.length;i++){html+=arr[i];}
$(wrapper).html(html);_this.isManager=true;}else{$(ElScreenContainer).html(resultHtml);}
_this.$dateTimePicker=$(dateTimePicker).length==1?$(dateTimePicker):$('.datetimepicker-container');setTimeout(function(){_this.DOMDone&&_this.DOMDone();Spinner.spin($('#events')[0]);},0);_this.init();I18n.fillArea($("#wrap"));});return this;},close:function close(){this.resetVariable();this.detachEvents();},resetVariable:function resetVariable(){this.noticeList=[];this.equipments_list=[];this.zones_list=[];this.currentPage=1;this.overdue_type='all';this.user_level='all';this.fault_time_type='all';},refreshPage:function refreshPage(){},Done:function Done(func){this.DOMDone=func;},init:function init(){this.$calendar=$('#calendar');this.renderProjectSelector();this.attachEvent();if(window.localStorage.calendarDefault){$('.project-selector').val(window.localStorage.calendarDefault);}},renderProjectSelector:function renderProjectSelector(){var $projectSelector=$('.project-selector');for(var m=0;m<AppConfig.projectList.length;m++){var projectItem=AppConfig.projectList[m];var projectName=StringUtil.getI18nProjectName(projectItem);$projectSelector.append('<option value="'+projectItem.id+'">'+projectName+'</option>');}},paginationRefresh:function paginationRefresh(totalNum){var _this=this;var totalPages=Math.ceil(totalNum/_this.pageSize);if(!totalNum){return;}
$("#paginationWrapper").empty().html('<ul id="pool-pagination" class="pagination fr"></ul>');while(totalPages<_this.currentPage&&_this.currentPage>1){_this.currentPage=_this.currentPage-1;}
var pageOption={first:'&laquo;&laquo',prev:'&laquo;',next:'&raquo;',last:'&raquo;&raquo;',startPage:_this.currentPage?_this.currentPage:1,totalPages:!totalPages?1:totalPages,onPageClick:function onPageClick(event,page){_this.currentPage=page;_this.fetchNoticesData(true);}};if(_this.currentPage){pageOption['startPage']=_this.currentPage?_this.currentPage:1;}
$("#pool-pagination").twbsPagination(pageOption);},fetchNoticesData:function fetchNoticesData(force){var $paginationWrapper=$("#paginationWrapper");Spinner.spin($('#events')[0]);var _this=this;var projectID=window.localStorage.getItem('calendarDefault')==null?this.projectId:window.localStorage.getItem('calendarDefault');if(force){this.noticePromiseMap[projectID]=null;}
var noticePromise=this.noticePromiseMap[projectID];if(!noticePromise){noticePromise=$.getJSON('/diagnosis/getRealtimeFaultPoints/'+projectID+'/'+_this.overdue_type+'/'+_this.user_level+'/'+_this.fault_time_type+'/'+_this.currentPage+'/'+_this.pageSize);this.noticePromiseMap[projectID]=noticePromise;}
var dfd=$.Deferred();noticePromise.done(function(faultsResult){var faults=faultsResult.dataFaults;var total=faultsResult.total;if(Array.isArray(faults)){if(faults.length){var dataDealWith=function dataDealWith(){var noticesList=[];faults.forEach(function(faultsItem,index,array){var equipment={},zone={},zoneId=undefined;var equipmentId=faultsItem.equipmentId;_this.equipments_list.forEach(function(equipments,index,array){if(equipmentId==equipments.id){equipment=equipments;zoneId=equipment.zoneId;_this.zones_list.forEach(function(zones,index,array){if(zoneId==zones.id){zone=zones;}});return true;}});noticesList.push({project:projectID,id:faultsItem.id,equipmentId:equipmentId,zoneId:zoneId,time:faultsItem.time,fault:{points:faultsItem.points,name:faultsItem.name,userFaultGrade:faultsItem.grade,description:faultsItem.description,equipment:equipment?$.extend(true,{},equipment,{zone:zone}):{}}});});_this.noticeList=noticesList;_this.paginationRefresh(total);_this.renderNoticeList();$paginationWrapper.show();dfd.resolve();};if(_this.equipments_list&&_this.equipments_list.length){dataDealWith();}else{$.getJSON('/diagnosis/getStruct/'+projectID).done(function(data){_this.equipments_list=data.equipments;_this.zones_list=data.zones;dataDealWith();}).fail(function(){dfd.reject();});}}else{_this.noticeList=[];$("#taskPoolContent").html("");_this.paginationRefresh(1);$paginationWrapper.hide();dfd.resolve();}}else{_this.noticeList=[];$("#taskPoolContent").html("");_this.paginationRefresh(1);$paginationWrapper.hide();dfd.resolve();}}).fail(function(){dfd.reject();}).always(function(){Spinner.stop();});return dfd;},renderNoticeList:function renderNoticeList(){var _this2=this;$('.event-container:first').empty();var i=0,notice,$events=$('<div id="itemContent"></div>'),$eventItems,eventColor,_this=this;var _loop=function _loop(){notice=_this2.noticeList[i];$eventItems=$('<div class="fc-event ui-draggable ui-draggable-handle ellipsis" title="fault info">'+'<span class="zoneInfo">'+'<em class="mr20" title="equipment name">'+notice.fault.equipment.name+'</em>'+'</span>'+'<span class="itemPoolTitle" title="fault name">'+notice.fault.name+'</span>'+'<span class="itemTime" title="fault time">'+notice.time+'</span>'+'</div>');dateNow=new Date();date=new Date(notice.time);if(date.getDate()==dateNow.getDate()){$eventItems.attr('data-today','true');}
if(date.getDate()==dateNow.getDate()-1){$eventItems.attr('data-yesterday','true');}
if(_this2.getThisWeek().some(function(item){return item==date.getDate();})){$eventItems.attr('data-week','true');}
if(getQuarterSeason(dateNow.getMonth()+1).filter(function(element){return element==date.getMonth()+1;}).length!==0){$eventItems.attr('data-season','true');}
function getQuarterSeason(month){if(month<3){return[1,2,3];}else if(month>=4&&month<=6){return[4,5,6];}else if(month>=7&&month<=9){return[7,8,9];}else if(month>=10&&month<=12){return[10,11,12];}
return[];}
switch(Math.abs(date.getMonth()+1-(dateNow.getMonth()+1))){case 1:$eventItems.attr('data-one-month','true');break;case 2:$eventItems.attr('data-two-month','true');break;case 3:$eventItems.attr('data-three-month','true');break;case 6:$eventItems.attr('data-half-year','true');break;}
if(date.getMonth()==dateNow.getMonth()){$eventItems.attr('data-month','true');}
if(date.getFullYear()==dateNow.getFullYear()){$eventItems.attr('data-year','true');}
$eventItems.attr('data-dates',notice.time);$eventItems.attr('userFaultGrade',_this2.noticeList[i].fault.userFaultGrade);switch($eventItems.attr('userFaultGrade')){case'0':eventColor='#3a87ad';$eventItems.addClass('FaultGrade0');break;case'1':eventColor='#fdbb4a';$eventItems.addClass('FaultGrade1');break;case'2':eventColor='#ed7a3a';$eventItems.addClass('FaultGrade2');break;default:$eventItems.addClass('FaultGradeUndifined');}
$eventItems.draggable({zIndex:999,opacity:1,revert:true,revertDuration:0,distance:5,appendTo:'body',containment:'window',scroll:false,helper:'clone'});$eventItems.data('event',{id:_this2.noticeList[i].id,title:notice.fault.name,startTime:notice.time,description:notice.fault.description,allDay:true,userFaultGrade:notice.fault.userFaultGrade,content:notice,taskType:_this2.eventType.notice,editable:true,stick:true,color:eventColor}).on('click',function(){_this.currentEvent=$(this).data('event');_this.showWorkInfoDefault(_this,$(this).data('event'),true);});if(_this2.addedNoticedMap[notice.id]){_this2.displayAddScheduler($eventItems);}
$events.append($eventItems);};for(i;i<this.noticeList.length;i++){var dateNow;var date;_loop();}
$events.append('<div id="taskPoolInfoTxt" class="dn tc" i18n="workflow.calendar.NO_TASK"></div>');$('.event-container').append($events);this.checkEmptyTasks();I18n.fillArea($("#wrap"));},showWorkInfoDefault:function showWorkInfoDefault(_this,event,isFromEventPool){var $workflowInfo=$('#workflowInfo'),$wfContent=$('#wf-outline');_this.setWinData(event,isFromEventPool);$workflowInfo.attr('data-from','events');$workflowInfo.find('#itemDel,#itemEdit,.calendarInfoColor').hide();_this.itemContenteditable(false);$workflowInfo.css({'left':$wfContent.outerWidth()/2-$workflowInfo.width()/2+'px','top':$wfContent.outerHeight()/2-$workflowInfo.height()/2+'px'}).show();_this.getEcharts.call(_this,event,$workflowInfo.find('.taskPoolInfoEcharts').get(0));},displayAddScheduler:function displayAddScheduler(item){var $item=$(item);if($item.find('.label-success').length===0){$item.append('<div class="label label-success added-calendar" i18n="workflow.calendar.ADD_SCHEDULER"></div>');}},getThisWeek:function getThisWeek(){var dateNow=new Date(),dayNow=dateNow.getDate(),daysTotalMonth=new Date(dateNow.getFullYear(),dateNow.getMonth(),0).getDate(),result=[],i;if(daysTotalMonth-dayNow>=7){for(i=0;i<=7;i++){result.push(dayNow++);}}else{var length=daysTotalMonth-dayNow;for(i=0;i<=length;i++){result.push(dayNow++);}
for(i=1;i<=7-length;i++){result.push(i);}}
return result;},showUserCalendar:function showUserCalendar(userId){var _this=this;var eventSource={url:'/workflow/plan/listTasks',type:'POST',data:{userId:userId},error:function error(){Alert.danger(ElScreenContainer,'there was an error while fetching events!').showAtTop(2000);},success:function success(result){_this.fetchNoticesData().done(function(data){Spinner.stop();result.map(function(item){_this.addedNoticedMap[item.noticeId]=item;});if(_this.firstRender){_this.renderNoticeList();_this.firstRender=false;}});},textColor:'white',backgroundColor:'#5484ed'};this.$calendar.fullCalendar('removeEventSource','/workflow/plan/listTasks');this.$calendar.fullCalendar('addEventSource',eventSource);},showGroupCalendar:function showGroupCalendar(groupId){var _this=this;var eventSource={url:'/workflow/plan/listTasks',type:'POST',data:{groupId:groupId},error:function error(){Alert.danger(ElScreenContainer,'there was an error while fetching events!').showAtTop(2000);},success:function success(result){_this.fetchNoticesData().done(function(data){Spinner.stop();result.map(function(item){_this.addedNoticedMap[item.noticeId]=item;});if(_this.firstRender){_this.renderNoticeList();_this.firstRender=false;}});},textColor:'white',backgroundColor:'#5484ed'};this.$calendar.fullCalendar('removeEventSource','/workflow/plan/listTasks');this.$calendar.fullCalendar('addEventSource',eventSource);},attachEvent:function attachEvent(){var _this=this;$.spEvent.subEvent($('#wf-content'),'wf-task-list-calendar',function(event,type,id){if(type==='group'){_this.showGroupCalendar(id);}else if(type==='user'){if(!id){id=AppConfig.userId;}
_this.showUserCalendar(id);}});this.$dateTimePicker.datetimepicker({inline:true,sideBySide:true,minView:2,format:"yyyy-mm-dd ",todayHighlight:true}).datetimepicker('update',moment(new Date()).format('YYYY-MM-DD 00:00')).on('changeDate',function(date){var dateChangeNow=moment(date.date).format('YYYY-MM-DD');switch(_this.$calendar.fullCalendar('getView').type){case'month':_this.$calendar.fullCalendar('changeView','month');break;case'basicWeek':_this.$calendar.fullCalendar('changeView','basicWeek');break;case'basicDay':_this.$calendar.fullCalendar('changeView','basicDay');break;default:break;}
_this.$calendar.fullCalendar('gotoDate',dateChangeNow);_this.$dateTimePicker.datetimepicker('update',moment(date.date).format('YYYY-MM-DD 00:00'));$('.fc-bg').find('td').each(function(){$(this).css('backgroundColor','transparent');if($(this).attr('data-date')==dateChangeNow){$(this).css('backgroundColor','#ccc');}});});this.$calendar.fullCalendar({eventSources:[],events:[],eventLimit:true,firstDay:0,lang:localStorage.getItem('language')==='zh'?"zh-cn":localStorage.getItem('language'),defaultView:"month",header:{left:'prev,next today',center:'title',right:'month,basicWeek,basicDay'},lazyFetching:true,allDayDefault:true,editable:true,droppable:true,drop:function drop(date,jsEvent,ui){var $this=$(this);WebAPI.post('/workflow/plan/addNoticeToScheduler',{userId:AppConfig.userId,notice:$this.data('event').content,color:$this.data('event').color,startTime:date.format('YYYY-MM-DD HH:mm:ss')}).done(function(result){if(result.success){if($this.data('event')&&$this.data('event').id&&result.data.id){var event=_this.$calendar.fullCalendar('clientEvents',$this.data('event').id)[0];event.id=result.data.id;$('#calendar').fullCalendar('updateEvent',event);}
_this.noticeList.forEach(function(item,index,array){if(array[index].id==$this.data('event').id){array.splice(index,1);}});BackgroundWorkers.schedulerReporter?BackgroundWorkers.schedulerReporter.postMessage({type:'fetchWorkflowData',userId:AppConfig.userId}):$.noop();_this.displayAddScheduler($this);I18n.fillArea($("#wrap"));}else{Alert.danger(ElScreenContainer,'添加日程失败').showAtTop(2000);}});},eventDrop:function eventDrop(event){var eventItem={startTime:event.start.format('YYYY-MM-DD HH:mm:ss')};if(event.end){eventItem['endTime']=event.end.format('YYYY-MM-DD HH:mm:ss');}else{if(event.allDay){eventItem['endTime']=event.start.format('YYYY-MM-DD')+' 23:59:59';}else{eventItem['endTime']=moment(event.start).add(2,'h').format('YYYY-MM-DD HH:mm:ss');}}
WebAPI.post('/workflow/plan/updateScheduledTask',{scheduleId:event.id,event:eventItem}).done(function(result){return result.success;});},eventResize:function eventResize(event){WebAPI.post('/workflow/plan/updateScheduledTask',{scheduleId:event.id,event:{startTime:event.start.format('YYYY-MM-DD HH:mm:ss'),endTime:event.end.format('YYYY-MM-DD HH:mm:ss')}}).done(function(result){return result.success;});},eventClick:function eventClick(event,jsEvent){_this.oldColor=event.color;_this.itemContenteditable(false);_this.setWinData(event);var $workflowInfo=$("#workflowInfo");if(!event.editable){$workflowInfo.find('#itemDel,#itemEdit').hide();}else{$workflowInfo.find('#itemDel,#itemEdit').show();}
$workflowInfo.find('.calendarInfoColor').show();$workflowInfo.data("event",event);var wh=$(window).height();var ww=$(window).width();var oh=$workflowInfo.height();var x=jsEvent.clientX-$workflowInfo.width()/2;var y=jsEvent.clientY-43;if(wh-y<oh+40){y=y-oh+30;if(y<50){y=60;}}
if(_this.isManager){if(jsEvent.clientX<ww/2){x=x-80;}else{x=x-240;}}
_this.getEcharts.call(_this,event,$workflowInfo.find('.taskPoolInfoEcharts').get(0));$workflowInfo.css({"left":x,"top":y}).show();jsEvent.stopPropagation();return false;},viewRender:function viewRender(view){$('.fc-today-button').one('click',function(){_this.$dateTimePicker.datetimepicker('update',moment(new Date()).format('YYYY-MM-DD'));$('.fc-bg').find('td').each(function(){$(this).css('backgroundColor','transparent');if($(this).attr('data-date')==moment(new Date()).format('YYYY-MM-DD')){$(this).css('backgroundColor','#eee');}});});if(view.type=="basicWeek"){$('.fc-bg').find('td').each(function(){$(this).css('backgroundColor','transparent');if($(this).attr('data-date')==view.start.format()){$(this).css('backgroundColor','#ccc');}else if($(this).attr('data-date')==moment(new Date()).format('YYYY-MM-DD')){$(this).css('backgroundColor','#eee');}});}},eventRender:function eventRender(event,element){element.on('click',function(){_this.currentEvent=event;_this.currentElement=element;});},eventAfterAllRender:function eventAfterAllRender(){var date=_this.$calendar.fullCalendar('getDate');_this.$dateTimePicker.datetimepicker('update',moment(date).format('YYYY-MM-DD 00:00'));}});this.showUserCalendar(AppConfig.userId);$("#calendarDateStart").datetimepicker({format:"yyyy-mm-dd",autoclose:true,miniView:1,endDate:new Date()});$("#calendarDateEnd").datetimepicker({format:"yyyy-mm-dd",miniView:1,autoclose:true});$('#calendar').on("click.winEdit",function(e){var $workflowInfo=$("#workflowInfo"),isFormEvents=$workflowInfo.attr('data-from');if(isFormEvents){isFormEvents=true;$workflowInfo.attr('data-from','');}else{isFormEvents=false;}
if(!$(e.target).closest("#workflowInfo").length&&$workflowInfo.is(':visible')){$workflowInfo.hide();if(!isChangeColor&&!isFormEvents){_this.currentEvent.color=_this.oldColor;_this.$calendar.fullCalendar('updateEvent',_this.currentEvent);}}});_this.setCalendarHeight();$(window).on("resize.calendarHeight",function(){_this.setCalendarHeight();});var timer=null;var $taskPoolInfoEcharts=$('#taskPoolInfo').find('.taskPoolInfoEcharts');$("#events").on("mouseover",'.fc-event',function(){var $this=$(this);var item=$(this).data("event");var $taskPoolInfo=$("#taskPoolInfo");$("#taskPoolTitle").text(item.title);$("#taskPoolDetail").text(item.description);$("#taskPoolTime").text(item.startTime);$("#equipmentName").text(item.content.fault.equipment.points);var wh=$(window).height();var x=$this.offset().left-(_this.isManager?590:215);var y=$this.offset().top+$taskPoolInfo.height();if(y>wh){y=$this.offset().top-$taskPoolInfo.height();$taskPoolInfo.find('.tooltip-arrow').css('top','55px');}else{y=$this.offset().top-$this.height()*2;$taskPoolInfo.find('.tooltip-arrow').css('top','65px');}
var echartsHeight=200;$taskPoolInfo.css({"left":x-200,"top":y}).toggleClass('wf-bounceleft').show();clearTimeout(timer);timer=setTimeout(function(){if(y>360){$taskPoolInfo.animate({top:y-echartsHeight+'px'},'fast');$taskPoolInfo.find('.tooltip-arrow').css('top',65+echartsHeight+'px');}
_this.getEcharts.call(_this,item,$taskPoolInfoEcharts.get(0));$taskPoolInfoEcharts.slideDown();},2000);}).on("mouseout",'.fc-event',function(e){$("#taskPoolTitle").text('');$("#taskPoolDetail").text('');$("#taskPoolTime").text('');$("#taskPoolPoints").text('');$("#equipmentName").text('');$("#taskPoolInfo").toggleClass('wf-bounceleft').hide().find('.taskPoolInfoEcharts').empty();clearTimeout(timer);$taskPoolInfoEcharts.hide();timer=null;});var oldColor,isChangeColor=false;$("#workflowInfo .itemColor").click(function(){$("#workflowInfo .itemColor").each(function(){$(this).removeClass('active');});$(this).addClass('active');isChangeColor=false;var color=$(this).attr("data-color");$("#workflowInfo").data("color",color);if($("#workflowInfo").data("color")){_this.currentEvent.color=$("#workflowInfo").data("color");_this.$calendar.fullCalendar('updateEvent',_this.currentEvent);}});$("#itemDel").click(function(){WebAPI.post('/workflow/plan/delScheduledTask',{scheduleId:_this.currentEvent.id}).done(function(result){if(result.success){_this.$calendar.fullCalendar("removeEvents",_this.currentEvent._id);if(_this.projectId==_this.currentEvent.content.project){_this.noticeList.push(_this.currentEvent.content);delete _this.addedNoticedMap[_this.currentEvent.noticeId];_this.renderNoticeList();}
$("#workflowInfo").hide();try{if(_this.currentEvent.start.format('YYYY-MM-DD')==new Date().format('yyyy-MM-dd')&&_this.currentEvent.start-new Date()<=0&&(_this.currentEvent.allDay||_this.currentEvent.end-new Date()>=0)){var $workflowMenuButtonBadge=$('#paneWorkflow').find('.workflow-menu-button .badge');$workflowMenuButtonBadge.text(parseInt($workflowMenuButtonBadge.text())-1);var $menuItemCalendarBadge=$('#paneWorkflow').find('.menuItemCalendar .badge');$menuItemCalendarBadge.text(parseInt($menuItemCalendarBadge.text())-1);}}catch(e){}}else{Alert.danger(ElScreenContainer,'delete event failed!');}});});function changeSelectorInfo(index,which){var $calenderSelectorInfo=$('#wf-calender-selectorInfo');$calenderSelectorInfo.show();if(index==1){var value=$(which).text();var i18=I18n.resource.workflow.calendar;switch(value){case i18.SERIOUS:$calenderSelectorInfo.find('span').eq(index).attr('i18n',$(which).attr('i18n')).parent().css('backgroundColor','#ed7a3a').addClass('label label-primary');break;case i18.EMERGENCY:$calenderSelectorInfo.find('span').eq(index).attr('i18n',$(which).attr('i18n')).parent().css('backgroundColor','#fdbb4a').addClass('label label-primary');break;case i18.GENERAL:$calenderSelectorInfo.find('span').eq(index).attr('i18n',$(which).attr('i18n')).parent().css('backgroundColor','#3a87ad').addClass('label label-primary');break;case i18.All:$calenderSelectorInfo.find('span').eq(index).attr('i18n',$(which).attr('i18n')).parent().css('backgroundColor','#428bca').addClass('label label-primary');break;}}else{$calenderSelectorInfo.find('span').eq(index).attr('i18n',$(which).attr('i18n')).parent().addClass('label label-primary');}
I18n.fillArea($calenderSelectorInfo);}
$('#wf-Time-overdue').find('a').click(function(){_this.currentPage=1;var value=$(this).text();var i18=I18n.resource.workflow.calendar;$('#events .dropdown-menu li').removeClass('active');changeSelectorInfo(0,this);$(this).parent().addClass('active');_this.setCalendarHeight();switch(value){case i18.All:_this.overdue_type='all';break;case i18.ONE_MONTH:_this.overdue_type='one-month';break;case i18.TWO_MONTH:_this.overdue_type='two-month';break;case i18.THREE_MONTH:_this.overdue_type='three-month';break;case i18.HALF_YEAR:_this.overdue_type='half-year';break;default:return false;}
_this.fetchNoticesData(true);});$('#wf-Emergency-degree').find('a').click(function(){_this.currentPage=1;var value=$(this).text();var i18=I18n.resource.workflow.calendar;$('#events .dropdown-menu li').removeClass('active');changeSelectorInfo(1,this);$(this).parent().addClass('active');switch(value){case i18.All:_this.user_level='all';break;case i18.GENERAL:_this.user_level=0;break;case i18.EMERGENCY:_this.user_level=1;break;case i18.SERIOUS:_this.user_level=2;break;}
_this.fetchNoticesData(true);});$('#wf-fault-time').find('a').click(function(){_this.currentPage=1;var value=$(this).text();var i18=I18n.resource.workflow.calendar;$('#events .dropdown-menu li').removeClass('active');changeSelectorInfo(2,this);$(this).parent().addClass('active');switch(value){case i18.All:_this.fault_time_type='all';break;case i18.TODAY:_this.fault_time_type='today';break;case i18.YESTERDAY:_this.fault_time_type='yesterday';break;case i18.THIS_WEEK:_this.fault_time_type='week';break;case i18.THIS_MONTH:_this.fault_time_type='month';break;case i18.THIS_SEASON:_this.fault_time_type='season';break;case i18.THIS_YEAR:_this.fault_time_type='year';break;default:return false;}
_this.fetchNoticesData(true);});$('#createWF').click(function(){var $calendarSavedHtml=$('#indexMain').children().detach(),wiInstance;function insertCallback(){back();BackgroundWorkers.schedulerReporter?BackgroundWorkers.schedulerReporter.postMessage({type:'fetchWorkflowData',userId:AppConfig.userId}):$.noop();Alert.success(ElScreenContainer,I18n.resource.workflow.calendar.ORDER_CREATION_SUCCESS).showAtTop(2000);}
var momentTime=_this.currentEvent.content.time.toDate();var faultGrade=0;if(_this.currentEvent.content.fault.userFaultGrade){faultGrade=_this.currentEvent.content.fault.userFaultGrade;}
var back=function back(){wiInstance=null;$('#indexMain').empty().append($calendarSavedHtml);};wiInstance=new WorkflowInsert({noticeId:_this.currentEvent.content.id,title:_this.currentEvent.content.fault.name,detail:_this.currentEvent.content.fault.description,dueDate:new Date(+new Date()+172800000).format('yyyy-MM-dd'),critical:faultGrade,projectId:_this.currentEvent.content.project,chartPointList:_this.currentEvent.content.fault.points,chartQueryCircle:'m5',description:'冷凝器进水温度读数无规律波动, 请检查相应传感器',name:"冷凝器进水温度无规律波动",time:new Date(momentTime).format('yyyy-MM-dd HH:mm:ss'),chartStartTime:new Date(momentTime-43200000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(momentTime+43200000).format('yyyy-MM-dd HH:mm:ss')});wiInstance.show().submitSuccess(function(taskModelInfo,uploadFiles){insertCallback();this.close();wiInstance=null;}).cancel(function(){back();wiInstance=null;}).fail(function(){});});$("#itemClose").click(function(){var $workflowInfo=$("#workflowInfo"),isFormEvents=$workflowInfo.attr('data-from');if(isFormEvents){isFormEvents=true;$workflowInfo.attr('data-from','');}else{isFormEvents=false;}
if(!isChangeColor&&_this.currentEvent&&!isFormEvents){_this.currentEvent.color=_this.oldColor;_this.$calendar.fullCalendar('updateEvent',_this.currentEvent);}
$workflowInfo.hide();});$("#itemEdit").click(function(){_this.itemContenteditable(true);$(this).hide();$("#itemSave").show();$('#wf-name').removeClass('ellipsis');});$("#itemSave").click(function(){var date_start=$("#calendarDateStart").val();var date_end=$("#calendarDateEnd").val();if(date_start>date_end){$("#errorInfo").text(I18n.resource.workflow.calendar.DATE_ERROR_INFO).show();return false;}else{$("#errorInfo").hide();}
WebAPI.post('/workflow/plan/updateScheduledTask',{scheduleId:_this.currentEvent.id,event:{startTime:new Date($(".calendarDateStart").val()).format('yyyy-MM-dd HH:mm:00'),endTime:new Date($(".calendarDateEnd").val()).format('yyyy-MM-dd HH:mm:00'),title:$("#wf-name").text(),color:$("#workflowInfo").data("color")}}).done(function(result){if(result.success){_this.currentEvent.title=$('#wf-name').text();_this.currentEvent.start=$(".calendarDateStart").val();_this.currentEvent.end=moment($(".calendarDateEnd").val()).add(1,'days').format('YYYY-MM-DD HH:MM:00');if($("#workflowInfo").data("color")){_this.currentEvent.color=$("#workflowInfo").data("color");}
_this.$calendar.fullCalendar('updateEvent',_this.currentEvent);isChangeColor=true;$("#workflowInfo").hide();}else{Alert.danger(ElScreenContainer,I18n.resource.workflow.calendar.SAVE_FAILED);}});});$('#events select.task-filter').each(function(){$(this).change(function(){var value=$(this).val();var i18=I18n.resource.workflow.calendar;switch(value){case i18.TODAY:changeEventContainer(1,'data-today');break;case i18.THIS_WEEK:changeEventContainer(1,'data-week');break;case i18.THIS_MONTH:changeEventContainer(1,'data-month');break;case i18.THIS_YEAR:changeEventContainer(1,'data-year');break;case i18.All:changeEventContainer(1,'all');break;default:return false;}});});function changeEventContainer(type,changeType){if(arguments.length==2){if(type==1){$('.event-container').find('.fc-event').each(function(){$(this).hide();changeType=='all'?$(this).show():$(this).attr(changeType)=='true'?$(this).show():$(this).hide();});}else if(type==2){$('.event-container').find('.fc-event').each(function(){$(this).hide();$(this).attr('userFaultGrade')==changeType?$(this).show():$(this).hide();});}else return false;}
_this.checkEmptyTasks();$("#taskPoolInfo").hide();}
$('#events select.project-selector').change(function(){_this.resetVariable();_this.checkEmptyTasks();_this.projectId=$(this).val();var selectorInfo=$("#wf-calender-selectorInfo");selectorInfo.hide();selectorInfo.children('section').removeClass('label label-primary').attr("style","");selectorInfo.find(".condition_txt").text("").removeAttr('i18n').removeAttr('value');window.localStorage.calendarDefault=$(this).val();Spinner.spin($('#events')[0]);_this.fetchNoticesData(true).done(function(result){Spinner.stop();_this.renderNoticeList();});});},checkEmptyTasks:function checkEmptyTasks(){var $taskPoolInfoTxt=$("#taskPoolInfoTxt");if(!$("#itemContent>.fc-event:visible").length){$taskPoolInfoTxt.show();}else{$taskPoolInfoTxt.hide();}},setEventsTotalTips:function setEventsTotalTips(_year,_month){var _this=this,i;var result=[],_Arr_prevMonth=[],_Arr_nextMonth=[],lastDay;var prevDay=new Date(_year,_month-1,0).getDate();var firstDay=new Date(_year,_month-1,1).getDay();var dayTotal=new Date(_year,_month,0).getDate();for(i=0;i<firstDay;i++){_Arr_prevMonth.push(prevDay--);}
_Arr_prevMonth.sort().forEach(function(item,index,array){result.push(_this.$calendar.fullCalendar('clientEvents',function(event){return event.start.format('YYYY-MM-DD')==moment(new Date(_year+'-'+(_month-1)+'-'+item)).format('YYYY-MM-DD');}).length);});for(i=1;i<=dayTotal;i++){result.push(_this.$calendar.fullCalendar('clientEvents',function(event){return event.start.format('YYYY-MM-DD')==moment(new Date(_year+'-'+_month+'-'+i)).format('YYYY-MM-DD');}).length);}
for(i=0,lastDay=42-result.length;i<lastDay;i++){_Arr_nextMonth.push(i+1);}
_Arr_nextMonth.forEach(function(item,index,array){result.push(_this.$calendar.fullCalendar('clientEvents',function(event){return event.start.format('YYYY-MM-DD')==moment(new Date(_year+'-'+(_month+1)+'-'+array[index])).format('YYYY-MM-DD');}).length);});_this.$dateTimePicker.find('.datetimepicker-days tbody td').each(function(i,item){if(result[i]!==0){$(item).attr('data-eventstotal',result[i]);}});},getEcharts:function getEcharts(event,echartContainer){$(echartContainer).empty();var $taskPoolContainer=$('#taskPoolInfoEcharts');var faultGrade=0;var _this=this;var momentTime=event.content.time.toDate();var Spinner=new LoadingSpinner({color:'#00FFFF'});Spinner.spin(echartContainer);WebAPI.post('workflow/transaction/fault_curve_data/',{projectId:event.content.project,chartPointList:event.content.fault.points,chartQueryCircle:'m5',chartStartTime:new Date(momentTime-3600000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(momentTime+3600000).format('yyyy-MM-dd HH:mm:ss')}).done(function(result){if(result.success){_this.renderChart(result.data,echartContainer);}}).always(function(){Spinner.stop();Spinner=null;});},renderChart:function renderChart(record,echartContainer){var list_description=record.description,list_value=record.value,arrXAxis=[],result=[];if(record.time.length>0)result=record.time[0].split(',');result.forEach(function(item){arrXAxis.push(item.split(' ')[1]);});var arrSeriesTemp=[];for(var i=0;i<list_value.length;i++){var arrDatas=[];if(i<8){var item=list_value[i];if(item){var strDatas=item.split(",");for(var j=0;j<strDatas.length;++j){arrDatas.push(parseFloat(strDatas[j]).toFixed(1));}}
arrSeriesTemp.push({name:list_description[i],type:'line',itemStyle:{normal:{lineStyle:{type:'solid'}}},data:arrDatas});}}
var option={tooltip:{trigger:'axis',formatter:function formatter(params){if(params[0].name.length>0){var strResult=result[params[0].dataIndex]+'<br/>';for(var i=0;i<params.length;++i){strResult+=params[i].seriesName+' : '+params[i].value;if(i!=params.length-1){strResult+='<br/>';}}}
return strResult;}},legend:{data:list_description,x:'center'},toolbox:{show:true},xAxis:[{type:'category',boundaryGap:false,axisLine:{onZero:false},data:arrXAxis}],yAxis:[{type:'value',scale:true}],series:arrSeriesTemp};var myChart=echarts.init(echartContainer);myChart.setOption(option);window.onresize=myChart.resize;},detachEvents:function detachEvents(){$(window).off("resize.calendarHeight");},setFloatingWin:function setFloatingWin($win,h){var wh=$(window).height();var top=(wh-h)/2;$win.find(".modal-dialog").css({'top':top});$win.modal();},setCalendarHeight:function setCalendarHeight(){var wh=$(window).height(),$wrap=$("#wrap"),$navHeader=$("#navHeader");this.isManager?$wrap.css("height",wh-$navHeader.height()-12):$wrap.css("height",wh-$navHeader.height());$("#taskPoolContent").css("height",$("#events").height()-$(".event-selector").height()-100);this.$calendar.fullCalendar('option','height',wh-100);},setWinData:function setWinData(event,isFromEventPool){var _this=this,$this=$(this);var $calendarDateStart=$(".calendarDateStart");var $calendarDateEnd=$(".calendarDateEnd");$('#wf-name').addClass('ellipsis');$("#errorInfo").hide();$("#itemSave").hide();$("#itemEdit").show();var dateStart=moment(event.start).format('YYYY-MM-DD');var dateEnd=event.end?moment(event.end).subtract('days',1).format('YYYY-MM-DD'):moment(event.start).format('YYYY-MM-DD');var title=I18n.resource.workflow.calendar.NO_TITLE;if(event.title&&event.title.split(': ').length===2){title=event.title.split(': ')[1];}else{title=event.title?event.title:title;}
if(isFromEventPool){$("#owner").parent().hide();}else{$("#owner").text(event.username?event.username:AppConfig.userProfile.fullname).parent().show();}
$('#wf-name').text(title);$("#wf-detail").text(event.content.fault.description);$("#wf-critical").text(event.content.fault.userFaultGrade==2?I18n.resource.workflow.calendar.EMERGENCY:I18n.resource.workflow.calendar.NOT_URGENT);$("#wf-equipmentName").text(event.content.fault.equipment.name);$("#wf-zones").text(event.content.fault.equipment.zone?event.content.fault.equipment.zone.subBuildingName:'');if(isFromEventPool){$calendarDateStart.parent().hide();$calendarDateEnd.parent().hide();}else{$calendarDateStart.val(dateStart).parent().show();$calendarDateEnd.val(dateEnd).parent().show();}
$('.colorWrapper .itemColor').each(function(){if($(this).attr('data-color')==_this.oldColor){$(this).show();}});var projectName='';for(var i=0;i<AppConfig.projectList.length;i++){if(event.content.project==AppConfig.projectList[i].id){projectName=StringUtil.getI18nProjectName(AppConfig.projectList[i]);break;}}
$("#wf-projectName").text(projectName);I18n.fillArea($(ElScreenContainer));},itemContenteditable:function itemContenteditable(flag){var $itemColor=$("#workflowInfo .itemColor");$("#wf-name").attr("contenteditable",flag);if(flag===true){$itemColor.show();}else{$itemColor.hide();}
$(".calendarDateStart").attr({"contenteditable":flag,"disabled":!flag});$(".calendarDateEnd").attr({"contenteditable":flag,"disabled":!flag});}};return WorkflowCalendar;}();(function(beop){var configMap={htmlURL:'/static/views/workflow/task.html',settable_map:{taskModel:true,tags_model:true,group_model:true,attachmentModel:true,taskGroupModel:true,viewModel:true},taskModel:null,tags_model:null,group_model:null,attachmentModel:null,taskGroupModel:null,viewModel:{}},stateMap={viewModel:configMap.viewModel},jqueryMap={},setJqueryMap,configModel,init,attachEvents;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container;jqueryMap=$.extend(jqueryMap?jqueryMap:{},{$container:$container,$taskContent:$container.find('#taskContent'),$processSelector:$container.find('#taskProcessSelector'),$taskGroupSelector:$container.find('#taskGroupSelector'),$taskTemplateFields:$container.find('#taskTemplateFields'),$taskGroupProcess:$container.find('#taskGroupProcess'),$taskContentForm:$container.find('#taskContent')});};configModel=function configModel(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function init($container,transId){Spinner.spin(ElScreenContainer);stateMap.$container=$container;return configMap.taskGroupModel.getTaskGroup().done(function(result){if(!result.success){return false;}
return WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);setJqueryMap();stateMap.viewModel.taskGroup=result.data?result.data:[];if(stateMap.viewModel.taskGroup[0]){setProcessesByGroupId(stateMap.viewModel.taskGroup[0]._id);}
jqueryMap.$taskGroupProcess.empty().append(beopTmpl('tpl_wf_task_group_process',stateMap.viewModel));initDatePicker();stateMap.transId=transId;attachEvents();I18n.fillArea(jqueryMap.$container);});}).always(function(){Spinner.stop();});};attachEvents=function attachEvents(){jqueryMap.$taskContent.on('change','#taskGroupSelector',changeTaskGroup);jqueryMap.$taskContent.on('change','#taskProcessSelector',changeProcess);jqueryMap.$container.on('click.taskSave','#taskSave',taskSave);};var renderGroupProcess,initDatePicker,renderTemplate;renderGroupProcess=function renderGroupProcess(){jqueryMap.$processSelector=$('#taskProcessSelector');jqueryMap.$processSelector.empty().append(beopTmpl('tpl_wf_task_process_option',{process:stateMap.viewModel.process}));};initDatePicker=function initDatePicker(){jqueryMap.$due_time=jqueryMap.$container.find('#dueTime');jqueryMap.$due_time.datetimepicker({minView:2,format:"yyyy-mm-dd",startDate:new Date().format('yyyy-MM-dd 00:00:00'),autoclose:true});};renderTemplate=function renderTemplate(process_id){jqueryMap.$taskTemplateFields=$('#taskTemplateFields');var template=getProcessTemplate(process_id);jqueryMap.$taskTemplateFields.empty().append(beopTmpl('tpl_wf_task_template',template));};var setProcessesByGroupId,getProcess,getProcessTemplate;setProcessesByGroupId=function setProcessesByGroupId(groupId){for(var m=0,n=stateMap.viewModel.taskGroup.length;m<n;m++){if(stateMap.viewModel.taskGroup[m]._id==groupId){stateMap.viewModel.process=stateMap.viewModel.taskGroup[m].process;break;}}
renderTemplate(stateMap.viewModel.process[0]._id);};getProcess=function getProcess(process_id){for(var m=0,n=stateMap.viewModel.process.length;m<n;m++){if(stateMap.viewModel.process[m]._id==process_id){return stateMap.viewModel.process[m];}}};getProcessTemplate=function getProcessTemplate(process_id){var process=getProcess(process_id);return process&&process.template;};var changeTaskGroup,changeProcess,taskSave;changeTaskGroup=function changeTaskGroup(){setProcessesByGroupId($(this).val());renderGroupProcess();};changeProcess=function changeProcess(){renderTemplate($(this).val());};taskSave=function taskSave(){Spinner.spin(jqueryMap.$container[0]);configMap.taskModel.saveTask(jqueryMap.$taskContentForm.serializeObject()).done(function(result){if(result.success){alert('success');}}).always(function(){Spinner.stop();});};beop.view=beop.view||{};beop.view.task={configModel:configModel,init:init};})(beop||(beop={}));(function(){var stateMap={},jqueryMap={},setJqueryMap,init,_show,close,action;setJqueryMap=function setJqueryMap(){var $container=stateMap.$container,$content=$container.find('#wf-content');jqueryMap={$container:$container,$main_menu:$container.find('#wf-main-menu'),$level_menu:$container.find('#wf-level-menu'),$content:$content,$content_wrapper:$content.find('#wf-content-wrapper'),$content_box:$content.find('#wf-content-box')};};_show=function show(router){beop.model.stateMap.routerSubType='';if($('#wf-outline').length){action(router);}else{window.workflow.prototype.init($(ElScreenContainer)).done(function(){action(router);});}};close=function close(){};action=function action(router){var routerType=router.type;var actionError=function actionError(){console.error('无法识别的location hash!');return true;};var transactionCommon=function transactionCommon(router){if(router.type!=='taskProject'&&router.type!=="transaction"||router.subType=="workingTask"){$('#level-menu-task').removeClass('task-project');}
beop.view.taskList.configModel({enableBack:false});beop.view.menu_group_list.configModel({whereComeFrom:'default'});beop.view.menu_tag_list.configModel({whereComeFrom:'default'});beop.view.taskDetail.configModel({whereBack:'taskDetail'});};var transactionAction=function transactionAction(router){var type=router.type,subType=router.subType,transactionId=router.transactionId,id=router.id;var subTypeListTop=["workingTask","newCreate","inDoing","waitVerifier","waitMeToVerifier","finishedBy","taskStop","taskComplete","createdBy","joinedBy",'myCollection'];var subTypeListBottom=['wf-group-add','wf-task-add','wf-task-list','taskGroup','addTransaction','addTaskGroup','myTags'];jqueryMap.$level_menu.show();if(subType&&subTypeListTop.concat(subTypeListBottom).indexOf(subType.toString())==-1){actionError();}else{var isActivity=$('#wf-main-activity-hash').hasClass('active');var isLoadTaskDetail=subTypeListTop.indexOf(subType)==-1&&transactionId&&!isActivity;transactionCommon(router);if(isActivity&&transactionId){beop.view.taskDetail.init($('#wf-content'),'show',Number(transactionId));}else if(!$('#wf-main-task-hash').hasClass('active')&&subTypeListBottom.indexOf(router.subType)==-1){jqueryMap.$main_menu.find('#wf-main-task-hash').trigger('click');beop.view.menu_group_list.init($('#wf-outline'));beop.view.menu_tag_list.init($('#wf-label-ul'));$('#wf-content').css({'left':341+'px','width':'calc(100% - 345px)','padding':'5px 10px'});}else if($('#wf-task-groups').children().length<=0){beop.view.menu_group_list.init($('#wf-outline'));beop.view.menu_tag_list.init($('#wf-label-ul'));}
if(subType&&id||subTypeListBottom.indexOf(subType)!==-1){switch(subType.toString()){case"taskGroup":beop.model.stateMap.currentGroupId=router.id;beop.view.menu.onMenuItemClick(subType,['group',router.id]);break;case"myTags":beop.view.menu.onMenuItemClick('wf-task-list',['tag',router.id]);break;case"calendar":beop.view.taskDetail.configModel({whereBack:'calendar'});break;case"addTransaction":beop.view.menu.onMenuItemClick('wf-task-add',['wf-group-add']);break;case"addTaskGroup":beop.view.menu.onMenuItemClick('wf-group-add',['wf-group-add']);break;}}
setTimeout(function(){if(type&&subTypeListTop.indexOf(subType)!==-1){beop.view.menu.showDefaultLevelMenu('#wf-main-task','#level-menu-task');jqueryMap.$level_menu.find('[data-param='+subType+']').closest('ul').find('li.active').removeClass('active').end().end().addClass('active');if($('#wf-taskMine-content').length&&subType!='taskGroup'){$.spEvent.pubEvent('wf-task-list',subType);}else{if(subTypeListBottom.indexOf(router.subType)==-1){beop.view.taskList.init(jqueryMap.$container.find('#wf-content')).done(function(){$.spEvent.pubEvent('wf-task-list',subType);});}else{$.spEvent.pubEvent('wf-task-list',subType);}}}
if(isLoadTaskDetail){beop.view.taskDetail.init($('#wf-content'),'show',Number(transactionId));}},300);}};var activityAction=function activityAction(router){var subType=router.subType,subTypeList=['activity','today','yesterday','thisWeek','thisMonth','latestCompleted','latestCreated'];if(subType&&subTypeList.indexOf(subType.toString())==-1){actionError();}else{beop.view.menu.onMenuItemClick('wf-activities-change',[subType,1]);}};var calendarAction=function calendarAction(router){if(router.subType&&router.id){if(!$('#wf-main-calender-hash').hasClass('active')){beop.view.menu.onMenuItemClick('wf-firstMenu-change',[]);}
beop.view.menu.onMenuItemClick('wf-task-list-calendar',['group',router.id]);}else{beop.view.menu.onMenuItemClick('wf-firstMenu-change',[]);}};switch(routerType){case'transaction':transactionAction(router);break;case"activity":activityAction(router);break;case"calendar":calendarAction(router);break;case"team":beop.view.menu.onMenuItemClick('wf-team-show',[]);break;case"taskProject":beop.model.stateMap.currentGroupId=router.id;beop.view.menu.onMenuItemClick('taskProject',['group',router.id]);break;default:jqueryMap.$main_menu.find('#wf-main-task').trigger('click');}};init=function init($container){stateMap.$container=$container;Spinner.spin($container.get(0));return WebAPI.get("/static/views/workflow/outline.html").done(function(resultHtml){var $ElScreenContainer=$(ElScreenContainer);$ElScreenContainer.html(resultHtml);setJqueryMap();I18n.fillArea($container);var language=localStorage.getItem('language');if(language==='zh'){moment.locale('zh-cn');}else{moment.locale('en');}
beop.model.init();beop.view.activities.configModel({activities_model:beop.model.activitiesModel,transactions_model:beop.model.transactionsModel,reply_mode:beop.model.replyModel});beop.view.taskList.configModel({transactions_model:beop.model.transactionsModel,tags_model:beop.model.tagsModel});beop.view.faultCurve.configModel({transactions_model:beop.model.transactionsModel});beop.view.replyList.configModel({transactions_model:beop.model.transactionsModel,reply_mode:beop.model.replyModel});beop.view.progress.configModel({transactions_model:beop.model.transactionsModel});beop.view.groupAdd.configModel({group_model:beop.model.groupModel});beop.view.groupDelete.configModel({group_model:beop.model.groupModel});beop.view.taskDetail.configModel({transactions_model:beop.model.transactionsModel,tags_model:beop.model.tagsModel,group_model:beop.model.groupModel,attachmentModel:beop.model.attachmentModel});beop.view.menu_group_list.configModel({group_model:beop.model.groupModel});beop.view.menu_tag_list.configModel({tags_model:beop.model.tagsModel});beop.view.groupEdit.configModel({group_model:beop.model.groupModel});beop.view.menu.init(stateMap.$container);}).always(function(){Spinner.stop();});};var workflow=function workflow(type,subType,transactionId,id){this.router={type:type};if(subType){this.router.subType=subType;this.router.id=id;}else{this.router.transactionId=transactionId;}};workflow.prototype={init:init,show:function show(){Spinner.spin(ElScreenContainer);_show(this.router);},close:close};window.workflow=workflow;})(beop||(beop={}));var TaskPool=function(){function TaskPool(){this.urlMap={htmlTemplateURL:'static/views/workflow/taskPoolTemplate.html'};this.apiMap={getHtmlTemplate:'',testJSON:'static/notices.json',getDiagnosisAll:'diagnosis/getRealtimeFault/',getStruct:'/diagnosis/getStruct/'};this.configMap={faultsHtmlTemplateId:'task_pool_faults_list'};this.jqueryMap={};this.noticeList=[];this.query={overDueTime:['oneMonth','twoMonth','threeMonth','halfYear'],emergencyLevel:['general','emergency','serious'],faultsTime:['today','yesterday','thisYear','thisWeek','thisMonth','thisSeason']};this.timer=null;this.echarts=null;}
TaskPool.prototype={show:function show($container,projectID){var _this=this;var $currentContainer=$container?$container:$(ElScreenContainer);var Spinner=new LoadingSpinner({color:'#00FFFF'});Spinner.spin($currentContainer.get(0));this.init($currentContainer).done(function(){Spinner.spin(_this.jqueryMap.taskPool.get(0));$.getJSON(_this.apiMap.getDiagnosisAll+projectID).done(function(faults){if(faults){_this.renderFaultsList(faults,projectID).done(function(){Spinner.stop();});}else{$('.taskPoolInfoTxt').show();Spinner.stop();}}).fail(function(){alert('读取数据失败');});}).always(function(){I18n.fillArea($currentContainer);}).fail(function(){alert('读取html模板失败');Spinner.stop();});},init:function init($container){var _this=this;return WebAPI.get(this.urlMap.htmlTemplateURL+'?='+new Date().getTime()).done(function(html){$container.html(html);_this.setJqueryMap();});},setJqueryMap:function setJqueryMap(){this.jqueryMap={faultsContainer:'.task_pool_container',faultsContent:'<div id="task_pool_content"></div>',taskPool:$('#task_pool'),taskPoolTips:$('#taskPool_toolTip'),toolTipsFaultsTime:$('#taskPool_faults_Time'),toolTipsFaultsDetail:$('#taskPool_faults_Detail'),toolTipsFaultsTitle:$('#taskPool_faults_Title'),taskPoolSelectorInfo:$('.task_pool_selectorInfo')};},attachEvent:function attachEvent(){var $taskPoolDropDownList=this.jqueryMap.taskPool.find('.dropdown li'),_this=this;$taskPoolDropDownList.off().on('click',function(){var $this=$(this),paramType=$this.parent().data('param-type'),param=$this.data('param');if(param==-1){_this.toggleFaultsStatus('all');}else{try{var values=_this.query[paramType][param];if(!!values&&values!==null&&values!=='undefined'){_this.toggleFaultsStatus(paramType,values);}else{_this.toggleFaultsStatus('all');}}catch(ex){_this.toggleFaultsStatus('all');}}
_this.checkEmptyTasks();$taskPoolDropDownList.removeClass('active');$this.addClass('active');var emergencyLevelColor='',taskPoolSelectorInfo=$this.text();if(paramType=='emergencyLevel'){switch(param){case 0:emergencyLevelColor='#3a87ad';break;case 1:emergencyLevelColor='#ed7a3a';break;case 2:emergencyLevelColor='#fdbb4a';break;}}
_this.jqueryMap.taskPoolSelectorInfo.show().find('section').css('backgroundColor','transparent').each(function(){var $this=$(this);if($this.attr('data-param-type')==paramType){if(!emergencyLevelColor){$this.css('backgroundColor','#428bca').show().find('span').text(taskPoolSelectorInfo);}else{$this.css('backgroundColor',emergencyLevelColor).show().find('span').text(taskPoolSelectorInfo);}}});});this.jqueryMap.taskPool.off().on("mouseover",'.faults',function(){_this.showToolTips($(this));}).on('mouseout','.faults',function(){_this.hideToolTips($(this));});},showToolTips:function showToolTips($this){var dataEvent=$this.data().event,_this=this;var $taskPoolInfo=$("#taskPool_toolTip");this.jqueryMap.toolTipsFaultsTitle.text(dataEvent.title);this.jqueryMap.toolTipsFaultsDetail.text(dataEvent.description);this.jqueryMap.toolTipsFaultsTime.text(dataEvent.startTime);var wh=$(window).height();var x=this.jqueryMap.taskPoolTips.outerWidth();var y=$this.offset().top+$taskPoolInfo.height();var echartsHeight=200;if(y>wh){y=$this.offset().top-$this.height()*3;$taskPoolInfo.find('.tooltip-arrow').css('top','70%');}else{y=$this.offset().top-$this.height()*2.5;$taskPoolInfo.find('.tooltip-arrow').css('top','45px');}
$taskPoolInfo.css({"left":-x,"top":y}).toggleClass('wf-bounceleft').show();clearTimeout(this.timer);this.timer=setTimeout(function(){if(y>360){$taskPoolInfo.animate({top:y-echartsHeight+'px'},'fast');$taskPoolInfo.find('.tooltip-arrow').css('top',45+echartsHeight+'px');}
_this.jqueryMap.taskPoolTips.find('.taskPoolInfoEcharts').slideDown();_this.getEcharts.call(_this,dataEvent,_this.jqueryMap.taskPool.find('.taskPoolInfoEcharts').get(0));},2000);},hideToolTips:function hideToolTips($this){this.jqueryMap.toolTipsFaultsTitle.text('');this.jqueryMap.toolTipsFaultsDetail.text('');this.jqueryMap.toolTipsFaultsTime.text('');$("#taskPool_toolTip").toggleClass('wf-bounceleft').hide().find('.taskPoolInfoEcharts').empty().hide();clearTimeout(this.timer);this.timer=null;this.echarts=null;},getEcharts:function getEcharts(event,echartContainer){$(echartContainer).empty();var _this=this;var momentTime=event.content.time.toDate();var Spinner=new LoadingSpinner({color:'#00FFFF'});Spinner.spin(echartContainer);WebAPI.post('workflow/transaction/fault_curve_data/',{projectId:event.content.project,chartPointList:event.content.fault.points,chartQueryCircle:'m5',chartStartTime:new Date(momentTime-3600000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(momentTime+3600000).format('yyyy-MM-dd HH:mm:ss')}).done(function(result){if(result.success){_this.renderChart(result.data,echartContainer);}}).always(function(){Spinner.stop();Spinner=null;});},renderChart:function renderChart(record,echartContainer){var list_description=record.description,list_value=record.value,arrXAxis;if(record.time.length>0)arrXAxis=record.time[0].split(',');var arrSeriesTemp=[];for(var i=0;i<list_value.length;i++){var arrDatas=[];if(i<8){var item=list_value[i];if(item){var strDatas=item.split(",");for(var j=0;j<strDatas.length;++j){arrDatas.push(parseFloat(strDatas[j]).toFixed(1));}}
arrSeriesTemp.push({name:list_description[i],type:'line',itemStyle:{normal:{lineStyle:{type:'solid'}}},data:arrDatas});}}
var option={tooltip:{trigger:'axis'},legend:{data:list_description,x:'center'},toolbox:{show:true},xAxis:[{type:'category',boundaryGap:false,axisLine:{onZero:false},data:arrXAxis}],yAxis:[{type:'value',scale:true}],series:arrSeriesTemp};var myChart=echarts.init(echartContainer);myChart.setOption(option);this.echarts=myChart;},toggleFaultsStatus:function toggleFaultsStatus(queryType,values){var $faultsList=$('#task_pool_content').find('.faults');if(arguments.length==2){$faultsList.each(function(){var $this=$(this);$this.hide();try{if($this.data().query[queryType][values]){$this.show();}}catch(ex){}});}else{if(arguments.length==1&&arguments[0]=='all'){$faultsList.show();}}},checkEmptyTasks:function checkEmptyTasks(){var $taskPoolInfoTxt=this.jqueryMap.taskPool.find('.taskPoolInfoTxt');if(!this.jqueryMap.taskPool.find('.faults:visible').length){$taskPoolInfoTxt.show();}else{$taskPoolInfoTxt.hide();}},detachEvents:function detachEvents(){},renderFaultsList:function renderFaultsList(faults,projectID){var _this=this;var dealFaults=function dealFaults(){var dfd=$.Deferred();if(Array.isArray(faults)){if(faults.length){$.getJSON(_this.apiMap.getStruct+projectID).done(function(data){var noticesList=[];faults.forEach(function(faultsItem,index,array){var equipment={},zone={},zoneId=undefined;var equipmentId=faultsItem.equipmentId;data.equipments.forEach(function(equipments,index,array){if(equipmentId==equipments.id){equipment=equipments;zoneId=equipment.zoneId;data.zones.forEach(function(zones,index,array){if(zoneId==zones.id){zone=zones;}});return true;}});noticesList.push({project:projectID,id:faultsItem.id,equipmentId:equipmentId,zoneId:zoneId,time:faultsItem.time,fault:{points:faultsItem.points,name:faultsItem.name,userFaultGrade:faultsItem.grade,description:faultsItem.description,equipment:equipment?$.extend(true,{},equipment,{zone:zone}):{}}});});_this.noticeList=noticesList;dfd.resolve();}).fail(function(){dfd.reject();});}else{_this.noticeList=[];dfd.resolve();}}else{_this.noticeList=[];dfd.resolve();}
return dfd;};return dealFaults().done(function(){_this.setDataOnFaults().done(function(){_this.attachEvent();});}).fail(function(){_this.setDataOnFaults().done(function(){_this.attachEvent();});});},setDataOnFaults:function setDataOnFaults(){$(this.jqueryMap.faultsContainer).empty();var i=0,notice,$faultsItem,_this=this,$events=$(this.jqueryMap.faultsContent),data=this.noticeList;for(i;i<data.length;i++){notice=data[i];$faultsItem=$('<div class="ellipsis faults" title="fault info">'+'<span class="zoneInfo">'+'<em class="mr20" title="equipment name">'+notice.fault.equipment.name+'</em>'+'</span>'+'<span class="itemPoolTitle" title="fault name">'+notice.fault.name+'</span>'+'<span class="itemTime" title="time">'+notice.time+'</span>'+'</div>');var dateNow=new Date(),date=new Date(notice.time);var queryObject={userFaultGrade:_this.noticeList[i].fault.userFaultGrade,overDueTime:{oneMonth:false,twoMonth:false,threeMonth:false,halfYear:false},emergencyLevel:{general:false,emergency:false,serious:false},faultsTime:{today:false,yesterday:false,thisYear:false,thisWeek:false,thisMonth:false,thisSeason:false}};if(date.getDate()==dateNow.getDate()){queryObject.faultsTime.today=true;}
if(date.getDate()==dateNow.getDate()-1){queryObject.faultsTime.yesterday=true;}
if(this.getThisWeek().some(function(item){return item==date.getDate();})){queryObject.faultsTime.thisWeek=true;}
if(_this.getQuarterSeason(dateNow.getMonth()+1).filter(function(element){return element==date.getMonth()+1;}).length!==0){queryObject.faultsTime.thisSeason=true;}
if(date.getMonth()==dateNow.getMonth()){queryObject.faultsTime.thisMonth=true;}
if(date.getFullYear()==dateNow.getFullYear()){queryObject.faultsTime.thisYear=true;}
switch(Math.abs(date.getMonth()+1-(dateNow.getMonth()+1))){case 1:queryObject.overDueTime.oneMonth=true;$faultsItem.attr('data-overDueTime','1');break;case 2:queryObject.overDueTime.threeMonth=true;break;case 3:queryObject.overDueTime.threeMonth=true;break;case 6:queryObject.overDueTime.halfYear=true;break;}
var grade=_this.noticeList[i].fault.userFaultGrade;switch(grade){case 0:queryObject.emergencyLevel.general=true;break;case 1:queryObject.emergencyLevel.emergency=true;break;case 2:queryObject.emergencyLevel.serious=true;break;default:break;}
$faultsItem.addClass('fault_grade_'+grade);var dataObj={query:queryObject,event:{id:this.noticeList[i].id,title:notice.fault.name,startTime:notice.time,description:notice.fault.description,userFaultGrade:notice.fault.userFaultGrade,content:notice}};$faultsItem.data(dataObj);$events.append($faultsItem);}
$(this.jqueryMap.faultsContainer).html($events);return $.Deferred().resolve();},getQuarterSeason:function getQuarterSeason(month){if(month<3){return[1,2,3];}else if(month>=4&&month<=6){return[4,5,6];}else if(month>=7&&month<=9){return[7,8,9];}else if(month>=10&&month<=12){return[10,11,12];}
return[];},getThisWeek:function getThisWeek(){var dateNow=new Date(),dayNow=dateNow.getDate(),daysTotalMonth=new Date(dateNow.getFullYear(),dateNow.getMonth(),0).getDate(),result=[],i;if(daysTotalMonth-dayNow>=7){for(i=0;i<=7;i++){result.push(dayNow++);}}else{var length=daysTotalMonth-dayNow;for(i=0;i<=length;i++){result.push(dayNow++);}
for(i=1;i<=7-length;i++){result.push(i);}}
return result;},close:function close(){}};return TaskPool;}();var WfFileUpload=function($){var configMap={uploadModalContainerId:'#uploadModal-container',uploadModalId:'#uploadModal'};var fileUpload=function fileUpload(autoSendFile,currentAttachAmount,isNewTask){if(typeof FileReader==='undefined'){throw new Error('Your browse isn\'t suppose FileReader');}else if(typeof $==='undefined'){throw new ReferenceError('fileUpload need\'s jQuery');}else if(typeof $.fn.modal==='undefined'){throw new ReferenceError('fileUpload need\'s bootstrap modal');}
this.formData=new FormData();this.allFileList=[];this.pendingFileList=[];this.successFileLength=0;this.$progress=null;this.cbList={};this.currentAttachAmount=currentAttachAmount||null;this.maxAttachment=5;this._autoSendFile=autoSendFile;this.uploadModalContainerId=configMap.uploadModalContainerId;this.fileAllow={affixMaxSize:5242880,fileNotAllowTypeList:[]};this.isNewTask=isNewTask;};fileUpload.prototype={show:function show(){this.init();},init:function init(cb){this._showUploadModal();if(cb){this.cbList._initCb=cb;}
return this;},close:function close(cb){if(cb){this.cbList._closeCb=cb;}
return this;},uploadSuccess:function uploadSuccess(cb){if(cb){this.cbList._uploadCompleteCb=cb;}
return this;},_destroy:function _destroy(){$('body').find(configMap.uploadModalContainerId).remove();this.cbList._closeCb&&this.cbList._closeCb.call(this,this.pendingFileList);},_showUploadModal:function _showUploadModal(){var self=this;WebAPI.get('/static/views/workflow/fileUpload.html'+'?='+new Date().getTime()).done(function(result){$('body').append(result);I18n.fillArea($(configMap.uploadModalContainerId));$(configMap.uploadModalId).modal('show').on('hidden.bs.modal',self._destroy.bind(self));self.$progress=$(configMap.uploadModalContainerId).find('.progress');self._bindEvents();self.cbList._initCb&&self.cbList._initCb.call(self);});},_bindEvents:function _bindEvents(){var self=this,$container=$(configMap.uploadModalContainerId);$container.off();var $fileElement=$(configMap.uploadModalContainerId).find('input[type="file"]');$container.on('click','[data-file-type="add"]',function(){if(self.currentAttachAmount&&self.pendingFileList&&self.pendingFileList.length+self.currentAttachAmount>=self.maxAttachment){alert(I18n.resource.workflow.task.ATTACHMENT_FILE_AMOUNT_INFO);}else{$fileElement.trigger('click');}});$container.on('click','[data-file-type="remove-upload-item"]',function(ev){ev.stopPropagation();ev.preventDefault();var _this=this;confirm(I18n.resource.workflow.task.ATTACHMENT_DELETE_NOTE,function(){self._removeUploadFileItem(ev,_this,true);});});$container.off('click.add-upload-item').on('click.add-upload-item','.files',function(ev){var $this=$(this),fileId=$this.closest('div.files').attr('data-file-id');if(!fileId){return false;}else{if($this.hasClass('active')){$this.removeClass('active');self._removeUploadFileItem(ev,this);}else{$this.addClass('active');self._addUploadFileItem(ev,this);}}});$container.on('click','[data-file-type="upload"]',function(){if(self._autoSendFile&&self.pendingFileList.length){self._uploadFile();}else{$(configMap.uploadModalId).modal('hide');self.cbList._uploadCompleteCb&&self.cbList._uploadCompleteCb.call(self,self.pendingFileList);}});$fileElement.on('change',function(ev){self._fileElementChange(ev,this);});},_addUploadFileItem:function _addUploadFileItem(ev,$dom){var $file=$($dom).closest('div.files'),fileId=$file.attr('data-file-id'),self=this;this.allFileList.forEach(function(item){if(item.id==fileId){self.pendingFileList.push(item);}});this._setUploadInfo();},_removeUploadFileItem:function _removeUploadFileItem(ev,$dom,isRemove){var $file=$($dom).closest('div.files'),fileId=$file.attr('data-file-id'),self=this;this.pendingFileList.forEach(function(item,index,array){if(item.id==fileId){array.splice(index,1);}});self._setUploadInfo();if(isRemove){$file.fadeOut(300,function(){$file.closest('.files-li').remove();});}},_setUploadInfo:function _setUploadInfo(){var $container=$(configMap.uploadModalContainerId),$uploadInfo=$container.find('.upload-file-info'),self=this;var size=0;this.pendingFileList.forEach(function(item){size+=item.file.size;});size=parseFloat(size/1024/1024).toFixed(2);if(this.pendingFileList.length>0){$uploadInfo.css({"opacity":1}).html(I18n.resource.workflow.task.ATTACHMENT_FILE_INFO_TEXT.format([self.allFileList.length,size,self.successFileLength]));}else{$uploadInfo.css({"opacity":0});}},_fileElementChange:function _fileElementChange(ev,$dom){ev.stopPropagation();ev.preventDefault();var file=$dom.files[0];if(file){if(!this._checkFile(file,$dom)){alert(I18n.resource.workflow.task.ATTACHMENT_FILE_ERROR_INFO_SIZE);return false;}
var fileInfo={name:file.name,type:file.type,iconClass:this._getFileTypeIconClass(file.name),size:file.size,lastModified:file.lastModified,lastModifiedDate:file.lastModifiedDate};this._addToNavList(file,fileInfo);}},_checkFile:function _checkFile(file,$dom){return file.size<=this.fileAllow.affixMaxSize;},_addToNavList:function _addToNavList(file,fileInfo){var $filesNav=$(configMap.uploadModalContainerId).find('ul.files-nav'),fileId=new Date().getTime().toString(16),self=this,filter=/^(?:image\/bmp|image\/cis\-cod|image\/gif|image\/ief|image\/jpeg|image\/jpeg|image\/jpeg|image\/pipeg|image\/png|image\/svg\+xml|image\/tiff|image\/x\-cmu\-raster|image\/x\-cmx|image\/x\-icon|image\/x\-portable\-anymap|image\/x\-portable\-bitmap|image\/x\-portable\-graymap|image\/x\-portable\-pixmap|image\/x\-rgb|image\/x\-xbitmap|image\/x\-xpixmap|image\/x\-xwindowdump)$/i;if(filter.test(file.type)){Spinner.spin(ElScreenContainer);var fileReader=new FileReader();fileReader.readAsDataURL(file);fileReader.onload=function(ev){$filesNav.find('.upload-drag-area').before($(beopTmpl('file_list_temp',{file:fileInfo,fileId:fileId,fileBase64:ev.target.result})).fadeIn(300,function(){self.allFileList.push({id:fileId,file:file,iconClass:fileInfo.iconClass,fileBase64:ev.target.result});self.pendingFileList.push({id:fileId,file:file,iconClass:fileInfo.iconClass,fileBase64:ev.target.result});self._setUploadInfo();Spinner.stop();}));};}else{$filesNav.find('.upload-drag-area').before($(beopTmpl('file_list_temp',{file:fileInfo,fileId:fileId,fileBase64:null})).fadeIn(300,function(){self.allFileList.push({id:fileId,file:file,iconClass:fileInfo.iconClass,fileBase64:null});self.pendingFileList.push({id:fileId,file:file,iconClass:fileInfo.iconClass,fileBase64:null});self._setUploadInfo();}));}},_uploadFile:function _uploadFile(){this._setFormData.call(this);Spinner.spin($(configMap.uploadModalId).get(0));var xhr=new XMLHttpRequest(),self=this;xhr.onreadystatechange=function(event){self._uploadComplete(event,this);};xhr.upload.onloadstart=function(){self._UploadFileStart();};xhr.onprogress=xhr.upload.onprogress=function(event){self._uploadFileProgress(event);};xhr.onload=xhr.upload.onload=function(event){};xhr.onerror=xhr.upload.onerror=function(){Spinner.stop();self._uploadFailed();};xhr.onabort=xhr.upload.onabort=function(){self._uploadCanceled();};xhr.open("POST","workflow/attachment/upload");xhr.send(this.formData);},_setFormData:function _setFormData(){var fileIdList=[];this.pendingFileList.forEach(function(item){this.formData.append('file',item.file);fileIdList.push(item.id);}.bind(this));this.formData.append('file_ids',fileIdList);this.formData.append('transId',this.isNewTask?"":beop.model.stateMap.cur_trans.id);this.formData.append('userId',AppConfig.userId);},_UploadFileStart:function _UploadFileStart(){this.$progress.show();},_uploadFileProgress:function _uploadFileProgress(event){if(event.lengthComputable){var percentComplete=100*parseFloat(event.loaded/event.total).toFixed(2)+'%';this.$progress.find('.progress-bar').css('width',percentComplete).find('i').text(percentComplete);}},_uploadComplete:function _uploadComplete(ev,xhrInstance){var self=this;if(xhrInstance.readyState!==4){return;}
if(xhrInstance.status===200){try{var result=JSON.parse(xhrInstance.responseText);}catch(ex){alert(I18n.resource.workflow.task.ATTACHMENT_FILE_FAIL_INFO);console.error(ex);}
if(result.success){setTimeout(function(){Spinner.stop();self.$progress.fadeOut(300,function(){self.$progress.find('.progress-bar').css('width',0).find('i').text('0%');$(configMap.uploadModalId).modal('hide');self.successFileLength=self.allFileList.length-self.pendingFileList.length;if(self.isNewTask){self.pendingFileList.forEach(function(item,index,array){result.data.forEach(function(data){if(data.fileId==item.id){array[index]['uid']=data.uid;}});});}
self.cbList._uploadCompleteCb&&self.cbList._uploadCompleteCb.call(self,self.pendingFileList,ev,xhrInstance);});},1000);}else{alert(I18n.resource.workflow.task.ATTACHMENT_FILE_FAIL_INFO);}}},_uploadFailed:function _uploadFailed(){},_uploadCanceled:function _uploadCanceled(){},_getFileTypeIconClass:function _getFileTypeIconClass(name){var mineType=[{type:['png','jpeg','jpg','bmp','webpg'],class:'icon-file-pic'},{type:['docx','doc','wps'],class:"icon-file-doc"},{type:['ppt'],class:"icon-file-ppt"},{type:['pdf'],class:'icon-file-pdf'},{type:['xlsx','xls','xlsb','xlsm','xlst'],class:'icon-file-excel'},{type:['exe'],class:'icon-file-exe'},{type:['zip','jar'],class:'icon-file-zip'},{type:['rar'],class:'icon-file-rar'}];var fileType=name.split('.'),defaultFileClassName='icon-file-file';fileType=fileType[fileType.length-1];if(fileType){mineType.forEach(function(item,index,array){if(item.type.indexOf(String(fileType).toLowerCase())!==-1){defaultFileClassName=item.class;return true;}});}
return defaultFileClassName;},_getFileAddTime:function _getFileAddTime(time){var monthShort=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];var date=new Date(time);return monthShort[date.getMonth()]+' '+date.getDate()+' '+date.getFullYear();}};return fileUpload;}(jQuery);;(function(exports){var BALL_MOVE_STEP=5;var BALL_ATTACH_STEP=15;var BALL_POSITION={TOP:0,RIGHT:1,BOTTOM:2,LEFT:3,AUTO:4};var ANIMATION_STATUS={RUNNING:0,PAUSE:1,STOP:2};var DEFAULTS={};var requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame;var cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame;var request;function AnimController(container,options){this.container=container;this.options=$.extend(false,{},DEFAULTS,options);this.balls=[];this.matchedBalls=[];this.arrivedBalls=[];this.ctx=null;this.width=null;this.height=null;this.animInfo={ballImage:null,imgWidth:39,imgHeight:39};this.status=ANIMATION_STATUS.STOP;this._init();}
+function(){this._init=function(){var domCanvas=document.createElement('canvas');var computedStyle=window.getComputedStyle(this.container);var width=parseInt(computedStyle.width);var height=parseInt(computedStyle.height);domCanvas.width=this.width=width;domCanvas.height=this.height=height;domCanvas.style.width=width+'px';domCanvas.style.height=height+'px';this.container.innerHTML='';this.container.appendChild(domCanvas);this.ctx=domCanvas.getContext('2d');this.animInfo.ballImage=document.querySelector('#imgBall');};this.start=function(){if(this.status===ANIMATION_STATUS.RUNNING){return;}
this.status=ANIMATION_STATUS.RUNNING;this._loop();};this._loop=function(){this._render();this._update();request=requestAnimationFrame(this._loop.bind(this));};this._render=function(){var _this=this;var ctx=this.ctx;ctx.clearRect(0,0,this.width,this.height);this.balls.concat(this.matchedBalls).forEach(function(ball){if(ball.delay>0){return;}
ctx.drawImage(_this.animInfo.ballImage,ball.x,ball.y);});this.arrivedBalls.forEach(function(ball){var width=_this.animInfo.imgWidth*ball.scale;var height=_this.animInfo.imgHeight*ball.scale;var dw=(_this.animInfo.imgWidth-width)/2;var dh=(_this.animInfo.imgHeight-height)/2;ctx.drawImage(_this.animInfo.ballImage,ball.x+dw,ball.y+dh,width,height);});};this._update=function(){var _this=this;var boundBottom=this.height-this.animInfo.imgHeight;var boundRight=this.width-this.animInfo.imgWidth;this.balls.forEach(function(ball){if(ball.delay>0){ball.delay-=1;return;}
switch(ball.pos){case BALL_POSITION.TOP:ball.y=0;if(ball.x>0){ball.x-=BALL_MOVE_STEP;}else{ball.x=0;ball.pos=BALL_POSITION.LEFT;}
break;case BALL_POSITION.LEFT:ball.x=0;if(ball.y<boundBottom){ball.y+=BALL_MOVE_STEP;}else{ball.y=boundBottom;ball.pos=BALL_POSITION.BOTTOM;}
break;case BALL_POSITION.BOTTOM:ball.y=boundBottom;if(ball.x<boundRight){ball.x+=BALL_MOVE_STEP;}else{ball.x=boundRight;ball.pos=BALL_POSITION.RIGHT;}
break;case BALL_POSITION.RIGHT:ball.x=boundRight;if(ball.y>0){ball.y-=BALL_MOVE_STEP;}else{ball.y=0;ball.pos=BALL_POSITION.TOP;}
break;}});this.matchedBalls.forEach(function(ball){var destPos=ball.to;if(Math.abs(ball.x-destPos.x)<20&&Math.abs(ball.y-destPos.y)<20){_this.remove(_this.matchedBalls,ball);ball.scale=1;_this.arrivedBalls.push(ball);return;}
ball.x+=ball.stepX;ball.y+=ball.stepY;});this.arrivedBalls.forEach(function(ball){ball.scale-=0.1;if(ball.scale<=0){_this.remove(_this.arrivedBalls,ball);_this.excuteCallback('arrived',ball);if(_this.matchedBalls.length===0&&_this.arrivedBalls.length===0){_this.excuteCallback('all-arrived');}}});};this.excuteCallback=function(type,data){switch(type){case'arrived':typeof this.options.onArrived==='function'&&this.options.onArrived(data);break;case'all-arrived':typeof this.options.onAllArrived==='function'&&this.options.onAllArrived(data);break;default:break;}};this.add=function(ball){var _this=this;if(Object.prototype.toString.call(ball)!=='[object Array]'){ball=[ball];}
ball.forEach(function(row,i){row.x=_this.width;row.y=0;row.delay=i*Math.ceil(_this.animInfo.imgWidth/BALL_MOVE_STEP);row.pos=BALL_POSITION.TOP;_this.balls.push(row);});};this.remove=function(balls,ball){if(Object.prototype.toString.call(ball)!=='[object Array]'){ball=[ball];}
for(var i=0,len=balls.length;i<len;i++){if(ball.indexOf(balls[i])>-1){balls.splice(i,1);i--;len--;}}};this.match=function(data){var _this=this;var arr=[],removed;if(Object.prototype.toString.call(data)!=='[object Array]'){data=[data];}
data.forEach(function(row){var id=row.id;var ball=_this.findById(id);var dy,dx,rotate;if(ball===null){console.warn('can not find ball with "id": '+id);return;}
_this.remove(_this.balls,ball);ball.pos=BALL_POSITION.AUTO;ball=$.extend(true,{},ball,row);ball.to.x=ball.to.x-_this.animInfo.imgWidth/2;ball.to.y=ball.to.y-_this.animInfo.imgHeight/2;rotate=Math.atan2(ball.to.y-ball.y,ball.to.x-ball.x);ball.stepX=Math.cos(rotate)*BALL_ATTACH_STEP;ball.stepY=Math.sin(rotate)*BALL_ATTACH_STEP;_this.matchedBalls.push(ball);});};this.findById=function(id){var findRs=null;this.balls.some(function(ball){if(ball.id===id){findRs=ball;return true;}
return false;});return findRs;};this.pause=function(){if(request){cancelAnimationFrame(request);this.status=ANIMATION_STATUS.PAUSE;}};this.stop=function(){this.pause();this.balls.length=0;this._render();this.status=ANIMATION_STATUS.STOP;};}.call(AnimController.prototype);exports.AnimController=AnimController;})(window);;(function(exports){var _this;var OFFSET_X=34;var OFFSET_Y=34;function DiagnosisConfigScreen(data){_this=this;this.store=data;this.container=null;this.animCtn=null;this.equipCtn=null;this.page=null;this.animController=null;this.tplParamList=[];this.unmatchedList=null;this.showDeferred=$.Deferred();}
+function(){this.UNMATCHED_ITEM_TPL='<div class="col-xs-3 unmatched-item" data-id="{id}" draggable="true">\
            <div class="media">\
                <div class="media-body">\
                    <h4 class="media-heading">{value}</h4>\
                    {alias}\
                </div>\
                <button type="button" class="close">\
                    <span>×</span>\
                </button>\
            </div>\
        </div>';this.show=function($container,filterPanel){WebAPI.get('/static/app/DiagnosisEngine/views/diagnosisConfig/diagnosisConfigScreen.html').done(function(html){_this.container=$container[0];_this.filterPanel=filterPanel;_this.container.innerHTML='<div id="container-left"></div>'+'<div id="container-right"></div>';$(_this.container).removeClass("mr10 ml10 mt5");$(_this.container).find('#container-left')[0].innerHTML=html;_this.animCtn=_this.container.querySelector('#animLayer');_this.equipCtn=_this.container.querySelector('#equipLayer');if(!AppConfig.datasource){AppConfig.datasource=new DataSource(_this);AppConfig.datasource.show();}else{AppConfig.datasource.show();}
_this.showDeferred.resolve();_this.init();});};this.init=function(){var _this=this;this.initAnimation();this.initPageScreen().done(function(){_this.initStatus();});this.attachEvents();};this.initStatus=function(){this.__getTplParamList();this.__refreshRemoveBtns();};this.attachEvents=function(){var _this=this;var $unmatchedList=$('#unmatchedList',this.container);this.container.ondrop=function(e){var transferData=EventAdapter.getData()||{};var dsItemId=transferData.dsItemId;var type=transferData.type;_this.__onDropUnmatchedPoint(e,dsItemId);};this.container.ondragenter=function(e){e.preventDefault();};this.container.ondragover=function(e){e.preventDefault();};$unmatchedList.off('click').on('click','.close',function(e){var $ele=$(this).closest('.unmatched-item');$ele.remove();});$unmatchedList.off('dragstart').on('dragstart','.unmatched-item',function(e){EventAdapter.setData({'dsItemId':this.dataset.id,'type':'unmatched'});});};this.__onDropUnmatchedPoint=function(evt,dsItemId){var _this=this;var tplParamList=this.tplParamList;var offset=$('#equipLayer',this.container).offset();var absoluteDropX=evt.pageX-offset.left;var absoluteDropY=evt.pageY-offset.top;var painter=this.page.painter;tplParamList.some(function(row){var pos=row.modelPos;var o={};var hitShape=GUtil.getIntersectionByPoint(absoluteDropX,absoluteDropY,painter.getCanvasLayer(),painter.getRootLayer());if(hitShape){_this.store.dictVariable[row.param[0]]=dsItemId;o[row.param[0]]=dsItemId;_this.page.reloadWidgetById(row.modelId,o);_this.__addRemoveBtn(row);return true;}});};this.__addToUnmatchesList=function(){var _this=this;var container=this.container.querySelector('#unmatchedList');var arrHtml=[];var unmatches=this.unmatchedList;if(!unmatches.length){return;}
$(container).append(arrHtml);};this.__getTplParamList=function(){var _this=this;var models,paramList=[];if(this.tplParamList.length){return this.tplParamList.map(function(row){return row.param[0];});}
models=this.page.getModelsByType('HtmlContainer');models.forEach(function(model){var pattern=/<#\s*(\w*?)\s*#>/mg;var match,list=[];while(match=pattern.exec(model.option().html)){list.push(match[1]);}
paramList.push({modelId:model._id(),param:list,to:{x:model.x()+model.w()/2+OFFSET_X,y:model.y()+model.h()/2+OFFSET_Y},modelPos:{x:model.x()+OFFSET_X,y:model.y()+OFFSET_Y,w:model.w(),h:model.h()}});});this.tplParamList=paramList;return paramList.map(function(row){return row.param[0];});};this.__onArrivedCallback=function(data){var o={};o[data.param[0]]=data.id;this.page.reloadWidgetById(data.modelId,o);this.__addRemoveBtn(data);};this.__onAllArrivedCallback=function(){this.__addToUnmatchesList();this.animController.stop();};this.__refreshRemoveBtns=function(){var _this=this;var map=this.store.dictVariable;var tplParamList=this.tplParamList;var arr=[];Object.keys(map).forEach(function(k){var match;if(map[k]){match=_this.__getDestInfoByTplParam(k);if(match){arr.push(match);}}});this.container.querySelector('#decorateLayer').innerHTML='';arr.forEach(function(row){_this.__addRemoveBtn(row);});};this.__addRemoveBtn=function(data){var _this=this;var modelId=data.modelId;var container=this.container.querySelector('#decorateLayer');var dom=document.createElement('button');var pos=data.modelPos;dom.classList.add('close');dom.style.position='absolute';dom.style.left=pos.x+pos.w-25+'px';dom.style.top=pos.y+pos.h/2-12+'px';dom.style.float='none';dom.style.fontSize='24px';dom.style.color='#c7254e';dom.style.opacity=1;dom.innerHTML='<span>×</span>';container.appendChild(dom);dom.onclick=function(e){_this.store.dictVariable[data.param[0]]='';_this.page.reloadWidgetById(modelId,{});container.removeChild(this);};};this.__updateThing=function(data){return WebAPI.post('/diagnosisEngine/saveThings',data);};this.__getDestInfoByTplParam=function(param){var match,info={};this.tplParamList.some(function(row){if(row.param.indexOf(param)>-1){match=row;return true;}});if(!match){return;}
return match;};this.__matchDataSource=function(data){var dsInfo=_this.filterPanel.tree.getNodesByParam("id",data,null);return WebAPI.post('/diagnosisEngine/matchPoints',{'type':this.store.type,'arrVariable':_this.store.arrVariable,'arrClass':dsInfo.map(function(row){return{_id:row.id,name:row.value,note:row.alias};})});};this.initPageScreen=function(){var PageScreen=namespace('observer.screens.PageScreen');if(this.page){this.page.close();}
this.page=new PageScreen({id:this.store.srcPageId,params:this.store.dictVariable},this.equipCtn);return this.page.show();};this.initAnimation=function(){this.animController=new AnimController(_this.animCtn,{onArrived:this.__onArrivedCallback.bind(this),onAllArrived:this.__onAllArrivedCallback.bind(this)});};this.close=function(){if(this.page){this.page.close();}};}.call(DiagnosisConfigScreen.prototype);exports.DiagnosisConfigScreen=DiagnosisConfigScreen;})(window);;(function(exports){function EquipmentScreen(){}
+function(){this.show=function(){};this.initAnimation=function(){};this.initPageScreen=function(){};}.call(EquipmentScreen.prototype);exports.EquipmentScreen=EquipmentScreen;})(window);