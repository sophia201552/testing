var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};!function($){function UTCDate(){return new Date(Date.UTC.apply(Date,arguments));}
function UTCToday(){var today=new Date();return UTCDate(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate(),today.getUTCHours(),today.getUTCMinutes(),today.getUTCSeconds(),0);}
var extend={monthAbbreviation:false};var Datetimepicker=function Datetimepicker(element,options){var that=this;this.element=$(element);this.container=options.container||'body';this.language=options.language||this.element.data('date-language')||"en";this.language=this.language in dates?this.language:"en";this.isRTL=dates[this.language].rtl||false;if(options.monthAbbreviation){extend.monthAbbreviation=true;}
this.formatType=options.formatType||this.element.data('format-type')||'standard';this.format=DPGlobal.parseFormat(options.format||this.element.data('date-format')||dates[this.language].format||DPGlobal.getDefaultFormat(this.formatType,'input'),this.formatType);this.isInline=false;this.isVisible=false;this.isInput=this.element.is('input');this.bootcssVer=this.isInput?this.element.is('.form-control')?3:2:this.bootcssVer=this.element.is('.input-group')?3:2;this.component=this.element.is('.date')?this.bootcssVer==3?this.element.find('.input-group-addon .glyphicon-th, .input-group-addon .glyphicon-time, .input-group-addon .glyphicon-calendar').parent():this.element.find('.add-on .icon-th, .add-on .icon-time, .add-on .icon-calendar').parent():false;this.componentReset=this.element.is('.date')?this.bootcssVer==3?this.element.find('.input-group-addon .glyphicon-remove').parent():this.element.find('.add-on .icon-remove').parent():false;this.hasInput=this.component&&this.element.find('input').length;if(this.component&&this.component.length===0){this.component=false;}
this.linkField=options.linkField||this.element.data('link-field')||false;this.linkFormat=DPGlobal.parseFormat(options.linkFormat||this.element.data('link-format')||DPGlobal.getDefaultFormat(this.formatType,'link'),this.formatType);this.minuteStep=options.minuteStep||this.element.data('minute-step')||5;this.pickerPosition=options.pickerPosition||this.element.data('picker-position')||'bottom-right';this.showMeridian=options.showMeridian||this.element.data('show-meridian')||false;this.initialDate=options.initialDate||new Date();this._attachEvents();this.formatViewType="datetime";if('formatViewType'in options){this.formatViewType=options.formatViewType;}else if('formatViewType'in this.element.data()){this.formatViewType=this.element.data('formatViewType');}
this.minView=0;if('minView'in options){this.minView=options.minView;}else if('minView'in this.element.data()){this.minView=this.element.data('min-view');}
this.minView=DPGlobal.convertViewMode(this.minView);this.showWeek=options.showWeek,this.weeklyString=null,this.dataNOW=null,this.currentTR=null||false;if(this.showWeek){var oldVal=this.element.val();var oldDate=new Date(oldVal);var nowWeek=this.iso8601Week(oldDate);this.element.val(oldDate.getFullYear()+'-'+nowWeek+'-week');}
this.maxView=DPGlobal.modes.length-1;if('maxView'in options){this.maxView=options.maxView;}else if('maxView'in this.element.data()){this.maxView=this.element.data('max-view');}
this.maxView=DPGlobal.convertViewMode(this.maxView);this.wheelViewModeNavigation=false;if('wheelViewModeNavigation'in options){this.wheelViewModeNavigation=options.wheelViewModeNavigation;}else if('wheelViewModeNavigation'in this.element.data()){this.wheelViewModeNavigation=this.element.data('view-mode-wheel-navigation');}
this.wheelViewModeNavigationInverseDirection=false;if('wheelViewModeNavigationInverseDirection'in options){this.wheelViewModeNavigationInverseDirection=options.wheelViewModeNavigationInverseDirection;}else if('wheelViewModeNavigationInverseDirection'in this.element.data()){this.wheelViewModeNavigationInverseDirection=this.element.data('view-mode-wheel-navigation-inverse-dir');}
this.wheelViewModeNavigationDelay=100;if('wheelViewModeNavigationDelay'in options){this.wheelViewModeNavigationDelay=options.wheelViewModeNavigationDelay;}else if('wheelViewModeNavigationDelay'in this.element.data()){this.wheelViewModeNavigationDelay=this.element.data('view-mode-wheel-navigation-delay');}
this.startViewMode=2;if('startView'in options){this.startViewMode=options.startView;}else if('startView'in this.element.data()){this.startViewMode=this.element.data('start-view');}
this.startViewMode=DPGlobal.convertViewMode(this.startViewMode);this.viewMode=this.startViewMode;this.viewSelect=this.minView;if('viewSelect'in options){this.viewSelect=options.viewSelect;}else if('viewSelect'in this.element.data()){this.viewSelect=this.element.data('view-select');}
this.viewSelect=DPGlobal.convertViewMode(this.viewSelect);this.forceParse=true;if('forceParse'in options){this.forceParse=options.forceParse;}else if('dateForceParse'in this.element.data()){this.forceParse=this.element.data('date-force-parse');}
this.picker=$(this.bootcssVer==3?DPGlobal.templateV3:DPGlobal.template).appendTo(this.isInline?this.element:this.container).on({click:$.proxy(this.click,this),mousedown:$.proxy(this.mousedown,this)});if(this.wheelViewModeNavigation){if($.fn.mousewheel){this.picker.on({mousewheel:$.proxy(this.mousewheel,this)});}else{console.log("Mouse Wheel event is not supported. Please include the jQuery Mouse Wheel plugin before enabling this option");}}
if(this.isInline){this.picker.addClass('datetimepicker-inline');}else{this.picker.addClass('datetimepicker-dropdown-'+this.pickerPosition+' dropdown-menu');}
if(this.isRTL){this.picker.addClass('datetimepicker-rtl');if(this.bootcssVer==3){this.picker.find('.prev span, .next span').toggleClass('glyphicon-arrow-left glyphicon-arrow-right');}else{this.picker.find('.prev i, .next i').toggleClass('icon-arrow-left icon-arrow-right');};}
$(document).on('mousedown',function(e){if($(e.target).closest('.datetimepicker').length===0){that.hide();}});this.autoclose=false;if('autoclose'in options){this.autoclose=options.autoclose;}else if('dateAutoclose'in this.element.data()){this.autoclose=this.element.data('date-autoclose');}
this.keyboardNavigation=true;if('keyboardNavigation'in options){this.keyboardNavigation=options.keyboardNavigation;}else if('dateKeyboardNavigation'in this.element.data()){this.keyboardNavigation=this.element.data('date-keyboard-navigation');}
this.todayBtn=options.todayBtn||this.element.data('date-today-btn')||false;this.todayHighlight=options.todayHighlight||this.element.data('date-today-highlight')||false;this.weekStart=(options.weekStart||this.element.data('date-weekstart')||dates[this.language].weekStart||0)%7;this.weekEnd=(this.weekStart+6)%7;this.startDate=-Infinity;this.endDate=Infinity;this.daysOfWeekDisabled=[];this.setStartDate(options.startDate||this.element.data('date-startdate'));this.setEndDate(options.endDate||this.element.data('date-enddate'));this.setDaysOfWeekDisabled(options.daysOfWeekDisabled||this.element.data('date-days-of-week-disabled'));this.fillDow();this.fillMonths();this.update();this.showMode();if(this.isInline){this.show();}};Datetimepicker.prototype={constructor:Datetimepicker,_events:[],_attachEvents:function _attachEvents(){this._detachEvents();if(this.isInput){this._events=[[this.element,{focus:$.proxy(this.show,this),keyup:$.proxy(this.update,this),keydown:$.proxy(this.keydown,this)}]];}else if(this.component&&this.hasInput){this._events=[[this.element.find('input'),{focus:$.proxy(this.show,this),keyup:$.proxy(this.update,this),keydown:$.proxy(this.keydown,this)}],[this.component,{click:$.proxy(this.show,this)}]];if(this.componentReset){this._events.push([this.componentReset,{click:$.proxy(this.reset,this)}]);}}else if(this.element.is('div')){this.isInline=true;}else{this._events=[[this.element,{click:$.proxy(this.show,this)}]];}
for(var i=0,el,ev;i<this._events.length;i++){el=this._events[i][0];ev=this._events[i][1];el.on(ev);}},_detachEvents:function _detachEvents(){for(var i=0,el,ev;i<this._events.length;i++){el=this._events[i][0];ev=this._events[i][1];el.off(ev);}
this._events=[];},show:function show(e){this.picker.show();this.height=this.component?this.component.outerHeight():this.element.outerHeight();if(this.forceParse){this.update();}
this.place();$(window).on('resize',$.proxy(this.place,this));if(e){e.stopPropagation();e.preventDefault();}
this.isVisible=true;this.element.trigger({type:'show',date:this.date});},hide:function hide(e){if(!this.isVisible)return;if(this.isInline)return;this.picker.hide();$(window).off('resize',this.place);this.viewMode=this.startViewMode;this.showMode();if(!this.isInput){$(document).off('mousedown',this.hide);}
if(this.forceParse&&(this.isInput&&this.showWeek?this.dataNOW:this.element.val()||this.hasInput&&this.showWeek?this.dataNOW:this.element.find('input').val()))this.setValue();this.isVisible=false;this.element.trigger({type:'hide',date:this.date});},remove:function remove(){this._detachEvents();this.picker.remove();delete this.picker;delete this.element.data().datetimepicker;},getDate:function getDate(){var d=this.getUTCDate();return new Date(d.getTime()+d.getTimezoneOffset()*60000);},getUTCDate:function getUTCDate(){return this.date;},setDate:function setDate(d){this.setUTCDate(new Date(d.getTime()-d.getTimezoneOffset()*60000));},setUTCDate:function setUTCDate(d){if(d>=this.startDate&&d<=this.endDate){this.date=d;this.setValue();this.viewDate=this.date;this.fill();}else{this.element.trigger({type:'outOfRange',date:d,startDate:this.startDate,endDate:this.endDate});}},setFormat:function setFormat(format){this.format=DPGlobal.parseFormat(format,this.formatType);var element;if(this.isInput){element=this.element;}else if(this.component){element=this.element.find('input');}
if(element&&element.val()){this.setValue();}},setValue:function setValue(){var formatted=this.getFormattedDate();if(this.showWeek){this.dataNOW=formatted;}
if(!this.isInput){if(this.component){if(this.showWeek){if(this.weeklyString){this.element.find('input').val(this.weeklyString);}}else{this.element.find('input').val(formatted);}}
this.element.data('date',formatted);}else{if(this.showWeek){this.element.val(this.weeklyString);}else{this.element.val(formatted);}}
if(this.linkField){$('#'+this.linkField).val(this.getFormattedDate(this.linkFormat));}},getFormattedDate:function getFormattedDate(format){if(format==undefined)format=this.format;return DPGlobal.formatDate(this.date,format,this.language,this.formatType);},setStartDate:function setStartDate(startDate){this.startDate=startDate||-Infinity;if(this.startDate!==-Infinity){this.startDate=DPGlobal.parseDate(this.startDate,this.format,this.language,this.formatType);}
this.update();this.updateNavArrows();},setEndDate:function setEndDate(endDate){this.endDate=endDate||Infinity;if(this.endDate!==Infinity){this.endDate=DPGlobal.parseDate(this.endDate,this.format,this.language,this.formatType);}
this.update();this.updateNavArrows();},setDaysOfWeekDisabled:function setDaysOfWeekDisabled(daysOfWeekDisabled){this.daysOfWeekDisabled=daysOfWeekDisabled||[];if(!$.isArray(this.daysOfWeekDisabled)){this.daysOfWeekDisabled=this.daysOfWeekDisabled.split(/,\s*/);}
this.daysOfWeekDisabled=$.map(this.daysOfWeekDisabled,function(d){return parseInt(d,10);});this.update();this.updateNavArrows();},place:function place(){if(this.isInline)return;var index_highest=0;$('div').each(function(){var index_current=parseInt($(this).css("zIndex"),10);if(index_current>index_highest){index_highest=index_current;}});var zIndex=index_highest+10;var offset,top,left,containerOffset;if(this.container instanceof $){containerOffset=this.container.offset();}else{containerOffset=$(this.container).offset();}
if(this.component){offset=this.component.offset();left=offset.left;if(this.pickerPosition=='bottom-left'||this.pickerPosition=='top-left'){left+=this.component.outerWidth()-this.picker.outerWidth();}}else{offset=this.element.offset();left=offset.left;}
if(left+220>document.body.clientWidth){left=document.body.clientWidth-220;}
if(this.pickerPosition=='top-left'||this.pickerPosition=='top-right'){top=offset.top-this.picker.outerHeight();}else{top=offset.top+this.height;}
top=top-containerOffset.top;left=left-containerOffset.left;this.picker.css({top:top,left:left,zIndex:zIndex});},update:function update(){var date,fromArgs=false;if(arguments&&arguments.length&&(typeof arguments[0]==='string'||arguments[0]instanceof Date)){date=arguments[0];fromArgs=true;}else{date=(this.isInput?this.showWeek?this.dataNOW:this.element.val():this.showWeek?this.dataNOW:this.element.find('input').val())||this.element.data('date')||this.initialDate;if(typeof date=='string'||date instanceof String){date=date.replace(/^\s+|\s+$/g,'');}}
if(!date){date=new Date();fromArgs=false;}
this.date=DPGlobal.parseDate(new Date(date),this.format,this.language,this.formatType);if(fromArgs)this.setValue();if(this.date<this.startDate){this.viewDate=new Date(this.startDate);}else if(this.date>this.endDate){this.viewDate=new Date(this.endDate);}else{this.viewDate=new Date(this.date);}
this.fill();},fillDow:function fillDow(){var dowCnt=this.weekStart,html=this.showWeek?'<tr><th class="ui-week">WK</th>':html='<tr>';while(dowCnt<this.weekStart+7){html+='<th class="dow">'+dates[this.language].daysMin[dowCnt++%7]+'</th>';}
html+='</tr>';this.picker.find('.datetimepicker-days thead').append(html);},iso8601Week:function iso8601Week(date){var addOneDayDate=new Date(new Date(date).getTime()+24*60*60*1000);var time,checkDate=new Date(addOneDayDate.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},fillMonths:function fillMonths(){var html='',i=0;while(i<12){html+='<span class="month">'+dates[this.language].monthsShort[i++]+'</span>';}
this.picker.find('.datetimepicker-months td').html(html);},fill:function fill(){if(this.date==null||this.viewDate==null){return;}
var d=new Date(this.viewDate),year=d.getUTCFullYear(),month=d.getUTCMonth(),dayMonth=d.getUTCDate(),hours=d.getUTCHours(),minutes=d.getUTCMinutes(),startYear=this.startDate!==-Infinity?this.startDate.getUTCFullYear():-Infinity,startMonth=this.startDate!==-Infinity?this.startDate.getUTCMonth():-Infinity,endYear=this.endDate!==Infinity?this.endDate.getUTCFullYear():Infinity,endMonth=this.endDate!==Infinity?this.endDate.getUTCMonth():Infinity,currentDate=new UTCDate(this.date.getUTCFullYear(),this.date.getUTCMonth(),this.date.getUTCDate()).valueOf(),today=new Date();this.picker.find('.datetimepicker-days thead th:eq(1)').text(dates[this.language].months[month]+' '+year);if(this.formatViewType=="time"){var hourConverted=hours%12?hours%12:12;var hoursDisplay=(hourConverted<10?'0':'')+hourConverted;var minutesDisplay=(minutes<10?'0':'')+minutes;var meridianDisplay=dates[this.language].meridiem[hours<12?0:1];this.picker.find('.datetimepicker-hours thead th:eq(1)').text(hoursDisplay+':'+minutesDisplay+' '+(meridianDisplay?meridianDisplay.toUpperCase():''));this.picker.find('.datetimepicker-minutes thead th:eq(1)').text(hoursDisplay+':'+minutesDisplay+' '+(meridianDisplay?meridianDisplay.toUpperCase():''));}else{this.picker.find('.datetimepicker-hours thead th:eq(1)').text(dayMonth+' '+dates[this.language].months[month]+' '+year);this.picker.find('.datetimepicker-minutes thead th:eq(1)').text(dayMonth+' '+dates[this.language].months[month]+' '+year);}
if(this.showWeek){this.picker.find('tfoot th.today').text(dates[this.language].week).toggle(this.todayBtn!==false);}else{this.picker.find('tfoot th.today').text(dates[this.language].today).toggle(this.todayBtn!==false);}
this.updateNavArrows();this.fillMonths();var prevMonth=UTCDate(year,month-1,28,0,0,0,0),day=DPGlobal.getDaysInMonth(prevMonth.getUTCFullYear(),prevMonth.getUTCMonth());prevMonth.setUTCDate(day);prevMonth.setUTCDate(day-(prevMonth.getUTCDay()-this.weekStart+7)%7);var nextMonth=new Date(prevMonth);nextMonth.setUTCDate(nextMonth.getUTCDate()+42);nextMonth=nextMonth.valueOf();var html=[];var clsName;while(prevMonth.valueOf()<nextMonth){if(prevMonth.getUTCDay()==this.weekStart){this.showWeek?html.push('<tr class="ui-week-tr"><td class="ui-week-col">'+this.iso8601Week(new Date(prevMonth.valueOf()))+'</td>'):html.push('<tr>');}
clsName='';if(prevMonth.getUTCFullYear()<year||prevMonth.getUTCFullYear()==year&&prevMonth.getUTCMonth()<month){clsName+=' old';}else if(prevMonth.getUTCFullYear()>year||prevMonth.getUTCFullYear()==year&&prevMonth.getUTCMonth()>month){clsName+=' new';}
if(this.todayHighlight&&prevMonth.getUTCFullYear()==today.getFullYear()&&prevMonth.getUTCMonth()==today.getMonth()&&prevMonth.getUTCDate()==today.getDate()){clsName+=' today';}
if(prevMonth.valueOf()==currentDate){if(!this.showWeek){clsName+=' active';}}
if(prevMonth.valueOf()+86400000<=this.startDate||prevMonth.valueOf()>this.endDate||$.inArray(prevMonth.getUTCDay(),this.daysOfWeekDisabled)!==-1){clsName+=' disabled';}
html.push('<td class="day'+clsName+'">'+prevMonth.getUTCDate()+'</td>');if(prevMonth.getUTCDay()==this.weekEnd){html.push('</tr>');}
prevMonth.setUTCDate(prevMonth.getUTCDate()+1);}
this.picker.find('.datetimepicker-days tbody').empty().append(html.join(''));html=[];var txt='',meridian='',meridianOld='';for(var i=0;i<24;i++){var actual=UTCDate(year,month,dayMonth,i);clsName='';if(actual.valueOf()+3600000<=this.startDate||actual.valueOf()>this.endDate){clsName+=' disabled';}else if(hours==i){clsName+=' active';}
if(this.showMeridian&&dates[this.language].meridiem.length==2){meridian=i<12?dates[this.language].meridiem[0]:dates[this.language].meridiem[1];if(meridian!=meridianOld){if(meridianOld!=''){html.push('</fieldset>');}
html.push('<fieldset class="hour"><legend>'+meridian.toUpperCase()+'</legend>');}
meridianOld=meridian;txt=i%12?i%12:12;html.push('<span class="hour'+clsName+' hour_'+(i<12?'am':'pm')+'">'+txt+'</span>');if(i==23){html.push('</fieldset>');}}else{txt=i+':00';html.push('<span class="hour'+clsName+'">'+txt+'</span>');}}
this.picker.find('.datetimepicker-hours td').html(html.join(''));html=[];txt='',meridian='',meridianOld='';for(var i=0;i<60;i+=this.minuteStep){var actual=UTCDate(year,month,dayMonth,hours,i,0);clsName='';if(actual.valueOf()<this.startDate||actual.valueOf()>this.endDate){clsName+=' disabled';}else if(Math.floor(minutes/this.minuteStep)==Math.floor(i/this.minuteStep)){clsName+=' active';}
if(this.showMeridian&&dates[this.language].meridiem.length==2){meridian=hours<12?dates[this.language].meridiem[0]:dates[this.language].meridiem[1];if(meridian!=meridianOld){if(meridianOld!=''){html.push('</fieldset>');}
html.push('<fieldset class="minute"><legend>'+meridian.toUpperCase()+'</legend>');}
meridianOld=meridian;txt=hours%12?hours%12:12;html.push('<span class="minute'+clsName+'">'+txt+':'+(i<10?'0'+i:i)+'</span>');if(i==59){html.push('</fieldset>');}}else{txt=i+':00';html.push('<span class="minute'+clsName+'">'+hours+':'+(i<10?'0'+i:i)+'</span>');}}
this.picker.find('.datetimepicker-minutes td').html(html.join(''));var currentYear=this.date.getUTCFullYear();var months=this.picker.find('.datetimepicker-months').find('th:eq(1)').text(year).end().find('span.month').removeClass('active');if(currentYear==year){months.eq(this.date.getMonth()).addClass('active');}
if(year<startYear||year>endYear){months.addClass('disabled');}
if(year==startYear){months.slice(0,startMonth).addClass('disabled');}
if(year==endYear){months.slice(endMonth+1).addClass('disabled');}
html='';year=parseInt(year/10,10)*10;var yearCont=this.picker.find('.datetimepicker-years').find('th:eq(1)').text(year+'-'+(year+9)).end().find('td');year-=1;for(var i=-1;i<11;i++){html+='<span class="year'+(i==-1||i==10?' old':'')+(currentYear==year?' active':'')+(year<startYear||year>endYear?' disabled':'')+'">'+year+'</span>';year+=1;}
yearCont.html(html);this.place();},updateNavArrows:function updateNavArrows(){var d=new Date(this.viewDate),year=d.getUTCFullYear(),month=d.getUTCMonth(),day=d.getUTCDate(),hour=d.getUTCHours();switch(this.viewMode){case 0:if(this.startDate!==-Infinity&&year<=this.startDate.getUTCFullYear()&&month<=this.startDate.getUTCMonth()&&day<=this.startDate.getUTCDate()&&hour<=this.startDate.getUTCHours()){this.picker.find('.prev').css({visibility:'hidden'});}else{this.picker.find('.prev').css({visibility:'visible'});}
if(this.endDate!==Infinity&&year>=this.endDate.getUTCFullYear()&&month>=this.endDate.getUTCMonth()&&day>=this.endDate.getUTCDate()&&hour>=this.endDate.getUTCHours()){this.picker.find('.next').css({visibility:'hidden'});}else{this.picker.find('.next').css({visibility:'visible'});}
break;case 1:if(this.startDate!==-Infinity&&year<=this.startDate.getUTCFullYear()&&month<=this.startDate.getUTCMonth()&&day<=this.startDate.getUTCDate()){this.picker.find('.prev').css({visibility:'hidden'});}else{this.picker.find('.prev').css({visibility:'visible'});}
if(this.endDate!==Infinity&&year>=this.endDate.getUTCFullYear()&&month>=this.endDate.getUTCMonth()&&day>=this.endDate.getUTCDate()){this.picker.find('.next').css({visibility:'hidden'});}else{this.picker.find('.next').css({visibility:'visible'});}
break;case 2:if(this.startDate!==-Infinity&&year<=this.startDate.getUTCFullYear()&&month<=this.startDate.getUTCMonth()){this.picker.find('.prev').css({visibility:'hidden'});}else{this.picker.find('.prev').css({visibility:'visible'});}
if(this.endDate!==Infinity&&year>=this.endDate.getUTCFullYear()&&month>=this.endDate.getUTCMonth()){this.picker.find('.next').css({visibility:'hidden'});}else{this.picker.find('.next').css({visibility:'visible'});}
break;case 3:case 4:if(this.startDate!==-Infinity&&year<=this.startDate.getUTCFullYear()){this.picker.find('.prev').css({visibility:'hidden'});}else{this.picker.find('.prev').css({visibility:'visible'});}
if(this.endDate!==Infinity&&year>=this.endDate.getUTCFullYear()){this.picker.find('.next').css({visibility:'hidden'});}else{this.picker.find('.next').css({visibility:'visible'});}
break;}},mousewheel:function mousewheel(e){e.preventDefault();e.stopPropagation();if(this.wheelPause){return;}
this.wheelPause=true;var originalEvent=e.originalEvent;var delta=originalEvent.wheelDelta;var mode=delta>0?1:delta===0?0:-1;if(this.wheelViewModeNavigationInverseDirection){mode=-mode;}
this.showMode(mode);setTimeout($.proxy(function(){this.wheelPause=false;},this),this.wheelViewModeNavigationDelay);},click:function click(e){e.stopPropagation();e.preventDefault();var target=$(e.target).closest('span, td, th, legend');if(target.is('.glyphicon')){target=$(target).parent().closest('span, td, th, legend');}
if(target.length==1){if(target.is('.disabled')){this.element.trigger({type:'outOfRange',date:this.viewDate,startDate:this.startDate,endDate:this.endDate});return;}
switch(target[0].nodeName.toLowerCase()){case'th':switch(target[0].className){case'switch':this.showMode(1);break;case'prev':case'next':var dir=DPGlobal.modes[this.viewMode].navStep*(target[0].className=='prev'?-1:1);switch(this.viewMode){case 0:this.viewDate=this.moveHour(this.viewDate,dir);break;case 1:this.viewDate=this.moveDate(this.viewDate,dir);break;case 2:this.viewDate=this.moveMonth(this.viewDate,dir);break;case 3:case 4:this.viewDate=this.moveYear(this.viewDate,dir);break;}
this.fill();this.element.trigger({type:target[0].className+':'+this.convertViewModeText(this.viewMode),date:this.viewDate,startDate:this.startDate,endDate:this.endDate});break;case'today':var date=new Date();if(this.showWeek){var week=this.iso8601Week(date);this.weeklyString=date.getFullYear()+'-'+week+'-'+'week';}
date=UTCDate(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes(),date.getSeconds(),0);if(date<this.startDate)date=this.startDate;else if(date>this.endDate)date=this.endDate;this.viewMode=this.startViewMode;this.showMode(0);this._setDate(date);this.fill();if(this.autoclose){this.hide();}
if(this.showWeek){this.element.trigger({type:'goToToday',date:this.viewDate,week:week});this.picker.find('.datetimepicker-days').find('tr').removeClass('active');this.picker.find('.datetimepicker-days').find('td').each(function(){if($(this).text()==week){$(this).parent().addClass('active');}});}
break;}
break;case'span':if(!target.is('.disabled')){var year=this.viewDate.getUTCFullYear(),month=this.viewDate.getUTCMonth(),day=this.viewDate.getUTCDate(),hours=this.viewDate.getUTCHours(),minutes=this.viewDate.getUTCMinutes(),seconds=this.viewDate.getUTCSeconds();if(target.is('.month')){this.viewDate.setUTCDate(1);month=target.parent().find('span').index(target);day=this.viewDate.getUTCDate();this.viewDate.setUTCMonth(month);this.element.trigger({type:'changeMonth',date:this.viewDate});if(this.viewSelect>=3){this._setDate(UTCDate(year,month,day,hours,minutes,seconds,0));}}else if(target.is('.year')){this.viewDate.setUTCDate(1);year=parseInt(target.text(),10)||0;this.viewDate.setUTCFullYear(year);this.element.trigger({type:'changeYear',date:this.viewDate});if(this.viewSelect>=4){this._setDate(UTCDate(year,month,day,hours,minutes,seconds,0));}}else if(target.is('.hour')){hours=parseInt(target.text(),10)||0;if(target.hasClass('hour_am')||target.hasClass('hour_pm')){if(hours==12&&target.hasClass('hour_am')){hours=0;}else if(hours!=12&&target.hasClass('hour_pm')){hours+=12;}}
this.viewDate.setUTCHours(hours);this.element.trigger({type:'changeHour',date:this.viewDate});if(this.viewSelect>=1){this._setDate(UTCDate(year,month,day,hours,minutes,seconds,0));}}else if(target.is('.minute')){minutes=parseInt(target.text().substr(target.text().indexOf(':')+1),10)||0;this.viewDate.setUTCMinutes(minutes);this.element.trigger({type:'changeMinute',date:this.viewDate});if(this.viewSelect>=0){this._setDate(UTCDate(year,month,day,hours,minutes,seconds,0));}}
if(this.viewMode!=0){var oldViewMode=this.viewMode;this.showMode(-1);this.fill();if(oldViewMode==this.viewMode&&this.autoclose){this.hide();}}else{this.fill();if(this.autoclose){this.hide();}}}
break;case'td':if(target.is('.day')&&!target.is('.disabled')){var day=parseInt(target.text(),10)||1;var year=this.viewDate.getUTCFullYear(),month=this.viewDate.getUTCMonth(),hours=this.viewDate.getUTCHours(),minutes=this.viewDate.getUTCMinutes(),seconds=this.viewDate.getUTCSeconds();if(target.is('.old')){if(month===0){month=11;year-=1;}else{month-=1;}}else if(target.is('.new')){if(month==11){month=0;year+=1;}else{month+=1;}}
this.viewDate.setUTCFullYear(year);this.viewDate.setUTCMonth(month,day);this.currentTR=$(e.target).parent().index();if(this.showWeek){this.weeklyString=new Date(this.viewDate).getFullYear()+'-'+$(e.target).parent().find('td:first').text()+'-week';this.element.trigger({type:'changeDay',date:this.viewDate,week:$(e.target).parent().find('td:first').text(),target:e.target,weeklyString:this.weeklyString,currentTr:this.currentTR});}else{this.element.trigger({type:'changeDay',date:this.viewDate});}
if(this.viewSelect>=2){this._setDate(UTCDate(year,month,day,hours,minutes,seconds,0));}}
var oldViewMode=this.viewMode;this.showMode(-1);this.fill();if(oldViewMode==this.viewMode&&this.autoclose){this.hide();}
break;}}},_setDate:function _setDate(date,which){if(!which||which=='date')this.date=date;if(!which||which=='view')this.viewDate=date;this.fill();this.setValue();var element;if(this.isInput){element=this.element;}else if(this.component){element=this.element.find('input');}
if(element){element.change();if(this.autoclose&&(!which||which=='date')){}}
this.element.trigger({type:'changeDate',date:this.date});},moveMinute:function moveMinute(date,dir){if(!dir)return date;var new_date=new Date(date.valueOf());new_date.setUTCMinutes(new_date.getUTCMinutes()+dir*this.minuteStep);return new_date;},moveHour:function moveHour(date,dir){if(!dir)return date;var new_date=new Date(date.valueOf());new_date.setUTCHours(new_date.getUTCHours()+dir);return new_date;},moveDate:function moveDate(date,dir){if(!dir)return date;var new_date=new Date(date.valueOf());new_date.setUTCDate(new_date.getUTCDate()+dir);return new_date;},moveMonth:function moveMonth(date,dir){if(!dir)return date;var new_date=new Date(date.valueOf()),day=new_date.getUTCDate(),month=new_date.getUTCMonth(),mag=Math.abs(dir),new_month,test;dir=dir>0?1:-1;if(mag==1){test=dir==-1?function(){return new_date.getUTCMonth()==month;}:function(){return new_date.getUTCMonth()!=new_month;};new_month=month+dir;new_date.setUTCMonth(new_month);if(new_month<0||new_month>11)new_month=(new_month+12)%12;}else{for(var i=0;i<mag;i++){new_date=this.moveMonth(new_date,dir);}
new_month=new_date.getUTCMonth();new_date.setUTCDate(day);test=function test(){return new_month!=new_date.getUTCMonth();};}
while(test()){new_date.setUTCDate(--day);new_date.setUTCMonth(new_month);}
return new_date;},moveYear:function moveYear(date,dir){return this.moveMonth(date,dir*12);},dateWithinRange:function dateWithinRange(date){return date>=this.startDate&&date<=this.endDate;},keydown:function keydown(e){if(this.picker.is(':not(:visible)')){if(e.keyCode==27)
this.show();return;}
var dateChanged=false,dir,day,month,newDate,newViewDate;switch(e.keyCode){case 27:this.hide();e.preventDefault();break;case 37:case 39:if(!this.keyboardNavigation)break;dir=e.keyCode==37?-1:1;viewMode=this.viewMode;if(e.ctrlKey){viewMode+=2;}else if(e.shiftKey){viewMode+=1;}
if(viewMode==4){newDate=this.moveYear(this.date,dir);newViewDate=this.moveYear(this.viewDate,dir);}else if(viewMode==3){newDate=this.moveMonth(this.date,dir);newViewDate=this.moveMonth(this.viewDate,dir);}else if(viewMode==2){newDate=this.moveDate(this.date,dir);newViewDate=this.moveDate(this.viewDate,dir);}else if(viewMode==1){newDate=this.moveHour(this.date,dir);newViewDate=this.moveHour(this.viewDate,dir);}else if(viewMode==0){newDate=this.moveMinute(this.date,dir);newViewDate=this.moveMinute(this.viewDate,dir);}
if(this.dateWithinRange(newDate)){this.date=newDate;this.viewDate=newViewDate;this.setValue();this.update();e.preventDefault();dateChanged=true;}
break;case 38:case 40:if(!this.keyboardNavigation)break;dir=e.keyCode==38?-1:1;viewMode=this.viewMode;if(e.ctrlKey){viewMode+=2;}else if(e.shiftKey){viewMode+=1;}
if(viewMode==4){newDate=this.moveYear(this.date,dir);newViewDate=this.moveYear(this.viewDate,dir);}else if(viewMode==3){newDate=this.moveMonth(this.date,dir);newViewDate=this.moveMonth(this.viewDate,dir);}else if(viewMode==2){newDate=this.moveDate(this.date,dir*7);newViewDate=this.moveDate(this.viewDate,dir*7);}else if(viewMode==1){if(this.showMeridian){newDate=this.moveHour(this.date,dir*6);newViewDate=this.moveHour(this.viewDate,dir*6);}else{newDate=this.moveHour(this.date,dir*4);newViewDate=this.moveHour(this.viewDate,dir*4);}}else if(viewMode==0){newDate=this.moveMinute(this.date,dir*4);newViewDate=this.moveMinute(this.viewDate,dir*4);}
if(this.dateWithinRange(newDate)){this.date=newDate;this.viewDate=newViewDate;this.setValue();this.update();e.preventDefault();dateChanged=true;}
break;case 13:if(this.viewMode!=0){var oldViewMode=this.viewMode;this.showMode(-1);this.fill();if(oldViewMode==this.viewMode&&this.autoclose){this.hide();}}else{this.fill();if(this.autoclose){this.hide();}}
e.preventDefault();break;case 9:this.hide();break;}
if(dateChanged){var element;if(this.isInput){element=this.element;}else if(this.component){element=this.element.find('input');}
if(element){element.change();}
this.element.trigger({type:'changeDate',date:this.date});}},showMode:function showMode(dir){if(dir){var newViewMode=Math.max(0,Math.min(DPGlobal.modes.length-1,this.viewMode+dir));if(newViewMode>=this.minView&&newViewMode<=this.maxView){this.element.trigger({type:'changeMode',date:this.viewDate,oldViewMode:this.viewMode,newViewMode:newViewMode});this.viewMode=newViewMode;}}
this.picker.find('>div').hide().filter('.datetimepicker-'+DPGlobal.modes[this.viewMode].clsName).css('display','block');this.updateNavArrows();},reset:function reset(e){this._setDate(null,'date');},convertViewModeText:function convertViewModeText(viewMode){switch(viewMode){case 4:return'decade';case 3:return'year';case 2:return'month';case 1:return'day';case 0:return'hour';}}};$.fn.datetimepicker=function(option){var args=Array.apply(null,arguments);args.shift();var internal_return;this.each(function(){var $this=$(this),data=$this.data('datetimepicker'),options=(typeof option==='undefined'?'undefined':_typeof(option))=='object'&&option;if(!data){$this.data('datetimepicker',data=new Datetimepicker(this,$.extend({},$.fn.datetimepicker.defaults,options)));}
if(typeof option=='string'&&typeof data[option]=='function'){internal_return=data[option].apply(data,args);if(internal_return!==undefined){return false;}}});if(internal_return!==undefined)return internal_return;else return this;};$.fn.datetimepicker.defaults={};$.fn.datetimepicker.Constructor=Datetimepicker;var dates=$.fn.datetimepicker.dates={en:{days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],daysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],daysMin:["Su","Mo","Tu","We","Th","Fr","Sa","Su"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],meridiem:["am","pm"],suffix:["st","nd","rd","th"],today:"Today",week:"This Week"}};var DPGlobal={modes:[{clsName:'minutes',navFnc:'Hours',navStep:1},{clsName:'hours',navFnc:'Date',navStep:1},{clsName:'days',navFnc:'Month',navStep:1},{clsName:'months',navFnc:'FullYear',navStep:1},{clsName:'years',navFnc:'FullYear',navStep:10}],isLeapYear:function isLeapYear(year){return year%4===0&&year%100!==0||year%400===0;},getDaysInMonth:function getDaysInMonth(year,month){return[31,DPGlobal.isLeapYear(year)?29:28,31,30,31,30,31,31,30,31,30,31][month];},getDefaultFormat:function getDefaultFormat(type,field){if(type=="standard"){if(field=='input')return'yyyy-mm-dd hh:ii';else return'yyyy-mm-dd hh:ii:ss';}else if(type=="php"){if(field=='input')return'Y-m-d H:i';else return'Y-m-d H:i:s';}else{throw new Error("Invalid format type.");}},validParts:function validParts(type){if(type=="standard"){return(/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g);}else if(type=="php"){return(/[dDjlNwzFmMnStyYaABgGhHis]/g);}else{throw new Error("Invalid format type.");}},nonpunctuation:/[^ -\/:-@\[-`{-~\t\n\rTZ]+/g,parseFormat:function parseFormat(format,type){var separators=format.replace(this.validParts(type),'\0').split('\0');parts=format.match(this.validParts(type));if(extend.monthAbbreviation){parts[0]=='MM'?parts[0]='M':'';}
if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};},parseDate:function parseDate(date,format,language,type){if(date instanceof Date){var dateUTC=new Date(date.valueOf()-date.getTimezoneOffset()*60000);dateUTC.setMilliseconds(0);return dateUTC;}
if(/^\d{4}\-\d{1,2}\-\d{1,2}$/.test(date)){format=this.parseFormat('yyyy-mm-dd',type);}
if(/^\d{4}\-\d{1,2}\-\d{1,2}[T ]\d{1,2}\:\d{1,2}$/.test(date)){format=this.parseFormat('yyyy-mm-dd hh:ii',type);}
if(/^\d{4}\-\d{1,2}\-\d{1,2}[T ]\d{1,2}\:\d{1,2}\:\d{1,2}[Z]{0,1}$/.test(date)){format=this.parseFormat('yyyy-mm-dd hh:ii:ss',type);}
if(/^[-+]\d+[dmwy]([\s,]+[-+]\d+[dmwy])*$/.test(date)){var part_re=/([-+]\d+)([dmwy])/,parts=date.match(/([-+]\d+)([dmwy])/g),part,dir;date=new Date();for(var i=0;i<parts.length;i++){part=part_re.exec(parts[i]);dir=parseInt(part[1]);switch(part[2]){case'd':date.setUTCDate(date.getUTCDate()+dir);break;case'm':date=Datetimepicker.prototype.moveMonth.call(Datetimepicker.prototype,date,dir);break;case'w':date.setUTCDate(date.getUTCDate()+dir*7);break;case'y':date=Datetimepicker.prototype.moveYear.call(Datetimepicker.prototype,date,dir);break;}}
return UTCDate(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate(),date.getUTCHours(),date.getUTCMinutes(),date.getUTCSeconds(),0);}
var parts=date&&date.match(this.nonpunctuation)||[],date=new Date(0,0,0,0,0,0,0),parsed={},setters_order=['hh','h','ii','i','ss','s','yyyy','yy','M','MM','m','mm','D','DD','d','dd','H','HH','p','P'],setters_map={hh:function hh(d,v){return d.setUTCHours(v);},h:function h(d,v){return d.setUTCHours(v);},HH:function HH(d,v){return d.setUTCHours(v==12?0:v);},H:function H(d,v){return d.setUTCHours(v==12?0:v);},ii:function ii(d,v){return d.setUTCMinutes(v);},i:function i(d,v){return d.setUTCMinutes(v);},ss:function ss(d,v){return d.setUTCSeconds(v);},s:function s(d,v){return d.setUTCSeconds(v);},yyyy:function yyyy(d,v){return d.setUTCFullYear(v);},yy:function yy(d,v){return d.setUTCFullYear(2000+v);},m:function m(d,v){v-=1;while(v<0){v+=12;}v%=12;d.setUTCMonth(v);while(d.getUTCMonth()!=v){if(isNaN(d.getUTCMonth()))return d;else d.setUTCDate(d.getUTCDate()-1);}return d;},d:function d(_d,v){return _d.setUTCDate(v);},p:function p(d,v){return d.setUTCHours(v==1?d.getUTCHours()+12:d.getUTCHours());}},val,filtered,part;setters_map['M']=setters_map['MM']=setters_map['mm']=setters_map['m'];setters_map['dd']=setters_map['d'];setters_map['P']=setters_map['p'];date=UTCDate(date.getFullYear(),date.getMonth(),date.getDate(),date.getHours(),date.getMinutes(),date.getSeconds());if(parts.length==format.parts.length){for(var i=0,cnt=format.parts.length;i<cnt;i++){val=parseInt(parts[i],10);part=format.parts[i];if(isNaN(val)){switch(part){case'MM':filtered=$(dates[language].months).filter(function(){var m=this.slice(0,parts[i].length),p=parts[i].slice(0,m.length);return m==p;});val=$.inArray(filtered[0],dates[language].months)+1;break;case'M':filtered=$(dates[language].monthsShort).filter(function(){var m=this.slice(0,parts[i].length),p=parts[i].slice(0,m.length);return m.toLowerCase()==p.toLowerCase();});val=$.inArray(filtered[0],dates[language].monthsShort)+1;break;case'p':case'P':val=$.inArray(parts[i].toLowerCase(),dates[language].meridiem);break;}}
parsed[part]=val;}
for(var i=0,s;i<setters_order.length;i++){s=setters_order[i];if(s in parsed&&!isNaN(parsed[s]))setters_map[s](date,parsed[s]);}}
return date;},formatDate:function formatDate(date,format,language,type){if(date==null){return'';}
var val;if(type=='standard'){val={yy:date.getUTCFullYear().toString().substring(2),yyyy:date.getUTCFullYear(),m:date.getUTCMonth()+1,M:dates[language].monthsShort[date.getUTCMonth()],MM:dates[language].months[date.getUTCMonth()],d:date.getUTCDate(),D:dates[language].daysShort[date.getUTCDay()],DD:dates[language].days[date.getUTCDay()],p:dates[language].meridiem.length==2?dates[language].meridiem[date.getUTCHours()<12?0:1]:'',h:date.getUTCHours(),i:date.getUTCMinutes(),s:date.getUTCSeconds()};if(dates[language].meridiem.length==2){val.H=val.h%12==0?12:val.h%12;}else{val.H=val.h;}
val.HH=(val.H<10?'0':'')+val.H;val.P=val.p.toUpperCase();val.hh=(val.h<10?'0':'')+val.h;val.ii=(val.i<10?'0':'')+val.i;val.ss=(val.s<10?'0':'')+val.s;val.dd=(val.d<10?'0':'')+val.d;val.mm=(val.m<10?'0':'')+val.m;}else if(type=='php'){val={y:date.getUTCFullYear().toString().substring(2),Y:date.getUTCFullYear(),F:dates[language].months[date.getUTCMonth()],M:dates[language].monthsShort[date.getUTCMonth()],n:date.getUTCMonth()+1,t:DPGlobal.getDaysInMonth(date.getUTCFullYear(),date.getUTCMonth()),j:date.getUTCDate(),l:dates[language].days[date.getUTCDay()],D:dates[language].daysShort[date.getUTCDay()],w:date.getUTCDay(),N:date.getUTCDay()==0?7:date.getUTCDay(),S:date.getUTCDate()%10<=dates[language].suffix.length?dates[language].suffix[date.getUTCDate()%10-1]:'',a:dates[language].meridiem.length==2?dates[language].meridiem[date.getUTCHours()<12?0:1]:'',g:date.getUTCHours()%12==0?12:date.getUTCHours()%12,G:date.getUTCHours(),i:date.getUTCMinutes(),s:date.getUTCSeconds()};val.m=(val.n<10?'0':'')+val.n;val.d=(val.j<10?'0':'')+val.j;val.A=val.a.toString().toUpperCase();val.h=(val.g<10?'0':'')+val.g;val.H=(val.G<10?'0':'')+val.G;val.i=(val.i<10?'0':'')+val.i;val.s=(val.s<10?'0':'')+val.s;}else{throw new Error("Invalid format type.");}
var date=[],seps=$.extend([],format.separators);for(var i=0,cnt=format.parts.length;i<cnt;i++){if(seps.length){date.push(seps.shift());}
date.push(val[format.parts[i]]);}
if(seps.length){date.push(seps.shift());}
return date.join('');},convertViewMode:function convertViewMode(viewMode){switch(viewMode){case 4:case'decade':viewMode=4;break;case 3:case'year':viewMode=3;break;case 2:case'month':viewMode=2;break;case 1:case'day':viewMode=1;break;case 0:case'hour':viewMode=0;break;}
return viewMode;},headTemplate:'<thead>'+'<tr>'+'<th class="prev"><i class="icon-arrow-left"/></th>'+'<th colspan="5" class="switch"></th>'+'<th class="next"><i class="icon-arrow-right"/></th>'+'</tr>'+'</thead>',headTemplateV3:'<thead>'+'<tr>'+'<th class="prev"><span class="glyphicon glyphicon-arrow-left"></span> </th>'+'<th colspan="5" class="switch"></th>'+'<th class="next"><span class="glyphicon glyphicon-arrow-right"></span> </th>'+'</tr>'+'</thead>',contTemplate:'<tbody><tr><td colspan="7"></td></tr></tbody>',footTemplate:'<tfoot><tr><th colspan="7" class="today"></th></tr></tfoot>'};DPGlobal.template='<div class="datetimepicker">'+'<div class="datetimepicker-minutes">'+'<table class=" table-condensed">'+DPGlobal.headTemplate+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datetimepicker-hours">'+'<table class=" table-condensed">'+DPGlobal.headTemplate+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datetimepicker-days">'+'<table class=" table-condensed">'+DPGlobal.headTemplate+'<tbody></tbody>'+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datetimepicker-months">'+'<table class="table-condensed">'+DPGlobal.headTemplate+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datetimepicker-years">'+'<table class="table-condensed">'+DPGlobal.headTemplate+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'</div>';DPGlobal.templateV3='<div class="datetimepicker">'+'<div class="datetimepicker-minutes">'+'<table class=" table-condensed">'+DPGlobal.headTemplateV3+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datetimepicker-hours">'+'<table class=" table-condensed">'+DPGlobal.headTemplateV3+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datetimepicker-days">'+'<table class=" table-condensed">'+DPGlobal.headTemplateV3+'<tbody></tbody>'+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datetimepicker-months">'+'<table class="table-condensed">'+DPGlobal.headTemplateV3+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'<div class="datetimepicker-years">'+'<table class="table-condensed">'+DPGlobal.headTemplateV3+DPGlobal.contTemplate+DPGlobal.footTemplate+'</table>'+'</div>'+'</div>';$.fn.datetimepicker.DPGlobal=DPGlobal;$.fn.datetimepicker.noConflict=function(){$.fn.datetimepicker=old;return this;};$(document).on('focus.datetimepicker.data-api click.datetimepicker.data-api','[data-provide="datetimepicker"]',function(e){var $this=$(this);if($this.data('datetimepicker'))return;e.preventDefault();$this.datetimepicker('show');});$(function(){$('[data-provide="datetimepicker-inline"]').datetimepicker();});}(window.jQuery);var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function($){var patterns={num_01:/^[0|1]*$/,num_02:/^[0-2]*$/,num_03:/^[0-3]*$/,num_19:/^[1-9]*$/,num_09:/^[0-9]*$/,num_08:/^[0-8]*$/,num_05:/^[0-5]*$/};var regDate=new RegExp('(([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})(-|/|.)(((0[13578]|1[02])(-|/|.)(0[1-9]|[12][0-9]|3[01]))|((0[469]|11)(-|/|.)(0[1-9]|[12][0-9]|30))|(02(-|/|.)(0[1-9]|[1][0-9]|2[0-8]))))|((([0-9]{2})(0[48]|[2468][048]|[13579][26])|((0[48]|[2468][048]|[3579][26])00))(-|/|.)02(-|/|.)29)');var regDateYM=new RegExp('(([0-9]{3}[1-9]|[0-9]{2}[1-9][0-9]{1}|[0-9]{1}[1-9][0-9]{2}|[1-9][0-9]{3})(-|/|.)(((0[13578]|1[02]))|((0[469]|11))))|((([0-9]{2})(0[48]|[2468][048]|[13579][26])|((0[48]|[2468][048]|[3579][26])00)))');var regTime=/^(?:[01]\d|2[0-3])(?::[0-5]\d)$/;var arrKW=['y','M','d','H','m','h','i'];var _this;var InputDatetime=function InputDatetime(input,$dtp){this.input=input;this.$dtp=$dtp;_this=this;_this.input.pos=0;if(input.dataset.format)this.attachEvents();};InputDatetime.prototype={constructor:InputDatetime,init:function init(){},remove:function remove(){this.$dtp.datetimepicker('remove');},_events:[],attachEvents:function attachEvents(){this._detachEvents();this._events=[[this.input,{keydown:$.proxy(this.keydown,this),focus:$.proxy(this.focus,this),click:$.proxy(this.click,this),blur:$.proxy(this.blur,this),input:$.proxy(this.oninput,this),change:$.proxy(this.change,this)}]];for(var i=0,el,ev;i<this._events.length;i++){el=this._events[i][0];ev=this._events[i][1];$(el).on(ev);}},_detachEvents:function _detachEvents(){for(var i=0,el,ev;i<this._events.length;i++){el=this._events[i][0];ev=this._events[i][1];$(el).off(ev);}
this._events=[];},oninput:function oninput(e){var inputVal=this.input.value;if(inputVal.length>this.input.dataset.format.length){$(this.input).val($(this.input).data('oldVal'));this.input.selectionStart=this.input.selectionEnd=this.input.pos;}},change:function change(){if(this.input.dataset.format==='yyyy-mm-dd hh'){this.input.value=this.input.value+':00';}},keydown:function keydown(e){var keyCode=e.which;var inputVal=this.input.value;var _that=this;$(this.input).popover('hide');if(keyCode>=48&&keyCode<=57)dealWithKey();if(keyCode>=96&&keyCode<=105)dealWithNumKey();if(keyCode==8||keyCode==46||keyCode==37||keyCode==39)dealWithDelete();return false;function dealWithKey(){var strPosF,strPosFNext,strKey,isMatch=false,strPrev,dIndex,month,strDate,dateTemp;if(_that.input.pos==_that.input.dataset.format.length)return false;strKey=String.fromCharCode(keyCode);strPosF=_that.input.dataset.format.substring(_that.input.pos,_that.input.pos+1);strPosFNext=_that.input.dataset.format.substring(_that.input.pos+1,_that.input.pos+2);strPrev=inputVal.substring(_that.input.pos-1,_that.input.pos);if(strPosF==='y'){isMatch=true;}else if(strPosF==='d'){dIndex=_that.input.dataset.format.indexOf('dd');month=inputVal.substring(dIndex-3,dIndex-1);if(strPosF==strPosFNext){if(strKey=='0'){isMatch=true;}else{strDate=_that.input.value.substring(0,dIndex)+strKey+'0';}}else{strDate=_that.input.value.substring(0,dIndex+1)+strKey;}
if(isMatch==false){dateTemp=new Date(strDate.replace(/\D/g,'-'));if(dateTemp.toString()==="Invalid Date"){isMatch=false;}else if(month!=dateTemp.getMonth()+1){isMatch=false;}else{isMatch=true;}}}else if(strPosF==='H'||strPosF==='h'){if(strPosF==strPosFNext){isMatch=patterns.num_02.test(strKey);}else{if(strPrev=='0'){isMatch=patterns.num_09.test(strKey);}else if(strPrev=='2'){isMatch=patterns.num_03.test(strKey);}else{isMatch=patterns.num_09.test(strKey);}}}else if(strPosF==='i'){if(strPosF==strPosFNext){isMatch=patterns.num_05.test(strKey);}else{isMatch=patterns.num_09.test(strKey);}}else if(strPosF==='M'||strPosF==='m'){if(strPosF==strPosFNext){isMatch=patterns.num_01.test(strKey);}else{if(strPrev=='0'){isMatch=patterns.num_19.test(strKey);}else if(strPrev=='1'){isMatch=patterns.num_02.test(strKey);}}}
if(isMatch){_that.input.value=inputVal.substring(0,_that.input.pos)+strKey+inputVal.substring(_that.input.pos+1,inputVal.length);$(_that.input).data('oldVal',_that.input.value);_that.input.pos++;var strOfPos=_that.input.dataset.format.substring(_that.input.pos,_that.input.pos+1);while(strOfPos!=''&&$.inArray(strOfPos,arrKW)<0){_that.input.pos++;strOfPos=_that.input.dataset.format.substring(_that.input.pos,_that.input.pos+1);}
_this.moveCursor(_that.input);}
return false;}
function dealWithNumKey(){keyCode=keyCode-48;dealWithKey(keyCode);}
function dealWithDelete(){var strOfPos;if(keyCode==8||keyCode==46){if(_that.input.pos==_that.input.dataset.format.length&&keyCode==46)return false;if(_that.input.pos==0&&keyCode==8)return false;if(keyCode==8){_that.input.pos--;strOfPos=_that.input.dataset.format.substring(_that.input.pos,_that.input.pos+1);while(strOfPos!=''&&$.inArray(strOfPos,arrKW)<0){_that.input.pos--;strOfPos=_that.input.dataset.format.substring(_that.input.pos,_that.input.pos+1);}
_that.input.value=inputVal.substring(0,_that.input.pos)+strOfPos+inputVal.substring(_that.input.pos+1,inputVal.length);$(_that.input).data('oldVal',_that.input.value);}else if(keyCode==46&&/[0-9]/.test(_that.input.value.substring(_that.input.pos))){strOfPos=_that.input.dataset.format.substring(_that.input.pos,_that.input.pos+1);while(strOfPos!=''&&$.inArray(strOfPos,arrKW)<0){_that.input.pos++;strOfPos=_that.input.dataset.format.substring(_that.input.pos,_that.input.pos+1);}
_that.input.value=inputVal.substring(0,_that.input.pos)+strOfPos+inputVal.substring(_that.input.pos+1,inputVal.length);$(_that.input).data('oldVal',_that.input.value);_that.input.pos++;}}else{if(_that.input.pos==_that.input.dataset.format.length&&keyCode==39)return false;if(_that.input.pos==0&&keyCode==37)return false;if(keyCode==37){_that.input.pos--;}else if(keyCode==39){_that.input.pos++;}}
_this.moveCursor(_that.input);}},focus:function focus(){var inputVal=this.input.value.trim();if(inputVal==''){this.input.value=this.input.dataset.format;$(this.input).data('oldVal',this.input.value);$(this.input).popover({placement:'bottom',content:'请输入有效的时间',trigger:'focus'});}else{if(inputVal!==this.input.dataset.format&&!_this.isMatchReg(inputVal,this.input.dataset.format)){$(this.input).popover('show');}else{$(this.input).popover('hide');}}
_this.moveCursor(this.input);},moveCursor:function moveCursor(input){setTimeout(function(){input.selectionStart=input.selectionEnd=input.pos;},50);},isMatchReg:function isMatchReg(inputVal,format){var isNotShow=false;if(/^(HH|hh):ii$/.test(format)){isNotShow=regTime.test(inputVal);}else if(/ (HH|hh):ii/.test(format)){isNotShow=regDate.test(inputVal.split(' ')[0])&&regTime.test(inputVal.split(' ')[1]);}else if(new RegExp('^yyyy(-|/|.)(mm|MM)$').test(format)){isNotShow=regDateYM.test(inputVal);}else{isNotShow=regDate.test(inputVal);}
return isNotShow;},click:function click(){var strAfterCursor=this.input.value.substring(this.input.pos);if(!/[0-9]/.test(this.input.value)){this.input.selectionStart=this.input.selectionEnd=this.input.pos=0;}else if(!/[0-9]/.test(strAfterCursor)&&strAfterCursor!==''){this.input.selectionStart=this.input.selectionEnd=this.input.pos;}else{this.input.pos=this.input.selectionStart;}},blur:function blur(){var inputVal=this.input.value.trim();if(inputVal!==this.input.dataset.format&&!_this.isMatchReg(inputVal,this.input.dataset.format)&&$('.datetimepicker [class^="datetimepicker-"]').not(':hidden').length<1){$(this.input).css({border:'1px solid #d43f3a'});$(this.input).addClass('timeError');}else{$(this.input).css({border:''});$(this.input).removeClass('timeError');}}};$.fn.datetime=function(option){var format,minView,startView,maxView,btn,optDTP,$dtp,data,internal_return;this.each(function(){var $this=$(this);var input=this.tagName=="INPUT"?this:this.children[0].tagName=="INPUT"?this.children[0]:null;if(!input){console.log('not found input element');return;}
format=input.dataset.format;optDTP={format:format,autoclose:true,initialDate:new Date(),todayBtn:true};if(new RegExp('^yyyy(-|/|.)(mm|MM)(-|/|.)dd(.)* (HH|hh)(:|.)ii').test(format)){startView=4;minView=0;}else if(new RegExp('^yyyy(-|/|.)(mm|MM)(-|/|.)dd(.)* (HH|hh)').test(format)){startView=4;minView=1;}else if(new RegExp('^yyyy(-|/|.)(mm|MM)(-|/|.)dd(.)*').test(format)){startView=4;minView=2;}else if(new RegExp('^yyyy(-|/|.)(mm|MM)').test(format)){startView=4;minView=3;}else if(new RegExp('^(HH|hh):ii').test(format)){startView=maxView=1;minView=0;}
if(minView)optDTP.minView=minView;if(maxView)optDTP.maxView=maxView;if(startView)optDTP.startView=startView;if((typeof option==='undefined'?'undefined':_typeof(option))=='object'&&!$.isEmptyObject(option)){optDTP=$.extend(true,optDTP,option);}
if(input.attributes.datetimepicker){$this.datetimepicker(optDTP);$dtp=$this;}else if(input.nextElementSibling&&input.nextElementSibling.tagName=='SPAN'&&input.nextElementSibling.classList.contains('add-on')){btn=input.nextElementSibling;if(!input.id||input.id.trim()==''){alert('input element must has a id');return;}
optDTP.linkField=input.id;optDTP.linkFormat=format;$(btn).datetimepicker(optDTP);$dtp=$(btn);}
data=$this.data('datetime');if(!data){$this.data('datetime',data=new InputDatetime(input,$dtp));}
if(typeof option=='string'&&typeof data[option]=='function'){internal_return=data[option].apply(data);if(internal_return!==undefined){return false;}}});};})(jQuery);var FactoryIoC=function(){function FactoryIoC(strType){this.listClass=[];this.init(strType);};FactoryIoC.prototype={init:function init(strType){switch(strType){case'analysis':this.initAnalysisModule();break;case'dashboard':this.initDashboardModule();break;case'report':this.initReportModule();break;default:break;}},add:function add(entityClass){this.listClass.push(entityClass);},getModel:function getModel(strModelName){for(var i=0,len=this.listClass.length;i<len;i++){if(strModelName.toLowerCase()==this.listClass[i].name.toLowerCase()){return this.listClass[i];}}
return null;},getList:function getList(){return this.listClass;},initAnalysisModule:function initAnalysisModule(){this.add(AnlzTendency);this.add(AnlzSpectrum);this.add(AnlzScatter);this.add(AnlzHistoryCompare);this.add(AnlzHistoryCompare_Line);this.add(AnlzStack);this.add(AnlzPieRealtime);this.add(AnlzEnergy);this.add(AnlzCluster);this.add(AnlzCluster_AHU);this.add(AnlzCluster_Chiller);},initDashboardModule:function initDashboardModule(){this.add(ModalNone);this.add(ModalAnalysis);this.add(ModalHistoryChart);this.add(ModalHistoryChartNormal);this.add(ModalHistoryChartEnergyConsume);this.add(ModalHistoryChartYearOnYearLine);this.add(ModalHistoryChartYearOnYearBar);this.add(ModalHistoryDataAnalyze);this.add(ModalChart);this.add(ModalRealtimePieEnegBrkd);this.add(ModalRealtimeLineOutdoor);this.add(ModalRealtimeBarSub);this.add(ModalRealtimeGauge);this.add(ModalRealtimeBarEnegBrkd);this.add(ModalMultiple);this.add(ModalKPIChart);this.add(ModalObserver);this.add(ModalPredictPointLine);this.add(ModalNote);this.add(ModalRank);this.add(ModalRankNormal);this.add(ModalMix);this.add(ModalHtml);this.add(ModalChartCustom);this.add(ModalPointKPI);this.add(ModalReportChapter);typeof ModalReportFactory!="undefined"&&this.add(ModalReportFactory);this.add(ModalInteract);this.add(ModalMonitor);this.add(ModalAppChart);this.add(ModalAppGauge);this.add(ModalAppButton);this.add(ModalAppHistory);this.add(ModalHistoryDataAnalyze);this.add(ModalKPIStruct);this.add(ModalAppBlind);this.add(ModalAppDiagRanking);this.add(ModalAPPMonthHistory);this.add(ModalAppKPICollect);this.add(ModalAppPie);this.add(ModalDiagnosisPanelHtml);this.add(ModalRealtimeWeather);this.add(ModalDataMonitorList);this.add(ModalKpiOverview);this.add(ModalDiagnosisStruct);this.add(ModalCumulantChart);},initReportModule:function initReportModule(){var ns=namespace('factory.report.components');this.add(ns.Summary);this.add(ns.ChapterContainer);this.add(ns.Text);this.add(ns.Html);this.add(ns.Chart);this.add(ns.Block);this.add(ns.Table);}};return FactoryIoC;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var beop=beop||{};beop.constant={project_img_path:'/static/images/project_img/',project_default_img:'default.jpg',BEOP_IMG_HOST:'http://images.rnbtech.com.hk',OSS_PROJECT_IMG_PATH:'/custom/project_img/'};var ObjectId=function ObjectId(){var timestamp=new Date().valueOf();var userId=('000'+(AppConfig.userId||'000')).slice(-3);var hex8=('00000000'+Math.floor(Math.random()*0xFFFFFFFF).toString(16)).slice(-8);return timestamp+userId+hex8;};(function(exports){exports.namespace=function(path){var obj=window;path=path.split('.');path.forEach(function(p,i){p=p.trim();if(i===0&&p==='window')return;obj=obj[p]=obj[p]||{};});return obj;};})(window);(function(exports){exports.Mixin=function(){var prototype={};var methods;for(var i=0,len=arguments.length;i<len;i++){methods=arguments[i];for(var m in methods){prototype[m]=methods[m];}}
return prototype;};})(window);(function(){var ENUM_LEVEL={LOG:1,INFO:2,DEBUG:3,WARN:4,ERROR:5,EXCEPTION:6};window.Log={level:ENUM_LEVEL.WARN,log:function log(){if(this.level>ENUM_LEVEL.LOG)return;Log._out('log',arguments);},info:function info(){if(this.level>ENUM_LEVEL.INFO)return;Log._out('info',arguments);},debug:function debug(){if(this.level>ENUM_LEVEL.DEBUG)return;Log._out('debug',arguments);},warn:function warn(){if(this.level>ENUM_LEVEL.WARN)return;Log._out('warn',arguments);},error:function error(){if(this.level>ENUM_LEVEL.ERROR)return;Log._out('error',arguments);},exception:function exception(message,_exception){if(this.level>ENUM_LEVEL.EXCEPTION)return;if(_exception){Log.error('Exception: ',message,_exception.stack||_exception);}else{Log.error('Exception: ',message);}},_out:function _out(type,args){console[type].apply(console,args);}};})();var FullScreenManager=function(){var manager=Object.create({init:function init(){var _this=this;$(document).off('webkitfullscreenchange');$(document).on('webkitfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('mozfullscreenchange');$(document).on('mozfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('msfullscreenchange');$(document).on('msfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});if(typeof onError==='function'){$(document).off('webkitfullscreenerror');$(document).on('webkitfullscreenerror',this.onFullScreenError);$(document).off('mozfullscreenerror');$(document).on('mozfullscreenerror',this.onFullScreenError);$(document).off('msfullscreenerror');$(document).on('msfullscreenerror',this.onFullScreenError);}},onFullScreenEnter:function onFullScreenEnter(){},onFullScreenOut:function onFullScreenOut(){},onFullScreenError:function onFullScreenError(){},toggle:function toggle(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!document.msFullscreenElement){if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}}});manager.init();return manager;}();function StringBuilder(){this.data=Array("");}
StringBuilder.prototype.append=function(){this.data.push(arguments[0]);return this;};StringBuilder.prototype.toString=function(){return this.data.join("");};StringBuilder.prototype.getLength=function(){return this.data.length;};if(!String.prototype.format){String.prototype.format=function(){if(arguments[0]===undefined){return'';}
if(arguments[0].constructor===Array){var args=arguments[0];}else{var args=arguments;}
return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
if(!String.prototype.formatEL){String.prototype.formatEL=function(o){var str=this.toString();if(!str||!o)return'';for(var p in o){if(o.hasOwnProperty(p)){str=str.replace(new RegExp('{'+p+'}','g'),o[p]);}}
return str;};}
String.prototype.toDate=function(){var str=this;if(str.indexOf('-')>-1)
str=str.replace('-','/').replace('-','/');return new Date(str);};if(!String.prototype.startsWith){String.prototype.startsWith=function(word){return new RegExp('^'+word).test(this);};}
Number.prototype.toDate=function(){return new Date(this);};function Alert(targetElement,type,msg){this.element=targetElement;this.str=new StringBuilder();this.str.append('<div style="display:none;" class="alert beop-alert alert-').append(type).append(' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<div class="alert-msg">'+msg+'</div>').append('</div>');this.$alert=$(this.str.toString());}
Alert.danger=function(targetElement,msg){return new Alert(targetElement,Alert.type.danger,msg);};Alert.warning=function(targetElement,msg){return new Alert(targetElement,Alert.type.warning,msg);};Alert.success=function(targetElement,msg){return new Alert(targetElement,Alert.type.success,msg);};Alert.info=function(targetElement,msg){return new Alert(targetElement,Alert.type.info,msg);};Alert.closeAll=function(){$('.beop-alert').remove();};Alert.type={danger:'danger',warning:'warning',success:'success',info:'info'};Alert.prototype.show=function(duration){Alert.closeAll();if(duration){var _this=this;setTimeout(function(){_this.close();},duration);}
$(this.element).append(this.$alert);this.$alert.slideDown(500);return this;};Alert.prototype.close=function(){var _this=this;this.$alert.slideUp(500,function(){_this.$alert.remove();_this=null;});};Alert.prototype.setMessage=function(msg){if(!msg){return false;}
this.$alert.find('.alert-msg').text(msg);};Alert.prototype.setStyle=function(style){if(style&&typeof style!=='string'){this.$alert.css(style);}
return this;};Alert.prototype.showAtTop=function(duration){this.setStyle({position:'absolute',top:0,left:0,right:0,margin:'auto',width:'30%',textAlign:'center',zIndex:10000});if(!duration){duration=2000;}
this.show(duration);};function showDialog(url){return WebAPI.get(url).done(function(resultHtml){$("#dialogContent").html(resultHtml);$('#dialogModal').modal({});});}
function clone(obj){if(obj==null||(typeof obj==='undefined'?'undefined':_typeof(obj))!='object')return obj;var temp=obj.constructor();for(var key in obj){if(obj.hasOwnProperty(key)){temp[key]=clone(obj[key]);}}
return temp;}
Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var week={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
if(/(E+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>2?"/u661f/u671f":"/u5468":"")+week[this.getDay()+""]);}
for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+o[k]).substr((""+o[k]).length));}}
return fmt;};Date.prototype.timeFormat=function(format,type,language,option){var date=this;if(format&&(typeof format=='string'||(typeof format==='undefined'?'undefined':_typeof(format))=='object')){if((typeof format==='undefined'?'undefined':_typeof(format))=='object'&&(!format.separators||!format.parts)){format='yyyy-mm-dd hh:ii:ss';}}else{format='yyyy-mm-dd hh:ii:ss';}
if(arguments.length>=2){var paramArr=function(arrayish){return[].slice.call(arrayish);}(arguments);paramArr.shift();type=language=option=null;paramArr.forEach(function(it,i){if(typeof it=='string'){language=it;}else if(typeof it=='number'){type=it;}else if((typeof it==='undefined'?'undefined':_typeof(it))=='object'){option=it;}});}
var isReturnNull=false;if(option){for(var k in option){if(k=='isReturnNull'){isReturnNull=option[k];}}}
if(date=='Invalid Date'){console.warn("Invalid date.");if(isReturnNull){return'';}else{return date.toString();}}
var DATES={en:{"days":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"daysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],"daysMin":["Su","Mo","Tu","We","Th","Fr","Sa","Su"],"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"meridiem":["am","pm"]}};language=language?DATES[language]?language:'en':'en';var formatObj=function(formatStr){if((typeof formatStr==='undefined'?'undefined':_typeof(formatStr))=='object'){return formatStr;}
if(type){formatStr=timeFormatChange(formatStr,type);}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};}(format);var val={yy:date.getFullYear().toString().substring(2),yyyy:date.getFullYear(),m:date.getMonth()+1,M:DATES[language].monthsShort[date.getMonth()],MM:DATES[language].months[date.getMonth()],d:date.getDate(),D:DATES[language].daysShort[date.getDay()],DD:DATES[language].days[date.getDay()],p:DATES[language].meridiem.length==2?DATES[language].meridiem[date.getHours()<12?0:1]:'',h:date.getHours(),i:date.getMinutes(),s:date.getSeconds()};if(DATES[language].meridiem.length==2){val.H=val.h%12==0?12:val.h%12;}else{val.H=val.h;}
val.HH=(val.H<10?'0':'')+val.H;val.P=val.p.toUpperCase();val.hh=(val.h<10?'0':'')+val.h;val.ii=(val.i<10?'0':'')+val.i;val.ss=(val.s<10?'0':'')+val.s;val.dd=(val.d<10?'0':'')+val.d;val.mm=(val.m<10?'0':'')+val.m;var finTime='';for(var i=0,len=formatObj.separators.length;i<len;i++){finTime+=formatObj.separators[i]+(formatObj.parts[i]?val[formatObj.parts[i]]:'');}
return finTime;};var DateUtil=function(){var dateLocale={month:{en:{month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],month_names_short:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']},zh:{month_names:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],month_names_short:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']}}};function getWeekNumber(d){d=new Date(+d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil(((d-yearStart)/86400000+1)/7);return[d.getFullYear(),weekNo];}
function getLastWeekNumberOf(y,w){w-=1;if(w===0){y=y-1;w=52;}
return[y,w];}
function getNextWeekNumberOf(y,w){w+=1;if(w===53){y+=1;w=1;}
return[y,w];}
function isLeapYear(y){if(Object.prototype.toString.call(y)==='[object Date]'){y=y.getFullYear();}
return y%4===0&&y%100!==0||y%400===0;}
function daysInMonth(dt){var m=dt.getMonth();if(m===1){return isLeapYear(dt)?29:28;}
return[31,28,31,30,31,30,31,31,30,31,30,31][m];}
function getFirstDayOfWeek(year,week){var d=new Date(year,0,1),offset=d.getTimezoneOffset();d.setDate(d.getDate()+4-(d.getDay()||7));d.setTime(d.getTime()+7*24*60*60*1000*(week+(year==d.getFullYear()?-1:0)));d.setTime(d.getTime()+(d.getTimezoneOffset()-offset)*60*1000);d.setDate(d.getDate()-3);return d;}
function getDateRangeOnWeekNumber(year,week){if(!year||!week){return;}
var firstDay=getFirstDayOfWeek(year,week),lastDay=new Date(firstDay);lastDay.setDate(firstDay.getDate()+6);return[firstDay,lastDay];}
function getMonthName(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names:dateLocale.month['en'].month_names;return monthList[index];}
function getMonthNameShort(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names_short:dateLocale.month['en'].month_names_short;return monthList[index];}
function getLastMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===1){return 12;}else{return currentMonth-1;}}
function getNextMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===12){return 1;}else{return currentMonth+1;}}
function getRelativeDateInfo(date1,date2){var now=new Date();var lang=I18n.type;var value1,value2,ts,info;if(!date1&&!date2)return'';value1=(date1||now).valueOf();value2=(date2||now).valueOf();ts=Math.floor(Math.abs(value1-value2)/1000);switch(true){case ts<60:info=ts+(ts===1?' second':' seconds');break;case ts<3600:ts=Math.floor(ts/60);info=ts+(ts===1?' minute':' minutes');break;case ts<86400:ts=Math.floor(ts/3600);info=ts+(ts===1?' hour':' hours');break;case ts<31536000:ts=Math.floor(ts/86400);info=ts+(ts===1?' day':' days');break;default:ts=Math.floor(ts/31536000);info=ts+(ts===1?' year':' years');break;}
info+=value1>value2?' ago':' later';if(lang==='zh'){info=info.replace(/\s(seconds?|minutes?|hours?|days?|years?)\s(ago|later)$/,function($0,$1,$2){var rs='';if($1.indexOf('second')>-1)rs+='秒';if($1.indexOf('minute')>-1)rs+='分钟';if($1.indexOf('hour')>-1)rs+='小时';if($1.indexOf('day')>-1)rs+='天';if($1.indexOf('year')>-1)rs+='年';if($2==='ago')rs+='前';if($2==='later')rs+='后';return rs;});}
return info;}
return{getWeekNumber:getWeekNumber,isLeapYear:isLeapYear,daysInMonth:daysInMonth,getLastWeekNumberOf:getLastWeekNumberOf,getNextWeekNumberOf:getNextWeekNumberOf,getDateRangeOnWeekNumber:getDateRangeOnWeekNumber,getFirstDayOfWeek:getFirstDayOfWeek,getMonthName:getMonthName,getMonthNameShort:getMonthNameShort,getLastMonth:getLastMonth,getNextMonth:getNextMonth,getRelativeDateInfo:getRelativeDateInfo,DATA_FORMAT:{FULL_DATETIME:'yyyy-MM-dd HH:mm:ss',FULL_DATE:'yyyy-MM-dd',TIME:'HH:mm:ss'}};}();var StringUtil=function(){var HTML_ENTITIES={'&':'&amp;','>':'&gt;','<':'&lt;','"':'&quot;',"'":'&#39;','`':'&#x60;'},HTML_ENTITIES_INVERT=invert(HTML_ENTITIES);function invert(obj){var result={},keys=Object.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i];}
return result;}
function padLeft(oldStr,padNum,padStr){if(!padStr){return oldStr;}
return new Array(padNum-String(oldStr).length+1).join(padStr)+oldStr;}
function htmlEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES[character];});}
function htmlUnEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES_INVERT).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES_INVERT[character];});}
var getI18nProjectName=function getI18nProjectName(project){if(!I18n||!project){return'';}
var result='';switch(I18n.type){case'en':{result=project.name_english;break;}
case'zh':{result=project.name_cn;break;}
default:{result=project.name_english;}}
return result||'';};return{padLeft:padLeft,htmlEscape:htmlEscape,htmlUnEscape:htmlUnEscape,getI18nProjectName:getI18nProjectName};}();var BEOPUtil=function(){var jsType={function:_typeof($.noop),number:_typeof(0),string:_typeof(''),undefined:typeof undefined==='undefined'?'undefined':_typeof(undefined)};var projectImgPath=beop.constant.project_img_path;var setRelativePosition=function setRelativePosition($obj,$target,topOffset,leftOffset){$target.css({"left":$obj.offset().left+$obj.width()+(leftOffset||5),"top":$obj.offset().top+(topOffset||10)});};var projectDefaultImgPath=projectImgPath+beop.constant.project_default_img;var getProjectImgPath=function getProjectImgPath(project){if(project){return project.pic?projectImgPath+project.pic:projectDefaultImgPath;}};var getProjectFromAppConfig=function getProjectFromAppConfig(projectId){for(var m=0,len=AppConfig.projectList.length;m<len;m++){if(AppConfig.projectList[m].id==projectId){return AppConfig.projectList[m];}}};function getFunctionName(func){if(!func||(typeof func==='undefined'?'undefined':_typeof(func))!=jsType.function){return'';}
var ret=func.toString();ret=ret.substr('function '.length);ret=ret.substr(0,ret.indexOf('('));return ret;}
function isUndefined(obj){return(typeof obj==='undefined'?'undefined':_typeof(obj))===jsType.undefined;}
function getCookie(name){var value="; "+document.cookie;var parts=value.split("; "+name+"=");if(parts.length==2)return parts.pop().split(";").shift();}
function logicContentHandle(content){if(content){content=content.replace(/\t/g,'    ');}
return content;}
function copyToClipboard(text){if(window.clipboardData&&window.clipboardData.setData){return clipboardData.setData("Text",text);}else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var textarea=document.createElement("textarea");textarea.textContent=text;textarea.style.position="fixed";document.body.appendChild(textarea);textarea.select();try{return document.execCommand("copy");}catch(ex){console.warn("Copy to clipboard failed.",ex);return false;}finally{document.body.removeChild(textarea);}}}
var projectImgType={logo:'logo.png',pdfCover:'pdf_cover.jpg'};function getProjectImgByType(projectId,name,extension){var img='';if(projectId){img+=projectId+'_';}
img+=name;if(extension){img+='.'+extension;}
return beop.constant.BEOP_IMG_HOST+beop.constant.OSS_PROJECT_IMG_PATH+img;}
return{setRelativePosition:setRelativePosition,getProjectImgPath:getProjectImgPath,getFunctionName:getFunctionName,isUndefined:isUndefined,getCookie:getCookie,getProjectFromAppConfig:getProjectFromAppConfig,logicContentHandle:logicContentHandle,copyToClipboard:copyToClipboard,getProjectImgByType:getProjectImgByType,projectImgType:projectImgType};}();(function(){var beop_tmpl_cache={};this.beopTmpl=function tmpl(str,data,frameStr){var fn=!/\W/.test(str)?beop_tmpl_cache[str]=beop_tmpl_cache[str]||tmpl(frameStr?frameStr:document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+str.replace(/[\r\t\n]/g," ").split(/<!/).join("\t").replace(/((^|!>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)!>/g,"',$1,'").split("\t").join("');").split(/!>/).join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return data?fn(data):fn;};})();var SidebarMenuEffect=function(){function SidebarMenuEffect(){}
SidebarMenuEffect.prototype.init=function(center,left,right){var _this=this;this.$paneCt=$(center);this.$leftBtn=$(center).find('#leftCt');this.$rightBtn=$(center).find('#rightCt');var container=document.getElementById('st-container'),buttons=Array.prototype.slice.call(document.querySelectorAll('.sideTrans')),refresh=function refresh(){var leftCol=0,rightCol=0,centerCol=0;var leftArrow='<span class="glyphicon glyphicon-chevron-left"></span>';var rightArrow='<span class="glyphicon glyphicon-chevron-right"></span>';if(_this.$leftBtn.length>0){if(container.className.indexOf('st-effect-7')>0){var prev=_this.$paneCt.prev('div')[0];if(prev&&prev.className.indexOf('col-')>-1){leftCol=parseInt(prev.classList[0].split('-')[2]);}else{leftCol=0;}
_this.$leftBtn.removeClass('leftCtClose').addClass('leftCtOpen').html(leftArrow);}else{leftCol=0;_this.$leftBtn.removeClass('leftCtOpen').addClass('leftCtClose').html(rightArrow);}}
if(_this.$rightBtn.length>0){if(container.className.indexOf('st-effect-1')>0){var next=_this.$paneCt.next('div')[0];if(next&&next.className.indexOf('col-')>-1){rightCol=parseInt(next.classList[0].split('-')[2]);}else{rightCol=0;}
_this.$rightBtn.removeClass('rightCtClose').addClass('rightCtOpen').html(rightArrow);}else{rightCol=0;_this.$rightBtn.removeClass('rightCtOpen').addClass('rightCtClose').html(leftArrow);}}
centerCol=12-leftCol-rightCol;_this.$paneCt.removeClass().addClass('col-sm-'+centerCol+' st-content');};buttons.forEach(function(el,i){var effect=el.getAttribute('data-effect');el.addEventListener('click',function(ev){var target=ev.target.getAttribute('data-effect')!=null?ev.target.getAttribute('data-effect'):ev.target.parentNode.getAttribute('data-effect');var stCtClass=document.getElementById('st-container').className;if(stCtClass.indexOf(target)<0){ev.stopPropagation();ev.preventDefault();container.classList.add(effect);setTimeout(function(){if($(container.children[0]).children('div').length==3){container.classList.add('st-menu-open');}
refresh();},250);}else{container.classList.remove(target);refresh();}});});};return SidebarMenuEffect;}();(function(window){{var unknown='-';var screenSize='';if(screen.width){var width=screen.width?screen.width:'';var height=screen.height?screen.height:'';screenSize+=''+width+" x "+height;}
var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var browser=navigator.appName;var version=''+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if((verOffset=nAgt.indexOf('Opera'))!=-1){browser='Opera';version=nAgt.substring(verOffset+6);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('MSIE'))!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(verOffset+5);}
else if((verOffset=nAgt.indexOf('Chrome'))!=-1){browser='Chrome';version=nAgt.substring(verOffset+7);}
else if((verOffset=nAgt.indexOf('Safari'))!=-1){browser='Safari';version=nAgt.substring(verOffset+7);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('Firefox'))!=-1){browser='Firefox';version=nAgt.substring(verOffset+8);}
else if(nAgt.indexOf('Trident/')!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(nAgt.indexOf('rv:')+3);}
else if((nameOffset=nAgt.lastIndexOf(' ')+1)<(verOffset=nAgt.lastIndexOf('/'))){browser=nAgt.substring(nameOffset,verOffset);version=nAgt.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName;}}
if((ix=version.indexOf(';'))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(' '))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(')'))!=-1)version=version.substring(0,ix);majorVersion=parseInt(''+version,10);if(isNaN(majorVersion)){version=''+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10);}
var mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);var cookieEnabled=navigator.cookieEnabled?true:false;if(typeof navigator.cookieEnabled=='undefined'&&!cookieEnabled){document.cookie='testcookie';cookieEnabled=document.cookie.indexOf('testcookie')!=-1?true:false;}
var os=unknown;var clientStrings=[{s:'Windows 3.11',r:/Win16/},{s:'Windows 95',r:/(Windows 95|Win95|Windows_95)/},{s:'Windows ME',r:/(Win 9x 4.90|Windows ME)/},{s:'Windows 98',r:/(Windows 98|Win98)/},{s:'Windows CE',r:/Windows CE/},{s:'Windows 2000',r:/(Windows NT 5.0|Windows 2000)/},{s:'Windows XP',r:/(Windows NT 5.1|Windows XP)/},{s:'Windows Server 2003',r:/Windows NT 5.2/},{s:'Windows Vista',r:/Windows NT 6.0/},{s:'Windows 7',r:/(Windows 7|Windows NT 6.1)/},{s:'Windows 8.1',r:/(Windows 8.1|Windows NT 6.3)/},{s:'Windows 8',r:/(Windows 8|Windows NT 6.2)/},{s:'Windows NT 4.0',r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:'Windows ME',r:/Windows ME/},{s:'Android',r:/Android/},{s:'Open BSD',r:/OpenBSD/},{s:'Sun OS',r:/SunOS/},{s:'Linux',r:/(Linux|X11)/},{s:'iOS',r:/(iPhone|iPad|iPod)/},{s:'Mac OS X',r:/Mac OS X/},{s:'Mac OS',r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:'QNX',r:/QNX/},{s:'UNIX',r:/UNIX/},{s:'BeOS',r:/BeOS/},{s:'OS/2',r:/OS\/2/},{s:'Search Bot',r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var id in clientStrings){var cs=clientStrings[id];if(cs.r.test(nAgt)){os=cs.s;break;}}
var osVersion=unknown;if(/Windows/.test(os)){osVersion=/Windows (.*)/.exec(os)[1];os='Windows';}
switch(os){case'Mac OS X':osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];break;case'Android':osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1];break;case'iOS':osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);osVersion=osVersion[1]+'.'+osVersion[2]+'.'+(osVersion[3]|0);break;}}
window.jscd={screen:screenSize,browser:browser,browserVersion:version,mobile:mobile,os:os,osVersion:osVersion,cookies:cookieEnabled};})(this);var getUrlParams=function getUrlParams(){var search=window.location.search.substring(1);var kvArr=search.split('&');var rs={};kvArr.forEach(function(kv){var arr=kv.split('=');if(typeof arr[1]!=='undefined'){rs[arr[0]]=arr[1];}});return rs;};$.fn.serializeObject=function(){var obj={};this.serializeArray().map(function(item){if(/\[\]$/.test(item.name)){if(obj[item.name]){obj[item.name].push(item.value);}else{obj[item.name]=[item.value];}}else{obj[item.name]=item.value;}});return obj;};function kIntSeparate(num,n){var number=num.toFixed(n?n:0);var source=String(number).split(".");source[0]=source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)','ig'),"$1,");return source.join(".");}
function timeFormatChange(format,type){var lastStr='';var formatObj=function(formatStr){if(!formatStr||(typeof formatStr==='undefined'?'undefined':_typeof(formatStr))=='object'){return;}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){return;}
return{separators:separators,parts:parts};}(format);if(formatObj){format='';for(var i=0,len=formatObj.separators.length-1;i<len;i++){format+=formatObj.separators[i]+formatObj.parts[i];}
lastStr=formatObj.separators[len];}
var formatArr=['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'];var formatChangeArr=[['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'],['M d, yyyy hh:ii:ss','M d, yyyy hh:ii','M d, yyyy hh','M d, yyyy','M, yyyy','M d hh:ii:ss','M d hh:ii','M d hh','M d'],['dd/mm/yyyy hh:ii:ss','dd/mm/yyyy hh:ii','dd/mm/yyyy hh','dd/mm/yyyy','mm/yyyy','dd/mm hh:ii:ss','dd/mm hh:ii','dd/mm hh','dd/mm']];var index=formatArr.findIndex(function(v){return v===format;});type=Number(type);type&&type>=formatChangeArr.length&&(type=formatChangeArr.length-1);if(index==-1){console.log('format is not defined');return format+lastStr;}else{return formatChangeArr[type||AppConfig.projectTimeFormat||0][index]+lastStr;}}
function timeFormat(time,format,language,option){var date,arr,arr2;if(time instanceof Date){date=time;}else if(/^\d{1,2}\/\d{4}$/.test(time)){arr=time.split('/');date=new Date(arr[0]+'/01/'+arr[1]);}else if(/^\d{1,2}\/\d{1,2}$/.test(time)){arr=time.split('/');date=new Date(arr[1]+'/'+arr[0]);}else if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(time)){arr=time.split('/');date=new Date(arr[1]+'/'+arr[0]+'/'+arr[2]);}else if(/^\d{1,2}\/\d{1,2} /.test(time)){arr=time.split(' ');arr2=arr[0].split('/');date=new Date(arr2[1]+'/'+arr2[0]+' '+arr[1]);}else if(/^\d{1,2}\/\d{1,2}\/\d{4} /.test(time)){arr=time.split(' ');arr2=arr[0].split('/');date=new Date(arr2[1]+'/'+arr2[0]+'/'+arr2[2]+' '+arr[1]);}else{date=new Date(time);}
return date.timeFormat(format,language,option);}
(function(exports){var MINITE_1=60000;var MINITE_5=300000;var HOUR_1=3600000;var DAY_1=86400000;var DAY_365=31536000000;function _formatTimeStr(str,format){var arr=str.split(' ');var date=arr[0].split('-');var time=arr[1].split(':');return format.replace('yyyy',date[0]).replace('MM',date[1]).replace('dd',date[2]).replace('HH',time[0]).replace('mm',time[1]).replace('ss',time[2]);}
function _explainPattern(timeShaft){var startTime=new Date(timeShaft[0]);var endTime=new Date(timeShaft[timeShaft.length-1]);var timeRange=endTime.valueOf()-startTime.valueOf();var timeInterval=timeRange/(timeShaft.length-1);var pattern='MM-dd HH:mm';if(timeInterval<=MINITE_5){if(timeRange<=HOUR_1){pattern='HH:mm';}else if(timeRange<=DAY_1){pattern='HH:mm';}}
else if(timeInterval<=HOUR_1){if(timeRange<=DAY_1){pattern='HH:mm';}else{pattern='MM-dd HH:mm';}}
else if(timeInterval<=DAY_1){if(timeRange<=DAY_365){pattern='MM-dd';}else{pattern='yyyy-MM-dd';}}
else{pattern='yyyy-MM';}
return pattern;}
function _explain(timeShaft){pattern=getPattern(timeShaft);if(pattern){timeShaft=timeShaft.map(function(row){return _formatTimeStr(row,pattern);});}
return timeShaft;}
function _valid(params){var flag=Object.prototype.toString.call(params)==='[object Array]';return flag&&/^[\d-]{10} [\d:]{8}$/.test(params[0]);}
var _getTimePattern=function _getTimePattern(timeShaft){if(!_valid(timeShaft)){return;}
if(timeShaft.length<=1){return;}
return _explainPattern(timeShaft);};var formatTimeShaft=exports.formatTimeShaft=function(timeShaft){if(!_valid(timeShaft)){console.warn('function arguments is not a valid time shaft array!');return timeShaft;}
if(timeShaft.length<=1){return timeShaft;}
return _explain(timeShaft);};function _formatTimeStrByAppConfig(data){var formatArr,formatStr,regularArr,language,formatObj;switch(AppConfig.projectTimeFormat||0){case 0:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';break;case 1:formatArr=['M d, yyyy','M d hh:ii','M, yyyy','M, yyyy','M d'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;case 2:formatArr=['dd/mm/yyyy','dd/mm hh:ii','mm/yyyy','mm/yyyy','dd/mm'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;default:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';}
for(var i=0,len=regularArr.length;i<len;i++){if(regularArr[i].test(data)){formatStr=formatArr[i];break;}}
if(formatStr){formatObj=function _parseFormat(formatStr){var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};}(formatStr);return{formatStr:formatStr,language:language,formatObj:formatObj};}else{return;}}
if(window.echarts){echarts.registerPreprocessor(function(option){var pattern;var formatInfo,firstValue;if(option.xAxis&&option.xAxis.length){option.xAxis.forEach(function(row){if(row.data&&row.data.length){pattern=_getTimePattern(row.data);formatInfo=_formatTimeStrByAppConfig(row.data[0]);if(pattern){row.data=row.data.map(function(row){return row.substr(0,16);});firstValue=_formatTimeStr(row.data[0],pattern);formatInfo=_formatTimeStrByAppConfig(firstValue);if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}else{row.data=row.data.map(function(it,i){return _formatTimeStr(it,pattern);});}}else if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}}});}});}})(window);var WebAPI=function(){var siteId;switch(window.location.hostname){case'beop.rnbtech.com.hk':siteId='b79c068f77198848e22fe79758836e53';break;case'beop6.rnbtech.com.hk':siteId='f1f6b2b9e6b64592c0b4cb5e9b8bd79e';break;case'beopdemo.rnbtech.com.hk':siteId='ac0df98f274d9a5980a571297248d80b';break;default:break;}
(function(){if(siteId){var hm=document.createElement("script");hm.src="//hm.baidu.com/hm.js?"+siteId;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);}})();var mockList={'/static/mock/analysis_workspace_saveLayout.json':/\/analysis\/workspace\/saveLayout\/\d+\/[01]/i,'/static/mock/analysis_template_get.json':/\/analysis\/template\/get\/\d+/i};function mock(url){var match=null;for(var i in mockList){match=url.match(mockList[i]);if(match!==null)return i;}
return url;}
function requestFailHandle(result){if(result&&result.status==401){alert(i18n_resource.error.noPermission);}}
function WebAPI(){}
WebAPI.isMock=false;$.ajaxSetup({converters:{"text json":true},dataFilter:function dataFilter(result,type){var data=result;if(type==='script'){return data;}else if(typeof data==='string'){if(/^\s*</.test(data)){return data;}
try{data=JSON.parse(result);}catch(e){console.log('request error: '+e+', the data is :'+data);return data;}}
if(data){if(data.error){switch(data.error){case'token_invalid':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');if(typeof LoginValidate!='undefined'){var validate=new LoginValidate();validate.show();return;}
confirm(i18n_resource.error.token[data.msg]+'. '+i18n_resource.error.relogin+'.',function(){if(AppConfig.isMobile){location.reload();}else{location.href='/';}});}
case'historyData':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');alert(data.msg);return{};}
default:break;}}
if(data.code==403){console.log(this.url+' ('+data.msg+'")');alert(I18n.resource.error.noPermission);return{};}}
return data;}});WebAPI.post=function(url,data,isMock){var mockUrl;isMock=isMock===undefined?WebAPI.isMock:isMock;if(isMock){mockUrl=mock(url);if(url!==mockUrl)return this.get(mockUrl,false);}
if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1);}}
return $.ajax({url:url,type:'POST',data:JSON.stringify(data),contentType:'application/json'}).fail(requestFailHandle);};WebAPI.get=function(url,isMock){isMock=isMock===undefined?WebAPI.isMock:isMock;url=isMock?mock(url):url;if(window._hmt&&url.indexOf('.html')>0)window._hmt.push(['_trackPageview',url]);if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1);}}
return $.ajax({url:url,type:'Get',contentType:'application/json'}).fail(requestFailHandle);};WebAPI.getHistoryDS=function(callback){};WebAPI.getHistory=function(callback){};WebAPI.ajaxForDebugTool=function(ajaxObj,host,dtuName,endpoint){var defaultUrl='http://'+host+'/'+endpoint+'/'+dtuName,defaultAjaxObj={url:defaultUrl,crossDomain:true,dataType:'json'},dfd,timer=10,intervalFlags,url,requestFlag='requestFlag='+new Date().getTime()+Math.ceil(Math.random()*100);$.extend(defaultAjaxObj,ajaxObj);url=defaultAjaxObj.url;if(url.indexOf('?')<0){requestFlag='?'+requestFlag;}else{requestFlag='&'+requestFlag;}
var userId=BEOPUtil.getCookie('userId');defaultAjaxObj.url+=requestFlag+'&userId='+userId;return $.ajax(defaultAjaxObj).then(function(result){dfd=$.Deferred();if(result.success){intervalFlags=setInterval(function(){if(timer<0){clearInterval(intervalFlags);return dfd.reject({success:false,msg:'no response from server'});}
$.ajax({type:'GET',url:'http://'+host+'/getCMDResponse/'+dtuName+requestFlag,crossDomain:true,dataType:'json'}).done(function(result){if(result.success){clearInterval(intervalFlags);return dfd.resolve(result);}}).always(function(){timer--;});},2000);}else{return dfd.reject(result);}
return dfd;});};return WebAPI;}();(function(){'use strict';var indexedDB=indexedDB||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(!indexedDB){return;}
function _initStorage(options){var _this=this;this._dbInfo=$.extend({db:null},options);var promise=$.Deferred();(function(){var _this=this;var dbInfo=this._dbInfo;var openreq=indexedDB.open(dbInfo.name,dbInfo.version);openreq.onerror=function(){promise.reject(openreq.error);};openreq.onsuccess=function(){dbInfo.db=openreq.result;promise.resolve();};openreq.onupgradeneeded=function(){var names=openreq.result.objectStoreNames;var length,key;var indexOf=[].indexOf;if(indexOf.call(names,'cache')>-1){openreq.result.deleteObjectStore('cache');}
if(indexOf.call(names,'datasource')>-1){openreq.result.deleteObjectStore('datasource');}
if(indexOf.call(names,'thumbnail')>-1){openreq.result.deleteObjectStore('thumbnail');}
if(indexOf.call(names,'buffer')===-1){openreq.result.createObjectStore('buffer');}
openreq.result.createObjectStore('datasource');openreq.result.createObjectStore('thumbnail');for(var i=0,len=localStorage.length;i<len;i++){key=localStorage.key(i);if(key.indexOf('workSpacePicStorageEnable')===0){localStorage.removeItem(key);}}};}).call(this);}
function length(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.count();req.onsuccess=function(){promise.resolve(req.result);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.get(key);req.onsuccess=function(){var value=req.result;value=value===undefined?null:value;promise.resolve(value);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var result={};var promise=this.iterate(function(key,value,i){if(keyList.indexOf(key)>-1){result[key]=value;}}).then(function(){return result;},function(){console.warn('getItemList error!');});excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.put(value,key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();try{(function(){var _this=this;var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var result={};kvList.forEach(function(kv,i){var key=kv.key,value=kv.value;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
store.put(value,key);});transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=transaction.error;promise.reject(err);};}).call(this);}catch(e){console.warn('setItemList error!');promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.delete(key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;var request;if(!cursor){promise.resolve();return;}
if(keyList.indexOf(cursor.key)>-1){cursor.delete();}
cursor.continue();};req.onerror=function(err){promise.reject(err);};}).call(this);}catch(e){promise.reject();}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.clear();transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var advanced=false;req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(null);return;}
if(n===0){promise.resolve(cursor.key);}else{if(!advanced){advanced=true;cursor.advance(n);}else{promise.resolve(cursor.key);}}};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var keys=[];var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(keys);return;}
keys.push(cursor.key);cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var index=0;req.onsuccess=function(){var cursor=req.result;var result;if(!cursor){promise.resolve();return;}
result=iterator(cursor.key,cursor.value,index++);if(result===false){promise.resolve();return;}
cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var indexDBWrapper={_driver:'indexedDBWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.indexedDB=indexDBWrapper;}).call(this);(function($){'use strict';var localStorage;try{if(!this.localStorage||!('setItem'in this.localStorage)){return;}
localStorage=this.localStorage;}catch(e){return;}
function _initStorage(options){this._dbInfo=$.extend({},options);this._dbInfo.keyPrefix=this._dbInfo.name+'/';}
function length(callback){var _this=this;var promise=this.keys().then(function(keys){return keys.length;});excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var result;result=localStorage.getItem(this._dbInfo.keyPrefix+key);try{result=JSON.parse(result);}catch(e){}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var _this=this;var promise=$.Deferred();(function(){var result={};keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
result[key]=localStorage.getItem(_this._dbInfo.keyPrefix+key);try{result[key]=JSON.parse(result[key]);}catch(e){}});promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var _this=this;var result;try{try{value=JSON.stringify(value);}catch(e){}
result=localStorage.setItem(_this._dbInfo.keyPrefix+key,value);promise.resolve(result);}catch(e){result=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}
promise.reject(e);}}).call(this);excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();(function(){var _this=this;var result={};kvList.forEach(function(kv,i){var value;if(typeof kv.key!=='string'){console.warn('The key is not a string!');kv.key=String(kv.key);}
try{try{value=JSON.stringify(kv.value);}catch(e){value=kv.value;}
result[kv.key]=localStorage.setItem(_this._dbInfo.keyPrefix+kv.key,value);}catch(e){console.warn('occur error when set data into storage [key: "'+kv.key+'", value: "'+kv.value+'"]');result[kv.key]=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}}});promise.resolve();}).call(this);excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){localStorage.removeItem(this._dbInfo.keyPrefix+key);promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var _this=this;keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
localStorage.removeItem(_this._dbInfo.keyPrefix+key);});promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){localStorage.removeItem(key);}}
promise.resolve();}).call(this);}catch(e){proimse.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();(function(){var result;result=localStorage.key(n);if(result){result=result.substring(_this._dbInfo.keyPrefix.length);}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();(function(){var keyPrefix=this._dbInfo.keyPrefix;var length=localStorage.length;var keys=[],key;for(var i=0;i<length;i++){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){keys.push(key.substring(keyPrefix.length));}}
promise.resolve(keys);}).call(this);excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key,value;var result;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){value=localStorage.getItem(key);try{value=JSON.parse(value);}catch(e){}
result=iterator(key.substring(keyPrefix.length),value,i);}
if(result===false){break;}}
promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var localStorageWrapper={_driver:'localStorageWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.localStorage=localStorageWrapper;}).call(this,jQuery);(function($){function BaseCache(options){this.options=$.extend({},DEFAULTS,options);this.storage=Object.create(Beop.cache.drivers[this.options.driver]);this.init();}
BaseCache.prototype.init=function(){this.storage._initStorage(this.options);};BaseCache.prototype.length=function(){return this.storage.length();};BaseCache.prototype.key=function(n,callback){return this.storage.key(n,callback);};BaseCache.prototype.keys=function(callback){return this.storage.keys(callback);};BaseCache.prototype.getItem=function(key,callback){return this.storage.getItem(key,callback);};BaseCache.prototype.getItemList=function(keyList,callback){return this.storage.getItemList(keyList,callback);};BaseCache.prototype.setItem=function(key,value,callback){return this.storage.setItem(key,value,callback);};BaseCache.prototype.setItemList=function(kvList,callback){return this.storage.setItemList(kvList,callback);};BaseCache.prototype.removeItem=function(key,callback){return this.storage.removeItem(key,callback);};BaseCache.prototype.removeItemList=function(keyList,callback){return this.storage.removeItemList(keyList,callback);};BaseCache.prototype.clear=function(callback){return this.storage.clear(callback);};BaseCache.prototype.iterate=function(iterator,callback){return this.storage.iterate(iterator,callback);};var DEFAULTS={dbType:'localStorage',name:'beopcache',version:3};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.BaseCache=BaseCache;}).call(this,jQuery);(function($,undefined){var TIME_STAMP={m1:60000,m5:300000,h1:3600000,d1:86400000};var TIMEZONE_OFFSET=new Date().getTimezoneOffset()*60000;var DB_INFO={driver:'indexedDB',storeName:'datasource'};function DSCache(){this.db=new Beop.cache.BaseCache(DB_INFO);this.keyTpl='anal_{id}_{fmt}_{start}_{end}';this.useCache=false;};DSCache.prototype.get=function(id,tmFmt,tmStart,tmEnd){var promise=$.Deferred();if(!this.useCache){promise.resolve(null);return promise;}
var _this=this;var key;if(tmFmt==='M1'){promise.resolve(null);return promise;}
if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=this.formatTime(tmStart,tmFmt,'up');tmEnd=this.formatTime(tmEnd,tmFmt);key=this.keyTpl.formatEL({id:id,fmt:tmFmt,start:tmStart.valueOf(),end:tmEnd.valueOf()});this.db.getItem(key).done(function(rs){var index1,index2;if(rs!==null){promise.resolve(rs);return promise;};tmStart=tmStart.format('yyyy-MM-dd HH:mm:ss');tmEnd=tmEnd.format('yyyy-MM-dd HH:mm:ss');_this.db.iterate(function(key,value,i){if(_this.isExist(key,id,tmFmt,tmStart,tmEnd)){index1=value.timeShaft.indexOf(tmStart);index2=value.timeShaft.indexOf(tmEnd);value.list[0].data=value.list[0].data.slice(index1,index2+1);value.timeShaft=value.timeShaft.slice(index1,index2+1);rs=value;return false;}}).done(function(){promise.resolve(rs);}).fail(function(e){promise.reject(e);});}).fail(function(e){promise.reject(e);});return promise;};DSCache.prototype.getBatch=function(ids,tmFmt,tmStart,tmEnd){if(!this.useCache){return $.when($,[]).then(function(){return;});}
var find,rs=null;var promiseArr=[];var idsNotFound=[];for(var i=0,len=ids.length;i<len;i++){(function(i){promiseArr.push(this.get(ids[i],tmFmt,tmStart,tmEnd).done(function(find){if(find!==null){if(rs===null)rs=find;else rs.list.push(find.list[0]);}else{idsNotFound.push(ids[i]);}}));}).call(this,i);}
return $.when.apply($,promiseArr).then(function(){return{data:rs,idsNotFound:idsNotFound};});};DSCache.prototype.set=function(data,tmFmt,tmStart,tmEnd){var promise=$.Deferred();if(!this.useCache){promise.resolve(null);return promise;}
var list=data.list.concat();if(tmFmt==='M1'){promise.resolve(null);return promise;}
if(data===null||!data.timeShaft||!data.timeShaft.length){promise.resolve(null);return promise;}
if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=this.formatTime(tmStart,tmFmt,'up');tmEnd=this.formatTime(tmEnd,tmFmt);function circle(){var _this=this;var item=list.shift();var id,key;if(!item){promise.resolve();return;}
id=item.dsItemId;key=this.keyTpl.formatEL({id:id,fmt:tmFmt,start:tmStart.valueOf(),end:tmEnd.valueOf()});this.merge2Cache(key,{list:[item],timeShaft:data.timeShaft}).done(function(){circle.call(_this);}).fail(function(e){promise.reject(e);});}
circle.call(this);return promise;};DSCache.prototype.remove=function(itemIds){var _this=this;var keys=[];var promise=$.Deferred();if(typeof itemIds==='string'){itemIds=[itemIds];}
this.db.keys().done(function(rs){console.log(rs);});this.db.iterate(function(key){var isExist=itemIds.some(function(row,i){if(key.indexOf('anal_'+row)>-1)return true;});if(isExist)keys.push(key);}).done(function(){if(keys.length>0){_this.db.removeItemList(keys).done(function(){promise.resolve();}).fail(function(){promise.reject();});return;}
promise.reject();}).fail(function(){console.warn('remove ds key failed! key: '+keys.join(','));promise.reject();});return promise;};DSCache.prototype.merge2Cache=function(newKey,newValue){var _this=this;var arr=newKey.split('_');var kk=[arr[0],arr[1],arr[2]].join('_');var filter=[];var promise=$.Deferred();this.db.iterate(function(key,value,index){if(key.indexOf(kk)>-1){filter.push({key:key,value:value});}}).done(function(){if(filter.length===0){_this.db.setItem(newKey,newValue).done(function(){promise.resolve();});return;}
_this.merge2group({key:newKey,value:newValue,fmt:arr[2],start:parseInt(arr[3]),end:parseInt(arr[4])},filter).then(function(){promise.resolve();},function(e){promise.reject(e);});}).fail(function(e){promise.reject(e);});return promise;};DSCache.prototype.merge2group=function(row,group){var _this=this;var timeArr=[],arr,ts,item;var start1,end1,start2,end2;var srcData;var promise=$.Deferred();for(var i=0,len=group.length;i<len;i++){arr=group[i].key.split('_');item={key:group[i].key,fmt:arr[2],start:parseInt(arr[3]),end:parseInt(arr[4])};timeArr.push(item);}
ts=TIME_STAMP[row.fmt];if(ts===undefined){promise.reject();return;}
start1=row.start-ts;end1=row.end+ts;srcData={key:row.key,value:row.value};function circle(){var _this=this;var item=timeArr.shift();var start2,end2;if(!item){this.db.setItem(srcData.key,srcData.value);promise.resolve();return;}
start2=item.start;end2=item.end;if(start1>end2||end1<start2){circle.call(this);}else{this.db.getItem(item.key).done(function(value){_this.mergeData(srcData,{key:item.key,value:value}).done(function(rs){srcData=rs;if(srcData===null){promise.resolve();return;}
circle.call(_this);});}).fail(function(){promise.reject();return;});}}
circle.call(this);return promise;};DSCache.prototype.mergeData=function(d1,d2){var key1=d1.key,key2=d2.key;var item1=d1.value,item2=d2.value;var arr=key1.split('_');var dsId=arr[1];var prefix=this.keyTpl.formatEL({id:arr[1],fmt:arr[2]});var start1,end1,start2,end2;var start,end;var index,data,ts,result;var promise=$.Deferred();startStr1=item1.timeShaft[0];endStr1=item1.timeShaft[item1.timeShaft.length-1];startStr2=item2.timeShaft[0];endStr2=item2.timeShaft[item2.timeShaft.length-1];start1=startStr1.toDate().valueOf();end1=endStr1.toDate().valueOf();start2=startStr2.toDate().valueOf();end2=endStr2.toDate().valueOf();start=Math.min(start1,start2);end=Math.max(end1,end2);if(start===start2&&end===end2){promise.resolve(null);return promise;}
if(start===start1&&end===end1){this.db.removeItem(key2).done(function(){promise.resolve(d1);});return promise;}
if(start===start1&&end===end2){index=item1.timeShaft.indexOf(startStr2);if(index===-1)index=item1.timeShaft.length;data=item1.list[0].data.slice(0,index).concat(item2.list[0].data);ts=item1.timeShaft.slice(0,index).concat(item2.timeShaft);this.db.removeItem(key2).done(function(){promise.resolve({key:prefix.formatEL({start:start1,end:end2}),value:{list:[{data:data,dsItemId:dsId}],timeShaft:ts}});});return promise;}
if(start===start2&&end===end1){index=item1.timeShaft.indexOf(endStr2);if(index===-1)index=0;data=item2.list[0].data.concat(item1.list[0].data.slice(index));ts=item2.timeShaft.concat(item1.timeShaft.slice(index));this.db.removeItem(key2).done(function(){promise.resolve({key:prefix.formatEL({start:start2,end:end1}),value:{list:[{data:data,dsItemId:dsId}],timeShaft:ts}});});return promise;}
promise.resolve(d1);return promise;};DSCache.prototype.isExist=function(key,id,tmFmt,tmStart,tmEnd){var arr=[];var rangeStart,rangeEnd;if(key.indexOf('anal_'+id+'_'+tmFmt)===-1)return false;arr=key.split('_');if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=tmStart.valueOf();tmEnd=tmEnd.valueOf();if(tmStart>=parseInt(arr[3])&&tmEnd<=parseInt(arr[4]))return true;return false;};DSCache.prototype.formatTime=function(time,fmt,mode){var ts=TIME_STAMP[fmt];mode=mode==='up'?'ceil':'floor';if(ts===undefined)return;if(typeof time==='string')time=time.toDate();time=time.valueOf()-TIMEZONE_OFFSET;if(fmt==='d1'){time=new Date(Math[mode](time/ts)*ts).format('yyyy-MM-dd 00:mm:ss');}else{time=new Date(Math[mode](time/ts)*ts+TIMEZONE_OFFSET).format('yyyy-MM-dd HH:mm:ss');}
return new Date(time);};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.ds=new DSCache();}).call(this,jQuery);(function($,undefined){var DB_INFO={driver:'indexedDB',storeName:'thumbnail'};function imgCache(){this.db=new Beop.cache.BaseCache(DB_INFO);}
imgCache.prototype.getChkByWs=function(workspace){var keyList=wsList2keyList([workspace]);return this.db.getItemList(keyList).then(function(rs){var index;for(var k in rs){if(!rs.hasOwnProperty(k)){continue;}
if((index=keyList.indexOf(k))>-1){keyList.splice(index,1);}}
return{data:rs,absentList:keyList.map(function(row){return row.split('_')[1];})};});};imgCache.prototype.getByWsList=function(workspaceList){var keyList=wsList2keyList(workspaceList);return this.db.getItemList(keyList);};imgCache.prototype.setByWs=function(workspace){return this.setByWsList([workspace]);};imgCache.prototype.setByWsList=function(workspaceList){var kvList=wsList2kvList(workspaceList);return this.db.setItemList(kvList);};imgCache.prototype.removeByWsList=function(workspaceList){var keyList=wsList2keyList(workspaceList);return this.db.removeItemList(keyList);};imgCache.prototype.set=function(wsId,modalId,imagebin){return this.db.setItem(wsId+'_'+modalId,imagebin);};function wsList2keyList(workspaceList){var keyList=[];workspaceList.forEach(function(workspace){var wsId=workspace.id;keyList=keyList.concat(workspace.modalList.map(function(modal){return wsId+'_'+modal.id;}));});return keyList;}
function wsList2kvList(workspaceList){var kvList=[];workspaceList.forEach(function(workspace){var wsId=workspace.id;workspace.modalList.forEach(function(modal){if(!modal.imagebin||!modal.id||!wsId){return false;}
kvList.push({key:wsId+'_'+modal.id,value:modal.imagebin});});});return kvList;}
this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.img=new imgCache();}).call(this,jQuery);(function($,undefined){'use strict';var DB_INFO={driver:'indexedDB',storeName:'buffer'};var log=console.warn.bind(console);var assert={equal:function equal(val1,val2){if(val1!==val2)console.warn('assert - equal not expected!');}};var key_version,uId;function BufferCache(){this.db=new Beop.cache.BaseCache(DB_INFO);}
+function(){this.init=function(){var _this=this;uId=AppConfig.userId;key_version='version?u='+uId;return this.db.getItem(key_version).then(function(v){if(v===null){_this.db.setItem(key_version,1).then(function(){_this.activeVersion=1;_this.frozenVersion=0;});}else{v=parseInt(v);_this.activeVersion=v;_this.frozenVersion=v-1;}},function(){_this.db.setItem(key_version,1).then(function(){_this.activeVersion=1;_this.frozenVersion=0;});});};this.getBuffer=function(key,version){var promise;version=version===undefined?this.activeVersion:version;if(!key){log('getBuffer - arguments can not be empty');promise=$.Deferred();promise.reject();return promise;}
return this.db.getItem(key+'?u='+uId+'&v='+version).then(function(rs){if(rs===null){rs=[];}
return rs;});};this.setBuffer=function(data,key,version){var promise;version=version===undefined?this.activeVersion:version;if(!key){log('setBuffer - arguments can not be empty');promise=$.Deferred();promise.reject();return promise;}
return this.db.setItem(key+'?u='+uId+'&v='+version,data);};this.removeBuffer=function(key,version){var promise;version=version===undefined?this.frozenVersion:version;if(!key){log('removeBuffer - arguments can not be empty');promise=$.Deferred();promise.reject();return promise;}
return this.db.removeItem(key+'?u='+uId+'&v='+version);};this.findDataById=function(id,type){var promise=$.Deferred();this.getBuffer(type).then(function(rs){for(var i=0,len=rs.length;i<len;i++){if(rs[i].id===id){break;}}
if(i!==len){promise.resolve(rs,i);}else{promise.resolve(rs,-1);}},function(){promise.reject();});return promise;};this.findModalById=function(modalId,id,type){var promise=$.Deferred();this.findDataById(id,type).then(function(rs,i){var row,row2;var t,len;if(i===-1){promise.resolve(rs,-1);return;}
row=rs[i];for(t=0,len=row.modalList.length;t<len;t++){row2=row.modalList[t];if(row2.id===modalId){break;}}
if(t!==len){promise.resolve(rs,i,t);}
else{promise.resolve(rs,i,-1);}},function(rs,i){promise.reject();});return promise;};this.addWsCreateOp=function(data,type){var _this=this;var promise=$.Deferred();type=type===undefined?'ws':type;data.op='create';this.getBuffer(type).then(function(rs){rs.push(data);_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addWsCreateOp - '+type+' - setBuffer failed');promise.reject();});},function(){log('addWsCreateOp - '+type+' - getBuffer failed');promise.reject();});return promise;};this.addWsUpdateOp=function(data,type){var _this=this;var promise=$.Deferred();type=type===undefined?'ws':type;this.findDataById(data.id,type).then(function(rs,index){var ws;if(index!==-1){ws=rs[index];ws.name=data.name;ws.modifyTime=data.modifyTime;}
else{rs.push({id:data.id,name:data.name,modifyTime:data.modifyTime,modalList:[],op:'update'});}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addWsUpdateOp - '+type+' - setBuffer failed');promise.reject();});},function(){log('addWsUpdateOp - '+type+' - findDataById failed');promise.reject();});return promise;};this.addWsDeleteOp=function(data,type){var _this=this;var promise=$.Deferred();type=type===undefined?'ws':type;this.findDataById(data.id,type).then(function(rs,index){var ws;if(index!==-1){ws=rs[index];if(ws.op==='create'){rs.splice(index,1);}else{rs[index]={id:data.id,op:'delete'};}}
else{rs.push({id:data.id,op:'delete'});}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addWsDeleteOp - '+type+' - setBuffer failed');promise.reject();});},function(){log('addWsDeleteOp - '+type+' - findDataById failed');promise.reject();});return promise;};this.addModalCreateOp=function(modal,id,type){var _this=this;var promise=$.Deferred();this.findDataById(id,type).then(function(rs,i){if(i!==-1){rs[i].modalList.push(modal);}
else{rs.push({id:id,modalList:[modal],op:'update'});}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addModalCreateOp - setBuffer failed');promise.reject();});},function(){log('addModalCreateOp - findDataById failed');promise.reject();});return promise;};this.addModalUpdateOp=function(modal,id,type){var _this=this;var promise=$.Deferred();this.findModalById(modal.id,id,type).then(function(rs,i,t){if(i===-1){rs.push({id:id,op:'update',modalList:[modal]});}
else if(t===-1){assert.equal(rs[i].op,'update');rs[i].modalList.push(modal);}
else{modal.op=rs[i].modalList[t].op;modal=$.extend(false,rs[i].modalList.splice(t,1),modal);rs[i].modalList.push(modal);}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addModalDeleteOp - setBuffer failed');promise.reject();});},function(){log('addModalDeleteOp - findModalById failed');promise.reject();});return promise;};this.addModalDeleteOp=function(modalId,id,type){var _this=this;var promise=$.Deferred();this.findModalById(modalId,id,type).then(function(rs,i,t){var op;if(i===-1){rs.push({id:id,op:'update',modalList:[{id:modalId,op:'delete'}]});}
else if(t===-1){assert.equal(rs[i].op,'update');rs[i].modalList.push({id:modalId,op:'delete'});}
else{op=rs[i].modalList[t].op;if(op==='create'){rs[i].modalList.splice(t,1);}else if(op==='update'){rs[i].modalList[t]={id:modalId,op:'delete'};}}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addModalDeleteOp - setBuffer failed');promise.reject();});},function(){log('addModalDeleteOp - findModalById failed');promise.reject();});return promise;};this.freeze=function(){var promise=$.Deferred();this.db.keys().done(function(keys){if(keys.indexOf('ws?u='+uId+'&v='+this.frozenVersion)===-1&&keys.indexOf('tpl?u='+uId+'&v='+this.frozenVersion)===-1&&(keys.indexOf('ws?u='+uId+'&v='+this.activeVersion)!==-1||keys.indexOf('tpl?u='+uId+'&v='+this.activeVersion)!==-1)){this.db.setItem(key_version,this.activeVersion+1).done(function(){this.frozenVersion=this.activeVersion;this.activeVersion+=1;promise.resolve();}.bind(this));}else{promise.resolve();}}.bind(this));return promise;};this.getFrozenData=function(){function getDisplayData(data){var rs={};if(!data.length)return null;data.forEach(function(ws){switch(ws.op){case'create':case'delete':rs[ws.op]=rs[ws.op]||[];rs[ws.op].push(ws);delete ws.op;ws.modalList&&ws.modalList.forEach(function(row){delete row.op;});break;case'update':rs.update=rs.update||[];if(!!ws.modalList&&!!ws.modalList.length){ws.modal={};ws.modalList.forEach(function(modal){ws.modal[modal.op]=ws.modal[modal.op]||[];ws.modal[modal.op].push(modal);delete modal.op;});}
delete ws.op;delete ws.modalList;rs.update.push(ws);break;default:break;}});return rs;}
return function(){var arr=[];var promise=$.Deferred();this.freeze().then(function(){arr.push(this.getBuffer('ws',this.frozenVersion).then(function(ws){return getDisplayData(ws);}));arr.push(this.getBuffer('tpl',this.frozenVersion).then(function(tpl){return getDisplayData(tpl);}));$.when.apply($,arr).then(function(){var rs=null;if(arguments[0]!==null){rs=rs||{};rs['ws']=arguments[0];}
if(arguments[1]!==null){rs=rs||{};rs['tpl']=arguments[1];}
promise.resolve(rs);});}.bind(this),function(){log('getFrozenData - freeze failed');promise.reject();});return promise;};}.call(this);this.removeFrozenData=function(){var arr=[];arr.push(this.removeBuffer('ws',this.frozenVersion));arr.push(this.removeBuffer('tpl',this.frozenVersion));return $.when.apply($,arr);};}.call(BufferCache.prototype);this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.buffer=new BufferCache();}).call(this,jQuery);var Internationalization=function(){function Internationalization(lang,resource){this.type=lang||localStorage["language"];this.resource=resource||{};}
Internationalization.prototype={getResource:function getResource(){return this.resource;},fillPage:function fillPage(){this.fill2($('[i18n]'));},fillArea:function fillArea(element){this.fill2(element.find('[i18n]'));try{Permission.check(element);}catch(e){console.log('check permission failed:'+e);}},fillAreaAttribute:function fillAreaAttribute(element,attributeName){this.fill(element.find('[i18n]['+attributeName+']'),attributeName);},fill:function fill(arrElement,attributeName){for(var i=0,arrPath,text,len=arrElement.length;i<len;i++){arrPath=arrElement[i].attributes["i18n"].value.split('.');text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
if(!attributeName){arrElement[i].innerHTML=text;}else{arrElement[i].setAttribute(attributeName,text);}}},getI18nValue:function getI18nValue(i18nKey){if(!i18nKey){return'';}
var arrPath=i18nKey.split('.');var text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
return text;},fill2:function fill2(arrElement){for(var i=0,len=arrElement.length;i<len;i++){var i18nValue=arrElement[i].attributes["i18n"];var items=i18nValue.value.split(';'),item,attrMap;for(var j=0;j<items.length;j++){item=items[j];if(!item){continue;}
if(item.indexOf('=')===-1){i18nValue=this.getI18nValue(item);arrElement[i].innerHTML=i18nValue;}else{attrMap=item.split('=');if(!attrMap[0]){continue;}
arrElement[i].setAttribute(attrMap[0],this.getI18nValue(attrMap[1]));}}}},findContent:function findContent(strPath){var arrPath=strPath.split('.');var text=this.resource;for(var i=0,len=arrPath.length;i<len;i++){text=text&&text[arrPath[i]];}
return text;}};return Internationalization;}();function InitI18nResource(strLanguage,isForce,filePath){if(!strLanguage){strLanguage=localStorage["isUserSelectedLanguage"]||navigator.language.split('-')[0];}
if(isForce){localStorage["isUserSelectedLanguage"]=strLanguage;}else if(localStorage["isUserSelectedLanguage"]){strLanguage=localStorage["isUserSelectedLanguage"];}
filePath=filePath||'/static/views/js/i18n/';return $.ajax({async:false,url:filePath+strLanguage+".js",dataType:"script"}).then(function(){localStorage["language"]=strLanguage;return i18n_resource;},function(){return $.ajax({async:false,url:filePath+"en.js",dataType:'script'}).then(function(){localStorage["language"]="en";return i18n_resource;},function(){console.warn('i18n files loading failed!');return{};});});}
var Permission=function(){Permission={addPermission:function addPermission(permission){if(permission&&permission.trim()){AppConfig.permission[permission.trim()]=true;}},deletePermission:function deletePermission(permission){if(permission&&permission.trim()){AppConfig.permission[permission.trim()]=false;}},setPermission:function setPermission(permissionList){AppConfig.permission={};if(permissionList&&permissionList.length){for(var m=0,n=permissionList.length;m<n;m++){if(permissionList[m]){AppConfig.permission[permissionList[m].trim()]=true;}}}},hasPermission:function hasPermission(permission){if(AppConfig.userId==1||AppConfig.permission['BRoot']||AppConfig.permission['all']){return true;}
return AppConfig.permission&&permission&&AppConfig.permission[permission.trim()];},permissionStrategy:function permissionStrategy($dom,permissionsToCheck){var permissionItem,clickPermissions,canClick=false,shouldRemove=true;for(var m=0,n=permissionsToCheck.length;m<n;m++){permissionItem=permissionsToCheck[m].trim();if(permissionItem.startsWith('click')){permissionItem=permissionItem.split(/\s*:\s*/);if(permissionItem.length=2){clickPermissions=permissionItem[1].split(/\s*,\s*/);}
for(var i=0,j=clickPermissions.length;i<j;i++){if(this.hasPermission(clickPermissions[i])){canClick=true;}}
if(!canClick){$dom.attr('href','').attr('disabled',true).addClass('disabled');$dom.click(function(e){e.stopPropagation();return false;});}
$dom.attr("style","display: block !important");}else{if(this.hasPermission(permissionItem)){$dom.attr("style","display: block !important");shouldRemove=false;break;}}}
if(shouldRemove){$dom.remove();}
return false;},check:function check(area){try{if(!AppConfig.permission){return false;}}catch(e){console.error('AppConfig.permission未定义');}
if(!area){return false;}
if(!(area instanceof jQuery)){area=$(area);}
area.find('[permission]').each(function(index,item){var $item=$(item),permissions;permissions=$item.attr('permission').split(/\s*;\s*/);Permission.permissionStrategy($item,permissions);});}};return Permission;}();var PaneProjectSelector=function(){var _this=this;var configMap={paneTemplate:'/static/views/admin/paneProjectSelector.html',mapTemplate:'/static/views/admin/mapProjectSelector.html?t='+new Date().getTime(),selectorType:{panel:'panel',map:'map'},isMapAvailable:true,currentSelector:null};function PaneProjectSelector(){_this=this;if(!BackgroundWorkers.alarmReporter){BackgroundWorkers.alarmReporter=new Worker("/static/views/js/worker/workerUpdate.js");BackgroundWorkers.alarmReporter.onmessage=function(e){var rs=e.data;if(rs.status==='OK'){_this.refreshAlarmPanel(_this.filterByAlarmRule(rs.data));}
else{}};}
if(!BackgroundWorkers.schedulerReporter){BackgroundWorkers.schedulerReporter=new Worker("/static/views/js/worker/workerUpdate.js");BackgroundWorkers.schedulerReporter.receivedMessage=function(data){var $paneWorkflow=$('#paneWorkflow'),$badge=$paneWorkflow.find('.badge'),$imgBadge=$('#iconList a:eq(0) .badge'),$alarmBadge=$('#liProjectAlarm .badge');var remindsLen=data.reminds.length,schedulerLen=data.scheduler.length,transactionLen=data.transaction.length;var totalCount=transactionLen+schedulerLen;if(totalCount){$badge.text(totalCount);$imgBadge.html('&nbsp;');}else{$badge.text('');if($alarmBadge.is(':empty')){$imgBadge.html('');}}
if(remindsLen){$("#messageAll").find(".badge").text(remindsLen).show();}else{$("#messageAll").find(".badge").hide();}
if(data.scheduler.length){$paneWorkflow.find('.menuItemCalendar .badge').text(data.scheduler.length);}else{$paneWorkflow.find('.menuItemCalendar .badge').text('');}
if(data.transaction.length){$paneWorkflow.find('.menuItemMine .badge').text(data.transaction.length);}else{$paneWorkflow.find('.menuItemMine .badge').text('');}};BackgroundWorkers.schedulerReporter.onmessage=function(e){var rs=e.data;if(rs.success){BackgroundWorkers.schedulerReporter.receivedMessage(rs.data);}};BackgroundWorkers.schedulerReporter.postMessage({type:'fetchWorkflowData',userId:AppConfig.userId});}}
PaneProjectSelector.prototype={show:function show(selectorType){I18n.fillArea($('#navPane'));this.clearMenu();this.init();if(!selectorType){selectorType=configMap.currentSelector;}
if(AppConfig.skipProjectSelector){var favoriteProject=this.getFavoriteProject();var project=favoriteProject?favoriteProject:AppConfig.projectList[0];this.initProject(project.id,project.name_en,StringUtil.getI18nProjectName(project),project.logo).done(function(result){_this.initDefaultPage(result);}).always(function(){AppConfig.skipProjectSelector=false;Spinner.stop();});}else{if(selectorType===configMap.selectorType.panel){this.showPanelView();}else{if(configMap.isMapAvailable){this.showMapView();}else{this.showPanelView();}}}
var $btnMemberManage=$('#btnMemberManage');if($btnMemberManage.length){$btnMemberManage.children('a').attr('href','#page=UserManagerController&manager=MemberManager');}
$('#scrollPages').css({'height':'auto','width':'auto'});$('#ulPages').css({'height':'auto','width':'auto'}).hide();Spinner.stop();},showMapView:function showMapView(){var _this=this;this.showMapSelector().done(function(){_this.init();var map=new beop.getMapInstance();map.load();});},showPanelView:function showPanelView(){var _this=this;this.showPanelSelector().done(function(){_this.init();BEOPUtil.setRelativePosition($("#imgListCon"),$("#funList"),-45,5);$(window).resize(function(){BEOPUtil.setRelativePosition($("#imgListCon"),$("#funList"),-45,5);});});},setMapAvailable:function setMapAvailable(available){configMap.isMapAvailable=!!available;},getFavoriteProject:function getFavoriteProject(){var favoriteProject=null;AppConfig.projectList.forEach(function(project){if(project.isFavorite){favoriteProject=project;}});return favoriteProject;},close:function close(){$(window).off('resize');$('#scrollPages').height($('#divPages').height());_this.initNav();$(window).off('resize.nav').on('resize.nav',function(e){if($('html').hasClass('sharpview-mode'))return;_this.initNav();});},showPanelSelector:function showPanelSelector(){configMap.currentSelector=configMap.selectorType.panel;return WebAPI.get(configMap.paneTemplate).done(function(resultHtml){var $resultHtml=$(resultHtml);$(ElScreenContainer).html($resultHtml);I18n.fillArea($resultHtml);var paneSelector=$("#paneSelector");var imgListCon=paneSelector.find('.project-media-container');paneSelector.html('');imgListCon.html('');for(var i=0;i<AppConfig.projectList.length;i++){var project=AppConfig.projectList[i];var divMedia=$('<div class="media effect"><a><div class="img"><img class="media-object" src="'+BEOPUtil.getProjectImgPath(project)+'"></div></a></div>');divMedia.attr('id','project-'+project.id+"-"+project.name_en+"-"+project.level);var divMediaBody=$('<div class="media-body info"></div>').append($('<h4 class="media-heading">'+StringUtil.getI18nProjectName(project)+'</h4>'));divMedia.find('a').append(divMediaBody);imgListCon.append(divMedia);}
if(window.localStorage.getItem('language')==='zh'){var version=window.localStorage.getItem('versionHistory');if(beop.data.versionHistory&&!!beop.data.versionHistory&&beop.data.versionHistory!=='undefined'){var $beopHistory=$('<a href="#page=VersionHistory" style="display: inline-block;width:auto;cursor: pointer;padding-left: 10px;"> beop version:'+beop.data.versionHistory.version+'</a>');paneSelector.append($beopHistory);$beopHistory.eventOff().eventOn('click',function(){ScreenManager.goTo({page:'VersionHistory'});});}}
paneSelector.append(imgListCon);});},showMapSelector:function showMapSelector(){configMap.currentSelector=configMap.selectorType.map;return WebAPI.get(configMap.mapTemplate).done(function(resultHtml){$(ElScreenContainer).html(resultHtml);I18n.fillArea($('.map-row'));});},setLogo:function setLogo(){var logoImgBEOP=$('#navHomeLogo').find('img');if(logoImgBEOP.attr('company')){return false;}
if(localStorage.getItem('systemSkin_'+AppConfig.userId)=='dark'){logoImgBEOP.attr('src','/static/images/logo_white.png');}else{logoImgBEOP.attr('src','/static/images/logo_beop.png');}},init:function init(){var _this=this;$("#rowLogin").animate({left:'-250px',opacity:'0.5',height:'10px',width:'10px',marginTop:'0'},null,function(){$("#rowLogin").css("display","none");});$("#rowSelector").eventOn('click','.media',function(e){var arrConfig=e.currentTarget.id.split("-");var projectId=parseInt(arrConfig[1]);var projectEnName=arrConfig[2];var projectName='';Spinner.spin(document.getElementById('paneSelector'));AppConfig.level=parseInt(arrConfig[3]);for(var i=0,len=AppConfig.projectList.length;i<len;i++){if(projectId===AppConfig.projectList[i].id){projectName=StringUtil.getI18nProjectName(AppConfig.projectList[i]);break;}}
if(!projectName){Spinner.stop();return;}
_this.initProject(projectId,projectEnName,projectName).done(function(result){_this.initDefaultPage(result);}).always(function(){Spinner.stop();});},['projSel','projSel','text',function(e){return $(e.currentTarget).attr('id').search(/\d/g);}]).animate({opacity:'1'}).show();if(AppConfig.userId==1){$('.adminFeature').show();}
if(configMap.isMapAvailable){$('#btnMapSelector').show().eventOn('click',function(){var selector=new PaneProjectSelector();selector.show(configMap.selectorType.map);},'projMapSelect');}
$("#btnUpdate").eventOn('click',function(e){Spinner.spin(document.getElementById('paneSelector'));var alert;WebAPI.get("/observer/update").done(function(result){if(result=="success"){alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectManager.UPDATE_COMPLETE);alert.showAtTop(1000);}else{alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectManager.UPDATE_FAILED);alert.showAtTop(1000);}}).fail(function(){alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectManager.UPDATE_FAILED);alert.showAtTop(1000);}).always(function(e){Spinner.stop();});},'projUpdate');$("#btnBenchmark").parent('li').show().end().eventOff('click').eventOn('click',function(){ScreenManager.show(BenchmarkScreen);},'navTool-benchMark');$("#btnPermissionManage").eventOff('click').eventOn('click',function(){ScreenManager.show(UserManagerController,ProjectPermissionManager);},'navTool-permission');$('#btnFullScreen').eventOff('click').eventOn('click',function(){function launchFullscreen(element){if(element.requestFullscreen){element.requestFullscreen();}else if(element.mozRequestFullScreen){element.mozRequestFullScreen();}else if(element.webkitRequestFullscreen){element.webkitRequestFullscreen();}else if(element.msRequestFullscreen){element.msRequestFullscreen();}}
function exitFullscreen(){if(document.exitFullscreen){document.exitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}
if(window.innerHeight!==screen.height){launchFullscreen(document.documentElement);}else{exitFullscreen();}});$("#right-nav").show();$("#paneUser").html(AppConfig.userProfile.fullname||AppConfig.account);$('#iconList .userPic.small').attr('src','http://images.rnbtech.com.hk/'+AppConfig.userProfile.picture).attr('alt',AppConfig.userProfile.fullname||AppConfig.account);$('#btnAccountManage .userPic').attr('src','http://images.rnbtech.com.hk/'+AppConfig.userProfile.picture).attr('alt',AppConfig.userProfile.fullname||AppConfig.account);$("#btnOperatingRecord").eventOff('click').eventOn('click',function(e){new OperatingRecord().show();},'navTool-operationRecord');$('#btnAlarmLogging').eventOff().eventOn('click',function(e){ScreenManager.show(AlarmLogging);e.preventDefault();},'navTool-alarmLog');$('#liProjectAlarm').eventOff().eventOn('click',function(e){var $ulAlarmPanel=$('#ulAlarmPanel');$ulAlarmPanel.toggle().next('.card-close').toggle().off().one('click',function(e){e.stopPropagation();$ulAlarmPanel.hide();$(this).hide();});e.stopPropagation();e.preventDefault();},'navTool-alarm');$("#btnLogout").eventOff('click').eventOn('click',function(e){PaneProjectSelector.logout();},'navTool-logout');var $btnChangeSkin=$("#btnChangeSkin");var $labelChangeSkin=$('#labelChangeSkin');$labelChangeSkin.eventOff('click').eventOn('click',function(e){e.stopPropagation();$btnChangeSkin.toggle();},'navTool-skinLabel');$btnChangeSkin.eventOff('click').eventOn('click',function(e){e.stopPropagation();},'navTool-skinSel');var skinTimeout=null;var updateMenuPic=function updateMenuPic(currentSkin){var $navBar=$('#ulPages'),navIconsList=$navBar.find('li').find('img.nav-icon-svg'),current;navIconsList.each(function(){var $this=$(this);current=$this.attr('src').split('-');$this.replaceWith('<img class="nav-icon-svg" src=" '+current[0]+'-'+currentSkin+'.'+current[1].split('.')[1]+' " onerror="this.style.display=\'none\'"> ');});};$btnChangeSkin.eventOff('change').eventOn('change',function(e){var systemSkin=$('#darkSkin').length==0?'default':'dark';var currentSkin=this.value;if(systemSkin!=this.value){if(this.value=='dark'){loadDarkSkin();}else{var cssDark=document.querySelector('#darkSkin');if(cssDark){cssDark.remove();}
AppConfig.chartTheme='macarons';}
localStorage.setItem('systemSkin_'+AppConfig.userId,this.value);_this.setLogo();updateMenuPic(currentSkin);}
skinTimeout=setTimeout(function(){$btnChangeSkin.fadeOut(1000);},5000);},'navTool-skinLabel');$btnChangeSkin.hover(function(){clearTimeout(skinTimeout);},function(){skinTimeout=setTimeout(function(){$btnChangeSkin.fadeOut(1000);},5000);});this.setLogo();var systemSkin=localStorage.getItem('systemSkin_'+AppConfig.userId);if(systemSkin){$btnChangeSkin.val(systemSkin);}else{$btnChangeSkin.val('dark');systemSkin='dark';}
if(systemSkin=='dark'){loadDarkSkin();}
function loadDarkSkin(){var head=document.querySelector('head');var $darkSkin=$('#darkSkin');if($darkSkin.length==0){var $cssDark=$('<link id="darkSkin" rel="stylesheet" type="text/css" href="/static/content/index-black.css?'+new Date().getTime()+'">');head.appendChild($cssDark[0]);$cssDark[0].onload=function(){localStorage.setItem('systemSkin_'+AppConfig.userId,'dark');};}
AppConfig.chartTheme=theme.Dark;}
$("#btnResetPassword").eventOff('click').eventOn('click',function(e){WebAPI.get("/static/views/admin/resetPassword"+".html",null,function(resultHtml){$('#dialogContent').html(resultHtml);$('#dialogModal').modal();});},'navTool-resetPwd');$("#btnPointManager").eventOff('click').eventOn('click',function(e){ScreenManager.goTo({page:'PointManagerRealTimeData',projectId:AppConfig.projectId});},'navTool-point');var $btnDebugTools=$("#btnDebugTools");AppConfig.debugTool?$btnDebugTools.show():$btnDebugTools.hide();$btnDebugTools.eventOff('click').eventOn('click',function(e){window.localStorage.setItem("current_project",AppConfig.projectId);},'navTool-debugTool');$('#ulAlarmPanel').eventOff().eventOn('click','a',function(e){ScreenManager.goTo({page:'AlarmLogging'});});$("#navHeader").eventOff().eventOn('click','li',function(e){var $this=$(this);if($this.find("ul").length==0){$("#navHeader li").removeClass("active");$this.closest("li").addClass("active");}});var isShowInfoBox=false;var messageOptions={pageSize:3,pageNumber:1};var nextPageData=[],currentIndex=messageOptions.pageSize;var getMessageLatest=function getMessageLatest(pageSize,pageNumber){return WebAPI.post('/message/api/v1/queryUserMessage',{limit:pageSize||messageOptions.pageSize,page:pageNumber||messageOptions.pageNumber,type:"notRead",tags:null});};var translateOp=function translateOp(text){switch(text){case'reply':return I18n.resource.workflow.notice.TASK_REPLY;case'new':return I18n.resource.workflow.notice.TASK_CREATE;case"complete":return I18n.resource.workflow.notice.TASK_FINISH;case"verified":return I18n.resource.workflow.notice.TASK_VERIFIED;case"not_verified":return I18n.resource.workflow.notice.TASK_VERIFIED_FAILED;case"start":return I18n.resource.workflow.notice.TASK_START;case"end":return I18n.resource.workflow.notice.TASK_CLOSED;case"edit":return I18n.resource.workflow.notice.TASK_EDIT;case"forward":return I18n.resource.workflow.notice.TASK_FORWARD;default:return text;}};var showNextMsg=function showNextMsg(msg){var html="",unreadClass=msg.isRead?false:'unread markAsRead';var senderUserInfo=msg.messageInfo&&msg.messageInfo.sender&&msg.messageInfo.sender.senderInfo||{userpic:"",userfullname:'',useremail:'',id:''};var baseLogo='static/images/logo_beop.png';html+='<li id="infoBoxMessage-'+msg.msgId+'" data-msg-id="'+msg._id+'">'+'<div class="fl wdr1"><img class="userImg" src="'+(msg.messageInfo.task?senderUserInfo.userpic:baseLogo)+'"/></div>';if(msg.messageInfo.task){html+='<a class="messageLink" href="#page=workflow&type=transaction&transactionId='+msg.messageInfo.task.id+'"><div class="fl wdr2 messageText">'+'<span class="messageUserName mr5">'+senderUserInfo.userfullname+'</span>'+'<span>'+translateOp(msg.messageInfo.task.op)+'</span>'+'<div>'+msg.messageInfo.title+'</div></a>';}else{html+='<div class="fl wdr2 messageText">'+'<span class="messageUserName mr5">'+msg.messageInfo.title+'</span>'+'<div>'+msg.messageInfo.content+'</div>';}
html+='</div>'+'<div class="fl tr wdr3 messageRight"><div class="messageTime">'+timeFormat(msg.messageInfo.time,timeFormatChange('yyyy-mm-dd hh:ii:ss'))+'</div>'+'<div class="'+unreadClass+' "><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></div>'+'</div>'+'</li>';return html;};var renderMessageBox=function renderMessageBox(){var $infoBoxMessage=$('.infoBoxMessage');messageOptions.pageNumber=1;getMessageLatest(messageOptions.pageSize,1).done(function(result){if(result.success){var $badge=$('#messageAll .badge');var data=result.data,messageHtml='<ul>',unreadClass;if(data.totalCount>0){$badge.text(data.totalCount).show();}else{$badge.text(' ').hide();}
nextPageData=data.message;currentIndex=0;data.message.forEach(function(item){unreadClass=item.isRead?false:'unread markAsRead';messageHtml+=showNextMsg(item);});messageHtml+='</ul>';if(data.totalCount>=messageOptions.pageSize){messageHtml+='<div id="messageShowAll" class="tc cp messageShowAll"><a href="#page=AllMessages"><span>'+i18n_resource.workflow.message.VIEW_ALL_NEWS+'</span><span>&gt;&gt;</span></a></div>';}
if(isShowInfoBox){messageInfoBox(messageHtml,{initCb:function initCb(){I18n.fillArea($('.infoBoxMessage'));var $el=this.$el;var $markAsReadBtn=$el.find('.header-right'),$showMoreBtn=$el.find("#messageShowAll");if(!$el.find('.infoBox-msg ul li').length){$el.find(".header-right").remove();}
this.$el.off('click.markAsAllRead').on('click.markAsAllRead','.markAsAllRead',function(){Spinner.spin($el.get(0));WebAPI.post('/message/api/v1/markAllAsRead').done(function(){$el.find(".infoBox-msg ul li").remove();$markAsReadBtn.hide();$showMoreBtn.hide();$badge.text('').hide();}).always(function(){Spinner.stop();}).fail(function(){alert(I18n.resource.workflow.message.MARK_READ_FAILED);});});this.$el.off('click.markAsRead').on('click.markAsRead','.markAsRead',function(){var $this=$(this),$parent=$this.closest('li'),msgId=$parent.data("msg-id");if(msgId){Spinner.spin($parent.closest('ul').get(0));WebAPI.post('/message/api/v1/markAsRead',{msgIdList:[msgId]}).done(function(){Spinner.stop();renderMessageBox();});}});this.$el.on('click','.messageLink',function(){var msgId=$(this).closest('li').data("msg-id");if(msgId){WebAPI.post('/message/api/v1/markAsRead',{msgIdList:[msgId]});}});}});}}
$infoBoxMessage.remove();}).fail(function(){alert(I18n.resource.workflow.message.READ_USER_UNREAD_MESSAGES_FAILED);});};renderMessageBox();$("#messageAll").off().click(function(){var $infoBoxMessage=$('.infoBoxMessage');if($infoBoxMessage.is(":visible")){$infoBoxMessage.hide();isShowInfoBox=false;}else{isShowInfoBox=true;renderMessageBox();}});$(document).off('click.infoBoxMessage').on("click.infoBoxMessage",function(e){var $target=$(e.target);if(!$target.closest(".infoBoxMessage").length){$(".infoBoxMessage").hide();isShowInfoBox=false;}});$('#iconList').on('show.bs.dropdown',function(){$(".infoBoxMessage").hide();});$('#divPages>span').css('display','none');$('ulPages').css('left','0');return this;},initProject:function initProject(projectId,projectEnName,projectName,pageId,logo){var _this=this;return WebAPI.get("/get_plant_pagedetails/"+projectId+"/"+AppConfig.userId).done(function(result){var result_obj=result;AppConfig.projectId=projectId;AppConfig.projectName=projectEnName;AppConfig.projectShowName=projectName;AppConfig.projectBenchmark=result_obj.benchmark;AppConfig.navItems=result_obj.navItems;AppConfig.role_permission=result_obj.role_permission;$('#liProjectMenu').show();if(!AppConfig.navItems.length&&ScreenCurrent&&ScreenCurrent.showMapView){if(configMap.isMapAvailable){_this.showMapView();}else{_this.showPanelView();}}
if(loginCode&&loginCode.toLowerCase()=='hzbt'){$('#txtProjectTitle').text(AppConfig.projectShowName).removeAttr('i18n');if(logo&&logo!='None'){$('#navHomeLogo span').attr("style","width: 78px; height: 32px;background-image: url("+logo+") !important;");}}else{$('#projectMenu').text(projectName).attr('title',projectName).show();}
BackgroundWorkers.alarmReporter.postMessage({type:'dataAlarmRealtime',projectId:projectId});_this.initNavigationPane(result_obj.navItems);_this.initMenu(result_obj.observerPages,result_obj.groupInfo);_this.initNav();if(Boolean(pageId)){var navBtnA=$('#ulPages').find('.nav-btn-a');for(var i=0,len=navBtnA.length;i<len;i++){var item=navBtnA.eq(i);if(pageId==item.attr('pageid')){item.closest('li').attr('class','active');break;}}}
$(window).off('resize.nav').on('resize.nav',function(){_this.initNav();});if(beop.benchMark){beop.benchMark.refresh();}
var $btnMemberManage=$('#btnMemberManage');if($btnMemberManage.length){$btnMemberManage.children('a').attr('href','#page=UserManagerController&manager=ProjectPermissionManager');}}).fail(function(msg){console.log(msg);var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectSelector.PROJECT_OPEN_FAILED.format(projectName));alert.showAtTop(2000);});},initNav:function initNav(){var divPageWidth=window.innerWidth-document.getElementById('right-nav').offsetWidth-document.getElementById('navHomeLogo').offsetWidth-100;var scrollPageWidth=divPageWidth-50;var $scrollPages=$('#scrollPages');var ulPageWidth=0;var $ulPages=$('#ulPages'),$divPages=$('#divPages');var isPlay=false;var liWidth=0;$ulPages.children('li').each(function(){if(this.offsetWidth>5){$(this).attr('offsetW',this.offsetWidth);}
liWidth=$(this).attr('offsetW');ulPageWidth+=parseInt(liWidth)+5;});$scrollPages.css('width',scrollPageWidth+'px');$ulPages.css('width',ulPageWidth+'px');$ulPages.css('left','0');document.getElementById('divPages').style.width=divPageWidth+'px';if(divPageWidth<ulPageWidth){$('#divPages>span').css('display','inline');$('#btnPageScrollLeft').eventOff('click').eventOn('click',function(){if(isPlay)return;if(-parseInt($ulPages.css('left'))>ulPageWidth-scrollPageWidth)return;isPlay=true;$ulPages.animate({"left":"-=100px"},function(){isPlay=false;});},'navPage-btnScrollLeft');$('#btnPageScrollRight').eventOff('click').eventOn('click',function(){if(isPlay)return;if(-parseInt($ulPages.css('left'))<100)return;isPlay=true;$ulPages.animate({"left":"+=100px"},function(){isPlay=false;});},'navPage-btnScrollRight');}else{$('#divPages>span').css('display','none');}
var dropDownWidth;function showDropDownEvent(){var $this=$(this),height=$this.attr('data-h');if(height===undefined){height=$('#navPane').outerHeight()+getUlHeight($this.children('.dropdown-menu'))+20;$this.attr('data-h',height);}
$scrollPages.height(height);dropDownWidth=$this.offset().left-$scrollPages.offset().left+$this.children('.dropdown-menu').outerWidth();if(dropDownWidth>scrollPageWidth){$scrollPages.width(dropDownWidth);}}
function getUlHeight($ul){var height=20,defaultHeight=26;var $liList=$ul.children('li');for(var i=0;i<$liList.length;i++){var $li=$liList.eq(i);if($li.children('ul').length){height+=($li.children('ul').children('li').length+1)*defaultHeight;}else{height+=defaultHeight;}}
return height;}
function hideDropDownEvent(){$scrollPages.height($divPages.height());$scrollPages.width($divPages.outerWidth()-50);}
function showSubDropDownEvent(e){var $this=$(this),$ul=$(this).closest('.dropdown-submenu').find("ul");if($this.hasClass('showUl')){$this.removeClass('showUl');$ul.slideUp();}else{$this.addClass('showUl');$ul.slideDown();}
e.stopPropagation();}
$scrollPages.off('show.bs.dropdown','.dropdown').off('show.bs.dropdown','.dropdown').off('click.dropdown-submenu','.dropdown-submenu>a');$scrollPages.on('show.bs.dropdown','.dropdown',showDropDownEvent).on('hide.bs.dropdown','.dropdown',hideDropDownEvent).on('click.dropdown-submenu','.dropdown-submenu>a',showSubDropDownEvent);},refreshAlarmPanel:function refreshAlarmPanel(data){var arrHtml=[];var $panel=$('#liProjectAlarm'),$imgBadge=$('#iconList a:eq(0) .badge'),$workflowBadge=$('#paneWorkflow .badge');if(!data)return;if(data.length===0){$($panel.find('a>.badge').text(''));arrHtml.push('<li class="dropdown-header">There is No Alarms Now.</li>');arrHtml.push('<li class="dropdown-header"><a href="javascript:;">Go To Alarms Page></a></li>');if($workflowBadge.is(':empty')){$imgBadge.html('');}}
else{$($panel.find('a>.badge').text(data.length));for(var i=0,len=Math.min(3,data.length);i<len;i++){arrHtml.push('<li>\
                        <a href="javascript:;">\
                            <div class="divAlarmInfo">\
                                <span class="glyphicon glyphicon-exclamation-sign"></span> {0}\
                            </div>\
                            <div class="clearfix">\
                                <span class="pull-left text-muted small">Level-{1}</span>\
                                <span class="pull-right text-muted small">{2}</span>\
                            </div>\
                        </a>\
                    </li>'.format(data[i]['info'],data[i]['level'],DateUtil.getRelativeDateInfo(new Date(),new Date(data[i]['time']))));}
arrHtml.push('<li class="dropdown-header"><a href="javascript:;">See All Alarms></a></li>');$imgBadge.html('&nbsp;');}
$('#ulAlarmPanel').html(arrHtml.join(''));},menuScreenFactory:function menuScreenFactory(type){var screen=undefined;switch(type){case'ObserverScreen':case'observer':screen='temp';break;case'DiagnosisScreen':case'diagnosis':screen=DiagnosisScreen;break;case'AnalysisScreen':case'analysis':screen=AnalysisScreen;break;case'ReportScreen':case'report':screen=ReportScreen;break;case'WorkflowMine':case'workFlow':screen=WorkflowMine;break;case'EnergyScreen':case'EnergyScreen_M':case'energy':screen=EnergyScreen;break;case'DataCenter3D':screen=DataCenter3D;break;case'DropDownList':case'dropDownList':screen='temp';break;case'PageScreen':screen=namespace('observer.screens.PageScreen');break;case'FacReportScreen':screen=namespace('observer.screens.FacReportScreen');break;case'FacReportWrapScreen':screen=namespace('observer.screens.FacReportWrapScreen');break;case'BenchmarkScreen':screen=BenchmarkScreen;break;default:break;}
return screen;},setMenuActive:function setMenuActive(){$("#ulPages").find('.active').removeClass('active');var $targetLi=$("#ulPages").find('[pageId="'+ScreenManager.getPageId()+'"]');$targetLi.addClass('active').closest('li.dropdown').addClass('active');var $targetUl=$targetLi.closest('ul').addClass('active');if(!$targetUl.is('.dropdown-menu')){$targetLi.closest('ul').closest('li').find('a').addClass('showUl');$targetLi.parents('li').addClass('active');}},initMenu:function initMenu(pages,groups){var _this=this;var navBtnA=$('#ulPages .nav-btn-a');var ulTag=document.getElementById('ulObserverScreenList');var pageIdFromHash=ScreenManager.getPageId();if(ulTag){ulTag.innerHTML='<div class="arrow"></div>';var arrGroupUsed=[];for(var i=0,len=pages.length;i<len;i++){arrGroupUsed.push(pages[i].groupid);}
var nShowGroupCnt=0;for(var i=0,len=groups.length;i<len;i++){var item=groups[i];var bGroupFind=false;for(var j=0,len2=arrGroupUsed.length;j<len2;j++){if(arrGroupUsed[j]==item.id){bGroupFind=true;nShowGroupCnt++;break;}}}
for(var i=0,group,liTag,aTag,ulDropDown,len=groups.length;i<len;i++){group=groups[i];var bGroupFind=false;for(var j=0,len2=arrGroupUsed.length;j<len2;j++){if(arrGroupUsed[j]==group.id){bGroupFind=true;break;}}
if(!bGroupFind){continue;}
if(nShowGroupCnt>1){liTag=document.createElement("li");aTag=document.createElement("a");aTag.textContent=group.name;ulDropDown=document.createElement("ul");liTag.setAttribute("groupid",group.id);liTag.setAttribute("class","dropdown-submenu");if(pageIdFromHash&&pageIdFromHash==group.id){liTag.classList.add('active');}
liTag.appendChild(aTag);liTag.appendChild(ulDropDown);ulTag.appendChild(liTag);}}
for(var i=0,page,liTag,aTag,len=pages.length;i<len;i++){page=pages[i];liTag=document.createElement("li");aTag=document.createElement("a");aTag.textContent=page.name;liTag.setAttribute("pageid",page.id);if(pageIdFromHash&&pageIdFromHash==page.id){liTag.classList.add('active');}
(function(page){$(aTag).eventOn('click',function(e){Spinner.spin(ElScreenContainer);ScreenManager.goTo({page:'ObserverScreen',id:page.id});},['navPage','navPage',AppConfig.projectShowName,AppConfig.projectId,page.name,page.id]);})(page);if(nShowGroupCnt>1){liTag.appendChild(aTag);var $searchGroup=$(ulTag).find('li[groupid$='+page.groupid+']');if($searchGroup){var $ulGroup=$searchGroup.find('ul');$ulGroup.append(liTag);}}else{liTag.appendChild(aTag);ulTag.appendChild(liTag);}}
this.setMenuActive();}
navBtnA.eventOff('click').eventOn('click',function(e){var currentTarget=e.currentTarget;var screen=_this.menuScreenFactory(currentTarget.getAttribute('page-type'));if(!screen){return false;}
if(currentTarget.attributes['pageId']){var pageId=currentTarget.attributes['pageId'].value;if(screen===ReportScreen){ScreenManager.goTo({page:'ReportScreen',reportId:pageId,reportType:currentTarget.attributes['report-type'].value,reportFolder:currentTarget.attributes['report-folder'].value,reportText:$(currentTarget).find('.nav-btn-text').text()});}else if(currentTarget.getAttribute('page-type')=='EnergyScreen_M'){ScreenManager.show(screen,pageId,null,null,null,true);}else if([namespace('observer.screens.PageScreen'),namespace('observer.screens.FacReportScreen'),namespace('observer.screens.FacReportWrapScreen')].indexOf(screen)>-1){ScreenManager.show(screen,{id:pageId},'indexMain');}else{ScreenManager.goTo({page:currentTarget.getAttribute('page-type'),id:pageId});}}else{ScreenManager.goTo({page:currentTarget.getAttribute('page-type')});}},['navPage-a','navPage',AppConfig.projectShowName,AppConfig.projectId,'text','pageId']);},initDefaultPage:function initDefaultPage(result){var navItems=result.navItems,observerPages=result.observerPages,firstItem,firstItemType,screen,pageId;if(!navItems.length){return false;}
firstItem=navItems[0],firstItemType=firstItem.type,pageId=firstItem.id;if(!firstItemType){return false;}
screen=this.menuScreenFactory(firstItemType);switch(firstItemType){case'ObserverScreen':{ScreenManager.goTo({page:'ObserverScreen',id:observerPages&&observerPages[0]&&observerPages[0].id});break;}
case'DropDownList':{for(var m=0,len=navItems.length;m<len;m++){if(navItems[m].parent===pageId){if(navItems[m].type==='DropDownList'){pageId=navItems[m].id;continue;}
pageId=navItems[m].id;screen=this.menuScreenFactory(navItems[m].type);if(navItems[m].type==='ReportScreen'){ScreenManager.show(screen,pageId,navItems[m].reportType,navItems[m].reportFolder);}
else if(navItems[m].type==='PageScreen'){ScreenManager.goTo({page:'observer.screens.PageScreen',options:{id:pageId},container:'indexMain'});}
else if(navItems[m].type==='FacReportScreen'){ScreenManager.goTo({page:'observer.screens.FacReportScreen',options:{id:pageId},container:'indexMain'});}else if(navItems[m].type==='FacReportWrapScreen'){ScreenManager.goTo({page:'observer.screens.FacReportWrapScreen',options:{id:pageId},container:'indexMain'});}else{ScreenManager.show(screen,pageId);}
break;}}
break;}
case'ReportScreen':{ScreenManager.goTo({page:'ReportScreen',reportId:pageId,reportType:firstItem.reportType,reportFolder:firstItem.reportFolder});break;}
case'EnergyScreen_M':{ScreenManager.show(screen,pageId,null,null,null,true);break;}
case'PageScreen':ScreenManager.goTo({page:'observer.screens.PageScreen',options:{id:pageId},container:'indexMain'});break;case'FacReportScreen':ScreenManager.goTo({page:'observer.screens.FacReportScreen',options:{id:pageId},container:'indexMain'});break;case'FacReportWrapScreen':ScreenManager.goTo({page:'observer.screens.FacReportWrapScreen',options:{id:pageId},container:'indexMain'});break;default:ScreenManager.goTo({page:navItems[0].type,id:pageId});}},initDropDownItem:function initDropDownItem(dropdownItem){var _this=this,$liTag,$aTag,$dropDownWrapper=$('#DropDownList'+dropdownItem.parent);if(dropdownItem.type==='EnergyScreen_M'&&!AppConfig.role_permission.c_dashboard){$dropDownWrapper.closest('.dropdown').remove();return;}
if($dropDownWrapper.length===0){return;}
if(dropdownItem.text.indexOf('observer.menu.')>=0){dropdownItem.text=I18n.findContent(dropdownItem.text);}
$liTag=$('<li></li>').attr('pageid',dropdownItem.id);$aTag=$('<a><span class="glyphicon glyphicon-'+dropdownItem.pic+'"></span>'+dropdownItem.text+'</a>');if(dropdownItem.type!=='DropDownList'){if(_this.menuScreenFactory(dropdownItem.type)===ReportScreen){$liTag.attr('permission','RReport');}else if(_this.menuScreenFactory(dropdownItem.type)===EnergyScreen){$liTag.attr('permission','RDashboard');}
$aTag.eventOn('click',function(){var ScreenClass=_this.menuScreenFactory(dropdownItem.type);Spinner.spin(ElScreenContainer);if(ScreenClass===ReportScreen){$liTag.attr('permission','RReport');ScreenManager.goTo({page:'ReportScreen',reportId:dropdownItem.id,reportType:dropdownItem.reportType,reportFolder:dropdownItem.reportFolder,reportText:dropdownItem.text});}
else if([namespace('observer.screens.PageScreen'),namespace('observer.screens.FacReportScreen'),namespace('observer.screens.FacReportWrapScreen')].indexOf(ScreenClass)>-1){ScreenManager.show(ScreenClass,{id:dropdownItem.id},'indexMain');}else if(dropdownItem.type=='EnergyScreen_M'){ScreenManager.goTo({page:dropdownItem.type,id:dropdownItem.id,isForMobile:true});}else{ScreenManager.goTo({page:dropdownItem.type,id:dropdownItem.id});}},['navPage','navPage',AppConfig.projectShowName,AppConfig.projectId,dropdownItem.text,dropdownItem.id]);}
$liTag.append($aTag);if(dropdownItem.type==='EnergyScreen'||dropdownItem.type==='ReportScreen'){AppConfig.menu[dropdownItem.id]=dropdownItem.text;}else if(dropdownItem.type==='DropDownList'){$liTag.addClass('dropdown-submenu');$liTag.append('<ul id="'+'DropDownList'+dropdownItem.id+'"></ul>');}
$dropDownWrapper.append($liTag);},initNavigationPane:function initNavigationPane(navItems){var liTag,spanTag;var $ulPages=$("#ulPages");$ulPages.empty();$ulPages.css({width:'',left:''});$ulPages.show();var strLiObserver='<li class="dropdown">\
                    <a class="dropdown-toggle nav-btn-a" id="<%menuId%>" data-toggle="dropdown" aria-expanded="false">\
                        <span>\
                        <img class="nav-icon-svg" src="<%imgMenuPicSrc%>" onerror="this.style.display=\'none\'"/> \
                        <span class="glyphicon glyphicon-<%iconMenuPicDefault%>"></span>\
                        </span>\
                        <%menuName%>\
                        <span class="caret"></span>\
                    </a>\
                    <ul id="ulObserverScreenList" class="dropdown-menu popover bottom"></ul>\
                </li>';var strLiDiagnosis='<li>\
                    <a class="nav-btn-a" pageId="<%menuId%>" page-type="<%pageType%>">\
                     <img class="nav-icon-svg" src="<%imgMenuPicSrc%>" onerror="this.style.display=\'none\'"/> \
                     <span class="glyphicon glyphicon-<%iconMenuPicDefault%>"></span>\
                        <%menuName%>\
                    </a>\
                </li>';var strLiAnalysis='<li>\
                <a class="nav-btn-a" pageId="<%menuId%>" page-type="<%pageType%>">\
                    <span>\
                        <img class="nav-icon-svg" src="<%imgMenuPicSrc%>" onerror="this.style.display=\'none\'"/> \
                        <span class="glyphicon glyphicon-<%iconMenuPicDefault%>"></span>\
                    </span>\
                    <%menuName%>\
                </a>\
            </li>';var strLiReport='<li permission="RReport">\
                    <a class="nav-btn-a" pageId="<%menuId%>" page-type="<%pageType%>" report-type="<%reportType%>" report-folder="<%reportFolder%>">\
                        <span>\
                            <img class="nav-icon-svg" src="<%imgMenuPicSrc%>" onerror="this.style.display=\'none\'"/> \
                            <span class="glyphicon glyphicon-<%iconMenuPicDefault%>"></span>\
                        </span>\
                        <%menuName%>\
                    </a>\
                </li>';var strLiEnergy='<li permission="RDashboard">\
                    <a class="nav-btn-a" pageId="<%menuId%>" page-type="<%pageType%>">\
                        <span>\
                          <img class="nav-icon-svg" src="<%imgMenuPicSrc%>" onerror="this.style.display=\'none\'"/> \
                          <span class="glyphicon glyphicon-<%iconMenuPicDefault%>"></span>\
                        </span>\
                        <%menuName%>\
                    </a>\
                </li>';var strLiDropDownList='<li class="dropdown">\
                    <a class="dropdown-toggle nav-btn-a" pageId="<%menuId%>" data-toggle="dropdown" aria-expanded="false">\
                        <span>\
                          <img class="nav-icon-svg" src="<%imgMenuPicSrc%>" onerror="this.style.display=\'none\'"/> \
                          <span class="glyphicon glyphicon-<%iconMenuPicDefault%>"></span>\
                        </span>\
                        <%menuName%>\
                        <span class="caret"></span>\
                    </a>\
                    <ul class="dropdown-menu popover bottom" id="<%parentId%>"><div class="arrow"></div></ul>\
                </li>';var dropDownItems=[];AppConfig.menu={};if(!navItems)return;var systemSkin=window.localStorage.getItem('systemSkin_'+AppConfig.userId);if(!systemSkin||systemSkin==null||systemSkin==undefined){systemSkin='default';}
var imgMenuPicDefault={ObserverScreen:'/static/images/menu/Observer-'+systemSkin+'.svg',DiagnosisScreen:'/static/images/menu/Diagnosis-'+systemSkin+'.svg',AnalysisScreen:'/static/images/menu/Analysis-'+systemSkin+'.svg',ReportScreen:'/static/images/menu/Report-'+systemSkin+'.svg',EnergyScreen:'/static/images/menu/Energy-'+systemSkin+'.svg',DropDownList:'/static/images/menu/Energy-'+systemSkin+'.svg',WorkflowMine:'/static/images/menu/Report- '+systemSkin+'.svg',defaultMenuPic:'/static/images/menu/Analysis-'+systemSkin+'.svg',PageScreen:'/static/images/menu/Energy-'+systemSkin+'.svg',FacReportScreen:'/static/images/menu/Energy-'+systemSkin+'.svg',FacReportWrapScreen:'/static/images/menu/Energy-'+systemSkin+'.svg',BenchmarkScreen:'/static/images/menu/Energy-'+systemSkin+'.svg'};for(var i=0;i<navItems.length;i++){if(!navItems[i].parent||navItems[i].parent==''){spanTag=navItems[i].text;if(AppConfig.isMobile){spanTag='';}else{if(spanTag.indexOf('observer.menu.')>=0){spanTag='<span class="nav-btn-text">'+I18n.findContent(spanTag)+'</span>';}else{spanTag='<span class="nav-btn-text">'+spanTag+'</span>';}}
var navItemPic=navItems[i].pic,navItemsType=navItems[i].type;switch(navItemsType){case'ObserverScreen':liTag=strLiObserver;liTag=liTag.replace('<%iconMenuPicDefault%>',navItemPic);break;case'PageScreen':case'FacReportScreen':case'FacReportWrapScreen':case'DiagnosisScreen':case'BenchmarkScreen':liTag=strLiDiagnosis;liTag=liTag.replace('<%iconMenuPicDefault%>',navItemPic);break;case'AnalysisScreen':liTag=strLiAnalysis;liTag=liTag.replace('<%iconMenuPicDefault%>',navItemPic);break;case'ReportScreen':liTag=strLiReport;liTag=liTag.replace('<%reportType%>',navItems[i].reportType).replace('<%reportFolder%>',navItems[i].reportFolder).replace('<%iconMenuPicDefault%>',navItemPic);AppConfig.menu[navItems[i].id]=navItems[i].text;break;case'EnergyScreen':liTag=strLiEnergy;liTag=liTag.replace('<%iconMenuPicDefault%>',navItemPic);AppConfig.menu[navItems[i].id]=navItems[i].text;break;case'EnergyScreen_M':if(AppConfig.role_permission.c_dashboard){liTag=strLiEnergy;liTag=liTag.replace('<%iconMenuPicDefault%>',navItemPic);AppConfig.menu[navItems[i].id]=navItems[i].text;}else{liTag=null;}
break;case'DropDownList':liTag=strLiDropDownList.replace('<%parentId%>','DropDownList'+navItems[i].id).replace('<%iconMenuPicDefault%>',navItemPic);break;case'WorkflowMine':liTag=strLiReport;liTag=liTag.replace('<%iconMenuPicDefault%>',navItemPic);break;default:break;}
if(liTag){var menuItem='';if(navItemPic){navItemPic=navItemPic.split('-')[0]+'-'+systemSkin+'.svg';menuItem=liTag.replace('<%imgMenuPicSrc%>',navItemPic).replace('<%menuName%>',spanTag).replace('<%menuId%>',navItems[i].id).replace('<%pageType%>',navItems[i].type);}else{menuItem=liTag.replace('<%imgMenuPicSrc%>',imgMenuPicDefault[navItemsType]).replace('<%menuName%>',spanTag).replace('<%menuId%>',navItems[i].id).replace('<%pageType%>',navItems[i].type);}
menuItem&&$ulPages.append(menuItem);}}else{dropDownItems.push(navItems[i]);}}
for(var ele in dropDownItems){this.initDropDownItem(dropDownItems[ele]);}
this.setMenuActive();I18n.fillArea($ulPages);},filterByAlarmRule:function filterByAlarmRule(data){var result=[];var rules=JSON.parse(localStorage.getItem('alarm_rules'));var row=deadline=key=null;if(!rules||!(rules=rules[AppConfig.projectId]))return data;for(var i=0,len=data.length;i<len;i++){row=data[i];key=window.encodeURIComponent(row['bindpointname']+'_'+row['time']);if(!(deadline=rules[key])){result.push(row);continue;}
if(data[i]['endtime']>=deadline){result.push(row);}}
return result;},clearMenu:function clearMenu(){$('#liProjectMenu').hide();$('#projectMenu').hide();$('#liProjectAlarm').hide();BackgroundWorkers.alarmReporter.postMessage({type:'clearTimer',name:'dataAlarmRealtime'});this.refreshAlarmPanel([]);$("#ulPages").empty();AppConfig.navItems=null;}};PaneProjectSelector.logout=function(){WebAPI.get('/logout/'+AppConfig.userId).done(function(){AppConfig={};window.onhashchange=null;localStorage.removeItem("userInfo");try{if(loginCode){location.href='/company/'+loginCode;return;}}catch(e){}
location.href='/';});};return PaneProjectSelector;}();var VersionHistory=function(){function VersionHistory(){this.configMap={templateURL:"static/views/admin/versionHistory.html"+'?='+new Date().getTime(),addVersionHistoryTitleGreed:I18n.resource.admin.versionHistory.VERSION_HISTORY_TITLE,addVersionHistoryContentGreed:I18n.resource.admin.versionHistory.VERSION_HISTORY_CONTENT,versionHistoryEditBtnClass:'.version-history-edit',versionHistoryDeleteBtnClass:'.version-history-delete',versionHistoryConfigBtnClass:'.version-history-config'};this.jqueryMap={};this.apiMap={getVersionHistory:'workflow/versionHistory/getAll/',addVersionHistory:'workflow/versionHistory/add',updateVersionHistory:'workflow/versionHistory/update',getAccurateVersionHistory:'workflow/versionHistory/getAccurate',deleteVersionHistory:'workflow/versionHistory/delete'};this.templateId={setVersionPanelList:'versionHistoryPlate_item'};this.versionOwnersList=null;this.UEeditor=null;this.modalType=null;this.versionId=null;}
VersionHistory.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.configMap.templateURL+'?t='+new Date().getTime()).done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.init().done(function(){_this.attachEvent();I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});});},init:function init(){var _this=this;return WebAPI.get(this.apiMap.getVersionHistory+AppConfig.userId).done(function(result){var isPermission,html='<button type="button" class="btn btn-success pull-right" id="versionHistory-add" i18n="admin.versionHistory.ADD_VERSION_HISTORY"></button>';AppConfig.userId==1||AppConfig.userId==67?(isPermission=true,$('.versionHistory-add-container').append(html)):isPermission=false;_this.setJqueryMap();if(result.data!==null&&result.data.length){var projectImgUrlList={};result.data.forEach(function(item){projectImgUrlList[item.id]=_this.getProjectInfo(item);});$('#versionHistory-container').html(beopTmpl(_this.templateId.setVersionPanelList,{versionList:result.data,isPermission:isPermission,projectImgUrlList:projectImgUrlList,changeProjectImg:true}));}});},setJqueryMap:function setJqueryMap(){this.jqueryMap={UEditor:$('#versionHistory-UEditor'),UEditorIdName:'versionHistory-UEditor',modal:$('#versionHistory-modal')};},attachEvent:function attachEvent(){var _this=this;this.jqueryMap.modal=$('#versionHistory-modal');var UEDITOR,verisonDescription,versionTitle,versionId;var $versionHistoryTitle=this.jqueryMap.modal.find('#versionHistory-modal-title'),$versionHistoryCommit=this.jqueryMap.modal.find('#versionHistory-commit'),$versionHistoryBody=$('#versionHistory'),$versionHistoryEditBtn=$(this.configMap.versionHistoryEditBtnClass),$versionHistoryAdd=$('#versionHistory-add'),$versionHistoryDeleteBtn=$(this.configMap.versionHistoryDeleteBtnClass);$versionHistoryEditBtn.off();$versionHistoryBody.on('click',this.configMap.versionHistoryEditBtnClass,function(){var $this=$(this);verisonDescription=$.trim($this.parent().next().find('.panel-project-log').html());versionTitle=$.trim($this.parent().find('.panel-title').text());_this.modalType='edit';versionId=$this.parent().parent().attr('data-version-history-id');$versionHistoryTitle.text(versionTitle).attr('contenteditable',false);var $modalBody=_this.jqueryMap.modal.find('.modal-body');$modalBody.empty();_this.jqueryMap.modal.modal({keyboard:false,backdrop:'static'});});$versionHistoryDeleteBtn.off();$versionHistoryBody.on('click',this.configMap.versionHistoryDeleteBtnClass,function(){var $this=$(this),$parent=$this.parent().parent();versionId=$parent.attr('data-version-history-id');confirm(I18n.resource.admin.versionHistory.VERSION_HISTORY_DELETE,function(){Spinner.spin(ElScreenContainer);WebAPI.post(_this.apiMap.deleteVersionHistory+'/'+AppConfig.userId+'/'+versionId).done(function(){$parent.remove();Alert.success(ElScreenContainer,I18n.resource.admin.versionHistory.VERSION_HISTORY_DELETE_SUCCESS).showAtTop(200);}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.versionHistory.VERSION_HISTORY_DELETE_FAILED).showAtTop(200);}).always(function(){Spinner.stop();});});});$versionHistoryAdd.off().on('click',function(){verisonDescription=_this.configMap.addVersionHistoryContentGreed;versionTitle=_this.configMap.addVersionHistoryTitleGreed;_this.modalType='new';$versionHistoryTitle.text(versionTitle).attr('contenteditable',false);var $modalBody=_this.jqueryMap.modal.find('.modal-body');$modalBody.empty();_this.jqueryMap.modal.modal({keyboard:false,backdrop:'static'});});_this.attachConfigOwnersEvent();_this.jqueryMap.modal.on('shown.bs.modal',function(){var $modalBody=_this.jqueryMap.modal.find('.modal-body'),width=$modalBody.width();Spinner.spin($modalBody.get(0));if(_this.modalType=='config'){Spinner.stop();}else{$modalBody.append('<script id="versionHistory-UEditor" name="content" type="text/plain"></script>');UEDITOR=new UE.ui.Editor({initialFrameHeight:400,initialFrameWidth:width});UEDITOR.setOpt(window.UEDITOR_CONFIG.toolbars);UEDITOR.render(_this.jqueryMap.UEditorIdName);UEDITOR.ready(function(){_this.UEeditor=UEDITOR;UEDITOR.setContent(verisonDescription);Spinner.stop();});}});this.jqueryMap.modal.find('button[data-close="modal"]').off().on('click',function(ev){ev.stopPropagation();ev.preventDefault();if(_this.modalType=='config'){_this.jqueryMap.modal.modal('hide');}else{confirm(I18n.resource.admin.versionHistory.VERSION_HISTORY_ALERT,function(){_this.jqueryMap.modal.modal('hide');});}});this.jqueryMap.modal.on('hidden.bs.modal',function(){if(_this.modalType=='config'){}else{UEDITOR.destroy();}});$versionHistoryTitle.off().on('click',function(){if(_this.modalType=='config'){return false;}else{var html='<input type="text"/',$this=$(this),text=$this.text();$this.attr('contenteditable',true);}});$versionHistoryCommit.off().on('click',function(){switch(_this.modalType){case'new':_this.addVersion();break;case'edit':_this.updateVersion(versionId);break;case'config':_this.updateOwners(_this.versionId);break;}});},getProjectInfo:function getProjectInfo(item,isJson){var ownerList;if(item.owners){try{if(!isJson){ownerList=JSON.parse(item.owners);}else{ownerList=item.owners;}
var list=[];ownerList.forEach(function(id){AppConfig.projectList.forEach(function(project){if(project.id==id){list.push({pic:project.pic,name:project.name_cn});}});});return list;}catch(ex){console.error(ex);}}else{return null;}},attachConfigOwnersEvent:function attachConfigOwnersEvent(){var $versionHistoryBody=$('#versionHistory'),_this=this;$versionHistoryBody.find(this.configMap.versionHistoryConfigBtnClass).off().on('click',function(ev){_this.jqueryMap.modal.find('#versionHistory-modal-title').text($.trim($(this).parent().find('.panel-title').text())).attr('contenteditable',false);_this.modalType='config';var $this=$(this);_this.versionId=$this.parent().parent().attr('data-version-history-id');var $modalBody=_this.jqueryMap.modal.find('.modal-body');$modalBody.empty();Spinner.spin(ElScreenContainer);WebAPI.post(_this.apiMap.getAccurateVersionHistory+'/'+_this.versionId,{userId:AppConfig.userId}).done(function(result){if(result.data){var versionOwners=result.data.owners;if(!!!versionOwners||versionOwners==='undefined'||versionOwners==[]){versionOwners=[];}else{versionOwners=JSON.parse(versionOwners);}
_this.versionOwnersList=versionOwners;$modalBody.off().html(beopTmpl('versionHistory_config_proj_item',{isEN:false,versionId:_this.versionId,versionOwners:versionOwners}));_this.jqueryMap.modal.off('.project-item').on('click.project-item','.project-item',function(ev){var $this=$(this),projectId=$this.attr('data-project-id');$this.toggleClass('checked');if($this.hasClass('checked')){_this.setOwners(projectId);}else{_this.removeOwners(projectId);}
ev.stopPropagation();ev.preventDefault();});_this.jqueryMap.modal.modal({keyboard:false,backdrop:'static'});}}).fail(function(){}).always(function(){Spinner.stop();});});},setOwners:function setOwners(projectId){if(this.versionOwnersList.indexOf(projectId)==-1){this.versionOwnersList.push(projectId);}},removeOwners:function removeOwners(projectId){var index=this.versionOwnersList.indexOf(projectId);if(index!==-1){this.versionOwnersList.splice(index,1);}},updateOwners:function updateOwners(versionId){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.post('workflow/versionHistory/setOwners',{versionId:versionId,userId:AppConfig.userId,owners:this.versionOwnersList}).done(function(){$('#versionHistory-container').find('.panel').each(function(){var $this=$(this);if($this.attr('data-version-history-id')==versionId){$this.find('.panel-project-img').remove().end().find('.panel-body').prepend(beopTmpl('versionHistory_config_proj_img',{projectImgUrlList:_this.getProjectInfo({owners:_this.versionOwnersList},true)}));}});alert('保存配置成功！');_this.jqueryMap.modal.modal('hide');}).fail(function(){alert('保存配置失败！');}).always(function(){Spinner.stop();});},addVersion:function addVersion(){var UE=this.UEeditor,_this=this;var html=$.trim(UE.getContent()),txt=$.trim(UE.getContentTxt()),userId=AppConfig.userId,title=$.trim(this.jqueryMap.modal.find('#versionHistory-modal-title').text());if(title==this.configMap.addVersionHistoryTitleGreed||txt==this.configMap.addVersionHistoryContentGreed){Alert.danger(ElScreenContainer,I18n.resource.admin.versionHistory.TIPS).showAtTop(200);return false;}
Spinner.spin(this.jqueryMap.modal.get(0));WebAPI.post(this.apiMap.addVersionHistory+'/'+userId,{title_version:title,userId:userId,html:html,txt:txt}).done(function(result){var getNewVersion=function getNewVersion(id){return WebAPI.post(_this.apiMap.getAccurateVersionHistory+'/'+id,{userId:AppConfig.userId}).done(function(result){if(result.data){var data=result.data;_this.versionOwnersList=result.data.owners;var projectImgUrlList={};projectImgUrlList[result.data.id]=_this.getProjectInfo({owners:_this.versionOwnersList},true);$('#versionHistory-container').prepend(beopTmpl(_this.templateId.setVersionPanelList,{versionList:[{version:data.version,log:data.log,id:data.id,userId:userId}],isPermission:true,projectImgUrlList:projectImgUrlList,changeProjectImg:true}));}});};getNewVersion(result.data.versionId).done(function(){Alert.success(ElScreenContainer,I18n.resource.admin.versionHistory.ADD_SUCCESS).showAtTop(200);}).always(function(){Spinner.stop();_this.jqueryMap.modal.modal('hide');_this.attachConfigOwnersEvent();});}).always(function(){}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.versionHistory.ADD_FAILED).showAtTop(200);});},updateVersion:function updateVersion(versionId){var UE=this.UEeditor,_this=this;var html=UE.getContent(),txt=UE.getContentTxt(),userId=AppConfig.userId,title=$(this.jqueryMap.modal.find('#versionHistory-modal-title')).text();Spinner.spin(this.jqueryMap.modal.get(0));WebAPI.post(this.apiMap.updateVersionHistory+'/'+userId+'/'+versionId,{title_version:title,userId:userId,html:html,txt:txt,versionId:versionId}).done(function(){var getNewVersion=function getNewVersion(id){return WebAPI.post(_this.apiMap.getAccurateVersionHistory+'/'+id,{userId:AppConfig.userId}).done(function(result){if(result.data){var data=result.data;$('#versionHistory-container').find('div').each(function(){var $this=$(this),versionHistoryID=$this.attr('data-version-history-id');if(versionHistoryID==versionId){$this.replaceWith(beopTmpl(_this.templateId.setVersionPanelList,{versionList:[{version:data.version,log:data.log,id:data.id,userId:userId}],isPermission:true,changeProjectImg:false}));}});}});};getNewVersion(versionId).done(function(){Alert.success(ElScreenContainer,I18n.resource.admin.versionHistory.UPDATE_SUCCESS).showAtTop(200);}).always(function(){Spinner.stop();_this.jqueryMap.modal.modal('hide');_this.attachConfigOwnersEvent();});}).always(function(){_this.jqueryMap.modal.modal('show');}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.versionHistory.UPDATE_FAILED).showAtTop(200);});},detachEvents:function detachEvents(){this.jqueryMap.modal.off();},close:function close(){this.detachEvents();this.versionOwnersList=null;this.UEeditor=null;this.modalType=null;this.versionId=null;}};return VersionHistory;}();var ElScreenContainer=document.getElementById('indexMain');var ScreenCurrent=undefined;var ScreenModal=undefined;var ScreenPrevious=undefined;var ToolCurrent=undefined;var Spinner=new LoadingSpinner({color:'#00FFFF'});var AppConfig=AppConfig||{projectId:undefined,projectName:undefined,userId:undefined,account:undefined,level:undefined,projectList:undefined,isMobile:navigator.userAgent.match(/iP(ad|hone|od)|Android/i),chartTheme:'macarons',isFactory:0};var I18n=I18n?I18n:undefined;var BackgroundWorkers={};echarts.config=echarts.config||{color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500']};$(document).ready(function(){$("#ulPages").hide();});var IndexScreen=function(){function IndexScreen(){}
IndexScreen.prototype={show:function show(){this.init();$('.totalDown').show().off('click').click(function(){location.href='/static/views/homeSlider/showPage.html?language='+I18n.type;});},close:function close(){document.onkeydown=false;$('.totalDown').hide();$('#indexMain').off('mousewheel');},init:function init(){var _this=this;$("#containerBackground").remove();_this.initLogin();_this.initRegister();_this.initResetPassword();$("#selectLanguage").off('click.loadI18nResource').on('click.loadI18nResource','a',function(e){InitI18nResource(e.currentTarget.attributes.value.value,true).always(function(rs){I18n=new Internationalization(null,rs);});I18n.fillPage();e.preventDefault();});$(".login-feature-pane > div").hover(function(e){document.getElementsByName('div-img-default')[0].style.display='none';var element=document.getElementsByName(e.currentTarget.className.replace('grow login-','div-img-'))[0];element.style.display='block';},function(e){document.getElementsByName('div-img-default')[0].style.display='block';var element=document.getElementsByName(e.currentTarget.className.replace('grow login-','div-img-'))[0];element.style.display='none';});$(document).ready(function(){_this.restorePwd();I18n.fillArea($('#divLanguage').fadeIn());I18n.fillArea($('#divLogin').css('visibility','visible').fadeIn());I18n.fillArea($('#navPane'));LoadingAnimationStep=2;});},initLogin:function initLogin(){var _this=this;$("#btnLogin").click(function(e){_this.login();});$(document).on("keydown","#divLogin input",function(event){var e=event||window.event||arguments.callee.caller.arguments[0];if(e&&e.keyCode==13){_this.login();}});I18n.fillArea($('#paneLogin'));$('#txtName').attr('placeholder',I18n.resource.admin.login.PANE_PLACEHOLDER_ACCOUNT);$('#txtPwd').attr('placeholder',I18n.resource.admin.login.PANE_PLACEHOLDER_PWD);},initResetPassword:function initResetPassword(){var $resetModal=$('#resetPasswordModal'),$passwordResetBtn=$('#passwordResetBtn'),$inputEmail=$resetModal.find('#inputEmail'),isValidEmail,addValidStatus,removeValidStatus,errorTooltip;I18n.fillArea($resetModal);addValidStatus=function addValidStatus(msg){errorTooltip=$inputEmail.tooltip({container:'body',placement:"right",trigger:"manual",template:'<div class="tooltip" role="tooltip">'+'<div class="tooltip-arrow" style="border-right-color: rgb(165, 42, 42);"></div>'+'<div class="tooltip-inner" style="background-color: rgb(165, 42, 42);"></div>'+'</div>',html:true,title:msg||''});errorTooltip.tooltip('show');};removeValidStatus=function removeValidStatus(){errorTooltip&&errorTooltip.tooltip('destroy');};isValidEmail=function isValidEmail(email){if(!email){return false;}
return RegExp('^[a-zA-Z0-9_-|\\.]+@[a-zA-Z0-9_-]+(?:\\.[a-zA-Z0-9_-]+)+$','g').test(email);};$inputEmail.on('keydown',removeValidStatus);$resetModal.on('shown.bs.modal',function(){$inputEmail.val($('#txtName').val());}).on('hide.bs.modal',function(){removeValidStatus();});$passwordResetBtn.click(function(){if(!$inputEmail.val()){addValidStatus(I18n.resource.observer.widgets.EMAIL_ADDRESS_REQUIRED);return false;}
if(!isValidEmail($inputEmail.val())){addValidStatus(I18n.resource.observer.widgets.INVALID_EMAIL_ADDRESS);return false;}
var $resetModalContent=$("#resetPasswordModal .modal-content");Spinner.spin($resetModalContent.get(0));WebAPI.post('/send_reset_pwd_email',{email:$inputEmail.val(),serverURL:location.origin}).done(function(result){if(result==='success'){$passwordResetBtn.remove();$resetModalContent.find('.message').text(I18n.resource.observer.widgets.EMAIL_PASSWORD_SENT_SUCCESS);}else{if(result==='email was sent'){addValidStatus(I18n.resource.observer.widgets.EMAIL_PASSWORD_SENT);}else if(result==="email is not exist"){addValidStatus(I18n.resource.observer.widgets.EMAIL_NOT_EXIST);}else if(result==="account is not activated."){addValidStatus(I18n.resource.observer.widgets.EMAIL_NOT_ACTIVATED);}}}).fail(function(){addValidStatus(I18n.resource.observer.widgets.EMAIL_FAILED_SEND);}).always(function(){Spinner.stop();});});},initRegister:function initRegister(){var _this=this;var $iptMailAddr=$('#iptMailAddr');var $panes=$('#regContent').find('.modal-body');var util={panes:{show:function show(index){$panes.hide();$panes.eq(index).show();}},tooltip:{show:function show($ele,cnt,delay){$ele.attr('data-original-title',cnt);$ele.tooltip('show');if($ele[0].timer){window.clearTimeout($ele[0].timer);$ele[0].timer=null;}
$ele[0].timer=window.setTimeout(function(){$ele.tooltip('hide');},delay||3000);},hide:function hide($ele){$ele.tooltip('hide');}},mail:{changeStatus:function changeStatus(mail,status,msg){var $tipWrap=$('#mailTipWrap'),$tip=$tipWrap.children('span').eq(1),$links=$('#mailLinksWrap').children('a'),$linkReturn=$links.eq(0),$linkMail=$links.eq(1),$icon=$tipWrap.find('.glyphicon').eq(0),cls=$icon.attr('class').replace(/\s*\b(?:glyphicon-).+?\b\s*/,' ').trim();var mailhost=null;$icon.attr('class',cls);$tip.text(msg);switch(status){case'success':$tipWrap.addClass('txt-success');$icon.addClass('glyphicon-ok');$linkReturn.show();mailhost=this.getMailHost(mail);mailhost&&$linkMail.attr('href','http://'+mailhost).show();break;case'warn':$tipWrap.addClass('txt-warning');$icon.addClass('glyphicon-alert');$linkReturn.show();mailhost=this.getMailHost(mail);mailhost&&$linkMail.attr('href','http://'+mailhost).show();break;case'error':$tipWrap.addClass('txt-danger');$icon.addClass('glyphicon-remove');$linkReturn.show();$linkMail.hide();break;default:$tipWrap.removeClass('txt-danger txt-success');$icon.addClass('glyphicon-exclamation-sign');$linkReturn.show();$linkMail.hide();break;}},getMailHost:function getMailHost(mail){var str=mail.split('@')[1].toLowerCase();switch(str){case'163.com':return'mail.163.com';case'vip.163.com':return'vip.163.com';case'mail.126.com':return'mail.126.com';case'qq.com':case'vip.qq.com':case'foxmail.com':return'mail.qq.com';case'gmail.com':return'mail.google.com';case'sohu.com':return'mail.sohu.com';case'tom.com':return'mail.tom.com';case'vip.sina.com':return'vip.sina.com';case'sina.com.cn':case'sina.com':return'mail.sina.com.cn';case'yahoo.com.cn':case'yahoo.cn':return'mail.cn.yahoo.com';case'yeah.net':return'www.yeah.net';case'21cn.com':return'mail.21cn.com';case'hotmail.com':return'www.hotmail.com';case'sogou.com':return'mail.sogou.com';case'188.com':return'www.188.com';case'139.com':return'mail.10086.cn';case'189.cn':return'webmail15.189.cn/webmail';case'wo.com.cn':return'mail.wo.com.cn/smsmail';case'rnbtech.com.hk':return'mail.rnbtech.com.hk';default:return false;}}},inputbox:{changeStatus:function changeStatus($ele,status){var $wrap=$ele.parentsUntil('.form-group'),$icon=$wrap.find('.glyphicon').eq(0),cls=$icon.attr('class').replace(/\s*\b(?:glyphicon-).+?\b\s*/,' ').trim();$icon.attr('class',cls);switch(status){case'success':$wrap.addClass('has-success');$icon.addClass('glyphicon-ok');break;case'error':$wrap.addClass('has-error');$icon.addClass('glyphicon-remove');break;case'default':default:$wrap.removeClass('has-error has-success');$icon.addClass('glyphicon-pencil');break;}}}};$iptMailAddr.tooltip({title:'',trigger:'manual'});$('#btnRegister').click(function(){util.inputbox.changeStatus($iptMailAddr,'default');I18n.fillArea($('#regContent'));$('#regContent').modal('show');});$('#mailReinput').click(function(){util.panes.show(0);});$("#messageShowAll").click(function(){ScreenManager.goTo({page:'AllMessages'});});$('#userSave').click(function(){var addr=$iptMailAddr.val().trim();var $this=$(this);if(!addr){util.tooltip.show($iptMailAddr,'邮箱地址不能为空！');util.inputbox.changeStatus($iptMailAddr,'error');return;}
if(!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(addr)){util.tooltip.show($iptMailAddr,'邮箱格式有误！');util.inputbox.changeStatus($iptMailAddr,'error');return;}
util.inputbox.changeStatus($iptMailAddr,'default');$this.prop('disabled',true);util.panes.show(1);WebAPI.post('/apply_for_registration',{email:addr,server_url:window.location.origin}).done(function(rs){var tips='';var s='success';var status=rs.status;switch(status){case 0:s='success';tips='邮件已经成功发送至您的邮箱，10分钟内有效，请您及时访问注册！';break;case-1:s='error';tips='该邮箱地址已经被注册过，请直接登录！';break;case-2:s='warn';tips='邮件已经发送，10分钟内不能重发，请检查您的邮箱！';break;case-3:default:s='error';tips='邮件发送失败，可能是网络故障，请稍后重试！';break;}
util.mail.changeStatus(addr,s,tips);}).fail(function(err){util.mail.changeStatus(addr,'error','邮件发送失败，可能是网络故障，请稍后重试！');}).always(function(){util.panes.show(2);$this.prop('disabled',false);});});},getFavoriteProject:function getFavoriteProject(){var favoriteProject=null;AppConfig.projectList.forEach(function(project){if(project.isFavorite){favoriteProject=project;}});return favoriteProject;},login:function login(){var _this=this;var $btnLogin=$('#btnLogin');$btnLogin.find('.spinner').show();$btnLogin.find('span').hide();$btnLogin.attr('disabled','disabled');var txtName=$("#txtName").val(),txtPwd=$("#txtPwd").val();var loginFail=function loginFail(msg){alert.danger(msg);$btnLogin.find('.spinner').hide();$btnLogin.find('span').show();$btnLogin.removeAttr('disabled');};if(!(txtName&&txtPwd)){loginFail(I18n.resource.observer.widgets.WARNING_EMPTY_ACCOUTN_OR_PASSWORD);return;}
WebAPI.post("/login/1",{name:txtName,pwd:txtPwd,agent:jscd?jscd:{}}).then(function(login_result){try{var after_login=function after_login(){if(login_result.status!=undefined&&login_result.status==true){if(login_result.projects&&login_result.projects.length>0){_this.rememberPwd();localStorage.removeItem('dataManagerStartDate');AppConfig.userId=login_result.id;AppConfig.account=$("#txtName").val();AppConfig.projectList=login_result.projects;AppConfig.userProfile=login_result.userProfile;AppConfig.debugTool=login_result.debugTool;if(AppConfig.projectList.length==1){AppConfig.skipProjectSelector=true;}else{AppConfig.skipProjectSelector=!!_this.getFavoriteProject();}
AppConfig.permission=login_result.permission;_this.setToBeopData(login_result.version);$('#navHeader').fadeIn();$('#indexMain').css({top:'55px'});try{if(!loadingAnimation){}}catch(e){location.hash="#page=PaneProjectSelector";}
LoadingAnimationStep='end';}else{loginFail("<strong>"+I18n.resource.observer.widgets.LOAD_PROJECT_FAILED+"</strong> "+I18n.resource.observer.widgets.NO_PERMISSION_PROJECT+"！");}}else{if(login_result.code&&login_result.code==1){loginFail("<strong>"+I18n.resource.observer.widgets.LOG_IN_FAILED+"</strong> "+I18n.resource.observer.widgets.INVALID_ACCOUNT_PASSWORD+"！");}else if(login_result.code&&login_result.code==2){loginFail("<strong>"+I18n.resource.observer.widgets.LOG_IN_FAILED+"</strong> "+I18n.resource.observer.widgets.ACCOUNT_EXPIRED);}else if(login_result.code&&login_result.code==3){loginFail("<strong>"+I18n.resource.observer.widgets.LOAD_PROJECT_FAILED+"</strong> "+I18n.resource.observer.widgets.NO_PERMISSION_PROJECT+"！");}}};}catch(e){loginFail("<strong>"+I18n.resource.observer.widgets.LOG_IN_FAILED+"！");return false;}
localStorage.setItem('isGoogleAvailable',false);if(!login_result.ip||login_result.ip==='127.0.0.1'){after_login();}else{$.ajax({url:'http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=js&ip='+login_result.ip,dataType:"script",timeout:2000}).done(function(){try{if(remote_ip_info&&remote_ip_info.ret>0){localStorage.setItem('isGoogleAvailable',_this.isGoogleAvailable(remote_ip_info.country,remote_ip_info.province));}}catch(e){console.log(e);}}).fail(function(e){console.warn('无法获得IP地址解析:'+login_result.ip+';');console.warn(e);localStorage.setItem('isGoogleAvailable','error');}).always(function(){after_login();});}}).always(function(){Spinner.stop();});},isGoogleAvailable:function isGoogleAvailable(country,province){if(country==='中国'){switch(province){case'香港':return true;case'澳门':return true;case'台湾':return true;default:return false;}}else{return true;}},rememberPwd:function rememberPwd(){if($("#cbRememberPwd").is(":checked")){localStorage["userInfo"]=JSON.stringify({name:$("#txtName").val(),pwd:$("#txtPwd").val()});}else{localStorage.removeItem("userInfo");}},setVersionHistory:function setVersionHistory(data){var versionHistoryKey='versionHistory';var currentVersion=window.localStorage.getItem(versionHistoryKey),result;try{if(!!currentVersion&&currentVersion!=='undefined'){currentVersion=JSON.parse(currentVersion);if(currentVersion.version==data.version){if(currentVersion.readUsers){if(currentVersion.readUsers.indexOf(AppConfig.userId)==-1){result=$.extend(data,{readUsers:currentVersion.readUsers,newest:false});}else{result=$.extend(data,{readUsers:currentVersion.readUsers,newest:true});}}else{result=$.extend(data,{readUsers:[],newest:false});}
window.localStorage.setItem(versionHistoryKey,JSON.stringify(result));}else{result=$.extend(data,{readUsers:[],newest:false});window.localStorage.setItem(versionHistoryKey,JSON.stringify(result));}}else{result=$.extend(data,{readUsers:[],newest:false});window.localStorage.setItem(versionHistoryKey,JSON.stringify(result));}}catch(ex){result=$.extend(data,{readUsers:[],newest:false});window.localStorage.setItem(versionHistoryKey,JSON.stringify(result));}
this.setToBeopData(result);},setToBeopData:function setToBeopData(result){if(beop){if(beop.data){beop.data.versionHistory=result;}else{beop.data={};beop.data.versionHistory=result;}}else{beop={};beop.data={};beop.data.versionHistory=result;}},restorePwd:function restorePwd(){if(localStorage["userInfo"]){var data=JSON.parse(localStorage["userInfo"]);if(data.pwd&&data.pwd!=""){$("#cbRememberPwd").attr("checked",true);$("#txtName").val(data.name);$("#txtPwd").val(data.pwd);}}}};return IndexScreen;}();var AllMessages=function(){'use strict';function AllMessages(){this._configMap={url:"static/views/admin/allMessages.html"};this._messageTypeList=["notRead","read","all"];this._messageSubTypeList=["all","diagnosis","workflow","versionHistory"];this.state={messageType:"all",messageSubType:"all",messageTotalCount:0,pageSize:15,pageNumber:1};this._jqueryMap={};this._apiMap={queryMessageApi:"/message/api/v1/queryUserMessage",markAsReadApi:"/message/api/v1/markAsRead",deleteMsgApi:"/message/api/v1/deleteUserMsg"};}
AllMessages.prototype={show:function show(){$(".infoBoxMessage").hide();Spinner.spin(ElScreenContainer);WebAPI.get(this._configMap.url+'?t='+new Date().getTime()).done(function(resultHtml){$(ElScreenContainer).html(resultHtml);this._init();I18n.fillArea(this._jqueryMap.$container);}.bind(this));},set messageType(type){if(!type){throw new SyntaxError("message Type isn\'t defined");}
if(this._messageTypeList.indexOf(type)==-1){throw new Error("message Type isn\'t supposed"+type);}else{this.state.messageType=type;}},get messageType(){return this.state.messageType;},set messageSubType(subType){if(!subType){throw new SyntaxError("message subType isn\'t defined");}
if(this._messageSubTypeList.indexOf(subType)==-1){throw new Error("message Type isn\'t supposed"+subType);}else{this.state.messageSubType=subType;}},get messageSubType(){return this.state.messageSubType;},_init:function _init(){this._setJqueryMap();this._attachEvent();this._fetchMessageData();},_setJqueryMap:function _setJqueryMap(){var $container=$("#all_messages_box");var $messageTableContainer=$container.find("#message-list-container");this._jqueryMap={$container:$container,$leftContainer:$container.find('.nav-bar-list'),$rightContainer:$container.find('.allMessage-body'),$paginationContainer:$container.find('.pagination-container'),$messageTableContainer:$messageTableContainer,messageTableContainer:$messageTableContainer.get(0)};},_fetchMessageData:function _fetchMessageData(){Spinner.spin(this._jqueryMap.messageTableContainer);return WebAPI.post(this._apiMap.queryMessageApi,{limit:this.state.pageSize,page:this.state.pageNumber,type:this.state.messageType,tags:this.state.messageSubType}).done(function(result){this.state.messageTotalCount=result.data.totalCount;this._renderMessageList(result.data.message);this._refreshDOMMessageTypeState();if(result.data.totalCount){this._jqueryMap.$paginationContainer=this._jqueryMap.$container.find('.pagination-container');this._initTwbsPagination();}}.bind(this)).fail(function(){alert("get message data failed.");}).always(function(){Spinner.stop();});},_refreshDOMMessageTypeState:function _refreshDOMMessageTypeState(){var self=this;this._jqueryMap.$leftContainer.find("a.switch-msg-type").removeClass('active').each(function(){if($(this).attr("data-msg-type")==self.state.messageType){$(this).addClass("active");}});this._jqueryMap.$rightContainer.find("a.switch-msg-type").removeClass('active').each(function(){if($(this).attr("data-msg-sub-type")==self.state.messageSubType){$(this).addClass("active");}});},_attachEvent:function _attachEvent(){var self=this,$span=$('.allMessage-navBar-transform').find('span');this._jqueryMap.$container.off('click.navBarTransform').on('click.navBarTransform','.allMessage-navBar-transform',function(){self._jqueryMap.$container.toggleClass('message-navBar-hidden');$span.toggleClass("glyphicon-chevron-left").toggleClass("glyphicon-chevron-right");});this._jqueryMap.$container.off('click.changeMessageType').on('click.changeMessageType','a.switch-msg-type',function(){var $this=$(this);if($this.hasClass("active")){return false;}
var messageType=$this.attr('data-msg-type');var messageSubType=$this.attr("data-msg-sub-type");messageSubType&&(self.messageSubType=messageSubType);messageType&&(self.messageType=messageType,self.messageSubType="all");self.state.pageNumber=1;self._fetchMessageData();});this._jqueryMap.$rightContainer.off('change.message-check').on('change.message-check','.message-check',function(){var $this=$(this),isChecked=$this.is(":checked");var $checked=self._jqueryMap.$rightContainer.find("input.message-check-item:checked"),$allCheck=self._jqueryMap.$rightContainer.find("input.message-check-item");if($this.hasClass("message-check-all")){self._jqueryMap.$rightContainer.find("input.message-check").prop("checked",isChecked);}else{if($checked.length<$allCheck.length){self._jqueryMap.$rightContainer.find("input.message-check-all").prop('checked',false);}else if($checked.length==$allCheck.length){self._jqueryMap.$rightContainer.find("input.message-check-all").prop('checked',true);}}});var getCheckedMsgIdList=function getCheckedMsgIdList(){var msgIdList=[];self._jqueryMap.$rightContainer.find("input.message-check-item:checked").each(function(){var $parentTR=$(this).closest('tr');msgIdList.push($parentTR.attr("data-user-msg-id"));});return msgIdList;};this._jqueryMap.$rightContainer.off('click.msg-delete').on('click.msg-delete','.msg-delete',function(){Spinner.spin(self._jqueryMap.messageTableContainer);WebAPI.post(self._apiMap.deleteMsgApi,{msgIdList:getCheckedMsgIdList()}).done(function(){self._fetchMessageData();}).always(function(){Spinner.stop();});});this._jqueryMap.$rightContainer.off('click.msg-mark-as-read').on('click.msg-mark-as-read','.msg-mark-as-read',function(){Spinner.spin(self._jqueryMap.messageTableContainer);WebAPI.post(self._apiMap.markAsReadApi,{msgIdList:getCheckedMsgIdList()}).done(function(){self._fetchMessageData();}).always(function(){Spinner.stop();});});},_initTwbsPagination:function _initTwbsPagination(){var paginationOpts={first:'&laquo;&laquo',prev:'&laquo;',next:'&raquo;',last:'&raquo;&raquo;',startPage:this.state.pageNumber,totalPages:Math.ceil(this.state.messageTotalCount/this.state.pageSize),onPageClick:this._paginationNextPageCb.bind(this)};this._jqueryMap.$paginationContainer.twbsPagination(paginationOpts);},_paginationNextPageCb:function _paginationNextPageCb(event,page){this.state.pageNumber=page;this._fetchMessageData();},_renderMessageList:function _renderMessageList(data){this._jqueryMap.$messageTableContainer.empty().html(beopTmpl('tpl_message_table_list',{'messageList':data}));}};return AllMessages;}();var pyFormat=function(){var pyFormat=function pyFormat(){this._configMap={"KEY_PY_STORY":"BEOP.WF.PY","version":"1451029779889","JSONUrl":'/static/scripts/workflow2.0/wf.pinyin.json'};};pyFormat.prototype={init:function init(){},getPYLocalStorage:function getPYLocalStorage(){var _this=this,$Dfd=$.Deferred();var setLocalStorage=function setLocalStorage(result){window.localStorage.setItem(_this._configMap.KEY_PY_STORY,JSON.stringify(result));};if(!this._isPYStored()){return $.getJSON(_this._configMap.JSONUrl).done(function(result){if(result){setLocalStorage(result);}});}else{var py=window.localStorage.getItem(this._configMap.KEY_PY_STORY);try{py=JSON.parse(py);if(py.version&&py.version==this._configMap.version){return $Dfd.resolve(py);}else{return $.getJSON(_this._configMap.JSONUrl).done(function(result){if(result){setLocalStorage(result);}});}}catch(ex){return $.getJSON(_this._configMap.JSONUrl).done(function(result){if(result){setLocalStorage(result);}});}}},getPYMap:function getPYMap(PY,value){if(!!!value||value==='undefined')return value;return this._dealPYMap(PY,value);},_getVersion:function _getVersion(){return new Date().getTime();},_dealPYMap:function _dealPYMap(PY,value){if(arguments.length!==2)return new SyntaxError('arguments \'s length isn\'t 2');var format,result=[],_this=this;[].slice.call(value).forEach(function(item){if(typeof item!='string'||!!!item||item==='undefined'){result.push({key:item,pinyin:item,acronym:item});}else{format=_this._getZH_EN(PY,item);result.push({key:item,pinyin:format.pinyin,acronym:format.acronym});}});return result;},_isPYStored:function _isPYStored(){return!!window.localStorage.getItem(this._configMap.KEY_PY_STORY);},_getZH_EN:function _getZH_EN(PinYin,first_letter){var _name='',_char='',_firstChar='',_reg=/[a-z0-9A-Z\- ]/,i=0,len=first_letter.length;for(i=0;i<len;i++){var _val=first_letter[i];if(_reg.test(_val)){_name+=_val;}else{_char=getPinYin(_val);_name+=_char;_firstChar+=_char[0];}}
return{pinyin:_name,acronym:_firstChar};function getPinYin(_val){var _key='';for(var key in PinYin){if(PinYin.hasOwnProperty(key)){if(PinYin[key].indexOf(_val)==-1){_key=_val;}else{_key=key;break;}}}
return _key;}}};return pyFormat;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var beop;(function(beop){var configMap={AmapKey:'9cc89c68a4bd6f3f5f65589f85ad7685',AmapUrl:location.protocol+'//webapi.amap.com/maps',AmapVersion:'1.3',GmapKey:'AIzaSyAzzOzAmrGov5GLacve9w8_Q8dS-xBYCgc',GmapUrl:'https://maps.googleapis.com/maps/api/js',GmapVersion:'3.0',mapContainer:'map-canvas',project_img_path:'/static/images/project_img/',mapLoadCallBack:'mapLoadCallBack',defaultLatlng:'31.2114943,121.6283679',projectStatus:{online:'Online',offline:'Offline'},online_img_path:'/static/images/map_marker_online.png',offline_img_path:'/static/images/map_marker_offline.png',neighbouringRadius:80000,loadMapTimeout:3000,hasPowerLink:false,isFirstComeIn:true,isFirstLoadVersion:true};function inherits(clazz,base){var clazzPrototype=clazz.prototype;function F(){}
F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;}
function buildSrc(url,opts){if(!url){return null;}
if(!opts){return url;}
var paramArr=[];for(var prop in opts){if(opts[prop]){paramArr.push(prop+'='+opts[prop]);}}
return url+'?'+paramArr.join('&');}
function initPanelBtns(pageInfo){if(typeof pageInfo==='string'){try{pageInfo=JSON.parse(pageInfo);}catch(e){pageInfo={};console.error(e);}}
if(!pageInfo.funcNavItems||!pageInfo.funcNavItems.length){$('#cardBtnPanel').hide();}else{$('#cardBtnPanel').show();var firstEnergy;if(pageInfo.navItems.length>0){for(var item in pageInfo.navItems){if(pageInfo.navItems[item].type=='EnergyScreen'){firstEnergy=pageInfo.navItems[item];break;}}}
pageInfo.firstObserverScreenId=pageInfo.observerPages[0]&&pageInfo.observerPages[0].id;var btnsHtml=beopTmpl('mapCardBtnsTmpl',pageInfo);var $mapNavFunc=$('#map-nav-func').empty().html(btnsHtml);I18n.fillArea($mapNavFunc);}}
function getProject(id){for(var n=0,len=AppConfig.projectList.length;n<len;n++){var item=AppConfig.projectList[n];if(item.id==id){return item;}}}
function BeopMap(){this.url='';this.key='';this.container=configMap.mapContainer;this.map=null;this.zoom=5;this.markers={};this.infoWindows={};this.paneProjectSelector=new PaneProjectSelector();this.$projectDetailCard=$('#projectDetailCard');this.$projectsCard=$('#projectsCard');this.$nearbyProjects=this.$projectDetailCard.find('.nearby-projects');}
BeopMap.prototype.init=function(){this.attachPanelEvent();this.openProjectsCard();I18n.fillArea(this.$projectsCard);I18n.fillArea(this.$projectDetailCard);};BeopMap.prototype.destroy=BeopMap.prototype.close=function(){if(this.map&&this.map.destroy){if(BackgroundWorkers.fetchProjectStatus){BackgroundWorkers.fetchProjectStatus.postMessage({type:"clearTimer",name:"requestProjectStatus"});}
this.map.destroy();this.map=null;}};BeopMap.prototype.initWorkerForUpdating=function(){if(!BackgroundWorkers.fetchProjectStatus){BackgroundWorkers.fetchProjectStatus=new Worker("/static/views/js/worker/workerUpdate.js");}
this.workerUpdate=BackgroundWorkers.fetchProjectStatus;this.workerUpdate.addEventListener("message",this.refreshData.bind(this),true);this.workerUpdate.addEventListener("error",function(e){console.log(e);},true);this.workerUpdate.postMessage({type:"fetchProjectStatus",userId:AppConfig.userId});};BeopMap.prototype.refreshData=function(e){var result=e.data;if(result.success&&result.data&&result.data.projects){var projects=result.data.projects;for(var m=0;m<projects.length;m++){for(var n=0;n<AppConfig.projectList.length;n++){var item=AppConfig.projectList[n];if(item.id==projects[m].id){item.lastReceivedTime=projects[m].lastReceivedTime;item.updateMarker=item.online!=projects[m].online;item.online=projects[m].online;break;}}}
this.addMarkers(AppConfig.projectList);}};BeopMap.prototype.openProjectsCard=function(){var $projectContainer=this.$projectsCard.find('.project-media-container').html('');for(var i=0;i<AppConfig.projectList.length;i++){$projectContainer.append(beopTmpl('mapCardItemTmpl',{project:AppConfig.projectList[i]}));}
configMap.isFirstComeIn=false;this.$projectsCard.show();};BeopMap.prototype.addHistory=function(projectId){"use strict";if(!projectId)return false;var localStoragePrefix="userViewHistory",oldStorage=window.localStorage.getItem(localStoragePrefix);if(!oldStorage||oldStorage==undefined){window.localStorage.setItem(localStoragePrefix,projectId);}else{var currentStorage=oldStorage.split(',');if(currentStorage.length>=2){if(currentStorage[1]!=projectId){currentStorage=[currentStorage[1],projectId];}}else{if(currentStorage.indexOf(projectId.toString())==-1){currentStorage.push(projectId);}}
window.localStorage.setItem(localStoragePrefix,currentStorage);}};BeopMap.prototype.attachPanelEvent=function(){var _this=this;this.$projectDetailCard.off('click').on('click','.nav-item',function(){var $this=$(this),$pageType=$this.find('div[page-type]'),destination=$pageType.attr('page-type'),screen=_this.paneProjectSelector.menuScreenFactory(destination);if(destination==='ObserverScreen'){ScreenManager.show(ObserverScreen,$pageType.attr('page-id'));}else if(screen==EnergyScreen){ScreenManager.show(screen,$pageType.attr('page-id'));}else if(screen==ReportScreen){ScreenManager.show(screen,$pageType.attr('page-id'),$pageType.attr('report-folder'),$pageType.attr('report-type'));}else{var project_id=_this.$projectDetailCard.attr('project-id');if(!project_id){return false;}
AppConfig.projectId=parseInt(project_id);var projectItem=getProject(project_id);if(projectItem){AppConfig.projectName=projectItem.name_en;}
ScreenManager.show(screen,$pageType.attr('page-id'));}}).on('click','.card-close',function(){_this.paneProjectSelector.clearMenu();_this.closeAllInfoWindow();_this.collapseProjectPanel(function(){this.openProjectsCard();});AppConfig.projectId=undefined;});var $projectsCard=$('#projectsCard');var $advanceSearchBtn=$projectsCard.find('.project-control-advanceSearch'),$advanceContainer=$projectsCard.find('#advanceSearch-container'),$advanceContent=$projectsCard.find('#advanceSearch-content');var $panelToggle=$projectsCard.find('.project-media-toggle'),$panelToggleBtn=$panelToggle.find('i'),$searchTableToggle=$projectsCard.find('.search-table-toggle'),$projectCardContainer=$projectsCard.find('.projectsCard-container'),$projectCardControl=$projectsCard.find('.project-media-control'),$searchBox=$projectsCard.find('.project-media-searchBox'),$panel=$projectsCard.find('.project-media-panel');var $projectSearchContainer=$projectsCard.find("#pms-project-content");var $pmsProjectContainer=$projectsCard.find('#pms-project-content'),$pmsEquipmentContainer=$projectsCard.find('#pms-equipment'),$historyContainer=$projectsCard.find('.projectsCard-history-container');var $sortTitle=null;var $searchBoxClear=$projectsCard.find('.project-media-searchBox-clear');var PYFormat=new pyFormat(),PYProjectList=[],PYItem;PYFormat.getPYLocalStorage().done(function(result){AppConfig.projectList.forEach(function(item){var pinyin=' ';PYItem=PYFormat.getPYMap(result.data,item.name_cn);if(Array.isArray(PYItem)){PYItem.forEach(function(i){pinyin+=i.pinyin;});PYProjectList.push($.extend(true,{},item,{"id":item.id,"PY":$.trim(pinyin),"latlng":item.latlng,"name_en":item.name_en}));}else{PYProjectList.push($.extend(true,{},item,{"id":item.id,"PY":$.trim(pinyin),"latlng":item.latlng,"name_en":item.name_en}));}});PYFormat=null;});if(configMap.isFirstComeIn){AppConfig.projectList.forEach(function(item){if(item.name_cn&&item.name_cn.toLowerCase().indexOf("powerlink")!=-1||item.name_english&&item.name_english.toLowerCase().indexOf("powerlink")!=-1){configMap.hasPowerLink=true;}});}
if(!configMap.hasPowerLink){$panel.find("li").eq(2).off().removeClass("enabled").attr("role","").find("div").attr("data-target","").attr("data-toggle","");$advanceSearchBtn.off().hide();}else{}
var pmsProjectList=[{name:i18n_resource.admin.panel.advanceSearch.project.COUNTRY,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.project.PROVINCE,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.project.CITY,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.project.PROJECT_TYPE,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.project.APPLICATION_AREA,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.project.AUTHORIZE_TIME,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.project.POWER_FREQUENCY,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.project.POWER_SCALE,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.project.IS_parallel,options:[],role:"small"}],pmsEquipmentList=[{name:i18n_resource.admin.panel.advanceSearch.equipment.INTERNAL_COMBUSTION_ENGINE,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.equipment.COUNTRY,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.equipment.PROVINCE,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.equipment.CITY,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.equipment.PRODUCT_TYPE,options:[],role:"small",filter:"equipmentType"},{name:i18n_resource.admin.panel.advanceSearch.equipment.EQUIPMENT,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.equipment.EQUIPMENT_NUMBER,options:["CG200/S-NG","GXE160/S-6NG"],role:"small",filter:"equipmentModel"},{name:i18n_resource.admin.panel.advanceSearch.equipment.RATED_POWER,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.equipment.APPLICATION_AREA,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.equipment.APPLICATION_TYPE,options:[],role:"small"},{name:i18n_resource.admin.panel.advanceSearch.equipment.FACTORY_TIME,options:[],role:"small",filter:"factoryTime"},{name:i18n_resource.admin.panel.advanceSearch.equipment.AVERAGE_EFFICIENCY,options:[],role:"small"}];var userViewStorage=window.localStorage.getItem("userViewHistory"),userViewProjectList=[];if(!userViewStorage||userViewStorage==undefined){userViewProjectList=[];}else{try{userViewStorage.split(',').forEach(function(item){AppConfig.projectList.forEach(function(project){if(project.id==item){userViewProjectList.push(project);}});});}catch(ex){userViewProjectList=[];}}
if(userViewProjectList.length>0){var html='<p>'+i18n_resource.admin.panel.HISTORY_PROJECT_LIST+'</p>';userViewProjectList.forEach(function(item){html+=beopTmpl("mapCardItemTmpl",{project:item});});$historyContainer.empty().html(html);}else{$historyContainer.empty().hide();}
$pmsProjectContainer.empty().html(beopTmpl('project_media_search_arguments',{data:pmsProjectList}));$pmsEquipmentContainer.empty().html(beopTmpl('project_media_search_arguments',{data:pmsEquipmentList}));var defaultLatLng="20.643571, 112.15596";var restoreMap=function restoreMap(cb){AppConfig.projectList.forEach(function(item){try{_this.removeMarker(item.id);if(_this.infoWindows[item.id+"test"]){_this.removeMarker(item.id+"test");}}catch(ex){}});$('.amap-overlays').empty();var Itlang=defaultLatLng.split(',').reverse();_this.map.setZoom(4);_this.map.panTo([Itlang[0],Itlang[1]]);_this.map.setCenter([Itlang[0],Itlang[1]]);cb&&cb();};var resizeSearchContainer=function resizeSearchContainer(type){if(type=='max'||type=="pms-equipment"){$projectsCard.addClass("large-projectsCard");$projectCardControl.addClass("large-project-media-control");}else if(type=='min'||type=="pms-project"){$projectsCard.removeClass("large-projectsCard");$projectCardControl.removeClass("large-project-media-control");}};var searchMain=function searchMain(){$searchTableToggle.hide();var searchValue=$searchBox.val();if($sortTitle){$sortTitle.hide();}
$advanceSearchBtn.find('a').removeClass("active").find("i").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");$projectSearchContainer.slideUp().removeClass('active');if(searchValue==''||!searchValue){$projectsCard.find('.map-scrollbar').slideDown();$projectsCard.find('.project-media-result').slideUp();$historyContainer.show();restoreMap(function(){addVisibleMarks(AppConfig.projectList,true);});}else{Spinner.spin($projectsCard.get(0));$historyContainer.hide();dealAdvanceSearch($projectsCard,searchValue.toLowerCase());}
$advanceSearchBtn.removeClass('active');$projectCardContainer.slideDown();$advanceContainer.hide();resizeSearchContainer("min");};var addInfoWindowTest=function addInfoWindowTest(data){"use strict";var html="";data.forEach(function(item){html='<div style="padding:0px 0px 0px 4px;"><b>'+item.projectBelongs+'</b><br></div>';_this.addInfoWindow(item.projectID+"test",html);});};var searchEquipment=function searchEquipment(filter,restore){Spinner.spin($projectsCard.get(0));if(restore){$projectsCard.find('#pms-equipment').find('select').each(function(){$(this).val(0);});}
$.getJSON('static/mapSearch.json').done(function(result){if(result.success){var data=result.data.result.equipment,filterResult=[],key,isCurrentData;var $projectResultContainer=$projectsCard.find('.project-media-result');if(Array.isArray(data)){data.forEach(function(item){isCurrentData=true;for(key in filter){if(filter.hasOwnProperty(key)){if(item[key].toString().toLowerCase().indexOf(filter[key].toString().toLowerCase())==-1){isCurrentData=false;}}}
if(isCurrentData){var listObj={orderNumber:item.orderNumber,unitSerialNumber:item.unitSerialNumber,projectBelongs:item.projectBelongs,runningTimeHours:item.runningTimeHours,startRunningTime:item.startRunningTime,equipmentModel:item.equipmentModel,projectID:item.projectID,project:undefined};AppConfig.projectList.forEach(function(item){if(item.id==listObj.projectID){listObj.project=item;}});filterResult.push(listObj);}});$projectCardContainer.find('.map-scrollbar').hide();$projectResultContainer.empty().html(beopTmpl('project_media_search_equipment',{result:{type:['订单号','机组序列号','所属项目','运行小时','开始运营时间','设备型号'],data:filterResult}}));if(filterResult.length>0){$searchTableToggle.show();}
if(restore){$searchTableToggle.removeClass("search-table-toggle-active").removeClass("active").find("i").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");}
$projectResultContainer.slideDown();restoreMap(function(){bindSearchResultTableEvents($projectResultContainer);addVisibleMarks(filterResult);addInfoWindowTest(filterResult);$sortTitle=$('#sortTitle');});}}}).always(function(){Spinner.stop();});};$projectsCard.off().on('click','.project-control-advanceSearch>a',function(){if($projectSearchContainer.hasClass("active")){$projectSearchContainer.slideUp().removeClass('active');}else{$projectSearchContainer.slideDown().addClass("active");}
var $this=$(this);$this.toggleClass("active");if($this.hasClass('active')){$this.find("i").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up");}else{$this.find("i").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");}}).on('click','#advanceSearch-btn-1',function(){searchMain();}).on('click','.project-media-searchBox-clear',function(){$searchBox.val('');var type=$advanceContent.data("type");if(type=="pms-equipment"){$advanceContent.show();resizeSearchContainer("min");$projectsCard.find('.project-media-result').empty();}else{searchMain();}
$(this).hide();}).on('click','.search-table-toggle',function(){var $this=$(this),$icon=$this.find('i');if($this.hasClass('active')){resizeSearchContainer("min");$this.removeClass('active');$this.toggleClass("search-table-toggle-active");$icon.removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");}else{resizeSearchContainer("max");$this.addClass('active');$this.toggleClass("search-table-toggle-active");$icon.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up");}});var filter={};var addVisibleMarks=function addVisibleMarks(filterResult,isNative){var projectList=[];if(!isNative){filterResult.forEach(function(item){if(item.project!=undefined){projectList.push(item.project);}});}else{projectList=filterResult;}
_this.addMarkers(projectList,true);_this.setFitView();};$projectsCard.find('#pms-equipment').find('select').change(function(){$searchBox.val("");var $this=$(this),value=$this.val(),type=$this.data('filter');$this.parent().attr('title',$this.find("option:selected").text());if(value==0){delete filter[type];}else{filter[type]=value;}
searchEquipment(filter);});$projectsCard.find('[data-toggle="tab"]').on('show.bs.tab',function(e){$advanceContent.show();$historyContainer.show();$searchBox.val('');$searchBoxClear.hide();if($sortTitle){$sortTitle.hide();}
$projectCardContainer.parent().scrollTop(0);$advanceSearchBtn.find('a').removeClass("active").find("i").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");$projectSearchContainer.removeClass("active").hide();$searchTableToggle.removeClass("search-table-toggle-active").removeClass('active').hide();$searchTableToggle.find('i').removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");$projectsCard.find('.project-media-result').empty();$projectCardContainer.css({height:"calc(100% - "+($projectCardControl.height()+30)+"px)"}).find('.map-scrollbar').show();$projectsCard.find('#pms-equipment').find('select').each(function(){$(this).val(0);});var type=$(this).data('target').split('#')[1];$advanceContent.attr('data-type',type);if(type=="pms-project"){resizeSearchContainer("min");$searchBox.attr("placeholder",i18n_resource.admin.panel.SEARCH_PROJECT_PLACEHOLDER);}else if(type=="pms-equipment"){$historyContainer.hide();$searchBox.attr("placeholder",i18n_resource.admin.panel.SEARCH_EQUIPMENT_PLACEHOLDER);}
restoreMap(function(){addVisibleMarks(AppConfig.projectList,true);});});$projectsCard.find('.project-media-searchBox').keyup(function(ev){ev.preventDefault();ev.stopPropagation();var $this=$(this);if($this.val()==''&&$this.hasClass('active')){$searchBoxClear.hide();$projectsCard.find('.map-scrollbar').slideDown();$projectsCard.find('.project-media-result').empty().slideUp();$advanceSearchBtn.removeClass('active');$advanceContent.show();$advanceContainer.hide();$historyContainer.show();$projectsCard.find('#pms-equipment').find('select').each(function(){$(this).val(0);});$this.removeClass('active');resizeSearchContainer("min");restoreMap(function(){addVisibleMarks(AppConfig.projectList,true);});}else if($this.val()!=''){$searchBoxClear.show();$this.addClass('active');if(ev.keyCode==13){$historyContainer.hide();searchMain();}}});var timer=null;var bindSearchResultTableEvents=function bindSearchResultTableEvents($projectResultContainer){$projectResultContainer.find('table tbody tr').off().on('mouseenter',function(){var $this=$(this),projectId=$this.data('project-id');timer=setTimeout(function(){$projectResultContainer.find('table tbody tr').removeClass('active');$this.toggleClass('active');var result={};AppConfig.projectList.forEach(function(item){if(item.id==projectId){result=item;}});var addr=result.latlng,Itlang=[];if(addr==""||!addr){return false;}else{Itlang=addr.split(',');Itlang.reverse();_this.map.panTo([Itlang[0],Itlang[1]]);_this.map.setCenter([Itlang[0],Itlang[1]]);_this.map.setZoom(15);_this.openInfoWindow(_this.infoWindows[projectId+"test"],_this.markers[projectId]);}},500);}).on('mouseleave',function(){clearTimeout(timer);timer=null;});$projectResultContainer.find('table thead th').eq(3).off().on('click',function(){Spinner.spin($projectsCard.get(0));var list=[],result=[],$this=$(this),classPrefix='active';$projectResultContainer.find('table tbody tr').each(function(){list.push({dom:$(this).clone(),runningTimeHours:$(this).data('runningtimehours')});});if($this.hasClass(classPrefix)){$sortTitle.removeClass("glyphicon glyphicon-sort-by-attributes-alt").addClass("glyphicon glyphicon-sort-by-attributes").show();list.sort(function(a,b){return a.runningTimeHours-b.runningTimeHours;});}else{$sortTitle.removeClass("glyphicon glyphicon-sort-by-attributes").addClass("glyphicon glyphicon-sort-by-attributes-alt").show();list.sort(function(a,b){return a.runningTimeHours-b.runningTimeHours;}).reverse();}
list.forEach(function(item){result.push(item.dom);});$projectResultContainer.find('table tbody').empty().html(result);Spinner.stop();$this.toggleClass(classPrefix);bindSearchResultTableEvents($projectResultContainer);});};var dealAdvanceSearch=function dealAdvanceSearch($projectsCard,value){var language=window.localStorage.getItem('language'),projectList=AppConfig.projectList,result=[];var $projectResultContainer=$projectsCard.find('.project-media-result');if(language==='zh'){language='name_cn';}else if(language==='en'){language='name_english';}else{language='name_cn';}
var reg=/[a-z0-9A-Z\- ]/,searchValueList=value.split(''),mapMarksList=[],searchType=$projectsCard.find('#advanceSearch-content').attr("data-type");var isPullEnglish=true;searchValueList.forEach(function(item){if(!reg.test(item)){isPullEnglish=false;}});if(Array.isArray(projectList)){if(searchType=="pms-project"||searchType==""||searchType==undefined){if(isPullEnglish){PYProjectList.forEach(function(item){if(item.name_english&&$.trim(item.name_english.toString()).toLowerCase().indexOf(value.toLowerCase())!==-1||item.PY&&item.PY.toString().toLocaleLowerCase().indexOf(value.toString().toLocaleLowerCase())!==-1||item.id&&$.trim(item.id).indexOf($.trim(value))!==-1){result.push({pic:'/static/images/project_img/'+item.pic,name:item[language],address:item.address,latlng:item.latlng,name_en:item.name_en,id:item.id});mapMarksList.push(item);}});}else{projectList.forEach(function(item){if(item.name_cn&&$.trim(item.name_cn).indexOf(value)!==-1){result.push({pic:'/static/images/project_img/'+item.pic,name:item[language],address:item.address,latlng:item.latlng,name_en:item.name_en,id:item.id});mapMarksList.push(item);}});}
Spinner.stop();$projectsCard.find('.map-scrollbar').slideUp();$projectResultContainer.html(beopTmpl('project_media_search_name',{result:{name:value,length:result.length,data:result}}));$projectResultContainer.slideDown();restoreMap(function(){addVisibleMarks(mapMarksList,true);});$advanceContent.attr("data-type","pms-project");}else if(searchType=="pms-equipment"){searchEquipment({"equipmentModel":value},true);}}};$panelToggleBtn.off().on('click',function(){if($panelToggle.hasClass('project-media-toggle-active')){}else{$panelToggleBtn.removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');}
$panelToggle.toggleClass('project-media-toggle-active');});$('.map-card').on('click','.media',function(){var $this=$(this);var arrConfig=$this.attr("id").split("-");var projectId=parseInt(arrConfig[1]);var projectEnName=arrConfig[2];var projectName='';Spinner.spin(document.getElementById('projectsCard'));AppConfig.level=parseInt(arrConfig[3]);for(var i=0,len=AppConfig.projectList.length;i<len;i++){if(projectId===AppConfig.projectList[i].id){projectName=StringUtil.getI18nProjectName(AppConfig.projectList[i]);break;}}
if(!projectName){Spinner.stop();return;}
_this.paneProjectSelector.initProject(projectId,projectEnName,projectName).done(function(result){if(_this.workerUpdate){_this.workerUpdate.postMessage({type:"clearTimer",name:"requestProjectStatus"});}
try{var isFailed=_this.paneProjectSelector.initDefaultPage(result);if(isFailed!==false){_this.destroy();}}catch(ex){console.log(ex);}
_this.addHistory(projectId);}).always(function(){window.localStorage.setItem("calendarDefault",projectId);Spinner.stop();});}).on('click','.favorite',function(e){var $this=$(this);var projectIdStr=$this.closest('.media').attr("id");var projectId=parseInt(projectIdStr.split('-')[1]);var $projectsCard=$('#projectsCard');var $currentEleAll=$projectsCard.find('.media[id='+projectIdStr+'] .favorite');if($this.hasClass('active')){confirm(I18n.resource.admin.panel.CANCEL_DEFAULT,function(){WebAPI.post('/admin/removeFavoriteProject').done(function(){$currentEleAll.removeClass('active');AppConfig.projectList.forEach(function(project){project.isFavorite=false;});});});}else{confirm(I18n.resource.admin.panel.SET_DEFAULT,function(){WebAPI.post('/admin/setFavoriteProject',{projectId:projectId}).done(function(){$projectsCard.find('.favorite.active').removeClass('active');$currentEleAll.addClass('active');AppConfig.projectList.forEach(function(project){project.isFavorite=project.id==projectId;});});});}
e.stopPropagation();});};BeopMap.prototype.loadMapScriptFailed=function(msg){console.log(this.mapName+I18n.resource.core.beopMap.LOADED_FAILED);if(msg){console.log(msg);}
this.paneProjectSelector.setMapAvailable(false);this.paneProjectSelector.showPanelView();};BeopMap.prototype.loadScript=function(opts){if(!opts){opts={};}
$.extend(opts,{key:this.key});var src=buildSrc(this.url,opts),_this=this;$.ajax({url:src,dataType:"script",success:function success(){if(_this instanceof GoogleMap){isMapAsyncLoadSuccess=true;}
if(typeof isMapAsyncLoadSuccess=='undefined'&&_this instanceof GaodeMap){isMapAsyncLoadSuccess=false;return false;}
if(isMapAsyncLoadSuccess){console.log(_this.mapName+I18n.resource.core.beopMap.LOADED_SUCCESSFUL+'.');}else{_this.loadMapScriptFailed('');}},error:function error(jqXHR,errorText){_this.loadMapScriptFailed(errorText);},timeout:configMap.loadMapTimeout});};BeopMap.prototype.clickMarker=function(marker){if(!marker){return;}
this.trigger(marker,'click');};BeopMap.prototype.getInfoWindowContent=function(project){var info=[];info.push("<div style=\"padding:0px 0px 0px 4px;\"><b>"+StringUtil.getI18nProjectName(project)+"</b>");if(project.online){info.push(I18n.resource.admin.projectSelector.PROJECT_STATUS+" : "+project.online);}else{info.push(I18n.resource.admin.projectSelector.PROJECT_STATUS+" : "+configMap.projectStatus.offline);}
if(project.lastReceivedTime){info.push(I18n.resource.admin.projectSelector.PROJECT_LAST_RECEIVED_TIME+" : "+project.lastReceivedTime);}
info.push("</div'>");return info.join('<br/>');};BeopMap.prototype.getMarkerImagePath=function(isOnline){return isOnline?configMap.online_img_path:configMap.offline_img_path;};BeopMap.prototype.expandNearbyProject=function(){if(this.$nearbyProjects.find('.media').length===0){return;}
this.$nearbyProjects.slideDown(500);};BeopMap.prototype.addMarkers=function(markerCollection,isForce){var item,marker,infoWindow,isOnline;if(!markerCollection||!markerCollection.length){return false;}
var _this=this;for(var m=0;m<markerCollection.length;m++){item=markerCollection[m];if(!isForce&&typeof item.updateMarker=='boolean'&&!item.updateMarker){continue;}
isOnline=item.online&&item.online===configMap.projectStatus.online?true:false;marker=this.addMarker(item.id,item.latlng,isOnline);if(!marker){continue;}
infoWindow=this.addInfoWindow(item.id,this.getInfoWindowContent(item));_this.addMarkerClick(marker,function(item){return function(){_this.openInfoWindow(_this.infoWindows[item.id],_this.markers[item.id]);};}(item));}};BeopMap.prototype.initSingleProject=function(project){var _this=this,nearbyProjectList;return this.paneProjectSelector.initProject(project.id,project.name_en,StringUtil.getI18nProjectName(project),project.logo).done(function(result){_this.$projectsCard.hide();_this.collapseProjectPanel(function(){_this.loadProjectPanel(project);_this.$nearbyProjects.hide();initPanelBtns(result);_this.openInfoWindow(_this.infoWindows[project.id],_this.markers[project.id]);_this.expandProjectPanel(_this.expandNearbyProject);nearbyProjectList=_this.getNearbyProjects(project.id,configMap.neighbouringRadius);_this.renderNearbyProjects(nearbyProjectList);});}).always(function(){Spinner.stop();});};BeopMap.prototype.renderNearbyProjects=function(projectList){var $projectsContainer=this.$nearbyProjects.find('.projects-section');$projectsContainer.empty();for(var m=0,len=projectList.length;m<len;m++){$projectsContainer.append(this.createProjectItemOfCard(projectList[m]));}};BeopMap.prototype.createProjectItemOfCard=function(project){var projectName=StringUtil.getI18nProjectName(project);var divMedia=$('<div class="media wobble-horizontal"><a class="pull-left"><img class="media-object" src="'+BEOPUtil.getProjectImgPath(project)+'" style="width: 48px; height: 48px;"></a></div>');divMedia.attr('id',project.id+"-"+project.name_en+"-"+project.level);divMedia.attr('title',projectName);var divMediaBody=$('<div class="media-body"></div>').append($('<h4 class="media-heading"></h4>').text(projectName));divMedia.append(divMediaBody);return divMedia;};BeopMap.prototype.expandProjectPanel=function(callback){this.$projectDetailCard.slideDown("normal",callback?callback.bind(this):$.noop);};BeopMap.prototype.collapseProjectPanel=function(callback){this.$projectDetailCard.slideUp("normal",callback?callback.bind(this):$.noop);};BeopMap.prototype.addToListControl=function(){var $controlBtn=this.createControlBtn('glyphicon glyphicon-list',i18n_resource.admin.projectSelector.TITLE_PANELSELECTOR);this.addControl($controlBtn,function(){this.paneProjectSelector.show('panel');});};BeopMap.prototype.addToMapControl=function(){var $controlBtn=this.createControlBtn('glyphicon glyphicon-map-marker',i18n_resource.core.beopMap.AMAP,'active');this.addControl($controlBtn,function(){});};BeopMap.prototype.addToVersionHistory=function(){var versionHistory=beop.data.versionHistory,$controlBtn;if(!!!versionHistory||versionHistory=='undefined'){$controlBtn=this.createVersionHistory('');}else{$controlBtn=this.createVersionHistory(versionHistory.version);}
this.addControl($controlBtn);};BeopMap.prototype.createVersionHistory=function(text,isShowVersionInfo){return $('<div class="map-beop-version-history" title="beop版本历史记录"><a href="#page=VersionHistory"> beop version: '+text+' </a></div>');};BeopMap.prototype.addNewVersionInfo=function(){if(configMap.isFirstLoadVersion){configMap.isFirstLoadVersion=false;var versionHistory=beop.data.versionHistory;if(!!versionHistory&&versionHistory!='undefined'&&!!versionHistory.log){beop.data.versionHistory.newest=true;beop.data.versionHistory.readUsers.push(AppConfig.userId);window.localStorage.setItem('versionHistory',JSON.stringify(beop.data.versionHistory));versionInfoBox(versionHistory.version,versionHistory.log);}}};BeopMap.prototype.loadProjectPanel=function(project){if(!project){return false;}
var name=StringUtil.getI18nProjectName(project);this.$projectDetailCard.attr('project-id',project.id).find('.project-img').attr('src',BEOPUtil.getProjectImgPath(project)).attr('alt',name).end().find('.name').text(name);if(!project.address){this.$projectDetailCard.find('.address').hide();}else{this.$projectDetailCard.find('.address').show().find('address').text(project.address);}};BeopMap.prototype.createControlBtn=function(btnClass,btnText,className){var $controlUI;if(className){$controlUI=$('<div class="map-control-btn '+className+'"><span class="'+btnClass+'" aria-hidden="true"></span></div>');}else{$controlUI=$('<div class="map-control-btn"><span class="'+btnClass+'" aria-hidden="true"></span></div>');}
$controlUI.attr("title",btnText);return $controlUI;};BeopMap.prototype.addUpdateProjectControl=function(){var $controlBtn=this.createControlBtn('glyphicon glyphicon-refresh',I18n.resource.admin.projectSelector.PANE_BTN_UPDATE);this.addControl($controlBtn,function(){Spinner.spin(ElScreenContainer);var alert;WebAPI.post("/observer/update_project_by_user",{user_id:AppConfig.userId}).done(function(result){if(result.indexOf('error')!=-1){alert=new Alert(ElScreenContainer,Alert.type.success,I18n.resource.admin.projectSelector.PROJECT_UPDATE_SUCCESS);}else{alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectSelector.PROJECT_UPDATE_FAILED);}
alert.showAtTop(2000);}).error(function(){alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectSelector.PROJECT_UPDATE_FAILED);alert.showAtTop(2000);}).always(function(){Spinner.stop();});});};BeopMap.prototype.addManagePanelControl=function(){var $controlBtn=this.createControlBtn('glyphicon glyphicon-user',I18n.resource.admin.projectSelector.PANE_BTN_MANAGER);this.addControl($controlBtn,function(){ScreenManager.show(UserManagerController,AccountManager);});};BeopMap.prototype.setFitView=function(){};BeopMap.prototype.getNearbyProjects=function(centerProjectId,radius){var centerProjectMarker=this.markers[centerProjectId],centerProjectLnglat=this.getMarkerPosition(centerProjectMarker),nearbyList=[];for(var projectId in this.markers){if(projectId+''===centerProjectId+''){continue;}
var marker=this.markers[projectId],markLnglat=this.getMarkerPosition(marker);if(this.computeDistanceBetween(centerProjectLnglat,markLnglat)<=radius){nearbyList.push(getProject(projectId));}}
return nearbyList;};function GaodeMap(){BeopMap.call(this);this.url=configMap.AmapUrl;this.key=configMap.AmapKey;this.mapName=I18n.resource.core.beopMap.AMAP;}
GaodeMap.prototype.init=function(){BeopMap.prototype.init.call(this);this.map=new AMap.Map(this.container,{view:new AMap.View2D({zoom:this.zoom}),resizeEnable:true});};GaodeMap.prototype.destroy=function(){if(this.map&&this.map.destroy){this.map.destroy();this.workerUpdate.postMessage({type:"clearTimer",name:"requestProjectStatus"});this.map=null;}};GaodeMap.prototype.getLatLng=function(lat,lng){return new AMap.LngLat(lng,lat);};GaodeMap.prototype.isMapLoaded=function(){try{if(AMap&&AMap.Map){return true;}}catch(e){return false;}};GaodeMap.prototype.addControl=function($controlUI,callback){var _this=this;var controlDiv=function controlDiv(){};controlDiv.prototype={addTo:function addTo(map,dom){dom.appendChild(this._getHtmlDom(map));},_getHtmlDom:function _getHtmlDom(map){this.map=map;$controlUI.click(function(){callback.call(_this);});this.container=$controlUI[0];return $controlUI[0];}};this.map.addControl(new controlDiv(this.map));};GaodeMap.prototype.load=function(){if(this.isMapLoaded()){mapLoadCallBack();}else{this.loadScript({v:configMap.AmapVersion,callback:configMap.mapLoadCallBack});}};GaodeMap.prototype.trigger=function(instance,eventName,var_args){AMap.event.trigger(instance,eventName,var_args);};GaodeMap.prototype.openInfoWindow=function(infoWindow,marker){infoWindow.open(this.map,marker.getPosition());};GaodeMap.prototype.addMarker=function(identifier,lnglat,isOnline,opts){if(!this.map||!identifier||!lnglat){return null;}
if(!lnglat){lnglat=configMap.defaultLatlng;}
if(typeof lnglat==='string'){var temp=lnglat.split(',');lnglat={'lat':+temp[0],'lng':+temp[1]};}
var projectStatus=isOnline?configMap.projectStatus.online:configMap.projectStatus.offline;var defaultOpts={map:this.map,position:this.getLatLng(lnglat.lat,lnglat.lng),offset:new AMap.Pixel(-8,-8),content:'<div class="map-marker '+projectStatus+'" data-id="'+identifier+'"></div>',extData:{id:identifier}};if(opts){$.extend(defaultOpts,opts);}
if(this.markers[identifier]){this.map.remove(this.markers[identifier]);}
var marker=new AMap.Marker(defaultOpts);this.markers[identifier]=marker;return marker;};GaodeMap.prototype.removeMarker=function(identifier){if(!identifier){return false;}
var marker=this.markers[identifier];if(!marker){return false;}
marker.setMap(null);return true;};GaodeMap.prototype.addInfoWindow=function(id,content){var infoWindow=new AMap.InfoWindow({offset:new AMap.Pixel(0,0),content:content});this.infoWindows[id]=infoWindow;return infoWindow;};GaodeMap.prototype.addMarkerClick=function(marker,eventFunc){var _this=this;AMap.event.addListener(marker,'click',function(){eventFunc.call(_this);});};GaodeMap.prototype.setFitView=function(){this.map.setFitView();};GaodeMap.prototype.computeDistanceBetween=function(from,to){if(!from||!to){return;}
return from.distance(to);};GaodeMap.prototype.getMarkerPosition=function(marker){if(!marker){return;}
return marker.getPosition();};GaodeMap.prototype.closeAllInfoWindow=function(){this.map.clearInfoWindow();};inherits(GaodeMap,BeopMap);function GoogleMap(){BeopMap.call(this);this.url=configMap.GmapUrl;this.key=configMap.GmapKey;this.zoom=4;this.mapName='google'+I18n.resource.core.beopMap.MAP;}
GoogleMap.prototype.init=function(){BeopMap.prototype.init.call(this);this.map=new google.maps.Map($('#'+this.container)[0],{zoom:this.zoom,disableDefaultUI:true});GMarker=function GMarker(latlng,map,args){this.latlng=latlng;this.args=args;this.setMap(map);};GMarker.prototype=new google.maps.OverlayView();GMarker.prototype.draw=function(){var self=this;var div=this.div;if(!div){div=this.div=document.createElement('div');div.className='map-marker '+(self.args.isOnline?'Online':'Offline');div.style.position='absolute';if(typeof self.args.id!=='undefined'){div.dataset.id=self.args.id;}
google.maps.event.addDomListener(div,"click",function(event){google.maps.event.trigger(self,"click");});var panes=this.getPanes();panes.overlayImage.appendChild(div);}
var point=this.getProjection().fromLatLngToDivPixel(this.latlng);if(point){div.style.left=point.x-8+'px';div.style.top=point.y-8+'px';}};GMarker.prototype.onRemove=function(){if(this.div){this.div.parentNode.removeChild(this.div);this.div=null;}};GMarker.prototype.getPosition=function(){return this.latlng;};GMarker.prototype.getExtData=function(){return this.args;};GMarker.prototype.show=function(){this.div.style.display='';};GMarker.prototype.hide=function(){this.div.style.display='none';};};GoogleMap.prototype.destroy=function(){if(this.map&&this.map.destroy){this.workerUpdate.postMessage({type:"clearTimer",name:"requestProjectStatus"});this.map.destroy();this.map=null;}};GoogleMap.prototype.isMapLoaded=function(){try{if(google&&google.maps){return true;}}catch(e){return false;}};GoogleMap.prototype.load=function(){if(this.isMapLoaded()){mapLoadCallBack();}else{this.loadScript({callback:configMap.mapLoadCallBack,sensor:false,libraries:'geometry,places',language:'en'});}};GoogleMap.prototype.getLatLng=function(lat,lng){return new google.maps.LatLng(lat,lng);};GoogleMap.prototype.openInfoWindow=function(infoWindow,marker){infoWindow.open(this.map,marker);};GoogleMap.prototype.addMarker=function(identifier,lnglat,isOnline,opts){if(!identifier||!lnglat){return null;}
if(typeof lnglat==='string'){var temp=lnglat.split(',');lnglat={'lat':+temp[0],'lng':+temp[1]};}
if(opts){$.extend(defaultOpts,opts);}
var marker=new GMarker(this.getLatLng(lnglat.lat,lnglat.lng),this.map,{id:identifier,isOnline:isOnline});this.markers[identifier]=marker;return marker;};GoogleMap.prototype.addInfoWindow=function(id,content){var infoWindow=new google.maps.InfoWindow({content:content,pixelOffset:new google.maps.Size(0,0)});this.infoWindows[id]=infoWindow;return infoWindow;};GoogleMap.prototype.addControl=function($controlUI,callback){var _this=this,controlUIDom=$controlUI[0];this.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlUIDom);google.maps.event.addDomListener(controlUIDom,'click',function(){callback.call(_this);});};GoogleMap.prototype.closeAllInfoWindow=function(){for(var m=0,len=this.infoWindows.length;m<len;m++){this.infoWindows[m].close();}};GoogleMap.prototype.addMarkerClick=function(marker,eventFunc){var _this=this;google.maps.event.addListener(marker,'click',function(){_this.closeAllInfoWindow();eventFunc.call(_this);});};GoogleMap.prototype.setFitView=function(){var bounds=new google.maps.LatLngBounds();for(var project in this.markers){bounds.extend(this.markers[project].getPosition());}
this.map.fitBounds(bounds);};GoogleMap.prototype.computeDistanceBetween=function(from,to){if(!from||!to){return;}
return google.maps.geometry.spherical.computeDistanceBetween(from,to);};GoogleMap.prototype.getMarkerPosition=function(marker){if(!marker){return;}
return marker.getPosition();};GoogleMap.prototype.trigger=function(instance,eventName,var_args){google.maps.event.trigger(instance,eventName,var_args);};inherits(GoogleMap,BeopMap);var GMarker=null;beop.getMapInstance=function(){var isGoogleAvailable=localStorage.getItem('isGoogleAvailable');if((typeof isGoogleAvailable==='undefined'?'undefined':_typeof(isGoogleAvailable))!==(typeof undefined==='undefined'?'undefined':_typeof(undefined))&&isGoogleAvailable!=='error'){return isGoogleAvailable==='true'?new GoogleMap():new GaodeMap();}
if(I18n.type==='zh'){return new GaodeMap();}else{return new GoogleMap();}};beop.GaodeMap=GaodeMap;beop.GoogleMap=GoogleMap;})(beop||(beop={}));var isMapAsyncLoadSuccess=undefined;function mapLoadCallBack(){try{var mapIns=beop.getMapInstance();mapIns.init();mapIns.addToListControl();if(AppConfig.userId==1){mapIns.addUpdateProjectControl();}
mapIns.addToMapControl();if(window.localStorage.getItem('language')=='zh'){mapIns.addToVersionHistory(beop.data.versionHistory.readUsers);}
mapIns.addMarkers(AppConfig.projectList,true);mapIns.initWorkerForUpdating();mapIns.setFitView();isMapAsyncLoadSuccess=true;mapIns.customCtrls=mapIns.customCtrls||{};mapIns.customCtrls.dataRange=new window.map.controls.DataRange(mapIns,document.getElementById(mapIns.container));ScreenCurrent=mapIns;}catch(e){console.error(e);}}
var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var beop=window.beop||{};beop.baseMap=beop.baseMap||{};(function(window,$,nsBaseMap){var CONSTS={AMap:{name:'高德地图',url:location.protocol+'//webapi.amap.com/maps',params:{key:'9cc89c68a4bd6f3f5f65589f85ad7685',v:'1.3'}},GLoader:{name:'Google Loader',url:'https://www.google.com/jsapi'},GMap:{name:'Google Map',url:'http://maps.googleapis.com/maps/api/js',params:{key:'AIzaSyAzzOzAmrGov5GLacve9w8_Q8dS-xBYCgc',libraries:'geometry,places'}}};var defaults={mapContainer:'mapContainer',defaultLng:'121.6283679',defaultLat:'31.2114943',markerImgPath:'/static/images/map_marker_online.png'};var util={inherits:function inherits(clazz,base){var clazzPrototype=clazz.prototype;var F=function F(){};F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;},loadJS:function loadJS(url,callback){var done=false;var script=document.createElement('script');script.type='text/javascript';script.language='javascript';script.src=url;script.onload=script.onreadystatechange=function(){if(!done&&(!script.readyState||script.readyState=='loaded'||script.readyState=='complete')){done=true;script.onload=script.onreadystatechange=null;typeof callback==='function'&&callback.call(script);}};document.getElementsByTagName("head")[0].appendChild(script);},runJS:function runJS(url,callback){this.loadJS(url,function(){document.getElementsByTagName('head')[0].removeChild(this);typeof callback==='function'&&callback();});}};function PaneMapSearch(map,iptSch,paneSchRes){this.map=map;this.$iptSch=$(iptSch);this.$paneSchRes=$(paneSchRes);this.$liSets=[];this.rs=null;this.rsCount=0;this.showLimits=5;this.curSelect=-1;this.isPaneShow=false;this.bindEvents();this.$iptSch.parent('div').show();}
PaneMapSearch.prototype.bindEvents=function(){var _this=this;this.$iptSch.keyup(function(e){var kc=e.keyCode;switch(kc){case 38:_this.prev();e.preventDefault();break;case 40:_this.next();e.preventDefault();break;case 13:_this.doSearch();break;default:_this.autoComplete();break;}});this.$paneSchRes.on('click','a',function(e){var $this=$(this);var index=$this.attr('data-sort')||0;_this.to(index);_this.doSearch();e.preventDefault();});};PaneMapSearch.prototype.showPane=function(){this.$paneSchRes.show();this.isPaneShow=true;};PaneMapSearch.prototype.hidePane=function(){this.$paneSchRes.hide();this.isPaneShow=false;};PaneMapSearch.prototype.prev=function(){this.to(this.curSelect-1);};PaneMapSearch.prototype.next=function(){this.to(this.curSelect+1);};PaneMapSearch.prototype.to=function(index){if(!this.isPaneShow){this.showPane();return;}
index=Math.min(Math.max(0,index),this.rsCount-1);if(index===this.curSelect)return;this.curSelect=index;this.$liSets.removeClass('on');this.$liSets.eq(index).addClass('on');this.$iptSch.val(this.rs[index].name);};PaneMapSearch.prototype.doSearch=function(){var _this=this;var keywords=this.$iptSch.val().trim();var options;if(keywords==='')return;_this.hidePane();if(this.curSelect>-1){options={pageSize:1,city:this.rs[this.curSelect].adcode};}
this.map.placeSearch(keywords,options,function(rs){if(rs.status!==0)return;rs=rs.data;if(_this.curSelect<0){_this.map.setCenter(rs[0].lng,rs[0].lat);_this.map.setZoom(15);}else{_this.map.trigger('click',{lnglat:rs[0]});}});};PaneMapSearch.prototype.autoComplete=function(){var _this=this;var keywords=this.$iptSch.val().trim();keywords=keywords.replace(/[\\\?\.\+\^\$]/g,'');if(keywords==='')return;this.map.search(keywords,function(rs){if(rs.status!==0)return;rs=rs.data;var arrHtml=[];_this.rsCount=Math.min(rs.length,_this.showLimits);_this.rs=rs;_this.curSelect=-1;if(_this.rsCount<=0){_this.hidePane();return;}
for(var i=0;i<_this.rsCount;i++){arrHtml.push('<li><a data-sort="'+i+'" href="javascript:;"><span class="rs-name">'+rs[i].name.replace(new RegExp(keywords.replace(/([\(\)])/g,'\\$1')),'<span class="keywords">'+keywords+'</span>')+'</span><span class="rs-district">'+rs[i].district+'</span</a></li>');};_this.$paneSchRes.html(arrHtml.join(''));_this.showPane();_this.$liSets=_this.$paneSchRes.children('li');});};PaneMapSearch.prototype.destroy=function(){this.$iptSch.unbind();this.$paneSchRes.off();};var BaseMap=function BaseMap(options){this.options=$.extend({},defaults,options);this.markers=[];};BaseMap.load=function(type,callback){var _this=this;var url=CONSTS[type].url;var params=CONSTS[type].params;var p=[];for(var i in params){if(params.hasOwnProperty(i)){p.push(i+'='+params[i]);}}
if(p.length)url=url+'?';util.runJS(url+p.join('&'),function(){window.console&&console.log('load JS: '+url+' success!');(typeof callback==='undefined'?'undefined':_typeof(callback))&&callback.call(_this);});};var GDMap=function GDMap(options){BaseMap.call(this,options);this.markers=[];this.controls=[];this.zoom=15;this.init();};GDMap.load=function(options,callback){if(typeof options==='function'){callback=options;options=null;}
if(!GDMap.isLoaded()){BaseMap.load('AMap',function(){callback(new GDMap(options));});}else{callback(new GDMap(options));}};GDMap.isLoaded=function(){return window.AMap&&window.AMap.Map;};GDMap.prototype.init=function(){this.map=new AMap.Map(this.options.mapContainer,{resizeEnable:true,view:new AMap.View2D({zoom:this.zoom})});};GDMap.prototype.setCenter=function(lng,lat){return this.map.setCenter(this.getPoint(lng,lat));};GDMap.prototype.setZoom=function(level){return this.map.setZoom(level);};GDMap.prototype.getPoint=function(lng,lat){return new AMap.LngLat(lng,lat);};GDMap.prototype.addMarker=function(lng,lat){var marker;lng=lng||this.options.defaultLng;lat=lat||this.options.defaultLat;marker=new AMap.Marker({map:this.map,icon:this.options.markerImgPath,position:this.getPoint(lng,lat)});marker&&this.markers.push(marker);return marker;};GDMap.prototype.removeMarker=function(marker){var removed;for(var i=this.markers.length-1;i>=0;i--){if(this.markers[i]===marker){removed=this.markers.splice(i,1);removed.setMap(null);}};};GDMap.prototype.removeAllMarkers=function(){for(var i=this.markers.length-1;i>=0;i--){this.markers[i].setMap(null);}
this.markers.length=0;};GDMap.prototype.addListener=function(eventName,handler){AMap.event.addListener(this.map,eventName,handler);};GDMap.prototype.trigger=function(eventName,args){AMap.event.trigger(this.map,eventName,args);};GDMap.prototype.getAddress=function(lng,lat,callback){var _this=this;var geocoder;var format=[],statusCode=-1;AMap.service(["AMap.Geocoder"],function(){var geocoder=new AMap.Geocoder();geocoder.getAddress(_this.getPoint(lng,lat),function(status,rs){var geoinfo=rs.regeocode;if(status==='complete'&&rs.info==='OK'){format.push({name:geoinfo.formattedAddress,components:{city:geoinfo.addressComponent.city,province:geoinfo.addressComponent.province}});statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.getLocation=function(addr,callback){var _this=this;var format=[],statusCode=-1;AMap.service(["AMap.Geocoder"],function(){var geocoder=new AMap.Geocoder();geocoder.getLocation(addr,function(status,rs){var point;if(status==='complete'&&rs.info==='OK'){for(var i=0,len=rs.geocodes.length;i<len;i+=1){point=rs.geocodes[i].location;format.push({lng:point.lng,lat:point.lat});}
statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.search=function(keywords,callback){var format=[],statusCode=-1;AMap.service(['AMap.Autocomplete'],function(){var auto=new AMap.Autocomplete();if(keywords.length>0){auto.search(keywords,function(status,result){if(status==='complete'&&result.info==='OK'){for(var i=0,len=result.tips.length;i<len;i++){format.push({name:result.tips[i].name,district:result.tips[i].district,adcode:result.tips[i].adcode});};statusCode=0;typeof callback==='function'&&callback({status:statusCode,data:format});}});}});};GDMap.prototype.placeSearch=function(keywords,options,callback){var pSearch;if(typeof options==='function'){callback=options;options=null;}
AMap.service(['AMap.PlaceSearch'],function(){pSearch=new AMap.PlaceSearch(options);pSearch.search(keywords,function(status,rs){var format=[],statusCode=-1;var row;if(status==='complete'&&rs.info==='OK'){for(var i=0,len=rs.poiList.pois.length;i<len;i++){row=rs.poiList.pois[i];format.push({lng:row.location.getLng(),lat:row.location.getLat(),address:row.address});}
statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.setFitView=function(){this.map.setFitView();};GDMap.prototype.addSearchBox=function(iptSch,mapSchPane){this.controls.push(new PaneMapSearch(this,iptSch,mapSchPane));};GDMap.prototype.destroy=function(){for(var i=this.controls.length-1;i>=0;i--){if(typeof this.controls[i].destroy!=='function'){console.warn('one map UI control not destroy!');continue;}
this.controls[i].destroy();};this.map.destroy();};var GoogleMap=function GoogleMap(options){BaseMap.call(this,options);this.markers=[];this.controls=[];this.zoom=16;this.init();};GoogleMap.load=function(options,_callback){if(typeof options==='function'){_callback=options;options=null;}
if(!GoogleMap.isLoaded()){BaseMap.load('GLoader',function(){var params=CONSTS['GMap'].params;var p=[];for(var i in params){if(params.hasOwnProperty(i)){p.push(i+'='+params[i]);}}
google.load('maps',3,{other_params:p.join('&'),callback:function callback(){_callback(new GoogleMap(options));}});});}else{_callback(new GoogleMap(options));}};GoogleMap.isLoaded=function(){return window.google&&window.google.maps;};GoogleMap.prototype.init=function(){this.map=new google.maps.Map($('#'+this.options.mapContainer)[0],{zoom:this.zoom,disableDefaultUI:true,center:this.getPoint(this.options.defaultLng,this.options.defaultLat)});};GoogleMap.prototype.setCenter=function(lng,lat){return this.map.setCenter(this.getPoint(lng,lat));};GoogleMap.prototype.setZoom=function(level){return this.map.setZoom(level);};GoogleMap.prototype.getPoint=function(lng,lat){return new google.maps.LatLng(lat,lng);};GoogleMap.prototype.addMarker=function(lng,lat){var marker;lng=lng||this.options.defaultLng;lat=lat||this.options.defaultLat;marker=new google.maps.Marker({map:this.map,icon:this.options.markerImgPath,position:this.getPoint(lng,lat)});marker&&this.markers.push(marker);return marker;};GoogleMap.prototype.removeMarker=function(marker){var removed;for(var i=this.markers.length-1;i>=0;i--){if(this.markers[i]===marker){removed=this.markers.splice(i,1);removed.setMap(null);}};};GoogleMap.prototype.removeAllMarkers=function(){for(var i=this.markers.length-1;i>=0;i--){this.markers[i].setMap(null);}
this.markers.length=0;};GoogleMap.prototype.addListener=function(eventName,handler){var _this=this;return google.maps.event.addListener(this.map,eventName,function(e){_this.formatEventResult(e);handler.call(this,e);});};GoogleMap.prototype.removeAllListener=function(){google.maps.event.clearInstanceListeners(this.map);};GoogleMap.prototype.trigger=function(eventName,args){return google.maps.event.trigger(this.map,eventName,args);};GoogleMap.prototype.formatEventResult=function(rs){rs.lnglat={lng:rs.latLng.lng(),lat:rs.latLng.lat()};};GoogleMap.prototype.getAddress=function(lng,lat,callback){var _this=this;var geocoder=new google.maps.Geocoder();var format=[],statusCode=-1;geocoder.geocode({latLng:this.getPoint(lng,lat)},function(rs,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0,len=rs.length;i<len;i++){format.push({name:rs[0].formatted_address,components:_this._formatAddressComponents(rs[i].address_components)});};statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});};GoogleMap.prototype.getLocation=function(addr,callback){var geocoder=new google.maps.Geocoder();var format=[],statusCode=-1;geocoder.geocode({address:addr},function(rs,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0,len=rs.length;i<len;i++){format.push({name:rs[i].formatted_address,lng:rs[i].geometry.location.lng(),lat:rs[i].geometry.location.lat()});};statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});};GoogleMap.prototype.search=function(keywords,callback){};GoogleMap.prototype.setFitView=function(){if(this.markers.length<=0)return;this.map.panTo(this.markers[0].getPosition());};GoogleMap.prototype.addSearchBox=function(iptSch){var _this=this;var input=document.getElementById('btnGoogleSch');var searchBox;this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);searchBox=new google.maps.places.SearchBox(input);google.maps.event.addListener(searchBox,'places_changed',function(){var places=searchBox.getPlaces();if(places.length<=0)return;_this.trigger('click',{latLng:places[0].geometry.location});});input.style.display='';};GoogleMap.prototype.destroy=function(){for(var i=this.controls.length-1;i>=0;i--){if(typeof this.controls[i].destroy!=='function'){console.warn('one map UI control does not destroy!');continue;}
this.controls[i].destroy();};this.removeAllMarkers();this.removeAllListener();};GoogleMap.prototype._formatAddressComponents=function(addressComponents,type){var format={};for(var i=addressComponents.length-1;i>=0;i--){switch(addressComponents[i].types[0]){case'administrative_area_level_1':format.province=addressComponents[i].long_name;break;case'locality':format.city=addressComponents[i].long_name;break;}}
return format;};nsBaseMap.load=function(callback){var isGoogleAvailable=localStorage.getItem('isGoogleAvailable');if((typeof isGoogleAvailable==='undefined'?'undefined':_typeof(isGoogleAvailable))!==(typeof undefined==='undefined'?'undefined':_typeof(undefined))&&isGoogleAvailable!=='error'){return isGoogleAvailable==='true'?new GoogleMap():new GaodeMap();}
if(I18n.type==='zh'){return new GaodeMap();}else{return new GoogleMap();}};nsBaseMap.loadAccurateMap=function(type,callback){if(type==='AMap'){GDMap.load(callback);}else if(type==='GMap'){GoogleMap.load(callback);}else{throw new SyntaxError('Map type is illegal !');}};})(window,jQuery,beop.baseMap,undefined);window.map=window.map||{};window.map.controls=window.map.controls||{};window.map.controls.DataRange=function(window,$,undefined){'use strict';var utils={color:{getColorValue:function getColorValue(arr){if($.type(arr)!=='array'){arr=[arr];}
return arr.map(function(row,i){var matches=null;matches=row.match(/^#(\w{2})(\w{2})(\w{2})$/);return[parseInt(matches[1],16),parseInt(matches[2],16),parseInt(matches[3],16)];});}}};function DataRange(mapIns,container){this.mapIns=mapIns;this.$container=$(container);this.options=$.extend({},DEFAULTS);this.colorsRange=null;this.visibleRangeValue={};this.data=null;this.$markers=null;this.init();}
DataRange.prototype={constructor:DataRange,init:function init(){this.initColors();this.buildUI();this.attachEvents();},show:function show(){this.$divWrap.show();},initColors:function initColors(){var colors=utils.color.getColorValue(this.options.colors);var optMin=this.options.range.min;var optMax=this.options.range.max;var range=optMax-optMin;var step=1/(colors.length-1);var row,prev;this.colorsRange=[];for(var i=1,len=colors.length;i<len;i++){row=colors[i];prev=colors[i-1];this.colorsRange.push({from:optMin+range*step*(i-1),to:i===len-1?optMax:range*step*i,colorFrom:prev,colorTo:row});}},initMarkers:function initMarkers(data){var newData={},t;var _this=this;var $markers=this.$markers;var projectId,value,row;if(!$markers)$markers=this.$markers=$('.map-marker',this.$container);data.forEach(function(row,i){newData[row.projectId]=row.value;});this.data=newData;[].forEach.call($markers,function(row,i){var $this=$(row),color;projectId=$this.attr('data-id');value=_this.data[projectId];if(value===-1||value===undefined){_this.mapIns.markers[projectId].hide();}else{color=_this.getColorByValue(value);$this.css({'background-color':color});_this.mapIns.markers[projectId].show();}});this.setVisibleMarkers();},buildUI:function buildUI(){var halfHeight;var options=this.options;this.$divWrap=$('<div class="barDataZoom">').css({'width':options.width,'height':options.height,'position':'absolute','bottom':50,'left':40,'background-image':'linear-gradient(to top, '+this.options.colors.join(',')+')','border-radius':'2px','z-index':1,'display':'none','box-shadow':'0 2px 6px rgba(0,0,0,0.4)'});this.$divRangeCoverUp=$('<div>').css({'position':'absolute','left':0,'top':0,'right':0,'background-color':'#ccc'});this.$divRangeCoverDown=$('<div>').css({'position':'absolute','left':0,'bottom':0,'right':0,'background-color':'#ccc'});this.$divRange=$('<div>').css({'position':'absolute','left':0,'top':0,'bottom':0,'right':0,'background-color':'transparent','font-family':'Microsoft YaHei','font-weight':'bold','cursor':'move'});halfHeight=options.arrowSize/2;this.$arrowUp=$('<span>').css({'position':'absolute','left':options.width,'top':-halfHeight,'width':options.arrowSize,'height':options.arrowSize,'border-top-width':halfHeight,'border-left-width':0,'border-bottom-width':halfHeight,'border-right-width':options.arrowSize,'border-color':'transparent #555 transparent transparent','border-style':'solid'});this.$arrowDown=$('<span>').css({'position':'absolute','left':options.width,'bottom':-halfHeight,'width':options.arrowSize,'height':options.arrowSize,'border-top-width':halfHeight,'border-left-width':0,'border-bottom-width':halfHeight,'border-right-width':options.arrowSize,'border-color':'transparent #555 transparent transparent','border-style':'solid'});this.$labelUp=$('<span>High</span>').css({'height':25,'line-height':'25px','position':'absolute','left':0,'right':0,'top':-25,'font-weight':'bold'});this.$labelDown=$('<span>Low</span>').css({'height':25,'line-height':'25px','position':'absolute','left':0,'right':0,'bottom':-25,'font-weight':'bold'});this.$arrowLabelUp=$('<span>').css({'position':'absolute','left':this.options.arrowSize+4,'top':-this.options.arrowSize/2,'line-height':this.options.arrowSize+'px'});this.$arrowLableDown=$('<span>').css({'position':'absolute','left':this.options.arrowSize+4,'top':-this.options.arrowSize/2,'line-height':this.options.arrowSize+'px'});this.$arrowUp.append(this.$arrowLabelUp);this.$arrowDown.append(this.$arrowLableDown);this.$divRange.append(this.$arrowUp).append(this.$arrowDown);this.$divWrap.append(this.$divRangeCoverUp).append(this.$divRangeCoverDown).append(this.$divRange);this.$container.append(this.$divWrap);},changeColors:function changeColors(top,bottom){var height=_this.options.height;var ratioTop=top/height;var ratioBottom=bottom/height;var colors=this.colors;},getColorByValue:function getColorByValue(value){var percent,color=[];for(var i=0,row,len=this.colorsRange.length;i<len;i++){row=this.colorsRange[i];if(value<=row.to){percent=(value-row.from)/(row.to-row.from);color.push((row.colorFrom[0]+(row.colorTo[0]-row.colorFrom[0])*percent)/255*100+'%');color.push((row.colorFrom[1]+(row.colorTo[1]-row.colorFrom[1])*percent)/255*100+'%');color.push((row.colorFrom[2]+(row.colorTo[2]-row.colorFrom[2])*percent)/255*100+'%');break;}}
return'rgb('+color.join(',')+')';},setVisibleMarkers:function setVisibleMarkers(topValue,bottomValue){var _this=this;var $markers=this.$markers;var projectId,value,row;if(!this.data)return;topValue=[null,undefined].indexOf(topValue)>-1?this.options.range.max:topValue;bottomValue=[null,undefined].indexOf(bottomValue)>-1?this.options.range.min:bottomValue;[].forEach.call($markers,function(row,i){var $this=$(row);projectId=$this.attr('data-id');value=_this.data[projectId];if(value===-1||value===undefined||value>topValue||value<bottomValue){_this.mapIns.markers[projectId].hide();}else{_this.mapIns.markers[projectId].show();}});},setVisibleRange:function setVisibleRange(top,bottom){var optMin=this.options.range.min===undefined?DEFAULTS.range.min:this.options.range.min;var optMax=this.options.range.max===undefined?DEFAULTS.range.max:this.options.range.max;var range=optMax-optMin;var topRatio,topValue;var bottomRatio,bottomValue;if(top!==undefined&&top!==null){topRatio=1-(top-0)/this.options.height;topValue=Math.round((optMin+topRatio*range)*100)/100;this.$arrowLabelUp.text(topValue);this.$divRange.css('top',top);this.$divRangeCoverUp.css('bottom',this.options.height-top);this.visibleRangeValue.top=topValue;}
if(bottom!==undefined&&bottom!==null){bottomRatio=1-(bottom-0)/this.options.height;bottomValue=Math.round((optMin+bottomRatio*range)*100)/100;this.$arrowLableDown.text(bottomValue);this.$divRange.css('bottom',this.options.height-bottom);this.$divRangeCoverDown.css('top',bottom);this.visibleRangeValue.bottom=bottomValue;}
this.setVisibleMarkers(this.visibleRangeValue.top,this.visibleRangeValue.bottom);typeof this.options.onRangeChange==='function'&&this.options.onRangeChange();},attachEvents:function attachEvents(){var _this=this;var minHeight=20;this.$arrowUp.on('mousedown',function(e){var position=_this.$divRange.position();var delta=position.top-e.pageY;var mDownBottom=_this.$divRange.height()+position.top;_this.$container.on('mousemove',function(e){var top=delta+e.pageY;top=Math.max(0,Math.min(top,mDownBottom-minHeight));_this.setVisibleRange(top);e.stopPropagation();});e.stopPropagation();});_this.$container.on('mouseup mouseleave',function(e){$(this).off('mousemove');e.preventDefault();});this.$arrowDown.on('mousedown',function(e){var position=_this.$divRange.position();var mDownTop=position.top;var delta=_this.$divRange.height()+position.top-e.pageY;_this.$container.on('mousemove',function(e){var bottom=delta+e.pageY;bottom=Math.max(mDownTop+minHeight,Math.min(_this.options.height,bottom));_this.setVisibleRange(null,bottom);e.stopPropagation();});e.stopPropagation();});_this.$divRange.on('mousedown',function(e){var position=_this.$divRange.position();var deltaTop=position.top-e.pageY;var height=_this.$divRange.height();var deltaBottom=height+position.top-e.pageY;_this.$container.on('mousemove',function(e){var top=deltaTop+e.pageY;var bottom=deltaBottom+e.pageY;if(top<0){top=0;bottom=height;}
if(bottom>_this.options.height){top=_this.options.height-height;bottom=_this.options.height;};_this.setVisibleRange(top,bottom);e.stopPropagation();});e.stopPropagation();});},setOptions:function setOptions(options){var originColors=this.options.colors||[];this.options=$.extend({},this.options,options);if(this.options.colors&&originColors.join('')!==this.options.colors.join('')){this.$divWrap.css({'background-image':'linear-gradient(to top, '+this.options.colors.join(',')+')'});}
this.initColors();this.setVisibleRange(0,this.options.height);}};var DEFAULTS={width:20,height:180,arrowSize:12,colors:['#87E034','#EDE24C','#F53F52'],range:{min:0,max:100}};return DataRange;}(window,jQuery);var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var EventAdapter=function(){var eventData,eventStatus;function EventAdapter($){}
EventAdapter.on=function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<3||arguments.length>5){console.log('EventAdapter.on arguments.length error');return;}
if(_typeof(arguments[0])!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}}
if(typeof arguments[1]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[1];}
if(typeof arguments[2]=='function'){eventFunction=arguments[2];eventSelector=null;eventHmt=arguments[3];}else if(typeof arguments[2]=='string'){if(arguments[3]&&typeof arguments[3]=='function'){eventSelector=arguments[2];eventFunction=arguments[3];eventHmt=arguments[4];}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function finalFunction(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction);}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':eventTarget.on('touchstart',eventSelector,function(e){mobileDragStart.call(this,e,eventTarget,finalFunction);});break;case'dragover':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragOver.call(this,e,eventTarget,finalFunction);});break;case'dragleave':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragLeave.call(this,e,eventTarget,finalFunction);});break;case'drop':$(document).on('touchend.drop',eventSelector,function(e){mobileDrop.call(this,e,eventTarget,finalFunction);});break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;};EventAdapter.off=function(){if(arguments.length>3||arguments.length<1||arguments[0]&&typeof arguments[1]!='string'){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}
if(arguments.length==1){eventTarget.off();return eventTarget;}
if(typeof arguments[1]=='string'){eventType=arguments[1];}else{console.log('EventAdapter.off eventType Error');return;}
if(typeof arguments[2]=='string'){eventSelector=arguments[2];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector);}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;};$.fn.extend({'eventOn':function eventOn(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<2||arguments.length>4){console.log('EventAdapter.on arguments.length error');return;}
if(_typeof(this)!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(this instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=this;}}
if(typeof arguments[0]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[0];}
if(typeof arguments[1]=='function'){eventFunction=arguments[1];eventSelector=null;eventHmt=arguments[2];}else if(typeof arguments[1]=='string'){if(arguments[2]&&typeof arguments[2]=='function'){eventSelector=arguments[1];eventFunction=arguments[2];eventHmt=arguments[3];}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function finalFunction(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction);}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':mobileDragStart(eventTarget,eventSelector,finalFunction);break;case'dragover':mobileDragOver(eventTarget,eventSelector,finalFunction);break;case'dragleave':mobileDragLeave(eventTarget,eventSelector,finalFunction);break;case'drop':mobileDrop(eventTarget,eventSelector,finalFunction);break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;},'eventOff':function eventOff(){if(arguments.length>2||arguments[0]&&typeof arguments[0]!='string'){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(this instanceof jQuery)){eventTarget=jQuery(this);}else{eventTarget=this;}
if(arguments.length==0){eventTarget.off();return eventTarget;}
if(typeof arguments[0]=='string'){eventType=arguments[0];}else{console.log('EventAdapter.off eventType Error');return;}
if(typeof arguments[1]=='string'){eventSelector=arguments[1];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector);}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector,mobileDragStart);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;}});EventAdapter.setData=function(date){if(date==undefined)return;eventData=date;};EventAdapter.getData=function(){return eventData;};document.addEventListener('drop',function(){eventData=null;},false);document.addEventListener('touchend',function(){eventData=null;},false);EventAdapter.clearEvent=function(){$(document).off('touchmove.copy');$(document).off('touchmove.drag');$(document).off('touchend.drop');};EventAdapter.analyse=function(e,eventType,hmtInfo){var mainInfo='',initArrTag,finalArrTag,tag,unitTag;var target=$(e.currentTarget);if(hmtInfo instanceof Array&&hmtInfo[0]){mainInfo=judgeWay(hmtInfo[0]);initArrTag=hmtInfo.filter(function(ele,index){return index>0&&ele!='';});finalArrTag=[];for(var i=0;i<initArrTag.length;i++){unitTag=judgeWay(initArrTag[i]);if(unitTag=='')continue;finalArrTag.push(unitTag);}
tag=finalArrTag.join('-');}else{if(typeof hmtInfo=='string'){mainInfo=hmtInfo;}else{mainInfo=getInfo(target);}
mainInfo=mainInfo?mainInfo:'';tag=mainInfo;}
_hmt.push(['_trackEvent',mainInfo.substr(0,30),eventType,tag.substr(0,100)]);function getInfo(tar){if(tar.length==0)return;var tarInfo;if(tar.attr('id')){tarInfo=tar.attr('id');}else if(tar.attr('i18n')){tarInfo=tar.attr('i18n');}else if(tar.attr('title')){tarInfo=tar.attr('title');}else{tarInfo=tar[0].innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30);}
return tarInfo;}
function judgeWay(arg){if(typeof arg=='undefined'){return'';}
if(arg instanceof Function){return arg.call(this,e);}else if(typeof arg=='string'){if(arg=='text'){return e.currentTarget.innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30);}else{return $(e.currentTarget).attr(arg)?$(e.currentTarget).attr(arg):arg;}}else if(typeof arg=='number'){return arg;}}};var mobileDragStart=function mobileDragStart(e,target,eventFunction){var originalTarget=$(e.target).closest('[draggable="true"]')[0];var ev=e.type=='touchstart'?e.originalEvent.touches[0]:e,startPos={left:$(originalTarget).css('left'),top:$(originalTarget).css('top'),zIndex:$(originalTarget).css('z-index')},disX=originalTarget.offsetWidth/2,disY=originalTarget.offsetHeight/2;var $copyTarget=$(originalTarget).clone();$copyTarget.data('startPos',startPos);$copyTarget.css('z-index',10000);$copyTarget.css('position','absolute');$copyTarget.css('opacity','0.5');$copyTarget.css('pointer-events','none');var $container=$('body');$container.append($copyTarget);var sPos=$(originalTarget)[0].getBoundingClientRect();$copyTarget.css('left',sPos.left-$container[0].offsetLeft+'px');$copyTarget.css('top',sPos.top-$container[0].offsetTop+'px');$copyTarget[0].cssText=originalTarget.cssText;$copyTarget.css('width',originalTarget.offsetWidth);$copyTarget.css('height',originalTarget.offsetHeight);eventStatus='dragStart';eventFunction.call(this,ev);$(document).off('touchend.copy').on('touchend.copy',function(e){$copyTarget.remove();eventStatus='dragEnd';});$(document).on('touchmove.copy',function(e){eventStatus='dragMove';var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var $parent=$copyTarget.offsetParent();$parent=$parent.is(':root')?$(window):$parent;var targetLeft=ev.pageX-disX;var targetTop=ev.pageY-disY;$copyTarget.css({left:targetLeft+'px',top:targetTop+'px','z-index':10000});});};var mobileDragOver=function mobileDragOver(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn'&&eventStatus!='dragMoveOut')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX&&target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveIn';eventFunction.call(this,e);break;}}};var mobileDragLeave=function mobileDragLeave(e,target,eventFunction){if(eventStatus!='dragMoveIn')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(!(target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX&&target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveOut';eventFunction.call(this,e);}}};var mobileDragEnd=function mobileDragEnd(e,target,eventFunction){eventFunction.call(this,e);};var mobileDrop=function mobileDrop(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn')return;var ev=e.type=='touchend'?e.originalEvent.changedTouches[0]:e;var eventTarget=target;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX&&target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY){e.target=target[i];e.currentTarget=target[i];eventFunction.call(this,e);break;}}};return EventAdapter;}(jQuery);var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var ScreenManager=function(){function ScreenManager(){}
ScreenManager.screenFlag='page';ScreenManager.root='#page=IndexScreen';ScreenManager.paneRoot="#page=PaneProjectSelector";ScreenManager.isListening=false;ScreenManager.setProjectSelector=function(ProjectSelector){if(typeof ProjectSelector==='function'){ScreenManager.projectSelector=new ProjectSelector();}};ScreenManager.Init=function(){I18n.fillArea($(".navbar"));};ScreenManager.show=function(){if(arguments.length===0){return;}
var screenClass=arguments[0];if(typeof screenClass!=='function'){return;}
if(ScreenManager.isListening){ScreenManager.applyGoTo.apply(null,arguments);}else{ScreenManager.applyScreen.apply(null,arguments);}};ScreenManager.applyGoTo=function(){var screenClass=arguments[0];if(!screenClass.name){alert(I18n.resource.common.NOT_FOUND_PAGE);return false;}
var paramObj={page:screenClass.name},paramList=ScreenManager._getFunctionParams(screenClass);for(var m=0,n=paramList.length;m<n;m++){if(_typeof(arguments[m+1])!=(typeof undefined==='undefined'?'undefined':_typeof(undefined))){paramObj[paramList[m]]=arguments[m+1];}}
ScreenManager.goTo(paramObj);};ScreenManager.applyScreen=function(){var screenClass=arguments[0];if(!screenClass){alert('Can\'t find the page.');return;}
if(ScreenCurrent){window.onresize=null;if(ScreenCurrent.close&&ScreenCurrent.close()===false){return;}}
var screenObj=Object.create(screenClass.prototype);ScreenCurrent=screenClass.apply(screenObj,Array.prototype.slice.call(arguments,1))||screenObj;if(ScreenCurrent.onresize)window.onresize=ScreenCurrent.onresize;ScreenCurrent.show();};ScreenManager._getFunctionParams=function(func){var STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg,ARGUMENT_NAMES=/([^\s,]+)/g,fnStr,result;fnStr=func.toString().replace(STRIP_COMMENTS,'');result=fnStr.slice(fnStr.indexOf('(')+1,fnStr.indexOf(')')).match(ARGUMENT_NAMES);if(result===null){result=[];}
return result;};ScreenManager._getHashParamsMap=function(){var list,map={};list=location.hash.substr(1).split('&');for(var m=0;m<list.length;m++){var item=list[m].split('=');map[item[0]]=_unserializeParams(item[1]);}
return map;};ScreenManager.getPageId=function(){var hashMap=ScreenManager._getHashParamsMap();var params;if(hashMap.id){return hashMap.id;}
if(hashMap.reportId){return hashMap.reportId;}
if(typeof hashMap.options==='string'){params={};try{params=JSON.parse(window.decodeURIComponent(hashMap.options));}catch(e){}
return params.id;}
if(_typeof(hashMap.options)==='object'&&hashMap.options){return hashMap.options.id;}};ScreenManager.loadProjectMenu=function(project,page_id){ScreenManager.projectSelector.initProject(project['id'],project['name_en'],StringUtil.getI18nProjectName(project),page_id,project['logo']);};ScreenManager.loadUserPanel=function(){$("#right-nav").show();};ScreenManager.screenChange=function(e){var paramsMap=ScreenManager._getHashParamsMap(),project;if(_typeof(paramsMap.projectId)!==(typeof undefined==='undefined'?'undefined':_typeof(undefined))){AppConfig.projectId=parseInt(paramsMap.projectId);project=BEOPUtil.getProjectFromAppConfig(AppConfig.projectId);if(!project){alert.danger(I18n.resource.error.noPermission);return false;}
AppConfig.projectTimeFormat=project.time_format||0;}
var promise=$.Deferred();if(I18n&&I18n.resource){promise.resolve();}else{InitI18nResource().always(function(rs){I18n=new Internationalization(null,rs);promise.resolve();});}
promise.always(function(){var screen,currentPage,screenParamsNameList=[],screenParamsValueList=[];if(AppConfig.afterLogin){$('#navHeader').fadeIn();$('#indexMain').css({top:'55px'});}
if(project){AppConfig.projectEnName=project['name_en'];AppConfig.projectName=project['name_en'];if(location.hash!=ScreenManager.paneRoot&&!AppConfig.navItems){ScreenManager.loadProjectMenu(project,paramsMap.id);}else{ScreenManager.projectSelector.setMenuActive();}}
ScreenManager.loadUserPanel();currentPage=paramsMap[ScreenManager.screenFlag];if(currentPage){if(currentPage.indexOf('.')>0){screen=namespace(currentPage);}else{if(currentPage==='EnergyScreen_M'){currentPage='EnergyScreen';}
screen=window[currentPage]||namespace('observer.screens')[currentPage];}}else{console.error('无法识别的location hash! hash is '+location.hash);return true;}
if(screen&&typeof screen==='function'){screenParamsNameList=ScreenManager._getFunctionParams(screen);for(var m=0;m<screenParamsNameList.length;m++){var paramName=screenParamsNameList[m];if(typeof paramsMap[paramName]!=='undefined'){screenParamsValueList[m]=paramsMap[paramName];}else{screenParamsValueList[m]=undefined;}}
ScreenManager.applyScreen.apply(null,[screen].concat(screenParamsValueList));I18n.fillArea($('#navPane'));return false;}else{return true;}});};ScreenManager.goTo=function(pageInfo){var hashFlag='#',hashList=[];if(!pageInfo){return false;}
if(AppConfig.projectId){pageInfo['projectId']=AppConfig.projectId;}
if(pageInfo[ScreenManager.screenFlag]){hashList.push(ScreenManager.screenFlag+'='+pageInfo[ScreenManager.screenFlag]);}
for(var param in pageInfo){if(pageInfo.hasOwnProperty(param)){if(param!==ScreenManager.screenFlag){hashList.push(param+'='+_serializeParams(pageInfo[param]));}}}
if(location.hash===hashFlag+hashList.join('&')){Spinner&&Spinner.stop();}else{location.hash=hashFlag+hashList.join('&');}};ScreenManager.listen=function(){if("onhashchange"in window&&(!document.documentMode||document.documentMode>=8)){ScreenManager.isListening=true;window.onhashchange=ScreenManager.screenChange;ScreenManager.detectAnchorHash();if(location.hash===''){if(AppConfig.afterLogin){window.addEventListener('load',function(){location.hash=ScreenManager.paneRoot;ScreenManager.projectSelector.show();},false);}else{location.hash=ScreenManager.root;}}else{if(location.hash==ScreenManager.root){if(AppConfig.afterLogin){location.hash=ScreenManager.paneRoot;}else{ScreenManager.screenChange();}}
if(AppConfig.afterLogin){window.addEventListener('load',function(){ScreenManager.screenChange();ScreenManager.projectSelector.init();},false);}else{location.hash=ScreenManager.root;}}}else{console.error('This browser can\'t support onhashchange event.');}};ScreenManager.detectAnchorHash=function(){var isValidHash=function isValidHash(hash){if((typeof hash==='undefined'?'undefined':_typeof(hash))===(typeof undefined==='undefined'?'undefined':_typeof(undefined))||hash.startsWith('http')||hash.startsWith('https')||hash.startsWith('blob')){return true;}else if(hash==='/factory'||hash==='/point_tool/editor'){return true;}else{return hash.indexOf('=')!=-1;}};$(document).on('click.anchorHash','a',function(ev){var $this=$(this),hash=$this.attr('href'),isManagedHash=$this.attr('nothash');if((typeof isManagedHash==='undefined'?'undefined':_typeof(isManagedHash))!==(typeof undefined==='undefined'?'undefined':_typeof(undefined))&&isManagedHash!==false){return true;}
if(!isValidHash(hash)){ev.preventDefault();var dom=document.getElementById(hash.substr(1));if(dom){dom.scrollIntoView();}}
return true;});};if((typeof AppConfig==='undefined'?'undefined':_typeof(AppConfig))!=(typeof undefined==='undefined'?'undefined':_typeof(undefined))){ScreenManager.listen();try{ScreenManager.setProjectSelector(PaneProjectSelector);}catch(e){}}
function _serializeParams(params){return window.encodeURIComponent(JSON.stringify(params));}
function _unserializeParams(params){try{params=JSON.parse(window.decodeURIComponent(params));}catch(e){}
return params;}
return ScreenManager;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var ConfigModal=function(){function ConfigModal(opt,modal){_classCallCheck(this,ConfigModal);this.modal=modal instanceof jQuery?modal[0]:modal;this.modalContent=undefined;this.modalBody=undefined;this.modalStyle=undefined;this.opt=$.extend(true,{},opt);this.initOpt=$.extend(true,{},opt);this.mapWidget=[];this.mapWidgetCls={};this.mapModuleCls={};this.store={};}
ConfigModal.prototype.setOption=function setOption(){var opt=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.opt=$.extend(true,{},opt);this.initOpt=$.extend(true,{},opt);return this;};ConfigModal.prototype.init=function init(){this.destroy();this.initContainer();this.initClassMap();this.initModule();this.initResult();this.initWidgetMap();this.initWidgetByJSON();this.attachEvent();return this;};ConfigModal.prototype.initContainer=function initContainer(){if(!this.modal||!$(this.modal).hasClass('cfgModal')){var container=this.modal;this.modal=$('body>.cfgModal')[0];if(!this.modal){this.modal=document.createElement('div');this.modal.className='modal fade cfgModal';this.modal.innerHTML='\
                    <div class="modal-dialog">\
                        <style class="modal-style"></style>\
                        <div class="modal-content">\
                            <div class="modal-body"></div>\
                        </div>\
                    </div>\
                ';container?container.appendChild(this.modal):document.getElementsByTagName('body')[0].appendChild(this.modal);}}
var modalDialog=this.modal.querySelector('.modal-dialog');this.modalContent=this.modal.querySelector('.modal-content');this.modalStyle=this.modal.querySelector('.modal-style');if(!this.modalContent){this.modalContent=document.createElement('div');this.modalContent.className='modal-content';this.modalContent.innerHTML='<div class="modal-body"></div>';if(!modalDialog){modalDialog=document.createElement('div');modalDialog.className='modal-dialog';this.modal.appendChild(modalDialog);}
modalDialog.appendChild(this.modalContent);}
this.modalBody=this.modal.querySelector('.modal-body');this.modalBody.style.height=window.innerHeight*0.5+'px';this.clearDom();if(this.opt.header)this.modalContent.insertBefore(this.initModalHeader(),this.modalBody);};ConfigModal.prototype.initModalHeader=function initModalHeader(){if(!this.opt.header)return;var divHeader=document.createElement('div');divHeader.className='modal-header';if(this.opt.header.needBtnClose!==false){var btnClose=document.createElement('button');btnClose.className='close';btnClose.setAttribute('type','button');btnClose.dataset.dismiss='modal';btnClose.setAttribute('aria-label','close');btnClose.innerHTML='<span aria-hidden="true">&times;</span>';divHeader.appendChild(btnClose);}
if(this.opt.header.title){var divTitle=document.createElement('h4');divTitle.className='modal-title';divTitle.textContent=this.opt.header.title;divHeader.appendChild(divTitle);}
return divHeader;};ConfigModal.prototype.searChWidget=function searChWidget(){var widgetDom=this.modal.querySelectorAll('.cfgWidget');var type,arrWidgetDom;for(var i=0;i<widgetDom.length;i++){type=widgetDom.getAttribute('type');if(type){arrWidgetDom=this.mapWidget.get(type);arrWidgetDom instanceof Array?this.mapWidget.set(type,[widgetDom]):arrWidgetDom.push(widgetDom);}}};ConfigModal.prototype.initWidgetByDom=function initWidgetByDom(){var _this2=this;this.mapWidget.forEach(function(val,key){var widgetCls=_this2.mapWidgetCls(key);new widgetCls(_this2,val).init();});};ConfigModal.prototype.setModalData=function setModalData(data){this.opt.data=data;};ConfigModal.prototype.show=function show(){$(this.modal).modal('show');return this;};ConfigModal.prototype.hide=function hide(){$(this.modal).modal('hide');return this;};ConfigModal.prototype.attachEvent=function attachEvent(){var _this3=this;var $modal=$(this.modal);if(this.opt&&this.opt.event){if(typeof this.opt.event.beforeShow=='function'){$modal.off('show.bs.modal').on('show.bs.modal',function(e){_this3.opt.event.beforeShow();});}
if(typeof this.opt.event.afterShow=='function'){$modal.off('shown.bs.modal').on('shown.bs.modal',function(e){_this3.opt.event.afterShow();});}
if(typeof this.opt.event.beforeHide=='function'){$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){_this3.opt.event.beforeHide();});}
if(typeof this.opt.event.afterHide=='function'){$modal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this3.opt.event.afterHide();});}else{$modal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){});}}};ConfigModal.prototype.initWidgetMap=function initWidgetMap(){var _this4=this;if(!(this.opt.area instanceof Array))this.opt.area=[];this.mapWidget=[];this.opt.area.forEach(function(val,index){if(!(val.widget instanceof Array))return;if(!val.dom){val.dom=document.createElement('div');val.dom.className='cfgArea div'+_this4.upperCaseText(val.name?val.name:val.type,0);val.dom.setAttribute('type',val.type);val.id=ObjectId();if(val.type=='footer'){val.dom.className+=' modal-footer';_this4.modalContent.appendChild(val.dom);}else{val.dom.className+=' row';_this4.modalBody.appendChild(val.dom);}}
for(var i=0;i<val.widget.length;i++){val.widget[i].cls=_this4.mapWidgetCls[val.widget[i].type];if(!val.widget[i].cls)continue;if(!val.widget[i].opt)val.widget[i].opt={};val.widget[i].instantiation=new val.widget[i].cls(_this4,val.widget[i],val);}
_this4.mapWidget.push(val);});};ConfigModal.prototype.initClassMap=function initClassMap(){this.mapWidgetCls={select:SelectOption,interval:IntervalOption,refreshInterval:RefreshIntervalOption,recentTime:RecentTimeOption,recentTimeCustom:recentTimeCustomOption,mode:ModeOption,date:DateOption,range:RangeOption,text:TextOption,color:InputColorOption,checkbox:CheckBoxOption,linkSelect:LinkOption,datasource:DataSourceData,dataInfoList:DataInfoListData,multiDataConfig:MultiDataConfigData,confirm:ConfirmFooter,cancel:CancelFooter};this.mapModuleCls={timeConfig:TimeConfigModule,dsDrag:DataSourceDragModule,dataInfoList:DataInfoListModule,multiDataConfig:MultiDataConfigModule,realTime:RealTimeConfigModule,gauge:GaugeConfigModule,factoryTplFooter:FactoryTplFooterModule,colorConfig:ColorConfigModule};};ConfigModal.prototype.initModule=function initModule(){var _this5=this;if(!(this.opt.area instanceof Array))this.opt.area=[];this.opt.area.forEach(function(val,index){if(!val.module||!_this5.mapModuleCls[val.module])return;val.cls=_this5.mapModuleCls[val.module];val.instantiation=new val.cls(_this5,val);val.instantiation.init();});};ConfigModal.prototype.initWidgetByJSON=function initWidgetByJSON(){this.mapWidget.forEach(function(val){if(val.widget instanceof Array){for(var i=0;i<val.widget.length;i++){val.widget[i].instantiation.init();}}});this.mapWidget.forEach(function(val){if(val.widget instanceof Array){for(var i=0;i<val.widget.length;i++){val.widget[i].instantiation.setSubWidget();}}});};ConfigModal.prototype.initResult=function initResult(){if(!this.opt.result)return;if(typeof this.opt.result.func=='function'){var areaFooter,widgetConfirm;for(var i=this.opt.area.length-1;i>=0;i--){if(!this.opt.area[i].widget)continue;for(var j=0;j<this.opt.area[i].widget.length;j++){if(this.opt.area[i].widget[j].type=='confirm')widgetConfirm=this.opt.area[i].widget[j];break;}
if(widgetConfirm){areaFooter=this.opt.area[i];break;}}
var _this=this;if(!widgetConfirm){widgetConfirm={type:'confirm',func:function func(e){_this.store=_this.getResult();_this.opt.result.func(_this.store);if(this.opt.needClose!==false)_this.hide();}};areaFooter={type:'footer',widget:[widgetConfirm]};this.opt.area.push(areaFooter);}else{widgetConfirm.func=function(){_this.store=_this.getResult();_this.opt.result.func(_this.store);if(this.opt.needClose!==false)_this.hide();};}}};ConfigModal.prototype.getResult=function getResult(){var store={},widgetStore;var storeGroup;var data;var id;for(var i=0;i<this.opt.area.length;i++){if(this.opt.area[i].instantiation){data=this.opt.area[i].instantiation.getData();if(data)Object.assign(store,data);continue;}
for(var j=0;j<this.opt.area[i].widget.length;j++){if(this.opt.area[i].widget[j].id){id=this.opt.area[i].widget[j].id;}else{id=this.opt.area[i].widget[j].type;}
widgetStore=this.opt.area[i].widget[j].instantiation.getData();widgetStore&&(store[id]=widgetStore);}}
return store;};ConfigModal.prototype.upperCaseText=function upperCaseText(text,index){if(!text[0])return'';return text[index].toUpperCase()+text.slice(index+1);};ConfigModal.prototype.clearDom=function clearDom(){if(this.modalContent){this.modalContent.querySelector('.modal-body').innerHTML='';var modalHeader=this.modalContent.querySelector('.modal-header');modalHeader&&this.modalContent.removeChild(modalHeader);var arrModalFooter=this.modalContent.querySelectorAll('.modal-footer');for(var i=0;i<arrModalFooter.length;i++){this.modalContent.removeChild(arrModalFooter[i]);}}
this.modal&&$(this.modal).find('.modal-style').html('');this.modalBody&&(this.modalBody.innerHTML='');};ConfigModal.prototype.transDomToJSON=function transDomToJSON(){};ConfigModal.prototype.extendWidget=function extendWidget(){};ConfigModal.prototype.setData=function setData(data){var _this6=this;if(!(data instanceof Array&&data.length>0))return;data.forEach(function(val){if(!val.type)return;var moduleEntity;if(val.module){moduleEntity=_this6.getModuleByType(val.module);}
_this6.getWidgetByType(val.type,moduleEntity).forEach(function(widget){widget.instantiation.setData(val.data);});});return this;};ConfigModal.prototype.getModuleByType=function getModuleByType(module){if(!module)return;var arrModule=[];for(var i=0;i<this.opt.area.length;i++){if(this.opt.area[i].module==module){arrModule.push(this.opt.area[i]);}}
return arrModule;};ConfigModal.prototype.getWidgetByType=function getWidgetByType(type,area){var arrWidget=[];if(area){if(area instanceof Array){area.forEach(function(val){for(var i=0;i<val.widget.length;i++){if(val.widget[i].type==type){arrWidget.push(val.widget[i]);}}});}else{for(var i=0;i<area.widget.length;i++){if(area.widget[i].type==type){arrWidget.push(area.widget[i]);}}}}else{for(var _i=0;_i<this.opt.widget.length;_i++){if(this.opt.widget[_i].type==type){arrWidget.push(this.opt.widget[_i]);}}}
return arrWidget;};ConfigModal.prototype.destroy=function destroy(){this.clearDom();if(!(this.opt.area instanceof Array))return;for(var i=0;i<this.opt.area.length;i++){if(this.opt.area[i].instantiation){this.opt.area[i].instantiation.destroy();this.opt.area[i].instantiation=null;}else{if(!this.opt.area[i].widget)continue;for(var j=0;j<this.opt.area[i].widget.length;j++){if(!this.opt.area[i].widget[j].instantiation)continue;this.opt.area[i].widget[j].instantiation.destroy();this.opt.area[i].widget[j].instantiation=null;}}}};return ConfigModal;}();function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}
function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}
function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BaseConfigWidget=function(){function BaseConfigWidget(objModal,widget,area){_classCallCheck(this,BaseConfigWidget);this.objModal=objModal;this.widget=widget;this.area=area;this.store=undefined;this.mainWidgetOpt={};}
BaseConfigWidget.prototype.init=function init(){this.initOption();this.initData();this.setWidget();this.attachEvent();this.widget.completeInit&&this.widget.completeInit.call(this);};BaseConfigWidget.prototype.setWidget=function setWidget(){this.widget.dom=document.createElement('div');this.widget.dom.className='cfgWidget cfgOptionWidget div'+this.upperCaseText(this.widget.type);this.widget.dom.setAttribute('type',this.widget.type);this.initWidgetLabel();this.initWidgetAttr();this.initWidgetStyle();this.initWidgetId();this.widget.dom.appendChild(this.createWidgetDom(this.widget.opt));this.area.dom.appendChild(this.widget.dom);};BaseConfigWidget.prototype.initOption=function initOption(){if(this.defaultOpt){this.widget=$.extend(true,{},this.defaultOpt,this.widget);}};BaseConfigWidget.prototype.setSubWidget=function setSubWidget(){var _this2=this;if(!(this.widget.subWidget instanceof Array))return;this.widget.subWidget.forEach(function(val){var obj;for(var i=0;i<_this2.area.widget.length;i++){if(_this2.area.widget[i].type==val.type){obj=_this2.area.widget[i].instantiation;}}
if(!obj)return;if(typeof val.callback=='function'){val.callback.call(obj,_this2.widget.type,_this2.store);obj.setSubWidget();}else{obj.onMainWidgetChange(_this2.widget.type,_this2.store);}});};BaseConfigWidget.prototype.onMainWidgetChange=function onMainWidgetChange(type,val){};BaseConfigWidget.prototype.initWidgetLabel=function initWidgetLabel(){if(this.widget.name&&this.widget.opt.needLabel!==false){var label=document.createElement('label');label.className='cfgLabel';label.textContent=this.widget.name;this.widget.dom.appendChild(label);}};BaseConfigWidget.prototype.initWidgetAttr=function initWidgetAttr(){if(this.widget.opt.attr){for(var attr in this.widget.opt.attr){if(attr=='class'){this.widget.dom.className+=' '+this.widget.opt.attr[attr];continue;}
this.widget.dom.setAttribute(attr,this.widget.opt.attr[attr]);}}};BaseConfigWidget.prototype.initWidgetStyle=function initWidgetStyle(){if(this.widget.opt.style){$(this.widget.dom).css(this.widget.opt.style);}};BaseConfigWidget.prototype.initWidgetId=function initWidgetId(){if(this.widget.id){this.widget.dom.id=this.widget.id;}};BaseConfigWidget.prototype.attachEvent=function attachEvent(){};BaseConfigWidget.prototype.initData=function initData(){this.store=this.widget.store;};BaseConfigWidget.prototype.createWidgetDom=function createWidgetDom(opt){};BaseConfigWidget.prototype.setData=function setData(data){this.store=data;};BaseConfigWidget.prototype.getData=function getData(){return this.store;};BaseConfigWidget.prototype.upperCaseText=function upperCaseText(text,index){if(!index)index=0;return text[index].toUpperCase()+text.slice(index+1);};BaseConfigWidget.prototype.destroy=function destroy(){this.objModal=null;this.widget=null;this.area=null;this.store=null;this.mainWidgetOpt=null;};return BaseConfigWidget;}();var baseModuleOperateBtn=function(){function baseModuleOperateBtn(module){_classCallCheck(this,baseModuleOperateBtn);this.module=module;this.btn=undefined;}
baseModuleOperateBtn.prototype.init=function init(){this.createButton();this.attachEvent();};baseModuleOperateBtn.prototype.createButton=function createButton(){};baseModuleOperateBtn.prototype.attachEvent=function attachEvent(){};return baseModuleOperateBtn;}();var btnModuleAdd=function(_baseModuleOperateBtn){_inherits(btnModuleAdd,_baseModuleOperateBtn);function btnModuleAdd(module){_classCallCheck(this,btnModuleAdd);return _possibleConstructorReturn(this,_baseModuleOperateBtn.call(this,module));}
btnModuleAdd.prototype.createButton=function createButton(){this.btn=document.createElement('span');this.btn.className='glyphicon glyphicon-plus btnModuleAdd btnModuleOperate';this.module.dom.appendChild(this.btn,this.module.dom.children[0]);};btnModuleAdd.prototype.attachEvent=function attachEvent(){var _this=this;this.btn.onclick=function(){$(_this.module.dom).after('');};};return btnModuleAdd;}(baseModuleOperateBtn);var btnModuleDel=function(_baseModuleOperateBtn2){_inherits(btnModuleDel,_baseModuleOperateBtn2);function btnModuleDel(module){_classCallCheck(this,btnModuleDel);return _possibleConstructorReturn(this,_baseModuleOperateBtn2.call(this,module));}
btnModuleDel.prototype.createButton=function createButton(){this.btn=document.createElement('span');this.btn.className='glyphicon glyphicon-plus btnModuleDel btnModuleOperate';this.module.dom.appendChild(this.btn,this.module.dom.children[0]);};btnModuleDel.prototype.attachEvent=function attachEvent(){var _this=this;this.btn.onclick=function(){$(_this.module.dom).after('');};};return btnModuleDel;}(baseModuleOperateBtn);function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}
function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}
var BaseOptionWidget=function(_BaseConfigWidget){_inherits(BaseOptionWidget,_BaseConfigWidget);function BaseOptionWidget(objModal,widget,area){_classCallCheck(this,BaseOptionWidget);return _possibleConstructorReturn(this,_BaseConfigWidget.call(this,objModal,widget,area));}
return BaseOptionWidget;}(BaseConfigWidget);var SelectOption=function(_BaseOptionWidget){_inherits(SelectOption,_BaseOptionWidget);function SelectOption(objModal,widget,area){_classCallCheck(this,SelectOption);var _this3=_possibleConstructorReturn(this,_BaseOptionWidget.call(this,objModal,widget,area));_this3.defaultOpt={type:'select',opt:{attr:{class:'col-xs-3'}}};return _this3;}
SelectOption.prototype.setWidget=function setWidget(){this.widget.dom=document.createElement('div');this.widget.dom.className='cfgWidget cfgOptionWidget div'+this.upperCaseText(this.widget.type);this.widget.dom.setAttribute('type',this.widget.type);this.initWidgetLabel();this.initWidgetAttr();this.initWidgetStyle();this.initWidgetId();this.widget.dom.appendChild(this.createWidgetDom(this.widget.opt));this.area.dom.appendChild(this.widget.dom);};SelectOption.prototype.createWidgetDom=function createWidgetDom(opt){var select=document.createElement('select');select.className='form-control';var option;for(var i=0;i<opt.option.length;i++){option=new Option();option.value=opt.option[i].val;option.text=opt.option[i].name;if(this.store.val==opt.option[i].val){option.selected=true;}
select.options.add(option);}
if(!this.store.val)select.options[0].selected=true;return select;};SelectOption.prototype.attachEvent=function attachEvent(){var _this4=this;$(this.widget.dom).find('select').off('change').on('change',function(e){_this4.store={val:e.currentTarget.value,name:e.currentTarget.querySelector('[value="'+e.currentTarget.value+'"]').textContent};_this4.setSubWidget();});};SelectOption.prototype.initData=function initData(){if(this.widget.data&&this.widget.data.val){for(var i=0;i<this.widget.opt.option.length;i++){if(this.widget.opt.option[i].val==this.widget.data.val){this.store={val:this.widget.opt.option[i].val,name:this.widget.opt.option[i].name};return;}}}
this.store={val:this.widget.opt.option[0].val,name:this.widget.opt.option[0].name};};return SelectOption;}(BaseOptionWidget);var IntervalOption=function(_SelectOption){_inherits(IntervalOption,_SelectOption);function IntervalOption(objModal,widget,area){_classCallCheck(this,IntervalOption);var _this5=_possibleConstructorReturn(this,_SelectOption.call(this,objModal,widget,area));_this5.defaultOpt={type:'interval',opt:{option:[{val:'m1',name:'1分钟'},{val:'m5',name:'5分钟'},{val:'h1',name:'1小时'},{val:'d1',name:'1天'},{val:'M1',name:'1个月'}],attr:{class:'col-xs-3'}},name:'采样周期'};return _this5;}
IntervalOption.prototype.initData=function initData(){this.store={};if(this.area.data&&this.area.data.format){this.store.val=this.area.data.format;}};return IntervalOption;}(SelectOption);var RefreshIntervalOption=function(_SelectOption2){_inherits(RefreshIntervalOption,_SelectOption2);function RefreshIntervalOption(objModal,widget,area){_classCallCheck(this,RefreshIntervalOption);var _this6=_possibleConstructorReturn(this,_SelectOption2.call(this,objModal,widget,area));_this6.defaultOpt={type:'refreshInterval',opt:{option:[{val:'30s',name:'30秒钟'},{val:'m1',name:'1分钟'},{val:'m5',name:'5分钟'},{val:'10m',name:'10分钟'},{val:'30m',name:'30分钟'},{val:'h1',name:'1小时'},{val:'d1',name:'1天'},{val:'M1',name:'1个月'}],attr:{class:'col-xs-3'}},name:'刷新时间'};return _this6;}
return RefreshIntervalOption;}(SelectOption);var ModeOption=function(_SelectOption3){_inherits(ModeOption,_SelectOption3);function ModeOption(objModal,widget,area){var opt=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};_classCallCheck(this,ModeOption);var _this7=_possibleConstructorReturn(this,_SelectOption3.call(this,objModal,widget,area,opt));_this7.defaultOpt={type:'mode',opt:{option:[{val:'0',name:'快速配置'},{val:'1',name:'固定周期'},{val:'2',name:'最近周期'}],attr:{class:'col-xs-3'}},name:'模式'};return _this7;}
return ModeOption;}(SelectOption);var RecentTimeOption=function(_SelectOption4){_inherits(RecentTimeOption,_SelectOption4);function RecentTimeOption(objModal,widget,area){var opt=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};_classCallCheck(this,RecentTimeOption);var _this8=_possibleConstructorReturn(this,_SelectOption4.call(this,objModal,widget,area,opt));_this8.defaultOpt={type:'recentTime',opt:{option:[{val:'today',name:'过去24小时'},{val:'threeDay',name:'过去72小时'},{val:'yesterday',name:'昨天（24小时）'},{val:'thisWeek',name:'过去7天'},{val:'lastWeek',name:'上周（7天）'},{val:'thisYear',name:'过去12个月'}],attr:{class:'col-xs-3'}},name:'时间周期'};return _this8;}
RecentTimeOption.prototype.getData=function getData(){var startTime,endTime,format;var now=new Date();switch(this.store.val){case'today':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-86400000).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'threeDay':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-259200000).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'yesterday':endTime=new Date(new Date().setDate(now.getDate()-1)).format('yyyy-MM-dd 23:59:59');startTime=new Date(new Date().setDate(now.getDate()-1)).format('yyyy-MM-dd 00:00:00');format='h1';break;case'thisWeek':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-604800000).format('yyyy-MM-dd HH:mm:ss');format='d1';break;case'lastWeek':endTime=new Date(now-(now.getDay()+1)*86400000).format('yyyy-MM-dd 23:59:59');startTime=new Date(now-(now.getDay()+7)*86400000).format('yyyy-MM-dd 00:00:00');format='d1';break;case'thisYear':endTime=new Date(now-(now.getDay()+1)*86400000).format('yyyy-MM-dd 23:59:59');startTime=new Date(now-(now.getDay()+7)*86400000).format('yyyy-MM-dd 00:00:00');format='M1';break;}
return{startTime:startTime,endTime:endTime,recentTime:this.store.val,format:format};};RecentTimeOption.prototype.initData=function initData(){if(this.widget.data){for(var i=0;i<this.widget.opt.option.length;i++){if(this.widget.opt.option[i].val==this.widget.data){this.store={val:this.widget.opt.option[i].val,name:this.widget.opt.option[i].name};break;}}}else{this.store={val:this.widget.opt.option[0].val,name:this.widget.opt.option[0].name};}};return RecentTimeOption;}(SelectOption);var TextWithSelectOption=function(_BaseOptionWidget2){_inherits(TextWithSelectOption,_BaseOptionWidget2);function TextWithSelectOption(objModal,widget,area){_classCallCheck(this,TextWithSelectOption);var _this9=_possibleConstructorReturn(this,_BaseOptionWidget2.call(this,objModal,widget,area));_this9.defaultOpt={type:'textWithSelect',opt:{attr:{class:'col-xs-6'}}};return _this9;}
TextWithSelectOption.prototype.createWidgetDom=function createWidgetDom(opt){var divIptGrp=document.createElement('div');divIptGrp.className='input-group';divIptGrp.style.width='100%';var iptText=document.createElement('input');iptText.className='form-control';iptText.setAttribute('type','text');iptText.style.width='50%';var select=document.createElement('select');select.className='form-control';select.style.width='50%';var option;for(var ele in opt.option){option=new Option();option.value=opt.option[ele].val;option.text=opt.option[ele].name;select.options.add(option);}
divIptGrp.appendChild(iptText);divIptGrp.appendChild(select);return divIptGrp;};TextWithSelectOption.prototype.initData=function initData(){this.store={};if(this.widget.data&&this.widget.data.val){this.store.val=this.area.data.val;}
if(this.widget.data&&this.widget.data.unit){this.store.unit=this.area.data.unit;}else{this.store.unit=this.widget.opt.option[0].val;}};TextWithSelectOption.prototype.attachEvent=function attachEvent(){var _this=this;this.widget.dom.querySelector('select').onchange=function(e){_this.store.unit=e.currentTarget.value;_this.setSubWidget();};this.widget.dom.querySelector('input').onchange=function(e){_this.store.val=e.currentTarget.value;};};return TextWithSelectOption;}(BaseOptionWidget);var recentTimeCustomOption=function(_TextWithSelectOption){_inherits(recentTimeCustomOption,_TextWithSelectOption);function recentTimeCustomOption(objModal,widget,area){_classCallCheck(this,recentTimeCustomOption);var _this10=_possibleConstructorReturn(this,_TextWithSelectOption.call(this,objModal,widget,area));_this10.defaultOpt={type:'recentTimeCustom',opt:{option:[{val:'hour',name:'小时'},{val:'day',name:'天'},{val:'month',name:'月'}],attr:{class:'col-xs-6'}},name:'时间周期'};return _this10;}
recentTimeCustomOption.prototype.getData=function getData(){return this.store;};recentTimeCustomOption.prototype.createWidgetDom=function createWidgetDom(opt){var divIptGrp=document.createElement('div');divIptGrp.className='input-group';divIptGrp.style.width='100%';var iptText=document.createElement('input');iptText.className='form-control';iptText.setAttribute('type','text');iptText.style.width='50%';if(this.store&&this.store.val){iptText.value=this.store.val;}
var select=document.createElement('select');select.className='form-control';select.style.width='50%';var option;for(var ele in opt.option){option=new Option();option.value=opt.option[ele].val;option.text=opt.option[ele].name;select.options.add(option);if(this.store&&this.store.unit===option.value){option.selected=true;}}
divIptGrp.appendChild(iptText);divIptGrp.appendChild(select);return divIptGrp;};return recentTimeCustomOption;}(TextWithSelectOption);var DateOption=function(_BaseOptionWidget3){_inherits(DateOption,_BaseOptionWidget3);function DateOption(objModal,widget,area){_classCallCheck(this,DateOption);var _this11=_possibleConstructorReturn(this,_BaseOptionWidget3.call(this,objModal,widget,area));_this11.defaultOpt={type:'date',opt:{input:[{val:new Date(),role:'startTime',suffix:'To'},{val:new Date(),role:'endTime'}],attr:{class:'col-xs-6'}},name:'时间范围'};return _this11;}
DateOption.prototype.initData=function initData(){this.store={};if(this.widget.data){this.store.startTime=this.widget.data.startTime;this.store.endTime=this.widget.data.endTime;return;}
for(var i=0;i<this.widget.opt.input.length;i++){var date=new Date(this.widget.opt.input[i].val);if(!date||date=='Invalid Date')date=new Date();this.store[this.widget.opt.input[i].role]=date.format('yyyy-MM-dd HH:mm:ss');}};DateOption.prototype.createWidgetDom=function createWidgetDom(opt){var divIptDateGrp=document.createElement('div');divIptDateGrp.className='input-group';var iptDate,spDateSuffix;if(opt.input instanceof Array&&opt.input.length>0){for(var i=0;i<opt.input.length;i++){iptDate=document.createElement('input');iptDate.className='form-control';iptDate.setAttribute('type','text');iptDate.setAttribute('role',opt.input[i].role);if(this.store[opt.input[i].role]){iptDate.value=this.store[opt.input[i].role];}
divIptDateGrp.appendChild(iptDate);if(opt.input[i].suffix){spDateSuffix=document.createElement('span');spDateSuffix.textContent=opt.input[i].suffix;spDateSuffix.className='input-group-addon';divIptDateGrp.appendChild(spDateSuffix);}
$(iptDate).datetimepicker({initialDate:this.store[opt.input[i].role]?new Date(this.store[opt.input[i].role]):new Date(),format:'yyyy-mm-dd hh:ii:ss',todayBtn:'linked',autoclose:true});}}
return divIptDateGrp;};DateOption.prototype.onMainWidgetChange=function onMainWidgetChange(data){};DateOption.prototype.attachEvent=function attachEvent(){var _this12=this;var $iptDate=$(this.widget.dom).find('input');this.store={};$iptDate.off('change').on('change',function(e){for(var i=0;i<$iptDate.length;i++){_this12.store[e.currentTarget.getAttribute('role')]=e.currentTarget.value;}});};DateOption.prototype.getData=function getData(){var _this13=this;var $iptDate=$(this.widget.dom).find('input');this.store={};$iptDate.each(function(index,obj){_this13.store[obj.getAttribute('role')]=obj.value;});return this.store;};return DateOption;}(BaseOptionWidget);var TextOption=function(_BaseOptionWidget4){_inherits(TextOption,_BaseOptionWidget4);function TextOption(objModal,widget,area){_classCallCheck(this,TextOption);var _this14=_possibleConstructorReturn(this,_BaseOptionWidget4.call(this,objModal,widget,area));_this14.defaultOpt={type:'text',opt:{data:'',attr:{class:'col-xs-6'}}};return _this14;}
TextOption.prototype.initData=function initData(){this.store={val:this.widget.opt.data};};TextOption.prototype.createWidgetDom=function createWidgetDom(opt){var ipt=document.createElement('input');ipt.className='form-control';ipt.setAttribute('type','text');ipt.value=opt.data?opt.data:'';if(opt.attr.placeholder)ipt.setAttribute('placeholder',opt.attr.placeholder);return ipt;};TextOption.prototype.attachEvent=function attachEvent(){var _this15=this;$(this.widget.dom).find('input').off('change').on('change',function(e){_this15.store={val:e.currentTarget.value};_this15.setSubWidget();});$(this.widget.dom).find('input').off('input').on('input',function(e){_this15.store={val:e.currentTarget.value};_this15.setSubWidget();});};return TextOption;}(BaseOptionWidget);var RangeOption=function(_BaseOptionWidget5){_inherits(RangeOption,_BaseOptionWidget5);function RangeOption(objModal,widget,area){_classCallCheck(this,RangeOption);var _this16=_possibleConstructorReturn(this,_BaseOptionWidget5.call(this,objModal,widget,area));_this16.defaultOpt={type:'range',opt:{attr:{class:'col-xs-12'}}};return _this16;}
RangeOption.prototype.createWidgetDom=function createWidgetDom(opt){var divIptDateGrp=document.createElement('div');divIptDateGrp.className='input-group';var iptRange,spDateSuffix;if(opt.input instanceof Array&&opt.input.length>0){for(var i=0;i<opt.input.length;i++){iptRange=document.createElement('input');iptRange.className='form-control';opt.input[i].cls&&(iptRange.className+=' '+opt.input[i].cls);iptRange.setAttribute('type','text');iptRange.value=opt.input[i].val?opt.input[i].val:'';iptRange.setAttribute('role',opt.input[i].role?opt.input[i].role:'');divIptDateGrp.appendChild(iptRange);if(opt.input[i].suffix){spDateSuffix=document.createElement('span');spDateSuffix.className='input-group-addon';opt.input[i].suffix.cls&&(spDateSuffix.className+=' '+opt.input[i].suffix.cls);opt.input[i].suffix.text&&(spDateSuffix.textContent=opt.input[i].suffix.text);opt.input[i].suffix.style&&$.extend(spDateSuffix.style,opt.input[i].suffix.style);divIptDateGrp.appendChild(spDateSuffix);}}}
return divIptDateGrp;};RangeOption.prototype.initData=function initData(){if(this.widget.opt.input instanceof Array&&this.widget.opt.input.length>0){this.store=this.widget.opt.input.map(function(item){return{val:!isNaN(item.value)?parseFloat(item.value):0,role:item.role?item.role:''};});}else{this.store=[];}};RangeOption.prototype.attachEvent=function attachEvent(){var _this17=this;var $iptRange=$(this.widget.dom).find('input');$iptRange.off('change').on('change',function(e){_this17.getIptVal($iptRange);});};RangeOption.prototype.getIptVal=function getIptVal($iptRange){var arrRange=[];for(var i=0;i<$iptRange.length;i++){arrRange.push({val:!isNaN($iptRange[i].value)?parseFloat($iptRange[i].value):0,role:$iptRange[i].getAttribute('role')});}
this.store=arrRange;};return RangeOption;}(BaseOptionWidget);var LinkOption=function(_BaseOptionWidget6){_inherits(LinkOption,_BaseOptionWidget6);function LinkOption(objModal,widget,area){_classCallCheck(this,LinkOption);var _this18=_possibleConstructorReturn(this,_BaseOptionWidget6.call(this,objModal,widget,area));_this18.defaultOpt={type:'linkSelect',name:'链接',opt:{data:'',attr:{class:'col-xs-6'},option:{}}};return _this18;}
LinkOption.prototype.createWidgetDom=function createWidgetDom(opt){var divSelect=document.createElement('div');divSelect.className='divLinkSel';var selLinkType=document.createElement('select');selLinkType.className='form-control selLinkType';var typeOpt,typeIndex;typeIndex=0;for(var i=0;i<opt.option.length;i++){typeOpt=new Option();typeOpt.value=typeOpt.option[i].type;typeOpt.name=typeOpt.option[i].name;if(this.store.type==typeOpt.option[i].val){typeOpt.selected=true;typeIndex=i;}
selLinkType.options.add(typeOpt);}
var selLinkTar=document.createElement('select');selLinkTar.className='form-control selLinkTar';var linkOpt;for(var i=0;i<opt.option[typeIndex].link.length;i++){linkOpt=new Option();linkOpt.value=opt.option[typeIndex].link[i].val;linkOpt.name=opt.option[typeIndex].link[i].name;if(this.store.link==opt.option[typeIndex].link[i].val){linkOpt.selected=true;}
selLinkTar.options.add(linkOpt);}
return divSelect;};LinkOption.prototype.setChartSelTar=function setChartSelTar($dom){$dom.innerHTML='';if(!this.opt.option||!this.opt.option.chart)return;var opt;var arrOpt=this.opt.option.page;for(var i=0;i<arrOpt.length;i++){opt=new Option();opt.value=arrOpt[i].val;opt.text=arrOpt[i].name;if(this.store.val==arrOpt[i].val){opt.selected=true;}
$dom[0].options.add(opt);}};LinkOption.prototype.setPageSelTar=function setPageSelTar($dom){$dom.innerHTML='';if(!this.opt.option||!this.opt.option.page)return;var opt;var arrOpt=this.opt.option.page;for(var i=0;i<arrOpt.length;i++){opt=new Option();opt.value=arrOpt[i].val;opt.text=arrOpt[i].name;if(this.store.val==arrOpt[i].val){opt.selected=true;}
$dom[0].options.add(opt);}};LinkOption.prototype.attachEvent=function attachEvent(){var _this19=this;var $selLinkTar=$(this.widget.dom).find('.selLinkTar');$(this.widget.dom).find('.selLinkType').off('change').on('change',function(e){if(e.currentTarget.value=='chart'){_this19.setChartSelTar($selLinkTar);}else{_this19.setPageSelTar($selLinkTar);}});};return LinkOption;}(BaseOptionWidget);var CheckBoxOption=function(_BaseOptionWidget7){_inherits(CheckBoxOption,_BaseOptionWidget7);function CheckBoxOption(objModal,widget,area){_classCallCheck(this,CheckBoxOption);var _this20=_possibleConstructorReturn(this,_BaseOptionWidget7.call(this,objModal,widget,area));_this20.defaultOpt={type:'checkbox',name:'选择',opt:{data:'',option:{}}};return _this20;}
CheckBoxOption.prototype.createWidgetDom=function createWidgetDom(opt){var iptChkBox=document.createElement('input');iptChkBox.className='iptCheckBox';iptChkBox.style.top='2px';iptChkBox.style.left='10px';iptChkBox.style.position='relative';iptChkBox.setAttribute('type','checkbox');if(this.store==true)iptChkBox.checked=true;return iptChkBox;};CheckBoxOption.prototype.initData=function initData(){if(this.widget.data){this.store=this.widget.data;}};CheckBoxOption.prototype.getData=function getData(){var val=this.widget.dom.querySelector('.iptCheckBox').checked;this.store=val;return this.store;};return CheckBoxOption;}(BaseOptionWidget);var InputColorOption=function(_BaseOptionWidget8){_inherits(InputColorOption,_BaseOptionWidget8);function InputColorOption(objModal,widget,area){_classCallCheck(this,InputColorOption);var _this21=_possibleConstructorReturn(this,_BaseOptionWidget8.call(this,objModal,widget,area));_this21.defaultOpt={type:'color',opt:{data:'',attr:{class:'col-xs-2'}}};return _this21;}
InputColorOption.prototype.initData=function initData(){this.store={val:this.widget.opt.data};};InputColorOption.prototype.createWidgetDom=function createWidgetDom(opt){var ipt=document.createElement('input');ipt.setAttribute('type','color');ipt.className='form-control';ipt.value=opt.data?opt.data:'';return ipt;};InputColorOption.prototype.attachEvent=function attachEvent(){var _this22=this;$(this.widget.dom).find('input').off('change').on('change',function(e){_this22.store={val:e.currentTarget.value};});};return InputColorOption;}(BaseOptionWidget);function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}
function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}
var BaseDataWidget=function(_BaseConfigWidget){_inherits(BaseDataWidget,_BaseConfigWidget);function BaseDataWidget(objModal,widget,area){_classCallCheck(this,BaseDataWidget);return _possibleConstructorReturn(this,_BaseConfigWidget.call(this,objModal,widget,area));}
BaseDataWidget.prototype.setWidget=function setWidget(){this.widget.dom=document.createElement('div');this.widget.dom.className='cfgWidget cfgDataWidget div'+this.upperCaseText(this.widget.type);this.widget.dom.setAttribute('type',this.widget.type);this.initWidgetLabel();this.initWidgetAttr();this.initWidgetStyle();this.initWidgetId();this.widget.dom.appendChild(this.createWidgetDom(this.widget.opt));this.area.dom.appendChild(this.widget.dom);};return BaseDataWidget;}(BaseConfigWidget);var DataSourceData=function(_BaseDataWidget){_inherits(DataSourceData,_BaseDataWidget);function DataSourceData(objModal,widget,area){var opt=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};_classCallCheck(this,DataSourceData);var _this3=_possibleConstructorReturn(this,_BaseDataWidget.call(this,objModal,widget,area,opt));_this3.chartCogDom=undefined;return _this3;}
DataSourceData.prototype.initData=function initData(){this.store={};for(var i=0;i<this.widget.opt.variable.length;i++){this.store[this.widget.opt.variable[i].type]=this.widget.opt.variable[i];if(!this.store[this.widget.opt.variable[i].type].cog){this.store[this.widget.opt.variable[i].type].cog={upper:'',lower:'',unit:'',accuracy:'',markLine:[]};}}};DataSourceData.prototype.createWidgetDom=function createWidgetDom(opt){var divDataWorkspace=document.createElement('div');divDataWorkspace.className='divDsWorkspace';var divVar,spLabel,divTip,divVarData;for(var ele in opt.variable){divVar=document.createElement('div');divVar.className='divVar row divVar'+this.upperCaseText(opt.variable[ele].type);divVar.dataset.type=opt.variable[ele].type;spLabel=document.createElement('span');spLabel.className='spVarLabel';spLabel.textContent=opt.variable[ele].name;divVar.appendChild(spLabel);divVarData=document.createElement('div');divVarData.className='divVarData';for(var i=0;i<opt.variable[ele].data.length;i++){divVarData.appendChild(this.createDataUnitDom(opt.variable[ele].data[i]));}
divTip=this.createDataTipDom();divVarData.appendChild(divTip);divVar.appendChild(divVarData);if(opt.variable[ele].forChart!==false){divVar.appendChild(this.createChartCogBtnDom());}
divDataWorkspace.appendChild(divVar);}
divDataWorkspace.appendChild(this.createChartCogDom());return divDataWorkspace;};DataSourceData.prototype.createDataUnitDom=function createDataUnitDom(id){var divDs=document.createElement('div');divDs.className='divDs grow col-xs-4 col-lg-3';divDs.dataset.id=id;var spDs=document.createElement('span');spDs.className='spDs';var datasource=AppConfig.datasource.getDSItemById(id);spDs.textContent=datasource.alias===""?datasource.value:datasource.alias;divDs.appendChild(spDs);var spBtnDel=document.createElement('span');spBtnDel.className='glyphicon glyphicon-remove btnDsDel';divDs.appendChild(spBtnDel);return divDs;};DataSourceData.prototype.createDataTipDom=function createDataTipDom(){var divDsTip=document.createElement('div');divDsTip.className='divDs divDsTip col-xs-4 col-lg-3';var spDsTip=document.createElement('span');spDsTip.className='glyphicon glyphicon-plus';divDsTip.appendChild(spDsTip);return divDsTip;};DataSourceData.prototype.createChartCogBtnDom=function createChartCogBtnDom(){var divChartCog=document.createElement('div');divChartCog.className='grow btnChartCog glyphicon glyphicon-cog';var _this=this;divChartCog.onclick=function(e){var type=e.currentTarget.parentNode.dataset.type;_this.initChartCogData(type);_this.chartCogDom&&$(_this.chartCogDom).show();};return divChartCog;};DataSourceData.prototype.createChartCogDom=function createChartCogDom(){var panelCog=document.createElement('div');panelCog.className='panelChartCog form-horizontal';panelCog.innerHTML='\n                <div class="form-group">\n                    <label for="inputPtValUpper" class="col-xs-4 control-label" i18n="modalConfig.data.PT_UPPER">\u5750\u6807\u8F74\u4E0A\u9650</label>\n                    <div class="col-xs-6">\n                        <input type="text" class="form-control upper" data-role="upper" placeholder="">\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="inputPtValLower" class="col-xs-4 control-label" i18n="modalConfig.data.PT_LOWER">\u5750\u6807\u8F74\u4E0B\u9650</label>\n                    <div class="col-xs-6">\n                        <input type="text" class="form-control lower" data-role="lower" placeholder="">\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="inputPtUnit" class="col-xs-4 control-label" i18n="modalConfig.data.PT_UNIT">\u5750\u6807\u8F74\u5355\u4F4D</label>\n                    <div class="col-xs-6">\n                        <input type="text" class="form-control unit" data-role="unit" placeholder="">\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="inputPtAccuracy" class="col-xs-4 control-label" i18n="modalConfig.data.PT_ACCURACY">\u5C0F\u6570\u70B9\u4F4D\u6570</label>\n                    <div class="col-xs-6">\n                        <input type="text" class="form-control accuracy" data-role="accuracy" placeholder="">\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="inputLineName1" class="col-xs-4 control-label" i18n="modalConfig.data.PT_LINE_1">\u57FA\u7EBF1</label>\n                    <div class="col-xs-3">\n                        <input type="text" class="form-control inputLineName markLine-0" data-role="mkName" placeholder="TiTle">\n                    </div>\n                    <label for="inputLineVal1" class="sr-only control-label"></label>\n                    <div class="col-xs-3">\n                        <input type="text" class="form-control inputLineVal markLine-0" data-role="mkVal" placeholder="Value">\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="inputLineName2" class="col-xs-4 control-label" i18n="modalConfig.data.PT_LINE_2">\u57FA\u7EBF2</label>\n                    <div class="col-xs-3">\n                        <input type="text" class="form-control inputLineName markLine-1" data-role="mkName" placeholder="">\n                    </div>\n                    <label for="inputLineVal2" class="sr-only control-label"></label>\n                    <div class="col-xs-3">\n                        <input type="text" class="form-control inputLineVal markLine-1" data-role="mkVal"  placeholder="">\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="inputLineName3" class="col-xs-4 control-label" i18n="modalConfig.data.PT_LINE_3">\u57FA\u7EBF3</label>\n                    <div class="col-xs-3">\n                        <input type="text" class="form-control inputLineName markLine-2" data-role="mkName" placeholder="">\n                    </div>\n                    <label for="inputLineVal3" class="sr-only control-label"></label>\n                    <div class="col-xs-3">\n                        <input type="text" class="form-control inputLineVal markLine-2" data-role="mkVal" placeholder="">\n                    </div>\n                </div>\n                <div class="form-group">\n                    <label for="inputLineName4" class="col-xs-4 control-label" i18n="modalConfig.data.PT_LINE_4">\u57FA\u7EBF4</label>\n                    <div class="col-xs-3">\n                        <input type="text" class="form-control inputLineName markLine-3" data-role="mkName" placeholder="">\n                    </div>\n                    <label for="inputLineVal4" class="sr-only control-label"></label>\n                    <div class="col-xs-3">\n                        <input type="text" class="form-control inputLineVal markLine-3" data-role="mkVal" placeholder="">\n                    </div>\n                </div>\n                <span class="glyphicon glyphicon-remove btnPanelCogHide" aria-hidden="true"></span>\n                <div class="divBtnCogGrp">\n                    <button type="button" class="btn btn-primary btnCogConfirm" i18n="modalConfig.data.PT_COG_SURE">\u786E\u8BA4</button>\n                    <button type="button" class="btn btn-primary btnCogCancel" i18n="modalConfig.data.PT_COG_CANCEL">\u53D6\u6D88</button>\n                </div>\n            ';panelCog.style.display='none';var _this=this;panelCog.querySelector('.btnCogConfirm').onclick=function(){_this.setChartCogData();$(panelCog).hide();};panelCog.querySelector('.btnCogCancel').onclick=function(){$(panelCog).hide();};panelCog.querySelector('.btnPanelCogHide').onclick=function(){$(panelCog).hide();};this.chartCogDom=panelCog;return panelCog;};DataSourceData.prototype.setChartCogData=function setChartCogData(){var iptGrp=this.chartCogDom.querySelectorAll('input');for(var i=0;i<iptGrp.length;i++){if(iptGrp.dataset.role!='mkVal'&&iptGrp.dataset.role!='mkName'){this.store[this.chartCogDom.dataset.type].cog[iptGrp.dataset.role]=iptGrp;}}
this.store[this.chartCogDom.dataset.type].cog.markLine=[];for(var _i=0;_i<4;_i++){this.store[this.chartCogDom.dataset.type].cog.markLine.push({name:this.chartCogDom.querySelector('inputLineName markLine-'+(_i+1)),value:this.chartCogDom.querySelector('inputLineVal markLine-'+(_i+1))});}};DataSourceData.prototype.initChartCogData=function initChartCogData(type){var _this4=this;this.chartCogDom.dataset.type=type;Object.keys(this.store[type].cog).forEach(function(val){if(val!='markLine'){_this4.chartCogDom.querySelector('.'+val).value=_this4.store[type].cog[val];}else{for(var i=0;i<_this4.store[type].cog[val].length;i++){_this4.chartCogDom.querySelector('.inputLineName '+val+'-'+i).value=_this4.store[type].cog[val][i].name;_this4.chartCogDom.querySelector('.inputLineVal '+val+'-'+i).value=_this4.store[type].cog[val][i].value;}}});};DataSourceData.prototype.attachEvent=function attachEvent(){var _this5=this;$(this.widget.dom).find('.divVar').off('dragover').on('dragover',function(e){e.preventDefault();$(e.currentTarget).find('.divDsTip').addClass('dragover');});$(this.widget.dom).find('.divVar').off('dragleave').on('dragleave',function(e){e.preventDefault();$(e.currentTarget).find('.divDsTip').removeClass('dragover');});$(this.widget.dom).find('.divVar').off('drop').on('drop',function(e){e.preventDefault();var id=EventAdapter.getData().dsItemId;var datasource=AppConfig.datasource.getDSItemById(id);var textContent=datasource.alias===""?datasource.value:datasource.alias;var $allShowDatasource=$(e.currentTarget.querySelector('.divVarData')).find(".spDs");var num=0;$allShowDatasource.each(function(){var $thisName=$(this).text();if($thisName===textContent){num+=1;}});var divTip=e.currentTarget.querySelector('.divDsTip');$(divTip).removeClass('dragover');if(num<=0){e.currentTarget.querySelector('.divVarData').insertBefore(_this5.createDataUnitDom(id),divTip);_this5.setStore();}else{alert(I18n.resource.modalConfig.err.TYPE2);}});$(this.widget.dom).off('click').on('click','.btnDsDel',function(e){$(e.currentTarget).parent().remove();_this5.setStore();});};DataSourceData.prototype.setStore=function setStore(){var $divParam=$(this.widget.dom).find('.divVar');var $divDs;this.store={};for(var i=0;i<$divParam.length;i++){$divDs=$divParam.eq(i).find('.divDs');if(!this.store[$divParam[i].dataset.type]){this.store[$divParam[i].dataset.type]={data:[],cog:{}};}
for(var j=0;j<$divDs.length;j++){if(!$divDs[j].dataset.id)continue;this.store[$divParam[i].dataset.type].data.push($divDs[j].dataset.id);}}};return DataSourceData;}(BaseDataWidget);var DataInfoListData=function(_BaseDataWidget2){_inherits(DataInfoListData,_BaseDataWidget2);function DataInfoListData(objModal,widget,area){var opt=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};_classCallCheck(this,DataInfoListData);return _possibleConstructorReturn(this,_BaseDataWidget2.call(this,objModal,widget,area,opt));}
DataInfoListData.prototype.initData=function initData(){this.store=[];for(var i=0;i<this.widget.opt.variable.length;i++){this.store.push(this.widget.opt.variable[i]);}};DataInfoListData.prototype.createWidgetDom=function createWidgetDom(opt){var divDataBindList=document.createElement('div');divDataBindList.className='divDataBindList';var divParamAdd=document.createElement('div');divParamAdd.className='divBtnAddParam glyphicon glyphicon-plus';var _this=this;divParamAdd.onclick=function(){divDataBindList.appendChild(_this.createLiData({}));};divDataBindList.appendChild(divParamAdd);divDataBindList.appendChild(this.createDataListTtl());for(var i=0;i<opt.variable.length;i++){divDataBindList.appendChild(this.createLiData(opt.variable[i]));}
return divDataBindList;};DataInfoListData.prototype.createDataListTtl=function createDataListTtl(){var divTtl=document.createElement('div');divTtl.className='divDataListTtl flexCenter';divTtl.innerHTML='\
        <span class="spDataListTtl spDataListNameTtl">数据名称</span>\
        <span class="spDataListTtl spDataListDsTtl">数据源</span>\
        <span class="spDataListTtl spDataListUnitTtl">数据单位</span>\
        <span class="spDataListTtl spDataListScaleTtl">小数点位</span>\
        ';return divTtl;};DataInfoListData.prototype.createLiData=function createLiData(variable){var divLiDataBind=document.createElement('div');divLiDataBind.className='divDataParam form-inline flexCenter';var iptName=document.createElement('input');iptName.setAttribute('type','input');iptName.className='form-control iptName';variable.name&&(iptName.value=variable.name);var iptUnit=document.createElement('input');iptUnit.setAttribute('type','input');iptUnit.className='form-control iptUnit';variable.unit&&(iptUnit.value=variable.unit);var iptScale=document.createElement('input');iptScale.setAttribute('type','input');iptScale.className='form-control iptScale';variable.unit&&(iptScale.value=variable.Scale);var id=variable.data instanceof Array?variable.data[0]:null;var divDs=this.createDataUnitDom(id);var divParamDel=document.createElement('div');divParamDel.className='btnParamDel glyphicon glyphicon-remove';divLiDataBind.appendChild(iptName);divLiDataBind.appendChild(divDs);divLiDataBind.appendChild(iptUnit);divLiDataBind.appendChild(iptScale);divLiDataBind.appendChild(divParamDel);return divLiDataBind;};DataInfoListData.prototype.createDataUnitDom=function createDataUnitDom(id){var divDs=document.createElement('div');divDs.className='divDs grow';var spDs=document.createElement('span');spDs.className='spDs';if(id){divDs.className+=' hasDs';divDs.dataset.id=id;spDs.textContent=AppConfig.datasource.getDSItemById(id).alias===""?AppConfig.datasource.getDSItemById(id).value:AppConfig.datasource.getDSItemById(id).alias;}
divDs.appendChild(spDs);var spTip=document.createElement('span');spTip.className='spDsTip';spTip.innerHTML='\n            <span class=\'spNormalTip glyphicon glyphicon-plus\'></span>\n            <span class=\'spHoverTip\'>\u8BF7\u62D6\u62FD\u6570\u636E\u6E90\u81F3\u6B64</span>\n        ';divDs.appendChild(spTip);var spBtnDel=document.createElement('span');spBtnDel.className='glyphicon glyphicon-remove btnDsDel';divDs.appendChild(spBtnDel);return divDs;};DataInfoListData.prototype.attachEvent=function attachEvent(){$(this.widget.dom).off('dragover').on('dragover','.divDs',function(e){e.preventDefault();$(e.currentTarget).addClass('dragover');});$(this.widget.dom).off('dragleave').on('dragleave','.divDs',function(e){e.preventDefault();$(e.currentTarget).removeClass('dragover');});$(this.widget.dom).off('drop').on('drop','.divDs',function(e){e.preventDefault();$(e.currentTarget).removeClass('dragover').addClass('hasDs');var id=EventAdapter.getData().dsItemId;e.currentTarget.dataset.id=id;$(e.currentTarget).find('.spDs').text(AppConfig.datasource.getDSItemById(id).alias===""?AppConfig.datasource.getDSItemById(id).value:AppConfig.datasource.getDSItemById(id).alias);});$(this.widget.dom).off('click').on('click','.btnDsDel',function(e){$(e.currentTarget).parent().removeClass('hasDs');delete e.currentTarget.dataset.id;$(e.currentTarget).find('.spDs').text('');});$(this.widget.dom).on('click','.btnParamDel',function(e){$(e.currentTarget).parent().remove();});};DataInfoListData.prototype.getData=function getData(){var arrParamDom=this.widget.dom.querySelectorAll('.divDataParam');this.store=[];var name,unit,id,scale;var nameDom,unitDom,dsDom,scaleDom;for(var i=0;i<arrParamDom.length;i++){nameDom=arrParamDom[i].querySelector('.iptName');unitDom=arrParamDom[i].querySelector('.iptUnit');dsDom=arrParamDom[i].querySelector('.divDs');scaleDom=arrParamDom[i].querySelector('.iptScale');name=nameDom.value?nameDom.value:'';unit=unitDom.value?unitDom.value:'';scale=scaleDom.value?scaleDom.value:'';id=dsDom.dataset.id?dsDom.dataset.id:'';this.store.push({name:name,unit:unit,data:id,scale:scale});}
return this.store;};return DataInfoListData;}(BaseDataWidget);var MultiDataConfigData=function(_BaseDataWidget3){_inherits(MultiDataConfigData,_BaseDataWidget3);function MultiDataConfigData(objModal,widget,area){var opt=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};_classCallCheck(this,MultiDataConfigData);return _possibleConstructorReturn(this,_BaseDataWidget3.call(this,objModal,widget,area,opt));}
MultiDataConfigData.prototype.initData=function initData(){this.store=[];for(var i=0;i<this.widget.opt.variable.length;i++){this.store.push(this.widget.opt.variable[i]);}};MultiDataConfigData.prototype.createTitleDom=function createTitleDom(title){var opt=title?title:{};var divTitle=document.createElement('div');divTitle.className='divRoleConfigTtl clearfix';var label=document.createElement('label');label.className='divTitleLabel';label.innerHTML='标题：';var dataTitleName=document.createElement('div');dataTitleName.className='divDataTitleName';dataTitleName.innerHTML='标题数据：';var iptTtl=document.createElement('input');iptTtl.className='iptRoleTtl form-control';iptTtl.setAttribute('type','text');iptTtl.setAttribute('placeholder','请输入标题名称……');if(opt.text)iptTtl.value=opt.text;var dataSource=this.createDataUnitDom(opt.data);var iptUnit=document.createElement('input');iptUnit.className='iptRoleTtlUnit form-control';iptUnit.setAttribute('placeholder','单位');if(opt.unit)iptUnit.value=opt.unit;var iptScale=document.createElement('input');iptScale.className='iptRoleTtlScale form-control';iptScale.setAttribute('placeholder','小数点位');if(opt.scale)iptScale.value=opt.scale;divTitle.appendChild(label);divTitle.appendChild(iptTtl);divTitle.appendChild(dataTitleName);divTitle.appendChild(dataSource);divTitle.appendChild(iptUnit);divTitle.appendChild(iptScale);return divTitle;};MultiDataConfigData.prototype.createWidgetDom=function createWidgetDom(opt){var divMultiRoleWorkSpace=document.createElement('div');divMultiRoleWorkSpace.className='divMultiDataWorkSpace';for(var i=0;i<opt.variable.length;i++){divMultiRoleWorkSpace.appendChild(this.createRoleList(opt.variable[i]));}
if(opt.variable.length==0)divMultiRoleWorkSpace.appendChild(this.createRoleList());return divMultiRoleWorkSpace;};MultiDataConfigData.prototype.createRoleList=function createRoleList(){var opt=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var divRoleList=document.createElement('div');divRoleList.className='divRoleConfig';divRoleList.appendChild(this.createTitleDom(opt.title));divRoleList.appendChild(this.createDataList(opt.param));return divRoleList;};MultiDataConfigData.prototype.createDataList=function createDataList(opt){var divDataBindList=document.createElement('div');divDataBindList.className='divDataBindList';var divParamAdd=document.createElement('div');divParamAdd.className='divBtnAddParam glyphicon glyphicon-plus glyphiconPlus';var _this=this;divDataBindList.appendChild(this.createDataListTtl());divParamAdd.onclick=function(){divDataBindList.appendChild(_this.createLiData({}));};divDataBindList.appendChild(divParamAdd);if(opt instanceof Array&&opt.length>0){for(var i=0;i<opt.length;i++){divDataBindList.appendChild(this.createLiData(opt[i]));}}else{divDataBindList.appendChild(_this.createLiData({}));}
return divDataBindList;};MultiDataConfigData.prototype.createDataListTtl=function createDataListTtl(){var divTtl=document.createElement('div');divTtl.className='divDataListTtl flexCenter';var type;for(var i=0;i<this.widget.opt.param.length;i++){type=this.widget.opt.param[i].type;type=type[0].toUpperCase()+type.slice(1);divTtl.innerHTML+='\n                <span class="spDataListTtl spDataList'+type+'Ttl">'+this.widget.opt.param[i].name+'</span>\n            ';}
return divTtl;};MultiDataConfigData.prototype.createLiData=function createLiData(){var variable=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var divLiDataBind=document.createElement('div');divLiDataBind.className='divDataParam form-inline flexCenter';var paramDom,param;for(var i=0;i<this.widget.opt.param.length;i++){param=this.widget.opt.param[i].type;if(param=='data'){var id=typeof variable.data=="string"?variable.data:null;divLiDataBind.appendChild(this.createDataUnitDom(id));continue;}
paramDom=document.createElement('input');paramDom.setAttribute('type','input');paramDom.dataset.param=param;paramDom.className='form-control iptParam ipt'+param[0].toUpperCase()+param.slice(1);variable[param]&&(paramDom.value=variable[param]);divLiDataBind.appendChild(paramDom);}
var divParamDel=document.createElement('div');divParamDel.className='btnParamDel glyphicon glyphicon-remove';divLiDataBind.appendChild(divParamDel);return divLiDataBind;};MultiDataConfigData.prototype.createDataUnitDom=function createDataUnitDom(id){var divDs=document.createElement('div');divDs.className='divDs grow';var spDs=document.createElement('span');spDs.className='spDs';if(id){divDs.className+=' hasDs';divDs.dataset.id=id;spDs.textContent=AppConfig.datasource.getDSItemById(id).alias===""?AppConfig.datasource.getDSItemById(id).value:AppConfig.datasource.getDSItemById(id).alias;}
divDs.appendChild(spDs);var spTip=document.createElement('span');spTip.className='spDsTip';spTip.innerHTML='\n            <span class=\'spNormalTip glyphicon glyphicon-plus\'></span>\n            <span class=\'spHoverTip\'>\u8BF7\u62D6\u62FD\u6570\u636E\u6E90\u81F3\u6B64</span>\n        ';divDs.appendChild(spTip);var spBtnDel=document.createElement('span');spBtnDel.className='glyphicon glyphicon-remove btnDsDel';divDs.appendChild(spBtnDel);return divDs;};MultiDataConfigData.prototype.attachEvent=function attachEvent(){$(this.widget.dom).off('dragover').on('dragover','.divDs',function(e){e.preventDefault();$(e.currentTarget).addClass('dragover');});$(this.widget.dom).off('dragleave').on('dragleave','.divDs',function(e){e.preventDefault();$(e.currentTarget).removeClass('dragover');});$(this.widget.dom).off('drop').on('drop','.divDs',function(e){e.preventDefault();$(e.currentTarget).removeClass('dragover').addClass('hasDs');var id=EventAdapter.getData().dsItemId;e.currentTarget.dataset.id=id;$(e.currentTarget).find('.spDs').text(AppConfig.datasource.getDSItemById(id).alias===""?AppConfig.datasource.getDSItemById(id).value:AppConfig.datasource.getDSItemById(id).alias);});$(this.widget.dom).off('click').on('click','.btnDsDel',function(e){$(e.currentTarget).parent().removeClass('hasDs');delete e.currentTarget.parentNode.dataset.id;$(e.currentTarget).parent().find('.spDs').text('');});$(this.widget.dom).on('click','.btnParamDel',function(e){$(e.currentTarget).parent().remove();});};MultiDataConfigData.prototype.getData=function getData(){var arrRoleDom=this.widget.dom.querySelectorAll('.divRoleConfig');this.store=[];var arrDivParamDom,dsDom,arrParamDom,divRoleTtl;var dictParam=[];var roleConfig={title:{},param:[]};var id;for(var i=0;i<arrRoleDom.length;i++){roleConfig={title:{},param:[]};divRoleTtl=arrRoleDom[i].querySelector('.divRoleConfigTtl');roleConfig.title.text=divRoleTtl.querySelector('.iptRoleTtl').value;roleConfig.title.data=divRoleTtl.querySelector('.divDs').dataset.id;roleConfig.title.unit=divRoleTtl.querySelector('.iptRoleTtlUnit').value;roleConfig.title.scale=divRoleTtl.querySelector('.iptRoleTtlScale').value;if(!roleConfig.title.data)roleConfig.title.data='';arrDivParamDom=arrRoleDom[i].querySelectorAll('.divDataParam');for(var j=0;j<arrDivParamDom.length;j++){dictParam={};dsDom=arrDivParamDom[j].querySelector('.divDs');arrParamDom=arrDivParamDom[j].querySelectorAll('.iptParam');for(var k=0;k<arrParamDom.length;k++){dictParam[arrParamDom[k].dataset.param]=arrParamDom[k].value;}
id=dsDom.dataset.id?dsDom.dataset.id:'';dictParam.data=id;roleConfig.param.push(dictParam);}
this.store.push(roleConfig);}
return this.store;};return MultiDataConfigData;}(BaseDataWidget);function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}
function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}
var BaseFooterWidget=function(_BaseConfigWidget){_inherits(BaseFooterWidget,_BaseConfigWidget);function BaseFooterWidget(objModal,widget,area){_classCallCheck(this,BaseFooterWidget);return _possibleConstructorReturn(this,_BaseConfigWidget.call(this,objModal,widget,area));}
BaseFooterWidget.prototype.setWidget=function setWidget(){this.widget.dom=document.createElement('div');this.widget.dom.className='cfgWidget cfgFooterWidget div'+this.upperCaseText(this.widget.type);this.widget.dom.setAttribute('type',this.widget.type);this.initWidgetLabel();this.initWidgetAttr();this.initWidgetStyle();this.initWidgetId();this.widget.dom.appendChild(this.createWidgetDom(this.widget.opt));this.area.dom.appendChild(this.widget.dom);};return BaseFooterWidget;}(BaseConfigWidget);var ConfirmFooter=function(_BaseFooterWidget){_inherits(ConfirmFooter,_BaseFooterWidget);function ConfirmFooter(objModal,widget,area){_classCallCheck(this,ConfirmFooter);var _this3=_possibleConstructorReturn(this,_BaseFooterWidget.call(this,objModal,widget,area));_this3.defaultOpt={type:'confirm',name:'确定',opt:{needLabel:false}};return _this3;}
ConfirmFooter.prototype.createWidgetDom=function createWidgetDom(opt){var btnConfirm=document.createElement('button');btnConfirm.className='btn btn-primary btnConfirm';btnConfirm.textContent=this.widget.name;return btnConfirm;};ConfirmFooter.prototype.setData=function setData(data){this.store=data;};ConfirmFooter.prototype.attachEvent=function attachEvent(){if(typeof this.widget.func=='function'){var _this=this;this.widget.dom.onclick=function(e){var result=_this.objModal.getResult();_this.widget.func(result,_this.objModal.opt.data);};}};return ConfirmFooter;}(BaseFooterWidget);var CancelFooter=function(_BaseFooterWidget2){_inherits(CancelFooter,_BaseFooterWidget2);function CancelFooter(objModal,widget,area){_classCallCheck(this,CancelFooter);var _this4=_possibleConstructorReturn(this,_BaseFooterWidget2.call(this,objModal,widget,area));_this4.defaultOpt={type:'cancel',name:'取消',opt:{needLabel:false}};return _this4;}
CancelFooter.prototype.createWidgetDom=function createWidgetDom(opt){var btnCancel=document.createElement('button');btnCancel.className='btn btn-default btnCancel';btnCancel.textContent=this.widget.name;btnCancel.dataset.dismiss='modal';return btnCancel;};CancelFooter.prototype.attachEvent=function attachEvent(){var _this=this;if(typeof this.widget.func=='function'){this.widget.dom.onclick=function(e){_this.widget.func(e);};}else{this.widget.dom.onclick=function(e){_this.objModal.hide();};}};return CancelFooter;}(BaseFooterWidget);function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}
function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}
function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BaseConfigModule=function(){function BaseConfigModule(objModal,area){_classCallCheck(this,BaseConfigModule);this.objModal=objModal;this.area=area;this.store={};}
BaseConfigModule.prototype.init=function init(){this.initOption();this.initOptionDetail();this.initData();this.initStyle();this.attachEvent();};BaseConfigModule.prototype.attachEvent=function attachEvent(){};BaseConfigModule.prototype.initStyle=function initStyle(){if(this.area.style){this.objModal.modalStyle.innerHTML+=this.area.style;}};BaseConfigModule.prototype.initOption=function initOption(){if(this.defaultOpt){$.extend(true,this.area,this.defaultOpt,this.area);}};BaseConfigModule.prototype.initOptionDetail=function initOptionDetail(){};BaseConfigModule.prototype.initData=function initData(){};BaseConfigModule.prototype.getData=function getData(){var store;for(var i=0;i<this.area.widget.length;i++){store=this.area.widget[i].instantiation.getData();store&&(this.store[this.area.widget[i].type]=store);}
return this.store;};BaseConfigModule.prototype.destroy=function destroy(){for(var i=0;i<this.area.widget.length;i++){this.area.widget[i].instantiation.destroy();this.area.widget[i].instantiation=null;}};return BaseConfigModule;}();var TimeConfigModule=function(_BaseConfigModule){_inherits(TimeConfigModule,_BaseConfigModule);function TimeConfigModule(objModal,area){_classCallCheck(this,TimeConfigModule);var _this=_possibleConstructorReturn(this,_BaseConfigModule.call(this,objModal,area));_this.defaultOpt={name:'option',type:'option',module:'timeConfig',widget:[{type:'mode',subWidget:[{type:'interval',callback:function callback(type,store){if(type=='mode'){switch(store.val){case'0':$(this.widget.dom).hide();break;default:$(this.widget.dom).show();break;}}}},{type:'recentTimeCustom',callback:function callback(type,store){if(type=='mode'){switch(store.val){case'2':$(this.widget.dom).show();break;default:$(this.widget.dom).hide();break;}}}},{type:'recentTime',callback:function callback(type,store){if(type=='mode'){switch(store.val){case'0':$(this.widget.dom).show();break;default:$(this.widget.dom).hide();break;}}}},{type:'date',callback:function callback(type,store){if(type=='mode'){switch(store.val){case'1':$(this.widget.dom).show();break;default:$(this.widget.dom).hide();break;}}}}]},{type:'recentTimeCustom',subWidget:[{type:'interval',callback:function callback(type,store){if(type=='recentTimeCustom'){if(this.area.dom.querySelector('.divMode>select').value!='2')return;var firstSelect,secondSelect;switch(store.unit){case'second':firstSelect='m5';secondSelect='m1';break;case'minute':firstSelect='m5';secondSelect='m1';break;case'hour':firstSelect='h1';secondSelect='m5';break;case'day':firstSelect='d1';secondSelect='h1';break;case'month':firstSelect='M1';secondSelect='d1';break;}
$(this.widget.dom).find('option').hide();this.widget.dom.querySelector('select').value=firstSelect;$(this.widget.dom.querySelector('[value='+firstSelect+']')).show();$(this.widget.dom.querySelector('[value='+secondSelect+']')).show();}}}]},{type:'recentTime',subWidget:[{type:'interval',callback:function callback(type,store){if(type!='recentTime')return;if(this.area.dom.querySelector('.divMode>select').value!='0')return;var interval;switch(store.val){case'today':interval='h1';break;case'yesterday':interval='h1';break;case'thisWeek':interval='d1';break;case'lastWeek':interval='d1';break;case'thisYear':interval='M1';break;}
return interval;}}]},{type:'interval'},{type:'date',subWidget:[{type:'interval',callback:function callback(){if(this.area.dom.querySelector('.divMode>select').value!='1')return;$(this.widget.dom).find('option').show();}}]}]};return _this;}
TimeConfigModule.prototype.initOptionDetail=function initOptionDetail(){if(!this.area.opt)return;for(var i=0;i<this.area.widget.length;i++){if(!this.area.widget[i].opt)this.area.widget[i].opt={};if(this.area.opt.recentTime&&this.area.widget[i].type=='recentTime'){this.area.widget[i].opt.option=this.area.opt.recentTime;}}};TimeConfigModule.prototype.initData=function initData(){if(!this.area.data)return;for(var i=0;i<this.area.widget.length;i++){if(this.area.data.mode&&this.area.widget[i].type=='mode'){this.area.widget[i].data={val:this.area.data.mode};}
if(this.area.data.interval&&this.area.widget[i].type=='interval'){this.area.widget[i].data=this.area.data.interval;}
if(this.area.data.recentTimeCustom&&this.area.widget[i].type=='recentTimeCustom'){this.area.widget[i].data=this.area.data.recentTimeCustom;}
if(this.area.data.date&&this.area.widget[i].type=='date'){this.area.widget[i].data=this.area.data.date;}}};TimeConfigModule.prototype.getData=function getData(){for(var i=0;i<this.area.widget.length;i++){this.store[this.area.widget[i].type]=this.area.widget[i].instantiation.getData();}
var result={};if(this.store.mode.val=='0'){result={startTime:this.store.recentTime.startTime,endTime:this.store.recentTime.endTime,recentTime:this.store.recentTime.recentTime,format:this.store.recentTime.format};}else if(this.store.mode.val=='1'){result={startTime:this.store.date.startTime,endTime:this.store.date.endTime};}else if(this.store.mode.val=='2'){result={unit:this.store.recentTimeCustom.unit,val:this.store.recentTimeCustom.val};}
result.mode=this.store.mode.val;!result.format&&(result.format=this.store.interval.val);return result;};return TimeConfigModule;}(BaseConfigModule);var DataSourceDragModule=function(_BaseConfigModule2){_inherits(DataSourceDragModule,_BaseConfigModule2);function DataSourceDragModule(objModal,area){_classCallCheck(this,DataSourceDragModule);var _this2=_possibleConstructorReturn(this,_BaseConfigModule2.call(this,objModal,area));_this2.defaultOpt={name:'datasource',type:'datasource',module:'dsDrag',widget:[{type:'datasource',opt:{variable:[{type:'x',name:'X',data:[]},{type:'y',name:'Y',data:[]}]}}]};return _this2;}
DataSourceDragModule.prototype.initData=function initData(){if(!this.area.data)return;for(var i=0;i<this.area.widget.length;i++){if(this.area.widget[i].type=='datasource'){this.area.widget[i].opt.variable=this.area.data;break;}}};DataSourceDragModule.prototype.getData=function getData(){for(var i=0;i<this.area.widget.length;i++){this.store[this.area.widget[i].type]=this.area.widget[i].instantiation.getData();}
var points=[],cog=[];var arrDsParam=Object.keys(this.store['datasource']);for(var _i=0;_i<arrDsParam.length;_i++){points.push(this.store['datasource'][arrDsParam[_i]].data);cog.push(this.store['datasource'][arrDsParam[_i]].cog);}
return{points:points,chartCog:cog};};return DataSourceDragModule;}(BaseConfigModule);var DataInfoListModule=function(_BaseConfigModule3){_inherits(DataInfoListModule,_BaseConfigModule3);function DataInfoListModule(objModal,area){_classCallCheck(this,DataInfoListModule);var _this3=_possibleConstructorReturn(this,_BaseConfigModule3.call(this,objModal,area));_this3.defaultOpt={name:'dataInfoList',type:'dataInfoList',module:'dataInfoList',style:'\n                .divDataBindList .glyphicon {\n                    cursor:pointer;\n                }\n                .divDiaTitle{\n                    display: block;\n                    padding: 0;\n                    margin-top: -15px;\n                }\n                .modal-body .col-xs-2 {\n                    font-size: 16px;\n                    font-weight: bold;\n                    line-height: 34px;\n                    text-align: left;\n                    width:16.6666667%;\n                }\n                .col-xs-10{\n                    width:83.3333333%;\n                }\n                .divBtnAddParam{\n                    margin-top: 20px;\n                    left: 542px;\n                    top:20px;\n                }\n                .divBtnAddContent{\n                    left: 95%;\n                    top: -37px;\n                }\n                .divDataListTtl {\n                    font-size: 16px;\n                    margin-bottom: 20px;\n                    padding-right: 5%;\n                }\n                .spDataListTtl {\n                    width: 39%;\n                    text-align: center;\n                }\n                .spDataListNameTtl {\n                    width: 26%;\n                }\n                .spDataListUnitTtl {\n                    width: 20%;\n                }\n                .spDataListScaleTtl{\n                    width:16%;\n                }\n                .spDataListDsTtl {\n                    width: 41%;\n                }\n                .divDataParam {\n                    margin-bottom:1%;\n                }\n                .divDataParam .form-control {\n                    margin: 0 2%;\n                }\n                .divDataParam .iptName {\n                    width:26%;\n                }\n                .divDataParam .iptUnit {\n                    width:16%;\n                }\n                .divDataParam .iptScale{\n                    width:16%;\n                }\n                .divDataParam .divDs  {\n                    margin: 0 2%;\n                    width: 41%;\n                    text-align: center;\n                    color: #ccc;\n                    border: 1px dashed #ccc;\n                    height: 34px;\n                    display: inline-block;\n                    padding: 6px 15px;\n                    border-radius: 5px;\n                }\n                .divDataParam .divDs:hover  {\n                    border-color: #66afe9;\n                    cursor: pointer;\n                    outline: 0;\n                    -webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6);\n                    box-shadow: inset 0 1px 1px rgba(0,0,0,.075),0 0 8px rgba(102,175,233,.6);\n                }\n                .divDataParam .divDs.hasDs  {\n                    background-color: #fff;\n                    border: 1px solid #dcdcdc;\n                    color: #4c9f42;\n                    border-radius: 5px;\n                }\n                .divDataParam .divDs.hasDs:hover  {\n                    cursor: pointer;\n                    outline: 0;\n                    -webkit-box-shadow: none;\n                    box-shadow: none;\n                }\n                .divDataParam .divDs .spDs{\n                    display:none;\n                    white-space: nowrap;\n                    text-overflow: ellipsis;\n                    overflow: hidden;\n                    width: 90%;\n                }\n                .divDataParam .divDs .btnDsDel{\n                    display:none;\n                    top: 2px;\n                    color: #ccc;\n                    float: right;\n                }\n                .divDataParam .divDs .spHoverTip{\n                    display:none;\n                }\n                .divDataParam .divDs:hover .spNormalTip  {\n                    display:none;\n                }\n                .divDataParam .divDs:hover .spHoverTip  {\n                    display:inline-block;\n                }\n                .divDataParam .divDs.hasDs .btnDsDel  {\n                    display:inline-block;\n                }\n                .divDataParam .divDs.hasDs:hover .btnDsDel  {\n                    color: darkorange;\n                }\n                .divDataParam .divDs.hasDs .spDsTip {\n                    display:none;\n                }\n                .divDataParam .divDs.hasDs .spDs {\n                    display:inline-block;\n                }\n                .btnParamDel {\n                    width: 4%;\n                }\n                .glyphiconPlus{\n                    position:relative;\n                    top:-16px;\n                }\n            ',widget:[{type:'dataInfoList',opt:{variable:[{name:'',unit:'',data:[]}]}}]};return _this3;}
DataInfoListModule.prototype.initData=function initData(){if(!this.area.data)return;for(var i=0;i<this.area.widget.length;i++){if(this.area.widget[i].type=='dataInfoList'){this.area.widget[i].opt.variable=this.area.data;break;}}};DataInfoListModule.prototype.getData=function getData(){for(var i=0;i<this.area.widget.length;i++){this.store[this.area.widget[i].type]=this.area.widget[i].instantiation.getData();}
return{dataInfoList:this.store['dataInfoList']};};return DataInfoListModule;}(BaseConfigModule);var MultiDataConfigModule=function(_BaseConfigModule4){_inherits(MultiDataConfigModule,_BaseConfigModule4);function MultiDataConfigModule(objModal,area){_classCallCheck(this,MultiDataConfigModule);var _this4=_possibleConstructorReturn(this,_BaseConfigModule4.call(this,objModal,area));_this4.defaultOpt={name:'multiDataConfig',type:'multiDataConfig',module:'multiDataConfig',widget:[{type:'multiDataConfig',opt:{role:'',variable:[],param:[{'type':'name','name':'数据标题'},{'type':'data','name':'数据点位'},{'type':'unit','name':'数据单位'}]}}]};return _this4;}
MultiDataConfigModule.prototype.initData=function initData(){if(!this.area.data)return;for(var i=0;i<this.area.widget.length;i++){if(this.area.widget[i].type=='multiDataConfig'){if(!this.area.data)break;this.area.widget[i].opt.variable=this.area.data.variable?this.area.data.variable:[];this.area.data.param&&(this.area.widget[i].opt.param=this.area.data.param);break;}}};MultiDataConfigModule.prototype.getData=function getData(){for(var i=0;i<this.area.widget.length;i++){this.store[this.area.widget[i].type]=this.area.widget[i].instantiation.getData();}
return{dataInfoList:this.store['multiDataConfig']};};return MultiDataConfigModule;}(BaseConfigModule);var RealTimeConfigModule=function(_BaseConfigModule5){_inherits(RealTimeConfigModule,_BaseConfigModule5);function RealTimeConfigModule(objModal,area){_classCallCheck(this,RealTimeConfigModule);var _this5=_possibleConstructorReturn(this,_BaseConfigModule5.call(this,objModal,area));_this5.defaultOpt={type:'realTime',module:'realTime',widget:[{type:'refreshInterval'}],style:''};return _this5;}
return RealTimeConfigModule;}(BaseConfigModule);var GaugeConfigModule=function(_BaseConfigModule6){_inherits(GaugeConfigModule,_BaseConfigModule6);function GaugeConfigModule(objModal,area){_classCallCheck(this,GaugeConfigModule);var _this6=_possibleConstructorReturn(this,_BaseConfigModule6.call(this,objModal,area));_this6.defaultOpt={type:'gauge',module:'gauge',style:'',widget:[{type:'select',opt:{option:[{val:'high',name:'高值异常'},{val:'low',name:'低值异常'}]},subWidget:[{type:'range',callback:function callback(type,store){var iptGrp=this.widget.dom.querySelector('.input-group');if(store.val=='high'){iptGrp.insertBefore(iptGrp.querySelector('.gaugeGreen'),iptGrp.querySelectorAll('input')[1]);iptGrp.insertBefore(iptGrp.querySelector('.gaugeRed'),iptGrp.querySelectorAll('input')[3]);}else if(store.val=='low'){iptGrp.insertBefore(iptGrp.querySelector('.gaugeGreen'),iptGrp.querySelectorAll('input')[3]);iptGrp.insertBefore(iptGrp.querySelector('.gaugeRed'),iptGrp.querySelectorAll('input')[1]);}}}]},{type:'range',opt:{input:[{val:'',suffix:{text:'节能',style:{background:'lightseagreen'},cls:'gaugeGreen'}},{val:'',suffix:{text:'正常',style:{background:'#428bca'},cls:'gaugeBlue'}},{val:'',suffix:{text:'报警',style:{background:'#ff6c60'},cls:'gaugeRed'}},{val:''}]}}]};return _this6;}
GaugeConfigModule.prototype.initData=function initData(){if(!this.area.data)return;for(var i=0;i<this.area.widget.length;i++){if(this.area.widget[i].type=='select'){this.area.widget[i].opt.data=this.area.data.mode;}
if(this.area.widget[i].type=='range'){if(!(this.area.data.range instanceof Array&&this.area.data.range.length>=3))continue;this.area.widget[i].opt.input=[{val:this.area.data.range[0],suffix:{text:'节能',style:{background:'lightseagreen'},cls:'gaugeGreen'}},{val:this.area.data.range[1],suffix:{text:'正常',style:{background:'#428bca'},cls:'gaugeBlue'}},{val:this.area.data.range[2],suffix:{text:'报警',style:{background:'#ff6c60'},cls:'gaugeRed'}},{val:this.area.data.range[3]}];}}};GaugeConfigModule.prototype.getData=function getData(){for(var i=0;i<this.area.widget.length;i++){this.store[this.area.widget[i].type]=this.area.widget[i].instantiation.getData();}
return this.store;};return GaugeConfigModule;}(BaseConfigModule);var BaseFooterModule=function(_BaseConfigModule7){_inherits(BaseFooterModule,_BaseConfigModule7);function BaseFooterModule(objModal,area){_classCallCheck(this,BaseFooterModule);var _this7=_possibleConstructorReturn(this,_BaseConfigModule7.call(this,objModal,area));_this7.defaultOpt={type:'footer',module:'footer',widget:[{type:'cancel',func:function func(){}},{type:'confirm',func:function func(){}}]};return _this7;}
return BaseFooterModule;}(BaseConfigModule);var FactoryTplFooterModule=function(_BaseFooterModule){_inherits(FactoryTplFooterModule,_BaseFooterModule);function FactoryTplFooterModule(objModal,area){_classCallCheck(this,FactoryTplFooterModule);var _this8=_possibleConstructorReturn(this,_BaseFooterModule.call(this,objModal,area));_this8.defaultOpt={type:'footer',module:'factoryTplFooter',widget:[{type:'cancel'},{type:'confirm',func:_this8.createWidgetTpl}]};return _this8;}
FactoryTplFooterModule.prototype.createWidgetTpl=function createWidgetTpl(opt,data){if(!data.tpl.tplJs)return;var event=data.event;var painter=data.painter;var entity,pos;if(!data.entity){entity=THtml.prototype.createEntity();var model;entity._id=ObjectId();entity.layerId='';pos={x:event.layerX,y:event.layerY};entity.x=pos.x-50;entity.y=pos.y-25;entity.w=400;entity.h=400;entity.widgetTpl={config:data.tpl.config,tplJs:data.tpl.tplJs};data.tpl.tplJs&&eval(data.tpl.tplJs);model=new NestedModel(entity);painter.store.widgetModelSet.append(model);}else{var objEntity=data.entity;entity={};entity.widgetTpl={config:data.tpl.config,tplJs:data.tpl.tplJs};data.tpl.tplJs&&eval(data.tpl.tplJs);objEntity.property('widgetTpl');objEntity.update({'widgetTpl':entity.widgetTpl});objEntity.option($.extend(false,{},entity.option,{'html':entity.option.html,'css':entity.option.css,'js':entity.option.js}));}
painter.setActiveWidgets(entity._id);this.instantiation.objModal.hide();};return FactoryTplFooterModule;}(BaseFooterModule);var ColorConfigModule=function(_BaseConfigModule8){_inherits(ColorConfigModule,_BaseConfigModule8);function ColorConfigModule(objModal,area){_classCallCheck(this,ColorConfigModule);var _this9=_possibleConstructorReturn(this,_BaseConfigModule8.call(this,objModal,area));_this9.defaultOpt={name:'option',type:'option',module:'colorConfig',widget:[{type:'select',opt:{option:[{val:'transparent',name:'无'},{val:'#ffffff',name:'白'},{val:'#000000',name:'黑'},{val:'#337ab7',name:'蓝'},{val:'#5cb85c',name:'绿'},{val:'custom',name:'自定义'}],attr:{class:'col-xs-4 inlineBlock selBgColor'}},subWidget:[{'type':'color',callback:function callback(type,store){var iptBgColor=this.area.dom.querySelector('.iptBgColor input');var iptBgColorCfg=this.area.dom.querySelector('.iptBgColor');var bgColorView=this.area.dom.querySelector('.bgColorView input');switch(store.val){case'transparent':bgColorView.style.display='none';iptBgColorCfg.style.display='none';break;case'custom':iptBgColorCfg.style.display='inline-block';iptBgColor.value='';iptBgColor.focus();break;default:bgColorView.style.display='inline-block';bgColorView.value=store.val;iptBgColor.value=store.val;iptBgColorCfg.style.display='none';break;}}}],name:'背景颜色'},{type:'text',opt:{attr:{class:'col-xs-3 iptBgColor',placeholder:'#ffffff'}},subWidget:[{'type':'text',callback:function callback(type,store){var reg=/^#[0-9a-fA-F]{6}$/;var bgColorView=this.area.dom.querySelector('.bgColorView input');if(reg.test(store.val)){bgColorView.value=store.val;}}}],name:''},{type:'color',name:'',opt:{attr:{class:'col-xs-2 bgColorView'}}}]};return _this9;}
ColorConfigModule.prototype.initData=function initData(){};ColorConfigModule.prototype.getData=function getData(){};ColorConfigModule.prototype.attachEvent=function attachEvent(){};return ColorConfigModule;}(BaseConfigModule);var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};(function($,undefined){var util={string:{formatEL:function formatEL(str,o){if(!str||!o)return'';for(var i in o){if(o.hasOwnProperty(i)){str=str.replace(new RegExp('{'+i+'}','g'),o[i]);}}
return str;}}};function Table(ele,options){var $ele=this.$tblBody=$(ele);var id=$ele.attr('id');this.options=$.extend({},Table.DEFAULTS,options);this.$wrap=$('<div class="ui-tbl-w"></div>').insertAfter($ele);this.$hWrap=$('<div class="ui-tbl-whead"></div>').appendTo(this.$wrap);this.$bWrap=$('<div class="ui-tbl-wbody"></div>').appendTo(this.$wrap);this.$fWrap=$('<div class="ui-tbl-wfoot"></div>').appendTo(this.$wrap);this.$tblHeader=$('<table class="ui-tbl-htable table table-bordered">').appendTo(this.$hWrap);this.$tblBody=$ele.addClass('ui-tbl-btable table table-bordered').appendTo(this.$bWrap);this.$tblFooter=$('<div class="ui-tbl-footer">').appendTo(this.$fWrap);this.$thead=$('<thead>').appendTo(this.$tblHeader);this.$tbody=$('<tbody>').appendTo(this.$tblBody);typeof id==='string'&&this.$tblBody.attr('id',id);this.data=null;this.total=null;this._buildHeader();}
Table.prototype._buildHeader=function(){var prefix=this.options.colPrefix;var cols=this.options.columns;var arrHtml=[];arrHtml.push('<tr>');for(var i=0,len=cols.length;i<len;i++){arrHtml.push(util.string.formatEL('<th class="{prefix}{name}">{title}</th>',{prefix:prefix,name:cols[i].name,title:cols[i].title}));}
arrHtml.push('</tr>');this.$thead.html(arrHtml.join(''));};Table.prototype._buildFooter=function(ds){var tpl=this.options.footerTpl;this.$tblFooter.html(util.string.formatEL(tpl,{total:ds.length})).show();};Table.prototype.loading=function(){this.$tblFooter.hide();this.$tbody.html('<tr><td class="ui-tbl-col-i-info" col-span="'+this.options.columns.length+'"><img src="/static/images/ballsline.gif" alt="loading" /></td></tr>');};Table.prototype.load=function(ds){this._renderTable(ds);this.total=ds.length;this.data=ds;};Table.prototype._renderTable=function(ds){var arrHtml=[];var row=null;var cssCls=null;var formatter=null;var column=null;if(!ds||ds.length<=0){this._showNoData();return;}
for(var i=0,leni=ds.length;i<leni;i++){row=ds[i];arrHtml.push('<tr data-rowindex="'+i+'">');for(var t=0,lent=this.options.columns.length;t<lent;t++){column=this.options.columns[t];cssCls=this.options.colPrefix+column.name;arrHtml.push('<td class="'+cssCls+'">');switch(_typeof(column.formatter)){case'string':arrHtml.push(util.string.formatEL(column.formatter,row));break;case'function':arrHtml.push(column.formatter(i,row)||'');break;}
arrHtml.push('</td>');}
arrHtml.push('</tr>');}
this.$tbody.html(arrHtml.join(''));this._buildFooter(ds);};Table.prototype.filter=function(rule){var ds=this.data;var result=[];if(!rule){result=ds;}else{for(var i=0,len=ds.length;i<len;i++){for(var r in rule){if(ds[i].hasOwnProperty(r)){if(ds[i][r].toLowerCase().indexOf(rule[r].toLowerCase())>-1){result.push(ds[i]);}}}}}
this._renderTable(result);};Table.prototype.setStretchHeight=function(l){this.$bWrap.css('height',l);};Table.prototype.getData=function(){return this.data;};Table.prototype._showNoData=function(){this.$tblFooter.hide();this.$tbody.html('<tr><td class="ui-tbl-col-i-info" col-span="'+this.options.columns.length+'">no records</td></tr>');};Table.prototype.destroy=function(){};Table.DEFAULTS={colPrefix:'ui-tbl-col-',footerTpl:'<strong>{total}</strong> records in total'};function Plugin(option,args){var $this=this;var data=$this.data('ui.w.table');var options=(typeof option==='undefined'?'undefined':_typeof(option))=='object'&&option;if(!data&&option=='destroy')return;if(!data)$this.data('ui.w.table',data=new Table(this,options));if(typeof option=='string')return data[option](args);}
$.fn.table=Plugin;})(jQuery);var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var Validator=function($,undefined){var push=[].push;var rulesMap={};function RuleWrap(ele,name,rule){this.$ele=$(ele);this.name=name;this.rule=rule;this.defer=$.Deferred();this.value=this.$ele.val();};RuleWrap.prototype.valid=function(){var handler=this.rule.valid;var _this=this;var type=$.type(handler);if(type!=='function'&&type!=='string'){console.warn('rule is illigal!');return;}
else if(type==='string'&&rulesMap[handler]===undefined){console.warn('rule is not exists!');return;}
else if(type==='string'){handler=rulesMap[handler];}
return handler;};RuleWrap.prototype.success=function(){this.defer.resolveWith(this);};RuleWrap.prototype.fail=function(){this.defer.rejectWith(this);};function Validator(ele,options){if(arguments.length===0)return this;if(arguments.length===1){options=ele;ele='body';}
this.$ele=$.type(ele)==='object'?ele:$(ele);this.options=$.extend({},Validator.DEFAULTS,options);this.__merge(this,this.options.elements||[]);this.__init();return this;}
Validator.prototype.__init=function(){var $selectors;var html='<span class="glyphicon'+(this.options.icon?' glyphicon-pencil':'')+' form-control-feedback"></span>';for(var i=0,row,len=this.length;i<len;i++){row=this[i];$selectors=$.type(row['selector'])==='object'?row['selector']:$(row['selector'],this.$ele);$selectors.each(function(i,ele){var $ele=$(ele),$formGroup;$formGroup=$ele.closest('.form-group');$formGroup.addClass('has-feedback');if($formGroup.children('form-control-feedback').length===0){$(html).insertAfter($ele);}});}};Validator.prototype.valid=function(callback){var self=this;var row,results=[];var $selectors;var deferGroups=[];this.resetStatus();for(var i=0,len=this.length;i<len;i++){row=this[i];$selectors=$.type(row['selector'])==='object'?row['selector']:$(row['selector'],this.$ele);if($selectors.length===0)continue;$selectors.each(function(i,ele){var $ele=$(ele);var val=$ele.val();var defers=[];var obj;for(var t=0,len2=row.rules.length;t<len2;t++){obj=new RuleWrap(ele,row.name,row.rules[t]);defers.push(obj);}
defers[0].valid().call(defers[0],defers[0].value);defers=defers.map(function(row,i,arr){if(i+1<len2){row.defer.done(function(){arr[i+1].valid().call(arr[i+1],defers[0].value);});}
return row.defer;});deferGroups.push(defers);});}
deferGroups=deferGroups.map(function(deferGrp,i){var newDefer=$.Deferred();$.when.apply($,deferGrp).done(function(){var $ele,$formGroup;var _this,obj={};if(this.length)_this=this[0];else _this=this;$ele=_this.$ele;self.setStatus($ele,'success');obj[_this.name]=_this.value;newDefer.resolve(obj);}).fail(function(){var $ele=this.$ele,ele=$ele[0];self.setStatus($ele,'error');if(ele.timer!==null){window.clearTimeout(ele.timer);ele.timer=null;}
$ele.tooltip({placement:'top',trigger:'manual'}).attr('data-original-title',this.rule['msg']).tooltip('show');ele.timer=window.setTimeout(function($ele){return function(){$ele.tooltip('hide');$ele[0].timer=null;};}($ele),2000);newDefer.reject();});return newDefer;});return $.when.apply($,deferGroups).then(function(rs){return $.extend.apply($,[].slice.call(arguments));});};Validator.prototype.setStatus=function($ele,type){if(!this.options.icon)return;if(type==='error'){$ele.closest('.form-group').addClass('has-error').children('.form-control-feedback').removeClass(['glyphicon-ok','glyphicon-pencil'].join(' ')).addClass('glyphicon-remove');}else if(type==='success'){$ele.closest('.form-group').addClass('has-success').children('.form-control-feedback').removeClass(['glyphicon-pencil','glyphicon-remove'].join(' ')).addClass('glyphicon-ok');}};Validator.prototype.resetStatus=function(){var $selectors,row,$ele,ele,data;for(var i=0,len=this.length;i<len;i++){row=this[i];$selectors=_typeof(row['selector'])==='object'?row['selector']:$(row['selector'],this.$ele);for(var t=0,len2=$selectors.length;t<len2;t++){$ele=$selectors.eq(t);ele=$selectors[t];$ele.parents('.form-group').removeClass('has-error has-success');if(ele.timer){window.clearTimeout(ele.timer);ele.timer=null;}
if(data=$ele.data('bs.tooltip')){data.$tip.detach();}}}};Validator.prototype.filter=function(selector){return this.__seek(selector,true);};Validator.prototype.not=function(selector){return this.__seek(selector,false);};Validator.prototype.__seek=function(selector,isNeed){var results=[],ret;var eles=this.options.elements;var regx=$.type(selector)==='string'?new RegExp('^'+selector+'$'):regx;if($.type(regx)!=='regexp'){throw'selector is not a RegExp object or a string!';}
isNeed=isNeed||false;for(var i=0,len=eles.length;i<len;i++){if(!!regx.test(eles[i]['name'])===isNeed)results.push(eles[i]);}
ret=this.__merge(new this.constructor(),results);ret.prevObj=this;ret.$ele=this.$ele;ret.options=this.options;return ret;};Validator.prototype.__merge=function(newObj,arr){for(var i=0,len=arr.length;i<len;i++){push.call(newObj,arr[i]);}
return newObj;};Validator.prototype.length=0;Validator.prototype.splice=[].splice;Validator.extendRules=function(name,handler){var rules={},fn;if($.type(name)==='string')rules[name]=handler;else if($.type(name)==='object')rules=name;else return;for(var i in rules){if(!rules.hasOwnProperty(i))continue;fn=rules[i];if($.type(fn)!=='function')continue;rulesMap[i]=fn;}};Validator.extendRules({'require':function require(val){if(val.trim()==='')this.fail();else this.success();},'word':function word(val){if(/^\w+$/.test(val))this.success();else this.fail();}});Validator.DEFAULTS={tooltipDelay:2000,icon:true};return Validator;}(jQuery);var OperatingPane=function(){function OperatingPane(pointName,value,description,screen){this.pointName=pointName;this.value=value;this.description=description;this.screen=screen;this.element=undefined;this.i18=I18n.resource.observer.widgets;this.init();};OperatingPane.prototype={show:function show(){$('#dialogOperatingPane').modal({});},close:function close(){this.pointName=null;this.value=null;this.description=null;this.screen=null;this.element.parentNode.removeChild(this.element);},init:function init(){var _this=this;$("#dialogOperatingPane").remove();this.element=document.createElement("div");this.element.id="dialogOperatingPane";this.element.className="modal fade";this.element.attributes["tabindex"]=-1;this.element.attributes["role"]="dialog";this.element.attributes["aria-labelledby"]="myModalLabel";this.element.attributes["aria-hidden"]=true;var divModal=document.createElement("div");divModal.className="modal-dialog";var sb=new StringBuilder();sb.append('<div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>\
                <span class="sr-only">Close</span></button><h4 class="modal-title" id="myModalLabel" i18n="observer.widgets.ACTION_CONFIRM"></h4></div>\
                <div class="modal-body">');sb.append(I18n.resource.observer.widgets.CONFIRM).append(this.description).append("？");sb.append('</div><div class="modal-footer"></div></div>');divModal.innerHTML=sb.toString();var btnSure=document.createElement("button");btnSure.type="button";btnSure.className="btn btn-primary";btnSure.attributes["data-dismiss"]="modal";btnSure.textContent=this.i18.CONFIRM;btnSure.onclick=function(e){$("#dialogOperatingPane .modal-footer").hide();$("#dialogOperatingPane .modal-body").html(_this.i18.EXECUTING+"...");_this.initProcessBar();_this.setValue();};var btnCancel=document.createElement("button");btnCancel.type="button";btnCancel.className="btn";btnCancel.attributes["data-dismiss"]="modal";btnCancel.textContent=this.i18.CANCEL;btnCancel.onclick=function(e){$('#dialogOperatingPane').modal('hide');};this.element.appendChild(divModal);$("body").append(this.element);var $footer=$("#dialogOperatingPane .modal-footer");$footer.append(btnSure);$footer.append(btnCancel);$('#dialogOperatingPane').on('hidden.bs.modal',function(e){_this.close();});},setValue:function setValue(){var _this=this;this.updateProcess("10%： "+this.i18.START_SENDING_REQUEST+"...",10);if(AppConfig.projectId==86){WebAPI.post("/set_to_site_by_projname",{db:AppConfig.projectName,point:this.pointName,value:this.value}).done(function(result){_this.updateProcess("40%： "+_this.i18.REQUEST_SENT_CONFIRM+"...+",40);var count=1;var interval=setInterval(function(){WebAPI.post("/get_realtimedata",{proj:AppConfig.projectId,pointList:[_this.pointName]}).done(function(data){if(!data.error&&data[0].value&&data[0].value==_this.value){_this.updateProcess("100%: "+I18n.resource.observer.widgets.DATA_OPERATION_COMPLETE+"！",100);clearInterval(interval);_this.screen.refreshData({data:data});setTimeout(function(){$('#dialogOperatingPane').modal('hide');},1000);}else{if(count<5){var percen=40+count*10;_this.updateProcess(percen.toString()+"%: 第 "+count.toString()+I18n.resource.observer.widgets.TIMES_DATA_CONFIRM,40+count*10);count++;}else{_this.processError("error： "+I18n.resource.observer.widgets.FAIL_TRY_AGAIN+"！");clearInterval(interval);setTimeout(function(){$('#dialogOperatingPane').modal('hide');},1000);}}});},2000);}).error(function(result){_this.processError("error： "+I18n.resource.observer.widgets.FAIL_SEND_REQUEST);});}else{WebAPI.post("/set_realtimedata",{db:AppConfig.projectId,point:this.pointName,value:this.value}).done(function(result){_this.updateProcess("40%： "+_this.i18.REQUEST_SENT_CONFIRM+"...+",40);var count=1;var interval=setInterval(function(){WebAPI.post("/get_realtimedata",{proj:AppConfig.projectId,pointList:[_this.pointName]}).done(function(data){if(!data.error&&data[0].value&&data[0].value==_this.value){_this.updateProcess("100%: "+I18n.resource.observer.widgets.DATA_OPERATION_COMPLETE+"！",100);clearInterval(interval);_this.screen.refreshData({data:data});setTimeout(function(){$('#dialogOperatingPane').modal('hide');},1000);}else{if(count<5){var percen=40+count*10;_this.updateProcess(percen.toString()+"%: 第 "+count.toString()+I18n.resource.observer.widgets.TIMES_DATA_CONFIRM,40+count*10);count++;}else{_this.processError("error： "+I18n.resource.observer.widgets.FAIL_TRY_AGAIN+"！");clearInterval(interval);setTimeout(function(){$('#dialogOperatingPane').modal('hide');},1000);}}});},2000);}).error(function(result){_this.processError("error： "+I18n.resource.observer.widgets.FAIL_SEND_REQUEST);});}},processError:function processError(strMessage){var $bars=$("#divOperatingBar .progress-bar");$bars.removeClass("progress-bar-success");$bars.addClass("progress-bar-danger");this.updateProcess(strMessage,100);},initProcessBar:function initProcessBar(){var divProcessBar=document.createElement("div");divProcessBar.id="divOperatingBar";divProcessBar.className="progress";divProcessBar.style.height="30px";divProcessBar.style.marginTop="10px";var divBar=document.createElement("div");divBar.className="progress-bar progress-bar-success progress-bar-striped active";divBar.style.lineHeight="30px";divBar.setAttribute("role","progressbar");divBar.setAttribute("role","progressbar");divProcessBar.appendChild(divBar);$('#dialogOperatingPane .modal-body').append(divProcessBar);},updateProcess:function updateProcess(strProcess,value){var $bars=$("#divOperatingBar .progress-bar");$bars.html(strProcess);$bars.width(value+"%");}};return OperatingPane;}();var OperatingRecord=function(){function OperatingRecord(){this.init();};OperatingRecord.prototype={show:function show(){$('#dialogModal').modal({});},init:function init(){var _this=this;WebAPI.get("/static/views/observer/widgets/operatingRecord.html").done(function(resultHtml){var $dialogContent=$("#dialogContent");$dialogContent.html(resultHtml);$("#datePickerLog").datetimepicker({minView:"month",autoclose:true,todayBtn:true,initialDate:new Date()}).on('hide',function(){var $txtLogDate=$(this).find("#txtLogDate");$txtLogDate.val(timeFormat($txtLogDate.val(),timeFormatChange('yyyy-mm-dd')));});$("#txtLogDate").val(timeFormat(new Date(),timeFormatChange('yyyy-mm-dd')));$("#txtLogDate").change(function(e){_this.refreshData();});$("#btnLogPre").click(function(e){var $txtLogDate=$("#txtLogDate");var preDay=new Date($txtLogDate.val().toDate()-86400000);$txtLogDate.val(timeFormat(preDay,timeFormatChange('yyyy-mm-dd')));_this.refreshData();});$("#btnLogNext").click(function(e){var $txtLogDate=$("#txtLogDate");var nextDay=new Date($txtLogDate.val().toDate().getTime()+86400000);$txtLogDate.val(timeFormat(nextDay,timeFormatChange('yyyy-mm-dd')));_this.refreshData();});_this.refreshData();I18n.fillArea($dialogContent);});},refreshData:function refreshData(){Spinner.spin($("#dialogContent .modal-body")[0]);var _this=this;WebAPI.post("/get_operation_log",{proj:AppConfig.projectId,date:new Date($("#txtLogDate").val()).toLocaleDateString().replace(/\//g,'-')}).done(function(data){_this.renderData(data);}).always(function(){Spinner.stop();});},renderData:function renderData(data){var sb=new StringBuilder();var $txtLogDate=$("#txtLogDate");$txtLogDate.val(timeFormat($txtLogDate.val(),timeFormatChange('yyyy-mm-dd')));if(data.length&&data.length>0){for(var i=0,item,opObj,opType,opDesc;i<data.length;i++){item=data[i];if(item.content&&item.content.hasOwnProperty('name')){opType='',opDesc='';sb.append("<tr><td>").append(item.time).append("</td>");sb.append("<td>").append(item.username).append("</td>");sb.append("<td>");for(var key in item.content){if(key=='name'){opObj=item.content[key];}else if(key=='modify'){item.content[key].forEach(function(val){opType+=val.timeAt+val.pointDesc+I18n.resource.observer.widgets.MODIFIED_AS+val.pointValue+'; ';});}else{if(item.content[key]==1){opType=I18n.resource.observer.widgets.SWITCH_ON;}else{opType=I18n.resource.observer.widgets.SWITCH_OFF;}}
if(opType.length>50){opDesc='<span title="'+opType+'">'+opType.substr(0,50)+' ...'+'</span>';}else{opDesc='<span title="'+opType+'">'+opType+'</span>';}}
sb.append(opObj).append('\t').append(opDesc).append("</td></tr>");}else if(item.content&&item.content.hasOwnProperty('desc')){sb.append("<tr><td>").append(item.time).append("</td>");sb.append("<td>").append(item.username).append("</td>");sb.append("<td>").append(item.content.desc).append("</td></tr>");}}}else{sb.append("<tr><td colspan=3 i18n='observer.widgets.NO_OPERATIONS_TODAY'></td></tr>");}
$("#tableOperatingRecord tbody").html(sb.toString());function getChildrenIndex(ele){if(!ele)return;var i=0;while(ele=ele.previousElementSibling){i++;}
return i;}}};return OperatingRecord;}();var HistoryChart=function(){function HistoryChart(obj){this.allData=obj.data;this.historyData=$.extend(true,{},this.allData);this.startDate=obj.startDate;this.endDate=obj.endDate;this.projectId=obj.projectId;this.pointList=obj.pointList||[];this.hidePointList=obj.hidePointList||[];this.format=obj.format;this.$dialogContent=$("#dialogContent");this.historyChart=null;this.ExpertContainerUrlPromise=$.Deferred();this.isShowRepairData=obj.isShowRepairData;this.repareDataKey=null;this.treeList=[];}
HistoryChart.prototype={show:function show(){var _this=this;$('#dialogModal').one('hidden.bs.modal',function(){$(this).find('#dialogContent').removeClass('historyChartBigModel');_this.close();_this.repairDataInterval&&clearInterval(_this.repairDataInterval);}).one('shown.bs.modal',function(){_this.$dialogContent.addClass('historyChartBigModel');_this.init();}).modal({backdrop:'static'});},close:function close(){this.historyChart&&this.historyChart.dispose&&this.historyChart.dispose();this.historyChart=null;this.$dialogContent.empty();this.allData=null;this.historyData=null;this.startDate=null;this.endDate=null;this.projectId=null;this.pointList=null;this.format=null;$('#curveDateStart').datetimepicker('remove');$('#curveDateEnd').datetimepicker('remove');},init:function init(){var _this=this;$('[data-toggle="tooltip"]').tooltip();this.ExpertContainerUrlPromise=$.ajax({url:"/getExpertContainerUrl",type:"GET"});return WebAPI.get("/static/views/observer/widgets/historyChart.html").done(function(resultHtml){_this.$dialogContent.html(resultHtml);if(window.localStorage.getItem("systemSkin_"+AppConfig.userId)=="default"){$('.modal-content').addClass('default');}else{$('.modal-content').addClass('dark');}
if(!_this.isShowRepairData){$('#repairData').hide();}
I18n.fillArea(_this.$dialogContent);_this.refreshDateTimePicker();_this.loadTree();_this.refreshData();_this.renderFilter();_this.attachEvent();});},getNotHidePoint:function getNotHidePoint(){var _this=this;this.pointList.filter(function(n){return _this.hidePointList.indexOf(n)==-1;});},attachEvent:function attachEvent(){var _this=this;var $curveDateStart=$("#curveDateStart"),$curveDateEnd=$("#curveDateEnd"),$intervalType=$("#intervalType");this.$dialogContent.off('click.filterCurveConfirm').on('click.filterCurveConfirm','#filterCurveConfirm',function(){var startTime=$curveDateStart.val(),endTime=$curveDateEnd.val(),format=$intervalType.val();if(!startTime){alert(I18n.resource.common.START_TIME_REQUIRED);return;}
if(!endTime){alert(I18n.resource.common.END_TIME_REQUIRED);return;}
if(endTime<startTime){alert(I18n.resource.common.TIME_COMPARE);return;}
_this.startDate=startTime;_this.endDate=endTime;_this.format=format;localStorage.setItem('dataManagerStartDate',startTime);localStorage.setItem('dataManagerEndDate',endTime);localStorage.setItem('dataManagerFormat',format);_this.fetchData();}).off('click.searchCurveOfTime').on('click.searchCurveOfTime','.searchCurveOfTime',function(){var dateType=$(this).attr('dateType');if(dateType==='hour'){_this.format='m5';}else if(dateType==='today'){_this.format='m5';}else if(dateType==='week'){_this.format='h1';}else if(dateType==='month'){_this.format='h1';}
_this.startDate=_this.getStartTime(dateType);_this.endDate=new Date().format("yyyy-MM-dd HH:mm:00");$curveDateStart.val(_this.startDate);$curveDateEnd.val(_this.endDate);$intervalType.val(_this.format);localStorage.setItem('dataManagerStartDate',_this.startDate);localStorage.setItem('dataManagerEndDate',_this.endDate);localStorage.setItem('dataManagerFormat',_this.format);_this.fetchData();}).off('click.repairData').on('click.repairData','#repairData',function(){var $self=$(this);if($self.hasClass('disable')){return;}
var start,end;try{var xAxis=_this.historyChart.getModel().option.xAxis[0];start=xAxis.data[xAxis.rangeStart]||xAxis.data[0];end=xAxis.data[xAxis.rangeEnd]||xAxis.data[xAxis.data.length-1];}catch(e){console.warn(e);start=$("#curveDateStart").val();end=$("#curveDateEnd").val();}
infoBox.confirm(I18n.resource.dataManage.SURE_TO_GENERATE_DATA+' '+start+' '+I18n.resource.dataManage.TO+' '+end+' '+I18n.resource.dataManage.INTERVAL_AS+' '+$intervalType.val()+' '+I18n.resource.dataManage.OF_DATA,function(){_this.ExpertContainerUrlPromise.done(function(result){if(result.success){$.ajax({url:result.data+'repairData/batch',type:"POST",data:{'list':JSON.stringify(_this.pointList),'timeFrom':start,'timeTo':end,'projId':_this.projectId,'format':$intervalType.val(),'userId':AppConfig.userId}}).done(function(isStartResult){$self.addClass('disable');if(isStartResult.length==24){_this.repareDataKey=isStartResult;var repairDataToolTip;_this.repairDataInterval=setInterval(function(){$.ajax({url:result.data+"repairData/status/"+AppConfig.projectId,type:'GET'}).done(function(repairDataResult){var percent=0;if(repairDataResult&&repairDataResult[_this.repareDataKey]){percent=repairDataResult[_this.repareDataKey].percent;}
repairDataToolTip&&repairDataToolTip.tooltip('destroy');repairDataToolTip=$('#repairData').tooltip({container:'body',trigger:'hover focus',html:true,placement:'bottom',template:'<div class="tooltip" role="tooltip">'+'<div class="tooltip-arrow"></div>'+'<div class="tooltip-inner"></div>'+'</div>',title:I18n.resource.dataManage.GENERATE_DATA_FROM+' '+start+' '+I18n.resource.dataManage.TO+' '+end+' '+I18n.resource.dataManage.INTERVAL_AS+' '+$intervalType.val()+' '+I18n.resource.dataManage.OF_DATAS+I18n.resource.dataManage.PROGRESS+' '+percent});$self.text(I18n.resource.dataManage.GENERATE_DATA+' '+percent);if(parseInt(percent)==100){repairDataToolTip&&repairDataToolTip.tooltip('destroy');_this.repairDataInterval&&clearInterval(_this.repairDataInterval);$self.text(I18n.resource.dataManage.GENERATE_DATA);$self.removeClass('disable');alert(I18n.resource.debugTools.sitePoint.COMPLEMENT_HAS_BEEN_COMPLETED);}}).fail(function(e){$self.text(I18n.resource.dataManage.GENERATE_DATA);$self.removeClass('disable');_this.serverRequestError(e);});},3000);}}).fail(function(e){_this.serverRequestError(e);});}else{alert('server busy:can\'t get the Expert Container service url.');}});});});},loadTree:function loadTree(){var zTreeSetting={view:{selectedMulti:false,showIcon:false},check:{enable:true},data:{simpleData:{enable:true}},callback:{onCheck:this.zTreeOnCheck.bind(this),beforeClick:this.zTreeBeforeClick,onClick:this.zTreeClick.bind(this)}};this.changeToZTreeNodes();this.zTreeInstance=$.fn.zTree.init($("#hcPointTree"),zTreeSetting,this.treeList);},changeToZTreeNodes:function changeToZTreeNodes(){for(var i=0;i<this.pointList.length;i++){var data=this.pointList[i];var item={};item.id=ObjectId();item.name=data;item.pId=1;$.inArray(data,this.hidePointList)!==-1?item.checked=false:item.checked=true;this.treeList.push(item);}
this.treeList.push({id:1,pId:0,name:"all",open:true,checked:true});},zTreeBeforeClick:function zTreeBeforeClick(){return true;},zTreeClick:function zTreeClick(e,treeId,treeNode){this.zTreeInstance.checkNode(treeNode,null,true,true);},zTreeOnCheck:function zTreeOnCheck(e,treeId,treeNode){if(treeNode){if(treeNode.isParent){if(treeNode.checked){this.historyData.data=$.extend(true,{},this.allData.data);this.hidePointList=[];}else{this.historyData.data={};if(treeNode.children&&treeNode.children.length){for(var i=0,iLen=treeNode.children.length;i<iLen;i++){$('#'+treeNode.children[i].tId+'_span').css('color','#fff');}}}}else{for(var prop in this.allData.data){if(prop==treeNode.name){if(treeNode.checked){this.historyData.data[prop]=this.allData.data[prop];if($.inArray(treeNode.name,this.hidePointList)!==-1){for(var i=0;i<this.hidePointList.length;i++){if(treeNode.name==this.hidePointList[i]){this.hidePointList.splice(i,1);break;}}}}else{delete this.historyData.data[prop];$('#'+treeNode.tId+'_span').css('color','#fff');}
break;}}}}
this.refreshData();},serverRequestError:function serverRequestError(mes){console.log(mes);alert(I18n.resource.debugTools.sitePoint.SERVER_REQUEST_FAILED);},getStartTime:function getStartTime(dateType){var date=new Date();if(dateType==='hour'){return new Date(date.getTime()-60*60*1000).format('yyyy-MM-dd HH:mm:00');}else if(dateType==='today'){return date.format('yyyy-MM-dd 00:00:00');}else if(dateType==='week'){var getDay=date.getDay()==0?7:date.getDay();return new Date(date-(getDay-1)*86400000).format('yyyy-MM-dd 00:00:00');}else if(dateType==='month'){return new Date(date.getFullYear(),date.getMonth(),1).format('yyyy-MM-dd 00:00:00');}},fetchData:function fetchData(){var _this=this;Spinner.spin(this.$dialogContent.get(0));WebAPI.post("/get_history_data_padded_reduce",{projectId:_this.projectId,pointList:this.pointList,timeStart:this.startDate.format("yyyy-MM-dd HH:mm:00"),timeEnd:this.endDate.format("yyyy-MM-dd HH:mm:00"),timeFormat:this.format?this.format:'m5'}).done(function(data){if(!data||data=={}){data=[];}
try{_this.allData=data;_this.historyData=$.extend(true,{},_this.allData);var treeObj=$.fn.zTree.getZTreeObj("hcPointTree");var nodes=treeObj.getCheckedNodes(true);var nodeNamelist=[];for(var i=0;i<nodes.length;i++){if(!nodes[i].isParent){nodeNamelist.push(nodes[i].name);}}
for(var prop in _this.historyData.data){if($.inArray(prop,nodeNamelist)===-1){delete _this.historyData.data[prop];}}
_this.refreshData();}catch(e){console.error(e);}}).fail(function(){alert(I18n.resource.observer.widgets.HISTORY_CURVE_FAILED);}).always(function(){Spinner.stop();});},renderFilter:function renderFilter(){$('#curveDateStart').val(this.startDate.format("yyyy-MM-dd HH:mm:00"));$('#curveDateEnd').val(this.endDate.format("yyyy-MM-dd HH:mm:00"));$('#intervalType').val(this.format);},refreshDateTimePicker:function refreshDateTimePicker(){$("#curveDateStart").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:00'});$("#curveDateEnd").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:00'});},refreshData:function refreshData(){var legends=[],series=[];var $tableOperatingRecord=$('#tableOperatingRecord');if(!this.historyData||!this.historyData.data){$tableOperatingRecord.empty();return;}else{var pointIndex=0;var len=echarts.config.color.length;for(var pointName in this.historyData.data){if(this.historyData.data.hasOwnProperty(pointName)){var color=echarts.config.color[pointIndex%len];if($.inArray(pointName,this.hidePointList)===-1){var treeNode=this.zTreeInstance.getNodeByParam('name',pointName,null);$('#'+treeNode.tId+'_span').css('color',color);}
pointIndex++;legends.push(pointName);series.push({name:pointName,type:'line',data:this.historyData.data[pointName],markPoint:{data:[{type:'max',name:I18n.resource.observer.widgets.MAXIMUM},{type:'min',name:I18n.resource.observer.widgets.MINIMUM}]}});}}}
var legends_handled=[];for(var l=0,l_length=legends.length;l<l_length;l++){legends_handled.push(legends[l]);if((l+1)%3===0){legends_handled.push('');}}
var hidePointListMap={};for(var i=0;i<this.hidePointList.length;i++){var key=this.hidePointList[i];hidePointListMap[key]=false;}
var option={title:{text:I18n.resource.dataManage.HISTORY_CURVE,x:'left'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{type:'dashed',width:1}}},legend:{x:'center',selected:hidePointListMap},toolbox:{show:true,feature:{mark:{show:true,title:"mark"},dataZoom:{show:true,readOnly:false,title:{zoom:"zoom",back:"back"}},dataView:{show:true,readOnly:false,title:I18n.resource.echarts.DATAVIEW,lang:[I18n.resource.echarts.DATAVIEW,I18n.resource.echarts.CLOSE,I18n.resource.echarts.REFRESH]},restore:{show:true,title:"restore"},saveAsImage:{show:true,title:"saveAsImage"}}},dataZoom:[{show:true,type:'slider',textStyle:{color:'#fff'}}],xAxis:[{type:'category',data:this.historyData.timeStamp}],yAxis:[{type:'value',scale:true}],grid:{containLabel:true},series:series};$tableOperatingRecord.css('width',($tableOperatingRecord.parent().width()*0.83).toFixed(1)+'px');this.historyChart=echarts.init($tableOperatingRecord.get(0),AppConfig.chartTheme);this.historyChart.setOption(option);},optionToContent:function optionToContent(opt){var axisData=opt.xAxis&&opt.xAxis[0].data,series=opt.series;var html='<div class="historyDataTable"><table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';if(BEOPUtil.isUndefined(axisData)){html+='<tr>';for(var i=0,l=series.length;i<l;i++){html+='<td colspan="2">'+series[i].name+'</td>';}
html+='</tr>';var longestSeriesData=[],longestLength=0;for(var j=0,sl=series.length;j<sl;j++){if(series[j].data.length>longestLength){longestSeriesData=series[j].data;longestLength=longestSeriesData.length;}}
for(var i=0,il=longestSeriesData.length;i<il;i++){html+='<tr>';for(var m=0,ml=series.length;m<ml;m++){if(!BEOPUtil.isUndefined(series[m].data[i])){for(var n=0,nl=series[m].data[i].length;n<nl;n++){html+='<td>'+series[m].data[i][n]+'</td>';}}}
html+='</tr>';}}else{html+='<tr><td>'+opt.xAxis[0].name+'</td>';for(var i=0,l=series.length;i<l;i++){html+='<td>'+series[i].name+'</td>';}
html+='</tr>';for(var i=0,l=axisData.length;i<l;i++){html+='<tr>'+'<td>'+axisData[i]+'</td>';for(var j=0,sl=series.length;j<sl;j++){html+='<td>'+series[j].data[i]+'</td>';}
html+='</tr>';}}
html+='</tbody></table></div>';return html;}};return HistoryChart;}();var UploadFile=function(){function UploadFile(data){this.init();this.m_data=data;};UploadFile.prototype={show:function show(){$('#dialogModal').modal({});},init:function init(){var _this=this;WebAPI.get("/static/views/observer/widgets/uploadFile.html").done(function(resultHtml){$("#dialogContent").html(resultHtml);_this.refreshData();$("#btn_write_pt").click(function(e){var ptList=[];var name;var value;var row;$(".chkPtSel").each(function(){name=$(this).closest('tr').find('.ptName').text();value=$(this).closest('tr').find('.ptValue').text();row={pointName:name,pointValue:value};ptList.push(row);});if(0==ptList.length){alert(I18n.resource.observer.widgets.PLEASE_SELECT_POINT+"！");return;}
WebAPI.post("/update_realtimedata_input_value",{project:AppConfig.projectName,listInfo:ptList}).done(function(result){}).error(function(e){alert(I18n.resource.observer.widgets.UPDATE_TABLE+"realtimedata_input"+I18n.resource.observer.widgets.FAILED+"！");Spinner.stop();});});$("#chk_all_sel").click(function(e){var state=$("#chk_all_sel").is(":checked");var arr=document.getElementsByClassName('chkFlag');for(var i=0;i<arr.length;i++){arr[i].checked=state;}});});},refreshData:function refreshData(){this.initData(this.m_data);},initData:function initData(data){var table=$("#tableOperatingRecord tbody");var tr;var td;var jsonData=JSON.parse(data);if(jsonData.length&&jsonData.length>0){for(var i=0;i<jsonData.length;i++){tr=document.createElement('tr');td=document.createElement('td');td.className='chkPtSel';td.innerHTML="<input type='checkbox' class='chkFlag' />";tr.appendChild(td);td=document.createElement('td');td.className='ptName';td.innerHTML=jsonData[i][0].name;tr.appendChild(td);td=document.createElement('td');td.className='ptValue';td.innerHTML=jsonData[i][1].value;tr.appendChild(td);table.append(tr);}}else{table.append("<tr><td colspan=3 i18n='observer.widgets.NO_DATA_READ'></td></tr>");}}};return UploadFile;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};;(function(e,d,a,f){var b=e.fn.twbsPagination;var c=function c(j,h){this.$element=e(j);this.options=e.extend({},e.fn.twbsPagination.defaults,h);if(this.options.startPage<1||this.options.startPage>this.options.totalPages){throw new Error("Start page option is incorrect");}this.options.totalPages=parseInt(this.options.totalPages);if(isNaN(this.options.totalPages)){throw new Error("Total pages option is not correct!");}this.options.visiblePages=parseInt(this.options.visiblePages);if(isNaN(this.options.visiblePages)){throw new Error("Visible pages option is not correct!");}if(this.options.totalPages<this.options.visiblePages){this.options.visiblePages=this.options.totalPages;}if(this.options.onPageClick instanceof Function){this.$element.first().bind("page",this.options.onPageClick);}if(this.options.href){var g,k=this.options.href.replace(/[-\/\\^$*+?.|[\]]/g,"\\$&");k=k.replace(this.options.hrefVariable,"(\\d+)");if((g=new RegExp(k,"i").exec(d.location.href))!=null){this.options.startPage=parseInt(g[1],10);}}var i=typeof this.$element.prop==="function"?this.$element.prop("tagName"):this.$element.attr("tagName");if(i==="UL"){this.$listContainer=this.$element;}else{this.$listContainer=e("<ul></ul>");}this.$listContainer.addClass(this.options.paginationClass);if(i!=="UL"){this.$element.append(this.$listContainer);}this.render(this.getPages(this.options.startPage));this.setupEvents();return this;};c.prototype={constructor:c,destroy:function destroy(){this.$element.empty();this.$element.removeData("twbs-pagination");this.$element.unbind("page");return this;},show:function show(g){if(g<1||g>this.options.totalPages){throw new Error("Page is incorrect.");}this.render(this.getPages(g));this.setupEvents();this.$element.trigger("page",g);return this;},buildListItems:function buildListItems(g){var j=e();if(this.options.first){j=j.add(this.buildItem("first",1));}if(this.options.prev){var l=g.currentPage>1?g.currentPage-1:this.options.loop?this.options.totalPages:1;j=j.add(this.buildItem("prev",l));}for(var h=0;h<g.numeric.length;h++){j=j.add(this.buildItem("page",g.numeric[h]));}if(this.options.next){var k=g.currentPage<this.options.totalPages?g.currentPage+1:this.options.loop?1:this.options.totalPages;j=j.add(this.buildItem("next",k));}if(this.options.last){j=j.add(this.buildItem("last",this.options.totalPages));}return j;},buildItem:function buildItem(i,j){var h=e("<li></li>"),k=e("<a></a>"),g=null;switch(i){case"page":g=j;h.addClass(this.options.pageClass);break;case"first":g=this.options.first;h.addClass(this.options.firstClass);break;case"prev":g=this.options.prev;h.addClass(this.options.prevClass);break;case"next":g=this.options.next;h.addClass(this.options.nextClass);break;case"last":g=this.options.last;h.addClass(this.options.lastClass);break;default:break;}h.data("page",j);h.data("page-type",i);h.append(k.attr("href",this.makeHref(j)).html(g));return h;},getPages:function getPages(j){var g=[];var k=Math.floor(this.options.visiblePages/2);var l=j-k+1-this.options.visiblePages%2;var h=j+k;if(l<=0){l=1;h=this.options.visiblePages;}if(h>this.options.totalPages){l=this.options.totalPages-this.options.visiblePages+1;h=this.options.totalPages;}var i=l;while(i<=h){g.push(i);i++;}return{currentPage:j,numeric:g};},render:function render(g){this.$listContainer.children().remove();this.$listContainer.append(this.buildListItems(g));var h=this.$listContainer.children();h.filter(function(){return e(this).data("page")===g.currentPage&&e(this).data("page-type")==="page";}).addClass(this.options.activeClass);h.filter(function(){return e(this).data("page-type")==="first";}).toggleClass(this.options.disabledClass,g.currentPage===1);h.filter(function(){return e(this).data("page-type")==="last";}).toggleClass(this.options.disabledClass,g.currentPage===this.options.totalPages);h.filter(function(){return e(this).data("page-type")==="prev";}).toggleClass(this.options.disabledClass,!this.options.loop&&g.currentPage===1);h.filter(function(){return e(this).data("page-type")==="next";}).toggleClass(this.options.disabledClass,!this.options.loop&&g.currentPage===this.options.totalPages);},setupEvents:function setupEvents(){var g=this;this.$listContainer.find("li").each(function(){var h=e(this);h.off();if(h.hasClass(g.options.disabledClass)||h.hasClass(g.options.activeClass)){h.click(function(i){i.preventDefault();});return;}h.click(function(i){!g.options.href&&i.preventDefault();g.show(parseInt(h.data("page"),10));});});},makeHref:function makeHref(g){return this.options.href?this.options.href.replace(this.options.hrefVariable,g):"#";}};e.fn.twbsPagination=function(i){var h=Array.prototype.slice.call(arguments,1);var k;var l=e(this);var j=l.data("twbs-pagination");var g=(typeof i==="undefined"?"undefined":_typeof(i))==="object"&&i;if(!j){l.data("twbs-pagination",j=new c(this,g));}if(typeof i==="string"){k=j[i].apply(j,h);}return k===f?l:k;};e.fn.twbsPagination.defaults={totalPages:0,startPage:1,visiblePages:5,href:false,hrefVariable:"{{number}}",first:"First",prev:"Previous",next:"Next",last:"Last",loop:false,onPageClick:null,paginationClass:"pagination",nextClass:"next",prevClass:"prev",lastClass:"last",firstClass:"first",pageClass:"page",activeClass:"active",disabledClass:"disabled"};e.fn.twbsPagination.Constructor=c;e.fn.twbsPagination.noConflict=function(){e.fn.twbsPagination=b;return this;};})(jQuery,window,document);var AlarmLogging=function(){var _this=this;var ALARM_RULE_NAME='alarm_rules';var alarmMode={LIMIT_VALUE:0,LIMIT_VALUE_TITLE:'Limit-Value Alarm Mode',BOOL:1,BOOL_TITLE:'Bool Alarm Mode',DIAGNOSIS:2,DIAGNOSIS_TITLE:'Diagnosis Alarm Mode'};var util={checkbox:{selectAll:function selectAll($eles){$eles.each(function(){var $this=$(this);if(!$this.is(':checked'))$this.prop('checked',true);});},selectInverse:function selectInverse($eles){$eles.each(function(i){var $this=$(this);$this.prop('checked',$this.is(':checked')?false:true);});},unSelectAll:function unSelectAll($eles){$eles.each(function(i){var $this=$(this);if($this.is(':checked'))$this.prop('checked',false);});},isAllChecked:function isAllChecked($eles){return $eles.not(':checked').length<=0;},keepOneCheckbox:function keepOneCheckbox($cbs){var $checkedCb=$cbs.filter(':checked');if($checkedCb.length<=1){$checkedCb.prop('disabled',true);}else{$cbs.prop('disabled',false);}}}};function AlarmLogging(){_this=this;this.timer=null;this.onmessage_global=BackgroundWorkers.alarmReporter.onmessage;this.validator=null;}
AlarmLogging.prototype={show:function show(){Spinner.spin(ElScreenContainer);$("#ulPages li").removeClass("active");$("#page-DataWatch").parent().addClass("active");WebAPI.get("/static/views/observer/widgets/alarmLogging.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.init();}).always(function(){Spinner.stop();});},init:function init(){this.$alarmLoggingPane=$('#alarmLoggingPane');this.$btnClose=$('#btnClose');this.$iptStartTime=$('#iptStartTime');this.$iptEndTime=$('#iptEndTime');this.$panelLog=$('#panelLog');this.$tbAlarm=$('#tbAlarm');this.$btnAlarmSrch=$('#btnAlarmSrch');this.$btnReload=$('#btnReload');this.$spLoading=this.$btnReload.children('span');this.$btnCog=$('#btnConfig');this.$btnAddRule=$('#btnAddRule');this.$btnDelRule=$('#btnDelRule');this.$tbRule=$('#tbRule');this.$panelCog=$('#panelCog');this.$btnRuleSrch=$('#btnRuleSrch');this.$iptRuleSrch=$('#iptRuleSrch');this.$btnLogList=$('#btnLogList');this.$btnSelectAll=$('#btnSelectAll');this.$cbSelectAll=this.$btnSelectAll.children('input');this.$lkSelectAll=$('#lkSelectAll');this.$lkSelectInverse=$('#lkSelectInverse');this.$lkUnSelectAll=$('#lkUnSelectAll');this.$ruleModal=$('#ruleModal');this.$divRuleForm=$('#divRuleForm');this.$divAlarmInfo=$('#divAlarmInfo');this.$divRuleEnable=$('#divRuleEnable');this.$divRuleValue=$('#divRuleValue');this.$divAlarmLevel=$('#divAlarmLevel');this.$cbLL=$('#cbLL');this.$cbL=$('#cbL');this.$cbH=$('#cbH');this.$cbHH=$('#cbHH');this.$iptLL=$('#iptLL');this.$iptL=$('#iptL');this.$iptH=$('#iptH');this.$iptHH=$('#iptHH');this.$iptLLInfo=$('#iptLLInfo');this.$iptLInfo=$('#iptLInfo');this.$iptHInfo=$('#iptHInfo');this.$iptHHInfo=$('#iptHHInfo');this.$iptPointName=$('#iptPointName');this.$iptAlarmInfo=$('#iptAlarmInfo');this.$iptAlarmLevel=$('#iptAlarmLevel');this.$btnRuleSubmit=$('#btnRuleSubmit');this.$divFormTip=$('#divFormTip');this.$ddAlarmMode=$('#ddAlarmMode');this.$btnAlarmMode=this.$ddAlarmMode.find('button');this.$spAlarmModeTitle=this.$btnAlarmMode.find('span').eq(0);this.$lkAlarmModeItems=this.$ddAlarmMode.find('ul>li>a');$(".form-datetime").datetimepicker({format:'yyyy-mm-dd hh:ii:ss',autoclose:true,todayBtn:true,minuteStep:20});this.attachEvents();this.initTable();this.resize();this.$iptEndTime.val(new Date().format('yyyy-MM-dd HH:mm:ss')).datetimepicker('update');this.startAutoload();this.initFormValidation();},startAutoload:function startAutoload(runAtStart){runAtStart=runAtStart===undefined||runAtStart===null?true:runAtStart;runAtStart&&this.$btnReload.trigger('click');BackgroundWorkers.alarmReporter.onmessage=function(e){var rs=e.data;if(rs.status==='LOADING'){_this.$tbAlarm.table('loading');_this.$spLoading.addClass('loading');return;}
_this.reloadRecord(rs.data);_this.onmessage_global(e);};},stopAutoload:function stopAutoload(){BackgroundWorkers.alarmReporter.onmessage=this.onmessage_global;},initTable:function initTable(){this.$tbAlarm.table({columns:[{name:'no',title:'No',formatter:function formatter(i,row){return i+1;}},{name:'time',title:'Time',formatter:'{time}'},{name:'bindpointname',title:'Point Name',formatter:'{bindpointname}'},{name:'info',title:'Info',formatter:'{info}'},{name:'level',title:'Level',formatter:function formatter(i,row){switch(row['level']){case 1:case 2:return'<span class="label label-warning">Warning</span>';case 3:case 4:default:return'<span class="label label-danger">Danger</span>';}}},{name:'operations',title:'Operations',formatter:'\
                    <div class="dropdown">\
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">\
                            Delay this alarm <span class="caret"></span>\
                        </button>\
                        <ul class="dropdown-menu" role="menu">\
                            <li data-value="30"><a href="javascript:">Delay 30 minutes</a></li>\
                            <li data-value="60"><a href="javascript:">Delay 1 hour</a></li>\
                            <li data-value="180"><a href="javascript:">Delay 3 hours</a></li>\
                            <li data-value="360"><a href="javascript:">Delay 6 hours</a></li>\
                            <li data-value="1440"><a href="javascript:">Delay 1 day</a></li>\
                        </ul>\
                    </div>'}]});this.$tbRule.table({columns:[{name:'cb',title:'',formatter:function formatter(i,row){return'<input type="checkbox" data-rowindex="'+i+'" />';}},{name:'pointname',title:'Point',formatter:'{pointname}'},{name:'warningtype',title:'Warning Type',formatter:function formatter(i,row){switch(row['boolwarning']){case alarmMode.LIMIT_VALUE:return alarmMode.LIMIT_VALUE_TITLE;case alarmMode.BOOL:return alarmMode.BOOL_TITLE;default:return'Unknow';}}},{name:'warninglevel',title:'Warning Level',formatter:'{boolwarninglevel}'},{name:'warningvalue',title:'Warning Value',formatter:function formatter(i,row){var arrHtml=[];switch(row['boolwarning']){case alarmMode.LIMIT_VALUE:arrHtml.push('LL: '+(row['LLEnable']===1?row['LLLimit']:'disabled'));arrHtml.push('L: '+(row['LEnable']===1?row['LLimit']:'disabled'));arrHtml.push('H: '+(row['HEnable']===1?row['HLimit']:'disabled'));arrHtml.push('HH: '+(row['HHEnable']===1?row['HHLimit']:'disabled'));return arrHtml.join('<br/>');case alarmMode.BOOL:return'/';default:return'/';}}},{name:'warninginfo',title:'Warning Info',formatter:function formatter(i,row){var arrHtml=[];switch(row['boolwarning']){case alarmMode.LIMIT_VALUE:arrHtml.push('LL: '+(row['LLEnable']===1?row['LLwarninginfo']:'disabled'));arrHtml.push('L: '+(row['LEnable']===1?row['Lwarninginfo']:'disabled'));arrHtml.push('H: '+(row['HEnable']===1?row['Hwarninginfo']:'disabled'));arrHtml.push('HH: '+(row['HHEnable']===1?row['HHwarninginfo']:'disabled'));return arrHtml.join('<br/>');case alarmMode.BOOL:return row['boolwarninginfo'];default:return'/';}}},{name:'operations',title:'Operations',formatter:function formatter(i,row){var htmlTpl='\
                        <button class="btn btn-primary btn-rule-edit" type="button" title="edit this rule">\
                            <span class="glyphicon glyphicon-pencil"></span>\
                        </button>\
                        <button class="btn btn-primary btn-rule-del" type="button" title="delete this rule">\
                            <span class="glyphicon glyphicon-trash"></span>\
                        </button>';return htmlTpl;}}]});},initFormValidation:function initFormValidation(){this.validator=new Validator({elements:[{name:'pointName',selector:this.$iptPointName,rules:[{valid:'require',msg:'"Point Name" cannot be empty!'}]},{name:'alarmInfo',selector:this.$iptAlarmInfo,rules:[{valid:'require',msg:'"Alarm Info" cannot be empty!'}]},{name:'limitValueInfo',selector:'#divRuleValue :text:enabled',rules:[{valid:'require',msg:'This field cannot be empty!'}]},{name:'alarmLevel',selector:this.$iptAlarmLevel,rules:[{valid:'require',msg:'"Alarm Level" cannot be empty!'}]}]});},attachEvents:function attachEvents(){this.$btnClose.click(function(e){ScreenManager.show(PaneProjectSelector);});this.$btnCog.click(function(e){_this.stopAutoload();_this.$panelLog.hide();_this.$panelCog.show();_this.$tbRule.table('loading');WebAPI.getJSON('/warning/getConfig/'+AppConfig.projectId,function(rs){_this.$tbRule.table('load',rs);});e.preventDefault();});this.$btnLogList.click(function(e){_this.$panelCog.hide();_this.$panelLog.show();_this.startAutoload();});this.$btnReload.click(function(){_this.reloadRecord();});this.$tbAlarm.on('click','.dropdown-menu>li',function(e){var $this=$(this);var rowIndex=parseInt($this.parents('tr').attr('data-rowindex'));var rowData=_this.$tbAlarm.table('getData')[rowIndex];var minutes=parseInt($this.attr('data-value'));var deadline=new Date(new Date().valueOf()+minutes*60*1000).format('yyyy-MM-dd HH:mm:ss');var msg='You have chosen "{0}", this alarm will not be shown until the time below:\n{1}\nAre you sure to do this?'.format($this.children('a').text(),deadline);_this.stopAutoload();confirm(msg,function(){_this.setDelayTime(rowData,deadline);_this.startAutoload();},function(){_this.startAutoload(false);});e.stopPropagation();});this.$btnRuleSrch.click(function(e){var key=_this.$iptRuleSrch.val().trim();_this.$cbSelectAll.prop('checked',false);if(!key){_this.$tbRule.table('filter');}else{_this.$tbRule.table('filter',{pointname:key});}
e.preventDefault();});this.$btnAddRule.click(function(){_this.$ruleModal.find('.modal-title').text('Add Rule');_this.$btnRuleSubmit.attr('data-action','add');_this.setModal();_this.$ruleModal.modal('show');});this.$btnDelRule.click(function(){var $chosen=$('.ui-tbl-col-cb>input:checked');var names=[];var data=_this.$tbRule.table('getData');var index=null;if($chosen.length===0){alert('You should choose one row at least!');return;}
$chosen.each(function(i,item){index=parseInt($(item).attr('data-rowindex'));names.push(data[index]['pointname']);});_this.delRule('Are you sure to delete these rules?',names);});this.$btnSelectAll.click(function(e){_this.$cbSelectAll.trigger('click');e.preventDefault();});this.$cbSelectAll.click(function(e){var $ckbs=$('.ui-tbl-col-cb').children('input');if($(this).is(':checked')){util.checkbox.selectAll($ckbs);}else{util.checkbox.unSelectAll($ckbs);}
e.stopPropagation();});this.$lkSelectAll.click(function(e){var $ckbs=$('.ui-tbl-col-cb').children('input');util.checkbox.selectAll($ckbs);_this.$cbSelectAll.prop('checked',true);});this.$lkSelectInverse.click(function(e){var $ckbs=$('.ui-tbl-col-cb').children('input');util.checkbox.selectInverse($ckbs);_this.$cbSelectAll.prop('checked',util.checkbox.isAllChecked($ckbs));});this.$lkUnSelectAll.click(function(e){var $ckbs=$('.ui-tbl-col-cb').children('input');util.checkbox.unSelectAll($ckbs);_this.$cbSelectAll.prop('checked',false);});this.$tbRule.on('click','.ui-tbl-col-cb',function(){var $this=$(this);var $ckbs=$('.ui-tbl-col-cb').children('input');_this.$cbSelectAll.prop('checked',util.checkbox.isAllChecked($ckbs));});this.$cbLL.click(function(){_this.$iptLL.add(_this.$iptLLInfo).prop('disabled',!$(this).is(':checked'));util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));});this.$cbL.click(function(){_this.$iptL.add(_this.$iptLInfo).prop('disabled',!$(this).is(':checked'));util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));});this.$cbH.click(function(){_this.$iptH.add(_this.$iptHInfo).prop('disabled',!$(this).is(':checked'));util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));});this.$cbHH.click(function(){_this.$iptHH.add(_this.$iptHHInfo).prop('disabled',!$(this).is(':checked'));util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));});this.$tbRule.on('click','.btn-rule-edit',function(){var $this=$(this);var index=$this.parents('tr').attr('data-rowindex');var rowData=_this.$tbRule.table('getData')[index];_this.$btnRuleSubmit.attr('data-action','edit');_this.$ruleModal.find('.modal-title').text('Edit Rule');_this.setModal(rowData);_this.$ruleModal.modal('show');});this.$tbRule.on('click','.btn-rule-del',function(){var $this=$(this);var index=$this.parents('tr').attr('data-rowindex');var pointName=_this.$tbRule.table('getData')[index]['pointname'];_this.delRule('Are you sure to delete this rule?',[pointName]);});this.$lkAlarmModeItems.click(function(e){var $this=$(this);var value=parseInt($this.attr('data-value'));var title=$this.text();_this.$spAlarmModeTitle.attr('data-value',value).text(title);switch(value){case alarmMode.LIMIT_VALUE:_this.$divAlarmInfo.hide();_this.$divRuleEnable.show();_this.$divRuleValue.show();break;case alarmMode.BOOL:default:_this.$divAlarmInfo.show();_this.$divRuleEnable.hide();_this.$divRuleValue.hide();break;}});this.$btnRuleSubmit.click(function(){var p={},valid;var url=$(this).attr('data-action')==='add'?'/warning/addWarningConfig/':'/warning/modifyWarningConfig/';p.pointname=_this.$iptPointName.val();p.unitproperty01=0;p.warninglevel=_this.$iptAlarmLevel.val();p.warningtype=parseInt(_this.$spAlarmModeTitle.attr('data-value'));if(p.warningtype!==alarmMode.LIMIT_VALUE){p.HHEnable=0;p.HEnable=0;p.LEnable=0;p.LLEnable=0;p.HHLimit=0;p.HLimit=0;p.LLimit=0;p.LLLimit=0;p.HHwarninginfo='';p.Hwarninginfo='';p.Lwarninginfo='';p.LLwarninginfo='';p.boolwarninginfo=_this.$iptAlarmInfo.val();valid=_this.validator.not('limitValueInfo').valid();}else{p.HHEnable=_this.$cbHH.is(':checked')?1:0;p.HEnable=_this.$cbH.is(':checked')?1:0;p.LEnable=_this.$cbL.is(':checked')?1:0;p.LLEnable=_this.$cbLL.is(':checked')?1:0;p.HHLimit=p.HHEnable===1?parseInt(_this.$iptHH.val()):0;p.HLimit=p.HEnable===1?parseInt(_this.$iptH.val()):0;p.LLimit=p.LEnable===1?parseInt(_this.$iptL.val()):0;p.LLLimit=p.LLEnable===1?parseInt(_this.$iptLL.val()):0;p.HHwarninginfo=p.HHEnable===1?_this.$iptHHInfo.val():'';p.Hwarninginfo=p.HEnable===1?_this.$iptHInfo.val():'';p.Lwarninginfo=p.LEnable===1?_this.$iptLInfo.val():'';p.LLwarninginfo=p.LLEnable===1?_this.$iptLLInfo.val():'';p.boolwarninginfo='';valid=_this.validator.not('alarmInfo').valid();}
valid.done(function(){console.log(arguments);Spinner.spin(_this.$ruleModal[0]);$.post(url+AppConfig.projectId,p).done(function(rs){if(rs.status!==0){alert('Sorry, operation faild, we will fix this as soon as possible.');return;}
_this.$tbRule.table('loading');WebAPI.getJSON('/warning/getConfig/'+AppConfig.projectId,function(rs){_this.$tbRule.table('load',rs);});}).always(function(){_this.$ruleModal.modal('hide');Spinner.stop();});});});$(window).resize(this.resize);},setDelayTime:function setDelayTime(row,delayTime){var rules=JSON.parse(localStorage.getItem(ALARM_RULE_NAME))||{};var key=window.encodeURIComponent(row['bindpointname']+'_'+row['time']);var projectId=AppConfig.projectId;var datetimeNow=new Date().format('yyyy-MM-dd HH:mm:ss');rules[projectId]=rules[projectId]||{};for(var i in rules[projectId]){if(rules[projectId].hasOwnProperty(i)){if(rules[projectId][i]<=datetimeNow)delete rules[projectId][i];}}
rules[AppConfig.projectId][key]=delayTime;localStorage.setItem(ALARM_RULE_NAME,JSON.stringify(rules));},filterByDelayRule:function filterByDelayRule(data){var result=[];var rules=JSON.parse(localStorage.getItem(ALARM_RULE_NAME));var row=deadline=key=null;if(!rules||!(rules=rules[AppConfig.projectId]))return data;for(var i=0,len=data.length;i<len;i++){row=data[i];key=window.encodeURIComponent(row['bindpointname']+'_'+row['time']);if(!(deadline=rules[key])){result.push(row);continue;}
if(data[i]['endtime']>=deadline){result.push(row);}}
return result;},setModal:function setModal(data){this.validator.resetStatus();this.$iptPointName.val('');this.$iptAlarmLevel.val('');this.$iptAlarmInfo.val('');this.$iptLL.val('').prop('disabled',false);this.$iptL.val('').prop('disabled',true);this.$iptH.val('').prop('disabled',true);this.$iptHH.val('').prop('disabled',true);this.$cbLL.prop('checked',true);this.$cbL.prop('checked',false);this.$cbH.prop('checked',false);this.$cbHH.prop('checked',false);util.checkbox.keepOneCheckbox(this.$divRuleEnable.find(':checkbox'));this.$iptLLInfo.val('').prop('disabled',false);this.$iptLInfo.val('').prop('disabled',true);this.$iptHInfo.val('').prop('disabled',true);this.$iptHHInfo.val('').prop('disabled',true);if(!data){this.$iptPointName.prop('disabled',false);this.$btnAlarmMode.prop('disabled',false);this.$lkAlarmModeItems.eq(0).trigger('click');}else{this.$iptPointName.val(data['pointname']).prop('disabled',true);this.$btnAlarmMode.prop('disabled',true);this.$iptAlarmLevel.val(data['boolwarninglevel']);switch(data['boolwarning']){case alarmMode.LIMIT_VALUE:this.$lkAlarmModeItems.eq(1).trigger('click');this.$iptLL.val(data['LLLimit']).prop('disabled',data['LLEnable']===0?true:false);this.$iptL.val(data['LLimit']).prop('disabled',data['LEnable']===0?true:false);this.$iptH.val(data['HLimit']).prop('disabled',data['HEnable']===0?true:false);this.$iptHH.val(data['HHLimit']).prop('disabled',data['HHEnable']===0?true:false);this.$cbLL.prop('checked',data['LLEnable']===0?false:true);this.$cbL.prop('checked',data['LEnable']===0?false:true);this.$cbH.prop('checked',data['HEnable']===0?false:true);this.$cbHH.prop('checked',data['HHEnable']===0?false:true);util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));this.$iptLLInfo.val(data['LLwarninginfo']).prop('disabled',data['LLEnable']===0?true:false);this.$iptLInfo.val(data['Lwarninginfo']).prop('disabled',data['LEnable']===0?true:false);this.$iptHInfo.val(data['Hwarninginfo']).prop('disabled',data['HEnable']===0?true:false);this.$iptHHInfo.val(data['HHwarninginfo']).prop('disabled',data['HHEnable']===0?true:false);break;case alarmMode.BOOL:this.$iptAlarmInfo.val(data['boolwarninginfo']);this.$lkAlarmModeItems.eq(0).trigger('click');break;default:return'Unknow';}}},reloadRecord:function reloadRecord(data){var startTime,endTime;if(!data){if(_this.$spLoading.hasClass('loading'))return;window.BackgroundWorkers.alarmReporter.postMessage({type:'dataAlarmRealtime',projectId:AppConfig.projectId});}
else{_this.$tbAlarm.table('load',_this.filterByDelayRule(data));_this.$spLoading.removeClass('loading');}},delRule:function delRule(msg,names){msg=msg||'Are you sure to do this operation?';confirm(msg,function(){Spinner.spin(_this.$alarmLoggingPane[0]);$.post('/warning/deleteWarningConfig/'+AppConfig.projectId,{pointNames:names.join('\',\'')}).done(function(rs){if(rs.status!==0){alert('Sorry, operation faild, we will fix this as soom as possible.');return;}
_this.$tbRule.table('loading');WebAPI.getJSON('/warning/getConfig/'+AppConfig.projectId,function(rs){_this.$tbRule.table('load',rs);});}).always(function(){Spinner.stop();});});},resize:function resize(){var totalHeight=$(window).height();var height=totalHeight-278;if(height<100)return;_this.$tbAlarm.table('setStretchHeight',height);_this.$tbRule.table('setStretchHeight',height);},close:function close(){this.stopAutoload();}};return AlarmLogging;}();var DataSourceConfigure=function(){function DataSourceConfigure(_parent,_showType,_bIsAdd,_customName,_ptName,_ptDesc,_prjId){this.parent=_parent;this.container=undefined;this.m_showType=_showType;this.m_bIsAdd=_bIsAdd;this.m_customName=_customName;this.m_pointName=_ptName;this.m_pointDesc=_ptDesc;this.m_projectId=_prjId;}
DataSourceConfigure.prototype={show:function show(){var _this=this;_this.container=document.createElement('div');_this.container.className='panel panel-default';_this.container.id='addPointPanelContain';_this.container.style.height='100%';_this.container.style.width='99%';_this.container.style.position='absolute';_this.container.style.zIndex='2';document.getElementById('dialogContent').style.height='50%';WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(resultHtml){if(_this.parent.m_parent!=undefined){_this.parent.m_parent.hideAnlsPane();}
_this.container.innerHTML=resultHtml;document.getElementById('paneContent').appendChild(_this.container);I18n.fillArea($('#addPointPanelContain'));if(0===_this.m_showType){$('#divDataSourceFormula').css('display','none');$('#formulaHeading').css('display','none');$('#formulaFooter').css('display','none');$('#divDataSourceAddPage').css('display','');$('#originalHeading').css('display','');$('#originalFooter').css('display','');new DataSourceOriginal(_this.parent,_this).show();}else if(1===_this.m_showType){$('#divDataSourceAddPage').css('display','none');$('#originalHeading').css('display','none');$('#originalFooter').css('display','none');$('#divDataSourceFormula').css('display','');$('#formulaHeading').css('display','');$('#formulaFooter').css('display','');new DataSourceFormula(_this.parent,_this).show();}else if(2===_this.m_showType){new DataSourceOriginal(_this.parent,_this).show();new DataSourceFormula(_this.parent,_this).show();}});},close:function close(){$(this.container).remove();}};return DataSourceConfigure;}();var DataSourceOriginal=function(){function DataSourceOriginal(_parent,_dsCfg){this.parent=_parent;this.m_strPrjName='';this.m_pointList='';this.m_dsCfg=_dsCfg;this.m_parseFmt={'search':'','arrCustom':[],'arrSystem':[],'arrDevice':[],'arrType':[]};this.m_lang=I18n.resource.dataSource;this.m_iconColor=new Array('#ff7f50','#87cefa','#da70d6','#32cd32','#6495ed','#ff69b4','#ba55d3','#cd5c5c','#ffa500','#40e0d0','#1e90ff','#ff6347','#7b68ee','#00fa9a','#ffd700','#6b8e23','#ff00ff','#3cb371','#b8860b','#30e0e0');this.m_rowStyle='rowSelStyle';this.m_curPageNum=0;}
DataSourceOriginal.prototype={show:function show(){var _this=this;_this.initElement();},initElement:function initElement(){var _this=this;if(_this.m_dsCfg.m_bIsAdd){$('#dsConfig').css('display','none');$('#dsPtName').css('display','none');}else{$('#divPointsBody').css('height','calc(100% - 194px)');$('#inputCustomName').attr('placeholder',_this.m_lang.CUSTOM_NAME);$('#inputPointDesc').attr('placeholder',_this.m_lang.POINT_DESC);$('#inputCustomName').val(_this.m_dsCfg.m_customName);$('#inputPointName').val(_this.m_dsCfg.m_pointName);$('#inputPointDesc').val(_this.m_dsCfg.m_pointDesc);}
var iconTitSys=$('#dataSrcSys li');iconTitSys.eq(1).attr('title',_this.m_lang.ICON_SYS_HVAC);iconTitSys.eq(2).attr('title',_this.m_lang.ICON_SYS_POWER);iconTitSys.eq(3).attr('title',_this.m_lang.ICON_SYS_LIGHT);iconTitSys.eq(4).attr('title',_this.m_lang.ICON_SYS_CRAC);var iconTitDev=$('#dataSrcEquip li');iconTitDev.eq(1).attr('title',_this.m_lang.ICON_DEV_CHIL);iconTitDev.eq(2).attr('title',_this.m_lang.ICON_DEV_PUMP);iconTitDev.eq(3).attr('title',_this.m_lang.ICON_DEV_COOL);iconTitDev.eq(4).attr('title',_this.m_lang.ICON_DEV_AHU);iconTitDev.eq(5).attr('title',_this.m_lang.ICON_DEV_VAV);iconTitDev.eq(6).attr('title',_this.m_lang.ICON_DEV_SYS);var iconTitType=$('#dataSrcType li');iconTitType.eq(1).attr('title',_this.m_lang.ICON_TYPE_ELEPOWMET);iconTitType.eq(2).attr('title',_this.m_lang.ICON_TYPE_THER);iconTitType.eq(3).attr('title',_this.m_lang.ICON_TYPE_TEMP);iconTitType.eq(4).attr('title',_this.m_lang.ICON_TYPE_FLOW);iconTitType.eq(5).attr('title',_this.m_lang.ICON_TYPE_PRES);iconTitType.eq(6).attr('title',_this.m_lang.ICON_TYPE_CURFLOW);iconTitType.eq(7).attr('title',_this.m_lang.ICON_TYPE_ELEPOW);iconTitType.eq(8).attr('title',_this.m_lang.ICON_TYPE_FREQ);iconTitType.eq(9).attr('title',_this.m_lang.ICON_TYPE_ONOFF);iconTitType.eq(10).attr('title',_this.m_lang.ICON_TYPE_ALARM);var selectPrj=$('#dataSrcPrjName');var prjId=0;var opt;var nSize=AppConfig.projectList.length;var nColorSize=_this.m_iconColor.length;if(!_this.m_dsCfg.m_bIsAdd&&_this.m_dsCfg.m_projectId!=-1){prjId=_this.m_dsCfg.m_projectId;}else{prjId=Number(AppConfig.projectId);}
selectPrj.empty();for(var i=0;i<nSize;i++){var project=AppConfig.projectList[i];opt=document.createElement('option');if('en'==localStorage['language']){opt.textContent=project.name_english;}else{opt.textContent=project.name_cn;}
opt.value=project.id;opt.setAttribute('iconColor',_this.m_iconColor[i-parseInt(i/nColorSize)*nColorSize]);selectPrj.append(opt);}
selectPrj.val(prjId);_this.initNavControls();selectPrj.change(function(e){var prjId=$('#dataSrcPrjName').find('option:selected').val();if(typeof prjId=="undefined"||''==prjId){$('#dataSrcPtSearch').attr('disabled','');return;}
$('#dataSrcPtSearch').removeAttr('disabled');_this.clearSearch();var ulCust=$('#dataSrcCustom .pagination');ulCust.empty();ulCust.append('<li><span class="filterCustom filterCustomSelected" id="filterCustomAll" i18n="dataSource.POINT_TYPE_CUSTOM"  style="width: 55px;">All</span></li>');var selectPt=$('#divPointsBody tbody');selectPt.html('');_this.initPointList();});$('#btnAddDataSrc').click(function(e){if(_this.selectPoint()){_this.parent.m_parent.showAnlsPane();$(_this.m_dsCfg.container).remove();}});$('#btnCancelDataSrc').click(function(e){_this.parent.m_parent.showAnlsPane();$(_this.m_dsCfg.container).remove();});$('#dataSrcPtSearch').keyup(function(e){var searchVal=$('#dataSrcPtSearch').val();if(''==searchVal){_this.initPointList();}
if(13==e.keyCode){_this.searchPointsEx(searchVal);}});$('#btnSearch').click(function(e){var searchVal=$('#dataSrcPtSearch').val();_this.searchPointsEx(searchVal);});$('#divPointsHead li').click(function(e){_this.clearSearch();var target=$(e.currentTarget);var showChar=target.find('a').text();if('All'==showChar){_this.showPointListAll();}else{_this.clearNavSelect();target.attr('class','active');var upChar=showChar.toUpperCase();var lowChar=showChar.toLowerCase();_this.parsePointListByAlphabet(upChar,lowChar);}});var iconSys=$('#dataSrcSys .filterIcon');iconSys.click(function(e){var target=$(e.currentTarget);var id=target.attr('id');if('filterSystemAll'==id){_this.m_parseFmt.arrSystem=[];iconSys.removeClass('filterIconSysSelected');target.addClass('filterIconSysSelected');}else{if('filterSystem1'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrSystem.push(1);target.addClass('filterIconSysSelected');}else{_this.delInArray(_this.m_parseFmt.arrSystem,1);target.removeClass('filterIconSysSelected');}}else if('filterSystem2'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrSystem.push(2);target.addClass('filterIconSysSelected');}else{_this.delInArray(_this.m_parseFmt.arrSystem,2);target.removeClass('filterIconSysSelected');}}else if('filterSystem3'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrSystem.push(3);target.addClass('filterIconSysSelected');}else{_this.delInArray(_this.m_parseFmt.arrSystem,3);target.removeClass('filterIconSysSelected');}}else if('filterSystem4'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrSystem.push(4);target.addClass('filterIconSysSelected');}else{_this.delInArray(_this.m_parseFmt.arrSystem,4);target.removeClass('filterIconSysSelected');}}
if(_this.m_parseFmt.arrSystem.length>0){$('#filterSystemAll').removeClass('filterIconSysSelected');}else{$('#filterSystemAll').addClass('filterIconSysSelected');}}
_this.searchPoints();});var iconDev=$('#dataSrcEquip .filterIcon');iconDev.click(function(e){var target=$(e.currentTarget);var id=target.attr('id');if('filterDeviceAll'==id){_this.m_parseFmt.arrDevice=[];iconDev.removeClass('filterIconDevSelected');target.addClass('filterIconDevSelected');}else{if('filterDevice1'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(1);target.addClass('filterIconDevSelected');}else{_this.delInArray(_this.m_parseFmt.arrDevice,1);target.removeClass('filterIconDevSelected');}}else if('filterDevice2'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(2);target.addClass('filterIconDevSelected');}else{_this.delInArray(_this.m_parseFmt.arrDevice,2);target.removeClass('filterIconDevSelected');}}else if('filterDevice3'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(3);target.addClass('filterIconDevSelected');}else{_this.delInArray(_this.m_parseFmt.arrDevice,3);target.removeClass('filterIconDevSelected');}}else if('filterDevice4'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(4);target.addClass('filterIconDevSelected');}else{_this.delInArray(_this.m_parseFmt.arrDevice,4);target.removeClass('filterIconDevSelected');}}else if('filterDevice5'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(5);target.addClass('filterIconDevSelected');}else{_this.delInArray(_this.m_parseFmt.arrDevice,5);target.removeClass('filterIconDevSelected');}}else if('filterDevice6'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(6);target.addClass('filterIconDevSelected');}else{_this.delInArray(_this.m_parseFmt.arrDevice,6);target.removeClass('filterIconDevSelected');}}
if(_this.m_parseFmt.arrDevice.length>0){$('#filterDeviceAll').removeClass('filterIconDevSelected');}else{$('#filterDeviceAll').addClass('filterIconDevSelected');}}
_this.searchPoints();});var iconType=$('#dataSrcType .filterIcon');iconType.click(function(e){var target=$(e.currentTarget);var id=target.attr('id');if('filterTypeAll'==id){_this.m_parseFmt.arrType=[];iconType.removeClass('filterIconTypeSelected');target.addClass('filterIconTypeSelected');}else{if('filterType1'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(1);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,1);target.removeClass('filterIconTypeSelected');}}else if('filterType2'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(2);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,2);target.removeClass('filterIconTypeSelected');}}else if('filterType3'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(3);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,3);target.removeClass('filterIconTypeSelected');}}else if('filterType4'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(4);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,4);target.removeClass('filterIconTypeSelected');}}else if('filterType5'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(5);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,5);target.removeClass('filterIconTypeSelected');}}else if('filterType6'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(6);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,6);target.removeClass('filterIconTypeSelected');}}else if('filterType7'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(7);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,7);target.removeClass('filterIconTypeSelected');}}else if('filterType8'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(8);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,8);target.removeClass('filterIconTypeSelected');}}else if('filterType9'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(9);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,9);target.removeClass('filterIconTypeSelected');}}else if('filterType10'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(10);target.addClass('filterIconTypeSelected');}else{_this.delInArray(_this.m_parseFmt.arrType,10);target.removeClass('filterIconTypeSelected');}}
if(_this.m_parseFmt.arrType.length>0){$('#filterTypeAll').removeClass('filterIconTypeSelected');}else{$('#filterTypeAll').addClass('filterIconTypeSelected');}}
_this.searchPoints();});selectPrj.change();},selectPointName:function selectPointName(clickTarget){if(this.m_dsCfg.m_bIsAdd){var target=$(clickTarget);var flag=target.attr('class');if(this.m_rowStyle==flag){target.attr('class','');}else{target.attr('class',this.m_rowStyle);}}else{$('#tableWatch tbody tr').attr('class','');var target=$(clickTarget);target.attr('class',this.m_rowStyle);$('#inputPointName').val(target.find('td').eq(1).text());}},showPointListAll:function showPointListAll(){$("#divPointsBody").scrollTop(0);var _this=this;if(null==_this.m_pointList.pointList){return;}
var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td,item,div;var nSize=_this.m_pointList.pointList.length;for(var i=0;i<nSize;i++){item=_this.m_pointList.pointList[i];tr=document.createElement('tr');tr.className='';tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target);};td=document.createElement('td');td.textContent=parseInt(_this.m_curPageNum)*50+i+'';tr.appendChild(td);td=document.createElement('td');td.textContent=item.name;td.title=item.name;$(td).css('max-width','250px');$(td).css('overflow-x','hidden');$(td).css('text-overflow','ellipsis');tr.appendChild(td);td=document.createElement('td');td.textContent=item.description;td.title=item.description;$(td).css('max-width','250px');$(td).css('overflow-x','hidden');$(td).css('text-overflow','ellipsis');tr.appendChild(td);if(item.system!=undefined&&item.device!=undefined&&item.type!=undefined){td=document.createElement('td');$(td).css('min-width','90px');if(''!=item.custom){div=document.createElement('div');div.textContent=item.custom;$(div).css('float','left');$(div).css('display','inline');$(div).css('color','#fff');$(div).css('border-radius','8px');$(div).css('padding','0 5px 0 5px');$(div).css('background-color','#428bca');td.appendChild(div);}
if(0!=item.system){div=document.createElement('div');div.className='iconComm';if(1==item.system){div.id='iconSys1';}else if(2==item.system){div.id='iconSys2';}else if(3==item.system){div.id='iconSys3';}else if(4==item.system){div.id='iconSys4';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
if(0!=item.device){div=document.createElement('div');div.className='iconComm';if(1==item.device){div.id='iconDev1';}else if(2==item.device){div.id='iconDev2';}else if(3==item.device){div.id='iconDev3';}else if(4==item.device){div.id='iconDev4';}else if(5==item.device){div.id='iconDev5';}else if(6==item.device){div.id='iconDev6';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
if(0!=item.type){div=document.createElement('div');div.className='iconComm';if(1==item.type){div.id='iconType1';}else if(2==item.type){div.id='iconType2';}else if(3==item.type){div.id='iconType3';}else if(4==item.type){div.id='iconType4';}else if(5==item.type){div.id='iconType5';}else if(6==item.type){div.id='iconType6';}else if(7==item.type){div.id='iconType7';}else if(8==item.type){div.id='iconType8';}else if(9==item.type){div.id='iconType9';}else if(10==item.type){div.id='iconType10';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
tr.appendChild(td);}
selectPt.append(tr);}},parsePointListByAlphabet:function parsePointListByAlphabet(upCharName,lowCharName){var _this=this;if(null==_this.m_pointList.pointList){return;}
var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td;var nSize=_this.m_pointList.pointList.length;for(var i=0;i<nSize;i++){var firstChar=_this.m_pointList.pointList[i].name[0];if(upCharName!=firstChar&&lowCharName!=firstChar){continue;}
tr=document.createElement('tr');tr.className='';tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target);};td=document.createElement('td');td.textContent=i;tr.appendChild(td);td=document.createElement('td');td.textContent=_this.m_pointList.pointList[i].name;tr.appendChild(td);td=document.createElement('td');td.textContent=_this.m_pointList.pointList[i].description;tr.appendChild(td);selectPt.append(tr);}},parsePointListByInput:function parsePointListByInput(){var _this=this;if(null==_this.m_pointList.pointList){var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td;tr=document.createElement('tr');tr.style.height='100px';td=document.createElement('td');td.colSpan=3;td.style.lineHeight='100%';td.style.verticalAlign='middle';td.style.fontSize='20px';td.style.fontWeight='bold';td.style.color='darkred';td.textContent=_this.m_lang.NO_MATCH_FOUND;tr.appendChild(td);selectPt.append(tr);return;}
var strSearchVal;strSearchVal=$('#dataSrcPtSearch').val();if(null==strSearchVal){return;}
if(''==strSearchVal){_this.showPointListAll();}
strSearchVal=strSearchVal.toLowerCase();var arrSearchVal=strSearchVal.split(' ');var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td;var nSize=_this.m_pointList.pointList.length;var strGetName,strGetDesc,nIdxName,nIdxDesc,nIdxNameFlag,nIdxDescFlag;for(var i=0;i<nSize;i++){nIdxNameFlag=true;nIdxDescFlag=true;for(var j=0;j<arrSearchVal.length;++j){if(arrSearchVal[j]=='')continue;strGetName=_this.m_pointList.pointList[i].name;strGetName=strGetName.toLowerCase();strGetName.indexOf(arrSearchVal[j],0);nIdxName=strGetName.indexOf(arrSearchVal[j],0);strGetDesc=_this.m_pointList.pointList[i].description;strGetDesc=strGetDesc.toLowerCase();strGetDesc.indexOf(arrSearchVal[j],0);nIdxDesc=strGetDesc.indexOf(arrSearchVal[j],0);if(-1==nIdxName){nIdxNameFlag=false;}
if(-1==nIdxDesc){nIdxDescFlag=false;}
if(!nIdxNameFlag&&!nIdxDescFlag){break;}}
if(!nIdxNameFlag&&!nIdxDescFlag){continue;}
tr=document.createElement('tr');tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target);};td=document.createElement('td');td.textContent=i;tr.appendChild(td);td=document.createElement('td');td.textContent=_this.m_pointList.pointList[i].name;tr.appendChild(td);td=document.createElement('td');td.textContent=_this.m_pointList.pointList[i].description;tr.appendChild(td);selectPt.append(tr);}
if(''===selectPt.html()){tr=document.createElement('tr');tr.style.height='100px';td=document.createElement('td');td.colSpan=3;td.style.lineHeight='100%';td.style.verticalAlign='middle';td.style.fontSize='20px';td.style.fontWeight='bold';td.style.color='darkred';td.textContent=_this.m_lang.NO_MATCH_FOUND;tr.appendChild(td);selectPt.append(tr);}},clearNavSelect:function clearNavSelect(){$('#divPointsHead').find('li').each(function(){$(this).attr('class','');});},initNavControls:function initNavControls(){$('#filterSystemAll').addClass('filterIconSysSelected');$('#filterDeviceAll').addClass('filterIconDevSelected');$('#filterTypeAll').addClass('filterIconTypeSelected');},initNavCustomControls:function initNavCustomControls(){var _this=this;var ulCust=$('#dataSrcCustom .pagination');ulCust.empty();ulCust.append('<li><span class="filterCustom filterCustomSelected" id="filterCustomAll" i18n="dataSource.POINT_TYPE_CUSTOM" style="width: 55px;">All</span></li>');for(var i=0,len=_this.m_pointList.customName.length;i<len;i++){var item=_this.m_pointList.customName[i];if(''==item){continue;}
var li=$('<li><span class="filterCustom">'+item+'</span></li>');ulCust.append(li);}
var iconCust=$('#dataSrcCustom .filterCustom');iconCust.click(function(e){var target=$(e.currentTarget);var showChar=target.text();if('All'==showChar){_this.m_parseFmt.arrCustom=[];iconCust.removeClass('filterCustomSelected');target.addClass('filterCustomSelected');}else{if('filterCustom'==target.eq(0).attr('class')){_this.m_parseFmt.arrCustom.push(showChar);target.addClass('filterCustomSelected');}else{_this.delInArray(_this.m_parseFmt.arrCustom,showChar);target.removeClass('filterCustomSelected');}
if(_this.m_parseFmt.arrCustom.length>0){$('#filterCustomAll').removeClass('filterCustomSelected');}else{$('#filterCustomAll').addClass('filterCustomSelected');}}
_this.searchPoints();});},initNavPageNum:function initNavPageNum(allPageNum){var _this=this;var ul=$('<ul class="pagination">\
                <li><a class="pageFlag" value="First"><span aria-hidden="true">&laquo;</span></a></li>\
                <li><a class="pageFlag" value="Previous"><span aria-hidden="true">&lsaquo;</span></a></li>\
            </ul>');if(allPageNum>5){ul.append('<li class="active"><a class="pageFlag pageNum" value="1">1</a></li>\
                    <li><a class="pageFlag pageNum" value="2">2</a></li>\
                    <li><a class="pageFlag pageNum" value="3">3</a></li>\
                    <li><a class="pageFlag pageNum" value="4">4</a></li>\
                    <li><a class="pageFlag pageNum" value="5">5</a></li>');}else{for(var i=0;i<allPageNum;i++){var num=i+1;ul.append('<li><a class="pageFlag pageNum" value="'+num+'">'+num+'</a></li>');}}
ul.append('<li><a class="pageFlag" value="Next"><span aria-hidden="true">&rsaquo;</span></a></li>\
                        <li><a class="pageFlag" value="Last"><span aria-hidden="true">&raquo;</span></a></li>');var pageFlag=ul.find('.pageFlag');pageFlag.click(function(e){var value=$(e.currentTarget).attr('value');if('First'==value){if(_this.m_curPageNum!=0){_this.setCurrentPage(0);}}else if('Previous'==value){if(_this.m_curPageNum>0){_this.setCurrentPage(_this.m_curPageNum-1);}}else if('Next'==value){if(_this.m_curPageNum<allPageNum-1){_this.setCurrentPage(_this.m_curPageNum+1);}}else if('Last'==value){if(_this.m_curPageNum!=allPageNum-1){_this.setCurrentPage(allPageNum-1);}}else{if(_this.m_curPageNum!=value-1){_this.setCurrentPage(value-1);}}});$('#navPageNum').empty();$('#navPageNum').append(ul);},setCurrentPage:function setCurrentPage(curPageNum){var _this=this;var prjId=$('#dataSrcPrjName').find('option:selected').val();Spinner.spin($('#divDataSourceAddPage')[0]);WebAPI.get('/analysis/get_pointList_from_s3db/'+prjId+'/'+curPageNum+'/50').done(function(result){_this.m_pointList={'pointList':result.pointList,'customName':result.customName,'pageAllNum':result.pageAllNum};_this.m_curPageNum=curPageNum;var liPageNum=$('#navPageNum').find('.pageNum');if(curPageNum<=2){liPageNum.eq(0).attr('value','1');liPageNum.eq(1).attr('value','2');liPageNum.eq(2).attr('value','3');liPageNum.eq(3).attr('value','4');liPageNum.eq(4).attr('value','5');liPageNum.eq(0).text('1');liPageNum.eq(1).text('2');liPageNum.eq(2).text('3');liPageNum.eq(3).text('4');liPageNum.eq(4).text('5');}else if(curPageNum>=result.pageAllNum-3){liPageNum.eq(0).attr('value',result.pageAllNum-4);liPageNum.eq(1).attr('value',result.pageAllNum-3);liPageNum.eq(2).attr('value',result.pageAllNum-2);liPageNum.eq(3).attr('value',result.pageAllNum-1);liPageNum.eq(4).attr('value',result.pageAllNum);liPageNum.eq(0).text(result.pageAllNum-4);liPageNum.eq(1).text(result.pageAllNum-3);liPageNum.eq(2).text(result.pageAllNum-2);liPageNum.eq(3).text(result.pageAllNum-1);liPageNum.eq(4).text(result.pageAllNum);}else{liPageNum.eq(0).attr('value',curPageNum-1);liPageNum.eq(1).attr('value',curPageNum);liPageNum.eq(2).attr('value',curPageNum+1);liPageNum.eq(3).attr('value',curPageNum+2);liPageNum.eq(4).attr('value',curPageNum+3);liPageNum.eq(0).text(curPageNum-1);liPageNum.eq(1).text(curPageNum);liPageNum.eq(2).text(curPageNum+1);liPageNum.eq(3).text(curPageNum+2);liPageNum.eq(4).text(curPageNum+3);}
for(var i=0,len=liPageNum.length;i<len;i++){var item=liPageNum.eq(i);if(item.attr('value')==curPageNum+1){item.closest('li').attr('class','active');}else{item.closest('li').removeAttr('class');}}
_this.showPointListAll();}).error(function(e){document.getElementById('dialogContent').style.height='50%';}).always(function(e){Spinner.stop();});},selectPoint:function selectPoint(){var _this=this;var ctlSelectPrj=$('#dataSrcPrjName');_this.m_strPrjName=ctlSelectPrj.find('option:selected').text();if(''==_this.m_strPrjName){alert(I18n.resource.observer.widgets.PLEASE_SELECT_PROJECT+'！');return false;}
var newPointList=[];var row;var strUserId=AppConfig.userId;var strUserName=AppConfig.account;var strCustName='';var prjId=Number(ctlSelectPrj.find('option:selected').attr('value'));var langFlag='zh'==localStorage['language']?0:1;var prjName=_this.parent.getProjectNameFromId(prjId,langFlag);var iconColor=ctlSelectPrj.find('option:selected').attr('iconColor');var strPtName='';var strPtDesc='';var groupId=_this.parent.m_selectGroupId;if(_this.m_dsCfg.m_bIsAdd){$('#tableWatch tbody tr').each(function(){if(_this.m_rowStyle==this.className){strPtName=$(this).find('td:eq(1)').text();strPtDesc=$(this).find('td:eq(2)').text();row={'userId':strUserId,'userName':strUserName,'customName':strPtName,'prjId':prjId,'prjName':prjName,'ptName':strPtName,'ptDesc':strPtDesc,'iconColor':iconColor,'itemType':0,'groupId':groupId,'groupName':''};newPointList.push(row);}});}else{$('#tableWatch tbody tr').each(function(){if(_this.m_rowStyle==this.className){strPtName=$(this).find('td:eq(1)').text();strPtDesc=$(this).find('td:eq(2)').text();row={'itemId':_this.parent.m_selectItemId,'userId':strUserId,'userName':strUserName,'customName':strPtName,'prjId':prjId,'prjName':prjName,'ptName':strPtName,'ptDesc':strPtDesc,'iconColor':iconColor,'itemType':0,'groupId':groupId,'groupName':''};newPointList.push(row);return false;}});if(newPointList.length<1){return true;}
_this.parent.m_newPointList=newPointList;_this.parent.modifyTable();return true;}
if(newPointList.length<=0){alert(_this.m_lang.NO_SELECT_POINT);return;}
_this.parent.m_newPointList=newPointList;_this.parent.renderTabel();return true;},clearSearch:function clearSearch(){$('#dataSrcPtSearch').val('');},parsePointListByFmt:function parsePointListByFmt(src){var _this=this;var item;var parseList=[];var search_regex=null;try{search_regex=src.search?new RegExp(src.search,'i'):null;}catch(e){src.search=src.search.replace('.*','*').replace('*','.*');search_regex=src.search?new RegExp(src.search,'i'):null;}
for(var i=0,len=_this.m_pointList.pointList.length;i<len;i++){item=_this.m_pointList.pointList[i];if((_this.findInArray(src.arrCustom,item.custom)||0==src.arrCustom.length)&&(_this.findInArray(src.arrSystem,item.system)||0==src.arrSystem.length)&&(_this.findInArray(src.arrDevice,item.device)||0==src.arrDevice.length)&&(_this.findInArray(src.arrType,item.type)||0==src.arrType.length)){if(search_regex){if(search_regex.test(item.name)||search_regex.test(item.description)){parseList.push(item);}}else{parseList.push(item);}}}
return parseList;},findInArray:function findInArray(array,findVal){if(0==findVal){return false;}
var bFind=false;for(var i=0,len=array.length;i<len;i++){if(findVal==array[i]){bFind=true;break;}}
return bFind;},delInArray:function delInArray(array,delVal){for(var i=0,len=array.length;i<len;i++){if(delVal==array[i]){array.splice(i,1);break;}}},showFmtIntoList:function showFmtIntoList(showList){var _this=this;if(null==showList){return;}
var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td,item,div;var nSize=showList.length;for(var i=0;i<nSize;i++){item=showList[i];tr=document.createElement('tr');tr.className='';tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target);};td=document.createElement('td');td.textContent=i;tr.appendChild(td);td=document.createElement('td');td.textContent=item.name;td.title=item.name;$(td).css('max-width','350px');$(td).css('overflow-x','hidden');$(td).css('text-overflow','ellipsis');tr.appendChild(td);td=document.createElement('td');td.textContent=item.description;td.title=item.name;$(td).css('max-width','350px');$(td).css('overflow-x','hidden');$(td).css('text-overflow','ellipsis');tr.appendChild(td);if(item.system!=undefined&&item.device!=undefined&&item.type!=undefined){td=document.createElement('td');$(td).css('min-width','90px');if(''!=item.custom){div=document.createElement('div');div.textContent=item.custom;$(div).css('float','left');$(div).css('display','inline');$(div).css('color','#fff');$(div).css('border-radius','8px');$(div).css('padding','0 5px 0 5px');$(div).css('background-color','#428bca');td.appendChild(div);}
if(0!=item.system){div=document.createElement('div');div.className='iconComm';if(1==item.system){div.id='iconSys1';}else if(2==item.system){div.id='iconSys2';}else if(3==item.system){div.id='iconSys3';}else if(4==item.system){div.id='iconSys4';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
if(0!=item.device){div=document.createElement('div');div.className='iconComm';if(1==item.device){div.id='iconDev1';}else if(2==item.device){div.id='iconDev2';}else if(3==item.device){div.id='iconDev3';}else if(4==item.device){div.id='iconDev4';}else if(5==item.device){div.id='iconDev5';}else if(6==item.device){div.id='iconDev6';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
if(0!=item.type){div=document.createElement('div');div.className='iconComm';if(1==item.type){div.id='iconType1';}else if(2==item.type){div.id='iconType2';}else if(3==item.type){div.id='iconType3';}else if(4==item.type){div.id='iconType4';}else if(5==item.type){div.id='iconType5';}else if(6==item.type){div.id='iconType6';}else if(7==item.type){div.id='iconType7';}else if(8==item.type){div.id='iconType8';}else if(9==item.type){div.id='iconType9';}else if(10==item.type){div.id='iconType10';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
tr.appendChild(td);}
selectPt.append(tr);}},searchPoints:function searchPoints(){this.m_parseFmt.search=$('#dataSrcPtSearch').val();var show=this.parsePointListByFmt(this.m_parseFmt);this.showFmtIntoList(show);},searchPointsEx:function searchPointsEx(searchVal){var _this=this;Spinner.spin($('#divDataSourceAddPage')[0]);var prjId=$('#dataSrcPrjName').find('option:selected').val();WebAPI.get('/analysis/get_pointList_from_s3db/'+prjId+'/0/-1').done(function(result){_this.m_pointList={'pointList':result.pointList,'customName':result.customName,'pageAllNum':result.pageAllNum};_this.m_parseFmt.search=searchVal;var show=_this.parsePointListByFmt(_this.m_parseFmt);_this.showFmtIntoList(show);$('#navPageNum').css('display','none');}).error(function(e){document.getElementById('dialogContent').style.height='50%';}).always(function(e){Spinner.stop();});},initPointList:function initPointList(){var _this=this;_this.m_curPageNum=0;Spinner.spin($('#divDataSourceAddPage')[0]);var prjId=$('#dataSrcPrjName').find('option:selected').val();WebAPI.get('/analysis/get_pointList_from_s3db/'+prjId+'/0/50').done(function(result){_this.m_pointList={'pointList':result.pointList,'customName':result.customName,'pageAllNum':result.pageAllNum};_this.initNavCustomControls();_this.initNavPageNum(result.pageAllNum);_this.showPointListAll();$('#navPageNum').css('display','block');}).error(function(e){document.getElementById('dialogContent').style.height='50%';}).always(function(e){Spinner.stop();});}};return DataSourceOriginal;}();var DataSourceFormula=function(){function DataSourceFormula(_parent,_dsCfg){this.m_parent=_parent;this.m_dsCfg=_dsCfg;this.m_lang=I18n.resource.dataSource;}
DataSourceFormula.prototype={show:function show(){this.init();},init:function init(){var _this=this;$('#inputCustName').attr('placeholder',_this.m_lang.CUSTOM_NAME);$('#inputFormulaDesc').attr('placeholder',_this.m_lang.POINT_DESC);$('.mathquill-editable:not(.mathquill-rendered-math)').mathquill('editable');if(!_this.m_dsCfg.m_bIsAdd){$('#inputCustName').val(_this.m_dsCfg.m_customName);$('#inputFormulaDesc').val(_this.m_dsCfg.m_pointDesc);var strFormula=_this.m_dsCfg.m_pointName;var idSearchReg=/<%\w*%>/g;var arrPtName=strFormula.match(idSearchReg);var arrValName=[],arrValId=[];var valIdExistFlag;var valNameIndex=0;for(var i=0;i<arrPtName.length;++i){valIdExistFlag=false;for(var j=0;j<arrValId.length;++j){if(arrPtName[i].slice(2,arrPtName[i].length-2)==arrValId[j]){valIdExistFlag=true;break;}}
if(!valIdExistFlag){arrValId.push(arrPtName[i].slice(2,arrPtName[i].length-2));arrValName.push(String.fromCharCode("a".charCodeAt(0)+valNameIndex));valNameIndex+=1;}}
$('.varRow').parent().remove();var strValRow,strValIdDiv;var $varConfig=$('#varConfig');var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrValId);for(var i=0;i<arrValId.length;++i){for(var m=0;m<arrItem.length;m++){if(arrValId[i]==arrItem[m].id){strValIdDiv='<div class="col-lg-6 col-xs-8 formulaVarValue grow" varId="'+arrValId[i]+'">\
                                                    <span></span>\
                                                    <div>'+arrItem[m].alias+'</div>\
                                                    <span class="glyphicon glyphicon-remove-sign grow removeVarValue" aria-hidden="true" ></span>\
                                                    </div>';strValRow='<div class="row">\
                                            <div class="col-xs-12 varRow">\
                                                <div class="varRemove glyphicon glyphicon-remove-sign grow" aria-hidden="true"></div>\
                                                <div class="col-xs-4 formulaVarName"><input type="text" name="inputVarValue" class="varNameChange">'+arrValName[i]+'</div>\
                                                <div class="col-xs-6 divVarValue">'+strValIdDiv+'</div>\
                                            </div>\
                                        </div>';$varConfig.get(0).innerHTML+=strValRow;strFormula=strFormula.replace(new RegExp('<%'+arrValId[i]+'%>','g'),arrValName[i]);break;}}}
$('#editable-math').mathquill('latex',strFormula);}
_this.initElement();_this.dragInit();_this.varConfigInit();_this.varAddInit();$('.removeVarValue').on('click',function(){$(this).parents('.formulaVarValue').remove();});},initElement:function initElement(){var _this=this;var formulaResult;$('#btnFormulaDataAdd').click(function(e){var input=$('#inputCustName');var name=$('#inputCustName').val();if(''==name){input.focus();alert(_this.m_lang.CUSTOM_NOT_NULL);return;}
var strFormulaVal=_this.formulaGet();if('error'!=strFormulaVal){if(_this.m_dsCfg.m_bIsAdd){_this.m_parent.renderFormula(name,strFormulaVal,$('#inputFormulaDesc').val());}else{_this.m_parent.modifyFormula(name,strFormulaVal,$('#inputFormulaDesc').val());}
_this.m_parent.m_parent.showAnlsPane();$(_this.m_dsCfg.container).remove();}});$('#btnCancelFormulaData').click(function(e){_this.m_parent.m_parent.showAnlsPane();$(_this.m_dsCfg.container).remove();});},dragInit:function dragInit(){var _this=this;var $formulaVarRow=$('#varConfig .varRow').not('#varConfig .row:first-child');$formulaVarRow.on('dragenter',function(e){e.preventDefault();e.stopPropagation();});$formulaVarRow.on('dragover',function(e){e.preventDefault();$(e.currentTarget).addClass('varSel');});$formulaVarRow.on('dragleave',function(e){e.preventDefault();$(e.currentTarget).removeClass('varSel');});for(var i=0;i<$formulaVarRow.length;++i){$formulaVarRow[i].ondrop=function(e){var targetId;e.preventDefault();targetId=EventAdapter.getData().dsItemId;var formulaVarValue='<div class="col-lg-6 col-xs-8 formulaVarValue grow" varId="'+targetId+'">\
                                            <span></span>\
                                            <div>'+AppConfig.datasource.getDSItemById(targetId).alias+'</div>\
                                            <span class="glyphicon glyphicon-remove-sign grow removeVarValue" aria-hidden="true" ></span>\
                                            </div>';$(e.currentTarget).find('.divVarValue').html(formulaVarValue);$(e.currentTarget).find('.removeVarValue').on('click',function(){$(this).parents('.formulaVarValue').remove();});};}
$('#dataSrcPanel').on('dragend',function(e){e.preventDefault();$('.varSel').removeClass('varSel');});},varConfigInit:function varConfigInit(){var $varConfig=$('#varConfig');$('.formulaVarName').click(function(){$(this).children().css('display','inline');$(this).children().val(this.childNodes[1].textContent).focus();$(this).children('span').css('display','none');});$('.varNameChange').blur(function(){this.style.display='none';if(this.value!=''){this.parentNode.childNodes[1].textContent=this.value;}
$(this).next('span').css('display','inline');});$varConfig.find('.varRemove').on('click',function(){$(this).parents('.row').remove();});$varConfig.find('.removeVarValue').on('click',function(){$(this).parents('.formulaVarValue').remove();});},varAddInit:function varAddInit(){var $varConfig=$('#varConfig');var newVarName;var _this=this;$varConfig.find('.glyphicon-plus-sign').click(function(){newVarName=$('.formulaVarName').last().text();newVarName=newVarName.substr(0,newVarName.length-1)+String.fromCharCode(newVarName.charCodeAt(newVarName.length-1)+1);if(newVarName.charCodeAt(0)==0){newVarName='a';}
$varConfig.get(0).innerHTML+='<div class="row"><div class="col-xs-12 varRow">\
                                                    <div class="varRemove glyphicon glyphicon-remove-sign grow" aria-hidden="true"></div>\
                                                    <div class="col-lg-4 col-xs-4 formulaVarName"><input type="text" name="inputVarValue" class="varNameChange">'+newVarName+'</div>\
                                                    <div class="col-xs-6 divVarValue"></div>\
                                                </div></div>';_this.varAddInit();_this.dragInit();_this.varConfigInit();});},formulaGet:function formulaGet(){var $editableMath=$('#editable-math');var $varRow=$('#varConfig .varRow');var latexMathValue=$editableMath.mathquill('latex');var varNum=$varRow.length;var varId,varName;var searchReg;var varError=new Array();$('.varLack').remove();for(var i=0;i<varNum;++i){varName=$($varRow.find('.formulaVarName').get(i));varId=$($varRow.find('.divVarValue').get(i)).children().attr('varId');searchReg=new RegExp('\\b'+varName.text()+'\\b','g');if(searchReg.test(latexMathValue)){if(varId){latexMathValue=latexMathValue.replace(searchReg,'<%'+varId+'%>');}else{varError.push(varName);}}}
if(varError.length>0){for(var ele=0;ele<varError.length;++ele){varError[ele].append($('<span class="varLack">Unassigned!<span>'));}
alert('Lack Variable in Formula');return'error';}
return latexMathValue;}};return DataSourceFormula;}();var DataSource=function(){var _this;function DataSource(parent,opt){_this=this;this.m_parent=parent;this.m_newPointList=[];this.m_allPointList=[];this.m_allGroupList=[];this.m_arrProjIdColorMap={};this.m_dataSourceId;this.m_lang=I18n.resource.dataSource;this.m_selectItemId=0;this.m_selectGroupId=0;this.m_groupIconOpen='/static/images/dataSource/group_head_sel.png';this.m_groupIconClose='/static/images/dataSource/group_head_normal.png';this.m_cfgPanel;this.m_unassigned='unassigned';this.m_langFlag='zh'==localStorage['language']?0:1;this.$dsNavContain=undefined;this.m_curPageNum=1;this.m_arrCloudTableInfo=[];this.disableIot=opt&&opt.disableIot?true:false;this.treeObj=undefined;this.iotFilter=undefined;this.iotOpt={};}DataSource.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);I18n.fillArea($('#divAnlsDatasourcePane'));I18n.fillArea($('#divEnergyAnlsPane'));_this.loadDataSourceRecord();_this.initContain();_this.initElement();Spinner.stop();},close:function close(){this.m_newPointList=null;this.m_allPointList=null;},initContain:function initContain(){this.initTreeNavStyle();},initTreeNavStyle:function initTreeNavStyle(){WebAPI.get('/static/views/observer/dataSource.html').done(function(resultHtml){_this.$dsNavContain=$(resultHtml);I18n.fillArea(_this.$dsNavContain);var $pageMine=_this.$dsNavContain.find('#pageMine');var $pageCloud=_this.$dsNavContain.find('#pageCloud');var $pageIot=_this.$dsNavContain.find('#pageIot');AppConfig.isFactory&&_this.$dsNavContain.find('#liMine').css('display','none').attr('class','');_this.$dsNavContain.find('#liMine').click(function(e){$('#liMine').attr('class','active');$('#liCloud').attr('class','');$('#liIot').attr('class','');$pageMine.show();$pageCloud.hide();$pageIot.hide();_this.currentObj='mine';});_this.$dsNavContain.find('#liCloud').click(function(e){if(_this.m_arrCloudTableInfo.length<=0){_this.initDsCloud();}$('#liMine').attr('class','');$('#liCloud').attr('class','active');$('#liIot').attr('class','');$pageMine.hide();$pageIot.hide();$pageCloud.show();_this.currentObj='cloud';});if(_this.disableIot){_this.$dsNavContain.find('#liIot').remove();}else{_this.$dsNavContain.find('#liIot').click(function(e){$('#liMine').attr('class','');$('#liCloud').attr('class','');$('#liIot').attr('class','active');$pageMine.hide();$pageIot.html('').show();$pageCloud.hide();_this.initIotFilter();_this.currentObj='iot';});_this.initIotFilter();}_this.initDsMine();AppConfig.isFactory&&_this.initDsCloud();$('#dataSrcContain').empty();$('#dataSrcContain').append(_this.$dsNavContain);AppConfig.isFactory&&$('#liCloud').click();var addGroup=$('<div id="dataSrcAddGroup"><input type="text" id="inputAddGroup" placeholder="+ Add group" ></div>');$pageMine.append(addGroup);$('#inputAddGroup').attr('placeholder',I18n.resource.dataSource.ADD_GROUP);$pageMine.keyup(function(e){if(13==e.keyCode){_this.addNewGroup();}});var inputAdd=addGroup.find('#inputAddGroup');inputAdd.attr('placeholder',_this.m_lang.ADD_GROUP);inputAdd.blur(function(e){_this.addNewGroup();});}).always(function(e){});},initIotFilter:function initIotFilter(){var $ctn=_this.$dsNavContain.find('#pageIot');_this.iotFilter=new HierFilter($ctn);_this.iotFilter.init();_this.iotOpt=$.extend(true,{},{base:{divideByProject:true},tree:{show:true,event:{click:[{act:onNodeClick,tar:['groups','projects']},{act:ontThingClick,tar:'things'},{act:function act(){console.log('click things');},tar:'things'}]},drag:{dragstart:[{act:onAttrDragStart,tar:'attrs'},{act:onThingsDragStart,tar:'things'}],dragend:[{act:onAttrDragEnd,tar:'attrs'}]}}},_this.iotOpt);_this.iotFilter.setOption(_this.iotOpt);function onNodeClick(event,treeId,treeNode){if(_this.iotFilter.setDefault===true){if(!treeNode.children||treeNode.children.length==0)return;var node=treeNode.children[0];_this.iotFilter.tree.selectNode(node);_this.iotFilter.tree.setting.callback.onClick({target:document.getElementById(node.tId)},node['_id'],node);_this.iotFilter.setDefault=false;}}function ontThingClick(event,treeId,treeNode){var attrs=_this.iotFilter.dictClass['things'][treeNode.type].attrs;var arrNode=[];var node;for(var pt in treeNode.arrP){if(!attrs[pt])continue;node={'_id':treeNode.arrP[pt],'name':attrs[pt].name,'attrType':pt,'baseType':'attrs'};arrNode.push(node);}if(!treeNode.children||treeNode.children.length==0){_this.iotFilter.tree.addNodes(treeNode,arrNode,true);}}function onThingsDragStart(event,treeNode){EventAdapter.setData({'dsItemId':treeNode['_id'],'dsNode':treeNode});$('.templatePara').css('display','block');}function onAttrDragStart(event,treeNode){EventAdapter.setData({'dsItemId':treeNode['_id'],'dsNode':treeNode});$('.templatePara').css('display','block');}function onAttrDragEnd(){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');}function onNodeDblClick(event,treeId,treeNode,widget){}},initDsMine:function initDsMine(){var $inputSearch=_this.$dsNavContain.find('#inputDsMineSearch');$inputSearch.keyup(function(e){var searchVal=$(this).val().trim();if(13==e.keyCode&&searchVal){WebAPI.get('/analysis/datasource/searchDsItemInfo/'+AppConfig.userId+'/'+searchVal).done(function(result){var treeMine=_this.$dsNavContain.find('#treeMine');var zSetting={async:{enable:false},view:{addDiyDom:addDiyDom,addHoverDom:addHoverDom,removeHoverDom:removeHoverDom,selectedMulti:false,nameIsHTML:true},edit:{enable:true,drag:{isCopy:false,isMove:false}},data:{simpleData:{enable:true}},callback:{beforeRename:zTreeBeforeRename,beforeRemove:zTreeBeforeRemove}};function addDiyDom(treeId,treeNode){var $itemLeaf=$('#'+treeNode.tId);$itemLeaf.attr('ptid',treeNode.id);$itemLeaf.attr('draggable',true);EventAdapter.on($itemLeaf,'dragstart',function(e){$('.templatePara').css('display','block');var tar=$(e.target);var dragSrcId=tar.attr('ptid');EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($itemLeaf,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemLeaf,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});if(!treeNode.isParent){if(0==treeNode.type){var prjName=_this.getProjectNameFromId(treeNode.projId,_this.m_langFlag);_this.initToolTips($itemLeaf,treeNode.name,prjName,treeNode.value,treeNode.note);}else if(1==treeNode.type){var showName=_this.getShowNameFromFormula(treeNode.value);_this.initFormulaToolTips($itemLeaf,treeNode.name,showName,treeNode.note);}}}function addHoverDom(treeId,treeNode){if(!treeNode.isParent){_this.setHoverColor(treeNode);}}function removeHoverDom(treeId,treeNode){if(!treeNode.isParent){_this.removeHoverColor(treeNode);}}function zTreeBeforeRename(treeId,treeNode,newName,isCancel){_this.zTreeBeforeRenameFunc(treeNode,newName);}function zTreeBeforeRemove(treeId,treeNode){_this.zTreeBeforeRemoveFunc(treeNode);}var zNodes=_this.generateSearchTree(result,searchVal);_this.treeObj=$.fn.zTree.init(treeMine,zSetting,zNodes);$('#dataSrcAddGroup').hide();});}if(!searchVal){_this.initDsMineTree();$('#dataSrcAddGroup').show();}});_this.$dsNavContain.find('#spanDsMineSearch').click(function(e){$inputSearch.val('');_this.initDsMineTree();$('#dataSrcAddGroup').show();});_this.initDsMineTree();$('#dataSrcAddGroup').show();},initDsMineTree:function initDsMineTree(){var zSetting={async:{enable:true,type:'get',url:function url(treeId,treeNode){return'/analysis/datasource/getDsItemInfo/'+AppConfig.userId+'/'+(typeof treeNode==='undefined'?'null':treeNode.id);},dataFilter:dsItemfilter},view:{addDiyDom:addDiyDom,addHoverDom:addHoverDom,removeHoverDom:removeHoverDom,selectedMulti:false},edit:{enable:true,renameTitle:I18n.resource.dataSource.RENAME,removeTitle:I18n.resource.dataSource.REMOVE,drag:{isCopy:false,isMove:false}},data:{keep:{leaf:true,parent:true},simpleData:{enable:true}},callback:{beforeRename:zTreeBeforeRename,beforeRemove:zTreeBeforeRemove,onAsyncSuccess:zTreeOnAsyncSuccess,onAsyncError:zTreeOnAsyncError,beforeEditName:zTreeBeforEditName}};function zTreeBeforEditName(treeId,treeNode){if(treeNode.note&&treeNode.note!==''&&treeNode.name.indexOf(treeNode.note)>=0){treeNode.name=treeNode.name.split('(')[1].split(')')[0];}}function dsItemfilter(treeId,parentNode,responseData){Spinner.spin(_this.$dsNavContain[2]);return _this.generateTreeEx(responseData);}function addDiyDom(treeId,treeNode){if(treeNode.num){var aObj=_this.$dsNavContain.find("#"+treeNode.tId+"_switch");var $badge=$('<span class="badge treeBadge">'+treeNode.num+'</span>');aObj.next('a').after($badge);}var $itemLeaf=_this.$dsNavContain.find('#'+treeNode.tId);$itemLeaf.attr('ptid',treeNode.id);$itemLeaf.attr('draggable',true);EventAdapter.on($itemLeaf,'dragstart',function(e){$('.templatePara').css('display','block');var tar=$(e.target);var dragSrcId=tar.attr('ptid');EventAdapter.setData({'dsItemId':dragSrcId});_this.stopBubble(e);});EventAdapter.on($itemLeaf,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemLeaf,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});EventAdapter.on($itemLeaf,'drop',function(e){var tar=$(e.target);var dstTLi=tar.closest('li');var dstId=dstTLi.eq(0).attr('id');var dstNode=_this.treeObj.getNodeByTId(dstId);var srcId=EventAdapter.getData().dsItemId;var srcJq=$('li[ptid$='+srcId+']');var srcTId=srcJq.eq(0).attr('id');var srcNode=_this.treeObj.getNodeByTId(srcTId);var dstParentId=dstNode.pId;var dstParentJq=$('li[ptid$='+dstParentId+']');var dstParentTId=dstParentJq.eq(0).attr('id');var dstParentNode=_this.treeObj.getNodeByTId(dstParentTId);var srcParentId=srcNode.pId;var srcParentJq=$('li[ptid$='+srcParentId+']');var srcParentTId=srcParentJq.eq(0).attr('id');var srcParentNode=_this.treeObj.getNodeByTId(srcParentTId);var postData={};var arrSrc=[];var arrDst=[];var srcParId=srcNode.pId;var dstParId=dstNode.pId;var saveType=0;if(srcNode.isParent&&!dstNode.isParent){return;}else if(!srcNode.isParent&&!dstNode.isParent){if(_this.treeObj.moveNode(dstNode,srcNode,'next',true)){if(srcParId==dstParId){$.each(dstParentNode.children,function(i,n){arrDst.push(n.id);});postData[dstParentId]=arrDst;}else{$.each(srcParentNode.children,function(i,n){arrSrc.push(n.id);});$.each(dstParentNode.children,function(i,n){arrDst.push(n.id);});var nSrcIdx=srcParentNode.getIndex();var nDstIdx=dstParentNode.getIndex();if(nDstIdx<nSrcIdx){postData[dstParId]=arrDst;postData[srcParId]=arrSrc;}else{postData[srcParId]=arrSrc;postData[dstParId]=arrDst;}}}}else if(!srcNode.isParent&&dstNode.isParent){if(_this.treeObj.moveNode(dstNode,srcNode,'inner',true)){if(srcParentNode.children){$.each(srcParentNode.children,function(i,n){arrSrc.push(n.id);});}$.each(dstNode.children,function(i,n){arrDst.push(n.id);});var nSrcIdx=srcParentNode.getIndex();var nDstIdx=dstNode.getIndex();if(nDstIdx<nSrcIdx){postData[dstNode.id]=arrDst;postData[srcParId]=arrSrc;}else{postData[srcParId]=arrSrc;postData[dstNode.id]=arrDst;}}}else if(srcNode.isParent&&dstNode.isParent){saveType=1;var nSrcIdx=srcNode.getIndex();var nDstIdx=dstNode.getIndex();if(_this.treeObj.moveNode(dstNode,srcNode,'next',true)){var liGroup=$('#treeMine').children('li');if(liGroup&&liGroup.length>0){postData.groupIdList=[];$.each(liGroup,function(i,n){postData.groupIdList.push($(n).attr('ptid'));});}}}if(0==saveType){WebAPI.post('/analysis/datasource/saveLayout/'+AppConfig.userId,postData).done(function(data){if(data.success){}}).always(function(){});}else if(1==saveType){WebAPI.post('/datasource/saveDataSourceGroupLayout/'+AppConfig.userId,postData).done(function(data){if('successful'==data.error){}}).always(function(){});}_this.stopBubble(e);});if(treeNode.id==sessionStorage.getItem('dsOpenGroupId')){sessionStorage.removeItem('dsOpenGroupId');if(treeNode.isParent&&_this.treeObj){_this.treeObj.expandNode(treeNode,true,false,true);}}if(!treeNode.isParent){if(0==treeNode.type){var prjName=_this.getProjectNameFromId(treeNode.projId,_this.m_langFlag);_this.initToolTips($itemLeaf,treeNode.name,prjName,treeNode.value,treeNode.note);}else if(1==treeNode.type){var showName=_this.getShowNameFromFormula(treeNode.value);_this.initFormulaToolTips($itemLeaf,treeNode.name,showName,treeNode.note);}}}
function addHoverDom(treeId,treeNode){if(treeNode.isParent){var sObj=$("#"+treeNode.tId+"_span");if(treeNode.editNameFlag||$("#addBtn_"+treeNode.tId).length>0){return;}
if(0==$("#addBtnFormula_"+treeNode.tId).length){var addStr="<span class='iconfont' id='addBtnFormula_"+treeNode.tId+"' title='add group' onfocus='this.blur();' style='margin-left:4px'>&#xe63e;</span>";sObj.after(addStr);var btnGroup=$("#addBtnFormula_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_FORMULA);if(btnGroup)btnGroup.bind("click",function(){if(_this.m_cfgPanel){$(_this.m_cfgPanel.container).remove();}var addInterface=$('#addPointPanelContain');if(!addInterface||addInterface.length>0){return;}_this.m_selectGroupId=treeNode.id;WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).always(function(e){});return false;});}if(0==$("#addBtnPage_"+treeNode.tId).length){var addStr="<span class='glyphicon glyphicon-plus-sign button' id='addBtnPage_"+treeNode.tId+"' title='add point' onfocus='this.blur();' style='margin-left:4px;top:2px'></span>";sObj.after(addStr);var btnGroup=$("#addBtnPage_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_POINT);if(btnGroup)btnGroup.bind("click",function(){var parentNodes=_this.treeObj.getNodesByParam('id',treeNode.id,null);if(parentNodes.length>0){if(!parentNodes[0].zAsync){_this.treeObj.expandNode(parentNodes[0],true,false,true);}}if(_this.m_cfgPanel){$(_this.m_cfgPanel.container).remove();}var addInterface=$('#addPointPanelContain');if(!addInterface||addInterface.length>0){return;}_this.m_selectGroupId=treeNode.id;WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).always(function(e){});return false;});}if(0==$("#addBtnGroup_"+treeNode.tId).length){var addStr="<span class='glyphicon glyphicon-object-align-bottom button' aria-hidden='true' id='addBtnGroup_"+treeNode.tId+"' title='add group' onfocus='this.blur();' style='margin-left:20px;top:2px'></span>";sObj.after(addStr);var btnGroup=$("#addBtnGroup_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_POINT_GROUP);if(btnGroup)btnGroup.bind("click",function(){var newName='new group';var postData={'groupId':'','name':newName,'parent':treeNode.id.toString(),'userId':AppConfig.userId};WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){if('successful'!=result.error){return;}var groupId=result.groupId;if(groupId){if(_this.treeObj){if(treeNode.zAsync){_this.treeObj.addNodes(treeNode,{id:result.groupId,pId:result.parentId,name:result.groupName,isParent:true});}else{_this.treeObj.expandNode(treeNode,true,false,true);}}}}).always(function(e){});return false;});}}else{_this.setHoverColor(treeNode);}};function removeHoverDom(treeId,treeNode){$("#addBtnGroup_"+treeNode.tId).unbind().remove();$("#addBtnPage_"+treeNode.tId).unbind().remove();$("#addBtnFormula_"+treeNode.tId).unbind().remove();if(!treeNode.isParent){_this.removeHoverColor(treeNode);}};function zTreeBeforeRename(treeId,treeNode,newName,isCancel){_this.zTreeBeforeRenameFunc(treeNode,newName);}function zTreeBeforeRemove(treeId,treeNode){confirm(I18n.resource.dataSource.DELETE_GROUP_INFO,function(){_this.zTreeBeforeRemoveFunc(treeNode);_this.treeObj.removeNode(treeNode);});return false;}function zTreeOnAsyncSuccess(event,treeId,treeNode,msg){Spinner.stop();};function zTreeOnAsyncError(event,treeId,treeNode,XMLHttpRequest,textStatus,errorThrown){Spinner.stop();};$(document).ready(function(){var treeMine=_this.$dsNavContain.find('#treeMine');var arrInit=_this.generateTreeEx(_this.m_parent.store.group);_this.treeObj=$.fn.zTree.init(treeMine,zSetting,arrInit);});},zTreeBeforeRenameFunc:function zTreeBeforeRenameFunc(treeNode,newName){if(treeNode.isParent){var postData={'groupId':treeNode.id,'name':newName,'parent':Boolean(treeNode.pId)?treeNode.pId.toString():'','userId':AppConfig.userId};WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){if('successful'!=result.error){return false;}}).always(function(e){return true;});}else{var treeNodeNote=treeNode.note?treeNode.note:'';newName=treeNodeNote!==''?treeNodeNote+'('+newName+')':newName;var postData={itemList:[{id:treeNode.id,type:0,projId:treeNode.projId,alias:newName,note:treeNode.note,value:treeNode.value,groupId:treeNode.pId}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.itemIdList.length>0){return true;}return false;}).error(function(e){return false;}).always(function(e){treeNode.name=newName;$('#treeMine').find('li[ptid='+treeNode.id+']').find('a span').eq(1).text(newName);});}},zTreeBeforeRemoveFunc:function zTreeBeforeRemoveFunc(treeNode){if(treeNode.isParent){WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+treeNode.id).done(function(result){if('successful'!=result.error){return false;}}).always(function(e){return true;});}else{var $itemLeaf=_this.$dsNavContain.find('#'+treeNode.tId);if($itemLeaf&&$itemLeaf.length>0){$itemLeaf.tooltip('destroy');}WebAPI.get('/analysis/datasource/removeSingle/'+treeNode.id).done(function(data){if(!data.success){return false;}else{var parentId=treeNode.pId;var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num-=1;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge');if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}break;}}return true;}}).always(function(){});}},generateTreeEx:function generateTreeEx(arr){var result=[];if(!arr){return result;}var params;var unassigned;for(var i=0,len=arr.length;i<len;i++){var item=arr[i];if(item){var itemNode=item.note?item.note:'';var itemAlias=item.alias?item.alias:'';var itemName=itemAlias;if(itemNode!==''&&itemAlias!==''){if(itemAlias.indexOf(itemNode)<0){itemName=itemNode+' ('+itemAlias+')';}}params={id:item.id,pId:item.parentId,isParent:item.isParent,name:itemName,value:item.value,note:item.note,projId:item.projId,num:item.num,type:item.type};if(!item.isParent){var leafIcon=1==item.type?'ptFormula':'ptNormal';params['iconSkin']=leafIcon;}if('unassigned'==item.alias){unassigned=params;}else{result.push(params);}}}if(unassigned){result.push(unassigned);}return result;},generateSearchTree:function generateSearchTree(arr,searchText){var result=[];var params;for(var id in arr){params={id:id,pId:null,isParent:true,name:arr[id].groupName,value:id,note:'',projId:'',type:0,open:true};result.push(params);if(arr[id].dsList){for(var i=0,len=arr[id].dsList.length;i<len;i++){var item=arr[id].dsList[i];var keyWordName=item.alias;searchText.replace(/[^\w\d\s\u4e00-\u9fa5]/g,' ').split(/\s/g).forEach(function(search_item){if(search_item){keyWordName=keyWordName.replace(new RegExp("("+search_item+")(?![^<]*>|[^<>]*</)","gi"),'<span class="keyword">$1</span>');}});params={id:item.id,pId:id,isParent:false,name:keyWordName,value:item.value,note:item.note,projId:item.projId,type:item.type,iconSkin:1==item.type?'ptFormula':'ptNormal'};result.push(params);}}}return result;},setHoverColor:function setHoverColor(treeNode){var $row=$('#'+treeNode.tId);if($row&&$row.length>0){$row.css('background-color','#FFE6B0');var $name=$('#'+treeNode.tId+'_span');if($name&&$name.length>0){$name.css('color','#000');}$row.find('.edit').css('color','#000');$row.find('.remove').css('color','#000');}},removeHoverColor:function removeHoverColor(treeNode){var $row=$('#'+treeNode.tId);if($row&&$row.length>0){$row.css('background-color','');var $name=$('#'+treeNode.tId+'_span');if($name&&$name.length>0){$name.css('color','');}$row.find('.edit').css('color','');$row.find('.remove').css('color','');}},initDsCloud:function initDsCloud(){var $selPrjName=_this.$dsNavContain.find('#selectPrjName');$selPrjName.empty();var opt;var prjId=AppConfig.project&&AppConfig.project.bindId?AppConfig.project.bindId:AppConfig.projectId;var nSize=AppConfig.projectList.length;for(var i=0;i<nSize;i++){var project=AppConfig.projectList[i];opt=document.createElement('option');if(0==_this.m_langFlag){opt.textContent=project.name_cn;}else{opt.textContent=project.name_english;}opt.value=project.id;$selPrjName.append(opt);}$selPrjName.val(prjId);$selPrjName.change(function(e){var prjId=$('#selectPrjName').find('option:selected').val();_this.initDsCloudTable(prjId,1,50);});var $inputSearch=_this.$dsNavContain.find('#inputDsCloudSearch');$inputSearch.keyup(function(e){var searchVal=$(e.currentTarget).val();if(13==e.keyCode){var prjId=_this.$dsNavContain.find('#selectPrjName').val();if(!prjId){return false;}var size=50;WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:1,pageSize:size,searchText:searchVal}).done(function(result){if(result.success&&result.data){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');$tableBody.empty();_this.setCloudTable(result.data.pointTable);var ptTotal=result.data.pointTotal;var allPageNum=Math.ceil(ptTotal/size);_this.setCloudNav(allPageNum);}}).always(function(e){});}if(''==searchVal){_this.initDsCloudFunc();}});_this.$dsNavContain.find('#spanDsCloudSearch').click(function(e){$inputSearch.val('');_this.initDsCloudFunc();});_this.initDsCloudTable(prjId,1,50);},initDsCloudTable:function initDsCloudTable(prjId,page,size){if(!prjId){return false;}Spinner.spin(_this.$dsNavContain[2]);WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:page,pageSize:size}).done(function(result){if(result.success&&result.data){_this.m_arrCloudTableInfo=result.data.pointTable;_this.setCloudTable(_this.m_arrCloudTableInfo);var ptTotal=result.data.pointTotal;var allPageNum=Math.ceil(ptTotal/size);_this.setCloudNav(allPageNum);}}).always(function(e){Spinner.stop();});},initDsCloudFunc:function initDsCloudFunc(){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');$tableBody.empty();var prjId=_this.$dsNavContain.find('#selectPrjName').val();_this.initDsCloudTable(prjId,1,50);},setCurrentPage:function setCurrentPage(curPageNum,size){curPageNum=parseInt(curPageNum,10);var prjId=_this.$dsNavContain.find('#selectPrjName').val();if(!prjId){return false;}Spinner.spin(_this.$dsNavContain[2]);WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:curPageNum,pageSize:size,searchText:_this.$dsNavContain.find('#inputDsCloudSearch').val()}).done(function(result){if(result.success&&result.data){var ptTotal=result.data.pointTotal?result.data.pointTotal:0;var allPageNum=Math.ceil(ptTotal/size);_this.m_curPageNum=curPageNum;var liPageNum=$('#navPageNum').find('.pageNum');if(curPageNum<=3){liPageNum.eq(0).attr('value','1');liPageNum.eq(1).attr('value','2');liPageNum.eq(2).attr('value','3');liPageNum.eq(3).attr('value','4');liPageNum.eq(4).attr('value','5');liPageNum.eq(0).text('1');liPageNum.eq(1).text('2');liPageNum.eq(2).text('3');liPageNum.eq(3).text('4');liPageNum.eq(4).text('5');}else if(curPageNum>=allPageNum-2){liPageNum.eq(0).attr('value',allPageNum-4);liPageNum.eq(1).attr('value',allPageNum-3);liPageNum.eq(2).attr('value',allPageNum-2);liPageNum.eq(3).attr('value',allPageNum-1);liPageNum.eq(4).attr('value',allPageNum);liPageNum.eq(0).text(allPageNum-4);liPageNum.eq(1).text(allPageNum-3);liPageNum.eq(2).text(allPageNum-2);liPageNum.eq(3).text(allPageNum-1);liPageNum.eq(4).text(allPageNum);}else{liPageNum.eq(0).attr('value',curPageNum-2);liPageNum.eq(1).attr('value',curPageNum-1);liPageNum.eq(2).attr('value',curPageNum);liPageNum.eq(3).attr('value',curPageNum+1);liPageNum.eq(4).attr('value',curPageNum+2);liPageNum.eq(0).text(curPageNum-2);liPageNum.eq(1).text(curPageNum-1);liPageNum.eq(2).text(curPageNum);liPageNum.eq(3).text(curPageNum+1);liPageNum.eq(4).text(curPageNum+2);}
for(var i=0,len=liPageNum.length;i<len;i++){var item=liPageNum.eq(i);if(item.attr('value')==curPageNum){item.closest('li').attr('class','active');}else{item.closest('li').removeAttr('class');}}_this.setCloudTable(result.data.pointTable);}}).always(function(e){Spinner.stop();});},setCloudTable:function setCloudTable(ptTable,searchText){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');if($tableBody){$tableBody.empty();for(var i=0,len=ptTable.length;i<len;i++){var $itemTr=$('<tr ptId="'+ptTable[i]._id+'" draggable="true" title="'+ptTable[i].value+' : '+ptTable[i].alias+' "></tr>');var $itemTd=$('<td>');var $itemTdName=$('<span class="tabColName" data-value="'+ptTable[i].value+'">'+ptTable[i].value+'</span>');var $itemTdDesc=$('<span class="tabColDesc"> -- '+ptTable[i].alias+'</span>');var $itemTdIcon=$('<span class="btnFav glyphicon glyphicon-plus-sign" aria-hidden="true"></span>');$itemTdIcon.off().click(function(e){var $row=$(e.currentTarget).closest('tr');var ptId=$row.attr('ptId');for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){if(ptId==_this.m_arrCloudTableInfo[i]._id){_this.insertIntoMineTable(_this.m_arrCloudTableInfo[i]);break;}}});$itemTd.append($itemTdName);$itemTdDesc.append($itemTdIcon);$itemTd.append($itemTdDesc);$itemTr.append($itemTd);var start=null;EventAdapter.on($itemTr,'click',function(e){e=e||event;var $this=$(this);var $tableDsCloud=$('#tableDsCloud');var trArr=$tableDsCloud.find('tr');if(e.ctrlKey){if(!e.shiftKey){if($this.hasClass('activeTr')){$this.removeClass('activeTr');}else{$this.addClass('activeTr');}start=this;}else{var startIndex=$(start).index(),lastIndex=$this.index();var selTr=trArr.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);if($(start).hasClass('activeTr')){selTr.addClass('activeTr');}else{selTr.removeClass('activeTr');}}}else if(e.shiftKey){if($('.activeTr').length!==0){var startIndex=$(start).index(),lastIndex=$this.index();var selTr=trArr.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);selTr.addClass('activeTr');trArr.not(selTr).removeClass('activeTr');}else{$this.addClass('activeTr');}}else{trArr.removeClass('activeTr');$this.addClass('activeTr');start=this;}});EventAdapter.on($itemTr,'dragstart',function(e){$('.templatePara').css('display','block');var tar=$('.activeTr').length>1?$('.activeTr'):$(e.target);var targetId=$(e.target).attr('ptid');var dragSrcId=undefined,isDragMore=false,dragId=[];if($('.activeTr').length>1){tar.each(function(i,item){var itemId=$(item).attr('ptid');if(itemId===targetId){isDragMore=true;}dragId.push(itemId);});if(isDragMore){dragSrcId=dragId;}else{dragSrcId=targetId;}}else{dragSrcId=tar.attr('ptid');}
EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($itemTr,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemTr,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});$tableBody.append($itemTr);}}},setCloudNav:function setCloudNav(allPageNum){var ul=$('<ul class="pagination">\
                <li><a class="pageFlag" value="First"><span aria-hidden="true">&laquo;</span></a></li>\
                <li><a class="pageFlag" value="Previous"><span aria-hidden="true">&lsaquo;</span></a></li>\
            </ul>');if(allPageNum>5){ul.append('<li class="active"><a class="pageFlag pageNum" value="1">1</a></li>\
                    <li><a class="pageFlag pageNum" value="2">2</a></li>\
                    <li><a class="pageFlag pageNum" value="3">3</a></li>\
                    <li><a class="pageFlag pageNum" value="4">4</a></li>\
                    <li><a class="pageFlag pageNum" value="5">5</a></li>');}else{for(var i=0;i<allPageNum;i++){var numTmp=i+1;if(0==i){ul.append('<li class="active"><a class="pageFlag pageNum" value="'+numTmp+'">'+numTmp+'</a></li>');}else{ul.append('<li><a class="pageFlag pageNum" value="'+numTmp+'">'+numTmp+'</a></li>');}}}ul.append('<li><a class="pageFlag" value="Next"><span aria-hidden="true">&rsaquo;</span></a></li>\
                        <li><a class="pageFlag" value="Last"><span aria-hidden="true">&raquo;</span></a></li>');var pageFlag=ul.find('.pageFlag');pageFlag.click(function(e){var value=$(e.currentTarget).attr('value');if('First'==value){if(_this.m_curPageNum!=1){_this.setCurrentPage(1,50);}}else if('Previous'==value){if(_this.m_curPageNum>1){_this.setCurrentPage(_this.m_curPageNum-1,50);}}else if('Next'==value){if(_this.m_curPageNum<allPageNum){_this.setCurrentPage(_this.m_curPageNum+1,50);}}else if('Last'==value){if(_this.m_curPageNum!=allPageNum){_this.setCurrentPage(allPageNum,50);}}else{if(_this.m_curPageNum!=value){_this.setCurrentPage(value,50);}}});var $navPage=_this.$dsNavContain.find('#navPageNum');$navPage.empty();$navPage.append(ul);},insertIntoMineTable:function insertIntoMineTable(newNode){var nodeParent=_this.treeObj.getNodesByParam('name','unassigned',null);if(nodeParent.length>0){var postData={itemList:[{type:0,projId:newNode.projId,alias:newNode.value,value:newNode.value,groupId:nodeParent[0].id}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.itemIdList.length>0){var item=data.itemIdList[0];var obj={id:item.id,pId:item.groupId,name:item.alias,isParent:false,value:item.value,note:item.note};_this.treeObj.addNodes(nodeParent[0],-1,obj);}}).always(function(e){});}},initElement:function initElement(){var _this=this;var len=AppConfig.projectList.length;var item;if(!(_this.m_parent.arrColor instanceof Array))return;var nColorSize=_this.m_parent.arrColor.length;for(var i=0;i<len;i++){item=AppConfig.projectList[i];_this.m_arrProjIdColorMap[item.id]=_this.m_parent.arrColor[i-parseInt(i/nColorSize)*nColorSize];}EventAdapter.on($('#data_source_add'),'click',function(e){if(0==_this.m_selectGroupId){alert(_this.m_lang.NO_SELECT_GROUP);return;}if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});EventAdapter.on($('#data_source_formula_add'),'click',function(e){if(0==_this.m_selectGroupId){alert(_this.m_lang.NO_SELECT_GROUP);return;}if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});EventAdapter.on($('#divAnlsDatasourcePane'),'click',function(e){_this.clearSelect();},false);$('#inputDsSearch').keyup(function(e){var searchVal=$(e.currentTarget).val();if(13==e.keyCode){$('#dataSrcPanel').empty();searchVal=searchVal.toLowerCase();_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,searchVal);$('#dataSrcAddGroup').hide();}if(''==searchVal){$('#dataSrcPanel').empty();_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,'');_this.colapseGroupsDefault();$('#dataSrcAddGroup').show();}});},insertIntoDataList:function insertIntoDataList(customName,ptName,ptDesc,prjName,iconColor,itemId,baseNode,bIsAppend,bIsSelected){var _this=this;var div;if(bIsSelected){div=$('<div draggable="true" class="dsItem grow dsSelected" style="height:34px"></div>');}else{div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');}div.attr('id',itemId);div.click(function(e){_this.clearSelect();var target=$(e.currentTarget);if('dsItem grow'==target.attr('class')){target.attr('class','dsItem grow dsSelected');}else{target.attr('class','dsItem grow');}_this.stopBubble(e);});var icon=$('<div class="dsMark"></div>');icon.css('background-color',iconColor);div.append(icon);var custName=$('<div class="dsValue" style="height:36px;">'+customName+'</div>');div.append(custName);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}_this.m_selectItemId=$(e.currentTarget).closest('.dsItem').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){confirm(_this.m_lang.REMOVE_CONFIRM_TIPS,function(){var div=$(e.currentTarget).closest('.dsItem');var dataSrcItemId=div.attr('id');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=data.deleteModal;var len=arr.length;if(len>0){var delMod;var arrDelTitle=[];for(var i=0;i<len;i++){delMod=$('#'+arr[i]);arrDelTitle.push(delMod.find('.newDivPageTitle').val());delMod.remove();}var delTitle=_this.m_lang.WORKSPACE+':';for(var i=0,len=arrDelTitle.length;i<len;i++){delTitle+=arrDelTitle[i]+' ';}delTitle+=_this.m_lang.REMOVE_RESULT;alert(delTitle);}}});});});div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>');var ctlPrjName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.PROJECT_NAME+': '+prjName+'</label></div>');ctlPrjName.click(function(e){_this.stopBubble(e);});divChange.append(ctlPrjName);var ctlPtName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.POINT_NAME+': '+ptName+'</label></div>');ctlPtName.click(function(e){_this.stopBubble(e);});divChange.append(ctlPtName);var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find('label').text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find('input');ctlInput.attr('value',customName);ctlInput.attr('placeholder',_this.m_lang.CUSTOM_NAME);inputCustName.click(function(e){_this.stopBubble(e);});divChange.append(inputCustName);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find('label').text(_this.m_lang.POINT_DESC);ctlInput=inputDesc.find('input');ctlInput.attr('value',ptDesc);ctlInput.attr('placeholder',_this.m_lang.POINT_DESC);inputDesc.click(function(e){_this.stopBubble(e);});divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE);btnOk.click(function(e){var temp=$(e.currentTarget).closest('.dsDivChange').find('input');var strName=$(temp[0]).val();var strDesc=$(temp[1]).val();var prjId,ptName,item;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){prjId=item.prjId;ptName=item.ptName;break;}}var postData={itemList:[{id:itemId,type:0,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:''}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){var id=data.itemIdList[0].id;for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName;_this.m_allPointList[i].ptDesc=strDesc;break;}}_this.setToolTipsCustomName(div,strName);_this.setToolTipsDesc(div,strDesc);_this.calUpdateDataSources();$('#'+id).find('.dsValue').text(strName);}).error(function(e){});});divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL);btnCancel.click(function(e){});divChange.append(btnCancel);div.append(divChange);if(bIsAppend){baseNode.append(div);}else{baseNode.after(div);}},initToolTips:function initToolTips(parent,customName,projectName,pointName,pointDesc){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="customName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="projectName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.PROJECT_NAME).append('</span>: ').append(projectName).append('</p> ');show.append('        <p class="pointName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_NAME).append('</span>: ').append(pointName).append('</p> ');show.append('        <p class="pointDesc tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(pointDesc).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'left',title:_this.m_lang.PARAM,template:show.toString(),trigger:'hover'};parent.tooltip(options);},setToolTipsAll:function setToolTipsAll(row,userName,customName,projectName,pointName,pointDesc){var tip=row.data('bs.tooltip').$tip;userName=': '+userName;customName=': '+customName;projectName=': '+projectName;pointName=': '+pointName;pointDesc=': '+pointDesc;tip.find('.userName').text(this.m_lang.USER_NAME+userName);tip.find('.customName').text(this.m_lang.CUSTOM_NAME+customName);tip.find('.projectName').text(this.m_lang.PROJECT_NAME+projectName);tip.find('.pointName').text(this.m_lang.POINT_NAME+pointName);tip.find('.pointDesc').text(this.m_lang.POINT_DESC+pointDesc);},setToolTipsCustomName:function setToolTipsCustomName(row,customName){var tip=row.data('bs.tooltip').$tip;tip.find('.customName').text(this.m_lang.CUSTOM_NAME+': '+customName);},setToolTipsDesc:function setToolTipsDesc(row,ptDesc){var tip=row.data('bs.tooltip').$tip;tip.find('.pointDesc').text(this.m_lang.POINT_DESC+': '+ptDesc);},renderTabel:function renderTabel(){var _this=this;var len=_this.m_newPointList.length;if(len<=0){return;}var div=$('#dataSrcPanel');var rowBaseNum=div.find('.dsItem').length;var rowCount;var item;var eachItem;var postData;len=_this.m_newPointList.length;if(len>0){postData={itemList:[]};var arrOld=[];var bIsExist=false;var parentId=_this.m_newPointList[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){arrOld=parentNodes[0].children;}for(var i=0;i<len;i++){item=_this.m_newPointList[i];eachItem={type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId};var bFlag=false;for(var j=0;j<arrOld.length;j++){if(item.prjId==arrOld[j].projId&&item.ptName==arrOld[j].value){bIsExist=true;bFlag=true;break;}}if(!bFlag){postData.itemList.push(eachItem);}}if(bIsExist){alert(I18n.resource.dataSource.ALREADY_EXIST);}var projName=_this.m_newPointList[0].prjName;var iconColor=_this.m_newPointList[0].iconColor;if(postData.itemList.length>0){WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.datasourceId){_this.m_dataSourceId=data.datasourceId;}var list=data.itemIdList;var nAddlen=postData.itemList.length;for(var i=0;i<nAddlen;i++){if(postData.itemList[i].alias==list[i].alias){postData.itemList[i].itemId=list[i].id;}}
if(_this.treeObj){var parentId=_this.m_newPointList[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){if(parentNodes[0].zAsync){var arrNodes=[];for(var i=0;i<postData.itemList.length;i++){var item=postData.itemList[i];var itemNode=item.note?item.note:'';var itemAlias=item.alias?item.alias:'';var itemName=itemAlias;if(itemNode!==''&&itemAlias!==''){if(itemAlias.indexOf(itemNode)<0){itemName=itemNode+' ('+itemAlias+')';}}arrNodes.push({id:item.itemId,pId:item.groupId,isParent:false,name:itemName,value:item.value,projId:item.projId,note:item.note,type:0,iconSkin:'ptNormal'});}_this.treeObj.addNodes(parentNodes[0],arrNodes);}else{_this.treeObj.expandNode(parentNodes[0],true,false,true);}
var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num+=nAddlen;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge');if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}break;}}}}
_this.m_allPointList=_this.m_allPointList.concat(_this.m_newPointList);_this.calUpdateDataSources();}).error(function(){}).always(function(){});}}},modifyTable:function modifyTable(){var _this=this;var item;var eachItem;var postData;var len=_this.m_newPointList.length;if(len>0){postData={itemList:[]};item=_this.m_newPointList[0];eachItem={id:item.itemId,type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId};postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.datasourceId){_this.m_dataSourceId=data.datasourceId;}for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(item.itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].prjId=item.prjId;_this.m_allPointList[i].prjName=_this.m_newPointList[0].prjName;_this.m_allPointList[i].customName=item.customName;_this.m_allPointList[i].ptName=item.ptName;_this.m_allPointList[i].ptDesc=item.ptDesc;break;}}
var divItem=$('#'+item.itemId);divItem.find('.showName').text(item.customName);_this.setToolTipsAll(divItem,item.userName,item.customName,item.prjName,item.ptName,item.ptDesc);_this.calUpdateDataSources();Beop.cache.ds.remove(item.itemId);}).error(function(){}).always(function(){});}},initDrag:function initDrag(){var _this=this;_this.dragOperateSrc($('#dataSrcPanel').get(0));_this.dragOperateCfg($('.springConfigMask').parent().get(0));},dragOperateSrc:function dragOperateSrc(tableList){if(undefined==tableList){return;}var _this=this;EventAdapter.on($(tableList),'dragstart',function(e){var tar=$(e.target);var className=tar.attr('class');if(!className){e.preventDefault();return;}if(tar.children('input').length>0){e.preventDefault();}if(-1!=className.indexOf('nav nav-list tree-group')){var dragSrcId=tar.attr('id');EventAdapter.setData({'dsGroupId':dragSrcId});}else if(-1!=className.indexOf('treeRow ui-draggable')){var dragSrcId=tar.attr('id');EventAdapter.setData({'dsItemId':dragSrcId});}else{return;}$('.templatePara').css('display','block');});EventAdapter.on($(tableList),'dragover',function(e){e.preventDefault();});EventAdapter.on($(tableList),'drop',function(e){var tarItem=$(e.target);var tarId=0;var dstGroupId=0;var srcGroupId=0;var rowClass=tarItem.attr('class');if(!rowClass){return;}var dragType=-1;var draggedID=0;if(-1!=rowClass.indexOf('nav nav-list tree-group')||-1!=rowClass.indexOf('dsTreeHeader')){tarId=tarItem.closest('.nav').attr('id');draggedID=EventAdapter.getData().dsGroupId;if(Boolean(draggedID)){dragType=0;}else{draggedID=EventAdapter.getData().dsItemId;if(Boolean(draggedID)){dragType=2;tarId=tarItem.closest('.nav').attr('id');dstGroupId=tarId;srcGroupId=$('#'+draggedID).closest('.nav').attr('id');}}}else if(-1!=rowClass.indexOf('showName')||-1!=rowClass.indexOf('treeRow ui-draggable')){dragType=1;draggedID=EventAdapter.getData().dsItemId;tarId=tarItem.closest('.treeRow').attr('id');dstGroupId=tarItem.closest('.nav').attr('id');srcGroupId=$('#'+draggedID).closest('.nav').attr('id');}else{return;}if(draggedID==tarId||!draggedID){return;}if(0===dragType){var item,groupName;for(var i=0,len=_this.m_allGroupList.length;i<len;i++){item=_this.m_allGroupList[i];if(draggedID==item.id){groupName=item.name;break;}}$('#'+draggedID).remove();_this.insertTreeGroup(draggedID,groupName,1,$('#'+tarId));for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(draggedID==item.groupId){if(item.itemType==0){_this.insertTreeItem($('#'+draggedID),item.itemId,item.iconColor,item.customName,0,'',true);}else{_this.insertTreeItem($('#'+draggedID),item.itemId,item.iconColor,item.customName,0,'',false);}var prjName=_this.getProjectNameFromId(item.prjId,_this.m_langFlag);_this.initToolTips($('#'+item.itemId),item.customName,prjName,item.ptName,item.ptDesc);}}var dstGroup,srcGroup;var arrDst=[],arrSrc=[];dstGroup=$('#'+tarId).find('.rows').find('.treeRow');srcGroup=$('#'+draggedID).find('.rows').find('.treeRow');$.each(dstGroup,function(i,n){arrDst.push(n.id);});$.each(srcGroup,function(i,n){arrSrc.push(n.id);});var postData={};postData[tarId]=arrDst;postData[draggedID]=arrSrc;WebAPI.post('/datasource/saveDataSourceGroupLayout/'+AppConfig.userId,postData).done(function(data){if('successful'==data.error){}}).error(function(){}).always(function(){});}else if(1===dragType||2===dragType){var itemType=0;var iconColor='';var custName='';var projId=0;var pointName='';var pointDesc='';for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(draggedID==_this.m_allPointList[i].itemId){_this.m_allPointList[i].groupId=dstGroupId;itemType=_this.m_allPointList[i].itemType;iconColor=_this.m_allPointList[i].iconColor;custName=_this.m_allPointList[i].customName;projId=_this.m_allPointList[i].prjId;pointName=_this.m_allPointList[i].ptName;pointDesc=_this.m_allPointList[i].ptDesc;break;}}var selItem=$('#'+draggedID);selItem.tooltip('destroy');selItem.remove();if(itemType==0){_this.insertTreeItem($('#'+dstGroupId),draggedID,iconColor,custName,dragType,$('#'+tarId),true);}else{_this.insertTreeItem($('#'+dstGroupId),draggedID,iconColor,custName,dragType,$('#'+tarId),false);}if(0==itemType){var prjName=_this.getProjectNameFromId(projId,_this.m_langFlag);_this.initToolTips($('#'+draggedID),custName,prjName,showName,pointDesc);}else if(1==itemType){var showName=_this.getShowNameFromFormula(pointName);_this.initFormulaToolTips($('#'+draggedID),custName,showName,pointDesc);}else{return;}var postData={};if(dstGroupId==srcGroupId){var srcGroup,arrSrc=[];srcGroup=$('#'+srcGroupId).find('.rows').find('.treeRow');$.each(srcGroup,function(i,n){arrSrc.push(n.id);});postData[srcGroupId]=arrSrc;}else{var dstGroup,srcGroup;var arrDst=[],arrSrc=[];dstGroup=$('#'+dstGroupId).find('.rows').find('.treeRow');srcGroup=$('#'+srcGroupId).find('.rows').find('.treeRow');$.each(dstGroup,function(i,n){arrDst.push(n.id);});$.each(srcGroup,function(i,n){arrSrc.push(n.id);});var dstGroupCnt=0,srcGroupCnt=0;var groups=$('#dataSrcPanel .nav');$.each(groups,function(i,n){if(n.id==dstGroupId){dstGroupCnt=i;}if(n.id==srcGroupId){srcGroupCnt=i;}});if(dstGroupCnt<srcGroupCnt){postData[dstGroupId]=arrDst;postData[srcGroupId]=arrSrc;}else{postData[dstGroupId]=arrDst;postData[srcGroupId]=arrSrc;}}WebAPI.post('/analysis/datasource/saveLayout/'+AppConfig.userId,postData).done(function(data){if(data.success){}}).error(function(){}).always(function(){});}});},dragOperateCfg:function dragOperateCfg(divItem){if(undefined==divItem){return;}var _this=this;EventAdapter.on($(divItem),'dragstart',function(e){var target=$(e.target);var className=target.attr('class');if('dsItem grow'!=className&&'dsItem grow dsSelected'!=className){return;}var dragSrcId=target.attr('id');EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($(divItem),'dragover',function(e){e.preventDefault();});EventAdapter.on($(divItem),'drop',function(e){var target=$(e.target);});},saveCurrentRecords:function saveCurrentRecords(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.post('/delete_data_source_records_by_userid',{userId:AppConfig.userId}).done(function(result){if(result!=0){Spinner.stop();return;}
var newPtList=[];var id;var len=_this.m_allPointList.length;var newRow;var item;$('#dataSrcPanel .dsItem').each(function(){id=$(this).attr('id');for(var i=0;i<len;i++){item=_this.m_allPointList[i];if(id==item.itemId){var _newRow;newRow=(_newRow={'itemId':id,'userId':item.userId,'userName':item.userName,'customName':item.customName,'prjId':item.prjId,'prjName':item.prjName,'ptName':item.ptName,'ptDesc':item.ptDesc,'iconColor':item.iconColor},_newRow['itemId']=item.itemId,_newRow);newPtList.push(newRow);break;}}});_this.m_allPointList=newPtList;var row;var data=[];var len=_this.m_allPointList.length;for(var i=0;i<len;i++){item=_this.m_allPointList[i];row={'userId':item.userId,'customName':item.customName,'projectId':item.prjId,'pointName':item.ptName,'pointDesc':item.ptDesc,'iconColor':item.iconColor};data.push(row);}WebAPI.post('/save_data_source_record',{sourceList:data}).done(function(result){if(0==result){}}).error(function(result){alert(I18n.resource.observer.widgets.DATABASE_OPERATION_FAILED+'！');return;});}).error(function(result){alert(I18n.resource.observer.widgets.FAIL_BEFORE_EXECUTING+'！');return;}).always(function(){Spinner.stop();});},loadDataSourceRecord:function loadDataSourceRecord(){var _this=this;var groupInfo=_this.m_parent.store.group;if(!groupInfo){return;}_this.m_allGroupList=[];_this.m_allPointList=[];var itemDefault=null;for(var m=0,n=groupInfo.length;m<n;m++){var groupId=groupInfo[m].groupId;var groupName=groupInfo[m].groupName;var groupIsDefault=Boolean(groupInfo[m].isDefault)?true:false;var data=groupInfo[m].datasourceList;var groupItem={'id':groupId,'name':groupName,'isDefault':groupIsDefault};if(groupIsDefault){itemDefault=groupItem;}else{_this.m_allGroupList.push(groupItem);}if(data){var len=data.length;var item;for(var i=0;i<len;i++){item={userId:AppConfig.userId,userName:AppConfig.account,customName:data[i].alias,prjId:data[i].projId,prjName:_this.getProjectNameFromId(data[i].projId),ptName:data[i].value,ptDesc:data[i].note,iconColor:_this.m_arrProjIdColorMap[data[i].projId],itemId:data[i].id,itemType:data[i].type,itemValue:data[i].value,groupId:groupId,groupName:groupName};if(item.itemType==1){item.iconColor='#000000';}_this.m_allPointList.push(item);}}}if(itemDefault){_this.m_allGroupList.push(itemDefault);}},colapseGroupsDefault:function colapseGroupsDefault(){var treeAllHead=$('.dsTreeHeader .dsGroupName');var item,row;for(var i=0,len=treeAllHead.length;i<len;i++){item=treeAllHead.eq(i);row=item.closest('.tree-group').find('.rows');if(!row||row.length<=0){continue;}if(item.text()==this.m_unassigned){row.css('display','block');}else{row.css('display','none');}}},colapseGroups:function colapseGroups(openGroupId){if(!openGroupId){return;}var treeAllRow=$('#dataSrcPanel .tree-group');var item,row;for(var i=0,len=treeAllRow.length;i<len;i++){item=treeAllRow.eq(i);row=item.find('.rows');if(!row||row.length<=0){continue;}if(item.attr('id')==openGroupId){row.css('display','block');}else{row.css('display','none');}}sessionStorage.removeItem('dsOpenGroupId');},getProjectNameFromId:function getProjectNameFromId(id,langFlag){var name;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(id==item.id){if(0==langFlag){name=item.name_cn;}else{name=item.name_en;}break;}}return name;},getProjectIdFromName:function getProjectIdFromName(projectName){var id;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(projectName==item.name_cn){id=item.id;break;}}return id;},calUpdateDataSources:function calUpdateDataSources(){return;var _this=this;var updateData=[];for(var i=0,len=_this.m_allGroupList.length;i<len;i++){var groupItem={'groupId':_this.m_allGroupList[i].id,'groupName':_this.m_allGroupList[i].name,'parentId':'','datasourceList':''};var dsList=[];for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){var curItem=_this.m_allPointList[j];if(groupItem.groupId==curItem.groupId){var pushItem={'id':curItem.itemId,'type':curItem.itemType,'projId':curItem.prjId,'alias':curItem.customName,'note':curItem.ptDesc,'value':curItem.ptName,'groupId':curItem.groupId};dsList.push(pushItem);}}groupItem.datasourceList=dsList;updateData.push(groupItem);}this.m_parent.updateDataSources(updateData);},renderFormula:function renderFormula(_customName,_formulaVal,_formulaDesc){var _this=this;var postData={itemList:[]};var prjId=0;var eachItem={type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId};postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}var list=data.itemIdList;var item;var arrNewFormula=[];for(var i=0,len=list.length;i<len;i++){item={'itemId':list[i].id,'itemType':1,'customName':list[i].alias,'itemValue':list[i].value,'ptName':list[i].value,'prjId':prjId,'iconColor':'#000000','ptDesc':_formulaDesc,'groupId':list[i].groupId};arrNewFormula.push(item);}
if(_this.treeObj){var parentId=arrNewFormula[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){if(parentNodes[0].zAsync){var arrNodes=[];for(var i=0;i<len;i++){arrNodes.push({id:arrNewFormula[i].itemId,pId:arrNewFormula[i].groupId,isParent:false,name:arrNewFormula[i].customName,value:arrNewFormula[i].itemValue,projId:arrNewFormula[i].prjId,note:arrNewFormula[i].ptDesc,type:1,iconSkin:'ptFormula'});}_this.treeObj.addNodes(parentNodes[0],arrNodes);}else{_this.treeObj.expandNode(parentNodes[0],true,false,true);}
var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num+=1;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge');if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}break;}}}}_this.calUpdateDataSources();});},modifyFormula:function modifyFormula(_customName,_formulaVal,_formulaDesc){var _this=this;var postData={itemList:[]};var itemId=_this.m_selectItemId;var prjId=Number(AppConfig.projectId);var eachItem={id:itemId,type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId};postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}var list=data.itemIdList;if(list.length>0){var showName=list[0].value;var arr=showName.split('<%');var arrId=[];var arrItem=[];for(var j=0,len2=arr.length;j<len2;j++){var id=arr[j].split('%>')[0];if(''!=id){arrId.push(id);}}arrItem=_this.getDSItemById(arrId);for(var j=0,len2=arr.length;j<len2;j++){var id=arr[j].split('%>')[0];if(''==id){continue;}for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var retVal=arrItem[m];if(null==retVal){continue;}showName=showName.replace(id,retVal.value);break;}}}showName=showName.replace(/<%/g,'');showName=showName.replace(/%>/g,'');for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=list[0].alias;_this.m_allPointList[i].ptName=list[0].value;_this.m_allPointList[i].ptDesc=list[0].note;break;}}var divFormula=$('#'+itemId);divFormula.find('.showName').text(list[0].alias);_this.setFormulaToolTipsAll(divFormula,list[0].alias,showName,list[0].note);_this.calUpdateDataSources();Beop.cache.ds.remove(itemId);}});},insertFormula:function insertFormula(itemId,customName,iconColor,formula,desc){var _this=this;var div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');div.attr('id',itemId);div.click(function(e){_this.clearSelect();var tar=$(e.currentTarget);if('dsItem grow'==tar.attr('class')){tar.attr('class','dsItem grow dsSelected');}else{tar.attr('class','dsItem grow');}_this.stopBubble(e);});var icon=$('<div class="dsMark"></div>');icon.css('background-color',iconColor);div.append(icon);var name=$('<div class="dsValue" style="height:36px"></div>');name.text(customName);div.append(name);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){var show=$(e.currentTarget).prevAll('.dsValue');show.css('display','none');var target=$(e.currentTarget).nextAll('.dsDivChange');target.attr('class','dsDivChange show');div.css('height','240px');div.css('width','100%');var item;var strName='';var strFormula='';var strDesc='';for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){strName=item.customName;strFormula=item.ptName;strDesc=item.ptDesc;break;}}var temp=target.find('input');if(temp.length==2){$(temp[0]).val(strName);$(temp[1]).val(strDesc);}_this.stopBubble(e);}).error(function(e){});div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){confirm(_this.m_lang.REMOVE_CONFIRM,function(){var div=$(e.currentTarget).closest('.dsItem');var dataSrcItemId=div.attr('id');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}_this.calUpdateDataSources();div.tooltip('destroy');div.remove();}});});});div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>');var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find('label').text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find('input');ctlInput.attr('value',customName);ctlInput.attr('placeholder',_this.m_lang.CUSTOM_NAME);inputCustName.click(function(e){_this.stopBubble(e);});divChange.append(inputCustName);var ctlFormula=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.FORMULA_NAME+': </label></div>');var showFormula=$('<span>'+formula+'</span>');showFormula.appendTo(ctlFormula.find('label')).mathquill();ctlFormula.click(function(e){_this.stopBubble(e);});divChange.append(ctlFormula);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find('label').text(_this.m_lang.POINT_DESC);ctlInput=inputDesc.find('input');ctlInput.attr('value',desc);ctlInput.attr('placeholder',_this.m_lang.POINT_DESC);inputDesc.click(function(e){_this.stopBubble(e);});divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE);btnOk.click(function(e){var temp=$(e.currentTarget).closest('.dsDivChange').find('input');var strName=$(temp[0]).val();var strDesc=$(temp[1]).val();var prjId,ptName,item;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){prjId=item.prjId;ptName=item.ptName;break;}}var postData={itemList:[{id:itemId,type:1,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:''}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(0==data.itemIdList.length){return;}var id=data.itemIdList[0].id;for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName;_this.m_allPointList[i].ptDesc=strDesc;break;}}_this.setToolTipsCustomName(div,strName);_this.setToolTipsDesc(div,strDesc);_this.calUpdateDataSources();$('#'+id).find('.dsValue').text(strName);}).error(function(e){});});divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL);btnCancel.click(function(e){});divChange.append(btnCancel);div.append(divChange);$('#dataSrcPanel').append(div);},initFormulaToolTips:function initFormulaToolTips(parent,customName,formula,desc){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:400px;">');show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="customName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="formula tipStyle" style="word-break:normal;"><span class="tipTitleStyle">').append(_this.m_lang.FORMULA_NAME).append('</span>: ').append('</p>');show.append('        <p class="pointDesc tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(desc).append('</p>');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var showFormula=$('<span>'+formula+'</span>');var showObj=$(show.toString());showFormula.appendTo(showObj.find('.formula')).mathquill();var options={placement:'left',title:_this.m_lang.PARAM,template:showObj};parent.tooltip(options);},setFormulaToolTipsAll:function setFormulaToolTipsAll(row,customName,formulaVal,formulaDesc){var tip=row.data('bs.tooltip').$tip;tip.find('.customName').html('<span style="font-weight:bold">'+this.m_lang.CUSTOM_NAME+'</span>: '+customName);tip.find('.pointDesc').html('<span style="font-weight:bold">'+this.m_lang.POINT_DESC+'</span>: '+formulaDesc);var showFormula=$('<span>'+formulaVal+'</span>');var dst=tip.find('.formula').html('<span style="font-weight:bold">'+this.m_lang.FORMULA_NAME+'</span>: ');showFormula.appendTo(dst).mathquill();},checkRepeatWithCustomName:function checkRepeatWithCustomName(_name){var _this=this;var bRet=false;var grids=$('#dataSrcPanel .dsItem .dsValue');$.each(grids,function(i,n){if(_name==$(n).text()){bRet=true;return false;}});return bRet;},stopBubble:function stopBubble(e){if(e&&e.stopPropagation){e.stopPropagation();}else{window.event.cancelBubble=true;}},clearSelect:function clearSelect(e){var itemList=$('#dataSrcPanel .dsItem');itemList.attr('class','dsItem grow');itemList.css('height','34px');itemList.css('width','33%');var panel=$('#dataSrcPanel');panel.find('.dsDivChange').attr('class','dsDivChange');panel.find('.dsValue').css('display','inline');},insertTreeGroup:function insertTreeGroup(groupId,groupName,type,baseGroup){var _this=this;var divContain=$('#dataSrcPanel');var $ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true">');var $liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon open"></span></li>');var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);if(groupName!=_this.m_unassigned){var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true"></span>');EventAdapter.on(btnRemove,'click',function(e){var div=$(e.currentTarget).closest('.nav');WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(_this.m_lang.REMOVE_CONFIRM);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}var groupId=div.attr('id');div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+groupId).done(function(data){if('successful'==data.error){var len=_this.m_allGroupList.length;for(var i=0;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1);div.remove();break;}}_this.calUpdateDataSources();}}).fail(function(e){});});res.modal('show');}).always(function(e){});}).error(function(e){});$liHd.append(btnRemove);}var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add"></span>');EventAdapter.on(btnAddDs,'click',function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add" /></span>');EventAdapter.on(btnAddFormula,'click',function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_hover.png');img.css('width','23px');img.css('height','20px');}).error(function(e){});btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_normal.png');img.css('width','21px');img.css('height','19px');}).error(function(e){});$liHd.append(btnAddFormula);if(groupName!=_this.m_unassigned){var spanEdit=$('<span class="glyphicon glyphicon-pencil panel-heading-btn grow dsEditGroupName" aria-hidden="true"></span>');EventAdapter.on(spanEdit,'click',function(e){var tar=$(e.currentTarget);var groupName=tar.siblings('.dsGroupName');groupName.hide();var input=tar.siblings('.inputEditGroup');input.val(groupName.text());input.show();input.select();tar.siblings('.btn').show();_this.stopBubble(e);});$liHd.append(spanEdit);var inputEdit=$('<input type="text" value="'+groupName+'" class="inputEditGroup">');inputEdit.hide();EventAdapter.on(inputEdit,'click',function(e){_this.stopBubble(e);});inputEdit.keyup(function(e){if(13==e.keyCode){var tar=$(e.currentTarget);tar.siblings('button').click();}_this.stopBubble(e);});$liHd.append(inputEdit);var btnEdit=$('<button class="btn btn-default btn-sm" type="submit">Change</button>');btnEdit.hide();EventAdapter.on(btnEdit,'click',function(e){var tar=$(e.currentTarget);tar.hide();var input=tar.siblings('.inputEditGroup');var newName=input.val();input.hide();var groupName=tar.siblings('.dsGroupName');var oldName=groupName.text();groupName.show();if(oldName!=newName&&''!=newName){var postData={'groupId':groupId,'name':newName,'parent':'','userId':AppConfig.userId};WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if(undefined==data){return;}if('successful'==data.error){for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList[i].name=data.groupName;break;}}spanName.text(data.groupName);}}).fail(function(e){});}_this.stopBubble(e);});$liHd.append(btnEdit);}EventAdapter.on($liHd,'click',function(e){divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');divContain.find('.dsEditGroupName').css('display','none');var curTarHead=$(e.currentTarget);curTarHead.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarHead.closest('.tree-group').get(0).id;$(this).next('.rows').slideToggle();var icon=$(this).find('.dsTreeHeaderIcon');var imgPath=icon.attr('src');if(icon.hasClass('open')){icon.removeClass('open');curTarHead.find('.dsGroupName').css('font-weight','400');curTarHead.find('.dsTreeBtnFormula').css('display','none');curTarHead.find('.dsTreeBtnAdd').css('display','none');curTarHead.find('.dsTreeBtnDel').css('display','none');curTarHead.find('.dsEditGroupName').css('display','none');}else{icon.addClass('open');curTarHead.find('.dsGroupName').css('font-weight','700');curTarHead.find('.dsTreeBtnFormula').css('display','inline');curTarHead.find('.dsTreeBtnAdd').css('display','inline');curTarHead.find('.dsTreeBtnDel').css('display','inline');curTarHead.find('.dsEditGroupName').css('display','inline');}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow);if(0===type){divContain.append($ul);}else if(1===type){if(''!=baseGroup){baseGroup.after($ul);}}else if(2===type){if(''!=baseGroup){baseGroup.before($ul);}}},insertTreeItem:function insertTreeItem(divParentGroup,itemId,iconColor,itemName,insertType,baseItem,bIsPoint){var _this=this;var div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true"> ');var icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css('background-color',iconColor);div.append(icon);var divShowName=$('<span class="showName">'+itemName+'</span>');EventAdapter.on(divShowName,'click',function(e){var oldCustName=$(e.currentTarget).text();var input=$('<input type="text" value="'+oldCustName+'" style="width:300px;position: absolute;top: 4px">');input.blur(function(e){var newCustName=$(e.currentTarget).val();if(oldCustName!=newCustName){var item,type,prjId,ptName,ptDesc,groupId,postData;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){type=item.itemType;prjId=item.prjId;ptName=item.ptName;ptDesc=item.ptDesc;groupId=item.groupId;break;}}postData={itemList:[]};var eachItem={id:itemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId};postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}var list=data.itemIdList;var dstId,dstCustomName;for(var i=0,len=list.length;i<len;i++){dstId=list[i].id;dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break;}}divShowName.text(dstCustomName);_this.setToolTipsCustomName(divShowName.closest('.treeRow'),dstCustomName);}_this.calUpdateDataSources();});}input.remove();divShowName.css('display','inline');});input.keyup(function(e){if(13==e.keyCode){input.blur();}_this.stopBubble(e);});divShowName.after(input);divShowName.css('display','none');input.select();});div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');EventAdapter.on(btnRemove,'click',function(e){var promise=$.Deferred();var div=$(e.currentTarget).closest('.treeRow');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;if(typeof _this.m_parent.doSync==='function'){_this.m_parent.doSync().done(function(){promise.resolve();});}else{promise.resolve();}
promise.done(function(){WebAPI.get('/analysis/checkDatasourceBeforeDelete/'+dataSrcItemId+'/'+AppConfig.userId).done(function(chkData){var nWorkSpLen=chkData.workspaceInfo.length;var nDashBoLen=chkData.dashboardInfo.length;if(nWorkSpLen>0||nDashBoLen>0){var show=_this.m_lang.REMOVE_CONFIRM_TIPS;var name;for(var i=0;i<nWorkSpLen;i++){if(0==i){show+='workspace: ';}name=chkData.workspaceInfo[i].modalName;name=Boolean(name)?name:'Untitled';show+=name+',';}for(var j=0;j<nDashBoLen;j++){if(0==j){show+='dashboard: ';}show+=chkData.dashboardInfo[j].modalType+',';}show+=_this.m_lang.REMOVE_CONFIRM;WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(show);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});});res.modal('show');}).always(function(e){});}else{if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});}}).fail(function(e){});});}).error(function(e){});div.append(btnRemove);if(bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on(btnCfg,'click',function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}else{var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on(btnCfg,'click',function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}EventAdapter.on(div,'click',function(e){var divContain=$('#dataSrcPanel');divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');var curTarItem=$(e.currentTarget);curTarItem.find('.dsTreeBtnCfg').css('display','inline');curTarItem.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarItem.closest('.tree-group').get(0).id;});if(0===insertType){divParentGroup.find('.rows').append(div);}else if(1===insertType){if(''!=baseItem){baseItem.after(div);}}else if(2===insertType){var lyRow=divParentGroup.find('.rows').find('.treeRow');if(0==lyRow.length){divParentGroup.find('.rows').append(div);}else{lyRow.eq(0).before(div);}}},insertTreeAllGroupItem:function insertTreeAllGroupItem(groupList,pointList,searchPointName){var _this=this;var divContain=$('#dataSrcPanel');var groupId,groupName,bIsDefault;for(var i=0,len=groupList.length;i<len;i++){groupId=groupList[i].id;groupName=groupList[i].name;bIsDefault=groupList[i].isDefault;var $ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true" dropable="true" isDefault="'+bIsDefault+'">');var $liHd;if(groupName==this.m_unassigned){$liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon open"></span></li>');}else{$liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon"></span></li>');}var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);if(groupName!=_this.m_unassigned){var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true" style="display:none"></span>');EventAdapter.on($(btnRemove),'click',function(e){var div=$(e.currentTarget).closest('.nav');WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(_this.m_lang.REMOVE_CONFIRM);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}var groupId=div.attr('id');div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+groupId).done(function(data){if('successful'==data.error){var len=_this.m_allGroupList.length;for(var i=0;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1);div.remove();break;}}_this.calUpdateDataSources();}}).fail(function(e){});});res.modal('show');}).always(function(e){});});$liHd.append(btnRemove);}var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add" style="display:none"></span>');if(groupName==this.m_unassigned){btnAddDs.css('display','inline');}EventAdapter.on($(btnAddDs),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add"  style="display:none"/></span>');if(groupName==this.m_unassigned){btnAddFormula.children('img').css('display','inline');}EventAdapter.on($(btnAddFormula),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_hover.png');img.css('width','23px');img.css('height','20px');}).error(function(e){});btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_normal.png');img.css('width','21px');img.css('height','19px');}).error(function(e){});$liHd.append(btnAddFormula);if(groupName!=_this.m_unassigned){var spanEdit=$('<span class="glyphicon glyphicon-pencil panel-heading-btn grow dsEditGroupName" aria-hidden="true" style="display:none"></span>');EventAdapter.on($(spanEdit),'click',function(e){var tar=$(e.currentTarget);var groupName=tar.siblings('.dsGroupName');groupName.hide();var input=tar.siblings('.inputEditGroup');input.val(groupName.text());input.show();input.select();tar.siblings('.btn').show();_this.stopBubble(e);});$liHd.append(spanEdit);var inputEdit=$('<input type="text" value="'+groupName+'" class="inputEditGroup">');inputEdit.hide();EventAdapter.on($(inputEdit),'click',function(e){_this.stopBubble(e);});inputEdit.keyup(function(e){if(13==e.keyCode){var tar=$(e.currentTarget);tar.siblings('button').click();}_this.stopBubble(e);});$liHd.append(inputEdit);var btnEdit=$('<button class="btn btn-primary btn-sm" type="submit">Change</button>');btnEdit.hide();EventAdapter.on($(btnEdit),'click',function(e){var tar=$(e.currentTarget);tar.hide();var input=tar.siblings('.inputEditGroup');var newName=input.val();input.hide();var groupName=tar.siblings('.dsGroupName');var oldName=groupName.text();groupName.show();if(oldName!=newName&&''!=newName){var ulNav=tar.closest('.nav');var groupId=ulNav.attr('id');var postData={'groupId':groupId,'name':newName,'parent':'','userId':AppConfig.userId};WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if(undefined==data){return;}if('successful'==data.error){for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList[i].name=data.groupName;break;}}var spanName=ulNav.find('.dsGroupName');if(Boolean(spanName)){spanName.text(data.groupName);}}}).fail(function(e){});}_this.stopBubble(e);});$liHd.append(btnEdit);}EventAdapter.on($($liHd),'click',function(e){divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');divContain.find('.dsEditGroupName').css('display','none');var curTarHead=$(e.currentTarget);curTarHead.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarHead.closest('.tree-group').get(0).id;$(this).next('.rows').slideToggle();var icon=$(this).find('.dsTreeHeaderIcon');if(icon.hasClass('open')){icon.removeClass('open');curTarHead.find('.dsGroupName').removeClass('selected');curTarHead.find('.dsTreeBtnFormula').css('display','none');curTarHead.find('.dsTreeBtnAdd').css('display','none');curTarHead.find('.dsTreeBtnDel').css('display','none');curTarHead.find('.dsEditGroupName').css('display','none');}else{icon.addClass('open');curTarHead.find('.dsGroupName').addClass('selected');curTarHead.find('.dsTreeBtnFormula').css('display','inline-block');curTarHead.find('.dsTreeBtnAdd').css('display','inline');curTarHead.find('.dsTreeBtnDel').css('display','inline');curTarHead.find('.dsEditGroupName').css('display','inline');}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');if(groupName==_this.m_unassigned){divLiRow.css('display','block');}else{divLiRow.css('display','none');}$ul.append(divLiRow);var itemId,iconColor,itemName,itemPtName;var bHasSearched=false;for(var j=0,len2=pointList.length;j<len2;j++){if(groupId==pointList[j].groupId){itemId=pointList[j].itemId;iconColor=pointList[j].iconColor;itemName=pointList[j].customName;itemPtName=pointList[j].ptName;if(''!=searchPointName){var custNameLower=itemName.toLowerCase();var ptNameLower=itemPtName.toLowerCase();if(-1==custNameLower.indexOf(searchPointName)&&-1==ptNameLower.indexOf(searchPointName)){continue;}else{bHasSearched=true;}}var div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true" dropable="true"> ');var icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css('background-color',iconColor);div.append(icon);var divShowName=$('<span class="showName">'+itemName+'</span>');EventAdapter.on($(divShowName),'click',function(e){var divCurShowName=$(e.currentTarget);var oldCustName=divCurShowName.text();var selItemId=divCurShowName.closest('.treeRow').attr('id');var input=$('<input type="text" value="'+oldCustName+'" style="width:300px;position: absolute;top: 4px;background-color:#465b85">');input.blur(function(e){var $tar=$(e.currentTarget);var newCustName=$tar.val();if(''==newCustName){$tar.select();alert(I18n.resource.dataSource.CUSTOM_NOT_NULL);return;}if(oldCustName!=newCustName){var item,type,prjId,ptName,ptDesc,groupId,postData;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(selItemId==item.itemId){type=item.itemType;prjId=item.prjId;ptName=item.ptName;ptDesc=item.ptDesc;groupId=item.groupId;break;}}postData={itemList:[]};var eachItem={id:selItemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId};postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}var list=data.itemIdList;var dstId,dstCustomName;for(var i=0,len=list.length;i<len;i++){dstId=list[i].id;dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break;}}divCurShowName.text(dstCustomName);_this.setToolTipsCustomName(divCurShowName.closest('.treeRow'),dstCustomName);}_this.calUpdateDataSources();});}input.remove();divCurShowName.css('display','inline');});input.keyup(function(e){if(13==e.keyCode){input.blur();}_this.stopBubble(e);});divCurShowName.after(input);divCurShowName.css('display','none');input.select();});div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');EventAdapter.on($(btnRemove),'click',function(e){var promise=$.Deferred();var div=$(e.currentTarget).closest('.treeRow');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;if(typeof _this.m_parent.doSync==='function'){_this.m_parent.doSync().done(function(){promise.resolve();});}else{promise.resolve();}Spinner.spin(div[0]);promise.done(function(){WebAPI.get('/analysis/checkDatasourceBeforeDelete/'+dataSrcItemId+'/'+AppConfig.userId).done(function(chkData){var nWorkSpLen=chkData.workspaceInfo.length;var nDashBoLen=chkData.dashboardInfo.length;if(nWorkSpLen>0||nDashBoLen>0){var show=_this.m_lang.REMOVE_CONFIRM_TIPS;var name;for(var i=0;i<nWorkSpLen;i++){if(0==i){show+='workspace: ';}name=chkData.workspaceInfo[i].modalName;name=Boolean(name)?name:'Untitled';show+=name+',';}for(var j=0;j<nDashBoLen;j++){if(0==j){show+='dashboard: ';}show+=chkData.dashboardInfo[j].modalType+',';}show+=_this.m_lang.REMOVE_CONFIRM;WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(show);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});});res.modal('show');}).always(function(e){});}else{div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});}}).fail(function(e){}).always(function(e){Spinner.stop();});});});div.append(btnRemove);var bIsPoint=0==pointList[j].itemType?true:false;if(bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on($(btnCfg),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}else{var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on($(btnCfg),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}EventAdapter.on($(div),'click',function(e){var divContain=$('#dataSrcPanel');divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');var curTarItem=$(e.currentTarget);curTarItem.find('.dsTreeBtnCfg').css('display','inline');curTarItem.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarItem.closest('.tree-group').get(0).id;});$ul.find('.rows').append(div);if(bIsPoint){var prjName=_this.getProjectNameFromId(pointList[j].prjId,_this.m_langFlag);_this.initToolTips(div,pointList[j].customName,prjName,pointList[j].ptName,pointList[j].ptDesc);}else{var showName=_this.getShowNameFromFormula(pointList[j].ptName);_this.initFormulaToolTips(div,pointList[j].customName,showName,pointList[j].ptDesc);}}}if(''==searchPointName){divContain.append($ul);}else{if(bHasSearched){divContain.append($ul);}}}},getDSItemById:function getDSItemById(datasourceItemId){var _this=this;var postData=[];var bIsArray=Object.prototype.toString.call(datasourceItemId)==='[object Array]';if(!bIsArray){if(this.m_parent.store.dsInfoList){var itemInfo;for(var i=0,len=this.m_parent.store.dsInfoList.length;i<len;i++){itemInfo=this.m_parent.store.dsInfoList[i];if(datasourceItemId==itemInfo.id){return itemInfo;}}}for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){var item=_this.m_arrCloudTableInfo[i];if(datasourceItemId==item._id){return{id:item._id,groupId:'',alias:item.alias,projId:item.projId,type:0,value:item.value};}}}else{var ret=[];if(this.m_parent.store.dsInfoList){var itemInfo;for(var j=0;j<datasourceItemId.length;j++){for(var i=0,len=this.m_parent.store.dsInfoList.length;i<len;i++){itemInfo=this.m_parent.store.dsInfoList[i];if(datasourceItemId[j]==itemInfo.id){ret.push(itemInfo);break;}}}if(ret.length>0){return ret;}}for(var j=0;j<datasourceItemId.length;j++){for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){var item=_this.m_arrCloudTableInfo[i];if(datasourceItemId[j]==item._id){ret.push({id:item._id,groupId:'',alias:!!item.alias?item.alias:item.value,projId:item.projId,type:0,value:item.value});}}}if(ret.length>0){return ret;}}if(!bIsArray){postData.push(datasourceItemId);}else{postData=datasourceItemId;}var dsRet=$.ajax({type:'POST',url:'/analysis/datasource/getDsItemsById',data:JSON.stringify(postData),contentType:'application/json',async:false}).responseText;if(dsRet){var temp=JSON.parse(dsRet);var ret;if(!bIsArray){ret=temp[0];if(!ret){ret={alias:undefined,groupId:undefined,id:undefined,note:undefined,projId:undefined,type:undefined,value:undefined};}}else{if(temp instanceof Array){temp.map(function(i){if(!i.alias){i.alias=i.value;}});}ret=temp;}return ret;}return{};},getDSItemData:function getDSItemData(target,arrDSItemIds){var _this=this.m_parent;var tmStart=_this.curModal.startTime.toDate();var tmEnd=_this.curModal.endTime.toDate();var tmFmt=_this.curModal.format;var key;var preloadIds=[];var row=null,arrId;var ids=arrDSItemIds.concat();var postData={dsItemIds:ids,timeStart:tmStart.format('yyyy-MM-dd HH:mm:ss'),timeEnd:tmEnd.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt};var promise=$.Deferred();Beop.cache.ds.getBatch(ids,tmFmt,tmStart,tmEnd).done(function(rs){promise.resolve(rs);}).fail(function(e){console.warn(e);promise.reject();});promise.always(function(rs){var idsNotFound,cacheData;if(rs){idsNotFound=rs.idsNotFound;cacheData=rs.data;if(idsNotFound.length>0){postData.dsItemIds=idsNotFound;}else{target.spinnerStop();target.renderModal(cacheData);return;}}WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(data){if(data.error&&data.error.length>0){target.errAlert(data.error);target.spinnerStop();return;}Beop.cache.ds.set(data,tmFmt,tmStart,tmEnd).done(function(){if(cacheData&&cacheData!==null){data={list:data.list.concat(cacheData.list),timeShaft:data.timeShaft.length>0?data.timeShaft:cacheData.timeShaft};}}).fail(function(e){console.warn(e);}).always(function(){target.renderModal(data);});}).error(function(e){_this.paneCenter.spinnerStop();_this.alertNoData();});});},getDSItemDataMulti:function getDSItemDataMulti(target,arrDSItemIds){var _this=this.m_parent;_this.curModal.arrComparePeriodLabel=[];var tmStart=_this.curModal.startTime;tmStart=tmStart.length<=10?tmStart+' 00:00:00':tmStart;var tmEnd=_this.curModal.endTime;tmEnd=tmEnd.length<=10?tmEnd+' 00:00:00':tmEnd;var tmFmt=_this.curModal.format;var comparePeriod=_this.curModal.comparePeriod;var period1,period2,time;var startDate=new Date(tmStart);var endDate=new Date(tmEnd);var compareDateI18n=I18n.resource.analysis.historyCompare;if(comparePeriod=='hour'){time=3600000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1)+'-'+startDate.getDate()+' '+startDate.getHours()+':00');_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1)+'-'+endDate.getDate()+' '+endDate.getHours()+':00');}if(comparePeriod=='day'){time=86400000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1)+'-'+startDate.getDate());_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1)+'-'+endDate.getDate());}if(comparePeriod=='week'){time=604800000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(compareDateI18n.YEAR_WEEK.replace('<%year%>',startDate.getFullYear()).replace('<%week%>',getWeekNumber(tmStart)));_this.curModal.arrComparePeriodLabel.push(compareDateI18n.YEAR_WEEK.replace('<%year%>',endDate.getFullYear()).replace('<%week%>',getWeekNumber(tmEnd)));}if(comparePeriod=='month'){var getCurrentMonthLastDay=function getCurrentMonthLastDay(date){var current=date.toDate();var currentMonth=current.getMonth();var nextMonth=++currentMonth;var nextMonthDayOne=new Date(current.getFullYear(),nextMonth,1);return new Date(nextMonthDayOne.getTime());};period1=getCurrentMonthLastDay(tmStart);period2=getCurrentMonthLastDay(tmEnd);_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1));_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1));}var postData=[{dsItemIds:arrDSItemIds,timeStart:tmStart.format('yyyy-MM-dd HH:mm:ss'),timeEnd:period1.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt},{dsItemIds:arrDSItemIds,timeStart:tmEnd.format('yyyy-MM-dd HH:mm:ss'),timeEnd:period2.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt}];WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(data){if(data.error&&data.error.length>0){target.errAlert(data.error);target.spinnerStop();return;}
target.renderModal(data);}).error(function(e){_this.paneCenter.spinnerStop();_this.alertNoData();});function isLeapYear(year){return year%400==0||year%4==0&&year%100!=0;}function getMonthDays(year,month){return[31,null,31,30,31,30,31,31,30,31,30,31][month]||(isLeapYear(year)?29:28);}function getWeekNumber(date){var now=date.toDate(),year=now.getFullYear(),month=now.getMonth(),days=now.getDate();for(var i=0;i<month;i++){days+=getMonthDays(year,i);}
var yearFirstDay=new Date(year,0,1).getDay()||7;var week=null;if(yearFirstDay==1){week=Math.ceil(days/yearFirstDay);}else{days-=7-yearFirstDay+1;week=Math.ceil(days/7)+1;}return week;}},getShowNameFromFormula:function getShowNameFromFormula(formula){var _this=this;var inputStr=formula;var nStart=inputStr.indexOf('<%');var nEnd=inputStr.indexOf('%>');if(-1==nStart||-1==nEnd){return inputStr;}var id=inputStr.substring(nStart+2,nEnd);if(''==id){return _this.getShowNameFromFormula(inputStr);}var retVal=_this.getDSItemById(id);if(null==retVal){return _this.getShowNameFromFormula(inputStr);}inputStr=inputStr.replace('<%'+id+'%>',retVal.value);return _this.getShowNameFromFormula(inputStr);},addNewGroup:function addNewGroup(){var groupName=$('#inputAddGroup').val();if(''==groupName){return;}var _this=this;var postData={'groupId':'','name':groupName,'parent':'','userId':AppConfig.userId};WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if('successful'!=data.error){return;}var groupId=data.groupId;if(groupId){if(_this.treeObj){var nodeUnassigned=_this.treeObj.getNodesByParam('name','unassigned',null);var index=-1;if(nodeUnassigned.length>0){index=_this.treeObj.getNodeIndex(nodeUnassigned[0]);}_this.treeObj.addNodes(null,index,{id:data.groupId,pId:data.parentId,name:data.groupName,isParent:true});}}$('#inputAddGroup').val('');$('#inputAddGroup').blur();}).fail(function(result){}).always(function(e){});}};return DataSource;}();var modalConfigurePane=function(){var _this;function modalConfigurePane(container,screen,modalType){_this=this;this.container=container;this.screen=screen;this.modalType=modalType;this.templateObj=undefined;this.optionType=undefined;this.option=undefined;this.dataLose=undefined;this.editorData=undefined;this.ue=undefined;this.UILoadPromise=undefined;}modalConfigurePane.prototype={show:function show(){this.UILoadPromise=WebAPI.get("/static/views/observer/widgets/modalConfigurePane.html").done(function(resultHtml){_this.container.innerHTML+=resultHtml;if(_this.modalType=="dataAnalysis"){document.getElementById('startConfig').setAttribute('i18n','modalConfig.btnStartConfig.TYPE1');}else if(_this.modalType=="dashboard"){document.getElementById('startConfig').setAttribute('i18n','modalConfig.btnStartConfig.TYPE2');}I18n.fillArea($('#modalConfig'));});},showModalInit:function showModalInit(optionType,option,templateObj){this.optionType=optionType;this.option=option;this.templateObj=templateObj;if(this.UILoadPromise&&this.UILoadPromise.state()==='pending'){}else{this.UILoadPromise=$.Deferred().resolve();}this.UILoadPromise.done(function(){this.init();if(_this.option.templateType=="ModalNote"){_this.initEditor();}$('#modalConfig').modal('show');}.bind(this));},init:function init(){var $modalConfig=$('#modalConfig');var $inputRealTimeInterval=$('#inputRealTimeInterval');var $labelText=$('#divRealTimeInterval label');var $option30s=$('#inputRealTimeInterval option[value = "30s"]');var $option10m=$('#inputRealTimeInterval option[value = "10m"]');var $option30m=$('#inputRealTimeInterval option[value = "30m"]');var $optionh1=$('#inputRealTimeInterval option[value = "h1"]');var $optiond1=$('#inputRealTimeInterval option[value = "d1"]');var $optionM1=$('#inputRealTimeInterval option[value = "M1"]');$modalConfig.off('show.bs.modal').on('show.bs.modal',function(e){if(e.namespace!=='bs.modal')return true;_this.initOption();_this.initConfigData();$('#inputAddGroup').click(function(e){$(e.target).focus();});if(_this.modalType=="dashboard"){_this.toggleDataSource(true);}if(_this.templateObj instanceof ModalRealtimeLineOutdoor||_this.templateObj instanceof ModalRealtimeBarSub){if(!_this.templateObj.entity.modal.option){$inputRealTimeInterval.find('option[value= "m5"]').attr('selected',true);}else if(_this.templateObj.entity.modal.option.timeFormat){$inputRealTimeInterval.find('option[value='+_this.templateObj.entity.modal.option.timeFormat+']').attr('selected',true);}$labelText.text(I18n.resource.modalConfig.option.LABEL_INTERVAL_ONE);$optionh1.show();$optiond1.show();$optionM1.show();$option30s.hide();$option10m.hide();$option30m.hide();}else{$labelText.text(I18n.resource.modalConfig.option.LABEL_REAL_TIME_INTERVAL_ONE);$optionh1.hide();$optiond1.hide();$optionM1.hide();$option30s.show();$option10m.show();$option30m.show();}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppGauge'){$('#modalConfig .modal-body>.row>div').css('display','none');if(!_this.templateObj.entity.modal.option||_this.templateObj.entity.modal.option&&!_this.templateObj.entity.modal.option.guageBgColor){$('.guageBgColor').html('<input type="color" value="#2F91E8" data-key="guageBgColor"/>');}$('#divAppGauge').css('display','block');}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppHistory'){$('#modalConfig .modal-body>.row>div').css('display','none');$('#divAppHistory').css('display','block');}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppDiagRanking'){$('#modalConfig .modal-body>.row>div').css('display','none');$('.chartPointCog').css("pointer-events","none");$('#appDiagRank').css('display','block');}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&(_this.option.templateType==='ModalAPPMonthHistory'||_this.option.templateType==='ModalAppPie')){$('#modalConfig .modal-body>.row>div').css('display','none');}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalKpiOverview'){$('#modalConfig .modal-body>.row>div').css('display','none');$('.chartPointCog').css("pointer-events","none");}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalDataMonitorList'){$('#modalConfig .modal-body>.row>div').css('display','none');$('.chartPointCog').css("pointer-events","none");}});$modalConfig.off('shown.bs.modal').on('shown.bs.modal',function(){_this.initTime();_this.initDrag();_this.initConfigStart();});$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$modalConfig.find('#dataConfig').html('<div><span I18n="modalConfig.data.DATA_CONFIG_TITLE"></span></div>');I18n.fillArea($modalConfig.find('#dataConfig'));if(_this.modalType=="dashboard"){_this.toggleDataSource(false);}$('#divChartPointCog').css('display','none');_this.dataLose=undefined;});},toggleDataSource:function toggleDataSource(bool){var ele=$('#paneContent')[0];var colCount;if(!ele){return;}colCount=ele.classList.contains('col-sm-10');if(bool&&colCount){ele=document.getElementById('rightCt');ele&&ele.click();}if(!bool&&!colCount){ele=document.getElementById('rightCt');ele&&ele.click();}},initDataTypeWidth:function initDataTypeWidth(ele){if(window.innerWidth>1200){if(ele.outerWidth()<ele.parent().outerWidth()/4){ele.addClass('col-lg-3');}else if(ele.outerWidth()<ele.parent().outerWidth()/2){ele.addClass('col-lg-6');}else if(ele.outerWidth()<ele.parent().outerWidth()*3/4){ele.addClass('col-lg-9');}else{ele.addClass('col-lg-12');}}else{if(ele.outerWidth()<ele.parent().outerWidth()/3){ele.addClass('col-xs-4');}else if(ele.outerWidth()<ele.parent().outerWidth()*2/3){ele.addClass('col-xs-8');}else{ele.addClass('col-xs-12');}}},initOption:function initOption(){var $inputMode=$('#inputMode');var $divMode=$inputMode.parent();var $inputInterval=$('#inputInterval');var $divInterval=$inputInterval.parent();var $divInputGroupPeriod=$('#divInputGroupPeriod');var $divPeriod=$divInputGroupPeriod.parent();var $inputPeriodUnit=$('#inputPeriodUnit');var $inputPeriodValue=$('#inputPeriodValue');var $inputPeriodDropDown=$('#inputPeriodDropDown');var $divPeriodDropDown=$inputPeriodDropDown.parent();var $divInputGroupTimeRange=$('#divInputGroupTimeRange');var $divTimeRange=$divInputGroupTimeRange.parent();var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');var $gaugeMode=$('#gaugeMode');var $divGaugeMode=$gaugeMode.parent();var $divGauge=$('#divGauge');var $gaugeLowerLimit=$('#gaugeLowerLimit');var $gaugeUpperLimit=$('#gaugeUpperLimit');var $normalLowerLimit=$('#normalLowerLimit');var $normalUpperLimit=$('#normalUpperLimit');var $inputComparePeriod=$('#inputComparePeriod');var $divComparePeriod=$inputComparePeriod.parent();var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');var $divCompareDate=$('#divCompareDate');var $inputRealTimeInterval=$('#inputRealTimeInterval');var $divRealTimeInterval=$inputRealTimeInterval.parent();var $divHistoryRange=$('#divHistoryRange');var $inputHistoryRange=$('#inputHistoryRange');var $divChartSelect=$('#divChartSelect');var $divAppHistory=$("#divAppHistory");var i;var totalModeType={easy:[$divPeriodDropDown],fixed:[$divInterval,$divTimeRange],recent:[$divInterval,$divPeriod],realTime:[],easyEnergy:[$divPeriodDropDown],realTimeDashboard:[$divRealTimeInterval],easyCompareAnalyz:[$divCompareDate],easyCompare:[$divComparePeriod],easyCompareToggle:[$divComparePeriod,$divChartSelect],compareSensor:[$divInterval,$divComparePeriod,$divCompareDate],compareMeter:[$divInterval,$divComparePeriod,$divCompareDate],gauge:[$divGauge,$divGaugeMode],weather:[],easyHistory:[$divHistoryRange],easyHistorySelect:[$divHistoryRange,$divChartSelect],multiple:[$divRealTimeInterval],modalRankNormal:[$divPeriodDropDown]};var $dataConfig=$('#dataConfig');var $startConfig=$('#startConfig');$dataConfig.css('display','block');$startConfig.removeClass('alwaysEnable');$inputMode.children().css('display','none');var modeSelectInit=false;if(_this.option.modeUsable&&_this.option.modeUsable[0]&&(_this.option.templateType==='ModalAppGauge'||_this.option.templateType==='ModalAppPie'||_this.option.templateType==='ModalAppDiagRanking'||_this.option.templateType==='ModalAPPMonthHistory'||_this.option.templateType==='ModalKpiOverview'||_this.option.templateType==='ModalDataMonitorList')){return;}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppHistory'){$divAppHistory.css('display','block');var startTime=new Date().format("yyyy-MM-dd 00:00:00");var endTime=new Date().format("yyyy-MM-dd HH:mm:ss");$divAppHistory.find("#startTime").val(startTime);$divAppHistory.find("#endTime").val(endTime);var modalOption=_this.templateObj.entity.modal.option;return;}for(i=0;i<_this.option.modeUsable.length;i++){$inputMode.children('option[value='+_this.option.modeUsable[i]+']').css('display','block');if(_this.optionType){if(sessionStorage.getItem('mode')==_this.option.modeUsable[i]&&!modeSelectInit){$inputMode.val(_this.option.modeUsable[i]);modeSelectInit=true;}}else{if(_this.option.modeUsable[i]=='fixed'&&!modeSelectInit){$inputMode.val('fixed');modeSelectInit=true;}}}if(!modeSelectInit){$inputMode.val(_this.option.modeUsable[0]);}function initMode(mode){sessionStorage.setItem('mode',$inputMode.val());$divMode.siblings().css('display','none');$inputInterval.children().removeClass('forbid');for(var i=0;i<totalModeType[mode].length;i++){totalModeType[mode][i].css('display','block');}switch(mode){case'easy':initPeriodDropDown(mode);initInterval(mode);break;case'recent':initInterval(mode);break;case'easyEnergy':initPeriodDropDown(mode);initInterval(mode);break;case'weather':$dataConfig.css('display','none');$startConfig.addClass('alwaysEnable');break;case'easyCompareAnalyz':$inputComparePeriod.val('month');break;case'easyCompare':case'easyCompareToggle':$inputComparePeriod.val('day');break;default:break;}}
if(this.optionType){if(sessionStorage.getItem('interval')!=null){if($inputInterval.children('option[value="'+sessionStorage.getItem('interval')+'"]').hasClass('forbid')){$inputInterval.val($inputInterval.children(':not(.forbid)').first());}else{$inputInterval.val(sessionStorage.getItem('interval'));}}else{sessionStorage.setItem('interval',$inputInterval.val());}}else{if(_this.option.optionPara.interval){$inputInterval.val(_this.option.optionPara.interval);}else{$inputInterval.val($inputInterval.children(':not(.forbid)').first());}
this.setTimePrecision($inputInterval.val(),$inputTimeStart,$inputTimeEnd);}$inputInterval.off('change').change(function(e){sessionStorage.setItem('interval',$(e.target).val());_this.setTimePrecision(this.value,$inputTimeStart,$inputTimeEnd);});function initInterval(mode){$inputInterval.children().addClass('forbid');if(mode=='recent'){switch($inputPeriodUnit.children(':selected').val()){case'second':firstSelect='m5';secondSelect='m1';break;case'minute':firstSelect='m5';secondSelect='m1';break;case'hour':firstSelect='h1';secondSelect='m5';break;case'day':firstSelect='d1';secondSelect='h1';break;case'month':firstSelect='M1';secondSelect='d1';break;}$inputInterval.find('option[value="'+secondSelect+'"]').removeClass('forbid');}if(mode=='easy'){switch($inputPeriodDropDown.val()){case'today':firstSelect='h1';break;case'yesterday':firstSelect='h1';break;case'thisWeek':firstSelect='d1';break;case'lastWeek':firstSelect='d1';break;case'thisYear':firstSelect='M1';break;}}$inputInterval.find('option[value="'+firstSelect+'"]').removeClass('forbid').attr('selected',true);sessionStorage.setItem('interval',$inputInterval.val());}
var firstSelect,secondSelect;if(this.optionType){if(sessionStorage.getItem('periodValue')){$inputPeriodValue.val(sessionStorage.getItem('periodValue'));}if(sessionStorage.getItem('periodUnit')){$inputPeriodUnit.val(sessionStorage.getItem('periodUnit'));}if(sessionStorage.getItem('periodDropDown')){if($inputPeriodDropDown.children('option[value="'+sessionStorage.getItem('periodDropDown')+'"]').hasClass('forbid')){$inputPeriodDropDown.val($inputPeriodDropDown.children(':not(.forbid)').first());}$inputPeriodDropDown.val(sessionStorage.getItem('periodDropDown'));}}$inputPeriodValue.off('change').change(function(e){sessionStorage.setItem('periodValue',e.target.value);});$inputPeriodUnit.off('change').change(function(e){sessionStorage.setItem('periodUnit',e.target.value);initInterval($inputMode.val());});$divPeriodDropDown.off('change').change(function(e){sessionStorage.setItem('periodDropDown',e.target.value);initInterval($inputMode.val());});function initPeriodDropDown(mode){$inputPeriodDropDown.children('').removeClass('forbid');if(mode=='easy'){$inputPeriodDropDown.children().eq(1).addClass('forbid');}else if(mode=='easyEnergy'){$inputPeriodDropDown.children().eq(2).addClass('forbid');$inputPeriodDropDown.children().eq(4).addClass('forbid');$inputPeriodDropDown.children().eq(5).addClass('forbid');}}
if(_this.optionType&&sessionStorage.getItem('anlzTimeStart')!=null){$inputTimeStart.val(sessionStorage.getItem('anlzTimeStart'));$inputCompareDate1.val(sessionStorage.getItem('anlzTimeStart'));}else{$inputTimeStart.val(new Date(_this.option.optionPara.startTime).format(_this.getDateFmtByInputFmt($inputTimeStart[0].dataset.format)));$inputCompareDate1.val(new Date(_this.option.optionPara.startTime).format(_this.getDateFmtByInputFmt($inputCompareDate1[0].dataset.format)));}$inputTimeStart.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeStart',e.target.value);}});$inputCompareDate1.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeStart',e.target.value);}});if(_this.optionType&&sessionStorage.getItem('anlzTimeEnd')!=null){$inputTimeEnd.val(sessionStorage.getItem('anlzTimeEnd'));$inputCompareDate2.val(sessionStorage.getItem('anlzTimeEnd'));}else{$inputTimeEnd.val(new Date(_this.option.optionPara.endTime).format(_this.getDateFmtByInputFmt($inputTimeEnd[0].dataset.format)));$inputCompareDate2.val(new Date(_this.option.optionPara.endTime).format(_this.getDateFmtByInputFmt($inputCompareDate2[0].dataset.format)));}$inputTimeEnd.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeEnd',e.target.value);}});$inputCompareDate2.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeEnd',e.target.value);}});if(_this.option.optionPara.timeType&&$inputMode.val()=='easyCompareAnalyz'){$inputComparePeriod.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('comparePeriodAnalyz')!=null){$inputComparePeriod.val(sessionStorage.getItem('comparePeriodAnalyz'));}if(_this.option.optionPara.timeType&&($inputMode.val()=='easyCompare'||$inputMode.val()=='easyCompareToggle')){$inputComparePeriod.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('comparePeriod')!=null){$inputComparePeriod.val(sessionStorage.getItem('comparePeriod'));}$inputComparePeriod.change(function(e){sessionStorage.setItem('comparePeriod',$inputComparePeriod.val());});if(sessionStorage.getItem('gaugeMode')!=null){$gaugeMode.val(sessionStorage.getItem('gaugeMode'));}$gaugeMode.change(function(){sessionStorage.setItem('gaugeMode',$gaugeMode.val());});initGaugeMode();$gaugeMode.change(function(){initGaugeMode();});function initGaugeMode(){var green='<span class="input-group-addon gaugeGreen" i18n="modalConfig.option.GAUGE_GREEN"></span>';var red='<span class="input-group-addon gaugeRed" i18n="modalConfig.option.GAUGE_RED"></span>';if($gaugeMode.val()=='high'){$gaugeLowerLimit.next().remove();$gaugeLowerLimit.after(green);$normalUpperLimit.next().remove();$normalUpperLimit.after(red);}else if($gaugeMode.val()=='low'){$gaugeLowerLimit.next().remove();$gaugeLowerLimit.after(red);$normalUpperLimit.next().remove();$normalUpperLimit.after(green);}I18n.fillArea($('#divGauge'));}if(_this.option.optionPara.scaleList){_this.option.optionPara.scaleList.sort(function(a,b){return a>b?1:-1;});}if(_this.optionType&&sessionStorage.getItem('gaugeLowerLimit')!=null){$gaugeLowerLimit.val(sessionStorage.getItem('gaugeLowerLimit'));}else if(!_this.optionType&&_this.option.optionPara.scaleList){$gaugeLowerLimit.val(_this.option.optionPara.scaleList[0]);}$gaugeLowerLimit.change(function(){sessionStorage.setItem('gaugeLowerLimit',$gaugeLowerLimit.val());});if(_this.optionType&&sessionStorage.getItem('gaugeUpperLimit')!=null){$gaugeUpperLimit.val(sessionStorage.getItem('gaugeUpperLimit'));}else if(!_this.optionType&&_this.option.optionPara.scaleList){$gaugeUpperLimit.val(_this.option.optionPara.scaleList[3]);}$gaugeUpperLimit.change(function(){sessionStorage.setItem('gaugeUpperLimit',$gaugeUpperLimit.val());});if(_this.optionType&&sessionStorage.getItem('normalLowerLimit')!=null){$normalLowerLimit.val(sessionStorage.getItem('normalLowerLimit'));}else if(!_this.optionType&&_this.option.optionPara.scaleList){$normalLowerLimit.val(_this.option.optionPara.scaleList[1]);}$normalLowerLimit.change(function(){sessionStorage.setItem('normalLowerLimit',$normalLowerLimit.val());});if(_this.optionType&&sessionStorage.getItem('normalUpperLimit')!=null){$normalUpperLimit.val(sessionStorage.getItem('normalUpperLimit'));}else if(!_this.optionType&&_this.option.optionPara.scaleList){$normalUpperLimit.val(_this.option.optionPara.scaleList[2]);}$normalUpperLimit.change(function(){sessionStorage.setItem('normalUpperLimit',$normalUpperLimit.val());});if(_this.option.optionPara.timeType&&($inputMode.val()=='realTimeDashboard'||$inputMode.val()=='multiple')){$inputHistoryRange.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('historyRange')!=null){$inputHistoryRange.val(sessionStorage.getItem('historyRange'));}$inputHistoryRange.change(function(){sessionStorage.setItem('historyRange',$inputHistoryRange.val());});if(_this.option.optionPara.timeType&&($inputMode.val()=='easyHistory'||$inputMode.val()=='easyHistorySelect')){$inputHistoryRange.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('historyRange')!=null){$inputHistoryRange.val(sessionStorage.getItem('historyRange'));}$inputHistoryRange.change(function(){sessionStorage.setItem('historyRange',$inputHistoryRange.val());});initMode($inputMode.val());$inputMode.change(function(e){initMode($inputMode.val());});if('AnlzTendency'==this.option.templateType){$('#dataConfig').css('height','100%');$('#modifyChart').show();if(this.optionType){$('#modifyChartTitle').val('');$('#modifyChartYMax').val('');$('#modifyChartYMin').val('');$('#modifyChartYMark').val('');$('#modifyChartYUnitName').val('');$('#modifyChartYUnitEx')[0].selectedIndex=0;}else{var opt=_this.screen.curModal.chartOption;if(opt){$('#modifyChartTitle').val(opt.chartName);$('#modifyChartYMax').val(opt.yMax);$('#modifyChartYMin').val(opt.yMin);$('#modifyChartYMark').val(opt.yMark);var yUnit=opt.yUnit;var flag=' ';var index=yUnit.indexOf(flag);$('#modifyChartYUnitName').val(yUnit.substr(0,index));if(yUnit.substr(index+1)){$('#modifyChartYUnitEx').val(yUnit.substr(index+1));}else{$('#modifyChartYUnitEx')[0].selectedIndex=0;}}}}else{$('#dataConfig').css('height','350px');$('#modifyChart').hide();}$('#modifyChart .anlsModifyCobfig').off('click').click(function(){if($('#modifyChart .row').is(':visible')){$('#modifyChart .row').hide();}else{$('#modifyChart .row').show();}});},initConfigData:function initConfigData(){var $dataConfig=$('#dataConfig');var $divAppGauge=$('#divAppGauge');var $appDiagRank=$('#appDiagRank');$dataConfig.html('<div><span I18n="modalConfig.data.DATA_CONFIG_TITLE"></span></div>');var strConfigModalBody=$dataConfig.html();var strDataTypeShowName=[];if(_this.option.rowDataTypeShowName){for(var i=0;i<_this.option.rowDataType.length;++i){strDataTypeShowName.push(_this.option.rowDataTypeShowName[_this.option.rowDataType[i]]);}}else{strDataTypeShowName=_this.option.rowDataType;}for(var i=0;i<_this.option.rowDataType.length;++i){strConfigModalBody+='<div class="divConfigData" dataType="'+_this.option.rowDataType[i]+'">\
                                                <div class="dataTypeName">'+strDataTypeShowName[i]+'</div>\
                                                <span class="chartPointCog glyphicon glyphicon-cog grow"></span>\
                                                <div class="row rowDataValue"><div class="dataDragTip col-lg-3 col-xs-4"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></div></div>\
                                    </div>';}$dataConfig.html(strConfigModalBody);if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppDiagRanking'){$appDiagRank.css('display','block');var rankType;if(_this.templateObj.entity.modal.option){rankType=_this.templateObj.entity.modal.option.diagType?_this.templateObj.entity.modal.option.diagType:'fault';}else{rankType='fault';}$('#appDiagRank').find('select').val(rankType);}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppGauge'){$divAppGauge.css('display','block');var modalOption=_this.templateObj.entity.modal.option;var gaugeTitleVal=modalOption?modalOption.guageTitle:'';$('#appGuageTitle').val(gaugeTitleVal);$('#appGuageFulTitle').val(modalOption?modalOption.guageFulTitle:'');$('#appGuageDot').val(modalOption?modalOption.guageFixed:'');$('#appGuageUnit').val(modalOption?modalOption.guageUnit:'');var guageText=modalOption?modalOption.timeLocal:'';$('.timeDirectSelect').find('option[value="'+guageText+'"]').attr("selected",true);var guageDSelect=modalOption?modalOption.guageDirect:'';$('.GuageDirectSelect').find('option[value="'+guageDSelect+'"]').attr("selected",true);var bgColor=modalOption?modalOption.guageBgColor:'';if(bgColor){$('.guageBgColor').html('<input type="color" value="'+bgColor+'" data-key="guageBgColor"/>');}$('#guageBgColor').val();$('#appDataDot').val(modalOption?modalOption.transDataDot:'');}var btnStartConfigEnable;for(i=0;i<_this.option.optionPara.dataItem.length;++i){var $dataDragTip=$dataConfig.find('[dataType="'+_this.option.optionPara.dataItem[i].dsType+'"]').find('.dataDragTip');if($dataDragTip.length==0){$dataDragTip=$('.dataDragTip').eq(i);}var strDSConfig;var loseJudge;for(var j=0;j<_this.option.optionPara.dataItem[i].dsId.length;++j){loseJudge="ptExist";if(_this.option.optionPara.dataItem[i].dsName[j]==undefined){_this.option.optionPara.dataItem[i].dsName[j]=I18n.resource.modalConfig.data.DATA_LOSE;_this.dataLose=true;loseJudge="ptLose";}strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow '+loseJudge+'" dsid="'+_this.option.optionPara.dataItem[i].dsId[j]+'"><span class="contentDS" title="'+_this.option.optionPara.dataItem[i].dsName[j]+'">'+_this.option.optionPara.dataItem[i].dsName[j]+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig);btnStartConfigEnable=true;}}if(_this.modalType=="dataAnalysis"||_this.option.templateType==='ModalAppGauge'||_this.option.templateType==='ModalAppPie'||_this.option.templateType==='ModalAppHistory'||_this.option.templateType==='ModalAppDiagRanking'||_this.option.templateType==='ModalAPPMonthHistory'||_this.option.templateType==='ModalKpiOverview'||_this.option.templateType==='ModalDataMonitorList'){$('.chartPointCog').css('display','none');}else if(_this.modalType=="dashboard"){$('.chartPointCog').css('display','');}$dataConfig.off('click').on('click','.chartPointCog',function(e){$('#divChartPointCog').css('display','block');_this.initChartPtCog($('.chartPointCog').index($(e.target)));});if(_this.dataLose){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE11+"</strong>").show().close();}initDataTipAndButton();$('.alwaysEnable').removeClass('disabled');$('.divDSConfigure span').on('click',function(e){var $thisPar=$(e.target).parent();$thisPar.remove();if($('.ptLose').length==0){_this.dataLose=false;}initDataTipAndButton();$('#dataConfig').css('height','100%');});function initDataTipAndButton(){var NumOfDataTypeWithValue=0;var $rowDataValue=$('.rowDataValue');for(var i=0;i<$rowDataValue.length;++i){if($rowDataValue.eq(i).children().length>1){NumOfDataTypeWithValue+=1;}}if(_this.option.allDataNeed==true){if(NumOfDataTypeWithValue==$rowDataValue.length){$('#startConfig').removeClass('disabled');}else{$('#startConfig').addClass('disabled');}}else{if(NumOfDataTypeWithValue){$('#startConfig').removeClass('disabled');}else{$('#startConfig').addClass('disabled');}}if(_this.dataLose){$('#startConfig').addClass('disabled');}
if(_this.templateObj&&_this.templateObj.entity.modal.type=='ModalNote'){$('#startConfig').removeClass('disabled');}}_this.renderEditor();},initChartPtCog:function initChartPtCog(index){var $inputUpper=$('#inputPtValUpper');var $inputLower=$('#inputPtValLower');var $inputUnit=$('#inputPtUnit');var $inputAccuracy=$('#inputPtAccuracy');var $inputLineVal1=$('#inputLineVal1');var $inputLineName1=$('#inputLineName1');var $inputLineVal2=$('#inputLineVal2');var $inputLineName2=$('#inputLineName2');var $inputLineVal3=$('#inputLineVal3');var $inputLineName3=$('#inputLineName3');var $inputLineVal4=$('#inputLineVal4');var $inputLineName4=$('#inputLineName4');var $inputLineNameTotal=$('.inputLineName');var $inputLineValTotal=$('.inputLineVal');if(_this.option.dsChartCog&&_this.option.dsChartCog[index]){$inputUpper.val(_this.option.dsChartCog[index].upper);$inputLower.val(_this.option.dsChartCog[index].lower);$inputUnit.val(_this.option.dsChartCog[index].unit);$inputAccuracy.val(_this.option.dsChartCog[index].accuracy);for(var i=0;i<4;i++){$inputLineNameTotal.eq(i).val(_this.option.dsChartCog[index].markLine[i].name);$inputLineValTotal.eq(i).val(_this.option.dsChartCog[index].markLine[i].value);}}else{$('#divChartPointCog').find('input').val('');}$('#btnPtCogSure').off('click').click(function(){if(!_this.option.dsChartCog){_this.option.dsChartCog=[];for(var i=0;i<_this.option.rowDataType.length;++i){_this.option.dsChartCog[i]={};_this.option.dsChartCog[i].markLine=[{},{},{},{}];}}if(isNaN(Number($inputUpper.val()))||isNaN(Number($inputLower.val()))||isNaN(Number($inputAccuracy.val()))||isNaN(Number($inputLineVal1.val()))||isNaN(Number($inputLineVal2.val()))||isNaN(Number($inputLineVal3.val()))||isNaN(Number($inputLineVal4.val()))){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE10+"</strong>").show().close();return;}if($inputUpper.val()!=''&&$inputLower.val()!=''&&Number($inputUpper.val())<Number($inputLower.val())){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE12+"</strong>").show().close();return;}_this.option.dsChartCog[index].upper=$inputUpper.val();_this.option.dsChartCog[index].lower=$inputLower.val();_this.option.dsChartCog[index].unit=$inputUnit.val();_this.option.dsChartCog[index].accuracy=$inputAccuracy.val();for(var i=0;i<4;++i){if(!_this.option.dsChartCog[index].markLine[i]){_this.option.dsChartCog[index].markLine[i]={};}_this.option.dsChartCog[index].markLine[i].value=$inputLineValTotal.eq(i).val();_this.option.dsChartCog[index].markLine[i].name=$inputLineNameTotal.eq(i).val();}
$('#divChartPointCog').css('display','none');});$('#btnPtCogCancel').off('click').click(function(){$inputUpper.val('');$inputLower.val('');$inputUnit.val('');$inputAccuracy.val('');$('#divChartPointCog').css('display','none');});$('#btnPtCogRemove').off('click').click(function(){$inputUpper.val('');$inputLower.val('');$inputUnit.val('');$inputAccuracy.val('');$('#divChartPointCog').css('display','none');});},initTime:function initTime(){var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');$inputTimeStart.datetimepicker('remove');$inputTimeStart.datetime();$inputTimeEnd.datetimepicker('remove');$inputTimeEnd.datetime();var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');$inputCompareDate1.datetimepicker('remove');$inputCompareDate2.datetimepicker('remove');$inputCompareDate1.datetime();$inputCompareDate2.datetime();if(_this.optionType){var now=new Date();var time=new Date(now-259200000).format('yyyy-MM-dd HH:mm');var initCompareDate1=new Date(now.getFullYear(),now.getMonth()-2).format('yyyy-MM-dd HH:mm');var initCompareDate2=new Date(now.getFullYear(),now.getMonth()-1).format('yyyy-MM-dd HH:mm');if(!sessionStorage.getItem('anlzTimeStart')){$inputTimeStart.val(time);$inputCompareDate1.val(initCompareDate1);}now=now.format('yyyy-MM-dd HH:mm');if(!sessionStorage.getItem('anlzTimeEnd')){$inputTimeEnd.val(now);$inputCompareDate2.val(initCompareDate2);}}},initDrag:function initDrag(){var $divConfigData=$('.divConfigData');var $btnConfigStart=$('#startConfig');var _this=this;$divConfigData.on('dragover',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');});$divConfigData.on('dragleave',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');});var targetId,targetContent;var initBtnStartEnable;var initDragTipShow=[];var index;$divConfigData.on('drop',function(e,arg){$('.addData').removeClass('addData');var $note=$('#noteEditor');if(!$note.is(':hidden')&&!arg){return;}if(_this.option.templateType==="ModalAPPMonthHistory"||_this.option.templateType==="ModalAppDiagRanking"||_this.option.templateType==="ModalDataMonitorList"){var dsItemLength=$(e.currentTarget).find(".rowDataValue>div").length;if(dsItemLength===2){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE13+"</strong>").show().close();return;}}
index=$(e.currentTarget).index()-1;var $rowTempData=$(e.currentTarget).find('.rowDataValue');var $dataDragTip=$rowTempData.find('.dataDragTip');targetId=EventAdapter.getData().dsItemId;if(!targetId)return;if(Object.prototype.toString.call(targetId)==='[object Array]'){var len=targetId.length;var isContainue=false;for(var i=0;i<len;i++){if($rowTempData.find('.divDSConfigure[dsid="'+targetId[i]+'"]').length>0){targetId.splice(i,i+1);len=len-1;i=i-1;}else{targetContent=AppConfig.datasource.getDSItemById(targetId[i]).alias;var strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow" dsid="'+targetId[i]+'"><span class="contentDS" title="'+targetContent+'">'+targetContent+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig);}}if(targetId.length<1){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE2+"</strong>").show().close();}else{$('#startConfig').removeClass('disabled');}}else{var info=AppConfig.datasource.getDSItemById(targetId);targetContent=info.alias===""?info.value:info.alias;if($rowTempData.find('.divDSConfigure[dsid="'+targetId+'"]').length>0){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE2+"</strong>").show().close();return;}var strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow" dsid="'+targetId+'"><span class="contentDS" title="'+targetContent+'">'+targetContent+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig);$('#startConfig').removeClass('disabled');}initBtnStartAndDragTip(index);$(e.currentTarget).find('.divDSConfigure span').off('click').on('click',function(e){var $thisPar=$(e.target).parent();var dsid=$thisPar.attr('dsid');$thisPar.remove();if($('.ptLose').length==0){_this.dataLose=false;}initBtnStartAndDragTip(index);var $dataConfig=$('#dataConfig');$dataConfig.css('height','100%');});var $dataConfig=$('#dataConfig');if('AnlzTendency'!=_this.option.templateType){$dataConfig.height('');}if($dataConfig.height()>window.innerHeight-80){$dataConfig.css('height','100%');}if(!$note.is(':hidden')&&arg){var insertHtmlAtCaret=function insertHtmlAtCaret(html,targetId){var sel,range;var iframeWin=_this.ue.window;if(iframeWin.getSelection){sel=iframeWin.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var el=document.createElement("div");el.innerHTML=html;var frag=document.createDocumentFragment(),node,lastNode;while(node=el.firstChild){lastNode=frag.appendChild(node);}range.insertNode(frag);if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range);}$(iframeWin.document).find('#'+targetId)[0].addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);$(iframeWin.document).find('#'+targetId).off('click').on('click',function(e){_this.initNotePtCfg($(iframeWin.document).find('.pointValue').index($(e.target)));});}}};if(Object.prototype.toString.call(targetId)==='[object Array]'){var len=targetId.length;for(var i=0;i<len;i++){targetContent=AppConfig.datasource.getDSItemById(targetId[i]).alias;var format='&nbsp;<span id = "'+targetId[i]+'" contenteditable="false" class="pointValue" title="'+targetContent+'"><%'+targetContent+'%></span>&nbsp;';insertHtmlAtCaret(format,targetId[i]);}}else{var format='&nbsp;<span id = "'+targetId+'" contenteditable="false" class="pointValue" title="'+targetContent+'"><%'+targetContent+'%></span>&nbsp;';insertHtmlAtCaret(format,targetId);}}});function initBtnStartAndDragTip(indexOfDataType){var tempDivDS=$divConfigData.find('.rowDataValue').eq(indexOfDataType).children();if(_this.option.allDataNeed==true){initBtnStartEnable=true;for(var i=0;i<$divConfigData.length;++i){if($divConfigData.find('.rowDataValue').eq(i).children().length<=1){initBtnStartEnable=false;break;}}if(tempDivDS.length>1){}else{initBtnStartEnable-=1;initDragTipShow[indexOfDataType]=true;}}else{if($divConfigData.find('.divDSConfigure').length>0){initBtnStartEnable=true;}else{initBtnStartEnable=false;}}if(initBtnStartEnable>0){$btnConfigStart.removeClass('disabled');}else{$btnConfigStart.addClass('disabled');}
if(_this.dataLose){$btnConfigStart.addClass('disabled');}}},initConfigStart:function initConfigStart(){var $modalConfig=$('#modalConfig');var $inputModal=$('#inputMode');document.getElementById('startConfig').onclick=function(){if($(this).hasClass('disabled'))return;var tempStartTime,tempEndTime,tempPeriodTime;var tempInterval=0;var $inputPeriodValue=$('#inputPeriodValue');var periodValue=$inputPeriodValue.val();var tempDSId,tempDS,arrItemDS=[];var $rowDataValue=$('.rowDataValue');var $inputInterval=$('#inputInterval');var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');var $inputPeriodUnit=$('#inputPeriodUnit');var $inputPeriodDropDown=$('#inputPeriodDropDown');var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');var $inputComparePeriod=$('#inputComparePeriod');var $gaugeMode=$('#gaugeMode');var $gaugeLowerLimit=$('#gaugeLowerLimit');var $gaugeUpperLimit=$('#gaugeUpperLimit');var $normalLowerLimit=$('#normalLowerLimit');var $normalUpperLimit=$('#normalUpperLimit');var $inputRealTimeInterval=$('#inputRealTimeInterval');var $optionSelescted=$('#inputRealTimeInterval option:selected').val();var $inputHistoryRange=$('#inputHistoryRange');var timeType,scaleList;var now;for(var i=0;i<$rowDataValue.length;++i){tempDS={};tempDS.type=$rowDataValue[i].parentNode.getAttribute('dataType');tempDSId=[];for(var j=0;j<$rowDataValue[i].children.length-1;++j){tempDSId.push($rowDataValue[i].children[j].getAttribute('dsid'));}tempDS.arrId=tempDSId;arrItemDS.push(tempDS);}var totalModeType={easy:'easy',fixed:'fixed',recent:'recent',realTime:'realTime',easyCompareAnalyz:'easyCompareAnalyz',easyCompare:'easyCompare',easyCompareToggle:'easyCompareToggle',compareSensor:'compareSensor',compareMeter:'compareMeter',realTimeDashboard:"realTimeDashboard",gauge:'gauge',weather:'weather',easyHistory:"easyHistory",easyHistorySelect:"easyHistorySelect",multiple:'multiple'};switch($inputModal.val()){case totalModeType['fixed']:tempStartTime=$inputTimeStart.val().toDate().format('yyyy-MM-dd HH:mm');tempEndTime=$inputTimeEnd.val().toDate().format('yyyy-MM-dd HH:mm');if(tempStartTime.toDate()>=tempEndTime.toDate()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE3+"</strong>").show().close();return;}if(tempEndTime.toDate()>=new Date()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE4+"</strong>").show().close();return;}break;case totalModeType['recent']:tempEndTime=new Date().format('yyyy-MM-dd HH:mm:ss');switch($inputPeriodUnit.val()){case'hour':tempPeriodTime=periodValue*3600000;break;case'day':tempPeriodTime=periodValue*86400000;break;case'month':tempPeriodTime=periodValue*2592000000;break;case'year':tempPeriodTime=periodValue*31536000000;break;}now=new Date();tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case totalModeType['realTime']:tempStartTime='';tempEndTime='';break;case totalModeType['easy']:now=new Date();switch($inputPeriodDropDown.val()){case'today':tempPeriodTime=86400000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case'yesterday':var yesterday=new Date();yesterday=new Date(yesterday.setDate(yesterday.getDate()-1));tempEndTime=new Date(getTimeOfMidnightZero(now).getTime()-1000).format('yyyy-MM-dd HH:mm:ss');tempStartTime=getTimeOfMidnightZero(yesterday).format('yyyy-MM-dd HH:mm:ss');break;case'thisWeek':tempPeriodTime=604800000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case'lastWeek':tempPeriodTime=604800000;tempEndTime=getTimeOfMidnightZero(new Date(now-(now.getDay()+1)*86400000)).format('yyyy-MM-dd HH:mm:ss');tempStartTime=getTimeOfMidnightZero(new Date(now-(now.getDay()+7)*86400000)).format('yyyy-MM-dd HH:mm:ss');break;case'thisYear':tempPeriodTime=31536000000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;}break;case totalModeType['realTimeDashboard']:tempStartTime='';tempEndTime='';tempInterval=$inputRealTimeInterval.val();timeType=$inputRealTimeInterval.val();break;case totalModeType['multiple']:tempStartTime='';tempEndTime='';tempInterval=$inputInterval.val();timeType=$inputRealTimeInterval.val();var paraType=arrItemDS;break;case totalModeType['easyCompareAnalyz']:tempPeriodTime='month';$inputInterval.val('d1');timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['easyCompare']:tempPeriodTime='month';$inputInterval.val('d1');timeType=$inputComparePeriod.val();break;case totalModeType['easyCompareToggle']:tempPeriodTime='month';$inputInterval.val('d1');timeType=$inputComparePeriod.val();var chartType=$('#inputChartSelect').val();break;case totalModeType['compareSensor']:tempPeriodTime=$inputComparePeriod.val();timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['compareMeter']:tempPeriodTime=$inputComparePeriod.val();timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['gauge']:if($gaugeMode.val()=='high'){scaleList=[$gaugeLowerLimit.val(),$normalLowerLimit.val(),$normalUpperLimit.val(),$gaugeUpperLimit.val()];}else{scaleList=[$gaugeUpperLimit.val(),$normalUpperLimit.val(),$normalLowerLimit.val(),$gaugeLowerLimit.val()];}for(i=0;i<scaleList.length;i++){if(isNaN(Number(scaleList[i]))){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE10+"</strong>").show().close();return;}scaleList[i]=parseFloat(scaleList[i]);}var tempArr=scaleList.concat();if($gaugeMode.val()=='high'){tempArr.sort(function(a,b){return a>b?1:-1;});}else{tempArr.sort(function(a,b){return a<b?1:-1;});}if(tempArr.toString()!=scaleList.toString()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE5+"</strong>").show().close();return;}break;case totalModeType['weather']:tempStartTime='';tempEndTime='';break;case totalModeType['easyHistory']:timeType=$inputHistoryRange.val();break;case totalModeType['easyHistorySelect']:timeType=$inputHistoryRange.val();var chartType=$('#inputChartSelect').val();break;default:break;}
function initCompareTime(period,time){var startTime;switch(period){case'hour':startTime=time.toDate().format('yyyy-MM-dd HH')+':00:00';break;case'day':startTime=time.toDate().format('yyyy-MM-dd')+' 00:00:00';break;case'week':var weekDay=time.toDate().getDay();var date=time.toDate().getDate();startTime=new Date(time.toDate().setDate(date-weekDay+1)).format('yyyy-MM-dd')+' 00:00:00';break;case'month':startTime=time.toDate().format('yyyy-MM')+'-01 00:00:00';break;default:break;}return startTime;}
function getTimeOfMidnightZero(date){var tempDate;if(date){tempDate=date;}else{tempDate=new Date();}return(date.format('yyyy-MM-dd')+' 00:00:00').toDate();}if(_this.modalType=="dataAnalysis"){if(_this.optionType){_this.screen.curModal={startTime:tempStartTime,endTime:tempEndTime,format:$inputInterval.val(),mode:$inputModal.val(),type:_this.option.templateType,itemDS:arrItemDS,comparePeriod:tempPeriodTime,dsChartCog:_this.option.dsChartCog,noteList:[],graphList:[]};}else{_this.screen.curModal={startTime:tempStartTime,endTime:tempEndTime,format:$inputInterval.val(),mode:$inputModal.val(),type:_this.option.templateType,itemDS:arrItemDS,comparePeriod:tempPeriodTime,dsChartCog:_this.option.dsChartCog,noteList:_this.screen.curModal.noteList,graphList:_this.screen.curModal.graphList};}}else if(_this.modalType=="dashboard"){_this.templateObj.entity.modal.option={timeFormat:$optionSelescted};_this.templateObj.configParams={};var $divDSConfigure=$('.divDSConfigure');_this.templateObj.entity.modal.title=$('.springSel .chartTitle input').val();_this.templateObj.entity.modal.points=[];_this.templateObj.entity.modal.StartTime=tempStartTime;_this.templateObj.entity.modal.EndTime=tempEndTime;_this.templateObj.entity.modal.dsChartCog=_this.option.dsChartCog;if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppGauge'){var appGuageList={};var guageTitle=$('#appGuageTitle').val().trim();var guageFulTitle=$('#appGuageFulTitle').val().trim();var guageFixed=$('#appGuageDot').val().trim();var guageUnit=$('#appGuageUnit').val().trim();var timeLocal=$('.timeDirectSelect').val();var guageDirect=$('.GuageDirectSelect').val();var guageBgColor=$('.guageBgColor').find('input').val();var transDataDot=$('#appDataDot').val().trim();if(guageFixed!==''&&!/^(0|[1-9]\d*)$/.test(guageFixed)){alert('请输入非负整数！');return;}if(parseInt(transDataDot)<0||parseInt(transDataDot)>1){alert('请输入0-1之间的小数！');return;}}if(_this.option.templateType==='ModalAppDiagRanking'){var diagType=$('#appDiagRank').find('select.selecTDiagType').val();}if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppHistory'){var historyTitle=$('#appHistoryTitle').val();}if(_this.templateObj.entity.modal.type=='ModalNote'){var $divModalTextSpan=$(_this.ue.body).find('.pointValue');_this.templateObj.entity.modal.modalText=_this.ue.getContent();for(var i=0;i<$divModalTextSpan.length;++i){_this.templateObj.entity.modal.points.push($divModalTextSpan.get(i).attributes['id'].value);}_this.templateObj.entity.modal.modalTextUrl=_this.editorData;}else{if(_this.templateObj.entity.modal.type==='ModalAppPie'){_this.templateObj.entity.modal.points.push($divDSConfigure.get(0).attributes['dsid'].value);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:$divDSConfigure.get(0).attributes['dsid'].value}).done(function(result){var data=JSON.parse(result.dsItemList[0].data);var projectId=data.EnergyList[0].projectId;if(!projectId){if(AppConfig.project&&AppConfig.project.bindId){projectId=AppConfig.project.bindId;}else{projectId=AppConfig.projectId;}}_this.templateObj.entity.modal.points.push('@'+projectId+'|'+data.EnergyList[0].accumCostPoint);_this.templateObj.entity.modal.points.push('@'+projectId+'|'+data.EnergyList[0].accumEnergyPoint);});}else{for(var i=0;i<$divDSConfigure.length;++i){_this.templateObj.entity.modal.points.push($divDSConfigure.get(i).attributes['dsid'].value);}}}
var option={};timeType&&(option.timeType=timeType);scaleList&&(option.scaleList=scaleList);paraType&&(option.paraType=paraType);chartType&&(option.showType=chartType);if(_this.option.templateType==='ModalAppGauge'){option['guageTitle']=guageTitle!==''?guageTitle:null;option['guageFulTitle']=guageFulTitle!==''?guageFulTitle:null;option['guageFixed']=guageFixed!==''?parseInt(guageFixed):null;option['guageUnit']=guageUnit!==''?guageUnit:null;option['timeLocal']=timeLocal!==''?timeLocal:null;option['guageDirect']=guageDirect!==''?guageDirect:null;option['guageBgColor']=guageBgColor!==''?guageBgColor:null;option['transDataDot']=transDataDot!==''?parseFloat(transDataDot):null;}historyTitle&&(option.historyTitle=historyTitle);if(_this.option.templateType==='ModalAppDiagRanking'){option['diagType']=diagType;}}$modalConfig.modal('hide');_this.newPageFlag=true;if(_this.modalType=='dataAnalysis'){var yMax=$('#modifyChartYMax').val();var yMin=$('#modifyChartYMin').val();var yUintSpare=$('#modifyChartYUnitEx').find("option:selected").text();yUintSpare=yUintSpare==='--'?'':yUintSpare;if(yMax){yMax=parseInt(yMax,10);}if(yMin){yMin=parseInt(yMin,10);}var chartOpt={'chartName':$('#modifyChartTitle').val(),'yUnit':$('#modifyChartYUnitName').val()+' '+yUintSpare,'yMax':yMax,'yMin':yMin,'yMark':$('#modifyChartYMark').val()};_this.screen.curModal.chartOption=chartOpt;_this.screen.renderModal();}else if(_this.modalType=='dashboard'){_this.templateObj.setModalOption(option);_this.templateObj.render();}};},close:function close(){this.screen=null;this.container.parentNode.removeChild(this.container);this.container=null;this.modalType=null;this.ue=null;},initEditor:function initEditor(){var _this=this;this.editorData=_this.templateObj.entity.modal.modalTextUrl?_this.templateObj.entity.modal.modalTextUrl:[];if(!this.ue){UE.delEditor('noteEditor');this.ue=UE.getEditor('noteEditor',{lang:I18n.type=='zh'?'zh-cn':'en'});this.ue.ready(function(){$('#noteEditor').slideDown('fast');$('#dataConfig').hide();this.setContent(_this.templateObj.entity.modal.modalText?_this.templateObj.entity.modal.modalText:'');$(this.iframe).addClass('gray-scrollbar');this.body.ondrop=dropBody;this.body.ondragover=ondragoverBody;this.body.ondragleave=dragleaveBody;this.body.onmouseup=onmouseupBody;this.body.onkeydown=onkeydownBody;$(this.body).find('.pointValue').each(function(){this.addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);});});}else{this.ue.setContent(this.templateObj.entity.modal.modalText?this.templateObj.entity.modal.modalText:'');}
function dropBody(e){e.preventDefault();this.focus();var $divConfigData=$('#modalConfig').find('.divConfigData');$divConfigData.trigger('drop',[e]);var $editorPoint=$(_this.ue.body).find('.pointValue');var modalTextUrl=_this.editorData?_this.editorData:[];var tempModalTexUrl=[];var flag;for(var i=0;i<$editorPoint.length;i++){flag=false;for(var j=0;j<modalTextUrl.length;j++){if($editorPoint[i].id==modalTextUrl[j].ptId){tempModalTexUrl[i]=modalTextUrl[j];flag=true;break;}}if(!flag){tempModalTexUrl[i]={ptId:$editorPoint[i].id,ptName:$editorPoint[i].innerText.match(/\b\w+\b/g),ptTextUrl:[]};}}_this.editorData=tempModalTexUrl;}function ondragoverBody(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');}function dragleaveBody(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');}function onmouseupBody(e){var selection=window.getSelection();if(selection.type=="Range"){var content=selection.getRangeAt(0).cloneContents();for(var i in content.childNodes){if(content.childNodes[i].className=='pointValue'){$('.pointValue').attr("contenteditable",true);_this.isSelection=true;return;}}}else{$('.pointValue').attr("contenteditable",false);}_this.isSelection=false;}function onkeydownBody(e){if(_this.isSelection)window.event.returnValue=false;};},renderEditor:function renderEditor(){var $note=$('#noteEditor');var $dataConfig=$('#dataConfig');if(this.templateObj&&this.templateObj.entity.modal.type=='ModalNote'){$dataConfig.hide();$note.show();if(this.editorData){var $editor=$('#editor');$editor.find('.pointValue').off('click').on('click',function(e){_this.initNotePtCfg($editor.find('.pointValue').index($(e.target)));});}}else{$dataConfig.show();$note.hide();}},domNodeRemoved:function domNodeRemoved(){var id=$(this).attr('id');var $target=$('.divDSConfigure[dsid="'+id+'"]');var index=$target.parent().children('.divDSConfigure').index($target);setTimeout(function(){var newDom=$(_this.ue.body).find('#'+id);if(newDom.length<1){$target.find('.btnRemoveDS').trigger('click');var tempArray=[];for(var i=0;i<_this.editorData.length;i++){if(i==index)continue;tempArray.push(_this.editorData[i]);}_this.editorData=tempArray;}else{newDom[0].addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);}},1000);},initNotePtCfg:function initNotePtCfg(index){var modalTextUrl;var $editorPoint=$(_this.ue.body).find('.pointValue');if(_this.editorData&&$editorPoint.length==_this.editorData.length){modalTextUrl=_this.editorData;}else{modalTextUrl=[];for(var i=0;i<$editorPoint.length;++i){modalTextUrl.push({ptId:$editorPoint[i].id,ptName:$editorPoint[i].innerText.match(/\b\w+\b/g),ptTextUrl:[]});}}var temp;var $tempDivUrl=$('<div class="col-xs-4 "><select type="text" class="form-control inputNotePtCfgUrl"></select></div>');var $tempSelUrl=$tempDivUrl.children();$tempSelUrl[0].options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,'',true));for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);$tempSelUrl[0].options.add(option);}$tempSelUrl[0].onchange=function(){_this.templateObj.entity.modal.link=$tempSelUrl[0].value;};var strNotePtCfg=new StringBuilder();strNotePtCfg.append('<div id="containerNotePtCfg">');strNotePtCfg.append('   <span class="glyphicon glyphicon-plus" id="btnNotePtCfgAdd" aria-hidden="true"></span>');strNotePtCfg.append('   <span class="glyphicon glyphicon-remove" id="btnNotePtCfgExit" aria-hidden="true"></span>');strNotePtCfg.append('   <div class="rowNotePtCfgTitle row">');strNotePtCfg.append('       <div class="col-xs-3">Value</div>');strNotePtCfg.append('       <div class="col-xs-5">Name</div>');strNotePtCfg.append('       <div class="col-xs-4">Url</div>');strNotePtCfg.append('   </div>');strNotePtCfg.append('   <div id="divNotePtCfg">');strNotePtCfg.append('   </div>');strNotePtCfg.append('   <div id="divBtnNotePtCfg">');strNotePtCfg.append('       <button type="button" class="btn btn-primary" id="btnNotePtCogSure" i18n="modalConfig.data.PT_COG_SURE"></button>');strNotePtCfg.append('       <button type="button" class="btn btn-primary" id="btnNotePtCogCancel" i18n="modalConfig.data.PT_COG_CANCEL"></button>');strNotePtCfg.append('   </div>');strNotePtCfg.append('</div>');$('#noteEditor').append(strNotePtCfg.toString());strNotePtCfg=new StringBuilder();if(modalTextUrl[index]&&modalTextUrl[index].ptTextUrl.length>0){for(var i=0;i<modalTextUrl[index].ptTextUrl.length;i++){temp=modalTextUrl[index].ptTextUrl[i];strNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal" value="'+temp.value+'"></div>');strNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName" value="'+temp.name+'"></div>');strNotePtCfg.append('   </div>');}}else{strNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal"></div>');strNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName"></div>');strNotePtCfg.append('   </div>');}$('#divNotePtCfg').append(strNotePtCfg.toString());var $rowNotePtCfg=$('.rowNotePtCfg');var tempVal;for(var i=0;i<$rowNotePtCfg.length;i++){$rowNotePtCfg.eq(i).append($tempDivUrl.clone());tempVal=modalTextUrl[index].ptTextUrl[i]?modalTextUrl[index].ptTextUrl[i].url:'';$rowNotePtCfg.eq(i).find('.inputNotePtCfgUrl').val(tempVal);}I18n.fillArea($('#divBtnNotePtCfg'));var $self=$('#containerNotePtCfg');$('#btnNotePtCfgAdd').off('click').on('click',function(e){var strRowNotePtCfg=new StringBuilder();strRowNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strRowNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strRowNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal"></div>');strRowNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName"></div>');strRowNotePtCfg.append('   </div>');$('#divNotePtCfg').append(strRowNotePtCfg.toString());$('.rowNotePtCfg').last().append($tempDivUrl.clone());$('.btnRowNoteCfgRemove').last().off('click').on('click',function(e){var tempPtTextUrl=[];var tempIndex=$('.btnRowNoteCfgRemove').index($(e.target));tempPtTextUrl=[_this.editorData[index].ptTextUrl.slice(0,tempIndex),_this.editorData[index].ptTextUrl.slice(tempIndex+1)];tempPtTextUrl=tempPtTextUrl[0].concat(tempPtTextUrl[1]);_this.editorData[index].ptTextUrl=tempPtTextUrl.concat();$(e.target).parent().remove();});});$('#btnNotePtCfgExit').off('click').on('click',function(e){$self.remove();});$('#btnNotePtCogSure').off('click').on('click',function(e){$rowNotePtCfg=$('.rowNotePtCfg');modalTextUrl[index].ptTextUrl=[];for(var j=0;j<$rowNotePtCfg.length;j++){modalTextUrl[index].ptTextUrl.push({value:$rowNotePtCfg.eq(j).find('.inputNotePtCfgVal').val(),name:$rowNotePtCfg.eq(j).find('.inputNotePtCfgName').val(),url:$rowNotePtCfg.eq(j).find('.inputNotePtCfgUrl').val()});}_this.editorData=modalTextUrl;$self.remove();});$('#btnNotePtCogCancel').off('click').on('click',function(e){$self.remove();});$('.btnRowNoteCfgRemove').off('click').on('click',function(e){var tempPtTextUrl=[];var tempIndex=$('.btnRowNoteCfgRemove').index($(e.target));tempPtTextUrl=[_this.editorData[index].ptTextUrl.slice(0,tempIndex),_this.editorData[index].ptTextUrl.slice(tempIndex+1)];tempPtTextUrl=tempPtTextUrl[0].concat(tempPtTextUrl[1]);_this.editorData[index].ptTextUrl=tempPtTextUrl.concat();$(e.target).parent().remove();});},setTimePrecision:function setTimePrecision(cycle,$iptTime1,$iptTime2){var option={format:"yyyy-mm-dd hh:ii",autoclose:true,todayBtn:true,initialDate:new Date(),startView:2};$iptTime1.datetimepicker('remove');$iptTime2&&$iptTime2.datetimepicker('remove');switch(cycle){case'm1':option.minView=0;break;case'm5':option.minView=0;break;case'h1':option.minView=1;option.format="yyyy-mm-dd hh:00";break;case'd1':option.minView=2;option.format="yyyy-mm-dd 00:00";break;case'M1':option.minView=3;option.startView=3;option.format="yyyy-mm-01 00:00";break;default:option.minView=2;option.format="yyyy-mm-dd 00:00";break;}$iptTime1.datetime();$iptTime2&&$iptTime2.datetime();},getDateFmtByInputFmt:function getDateFmtByInputFmt(inputFmt){var arrFmt=inputFmt.split(' ');var dtFmt='';for(var i=0;i<arrFmt.length;i++){if(/yyyy(.)mm(.)dd/.test(arrFmt[i])){dtFmt+=arrFmt[i].replace(/mm/,'MM');}if(/hh:ii/.test(arrFmt[i])){dtFmt+=' HH:mm';}}return dtFmt;}};return modalConfigurePane;}();var shareLogging=function(){var _this=this;function shareLogging(userId){if(typeof userId==='undefined'){userId=BEOPUtil.getCookie('userId');}
this.userId=userId;_this=this;_this.shareLogList=undefined;}
shareLogging.prototype={show:function show(){WebAPI.get('/static/views/observer/widgets/shareLogging.html').done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.init();});},init:function init(){Spinner.spin(ElScreenContainer);WebAPI.get('/analysis/getShareLog/'+AppConfig.userId).done(function(result){_this.shareLogList=result.shareLogList;var totalShareLog='';for(var i=0;i<_this.shareLogList.length;++i){var shareTime=new Date(_this.shareLogList[i].shareDate.slice(0,_this.shareLogList[i].shareDate.indexOf('GMT'))).timeFormat(timeFormatChange('yyyy-mm-dd hh:ii'));var strShareLog=new StringBuilder();strShareLog.append('<div class="row rowShareLogContent" menuId ="'+_this.shareLogList[i].menuItemId+'" id="'+_this.shareLogList[i].shareLogId+'">');strShareLog.append('    <div class="shareOrder">'+'<span class="shareLogIndex">'+String(i+1)+'</span></div>');strShareLog.append('    <div class="shareDescribe shareCon"><span style="text-align:left;vertical-align:middle;display:inline-block;width:90%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" class="shareVal" title="">'+_this.shareLogList[i].shareDesc+'</span></div>');strShareLog.append('    <div class="shareDate shareDate">'+shareTime+'</div>');strShareLog.append('    <div class="shareOperate"><span class="glyphicon glyphicon-pencil shareDesc grow" style="vertical-align:middle;" title="'+I18n.resource.analysis.shareLog.EDIT_DESCRIPTION+'"></span><span class="glyphicon glyphicon-edit btnSharePageEdit grow" title="'+I18n.resource.analysis.shareLog.EDIT_PAGE+'"></span><span class="glyphicon glyphicon-remove btnShareRemove grow" title="'+I18n.resource.analysis.shareLog.DELETE_SHARE_LOG+'"></span></div>');strShareLog.append('<br style="clear:both;"></div>');totalShareLog+=strShareLog;}
if(totalShareLog==''){$('.divShareLog').parent().html('<div class="shareNone">'+I18n.resource.analysis.shareLog.NONE_LOG+'</div>');$('.shareNone').off('click').click(function(){ScreenManager.show(AnalysisScreen);});}else{$('.divShareLog').html(totalShareLog);}
$('.shareURL').click(function(e){window.open(e.target.innerHTML);});$('.btnShareLogClose').off('click').click(function(){ScreenManager.show(AnalysisScreen);});$('.rowShareLogContent').off('click').hover(function(){$(this).children('.shareOperate').show();if($('.shareCon input').length>0)return;$(this).children('.shareVal').attr('title',$(this).children('.shareVal').text());},function(){$(this).children('.shareOperate').hide();});$('.rowShareLogContent').click(function(e){window.open(window.location.origin+'/share/db/'+AppConfig.userId+'/'+$(e.currentTarget).attr('menuId'),'_blank');});_this.initEdit();_this.initDelete();_this.initDashboardPageEdit();I18n.fillArea($(ElScreenContainer));Spinner.stop();});},initEdit:function initEdit(){$('.shareDesc').click(function(e){e.preventDefault();e.stopPropagation();var shareOldVal=$(e.currentTarget).parent('.shareOperate').siblings('.shareCon').children('span').text();$(e.currentTarget).parent('.shareOperate').siblings('.shareCon').children('span').css('display','none');var inputDescEdit=document.createElement('input');inputDescEdit.setAttribute('type','text');inputDescEdit.setAttribute('placeholder',I18n.resource.analysis.shareLog.DESC_TIP);inputDescEdit.style.width='80%';inputDescEdit.value=shareOldVal;$(e.currentTarget).parent('.shareOperate').siblings('.shareCon').append(inputDescEdit);inputDescEdit.focus();var oldDesc=inputDescEdit.value;$(inputDescEdit).click(function(e){e.stopPropagation();});inputDescEdit.onblur=function(e){var postData={desc:e.target.value,shareId:$(e.target).closest('.rowShareLogContent').attr('id')};if(oldDesc!=e.target.value){WebAPI.post('/analysis/editShareLog/0',postData).done(function(result){console.log(result);}).error(function(){alert('Edit ShareLog Error');});}
$(e.target).prev().html(e.target.value).css('display','');$(e.target).parent('.shareCon').children('.shareVal').css('display','inline-block').html(e.target.value);$(e.target).parent('.shareCon').siblings('.shareOperate').children('.shareDesc').html('');e.target.remove();};});},initDelete:function initDelete(){$('.btnShareRemove').click(function(e){e.stopPropagation();confirm(I18n.resource.analysis.shareLog.REMOVE_ALERT,function(){var index=$('.btnShareRemove').index($(e.target));var postData={menuItemId:_this.shareLogList[index].menuItemId,shareId:$(e.target).closest('.rowShareLogContent').attr('id')};WebAPI.post('/analysis/editShareLog/1',postData).done(function(result){console.log(result);}).error(function(){alert('Remove ShareLog Error');});_this.shareLogList.splice(index,1);$(e.target).closest('.rowShareLogContent').remove();$('.shareLogIndex').each(function(index){$(this).text(index+1);});if($('.rowShareLogContent').length==0){$('#shareLogPanel .panel-body').html('<div class="shareNone">'+I18n.resource.analysis.shareLog.NONE_LOG+'</div>');$('.shareNone').off('click').click(function(){ScreenManager.show(AnalysisScreen);});}});});},initDashboardPageEdit:function initDashboardPageEdit(){$('.btnSharePageEdit').click(function(e){e.preventDefault();e.stopPropagation();var index=$('.btnSharePageEdit').index($(e.target));var menuItemId=_this.shareLogList[index].menuItemId.split('?')[0];var postData={shareLogId:_this.shareLogList[index].shareLogId,desc:_this.shareLogList[index].shareDesc};ScreenManager.show(EnergyScreen,menuItemId,null,postData);});},close:function close(){_this.shareLogList=null;}};return shareLogging;}();var DiagnosisConfig=function(){var _this;function DiagnosisConfig(parent){this.parent=parent;_this=this;_this.orderList=[];_this.enableList=[];_this.limitList=[];_this.template=undefined;}
DiagnosisConfig.prototype={show:function show(){var _this=this;WebAPI.get("/static/views/observer/diagnosis/diagnosisConfig.html").done(function(resultHtml){var $dialog=$('#dialogModal');$dialog.find('#dialogContent').html(resultHtml);Spinner.spin($dialog.find('.modal-body')[0]);_this.template=$('#createCase')[0].outerHTML.replace(' active in','').replace('confirmCreateCase','confirmEditCase');$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.close();Spinner.stop();$dialog.find('#dialogContent').empty();}).modal({});$dialog.on('click','.caseTab',function(){_this.caseId=$(this).children('a')[0].id;});I18n.fillArea($('#dialogContent'));_this.bindEvent();_this.init();});},close:function close(){},init:function init(){_this.isInit=true;WebAPI.get('/diagnosis/config/get/'+AppConfig.projectId).done(function(rs){if(rs.limit){renderLimit(rs.limit);}
if(rs.order){renderOrder(rs.order);}
if(rs.enable){renderEnable(rs.enable);}}).always(function(){Spinner.stop();});_this.getGroupsMembers();function renderLimit(result){_this.limitList=result;if(!_this.limitList||_this.limitList.length<1)return;for(var i=0;i<_this.limitList.length;i++){var item=_this.limitList[i];var buildings=_this.createBuildingsFromDB(item.equipList);var curtCase={id:item.id,name:item.name,notice:item.notice,alert:item.alert,fault:item.fault,buildings:buildings};_this.createCaseDom(curtCase,'limit');}}
function renderOrder(result){_this.orderList=result;if(!_this.orderList||_this.orderList.length<1)return;for(var i=0;i<_this.orderList.length;i++){var item=_this.orderList[i];var buildings=_this.createBuildingsFromDB(item.equipList);var curtCase={id:item.id,name:item.name,groupId:item.groupId,operatorId:item.operatorId,faultGrade:item.faultGrade,buildings:buildings};_this.createCaseDom(curtCase,'order');}}
function renderEnable(result){_this.enableList=result;if(!_this.enableList||_this.enableList.length<1)return;for(var i=0;i<_this.enableList.length;i++){var item=_this.enableList[i];var buildings=_this.createBuildingsFromDB(item.equipList);var curtCase={id:item.id,name:item.name,endTime:item.endTime,buildings:buildings};_this.createCaseDom(curtCase,'enable');}}},getGroupsMembers:function getGroupsMembers(){WebAPI.get('/diagnosis/getGroupsMembers/'+AppConfig.userId).done(function(data){if(!data)return;var $group=$('#group');var $operatorId=$('#operatorId');_this.group=new Object();for(var i=0;i<data.groups.length;i++){var group=data.groups[i];var $option=$('<option value="'+group.id+'">'+group.name+'</option>');$group.append($option);_this.group[group.id]={id:group.id,name:group.name,member:[]};for(var j=0;j<data.groupMembers[i].length;j++){var member=data.groupMembers[i][j];_this.group[group.id].member.push({id:member.userid,name:member.userfullname});}}
_this.groupHTML=$group[0].innerHTML;_this.operatorHTML=$operatorId[0].innerHTML;$group.change(function(){var selectId=this.value;_this.showSelectOption($operatorId,selectId);});var selectId=$group.children('option:first-child').attr('selected',true).val();_this.showSelectOption($operatorId,selectId);}).fail(function(result){alert(result.error);});},bindEvent:function bindEvent(){$('#btnDiagnosisShow').click(_this.showDiagnosisShow);$('#btnAutoPushWO').click(_this.showAutoPushWO);$('#btnDiagnosisPause').click(_this.showDiagnosisPauseConfig);$('#btnAlarmRule').click(function(e){new DiagnosisFaultConfig(_this.parent).show();});$('#limitCheckbox').change(function(){var enable=$(this).is(':checked')?1:0;WebAPI.get('/diagnosis/limit/enable/'+AppConfig.projectId+'/'+enable).done(function(){}).fail(function(){});});$('#orderCheckbox').change(function(){var enable=$(this).is(':checked')?1:0;WebAPI.get('/diagnosis/order/enable/'+AppConfig.projectId+'/'+enable).done(function(){}).fail(function(){});});$('#enableCheckbox').change(function(){var enable=$(this).is(':checked')?1:0;WebAPI.get('/diagnosis/enable/enable/'+AppConfig.projectId+'/'+enable).done(function(){}).fail(function(){});});},showSelectOption:function showSelectOption($operator,selectId){$operator[0].options.length=0;for(var i in _this.group[selectId].member){var member=_this.group[selectId].member[i];$operator[0].options.add(new Option(member.name,member.id));}},createBuildingsFromDB:function createBuildingsFromDB(equipList){var arr=equipList.toString().split(',');var buildingDict={};var subBuildingDict={};var equipmentDict={};if(arr.length<1)return;var dict=_this.parent;for(var i=0;i<arr.length;i++){var zone=dict.dictZone[dict.dictEquipment[arr[i]].zoneId];var building={buildingId:zone.buildingId,buildingName:zone.buildingName};var subBuilding={subBuildingId:zone.subBuildingId,subBuildingName:zone.subBuildingName};var equipment={equipmentId:arr[i],equipmentName:dict.dictEquipment[arr[i]].name};if(!buildingDict[zone.buildingId]){buildingDict[zone.buildingId]=building;}
if(!subBuildingDict[zone.subBuildingId]){subBuildingDict[zone.subBuildingId]=subBuilding;}
if(!equipmentDict[equipment.equipmentId]){equipmentDict[arr[i]]=equipment;}}
return{buildingDict:buildingDict,subBuildingDict:subBuildingDict,equipmentDict:equipmentDict};},showSetPane:function showSetPane(){var $tabPane=$('#createCase');var $diagnosisConfig=$('#diagnosisConfig');var $commonPane=$('.commonPane');if(_this.isInit){var $caseList=$tabPane.find('#caseList');_this.initBuildingConfig($tabPane,_this.parent.buildings);_this.isInit=false;$caseList.on('click','.close',function(){_this.removeFromCaseList();});$tabPane.off('click').on('click','.btnItem',function(){_this.chooseValue($tabPane,this);});$tabPane.children('.title').click(function(){$(this).next('.row').slideToggle();$(this).children('.glyphicon').toggleClass('glyphicon-plus-sign glyphicon-minus-sign');});$commonPane.on('click','#confirmCreateCase',function(){_this.createCase($tabPane);});$commonPane.on('click','.cancelCreateCase',function(){$diagnosisConfig.show();$commonPane.hide();});$commonPane.on('click','#btnCreateCase',function(){var $createCase=$('#createCase');$createCase.find('.chosen').addClass('notChosen').removeClass('chosen');$createCase.find('#caseName').val('');$('#createCase input').val('');});}else{$tabPane.find('.chosen').addClass('notChosen').removeClass('chosen');}
$diagnosisConfig.hide();$commonPane.show();},removeFromCaseList:function removeFromCaseList(){var $a=$(this).prev('a');var targetName=$a.attr('href').replace('#','');var id=$a.attr('id');var $dialog=$('#dialogModal');Spinner.spin($dialog.find('.commonPane')[0]);var curtPaneId=$('.commonPane').attr('id');if(curtPaneId=='diagShow'){WebAPI.get('/diagnosis/limit/delete/'+AppConfig.projectId+'/'+id).done(function(){removeDom('limit');}).fail(function(){}).always(function(){Spinner.stop();});}else if(curtPaneId=='WOPush'){WebAPI.get('/diagnosis/order/delete/'+AppConfig.projectId+'/'+id).done(function(){removeDom('order');}).fail(function(){}).always(function(){Spinner.stop();});}else if(curtPaneId=='diagPause'){WebAPI.get('/diagnosis/enable/delete/'+AppConfig.projectId+'/'+id).done(function(){removeDom('enable');}).fail(function(){}).always(function(){Spinner.stop();});}
function removeDom(str){$a.parent('li').remove();$('.tab-content').find('#'+targetName).remove();$('#'+str+'Nav').find('#btnCreateCase').click();}},initBuildingConfig:function initBuildingConfig($tab,data){var $buildList=$tab.find('#buildList'),$areaList=$tab.find('#areaList'),$equipmentList=$tab.find('#equipmentList');for(var i=0;i<data.length;i++){var build=data[i];var $liBuild=$('<li class="grow notChosen"><span class="btnItem enabled" id="'+build.buildId+'">'+build.buildName+'</span></li>');$buildList.append($liBuild);for(var j=0;j<build.subBuilds.length;j++){var area=build.subBuilds[j];var $liArea=$('<li class="grow notChosen" parentId="'+build.buildId+'" title="'+build.buildName+'"><span class="btnItem disabled" id="'+area.subBuildId+'" style="background:'+echarts.config.color[j]+'">'+area.subBuildName+'</span></li>');$areaList.append($liArea);for(var k=0;k<area.equipments.length;k++){var equipment=area.equipments[k];var $liEquipment=$('<li class="grow notChosen" parentId="'+area.subBuildId+'" title="'+area.subBuildName+'"><span class="btnItem disabled" id="'+equipment.equipmentId+'" style="background:'+echarts.config.color[j]+'">'+equipment.equipmentName+'</span></li>');$equipmentList.append($liEquipment);}}}},chooseValue:function chooseValue($tabPane,target){var $li=$(target).parent('li');var $ul=$li.parent('ul');var urId=$ul.attr('id');var $buildList=$tabPane.find('#buildList');var $areaList=$tabPane.find('#areaList');if($li.hasClass('notChosen')){if(urId=='buildList'){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();dealWithChildLevelAbleStatus('build','area');}
if(urId=='areaList'){var parentIds=getChosenParentIds($buildList);if($li.hasClass('all')){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();dealWithChildLevelAbleStatus('area','equipment');}else if($.inArray($li.attr('parentId'),parentIds)>-1){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();dealWithChildLevelAbleStatus('area','equipment');}}
if(urId=='equipmentList'){var parentIds=getChosenParentIds($areaList);if($li.hasClass('all')){if($areaList.children('.all').hasClass('chosen')){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();}}else if($.inArray($li.attr('parentId'),parentIds)>-1){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();}}}else{if(urId=='buildList'){$li.removeClass('chosen').addClass('notChosen');dealWithSameLevel();dealWithChildLevelToNotChosen('build','area');dealWithChildLevelAbleStatus('build','area');}
if(urId=='areaList'){$li.removeClass('chosen').addClass('notChosen');dealWithSameLevel();dealWithChildLevelToNotChosen('area','equipment');dealWithChildLevelAbleStatus('area','equipment');}
if(urId=='equipmentList'){$li.removeClass('chosen').addClass('notChosen');dealWithSameLevel();}}
function dealWithSameLevel(){var classList=$li[0].classList;if($li.hasClass('all')){if(classList.contains('chosen')){$li.siblings('li').removeClass('notChosen').addClass('chosen');}else{$li.siblings('li').removeClass('chosen').addClass('notChosen');}}else{if($ul.find('.chosen').not('.all').length<$ul.find('li').length-1){$li.siblings('.all').removeClass('chosen').addClass('notChosen');}else{$li.siblings('li').removeClass('notChosen').addClass('chosen');}}}
function dealWithChildLevelToNotChosen(parent,children){var parentIds=[];$tabPane.find('#'+parent+'List .chosen').not('.all').children('.btnItem').each(function(){parentIds.push(this.id);});$tabPane.find('#'+children+'List .chosen').each(function(){var eqpId=$(this).attr('parentId');if(eqpId){if($.inArray(eqpId,parentIds)<0){$(this).children('.btnItem').click();$(this).siblings('.all').removeClass('chosen').addClass('notChosen');}}});}
function dealWithChildLevelAbleStatus(parent,children){var parentIds=[];var $children=$tabPane.find('#'+children+'List').children().not('.all');$tabPane.find('#'+parent+'List .chosen').not('.all').children('.btnItem').each(function(){parentIds.push(this.id);});$children.each(function(){var eqpId=$(this).attr('parentId');if(eqpId){if($.inArray(eqpId,parentIds)<0){$(this).children('.btnItem').addClass('disabled').removeClass('enabled');}else{$(this).children('.btnItem').addClass('enabled').removeClass('disabled');}
$(this).click();}});var childrenCount=$children.length;var enabledCount=$children.children('.enabled').length;var $all=$tabPane.find('#'+children+'List').children('.all');if(childrenCount==enabledCount){$all.children('.btnItem').addClass('enabled').removeClass('disabled');}else{$all.children('.btnItem').addClass('disabled').removeClass('enabled');}}
function getChosenParentIds($obj){var idList=[];$obj.children('.chosen').not('.all').children('.btnItem').each(function(){idList.push($(this).attr('id'));});return idList;}},createCase:function createCase($tabPane){var caseName=$tabPane.find('#caseName').val();_this.operateCaseList($tabPane);$tabPane.find('#confirmCreateSave').click(function(){var $tabPane=$(this).closest('.tab-pane');var curtPaneId=$('.commonPane').attr('id');if(curtPaneId=='btnDiagnosisShow'){}else if(curtPaneId=='btnAutoPushWO'){var id=$('.caseTab.active a').attr('id');var caseName=$tabPane.find('#caseName');var buildings=_this.createBuildingData($tabPane);var $projectId=$tabPane.find('#projectId');var $userId=$tabPane.find('#userId');var curtCase={id:id,name:caseName,buildings:buildings,projectId:$projectId.val(),projectName:$projectId.find("option:selected").text(),userId:$userId.val(),userName:$userId.find("option:selected").text(),alarmLevel:$('#alarm').val()};for(var i=0;i<_this.orderList.length;i++){if(curtCase.id==id){_this.orderList[i]=curtCase;}}}else if(curtPaneId=='btnDiagnosisPause'){}});},operateCaseList:function operateCaseList($tabPane){var equipList=_this.getChosenEquipList($tabPane);if(equipList.length<1){alert(I18n.resource.diagnosis.config.subConfig.MUST_CHOOSE_EQUIP);return;}
if(!_this.checkRequire())return;var curtPaneId=$('.commonPane').attr('id');var caseName=$tabPane.find('#caseName').val();var curtCase=new Object();var $dialog=$('#dialogModal');if(curtPaneId=='diagShow'){curtCase={name:caseName,equipList:equipList,fault:$tabPane.find('#warning').val(),alert:$tabPane.find('#alert').val(),notice:$tabPane.find('#normal').val(),project:AppConfig.projectId,enabled:1};Spinner.spin($dialog.find('.commonPane')[0]);WebAPI.post('/diagnosis/limit/add/'+AppConfig.projectId,curtCase).done(function(result){curtCase.buildings=_this.createBuildingsFromDB(equipList);curtCase.id=result;_this.createCaseDom(curtCase,'limit');}).error(function(result){alert(result.error);}).always(function(){Spinner.stop();});}else if(curtPaneId=='WOPush'){curtCase={name:caseName,operatorId:$tabPane.find('#operatorId').val(),group:$tabPane.find('#group').val(),equipList:equipList,faultGrade:$tabPane.find('#alarm').val(),project:AppConfig.projectId,enable:1};Spinner.spin($dialog.find('.commonPane')[0]);WebAPI.post('/diagnosis/order/add/'+AppConfig.projectId,curtCase).done(function(result){curtCase.buildings=_this.createBuildingsFromDB(equipList);curtCase.id=result;_this.createCaseDom(curtCase,'order');}).error(function(result){alert(result.error);}).always(function(){Spinner.stop();});}else if(curtPaneId=='diagPause'){curtCase={name:caseName,endTime:$tabPane.find('.form-datetime').val(),equipList:equipList,project:AppConfig.projectId,enable:1};_this.enableList.push(curtCase);Spinner.spin($dialog.find('.commonPane')[0]);WebAPI.post('/diagnosis/enable/add/'+AppConfig.projectId,curtCase).done(function(result){curtCase.buildings=_this.createBuildingsFromDB(equipList);curtCase.id=result;_this.createCaseDom(curtCase,'enable');}).fail(function(result){alert(result.error);}).always(function(){Spinner.stop();});}
return curtCase;},checkRequire:function checkRequire(){var flag=true;$('.tab-pane.fade.active.in :input').not(':hidden').each(function(){if(this.type!='button'){var val=$(this).val();if(val==undefined||$.trim(val)==''){alert(I18n.resource.diagnosis.config.subConfig.MUST_FILL_IN);flag=false;return flag;}}});return flag;},createBuildingData:function createBuildingData($tabPane){var buildings=[];var index=0;var $buildList=$tabPane.find('#buildList');var $areaList=$tabPane.find('#areaList');var $equipmentList=$tabPane.find('#equipmentList');$buildList.children('.chosen').not('.all').each(function(){var $btnItem=$(this).children('.btnItem');var building={buildId:$btnItem[0].id,buildName:$btnItem[0].innerHTML,subBuilds:[]};$areaList.children('.chosen').not('.all').each(function(){var parentId=$(this).attr('parentId');if($btnItem[0].id==parentId){var $btnItemSub=$(this).children('.btnItem');var subBuilding={subBuildId:$btnItemSub[0].id,subBuildName:$btnItemSub[0].innerHTML,equipments:[]};building.subBuilds.push(subBuilding);$equipmentList.children('.chosen').not('.all').each(function(){var parentId=$(this).attr('parentId');if($btnItemSub[0].id==parentId){var $btnItemEqpmt=$(this).children('.btnItem');var equipment={equipmentId:$btnItemEqpmt[0].id,equipmentName:$btnItemEqpmt[0].innerHTML};building.subBuilds[index].equipments.push(equipment);}});index++;}});buildings.push(building);});return buildings;},getChosenEquipList:function getChosenEquipList($tabPane){var equipList='';$tabPane.find('#equipmentList').children('.chosen').not('.all').children('.btnItem').each(function(){equipList+=this.id+',';});return equipList.substring(0,equipList.length-1);},createCaseDom:function createCaseDom(data,type){$('.tab-content').append(_this.template);var $tabPane=$('.tab-pane:last-child');$tabPane.attr('id',data.name+data.id);$tabPane.find('#confirmEditCase').click(function(){_this.updateCase($tabPane);});I18n.fillArea($tabPane);_this.initBuildingConfig($tabPane,_this.parent.buildings);_this.signChosenItem($tabPane,data.buildings);_this.createTabNavItem(data,type);$tabPane.off('click').on('click','.btnItem',function(){_this.chooseValue($tabPane,this);});$tabPane.children('.title').click(function(){$(this).next('.row').slideToggle();$(this).children('.glyphicon').toggleClass('glyphicon-plus-sign glyphicon-minus-sign');});if(type=='limit'){$tabPane.find('#normal').val(data.notice);$tabPane.find('#alert').val(data.alert);$tabPane.find('#warning').val(data.fault);}else if(type=='order'){var $operator=$tabPane.find('#operatorId');$tabPane.find('#group').html(_this.groupHTML).change(function(){var selectId=this.value;_this.showSelectOption($operator,selectId);});$operator.html(_this.operatorHTML);$tabPane.find('#group option').each(function(){if(this.value==data.groupId){$(this).siblings().attr('selected',false);$(this).attr('selected',true);_this.showSelectOption($operator,this.value);}});$operator.children('option').each(function(){if(this.value==data.operatorId){$(this).siblings().attr('selected',false);$(this).attr('selected',true);}});$tabPane.find('#alarm option').each(function(){if(this.value==data.faultGrade){$(this).siblings().attr('selected',false);$(this).attr('selected',true);}});}else if(type=='enable'){$tabPane.find('.form-datetime').val(data.endTime);}},updateCase:function updateCase($tab){var curtPaneId=$('.commonPane').attr('id');var curtCase=new Object();var caseName=$tab.find('#caseName').val();var equipList=_this.getChosenEquipList($tab);var $dialog=$('#dialogModal');Spinner.spin($dialog.find('.commonPane')[0]);$tab.find('#caseName').val(caseName);$('.caseTab.active a').text(caseName);if(curtPaneId=='WOPush'){curtCase={name:caseName,operatorId:$tab.find('#operatorId').val(),group:$tab.find('#group').val(),equipList:equipList,faultGrade:$tab.find('#alarm').val(),project:AppConfig.projectId,enable:1};WebAPI.post('/diagnosis/order/update/'+AppConfig.projectId+'/'+_this.caseId,curtCase).done(function(result){}).fail(function(){alert(I18n.diagnosis.config.subConfig.UPDATE_FAIL);}).always(function(){Spinner.stop();});}else if(curtPaneId=='diagPause'){curtCase={name:caseName,endTime:$tab.find('.form-datetime').val(),equipList:equipList,project:AppConfig.projectId,enable:1};WebAPI.post('/diagnosis/enable/update/'+AppConfig.projectId+'/'+_this.caseId,curtCase).done(function(result){}).fail(function(){alert(I18n.diagnosis.config.subConfig.UPDATE_FAIL);}).always(function(){Spinner.stop();});}else if(curtPaneId=='diagShow'){curtCase={name:caseName,equipList:equipList,fault:$tab.find('#warning').val(),alert:$tab.find('#alert').val(),notice:$tab.find('#normal').val(),project:AppConfig.projectId,enable:1};WebAPI.post('/diagnosis/limit/update/'+AppConfig.projectId+'/'+_this.caseId,curtCase).done(function(result){}).fail(function(){alert(I18n.diagnosis.config.subConfig.UPDATE_FAIL);}).always(function(){Spinner.stop();});}},createTabNavItem:function createTabNavItem(data,type){var $caseNav=$('#'+type+'Nav');var $close=$('<button type="button" class="close"><span>×</span> </button>').click(_this.removeFromCaseList);var $caseTab=$('<li class="caseTab"><a id="'+data.id+'" data-toggle="tab" href="#'+data.name+data.id+'">'+data.name+'</a></li>').append($close);$caseNav.append($caseTab);$caseTab.children('a').click(function(){$('#'+data.name+data.id).find('#caseName').val(data.name);_this.showRelative();});},signChosenItem:function signChosenItem($tab,buildings){var $buildList=$tab.find('#buildList');var $areaList=$tab.find('#areaList');var $equipmentList=$tab.find('#equipmentList');var chosenBuildingIds=[];var chosenAreaIds=[];for(var i in buildings.buildingDict){var building=buildings.buildingDict[i];$buildList.children('.notChosen').not('.all').children('.btnItem').each(function(){if(this.id==building.buildingId){$(this).parent().removeClass('notChosen').addClass('chosen');chosenBuildingIds.push(this.id);}});}
_this.setBtnAllStatus($buildList);for(var j in buildings.subBuildingDict){var subBuilding=buildings.subBuildingDict[j];$areaList.children('.notChosen').not('.all').children('.btnItem').each(function(){var $li=$(this).parent('li');var parentId=$li.attr('parentId');if(this.id==subBuilding.subBuildingId){$(this).parent().removeClass('notChosen').addClass('chosen');chosenAreaIds.push(this.id);}
if($.inArray(parentId,chosenBuildingIds)>-1){$(this).addClass('enable').removeClass('disabled');}});}
_this.setBtnAllStatus($areaList);for(var k in buildings.equipmentDict){var equipment=buildings.equipmentDict[k];$equipmentList.children('.notChosen').not('.all').children('.btnItem').each(function(){var $li=$(this).parent('li');var parentId=$li.attr('parentId');if(this.id==equipment.equipmentId){$(this).parent().removeClass('notChosen').addClass('chosen');}
if($.inArray(parentId,chosenAreaIds)>-1){$(this).addClass('enabled').removeClass('disabled');}});}
_this.setBtnAllStatus($equipmentList);},setBtnAllStatus:function setBtnAllStatus($buildList){var $lis=$buildList.children('li').not('.all');var $all=$buildList.children('.all');var liCount=$lis.length;var enableCount=$lis.children('.btnItem').length;if(liCount==enableCount){$all.children('.btnItem').addClass('enabled').removeClass('disabled');}else{$all.children('.btnItem').addClass('disabled').removeClass('enable');}
var chosenCount=$buildList.children('.chosen').length;if(chosenCount==$lis.length){$all.addClass('chosen').removeClass('notChosen');}else{$all.addClass('notChosen').removeClass('chosen');}},showAutoPushWO:function showAutoPushWO(){$('.caseNav').hide();$('#orderNav').show();var $commonPane=$('.commonPane').attr('id','WOPush');I18n.fillArea($commonPane);_this.showSetPane();_this.showRelative();},showDiagnosisPauseConfig:function showDiagnosisPauseConfig(){$('.caseNav').hide();$('#enableNav').show();var $commonPane=$('.commonPane').attr('id','diagPause');I18n.fillArea($commonPane);_this.showSetPane();$('.form-datetime').datetimepicker('remove');$('.form-datetime').datetime({initialDate:new Date(),startDate:new Date(),pickerPosition:'top-right'});_this.showRelative();},showDiagnosisShow:function showDiagnosisShow(){$('.caseNav').hide();$('#limitNav').show();var $commonPane=$('.commonPane').attr('id','diagShow');I18n.fillArea($commonPane);_this.showSetPane();_this.showRelative();},showRelative:function showRelative(id){$('.row.option').hide().next('.list').hide();var curtPaneId=$('.commonPane').attr('id');if(curtPaneId=='WOPush'){$('.order').show().next('.list').show();}else if(curtPaneId=='diagPause'){$('.enable').show().next('.list').show();}else if(curtPaneId=='diagShow'){$('.limit').show().next('.list').show();}}};return DiagnosisConfig;}();var DiagnosisFaultConfig=function(){function DiagnosisFaultConfig(parent){this.parent=parent;};DiagnosisFaultConfig.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/diagnosis/paneFaultConfiguration.html").done(function(resultHtml){var dialog=$('#dialogModal');dialog.find('#dialogContent').html(resultHtml);$('#dialogContent .modal-content').css('height',document.body.scrollHeight-100);dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.close();ScreenModal=null;Spinner.stop();}).modal({});Spinner.spin(dialog.find('.modal-body')[0]);_this.init();});},close:function close(){},init:function init(){var _this=this;var tbody=document.createElement('tbody');var tr,td,item,sb;for(var id in this.parent.dictFault){item=this.parent.dictFault[id];tr=document.createElement('tr');tr.id='config-fault-'+id;tr.onclick=function(e){};sb=new StringBuilder();switch(item.defaultGrade){case 0:sb.append('<td><span class="badge" style="background-color: #5bc0de;" title="Grade">Normal</span></td>');break;case 1:sb.append('<td><span class="badge" style="background-color: #f0ad4e;" title="Grade">Alert</span></td>');break;case 2:sb.append('<td><span class="badge" style="background-color: #d9534f;" title="Grade">Fault</span></td>');break;default:break;}
sb.append('<td>').append(item.name).append('</td>');sb.append('<td>').append(this.parent.dictEquipment[item.equipmentId].name).append('</td>');sb.append('<td>').append(item.description).append('</td>');sb.append('<td>').append(item.userName).append('</td>');sb.append(this.getFaultStatus(item));tr.innerHTML=sb.toString();tbody.appendChild(tr);}
$('#tableListFaults').find('tbody').remove();$('#tableListFaults').append(tbody);Spinner.stop();},renderEditPane:function renderEditPane(element){var _this=this;var id=element.id.replace('config-fault-','');var fault=this.parent.dictFault[id];var rowIndex=element.sectionRowIndex;if(document.getElementById('paneFaultEdit-'+id))return;element.style.backgroundColor='rgb(180, 221, 221)';$(element).find('input').removeAttr("disabled");var tr=document.getElementById('tableListFaults').getElementsByTagName('tbody')[0].insertRow(rowIndex+1);tr.id='paneFaultEdit-'+id;var td=document.createElement('td');td.colSpan=7;td.style.backgroundColor='rgb(180, 221, 221)';var sb=new StringBuilder();sb.append('<span style="float: left; padding: 7px; margin-left: 5px; margin-right: 5px;">UserGrade:</span>');var optionContent='value="'+fault.userFaultGrade+'"';sb.append('<select class="form-control markGrade" style="width: 120px; float: left;"><option value="0">Normal</option><option value="1">Alert</option><option value="2">Fault</option></select>'.replace(optionContent,optionContent+" selected"));sb.append('<span style="float: left; padding: 7px; margin-left: 10px; margin-right: 5px;">Advaced:</span>');optionContent='value="'+fault.userFaultDelay+'"';sb.append('<select class="form-control markAdvanced" style="width: 160px; float: left;">\
                        <option value="0">Real-time</option>\
                        <option value="3600">Delay 1 hour</option>\
                        <option value="43200">Delay 12 hours</option>\
                        <option value="86400">Delay 24 hours</option>\
                        <option value="604800">Delay 7 days</option>\
                        <option value="2419200">Delay 1 month</option>\
                        <option value="-1">Disable this fault</option>\
                        </select>'.replace(optionContent,optionContent+' selected'));td.innerHTML=sb.toString();var btnAccept=document.createElement('button');btnAccept.className="btn btn-primary";btnAccept.textContent='Accept';btnAccept.style.cssFloat='right';btnAccept.style.marginRight='5px';btnAccept.onclick=function(e){var faultId=e.currentTarget.parentElement.parentElement.id.replace('paneFaultEdit-','');var data={id:faultId,userId:AppConfig.userId,isUserDefined:document.getElementById('config-fault-'+faultId).getElementsByClassName('maskUserDefined')[0].checked,userFaultGrade:e.currentTarget.parentElement.getElementsByClassName('markGrade')[0].value,userFaultDelay:e.currentTarget.parentElement.getElementsByClassName('markAdvanced')[0].value};WebAPI.post('/diagnosis/fault/customUpdate/'+AppConfig.projectId,data).done(function(result){if(result!='true')new Alert(e.currentTarget.parentElement,'warning','Refused modify');var fault=_this.parent.dictFault[faultId];fault.userFaultGrade=data.userFaultGrade;fault.userFaultDelay=data.userFaultDelay;fault.isUserDefined=data.isUserDefined;fault.userId=data.userId;fault.userName=AppConfig.account;_this.init();});};var btnCancel=document.createElement('button');btnCancel.className="btn btn-default";btnCancel.textContent='Cancel';btnCancel.style.cssFloat='right';btnCancel.style.marginRight='5px';btnCancel.onclick=function(e){_this.init();};td.appendChild(btnCancel);td.appendChild(btnAccept);tr.appendChild(td);},getFaultStatus:function getFaultStatus(fault){if(fault.isUserDefined){if(fault.userFaultDelay==-1)return'Disable';if(fault.userFaultDelay==0)return'Real-time';var remain=fault.userFaultDelay*1000-(new Date()-new Date(fault.userModifyTime*1000));if(remain>0){var remain=new Date(remain);var sb=new StringBuilder();sb.append('<td title="Remaining ').append(remain.getDay()?remain.getDay()+'Day ':'').append(remain.getHours()?remain.getHours()+'Hour ':'').append(remain.getMinutes()?remain.getMinutes()+'Min ':'').append('">').append(remain.getDay()?remain.getDay()+'D_':'').append(remain.getHours()?remain.getHours()+':':'').append(remain.getMinutes()?remain.getMinutes():'').append('</td>');return sb.toString();}else{return'Real-time';}}else{return'Real-time';}}};return DiagnosisFaultConfig;}();var DiagnosisLogHistory=function(){var _this=undefined;function DiagnosisLogHistory(parent){_this=this;this.parent=parent;this.m_tableInfo=[];this.m_bSortTimeAscend=false;this.m_bSortGradeAscend=false;this.m_bSortEquipAscend=false;this.m_bSortZoneAscend=false;this.m_bSortFaultAscend=false;this.m_bSortStatusAscend=false;this.isModal=false;};DiagnosisLogHistory.prototype={show:function show(){var _this=this;window.ElScreenContainer&&Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/diagnosis/paneHistory.html").done(function(resultHtml){var dialog=$('#dialogModal');if(dialog.length<1){$('body').append('<div class="modal fade" id="dialogModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog modal-lg" id="dialogContent"></div></div>');dialog=$('#dialogModal');};dialog.find('#dialogContent').html(resultHtml);$('#dialogContent .modal-content').css({'height':document.body.scrollHeight-100,'width':'1000px'});dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.close();ScreenModal=null;Spinner.stop();}).modal({});Spinner.spin(dialog.find('.modal-body')[0]);_this.init();$("#datePickerLog").datetimepicker({minView:"month",autoclose:true,todayBtn:true,initialDate:new Date()});$('#btnDownload').attr('title',i18n_resource.diagnosis.historyLog.DOWNLOAD_EXCEL);$('#btnDownloadPDF').attr('title',i18n_resource.diagnosis.historyLog.DOWNLOAD_PDF);var date=new Date();$("#txtLogDate").val(date.timeFormat(timeFormatChange('yyyy-mm-dd')));$('#thTime').click(function(e){_this.sortTable(0);});$('#thGrade').click(function(e){_this.sortTable(1);});$('#thEquip').click(function(e){_this.sortTable(2);});$('#thZone').click(function(e){_this.sortTable(3);});$('#thFault').click(function(e){_this.sortTable(4);});$('#thStatus').click(function(e){_this.sortTable(5);});$('#btnSearchFault').click(function(e){_this.searchFaultInfo();});$('#inputSearchFault').keyup(function(e){if(13===e.keyCode){_this.searchFaultInfo();}});});},close:function close(){},init:function init(){var _this=this;var now=new Date();var startTime=new Date(now.getFullYear(),now.getMonth(),now.getDate());this.refreshData(startTime,now);var timeFormat=timeFormatChange('yyyy-mm-dd');$("#datePickerLog").attr('data-date-format',timeFormat);$("#txtLogDate").change(function(e){var startTime=($(this).val()+' 00:00:00').toDate();var endTime=new Date(+startTime+86400000);_this.refreshData(startTime,endTime);});$("#btnLogPre").off('click').click(function(e){var endTime=($("#txtLogDate").val()+' 00:00:00').toDate();var preDay=new Date(+endTime-86400000);$("#txtLogDate").val(preDay.timeFormat(timeFormat));_this.refreshData(preDay,endTime);});$("#btnLogNext").off('click').click(function(e){var startTime=($("#txtLogDate").val()+' 00:00:00').toDate();var nextDay=new Date(+startTime+86400000);$("#txtLogDate").val(nextDay.timeFormat(timeFormat));startTime=($("#txtLogDate").val()+' 00:00:00').toDate();nextDay=new Date(+startTime+86400000);_this.refreshData(startTime,nextDay);});$("#btnDownload").off('click').click(function(){var logTime=($("#txtLogDate").val()+' 00:00:00').toDate();var startTime=logTime.format("yyyy-MM-dd HH:mm:ss");var endTime=new Date(+logTime+86400000).format("yyyy-MM-dd HH:mm:ss");window.open('/diagnosis/downloadHistoryFault/'+AppConfig.projectId+'/'+startTime+'/'+endTime);});$("#btnDownloadPDF").off('click').click(function(){var reportTitle=i18n_resource.diagnosis.historyLog.TITLE;Spinner.spin(document.body);var arrHtml=[];$('#tableNoticeHistory').find('.removeNode').remove();arrHtml.push($('#tableWrap').html());var promise=WebAPI.get('/static/views/share/reportWrap/pdfTemplate.html');promise.done(function(html){var xhr,formData;html=html.formatEL({cover:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.pdfCover),title:reportTitle,encoding:'UTF-8',entitiesHtml:arrHtml[0],projName:AppConfig.projectShowName,logo:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.logo),date:$('#txtLogDate').val(),footerLeft:i18n_resource.report.reportWrap.GENERATED_BY_BEOP,footerRight:localStorage.getItem("language")==="zh"?"第 [page] 页 共[topage]页":"Page [page] of [topage]"});formData=new FormData();formData.append('html',html);formData.append('skin','default');xhr=new XMLHttpRequest();xhr.open('POST','/admin/getShareReportWrapPDF');xhr.responseType='arraybuffer';xhr.onload=function(){var blob,url,lkPdfFile;if(this.status===200){blob=new Blob([xhr.response],{type:"application/pdf"});url=URL.createObjectURL(blob);lkPdfFile=document.createElement('a');lkPdfFile.style="display: none";lkPdfFile.id="lkPdfFile";lkPdfFile.href=url;lkPdfFile.download=reportTitle+' '+$('#txtLogDate').val()+'.pdf';document.body.appendChild(lkPdfFile);lkPdfFile.click();window.URL.revokeObjectURL(url);window.setTimeout(function(){lkPdfFile.parentNode.removeChild(lkPdfFile);},0);}else{alert('Generate report failed, please try it again soon!');}
Spinner.stop();};xhr.send(formData);}).fail(function(e){throw e;});});},createWorkflowOrder:function createWorkflowOrder(notice){var wiInstance;var momentTime=notice.time.toDate();var back=function back(){wiInstance=null;var $dialogModal=$('#dialogModal');Spinner.spin(ElScreenContainer);$dialogModal.modal("show");$dialogModal.off('shown.bs.modal.showDialogModal').on('shown.bs.modal.showDialogModal',function(){Spinner.stop();});};var insertCallback=function insertCallback(taskModelInfo){Alert.success(ElScreenContainer,I18n.resource.workflow.main.THE_WORK_ORDER+' '+(taskModelInfo?taskModelInfo.title:'')+' '+I18n.resource.workflow.main.IS_CREATED_SUCCESSFULLY).showAtTop(2000);var $faultCount=$('#btnWarningLog .badge');var faultCount=function(txt){if(parseInt(txt).toString()!="NaN"){return parseInt(txt);}
return 0;}($faultCount.text());if(faultCount>0){var count=faultCount-1;count=count>0?count:'';$faultCount.text(count);$('[noticeid="'+notice.id+'"]').remove();if(notice.grade===1){var $warningCount=$('#navFloor-'+AppConfig.zoneId).next('.warningCount');$warningCount.text($warningCount.text()-1);}else if(notice.grade===2){var $alertCount=$('#navFloor-'+AppConfig.zoneId).siblings('.alertCount');$alertCount.text($alertCount.text()-1);}}};wiInstance=new WorkflowInsert({noticeId:notice.id,title:notice.name,detail:notice.description,dueDate:new Date(+new Date()+172800000).format('yyyy-MM-dd'),critical:notice.grade,projectId:Number(notice.project),chartPointList:notice.points,chartQueryCircle:'m5',description:notice.description,name:notice.name,time:new Date(momentTime).format('yyyy-MM-dd HH:mm:ss'),chartStartTime:new Date(new Date(momentTime).getTime()-12*60*60*1000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(new Date(momentTime).getTime()+12*60*60*1000).format('yyyy-MM-dd HH:mm:ss')});wiInstance.show().submitSuccess(function(taskModelInfo,uploadFiles){insertCallback(taskModelInfo);this.close();back();}).cancel(function(){back();}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.workflow.main.CREATE_WORKFLOW_FAILED).showAtTop(2000);});return true;},refreshData:function refreshData(startTime,endTime){var _this=this;var item;startTime=startTime.format("yyyy-MM-dd HH:mm:ss");endTime=endTime.format("yyyy-MM-dd HH:mm:ss");Spinner.spin(document.getElementById('tableNoticeHistory'));WebAPI.get('/diagnosis/getHistoryFault/'+AppConfig.projectId+'/'+startTime+'/'+endTime).done(function(result){_this.m_tableInfo=result;_this.initTable(result);}).error(function(result){var dialog=$('#dialogModal');dialog.find('.modal-body').html('Error query.');}).always(function(){Spinner.stop();});},initTable:function initTable(data){var _this2=this;$('#tableNoticeHistory tbody').remove();var tbody=document.createElement('tbody');var $spanPoint;$('#tableNoticeHistory').append(tbody);if(data.length==0)tbody.innerHTML='no history data';var tr,td,item,sb,equipment,zone,timeDif,strDesc;var _loop=function _loop(){item=data[i];strDesc=item.description;equipment=_this2.parent.dictEquipment[item.equipmentId];zone=_this2.parent.dictZone[equipment.zoneId];tr=document.createElement('tr');tr.id='diagHistory_'+item.id;tr.title=strDesc;tbody.appendChild(tr);$(tr).append($('<td></td>').html(item.time.toDate().timeFormat(timeFormatChange("yyyy-mm-dd hh:ii:ss"))));switch(item.grade){case 0:$(tr).append('<td><span class="badge" style="background-color: #5bc0de;" title="Grade">Normal</span></td>');break;case 1:$(tr).append('<td><span class="badge" style="background-color: #f0ad4e;" title="Grade">Alert</span></td>');break;case 2:$(tr).append('<td><span class="badge" style="background-color: #d9534f;" title="Grade">Fault</span></td>');break;default:$(tr).append('<td><span class="badge" style="background-color: #d9534f;" title="Grade">Unknown</span></td>');break;}
$(tr).append($('<td></td>').html(equipment.name));$(tr).append($('<td></td>').html(zone.subBuildingName));$(tr).append($('<td></td>').html(item.name));switch(item.status){case'0':$(tr).append('<td>Disable</td>');break;case'1':$(tr).append('<td>Delayed</td>');break;case'2':$(tr).append('<td>Realtime</td>');break;default:break;}
if(!item.resTime||item.resTime==null){$(tr).append($('<td class="removeNode" colspan="2" style="text-align:center;" i18n="diagnosis.historyLog.RESPONSE_CONTENT"></td>'));if(!_this2.isModal){$spanPoint=pointerClick(item);$(tr).append($('<td class="removeNode"></td>').append($spanPoint));}}else{timeDif=Math.floor((new Date(item.resTime).getTime()-new Date(item.time).getTime())/(3600*1000));$(tr).append($('<td class="removeNode"></td>').html(item.executor));$(tr).append($('<td class="removeNode"></td>').html(timeDif));$(tr).append($('<td class="removeNode"></td>').html(''));}
arr=item.detail.toString().split(',');for(j=0;j<arr.length;j++){strDesc=strDesc.replace('{'+j.toString()+'}','<span class="variable">'+arr[j]+'</span>');}
function pointerClick(item){var $pointeer;$pointeer=$('<span class="glyphicon glyphicon-share grow span-hover-pointer"></span>').off('click').on('click',function(){_this.createWorkflowOrder(item);$('#dialogModal').modal('hide');});return $pointeer;}};for(var i=0,len=data.length;i<len;i++){var arr;var j;_loop();}},sortTable:function sortTable(type){$('#tableNoticeHistory tbody').html('');if(0===type){if(!_this.m_bSortTimeAscend){_this.m_tableInfo.sort(_this.sortTimeAscending);}else{_this.m_tableInfo.sort(_this.sortTimeDescending);}
_this.m_bSortTimeAscend=!_this.m_bSortTimeAscend;}else if(1===type){if(!_this.m_bSortGradeAscend){_this.m_tableInfo.sort(_this.sortGradeAscending);}else{_this.m_tableInfo.sort(_this.sortGradeDescending);}
_this.m_bSortGradeAscend=!_this.m_bSortGradeAscend;}else if(2===type){if(!_this.m_bSortEquipAscend){_this.m_tableInfo.sort(_this.sortEquipAscending);}else{_this.m_tableInfo.sort(_this.sortEquipDescending);}
_this.m_bSortEquipAscend=!_this.m_bSortEquipAscend;}else if(3===type){if(!_this.m_bSortZoneAscend){_this.m_tableInfo.sort(_this.sortZoneAscending);}else{_this.m_tableInfo.sort(_this.sortZoneDescending);}
_this.m_bSortZoneAscend=!_this.m_bSortZoneAscend;}else if(4===type){if(!_this.m_bSortFaultAscend){_this.m_tableInfo.sort(_this.sortFaultAscending);}else{_this.m_tableInfo.sort(_this.sortFaultDescending);}
_this.m_bSortFaultAscend=!_this.m_bSortFaultAscend;}else if(5===type){if(!_this.m_bSortStatusAscend){_this.m_tableInfo.sort(_this.sortStatusAscending);}else{_this.m_tableInfo.sort(_this.sortStatusDescending);}
_this.m_bSortStatusAscend=!_this.m_bSortStatusAscend;}
_this.initTable(_this.m_tableInfo);},sortTimeAscending:function sortTimeAscending(a,b){return new Date(a.time)-new Date(b.time);},sortTimeDescending:function sortTimeDescending(a,b){return new Date(b.time)-new Date(a.time);},sortGradeAscending:function sortGradeAscending(a,b){return a.grade-b.grade;},sortGradeDescending:function sortGradeDescending(a,b){return b.grade-a.grade;},sortEquipAscending:function sortEquipAscending(a,b){var equipA=_this.parent.dictEquipment[a.equipmentId];var equipB=_this.parent.dictEquipment[b.equipmentId];return equipA.name.localeCompare(equipB.name);},sortEquipDescending:function sortEquipDescending(a,b){var equipA=_this.parent.dictEquipment[a.equipmentId];var equipB=_this.parent.dictEquipment[b.equipmentId];return equipB.name.localeCompare(equipA.name);},sortZoneAscending:function sortZoneAscending(a,b){var equip=_this.parent.dictEquipment[a.equipmentId];var zoneA=_this.parent.dictZone[equip.zoneId];equip=_this.parent.dictEquipment[b.equipmentId];var zoneB=_this.parent.dictZone[equip.zoneId];return zoneA.subBuildingName.localeCompare(zoneB.subBuildingName);},sortZoneDescending:function sortZoneDescending(a,b){var equip=_this.parent.dictEquipment[a.equipmentId];var zoneA=_this.parent.dictZone[equip.zoneId];equip=_this.parent.dictEquipment[b.equipmentId];var zoneB=_this.parent.dictZone[equip.zoneId];return zoneB.subBuildingName.localeCompare(zoneA.subBuildingName);},sortFaultAscending:function sortFaultAscending(a,b){return a.name.localeCompare(b.name);},sortFaultDescending:function sortFaultDescending(a,b){return a.name.localeCompare(b.name);},sortStatusAscending:function sortStatusAscending(a,b){return a.status-b.status;},sortStatusDescending:function sortStatusDescending(a,b){return b.status-a.status;},searchFaultInfo:function searchFaultInfo(){var searchVal=$('#inputSearchFault').val();if(null==searchVal||undefined==searchVal){return;}
$('#tableNoticeHistory tbody').html('');if(''==searchVal){_this.initTable(_this.m_tableInfo);return;}
var item;var arrSuit=[];searchVal=searchVal.toLowerCase();for(var i=0,len=_this.m_tableInfo.length;i<len;i++){item=_this.m_tableInfo[i];if(-1!=item.name.toLowerCase().indexOf(searchVal)){arrSuit.push(item);}}
_this.initTable(arrSuit);},setIsModal:function setIsModal(boolean){this.isModal=boolean;},renderChart:function renderChart(record){Spinner.spin($("#wf-add-person")[0]);var list_description=record.list_description,list_value=record.list_value,arrXAxis;if(list_description.length==list_value.length){if(record.list_time.length>0)arrXAxis=record.list_time[0].split(',');var arrSeriesTemp=[];for(var i=0;i<list_value.length;i++){var arrDatas=[];if(i<8){var item=list_value[i];if(item){var strDatas=item.split(",");for(var j=0;j<strDatas.length;++j){arrDatas.push(parseFloat(strDatas[j]).toFixed(1));}}
arrSeriesTemp.push({name:list_description[i],type:'line',itemStyle:{normal:{lineStyle:{type:'solid'}}},data:arrDatas});}}
var option={tooltip:{trigger:'axis',formatter:function formatter(params){var strResult;if(params[0].name.length>0){strResult=params[0].name+'<br/>';for(var i=0;i<params.length;++i){strResult+=params[i].seriesName+' : '+params[i].value;if(i!=params.length-1){strResult+='<br/>';}}}
return strResult;}},legend:{data:list_description,x:'center'},toolbox:{show:true},dataZoom:{show:true,realtime:true,start:0,end:100},xAxis:[{name:"",type:'category',boundaryGap:false,axisLine:{onZero:false},data:arrXAxis}],yAxis:[{name:"",type:'value',scale:true}],series:arrSeriesTemp,showLoading:{text:'loading',effect:'spin'}};var myChart=echarts.init($('#wf-fault-curve').get(0));myChart.setOption(option);window.onresize=myChart.resize;Spinner.stop();}}};return DiagnosisLogHistory;}();var TemperatureSetting=function(){var jqueryMap={},stateMap={slider:null};function TemperatureSetting(heatType,isAnotherColor){this.viewModel=null;this.heatType=heatType;this.isAnotherColor=isAnotherColor;}
TemperatureSetting.prototype={show:function show(){var _this=this,text,heatTypeI18n;this.init().done(function(){heatTypeI18n=I18n.resource.observer.entities[_this.heatType.toUpperCase()];text=I18n.resource.observer.entities.TITLE_HEAT_MAP_CONFIGURE.format(heatTypeI18n);jqueryMap.$dialogModal.find('#myModalLabel').text(text).end().modal();});},close:function close(){jqueryMap.$dialogModal.modal('hide');if(stateMap.slider&&stateMap.slider.destroy){stateMap.slider.destroy();stateMap.slider=null;}},init:function init(){var _this=this;return WebAPI.get("/static/views/observer/widgets/temperatureSetting.html").done(function(resultHtml){jqueryMap.$dialogContent=$("#dialogContent");jqueryMap.$dialogContent.html(resultHtml);jqueryMap.$dialogModal=$('#dialogModal');_this.renderView();_this.attachEvent();jqueryMap.$dialogContent.removeClass('modal-lg');I18n.fillArea(jqueryMap.$dialogContent);});},renderView:function renderView(){var _this=this,defaultMax=30,defaultMin=20;Spinner.spin(jqueryMap.$dialogModal.find('.modal-content')[0]);this.loadModel().done(function(){var min,max;if(_this.viewModel){min=typeof _this.viewModel.min!='undefined'&&_this.viewModel.min.value!=''?_this.viewModel.min.value:defaultMin;max=typeof _this.viewModel.max!='undefined'&&_this.viewModel.max.value!=''?_this.viewModel.max.value:defaultMax;}else{min=defaultMin;max=defaultMax;}
stateMap.slider=$("#slider-range").ionRangeSlider({min:10,max:40,from:min,to:max,type:'double',step:1,hasGrid:true}).data("ionRangeSlider");if(_this.isAnotherColor){$('#rangeWrapper .irs-bar').addClass('anotherColor');}}).always(function(){Spinner.stop();});},loadModel:function loadModel(){var _this=this;return WebAPI.post('/admin/getColorSetting',{userId:AppConfig.userId,heatType:_this.heatType}).done(function(result){if(result.success){_this.viewModel=result.data;}});},attachEvent:function attachEvent(){var _this=this;$('#btnSaveSetting').off().click(function(){var $rangeWrapper=$("#rangeWrapper"),minValue=parseFloat($rangeWrapper.find(".irs-from").text()),maxValue=parseFloat($rangeWrapper.find(".irs-to").text());if(_this.viewModel&&_this.viewModel[_this.heatType]){_this.viewModel[_this.heatType].min.value=minValue;_this.viewModel[_this.heatType].max.value=maxValue;}else{_this.viewModel={};_this.viewModel[_this.heatType]={"min":{"color":"blue","value":minValue},"max":{"color":"red","value":maxValue}};}
Spinner.spin(jqueryMap.$dialogModal.find('.modal-content')[0]);WebAPI.post('/admin/setColorSetting',{'setting':_this.viewModel,userId:AppConfig.userId}).done(function(result){if(result.success){_this.close();Alert.success(ElScreenContainer,I18n.resource.code['2002']).showAtTop(2000);}
$(ElScreenContainer).trigger('refreshHeatMap');}).always(function(){Spinner.stop();});});}};return TemperatureSetting;}();var DataCalcFilterContain=function(){function DataCalcFilterContain(base){this.base=base;this.$parentContain=$('#paneContent');this.$anlsPaneContain=$('#anlsPaneContain');};DataCalcFilterContain.prototype={show:function show(){var _this=this;WebAPI.get('/static/views/observer/widgets/dataCalcFilter.html').done(function(resultHTML){_this.$wrap=$('<div class="modal-db-history-wrap" id="wrapDataFilter" style="height: 100%">').html(resultHTML);_this.$anlsPaneContain.before(_this.$wrap);_this.$pageFilter=_this.$wrap.find('#pageDataFilter');_this.$pageFilterCustom=_this.$wrap.find('#pageDataFilterCustom');_this.$pageFilterEd3=_this.$wrap.find('#pageDataFilterEd3');I18n.fillArea($('#dataFilterContain'));_this.init();new DataCalcFilterEd3(_this,_this.base).show(_this.$pageFilterEd3);});},init:function init(){this.$iconCancel=$('#iconCancel',this.$page);this.$tabFilterNormal=$('#tabFilterNormal',this.$page);this.$tabFilterCustom=$('#tabFilterCustom',this.$page);this.$tabFilterEd3=$('#pageDataFilterEd3',this.$page);this.initCloseControl();this.initTabs();},initCloseControl:function initCloseControl(){var _this=this;this.$iconCancel.off().click(function(e){_this.close();});},close:function close(){this.$wrap.remove();},initTabs:function initTabs(){var _this=this;_this.tabControl(2);this.$tabFilterNormal.off().click(function(e){_this.tabControl(0);});this.$tabFilterCustom.off().click(function(e){_this.tabControl(1);});},tabControl:function tabControl(nFlag){if(0==nFlag){this.$tabFilterNormal.attr('class','active');this.$pageFilter.show();this.$tabFilterCustom.removeAttr('class');this.$pageFilterCustom.hide();this.$tabFilterEd3.removeAttr('class');this.$pageFilterEd3.hide();}else if(1==nFlag){this.$tabFilterNormal.removeAttr('class');this.$pageFilter.hide();this.$tabFilterCustom.attr('class','active');this.$pageFilterCustom.show();this.$tabFilterEd3.removeAttr('class');this.$pageFilterEd3.hide();}else if(2==nFlag){this.$tabFilterNormal.removeAttr('class');this.$pageFilter.hide();this.$tabFilterCustom.removeAttr('class');this.$pageFilterCustom.hide();this.$tabFilterEd3.attr('class','active');this.$pageFilterEd3.show();}},getAlphabetByNum:function getAlphabetByNum(num){var alphabet;num=num%26;switch(num){case 0:alphabet='a';break;case 1:alphabet='b';break;case 2:alphabet='c';break;case 3:alphabet='d';break;case 4:alphabet='e';break;case 5:alphabet='f';break;case 6:alphabet='g';break;case 7:alphabet='h';break;case 8:alphabet='i';break;case 9:alphabet='j';break;case 10:alphabet='k';break;case 11:alphabet='l';break;case 12:alphabet='m';break;case 13:alphabet='n';break;case 14:alphabet='o';break;case 15:alphabet='p';break;case 16:alphabet='q';break;case 17:alphabet='r';break;case 18:alphabet='s';break;case 19:alphabet='t';break;case 20:alphabet='u';break;case 21:alphabet='v';break;case 22:alphabet='w';break;case 23:alphabet='x';break;case 24:alphabet='y';break;case 25:alphabet='z';break;default:alphabet='a';break;}
return alphabet;}};return DataCalcFilterContain;}();var DataCalcFilter=function(){function DataCalcFilter(parent,base){this.m_parent=parent;this.m_base=base;this.m_screen=base.screen;this.m_curModal=base.screen.curModal;if(!this.m_curModal.arrFilter){this.m_curModal.arrFilter=[];}
if(base.chart){this.m_chartOption=base.chart.getOption();}
this.m_dictShowData=this.m_curModal.dictShowData;this.m_arrDsItem=[];this.m_arrDsId=this.m_curModal.itemDS[0].arrId;var arrId=this.m_arrDsId;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=this.m_arrDsId.length;i<len;i++){var id=this.m_arrDsId[i];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var itemTemp=arrItem[m];itemTemp.alphabet=this.m_parent.getAlphabetByNum(i);this.m_arrDsItem.push(itemTemp);break;}}}
this.m_nInterval=0;var format=this.m_curModal.format;switch(format){case'm1':this.m_nInterval=60000;break;case'm5':this.m_nInterval=300000;break;case'h1':this.m_nInterval=3600000;break;case'd1':this.m_nInterval=86400000;break;default:this.m_nInterval=3600000;break;}
this.$wrap;this.$page;this.m_tmStart;this.m_tmEnd;this.m_tmCycle;};DataCalcFilter.prototype={show:function show($page){this.$page=$page;this.init();return;WebAPI.get('/static/views/observer/widgets/dataCalcFilter.html').done(function(resultHTML){_this.$wrap=$('<div class="modal-db-history-wrap" id="wrapDataFilter">').html(resultHTML);_this.$page=_this.$wrap.children('#pageDataFilter');_this.init();});},init:function init(){this.$btnFilter=$('#btnFilter',this.$page);this.$btnCancel=$('#btnCancel',this.$page);this.$selPtList=$('#selectPtList',this.$page);this.$chkPtList=$('#checkPtList',this.$page);this.$filterCodition=$('#filterCondition',this.$page);this.$mathCfgData=$('#varConfigData',this.$page);this.$radioFilTp1=$('#radioFilterType1',this.$page);this.$radioFilTp2=$('#radioFilterType2',this.$page);this.$tmStart=$('#timeStart',this.$page);this.$inputValLen=$('#inputValLen',this.$page);this.$inputCycleLen=$('#inputCycleLen',this.$page);this.$tmEnd=$('#timeEnd',this.$page);this.$tmCycle=$('#timeCycle',this.$page);this.$divInputValLen=$('#divValLen',this.$page);this.$divInputCycleLen=$('#divCycleLen',this.$page);this.$divTmEnd=$('#divTmEnd',this.$page);this.$divTmCycle=$('#divTmCycle',this.$page);this.$radioShowNone=$('#radioShowNone',this.$page);this.$radioShowColor=$('#radioShowColor',this.$page);this.$btnLogicAnd=$('#btnLogicAnd',this.$page);this.$btnLogicOr=$('#btnLogicOr',this.$page);this.$btnLogicNot=$('#btnLogicNot',this.$page);this.initCloseControl();this.initCheckButton();this.initFilterCondition();this.initVarGrid();this.initRadioControl();this.initTimeControl();this.initLogicButton();},close:function close(){this.m_parent.close();},initCloseControl:function initCloseControl(){var _this=this;this.$btnFilter.off().click(function(e){_this.filterOperationCheckButton();});this.$btnCancel.off().click(function(e){_this.close();});},initComboBox:function initComboBox(){var _this=this;this.$selPtList.empty();var item;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){item=$('<option value="'+this.m_arrDsItem[i].id+'">'+this.m_arrDsItem[i].alias+'</option>');this.$selPtList.append(item);}
this.$selPtList.change(function(e){var selPtId=_this.$selPtList.val();for(var i=0,len=_this.m_curModal.arrFilter.length;i<len;i++){var item=_this.m_curModal.arrFilter[i];if(selPtId==item.pointId){_this.$filterCodition.val(item.filterCondition);_this.$tmStart.val(item.timeStart);_this.$inputValLen.val(item.valLen);_this.$inputCycleLen.val(item.cycleLen);_this.$tmEnd.val(item.timeEnd);_this.$tmCycle.val(item.timeCycle);0==item.showType?_this.$radioShowNone.click():_this.$radioShowColor.click();0==item.filterType?_this.$radioFilTp1.click():_this.$radioFilTp2.click();break;}}});},initCheckButton:function initCheckButton(){this.$chkPtList.empty();var item;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(0==i){item='<div class="checkbox"><label><input type="checkbox" value="'+this.m_arrDsItem[i].id+'" checked>'+this.m_arrDsItem[i].alias+'</label></div>';}else{item='<div class="checkbox"><label><input type="checkbox" value="'+this.m_arrDsItem[i].id+'">'+this.m_arrDsItem[i].alias+'</label></div>';}
this.$chkPtList.append(item);}},initFilterCondition:function initFilterCondition(){this.$filterCodition.mathquill('editable');var arrFilter=this.m_curModal.arrFilter;var codition;for(var i=0,len=arrFilter.length;i<len;i++){if(true){codition=arrFilter[i].filterCondition;break;}}
if(codition){this.$filterCodition.mathquill('latex',codition);}},initVarGrid:function initVarGrid(){this.$mathCfgData.empty();var item;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){item=$('<div class="row">\
                                <div class="col-xs-12 varRow">\
                                    <div class="col-xs-4 formulaVarName"><input type="text" name="inputVarValue" class="varNameChange">'+this.m_arrDsItem[i].alphabet+'</div>\
                                    <div class="col-xs-6 divVarValue" varid="'+this.m_arrDsItem[i].id+'">'+this.m_arrDsItem[i].alias+'</div>\
                                </div>\
                            </div>');this.$mathCfgData.append(item);}},initRadioControl:function initRadioControl(){var _this=this;this.$radioFilTp1.next().text(I18n.resource.analysis.dataFilter.COUNT_SELECT);this.$radioFilTp2.next().text(I18n.resource.analysis.dataFilter.TIME_SELECT);this.$radioShowNone.next().text(I18n.resource.analysis.dataFilter.SHOW_NONE);this.$radioShowColor.next().text(I18n.resource.analysis.dataFilter.SHOW_DOT);this.$radioFilTp1.click();this.setFilterTypeControl(true);this.$radioFilTp1.click(function(e){_this.setFilterTypeControl(true);});this.$radioFilTp2.click(function(e){_this.setFilterTypeControl(false);});this.$radioShowNone.click();this.$radioShowNone.click(function(e){});this.$radioShowColor.click(function(e){});},initTimeControl:function initTimeControl(){var _this=this;var tmStart=new Date(this.m_chartOption.xAxis[0].data[0]);var xLen=this.m_chartOption.xAxis[0].data.length;var tmEnd=new Date(this.m_chartOption.xAxis[0].data[xLen-1]);this.m_tmStart=tmStart;this.$tmStart.val(tmStart.format('yyyy-MM-dd HH:00'));this.$tmStart.datetimepicker({format:'yyyy-mm-dd hh:00',startView:'month',minView:'day',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmStart,startDate:tmStart,endDate:tmEnd,keyboardNavigation:false}).off('changeDate').on('changeDate',function(e){var timeVal=_this.$tmStart.val();_this.m_tmStart=new Date(timeVal.replace(/-/,'/'));});this.m_tmEnd=tmEnd;this.$tmEnd.val(tmEnd.format('yyyy-MM-dd HH:00'));this.$tmEnd.datetimepicker({format:'yyyy-mm-dd hh:00',startView:'month',minView:'day',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmStart,startDate:tmStart,endDate:tmEnd,keyboardNavigation:false}).off('changeDate').on('changeDate',function(e){var timeVal=_this.$tmEnd.val();_this.m_tmEnd=new Date(timeVal.replace(/-/,'/'));});this.m_tmCycle=tmStart;this.$tmCycle.val(tmStart.format('yyyy-MM-dd HH:00'));this.$tmCycle.datetimepicker({format:'yyyy-mm-dd hh:00',startView:'month',minView:'day',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmStart,startDate:tmStart,endDate:tmEnd,keyboardNavigation:false}).off('changeDate').on('changeDate',function(e){var timeVal=_this.$tmCycle.val();_this.m_tmCycle=new Date(timeVal.replace(/-/,'/'));});},initLogicButton:function initLogicButton(){var _this=this;this.$btnLogicAnd.click(function(e){_this.$filterCodition.mathquill('write','&');});this.$btnLogicOr.click(function(e){_this.$filterCodition.mathquill('write','\\mid');});this.$btnLogicNot.click(function(e){_this.$filterCodition.mathquill('write','!');});},setFilterTypeControl:function setFilterTypeControl(bIsType1){if(bIsType1){this.$divInputValLen.css('display','block');this.$divInputCycleLen.css('display','block');this.$divTmEnd.css('display','none');this.$divTmCycle.css('display','none');}else{this.$divInputValLen.css('display','none');this.$divInputCycleLen.css('display','none');this.$divTmEnd.css('display','block');this.$divTmCycle.css('display','block');}},getFormula:function getFormula(){var $varRow=$('#varConfig .varRow');var latexMathValue=this.$filterCodition.mathquill('latex');var varNum=$varRow.length;var varId,varName;var searchReg;var varError=new Array();$('.varLack').remove();for(var i=0;i<varNum;i++){varName=$($varRow.find('.formulaVarName').get(i));varId=$varRow.children('.divVarValue').eq(i).attr('varid');searchReg=new RegExp('\\b'+varName.text()+'\\b','g');if(searchReg.test(latexMathValue)){if(varId){latexMathValue=latexMathValue.replace(searchReg,'<%'+varId+'%>');}else{varError.push(varName);}}}
if(varError.length>0){for(var ele=0;ele<varError.length;++ele){varError[ele].append($('<span class="varLack">Unassigned!<span>'));}
alert('Lack Variable in Formula');return'error';}
return latexMathValue;},filterDataByInput:function filterDataByInput(nCnt,nStartCnt,nValLen,nCycleLen,fmtType){var oneUnit=0;switch(fmtType){case'm1':oneUnit=1440;break;case'm5':oneUnit=288;break;case'h1':oneUnit=24;break;case'd1':oneUnit=30;break;case'M1':oneUnit=12;break;default:oneUnit=24;}
if(nCnt<nStartCnt||nCnt>nStartCnt+nCycleLen){return 2;}else{if(nValLen<nCycleLen){var bFind=false;var loopCnt=Math.ceil(nCycleLen/oneUnit);for(var i=0;i<loopCnt;i++){var begin=nStartCnt+oneUnit*i;if(nCnt>=begin&&nCnt<=begin+nValLen){bFind=true;break;}}
if(bFind){return 0;}else{return 1;}}else{return 0;}}},filterOperationCombox:function filterOperationCombox(){var _this=this;var filterCondition=this.$filterCodition.mathquill('latex');if(!filterCondition){alert('Please input filter condition !');this.$filterCodition.select();return;}
var strPtId=this.$selPtList.val();var radioFilterVal=this.$page.find('input:radio[name=radioFilterType]:checked').val();var radioShowVal=this.$page.find('input:radio[name=radioShowType]:checked').val();var nFilterType='optionFilterType1'==radioFilterVal?0:1;var nShowType='optionShowType1'==radioShowVal?0:1;var item={'pointId':strPtId,'filterCondition':filterCondition,'filterType':nFilterType,'timeStart':_this.$tmStart.val().format("yyyy-MM-dd HH:mm:ss"),'valLen':parseInt(_this.$inputValLen.val()),'cycleLen':parseInt(_this.$inputCycleLen.val()),'timeEnd':_this.$tmEnd.val().format("yyyy-MM-dd HH:mm:ss"),'timeCycle':_this.$tmCycle.val().format("yyyy-MM-dd HH:mm:ss"),'showType':nShowType,'filterDrawObj':{},'appendData':[]};var condition=this.$filterCodition.mathquill('latex');var dataObj={};for(var i=0,len1=this.m_arrDsItem.length;i<len1;i++){var alph=this.m_arrDsItem[i].alphabet;if(-1!=condition.indexOf(alph)){var id=this.m_arrDsItem[i].id;dataObj[alph]=this.m_dictShowData[id];}}
var dataTarget;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(strPtId==this.m_arrDsItem[i].id){dataTarget=this.m_arrDsItem[i].alphabet;break;}}
if(-1==condition.indexOf(dataTarget)){alert(I18n.resource.analysis.dataFilter.ERR2);return;}
var postData={'express':condition,'params':dataObj,'target':dataTarget};WebAPI.post('/expressAnalysis/calc',postData).done(function(res){if(res.error){return;}
for(var i=0,len=res.data.length;i<len;i++){if(!res.data[i]){res.data[i]=undefined;}}
var id='';for(var i=0,len=_this.m_arrDsItem.length;i<len;i++){if(res.name==_this.m_arrDsItem[i].alphabet){id=_this.m_arrDsItem[i].id;break;}}
var nStartVal=Date.parse(item.timeStart);var nStartCnt=0;var xLen=_this.m_chartOption.xAxis[0].data.length;if(nStartVal>Date.parse(_this.m_chartOption.xAxis[0].data[xLen-1])){alert('Out of range!');return;}
if(nStartVal<Date.parse(_this.m_chartOption.xAxis[0].data[0])){nStartVal=Date.parse(_this.m_chartOption.xAxis[0].data[0]);}
for(var i=0;i<xLen;i++){if(Date.parse(_this.m_chartOption.xAxis[0].data[i])>=nStartVal){nStartCnt=i;break;}}
var nValidateLen=0;var nCycleLen=0;if(1==item.filterType){var nStart=Date.parse(item.timeStart);var nEnd=Date.parse(item.timeEnd);var nCycle=Date.parse(item.timeCycle);var unit=0;switch(_this.m_curModal.format){case'm1':unit=60000;break;case'm5':unit=300000;break;case'h1':unit=3600000;break;case'd1':unit=86400000;break;default:unit=3600000;break;}
nValidateLen=Math.floor((nEnd-nStart)/unit);nCycleLen=Math.floor((nCycle-nStart)/unit);}else{nValidateLen=item.valLen;nCycleLen=item.cycleLen;}
var filterVal=[];for(var i=0,len=res.data.length;i<len;i++){var flag=_this.filterDataByInput(i,nStartCnt,nValidateLen,nCycleLen,_this.m_curModal.format);switch(flag){case 0:filterVal.push(res.data[i]);break;case 1:case 2:filterVal.push(undefined);break;default:filterVal.push(undefined);break;}}
var redrawObj={list:[],timeShaft:[]};redrawObj.list.push({'dsItemId':id,'data':filterVal});redrawObj.timeShaft=_this.m_chartOption.xAxis[0].data;item.filterDrawObj=redrawObj;var dataLen=res.data.length;for(var j=0;j<dataLen;j++){var arrOrigData=dataObj[res.name];if(Boolean(arrOrigData)&&Boolean(arrOrigData[j])&&!filterVal[j]){item.appendData.push(arrOrigData[j]);}else{item.appendData.push(undefined);}}
var tempCnt=[];for(var k=0;k<dataLen;k++){if(0==k){if(!item.appendData[k]&&item.appendData[k+1]&&filterVal[k]){tempCnt.push(k);}
if(item.appendData[k]&&!item.appendData[k+1]&&filterVal[k+1]){tempCnt.push(k+1);}}else{if(!item.appendData[k-1]&&item.appendData[k]&&filterVal[k-1]){tempCnt.push(k-1);}
if(item.appendData[k-1]&&!item.appendData[k]&&filterVal[k]){tempCnt.push(k);}}}
for(var m=0,lenM=tempCnt.length;m<lenM;m++){item.appendData[tempCnt[m]]=filterVal[tempCnt[m]];}
var bFind=false;for(var i=0,len=_this.m_curModal.arrFilter.length;i<len;i++){if(id==_this.m_curModal.arrFilter[i].pointId){bFind=true;break;}}
if(bFind){_this.m_curModal.arrFilter[i]=item;}else{_this.m_curModal.arrFilter.push(item);}
_this.m_base.showFilterCharts();_this.m_screen.saveModal();_this.m_screen.saveModalJudge.resolveWith(_this.m_screen,[_this.m_screen,1,null,$('#divWSPane .selected'),_this.m_screen.curModal,false]);_this.close();}).always(function(e){});},filterOperationCheckButton:function filterOperationCheckButton(){var _this=this;var condition=this.$filterCodition.mathquill('latex');if(!condition){alert('Please input filter condition !');this.$filterCodition.select();return;}
var arrChk=this.$chkPtList.find('input');var arrPtId=[];for(var i=0,len=arrChk.length;i<len;i++){if(this.$chkPtList.find('input')[i].checked){arrPtId.push(this.$chkPtList.find('input')[i].value);}}
if(arrPtId.length<=0){alert(I18n.resource.analysis.dataFilter.ERR1);return;}
var nCnt=0;var arrTargetId=[];var bCheckOk=false;for(var n=0,lenN=arrPtId.length;n<lenN;n++){for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(this.m_arrDsItem[i].id==arrPtId[n]){if(-1!=condition.indexOf(this.m_arrDsItem[i].alphabet)){bCheckOk=true;break;}}}
if(bCheckOk){break;}}
if(!bCheckOk){alert(I18n.resource.analysis.dataFilter.ERR2);return;}
for(var n=0,lenN=arrPtId.length;n<lenN;n++){var strPtId=arrPtId[n];var radioFilterVal=this.$page.find('input:radio[name=radioFilterType]:checked').val();var radioShowVal=this.$page.find('input:radio[name=radioShowType]:checked').val();var nFilterType='optionFilterType1'==radioFilterVal?0:1;var nShowType='optionShowType1'==radioShowVal?0:1;var tmStart=_this.$tmStart.val().format("yyyy-MM-dd HH:mm:ss");var nValLen=parseInt(_this.$inputValLen.val());var nCycLen=parseInt(_this.$inputCycleLen.val());var tmEnd=_this.$tmEnd.val().format("yyyy-MM-dd HH:mm:ss");var tmCyc=_this.$tmCycle.val().format("yyyy-MM-dd HH:mm:ss");var dataObj={};for(var i=0,len1=this.m_arrDsItem.length;i<len1;i++){var alph=this.m_arrDsItem[i].alphabet;if(-1!=condition.indexOf(alph)){var id=this.m_arrDsItem[i].id;dataObj[alph]=this.m_dictShowData[id];}}
var dataTarget;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(strPtId==this.m_arrDsItem[i].id){dataTarget=this.m_arrDsItem[i].alphabet;break;}}
var postData={'express':condition,'params':dataObj,'target':dataTarget};WebAPI.post('/expressAnalysis/calc',postData).done(function(res){if(res.error){_this.close();return;}
for(var i=0,len=res.data.length;i<len;i++){if(!res.data[i]){res.data[i]=undefined;}}
var id='';for(var i=0,len=_this.m_arrDsItem.length;i<len;i++){if(res.name==_this.m_arrDsItem[i].alphabet){id=_this.m_arrDsItem[i].id;arrTargetId.push(id);break;}}
var item={'pointId':id,'filterCondition':condition,'filterType':nFilterType,'timeStart':tmStart,'valLen':nValLen,'cycleLen':nCycLen,'timeEnd':tmEnd,'timeCycle':tmCyc,'showType':nShowType,'filterDrawObj':{},'appendData':[]};var nStartVal=Date.parse(item.timeStart);var nStartCnt=0;var xLen=_this.m_chartOption.xAxis[0].data.length;if(nStartVal>Date.parse(_this.m_chartOption.xAxis[0].data[xLen-1])){alert('Out of range!');return;}
if(nStartVal<Date.parse(_this.m_chartOption.xAxis[0].data[0])){nStartVal=Date.parse(_this.m_chartOption.xAxis[0].data[0]);}
for(var i=0;i<xLen;i++){if(Date.parse(_this.m_chartOption.xAxis[0].data[i])>=nStartVal){nStartCnt=i;break;}}
var nValidateLen=0;var nCycleLen=0;if(1==item.filterType){var nStart=Date.parse(item.timeStart);var nEnd=Date.parse(item.timeEnd);var nCycle=Date.parse(item.timeCycle);var unit=0;switch(_this.m_curModal.format){case'm1':unit=60000;break;case'm5':unit=300000;break;case'h1':unit=3600000;break;case'd1':unit=86400000;break;default:unit=3600000;break;}
nValidateLen=Math.floor((nEnd-nStart)/unit);nCycleLen=Math.floor((nCycle-nStart)/unit);}else{nValidateLen=item.valLen;nCycleLen=item.cycleLen;}
var filterVal=[];for(var i=0,len=res.data.length;i<len;i++){var flag=_this.filterDataByInput(i,nStartCnt,nValidateLen,nCycleLen,_this.m_curModal.format);switch(flag){case 0:filterVal.push(res.data[i]);break;case 1:case 2:filterVal.push(undefined);break;default:filterVal.push(undefined);break;}}
var redrawObj={list:[],timeShaft:[]};redrawObj.list.push({'dsItemId':id,'data':filterVal});redrawObj.timeShaft=_this.m_chartOption.xAxis[0].data;item.filterDrawObj=redrawObj;var dataLen=res.data.length;for(var j=0;j<dataLen;j++){var arrOrigData=dataObj[res.name];if(Boolean(arrOrigData)&&Boolean(arrOrigData[j])&&!filterVal[j]){item.appendData.push(arrOrigData[j]);}else{item.appendData.push(undefined);}}
var tempCnt=[];for(var k=0;k<dataLen;k++){if(0==k){if(!item.appendData[k]&&item.appendData[k+1]&&filterVal[k]){tempCnt.push(k);}
if(item.appendData[k]&&!item.appendData[k+1]&&filterVal[k+1]){tempCnt.push(k+1);}}else{if(!item.appendData[k-1]&&item.appendData[k]&&filterVal[k-1]){tempCnt.push(k-1);}
if(item.appendData[k-1]&&!item.appendData[k]&&filterVal[k]){tempCnt.push(k);}}}
for(var m=0,lenM=tempCnt.length;m<lenM;m++){item.appendData[tempCnt[m]]=filterVal[tempCnt[m]];}
var bFind=false;for(var i=0,len=_this.m_curModal.arrFilter.length;i<len;i++){if(id==_this.m_curModal.arrFilter[i].pointId){bFind=true;break;}}
item.pointId=id;if(bFind){_this.m_curModal.arrFilter[i]=item;}else{_this.m_curModal.arrFilter.push(item);}
nCnt++;if(nCnt>=lenN){for(var p=0,lenP=arrTargetId.length;p<lenP;p++){_this.m_screen.curModal.dictShowFlag[arrTargetId[p]]=false;_this.m_screen.curModal.dictShowFlag[arrTargetId[p]+'_filter']=true;}
_this.m_base.showFilterCharts(_this.m_chartOption.series);for(var p=0,lenP=_this.m_curModal.arrFilter.length;p<lenP;p++){var itemTemp=_this.m_curModal.arrFilter[p];_this.m_base.resetShowData(itemTemp.filterDrawObj,1);_this.m_base.resetShowData({list:[{'dsItemId':item.pointId,'data':itemTemp.appendData}],timeShaft:item.filterDrawObj.timeShaft},2);}
for(var p=0,lenP=arrTargetId.length;p<lenP;p++){for(var q=0,lenQ=_this.m_chartOption.series.length;q<lenQ;q++){if(arrTargetId[p]==_this.m_chartOption.series[q].id){_this.m_chartOption.series[q].data=[];break;}}}
_this.m_base.resetIcon(arrTargetId);_this.m_base.setTendencyOption(_this.m_chartOption.series);_this.m_screen.saveModal();_this.m_screen.saveModalJudge.resolveWith(_this.m_screen,[_this.m_screen,1,null,$('#divWSPane .selected'),_this.m_screen.curModal,false]);_this.close();}}).always(function(e){});}}};return DataCalcFilter;}();var DataCalcFilterCustom=function(){function DataCalcFilterCustom(parent,base){this.m_parent=parent;this.m_base=base;this.m_screen=base.screen;this.m_curModal=base.screen.curModal;if(!this.m_curModal.arrFilter){this.m_curModal.arrFilter=[];}
if(base.chart){this.m_chartOption=base.chart.getOption();if(this.m_chartOption&&this.m_chartOption.xAxis[0]){this.m_arrTimeStr=this.m_chartOption.xAxis[0].data;}}
this.m_arrDsItem=[];this.m_arrDsId=this.m_curModal.itemDS[0].arrId;var arrId=this.m_arrDsId;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=this.m_arrDsId.length;i<len;i++){var id=this.m_arrDsId[i];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var itemTemp=arrItem[m];itemTemp.alphabet=this.m_parent.getAlphabetByNum(i);itemTemp.arrData=this.m_curModal.dictShowData[id];this.m_arrDsItem.push(itemTemp);break;}}}
this.m_bShowData=this.m_curModal.bShowData||undefined==this.m_curModal.bShowData?true:false;this.$wrap;this.$page;this.m_arrFlag=['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','Y','W','X','Y','Z'];};DataCalcFilterCustom.prototype={show:function show($page){this.$page=$page;this.init();},init:function init(){this.$btnFilterCust=$('#btnFilterCustom',this.$page);this.$btnCancelCust=$('#btnCancelCustom',this.$page);this.$chkPtListCust=$('#checkPtListCust',this.$page);this.$mathCfgDataCust=$('#varConfigDataCust',this.$page);this.$divShow=$('#divShowData',this.$page);this.$divEdit=$('#divEdit',this.$page);this.$btnDataShow=$('#btnDataShow',this.$page);this.initCloseControl();this.initCheckButton();this.initVarGrid();this.initShowData();},close:function close(){this.m_parent.close();},initCloseControl:function initCloseControl(){var _this=this;this.$btnFilterCust.off().click(function(e){var arrFilterRes=_this.doFilterOperationEx();if(arrFilterRes){_this.m_curModal.arrFilter=arrFilterRes;var arrPointId=[];for(var i=0,len=arrFilterRes.length;i<len;i++){var pointId=arrFilterRes[i].pointId;arrPointId.push(pointId);_this.m_screen.curModal.dictShowFlag[pointId]=false;_this.m_screen.curModal.dictShowFlag[pointId+'_filter']=true;_this.m_base.resetShowData(arrFilterRes[i],1);for(var q=0,lenQ=_this.m_chartOption.series.length;q<lenQ;q++){if(pointId==_this.m_chartOption.series[q].id){_this.m_chartOption.series[q].data=[];break;}}}
_this.m_curModal.bShowData=_this.m_bShowData;_this.m_curModal.customRule=_this.$divEdit.html();_this.m_base.showFilterCharts(_this.m_chartOption.series);_this.m_base.resetIcon(arrPointId);_this.m_base.setTendencyOption(_this.m_chartOption.series);_this.m_screen.saveModal();_this.m_screen.saveModalJudge.resolveWith(_this.m_screen,[_this.m_screen,1,null,$('#divWSPane .selected'),_this.m_screen.curModal,false]);_this.close();}});this.$btnCancelCust.off().click(function(e){_this.close();});},initCheckButton:function initCheckButton(){this.$chkPtListCust.empty();var item;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(0==i){item='<div class="checkbox"><label><input type="checkbox" value="'+this.m_arrDsItem[i].id+'" checked>'+this.m_arrDsItem[i].alias+'</label></div>';}else{item='<div class="checkbox"><label><input type="checkbox" value="'+this.m_arrDsItem[i].id+'">'+this.m_arrDsItem[i].alias+'</label></div>';}
this.$chkPtListCust.append(item);}},initVarGrid:function initVarGrid(){this.$mathCfgDataCust.empty();var item;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){item=$('<div class="row">\
                                <div class="col-xs-12 varRow">\
                                    <div class="col-xs-4 formulaVarName"><input type="text" name="inputVarValue" class="varNameChange">'+this.m_arrDsItem[i].alphabet+'</div>\
                                    <div class="col-xs-6 divVarValue" varid="'+this.m_arrDsItem[i].id+'">'+this.m_arrDsItem[i].alias+'</div>\
                                </div>\
                            </div>');this.$mathCfgDataCust.append(item);}},initShowData:function initShowData(){var _this=this;this.showDataInCustomFilter(_this.m_bShowData);this.$btnDataShow.off().click(function(e){_this.m_bShowData=!_this.m_bShowData;_this.showDataInCustomFilter(_this.m_bShowData);});for(var i=0,len=this.m_arrDsItem.length;i<len;i++){var setVal='var '+this.m_arrDsItem[i].alphabet+' = [';for(var j=0,len2=this.m_arrDsItem[i].arrData.length;j<len2-1;j++){setVal+=this.m_arrDsItem[i].arrData[j]+', ';}
setVal+=this.m_arrDsItem[i].arrData[len2-1]+'];';var divSet=$('<div>'+setVal+'</div>');this.$divShow.append(divSet);}
var rule=this.m_curModal.customRule;if(rule){this.$divEdit.html(rule);}},doFilterOperation:function doFilterOperation(){var conditionCust=this.$divEdit.text();var funcLogic=null;var funcTime=null;if(!conditionCust){return;}
var arr=conditionCust.split(';');var arrLen=arr.length;var arrRet=[];var arrTimeCnt=[];var arrSub=[];for(var i=0;i<arrLen;i++){var arrTimeTemp=[];if(-1!=arr[i].indexOf('time')){arr[i]=arr[i].replace('&&','&');if(-1!=arr[i].indexOf('&')){arrSub=arr[i].split('&');for(var k=0,len3=arrSub.length;k<len3;k++){funcTime=new Function('v','return '+arrSub[k].replace('time','v'));for(var j=0,len2=this.m_arrTimeStr.length;j<len2;j++){if(funcTime(this.m_arrTimeStr[j])){if(0==k){arrTimeTemp.push(true);}else{arrTimeTemp[j]=arrTimeTemp[j]&&true?true:false;}}else{if(0==k){arrTimeTemp.push(false);}else{arrTimeTemp[j]=false;}}}}}else{funcTime=new Function('v','return '+arr[i].replace('time','v'));for(var j=0,len2=this.m_arrTimeStr.length;j<len2;j++){if(funcTime(this.m_arrTimeStr[j])){arrTimeCnt.push(true);}else{arrTimeCnt.push(false);}}}
if(0==arrTimeCnt.length){arrTimeCnt=arrTimeTemp;}else{for(var m=0,len4=arrTimeTemp.length;m<len4;m++){arrTimeCnt[m]=arrTimeCnt[m]|arrTimeTemp[m]?true:false;}}}}
for(var i=0;i<arrLen;i++){if(-1!=arr[i].indexOf('time')){continue;}
var alphabet=this.getAlphabet(arr[i]);if(alphabet){var arrData=[];var pointId;for(var j=0,len2=this.m_arrDsItem.length;j<len2;j++){if(alphabet==this.m_arrDsItem[j].alphabet){arrData=this.m_arrDsItem[j].arrData;pointId=this.m_arrDsItem[j].id;break;}}
var arrFilter=[];funcLogic=new Function('v','return '+arr[i].replace(alphabet,'v'));for(var k=0,len3=arrData.length;k<len3;k++){if(funcLogic(arrData[k])){arrFilter.push(arrData[k]);}else{arrFilter.push(undefined);}}
if(arrTimeCnt.length>0){for(var k=0,len3=arrData.length;k<len3;k++){if(!arrTimeCnt[k]){arrFilter[k]=undefined;}}}
var obj={'list':[{'data':arrFilter,'dsItemId':pointId}],'timeShaft':this.m_arrTimeStr};var item={appendData:[],cycleLen:undefined,filterCondition:arr[i],filterDrawObj:obj,filterType:0,pointId:pointId,showType:0,timeCycle:'',timeEnd:'',timeStart:'',valLen:undefined};arrRet.push(item);this.m_curModal.dictShowData[pointId+'_filter']=arrFilter;}}
return arrRet;},getAlphabet:function getAlphabet(src){var ret;for(var i=0,len=this.m_arrFlag.length;i<len;i++){if(-1!=src.indexOf(this.m_arrFlag[i])){ret=this.m_arrFlag[i];break;}}
if(ret){return ret.toLowerCase();}else{return null;}},parseCondition:function parseCondition(alphabet,src){return alphabet+' = '+alphabet+'.filter(function ('+alphabet+') { return '+src+'; });';},parseReturn:function parseReturn(alphabet){var id,ret;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(alphabet==this.m_arrDsItem[i].alphabet){id=this.m_arrDsItem[i].id;break;}}
if(id){ret='"'+id+'":'+alphabet+',';}
return ret;},doFilterOperationEx:function doFilterOperationEx(){var text=this.$divEdit.text();if(!text){return null;}
var arrChk=this.$chkPtListCust.find('input');var arrPtId=[];for(var i=0,len=arrChk.length;i<len;i++){if(this.$chkPtListCust.find('input')[i].checked){arrPtId.push(this.$chkPtListCust.find('input')[i].value);}}
if(arrPtId.length<=0){alert(I18n.resource.analysis.dataFilter.ERR1);return;}
text=text.replace(/.year/g,'.getFullYear()');text=text.replace(/.month/g,'.getMonth() + 1');text=text.replace(/.weekday/g,'.getDay() + 1');text=text.replace(/.day/g,'.getDate()');text=text.replace(/.hour/g,'.getHours() + 1');text=text.replace(/.minute/g,'.getMinutes() + 1');text=text.replace(/.second/g,'.getSeconds() + 1');text=text.replace(/TIME/g,'new Date(arrTime[i])');var content;content='function fn() {';for(var i=0,len=this.m_arrDsItem.length;i<len;i++){content+='var '+this.m_arrDsItem[i].alphabet+'=['+this.m_arrDsItem[i].arrData+'];';}
content+='var arrTime=[';for(var i=0,len=this.m_arrTimeStr.length;i<len-1;i++){content+='"'+this.m_arrTimeStr[i]+'",';}
content+='"'+this.m_arrTimeStr[len-1]+'"];';content+='var OUT=[];for(var i=0,len=a.length; i<len; i++){';content+=text;content+='}return OUT;}';eval(content);var arrFilter=fn();for(var i=0,len=arrFilter.length;i<len;i++){if(!arrFilter[i]&&0!=arrFilter[i]){arrFilter[i]=undefined;}}
var arrRet=[];for(var i=0,len=arrPtId.length;i<len;i++){var obj={'list':[{'data':arrFilter,'dsItemId':arrPtId[i]}],'timeShaft':this.m_arrTimeStr};var item={appendData:[],cycleLen:undefined,filterDrawObj:obj,filterType:0,pointId:arrPtId[i],showType:0,timeCycle:'',timeEnd:'',timeStart:'',valLen:undefined};arrRet.push(item);this.m_curModal.dictShowData[arrPtId[i]+'_filter']=arrFilter;}
return arrRet;},showDataInCustomFilter:function showDataInCustomFilter(bIsShow){if(bIsShow){this.$btnDataShow.text(I18n.resource.analysis.dataFilter.DATA_HIDE);this.$divShow.show();}else{this.$btnDataShow.text(I18n.resource.analysis.dataFilter.DATA_SHOW);this.$divShow.hide();}}};return DataCalcFilterCustom;}();var DataCalcFilterEd3=function(){function DataCalcFilterEd3(parent,base){this.m_parent=parent;this.m_base=base;this.m_screen=base.screen;this.m_curModal=base.screen.curModal;if(!this.m_curModal.arrFilter){this.m_curModal.arrFilter=[];}
if(base.chart){this.m_chartOption=base.chart.getOption();if(this.m_chartOption&&this.m_chartOption.xAxis&&this.m_chartOption.xAxis[0]){this.m_arrTimeStr=this.m_chartOption.xAxis[0].data;}}
this.m_filterAttr=this.m_curModal.filterAttr;if(!this.m_filterAttr){this.m_filterAttr=0;}
this.m_arrSelPtId=this.m_curModal.arrSelectPointsId;if(!this.m_arrSelPtId){this.m_arrSelPtId=[];}
this.m_nShowType=this.m_curModal.nShowType;if(!this.m_nShowType){this.m_nShowType=0;}
this.m_arrDsItem=[];this.m_arrDsId=this.m_curModal.itemDS[0].arrId;var arrId=this.m_arrDsId;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=this.m_arrDsId.length;i<len;i++){var id=this.m_arrDsId[i];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var itemTemp=arrItem[m];itemTemp.alphabet=this.m_parent.getAlphabetByNum(i);itemTemp.arrData=this.m_curModal.dictShowData[id];itemTemp.bSelected=1==len?(this.m_arrSelPtId.splice(0,1,id),true):this.findIdInSelectedArray(id);this.m_arrDsItem.push(itemTemp);break;}}}
this.m_bShowData=this.m_curModal.bShowData||undefined==this.m_curModal.bShowData?true:false;this.$wrap;this.$page;this.m_arrFlag=['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','Y','W','X','Y','Z'];this.m_dictShowData=this.m_curModal.dictShowData;};DataCalcFilterEd3.prototype={show:function show($page){this.$page=$page;this.init();},init:function init(){this.$btnFilterEd3=$('#btnFilterEd3',this.$page);this.$btnCancelEd3=$('#btnCancelEd3',this.$page);this.$mathCfgDataEd3=$('#varConfigDataEd3',this.$page);this.$divShow=$('#divShowDataEd3',this.$page);this.$divEdit=$('#divEditEd3',this.$page);this.$btnDataShow=$('#btnDataShowEd3',this.$page);this.$btnFilterCond=$('#btnFilterCondition',this.$page);this.$btnCustRule=$('#btnCustomRule',this.$page);this.$divFilterCond=$('#divFilterCondition',this.$page);this.$divCustRule=$('#divCustomRule',this.$page);this.$filterCodition=$('#filterConditionEd3',this.$page);this.$btnLogicAnd=$('#btnLogicAndEd3',this.$page);this.$btnLogicOr=$('#btnLogicOrEd3',this.$page);this.$btnLogicNot=$('#btnLogicNotEd3',this.$page);this.$radioShowNone=$('#radioShowNoneEd3',this.$page);this.$radioShowColor=$('#radioShowColorEd3',this.$page);this.initCloseControl();this.initVarGrid();this.initShowData();this.initFilterCondition();this.initConfigButton();this.initRadioShowType();},close:function close(){this.m_parent.close();},initCloseControl:function initCloseControl(){var _this=this;this.$btnFilterEd3.off().click(function(e){if(_this.m_arrSelPtId.length<=0){alert('Please select point.');return;}
_this.m_curModal.filterAttr=_this.m_filterAttr;_this.m_curModal.arrSelectPointsId=_this.m_arrSelPtId;_this.m_curModal.nShowType=_this.m_nShowType;if(0==_this.m_filterAttr){_this.filterOperationCheckButton();}else if(1==_this.m_filterAttr){var arrFilterRes=_this.doFilterOperationEx();if(!arrFilterRes){return;}
_this.m_curModal.arrFilter=arrFilterRes;var arrPointId=[];for(var i=0,len=arrFilterRes.length;i<len;i++){var pointId=arrFilterRes[i].pointId;arrPointId.push(pointId);_this.m_screen.curModal.dictShowFlag[pointId]=false;_this.m_screen.curModal.dictShowFlag[pointId+'_filter']=true;_this.m_base.resetShowData(arrFilterRes[i],1);for(var q=0,lenQ=_this.m_chartOption.series.length;q<lenQ;q++){if(pointId==_this.m_chartOption.series[q].id){_this.m_chartOption.series[q].data=[];break;}}}
_this.m_curModal.bShowData=_this.m_bShowData;_this.m_curModal.customRule=_this.$divEdit.html();_this.m_base.showFilterCharts(_this.m_chartOption.series);_this.m_base.resetIcon(arrPointId);_this.m_base.setTendencyOption(_this.m_chartOption.series);_this.m_screen.saveModal();_this.m_screen.saveModalJudge.resolveWith(_this.m_screen,[_this.m_screen,1,null,$('#divWSPane .selected'),_this.m_screen.curModal,false]);_this.close();}else{return;}});this.$btnCancelEd3.off().click(function(e){_this.close();});},initVarGrid:function initVarGrid(){var _this=this;var $item;this.$mathCfgDataEd3.empty();for(var i=0,len=this.m_arrDsItem.length;i<len;i++){$item=$('<tr varId="'+this.m_arrDsItem[i].id+'">\
                            <td>'+this.m_arrDsItem[i].alias+'</td>\
                            <td>'+this.m_arrDsItem[i].alphabet+'</td>\
                            <td><span class="glyphicon glyphicon-ok" aria-hidden="true" style="display:none"></span></td>\
                        </tr> ');if(this.m_arrDsItem[i].bSelected){$item.addClass('gridSelectRow');$item.find('.glyphicon').css('display','inline');}
$item.off().click(function(e){var $tarRow=$(e.currentTarget);if($tarRow){var id=$tarRow.attr('varId');var bFind=false;var i=0;for(var len=_this.m_arrSelPtId.length;i<len;i++){if(id==_this.m_arrSelPtId[i]){bFind=true;break;}}
if(bFind){_this.m_arrSelPtId.splice(i,1);$tarRow.removeClass('gridSelectRow');$tarRow.find('.glyphicon').css('display','none');}else{_this.m_arrSelPtId.push(id);$tarRow.addClass('gridSelectRow');$tarRow.find('.glyphicon').css('display','inline');}}});this.$mathCfgDataEd3.append($item);}},initShowData:function initShowData(){var _this=this;this.showDataInCustomFilter(_this.m_bShowData);this.$btnDataShow.off().click(function(e){_this.m_bShowData=!_this.m_bShowData;_this.showDataInCustomFilter(_this.m_bShowData);});for(var i=0,len=this.m_arrDsItem.length;i<len;i++){var setVal='var '+this.m_arrDsItem[i].alphabet+' = [';for(var j=0,len2=this.m_arrDsItem[i].arrData.length;j<len2-1;j++){setVal+=this.m_arrDsItem[i].arrData[j]+', ';}
setVal+=this.m_arrDsItem[i].arrData[len2-1]+'];';var divSet=$('<div>'+setVal+'</div>');this.$divShow.append(divSet);}
var rule=this.m_curModal.customRule;if(rule){this.$divEdit.html(rule);}},initFilterCondition:function initFilterCondition(){this.$filterCodition.mathquill('editable');var arrFilter=this.m_curModal.arrFilter;var codition;for(var i=0,len=arrFilter.length;i<len;i++){if(true){codition=arrFilter[i].filterCondition;break;}}
if(codition){this.$filterCodition.mathquill('latex',codition);}},initConfigButton:function initConfigButton(){var _this=this;this.$btnLogicAnd.click(function(e){_this.$filterCodition.mathquill('write','&');});this.$btnLogicOr.click(function(e){_this.$filterCodition.mathquill('write','\\mid');});this.$btnLogicNot.click(function(e){_this.$filterCodition.mathquill('write','!');});this.setFilterAttribute(this.m_filterAttr);this.$btnFilterCond.click(function(e){_this.setFilterAttribute(0);});this.$btnCustRule.click(function(e){_this.setFilterAttribute(1);});},initRadioShowType:function initRadioShowType(){this.$radioShowNone.next().text(I18n.resource.analysis.dataFilter.SHOW_NONE);this.$radioShowColor.next().text(I18n.resource.analysis.dataFilter.SHOW_DOT);if(0==this.m_nShowType){this.$radioShowNone.click();}else{this.$radioShowColor.click();}
var _this=this;this.$radioShowNone.click(function(e){_this.m_nShowType=0;});this.$radioShowColor.click(function(e){_this.m_nShowType=1;});},setFilterAttribute:function setFilterAttribute(val){if(!val&&0!=val){return;}
this.m_filterAttr=val;if(0==val){this.$btnFilterCond.removeClass('btnFilterCfgDisable');this.$btnCustRule.addClass('btnFilterCfgDisable');this.$divFilterCond.css('display','block');this.$divCustRule.css('display','none');}else if(1==val){this.$btnFilterCond.addClass('btnFilterCfgDisable');this.$btnCustRule.removeClass('btnFilterCfgDisable');this.$divFilterCond.css('display','none');this.$divCustRule.css('display','block');}else{}},findIdInSelectedArray:function findIdInSelectedArray(id){var bFind=false;for(var i=0,len=this.m_arrSelPtId.length;i<len;i++){if(id==this.m_arrSelPtId[i]){bFind=true;break;}}
return bFind;},doFilterOperationEx:function doFilterOperationEx(){var text=this.$divEdit.text();if(!text){return null;}
text=text.replace(/.year/g,'.getFullYear()');text=text.replace(/.month/g,'.getMonth() + 1');text=text.replace(/.weekday/g,'.getDay() + 1');text=text.replace(/.day/g,'.getDate()');text=text.replace(/.hour/g,'.getHours() + 1');text=text.replace(/.minute/g,'.getMinutes() + 1');text=text.replace(/.second/g,'.getSeconds() + 1');text=text.replace(/TIME/g,'new Date(arrTime[i])');var content;content='function fn() {';for(var i=0,len=this.m_arrDsItem.length;i<len;i++){content+='var '+this.m_arrDsItem[i].alphabet+'=['+this.m_arrDsItem[i].arrData+'];';}
content+='var arrTime=[';for(var i=0,len=this.m_arrTimeStr.length;i<len-1;i++){content+='"'+this.m_arrTimeStr[i]+'",';}
content+='"'+this.m_arrTimeStr[len-1]+'"];';content+=text;content+='return OUT;}';eval(content);var arrFilter=fn();for(var i=0,len=arrFilter.length;i<len;i++){if(!arrFilter[i]&&0!=arrFilter[i]){arrFilter[i]=undefined;}}
var arrPtId=this.m_arrSelPtId;var arrRet=[];for(var i=0,len=arrPtId.length;i<len;i++){var obj={'list':[{'data':arrFilter,'dsItemId':arrPtId[i]}],'timeShaft':this.m_arrTimeStr};var item={appendData:[],cycleLen:undefined,filterDrawObj:obj,filterType:0,pointId:arrPtId[i],showType:0,timeCycle:'',timeEnd:'',timeStart:'',valLen:undefined};arrRet.push(item);this.m_curModal.dictShowData[arrPtId[i]+'_filter']=arrFilter;}
return arrRet;},showDataInCustomFilter:function showDataInCustomFilter(bIsShow){if(bIsShow){this.$btnDataShow.text(I18n.resource.analysis.dataFilter.DATA_HIDE);this.$divShow.show();}else{this.$btnDataShow.text(I18n.resource.analysis.dataFilter.DATA_SHOW);this.$divShow.hide();}},filterOperationCheckButton:function filterOperationCheckButton(){var _this=this;var condition=this.$filterCodition.mathquill('latex');if(!condition){alert('Please input filter condition !');this.$filterCodition.select();return;}
var arrFlag=['+','-','*','/','<','>','=','&','|','!'];var bFind=false;for(var i=0,len=arrFlag.length;i<len;i++){if(-1!=condition.indexOf(arrFlag[i])){bFind=true;break;}}
if(!bFind){alert('Please input correct filter condition !');return;}
var arrPtId=this.m_arrSelPtId;if(arrPtId.length<=0){alert(I18n.resource.analysis.dataFilter.ERR1);return;}
var nCnt=0;var arrTargetId=[];var bCheckOk=false;for(var n=0,lenN=arrPtId.length;n<lenN;n++){for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(this.m_arrDsItem[i].id==arrPtId[n]){if(-1!=condition.indexOf(this.m_arrDsItem[i].alphabet)){bCheckOk=true;break;}}}
if(bCheckOk){break;}}
if(!bCheckOk){alert(I18n.resource.analysis.dataFilter.ERR2);return;}
for(var n=0,lenN=arrPtId.length;n<lenN;n++){var strPtId=arrPtId[n];var dataObj={};for(var i=0,len1=this.m_arrDsItem.length;i<len1;i++){var alph=this.m_arrDsItem[i].alphabet;if(-1!=condition.indexOf(alph)){var id=this.m_arrDsItem[i].id;dataObj[alph]=this.m_dictShowData[id];}}
var dataTarget;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(strPtId==this.m_arrDsItem[i].id){dataTarget=this.m_arrDsItem[i].alphabet;break;}}
var postData={'express':condition,'params':dataObj,'target':dataTarget};WebAPI.post('/expressAnalysis/calc',postData).done(function(res){if(res.error){_this.close();return;}
for(var i=0,len=res.data.length;i<len;i++){if(!res.data[i]){res.data[i]=undefined;}}
var id='';for(var i=0,len=_this.m_arrDsItem.length;i<len;i++){if(res.name==_this.m_arrDsItem[i].alphabet){id=_this.m_arrDsItem[i].id;arrTargetId.push(id);break;}}
var item={'pointId':id,'filterCondition':condition,'filterType':'','timeStart':'','valLen':0,'cycleLen':0,'timeEnd':'','timeCycle':0,'showType':_this.m_nShowType,'filterDrawObj':{},'appendData':[]};var filterVal=res.data;var redrawObj={list:[],timeShaft:[]};redrawObj.list.push({'dsItemId':id,'data':filterVal});redrawObj.timeShaft=_this.m_arrTimeStr;item.filterDrawObj=redrawObj;var dataLen=res.data.length;for(var j=0;j<dataLen;j++){var arrOrigData=dataObj[res.name];if(Boolean(arrOrigData)&&Boolean(arrOrigData[j])&&!filterVal[j]){item.appendData.push(arrOrigData[j]);}else{item.appendData.push(undefined);}}
var tempCnt=[];for(var k=0;k<dataLen;k++){if(0==k){if(!item.appendData[k]&&item.appendData[k+1]&&filterVal[k]){tempCnt.push(k);}
if(item.appendData[k]&&!item.appendData[k+1]&&filterVal[k+1]){tempCnt.push(k+1);}}else{if(!item.appendData[k-1]&&item.appendData[k]&&filterVal[k-1]){tempCnt.push(k-1);}
if(item.appendData[k-1]&&!item.appendData[k]&&filterVal[k]){tempCnt.push(k);}}}
for(var m=0,lenM=tempCnt.length;m<lenM;m++){item.appendData[tempCnt[m]]=filterVal[tempCnt[m]];}
var bFind=false;for(var i=0,len=_this.m_curModal.arrFilter.length;i<len;i++){if(id==_this.m_curModal.arrFilter[i].pointId){bFind=true;break;}}
item.pointId=id;if(bFind){_this.m_curModal.arrFilter[i]=item;}else{_this.m_curModal.arrFilter.push(item);}
nCnt++;if(nCnt>=lenN){for(var p=0,lenP=arrTargetId.length;p<lenP;p++){_this.m_screen.curModal.dictShowFlag[arrTargetId[p]]=false;_this.m_screen.curModal.dictShowFlag[arrTargetId[p]+'_filter']=true;}
_this.m_base.showFilterCharts(_this.m_chartOption.series);for(var p=0,lenP=_this.m_curModal.arrFilter.length;p<lenP;p++){var itemTemp=_this.m_curModal.arrFilter[p];_this.m_base.resetShowData(itemTemp.filterDrawObj,1);_this.m_base.resetShowData({list:[{'dsItemId':item.pointId,'data':itemTemp.appendData}],timeShaft:item.filterDrawObj.timeShaft},2);}
for(var p=0,lenP=arrTargetId.length;p<lenP;p++){for(var q=0,lenQ=_this.m_chartOption.series.length;q<lenQ;q++){if(arrTargetId[p]==_this.m_chartOption.series[q].id){_this.m_chartOption.series[q].data=[];break;}}}
_this.m_base.resetIcon(arrTargetId);_this.m_base.setTendencyOption(_this.m_chartOption.series);_this.m_screen.saveModal();_this.m_screen.saveModalJudge.resolveWith(_this.m_screen,[_this.m_screen,1,null,$('#divWSPane .selected'),_this.m_screen.curModal,false]);_this.close();}}).always(function(e){});}}};return DataCalcFilterEd3;}();var ModalAppendPointToDs=function(){var _this;function ModalAppendPointToDs(bPtHasId,pointIdList,pointNameList){_this=this;this.bPointHasId=bPtHasId;this.arrDs=[];this.groupInfo=undefined;if(bPtHasId){var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(pointIdList);for(var i=0,len=pointIdList.length;i<len;i++){var id=pointIdList[i];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){this.arrDs.push({'id':id,'name':arrItem[m].alias});break;}}}}else{for(var i=0,len=pointNameList.length;i<len;i++){this.arrDs.push({'id':null,'name':pointNameList[i]});}}}
ModalAppendPointToDs.prototype.show=function(){if(this.bPointHasId){domPanelContent=document.getElementById('paneCenter');}else{var domTemp=document.getElementById('divObserverCanvas');if(!domTemp){domTemp=document.getElementById('paneCenter');}
domPanelContent=domTemp;}
if(domPanelContent){Spinner.spin(domPanelContent);}
WebAPI.get('/static/views/observer/widgets/modalAppendPointToDs.html').done(function(html){_this.$wrap=$('<div class="modal-db-history-wrap" id="modalJumpPageWrap" style="z-index: 1051;">').appendTo(document.body).html(html);_this.$modal=_this.$wrap.children('.modal');_this.$modal.modal('show');if(_this.bPointHasId){if(!AppConfig.datasource.m_parent.store.group){WebAPI.get('/analysis/datasource/getDsItemInfo/'+AppConfig.userId+'/null').done(function(result){var arrGroupInfo=[];for(var i=0,len=result.length;i<len;i++){if(result[i].isParent){arrGroupInfo.push(result[i]);}}
AppConfig.datasource.m_parent.store.group=arrGroupInfo;_this.groupInfo=arrGroupInfo;_this.init();}).always(function(e){});}else{_this.groupInfo=AppConfig.datasource.m_parent.store.group;_this.init();}}else{WebAPI.get('/analysis/datasource/getDsItemInfo/'+AppConfig.userId+'/null').done(function(result){var arrGroupInfo=[];for(var i=0,len=result.length;i<len;i++){if(result[i].isParent){arrGroupInfo.push(result[i]);}}
_this.groupInfo=arrGroupInfo;_this.init();}).always(function(e){});}}).always(function(e){Spinner.stop();});};ModalAppendPointToDs.prototype.init=function(){I18n.fillArea(this.$modal);this.$divPtList=$('#ptList',this.$modal);this.$selGroup=$('#selectGroup',this.$modal);this.$btnImportJump=$('#btnImportJump',this.$modal);this.$btnImportNoJump=$('#btnImportNoJump',this.$modal);this.$inputNewGroup=$('#inputNewGroup',this.$modal);this.$btnSelAll=$('#btnSelAll',this.$modal);this.$btnSelRevert=$('#btnSelRevert',this.$modal);this.initPointList();this.initComboBox();this.attachEvents();};ModalAppendPointToDs.prototype.initPointList=function(){this.$divPtList.empty();var item;for(var i=0,len=this.arrDs.length;i<len;i++){item=$('<label class="checkboxShow"><input type="checkbox" value="'+this.arrDs[i].id+'" checked>'+this.arrDs[i].name+'</label>');this.$divPtList.append(item);}};ModalAppendPointToDs.prototype.initComboBox=function(){this.$selGroup.empty();var itemNew=$('<option value="new" style="color:#0000ff;font-weight:900;">'+I18n.resource.dashboard.modalJumpPages.NEW_GROUP+'</option>');this.$selGroup.append(itemNew);for(var i=0,len=this.groupInfo.length;i<len;i++){var item=$('<option value="'+this.groupInfo[i].id+'">'+this.groupInfo[i].alias+'</option>');this.$selGroup.append(item);}
_this.$inputNewGroup.css('display','block');this.$selGroup.click(function(e){var selGroupVal=_this.$selGroup.find("option:selected")[0].value;if('new'==selGroupVal){_this.$inputNewGroup.css('display','block');}else{_this.$inputNewGroup.css('display','none');}});this.$inputNewGroup.attr('placeholder',I18n.resource.dashboard.modalJumpPages.NEW_DS_NAME);};ModalAppendPointToDs.prototype.attachEvents=function(){this.$btnImportJump.off().click(function(e){_this.importFunc(true);});this.$btnImportNoJump.off().click(function(e){_this.importFunc(false);});this.$btnSelAll.off().click(function(e){var $checkBox=_this.$divPtList.find('input');if($checkBox.length>0){$checkBox.prop('checked',true);}});this.$btnSelRevert.off().click(function(e){var $checkBox=_this.$divPtList.find('input');for(var i=0,len=$checkBox.length;i<len;i++){var item=$checkBox.eq(i);if(item.prop('checked')){item.removeAttr('checked');}else{item.prop('checked',true);}}});};ModalAppendPointToDs.prototype.insertItemIntoGroup=function(groupId,arrPoint,bIsJump){var postData={itemList:[]};var arrItemList=[];if(this.bPointHasId){var arrId=[];for(var n=0;n<arrPoint.length;n++){arrId.push(arrPoint[n].id);}
var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=arrPoint.length;i<len;i++){for(var m=0;m<arrItem.length;m++){if(arrPoint[i].id==arrItem[m].id){var dsItem={};var temp=arrItem[m];dsItem.alias=temp.alias;dsItem.groupId=groupId;dsItem.note=temp.note;dsItem.projId=temp.projId;dsItem.type=temp.type;dsItem.value=temp.value;arrItemList.push(dsItem);break;}}}}else{for(var i=0,len=arrPoint.length;i<len;i++){var dsItem={};var ptName=arrPoint[i].name;dsItem.alias=ptName;dsItem.groupId=groupId;dsItem.note='';dsItem.projId=AppConfig.projectId;dsItem.type=0;dsItem.value=ptName;arrItemList.push(dsItem);}}
postData.itemList=arrItemList;WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){var itemList=result.itemIdList;var bSuccess=false;if(itemList.length>0){bSuccess=true;}
if(bSuccess||!_this.bPointHasId){if(bIsJump){var pageTitle=$('#ulPages').children('li');if(Boolean(pageTitle)&&pageTitle.length>0){pageTitle.filter('.active').attr('class','');}
sessionStorage.setItem('dsOpenGroupId',groupId);ScreenManager.show(AnalysisScreen);}
_this.$modal.modal('hide');}else{alert(I18n.resource.dashboard.modalJumpPages.FAIL_TIPS);}}).always(function(e){});};ModalAppendPointToDs.prototype.importFunc=function(bIsJump){var arrPoint=[];var nSelChkNum=0;var $checkBox=_this.$divPtList.find('input');for(var i=0,len=$checkBox.length;i<len;i++){if($checkBox[i].checked){arrPoint.push({id:$checkBox[i].value,name:$checkBox.eq(i).parent().text()});nSelChkNum++;}}
if(arrPoint<=0){alert(I18n.resource.dashboard.modalJumpPages.NO_FIT_POINT);return;}
var selGroupVal=_this.$selGroup.find("option:selected")[0].value;if('new'==selGroupVal){var groupName=_this.$inputNewGroup.val();if(''==groupName){alert('Please input group name !');_this.$inputNewGroup.focus();return;}
var postData={'groupId':'','name':groupName,'parent':'','userId':AppConfig.userId};WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if(!data.error){return;}
var groupId=data.groupId;var groupItem={alias:data.groupName,id:groupId,isParent:true,note:'',num:nSelChkNum,parentId:'',projId:0,type:0,value:''};_this.groupInfo.push(groupItem);_this.insertItemIntoGroup(groupId,arrPoint,bIsJump);}).always(function(e){});}else{_this.insertItemIntoGroup(selGroupVal,arrPoint,bIsJump);}};return ModalAppendPointToDs;}();var ModalInteractCfgPanel=function(){var _this;function ModalInteractCfgPanel(parent){_this=this;_this.$modalParent=parent;_this.modalId=parent.modalId;_this.option=parent.modal.option;}
ModalInteractCfgPanel.prototype.show=function(){var domPanelContent=document.getElementById('paneCenter');if(domPanelContent){Spinner.spin(domPanelContent);}
WebAPI.get('/static/views/observer/widgets/modalInteractCfgPanel.html').done(function(html){_this.$wrap=$('<div class="modal-db-history-wrap" id="modalInteractCfgPanelWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this.$modal.modal('show');_this.init();}).always(function(e){Spinner.stop();});};ModalInteractCfgPanel.prototype.init=function(){I18n.fillArea(_this.$modal);_this.$selMode=$('#selMode',this.$modal);_this.$selInter=$('#selInterval',this.$modal);_this.$divTmRange=$('#divTmRange',this.$modal);_this.$inputStart=$('#tmStart',this.$modal);_this.$inputEnd=$('#tmEnd',this.$modal);_this.$divTmLast=$('#divTmLast',this.$modal);_this.$inputPerVal=$('#inputPeriodValue',this.$modal);_this.$selPerUnit=$('#selPeriodUnit',this.$modal);_this.$btnOk=$('#btnOk',this.$modal);_this.attachEvents();};ModalInteractCfgPanel.prototype.attachEvents=function(){_this.$selMode.change(function(e){var $opt=_this.$selInter.children('option');var flag=$(e.currentTarget).val();switch(flag){case'fixed':$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$divTmRange.css('display','inline-block');_this.$divTmLast.css('display','none');break;case'recent':$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','none');$opt.eq(4).css('display','none');_this.$divTmRange.css('display','none');_this.$divTmLast.css('display','inline-block');var temp=_this.$selInter.val();if('d1'==temp||'M1'==temp){_this.$selInter.val('h1');}
break;default:break;}});var tmNow=new Date();var tmStart=new Date();tmStart.setFullYear(tmNow.getFullYear()-10);_this.$inputStart.val(tmNow.format('yyyy-MM-dd HH:mm'));_this.$inputStart.css({backgroundColor:'#f4f6f8',border:'1px solid #27334b',color:'#646464',borderRadius:'0.5em 0 0 0.5em',marginRight:'-5px'});_this.$inputStart.datetimepicker('remove');_this.$inputStart.datetime({initialDate:tmNow,startDate:tmStart,endDate:tmNow});_this.$inputEnd.val(tmNow.format('yyyy-MM-dd HH:mm'));_this.$inputEnd.css({backgroundColor:'#f4f6f8',border:'1px solid #27334b',color:'#646464',borderRadius:'0 0.5em 0.5em 0'});_this.$inputEnd.datetimepicker('remove');_this.$inputEnd.datetime({initialDate:tmNow,startDate:tmStart,endDate:tmNow});_this.$btnOk.off().click(function(e){var tmMode=_this.$selMode.val();var strStart,strEnd;if('fixed'==tmMode){strStart=_this.$inputStart.val();strEnd=_this.$inputEnd.val();}else if('recent'==tmMode){var tmStart=new Date();var periodVal=parseInt(_this.$inputPerVal.val());if(!periodVal){alert('Please input time !');return;}
var periodUnit=_this.$selPerUnit.val();switch(periodUnit){case'hour':var time=tmNow.getTime()-3600000*periodVal;tmStart.setTime(time);break;case'day':var time=tmNow.getTime()-86400000*(periodVal-1);tmStart.setTime(time);tmStart.setHours(0);tmStart.setMinutes(0);break;case'month':var month=tmNow.getMonth();if(0==month){tmStart.setFullYear(tmNow.getFullYear()-1);tmStart.setMonth(11);}else{tmStart.setMonth(month-1);}
break;default:break;}
strStart=tmStart.format('yyyy-MM-dd HH:mm:00');tmNow.setHours(23);tmNow.setMinutes(59);strEnd=tmNow.format('yyyy-MM-dd HH:mm:00');}else{alert('Please select mode !');return;}
if(_this.modalId){for(var i=0;i<_this.$modalParent.arrModal.length;i++){var item=_this.$modalParent.arrModal[i];if(item){if(_this.modalId==item.id){if(!item.modal.option){item.modal.option={};item.modal.option.dictPtStatus={};}
item.modal.option.timeMode=tmMode;item.modal.option.interval=_this.$selInter.val();item.modal.option.timeStart=strStart;item.modal.option.timeEnd=strEnd;item.modal.option.periodVal=periodVal;item.modal.option.periodUnit=periodUnit;if('recent'==tmMode){item.interval=1000;}else{item.interval=null;}
break;}}}}
_this.$modalParent.screen.saveLayoutOnly();_this.$modalParent.drawChartsEx(item.modal.option,_this.modalId);});if(_this.option){_this.$selMode.val(_this.option.timeMode);_this.$selInter.val(_this.option.interval);_this.$inputStart.val(_this.option.timeStart);_this.$inputEnd.val(_this.option.timeEnd);_this.$inputPerVal.val(_this.option.periodVal);_this.$selPerUnit.val('day');if('recent'==_this.option.timeMode){_this.$selMode.change();}}};return ModalInteractCfgPanel;}();var DiagnosisInfo=function(){var _this;function DiagnosisInfo(){this.diagnosisDetailInfo=undefined;this.$disgnosisDetailInfoModal=undefined;_this=this;}
DiagnosisInfo.prototype={show:function show(diagnosisDetailInfo){var _this=this;this.diagnosisDetailInfo=diagnosisDetailInfo;WebAPI.get("/static/views/observer/diagnosis/diagnosisInfo.html").done(function(resultHtml){_this.$disgnosisDetailInfoModal=$('#disgnosisDetailInfoModal');if(_this.$disgnosisDetailInfoModal.length===0){_this.diagnosisDetailInfo.containerScreen.append(resultHtml);_this.$disgnosisDetailInfoModal=$('#disgnosisDetailInfoModal');}else{_this.$disgnosisDetailInfoModal.find('.diagnosisTable tbody').html('');}
I18n.fillArea(_this.$disgnosisDetailInfoModal);_this.$disgnosisDetailInfoModal.modal('show');_this.$disgnosisDetailInfoModal.find('h4.modal-title').text(_this.diagnosisDetailInfo.faultName);var timeFormatStr=timeFormatChange('yyyy-mm-dd hh');$('#startTimeCog').datetimepicker({format:timeFormatStr+":00:00",autoclose:true,minView:1,startView:2,forceParse:false}).val(new Date(new Date().valueOf()-86400000*7).timeFormat(timeFormatChange('yyyy-mm-dd'))+' 00:00:00');$('#endTimeCog').datetimepicker({format:timeFormatStr+":00:00",autoclose:true,minView:1,forceParse:false,startView:2}).val(new Date().timeFormat(timeFormatStr)+':00:00');_this.init();_this.addEvents();Spinner.stop();});},close:function close(){this.diagnosisDetailInfo=null;this.$disgnosisDetailInfoModal.empty().remove();this.$disgnosisDetailInfoModal=null;},addEvents:function addEvents(){var _this=this;$('#checkDiagnosis').off('click').click(function(){_this.$disgnosisDetailInfoModal.find('.diagnosisTable tbody').html('');var diagType=$(_this.diagnosisDetailInfo.containerScreen.context).find('.diagRanking').attr('data-type');var startTime=timeFormat($('#startTimeCog').val(),'yyyy-mm-dd hh:ii:ss');var endTime=timeFormat($('#endTimeCog').val(),'yyyy-mm-dd hh:ii:ss');if(new Date(startTime).valueOf()>new Date(endTime).valueOf()){alert(I18n.resource.modalConfig.modalApp.TIME_ERROR);return;}
Spinner.spin($('#disgnosisDetailInfoModal')[0]);var postData={value:_this.diagnosisDetailInfo.faultName,type:diagType,startTime:startTime,endTime:endTime,projId:AppConfig.projectId};WebAPI.post('/diagnosis/getFaultDetails',postData).done(function(faultDetailCl){_this.diagnosisDetailInfo.faultDetailData=faultDetailCl.data;_this.init();Spinner.stop();});});},init:function init(){var _this=this;var detailInfoData=_this.diagnosisDetailInfo.faultDetailData;var timeIntervalObj=_this.timeInterval();function unique(arr){var result=[],hash={};for(var i=0,elem;(elem=arr[i])!=null;i++){if(!hash[elem]){result.push(elem);hash[elem]=true;}}
return result;}
function spectrumCreate(detailInfoData){var spectrumDiv='';function spectrumDivChild(faultTimeArr){var faultTimeArrTime=unique(faultTimeArr.time);var faultTimeArrCount=faultTimeArr.counts;var spectrumDivCh='';for(var p=0;p<faultTimeArrTime.length;p++){var cuerH=parseInt(faultTimeArrTime[p].split(' ')[1]);spectrumDivCh+='<div class="spectrumDivCh" title="'+timeFormat(faultTimeArrTime[p]+':00:00',timeFormatChange('yyyy-mm-dd hh:ii:ss'))+'('+faultTimeArrCount[p]+')'+'" style="width:'+100/24+'%;height:26px;display:inline-block;background:rgba(193, 33, 33, 0.8);position:absolute;top:0;left:'+100*(cuerH-1)/24+'%"></div>';}
return spectrumDivCh;}
for(var m=0;m<timeIntervalObj.length;m++){var detailInfoI=timeIntervalObj[m];var faultTimeArr={};faultTimeArr['time']=[];faultTimeArr['counts']=[];for(var n=0;n<detailInfoI.length;n++){var count=0;var hourPrimTime=detailInfoI[n].split(' ')[0]+' '+detailInfoI[n].split(' ')[1].split(':')[0];for(var k=0;k<detailInfoData.arrNoticeTime.length;k++){var noticeTime=detailInfoData.arrNoticeTime[k].Time;var hourCompaTime=noticeTime.split(' ')[0]+' '+noticeTime.split(' ')[1].split(':')[0];if(hourPrimTime==hourCompaTime){count=count+1;faultTimeArr.time.push(hourPrimTime);}}
if(count!==0){faultTimeArr.counts.push(count);}}
if(m%2===0){spectrumDiv+='<div class="spectrumDiv" title="'+timeFormat(detailInfoI[0].split(' ')[0],timeFormatChange('yyyy-mm-dd'))+'" style="width:'+100/timeIntervalObj.length+'%;background:-webkit-linear-gradient(top,#f0f4fb,#e4ecf9);position:relative">'+spectrumDivChild(faultTimeArr)+'</div>';}else{var evenColor='-webkit-linear-gradient(top,#ffffff,#f0f4fb)';spectrumDiv+='<div class="spectrumDiv" title="'+timeFormat(detailInfoI[0].split(' ')[0],timeFormatChange('yyyy-mm-dd'))+'" style="width:'+100/timeIntervalObj.length+'%;background:-webkit-linear-gradient(top,#ffffff,#f0f4fb);position:relative">'+spectrumDivChild(faultTimeArr)+'</div>';}}
return spectrumDiv;}
var rankType=$(_this.diagnosisDetailInfo.containerScreen.context).find('.diagRanking').attr('data-type');var diagnosisHead='';if(rankType==='equipment'){diagnosisHead='<tr">\
                        <th  width="20%">'+I18n.resource.modalConfig.modalApp.ZONE+'</th>\
                        <th width="20%">'+I18n.resource.modalConfig.modalApp.TIMES+'</th>\
                        <th>'+I18n.resource.modalConfig.modalApp.FREQUENCY+'</th>\
                        </tr>';}else if(rankType==='zone'){diagnosisHead='<tr">\
                        <th  width="30%">'+I18n.resource.modalConfig.modalApp.ZONE+'</th>\
                        <th>'+I18n.resource.modalConfig.modalApp.FREQUENCY+'</th>\
                        </tr>';}else{diagnosisHead='<tr">\
                        <th  width="15%">'+I18n.resource.modalConfig.modalApp.ZONE+'</th>\
                        <th  width="15%">'+I18n.resource.modalConfig.modalApp.EQUIPMENT+'</th>\
                        <th width="15%">'+I18n.resource.modalConfig.modalApp.TIMES+'</th>\
                        <th>'+I18n.resource.modalConfig.modalApp.FREQUENCY+'</th>\
                        </tr>';}
_this.$disgnosisDetailInfoModal.find('.diagnosisTable thead').html('');_this.$disgnosisDetailInfoModal.find('.diagnosisTable thead').append(diagnosisHead);for(var i=0;i<detailInfoData.length;i++){var diagnosisDetailTr='';if(rankType==='equipment'){diagnosisDetailTr='<tr class="diagnosisDetailTr" data-faultId="'+detailInfoData[i].FaultId+'">\
                        <td>'+detailInfoData[i].SubBuildingName+'</td>\
                        <td>'+detailInfoData[i].arrNoticeTime.length+'</td>\
                        <td class="spectrumCommen">'+spectrumCreate(detailInfoData[i])+'</td>\
                        </tr>';}else if(rankType==='zone'){diagnosisDetailTr='<tr class="diagnosisDetailTr" data-faultId="'+detailInfoData[i].FaultId+'">\
                        <td>'+detailInfoData[i].SubBuildingName+'</td>\
                        <td class="spectrumCommen">'+spectrumCreate(detailInfoData[i])+'</td>\
                        </tr>';}else{diagnosisDetailTr='<tr class="diagnosisDetailTr" data-faultId="'+detailInfoData[i].FaultId+'">\
                        <td>'+detailInfoData[i].SubBuildingName+'</td>\
                        <td>'+detailInfoData[i].EquipmentName+'</td>\
                        <td>'+detailInfoData[i].arrNoticeTime.length+'</td>\
                        <td class="spectrumCommen">'+spectrumCreate(detailInfoData[i])+'</td>\
                        </tr>';}
_this.$disgnosisDetailInfoModal.find('.diagnosisTable tbody').append(diagnosisDetailTr);}},hslOrRgb:function hslOrRgb(n){var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return[h,s,l];}
function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var hue2rgb=function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
var colorBasic='#055197';var rgb=colorBasic.colorRgb().split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var hsl=rgbToHsl(r,g,b);var hslCo;if(n===0){hsl[2]=1;}else if(n===1){hsl[2]=0.92;hslCo=0.88;}else{hsl[2]=96-n*3<10?10:96-n*3;hsl[2]=hsl[2]/100;hslCo=96-n*5<10?10:96-n*5;hslCo=hslCo/100;}
var rgbStartColor=hslToRgb(hsl[0],hsl[1],hsl[2]);var rgbStartColor1=hslToRgb(hsl[0],hsl[1],hslCo);if(n===0){return'-webkit-linear-gradient(top,#f0f4fb,#e4ecf9)';}else{return'rgba(193, 33, 33, 0.8)';}},timeInterval:function timeInterval(){var timeIntervalObj={};var startTimeCogVal=timeFormat($('#startTimeCog').val(),'yyyy-mm-dd hh:ii:ss');var endTimeCogVal=timeFormat($('#endTimeCog').val(),'yyyy-mm-dd hh:ii:ss');var startYear=parseInt(startTimeCogVal.split('-')[0]);var startMonth=parseInt(startTimeCogVal.split('-')[1]);var startDay=parseInt(startTimeCogVal.split(' ')[0].split('-')[2]);var endYear=parseInt(endTimeCogVal.split('-')[0]);var endMonth=parseInt(endTimeCogVal.split('-')[1]);var endDay=parseInt(endTimeCogVal.split(' ')[0].split('-')[2]);var startHour=parseInt(startTimeCogVal.split(' ')[1].split(':')[0]);startHour=startHour===0?24:startHour;var endHour=parseInt(endTimeCogVal.split(' ')[1].split(':')[0]);endHour=endHour===0?24:endHour;var monthLength=0;var monthArrCount=[];var monthDayArr=[];if(new Date(startTimeCogVal).valueOf()>new Date(endTimeCogVal).valueOf()){alert(I18n.resource.modalConfig.modalApp.TIME_ERROR);return;}
if(endYear-startYear>1){alert(I18n.resource.modalConfig.modalApp.TIME_INTERVAL);return;}else{if(startMonth===endMonth){if(startDay===endDay){var monthDay=[];startHour=startHour===24?0:startHour;var intervalHour=endHour-startHour;monthLength+=intervalHour+1;for(var i=0;i<=intervalHour;i++){var currentTimes;var startHourF=startHour+i>9?startHour+i:'0'+(startHour+i).toString();if(startHourF===24){startHourF='00';currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+1>9?startDay+1:'0'+(startDay+1).toString())+' '+startHourF+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay>9?startDay:'0'+startDay.toString())+' '+startHourF+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);}else{startHour=startHour===24?0:startHour;var startDayHour=24-startHour+1;monthLength+=startDayHour;var monthDay=[];for(var i=0;i<startDayHour;i++){var currentTimes;var startDayHourF=startHour+i>9?startHour+i:'0'+(startHour+i).toString();if(startDayHourF===24){startDayHourF='00';currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+1>9?startDay+1:'0'+(startDay+1).toString())+' '+startDayHourF+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay>9?startDay:'0'+startDay.toString())+' '+startDayHourF+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);if(endDay-startDay>1){var intervalDays=endDay-startDay;for(var i=1;i<intervalDays;i++){var monthDays=[];monthLength+=24;for(var j=1;j<=24;j++){var currentTimes;var endHourCur=j>9?j:'0'+j.toString();if(endHourCur===24){endHourCur='00';currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+i+1>9?startDay+i+1:'0'+(startDay+i+1).toString())+' '+endHourCur+':00:00';monthArrCount.push(currentTimes);monthDays.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+i>9?startDay+i:'0'+(startDay+i).toString())+' '+endHourCur+':00:00';monthArrCount.push(currentTimes);monthDays.push(currentTimes);}}
monthDayArr.push(monthDays);}}
var monthDayss=[];monthLength+=endHour;if(endHour===1){monthArrCount.push(startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+'01:00:00');monthDayss.push(startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+'01:00:00');}else{for(var i=1;i<=endHour;i++){var currentTimes;var endHourCue=i>9?i:'0'+i.toString();if(endHourCue===24){endHourCue='00';currentTimes=startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(endDay+1>9?endDay+1:'0'+(endDay+1).toString())+' '+endHourCue+':00:00';monthArrCount.push(currentTimes);monthDayss.push(currentTimes);}else{currentTimes=startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+endHourCue+':00:00';monthArrCount.push(currentTimes);monthDayss.push(currentTimes);}}}
monthDayArr.push(monthDayss);}}else{startHour=startHour===24?0:startHour;var startDayHour=24-startHour+1;monthLength+=startDayHour;var monthDays=[];for(var i=0;i<startDayHour;i++){var startDayHourF=startHour+i>9?startHour+i:'0'+(startHour+i).toString();var currentTimes;if(startDayHourF===24){startDayHourF='00';currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+1>9?startDay+1:'0'+(startDay+1).toString())+' '+startDayHourF+':00:00';monthArrCount.push(currentTimes);monthDays.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay>9?startDay:'0'+startDay.toString())+' '+startDayHourF+':00:00';monthArrCount.push(currentTimes);monthDays.push(currentTimes);}}
monthDayArr.push(monthDays);var startMonthDCount=new Date(startYear,startMonth,0).getDate();var intervalDay=startMonthDCount-startDay;for(var i=1;i<=intervalDay;i++){var monthDay=[];var pushStartDay=startDay+i>9?startDay+i:'0'+(startDay+i).toString();var pushStartDay1=startDay+i+1>9?startDay+i+1:'0'+(startDay+i+1).toString();monthLength+=24;for(var j=1;j<=24;j++){var currentTimes;var pushDayHourCound=j>9?j:'0'+j.toString();if(pushDayHourCound===24){pushDayHourCound='00';if(pushStartDay1>startMonthDCount){startMonth=startMonth+1;pushStartDay1='01';}
currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+pushStartDay1+' '+pushDayHourCound+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+pushStartDay+' '+pushDayHourCound+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);}
var startMonthArr=endMonth-startMonth;if(endMonth-startMonth>1){var monthHourArr=endMonth-startMonth;for(var i=1;i<monthHourArr;i++){var currentMonths=startMonth+i>9?startMonth+i:'0'+(startMonth+i).toString();var currentMonthDays=new Date(startYear,currentMonths,0).getDate();for(var j=1;j<=currentMonthDays;j++){var monthDay=[];var currentMonthDay=j>9?j:'0'+j.toString();var currentMonthDay1=j+1>9?j+1:'0'+(j+1).toString();monthLength+=24;for(var k=1;k<=24;k++){var currentTimes;var currentMonthDayHour=k>9?k:'0'+k.toString();if(currentMonthDayHour===24){currentMonthDayHour='00';currentTimes=startYear+'-'+currentMonths+'-'+currentMonthDay1+' '+currentMonthDayHour+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+currentMonths+'-'+currentMonthDay+' '+currentMonthDayHour+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);}}}
var endMonthGe=endMonth>9?endMonth:'0'+endMonth.toString();for(var i=1;i<endDay;i++){var monthDay=[];var currendEndDay=i>9?i:'0'+i.toString();var currendEndDay1=i+1>9?i+1:'0'+(i+1).toString();monthLength+=24;for(var j=1;j<=24;j++){var currentTimes;var currentEndDayHours=j>9?j:'0'+j.toString();if(currentEndDayHours===24){currentEndDayHours='00';currentTimes=startYear+'-'+endMonthGe+'-'+currendEndDay1+' '+currentEndDayHours+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+endMonthGe+'-'+currendEndDay+' '+currentEndDayHours+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);}
monthLength+=endHour;var monthDayF=[];if(endHour===1){monthArrCount.push(startYear+'-'+endMonthGe+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+'01:00:00');monthDayF.push(startYear+'-'+endMonthGe+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+'01:00:00');}else{for(var i=1;i<=endHour;i++){var currentTimes=startYear+'-'+endMonthGe+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+(i>9?i:'0'+i.toString())+':00:00';monthArrCount.push(currentTimes);monthDayF.push(currentTimes);}}
monthDayArr.push(monthDayF);}}
timeIntervalObj['timeIntervalCount']=monthLength;timeIntervalObj['timeIntervalArr']=monthArrCount;for(var k=0;k<monthDayArr.length-1;k++){var arrFirst=monthDayArr[k].pop();monthDayArr[k+1].splice(0,0,arrFirst);}
return monthDayArr;}};return DiagnosisInfo;}();var ObserverScreen=function(){var tObscreen=null;function ObserverScreen(id){this.id=id;this.container=undefined;this.$obCanvasContainer=undefined;this.$canvasContainer=undefined;this.canvas=undefined;this.ctx=undefined;this.cacheCanvas=undefined;this.cacheCtx=undefined;this.hitModel=undefined;this.workerUpdate=undefined;this.isRunning=true;this.store={};this.dictRefreshMap=undefined;this.stopWatch=undefined;this.dictPipelines=undefined;this.dictEquipments=undefined;this.dictCharts=undefined;this.dictGages=undefined;this.dictRulers=undefined;this.dictButtons=undefined;this.dictCheckboxs=undefined;this.dictTexts=undefined;this.dictTempDistributions=undefined;this.dictRects=undefined;this.dictImages={};this.indexImageLoaded=0;this.isDetailPage=false;this.dialogTitle=undefined;this.isDataReady=false;this.isPlayback=false;this.toolContainer=undefined;}
ObserverScreen.prototype={show:function show(container){var _this=this;if(_this.isDetailPage){_this.container=ElScreenContainer;_this.initContainer();Spinner.spin(_this.container);_this.init();}else{(function(){var initHtml=function initHtml(){Spinner.spin(_this.container);_this.init();I18n.fillArea($(_this.container));};_this.container=container||_this.container;if(_this.container){_this.initContainer();initHtml(_this.container);}else{_this.container=ElScreenContainer;WebAPI.get("/static/views/observer/observerScreen.html").done(function(resultHtml){$(_this.container).html(resultHtml);_this.initContainer();initHtml();});}})();}},initContainer:function initContainer(){if(this.container===ElScreenContainer){this.$obCanvasContainer=$('#divObserverCanvas');this.$canvasContainer=$('#canvasOverview');}else{this.$obCanvasContainer=$('.div-canvas-ctn',$(this.container));this.$canvasContainer=$('.canvas-ctn',$(this.container));}},close:function close(){$('.observer-text-editor').remove();ModelText.destroy();$('.toolBacktrace').remove();if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;for(var item in this.dictCharts){this.dictCharts[item].close();}this.isRunning=null;this.canvas=null;this.ctx=null;this.cacheCanvas=null;this.store=null;this.dictRefreshMap=null;this.dictPipelines=null;this.dictGages=null;this.dictRulers=null;this.dictEquipments=null;this.dictButtons=null;this.dictTexts=null;this.dictCheckboxs=null;this.dictImages=null;this.dictRects=null;this.hitModel=null;this.stopWatch=null;if(!this.isDetailPage){$('#ulTools').html('');if(ToolCurrent)ToolCurrent.close();ToolCurrent=null;}
$('#btnTemperatureSetting').hide().eventOff('click');},stop:function stop(){this.isRunning=false;if(this.workerUpdate){this.workerUpdate.terminate();this.workerUpdate=null;}},resume:function resume(){this.isRunning=true;this.initWorkerForUpdating();requestAnimationFrame(animate);},resize:function resize(){this.initScreen();this.renderElements();if(this.workerUpdate){this.workerUpdate.terminate();this.initWorkerForUpdating();}},onresize:function onresize(){ScreenCurrent.resize();},init:function init(){var _this=this;WebAPI.get("/get_plant/"+AppConfig.projectId+"/"+this.id+"/"+AppConfig.userId).done(function(result){_this.store=result;_this.initScreen();if(!_this.isDetailPage&&!_this.isInDashBoard)_this.initToolBar();_this.initImageDictionary();_this.renderElements();if(_this.isPlayback){ToolCurrent.requestDataForCurrentMoment(_this);}else{_this.initWorkerForUpdating();}
_this.initAnimation();}).error(function(e){alert(I18n.resource.observer.widgets.DATA_REQUEST_FAILED);Spinner.stop();});},renderElements:function renderElements(){this.hitModel=new HitModel(this.canvas);this.dictRefreshMap={};this.initPipelines();this.initEquipments();this.initCharts();this.initGages();this.initRulers();this.initCheckboxs();this.initButtons();this.initTexts();this.initTempDistribution();this.initRects();this.initHitModel();},initToolBar:function initToolBar(ins){var _this=!ins?this:ins;var $ele=$('#btnDropdownNavList').find('.toolBacktrace');if($ele.length>0){$ele.remove();}
this.toolContainer=$('#divObserverTools');var btnTimeShaft=$('<li class="iconWrap"><a><span class="glyphicon glyphicon-play-circle"></span><span class="dropdownNav"></span></a></li>').addClass('toolBacktrace');btnTimeShaft.find('.dropdownNav').text(I18n.resource.observer.widgets.BACKTRACE);btnTimeShaft.click(function(e){if(_this.isPlayback){_this.quitBacktraceMode(_this,e);}else{_this.enterBacktraceMode(_this,e);}});$('#ulTools').html('');$('#right-nav').find('#btnOperatingRecord').after(btnTimeShaft);if(_this.isInDiagnosis&&!_this.isPlayback)ToolCurrent=new TimeShaft(_this);},enterBacktraceMode:function enterBacktraceMode(screen,e){var _this=screen?screen:this;_this.isPlayback=true;if(e){e.currentTarget.classList.add('selected');}
if(!ToolCurrent)ToolCurrent=new TimeShaft(_this);ToolCurrent.containerHeight=100;ToolCurrent.show();if(_this.workerUpdate){this.workerUpdate.terminate();this.workerUpdate=null;}
$.when(ToolCurrent.defer).done(function(){var jCanvas=_this.$obCanvasContainer;jCanvas.css({height:'100%',width:'100%'});var jParent=jCanvas.parent();var height=jCanvas.height()-ToolCurrent.containerHeight;var width=height*_this.canvas.width/_this.canvas.height;if(width>jParent.width()){width=jParent.width();height=width/(_this.canvas.width/_this.canvas.height);}
jCanvas.animate({height:height,width:width,marginTop:(jParent.height()-height-ToolCurrent.containerHeight)/2+'px'},400,function(){_this.initScreen();_this.renderElements();});});},quitBacktraceMode:function quitBacktraceMode(screen,e){var _this=screen?screen:this;_this.isPlayback=false;if(e){e.currentTarget.classList.remove('selected');}
ToolCurrent.close();ToolCurrent=null;_this.$obCanvasContainer.animate({height:'100%',width:'100%'},300,function(){_this.initScreen();_this.renderElements();_this.initWorkerForUpdating();});},initScreen:function initScreen(){var _this2=this;this.isDetailPage=this.store.page.type!="fullscreen"&&!this.isInDashBoard;if(this.isDetailPage){var _this;var dialogWidth;var detailScreenModal;var $toolBacktrace;var oldDialogTitle;var paddingLeft;var paddingTop;(function(){var convertPositionToReal=function convertPositionToReal(arr){if(arr){for(var i=0;i<arr.length;i++){var temp=arr[i];temp.x=temp.x-paddingLeft;temp.y=temp.y-paddingTop;}}};var convertTempDistributionsToReal=function convertTempDistributionsToReal(dis){if(!dis){return;}
dis.x-=paddingLeft;dis.y-=paddingTop;convertPositionToReal(dis.data);};_this=_this2;dialogWidth=_this2.store.page.width+40>$(window).width()?$(window).width()-200:_this2.store.page.width+40;detailScreenModal=$('#detailScreenModal');$toolBacktrace=$('.toolBacktrace');I18n.fillArea($('#detailScreenModal'));$toolBacktrace.remove();if(_this2.dialogTitle){oldDialogTitle=detailScreenModal.find('.modal-title').text();detailScreenModal.find('.modal-title').text(_this2.dialogTitle);}
detailScreenModal.find('.modal-dialog').css("margin","0 auto 0 auto").css("width",dialogWidth);detailScreenModal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){if(ScreenModal){ScreenModal.close();ScreenModal=null;}
if(_this.diagScreen&&_this.diagScreen.ScreenModal){if(_this.diagScreen.obScreen){_this.diagScreen.obScreen=new ObserverScreen(_this.diagScreen.obScreen.id);_this.diagScreen.initObScreen();_this.diagScreen.obScreen.show(_this.diagScreen.$obContainer[0]);}
_this.diagScreen.ScreenModal.close();_this.diagScreen.ScreenModal=null;}
_this.initToolBar(tObscreen);Spinner.stop();oldDialogTitle&&$(this).find('.modal-title').text(oldDialogTitle);}).modal();Spinner.spin(detailScreenModal.find('.modal-body')[0]);paddingLeft=(1920-_this2.store.page.width)/2;paddingTop=(955-_this2.store.page.height)/2;convertPositionToReal(_this2.store.equipments);convertPositionToReal(_this2.store.buttons);convertPositionToReal(_this2.store.texts);convertTempDistributionsToReal(_this2.store.tempDistributions);})();}else{if(ScreenModal&&!this.isInDiagnosis){if(ScreenCurrent)ScreenCurrent.close();ScreenCurrent=ScreenModal;ScreenModal=null;}
if(this.isInDiagnosis)this.diagScreen.obScreen=this;tObscreen=this;$("#page-"+this.id).parent().addClass("active");if(!this.isPlayback){$('.div-canvas-ctn').css({marginTop:0});}}
if(this.isDetailPage){this.canvas=document.getElementById("canvasDetail");}else{this.canvas=this.$canvasContainer[0];}
this.ctx=this.canvas.getContext("2d");this.canvas.width=this.store.page.width;this.canvas.height=this.store.page.height;},initWorkerForUpdating:function initWorkerForUpdating(){if(this.workerUpdate){this.workerUpdate.terminate();}
this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e);},true);this.workerUpdate.postMessage({projectId:AppConfig.projectId,id:this.id,pointList:Object.keys(this.dictRefreshMap),type:"dataRealtime"});},initAnimation:function initAnimation(){var _this=this;this.stopWatch=new Stopwatch();this.stopWatch.start();requestAnimationFrame(animate);function animate(){if(_this.isRunning){_this.ctx.clearRect(0,0,_this.canvas.width,_this.canvas.height);var item,element,time=_this.stopWatch.getElapsedTime();for(item in _this.dictPipelines){element=_this.dictPipelines[item];element.update(_this.ctx,250);}
for(item in _this.dictEquipments){element=_this.dictEquipments[item];element.update(null,time);element.refreshImage(_this.store.animationList,_this.dictImages);}
for(var i=0;i<10;i++){for(item in _this.dictPipelines){element=_this.dictPipelines[item];if(element.layer==i)element.paint(_this.ctx);}
for(item in _this.dictEquipments){element=_this.dictEquipments[item];if(element.layer==i)element.paint(_this.ctx);}
for(item in _this.dictButtons){element=_this.dictButtons[item];if(element.layer==i)element.paint(_this.ctx);}
for(item in _this.dictTexts){element=_this.dictTexts[item];if(element.layer==i)element.paint(_this.ctx);}
for(item in _this.dictTempDistributions){element=_this.dictTempDistributions[item];if(element.layer==i)element.paint(_this.ctx);}
for(item in _this.dictRects){element=_this.dictRects[item];if(element.layer==i)element.paint(_this.ctx);}}
for(item in _this.dictCharts){_this.dictCharts[item].paint(_this.ctx);}
for(item in _this.dictGages){_this.dictGages[item].paint(_this.ctx);}
for(item in _this.dictRulers){_this.dictRulers[item].paint(_this.ctx);}
for(item in _this.dictCheckboxs){_this.dictCheckboxs[item].paint(_this.ctx);}
for(item in _this.dictTempDistributions){_this.dictTempDistributions[item].createHeatRuler(_this.ctx);}
requestAnimationFrame(animate);}}},initHitModel:function initHitModel(){var _this=this;var $canvas=this.isDetailPage?$("#canvasDetail"):this.$canvasContainer;if(_this.canvas.scrollWidth>0){_this.hitModel.scaleX=_this.store.page.width/_this.canvas.scrollWidth;_this.hitModel.scaleY=_this.store.page.height/_this.canvas.scrollHeight;}
$canvas.off('click').click(function(e){if(!_this.hitModel)return;var result=_this.hitModel.firstHitId(e.clientX,e.clientY,null);if(result&&result.id&&result.id!=""){var item=_getHitModelItem(result.type,result.id);item&&item.mouseDown&&item.mouseDown(e);if(item instanceof ModelRuler.ModelRulerCurrentReference){console.log('click ModelRulerCurrentReference');}else if(item instanceof ModelText){console.log('click ModelText');}else{if(item&&item.link!=undefined){_this.showDetailDialog(item.link,item.name);}else{new OperatingPane(item.idCom,item.setValue,item.description,_this).show();}}}
e.preventDefault();});var _getHitModelItem=function _getHitModelItem(type,id){var item;switch(Number(type)){case _this.enmuElementType.equipment:item=_this.dictEquipments[id];break;case _this.enmuElementType.button:item=_this.dictButtons[id];break;case _this.enmuElementType.ruler:var index_array=id.split('_');if(!index_array||index_array.length!=2){item=null;break;}
var rulerId=index_array[0],refIndex=index_array[1];item=_this.dictRulers[rulerId].references[refIndex];break;case _this.enmuElementType.text:item=_this.dictTexts[id];break;default:item=null;}
return item;};$canvas.mousemove(function(e){if(!_this.hitModel)return;var result=_this.hitModel.firstHitId(e.clientX,e.clientY,null);if(result&&result.id&&result.id!=""){_this.canvas.style.cursor="pointer";_this.hitModel.currentModel=result;var item=_getHitModelItem(result.type,result.id);item&&item.mouseEnter&&item.mouseEnter(e);}else{_this.canvas.style.cursor="auto";if(_this.hitModel.currentModel&&_this.hitModel.currentModel.id){var item=_getHitModelItem(_this.hitModel.currentModel.type,_this.hitModel.currentModel.id);item&&item.mouseOut&&item.mouseOut();_this.hitModel.currentModel=null;}}
e.preventDefault();});},renderData:function renderData(data){this.refreshData({data:data});},refreshData:function refreshData(e){var _this=this.self?this.self:this;if(e.data&&!e.data.error){var tempDistributionsUpdated={};for(var i=0;i<e.data.length;i++){var item=_this.dictRefreshMap[e.data[i].name];if(item){if(item.pipelines){for(var j=0;j<item.pipelines.length;j++){var pipline=_this.dictPipelines[item.pipelines[j]];pipline.dictIdCom[e.data[i].name]=e.data[i].value==1?true:false;}}
if(item.equipments){for(var j=0;j<item.equipments.length;j++){var equipment=_this.dictEquipments[item.equipments[j]];equipment.value=e.data[i].value;equipment.update(null,null);}}
if(item.charts){for(var j=0;j<item.charts.length;j++){_this.dictCharts[item.charts[j]].update(e.data[i].name,e.data[i].value);}}
if(item.gages){for(var j=0;j<item.gages.length;j++){_this.dictGages[item.gages[j]].update(e.data[i].value);}}
if(item.tempDistributions){for(var j=0;j<item.texts.length;j++){if(item.tempDistributions&&item.tempDistributions.length>0){if(!tempDistributionsUpdated[item.tempDistributions[j]]){tempDistributionsUpdated[item.tempDistributions[j]]=[];}
tempDistributionsUpdated[item.tempDistributions[j]].push(e.data[i]);_this.dictTexts[item.texts[j]].update(e.data[i].value,true);}else{_this.dictTexts[item.texts[j]].update(e.data[i].value);}}
continue;}
if(item.texts){for(var j=0;j<item.texts.length;j++){_this.dictTexts[item.texts[j]].update(e.data[i].value);}}
if(item.rulers){for(var j=0;j<item.rulers.length;j++){_this.dictRulers[item.rulers[j]].update(e.data[i].name,e.data[i].value);}}}}
for(var tempId in tempDistributionsUpdated){var tempUpdatedData=tempDistributionsUpdated[tempId];_this.dictTempDistributions[tempId].update(tempUpdatedData);}
for(var pointName in _this.dictCharts){var chart=_this.dictCharts[pointName];if(!chart.isRunning){chart.isRunning=true;chart.renderChart(chart);}}}else{}
_this.isDataReady=true;},initCanvasCache:function initCanvasCache(){this.cacheCanvas=document.createElement("canvas");this.cacheCtx=this.cacheCanvas.getContext("2d");this.cacheCanvas.width=this.canvas.width;this.cacheCanvas.height=this.canvas.height;var item,element;for(var i=0;i<10;i++){for(item in this.dictEquipments){element=this.dictEquipments[item];if((!element.idCom||element.idCom=="")&&element.layer==i)element.paint(this.cacheCtx);}
for(item in this.dictButtons){element=this.dictButtons[item];if((!element.idCom||element.idCom=="")&&element.layer==i)element.paint(this.cacheCtx);}}
for(item in this.dictTexts){element=this.dictTexts[item];if(!element.idCom||element.idCom=="")element.paint(this.cacheCtx);}},initImageDictionary:function initImageDictionary(){if(this.store.images){var item;for(var i=0;i<this.store.images.length;i++){item=this.store.images[i];this.addImageIntoRequestQueue(item);}}
if(this.store.animationImages){var item;for(var i=0;i<this.store.animationImages.length;i++){item=this.store.animationImages[i];this.addImageIntoRequestQueue("animation_"+item);}}
var _this=this;var interval=setInterval(function(e){var isCompleted=true;for(var key in _this.dictImages){if(!_this.dictImages[key].complete){isCompleted=false;break;}}
if(isCompleted&&_this.isDataReady){clearInterval(interval);Spinner.stop();}},300);},initPipelines:function initPipelines(){this.dictPipelines={};if(this.store.pipelines){var item,tempLine;for(var i=0;i<this.store.pipelines.length;i++){item=this.store.pipelines[i];tempLine=new ModelPipeline(item.id,null,null);tempLine.x=parseInt(item.startX);tempLine.y=parseInt(item.startY);tempLine.startX=parseInt(item.startX);tempLine.startY=parseInt(item.startY);tempLine.endX=parseInt(item.endX);tempLine.endY=parseInt(item.endY);tempLine.lineWidth=parseInt(item.width);tempLine.direction=item.direction=="1"?false:true;tempLine.speed=1;tempLine.layer=item.layer;tempLine.waterType=item.waterType;tempLine.color=item.color;if(item.idCom&&item.idCom.toString()!=""){tempLine.idCom=item.idCom;var arr=item.idCom.split(',');for(var j=0;j<arr.length;j++){if(arr[j]&&arr[j].toString()!=""){tempLine.dictIdCom[arr[j]]=false;this.addElementIdIntoDictRefreshMap(arr[j],this.enmuElementType.pipeline,item.id);}}}
this.dictPipelines[item.id]=tempLine;}}},initEquipments:function initEquipments(){this.dictEquipments={};if(this.store.equipments){var item,tempEquip;for(var i=0;i<this.store.equipments.length;i++){item=this.store.equipments[i];tempEquip=new ModelEquipment(item.id,null,null);tempEquip.x=item.x;tempEquip.y=item.y;tempEquip.width=item.width;tempEquip.height=item.height;tempEquip.animation=item.animation;tempEquip.idCom=item.idCom;tempEquip.layer=item.layer;if(!item.isFromAnimation){tempEquip.image=this.dictImages[item.idPicture];}else{if(tempEquip.animation[0]){tempEquip.image=this.dictImages[tempEquip.animation[0].animationId];}}
if(item.rotate!="0.0")tempEquip.rotate=item.rotate;if(item.idCom&&item.id!="")this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.equipment,item.id);if(item.link>-1){tempEquip.link=item.link;this.hitModel.add(item.id,this.enmuElementType.equipment,item.x,item.y,item.width,item.height);}
this.dictEquipments[item.id]=tempEquip;}}},initCharts:function initCharts(){this.dictCharts={};function ChartFactory(elementType){var chart;switch(Number(elementType)){case 52:chart=LineChart;break;case 53:chart=BarChart;break;case 54:chart=PieChart;break;default:chart=LineChart;}
return chart;}
if(this.store.charts){var item,tempChart;for(var i=0;i<this.store.charts.length;i++){item=this.store.charts[i];var ElementChart=ChartFactory(item.elementType);tempChart=new ElementChart(item.id,null,null);tempChart.x=item.x;tempChart.y=item.y;tempChart.width=item.width;tempChart.height=item.height;tempChart.units=item.data;if(item.interval&&item.interval!='')tempChart.interval=item.interval;tempChart.init();for(var j=0;j<item.data.length;j++){this.addElementIdIntoDictRefreshMap(item.data[j].pointName,this.enmuElementType.chart,item.id);}this.dictCharts[item.id]=tempChart;}}},initGages:function initGages(){this.dictGages={};if(this.store.gages){var item,tempGage;for(var i=0;i<this.store.gages.length;i++){item=this.store.gages[i];tempGage=new ModelGage(item.id,null,null);tempGage.width=item.width;tempGage.height=item.height;tempGage.idCom=item.idCom;tempGage.minValue=item.min;tempGage.maxValue=item.max;if(item.pagetype==='floating'&&item.xposition&&item.yposition){tempGage.x=item.x-item.xposition;tempGage.y=item.y-item.yposition;}else{tempGage.x=item.x;tempGage.y=item.y;}
this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.gage,item.id);this.dictGages[item.id]=tempGage;}}},initRulers:function initRulers(){this.dictRulers={};if(this.store.rulers){var item,tempRuler;for(var i=0;i<this.store.rulers.length;i++){item=this.store.rulers[i];tempRuler=new ModelRuler(this,item.id,null,null);tempRuler.x=item.x;tempRuler.y=item.y;tempRuler.width=item.width;tempRuler.height=item.height;tempRuler.minValue=item.min;tempRuler.maxValue=item.max;tempRuler.name=item.name;tempRuler.decimal=item.decimal;tempRuler.mainScale=item.mainScale;tempRuler.minorScale=item.minorScale;for(var j=0;j<item.levels.length;j++){tempRuler.levels.push(item.levels[j]);}for(var j=0;j<item.references.length;j++){if(item.references[j].idCom!=""){this.addElementIdIntoDictRefreshMap(item.references[j].idCom,this.enmuElementType.ruler,item.id);}
tempRuler.references.push(item.references[j]);}
tempRuler.init();this.dictRulers[item.id]=tempRuler;for(var n=0,len=tempRuler.references.length;n<len;n++){var ref=tempRuler.references[n];Number(ref.isInUp)!==1&&ref.panel&&this.hitModel.add(item.id+'_'+n,this.enmuElementType.ruler,ref.panel.x,ref.panel.y,ref.panel.w,ref.panel.h);}}}},initButtons:function initButtons(){this.dictButtons={};if(this.store.buttons){var item,tempButton;for(var i=0;i<this.store.buttons.length;i++){item=this.store.buttons[i];tempButton=new ModelButton(item.id,null,null);tempButton.x=item.x;tempButton.y=item.y;tempButton.width=item.width;tempButton.height=item.height;tempButton.image=this.dictImages[item.comm];tempButton.imageComm=this.dictImages[item.comm];tempButton.imageOver=this.dictImages[item.over];tempButton.imageDown=this.dictImages[item.down];tempButton.imageDisable=this.dictImages[item.disable];tempButton.idCom=item.idCom;tempButton.setValue=item.setValue;tempButton.description=item.description;tempButton.layer=item.layer;tempButton.fontSize=item.fontSize;tempButton.fontColor=item.fontColor;if(item.text)tempButton.text=item.text;if(item.link>-1)tempButton.link=item.link;this.hitModel.add(item.id,this.enmuElementType.button,item.x,item.y,item.width,item.height);this.dictButtons[item.id]=tempButton;}}},initCheckboxs:function initCheckboxs(){this.dictCheckboxs={};if(this.store.checkboxs){var item,tempCheckbox;for(var i=0;i<this.store.checkboxs.length;i++){item=this.store.checkboxs[i];tempCheckbox=new ModelButton(item.id,null,null);tempCheckbox.x=item.x;tempCheckbox.y=item.y;tempCheckbox.width=item.width;tempCheckbox.height=item.height;tempCheckbox.layer=item.layer;tempCheckbox.idCom=item.idCom;tempCheckbox.type=item.type;tempCheckbox.fontColor=item.fontColor;tempCheckbox.fontSize=item.fontSize;tempCheckbox.setValue=item.setValue;tempCheckbox.unsetValue=item.unsetValue;tempCheckbox.text=item.text;tempCheckbox.idGroup=item.idGroup;tempCheckbox.expression=item.expression;this.dictCheckboxs[item.id]=tempCheckbox;}}},initTempDistribution:function initTempDistribution(){this.dictTempDistributions={};if(this.store.tempDistributions&&!!this.store.tempDistributions.data&&this.store.tempDistributions.data.length){var item,tempDistribution;item=this.store.tempDistributions;tempDistribution=new ModelTempDistribution(item.pageid,null,null);tempDistribution.layer=item.layer;tempDistribution.data=item.data;tempDistribution.width=item.width;tempDistribution.height=item.height;tempDistribution.x=item.x;tempDistribution.y=item.y;tempDistribution.heatType=item.heatType;tempDistribution.init();this.dictTempDistributions[item.pageid]=tempDistribution;for(var n=0,len=item.data.length;n<len;n++){var point=item.data[n];this.addElementIdIntoDictRefreshMap(point.idCom,this.enmuElementType.temperature,item.pageid);}
$("#btnTemperatureSetting").show().eventOff('click').eventOn('click',function(e){new TemperatureSetting(item.heatType).show();});}else if(this.id){tempDistribution=new ModelTempDistribution(this.id,null,null);tempDistribution.init();this.dictTempDistributions[this.id]=tempDistribution;}},initRects:function initRects(){var rects;this.dictRects={};if(this.store.rects&&this.store.rects.length){for(var i=0,row,len=this.store.rects.length;i<len;i++){row=this.store.rects[i];rects=new ModelRect(row.id,null,null);rects.x=parseInt(row.x);rects.y=parseInt(row.y);rects.width=parseInt(row.width);rects.height=parseInt(row.height);rects.layer=row.layer;this.dictRects[row.id]=rects;}}},initTexts:function initTexts(){var _this=this;var modalTextIds={};var dicEquipments,dicFaults,getErrData,getErrDataNew;if(this.isInDiagnosis){dicEquipments=this.diagScreen.dictEquipment;dicFaults=this.diagScreen.dictFault;getErrData=function getErrData(id){var data=[];for(var t in dicEquipments){if(dicEquipments[t].modalTextId===id){data=data.concat(dicEquipments[t].faultIds.concat());}}
return data;};if(AppConfig.projectId==80){getErrDataNew=function getErrDataNew(id){var dataNew=[];for(var t in dicEquipments){if(dicEquipments[t].modalTextId===id){if(dicEquipments[t].subSystemName){dataNew=dataNew.concat(dicEquipments[t].subSystemName);}else{continue;}}}
return dataNew;};}}
this.dictTexts={};if(this.isInDiagnosis){for(var i in dicEquipments){modalTextIds[dicEquipments[i].modalTextId]=dicEquipments[i].id;}}
if(this.store.texts){var item,tempText;for(var i=0;i<this.store.texts.length;i++){item=this.store.texts[i];tempText=new ModelText(item.id,null,null);tempText.x=item.x;tempText.y=item.y;tempText.width=item.width;tempText.height=item.height;tempText.value=item.text;tempText.fontSize=item.fontSize;tempText.decimalplace=item.decimalplace;tempText.font=item.font;tempText.showMode=item.showMode;tempText.readWrite=item.rw;tempText.layer=item.layer;tempText.align=item.align;if(item.showMode==0&&item.bindString&&item.bindString!=""){var arr=item.bindString.split('|');var strs;for(var j=0;j<arr.length;j++){strs=arr[j].split(":");tempText.dictBindString[strs[0]]=strs[1];}}
if(item.color){tempText.color='rgb('+item.color.b+','+item.color.g+','+item.color.r+')';}
if(item.idCom&&item.id!=""){tempText.idCom=item.idCom;tempText.value="--";this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.text,item.id);}
if(this.isInDiagnosis){if(modalTextIds[item.id]){tempText.isErrTip=true;tempText.getErrData=getErrData;if(AppConfig.projectId==80){tempText.getErrDataNew=getErrDataNew;}
tempText.retrunToMoment=function(date){_this.enterBacktraceMode();Spinner.spin(ElScreenContainer);ToolCurrent.showFramePane();var time=date.toDate();ToolCurrent.requestData(new Date(+time-7200000),new Date(+time+7200000),null,true);};this.diagScreen.dictObserverText[item.id]=tempText;tempText.updateDiagnosisGrade(0);}}
if(item.idCom&&item.id!=""||this.isInDiagnosis)this.hitModel.add(item.id,this.enmuElementType.text,item.x,item.y-item.height/2,item.width,item.height);this.dictTexts[item.id]=tempText;}}
if(this.isInDiagnosis)this.diagScreen.resetFloor();},addElementIdIntoDictRefreshMap:function addElementIdIntoDictRefreshMap(idCom,enmuElementType,elementId){if(!this.dictRefreshMap[idCom])this.dictRefreshMap[idCom]={pipelines:[],equipments:[],buttons:[],texts:[],charts:[],gages:[],rulers:[],tempDistributions:[]};switch(enmuElementType){case this.enmuElementType.text:this.dictRefreshMap[idCom].texts.push(elementId);break;case this.enmuElementType.pipeline:this.dictRefreshMap[idCom].pipelines.push(elementId);break;case this.enmuElementType.equipment:this.dictRefreshMap[idCom].equipments.push(elementId);break;case this.enmuElementType.chart:this.dictRefreshMap[idCom].charts.push(elementId);break;case this.enmuElementType.button:this.dictRefreshMap[idCom].buttons.push(elementId);break;case this.enmuElementType.gage:this.dictRefreshMap[idCom].gages.push(elementId);break;case this.enmuElementType.temperature:this.dictRefreshMap[idCom].tempDistributions.push(elementId);break;case this.enmuElementType.ruler:this.dictRefreshMap[idCom].rulers.push(elementId);break;default:break;}},addImageIntoRequestQueue:function addImageIntoRequestQueue(id){if(this.dictImages[id])return this.dictImages[id];var img=new Image();img.src=new StringBuilder().append("/static/images/plant/").append(AppConfig.projectName).append("/").append(id).append(".png").toString();var _this=this;img.addEventListener("load",function(e){_this.indexImageLoaded++;});this.dictImages[id]=img;return img;},showDetailDialog:function showDetailDialog(pageid,dialogTitle){var obScreen;if(!this.isInDiagnosis){if(ScreenModal)ScreenModal.close();ScreenModal=new ObserverScreen(pageid);dialogTitle&&(ScreenModal.dialogTitle=dialogTitle);if(this.isPlayback)ScreenModal.isPlayback=true;ScreenModal.isDetailPage=true;ScreenModal.show();}else{this.diagScreen.obScreen.close();obScreen=new ObserverScreen(pageid);obScreen.isInDiagnosis=true;obScreen.diagScreen=this.diagScreen;dialogTitle&&(obScreen.dialogTitle=dialogTitle);if(this.isPlayback)obScreen.isPlayback=true;obScreen.isDetailPage=false;obScreen.show(this.container);this.diagScreen.ScreenModal=obScreen;obScreen=null;}},showErrTip:function showErrTip(modalTextId){try{var text=this.dictTexts[modalTextId];var scaleX=this.hitModel.scaleX;var scaleY=this.hitModel.scaleY;var rect=this.canvas.getBoundingClientRect();var e={pageX:text.x/scaleX+rect.left+this.canvas.scrollLeft,pageY:text.y/scaleY+rect.top+this.canvas.scrollTop};text.mouseEnter(e);}catch(e){console.log('click too fast!');}},hideErrTip:function hideErrTip(modalTextId){try{var text=this.dictTexts[modalTextId];text.mouseOut(null);}catch(e){console.log('click too fast!');}},enmuElementType:{pipeline:0,equipment:1,button:2,text:3,chart:4,gage:5,ruler:6,temperature:7}};return ObserverScreen;}();var AnalysisScreen=function(){var syncDelayTimer=null;function AnalysisScreen(){this.store=undefined;this.factoryIoC=undefined;this.container=undefined;this.ltContainer=undefined;this.arrColor=echarts.config.color;this.saveModalJudge=undefined;this.modalConfig=undefined;this.curModal={startTime:undefined,endTime:undefined,format:undefined,mode:undefined,itemDS:[]};this.path=[];this.paneDatasource=undefined;this.paneCenter=undefined;this.paneLeft=undefined;}
AnalysisScreen.prototype={show:function show(){var _this=this;var promise=$.Deferred();Spinner.spin(ElScreenContainer);if(syncDelayTimer!==null){window.clearTimeout(syncDelayTimer);syncDelayTimer=null;}
WebAPI.get("/static/views/observer/analysisScreen.html").done(function(resultHtml){Spinner.stop();$(ElScreenContainer).html(resultHtml);var side=new SidebarMenuEffect();side.init('#paneContent');document.querySelector('#leftCt').click();document.querySelector('#rightCt').click();_this.syncCheck();});},close:function close(){var _this=this;var isExistSpinner=function(){var $spinner=$('#anlsPaneContain').find('.spinner');return $spinner.length>0;}();if(isExistSpinner){confirm('Exit now will interrupt the current operation, continue?',function(){_this.store=null;_this.factoryIoC=null;_this.container=null;_this.curModal=null;_this.modalConfig&&_this.modalConfig.close&&_this.modalConfig.close();AppConfig.datasource=null;_this.paneDatasource&&_this.paneDatasource.close&&_this.paneDatasource.close();_this.wsPanel&&_this.wsPanel.close&&_this.wsPanel.close();_this.tplPanel&&_this.tplPanel.close&&_this.tplPanel.close();_this.paneCenter&&_this.paneCenter.close&&_this.paneCenter.close();delete FullScreenManager.onFullScreenEnter;delete FullScreenManager.onFullScreenOut;_this.detachResizeEvents();if(_this.syncWorker.status==='processing'){_this.syncWorker.stop();}else{_this.syncWorker.stop();_this.syncWorker.setOptions({onProcessing:null,onSuccess:null,onFailed:null});syncDelayTimer=window.setTimeout(function(){_this.syncWorker.start(0,'once');},500);}});}},syncCheck:function syncCheck(){var _this=this;this.syncWorker=new SyncWorker();this.syncWorker.setOptions({onSuccess:function onSuccess(){_this.init();_this.initSyncWorker();},onFailed:function onFailed(){alert('数据分析经历非法关闭，请确认您的数据完整');window.Beop.cache.buffer.removeFrozenData().done(function(){_this.init();_this.initSyncWorker();});}});window.Beop.cache.buffer.init().done(function(){_this.syncWorker.start(0);});},initSyncWorker:function initSyncWorker(e){var _this=this;this.syncWorker.setOptions({onProcessing:function onProcessing(){console.log('processing');},onSuccess:function onSuccess(){console.log('success');},onFailed:function onFailed(){console.warn('failed');}});},doSync:function doSync(){var _this=this;var promise=$.Deferred();this.syncWorker.setOptions({onSuccess:function onSuccess(){_this.initSyncWorker();promise.resolve();}});this.syncWorker.start(0);return promise;},onresize:function onresize(){if(ScreenCurrent.paneCenter&&ScreenCurrent.paneCenter.chart){ScreenCurrent.paneCenter.chart.resize();}},init:function init(){var _this=this;var localStorageFlag;this.container=document.getElementById('anlsPane');this.ltContainer=document.getElementById('workspacePane');this.rtContainer=document.getElementById('divAnlsDatasourcePane');this.$breadcrumb=$('.breadcrumb').eq(0);this.$itemTools=$('.itemTools').eq(0);this.arrToolBox=[[{type:'glyphicon',value:'glyphicon glyphicon-search',id:'btnPreview',title:'Preview Workspaces'},{type:'glyphicon',value:'glyphicon glyphicon-list-alt',id:'btnShowTemplate',title:'Show Template'}],[{type:'glyphicon',value:'glyphicon glyphicon-random',id:'btnMoveTo',title:'Move to Other workspace'},{type:'glyphicon',value:'glyphicon glyphicon-share',id:'btnShareTo',title:'Create Share Report'},{type:'glyphicon',value:'glyphicon glyphicon-play',id:'btnPlay',title:'Play Sliders'},{type:'button',value:i18n_resource.analysis.workspace.REVERSE_SELECT,id:'btnSelectReverse',title:i18n_resource.analysis.workspace.REVERSE_SELECT},{type:'button',value:i18n_resource.analysis.workspace.SELECT_ALL,id:'btnSelectAll',title:i18n_resource.analysis.workspace.SELECT_ALL}],[{type:'glyphicon',value:'glyphicon glyphicon-cog',id:'btnConfigModal',title:'Config'},{type:'glyphicon',value:'glyphicon glyphicon-edit',id:'btnCreateNote',title:'Create Notes'},{type:'glyphicon',value:'glyphicon glyphicon-eye-open',id:'btnNoteHideOrShow',title:'Notes Hide Or Show'},{type:'glyphicon',value:'glyphicon glyphicon-th-large',id:'graphSelsect',title:'Select Graphs'},{type:'glyphicon',value:'glyphicon glyphicon-filter',id:'btnDataFilter',title:'Data Filter'},{type:'glyphicon',value:'glyphicon glyphicon-download-alt',id:'btnDownLoadExcel',title:'Download the excel file'}],[{type:'glyphicon',value:'glyphicon glyphicon-log-in',id:'btnReturnToWorkspace',title:'Return To Workspace'}],[]];this.attachResizeEvents();this.initBreadCrumb();this.initItemTools();Spinner.spin(ElScreenContainer);var lastOpenWorkspaceId=localStorage.getItem('lastOpenWorkspaceId_'+AppConfig.userId);if(lastOpenWorkspaceId===null)lastOpenWorkspaceId=0;WebAPI.get('/analysis/getWorkspaces/'+AppConfig.userId+'/'+lastOpenWorkspaceId).done(function(result){var temp;_this.store=result;_this.initIoc();_this.paneDatasource=AppConfig.datasource=new DataSource(_this);_this.initWsObserver();_this.initPathObserver();if(_this.store.workspaces.length>0){if(lastOpenWorkspaceId!==0){for(var i=0;i<_this.store.workspaces.length;i++){if(_this.store.workspaces[i].id==lastOpenWorkspaceId){temp=_this.store.workspaces[i];break;}}
if(!temp){temp=_this.store.workspaces[0];}}else{temp=_this.store.workspaces[0];}
_this.path.splice(0,_this.path.length,{type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:_this.store.workspaces},{type:'CenterSliderPanel',title:temp.name,data:temp});}
else{_this.path.push({type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:_this.store.workspaces});}
_this.paneDatasource.show();_this.modalConfig=new modalConfigurePane(document.getElementById('modalConfigContainer'),_this,'dataAnalysis');_this.modalConfig.show();I18n.fillArea($(ElScreenContainer));Spinner.stop();});},attachResizeEvents:function attachResizeEvents(){var _this=this;var handler=function handler(e){if(e.originalEvent.propertyName!=='transform')return;if(e.target!==_this.ltContainer&&e.target!==_this.rtContainer)return;if(typeof _this.onresize==='function'){_this.onresize();}};$(this.ltContainer).off('transitionend').on('transitionend',handler);$(this.rtContainer).off('transitionend').on('transitionend',handler);},detachResizeEvents:function detachResizeEvents(){$(this.ltContainer).off('transitionend');$(this.rtContainer).off('transitionend');},mergeDsInfoList:function mergeDsInfoList(dsList){var dsInfoMap={},dsMap={};if(!dsList||!dsList.length)return;if(!this.store.dsInfoList||!this.store.dsInfoList.length){this.store.dsInfoList=dsList;return;}
this.store.dsInfoList.forEach(function(row){dsInfoMap[row.id]=row;});dsList.forEach(function(row){dsMap[row.id]=row;});for(var p in dsMap){if(!dsMap.hasOwnProperty(p))continue;if(dsInfoMap.hasOwnProperty(p))continue;dsInfoMap[p]=dsMap[p];this.store.dsInfoList.push(dsMap[p]);}},initWsObserver:function initWsObserver(){var _this=this;var addModalArrayOb=function addModalArrayOb(arr){observeHelper.watchArray(arr,'modalList',function(sign,type,data){var changeData;switch(type){case'push':observeHelper.watchProp(data.changeData,['name','imagebin'],'modal',function(sign,data){var params;switch(sign){case'modal_name':params={id:data.id,name:data.name,modifyTime:data.modifyTime};break;case'modal_imagebin':params={id:data.id,imagebin:data.imagebin,modifyTime:data.modifyTime};break;}
if(!_this.path[_this.path.length-1].isSlider)_this.paneCenter.updateSlider(params);_this.paneLeft.updateSlider(params);});if(!_this.path[_this.path.length-1].isSlider)_this.paneCenter.addSlider(data.changeData);_this.paneLeft.addSlider(data.changeData);break;case'splice':changeData=data.changeData[0];if(!_this.path[_this.path.length-1].isSlider)_this.paneCenter.removeSlider(changeData);_this.paneLeft.removeSlider(changeData);break;case'move':_this.saveModalLayout();break;}});arr.forEach(function(modal){observeHelper.watchProp(modal,['name','imagebin'],'modal',function(sign,data){var params;switch(sign){case'modal_name':params={id:data.id,name:data.name,modifyTime:data.modifyTime};break;case'modal_imagebin':params={id:data.id,imagebin:data.imagebin,modifyTime:data.modifyTime};break;}
if(!_this.path[_this.path.length-1].isSlider)_this.paneCenter.updateSlider(params);_this.paneLeft.updateSlider(params);});});};var addWsArrayOb=function addWsArrayOb(arr,name){observeHelper.watchArray(arr,name,function(sign,type,data){switch(type){case'push':addWorkspaceOb(data.changeData);_this.paneCenter.addOne(data.changeData);break;case'splice':_this.paneCenter.removeOne(data.changeData[0]);break;case'move':_this.saveWorkspaceLayout();break;}});arr.forEach(function(row){addWorkspaceOb(row);});};var addWorkspaceOb=function addWorkspaceOb(ws){observeHelper.watchProp(ws,['name','modalList'],'workspace',function(sign,data){var item;switch(sign){case'workspace_name':_this.paneCenter.updateOne(data);break;case'workspace_modalList':addModalArrayOb(data.modalList);if(_this.path.length===2&&_this.path[0].type==='WorkspacePanel'){_this.paneCenter.init();}
break;};});addModalArrayOb(ws.modalList);};addWsArrayOb(this.store.workspaces,'workspace');observeHelper.watchProp(this.store,'templates','analysis',function(sign,data){addWsArrayOb(data.templates.preTemplate,'analysis');addWsArrayOb(data.templates.userTemplate,'analysis');});},initPathObserver:function initPathObserver(){var _this=this;observeHelper.watchArray(this.path,'analysis',function(sign,type,data){var len=_this.path.length,oldLen=data.oldData.length;var item,modalClass;_this.renderBreadCrumb();_this.$itemTools.children().hide();item=_this.path[len-1];switch(len){case 1:if(_this.paneLeft&&_this.paneLeft.close)_this.paneLeft.close();_this.panelLeft=null;break;case 2:_this.refreshPaneLeft(new window.analysis.panels.LeftSliderPanel(_this,item.data));break;case 3:if(len-oldLen<=1)break;_this.refreshPaneLeft(new window.analysis.panels.LeftSliderPanel(_this,item.data));break;}
if(item.isSlider&&item.type!=='AnalysisTemplate'){_this.renderModalById(item.data);}else{_this.refreshPaneCenter(new window.analysis.panels[item.type](_this,item.data));}
_this.renderItemtools();});},refreshPaneLeft:function refreshPaneLeft(entity){if(this.paneLeft&&this.paneLeft.close)this.paneLeft.close();this.paneLeft=entity;this.paneLeft.show(this.ltContainer);},refreshPaneCenter:function refreshPaneCenter(entity){if(this.paneCenter&&this.paneCenter.close)this.paneCenter.close();this.paneCenter=entity;if(this.path[this.path.length-1].isSlider&&this.paneLeft.readonly){$(this.container).addClass('panel-readonly');}else{$(this.container).removeClass('panel-readonly');}
this.paneCenter.show(this.container);},initBreadCrumb:function initBreadCrumb(){var _this=this;EventAdapter.on(this.$breadcrumb,'click','a',function(){var $this=$(this);var level=parseInt($this.attr('data-level'));var type=_this.path[level].type;_this.path.splice(level+1);});},renderBreadCrumb:function renderBreadCrumb(){var arrHtml=[];var len=this.path.length;this.path.forEach(function(row,i){if(len-1===i){arrHtml.push('<li class="active">'+row.title+'</li>');return;}
arrHtml.push('<li><a href="javascript:;" data-level="'+i+'">'+row.title+'</a></li>');});this.$breadcrumb.html(arrHtml.join(''));},initItemTools:function initItemTools(){var arrToolHtml=[],_this=this;for(var i=0,len=this.arrToolBox.length;i<len;i++){var toolBox=this.arrToolBox[i];for(var j in toolBox){var tool=toolBox[j];tool.level=i;if(tool.type=='glyphicon'){if(tool.id==='btnDownLoadExcel'){arrToolHtml.push('<span class="glyphicon {value} panel-heading-btn grow" id="{id}" data-level="{level}" title="{title}"><a href="#" id="{id}_a" style="display: inline-block;width: 20px;height: 20px;position: absolute;top: 0;left: 0;" nothash></a></span>'.formatEL(tool));}else{arrToolHtml.push('<span class="glyphicon {value} panel-heading-btn grow" id="{id}" data-level="{level}" title="{title}"></span>'.formatEL(tool));}}else if(tool.type=='button'){arrToolHtml.push('<button type="button" class="btn btn-default btn-xs" id="{id}" data-level="{level}" title="{title}">{value}</button>'.formatEL(tool));}}}
this.$itemTools.html(arrToolHtml.join(''));EventAdapter.on($(this.$itemTools.children('#btnPreview').off('click')),'click',function(e){_this.preview();});EventAdapter.on($(this.$itemTools.children('#btnShareTo').off('click')),'click',function(e){_this.shareTo();});EventAdapter.on($(this.$itemTools.children('#btnPlay').off('click')),'click',function(e){_this.play();});EventAdapter.on($(this.$itemTools.children('#btnSelectAll').off('click')),'click',function(e){_this.selectAll();});EventAdapter.on($(this.$itemTools.children('#btnSelectReverse').off('click')),'click',function(e){_this.selectReverse();});EventAdapter.on($(this.$itemTools.children('#btnShowTemplate').off('click')),'click',function(e){_this.showTemplate();});EventAdapter.on($(this.$itemTools.children('#btnReturnToWorkspace').off('click')),'click',function(e){_this.returnToWorkspace();});EventAdapter.on($(this.$itemTools.children('#btnMoveTo').off('click')),'click',function(e){_this.moveTo();});},renderItemtools:function renderItemtools(){var index=this.path.length-1;if(this.path[0].type==='TemplatePanel')index+=3;if(index===5)index=2;if(this.path.length===3&&this.paneLeft.readonly)return;this.$itemTools.children('[data-level="'+index+'"]').show();if(this.path.length===2&&this.paneLeft.readonly){this.$itemTools.children('#btnMoveTo').hide();}
if(this.container&&$(this.container.firstChild).hasClass('anlsTemplate')){$('#btnDownLoadExcel').hide();}
if(this.curModal&&this.curModal.type=='AnlzTendency'){if($(this.container).find('div').hasClass('divHover')){$('#chartModify').show();$('#btnDataFilter').show();}else{$('#chartModify').hide();$('#btnDataFilter').hide();}}else{$('#chartModify').hide();$('#btnDataFilter').hide();}},hideAnlsPane:function hideAnlsPane(){$('#anlsPaneContain').hide();this.detachResizeEvents();},showAnlsPane:function showAnlsPane(){$('#anlsPaneContain').show();this.attachResizeEvents();this.onresize();},initIoc:function initIoc(){this.factoryIoC=new FactoryIoC('analysis');},renderModal:function renderModal(){var option=this.curModal;var modalClass=this.factoryIoC.getModel(option.type);if(modalClass){this.refreshPaneCenter(new modalClass(this.container,option,this));}else this.refreshPaneCenter(new window.analysis.panels.AnalysisTemplate(this));this.saveModal();},renderModalById:function renderModalById(modal){this.curModal=modal.option;this.renderModal();this.saveModalJudge.rejectWith(this,[this,$('#divWSPane .selected')]);this.saveModalJudge.rejectWith(this,[this,$('#divWSPane .selected')]);},saveWorkspaceLayout:function saveWorkspaceLayout(){var _this=this;var workspaces=this.store.workspaces;WebAPI.post('/analysis/workspace/saveOrder/'+AppConfig.userId,{idList:this.store.workspaces.map(function(row){return row.id;})}).done(function(){_this.paneCenter.close();_this.paneCenter.show(_this.container);});},saveModalLayout:function saveModalLayout(){var _this=this;var ws=this.paneLeft.ws;WebAPI.post('/analysis/modal/saveOrder/'+AppConfig.userId+'/0',{workspaceId:ws.id,idList:ws.modalList.map(function(row){return row.id;})}).done(function(){_this.paneLeft.close();_this.paneLeft.show(_this.ltContainer);if(!_this.path[_this.path.length-1].isSlider){_this.paneCenter.close();_this.paneCenter.show(_this.container);}});},saveModal:function saveModal(){this.saveModalJudge=$.Deferred();$.when(this.saveModalJudge).done(function(_this,_mode,_chart,_targetSlider,_curModal,imgSaveJudge){var currentWs=_this.paneLeft.ws;var modalList=currentWs.modalList;var imageSm,canvas,tempChartImageBin;var params,modal;var type;var modalId=_targetSlider.attr('data-id');for(var key in _curModal){if(_curModal[key]instanceof Date)_curModal[key]=_curModal[key].format('yyyy-MM-dd HH:mm:ss');}
params={id:modalId,type:_curModal.type||'',note:'',option:_curModal,modifyTime:new Date().format('yyyy-MM-dd HH:mm')};if(imgSaveJudge){if(!_chart){tempChartImageBin=_targetSlider.get(0).style.backgroundImage.replace('url(','').replace(')','');}else{var tempOption=_chart.getOption();var isShowToolbox=undefined;var isShowDataZoom=undefined;if(tempOption.toolbox&&tempOption.toolbox[0]){isShowToolbox=tempOption.toolbox[0].show;tempOption.toolbox[0].show=false;}
if(tempOption.dataZoom&&tempOption.dataZoom[0]){isShowDataZoom=tempOption.dataZoom[0].show;tempOption.dataZoom[0].show=false;}
if(tempOption.dataRange){tempOption.dataRange.show=false;}
_chart.setOption(tempOption);imageSm=_chart.getDataURL({type:'jpeg',pixelRatio:0.3,backgroundColor:'#fff'});if(isShowToolbox){tempOption.toolbox[0].show=isShowToolbox;}
if(isShowDataZoom){tempOption.dataZoom[0].show=isShowDataZoom;}
_chart.setOption(tempOption);canvas=document.createElement("canvas");canvas.width=480;canvas.height=300;tempChartImageBin=imageSm;}
Beop.cache.img.set(currentWs.id,modalId,tempChartImageBin);params.imagebin=tempChartImageBin;}
type=!currentWs.templateId?'ws':'tpl';_this.paneLeft.model.update(params,currentWs.id,type).done(function(){var i=0;while(modal=modalList[i++]){if(modal.id===modalId){modal.type=params.type;modal.option=params.option;modal.modifyTime=params.modifyTime;params.imagebin!==undefined&&(modal.imagebin=params.imagebin);break;}}});});$('#btnDownLoadExcel_a').parent().show();},updateDataSources:function updateDataSources(updateData){this.store.group=updateData;},alertNoData:function alertNoData(){var _this=this;var $dataAlert=$("#dataAlert");new Alert($dataAlert,"danger","<strong>"+I18n.resource.analysis.paneConfig.ERR11+"</strong>").show().close();},shareTo:function shareTo(){var selectedIds=$.makeArray(this.paneCenter.$container.find('.slider-item.checked').map(function(){return this.dataset.id;}));var selectedNames;var workAndReport;var modalList,data=[];if(selectedIds.length<=0){alert('You should choose one slider at least!');return;}
modalList=this.paneCenter.ws.modalList;if(!modalList||!modalList.length)return false;for(var i=0,item,arrPoints,len=modalList.length;i<len;i++){if(selectedIds.indexOf(modalList[i]['id'])>-1){item=modalList[i];if(item.id==selectedIds[0]){selectedNames=item.name;}
arrPoints=[];if(!item.option.itemDS)continue;for(var j=0;j<item.option.itemDS.length;j++){arrPoints=arrPoints.concat(item.option.itemDS[j].arrId);}
for(var p in item.__observeProps){if(!item.hasOwnProperty(p))continue;Object.defineProperty(item,p,{writable:true,value:item.__observeProps[p]});}
delete item.__observeProps;delete item.imagebin;data.push({"id":(+new Date()).toString()+i.toString(),"spanC":6,"spanR":4,"modal":{"interval":0,"option":item,"title":item.name,"points":arrPoints,"type":"ModalAnalysis"}});}}
workAndReport=new Date().timeFormat(timeFormatChange('yyyy-mm-dd'))+' '+this.paneCenter.ws.name+' <i style="font-weight:600;">'+selectedNames+'  </i>  '+I18n.resource.analysis.shareLog.DESC_TIP_ETC+'  '+selectedIds.length+'  '+I18n.resource.analysis.shareLog.DESC_TIP_TABLE;var strShare='SHARE'+AppConfig.userId.toString()+(+new Date()).toString(),postData;postData={projectId:'',menuItemId:strShare,layout:[data],desc:workAndReport};var dsInfoList=[].concat(this.store.dsInfoList);ScreenManager.show(EnergyScreen,strShare,postData,null,dsInfoList);},selectAll:function selectAll(){this.paneCenter.$container.find('.slider-item').addClass('checked');},selectReverse:function selectReverse(){this.paneCenter.$container.find('.slider-item').toggleClass('checked');},play:function play(){var _this=this;var sliders;var selectedIds=$.makeArray(this.paneCenter.$container.find('.slider-item.checked').map(function(){return this.dataset.id;}));if(selectedIds.length<=0){alert('You should choose one slider at least!');return;}
$('html').addClass('sharpview-mode');sliders=_this.paneCenter.ws.modalList.filter(function(row){return selectedIds.indexOf(row.id)>-1;});FullScreenManager.onFullScreenEnter=function(){_this.sharpViewScreen=new SharpViewScreen(sliders,_this.store);_this.sharpViewScreen.show();};FullScreenManager.onFullScreenOut=function(){$('html').removeClass('sharpview-mode');_this.sharpViewScreen.destroy();};FullScreenManager.toggle();},preview:function preview(){var _this=this;var promise=$.Deferred();var modalList=[],workspaces=this.store.workspaces;var wsIdsNeedLoad=[];var selectedWsIds=[].map.call($(this.container).find('.wsSet.on'),function(row){return row.dataset.id;});var selectedWsList=[];var dsInfoList;if(selectedWsIds.length==0){alert('Please select at least one workspace!');return;}
workspaces.forEach(function(ws){if(selectedWsIds.indexOf(ws.id)===-1){return false;}
if(ws.modalCount===undefined){modalList=modalList.concat(ws.modalList);}
else if(ws.modalCount>0){wsIdsNeedLoad.push(ws.id);}});if(!modalList.length&&!wsIdsNeedLoad.length)return false;if(wsIdsNeedLoad.length>0){WebAPI.post('/analysis/getModals',{idList:wsIdsNeedLoad}).done(function(rs){for(var prop in rs){if(!rs.hasOwnProperty(prop)){continue;}
modalList=modalList.concat(rs[prop].modalList);_this.mergeDsInfoList(rs[prop].dsInfoList);}
promise.resolve();});}else{promise.resolve();}
promise.done(function(){var postData;var data=[];for(var i=0,item,arrPoints,len=modalList.length;i<len;i++){item=modalList[i];arrPoints=[];if(!item.option.itemDS)continue;for(var j=0,arrId;j<item.option.itemDS.length;j++){arrPoints=arrPoints.concat(item.option.itemDS[j].arrId);}
data.push({"id":(+new Date()).toString()+i.toString(),"spanC":6,"spanR":4,"modal":{"interval":0,"option":item,"title":item.name,"points":arrPoints,"type":"ModalAnalysis"}});}
postData={group:_this.store.group,dsInfoList:_this.store.dsInfoList,projectId:'',layout:[data]};ScreenCurrent.close();ScreenCurrent=new EnergyScreen();ScreenCurrent.store=postData;ScreenCurrent.isForBencMark=true;ScreenCurrent.show();});},showModal:function showModal(){var $dialog=$('#dialogModal');var $dialogContent=$dialog.find('#dialogContent').css({height:'90%',width:'90%',margin:'auto',marginTop:'2.5%',backgroundColor:'#fff'});$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$dialogContent.removeAttr('style').html('');}).modal({});var energyScreen=new EnergyScreen();energyScreen.container=$dialogContent[0];energyScreen.isForBencMark=true;energyScreen.init();},showTemplate:function showTemplate(){var _this=this;var len=this.path.length;var pjIds;if(!this.store.templates){pjIds=AppConfig.projectList.map(function(row,i){return row.id;});Spinner.spin(this.container);WebAPI.post('/analysis/template/get/'+AppConfig.userId,{projectIds:pjIds}).done(function(rs){_this.store.templates=rs;_this.path.splice(0,len,{type:'TemplatePanel',title:'Templates',data:rs});}).always(function(){Spinner.stop();});}else{this.path.splice(0,len,{type:'TemplatePanel',title:'Templates',data:this.store.templates});}},returnToWorkspace:function returnToWorkspace(){this.path.splice(0,this.path.length,{type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:this.store.workspaces});},moveTo:function moveTo(){var selectedModalIds=Array.prototype.map.call($('.slider-item.checked',this.container),function(row){return row.dataset.id;});if(selectedModalIds.length==0){alert('Please select at least one Slider!');return;}
var $dialog=$('#dialogModal'),workspaceHtml=[],modalHtml,_this=this,targetWs={};var wsTpl='<div class="wsSet{isEmpty} moveTo" data-id="{id}"><div class="wsCtn"><div class="wsName">{name}</div></div></div>';this.store.workspaces.forEach(function(ws){if(_this.paneCenter.ws.id===ws.id||ws.templateId)return;workspaceHtml.push(wsTpl.formatEL({id:ws.id,name:ws.name,isEmpty:ws.modalList.length>0?'':' empty'}));});modalHtml='<div class="modal-content" id="" style="height: calc(100% - 200px);">\
                <div class="modal-header">\
                    <button type="button" class="close" onclick="">\
                        <span aria-hidden="true">&times;</span>\
                    </button>\
                    <h3 class="modal-title">Move to Workspace</h3>\
                </div>\
                <div class="modal-body" style="height: calc(100% - 120px); overflow-y: auto;">'+workspaceHtml.join('')+'<div style="clear: both;"></div>\
                </div>\
                <div class="modal-footer">\
                    <button id="confirmMove" class="btn btn-primary disabled">Confirm</button>\
                </div>\
            </div>';$dialog.find('#dialogContent').css({height:'100%'}).html(modalHtml);$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){Spinner.stop();}).modal({});EventAdapter.on($dialog.find('.close').off('click'),'click',function(e){$dialog.modal('hide');e.stopPropagation();});EventAdapter.on($dialog.find('#confirmMove').off('click'),'click',function(e){e.stopPropagation();var data,modalIdList=[];var targetModalList=targetWs.modalList;var srcModalList=_this.paneLeft.ws.modalList;var moveModals=[];var modalModel=_this.paneLeft.model;var ws=_this.paneLeft.ws;$dialog.modal('hide');Spinner.spin(ElScreenContainer);_this.doSync().done(function(){WebAPI.post('/analysis/modalMove/'+AppConfig.userId,{srcWsId:ws.id,destWsId:targetWs.id,moveModalIdList:selectedModalIds}).done(function(rs){if(rs.status==='OK'){for(var i=0,len=srcModalList.length;i<len;i++){if(selectedModalIds.indexOf(srcModalList[i].id)>-1){moveModals.push(srcModalList.splice(i,1)[0]);len--;i--;}}
moveModals.forEach(function(row){Array.prototype.push.call(targetModalList,row);});}}).always(function(){Spinner.stop();_this.initSyncWorker();});});});EventAdapter.on($($dialog.find('.wsSet').off('click')),'click',function(e){var targetWsId=$(this).attr('data-id');var workspaces=_this.store.workspaces;$(this).siblings('.wsSet').removeAttr('style');$(this).css({backgroundColor:'rgba(90, 155, 226, 0.2)'});$dialog.find('#confirmMove').removeClass('disabled');for(var i=0;i<workspaces.length;i++){if(workspaces[i].id===targetWsId){targetWs=workspaces[i];break;}}});}};var observeHelper={watchProp:function watchProp(target,props,sign,callback){var _this=this;if(!target.__observeProps)target.__observeProps={};props=typeof props==='string'?[props]:props;props.forEach(function(prop,i){if(target.__observeProps.hasOwnProperty(prop))return;target.__observeProps[prop]=target[prop];Object.defineProperty(target,prop,{configurable:true,enumerable:true,get:function get(){return this.__observeProps[prop];},set:function set(value){if(value===this.__observeProps[prop])return;this.__observeProps[prop]=value;callback(sign+'_'+prop,this);}});});},watchArray:function watchArray(target,sign,callback){var _this=this;target.push=function(data){var old=this.concat();var rs=Array.prototype.push.call(this,data);callback(sign+'_push','push',{oldData:old,newData:this,changeData:data});return rs;};target.pop=function(){var old=this.concat();var data=Array.prototype.pop.call(this,data);callback(sign+'_pop','pop',{oldData:old,newData:this,changeData:data});return data;};target.splice=function(){var old=this.concat();var del=Array.prototype.splice.apply(this,Array.prototype.slice.call(arguments));callback(sign+'_splice','splice',{oldData:old,newData:this,changeData:del});return del;};target.move=function(from,to){var old=this.concat();var change=Array.prototype.splice.call(this,to,0,Array.prototype.splice.call(this,from,1)[0]);callback(sign+'_move','move',{oldData:old,newData:this,changeData:change});};target.moveBatch=function(fromlist,toList){fromList.forEach(function(row,i){Array.prototype.splice.call(this,row,1);});};}};var SyncWorker=function(window,$,buffer){function SyncWorker(options){this.options=$.extend({},DEFAULTS,options);this.timer=null;this.status='stop';}
+function(){this.start=function(){function process(once){var _this=this;var promise=$.Deferred();_this.excuteCallback('onProcessing');_this.status='processing';buffer.getFrozenData().then(function(data){if(data===null){buffer.removeFrozenData().done(function(){promise.resolve();});return;}
console.log('transfer',data);WebAPI.post('/analysis/anlySync/'+AppConfig.userId,data).then(function(rs){if(rs.status==='OK'){buffer.removeFrozenData().done(function(){promise.resolve();});}else{promise.reject(-2);}},function(rs){promise.reject(-3);});},function(){promise.reject(-1);});promise.then(function(){_this.excuteCallback('onSuccess');},function(errCode){switch(errCode){case-1:console.warn('获取冻结版本数据失败');break;case-2:console.warn('同步数据失败，接口执行错误');break;case-3:console.warn('同步请求发送失败');break;default:break;}
_this.excuteCallback('onFailed',errCode);});if(once){_this.stop();return;}else{promise.always(function(){if(_this.timer===null)return;_this.timer=window.setTimeout(process.bind(_this),_this.options.interval);_this.status='ready';});}}
return function(delay,mode){var once=mode==='once'?true:false;delay=delay===undefined?this.options.interval:delay;if(this.timer!==null){this.stop();}
this.timer=window.setTimeout(process.bind(this,once),delay);this.status='ready';};}();this.stop=function(){if(this.timer){window.clearTimeout(this.timer);this.timer=null;}
this.status='stop';};this.setOptions=function(options){this.options=$.extend({},this.options,options);};this.excuteCallback=function(type,data){typeof this.options[type]==='function'&&this.options[type](data);};}.call(SyncWorker.prototype);var DEFAULTS={interval:60000};return SyncWorker;}(window,jQuery,window.Beop.cache.buffer);return AnalysisScreen;}();+function($){var useBuffer=true;!useBuffer&&function(){this.analysis=this.analysis||{};function WorkspaceModel(){}
+function(){this.create=function(data){var params;var promise;if(!data.templateId){params={workspaceName:data.name,modalList:data.modalList||[],modifyTime:data.modifyTime,modal:{option:{},imagebin:''}};promise=WebAPI.post('/analysis/modal/save/'+AppConfig.userId,params);}
else{params={workspaceName:data.name,templateId:data.templateId};promise=WebAPI.post('/analysis/template/apply/'+AppConfig.userId,params);}
return promise;};this.update=function(data){return WebAPI.post('/analysis/modal/save/'+AppConfig.userId,{workspaceId:data.id,workspaceName:data.name});};this.read=function(){};this.delete=function(wsId){return WebAPI.get('/analysis/workspace/remove/'+AppConfig.userId+'/'+wsId+'/0');};}.call(WorkspaceModel.prototype);function TemplateModel(){}
+function(){this.create=function(data){return WebAPI.post('/analysis/template/create/'+AppConfig.userId,{templateName:data.name,projectId:AppConfig.userId===1?'':AppConfig.projectId});};this.update=function(data){return WebAPI.post('/analysis/modal/save/'+AppConfig.userId,{templateId:data.id,templateName:data.name});};this.read=function(){};this.delete=function(tplId){return WebAPI.get('/analysis/workspace/remove/'+AppConfig.userId+'/'+tplId+'/1');};}.call(TemplateModel.prototype);function ModalModel(){}
+function(){this.create=function(){};this.update=function(data,ws){if(!ws.templateId){params={workspaceId:ws.id,workspaceName:ws.name,modal:data};}else{params={templateId:ws.templateId,modal:data};}
return WebAPI.post('/analysis/modal/save/'+AppConfig.userId,params);};this.read=function(){};this.delete=function(){};}.call(ModalModel.prototype);this.analysis.models={WorkspaceModel:WorkspaceModel,TemplateModel:TemplateModel,ModalModel:ModalModel};}.call(this,window.Beop.cache.buffer);useBuffer&&function(buffer){this.analysis=this.analysis||{};function WorkspaceModel(){}
+function(){this.create=function(data){var params;if(!data.templateId){params={id:data.id,name:data.name,modalList:data.modalList||[],modifyTime:data.modifyTime};params=$.extend(false,params,{modalList:params.modalList.concat()});params.modalList=params.modalList.map(function(row){var newRow=$.extend(false,row,{});delete newRow['__observeProps'];return newRow;});}
else{params={id:data.id,templateId:data.templateId,name:data.name,modifyTime:data.modifyTime,modalList:[]};}
if(data['dsOwnerId']!==undefined){params['dsOwnerId']=data['dsOwnerId'];}
return buffer.addWsCreateOp(params);};this.update=function(data){return buffer.addWsUpdateOp({id:data.id,name:data.name,modifyTime:data.modifyTime});};this.read=function(){};this.delete=function(wsId){return buffer.addWsDeleteOp({id:wsId});};}.call(WorkspaceModel.prototype);function TemplateModel(){}
+function(){this.create=function(data){var params;params={id:data.id,name:data.name,modalList:data.modalList||[],creatorId:data.creatorId,projectId:data.projectId,modifyTime:data.modifyTime};params=$.extend(false,params,{modalList:params.modalList.concat()});return buffer.addWsCreateOp(params,'tpl');};this.update=function(data){return buffer.addWsUpdateOp({id:data.id,name:data.name,modifyTime:data.modifyTime},'tpl');};this.read=function(){};this.delete=function(tplId){return buffer.addWsDeleteOp({id:tplId},'tpl');};}.call(TemplateModel.prototype);function ModalModel(){}
+function(){this.create=function(modal,id,type){var params={};params.id=modal.id;params.modifyTime=modal.modifyTime;params.type=modal.type;params.op='create';modal.note!==undefined&&(params.note=modal.note);modal.option!==undefined&&(params.option=modal.option);modal.name!==undefined&&(params.name=modal.name);modal.imagebin!==undefined&&(params.imagebin=modal.imagebin);return buffer.addModalCreateOp(params,id,type);};this.update=function(modal,id,type){var params={};params.id=modal.id;params.modifyTime=modal.modifyTime;params.type=modal.type;params.op='update';modal.note!==undefined&&(params.note=modal.note);modal.option!==undefined&&(params.option=modal.option);modal.name!==undefined&&(params.name=modal.name);modal.imagebin!==undefined&&(params.imagebin=modal.imagebin);return buffer.addModalUpdateOp(params,id,type);};this.read=function(){};this.delete=function(modalId,id,type){return buffer.addModalDeleteOp(modalId,id,type);};}.call(ModalModel.prototype);this.analysis.models={WorkspaceModel:WorkspaceModel,TemplateModel:TemplateModel,ModalModel:ModalModel};}.call(this,window.Beop.cache.buffer);}.call(this,jQuery);window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.AnalysisTemplate=function(){function AnalysisTemplate(screen){this.screen=screen;}
AnalysisTemplate.prototype={show:function show(){this.initAnlysTemplate();this.initDrag();$('#graphSelsect').click(function(){$('#graphBox').hide();return;});$('#chartModify').hide();$('#btnDataFilter').hide();},initAnlysTemplate:function initAnlysTemplate(){var paneAnalysis=document.getElementById('anlsPane');var _this=this;paneAnalysis.innerHTML='';var list,option,strAnlysPara,strTemplateImg,strAnlysTemplate,strTemplateImgColor,template,strImgIndex;list=this.screen.factoryIoC.getList();for(var ele=0;ele<list.length;ele++){template=list[ele];option=template.prototype.optionTemplate;strAnlysPara='';option=this.screen.factoryIoC.getModel(template.name).prototype.optionTemplate;strTemplateImg='/static/images/analysis/templateImg/templateImg.png';strTemplateImgColor=option.imgColor?option.imgColor:'65,131,189';strImgIndex=option.imgIndex?-(option.imgIndex*59):0;for(var i=0;i<option.templateParams.paraName.length;i++){strAnlysPara+='<p dataType="'+option.templateParams.paraName[i]+'">'+option.templateParams.paraName[i]+'</p>';}
var numOfPara=option.templateParams.paraName.length>5?'long':option.templateParams.paraName.length;strAnlysTemplate='<div class="anlsTemplate" anlysParaMode="'+option.templateParams.paraAnlysMode+'" templateType="'+template.name+'" style="background-color:rgba('+strTemplateImgColor+',0.1)">\
                                    <div class="templateImgBg" style="background-color:rgba('+strTemplateImgColor+',1)"></div>\
                                        <div class="templateImg" style="background-image:url('+strTemplateImg+'); background-repeat:no-repeat; background-position:'+strImgIndex+'px 0"></div>\
                                            <h3>'+I18n.findContent(option.templateName)+'</h3>\
                                        <p>'+I18n.resource.analysis.paneConfig.DATA_DRAG_TIP+'</p>\
                                        <div class = "templatePara numOfPara-'+numOfPara+'">'+strAnlysPara+'</div>\
                                    </div>';paneAnalysis.innerHTML+=strAnlysTemplate;}
var $anlsConfigModal=$('#anlsConfigModal');EventAdapter.on($('.anlsTemplate'),'click',function(e){var option={};var optionTemplate=_this.screen.factoryIoC.getModel($(e.currentTarget).attr('templateType')).prototype.optionTemplate;option.modeUsable=optionTemplate.chartConfig;option.dataTypeMaxNum=[];option.dataTypeMaxNum=optionTemplate.templateParams.dataTypeMaxNum;option.rowDataType=[];option.templateType=$(e.currentTarget).attr('templateType');for(var i=0;i<e.currentTarget.children[4].children.length;++i){option.rowDataType.push(e.currentTarget.children[4].children[i].getAttribute('dataType'));}
option.optionPara={};option.optionPara.dataItem=[];var allDataNeed=$(e.currentTarget).attr('anlysParaMode');if(allDataNeed=='all'){allDataNeed=true;}else{allDataNeed=false;}
option.allDataNeed=allDataNeed;_this.screen.modalConfig.showModalInit(true,option);});},initDrag:function initDrag(){var _this=this;var templateParaPane=$('.templatePara');var $tempPara=templateParaPane.children();var $anlysConfigModal=$('#anlsConfigModal');var $rowAnlysPara,strAnlysModalBody,targetId,targetContent;var $startAnlys=$('#startAnlys');$tempPara.on('dragenter',function(e){e.preventDefault();e.stopPropagation();});$tempPara.on('dragleave',function(e){e.preventDefault();$(e.target).removeClass('paraSel');$(e.target).closest('.anlsTemplate').removeClass('templateSel');});$tempPara.on('dragover',function(e){e.preventDefault();$(e.target).addClass('paraSel');$(e.target).closest('.anlsTemplate').addClass('templateSel');});$tempPara.on('drop',function(e){e.preventDefault();e.stopPropagation();var option={},targetIdEnd=undefined,dsNameEnd=[];var optionTemplate=_this.screen.factoryIoC.getModel($(e.currentTarget).closest('.anlsTemplate').attr('templateType')).prototype.optionTemplate;option.modeUsable=optionTemplate.chartConfig;option.templateType=$(e.currentTarget).closest('.anlsTemplate').attr('templateType');option.dataTypeMaxNum=[];option.dataTypeMaxNum=optionTemplate.templateParams.dataTypeMaxNum;option.rowDataType=[];for(var i=0;i<$(e.currentTarget).parent().children().length;++i){option.rowDataType.push($(e.currentTarget).parent().children().get(i).getAttribute('dataType'));}
option.optionPara={};targetId=EventAdapter.getData().dsItemId;if(!targetId)return;if(Object.prototype.toString.call(targetId)==='[object Array]'){targetIdEnd=targetId;for(var i=0,len=targetId.length;i<len;i++){dsNameEnd.push(AppConfig.datasource.getDSItemById(targetId[i]).alias);}}else{targetIdEnd=[targetId];dsNameEnd=[AppConfig.datasource.getDSItemById(targetId).alias];}
option.optionPara.dataItem=[{dsId:targetIdEnd,dsName:dsNameEnd,dsType:e.currentTarget.getAttribute('dataType')}];var allDataNeed=$(e.currentTarget).closest('.anlsTemplate').attr('anlysParaMode');allDataNeed=='all'?allDataNeed=true:allDataNeed=false;option.allDataNeed=allDataNeed;_this.screen.modalConfig.showModalInit(true,option);});$('#dataSrcPanel').on('dragend',function(e){e.preventDefault();$('.templateSel').removeClass('templateSel');$('.paraSel').removeClass('paraSel');$('.paraRowSel').removeClass('paraRowSel');$('.templatePara').css('display','none');});},close:function close(){}};return AnalysisTemplate;}();window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.CenterSliderPanel=function(window,$,Model,undefined){function CenterSliderPanel(screen,ws){this.screen=screen;this.ws=ws;this.readonly=ws.templateId&&ws.templateId!==ws.id?true:false;this.referTo=ws.templateId===ws.id?'tpl':'ws';this.model=new Model();};CenterSliderPanel.prototype.tpl='\
    <div class="divPage slider-item{cls}" id="cp_{id}" data-id="{id}" draggable="true" style="{imagebin}">\
        <h4 class="divPageTitle">\
            <div class="modalNameSp">{name}</div>\
        </h4>\
        {sign}\
        <div class="effect"></div>\
        <span class="slider-cb-wrap"><i class="slider-cb"></i></span>\
        <div class="sliderInfo">\
            <span class="modifyTime">Recently:&nbsp;&nbsp;{modifyTime}</span>\
        </div>\
    </div>';CenterSliderPanel.prototype.show=function(container){this.$container=$(container);this.init();};CenterSliderPanel.prototype.init=function(){var _this=this;if(this.ws.modalCount===undefined){this.renderPanel();}};CenterSliderPanel.prototype.renderPanel=function(){var _this=this,tempHTML=[];var sign=this.readonly?'<span class="btnRemove glyphicon glyphicon-link" title="From Template"></span>':'<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove"></span>';var cls=this.readonly?' slider-readonly':'';this.$itemCtn=this.$container;this.ws.modalList.forEach(function(modal){tempHTML.push(_this.tpl.formatEL({id:modal.id,name:modal.name||'Untitled',sign:sign,modifyTime:timeFormat(modal.modifyTime,timeFormatChange('yyyy-mm-dd hh:ii')),cls:cls,imagebin:function(){if(modal.imagebin)return'background-image: url('+modal.imagebin+')';else return'';}()}));});if(!this.readonly){tempHTML.push('<div class="divPage slider-item-add" style="background-image: none;">\
            <h4 style="cursor: pointer;z-index: 1;position: absolute;left: 50%;top: 50%;margin-left: -16px;margin-top: -16px;" id="btnAddSlider">\
                <span class="glyphicon glyphicon-plus" style="font-size: 32px;"></span>\
            </h4>\
            <div class="effect"></div>\
            </div>');}
this.$container.html(tempHTML.join(''));this.attachEvent();this.attachItemEvents(this.$container.find('.slider-item'));};CenterSliderPanel.prototype.attachEvent=function($container){var _this=this;EventAdapter.on($(this.$container.find('.slider-item-add')),'click',function(e){var modal={id:ObjectId(),name:"",note:"",option:{},type:"",modifyTime:new Date().format('yyyy-MM-dd HH:mm')};return _this.model.create(modal,_this.ws.id,_this.referTo).done(function(){_this.ws.modalList.push(modal);});});};CenterSliderPanel.prototype.attachItemEvents=function($items){var _this=this;var $btnRemoveList=$('.btnRemove ',$items);var $titleList=$('.divPageTitle',$items);var $checkBoxList=$('.slider-cb',$items);!this.readonly&&EventAdapter.on($btnRemoveList,'click',function(e){e.stopPropagation();var modalId=$(this).closest('.divPage').attr('data-id');return _this.model.delete(modalId,_this.ws.id,_this.referTo).done(function(){var modal,i=0;for(;modal=_this.ws.modalList[i];i++){if(modal.id===modalId){_this.ws.modalList.splice(i,1);return;}}});});!this.readonly&&EventAdapter.on($titleList,'click',function(e){e.stopPropagation();var $target=$(e.target);var $textarea=$('<textarea value="" placeholder="Input name"/>');$textarea.blur(function(){var modal,i=0;var modalId=$(this).closest('.divPage').attr('data-id');var params;$(this).closest('.divPage').attr('draggable',true);$(this).prev('.modalNameSp').show();$(this).remove();for(;modal=_this.ws.modalList[i];i++){if(modal.id===modalId){params={id:modalId,name:$(this).val(),modifyTime:new Date().format('yyyy-MM-dd HH:mm')};_this.model.update(params,_this.ws.id,_this.referTo).done(function(modal){modal.modifyTime=params.modifyTime;modal.name=params.name;}.bind(this,modal));break;}}}).keypress(function(e){if(e.keyCode===13)$(this).blur();}).focus(function(){$(this).closest('.divPage').attr('draggable',false);$(this).select().prev('.modalNameSp').hide();});EventAdapter.on($textarea,'click',function(e){e.stopPropagation();});$target.hide().after($textarea);$textarea.val($target.html()).focus();});EventAdapter.on($checkBoxList,'click',function(e){e.stopPropagation();var $slider=$(this).closest('.divPage');$slider.toggleClass('checked');});EventAdapter.on($items,'click',function(e){e.stopPropagation();var sliderId=$(this).attr('data-id');$('#lp_'+sliderId).trigger('click');});!this.ws.templateId&&this.attachDragEvents(this.$container.find('.slider-item'));};CenterSliderPanel.prototype.updateSlider=function(modal){var _this=this;var $modal=$('#cp_'+modal.id);var $name,$modifyTime;if(!$modal||!$modal.length)return;if(modal.name){$name=$('.modalNameSp',$modal);$name.text(modal.name||'Untitled');}
$modifyTime=$('.modifyTime',$modal);$modifyTime.text('Recently:  '+timeFormat(modal.modifyTime,timeFormatChange('yyyy-mm-dd hh:ii'))||'');if(modal.imagebin)$modal.css('background-image','url('+modal.imagebin+')');};CenterSliderPanel.prototype.removeSlider=function(modal){$('#cp_'+modal.id,this.$container).remove();};CenterSliderPanel.prototype.addSlider=function(modal){var $slider;var sign=this.readonly?'<span class="btnRemove glyphicon glyphicon-link" title="From Template"></span>':'<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove"></span>';var cls=this.readonly?' slider-readonly':'';$slider=$(this.tpl.formatEL({id:modal.id,name:modal.name||'Untitled',modifyTime:timeFormat(modal.modifyTime,timeFormatChange('yyyy-mm-dd hh:ii')),sign:sign,cls:cls}));this.$itemCtn.find('.slider-item-add').before($slider);this.$itemCtn[0].scrollTop=this.$itemCtn[0].scrollHeight;this.attachItemEvents($slider);return $slider;};CenterSliderPanel.prototype.close=function(){this.$container.empty();this.$container.off();};CenterSliderPanel.prototype.attachDragEvents=function($items){var _this=this;var startIndex,$dragEle;var dataUrl;var sliderWidth=$items.eq(0).width();var sliderHeight=$items.eq(0).height();$items.off('dragstart').on('dragstart',function(e){var $target=$dragEle=$(e.target);startIndex=$target.index();dataUrl=$target[0].style.backgroundImage;$target[0].style.backgroundImage='none';$target.addClass('on-drag');});$items.off('dragover').on('dragover',function(e){var $target=$(e.target);var oEvent=e.originalEvent;var offset;if($target===$dragEle)return;if(!$target.hasClass('divPage'))$target=$target.closest('.divPage');offset=$target.offset();if(oEvent.pageX-offset.left>sliderWidth/2){$dragEle.insertAfter($target);}
else{$dragEle.insertBefore($target);}
e.stopPropagation();});$items.off('dragend').on('dragend',function(e){var endIndex=$dragEle.index();$dragEle[0].style.backgroundImage=dataUrl;$dragEle.removeClass('on-drag');if(startIndex===endIndex)return;_this.ws.modalList.move(startIndex,endIndex);});};return CenterSliderPanel;}(window,jQuery,window.analysis.models.ModalModel);window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.LeftSliderPanel=function(window,$,Model,undefined){function LeftSliderPanel(screen,ws){this.screen=screen;this.ws=ws;this.readonly=ws.templateId&&ws.templateId!==ws.id?true:false;this.referTo=ws.templateId===ws.id?'tpl':'ws';this.model=new Model();};LeftSliderPanel.prototype.tpl='\
    <div class="divPage slider-item{cls}" id="lp_{id}" data-id="{id}" draggable="true" style="{imagebin}" >\
        <h4 class="divPageTitle">\
        <div class="modalNameSp">{name}</div>\
        </h4>\
        {sign}\
        <div class="effect"></div>\
    </div>';LeftSliderPanel.prototype.show=function(container){this.$container=$(container);this.init();};LeftSliderPanel.prototype.init=function(){var _this=this;if(this.ws.modalCount!==undefined){if(this.ws.modalCount===0){delete this.ws.modalCount;this.renderPanel();}
else if(this.ws.modalCount===-1){delete this.ws.modalCount;_this.displayThumbnail(this.ws.modalList).done(function(){_this.renderPanel();});}
else{Spinner.spin(ElScreenContainer);WebAPI.post('/analysis/getModals',{idList:[this.ws.id]}).done(function(rs){rs=rs[_this.ws.id];_this.displayThumbnail(rs.modalList).done(function(){delete _this.ws.modalCount;_this.ws.modalList=rs.modalList;_this.renderPanel();}).always(function(){Spinner.stop();});_this.screen.mergeDsInfoList(rs.dsInfoList);}).fail(function(){Spinner.stop();});}}else{this.renderPanel();}};LeftSliderPanel.prototype.displayThumbnail=function(modalList){var wsId=this.ws.id;var promise=$.Deferred();modalList=modalList.filter(function(row){return!!row.type;});window.Beop.cache.img.getChkByWs({id:wsId,modalList:modalList}).done(function(rs){var imgData=rs.data;var absentList=rs.absentList;modalList.forEach(function(modal){var key=wsId+'_'+modal.id;if(imgData[key]!==undefined){modal.imagebin=imgData[key];}});if(!absentList.length){promise.resolve();return;}
WebAPI.post('/analysis/getThumbnails',{modalIdList:absentList}).done(function(rs){var modalsNeedCache=[];modalList.forEach(function(modal){if(rs[modal.id]!==undefined){modal.imagebin=rs[modal.id];modalsNeedCache.push(modal);}});window.Beop.cache.img.setByWs({id:wsId,modalList:modalsNeedCache}).fail(function(){console.warn('thumbnail save to cache failed!');});}).fail(function(){console.warn('get thumbnail failed!');}).always(function(){promise.resolve();});});return promise;};LeftSliderPanel.prototype.renderPanel=function(){var _this=this,tempHTML=[];var sign=this.readonly?'<span class="btnRemove glyphicon glyphicon-link" title="From Template"></span>':'<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove"></span>';var cls=this.readonly?' slider-readonly':'';this.$itemCtn=this.$container.find('.panel-body');this.$divWsName=$('.dropdownWS',this.$container);this.$panelHead=$('.panel-heading',this.$container);this.$btnGroup=$('#btnGroup',this.$container);this.$btnAddSlider=$('#btnPageAdd',this.$container);this.ws.modalList.forEach(function(modal){tempHTML.push(_this.tpl.formatEL({id:modal.id,name:modal.name||'Untitled',sign:sign,cls:cls,imagebin:function(){if(modal.imagebin)return'background-image: url('+modal.imagebin+')';else return'';}()}));});this.$divWsName.text(this.ws.name);this.$panelHead.children().show();this.$btnGroup.show();if(this.readonly)this.$container.addClass('panel-readonly');this.$itemCtn.html(tempHTML.join(''));this.attachEvent();this.attachItemEvents(this.$itemCtn.find('.slider-item'));};LeftSliderPanel.prototype.updateSlider=function(modal){var $modal=$('#lp_'+modal.id);var $name;if(!$modal||!$modal.length)return;if(modal.name){$name=$('.modalNameSp','#lp_'+modal.id);$name.html(modal.name||'Untitled');}
if(modal.imagebin)$modal.css('background-image','url('+modal.imagebin+')');};LeftSliderPanel.prototype.removeSlider=function(modal){var newIndex,$newModal;var $modal=$('#lp_'+modal.id,this.$container);if($modal.hasClass('selected')&&this.ws.modalList.length>0){newIndex=Math.min($modal.index(),this.ws.modalList.length-1);$newModal=$('#lp_'+this.ws.modalList[newIndex].id,this.$container);}else if(this.ws.modalList.length<=0){this.screen.path.pop();}
$modal.remove();if($newModal!==undefined){$newModal.trigger('click');}};LeftSliderPanel.prototype.addSlider=function(modal){var sign='<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove"></span>';var $slider=$(this.tpl.formatEL({id:modal.id,name:modal.name||'Untitled',modifyTime:modal.modifyTime,sign:sign,cls:''}));this.$itemCtn.append($slider);this.$itemCtn[0].scrollTop=this.$itemCtn[0].scrollHeight;this.attachItemEvents($slider);$slider.trigger('click');};LeftSliderPanel.prototype.attachEvent=function(){var _this=this;EventAdapter.on(this.$btnAddSlider.off('click'),'click',function(e){var modal={id:ObjectId(),name:'',type:'',note:'',modifyTime:new Date().format('yyyy-MM-dd HH:mm:ss'),option:{}};return _this.model.create(modal,_this.ws.id,_this.referTo).done(function(){_this.ws.modalList.push(modal);});});};LeftSliderPanel.prototype.detachEvent=function(){};LeftSliderPanel.prototype.attachItemEvents=function($items){var _this=this;var $btnRemoveList=$('.btnRemove ',$items);var $titleList=$('.divPageTitle',$items);!this.readonly&&EventAdapter.on($btnRemoveList,'click',function(e){e.stopPropagation();var modalId=$(this).closest('.divPage').attr('data-id');return _this.model.delete(modalId,_this.ws.id,_this.referTo).done(function(){var modal,i=0;for(;modal=_this.ws.modalList[i];i++){if(modal.id===modalId){_this.ws.modalList.splice(i,1);return;}}});});!this.readonly&&EventAdapter.on($titleList,'click',function(e){e.stopPropagation();var $target=$(e.target);var $textarea=$('<textarea value="" placeholder="Input name"/>');$textarea.blur(function(){var modal,i=0;var modalId=$(this).closest('.divPage').attr('data-id');var params;$(this).closest('.divPage').attr('draggable',true);$(this).prev('.modalNameSp').show();$(this).remove();for(;modal=_this.ws.modalList[i];i++){if(modal.id===modalId){params={id:modalId,name:$(this).val(),modifyTime:new Date().format('yyyy-MM-dd HH:mm')};_this.model.update(params,_this.ws.id,_this.referTo).done(function(modal){var path=_this.screen.path[_this.screen.path.length-1];modal.modifyTime=params.modifyTime;modal.name=params.name;if(modalId===path.data['id']){path.title=params.name;_this.screen.renderBreadCrumb();}}.bind(this,modal));break;}}}).keypress(function(e){if(e.keyCode===13)$(this).blur();}).focus(function(){$(this).closest('.divPage').attr('draggable',false);$(this).select().prev('.modalNameSp').hide();});EventAdapter.on($textarea,'click',function(e){e.stopPropagation();});$target.hide().after($textarea);$textarea.val($target.html()).focus();});EventAdapter.on($items,'click',function(e){var modalList=_this.ws.modalList;var modalId=this.dataset.id;var modal,i=0;var path=_this.screen.path;_this.$container.find('.selected').removeClass('selected');$(this).addClass('selected');for(;modal=modalList[i++];){if(modal.id===modalId)break;};_this.renderPath(modal);e.stopPropagation();});!this.ws.templateId&&this.attachDragEvents(this.$container.find('.slider-item'));};LeftSliderPanel.prototype.attachDragEvents=function($items){var _this=this;var startIndex,$dragEle;var dataUrl;var sliderWidth=$items.eq(0).width();var sliderHeight=$items.eq(0).height();$items.off('dragstart').on('dragstart',function(e){var $target=$dragEle=$(e.target);startIndex=$target.index();dataUrl=$target[0].style.backgroundImage;$target[0].style.backgroundImage='none';$target.addClass('on-drag');});$items.off('dragover').on('dragover',function(e){var $target=$(e.target);var oEvent=e.originalEvent;var offset;if($target===$dragEle)return;if(!$target.hasClass('divPage'))$target=$target.closest('.divPage');offset=$target.offset();if(oEvent.pageY-offset.top>sliderHeight/2){$dragEle.insertAfter($target);}
else{$dragEle.insertBefore($target);}
e.stopPropagation();});$items.off('dragend').on('dragend',function(e){var endIndex=$dragEle.index();$dragEle[0].style.backgroundImage=dataUrl;$dragEle.removeClass('on-drag');if(startIndex===endIndex)return;_this.ws.modalList.move(startIndex,endIndex);});};LeftSliderPanel.prototype.close=function(){this.$itemCtn.empty();this.$divWsName.text('');this.$panelHead.children().hide();this.$btnGroup.hide();this.$container.removeClass('panel-readonly');};LeftSliderPanel.prototype.renderPath=function(modal){var path=this.screen.path;if(path[path.length-1].isSlider){path.splice(path.length-1,1,{isSlider:true,type:modal.type||'AnalysisTemplate',title:modal.name||'Untitled',data:modal});}else{path.push({isSlider:true,type:modal.type||'AnalysisTemplate',title:modal.name||'Untitled',data:modal});}};return LeftSliderPanel;}(window,jQuery,window.analysis.models.ModalModel);window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.WorkspacePanel=function(window,$,Model,undefined){function WorkspacePanel(screen,wsList){this.screen=screen;this.wsList=wsList;this.model=new Model();};WorkspacePanel.prototype.tpl='\
    <div class="wsSet ws-item{cls}{tplCls}" draggable="true" data-id ="{id}">\
        <div class="wsCtn">\
            <div class="dragHere"></div>\
            <span class="check-cb-wrap"><i class="check-cb"></i></span>\
            <div class="infoWrap">\
                <span class="name">{name}</span><span class="glyphicon glyphicon-pencil wsNameEdit"></span>\
                <div class="modifyTime">{modifyTime}</div>\
            </div>\
            <div class="btnWsRemove"><span class="glyphicon glyphicon-remove-sign"></span></div>\
        </div>\
    </div>';WorkspacePanel.prototype.show=function(container){this.$container=$(container);this.init();};WorkspacePanel.prototype.init=function(){var _this=this;var arrHtml=[];this.screen.store.workspaces.forEach(function(row,i){arrHtml.push(_this.tpl.formatEL({id:row.id,name:row.name||'Untitled',modifyTime:timeFormat(row.modifyTime,timeFormatChange('yyyy-mm-dd hh:ii'))||'',cls:function(){if(row.modalCount!==undefined){len=row.modalCount;}else{len=row.modalList.length;}
return len>0?'':' empty';}(),tplCls:row.templateId?' fromTemplate':''}));});arrHtml.push('<div class="wsSet ws-add empty">\
                        <div class="wsCtn">\
                            <h3 style="color: #fff;position: absolute;left: 66px;top: 40px;"><span class="glyphicon glyphicon-plus"></span></h3>\
                        </div>\
                    </div>');this.$container.html(arrHtml.join(''));this.attachEvents();this.attachItemsEvents($('.ws-item',this.$container));};WorkspacePanel.prototype.attachEvents=function(){var _this=this;EventAdapter.on(this.$container,'click','.check-cb-wrap',function(e){$(this).closest('.wsSet').toggleClass('on');e.stopPropagation();});EventAdapter.on(this.$container,'click','.wsNameEdit',function(e){e.stopPropagation();var _that=this;var $wsSet=$(this).closest('.wsSet');$wsSet.attr('draggable',false);$wsSet.find('.dragHere')[0].style.cursor='initial';var oldName=$(this).prev('.name').html();var $input=$('<input type="text" style="display: inline-block; width: 120px;"/>').val(oldName);EventAdapter.on($input,'click',function(e){e.stopPropagation();});var $button=$('<button type="button" class="btn btn-default" style="display: inline-block;padding: 1px 5px;margin-left: 9px;margin-top: -2px;">OK</button>');EventAdapter.on($button,'click',function(e){e.stopPropagation();var newName=$input.val();$(_that).removeAttr('style');$(_that).prev('.name').show();$(_that).closest('.wsSet').attr('draggable',true);$wsSet.find('.dragHere').removeAttr('style');$input.remove();$(this).remove();if(!newName||newName.length==0||oldName==newName)return;var wsId=$(_that).closest('.ws-item').attr('data-id');var match=getWorkspaceById(wsId);if(match!==undefined){match.name=newName;}});$(this).hide().prev('.name').hide();$(this).after($button).after($input);$input.focus();});EventAdapter.on(this.$container,'click','.ws-item',function(e){var wsId=this.dataset.id;var match=getWorkspaceById(wsId);if(match!==undefined){_this.screen.path.push({type:'CenterSliderPanel',title:match.name,data:match});}
localStorage.setItem('lastOpenWorkspaceId_'+AppConfig.userId,wsId);});EventAdapter.on(this.$container,'click','.btnWsRemove',function(e){e.stopPropagation();var wsId=$(this).closest('.ws-item').attr('data-id');var match=getWorkspaceById(wsId);confirm(I18n.resource.analysis.workspace.CONFIRM_WORKSPACE_DELETE,function(){if(match!==undefined){_this.screen.store.workspaces.forEach(function(ws,index){if(ws.id==wsId){_this.screen.store.workspaces.splice(index,1);}});}});});EventAdapter.on(this.$container.find('.ws-add').off('click'),'click',function(e){e.stopPropagation();var ws={id:ObjectId(),name:'new Workspace',modalList:[],modifyTime:new Date().format('yyyy-MM-dd HH:mm')};_this.screen.store.workspaces.push(ws);});function getWorkspaceById(wsId){var workspaces=_this.screen.store.workspaces;for(var i=0,len=workspaces.length;i<len;i++){if(workspaces[i].id===wsId){match=workspaces[i];break;}}
return match;}};WorkspacePanel.prototype.detachEvents=function(){this.$container.off('click');};WorkspacePanel.prototype.attachItemsEvents=function($items){this.attachDragEvents($('.ws-item',this.$container));};WorkspacePanel.prototype.detachItemsEvents=function($items){};WorkspacePanel.prototype.addOne=function(data){var _this=this;var $item,idList;var spinner;$item=$(_this.tpl.formatEL({id:data.id,name:data.name||'Untitled',modifyTime:data.modifyTime||'',cls:data.modalList.length>0?'':' empty',tplCls:data.templateId?' fromTemplate':''}));_this.$container.find('.ws-add').before($item);if(data.dsOwnerId!==undefined){idList=[];data.modalList.forEach(function(modal){var itemDs=modal.option['itemDS'];if(itemDs&&itemDs.length){itemDs.forEach(function(item){item['arrId'].forEach(function(dsId){if(idList.indexOf(dsId)===-1){idList.push(dsId);}});});}});if(idList.length>0){spinner=new LoadingSpinner({color:'#00FFFF'});spinner.spin($item[0]);WebAPI.post('/analysis/getDsList/'+data.dsOwnerId,{idList:idList}).done(function(rs){if(!!rs['dsInfoList']){_this.screen.mergeDsInfoList(rs['dsInfoList']);}}).always(function(){spinner.stop();});}}
this.model.create(data).done(function(){_this.attachItemsEvents($item);if(data.modalList&&data.modalList.length){Beop.cache.img.setByWsList([data]);}});};WorkspacePanel.prototype.removeOne=function(data){var _this=this;var wsId=data.id;var modalList=data.modalList;var $workSpace=_this.$container.find('[data-id="'+wsId+'"]');modalList.forEach(function(row){localStorage.removeItem('ws_'+wsId+'_modal_'+row.id);});$workSpace.remove();this.model.delete(wsId).done(function(result){Beop.cache.img.removeByWsList([data]);});};WorkspacePanel.prototype.updateOne=function(data){var _this=this;$('[data-id="'+data.id+'"]',_this.$container).find('.name').text(data.name);this.model.update(data).done(function(){});};WorkspacePanel.prototype.close=function(){this.$container.empty();this.detachEvents();};WorkspacePanel.prototype.attachDragEvents=function($items){var _this=this;var startIndex,$dragEle;var dataUrl;var sliderWidth=$items.eq(0).width();var sliderHeight=$items.eq(0).height();$items.off('dragstart').on('dragstart',function(e){var $target=$dragEle=$(e.target);startIndex=$target.index();dataUrl=$target[0].style.backgroundImage;$target[0].style.backgroundImage='none';$dragEle.addClass('on-drag');});$items.off('dragover').on('dragover',function(e){var $target=$(e.target);var oEvent=e.originalEvent;var offset;if($target===$dragEle)return;if(!$target.hasClass('ws-item'))$target=$target.closest('.ws-item');offset=$target.offset();if(oEvent.pageX-offset.left>sliderWidth/2){$dragEle.insertAfter($target);}
else{$dragEle.insertBefore($target);}
e.stopPropagation();});$items.off('dragend').on('dragend',function(e){var endIndex=$dragEle.index();$dragEle[0].style.backgroundImage=dataUrl;$dragEle.removeClass('on-drag');_this.wsList.move(startIndex,endIndex);});};return WorkspacePanel;}(window,jQuery,window.analysis.models.WorkspaceModel);window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.TemplatePanel=function(window,$,Model,undefined){function templatePanel(screen,tplData){this.screen=screen;this.tplData=tplData;this.tplType=AppConfig.userId===1?'pre':'user';this.model=new Model();};templatePanel.prototype.preTpl='\
    <div class="template preTemplate template-item" data-id="{id}">\
    <div class="templateImgBg"></div>\
    <div class="templateImg"></div>\
    <div class="divTemplateBtnGroup">{btns}</div>\
    <h3>{name}</h3>\
    <div class="infoWrap">\
        <span class="name">Creator:&nbsp;{creatorName}</span>\
        <div class="modifyTime">{modifyTime}</div>\
    </div>\
    </div>';templatePanel.prototype.userTpl='\
    <div class="template userTemplate template-item{isMyTpl}" data-id="{id}">\
    <div class="templateImgBg"></div>\
    <div class="templateImg"></div>\
    <div class="divTemplateBtnGroup">{btns}</div>\
    <h3><span class="tplName">{name}</span><span class="glyphicon glyphicon-pencil tplNameEdit"></span></h3>\
    <div class="infoWrap">\
        <span class="name">Creator:&nbsp;{creatorName}</span>\
        <div class="modifyTime">{modifyTime}</div>\
    </div>\
    </div>';templatePanel.prototype.show=function(container){this.$container=$(container);this.init();};templatePanel.prototype.init=function(){var _this=this;var arrHtml=[];this.tplData.preTemplate.forEach(function(row){arrHtml.push(_this.preTpl.formatEL({id:row.id,name:row.name,btns:function(){if(AppConfig.userId===row.creatorId){return['<span class="glyphicon glyphicon-edit grow btn-rt-corner"></span>','<span class="glyphicon glyphicon-remove-sign grow btn-rt-corner"></span>'].join('');}
return'';}(),creatorName:row.creatorName||'Unknow',modifyTime:row.modifyTime||''}));});this.tplData.userTemplate.forEach(function(row){arrHtml.push(_this.userTpl.formatEL({id:row.id,name:row.name,btns:function(){if(AppConfig.userId===row.creatorId){return['<span class="glyphicon glyphicon-edit grow btn-rt-corner"></span>','<span class="glyphicon glyphicon-remove-sign grow btn-rt-corner"></span>'].join('');}
return'';}(),creatorName:row.creatorName||'Unknow',modifyTime:row.modifyTime||'',isMyTpl:row.creatorId==AppConfig.userId?' myTpl':''}));});arrHtml.push('<div class="template template-add"><h3><span class="glyphicon glyphicon-plus" style="font-size: 28px;margin-left: -88px;"></span></h3></div>');this.$container.html(arrHtml.join(''));this.attachEvents();this.attachItemsEvents($('.template-item',this.$container));};templatePanel.prototype.removeOne=function(data){var _this=this;var tplId=data.id;var $item=_this.$container.children('[data-id="'+tplId+'"]');$item.remove();this.model.delete(tplId).done(function(){});};templatePanel.prototype.addOne=function(data){var _this=this;var $item,data;var tpl=AppConfig.userId===1?'preTpl':'userTpl';$item=$(_this[tpl].formatEL({id:data.id,name:data.name,btns:function(){return['<span class="glyphicon glyphicon-edit grow btn-rt-corner"></span>','<span class="glyphicon glyphicon-remove-sign grow btn-rt-corner"></span>'].join('');}(),creatorName:data.creatorName,modifyTime:data.modifyTime,isMyTpl:' myTpl'}));$item.insertBefore(_this.$container.find('.template-add').eq(0));this.model.create(data).done(function(rs){});};templatePanel.prototype.updateOne=function(data){var _this=this;var $tpl=$('[data-id="'+data.id+'"]',_this.$container);$tpl.find('.tplName').text(data.name);$tpl.find('.modifyTime').text(data.modifyTime);this.model.update(data).done(function(){});};templatePanel.prototype.findTemplateById=function(id){var hit=null;var t,i,row,tpl;for(t in this.tplData){row=this.tplData[t];i=0;while(tpl=row[i++]){if(tpl.id===id){hit=tpl;break;}}
if(hit)return hit;}
return null;};templatePanel.prototype.attachEvents=function(){var _this=this;var templates=_this.tplData[_this.tplType+'Template'];EventAdapter.on($(this.$container.find('.template-add')),'click',function(e){var template,i=0,inputName;if(!AppConfig.projectId){alert('Please choose a project in home page first.');return;}
inputName=prompt('Please input template name: ');if(!inputName||$.trim(inputName).length==0)return;templates.push({id:ObjectId(),creatorId:AppConfig.userId,modalList:[],name:inputName,projectId:AppConfig.projectId,creatorName:AppConfig.userProfile.fullname,modifyTime:new Date().format('yyyy-MM-dd HH:mm')});e.stopPropagation();});EventAdapter.on(this.$container,'click','.glyphicon-remove-sign',function(e){var tplId,template,i=0,_this=this;confirm(I18n.resource.analysis.workspace.CONFIRM_TEMPLATE_DELETE,function(){tplId=$(_this).closest('.template-item').attr('data-id');while(template=templates[i++]){if(template.id===tplId){templates.splice(i-1,1);break;}}});e.stopPropagation();});EventAdapter.on(this.$container,'click','.glyphicon-edit',function(e){var tplId=$(this).closest('.template-item').attr('data-id');var template,i=0;while(template=templates[i++]){if(template.id===tplId){break;}};template.templateId=template.id;_this.screen.path.push({type:'CenterSliderPanel',title:template.name+' [Template Edit Mode]',data:template});e.stopPropagation();});EventAdapter.on(this.$container,'click','.template-item',function(e){e.stopPropagation();if(e.target.tagName.toLowerCase()=='input')return;var tplId=this.dataset.id;var template=_this.findTemplateById(tplId);var modelName=template.name;var $divModalSel=$('#modelSelsect',ElScreenContainer);if($divModalSel.length===0){$divModalSel=$('<div class="modal fade" id="modelSelsect" role="dialog" style="padding-top: 110px;"><div class="modal-dialog" role="document"><div class="modal-content">'+'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">'+I18n.resource.analysis.workspace.APPLICATION_TEMPLATE+' -  '+modelName+'</h4></div>'+'<div class="modal-body">'+'<p style="width:550px;margin:0 auto 10px;line-height:1.5;">'+I18n.resource.analysis.workspace.IS_SAVE_COPY_OF_TEMP+'</p>'+'<p style="color:#A3A3A3;width:550px;margin:0 auto;line-height:1.5;">'+I18n.resource.analysis.workspace.IF_SAVE_COPY+'</p>'+'</div>'+'<div class="modal-footer">'+'<button type="button" class="btn btn-default retain">'+I18n.resource.analysis.workspace.SAVE+'</button>'+'<button type="button" class="btn btn-default notRetain">'+I18n.resource.analysis.workspace.NOT_SAVE+'</button>'+'<button type="button" class="btn btn-default" data-dismiss="modal">'+I18n.resource.analysis.workspace.CANCEL+'</button></div>'+'</div></div></div>');$(ElScreenContainer).append($divModalSel);}
$('.modal-title',$divModalSel).html(I18n.resource.analysis.workspace.APPLICATION_TEMPLATE+'  -  '+modelName);EventAdapter.on($('.retain',$divModalSel).off('click'),'click',function(e){$divModalSel.modal('hide');_this.screen.path.splice(0,_this.screen.path.length,{type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:_this.screen.store.workspaces});_this.screen.store.workspaces.push({id:ObjectId(),name:template.name,dsOwnerId:template.creatorId,modalList:function(){var modalList=template.modalList.concat();modalList.forEach(function(modal){modal.id=ObjectId();});return modalList;}(),modifyTime:new Date().format('yyyy-MM-dd HH:mm')});});EventAdapter.on($('.notRetain',$divModalSel).off('click'),'click',function(e){$divModalSel.modal('hide');_this.screen.path.splice(0,_this.screen.path.length,{type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:_this.screen.store.workspaces});_this.screen.store.workspaces.push({id:ObjectId(),templateId:template.id,name:template.name,dsOwnerId:template.creatorId,modalList:template.modalList,modifyTime:new Date().format('yyyy-MM-dd HH:mm')});});$divModalSel.modal('show');});EventAdapter.on(this.$container,'click','.myTpl .tplNameEdit',function(e){e.stopPropagation();var _that=this;var oldName=$(this).prev('.tplName').html();var $editCt=$('<div style="position: absolute;top: 48%;left: 50%;margin-left: -50px;"></div>');var $input=$('<input type="text" style="display: inline-block; width: 120px;"/>').val(oldName);var $button=$('<button type="button" class="btn btn-default" style="display: inline-block;padding: 1px 5px;margin-left: 9px;margin-top: -2px;">OK</button>');EventAdapter.on($button,'click',function(e){e.stopPropagation();var newName=$input.val();$(_that).removeAttr('style');$(_that).prev('.tplName').show();$input.remove();$(this).remove();if(!newName||newName.length==0||oldName==newName)return;var tplId=$(_that).closest('.userTemplate ').attr('data-id');var match=undefined;_this.tplData.userTemplate.forEach(function(userTpl){if(userTpl.id==tplId){match=userTpl;}});if(match!==undefined){match.modifyTime=new Date().format('yyyy-MM-dd HH:mm');match.name=newName;}});$(this).hide().prev('.tplName').hide();$editCt.append($input).append($button);$(this).after($editCt);$input.focus();});};templatePanel.prototype.detachEvents=function(){this.$container.off('click');};templatePanel.prototype.attachItemsEvents=function($items){};templatePanel.prototype.detachItemsEvents=function($items){};templatePanel.prototype.close=function(){this.$container.empty();this.detachEvents();};return templatePanel;}(window,jQuery,window.analysis.models.TemplateModel);var TerminalDebugging=function(){var _this;function TerminalDebugging(){_this=this;this.jqueryMap={};this.stateMap={};this.currentPage=1;this.page_size=1000;this.filterType={'name':0,'value':1,'range':2,'time':3,'explain':4,'define':5};this.searchModel={filterType:0,isAdvance:false,text:''};this.pointType={mapping:0||null,Algorithm:1,Calculation:2};}
TerminalDebugging.prototype.constructor=TerminalDebugging;TerminalDebugging.prototype={show:function show(){Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/terminalDebugging.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.stateMap.$container=$('#terminalDebugContainer');_this.historyStatusPopover=$('#deleteExpiredData').popover({html:true,placement:'bottom',content:'clear time setting',container:$("#realTimeBtnBox"),template:$('#tpl_real_time_popover').html()});_this.getDtuList();_this.setJqueryMap();_this.attachEvents();_this.refreshFilter(_this.filterType.name);}).always(function(){Spinner.stop();});},getDtuList:function getDtuList(){WebAPI.get('/terminal/list_dtu').done(function(result){_this.setting={callback:{onClick:_this.onTreeClick.bind(_this)},view:{fontCss:_this.setFontCss.bind(_this)}};if(result.success){var firstInit=!_this.tree;for(var i=0,iLen=result.data.length;i<iLen;i++){result.data[i].name=result.data[i].dtuname;result.data[i].dtuRemark&&(result.data[i].name+=' ('+result.data[i].dtuRemark+')');}
_this.dtu_list=result.data;_this.dtu_list.map(function(item){item.iconSkin='iconfont icon_is_online';});var showFirstDtu=function showFirstDtu(){var allNodes=_this.tree.getNodes();_this.currentDtuInfo=allNodes[0];};if(!_this.setRemarkedDtu&&_this.tree){showFirstDtu();}
_this.tree=$.fn.zTree.init($('#list_dtu_Tree'),_this.setting,_this.dtu_list);firstInit&&showFirstDtu();_this.dbname=result.data[0].dbname;if(_this.setRemarkedDtu){var treeNode=_this.tree.getNodeByParam('id',_this.currentDtuInfo.id);$('#'+treeNode.tId+'_span').click();_this.setRemarkedDtu=null;}
_this.loadRealDataTable();_this.showDtuInfo();}});},refreshFilter:function refreshFilter(type){$("#filterBox").empty().html(beopTmpl('tpl_data_manage_filter',{'type':type}));I18n.fillArea($(ElScreenContainer));},loadRealDataTable:function loadRealDataTable(){var $table=$("#debugRealTimeDataTable");var pageSizeIndex,$pageSizeSelect=$table.find(".pageSizeSelect");if($pageSizeSelect.length){pageSizeIndex=$pageSizeSelect.find("option:selected").index();}else{pageSizeIndex=1;}
var dataTableOptions={url:'/admin/dataPointManager/search/',post:WebAPI.post,postData:{dbname:this.dbname,current_page:this.currentPage,page_size:this.page_size,text:this.searchModel.text?this.searchModel.text:'',isAdvance:this.searchModel.isAdvance?this.searchModel.isAdvance:false,order:this.searchModel.order?this.searchModel.order:null,isRemark:this.searchModel.isRemark,flag:0},searchOptions:{pageSize:'page_size',pageNum:'current_page',searchText:'text'},searchInput:$("#debugSearchPoint"),rowsNums:[100,200,500,1000],pageSizeIndex:pageSizeIndex,dataFilter:function dataFilter(result){return result.list;},onBeforeRender:function onBeforeRender(){Spinner.spin(document.body);},onAfterRender:function onAfterRender(){Spinner.stop();},totalNumIndex:'total',colNames:['点名','点值','更新时间'],colModel:[{index:'pointname'},{index:'pointvalue'},{index:'time',type:'time'}],onRowClick:function onRowClick(tr,data){_this.currentPointData=data;$(this).toggleClass('active');},onRowDbClick:function onRowDbClick(tr,data){_this.currentPointData=data;},filters:[{param:'order',element:$('#filterSort'),event:'change',callback:function callback(sortIndex){switch(sortIndex){case'0':{return'pointname asc';}
case'1':{return'pointname desc';}
case'2':{return'pointvalue desc';}
case'3':{return'pointvalue asc';}
case'4':{return'time desc';}
case'5':{return'time asc';}
default:{return'';}}}}]};$('#debugTableWrapper').off().simpleDataTable(dataTableOptions);},onTreeClick:function onTreeClick(event,treeId,treeNode,clickFlag){_this.dbname=treeNode.dbname;_this.currentDtuInfo=treeNode;_this.showDtuInfo();_this.loadRealDataTable();},setFontCss:function setFontCss(treeId,treeNode){return treeNode.online=='Offline'?{color:'red'}:{color:'green'};},showDtuInfo:function showDtuInfo(){if(_this.currentDtuInfo.serverCode!='0'&&!_this.currentDtuInfo.serverCode!='1'){$('#dtuInfoContainer').hide();}else{$('#dtuInfoContainer').show();_this.jqueryMap.$dtuInfo.html(beopTmpl('tpl_dtu_info',_this.currentDtuInfo));}},searchProject:function searchProject(){var searchText=this.jqueryMap.$searchProject.find('input').val()||'';if(!searchText||!searchText.trim()){_this.tree=$.fn.zTree.init($('#list_dtu_Tree'),_this.setting,_this.dtu_list);}else{var searchList=[];for(var i=0,iLen=_this.dtu_list.length;i<iLen;i++){var keywordsArr=searchText.toLowerCase().split(' ');var isMatch=true;for(var j=0,jLen=keywordsArr.length;j<jLen;j++){if(!eval('/'+keywordsArr[j]+'/').exec(_this.dtu_list[i].dtuname.toLowerCase())){isMatch=false;break;}}
isMatch&&searchList.push(_this.dtu_list[i]);}
_this.tree=$.fn.zTree.init($('#list_dtu_Tree'),_this.setting,searchList);}},setJqueryMap:function setJqueryMap(){var $container=_this.stateMap.$container;this.jqueryMap=$.extend(this.jqueryMap?this.jqueryMap:{},{$container:$container,$debugLeftContainer:$container.find('#debugLeftContainer'),$searchProject:$container.find('#searchProjectBox'),$searchProjectBtn:$container.find('#searchProjectBtn'),$dtuInfo:$container.find('#dtuInfo')});},close:function close(){},setSearchModel:function setSearchModel(){this.currentPage=1;var value;this.searchModel.isRemark=false;if(this.searchModel.filterType==this.filterType.name){value=$('#debugSearchPoint').val().trim();this.searchModel.text=value;}else if(this.searchModel.filterType==this.filterType.value){value=$('#debugSearchPoint').val().trim();if(!value){this.searchModel.text='1 = 1';}else{this.searchModel.text='pointvalue = "'+value+'"';}}else if(this.searchModel.filterType==this.filterType.range){var filterMin=$('#filterMin').val().trim(),filterMax=$('#filterMax').val().trim();if(filterMin===''&&filterMax!==''){this.searchModel.text=' pointvalue <= '+filterMax;}else if(filterMin!==''&&filterMax===''){this.searchModel.text='pointvalue >= '+filterMin;}else{this.searchModel.text='pointvalue >= '+filterMin+' and pointvalue <= '+filterMax;}
this.searchModel.text+=' and pointvalue REGEXP "^[0-9]+\\.?[0-9]*$" ';}else if(this.searchModel.filterType==this.filterType.time){var pointDateStart=$('#pointDateStart').val().trim(),pointDateEnd=$('#pointDateEnd').val().trim();if(pointDateStart===''&&pointDateEnd!==''){this.searchModel.text=' time <= "'+pointDateEnd+'"';}else if(pointDateStart!==''&&pointDateEnd===''){this.searchModel.text='time >= "'+pointDateStart+'"';}else{this.searchModel.text='time >= "'+pointDateStart+'" and time <= "'+pointDateEnd+'"';}}else if(this.searchModel.filterType==this.filterType.explain){this.searchModel.text=$('#debugSearchPoint').val().trim();this.searchModel.isRemark=true;}},destroyDatePicker:function destroyDatePicker(){if(this.pointDateStartInstance){this.pointDateStartInstance=null;this.pointDateEndInstance=null;}},attachEvents:function attachEvents(){var _this=this;var $realTimeBtnBox=$('#realTimeBtnBox'),$filterDefineWin=$('#filterDefineWin');this.jqueryMap.$searchProjectBtn.click(function(){_this.searchProject();});this.jqueryMap.$searchProject.off('keyup.search').on('keyup.search','input',function(e){if(e.which!=13){return;}
_this.searchProject();});_this.jqueryMap.$container.on('click','#dtuRemark',function(){var $this=$(this);$this.attr('contentEditable',true);$this.off().blur(function(){if($this.context.innerText.trim()==_this.currentDtuInfo.dtuRemark){return;}
WebAPI.post('/point_tool/setDtuRemark',{"remark":$this.context.innerText.trim(),"id":_this.currentDtuInfo.id}).done(function(result){if(result.success){_this.setRemarkedDtu=_this.currentDtuInfo;_this.getDtuList();alert.success('success');}else{alert(result.msg);}});});});$('#deleteExpiredData').click(function(){var startTime=$("#expiredDataStartTime").datetime({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii'});var endTime=$("#expiredDataEndTime").datetime({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii'});I18n.fillArea($(".realTimePopover"));});$('#realTimeBtnBox').on('click','#expiredDataConfirm',function(){var startTimeVal;var endTimeVal=new Date($('#expiredDataEndTime').val().trim()).format('yyyy-MM-dd HH:mm:59');if(!$('#expiredDataEndTime').val().trim()){alert('The end time can\'t be empty.');return;}else if(new Date()<new Date(endTimeVal)||/[a-zA-Z]/.test($('#expiredDataEndTime').val().trim())){alert('End time error');return;}else if(/[a-zA-Z]/.test($('#expiredDataStartTime').val().trim())){alert('Start time error');return;}
if($('#expiredDataStartTime').val().trim()){startTimeVal=new Date($('#expiredDataStartTime').val().trim()).format('yyyy-MM-dd HH:mm:00');}else{startTimeVal=new Date(new Date(endTimeVal)-30*60*1000).format('yyyy-MM-dd HH:mm:00');$('#expiredDataStartTime').val(new Date(startTimeVal).format('yyyy-MM-dd HH:mm'));}
if(new Date(startTimeVal)>new Date(endTimeVal)){alert(I18n.resource.common.TIME_COMPARE);return;}
infoBox.confirm(I18n.resource.dataManage.IS_DELETE_EXPIRED_DATA+' '+startTimeVal+' '+I18n.resource.dataManage.TO+' '+endTimeVal+' '+I18n.resource.dataManage.OF_DATA,function(){WebAPI.post('/sitedata/clear',{'projId':AppConfig.projectId,'startTime':startTimeVal,'endTime':endTimeVal}).done(function(result){if(result.success){_this.loadRealDataTable().done(function(){_this.historyStatusPopover.popover('hide');_this.historyStatusPopover.data("bs.popover").inState.click=false;});}else{console.log('error'+result.data);}});});});$("#joinCurve").click(function(){var selectedPoints=$('#debugTableWrapper').simpleDataTable('getSelectedData'),selectedPointsName=[],date_start,data_end,format;if(!selectedPoints.length){return;}
if(selectedPoints.length>10){alert.danger(I18n.resource.dataManage.UP_TO_TEN_RECORDS);return;}
selectedPointsName.map(function(item){return item.pointname;});selectedPointsName=selectedPointsName.filter(function(item,pos){return selectedPointsName.indexOf(item)==pos;});if(localStorage.getItem('dataManagerStartDate')){date_start=localStorage.getItem('dataManagerStartDate');data_end=localStorage.getItem('dataManagerEndDate');format=localStorage.getItem('dataManagerFormat')?localStorage.getItem('dataManagerFormat'):'m5';}else{date_start=new Date(new Date()-24*60*60*1000).format("yyyy-MM-dd HH:mm:00");data_end=new Date().format("yyyy-MM-dd HH:mm:00");format='m5';}
Spinner.spin(ElScreenContainer);WebAPI.post("/get_history_data_padded_reduce",{projectId:_this.projectId,pointList:selectedPointsName,timeStart:date_start.format("yyyy-MM-dd HH:mm:00"),timeEnd:data_end.format("yyyy-MM-dd HH:mm:00"),timeFormat:format}).done(function(data){var obj={data:data,startDate:date_start,endDate:data_end,format:format,pointList:selectedPointsName,projectId:_this.projectId,isShowRepairData:false};new HistoryChart(obj).show();}).fail(function(e){alert.danger(I18n.resource.observer.widgets.HISTORY_CURVE_FAILED);}).always(function(){Spinner.stop();});});$(document).on("click.hideExpiredTimeBox",function(e){var $target=$(e.target);if(!$target.closest("#deleteExpiredData").length&&!$target.closest(".popover").length){if(_this.historyStatusPopover.data("bs.popover")){_this.historyStatusPopover.data("bs.popover").inState.click=false;}
_this.historyStatusPopover.popover('hide');}});$("#pointRefresh").click(function(){_this.currentPage=1;_this.loadRealDataTable();});$("#doSearch").click(function(){_this.currentPage=1;_this.loadRealDataTable();});$('#pageSizeSelector').change(function(){_this.setPageSize($(this).val());_this.loadRealDataTable();_this.paginationRefresh(1);});$('#filterDefineConfirm').click(function(){_this.searchModel.text=$('#filterContent').val().trim();if(!_this.searchModel.text){return;}
_this.loadRealDataTable();$filterDefineWin.modal('hide');});$realTimeBtnBox.on('change','#filterType',function(){var val=$(this).val().trim();_this.refreshFilter(val);_this.searchModel={filterType:val,isAdvance:true};if(val==_this.filterType.name){_this.searchModel.isAdvance=false;}else if(val==_this.filterType.define){_this.destroyDatePicker();$filterDefineWin.modal();}else if(val==_this.filterType.time){_this.pointDateStartInstance=$("#pointDateStart").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:ss'});_this.pointDateEndInstance=$("#pointDateEnd").datetimepicker({startView:'month',autoclose:true,format:'yyyy-mm-dd hh:ii:ss'});}else{_this.destroyDatePicker();}}).on('click','#filterConfirm',function(){_this.setSearchModel();_this.loadRealDataTable();}).on('click','#defineFilterEdit',function(){$filterDefineWin.modal();});}};return TerminalDebugging;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var bmOverview=function(){function bmOverview(ctn,screen,opt){_classCallCheck(this,bmOverview);}
bmOverview.prototype.show=function show(){};return bmOverview;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BenchmarkConfig=function(){function BenchmarkConfig(ctn,screen,opt){_classCallCheck(this,BenchmarkConfig);this.ctn=ctn;this.screen=screen;this.store=$.extend(true,{point:{},cost:[],relate:[]},this.screen.opt);this.selectNode=undefined;}
BenchmarkConfig.prototype.show=function show(){var _this2=this;Spinner.spin(ElScreenContainer);WebAPI.get('/static/views/observer/benchmark/benchmarkConfig.html').done(function(html){_this2.ctn.innerHTML=html;I18n.fillArea($(_this2.ctn));_this2.init();Spinner.stop(ElScreenContainer);});};BenchmarkConfig.prototype.init=function init(){if(this.screen.iotFilter.projectId!=AppConfig.projectId)this.screen.initIotFilter(AppConfig.projectId);this.initConfigNav();this.initDataSource();this.initPointConfig();this.initCostConfig();this.initParamConfirm();};BenchmarkConfig.prototype.initConfigNav=function initConfigNav(){var _this3=this;var nav=this.ctn.querySelector('.navConfig');$(nav).off('click').on('click','.navItem',function(e){$('.ctnBenchmarkCfg').removeClass('focus');var type=e.currentTarget.dataset.type;$('.ctn'+type[0].toUpperCase()+type.slice(1)+'Config').addClass('focus');$(nav).children().removeClass('selected');$(e.currentTarget).addClass('selected');if(type=='cost')_this3.initChart(_this3.store.cost);});$(nav).children().first().trigger('click');};BenchmarkConfig.prototype.initPointConfig=function initPointConfig(){var _this4=this;var ctn=this.ctn.querySelector('.ctnBenchmarkCfg');$(ctn).off('dragover').on('dragover','.divPtCfg',function(e){e.preventDefault();});$(ctn).off('dragleave').on('dragleave','.divPtCfg',function(e){e.preventDefault();});$(ctn).off('drop').on('drop','.divPtCfg',function(e){e.preventDefault();if(!_this4.selectNode){infoBox.alert(I18n.resource.benchmark.paramsConfig.SELECT_NODE,'danger');return;}
var id=EventAdapter.getData().dsItemId;$(e.currentTarget).addClass('hasDs');var point=_this4.screen.dataSource.getDSItemById(id);$(e.currentTarget).find('.spPtVal').text(point.alias?point.alias:point.value);e.currentTarget.dataset.id=id;if(!_this4.store.point[_this4.selectNode['_id']])_this4.store.point[_this4.selectNode['_id']]={'model':[]};_this4.store.point[_this4.selectNode['_id']][e.currentTarget.dataset.type]=id;_this4.setSelectNodeConfigStatus();});$(ctn).find('.btnPtDel').off('click').on('click',function(e){$(e.currentTarget).prev().text('');var $divPtCfg=$(e.currentTarget).parent().parent();$divPtCfg.removeClass('hasDs');if(!_this4.store.point[_this4.selectNode['_id']])_this4.store.point[_this4.selectNode['_id']]={'model':[]};_this4.store.point[_this4.selectNode['_id']][$divPtCfg[0].dataset.type]='';_this4.setSelectNodeConfigStatus();});this.selectNode=this.screen.iotFilter.tree.getSelectedNodes()[0];if(!this.selectNode){var rootNode=this.screen.iotFilter.tree.getNodes()[0];if(rootNode&&rootNode.children[0])this.selectNode=rootNode.children[0];}
this.setPointConfigVal();};BenchmarkConfig.prototype.setPointConfigVal=function setPointConfigVal(){if(!this.selectNode){$('.divPointName').text(I18n.resource.benchmark.paramsConfig.SELECT_NODE);}else{$('.divPointName').text(I18n.resource.benchmark.paramsConfig.CURRENT_NODE+this.selectNode.name);var nodeConfig=this.store.point[this.selectNode['_id']];var power='',energy='';if(nodeConfig){power=nodeConfig.power?nodeConfig.power:'';energy=nodeConfig.energy?nodeConfig.energy:'';}
var $divPowerPt=$('.divPowerPt');var $divConsumePt=$('.divConsumePt');var point;if(power){$divPowerPt[0].dataset.id=power;point=this.screen.dataSource.getDSItemById(power);$divPowerPt.addClass('hasDs').find('.spPtVal').text(point.alias?point.alias:point.value);}else{$divPowerPt.removeClass('hasDs').find('.spPtVal').text('');}
if(energy){$divConsumePt[0].dataset.id=energy;point=this.screen.dataSource.getDSItemById(energy);$divConsumePt.addClass('hasDs').find('.spPtVal').text(point.alias?point.alias:point.value);}else{$divConsumePt.removeClass('hasDs').find('.spPtVal').text('');}}};BenchmarkConfig.prototype.initCostConfig=function initCostConfig(){var _this5=this;var ctn=this.ctn.querySelector('.divCtnCostConfig');if(this.store.cost instanceof Array){this.store.cost.sort(function(a,b){var dateA,dateB;if(!a.time){dateA='';}else{dateA=new Date(new Date().format('yyyy/MM/dd '+a.time));}
if(!a.time){dateB='';}else{dateB=new Date(new Date().format('yyyy/MM/dd '+b.time));}
if(dateA=='Invalid Date')dateA=0;if(dateB=='Invalid Date')dateB=0;return dateA-dateB;});for(var i=0;i<this.store.cost.length;i++){ctn.appendChild(this.createCostDom(this.store.cost[i]));}}else{ctn.appendChild(this.createCostDom());}
$(ctn).off('click').on('click','.btnCost',function(e){var $target=$(e.currentTarget);if($target.hasClass('btnCostAdd')){ctn.appendChild(_this5.createCostDom());}else if($target.hasClass('btnCostEdit')){$target.parent().find('.spCost').hide();$target.parent().find('.iptCost').show();}else if($target.hasClass('btnCostDel')){$target.parent().remove();}});$(ctn).off('blur').on('blur','.iptCost',function(e){var $target=$(e.currentTarget);$target.prev().text($target.val());if($target.val()){$target.hide();$target.prev().show();}else{$target.show();$target.prev().hide();}
var $brotherIpt=$target.siblings('input');if($brotherIpt.val()){$brotherIpt.hide();$brotherIpt.prev().show();}});};BenchmarkConfig.prototype.initChart=function initChart(arrCostItem){var arrData=[],arrTime=[];for(var i=0;i<arrCostItem.length;i++){arrData.push(arrCostItem[i].cost);arrTime.push(arrCostItem[i].time);}
var option={xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},data:arrTime}],series:[{name:'收入',type:'bar',stack:'总量',label:{normal:{show:true}},data:arrData}]};echarts.init(document.getElementById('divCostChart'),AppConfig.chartTheme).setOption(option);};BenchmarkConfig.prototype.setCostConfigStore=function setCostConfigStore(){var $divCost=$('.divCtnCostConfig .divCost');this.store.cost=[];var time,cost;for(var i=0;i<$divCost.length;i++){time=$divCost.eq(i).find('.iptCostTime').val();cost=$divCost.eq(i).find('.iptCostVal').val();this.store.cost.push({time:time?time:'',cost:cost?cost:''});}
this.store.cost.sort(function(a,b){var dateA,dateB;if(!a.time){dateA='';}else{dateA=new Date(new Date().format('yyyy/MM/dd '+a.time));}
if(!a.time){dateB='';}else{dateB=new Date(new Date().format('yyyy/MM/dd '+b.time));}
if(dateA=='Invalid Date')dateA=0;if(dateB=='Invalid Date')dateB=0;return dateA-dateB;});};BenchmarkConfig.prototype.createCostDom=function createCostDom(content){var divCost=document.createElement('div');var cost=content&&content.cost?content.cost:'';var time=content&&content.time?content.time:'';divCost.className='divCost';divCost.innerHTML='\n        <span class=\'spCost spCostTime\'>'+time+'</span>\n        <input class=\'iptCost form-control iptCostTime\' value=\''+time+'\'>\n        <span class=\'spCost spCostVal\'>'+cost+'</span>\n        <input class=\'iptCost form-control iptCostVal\' value=\''+cost+'\'>\n        <span class=\'btnCostEdit btnCost glyphicon glyphicon-edit\'></span>\n        <span class=\'btnCostDel btnCost glyphicon glyphicon-remove\'></span>\n        ';var arrIpt=divCost.querySelectorAll('.iptCost');for(var i=0;i<arrIpt.length;i++){if(arrIpt[i].value){arrIpt[i].previousElementSibling.style.display='inline-block';$(arrIpt[i]).hide();}else{arrIpt[i].style.display='inline-block';$(arrIpt[i].previousElementSibling).hide();}}
return divCost;};BenchmarkConfig.prototype.initLinkConfig=function initLinkConfig(){var _this6=this;var ctn=this.ctn.querySelector('.ctnLinkConfig');if(!this.store.relate||this.store.relate.length==0){ctn.appendChild(this.createLinkDom());}else{for(var i=0;i<this.store.relate.length;i++){ctn.appendChild(this.createLinkDom(this.store.relate[i]));}}
$(ctn).off('dragover').on('dragover','.divLinkContent',function(e){e.preventDefault();});$(ctn).off('dragleave').on('dragleave','.divLinkContent',function(e){e.preventDefault();});$(ctn).off('drop').on('drop','.divLinkContent',function(e){e.preventDefault();var id=EventAdapter.getData().dsItemId;$(e.currentTarget).addClass('hasDs');e.currentTarget.dataset.id=id;var point=_this6.screen.dataSource.getDSItemById(id);e.currentTarget.querySelector('.spLinkVal').textContent=point.alias?point.alias:point.value;});$(ctn).off('click').on('click','.divLinkTtl .btnLink',function(e){$(e.currentTarget).parent().addClass('showIpt');$(e.currentTarget).prev().focus();});$(ctn).on('click','.btnLinkDel',function(e){var divNode=e.currentTarget.parentNode;divNode.parentNode.removeChild(divNode);});var _this=this;ctn.querySelector('.btnLinkAdd').onclick=function(){ctn.appendChild(_this.createLinkDom());I18n.fillArea($(ctn));};$(ctn).off('blur').on('blur','.iptLinkTtl',function(e){var val=e.currentTarget.value;var $target=$(e.currentTarget);if(val){$target.parent().removeClass('showIpt');}else{$target.parent().addClass('showIpt');}});$(ctn).on('click','.btnLinkDsDel',function(e){var $target=$(e.currentTarget);var $divLink=$target.parentsUntil('.divLink','.divLinkContent');$divLink.removeClass('hasDs');delete $divLink[0].dataset.id;});};BenchmarkConfig.prototype.createLinkDom=function createLinkDom(content){if(!content)content={name:'',point:''};var divLink=document.createElement('div');divLink.className='divLink';divLink.innerHTML='\n        <div class="divLinkTtl">\n            <span class="spLinkTtl">'+content.name+'</span>\n            <input class="iptLinkTtl form-control" value='+content.name+'>\n            <span class="btnLink btnLinkEdit glyphicon glyphicon-edit"></span>\n        </div>\n        <div class="divLinkContent divDsBox">\n            <div class="divDsTip"><span class="glyphicon glyphicon-plus"></span><span class="spDsTipText" i18n="benchmark.paramsConfig.DRAGE_THERE">\u8BF7\u62D6\u62FD\u81F3\u6B64</span></div>\n            <div class="divLinkDs divDsContent">\n                <span class="spLinkVal spDsVal"></span>\n                <span class="btnLinkDsDel spDsDel glyphicon glyphicon-remove"></span>\n            </div>\n        </div>\n        <span class="btnLink btnLinkDel glyphicon glyphicon-remove"></span>';if(!(content&&content.name)){$(divLink).addClass('showIpt');}
var divLinkContent=divLink.querySelector('.divLinkContent');if(content&&content.point){$(divLinkContent).addClass('hasDs');divLinkContent.dataset.id=content.point;var point=this.screen.dataSource.getDSItemById(content.point);divLinkContent.querySelector('.spLinkVal').textContent=point.alias?point.alias:point.value;}
return divLink;};BenchmarkConfig.prototype.setLinkConfigStore=function setLinkConfigStore(){var $divLink=$('.divLink');this.store.relate=[];var ttl,ds;for(var i=0;i<$divLink.length;i++){ttl=$divLink.eq(i).find('.iptLinkTtl').val();ds=$divLink.eq(i).find('.divLinkContent')[0].dataset.id;this.store.relate.push({name:ttl?ttl:'',point:ds?ds:''});}};BenchmarkConfig.prototype.initDataSource=function initDataSource(){this.screen.showDataSource();};BenchmarkConfig.prototype.initParamConfirm=function initParamConfirm(){var _this=this;this.ctn.querySelector('.btnBmCfgCancel').onclick=function(){_this.screen.setNodeConfigStatus();_this.transformToLastModule();};this.ctn.querySelector('.btnBmCfgConfirm').onclick=function(){_this.setCostConfigStore();_this.setLinkConfigStore();_this.screen.opt=_this.store;_this.store['_id']=_this.screen.iotFilter.tree.getNodes()[0]['_id'];WebAPI.post('/benchmark/config/save',_this.store).done(function(result){if(result==true){infoBox.alert(I18n.resource.benchmark.paramsConfig.SAVE_SUCCESS);_this.setTotalNodeConfigStatus();_this.transformToLastModule();}}).fail(function(){infoBox.alert(I18n.resource.benchmark.paramsConfig.SAVE_FAIL);});};};BenchmarkConfig.prototype.setSelectNodeConfigStatus=function setSelectNodeConfigStatus(targetConfig){var $target=$(document.getElementById(this.selectNode.tId));var ptConfig=this.store.point[this.selectNode['_id']];if(!ptConfig)return;if(ptConfig.power&&ptConfig.energy){$target.addClass('completeConfig');}else{$target.removeClass('completeConfig');}};BenchmarkConfig.prototype.setTotalNodeConfigStatus=function setTotalNodeConfigStatus(){};BenchmarkConfig.prototype.transformToLastModule=function transformToLastModule(){if(this.screen.prevModuleType&&this.screen.prevModuleType!='config'){$('.panelModuleList .btnBmModule[data-type="'+this.screen.prevModuleType+'"]').trigger('click');}else{this.setNodeConfigStatus();$('.panelModuleList .btnBmModule').first().trigger('click');}};BenchmarkConfig.prototype.destroy=function destroy(){this.screen.hideDataSource();this.ctn.innerHTML='';};BenchmarkConfig.prototype.onNodeClick=function onNodeClick(e,node){this.selectNode=node;this.setPointConfigVal();};return BenchmarkConfig;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BenchmarkEnergyAnalysis=function(){function BenchmarkEnergyAnalysis(ctn,screen,opt){_classCallCheck(this,BenchmarkEnergyAnalysis);this.ctn=ctn;this.screen=screen;this.opt=opt;this.ptConfig=undefined;this.dsIdList=[];this.isYear=false;this.chartMix={};this.dictRegression={};}
BenchmarkEnergyAnalysis.prototype.show=function show(){var _this2=this;$(this.ctn).empty();WebAPI.get('/static/views/observer/benchmark/energyAnalysis.html').done(function(html){$(_this2.ctn).append(html);I18n.fillArea($('.panelBmModule'));_this2.onNodeClick();});};BenchmarkEnergyAnalysis.prototype.init=function init(){$('.paneParams .divAnalysis',this.ctn).remove();$('.tips',this.ctn).show();$('.paneResult',this.ctn).hide();$('.paneModelInfo',this.ctn).hide();if(!this.ptConfig||!this.ptConfig.energy)return;this.pointIdBase=this.ptConfig.energy;this.dictPairFactor={};this.dictPairFactor[this.pointIdBase]={};};BenchmarkEnergyAnalysis.prototype.attachEvents=function attachEvents(){var _this3=this;var _this=this;var $iptTime=$('.divTop input.form-control',this.ctn);$(this.ctn).off('change').on('change','.selCycle',function(e){return _this3.resetDateTime(e);});$iptTime.datetime();$(this.ctn).off('click').on('click','.btnAnalysis',function(e){return _this3.getAnalysisData(e);});$(this.ctn).on('click','.btnConfig',function(e){return _this3.eventBtnConfigOnClick(e);});$(this.ctn).on('click','.btnDelete',function(e){return _this3.eventBtnDeleteOnClick(e);});$(this.ctn).on('click','.iconAdd',function(e){e.stopPropagation();createTab(e);});$('#modelTabList').off('click').on('click','.iconEdit',function(e){return _this3.eventRename(e);});$('#modelTabList').off('shown.bs.tab').on('shown.bs.tab','li',function(e){var href=$(e.target).attr('href');e.stopPropagation();if($(e.target).find('.iconEdit').length===1){_this.activeModelId=$(e.target).attr('href').split('#')[1];_this.$activeTabCtn=$('#'+_this.activeModelId);_this.model=_this.models[_this.getModelById(_this.activeModelId)];_this.model&&_this.getAnalysisData();}else{createTab(e);}});function createTab(e){var now=new Date();var yesterday=new Date(now.getTime()-66400000);var $target=e.target.tagName==='LI'||e.target.tagName==='A'?$(e.target).find('span'):$(e.target);var modelId='newModel_'+now.getTime();var strLi=$target.closest('li')[0].outerHTML;var strTabCtn=$('#newTab')[0].outerHTML;$('#modelTabList li').removeClass('active');$('#modelTabContent .tab-pane').removeClass('active');strLi=strLi.replace('javascript:void(0)','#'+modelId).replace('<span class="glyphicon glyphicon-plus-sign iconAdd"></span>','<span class="modelName">New</span><span class="cycle" i18n="benchmark.energyAnalysis.BDAY"></span><span class="glyphicon glyphicon-edit iconEdit"></span>');strTabCtn=strTabCtn.replace('newTab',modelId).replace('disabled','');$('#modelTabList li:last').before(strLi);$('#modelTabContent .tab-pane:last').before(strTabCtn);_this.activeModelId=modelId;_this.$activeTabCtn=$('#'+_this.activeModelId);$('[href="#'+modelId+'"]').click();$('input.form-control',_this.$activeTabCtn).datetime();$('.iptEndTime',_this.$activeTabCtn).val(yesterday.format('yyyy-MM-dd'));now.setMonth(now.getMonth()-1);$('.iptStartTime',_this.$activeTabCtn).val(now.format('yyyy-MM-dd'));I18n.fillArea($('#modelTabList'));}};BenchmarkEnergyAnalysis.prototype.resetDateTime=function resetDateTime(e,interval){var $iptTime=$('.divTop input.form-control',this.$activeTabCtn);var val=e?e.target.value:interval;var $activeTab=$('li.active .cycle','#modelTabList');if(val==='M1'){$activeTab.text(I18n.resource.benchmark.energyAnalysis.BMONTH);$iptTime.datetimepicker('remove');$iptTime.attr('data-format','yyyy-mm');}else if(val==='M12'){$activeTab.text(I18n.resource.benchmark.energyAnalysis.BYEAR);$iptTime.datetime('remove');$iptTime.attr('data-format','yyyy');}else if(val==='h1'){$activeTab.text(I18n.resource.benchmark.energyAnalysis.BHOUR);$iptTime.datetime('remove');$iptTime.attr('data-format','yyyy-mm-dd hh');}else{$activeTab.text(I18n.resource.benchmark.energyAnalysis.BDAY);$iptTime.datetime('remove');$iptTime.attr('data-format','yyyy-mm-dd');}
$iptTime.datetime();};BenchmarkEnergyAnalysis.prototype.getAnalysisData=function getAnalysisData(e){var _this4=this;if(e){this.isRelative=true;if(!this.model||!this.model.params||this.model.params.length===0){alert(I18n.resource.benchmark.energyAnalysis.CONFIG_RELATIVE);return false;}}else{this.isRelative=false;}
this.dsIdList.length=0;this.dsIdList.push(this.ptConfig.energy);var startTime=new Date($(".iptStartTime",this.$activeTabCtn).val());var endTime=new Date($(".iptEndTime",this.$activeTabCtn).val());var timeFormat=$('.selCycle',this.$activeTabCtn).val();var timeEnd=new Date(new Date(endTime).getTime()+86400000);if(this.model&&this.model.params&&this.model.params.length>0){this.resetDateTime(null,$('.selCycle',this.$activeTabCtn).val());for(var i=0,len=this.model.params.length;i<len;i++){this.dictPairFactor[this.pointIdBase][this.model.params[i].point]={value:0,order:0};}}
for(var keyBase in this.dictPairFactor){if(this.dsIdList.indexOf(keyBase)<0)this.dsIdList.push(keyBase);for(var keyFactor in this.dictPairFactor[keyBase]){if(this.dsIdList.indexOf(keyFactor)<0&&keyFactor)this.dsIdList.push(keyFactor);}}
var postData={dsItemIds:this.dsIdList,timeStart:startTime.format('yyyy-MM-dd 00:00:00'),timeEnd:timeEnd.format("yyyy-MM-dd 00:00:00"),timeFormat:timeFormat};if(timeFormat==='h1'){postData.timeStart=startTime.format("yyyy-MM-dd HH:00:00");postData.timeEnd=new Date(endTime.getTime()+3600000).format("yyyy-MM-dd HH:00:00");}else if(timeFormat==='M12'){postData.timeFormat='M1';postData.timeEnd=new Date(endTime.getFullYear()+1,endTime.getMonth(),1).format("yyyy-MM-dd 00:00:00");this.isYear=true;}
if(!postData.timeStart){alert(I18n.resource.benchmark.energyAnalysis.INPUT_START_TIME);return;}
if(!postData.timeStart){alert(I18n.resource.benchmark.energyAnalysis.INPUT_END_TIME);return;}
if(this.dsIdList.length===0){alert(I18n.resource.benchmark.energyAnalysis.DATA_POINTS_IS_NULL);return;}
Spinner.spin(this.ctn);WebAPI.post("/analysis/startWorkspaceDataGenHistogram",postData).done(function(dataSrc){if(!(dataSrc&&dataSrc.list&&dataSrc.list.length>0)){alert('data error');return;}
_this4.dictStore={};for(var i=0;i<dataSrc.list.length;i++){_this4.dictStore[dataSrc.list[i].dsItemId]=dataSrc.list[i];}
_this4.arrTimeShaft=dataSrc.timeShaft;_this4.dictStore[_this4.ptConfig.energy]&&(_this4.dictStore[_this4.ptConfig.energy].dsName=I18n.resource.benchmark.energyQuery.ENERGY_CONSUMP);_this4.model.params.forEach(function(param){_this4.dictStore[param.point]&&(_this4.dictStore[param.point].dsName=param.name);});_this4.fillChart();}).always(function(){});};BenchmarkEnergyAnalysis.prototype.eventBtnConfigOnClick=function eventBtnConfigOnClick(){var _this5=this;var _this=this;var $modelConfigModal=$('#modelConfigModal');var $divRelate=$('#divRelate').empty();var tpl='<div class="row"><label class="col-sm-3 control-label"><input class="form-control name" value="{name}" placeholder="因子名称" i18n="placeholder=benchmark.energyAnalysis.FACTOR_NAME"/></label>\
            <div class="col-sm-5"><span class="form-control point" dsId="{point}">{pName}</span></div>\
            <div class="col-sm-4"><span class="glyphicon glyphicon-remove-circle btnDelRelate"></span></div></div>';var strHtml='';if(this.model&&this.model.params&&this.model.params.length>0){for(var j=0,len=this.model.params.length;j<len;j++){strHtml+=tpl.formatEL({name:this.model.params[j].name,point:this.model.params[j].point,pName:this.screen.dataSource.getDSItemById(this.model.params[j].point).alias});}}else{strHtml+=tpl.formatEL({name:'',point:'',pName:''});}
$divRelate.append(strHtml);$modelConfigModal.off('click').on('click','.btnSaveRelate',function(e){var isHide=true;e.stopPropagation();if(_this.model){_this.model.params.length=0;}else{_this.model={"idNode":_this.node._id,'projectId':_this.screen.iotFilter.tree.getNodes()[0]['_id'],"interval":'d',"params":[]};}
$divRelate.children('.row').each(function(index){var point=$(this).find('span.point').attr('dsId');var name=$(this).find('input.name').val();if(point){if(name.trim().length===0){alert(I18n.resource.benchmark.energyAnalysis.FACTOR_NOWRITE);isHide=false;}
_this.model.params.push({'name':name,'point':point,'pName':'x'+(index+1)});if($.inArray(point,_this.dsIdList)<0){_this.dsIdList.push(point);}}});isHide&&$modelConfigModal.modal('hide');});$modelConfigModal.modal('show');$modelConfigModal.on('hidden.bs.modal',function(){_this5.screen.hideDataSource();});this.screen.showDataSource();$('#btnAddRelate').off('click').on('click',function(){$divRelate.append(tpl.formatEL({name:'',point:'',pName:''}));});$divRelate.off('click').on('click','.btnDelRelate',function(){$(this).closest('.row').remove();});$divRelate.on('click','.btnEditRelate',function(){});$divRelate.off('dragover').on('dragover','.point',function(e){e.preventDefault();});$divRelate.off('dragleave').on('dragleave','.point',function(e){e.preventDefault();});$divRelate.off('drop').on('drop','.point',function(e){e.stopPropagation();e.preventDefault();var id=EventAdapter.getData().dsItemId;$(e.currentTarget).attr('dsId',id).text(_this5.screen.dataSource.getDSItemById(id).alias);});};BenchmarkEnergyAnalysis.prototype.eventBtnDeleteOnClick=function eventBtnDeleteOnClick(){var _this=this;var $modelTabList=$('#modelTabList');infoBox.confirm('Confirm to delete?',okCallback);function okCallback(){if(_this.model&&_this.model._id){WebAPI.get('/benchmark/config/removeModel/'+_this.model._id).done(function(rs){if(rs){var index=_this.getModelById(_this.model._id);if(index){_this.models.splice(index,1);}
_this.$activeTabCtn.remove();$modelTabList.children('li.active').remove();if($modelTabList.children('li').length===1){$('#modelTabList li:eq(0) a .iconAdd').click();}else{$('#modelTabList li:eq(0) a').click();}}else{alert('Delete failed!');}});}else{_this.$activeTabCtn.remove();$modelTabList.children('li.active').remove();if($modelTabList.children('li').length===1){$('#modelTabList li:eq(0) a .iconAdd').click();}else{$('#modelTabList li:eq(0) a').click();}}}};BenchmarkEnergyAnalysis.prototype.eventRename=function eventRename(e){e.stopPropagation();var _this=this;var $target=$(e.target);var $modelName=$target.siblings('.modelName');var $cycle=$target.siblings('.cycle');var $input=$('<input class="form-control" type="text" style="width:120px;" value="'+$modelName.text()+'"/>').blur(function(e){saveModelName(this);}).keyup(function(e){if(e.keyCode===13){saveModelName(this);}});$target.addClass('hidden').after($input);$modelName.addClass('hidden');$cycle.addClass('hidden');$target.closest('a').css({padding:'3px 5px'});e.stopPropagation();e.preventDefault();function saveModelName(obj){$modelName.text($(obj).val());$(obj).remove();$modelName.removeClass('hidden');$cycle.removeClass('hidden');$target.removeClass('hidden');$target.closest('a').removeAttr('style');_this.saveModel({name:$(obj).val()});}};BenchmarkEnergyAnalysis.prototype.getModelById=function getModelById(modelId){if(this.models&&this.models.length>0){for(var i=0,len=this.models.length;i<len;i++){if(this.models[i]._id===modelId){return i;}}}};BenchmarkEnergyAnalysis.prototype.fillChart=function fillChart(){var _this=this;var period=$('.selCycle',this.$activeTabCtn).val();var optionChartMix={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{mark:{show:true},dataView:{show:true,readOnly:false},restore:{show:true},saveAsImage:{show:true}}},grid:{top:100,left:'3%',right:'4%',bottom:'3%',containLabel:true},xAxis:[{type:'category',boundaryGap:true,data:function(){var list=[],year='',key='',format;if(_this.isYear){_this.arrValIndex=[];for(var i=1;i<_this.arrTimeShaft.length;i++){key=_this.arrTimeShaft[i].split('-')[0];if(key!==year){year=key;list.push(year);_this.arrValIndex.push(i);}}}else{if(period=='d1'){format="MM-dd";}else if(period=='h1'){format="HH:00";}else{format="yyyy-MM";}
for(var i=0;i<_this.arrTimeShaft.length-1;i++){list.push(new Date(_this.arrTimeShaft[i]).format(format));}}
return list;}()},{type:'value',scale:false,axisLabel:{show:false},splitLine:{show:false}}],yAxis:[{type:'value',scale:true,axisLabel:{formatter:function formatter(value){if(value>=1000||value<=-1000){return value/1000+'k';}else{return value;}}}},{type:'value',scale:true,splitLine:{show:false},axisLabel:{formatter:function formatter(value){if(value>=1000){return value/1000+'k';}else{return value;}}}}],animation:false,legend:{x:'left',data:[I18n.resource.benchmark.energyQuery.ENERGY_CONSUMP,I18n.resource.benchmark.energyAnalysis.SUMMARY_REGRESSION]},series:[_this.createSeriesBar(_this.pointIdBase)]};if(this.chartMix[this.activeModelId]){this.chartMix[this.activeModelId].clear();}else{this.chartMix[this.activeModelId]=echarts.init($('.divChartMix',this.$activeTabCtn)[0],theme.Dark);}
this.chartMix[this.activeModelId].setOption(optionChartMix);if(this.isRelative||this.model&&this.model.params.length>0){this.fillPaneParams();}};BenchmarkEnergyAnalysis.prototype.fillPaneParams=function fillPaneParams(){var _this6=this;this.$getModel=$.Deferred();var _this=this;var $ctn=$('.paneParams').children('.divAnalysis').remove().end();var postData={};this.dictX={};if(this.isYear){var _getArrByIndexs=function _getArrByIndexs(data){var arr=[];if(!data)return;for(var i=1,l=_this.arrValIndex.length;i<l;i++){arr.push(data[_this.arrValIndex[i]]-data[_this.arrValIndex[i-1]]);}
return arr;};postData={y:_getArrByIndexs(this.dictStore[this.ptConfig.energy].data),x:{}};for(var i=0,key,len=this.model.params.length;i<len;i++){key=model.params[i].point;if(this.dictStore[key].data&&this.dictStore[key].data.length>0){postData.x['x'+(i+1)]=_getArrByIndexs(this.dictStore[key].data);}
this.dictX['x'+(i+1)]=key;}}else{var arr=this.chartMix[this.activeModelId].getOption().series[0].data;postData={y:arr,x:{}};for(var i=0,key,len=this.model.params.length;i<len;i++){key=this.model.params[i].point;if(this.dictStore[key].data&&this.dictStore[key].data.length>0){arr=this.dictStore[key].data;arr.pop();postData.x['x'+(i+1)]=arr;}
this.dictX['x'+(i+1)]=key;}}
Spinner.spin($ctn[0]);var $paneResult=$('.paneResult',this.$activeTabCtn).hide();var $paneModelInfo=$('.paneModelInfo',this.$activeTabCtn).hide();var $tips=$('.tips',this.$activeTabCtn).show();if($.isEmptyObject(postData.x)){alert(I18n.resource.benchmark.energyAnalysis.PARAMS_ERROR);return;}else{for(var i in postData.x){if(!postData.x[i]||postData.x[i].length===0){alert(I18n.resource.benchmark.energyAnalysis.PARAMS_ERROR);return;}}}
if(!arr||arr.length===0){alert(I18n.resource.benchmark.energyAnalysis.PARAMS_ERROR);return;}
if(!postData.y||postData.y.length<10){alert(I18n.resource.benchmark.energyAnalysis.PARAMS_LENGTH);return;}
Spinner.spin($tips[0]);this.$execRelationAnalysis=WebAPI.post('/analysis/model/execRelationAnalysis',postData).done(function(rs){try{rs=JSON.parse(rs);$tips.hide();$paneModelInfo.show();$paneResult.children('.divAnalysis').remove().end().show();if(!rs||$.isEmptyObject(rs)){alert(I18n.resource.benchmark.energyAnalysis.FAIL_ANALYSIS);return;}
var divRow,divRank,divVar,divCorRelate;var arrData=[];for(var i in rs.R){arrData.push({pt:_this6.dictX[i],rs:rs.R[i]});}
arrData.sort(function(a,b){return b.rs-a.rs;});for(var i=0;i<arrData.length;i++){divRow=document.createElement('div');divRow.className='divRow divAnalysis';divRank=document.createElement('div');divRank.className='divUnit divRank';divRank.textContent=(i+1).toString();divVar=document.createElement('div');divVar.className='divUnit divVar';divVar.textContent=_this6.dictStore[arrData[i].pt]?_this6.dictStore[arrData[i].pt].dsName:'';divCorRelate=document.createElement('div');divCorRelate.className='divUnit divCorRelate';divCorRelate.textContent=arrData[i].rs.toFixed(3);divRow.appendChild(divRank);divRow.appendChild(divVar);divRow.appendChild(divCorRelate);divRow.index=i;var isFixed={};divRow.onmouseover=function(){if(!isFixed[_this.pointIdSelected]){_this.pointIdSelected=arrData[this.index].pt;postData.x={};postData.x['x1']=_this.dictStore[_this.pointIdSelected].data;_this.renderRegression(postData,_this.pointIdSelected);}};divRow.onmouseout=function(){if(!isFixed[_this.pointIdSelected]){_this.pointIdSelected=undefined;_this.renderRegression(null,'all');}};divRow.onclick=function(){$(this).toggleClass('selected');_this.pointIdSelected=arrData[this.index].pt;if($(this).siblings().hasClass('selected')){$(this).siblings().removeClass('selected');for(var i in isFixed){isFixed[i]=false;}
isFixed[_this.pointIdSelected]=true;postData.x={};postData.x['x1']=_this.dictStore[_this.pointIdSelected].data;_this.renderRegression(postData,_this.pointIdSelected);}else{isFixed[_this.pointIdSelected]=!isFixed[_this.pointIdSelected];}};$paneResult.append(divRow);}}catch(e){console.log(e.toString());$tips.text(I18n.resource.benchmark.energyAnalysis.FAIL_ANALYSIS);}}).always(function(){Spinner.stop();}).fail(function(){$tips.text(I18n.resource.benchmark.energyAnalysis.FAIL_ANALYSIS);});if(this.isRelative||this.model&&this.model.params.length>0){this.renderRegression(postData,'all');}
$.when(this.$execRelationAnalysis).done(function(){_this.$getModel=WebAPI.post('/analysis/model/get',postData).done(function(rs){try{rs=JSON.parse(rs);if(rs&&!$.isEmptyObject(rs)){_this.model=$.extend(true,_this.model,rs);_this.renderModelInfo(_this.model);}else{alert(I18n.resource.benchmark.energyAnalysis.FAIL_GET_MODEL);}}catch(e){alert(I18n.resource.benchmark.energyAnalysis.FAIL_GET_MODEL);}}).fail(function(){alert(I18n.resource.benchmark.energyAnalysis.FAIL_GET_MODEL);}).always(function(){});$.when(_this.$getModel).done(function(){if(_this.isRelative){var period=$('.selCycle',_this.$activeTabCtn).val();var interval='';if(period==='h1'){interval='h';}else if(period==='d1'){interval='d';}else if(period==='M1'){interval='M';}else if(period==='M12'){interval='y';}
_this.saveModel({"interval":interval,"name":$('#modelTabList li.active a .modelName').text(),"creatorId":AppConfig.userId,"startTime":$('.iptStartTime',_this.$activeTabCtn).val(),"endTime":$('.iptEndTime',_this.$activeTabCtn).val()});}});});};BenchmarkEnergyAnalysis.prototype.renderModelInfo=function renderModelInfo(model){var strParams='';var $paneModelInfo=$('.paneModelInfo',this.$activeTabCtn);var $projectName=$('#projectName',$paneModelInfo).text(this.screen.iotFilter.tree.getNodes()[0].name);var $timeRange=$('#timeRange',$paneModelInfo);var $fittingObj=$('#fittingObj',$paneModelInfo);var $relativeParams=$('#relativeParams',$paneModelInfo);var $relativeVal=$('#relativeVal',$paneModelInfo);var $modelInfo=$('#modelInfo',$paneModelInfo);$projectName.text(this.screen.iotFilter.tree.getNodes()[0].name);$timeRange.text((model.startTime?model.startTime:$('.iptStartTime',this.$activeTabCtn).val())+' ~ '+(model.endTime?model.endTime:$('.iptEndTime',this.$activeTabCtn).val()));$fittingObj.text(this.screen.iotFilter.tree.getSelectedNodes()[0].name+I18n.resource.benchmark.energyQuery.ENERGY_CONSUMP);$relativeParams.html(strParams);$relativeVal.html(model.info.R2?kIntSeparate(model.info.R2,3):'');$modelInfo.text(model.info.desc?model.info.desc:'');};BenchmarkEnergyAnalysis.prototype.onNodeClick=function onNodeClick(e,node){var _this7=this;this.model=undefined;this.node=node?node:this.screen.iotFilter.tree.getSelectedNodes()[0];if(!this.node)return;if(this.screen.opt.point&&this.screen.opt.point[this.node['_id']]){this.ptConfig=this.screen.opt.point[this.node['_id']];Spinner.spin(this.ctn);this.screen.getModel(this.node._id).done(function(rs){_this7.models=rs;_this7.renderModelList();}).always(function(rs){Spinner.stop();});}else{this.ptConfig={};}
this.dsIdList.length=0;this.init();};BenchmarkEnergyAnalysis.prototype.saveModel=function saveModel(opt){var _this8=this;if(!this.model||$.isEmptyObject(this.model))return;this.model=$.extend(true,this.model,opt);WebAPI.post('/analysis/model/save',this.model).done(function(rs){if(!rs)alert('Save failed');if(!_this8.model._id){_this8.model._id=rs.id;_this8.models.push(_this8.model);_this8.$activeTabCtn.attr('id',_this8.model._id);$('#modelTabList li.active a').attr('href','#'+_this8.model._id);}
$('#'+_this8.node.tId).addClass('hasModel');});};BenchmarkEnergyAnalysis.prototype.createSeriesBar=function createSeriesBar(pointIdBase){var _this=this;return{name:this.dictStore[pointIdBase].dsName,type:'line',yAxisIndex:0,itemStyle:{normal:{color:'rgba(250,216,96,1)',lineStyle:{width:4}}},data:function(d){var arr=[];if(_this.isYear){for(var i=1,l=_this.arrValIndex.length,diff;i<l;i++){diff=d[_this.arrValIndex[i]]-d[_this.arrValIndex[i]-1];arr.push(diff>0?diff:0);}}else{for(var i=1,l=d.length,diff;i<l;i++){diff=d[i]-d[i-1];arr.push(diff>0?diff:0);}}
return arr;}(this.dictStore[pointIdBase].data)};};BenchmarkEnergyAnalysis.prototype.createSeriesLine=function createSeriesLine(pointIdSelected){var _this=this;return{name:this.dictStore[pointIdSelected].dsName,type:'bar',yAxisIndex:1,smooth:true,symbolSize:0,itemStyle:{normal:{color:'rgba(66, 139, 202, 0.5)',barBorderRadius:[5,5,0,0]}},data:function(d){var arr=[];if(_this.isYear){for(var i=1,l=_this.arrValIndex.length,diff;i<l;i++){diff=d[_this.arrValIndex[i]]-d[_this.arrValIndex[i]-1];arr.push(diff>0?diff:0);}}else{for(var i=1,l=d.length;i<l;i++){arr.push(d[i]);}}
return arr;}(this.dictStore[pointIdSelected].data)};};BenchmarkEnergyAnalysis.prototype.createSeriesRegression=function createSeriesRegression(key){var name,color;if(key=='all'){name=I18n.resource.benchmark.energyAnalysis.SUMMARY_REGRESSION;color='rgba(254,132,99,1)';}else{name=this.dictStore[this.pointIdSelected].dsName+I18n.resource.benchmark.energyAnalysis.REGRESSION;color='rgba(20,201,18,0.8)';}
return{name:name,type:'line',yAxisIndex:0,smooth:true,symbolSize:0,itemStyle:{normal:{color:color,lineStyle:{width:4}}},data:function(arrR){var arr=[];if(arrR&&arrR instanceof Array){arrR.forEach(function(i){arr.push(i.toFixed(0));});}
return arr;}(this.dictRegression[key])};};BenchmarkEnergyAnalysis.prototype.renderRegression=function renderRegression(postData,key){var _this9=this;var _this=this;if(this.dictRegression[key]){rerenderChart();}else if(postData){WebAPI.post('/analysis/model/analysisRegression',postData).done(function(rs){try{_this9.dictRegression[key]=JSON.parse(rs);rerenderChart();}catch(e){alert(I18n.resource.benchmark.energyAnalysis.MSG_FAIL_REGRESSION);}}).fail(function(rs){alert(I18n.resource.benchmark.energyAnalysis.MSG_FAIL_REGRESSION);}).always(function(rs){});}
function rerenderChart(){var opt=_this.chartMix[_this.activeModelId].getOption();if(_this.pointIdSelected){opt.legend[0].selected[I18n.resource.benchmark.energyAnalysis.SUMMARY_REGRESSION]=false;opt.legend[0].data[2]=_this.dictStore[_this.pointIdSelected].dsName;opt.legend[0].data[3]=_this.dictStore[_this.pointIdSelected].dsName+I18n.resource.benchmark.energyAnalysis.REGRESSION;opt.series=[_this.createSeriesBar(_this.pointIdBase),_this.createSeriesRegression('all'),_this.createSeriesLine(_this.pointIdSelected),_this.createSeriesRegression(_this.pointIdSelected)];}else{opt.legend[0].selected[I18n.resource.benchmark.energyAnalysis.SUMMARY_REGRESSION]=true;opt.legend[0].data.lenth=2;opt.series=[_this.createSeriesBar(_this.pointIdBase),_this.createSeriesRegression('all')];}
_this.chartMix[_this.activeModelId].clear();_this.chartMix[_this.activeModelId].setOption(opt);}};BenchmarkEnergyAnalysis.prototype.renderModelList=function renderModelList(){var $modelTabList=$('#modelTabList').empty();var $modelTabContent=$('#modelTabContent').empty();var $modelTemplate=$('#modelTemplate');var $content,content,cycle,interval;if(this.models&&this.models.length>0){this.models.forEach(function(model){if(model.interval==='y'){cycle=I18n.resource.benchmark.energyQuery.YEAR;}else if(model.interval==='M'){cycle=I18n.resource.benchmark.energyQuery.MONTH;}else if(model.interval==='d'){cycle=I18n.resource.benchmark.energyQuery.DAY;}else if(model.interval==='h'){cycle=I18n.resource.benchmark.energyQuery.HOUR;}
!model.name&&(model.name="Untitled");$content=$modelTemplate.clone(true).attr('id',model._id);$content.find('.btnDelete').removeAttr('disabled');$modelTabList.append('<li role="presentation" class=""><a href="#'+model._id+'" aria-controls="'+model._id+'" role="tab" data-toggle="tab"><span class="modelName">'+model.name+'</span><span class="cycle">('+cycle+')</span><span class="glyphicon glyphicon-edit iconEdit"></span></a></li>');$modelTabContent.append('<div role="tabpanel" class="tab-pane" id="'+model._id+'">'+$content.html()+'</div>');content=document.getElementById(model._id);interval=model.interval==='y'?'M12':model.interval+'1';$('.selCycle',content).val(interval);$('.iptStartTime',content).val(model.startTime);$('.iptEndTime',content).val(model.endTime);});this.model=this.models[0];}
$modelTabList.append('<li role="presentation"><a href="javascript:void(0)" aria-controls="newTab" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-plus-sign iconAdd"></span></a></li>');$modelTabContent.append('<div role="tabpanel" class="tab-pane" id="newTab">'+$modelTemplate.clone().attr('id',"").html()+'</div>');$modelTabList.children('li:eq(0)').addClass('active');this.$activeTabCtn=$modelTabContent.children('div:eq(0)').addClass('active');this.activeModelId=this.$activeTabCtn.attr('id');this.chartMix[this.activeModelId]=echarts.init($('.divChartMix',this.$activeTabCtn)[0],theme.Dark);this.attachEvents();if(this.model){this.getAnalysisData();}else{$('#modelTabList li.active .iconAdd').click();}};BenchmarkEnergyAnalysis.prototype.destroy=function destroy(){this.model=null;this.models=null;this.$activeTabCtn=null;this.activeModelId=null;this.ctn=null;this.screen=null;this.opt=null;this.ptConfig=null;this.dsIdList=null;this.isYear=null;this.chartMix=null;this.isRelative=null;this.dsIdList=null;this.pointIdBase=null;this.dictPairFactor=null;this.chartOption=null;};return BenchmarkEnergyAnalysis;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BenchmarkEnergyBenchmark=function(){function BenchmarkEnergyBenchmark(ctn,screen,opt){_classCallCheck(this,BenchmarkEnergyBenchmark);this.ctn=ctn;this.screen=screen;this.opt=opt;this.chart=undefined;this.chartOption={tooltip:{trigger:'item',formatter:function formatter(e){if(e.name==="invisible"){return'';}else{return e.name+': '+kIntSeparate(e.value);}}},legend:{orient:'vertical',x:'left',data:[I18n.resource.benchmark.energyBenchmark.FIDUCIAL_VALUE,I18n.resource.benchmark.energyBenchmark.ACTUAL_VALUE]},grid:{top:100,left:'3%',right:'4%',bottom:'3%',containLabel:true},color:["rgb(254,197,0)","rgb(104,156,15)"]};this.variables=[];}
BenchmarkEnergyBenchmark.prototype.init=function init(){var now=new Date();var startTime=new Date(now.getFullYear()+'-'+(now.getMonth()-1)+'-01').format('yyyy-MM');var endTime=new Date(now.getFullYear()+'-'+now.getMonth()+'-01').format('yyyy-MM');$('.iptStartTime',this.ctn).val(startTime);$('.iptEndTime',this.ctn).val(endTime);this.$activeTabCtn=$("#divPane").find(".form-inline").eq(0);this.attachEvents();};BenchmarkEnergyBenchmark.prototype.show=function show(){var _this2=this;var _this=this;$(this.ctn).empty();WebAPI.get('/static/views/observer/benchmark/energyBenchmark.html').done(function(html){$(_this2.ctn).append(html);I18n.fillArea($('.panelBmModule'));_this2.init();_this.resetDateTime(null,'M1');_this2.onNodeClick();});};BenchmarkEnergyBenchmark.prototype.destroy=function destroy(){this.ctn=null;this.screen=null;this.opt=null;this.chart=null;this.chartOption=null;this.variables=null;this.$activeTabCtn=null;this.models=null;this.isYear=null;};BenchmarkEnergyBenchmark.prototype.attachEvents=function attachEvents(){var _this3=this;var _this=this;$('.btnCalculate',this.ctn).off('click').on('click',function(e){return _this3.onNodeClick(e);});$('#selCycle .btn',this.ctn).off('click').on('click',function(e){$(this).removeClass('btn-default').addClass('btn-primary selected').parent().siblings().children('.btn').removeClass('btn-primary selected').addClass('btn-default');_this.resetDateTime(e);_this.clearInfo();});$('input.form-control',this.ctn).datetime();var $lis=$(".navType").find("li");$lis.click(function(){var index=$lis.index($(this));var $input,now=new Date(),time,month,interval;$("#divPane").find(".form-inline").hide();$lis.removeClass("selected");$(this).addClass("selected");_this.$activeTabCtn=$("#divPane").find(".form-inline").eq(index).show();if(index===1){interval=$('#chooseModel option:selected').data('interval');_this.resetDateTime(null,interval==='y'?'M12':interval+'1');}else if(index===2){$input=$('.iptStartTime',_this.$activeTabCtn).val(now.getFullYear()+'-'+(now.getMonth()<10?'0'+now.getMonth():now.getMonth()));$input.attr('data-format','yyyy-mm');$input.datetime('remove');$input.datetime({minView:3,startView:4});$input.off('change').on('change',function(){time=new Date(this.value);month=time.getMonth()+1;$(this).val(time.getFullYear()+'-'+(month<10?'0'+month:month));$('#iptBaseTime',_this.$activeTabCtn).val(time.getFullYear()+'-'+(month<10?'0'+month:month)+'-01');});$('#iptBaseTime',_this.$activeTabCtn).val(now.getFullYear()+'-'+(now.getMonth()<10?'0'+now.getMonth():now.getMonth())+'-01');}});$('#chooseModel',this.ctn).off('change').on('change',function(){_this.resetDateTime(null,$(this.selectedOptions[0]).data('interval')+'1');});$('#btnGetBaseByModel',this.ctn).off('click').on('click',function(){var interval=$('#chooseModel option:selected').data('interval');_this.getActualVal(interval==='y'?'M12':interval+'1');});$('#btnShowModal',this.ctn).off('click').on('click',function(e){return _this3.eventBtnConfigOnClick(e);});$('#btnSearch',this.ctn).off('click').on('click',function(e){return _this3.calcSimilarDays(e);});};BenchmarkEnergyBenchmark.prototype.resetDateTime=function resetDateTime(e,interval){var _this=this;var interval=e?e.target.dataset.value:interval;var $iptTime=$('input.form-control',this.$activeTabCtn);var time,month;var now=new Date();if(interval==='M1'){$('.iptStartTime',_this.$activeTabCtn).val(now.getFullYear()+'-'+(now.getMonth()<11?'0'+(now.getMonth()-1):now.getMonth()-1));$('.iptEndTime',_this.$activeTabCtn).val(now.getFullYear()+'-'+(now.getMonth()<10?'0'+now.getMonth():now.getMonth()));$iptTime.attr('data-format','yyyy-mm');$iptTime.datetime('remove');$iptTime.datetime({minView:3,startView:4});$iptTime.off('changeDate').on('changeDate',function(){_this.getActualVal(interval);});}else if(interval==='M12'){$('.iptStartTime',this.$activeTabCtn).val(now.getFullYear()-2);$('.iptEndTime',this.$activeTabCtn).val(now.getFullYear()-1);$iptTime.attr('data-format','yyyy');$iptTime.datetime('remove');$iptTime.datetime({minView:4,startView:4});$iptTime.off('changeDate').on('changeDate',function(){_this.getActualVal(interval);});}else if(interval==='h1'){$iptTime.attr('data-format','yyyy-mm-dd hh');$iptTime.datetime('remove');$iptTime.datetime();$iptTime.off('changeDate').on('changeDate',function(){_this.getActualVal(interval);});$('.iptEndTime',this.$activeTabCtn).val(new Date(now.getTime()-86400000).format('yyyy-MM-dd HH:00'));}else{$('.iptEndTime',this.$activeTabCtn).val(new Date(now.getTime()-86400000).format('yyyy-MM-dd'));$iptTime.attr('data-format','yyyy-mm-dd');$iptTime.datetime('remove');$iptTime.datetime();$iptTime.off('changeDate').on('changeDate',function(){_this.getActualVal(interval);});}};BenchmarkEnergyBenchmark.prototype.getActualVal=function getActualVal(interval){var _this4=this;var timeStart,timeEnd,timeFormat,arrParamId=[],now=new Date(),$iptEndTime=$('.iptEndTime',this.$activeTabCtn);if(this.$activeTabCtn[0].classList.contains('divPaneTwo')){var timeActual=new Date($iptEndTime.val());if(timeActual.toString()==="Invalid Date"){alert(I18n.resource.benchmark.energyBenchmark.INPUT_BASE_DAY);return false;}
if(interval==='M12'){timeFormat='M1';alert(I18n.resource.benchmark.energyBenchmark.TEM_NOSUPPORT_YEARCYCLE);return;}else if(interval==='M1'){timeStart=timeActual.format('yyyy-MM-dd 00:00:00');timeEnd=new Date(timeActual.getFullYear(),timeActual.getMonth()+1,1).format('yyyy-MM-dd 00:00:00');timeFormat='M1';$iptEndTime.val(timeActual.format('yyyy-MM-dd'));if(timeEnd>now||timeEnd<=now&&timeEnd.getMonth()>now.getMonth()){alert(I18n.resource.benchmark.energyQuery.BEFORE_MONTH);return;}}else if(interval==='d1'){timeStart=timeActual.format('yyyy-MM-dd 00:00:00');timeEnd=new Date(timeActual.getTime()+86400000).format('yyyy-MM-dd 00:00:00');timeFormat='d1';$iptEndTime.val(timeActual.format('yyyy-MM-dd'));if(timeEnd>now||timeEnd<=now&&timeEnd.getDate()>now.getDate()){alert(I18n.resource.benchmark.energyQuery.BEFORE_DAY);return;}}else if(interval==='h1'){timeStart=timeActual.format('yyyy-MM-dd HH:00:00');timeEnd=new Date(timeActual.getTime()+3600000).format('yyyy-MM-dd HH:00:00');timeFormat='h1';$iptEndTime.val(timeActual.format('yyyy-MM-dd HH:00'));if(timeEnd>now||timeEnd<=now&&timeEnd.getHours()>now.getHours()){alert(I18n.resource.benchmark.energyQuery.BEFORE_HOUR);return;}}
var model=this.models[this.getModelById($('#chooseModel').val())];if(!model||!model.params||model.params.length==0){alert(I18n.resource.benchmark.energyBenchmark.BUILD_MODEL);return false;}
this.clearInfo();for(var i=0;i<model.params.length;i++){arrParamId.push(model.params[i].point);}
arrParamId.push(this.ptConfig.energy);var postData={dsItemIds:arrParamId,timeStart:timeStart,timeEnd:timeEnd,timeFormat:timeFormat};WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(rs){var dictX={},diff;if(!rs||$.isEmptyObject(rs)||rs.list.length===0){return;}
rs.list.forEach(function(item,index){for(var i=0;i<model.params.length;i++){if(model.params[i].point==item.dsItemId){if(item.data.length>0){dictX[model.params[i].pName]=[item.data[0]];}else{dictX[model.params[i].pName]=[0];}}}
if(index===rs.list.length-1){diff=rs.list[index].data[rs.list[index].data.length-1]-rs.list[index].data[0];_this4.actual=diff>0?diff:0;}});if(isNaN(_this4.actual)){alert(I18n.resource.benchmark.energyBenchmark.NOT_GET_ACTUAL_VAL);return false;}else{$('.spanActual',_this4.$activeTabCtn).html(kIntSeparate(_this4.actual));_this4.getExecVal(dictX);}});}else if(this.$activeTabCtn[0].classList.contains('divPaneOne')){this.clearInfo();}};BenchmarkEnergyBenchmark.prototype.clearInfo=function clearInfo(){$('.spanActual',this.$activeTabCtn).text('');$('.spanBenchmark',this.$activeTabCtn).text('');$('.saveEnergy',this.$activeTabCtn).text('');$('.saveRate',this.$activeTabCtn).text('');$('.saveCost',this.$activeTabCtn).text('');};BenchmarkEnergyBenchmark.prototype.queryData=function queryData(){var _this5=this;if(!this.ptConfig||!this.ptConfig.energy){alert(I18n.resource.benchmark.energyBenchmark.SELECT_EFFECTIVE_EQUIPMENT);return;}
var $selCycle=$('#selCycle .selected');var timeFormat,postData=[];var timeBenchmark=new Date($('.iptStartTime',this.$activeTabCtn).val());var timeActual=new Date($('.iptEndTime',this.$activeTabCtn).val());var timeBenchmark_1,timeActual_1,timeBenchmark_0,timeActual_0;if(this.$activeTabCtn.hasClass('divPaneThree')){timeFormat='d1';}else{timeFormat=$selCycle?$selCycle[0].dataset.value:'M1';}
if(timeFormat==='M1'){this.isYear=false;timeBenchmark_1=new Date(timeBenchmark.getFullYear(),timeBenchmark.getMonth()+1,1);timeActual_1=new Date(timeActual.getFullYear(),timeActual.getMonth()+1,1);timeBenchmark_0=new Date(timeBenchmark.getFullYear(),timeBenchmark.getMonth(),1);timeActual_0=new Date(timeActual.getFullYear(),timeActual.getMonth(),1);postData=[{timeStart:timeBenchmark_0.format('yyyy-MM-dd 00:00:00'),timeEnd:timeBenchmark_1.format('yyyy-MM-dd 00:00:00'),timeFormat:timeFormat,dsItemIds:[this.ptConfig.energy]},{timeStart:timeActual_0.format('yyyy-MM-dd 00:00:00'),timeEnd:timeActual_1.format('yyyy-MM-dd 00:00:00'),timeFormat:timeFormat,dsItemIds:[this.ptConfig.energy]}];}else if(timeFormat==='M12'){this.isYear=true;timeFormat='M1';var iptStartTimeVal=$('.iptStartTime',this.$activeTabCtn).val();var iptEndTimeVal=$('.iptEndTime',this.$activeTabCtn).val();iptStartTimeVal=parseInt(iptStartTimeVal);iptEndTimeVal=parseInt(iptEndTimeVal);postData=[{timeFormat:timeFormat,timeStart:new Date(iptStartTimeVal,0,1).format('yyyy-MM-dd 00:00:00'),timeEnd:new Date(iptStartTimeVal+1,0,1).format('yyyy-MM-dd 00:00:00'),dsItemIds:[this.ptConfig.energy]},{timeFormat:timeFormat,timeStart:new Date(iptEndTimeVal,0,1).format('yyyy-MM-dd 00:00:00'),timeEnd:new Date(iptEndTimeVal+1,0,1).format('yyyy-MM-dd 00:00:00'),dsItemIds:[this.ptConfig.energy]}];}else{this.isYear=false;timeBenchmark_0=new Date($('#iptBaseTime',this.$activeTabCtn).val());timeActual_0=new Date($('#iptCompareTime',this.$activeTabCtn).val());timeBenchmark_1=new Date(timeBenchmark_0.getTime()+86400000);timeActual_1=new Date(timeActual_0.getTime()+86400000);postData=[{timeStart:timeBenchmark_0.format('yyyy-MM-dd 00:00:00'),timeEnd:timeBenchmark_1.format('yyyy-MM-dd 00:00:00'),timeFormat:'d1',dsItemIds:[this.ptConfig.energy]},{timeStart:timeActual_0.format('yyyy-MM-dd 00:00:00'),timeEnd:timeActual_1.format('yyyy-MM-dd 00:00:00'),timeFormat:'d1',dsItemIds:[this.ptConfig.energy]}];}
Spinner.spin(this.ctn);WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(rs){if(!rs)return;_this5.renderChart(rs);_this5.calculate();}).fail(function(){}).always(function(){Spinner.stop();});};BenchmarkEnergyBenchmark.prototype.getExecVal=function getExecVal(dictX){var _this6=this;var option=$('#chooseModel')[0].selectedOptions[0];if(!this.actual)return;if(!option)alert(I18n.resource.benchmark.energyBenchmark.BUILD_MODEL);var postData={'modeltype':$(option).data('type'),'model':$(option).data('model'),'x':dictX};if(!postData.model||!postData.modeltype||!dictX||$.isEmptyObject(dictX)){alert(I18n.resource.benchmark.energyBenchmark.MODEL_INFO_IS_REQUIRED);return false;}
Spinner.spin(this.$activeTabCtn[0]);WebAPI.post('/analysis/model/exec',postData).done(function(rs){try{rs=JSON.parse(rs);if(rs&&rs.length===1){_this6.benchmark=parseFloat(rs[0].toFixed(2));var option=_this6.chart.getOption();if(_this6.benchmark<_this6.actual){option.series[0].data[0].value=_this6.actual;option.series[0].data[1].value=0;option.series[0].data[1].itemStyle.normal.borderType='dashed';option.series[0].data[1].itemStyle.normal.borderColor='#fff';option.series[1].data[1].itemStyle.normal.borderType='dashed';option.series[1].data[1].itemStyle.normal.borderColor='transparent';option.series[1].data[0].value=_this6.benchmark;option.series[1].data[1].value=_this6.actual-_this6.benchmark;}else{option.series[0].data[0].value=_this6.actual;option.series[0].data[1].value=_this6.benchmark-_this6.actual;option.series[0].data[1].itemStyle.normal.borderType='dashed';option.series[0].data[1].itemStyle.normal.borderColor='transparent';option.series[1].data[1].itemStyle.normal.borderType='dashed';option.series[1].data[1].itemStyle.normal.borderColor='#fff';option.series[1].data[0].value=_this6.benchmark;option.series[1].data[1].value=0;}
_this6.chart.setOption(option);_this6.calculate();}else{alert(I18n.resource.benchmark.energyBenchmark.FIND_FIDUCIAL_VALUE_ERROR);}}catch(e){alert(I18n.resource.benchmark.energyBenchmark.FIND_FIDUCIAL_VALUE_ERROR);}}).always(function(rs){Spinner.stop();}).fail(function(rs){alert(I18n.resource.benchmark.energyBenchmark.FIND_FIDUCIAL_VALUE_ERROR);});};BenchmarkEnergyBenchmark.prototype.calculate=function calculate(){if(isNaN(this.actual)){alert(I18n.resource.benchmark.energyBenchmark.NO_ACTUAL_VALUE);return;}
if(isNaN(this.benchmark)){alert(I18n.resource.benchmark.energyBenchmark.NO_FIDUCIAL_VALUE);return;}
var saveEnergy=this.benchmark-this.actual;var saveEnergy=parseFloat(saveEnergy.toFixed(2));var saveRate=this.actual!==0?(saveEnergy/this.actual).toFixed(4):'--';var price=1;$('.spanBenchmark',this.$activeTabCtn).text(kIntSeparate(this.benchmark));$('.saveEnergy',this.$activeTabCtn).text(kIntSeparate(saveEnergy));$('.saveRate',this.$activeTabCtn).text(isNaN(saveRate)?'--':kIntSeparate(saveRate*100,2));$('.saveCost',this.$activeTabCtn).text(kIntSeparate(saveEnergy*price));};BenchmarkEnergyBenchmark.prototype.renderChart=function renderChart(data){this.chart=echarts.init(document.getElementById('divChartCtn'),AppConfig.chartTheme);var option=$.extend(this.chartOption,this.getChartOption(data));this.chart.setOption(option);};BenchmarkEnergyBenchmark.prototype.getChartOption=function getChartOption(data){var option={series:[]};this.benchmark=undefined;this.actual=undefined;if(data&&data.length>0){option.series.push({type:'pie',radius:['40%','55%'],data:[{name:I18n.resource.benchmark.energyBenchmark.ACTUAL_VALUE,value:0,labelLine:{normal:{show:'true',length:80}}},{value:0,name:'invisible',itemStyle:{normal:{color:"transparent"}}}]},{type:'pie',radius:['56%','70%'],data:[{name:I18n.resource.benchmark.energyBenchmark.FIDUCIAL_VALUE,value:0},{value:0,name:'invisible',itemStyle:{normal:{color:"transparent"}}}]});var optionData=[];$('.spanBenchmark',this.$activeTabCtn).text(0);$('.spanActual',this.$activeTabCtn).text(0);for(var i=0,len=data.length,diff;i<len;i++){var d=data[i].list[0].data;if(d.length>1){diff=data[i].list[0].data[data[i].list[0].data.length-1]-data[i].list[0].data[0];optionData.push(diff>0?diff:0);}else{optionData.push(0);}}
this.benchmark=optionData[0];this.actual=optionData[1];if(this.benchmark<this.actual){option.series[0].data[0].value=this.actual;option.series[0].data[1].value=0;option.series[0].data[1].itemStyle.normal.borderType='dashed';option.series[0].data[1].itemStyle.normal.borderColor='#fff';option.series[1].data[1].itemStyle.normal.borderType='dashed';option.series[1].data[1].itemStyle.normal.borderColor='transparent';option.series[1].data[0].value=this.benchmark;option.series[1].data[1].value=this.actual-this.benchmark;}else{option.series[0].data[0].value=this.actual;option.series[0].data[1].value=this.benchmark-this.actual;option.series[0].data[1].itemStyle.normal.borderType='dashed';option.series[0].data[1].itemStyle.normal.borderColor='transparent';option.series[1].data[1].itemStyle.normal.borderType='dashed';option.series[1].data[1].itemStyle.normal.borderColor='#fff';option.series[1].data[0].value=this.benchmark;option.series[1].data[1].value=0;}
if(optionData[0]===0&&optionData[1]===0){alert(I18n.resource.benchmark.energyBenchmark.NOT_GET_HISDATA);return;}
$('.spanBenchmark',this.$activeTabCtn).text(kIntSeparate(this.benchmark));$('.spanActual',this.$activeTabCtn).text(kIntSeparate(this.actual));}
return option;};BenchmarkEnergyBenchmark.prototype.onNodeClick=function onNodeClick(e,node){var _this7=this;node=node?node:this.screen.iotFilter.tree.getSelectedNodes()[0];if(!node)return;if(this.screen.opt.point&&this.screen.opt.point[node['_id']]){this.ptConfig=this.screen.opt.point[node['_id']];Spinner.spin(this.ctn);this.screen.getModel(node._id).done(function(rs){_this7.models=rs;_this7.renderModelInfo();}).always(function(rs){Spinner.stop();});}else{this.ptConfig={};}
if(this.$activeTabCtn[0].classList.contains('divPaneTwo')){$('#btnGetBaseByModel',this.ctn).trigger('click');}else{this.queryData();}};BenchmarkEnergyBenchmark.prototype.renderModelInfo=function renderModelInfo(){var $chooseModel=$('#chooseModel');var $strSel,interval;$chooseModel.empty();if(this.models&&this.models.length>0){this.models.forEach(function(model){if(model.interval==='h'){interval=I18n.resource.benchmark.energyAnalysis.BHOUR;}else if(model.interval==='d'){interval=I18n.resource.benchmark.energyAnalysis.BDAY;}else if(model.interval==='M'){interval=I18n.resource.benchmark.energyAnalysis.BMONTH;}else if(model.interval==='y'){interval=I18n.resource.benchmark.energyAnalysis.BYEAR;}else{interval='';}
$strSel=$('<option value="'+model._id+'">'+model.name+interval+'</option>').data('type',model.type).data('model',model.model).data('interval',model.interval);$chooseModel.removeAttr('disabled').append($strSel);});}else{$strSel=$('<option value="">'+I18n.resource.benchmark.energyBenchmark.NO_MODEL+'</option>');$chooseModel.attr('disabled','disabled').append($strSel);}};BenchmarkEnergyBenchmark.prototype.eventBtnConfigOnClick=function eventBtnConfigOnClick(e){var _this8=this;var _this=this;var $modelConfigModal=$('#modelConfigModal');var $divRelate=$('#divRelate').empty();var tpl='<div class="row">\
                <div class="col-sm-8"><span class="form-control point" dsId="{point}">{pName}</span></div>\
                <div class="col-sm-2"><span class="glyphicon glyphicon-remove-circle btnDelRelate"></span></div>\
            </div>';var strHtml='';if(_this.variables&&_this.variables.length>0){for(var j=0,len=_this.variables.length;j<len;j++){strHtml+=tpl.formatEL({pName:this.screen.dataSource.getDSItemById(_this.variables[j]).alias,point:_this.variables[j]});}}else{strHtml+=tpl.formatEL({point:'',pName:''});}
$divRelate.append(strHtml);$modelConfigModal.off('click').on('click','.btnSaveRelate',function(){var $divVariable=$('#divVariable').empty();var strHtml='';_this.variables.length=0;$divRelate.children('.row').each(function(){var point=$(this).find('span.point').attr('dsId');var dsName=$(this).find('span.point').text();if(point&&point!=='undefined'){if($.inArray(point,_this.variables)<0){_this.variables.push(point);strHtml+='<div class="dsNmame col-xs-offset-2" data-point="'+point+'">'+dsName+'</div>';}}});$divVariable.html(strHtml);});$modelConfigModal.modal('show');$modelConfigModal.on('hidden.bs.modal',function(){_this8.screen.hideDataSource();});this.screen.showDataSource();$('#btnAddRelate').off('click').on('click',function(){$divRelate.append(tpl.formatEL({name:'',point:'',pName:''}));});$divRelate.off('click').on('click','.btnDelRelate',function(){$(this).closest('.row').remove();});$divRelate.on('click','.btnEditRelate',function(){});$divRelate.off('dragover').on('dragover','.point',function(e){e.preventDefault();});$divRelate.off('dragleave').on('dragleave','.point',function(e){e.preventDefault();});$divRelate.off('drop').on('drop','.point',function(e){e.stopPropagation();e.preventDefault();var id=EventAdapter.getData().dsItemId;$(e.currentTarget).attr('dsId',id).text(_this8.screen.dataSource.getDSItemById(id).alias);});};BenchmarkEnergyBenchmark.prototype.calcSimilarDays=function calcSimilarDays(e){var _this9=this;this.clearInfo();var baseData=new Date($('#iptBaseTime',this.$activeTabCtn).val());var startTime=new Date($('.iptStartTime',this.$activeTabCtn).val());startTime=new Date(startTime.getFullYear(),startTime.getMonth(),1);var endTime=new Date(startTime.getFullYear(),startTime.getMonth()+1,0);var postData={'basedate':baseData.format('yyyy-MM-dd 00:00:00'),'startTime':startTime.format('yyyy-MM-dd 00:00:00'),'endTime':endTime.format('yyyy-MM-dd 00:00:00'),'type':'d1','x':this.variables};if(baseData<startTime||baseData>endTime){alert(I18n.resource.benchmark.energyBenchmark.FIDUCIALDAY_SELECT);return false;}
Spinner.spin(this.ctn);WebAPI.post('/analysis/calcSimilarDays',postData).done(function(rs){var strHtml='',time,strHead='<tr class="dataItem"><td class="time" i18n="benchmark.energyBenchmark.TIME">时间</td><td class="totalerror" i18n="benchmark.energyBenchmark.ALL_ERROR">总误差</td>';var $modelSimilarday=$('#modelSimilarday');try{rs=JSON.parse(rs);rs.forEach(function(item){strHtml+='<tr class="dataItem">\
                          <td class="time">'+item.time.split(' ')[0]+'</td>\
                          <td class="totalerror">'+kIntSeparate(item.totalerror*100)+'%</td>';for(var j=0;j<item.value.length;j++){strHtml+='<td class="value">'+kIntSeparate(item.value[j])+'</td>';}
strHtml+='</tr>';});for(var i=0;i<_this9.variables.length;i++){strHead+='<td class="value">'+_this9.screen.dataSource.getDSItemById(_this9.variables[i]).alias+'</td>';}
strHead+='</tr>';$modelSimilarday.find('.similarList').html(strHead+strHtml);$modelSimilarday.find('.similarList tbody tr:eq(1)').addClass('baseDate');$modelSimilarday.find('.similarList tbody tr:eq(2)').addClass('similarDate');$modelSimilarday.find('.similarList tbody tr:eq(3)').addClass('similarDate');$modelSimilarday.find('.similarList tbody tr:eq(4)').addClass('similarDate');var oTab=$modelSimilarday.find('.similarList')[0];var arr=[];for(i=1;i<oTab.tBodies[0].rows.length;i++){arr[i-1]=oTab.tBodies[0].rows[i];}
arr.sort(function(tr1,tr2){var n1=Date.parse(tr1.cells[0].innerHTML);var n2=Date.parse(tr2.cells[0].innerHTML);if(n1<n2){return-1;}else if(n1>n2){return 1;}else{return 0;}});for(i=0;i<arr.length;i++){oTab.tBodies[0].appendChild(arr[i]);}
$modelSimilarday.modal('show');$('.dataItem',$modelSimilarday).off('click').on('click',function(e){$modelSimilarday.modal('hide');var time=$(e.currentTarget).children('.time').text();$('#iptCompareTime',_this9.$activeTabCtn).val(time.split(' ')[0]);});I18n.fillArea($modelSimilarday);}catch(e){console.log('查找相似日失败!');}}).always(function(rs){Spinner.stop();}).fail(function(rs){alert(I18n.resource.benchmark.energyBenchmark.SELECT_EFFECTIVE_EQUIPMENT);});};BenchmarkEnergyBenchmark.prototype.getModelById=function getModelById(modelId){if(this.models&&this.models.length>0){for(var i=0,len=this.models.length;i<len;i++){if(this.models[i]._id===modelId){return i;}}}};return BenchmarkEnergyBenchmark;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BenchmarkEnergyQuery=function(){function BenchmarkEnergyQuery(ctn,screen,opt){_classCallCheck(this,BenchmarkEnergyQuery);this.ctn=ctn;this.screen=screen;this.opt=opt;this.arrEnergy=[];this.dictPoint={};this.hisData=undefined;this.chart=undefined;this.chartOption={toolbox:{show:true,feature:{magicType:{type:['line','bar']}},right:'4%'},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},title:{text:I18n.resource.benchmark.energyQuery.MEASURE_ENERGY_TEND},legend:{},grid:{top:100,left:'5%',right:'4%',bottom:'3%',containLabel:true},xAxis:[{type:'category'}],yAxis:[{type:'value',scale:true,axisLabel:{formatter:function formatter(value){if(value>=1000||value<=-1000){return value/1000+'k';}else{return value;}}}}]};var _this=this;this.screen.iotFilter.tree.setting.callback.onCheck=function(){_this.onCheck();};}
BenchmarkEnergyQuery.prototype.init=function init(){var now=new Date();this.startTime=new Date(now.getFullYear(),now.getMonth()-1,1);this.endTime=new Date(now.getFullYear(),now.getMonth(),0);$('#iptEndTime',this.ctn).val(this.endTime.format('yyyy-MM-dd'));$('#iptStartTime',this.ctn).val(this.startTime.format('yyyy-MM-dd'));this.attachEvents();};BenchmarkEnergyQuery.prototype.show=function show(){var _this2=this;$(this.ctn).empty();WebAPI.get('/static/views/observer/benchmark/energyQuery.html').done(function(html){$(_this2.ctn).append(html);I18n.fillArea($('.panelBmModule'));_this2.init();_this2.onNodeClick();});};BenchmarkEnergyQuery.prototype.destroy=function destroy(){this.screen.iotFilter.tree.setting.callback.onCheck=null;this.ctn=null;this.screen=null;this.opt=null;this.arrEnergy=null;this.dictPoint=null;this.hisData=null;this.chart=null;this.chartOption=null;this.chart=null;};BenchmarkEnergyQuery.prototype.attachEvents=function attachEvents(){var _this3=this;var _this=this;var $iptTime=$('.divTop input.form-control',this.ctn);$('#btnSave',this.ctn).off('click').on('click',function(e){return _this3.queryData();});$('#selCycle',this.ctn).off('change').on('change',function(e){return resetDateTime(e);});$iptTime.datetime();$('#ckShowPower',this.ctn).off('change').on('change',function(){_this.renderChart();});function resetDateTime(e){var val=e.target.value;var time,month;if(val==='M1'){$iptTime.attr('data-format','yyyy-mm');$iptTime.datetime('remove');$iptTime.datetime({minView:3,startView:4});}else if(val==='M12'){$iptTime.attr('data-format','yyyy');$iptTime.datetime('remove');$iptTime.datetime({minView:4,startView:4});}else if(val==='h1'){$iptTime.attr('data-format','yyyy-mm-dd hh');$iptTime.datetime('remove');$iptTime.datetime();}else{$iptTime.attr('data-format','yyyy-mm-dd');$iptTime.datetime('remove');$iptTime.datetime();$iptTime.off('change');}}};BenchmarkEnergyQuery.prototype.queryData=function queryData(){var _this4=this;if(!this.arrEnergy||this.arrEnergy.length===0){alert(I18n.resource.benchmark.energyQuery.SEL_EFFECTIVE_DEVICE);return;}
var cycle=$('#selCycle').val();var iptStartTimeVal=$('#iptStartTime').val();var iptEndTimeVal=$('#iptEndTime').val();var postData=[],now=new Date();var timeStart,timeEnd;if(cycle==='M1'){timeStart=new Date(iptStartTimeVal);timeEnd=new Date(iptEndTimeVal);timeStart=new Date(timeStart.getFullYear(),timeStart.getMonth(),1);timeEnd=new Date(timeEnd.getFullYear(),timeEnd.getMonth()+1,1);postData=[{timeFormat:cycle,timeStart:timeStart.format('yyyy-MM-dd 00:00:00'),timeEnd:timeEnd.format('yyyy-MM-dd 00:00:00'),dsItemIds:this.arrEnergy}];if(timeEnd>now){alert(I18n.resource.benchmark.energyQuery.BEFORE_MONTH);return;}}else if(cycle==='d1'){timeStart=new Date(iptStartTimeVal);timeEnd=new Date(new Date(iptEndTimeVal).getTime()+86400000);postData=[{timeFormat:cycle,timeStart:timeStart.format('yyyy-MM-dd 00:00:00'),timeEnd:timeEnd.format('yyyy-MM-dd 00:00:00'),dsItemIds:this.arrEnergy}];if(timeEnd>now){alert(I18n.resource.benchmark.energyQuery.BEFORE_DAY);return;}}else if(cycle==='h1'){timeStart=new Date(iptStartTimeVal);timeEnd=new Date(new Date(iptEndTimeVal).getTime()+3600000);postData=[{timeFormat:cycle,timeStart:timeStart.format('yyyy-MM-dd HH:mm:00'),timeEnd:timeEnd.format('yyyy-MM-dd HH:mm:00'),dsItemIds:this.arrEnergy}];if(timeEnd>now){alert(I18n.resource.benchmark.energyQuery.BEFORE_HOUR);return;}}else if(cycle==='M12'){iptStartTimeVal=parseInt(iptStartTimeVal);iptEndTimeVal=parseInt(iptEndTimeVal);if(iptEndTimeVal<iptStartTimeVal){alert(I18n.resource.benchmark.energyQuery.START_TIME_END);return;}
for(;iptStartTimeVal<=iptEndTimeVal;iptStartTimeVal++){postData.push({timeFormat:'M1',timeStart:new Date(iptStartTimeVal,0,1).format('yyyy-MM-dd 00:00:00'),timeEnd:new Date(iptStartTimeVal+1,0,1).format('yyyy-MM-dd 00:00:00'),dsItemIds:this.arrEnergy});}}
Spinner.spin(this.ctn);WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(rs){if(!rs)return;_this4.hisData=rs;_this4.renderChart();}).fail(function(){}).always(function(){Spinner.stop();});};BenchmarkEnergyQuery.prototype.renderChart=function renderChart(rs){if(!this.chart){this.chart=echarts.init(document.getElementById('divChartCtn'),AppConfig.chartTheme);}else{this.chart.clear();}
this.chart.setOption($.extend(this.chartOption,this.getChartOption()));};BenchmarkEnergyQuery.prototype.getChartOption=function getChartOption(){var _this=this;var rs=this.hisData;var option={xAxis:[{data:[]}],series:[],legend:{data:[]}};var period=$('#selCycle').val(),format;if(period=='d1'){format="MM-dd";}else if(period=='h1'){format="HH:00";}else{format="yyyy-MM";}
if(rs&&rs.length===1){rs.forEach(function(data){if(data.timeShaft&&data.timeShaft.length>0){option.xAxis[0].data=function(arrTime){var arrFormat=[];for(var i=0,l=arrTime.length-1;i<l;i++){arrFormat.push(new Date(arrTime[i]).format(format));}
return arrFormat;}(data.timeShaft);}
if(data.list&&data.list.length>0){data.list.forEach(function(item){var name=_this.dictPoint[item.dsItemId].name;if(_this.dictPoint[item.dsItemId].type=='energy'){option.series.push({name:name,type:'bar',data:function(d){var arr=[];for(var i=1,p,l=d.length;i<l;i++){p=d[i]-d[i-1];arr.push(p>0?p:0);}
return arr;}(item.data),itemStyle:{normal:{barBorderRadius:[5,5,0,0]}}});option.legend.data.push(name);}});}});}else if(rs&&rs.length>1){var iptStartTimeVal=$('#iptStartTime').val();var iptEndTimeVal=$('#iptEndTime').val();iptStartTimeVal=parseInt(iptStartTimeVal);iptEndTimeVal=parseInt(iptEndTimeVal);for(;iptStartTimeVal<=iptEndTimeVal;iptStartTimeVal++){option.xAxis[0].data.push(iptStartTimeVal);}
option.series[0]={name:name,type:'bar',data:[],itemStyle:{normal:{barBorderRadius:[5,5,0,0]}}};rs.forEach(function(data){if(data.list&&data.list.length>0){data.list.forEach(function(item){var name=item.dsItemId?_this.screen.dataSource.getDSItemById(item.dsItemId).alias:'';option.series[0].data.push(item.data[item.data.length-1]-item.data[0]);option.legend.data.push(name);});}});}
return option;};BenchmarkEnergyQuery.prototype.onNodeClick=function onNodeClick(e,node){var _this5=this;var checkedNodes=this.screen.iotFilter.tree.getSelectedNodes();this.arrEnergy.length=0;checkedNodes.forEach(function(node){var energy;if(_this5.screen.opt.point&&_this5.screen.opt.point[node['_id']]){energy=_this5.screen.opt.point[node['_id']].energy;_this5.arrEnergy.push(energy);_this5.dictPoint[energy]={name:node.name+'_'+I18n.resource.benchmark.energyQuery.ENERGY_CONSUMP,type:'energy'};}});this.queryData();};return BenchmarkEnergyQuery;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BenchmarkEnergyOverView=function(){function BenchmarkEnergyOverView(ctn,screen,opt){_classCallCheck(this,BenchmarkEnergyOverView);this.ctn=ctn;this.screen=screen;this.opt=opt;this.selectNode=undefined;this.costFinally=undefined;this.costType=0;}
BenchmarkEnergyOverView.prototype.show=function show(){var _this=this;WebAPI.get('/static/views/observer/benchmark/benchmarkEnergyOverView.html').done(function(resultHtml){$('.panelBmModule').html('').append(resultHtml);I18n.fillArea($('#bechOverViewBox'));_this.TopOneDataShow();_this.TopTwoDataShow();_this.TopThreeFirstDataShow();_this.TopThreeSecondDataShow();_this.attEvents();});};BenchmarkEnergyOverView.prototype.init=function init(){};BenchmarkEnergyOverView.prototype.attEvents=function attEvents(){var _this=this;function getIndex(arr,value){var str=arr.toString();var index=str.indexOf(value);if(index>=0){value=value.toString().replace(/(\[|\])/g,"\\$1");var reg1=new RegExp("((^|,)"+value+"(,|$))","gi");return str.replace(reg1,"$2@$3").replace(/[^,@]/g,"").indexOf("@");}else{return-1;}};$('#echartsList').off('slid.bs.carousel').on('slid.bs.carousel',function(e){switch($(e.relatedTarget).attr('id')){case'energyDay':_this.TopTwoDataShow('energyDay');break;case'costDay':_this.TopTwoDataShow('costDay');}});$('.calcButtonCost').click(function(){var btnStatiId=['btnCost0','btnCost1'];var btnNth=getIndex(btnStatiId,this.id);_this.costType=btnNth;_this.TopThreeSecondDataShow();$('.colorBartip').css('display','none');$('.statiColorBarC').removeClass('pointerC');for(var i=0;i<btnStatiId.length;i++){$('#'+btnStatiId[i]).removeClass('calcButtonCostActive');$('#'+btnStatiId[i]).addClass('calcButtonCost');};$(this).addClass('calcButtonCostActive');$(this).removeClass('calcButtonCost');});$('.calcButton').off('click').click(function(){var btnStatiId=['btnDay','btnWeek','btnMonth'];var $this=$(this);if($this.hasClass('calcButtonActive'))return;$this.addClass('calcButtonActive');$this.removeClass('calcButton');$this.siblings('div').removeClass('calcButtonActive');$this.siblings('div').addClass('calcButton');_this.selectNode=_this.screen.iotFilter.tree.getSelectedNodes()[0];if(!_this.selectNode.isParent||_this.selectNode.isParent&&!_this.selectNode.children)return;var pointsAll=_this.screen.opt.point;var legendColor=['#fed001','rgb(248,245,124)','rgb(182,209,78)','rgb(146,192,129)','rgb(105,170,187)','rgb(73,152,234)'];var pointsIdList=[];var pointsNameList=[];var pointsData=[];var pieData={};var childrenPoints=_this.selectNode.children;var isExidEnergy=false;for(var i=0;i<childrenPoints.length;i++){if(pointsAll[childrenPoints[i]._id]){isExidEnergy=true;pointsIdList.push(pointsAll[childrenPoints[i]._id].energy);pointsNameList.push(childrenPoints[i].name);}}
if(!isExidEnergy){alert(I18n.resource.benchmark.energyOverView.NO_CHILDREN);return;}
pieData['nameList']=pointsNameList;var postDataPieChart;if(this.id==='btnDay'){postDataPieChart={dsItemIds:pointsIdList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'h1',timeStart:new Date().format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00'};}else if(this.id==='btnWeek'){var weekNum=new Date().getDay();weekNum=weekNum==0?7:weekNum;if(weekNum===1){postDataPieChart={dsItemIds:pointsIdList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'h1',timeStart:new Date().format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00'};}else{postDataPieChart={dsItemIds:pointsIdList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'d1',timeStart:new Date(new Date().valueOf()-86400000*weekNum).format('yyyy-MM-dd 00:00:00')};}}else{var currentMonth=new Date().getMonth()+1;currentMonth=currentMonth-1<10?'0'+(currentMonth-1).toString():currentMonth-1;if(new Date().getDate()===1){postDataPieChart={dsItemIds:pointsIdList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'h1',timeStart:new Date().format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00'};}else{postDataPieChart={dsItemIds:pointsIdList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'d1',timeStart:new Date().getFullYear()+'-'+currentMonth+'-31'+' 00:00:00'};}}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postDataPieChart).done(function(result){var isExistData=false;for(var i=0;i<result.list.length;i++){if(result.list[i].data.length>0){isExistData=true;}}
if(!isExistData){alert(I18n.resource.benchmark.energyOverView.NO_DATA);return;}
var totalList=1;for(var i=0;i<result.list.length;i++){var currentData;if(result.list[i].data.length===0){currentData=0;}else{currentData=result.list[i].data[result.list[i].data.length-1]-result.list[i].data[0];if(currentData<0){currentData=0;}}
totalList+=currentData;pointsData.push(currentData);}
pieData['data']=[];pieData['data']=pointsData;totalList=totalList>1?totalList-1:totalList;var legendInner=$('.legendInner');for(var i=0;i<result.list.length;i++){for(var j=0;j<legendInner.length;j++){if(legendInner.eq(j).attr('current_id')==result.list[i].dsItemId){legendInner.eq(j).find('.legendInnerData>span').html(kIntSeparate(pointsData[i])+'  kWh');legendInner.eq(j).find('.legendInnerText2>span').html(kIntSeparate(Math.abs(pointsData[i]*1000/totalList)/10)+'%');}}}
_this.TopThreeFirstEcharts(pieData);});});};BenchmarkEnergyOverView.prototype.countCost=function countCost(corresTimeH){var _this=this;var nowCost=0;if(!_this.costFinally)return 1;for(var j=0;j<_this.costFinally.length;j++){var costTime=parseInt(_this.costFinally[j].time.split(':')[0]);var costFistTime=parseInt(_this.costFinally[0].time.split(':')[0]);costTime=costTime==0?24:costTime;if(corresTimeH===costTime){nowCost=parseFloat(_this.costFinally[j].cost);return nowCost;}
if(j===_this.costFinally.length-1){if(corresTimeH>=costTime){nowCost=parseFloat(_this.costFinally[j].cost);return nowCost;}}else{if(corresTimeH<costFistTime){nowCost=parseFloat(_this.costFinally[_this.costFinally.length-1].cost);return nowCost;}
var costlatTime=parseInt(_this.costFinally[j+1].time.split(':')[0]);costlatTime=costlatTime==0?24:costlatTime;if(corresTimeH>=costTime&&corresTimeH<costlatTime){nowCost=parseFloat(_this.costFinally[j].cost);return nowCost;}}}};BenchmarkEnergyOverView.prototype.TopOneDataShow=function TopOneDataShow(){var _this=this;this.selectNode=this.screen.iotFilter.tree.getSelectedNodes()[0];var selectNodeId=this.selectNode._id;var dataList=this.screen.opt.point[selectNodeId];var costSin=this.screen.opt.cost;if(costSin&&costSin.length>0){costSin.sort(function(a,b){return parseInt(a.time.split(':')[0])-parseInt(b.time.split(':')[0]);});this.costFinally=costSin;}
if(dataList){var dsItemIds=[];var dsItemIds1=[];dsItemIds.push(dataList.energy);dsItemIds1.push(dataList.power);var $threeItem3Span=$('#threeItem3').find('span.threeItem3Span');if(dataList.power){WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:dsItemIds1}).done(function(resultPower){if(!resultPower||!resultPower.dsItemList||!(resultPower.dsItemList instanceof Array))return;if(resultPower.dsItemList[0].data){if(parseFloat(resultPower.dsItemList[0].data)<1){$threeItem3Span.html(kIntSeparate(parseFloat(resultPower.dsItemList[0].data),1));}else{$threeItem3Span.html(kIntSeparate(parseInt(resultPower.dsItemList[0].data)));}}else{$threeItem3Span.html(I18n.resource.benchmark.energyOverView.NO_DATA);}});}else{$threeItem3Span.html(I18n.resource.benchmark.energyOverView.NO_DATA);alert(I18n.resource.benchmark.energyOverView.NO_CURRENT_NODE);}
Spinner.spin($('.panelBmModule')[0]);WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:dsItemIds,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'h1',timeStart:new Date().format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00'}).done(function(result){var resultList=result.list;if(resultList&&resultList.length>0){for(var i=0;i<resultList.length;i++){if(resultList[i].dsItemId===dataList.energy){var $threeItem1Span=$('#threeItem1').find('span.threeItem1Span');var $threeItem2Span=$('#threeItem2').find('span.threeItem2Span');if(resultList[i].data.length>0){var resultListData=resultList[i].data;var energyDataFin=Math.abs(resultListData[resultListData.length-1]-resultListData[0]);if(energyDataFin<1){$threeItem1Span.html(kIntSeparate(energyDataFin,1));}else{$threeItem1Span.html(kIntSeparate(energyDataFin));}
var nowHour=parseInt(new Date().format('yyyy-MM-dd HH:mm:ss').split(' ')[1].split(':')[0]);nowHour=nowHour==0?24:nowHour;var nowCost=0;nowCost=_this.countCost(nowHour);var todayCostReduct=0;for(var k=1;k<resultListData.length;k++){var currentHourEnergy=resultListData[k]-resultListData[k-1];var currentHour=parseInt(result.timeShaft[k-1].split(' ')[1].split(':')[0]);currentHour=currentHour==0?24:currentHour;var currentHourCost=_this.countCost(currentHour);todayCostReduct+=currentHourEnergy*currentHourCost;}
if(todayCostReduct<1){$threeItem2Span.html(kIntSeparate(todayCostReduct,1));}else{$threeItem2Span.html(kIntSeparate(todayCostReduct));}}else{if(dataList.energy===''){alert(I18n.resource.benchmark.energyOverView.NO_CURRENT_NODE);}
$threeItem1Span.html(I18n.resource.benchmark.energyOverView.NO_DATA);}}}}}).always(function(){Spinner.stop();});}else{alert(I18n.resource.benchmark.energyOverView.NO_CURRENT_NODE);}};BenchmarkEnergyOverView.prototype.TopTwoDataShow=function TopTwoDataShow(id){var _this=this;var selectNodeId=this.selectNode._id;var dataList=this.screen.opt.point[selectNodeId];if(dataList){var dsItemIds=[];dsItemIds.push(dataList.energy);var timeYesday=new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd HH:mm:ss');WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:dsItemIds,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'h1',timeStart:timeYesday.split(' ')[0]+' '+(parseInt(timeYesday.split(' ')[1].split(':')[0])-1>=10?parseInt(timeYesday.split(' ')[1].split(':')[0])-1:('0'+(parseInt(timeYesday.split(' ')[1].split(':')[0])-1)).toString())+':'+timeYesday.split(' ')[1].split(':')[1]+':'+timeYesday.split(' ')[1].split(':')[2]}).done(function(result){var resultList=result.list;var powerList;if(resultList&&resultList[0].data.length>0){resultList[0].name=I18n.resource.benchmark.energyOverView.HOURLY_ENERGY;resultList[0].timeShaft=result.timeShaft;resultList[0].domBox=$('#energyDay')[0];powerList=$.extend(true,{},resultList[0]);for(var i=1;i<powerList.data.length;i++){powerList.data[i-1]=(powerList.data[i]-powerList.data[i-1]).toFixed(2);}
if(!id||id==='energyDay'){powerList.data=powerList.data.slice(0,powerList.data.length-1);powerList.timeShaft=powerList.timeShaft.slice(1,powerList.timeShaft.length);_this.echartsBar(powerList);}else{powerList.data=[];for(var i=1;i<resultList[0].data.length;i++){var corresTimeH=parseInt(result.timeShaft[i].split(' ')[1].split(':')[0]);corresTimeH=corresTimeH===0?24:corresTimeH;var nowCost=0;nowCost=_this.countCost(corresTimeH);powerList.data.push(((resultList[0].data[i]-resultList[0].data[i-1])*nowCost).toFixed(2));}
powerList.name=I18n.resource.benchmark.energyOverView.HOURLY_COST;powerList.domBox=$('#costDay')[0];powerList.timeShaft=powerList.timeShaft.slice(1,powerList.timeShaft.length);_this.echartsBar(powerList);}}else{}}).always(function(){});}else{alert(I18n.resource.benchmark.energyOverView.NO_CURRENT_NODE);}};BenchmarkEnergyOverView.prototype.TopThreeFirstDataShow=function TopThreeFirstDataShow(period){var _this=this;if(!_this.selectNode.isParent||_this.selectNode.isParent&&!_this.selectNode.children)return;var pointsAll=_this.screen.opt.point;var legendColor=['#fed001','rgb(248,245,124)','rgb(182,209,78)','rgb(146,192,129)','rgb(105,170,187)','rgb(73,152,234)'];var pointsIdList=[];var pointsNameList=[];var pointsData=[];var pieData={};$('#btnDay').siblings('div').removeClass('calcButtonActive');$('#btnDay').siblings('div').addClass('calcButton');$('#btnDay').addClass('calcButtonActive');var childrenPoints=_this.selectNode.children;var isExidEnergy=false;for(var i=0;i<childrenPoints.length;i++){if(pointsAll[childrenPoints[i]._id]){isExidEnergy=true;pointsIdList.push(pointsAll[childrenPoints[i]._id].energy);pointsNameList.push(childrenPoints[i].name);}}
if(!isExidEnergy){alert(I18n.resource.benchmark.energyOverView.NO_ENERGY_POINT);return;}
pieData['nameList']=pointsNameList;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointsIdList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'h1',timeStart:new Date().format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00'}).done(function(result){var $legendZone=$('#SubZone_container002').find('.legendZone');$legendZone.html('');var totalList=1;for(var i=0;i<result.list.length;i++){var currentData;if(result.list[i].data.length===0){currentData=0;}else{currentData=result.list[i].data[result.list[i].data.length-1]-result.list[i].data[0];if(currentData<0){currentData=0;}}
totalList+=currentData;pointsData.push(currentData);}
pieData['data']=[];pieData['data']=pointsData;totalList=totalList>1?totalList-1:totalList;var j=0;for(var i=0;i<result.list.length;i++){var idEn=i<10?'0'+i:i;var legendInner=' <div class="legendInner" id="legendData'+idEn+'" current_id="'+result.list[i].dsItemId+'">\
                                    <div class="legendInnerLeft" id="legendInnerDiv'+i+'">\
                                    </div>\
                                    <div class="legendInnerRight">\
                                            <div class="legendInnerText1">\
                                                <p>'+pointsNameList[i]+'</p>\
                                            </div>\
                                            <div class="legendInnerText2">\
                                                <span id="legendPercent'+i+'">68.0%</span>\
                                            </div>\
                                        <div class="legendInnerData">\
                                            <span id="legendValue'+i+'">'+kIntSeparate(pointsData[i])+'  kWh</span>\
                                        </div>\
                                    </div>\
                                </div>';$legendZone.append(legendInner);if(j>5){j=0;}
$('#legendInnerDiv'+i).css({'background-color':legendColor[j]});$('#legendPercent'+i).html((pointsData[i]*1000/totalList/10).toFixed(2)+'%');j++;}
_this.TopThreeFirstEcharts(pieData);});};BenchmarkEnergyOverView.prototype.TopThreeFirstEcharts=function TopThreeFirstEcharts(resultData){var legendColor=['#fed001','rgb(248,245,124)','rgb(182,209,78)','rgb(146,192,129)','rgb(105,170,187)','rgb(73,152,234)'];var option={color:[],tooltip:{trigger:'item'},calculable:false,series:[{name:I18n.resource.benchmark.energyOverView.ENERGY_COMP,type:'pie',radius:['50%','70%'],itemStyle:{normal:{borderColor:'white',label:{show:false},labelLine:{show:false}}},data:[]}]};var j=0;for(var i=0;i<resultData.data.length;i++){option.color.push(legendColor[j]);if(i==legendColor.length){j=0;}
j++;option.series[0].data.push({value:resultData.data[i],name:resultData.nameList[i]});}
if(document.getElementById('divJAJLCircle13')){var chart=echarts.init(document.getElementById('divJAJLCircle13'));chart.setOption(option);}};BenchmarkEnergyOverView.prototype.TopThreeSecondDataShow=function TopThreeSecondDataShow(){var _this=this;var now=new Date();var stDay=new Date().setDate(now.getDate()).toDate().setHours(0,0,0).toDate().format('dd');var endTime=new Date().setDate(now.getDate()-1).toDate().setHours(0,0,0).toDate().format('yyyy-MM-dd HH:mm:ss');var DateStr=new Date(new Date().valueOf()-86400000).format('MM/dd');if(stDay=='01'){var startTime=new Date().setMonth(now.getMonth()-1,1).toDate().setHours(0,0,0).toDate().format('yyyy-MM-dd HH:mm:ss');}else{var startTime=new Date().setDate(1).toDate().setHours(0,0,0).toDate().format('yyyy-MM-dd HH:mm:ss');};var selectNodeId=this.selectNode._id;var dataList=this.screen.opt.point[selectNodeId];if(dataList){var dsItemIds=[];dsItemIds.push(dataList.energy);WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:dsItemIds,timeStart:new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00',timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00',timeFormat:'h1'}).done(function(resultData){var result=resultData;var dataList=result.list;var energyDValue=result.list[0].data;var nowCost=_this.costFinally?parseInt(_this.costFinally[_this.costFinally.length-1].cost):1;var lastdayERank=1;$('#reportTittle').text(I18n.resource.benchmark.energyOverView.YESTODAY_ENERGY_OVERVIEW+'('+DateStr+')');$('#lastDayEnergyValue').text(kIntSeparate(parseInt(energyDValue[energyDValue.length-1]-energyDValue[0])));var yesCostReduct=0;for(var k=1;k<energyDValue.length;k++){var currentHourEnergy=energyDValue[k]-energyDValue[k-1];var currentHour=parseInt(result.timeShaft[k-1].split(' ')[1].split(':')[0]);currentHour=currentHour==0?24:currentHour;var currentHourCost=_this.countCost(currentHour);yesCostReduct+=currentHourEnergy*currentHourCost;}
$('#lastDayCostValue').text(kIntSeparate(yesCostReduct,1));for(var i=0;i<energyDValue.length;i++){if(energyDValue[energyDValue.length-1]<energyDValue[i]){lastdayERank=lastdayERank+1;};};});}
$('#btnCost0').addClass('calcButtonCostActive');$('#btnCost1').removeClass('calcButtonCostActive').addClass('calcButtonCost');function toFamot00(str,num){if(num<10){return str+'0'+num;}else{return str+num;};};var elecFeeColor=['#2ecc71','#92d050','#c0df40','#fbf30c','#fed001','#fe5050'];var maxValue=1;var minValue=0;var pricePeriod=[];pricePeriod[0]=[8,9,10,13,14,18,19,20];pricePeriod[1]=[6,7,11,12,15,16,17,21];pricePeriod[2]=[0,1,2,3,4,5,22,23];var cost=[];function costColorType(a){var typeN=parseInt(5*(a-minValue)/(maxValue-minValue));return typeN<0?0:typeN;};function costColorFill(num,idStr){$(idStr).css("background-color",elecFeeColor[costColorType(num)<5?costColorType(num):5]);$(idStr).css("opacity",'1');};var now=new Date();var startTime=new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00';var endTime=new Date().format('yyyy-MM-dd HH:mm:ss').split(' ')[0]+' 00:00:00';if(dataList){var dsItemIds=[];dsItemIds.push(dataList.energy);WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:dsItemIds,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(resultData){var result=resultData;var dataList=result.list;var resultListData=result.list[0].data;var energyCost=[];if(resultListData.length>0){for(var j=1;j<resultListData.length;j++){resultListData[j-1]=parseFloat((resultListData[j]-resultListData[j-1]).toFixed(2));var corresTimeH=parseInt(result.timeShaft[j-1].split(' ')[1].split(':')[0]);corresTimeH=corresTimeH===0?24:corresTimeH;var nowCost=0;nowCost=_this.countCost(corresTimeH);energyCost.push(parseFloat((resultListData[j-1]*nowCost).toFixed(2)));}
resultListData.pop();result.timeShaft=result.timeShaft.slice(1,result.timeShaft.length);}
if(_this.costType===1){cost=energyCost;}else{cost=resultListData;}
var costCopy=[];var costRank=[];var hourName=['0:00~1:00 am','1:00~2:00 am','2:00~3:00 am','3:00~4:00 am','4:00~5:00 am','5:00~6:00 am','6:00~7:00 am','7:00~8:00 am','8:00~9:00 am','9:00~10:00 am','10:00~11:00 am','11:00~12:00 am','12:00~1:00 pm','1:00~2:00 pm','2:00~3:00 pm','3:00~4:00 pm','4:00~5:00 pm','5:00~6:00 pm','6:00~7:00 pm','7:00~8:00 pm','8:00~9:00 pm','9:00~10:00 pm','10:00~11:00 pm','11:00~0:00 am'];for(var i=0;i<cost.length;i++){costCopy[i]=cost[i];};costCopy.sort(function(a,b){return a<b?1:-1;});for(var i=0;i<cost.length;i++){for(var j=0;j<costCopy.length;j++){if(costCopy[j]==cost[i]){costRank[j]=i;}};};maxValue=costCopy[0];minValue=costCopy[23];for(var i=0;i<cost.length;i++){if(_this.costType==0){$(toFamot00('#elecFee',i)).text(cost[i]+'kWh');}else{$(toFamot00('#elecFee',i)).text('￥'+cost[i]);};costColorFill(cost[i],toFamot00('#elecFeeColor',i));};for(var i=0;i<3;i++){var calcSum=0;for(var j=0;j<pricePeriod[i].length;j++){calcSum=calcSum+cost[pricePeriod[i][j]];};if(_this.costType==0){$('#rankCost'+i).text(kIntSeparate(parseInt(calcSum))+' kWh');}else{$('#rankCost'+i).text('￥ '+kIntSeparate(parseInt(calcSum)));};};});}};BenchmarkEnergyOverView.prototype.historyData=function historyData(postData){Spinner.spin($('.panelBmModule')[0]);WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(data){if(data){return data;}}).always(function(){Spinner.stop();});;};BenchmarkEnergyOverView.prototype.echartsBar=function echartsBar(resultData){var timeShift=[];for(var i=0;i<resultData.timeShaft.length;i++){timeShift.push(resultData.timeShaft[i].split(' ')[1].split(':')[0]+':'+resultData.timeShaft[i].split(' ')[1].split(':')[1]);}
var option={tooltip:{trigger:'axis'},legend:{data:[resultData.name]},axisLabel:{formatter:function formatter(value){if(value>=1000||value<=-1000){return value/1000+'k';}else{return value;}}},grid:{left:70},calculable:false,dataZoom:{show:false},xAxis:[{type:'category',splitLine:{show:false},data:timeShift}],yAxis:[{type:'value',splitArea:{show:false}}],series:[{name:resultData.name,type:'bar',data:resultData.data}]};var chart=echarts.init(resultData.domBox,AppConfig.chartTheme);chart.setOption(option);};BenchmarkEnergyOverView.prototype.onNodeClick=function onNodeClick(e,node){var _this=this;_this.TopOneDataShow();_this.TopTwoDataShow();_this.TopThreeSecondDataShow();_this.TopThreeFirstDataShow();_this.attEvents();};BenchmarkEnergyOverView.prototype.destroy=function destroy(){this.ctn=null;this.screen=null;this.opt=null;this.selectNode=null;this.costFinally=null;this.costType=null;$('#echartsList').off('slid.bs.carousel');$('#echartsList').empty().remove();};return BenchmarkEnergyOverView;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BenchmarkEnergyDiagnosis=function(){function BenchmarkEnergyDiagnosis(ctn,screen,opt){_classCallCheck(this,BenchmarkEnergyDiagnosis);this.ctn=ctn;this.screen=screen;this.opt=opt;this.parentNode=undefined;}
BenchmarkEnergyDiagnosis.prototype.show=function show(){var _this=this;WebAPI.get('/static/views/observer/benchmark/benchmarkEnergyDiagnosis.html').done(function(resultHtml){$('.panelBmModule').html('').append(resultHtml);I18n.fillArea($('#benchDiagnosis'));_this.diagnosisListInit();_this.init();});};BenchmarkEnergyDiagnosis.prototype.init=function init(){var _this=this;var currentMonth=new Date().getMonth();var timeMList=[1,3,5,7,8,10,12];var monthLastDay;var currentYear=new Date().getFullYear();if(timeMList.indexOf(currentMonth)!==-1){monthLastDay='-31';}else if(currentMonth==2){if(currentYear%4==0&&currentYear%100!=0||currentYear%400==0){monthLastDay='-29';}else{monthLastDay='-28';}}else{monthLastDay='-30';}
currentMonth=currentMonth<10?'0'+currentMonth.toString():currentMonth;var currentPonit=this.screen.iotFilter.tree.getNodes()[0]._id;var dsItemIds=this.screen.opt.point[currentPonit].energy;var resultList=[];var postDate={dsItemIds:[dsItemIds],timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'d1',timeStart:currentYear+'-'+currentMonth+monthLastDay+' 00:00:00'};WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postDate).done(function(result){var currentTime={};currentTime.data=[];var resultListData=result.list[0].data;if(resultListData.length===0){alert(I18n.resource.benchmark.energyDiagnosis.CURRENT_POINT_NO_DATA);return;}
for(var i=1;i<resultListData.length;i++){currentTime.data.push((resultListData[i]-resultListData[i-1]).toFixed(2));}
currentTime.timeShaft=result.timeShaft.slice(1,result.timeShaft.length);_this.parentNode=currentTime;resultList.push(currentTime);_this.echartsLineInt(resultList);_this.attEvents();});};BenchmarkEnergyDiagnosis.prototype.attEvents=function attEvents(){var _this=this;$('#diagnosisInfoBox').find('.diagnosisSin').off('click').click(function(){var $this=$(this);var $diagnosisSelect=$this.find('.diagnosisSelect');if($this.hasClass('active')){$this.removeClass('active');$diagnosisSelect.removeClass('selectActive');}else{$this.addClass('active');$diagnosisSelect.addClass('selectActive');}});$('#diagnoForestData').off('click').click(function(){if(!_this.parentNode){alert(I18n.resource.benchmark.energyDiagnosis.CURRENT_POINT_NO_DATA);return;}
var disgnosisActive=$('.diagnosisSin.active');var arrFault=[];var resultList=[];var addResult=[];if(disgnosisActive.length===0){alert(I18n.resource.benchmark.energyDiagnosis.SELECT_DIAGNOSIS);return;}
for(var i=0;i<disgnosisActive.length;i++){arrFault.push(disgnosisActive.eq(i).find('.disgName').attr('data-name'));}
resultList.push(_this.parentNode);var currentMonth=new Date().getMonth()+1;currentMonth=currentMonth<10?'0'+currentMonth.toString():currentMonth;Spinner.spin($('#benchDiagnosis')[0]);WebAPI.post('/benchmark/diagnosis/getPredict',{arrFault:arrFault,endTime:new Date().format('yyyy-MM-dd HH:mm:ss'),interval:'d1',startTime:new Date().getFullYear()+'-'+currentMonth+'-01'+' 00:00:00',projectId:AppConfig.projectId}).done(function(resultAll){var secondData={};var resultData=[];var result=[];var barOne={};var barTwo={};barOne.timeShaft=_this.parentNode.timeShaft;for(var i=0;i<_this.parentNode.data.length;i++){if(!resultAll.data||resultAll.data.length===0){alert(I18n.resource.benchmark.energyDiagnosis.NO_DIAGNOSIS_ADD);return;}else{var finalData=(parseInt(_this.parentNode.data[i])-resultAll.data[i]).toFixed(2);if(finalData<0){finalData=0;}
result.push(finalData);}}
secondData.data=result;barOne.data=result;addResult.push(_this.parentNode);barTwo.data=resultAll.data;addResult.push(barTwo);if(resultList.length>1){resultList=resultList.slice(1,resultList.length);}
resultList.push(secondData);_this.echartsLineInt(resultList,resultAll.data);}).always(function(){Spinner.stop();});});};BenchmarkEnergyDiagnosis.prototype.echartsLineInt=function echartsLineInt(resultData,addResult){var timeShift=[];for(var i=0;i<resultData[0].timeShaft.length;i++){timeShift.push(resultData[0].timeShaft[i].split(' ')[0]);}
var option={tooltip:{trigger:'axis'},axisLabel:{formatter:function formatter(value){if(value>=1000||value<=-1000){return value/1000+'k';}else{return value;}}},legend:{data:[I18n.resource.benchmark.energyDiagnosis.CURRENT_DATE]},grid:{left:'3%',right:'4%',bottom:'3%',containLabel:true},xAxis:[{type:'category',boundaryGap:false,data:timeShift}],yAxis:[{type:'value',axisLine:{onZero:false},boundaryGap:false}],series:[{name:I18n.resource.benchmark.energyDiagnosis.CURRENT_DATE,type:'line',smooth:true,symbol:'rect',lineStyle:{normal:{width:3}},data:resultData[0].data}]};if(resultData.length>1){option.legend.data.push(I18n.resource.benchmark.energyDiagnosis.FORCAST_DATE);option.series.push({name:I18n.resource.benchmark.energyDiagnosis.FORCAST_DATE,type:'line',smooth:true,lineStyle:{normal:{type:'dashed',width:3}},data:resultData[1].data});}
if(addResult&&addResult.length>0){option.yAxis.push({type:'value',axisLine:{show:false},boundaryGap:false,splitLine:{show:false}});option.series.push({name:'增量',type:'bar',itemStyle:{normal:{barBorderColor:'rgba(6,113,162,0.8)',color:'rgba(6,113,162,0.8)'},emphasis:{barBorderColor:'rgba(6,113,162,0.8)',color:'rgba(6,113,162,0.8)'}},yAxisIndex:1,data:addResult});}
var dom=$('#lineEchartsBox')[0];var chart=echarts.init(dom,AppConfig.chartTheme);chart.setOption(option);};BenchmarkEnergyDiagnosis.prototype.diagnosisListInit=function diagnosisListInit(){var _this=this;WebAPI.get('/benchmark/diagnosis/get/'+AppConfig.projectId).done(function(result){if(result.data.length===0){alert(I18n.resource.benchmark.energyDiagnosis.NO_DIAGNOSIS_INFO);return;}else{var result=result.data;}
for(var i=0;i<result.length;i++){var diagnosisSin='<div class="diagnosisSin clearfix">\
                    <div class="leftDiagInfo col-xs-12">\
                        <div class="disgName" data-name="'+result[i].name+'">'+(i+1)+'.'+result[i].name+'</div>\
                        <div class="disgNum clearfix"><div class="col-xs-6 disgNumList">'+kIntSeparate(result[i].energy)+' kWh/'+I18n.resource.benchmark.energyDiagnosis.DIAGNOSIS_DAY+'</div><div class="col-xs-6 disgNumList">'+kIntSeparate(result[i].coust)+' '+I18n.resource.benchmark.energyOverView.MONEY+'/'+I18n.resource.benchmark.energyDiagnosis.DIAGNOSIS_DAY+'</div></div>\
                        <div class="disgDetail">'+result[i].detail+'</div>\
                    </div>\
                    <div class="rightMore col-xs-3">\
                        <div class="btnMore">More</div>\
                    </div>\
                    <i class="iconfont gouxuan diagnosisSelect">&#xe661;</i>\
                    </div>';$('#diagnosisInfoBox').append(diagnosisSin);}
_this.attEvents();});};BenchmarkEnergyDiagnosis.prototype.onNodeClick=function onNodeClick(e,node){var _this=this;};BenchmarkEnergyDiagnosis.prototype.destroy=function destroy(){this.ctn=null;this.screen=null;this.opt=null;this.parentNode=null;};return BenchmarkEnergyDiagnosis;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BenchmarkEnergyForecast=function(){function BenchmarkEnergyForecast(ctn,screen,opt){_classCallCheck(this,BenchmarkEnergyForecast);this.ctn=ctn;this.screen=screen;this.opt=opt;this.$bechForecast=undefined;this.paramsRelate=undefined;this.nodeMode=undefined;this.historyData=[];this.mathListData=[];this.importSuccess=undefined;}
BenchmarkEnergyForecast.prototype.show=function show(){var _this=this;WebAPI.get('/static/views/observer/benchmark/benchmarkEnergyForecast.html').done(function(resultHtml){$('.panelBmModule').html('').append(resultHtml);_this.$bechForecast=$('#bechForecast');I18n.fillArea(_this.$bechForecast);var startTime=new Date(new Date().valueOf()-86400000).format('yyyy-MM');var showStart=parseInt(startTime.split('-')[0])-1+'-'+startTime.split('-')[1];var timeFormatStr=timeFormatChange('yyyy-mm');var start=showStart.toDate(),end=new Date();$('#startTimeCog').datetimepicker({format:timeFormatStr,autoclose:true,todayBtn:true,minView:3,startView:3,forceParse:false,startDate:"2010-01-01 00:00",endDate:end,initialDate:start}).val(start.timeFormat(timeFormatStr));$('#endTimeCog').datetimepicker({format:timeFormatStr,autoclose:true,todayBtn:true,minView:3,startView:3,forceParse:false,startDate:"2010-01-01 00:00",endDate:end,initialDate:end}).val(end.timeFormat(timeFormatStr));_this.init();_this.attEvents();});};BenchmarkEnergyForecast.prototype.init=function init(){var _this=this;var currentNode=this.screen.iotFilter.tree.getSelectedNodes()[0];var nodeId=currentNode._id;Spinner.spin($('#bechForecast')[0]);this.screen.getModel(nodeId).done(function(rs){_this.nodeMode=rs;var $modalSelect=$('.modalSelect');$modalSelect.html('');if(rs.length===0){alert(I18n.resource.benchmark.energyForecast.NO_MODEL_CREAT);var option='<option class="modalSin" i18n="benchmark.energyForecast.NO_MODEL">无模型</option>';$modalSelect.append(option);I18n.fillArea($modalSelect);return;}
for(var i=0;i<rs.length;i++){var name=rs[i].name==''?'Untitled':rs[i].name;var option='<option class="modalSin" data-id = "'+rs[i]._id+'" data-interval="'+rs[i].interval+'">'+name+'('+rs[i].interval+')'+'</option>';$modalSelect.append(option);}
_this.attEvents();}).always(function(){Spinner.stop();});};BenchmarkEnergyForecast.prototype.attEvents=function attEvents(){var _this=this;$('.timeSelsect').off('change').change(function(){var $this=$(this);var $startTimeCog=$('#startTimeCog');var $endTimeCog=$('#endTimeCog');var $inputTime=_this.$bechForecast.find('.input-group').find('input.form-control');var timeFormatStr,start,end,minView,startView;if($this.val()==='M1'){timeFormatStr=timeFormatChange('yyyy-mm');start=new Date().timeFormat(timeFormatStr);end=new Date().timeFormat(timeFormatStr);minView=3;startView=3;}else if($this.val()==='h1'){timeFormatStr=timeFormatChange('yyyy-mm-dd hh')+' :00';start=new Date().format('yyyy-MM-dd').toDate().timeFormat(timeFormatStr);end=new Date().timeFormat(timeFormatStr);minView=1;startView=2;}else{timeFormatStr=timeFormatChange('yyyy-mm-dd');start=new Date(new Date().valueOf()-86400000).timeFormat(timeFormatStr);end=new Date().timeFormat(timeFormatStr);minView=2;startView=2;}
$startTimeCog.datetimepicker('remove').datetimepicker({format:timeFormatStr,autoclose:true,todayBtn:true,minView:minView,startView:startView,forceParse:false,startDate:"2010-01-01 00:00",endDate:new Date(),initialDate:start}).val(start);$endTimeCog.datetimepicker('remove').datetimepicker({format:timeFormatStr,autoclose:true,todayBtn:true,minView:minView,startView:startView,forceParse:false,startDate:"2010-01-01 00:00",endDate:new Date(),initialDate:end}).val(end);});function judgeModalInter(dataInterval){var currentTimeIn=$('.timeSelsect').val();var intervalStr='';if(dataInterval==='h'){intervalStr=I18n.resource.benchmark.energyForecast.HOUR;}else if(dataInterval==='d'){intervalStr=I18n.resource.benchmark.energyOverView.DAY;}else{intervalStr=I18n.resource.benchmark.energyOverView.MONTH;}
if(currentTimeIn.indexOf(dataInterval)===-1){alert(I18n.resource.benchmark.energyForecast.MODEL_NOT_ACCORD+intervalStr+I18n.resource.benchmark.energyForecast.PERIOD_CHANGE_MODEL);return false;}else{return true;}}
$('.modalSin').off('click').click(function(){var $this=$(this);var dataInterval=$this.attr('data-interval');judgeModalInter(dataInterval);var dataId=$this.attr('data-id');});function historyForest(startTimes,endTimes,isRepeat){var currentNode=_this.screen.iotFilter.tree.getSelectedNodes()[0];var nodeId=currentNode._id;var currentNodeCon=_this.screen.opt.point[nodeId];var currentModal;var selectModalInte=$('.modalSelect').find('.modalSin:selected').attr('data-interval');var currentModalId=$('.modalSin:selected').attr('data-id');var isAccord=judgeModalInter(selectModalInte);if(!isAccord)return;var period=$('.timeSelsect').val();var isExistModal=false;for(var i=0;i<_this.nodeMode.length;i++){if(period.indexOf(_this.nodeMode[i].interval)!==-1&&currentModalId===_this.nodeMode[i]._id){isExistModal=true;_this.paramsRelate=_this.nodeMode[i].params;currentModal=_this.nodeMode[i];}}
if(!isExistModal){alert(I18n.resource.benchmark.energyForecast.CHANGE_MODEL);return;}
var startTimeCogVal=startTimes;var endTimeCogVal=endTimes;var startYear=parseInt(startTimeCogVal.split('-')[0]);var startMonth=parseInt(startTimeCogVal.split('-')[1]);var startDay=parseInt(startTimeCogVal.split(' ')[0].split('-')[2]);var endYear=parseInt(endTimeCogVal.split('-')[0]);var endMonth=parseInt(endTimeCogVal.split('-')[1]);var endDay=parseInt(endTimeCogVal.split(' ')[0].split('-')[2]);if(new Date(startTimeCogVal).valueOf()>new Date(endTimeCogVal).valueOf()){alert(I18n.resource.benchmark.energyForecast.TIME_WRONG);return;}
var modalPeriod;var rowLength,rowContent;var monthLength=0;var monthArr=[];var monthArrCount=[];var startTime,endTime,judgeStartTime;if(period==='d1'){modalPeriod='d';if(!isRepeat){startTime=new Date(new Date(startTimeCogVal+' 00:00:00').valueOf()-86400000).format('yyyy-MM-dd 00:00:00');endTime=endTimeCogVal+' 00:00:00';judgeStartTime=startTimeCogVal+' 00:00:00';}else{startTime=new Date(new Date(startTimeCogVal).valueOf()-86400000).format('yyyy-MM-dd 00:00:00');endTime=endTimeCogVal;judgeStartTime=startTimeCogVal;}
if(endYear-startYear>1){alert(I18n.resource.benchmark.energyForecast.INTERVAL_LOOG);return;}else{if(endYear-startYear===0){if(startMonth===endMonth){var intervalD=endDay-startDay+1;monthLength+=intervalD;for(var i=0;i<intervalD;i++){var startDayF=startDay+i>9?startDay+i:'0'+(startDay+i).toString();monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+startDayF);}}else{var StartMonthDCount=new Date(startYear,startMonth,0).getDate();var startMonthDay=StartMonthDCount-startDay+1;monthLength+=startMonthDay;for(var i=0;i<startMonthDay;i++){var startMDayF=startDay+i>9?startDay+i:'0'+(startDay+i).toString();monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+startMDayF);}
if(endMonth-startMonth>1){var intervalM=endMonth-startMonth;for(var i=1;i<intervalM;i++){var intervalMcount=new Date(startYear,startMonth+1,0).getDate();monthLength+=intervalMcount;for(var j=1;j<=intervalMcount;j++){monthArrCount.push(startYear+'-'+(startMonth+1>9?startMonth+1:'0'+(startMonth+1).toString())+'-'+(j>9?j:'0'+j.toString()));}}}
monthLength+=endDay;if(endDay===1){monthArrCount.push(startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+'01');}else{for(var i=1;i<endDay;i++){monthArrCount.push(startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(i>9?i:'0'+i.toString()));}}}}else{var StartMonthDCount=new Date(startYear,startMonth,0).getDate();var startMonthDay=StartMonthDCount-startDay+1;monthLength+=startMonthDay;for(var i=0;i<startMonthDay;i++){var startMDayF=startDay+i>9?startDay+i:'0'+(startDay+i).toString();monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+startMDayF);}
var startMonthArr=12-startMonth;for(var i=1;i<=startMonthArr;i++){var intervalMCountD=new Date(startYear,startMonth+1,0).getDate();monthLength+=intervalMcount;for(var j=1;j<=intervalMcount;j++){monthArrCount.push(startYear+'-'+(startMonth+1>9?startMonth+1:'0'+(startMonth+1).toString())+'-'+(j>9?j:'0'+j.toString()));}}
for(var i=1;i<endMonth;i++){var intervalEndMCountD=new Date(endYear,i,0).getDate();monthLength+=intervalEndMCountD;for(var j=1;j<=intervalEndMCountD;j++){monthArrCount.push(endYear+'-'+(i>9?i:'0'+i.toString())+(j>9?j:'0'+'-'+j.toString()));}}
monthLength+=endDay;if(endDay===1){monthArrCount.push(endYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+'01');}else{for(var i=1;i<endDay;i++){monthArrCount.push(endYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(i>9?i:'0'+i.toString()));}}}}}else if(period==='M1'){modalPeriod='M';if(!isRepeat){startTime=startYear+'-'+(startMonth-1>9?startMonth-1:'0'+(startMonth-1).toString())+'-01 00:00:00';endTime=endTimeCogVal+'-01 00:00:00';judgeStartTime=startTimeCogVal+'-01 00:00:00';}else{startTime=startYear+'-'+(startMonth-1>9?startMonth-1:'0'+(startMonth-1).toString())+'-01 00:00:00';endTime=endTimeCogVal;judgeStartTime=startTimeCogVal;}
if(startYear===endYear&&startMonth===endMonth||startYear>endYear){alert(I18n.resource.benchmark.energyForecast.TIME_REPEAT_SELECT);return;}
if(startYear!==endYear){var startMonthInter=12-startMonth;monthLength+=startMonthInter;for(var i=0;i<=startMonthInter;i++){monthArrCount.push(startYear+'-'+(startMonth+i<10?'0'+(startMonth+i):startMonth+i));}
if(endYear-startYear>1){for(var i=0;i<endYear-startYear-1;i++){monthLength+=12;var currentYear=startYear+1;for(var j=1;j<=12;j++){monthArrCount.push(currentYear+'-'+(j<10?'0'+j:j));}}}
monthLength+=endMonth;for(var i=1;i<=endMonth;i++){monthArrCount.push(endYear+'-'+(i<10?'0'+i:i));}}else{monthLength+=endMonth-startMonth;for(var i=0;i<=endMonth-startMonth;i++){monthArrCount.push(startYear+'-'+(startMonth+i<10?'0'+(startMonth+i):startMonth+i));}}}else{modalPeriod='h';if(!isRepeat){startTime=new Date(new Date(startTimeCogVal+':00').valueOf()-3600000).format('yyyy-MM-dd HH:mm:ss');endTime=endTimeCogVal+':00';judgeStartTime=startTimeCogVal+':00';}else{startTime=new Date(new Date(startTimeCogVal).valueOf()-3600000).format('yyyy-MM-dd HH:mm:ss');endTime=endTimeCogVal;judgeStartTime=startTimeCogVal;}
var startHour=parseInt(startTimeCogVal.split(' ')[1].split(':')[0]);startHour=startHour===0?24:startHour;var endHour=parseInt(endTimeCogVal.split(' ')[1].split(':')[0]);endHour=endHour===0?24:endHour;if(endYear!==startYear){alert(I18n.resource.benchmark.energyForecast.INTERVAL_LOOG);return;}else{if(startMonth===endMonth){if(startDay===endDay){startHour=startHour===24?0:startHour;var intervalHour=endHour-startHour;monthLength+=intervalHour+1;for(var i=0;i<=intervalHour;i++){var startHourF=startHour+i>9?startHour+i:'0'+(startHour+i).toString();if(startHourF===24){startHourF='00';monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+1>9?startDay+1:'0'+(startDay+1).toString())+' '+startHourF+':00:00');}else{monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay>9?startDay:'0'+startDay.toString())+' '+startHourF+':00:00');}}}else{startHour=startHour===24?0:startHour;var startDayHour=24-startHour+1;monthLength+=startDayHour;for(var i=0;i<startDayHour;i++){var startDayHourF=startHour+i>9?startHour+i:'0'+(startHour+i).toString();if(startDayHourF===24){startDayHourF='00';monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+1>9?startDay+1:'0'+(startDay+1).toString())+' '+startDayHourF+':00:00');}else{monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay>9?startDay:'0'+startDay.toString())+' '+startDayHourF+':00:00');}}
if(endDay-startDay>1){var intervalDays=endDay-startDay;for(var i=1;i<intervalDays;i++){monthLength+=24;for(var j=1;j<=24;j++){var endHourCur=j>9?j:'0'+j.toString();if(endHourCur===24){endHourCur='00';monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+2>9?startDay+2:'0'+(startDay+2).toString())+' '+endHourCur+':00:00');}else{monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+1>9?startDay+1:'0'+(startDay+1).toString())+' '+endHourCur+':00:00');}}}}
monthLength+=endHour;if(endHour===1){monthArrCount.push(startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+'01:00:00');}else{for(var i=1;i<=endHour;i++){var endHourCue=i>9?i:'0'+i.toString();if(endHourCue===24){endHourCue='00';monthArrCount.push(startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(endDay+1>9?endDay+1:'0'+(endDay+1).toString())+' '+endHourCue+':00:00');}else{monthArrCount.push(startYear+'-'+(endMonth>9?endMonth:'0'+endMonth.toString())+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+endHourCue+':00:00');}}}}}else{startHour=startHour===24?0:startHour;var startDayHour=24-startHour+1;monthLength+=startDayHour;for(var i=0;i<startDayHour;i++){var startDayHourF=startHour+i>9?startHour+i:'0'+(startHour+i).toString();if(startDayHourF===24){startDayHourF='00';monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay+1>9?startDay+1:'0'+(startDay+1).toString())+' '+startDayHourF+':00:00');}else{monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+(startDay>9?startDay:'0'+startDay.toString())+' '+startDayHourF+':00:00');}}
var startMonthDCount=new Date(startYear,startMonth,0).getDate();var intervalDay=startMonthDCount-startDay;for(var i=1;i<=intervalDay;i++){var pushStartDay=startDay+i>9?startDay+i:'0'+(startDay+i).toString();var pushStartDay1=startDay+i+1>9?startDay+i+1:'0'+(startDay+i+1).toString();for(var j=1;j<=24;j++){monthLength+=24;var pushDayHourCound=m>9?m:'0'+m.toString();if(pushDayHourCound===24){pushDayHourCound='00';monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+pushStartDay1+' '+pushDayHourCound+':00:00');}else{monthArrCount.push(startYear+'-'+(startMonth>9?startMonth:'0'+startMonth.toString())+'-'+pushStartDay+' '+pushDayHourCound+':00:00');}}}
var startMonthArr=endMonth-startMonth;if(endMonth-startMonth>1){var monthHourArr=endMonth-startMonth;for(var i=1;i<monthHourArr;i++){var currentMonths=startMonth+i>9?startMonth+i:'0'+(startMonth+i).toString();var currentMonthDays=new Date(startYear,currentMonths,0).getDate();for(var j=1;j<=currentMonthDays;j++){var currentMonthDay=j>9?j:'0'+j.toString();var currentMonthDay1=j+1>9?j+1:'0'+(j+1).toString();for(var k=1;k<=24;k++){monthLength+=24;var currentMonthDayHour=k>9?k:'0'+k.toString();if(currentMonthDayHour===24){currentMonthDayHour='00';monthArrCount.push(startYear+'-'+currentMonths+'-'+currentMonthDay1+' '+currentMonthDayHour+':00:00');}else{monthArrCount.push(startYear+'-'+currentMonths+'-'+currentMonthDay+' '+currentMonthDayHour+':00:00');}}}}}
var endMonthGe=endMonth>9?endMonth:'0'+endMonth.toString();for(var i=1;i<endDay;i++){var currendEndDay=i>9?i:'0'+i.toString();var currendEndDay1=i+1>9?i+1:'0'+(i+1).toString();for(var j=1;j<=24;j++){monthLength+=24;var currentEndDayHours=j>9?j:'0'+j.toString();if(currentEndDayHours===24){currentEndDayHours='00';monthArrCount.push(startYear+'-'+endMonthGe+'-'+currendEndDay1+' '+currentEndDayHours+':00:00');}else{monthArrCount.push(startYear+'-'+endMonthGe+'-'+currendEndDay+' '+currentEndDayHours+':00:00');}}}
monthLength+=endHour;if(endHour===1){monthArrCount.push(startYear+'-'+endMonthGe+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+'01:00:00');}else{for(var i=1;i<endHour;i++){monthArrCount.push(startYear+'-'+endMonthGe+'-'+(endDay>9?endDay:'0'+endDay.toString())+' '+(i>9?i:'0'+i.toString())+':00:00');}}}}}
if(new Date(startTime).valueOf()>new Date().valueOf()){startTime=parseInt(judgeStartTime.split('-')[0])-1+'-'+judgeStartTime.split('-')[1]+'-'+judgeStartTime.split('-')[2];endTime=parseInt(endTime.split('-')[0])-1+'-'+endTime.split('-')[1]+'-'+endTime.split('-')[2];}
var energyId=currentNodeCon?currentNodeCon.energy:'';var postData={dsItemIds:[energyId],timeEnd:endTime,timeFormat:period,timeStart:startTime};WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(result){if(new Date(judgeStartTime).valueOf()>new Date().valueOf()){if(result.timeShaft.length===0){monthArr=monthArrCount;}else{var mothArrRep=[];var resultList=result.list[0];for(var i=0;i<result.timeShaft.length;i++){mothArrRep.push(parseInt(result.timeShaft[i].split('-')[0])+1+'-'+result.timeShaft[i].split('-')[1]+'-'+result.timeShaft[i].split('-')[2]);if(period=='d1'){monthArr.push(mothArrRep[i].split(' ')[0]);}else if(period=='M1'){rmonthArr.push(mothArrRep[i].split('-')[0]+'-'+mothArrRep[i].split('-')[1]);}else{monthArr.push(mothArrRep[i].split(':')[0]+':'+mothArrRep[i].split('-')[1]);}}
if(isRepeat){monthArr=monthArrCount;}}}else{var resultList=result.list[0];if(resultList.data.length!==0){resultList.timeShift=[];for(var i=1;i<resultList.data.length;i++){resultList.data[i-1]=(resultList.data[i]-resultList.data[i-1]).toFixed(2);if(period=='d1'){resultList.timeShift.push(result.timeShaft[i].split(' ')[0]);}else if(period=='M1'){resultList.timeShift.push(result.timeShaft[i].split('-')[0]+'-'+result.timeShaft[i].split('-')[1]);}else{resultList.timeShift.push(result.timeShaft[i].split(':')[0]+':'+result.timeShaft[i].split('-')[1]);}}
resultList.data=resultList.data.slice(0,resultList.data.length-1);_this.historyData=[resultList];monthArr=resultList.timeShift;if(isRepeat){monthArr=monthArrCount;}}else{monthArr=monthArrCount;}}
_this.mathListData=monthArr;if(!isRepeat){var params=currentModal.params;var cellLength=0;var cellOther='';var timeListBox='<div class="tableHeadBox clearfix"><div class="tabalCellH" i18n="benchmark.energyForecast.TIME">时间</div>';for(var i=0;i<params.length;i++){cellOther+='<div class="tabalCellH" data-x="'+params[i].pName+'">'+(params[i].name.trim()!==''?params[i].name:params[i].pName)+'</div>';cellLength+=1;}
$('#paramsListBox').append(timeListBox+cellOther+'</div>');I18n.fillArea($('#paramsListBox'));for(var i=0;i<monthArr.length;i++){var timeListBox1;var cellOther1='';timeListBox1='<div class="tableContentBox clearfix"><div class="tabalCellT">'+monthArr[i]+'</div>';for(var m=0;m<params.length;m++){cellOther1+='<div class="tabalCell" data-param="'+params[m].pName+'" data-id="'+params[m].point+'"><input type="text" class="paramsEnter"/><lable class="paramsShow"></lable></div>';}
$('#paramsListBox').append(timeListBox1+cellOther1+'</div>');}
$('.tabalCellH').width(100/(cellLength+1)-2+'%');$('.tabalCellT').width(100/(cellLength+1)-2+'%');$('.tabalCell').width(100/(cellLength+1)-2+'%');$('#configForestModal').modal('show');$('#modalConfigStartTime').val(startTimeCogVal);$('#modalConfigEndTime').val(endTimeCogVal);_this.attEvents();}});};$('#forestConfig').off('click').click(function(){var currentNode=_this.screen.iotFilter.tree.getSelectedNodes()[0];var nodeId=currentNode._id;var currentNodeCon=_this.screen.opt.point[nodeId];var currentModal;if(_this.nodeMode.length===0){alert(I18n.resource.benchmark.energyForecast.NO_MODEL_CREAT);return;}
var selectModalInte=$('.modalSelect').find('.modalSin:selected').attr('data-interval');var currentModalId=$('.modalSin:selected').attr('data-id');var isAccord=judgeModalInter(selectModalInte);if(!isAccord)return;var period=$('.timeSelsect').val();var isExistModal=false;for(var i=0;i<_this.nodeMode.length;i++){if(period.indexOf(_this.nodeMode[i].interval)!==-1&&currentModalId===_this.nodeMode[i]._id){isExistModal=true;_this.paramsRelate=_this.nodeMode[i].params;currentModal=_this.nodeMode[i];}}
if(!isExistModal){alert(I18n.resource.benchmark.energyForecast.CHANGE_MODEL);return;}
var startTimeCogVal=timeFormat($('#startTimeCog').val(),'yyyy-mm-dd hh:ii');var endTimeCogVal=timeFormat($('#endTimeCog').val(),'yyyy-mm-dd hh:ii');if(currentModal){if($('#configForestModal').length!==0){$('#configForestModal').remove();}
if($('#configForestModal').length===0){var configForestModal='<div class="modal fade" id="configForestModal">\
                                <div class="modal-dialog">\
                                <div class="modal-content">\
                                  <div class="modal-header">\
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                                    <h4 class="modal-title" i18n="benchmark.energyForecast.PARAMS_CONFIG">参数配置</h4>\
                                  </div>\
                                  <div class="modal-body">\
                                    <div class="configTopTime clearfix">\
                                    <div class="importData btn btn-primary" i18n="benchmark.energyForecast.IMPORT_DATA">导入数据</div>\
                                    <div class="timeBox">\
                                        <span i18n="benchmark.energyForecast.FROM">从</span><input  type="text" class="form-control" id="modalConfigStartTime">\
                                        <span i18n="benchmark.energyForecast.TO">到</span><input  type="text" class="form-control" id="modalConfigEndTime">\
                                    </div><input type="file" id="importDataIpt" style="display:none"/></div>\
                                    <div class="configContent"><div id="paramsListBox"></div></div>\
                                  </div>\
                                  <div class="modal-footer">\
                                    <button type="button" class="btn btn-default" data-dismiss="modal" i18n="benchmark.energyForecast.CANCEL">取消</button>\
                                    <button type="button" class="btn btn-primary" id="savaParams" i18n="benchmark.energyForecast.OK">确定</button>\
                                  </div>\
                                </div>\
                              </div>\
                            </div>';$('.panelBmModule').append(configForestModal);I18n.fillArea($('.panelBmModule'));historyForest(startTimeCogVal,endTimeCogVal);}}else{alert(I18n.resource.benchmark.energyForecast.NO_MODEL);}});$('.tabalCell').off('click').click(function(){var $this=$(this);$this.find('lable.paramsShow').hide();$this.find('.paramsEnter').html('').show().focus();});$('.paramsEnter').blur(function(){var $this=$(this);var paramsValue=$this.val();$this.siblings('lable.paramsShow').html(paramsValue).show();$this.hide();});$('.importData').off('click').click(function(){$('#importDataIpt').click();});$('#importDataIpt').change(function(e){var currentModalId=$('.modalSin:selected').attr('data-id');var currentModal;var period=$('.timeSelsect').val();var modalPeriod;if(period==='d1'){modalPeriod='d';}else if(period==='M1'){modalPeriod='M';}else{modalPeriod='h';}
for(var m=0;m<_this.nodeMode.length;m++){if(modalPeriod===_this.nodeMode[m].interval&&currentModalId===_this.nodeMode[m]._id){currentModal=_this.nodeMode[m];continue;}}
var currentMParams=currentModal.params;var files=e.target.files;if(!files||files.length<1)return;if(!/(xls|xlsx|csv)$/i.test(files[0].name)){alert(I18n.resource.benchmark.energyForecast.SELECT_EXCEL);}else{var formData=new FormData();formData.append('file',files[0]);$.ajax({url:'/benchmark/importHistoryData',type:'post',data:formData,cache:false,contentType:false,processData:false,success:function success(result){if(!result.data||result.time.length===0){alert(I18n.resource.benchmark.energyOverView.NO_DATA);}else{_this.importSuccess=true;var resultData=result.data;$('#modalConfigStartTime').val(result.time[0]);$('#modalConfigEndTime').val(result.time[result.time.length-1]);var cellOther='';var timeListBox='<div class="tableHeadBox clearfix"><div class="tabalCellH" i18n="benchmark.energyForecast.TIME">时间</div>';for(var item in resultData){var dataX;for(var i=0;i<currentMParams.length;i++){if(item===currentMParams[i].name){dataX=currentMParams[i].pName;}}
cellOther+='<div class="tabalCellH" data-x="'+dataX+'">'+item+'</div>';}
$('#paramsListBox').html('').append(timeListBox+cellOther+'</div>');I18n.fillArea($('#paramsListBox'));var itemCount=0;for(var item in resultData){var xDataList=resultData[item];var dataX;for(var i=0;i<currentMParams.length;i++){if(item===currentMParams[i].name){dataX=currentMParams[i].pName;}}
if(xDataList.length!==0){for(var i=0;i<xDataList.length;i++){if(itemCount===0){var timeListBox1='<div class="tableContentBox clearfix"><div class="tabalCellT">'+result.time[i]+'</div>';var cellOther1='<div class="tabalCell" data-param="'+dataX+'"><input type="text" class="paramsEnter"/><lable class="paramsShow">'+xDataList[i]+'</lable></div>';$('#paramsListBox').append(timeListBox1+cellOther1+'</div>');}else{var cellOther2='<div class="tabalCell" data-param="'+dataX+'"><input type="text" class="paramsEnter"/><lable class="paramsShow">'+xDataList[i]+'</lable></div>';$('#paramsListBox').find('.tableContentBox').eq(i).append(cellOther2);}}}
itemCount+=1;}
var cellLength=$('.tableHeadBox').find('.tabalCellH').length;$('.tabalCellH').width(100/cellLength-2+'%');$('.tabalCellT').width(100/cellLength-2+'%');$('.tabalCell').width(100/cellLength-2+'%');_this.attEvents();}}});}});$('#savaParams').off('click').click(function(){var period=$('.timeSelsect').val();var startTimeCogVal=$('#modalConfigStartTime').val();var endTimeCogVal=$('#modalConfigEndTime').val();var startTimeCogValPer=$('#startTimeCog').val();var endTimeCogValPer=$('#endTimeCog').val();var currentModalId=$('.modalSin:selected').attr('data-id');var modalPeriod;var startTime,endTime;var isRepeat=false;if(period==='d1'){modalPeriod='d';if(_this.importSuccess){startTime=startTimeCogVal;endTime=endTimeCogVal;startTimeCogValPer=timeFormat(startTimeCogValPer,'yyyy-mm-dd 00:00:00');endTimeCogValPer=timeFormat(endTimeCogValPer,'yyyy-mm-dd 00:00:00');}else{startTime=startTimeCogVal+' 00:00:00';endTime=endTimeCogVal+' 00:00:00';}}else if(period==='M1'){modalPeriod='M';if(_this.importSuccess){startTime=startTimeCogVal;endTime=endTimeCogVal;startTimeCogValPer=timeFormat(startTimeCogValPer,'yyyy-mm-01 00:00:00');endTimeCogValPer=timeFormat(endTimeCogValPer,'yyyy-mm-01 00:00:00');}else{startTime=startTimeCogVal+'-01 00:00:00';endTime=endTimeCogVal+'-01 00:00:00';}}else{modalPeriod='h';if(_this.importSuccess){startTime=startTimeCogVal;endTime=endTimeCogVal;startTimeCogValPer=timeFormat(startTimeCogValPer,'yyyy-mm-dd hh:00:00');endTimeCogValPer=timeFormat(endTimeCogValPer,'yyyy-mm-dd hh:00:00');;}else{startTime=startTimeCogVal+':00';endTime=endTimeCogVal+':00';}}
if(new Date(startTimeCogValPer).valueOf()!==new Date(startTime).valueOf()||new Date(endTimeCogValPer).valueOf()!==new Date(endTime).valueOf()){historyForest(startTime,endTime,true);}
var currentModal;for(var m=0;m<_this.nodeMode.length;m++){if(modalPeriod===_this.nodeMode[m].interval&&currentModalId===_this.nodeMode[m]._id){currentModal=_this.nodeMode[m];continue;}}
var currentParams=currentModal.params;var tableCell=$('#configForestModal').find('.tabalCell');var xNum=$('#configForestModal').find('.tableHeadBox').find('div').length-1;var xGene={};for(var j=0;j<currentParams.length;j++){xGene[currentParams[j].pName]=[];}
for(var i=0;i<tableCell.length;i++){var $current=tableCell.eq(i);var currentVal=$current.find('.paramsShow').html().trim();if(currentVal===''){alert(I18n.resource.benchmark.energyForecast.INTER_COMPLETE);return;}else{if(!Number(currentVal)){alert(I18n.resource.benchmark.energyForecast.INTER_NUBMER);return;}}}
for(var i=0;i<tableCell.length;i++){var $current=tableCell.eq(i);var currentVal=parseInt($current.find('.paramsShow').html().trim());var xSin=$current.attr('data-param');if(!xGene[xSin]){alert(I18n.resource.benchmark.energyForecast.EXCEL_WRONG);return;}
xGene[xSin].push(currentVal);}
var postData={'modeltype':currentModal.type,'model':currentModal.model,'x':xGene};var resultFinally=[];var result={};result['timeShift']=_this.mathListData;WebAPI.post('/analysis/model/exec',postData).done(function(data){var resultData=[];var dataStr=data.split('[')[1];if(dataStr){var dataString=data.split('[')[1].split(']')[0].split(',');}else{alert(I18n.resource.benchmark.energyForecast.DATA_BACK_FAIL);return;}
for(var i=0;i<dataString.length;i++){resultData.push(parseInt(dataString[i]));}
result['timeShift']=_this.mathListData;result['data']=resultData;if(new Date(startTime).valueOf()<=new Date().valueOf()){if(_this.historyData.length!==0){if(_this.historyData[0].data.length!==0){if(_this.mathListData.length!==_this.historyData[0].timeShift.length&&resultData.length!==0){_this.historyData[0].timeShift=_this.mathListData;}
resultFinally.push(_this.historyData[0]);}}}
resultFinally.push(result);}).always(function(){_this.echartsInit(resultFinally);$('#configForestModal').modal('hide');_this.importSuccess=false;});});};BenchmarkEnergyForecast.prototype.echartsInit=function echartsInit(result){if(result.length===0)return;var option={tooltip:{trigger:'axis'},axisLabel:{formatter:function formatter(value){if(value>=1000||value<=-1000){return value/1000+'k';}else{return value;}}},grid:{left:'3%',right:'4%',bottom:'3%',containLabel:true},xAxis:[{type:'category',boundaryGap:false,data:result[0].timeShift}],yAxis:{type:'value',axisLine:{onZero:false},boundaryGap:false},series:[{name:'预测值',type:'line',smooth:true,data:result[0].data}]};if(result.length>1){option.series[0].name='历史值';for(var i=1;i<result.length;i++){option.series.push({name:'预测值',type:'line',smooth:true,data:result[i].data});}}
var dom=this.$bechForecast.find('.forecastEchartsBox')[0];var chart=echarts.init(dom,AppConfig.chartTheme);chart.setOption(option);};BenchmarkEnergyForecast.prototype.onNodeClick=function onNodeClick(e,node){var _this=this;console.log(_this.screen);_this.init();};BenchmarkEnergyForecast.prototype.destroy=function destroy(){this.ctn=null;this.screen=null;this.opt=null;this.$bechForecast=null;this.paramsRelate=null;this.nodeMode=null;this.historyData=null;this.mathListData=null;this.importSuccess=null;};return BenchmarkEnergyForecast;}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}
var BenchmarkEnergyBenchmarking=function(){function BenchmarkEnergyBenchmarking(ctn,screen,opt){_classCallCheck(this,BenchmarkEnergyBenchmarking);this.ctn=ctn;this.screen=screen;this.opt=opt;this.$bechingBox=undefined;this.projectIdArr=[];this.pointToName={};this.pointToProjId={};this.resultDataEcharts={};this.hideOrShowData=undefined;this.dataGetDetail=undefined;}
BenchmarkEnergyBenchmarking.prototype.show=function show(){var _this=this;var projectId=AppConfig.projectId;WebAPI.get('/static/views/observer/benchmark/benchmarkEnergyBenchmarking.html').done(function(resultHtml){$('.panelBmModule').html('').append(resultHtml);_this.$bechingBox=$('#bechingBox');I18n.fillArea(_this.$bechingBox);var timeFormatStr=timeFormatChange('yyyy-mm-dd');var start=new Date(new Date().valueOf()-86400000),end=new Date();$('#startTimeCog').datetimepicker({format:timeFormatStr,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:end,initialDate:start,minView:2}).val(start.timeFormat(timeFormatStr));$('#endTimeCog').datetimepicker({format:timeFormatStr,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:end,initialDate:end,minView:2}).val(end.timeFormat(timeFormatStr));_this.init();if(AppConfig.projectId){_this.$bechingBox.find('.areaSingleBox[data_projId="'+AppConfig.projectId+'"]').trigger('click');}
_this.attEvents();});};BenchmarkEnergyBenchmarking.prototype.init=function init(){var _this=this;var resultData=[];var projectIdArr=[];var projectList=AppConfig.projectList;for(var i=0,len=projectList.length;i<len;i++){var item=projectList[i];projectIdArr.push(item.id);}
var parentNode=this.screen.iotFilter.tree.getNodes()[0];var currentNode=this.screen.iotFilter.tree.getSelectedNodes()[0];var postDataG;var currenType=currentNode.baseType;if(currenType==='projects'){currenType='Project';}else if(currenType==='groups'){currenType='Group';}else{currenType='Thing';}
postDataG={arrProjId:projectIdArr,nodeName:currentNode.name,type:currenType};function isEmptyObject(obj){for(var key in obj){return false;};return true;};WebAPI.post('/benchmark/config/getDetails',postDataG).done(function(data){var isEmpty=isEmptyObject(data);if(!isEmpty){for(var item in data){var language=localStorage["language"]?localStorage["language"]:AppConfig.language;var nameLan;var resultDataObj={};resultDataObj.projId=data[item].projId;resultDataObj.id=data[item]._id;if(language==='zh'){nameLan=data[item].name;}else{var projectListAll=AppConfig.projectList;for(var i=0;i<projectListAll.length;i++){var projItem=projectListAll[i];if(data[item].projId===projItem.id){nameLan=projItem.name_english;}}}
resultDataObj.name=nameLan;resultDataObj.pointEnergy=data[item].energy;resultData.push(resultDataObj);_this.pointToName[data[item].energy]=nameLan;_this.pointToProjId[data[item].energy]=data[item].projId;}
_this.dataGetDetail=resultData;_this.echartsData();}else{alert(I18n.resource.benchmark.energyOverView.NO_DATA);_this.projectListShow();}});};BenchmarkEnergyBenchmarking.prototype.attEvents=function attEvents(){var _this=this;this.$bechingBox.find('.areaSingleBox').off('click').click(function(){var $this=$(this);var projId=$(this).attr('data_projId');if(!$this.hasClass('attSelected')){$this.addClass('attSelected');}
$this.siblings('.areaSingleBox').removeClass('attSelected');_this.screen.initIotFilter(parseInt(projId));});this.$bechingBox.find('.timeSelsect').off('change').change(function(){var $this=$(this);var $inputTime=_this.$bechingBox.find('.input-group').find('input.form-control');var timeFormatStr,minView,startView,start,end;var $startTimeCog=$('#startTimeCog'),$endTimeCog=$('#endTimeCog');if($this.val()==='M1'){timeFormatStr=timeFormatChange('yyyy-mm');minView=3;startView=3;}else if($this.val()==='M12'){timeFormatStr=timeFormatChange('yyyy-mm-dd');minView=4;startView=4;}else{timeFormatStr=timeFormatChange('yyyy-mm-dd');minView=2;startView=2;}
start=new Date(new Date().valueOf()-86400000);end=new Date();$startTimeCog.datetimepicker('remove').datetimepicker({format:timeFormatStr,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:end,minView:minView,startView:startView,initialDate:start}).val(start.timeFormat(timeFormatStr));$endTimeCog.datetimepicker('remove').datetimepicker({format:timeFormatStr,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:end,minView:minView,startView:startView,initialDate:end}).val(end.timeFormat(timeFormatStr));});$('#refreshEcharts').off('click').click(function(){var startTime=timeFormat($('#startTimeCog').val(),'yyyy-mm-dd 00:00:00');var endTime=timeFormat($('#endTimeCog').val(),'yyyy-mm-dd 00:00:00');var timeShaft=$('.timeSelsect').val();if(new Date(startTime).valueOf()>new Date(endTime).valueOf()){alert(I18n.resource.benchmark.energyBenchmarking.STARTTIME_LT_ENDTIME);return;}
if(timeShaft=='M1'){if(parseInt(startTime.split('-')[1])===parseInt(endTime.split('-')[1])){alert(I18n.resource.benchmark.energyForecast.TIME_REPEAT_SELECT);return;}}
_this.echartsData();});this.$bechingBox.find('.showOrHide').off('click').click(function(e){e.stopPropagation();var $this=$(this);var currentData={nameList:[],dataList:[],projIdList:[]};var currentProjId=parseInt($this.parents('.areaSingleBox').attr('data_projid'));if(!$this.hasClass('hideProj')){$this.addClass('hideProj');$this.find('span').removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');for(var i=0;i<_this.hideOrShowData.projIdList.length;i++){if(_this.hideOrShowData.projIdList[i]!==currentProjId){currentData.projIdList.push(_this.hideOrShowData.projIdList[i]);currentData.nameList.push(_this.hideOrShowData.nameList[i]);currentData.dataList.push(_this.hideOrShowData.dataList[i]);}}
_this.hideOrShowData=currentData;}else{var hideOrShowDataArr=[];$this.removeClass('hideProj');$this.find('span').removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');for(var i=0;i<_this.resultDataEcharts.projIdList.length;i++){if(_this.resultDataEcharts.projIdList[i]===currentProjId){_this.hideOrShowData.projIdList.push(_this.resultDataEcharts.projIdList[i]);_this.hideOrShowData.nameList.push(_this.resultDataEcharts.nameList[i]);_this.hideOrShowData.dataList.push(_this.resultDataEcharts.dataList[i]);}}
for(var i=0;i<_this.hideOrShowData.dataList.length;i++){var objSin={};hideOrShowDataArr.push(objSin);}
for(var item in _this.hideOrShowData){var itemArr=_this.hideOrShowData[item];for(var j=0;j<itemArr.length;j++){if(item==='nameList'){hideOrShowDataArr[j].name=itemArr[j];}else if(item==='projIdList'){hideOrShowDataArr[j].projId=itemArr[j];}else{hideOrShowDataArr[j].data=itemArr[j];}}}
hideOrShowDataArr=_this.sortArrBigToSmall(hideOrShowDataArr);var resultNameList=[];var resultdataList=[];var resultToProjId=[];for(var j=0;j<hideOrShowDataArr.length;j++){resultNameList.push(hideOrShowDataArr[j].name);resultdataList.push(hideOrShowDataArr[j].data);resultToProjId.push(hideOrShowDataArr[j].projId);}
_this.hideOrShowData.nameList=resultNameList;_this.hideOrShowData.dataList=resultdataList;_this.hideOrShowData.projIdList=resultToProjId;}
_this.echartsShow();});};BenchmarkEnergyBenchmarking.prototype.projectListShow=function projectListShow(){var _this=this;var projectList=AppConfig.projectList;_this.$bechingBox.find('.diffAreaList').html('');for(var i=0,len=projectList.length;i<len;i++){var item=projectList[i],flag=true;if(!_this.dataGetDetail){return;}
for(var j=0;j<_this.dataGetDetail.length;j++){if(_this.dataGetDetail[j].projId==item.id){flag=false;break;}}
if(flag)continue;this.projectIdArr.push(item.id);var language=localStorage["language"]?localStorage["language"]:AppConfig.language;var nameLan=language==='zh'?item.name_cn:item.name_english;var projSingle='<div class="areaSingleBox" data_projId="'+item.id+'" title="'+nameLan+'">'+'<span  class="projNameCn">'+nameLan+'</span>'+'<b class="showOrHide"><span class="glyphicon glyphicon-eye-open"></span></b></div>';_this.$bechingBox.find('.diffAreaList').append(projSingle);}
_this.attEvents();};BenchmarkEnergyBenchmarking.prototype.echartsData=function echartsData(){var resultData=this.dataGetDetail;var _this=this;var dsItemIds=[];var timeFormat=_this.$bechingBox.find('.timeSelsect').val();for(var i=0,len=resultData.length;i<len;i++){dsItemIds.push(resultData[i].pointEnergy);}
if(dsItemIds.length===0){return;}
Spinner.spin($('#bechingBox')[0]);var postData={dsItemIds:dsItemIds,timeEnd:timeFormat($('#endTimeCog').val(),'yyyy-mm-dd 00:00:00'),timeFormat:timeFormat,timeStart:timeFormat($('#startTimeCog').val(),'yyyy-mm-dd 00:00:00')};WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(data){if(!data.list){alert(I18n.resource.benchmark.energyOverView.NO_DATA);return;}
var dataList=data.list.length>0?data.list:[];var echartsDataRe=[];_this.resultDataEcharts={};var resultNameList=[];var resultdataList=[];var resultToProjId=[];if(dataList.length>0){for(var i=0;i<dataList.length;i++){var echartsDataRep={};var item=dataList[i];var itemDataLast=item.data[item.data.length-1]?item.data[item.data.length-1]:0;var itemDataStart=item.data[0]?item.data[0]:0;echartsDataRep.name=_this.pointToName[item.dsItemId];echartsDataRep.point=item.dsItemId;echartsDataRep.data=(itemDataLast-itemDataStart).toFixed(2);if(itemDataLast-itemDataStart<0){echartsDataRep.data=0;}
echartsDataRep.projId=_this.pointToProjId[item.dsItemId];echartsDataRe.push(echartsDataRep);}
echartsDataRe=_this.sortArrBigToSmall(echartsDataRe);for(var j=0;j<echartsDataRe.length;j++){resultNameList.push(echartsDataRe[j].name);resultdataList.push(echartsDataRe[j].data);resultToProjId.push(echartsDataRe[j].projId);}
_this.resultDataEcharts.nameList=resultNameList;_this.resultDataEcharts.dataList=resultdataList;_this.resultDataEcharts.projIdList=resultToProjId;_this.hideOrShowData=_this.resultDataEcharts;_this.echartsShow();_this.projectListShow();}}).always(function(){Spinner.stop();});};BenchmarkEnergyBenchmarking.prototype.sortArrBigToSmall=function sortArrBigToSmall(data){data.sort(function(a,b){if(a.data!=undefined){return b.data-a.data;}else{return b.dataList.data-a.dataList.data;}});return data;};BenchmarkEnergyBenchmarking.prototype.echartsShow=function echartsShow(){var resultData=this.hideOrShowData;var _this=this;var option={tooltip:{trigger:'axis'},axisLabel:{formatter:function formatter(value){if(value>=1000||value<=-1000){return value/1000+'k';}else{return value;}}},calculable:false,dataZoom:{show:false},xAxis:[{type:'category',splitLine:{show:false},data:resultData.nameList}],yAxis:[{type:'value',splitArea:{show:false}}],series:[{type:'bar',data:resultData.dataList}]};var chart=echarts.init(_this.$bechingBox.find('.echartsListBox')[0],AppConfig.chartTheme);chart.setOption(option);};BenchmarkEnergyBenchmarking.prototype.onNodeClick=function onNodeClick(node){this.init();};BenchmarkEnergyBenchmarking.prototype.destroy=function destroy(){this.ctn=null;this.screen=null;this.opt=null;this.$bechingBox=null;this.projectIdArr=null;this.pointToName=null;this.pointToProjId=null;this.resultDataEcharts=null;this.hideOrShowData=null;this.dataGetDetail=null;};return BenchmarkEnergyBenchmarking;}();var EnergyScreen=function(){function EnergyScreen(id,store,shareSaveChange,dsInfoList,isForMobile){if(!id){this.id=ScreenCurrent.id;}else{this.id=id;}
this.factoryIoC=undefined;this.factoryIoCAnalysis=undefined;this.listEntity=undefined;this.mapRefresh={};this.popRefresh={};this.arrEntityOrder=undefined;this.requestPoints=[];this.dictPopToEntity={};this.store=store?store:undefined;this.container=undefined;this.dsInfolist=dsInfoList;if(store){this.sharedesc=store.desc;}else if(shareSaveChange){this.sharedesc=shareSaveChange.desc;}
this.isForReport=store?true:false;this.shareLogId=shareSaveChange?shareSaveChange.shareLogId:false;if(this.shareLogId){this.isForReport=true;}
this.isForBencMark=undefined;this.modalConfigPane=undefined;this.isConfigMode=false;this.workerUpdate=undefined;this.paneDatasource=undefined;this.arrColor=echarts.config.color;this.isScreenChange=undefined;this.isPlayback=false;this.$obCanvasContainer=undefined;this.canvas=undefined;this.toolContainer=undefined;this.isForMobile=isForMobile;this.options={isForMobile:isForMobile};}
EnergyScreen.prototype={show:function show(){var _this=this;ElScreenContainer.innerHTML='';WebAPI.get("/static/views/observer/energyScreen.html").done(function(resultHtml){var divMain=document.createElement('div');divMain.className='indexContent st-pusher';divMain.innerHTML=resultHtml;var stCt=$('<div id="st-container" class="st-container">')[0];stCt.appendChild(divMain);ElScreenContainer.appendChild(stCt);_this.container=document.getElementById('paneCenter');_this.$obCanvasContainer=$(_this.container);_this.modalConfigPane=new modalConfigurePane(document.getElementById('energyModal'),_this,'dashboard');_this.modalConfigPane.show();_this.init();});},close:function close(){if(this.isConfigMode){if(this.isScreenChange){var _this=this;confirm('There are some changes haven\'t been saved, do you want to save them before quit? ',function(){_this.saveLayout();});}}
for(var key in this.listEntity){this.listEntity[key].close();}
if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;this.factoryIoC=null;this.factoryIoCAnalysis=null;this.listEntity=null;this.arrEntityOrder=null;this.store=null;this.container=null;this.dictPopToEntity=null;this.UNIT_WIDTH=null;this.UNIT_HEIGHT=null;AppConfig.datasource=null;this.paneDatasource&&this.paneDatasource.close&&this.paneDatasource.close();this.$obCanvasContainer=null;this.canvas=null;this.arrColor=null;this.dsInfolist=null;this.mapRefresh=null;this.modalConfigPane=null;this.popRefresh=null;this.requestPoints=null;this.toolContainer=null;this.isForReport=null;this.isPlayback=null;this.shareLogId=null;if(!this.isForBencMark){if(ToolCurrent)ToolCurrent.close();ToolCurrent=null;$('#ulTools').html('');$('.toolBacktrace').remove();$('#btnConfigDashboard').remove();}
this.isForBencMark=null;},stop:function stop(){if(this.workerUpdate)this.workerUpdate.terminate();},onresize:function onresize(){var entity;for(var key in ScreenCurrent.listEntity){entity=ScreenCurrent.listEntity[key];if(entity.chart)entity.chart.resize();if(entity.entityAnalysis&&entity.entityAnalysis.chart)entity.entityAnalysis.chart.resize();}},init:function init(){var _this=this;Spinner.spin(ElScreenContainer);if(this.store){initByData();Spinner.stop();}else{WebAPI.get("/spring/get/"+this.id).done(function(result){_this.store=result;initByData();}).always(function(e){Spinner.stop();});}
function initByData(){_this.paneDatasource=new DataSource(_this);AppConfig.datasource=_this.paneDatasource;_this.initIoc();_this.initLayout();_this.initToolBar();_this.initWorkerForUpdating();_this.initScreen();if(_this.isForBencMark!==true){_this.initReplay();}}
$('#btnModalAdd').off('click').click(function(e){var entity=new ModalNone(_this,{id:(+new Date()).toString(),spanC:6,spanR:2,modal:{type:"ModalNone"}});_this.arrEntityOrder.push(entity.entity.id);_this.listEntity[entity.entity.id]=entity;entity.render();entity.configure();});},initToolBar:function initToolBar(){var _this=this;var ulTools;if(AppConfig.isMobile)return;if(this.isForBencMark)return;ulTools=$('#ulTools');ulTools.html('');if(this.isForReport){var btnMode=$('<span>').addClass('badge grow toolbar-btn-selected').text('ok').css('cursor','pointer').css('background-color','#5bc0de').click(function(e){_this.saveLayout();_this.isConfigMode=false;});_this.isConfigMode=true;$('.springLinkBtn').hide();$('.sideTrans').fadeIn();$($('.nav-header')[0]).click();btnMode.appendTo($('<li><a>')).appendTo(ulTools);}else{if(AppConfig.permission.DBWrite){var $liConfig=$('<li class="iconWrap" id="btnConfigDashboard" permission="DBWrite"><a><span class="glyphicon glyphicon-cog"></span><span class="dropdownNav">'+I18n.resource.observer.widgets.CONFIG_MODE+'</span> </a></li>');var btnMode=$('<span>').addClass('badge grow').text('').css('cursor','pointer').css('background-color','#5bc0de').click(function(e){_this.isConfigMode=false;e.currentTarget.classList.remove('toolbar-btn-selected');_this.saveLayout();$('.springLinkBtn').removeAttr('style');});$liConfig.click(function(e){_this.isConfigMode=true;$('.springLinkBtn').hide();_this.showConfigMode();$('.sideTrans').fadeIn();document.querySelector('#leftCt').click();$($('.nav-header')[0]).click();btnMode.text(I18n.resource.observer.widgets.CONFIG_SAVE);});btnMode.appendTo($('<li><a>')).appendTo(ulTools);$liConfig.appendTo($('#liProjectMenu .list-inline'));}else{$('#btnConfigDashboard').remove();}}
try{Permission.check($('#liProjectMenu ul'));}catch(e){console.log(e);}},initIoc:function initIoc(){this.factoryIoC=new FactoryIoC('dashboard');this.factoryIoCAnalysis=new FactoryIoC('analysis');},initLayout:function initLayout(){this.listEntity={};this.arrEntityOrder=[];if(!this.isForBencMark){var side=new SidebarMenuEffect();side.init('#paneContent');}
I18n.fillArea($('#toolBox'));if(!(this.store&&this.store.layout))return;for(var i=0,item;i<this.store.layout.length;i++){for(var j=0;j<this.store.layout[i].length;j++){item=this.store.layout[i][j];var modelClass,entity;if(item.modal.type&&(item.modal.type!='ModalNone'||item.isNotRender==true)){modelClass=this.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender)continue;entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);if(item.modal.interval&&item.modal.interval>=0&&item.modal.points){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(this.requestPoints.indexOf(point)<0){this.requestPoints.push(point);}}}
if(item.modal.popId){if(!this.dictPopToEntity[item.modal.popId])this.dictPopToEntity[item.modal.popId]=[];this.dictPopToEntity[item.modal.popId].push(item.id);if(this.requestPoints.indexOf(item.modal.popId)<0){this.requestPoints.push(item.modal.popId);}}
entity.render();}else if(item.modal.type=='ModalNone'){modelClass=this.factoryIoC.getModel(item.modal.type);entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);entity.render();}}}
var $springCtn=$('#paneCenter').children('.springContainer');if($springCtn.length==1&&parseFloat($springCtn[0].style.height)>=parseFloat("99%")&&parseFloat($springCtn[0].style.width)>=parseFloat("99%")){$springCtn.children('.panel-default').css({border:'none',left:0,top:0,width:'100%',height:'100%'});}
if(this.options.isForMobile)this.$obCanvasContainer.addClass('forMobile');var _this=this;if(_this.isForReport){_this.showConfigMode();document.querySelector('#leftCt').click();}},initWorkerForUpdating:function initWorkerForUpdating(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e);},true);if(this.requestPoints&&this.requestPoints.length>0){this.workerUpdate.postMessage({pointList:this.requestPoints,type:"datasourceRealtime"});}},refreshData:function refreshData(e){var _this=this.self?this.self:this;if(!e.data.error&&e.data.dsItemList){var point;for(var i=0,iLen=e.data.dsItemList.length;i<iLen;i++){point=e.data.dsItemList[i];_this.mapRefresh[point.dsItemId]=point;if(_this.dictPopToEntity[point.dsItemId]){_this.popRefresh[point.dsItemId]=point;}}
var entity,arrUpdataData;for(var key in _this.listEntity){entity=_this.listEntity[key];if(entity.entity.modal.type=="ModalNone"||entity.entity.modal.type=="ModalMix")continue;arrUpdataData=[];if(entity.entity.modal&&entity.entity.modal.points){for(var i=0,iLen=entity.entity.modal.points.length;i<iLen;i++){var point=entity.entity.modal.points[i];if(!point)continue;if(entity.entity.modal.points.indexOf(point)!=i)continue;if(_this.mapRefresh[point]!=undefined)arrUpdataData.push(_this.mapRefresh[point]);}
if(entity.entity.modal.type=="ModalAppGauge"){arrUpdataData.push({'guageTitle':entity.entity.modal.option.guageTitle,'guageFulTitle':entity.entity.modal.option.guageFulTitle,'guageFixed':entity.entity.modal.option.guageFixed,'guageUnit':entity.entity.modal.option.guageUnit,'timeLocal':entity.entity.modal.option.timeLocal,'guageDirect':entity.entity.modal.option.guageDirect,'guageBgColor':entity.entity.modal.option.guageBgColor,'transDataDot':entity.entity.modal.option.transDataDot});}
entity.entity.modal.popId&&entity.renderPop(_this.popRefresh[entity.entity.modal.popId]);entity.update(arrUpdataData);}}}else{}},refreshDataTrace:function refreshDataTrace(e){var _this=this;_this.refreshData(e);for(var key in this.listEntity){if(undefined!=_this.listEntity[key].goBackTrace){_this.listEntity[key].goBackTrace(e);}}},saveLayout:function saveLayout(){var _this=this;var arrEntity=[];var entity=null;for(var i=0;i<this.arrEntityOrder.length;i++){entity=this.listEntity[this.arrEntityOrder[i]].entity;if(this.listEntity[this.arrEntityOrder[i]].optionTemplate.needRefresh===false){arrEntity.push(entity);}
if(['ModalAppKPICollect','ModalObserver','ModalNote','ModalMix','ModalHtml','ModalChartCustom','ModalWeather','ModalReportFactory','ModalRealtimeWeather','ModalCumulantChart'].indexOf(entity.modal.type)>-1){arrEntity.push(entity);}else if(entity.modal.type=='ModalPointKPI'){arrEntity.push(this.dealWithEntity(entity));}else if(entity.modal.type=='ModalReportChapter'){if(entity.modal.option&&entity.modal.option.menuId&&entity.modal.option.menuId!=''){arrEntity.push(entity);}}else if(entity.modal.type=='ModalAppButton'){if(entity.modal.option&&entity.modal.option.appButton&&entity.modal.option.appButton.length!=0){arrEntity.push(entity);}}else if(entity.modal.type=='ModalDiagnosisPanelHtml'){if(!entity.modal.option){entity.modal.option={html:'<div id="modalDiagnosisPanel'+i+'" style="height:100%;"></div>↵<script>new ModalDiagnosisPanel(document.getElementById("modalDiagnosisPanel'+i+'")).show()</script>'};entity.modal.dsChartCog=[{accuracy:2}];entity.modal.interval=60000;entity.modal.points=[];}
arrEntity.push(entity);}else if(entity.modal.type=='ModalAppBlind'){if(entity.modal.option&&entity.modal.option.length>0){for(var j=0;j<entity.modal.option.length;j++){if(entity.modal.option[j]&&entity.modal.option[j].subChartIds&&entity.modal.option[j].subChartIds[0].id){var id=entity.modal.option[j].subChartIds[0].id;if(!this.listEntity[id]){entity.modal.option.splice(j,1);break;}}}}
arrEntity.push(entity);}else{if(entity.modal.type!='ModalNone'&&(!entity.modal.points||entity.modal.points.length==0))continue;arrEntity.push(entity);}}
var data={creatorId:AppConfig.userId,menuItemId:this.id,layout:[arrEntity]};this.store.id&&(data.id=this.store.id);Spinner.spin(ElScreenContainer);WebAPI.post('/spring/saveLayout',data).done(function(result){if(_this.isForReport){var argSkin=AppConfig.chartTheme=='macarons'?'':'?skin=dark';_this.initShareIframe("/share/db/"+AppConfig.userId+"/"+_this.id+argSkin);ScreenManager.show(shareLogging,AppConfig.userId);}else{if(_this.isConfigMode&&_this.isScreenChange)return;if(_this.options.isForMobile){ScreenManager.applyScreen(EnergyScreen,null,null,null,null,true);}else{ScreenManager.applyScreen(EnergyScreen);}}}).always(function(result){if(_this.isConfigMode&&_this.isScreenChange)return;Spinner.stop();});if(_this.isForReport){var modeType;if(_this.shareLogId){modeType=true;}else{modeType=false;}
var argSkin=AppConfig.chartTheme=='macarons'?'':'?skin=dark';var arrDesc=_this.sharedesc.split(' ');if(parseInt(arrDesc[arrDesc.length-3])!==_this.arrEntityOrder.length){arrDesc[arrDesc.length-3]=_this.arrEntityOrder.length;_this.sharedesc=arrDesc.join(' ');}
var postData={menuId:_this.id+argSkin,mode:modeType,shareLogId:_this.shareLogId,desc:_this.sharedesc};WebAPI.post('/analysis/saveShareLog/'+AppConfig.userId,postData).done(function(result){console.log(result.status);});}},saveLayoutOnly:function saveLayoutOnly(){var _this=this;var arrEntity=[];var entity=null;for(var i=0;i<this.arrEntityOrder.length;i++){entity=this.listEntity[this.arrEntityOrder[i]].entity;if(['ModalObserver','ModalNote','ModalMix','ModalHtml','ModalChartCustom','ModalWeather'].indexOf(entity.modal.type)>-1){arrEntity.push(entity);}else if(entity.modal.type=='ModalPointKPI'){arrEntity.push(this.dealWithEntity(entity));}else if(entity.modal.type=='ModalReportChapter'){if(entity.modal.option&&entity.modal.option.menuId&&entity.modal.option.menuId!=''){arrEntity.push(entity);}}else{if(entity.modal.type!='ModalNone'&&(!entity.modal.points||entity.modal.points.length==0))continue;arrEntity.push(entity);}}
var data={creatorId:AppConfig.userId,menuItemId:this.id,layout:[arrEntity]};this.store.id&&(data.id=this.store.id);Spinner.spin(ElScreenContainer);WebAPI.post('/spring/saveLayout',data).done(function(result){}).always(function(result){Spinner.stop();});},dealWithEntity:function dealWithEntity(entity){entity.modal.points=[];entity.modal.interval=5;entity.modal.option&&entity.modal.option.kpiList&&entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){dealWithNode(tree);traverse(tree,0);}
function traverse(node,i){var children=node.list;if(children!=null&&children.length>0){dealWithNode(children[i]);if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}
function dealWithNode(child){delete child.pointPassData;delete child.show;if(child.pointKPI){entity.modal.points.push(child.pointKPI);}
if(child.pointGrade){entity.modal.points.push(child.pointGrade);}
if(child.pointPass){entity.modal.points.push(child.pointPass);}}
return entity;},setEntity:function setEntity(entity){},replaceEntity:function replaceEntity(sourceId,targetId,parentId){if(sourceId==targetId)return;var _this=this;var source=this.listEntity[sourceId];var target=this.listEntity[targetId];source.entity.id=(+new Date()).toString();target.entity.id=(+new Date()+1).toString();this.listEntity[source.entity.id]=source;this.listEntity[target.entity.id]=target;delete this.listEntity[sourceId];delete this.listEntity[targetId];source.initContainer(targetId).configure();target.initContainer(sourceId).configure();this.arrEntityOrder[this.arrEntityOrder.indexOf(targetId)]=source.entity.id;this.arrEntityOrder[this.arrEntityOrder.indexOf(sourceId)]=target.entity.id;if(parentId){this.listEntity[parentId].entity.modal.option.subChartIds.forEach(function(i){if(i.id==sourceId){i.id=target.entity.id;}});this.listEntity[parentId].entity.modal.option.subChartIds.forEach(function(i){if(i.id==targetId){i.id=source.entity.id;}});}
if(source.entity.modal.type=='ModalMix'){source.entity.modal.option&&source.entity.modal.option.subChartIds&&source.entity.modal.option.subChartIds.forEach(function(i){var entity=_this.listEntity[i.id].entity,modelClass,item;modelClass=_this.factoryIoC.getModel(entity.modal.type);_this.container=$('#divContainer_'+source.entity.id).find('.chartsCt')[0];item=new modelClass(_this,entity);item.configure();});}
if(target.entity.modal.type=='ModalMix'&&target.entity.modal.option&&target.entity.modal.option.subChartIds){target.entity.modal.option.subChartIds.forEach(function(i){var entity=_this.listEntity[i.id].entity,modelClass,item;modelClass=_this.factoryIoC.getModel(entity.modal.type);_this.container=$('#divContainer_'+target.entity.id).find('.chartsCt')[0];item=new modelClass(_this,entity);item.configure();});}},rebornEntity:function rebornEntity(entityParams,tragetType,targetTitle,modalNoneEdit){this.removeEntity(entityParams.id);entityParams.modal.type=tragetType;entityParams.modal.title='';var modelClass=this.factoryIoC.getModel(tragetType);if(!entityParams.isNotRender&&entityParams.modal.type!=='ModalMix'&&!modalNoneEdit){entityParams.spanC=modelClass.prototype.optionTemplate.defaultWidth?modelClass.prototype.optionTemplate.defaultWidth:modelClass.prototype.optionTemplate.minWidth;entityParams.spanR=modelClass.prototype.optionTemplate.defaultHeight?modelClass.prototype.optionTemplate.defaultHeight:modelClass.prototype.optionTemplate.minHeight;}
var entity=new modelClass(this,entityParams);this.listEntity[entity.entity.id]=entity;this.arrEntityOrder.push(entity.entity.id);entity.configure();},removeEntity:function removeEntity(id){this.listEntity[id]=null;delete this.listEntity[id];this.arrEntityOrder.splice(this.arrEntityOrder.indexOf(id),1);},render:function render(data){for(var key in this.listEntity){this.listEntity[key].render();}},showConfigMode:function showConfigMode(){this.stop();Spinner.spin(document.getElementById('paneCenter'));for(var key in this.listEntity){this.listEntity[key].configure();}
this.initDataSourcePanel();this.initToolBox();Spinner.stop();},initToolBox:function initToolBox(){var $toolBox=$($('.col-sm-2')[0].children[0]);var $modals=$('<div id="modalCt" class="panel-body">').appendTo($toolBox);var list,template,option,groupList=[];list=this.factoryIoC.getList();for(var ele=0;ele<list.length;ele++){template=list[ele];option=template.prototype.optionTemplate;if(!option)continue;if(option.parent!=null){if(!groupList[option.parent]){groupList[option.parent]=new Array();}
groupList[option.parent].push(option);}}
for(var i=0;i<groupList.length;i++){$modals.append(getModalList(groupList[i]));}
function getModalList(group){var $ul=$('<ul class="nav nav-list accordion-group">');var $liList=$('<li class="rows" style="display: none;">').appendTo($ul);for(var i in group){if(i==0){var $liHd=$('<li class="nav-header">').append('<i class="icon-plus icon-white"></i>'+I18n.findContent(group[i].name)).click(function(){var $otherUl=$(this).parent('ul').siblings('ul');$otherUl.find('.rows').slideUp();$otherUl.find('i').removeClass('icon-minus').addClass('icon-plus');$(this).next('.rows').slideToggle();var $i=$(this).find('i');var toggleClass=function(){if($i.hasClass('icon-minus'))return'icon-plus icon-white';else return'icon-minus icon-white';}();$(this).find('i').removeClass().addClass(toggleClass);});$ul.prepend($liHd);}else{var $div=$('<div class="lyrow ui-draggable" draggable="true"> ').html(I18n.findContent(group[i].name)).attr('type',group[i].type);$div[0].ondragstart=function(e){e.dataTransfer.setData("type",$(this).attr('type'));e.dataTransfer.setData("title",$(this).text());};$liList.append($div);}}
return $ul;}},initDataSourcePanel:function initDataSourcePanel(){this.paneDatasource=new DataSource(this);AppConfig.datasource=this.paneDatasource;this.paneDatasource.show();},hideAnlsPane:function hideAnlsPane(){$('#paneCenter').hide();$('#energyModal').hide();},showAnlsPane:function showAnlsPane(){$('#paneCenter').show();$('#energyModal').show();},getDSItemById:function getDSItemById(datasourceItemId){for(var i=0,len=this.store.datasources[0].list.length;i<len;i++){if(this.store.datasources[0].list[i].id===datasourceItemId){return this.store.datasources[0].list[i];}}
return null;},updateDataSources:function updateDataSources(updateData){this.store.group=updateData;},initReplay:function initReplay(){var _this=this;var $ele=$('#btnDropdownNavList').find('.toolBacktrace');if($ele.length>0){$ele.remove();}
this.toolContainer=$('#divEnergyTools');var btnTimeShaft=$('<li class="iconWrap"><a><span class="glyphicon glyphicon-play-circle"></span><span class="dropdownNav"></span></a></li>').addClass('toolBacktrace');var enterTime;btnTimeShaft.find('.dropdownNav').text(I18n.resource.observer.widgets.BACKTRACE);btnTimeShaft.eventOn('click',function(e){if(_this.isPlayback){_this.quitBacktraceMode(_this,e);if(enterTime){enterTime=new Date()-enterTime;_hmt.push(['_trackEvent','navTool-backTrace-time','click','btnBakTrace-'+AppConfig.projectShowName+'-'+AppConfig.projectId,enterTime/1000]);}}else{_this.enterBacktraceMode(_this,e);enterTime=new Date();_hmt.push(['_trackEvent','navTool-backTrace-enter','click','btnBakTrace-'+AppConfig.projectShowName+'-'+AppConfig.projectId]);}},['navTool-backTrace','btnBackTrace',AppConfig.projectShowName,AppConfig.projectId]);$('#right-nav').find('#btnOperatingRecord').after(btnTimeShaft);if(this.isInDiagnosis)ToolCurrent=new TimeShaftDashboard(_this);},enterBacktraceMode:function enterBacktraceMode(screen,e){var _this=screen?screen:this;_this.isPlayback=true;if(e){e.currentTarget.classList.add('selected');}
if(!ToolCurrent)ToolCurrent=new TimeShaftDashboard(_this);ToolCurrent.containerHeight=100;ToolCurrent.show();if(_this.workerUpdate){_this.workerUpdate.terminate();_this.workerUpdate=null;}
$.when(ToolCurrent.defer).done(function(){var jCanvas=_this.$obCanvasContainer;jCanvas.css({height:'100%',width:'100%'});var jParent=jCanvas.parent();var height=jCanvas.height()-ToolCurrent.containerHeight;var width=jCanvas.width();if(width>jParent.width()){width=jParent.width();height=width/(_this.canvas.width/_this.canvas.height);}
jCanvas.animate({height:height,width:width,marginTop:(jParent.height()-height-ToolCurrent.containerHeight)/2+'px'},400,function(){_this.initScreen();_this.renderElements();_this.initWorkerForUpdating();});});},quitBacktraceMode:function quitBacktraceMode(screen,e){var _this=screen?screen:this;_this.isPlayback=false;if(e){e.currentTarget.classList.remove('selected');}
ToolCurrent.close();ToolCurrent=null;_this.$obCanvasContainer.animate({height:'100%',width:'100%'},300,function(){_this.initScreen();_this.renderElements();_this.initWorkerForUpdating();});},initScreen:function initScreen(){var _this2=this;if(this.isDetailPage){var _this;var dialogWidth;var detailScreenModal;var $toolBacktrace;var oldDialogTitle;var paddingLeft;var paddingTop;(function(){var convertPositionToReal=function convertPositionToReal(arr){if(arr){for(var i=0;i<arr.length;i++){var temp=arr[i];temp.x=temp.x-paddingLeft;temp.y=temp.y-paddingTop;}}};var convertTempDistributionsToReal=function convertTempDistributionsToReal(dis){if(!dis){return;}
dis.x-=paddingLeft;dis.y-=paddingTop;convertPositionToReal(dis.data);};_this=_this2;dialogWidth=_this2.store.page.width+40>$(window).width()?$(window).width()-200:_this2.store.page.width+40;detailScreenModal=$('#detailScreenModal');$toolBacktrace=$('.toolBacktrace');I18n.fillArea($('#detailScreenModal'));$toolBacktrace.remove();if(_this2.dialogTitle){oldDialogTitle=detailScreenModal.find('.modal-title').text();detailScreenModal.find('.modal-title').text(_this2.dialogTitle);}
detailScreenModal.find('.modal-dialog').css("margin","0 auto 0 auto").css("width",dialogWidth);detailScreenModal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){if(ScreenModal){ScreenModal.close();ScreenModal=null;}
_this.initToolBar(tObscreen);Spinner.stop();oldDialogTitle&&$(this).find('.modal-title').text(oldDialogTitle);}).modal({});Spinner.spin(detailScreenModal.find('.modal-body')[0]);paddingLeft=(1920-_this2.store.page.width)/2;paddingTop=(955-_this2.store.page.height)/2;convertPositionToReal(_this2.store.equipments);convertPositionToReal(_this2.store.buttons);convertPositionToReal(_this2.store.texts);convertTempDistributionsToReal(_this2.store.tempDistributions);})();}else{if(ScreenModal&&!this.isInDiagnosis){if(ScreenCurrent)ScreenCurrent.close();ScreenCurrent=ScreenModal;ScreenModal=null;}
if(this.isInDiagnosis)this.diagScreen.obScreen=this;tObscreen=this;$("#page-"+this.id).parent().addClass("active");}},renderElements:function renderElements(){this.dictRefreshMap={};},renderData:function renderData(dataList,curTm,startTm,endTm){var data={};data.dsItemList=dataList;this.refreshDataTrace({data:data,currentTime:curTm,startTime:startTm,endTime:endTm});},initShareIframe:function initShareIframe(shareURL){var strIframe=new StringBuilder();strIframe.append('<div class="modal fade" id="modalShareIframe" style="overflow-y:hidden">');strIframe.append('  <div class="modal-dialog" style="height:95%;width:80%">');strIframe.append('      <div class="modal-content" style="height:100%;">');strIframe.append('          <div class="modal-header" style="height:60px">');strIframe.append('              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>');strIframe.append('              <h4 class="modal-title">'+this.sharedesc+'</h4>');strIframe.append('          </div>');strIframe.append('          <div class="modal-body" id="divShareIframe" style="height:calc(100% - 60px);padding:0">');strIframe.append('              <iframe src="'+shareURL+'" style="height:100%;width:100%;border:none;"></iframe>');strIframe.append('          </div>');strIframe.append('      </div>');strIframe.append('  </div>');strIframe.append('</div>');$('body').append(strIframe.toString());var $modalShareIframe=$('#modalShareIframe');I18n.fillArea($modalShareIframe);$modalShareIframe.modal({show:true});$modalShareIframe.on('hidden.bs.modal',function(e){$modalShareIframe.remove();});}};return EnergyScreen;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var ReportScreen=function(){var getThisWeekReportNum=function getThisWeekReportNum(){var weekNum=DateUtil.getWeekNumber(new Date());return DateUtil.getLastWeekNumberOf(weekNum[0],weekNum[1]);};function ReportScreen(reportId,reportType,reportFolder,reportDate,reportText){this.$reportNavigation=null;this.reportStringId=reportId;this.reportType=reportType;this.lastReportType=reportType;this.reportFolder=reportFolder;this.reportText=reportText;this.dateList=[];this.pdfMap=[];this.datePickerInstance=null;if(reportDate){if(this.reportType==this.reportTypeMap.monthly){if(new Date().getMonth()==new Date(reportDate+'-15').getMonth()){var date=new Date();date.setMonth(date.getMonth()-1,1);reportDate=date.format('yyyy-MM');}
this.reportDate=new Date(reportDate+'-15').format('yyyy-MM');}else if(this.reportType==this.reportTypeMap.weekly){if(this.iso8601Week(new Date())==this.iso8601Week(new Date(reportDate))){reportDate=new Date(new Date()-7*24*60*60*1000).format('yyyy-MM-dd');}
this.reportDate=reportDate.format('yyyy-MM-dd');}else if(this.reportType!=this.reportTypeMap.monthly){this.reportDate=reportDate;}}else if(this.reportType==this.reportTypeMap.daily){var date=new Date();date.setDate(date.getDate()-1);this.reportDate=date.format('yyyy-MM-dd');}else if(this.reportType==this.reportTypeMap.monthly){var date=new Date();date.setMonth(date.getMonth()-1,1);this.reportDate=date.format('yyyy-MM');}else{this.reportDate=new Date(new Date()-7*24*60*60*1000).format('yyyy-MM-dd');}
this.reportName='';this.week=null;this.getMonthFirst=true;this.currentTR=null;this.currentDatePicker=null;this.currentYear=null;this.currentGoToday=false;this.dateTimePickerInline=false;this.i18nEcharts=I18n.resource.echarts;}
ReportScreen.prototype={displayWeek:getThisWeekReportNum(),reportTypeMap:{daily:'0',monthly:'1',weekly:'2'},baseChartOption:{title:{x:'center',textStyle:{fontSize:15}},tooltip:{trigger:'axis'},toolbox:{show:true,feature:{mark:{show:true},dataView:{show:true,readOnly:true},restore:{show:true},saveAsImage:{show:true}},showTitle:false},animation:false},chartYOffsetSetting:{grid:{y:100},legend:{y:40}},chartType:{pie:'pie',line:'line',scatter:'scatter',bar:'bar',area:'area',table:'table'},chartList:{},show:function show(){this.init();},close:function close(){this.unregisterChartResize();this.disposeChart();this.chartList={};$(window).off('resize');},disposeChart:function disposeChart(){for(var chartId in this.chartList){this.chartList[chartId].dispose();}},init:function init(){var _this=this;setTimeout(function(){if(_this.reportDate){_this.getReport.apply(_this,_this.reportDate.split('-'));}else{_this.getReport();}},50);this.chartList={};this.registerExportPDFEvent();this.registerExportWordEvent();},pieOptionToContent:function pieOptionToContent(opt){var html='';var series=$.extend(true,[],opt.series);for(var m=0,ml=series.length;m<ml;m++){series[m].data.sort(function(a,b){return a.name.localeCompare(b.name);});var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+series[m].name+'</p>';html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';for(var n=0,nl=series[m].data.length;n<nl;n++){html+='<tr>'+'<td>'+series[m].data[n].name+'</td>';for(var j=0,jl=series[m].data[n].value.length;j<jl;j++){html+='<td>'+series[m].data[n].value[j]+'</td>';}
html+='</tr>';}
html+='</tbody></table>';}
return html;},optionToContent:function optionToContent(opt){var axisData=opt.xAxis&&opt.xAxis[0].data,series=opt.series;var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+opt.title.text+'</p>';var html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';if(BEOPUtil.isUndefined(axisData)){html+='<tr>';for(var i=0,l=series.length;i<l;i++){html+='<td colspan="2">'+series[i].name+'</td>';}
html+='</tr>';var longestSeriesData=[],longestLength=0;for(var j=0,sl=series.length;j<sl;j++){if(series[j].data.length>longestLength){longestSeriesData=series[j].data;longestLength=longestSeriesData.length;}}
for(var i=0,il=longestSeriesData.length;i<il;i++){html+='<tr>';for(var m=0,ml=series.length;m<ml;m++){if(!BEOPUtil.isUndefined(series[m].data[i])){for(var n=0,nl=series[m].data[i].length;n<nl;n++){html+='<td>'+series[m].data[i][n]+'</td>';}}}
html+='</tr>';}}else{html+='<tr><td>'+opt.xAxis[0].name+'</td>';for(var i=0,l=series.length;i<l;i++){html+='<td>'+series[i].name+'</td>';}
html+='</tr>';for(var i=0,l=axisData.length;i<l;i++){html+='<tr>'+'<td>'+axisData[i]+'</td>';for(var j=0,sl=series.length;j<sl;j++){html+='<td>'+series[j].data[i]+'</td>';}
html+='</tr>';}}
html+='</tbody></table>';return html;},registerChartResize:function registerChartResize(){var _this=this;this.unregisterChartResize();$(window).on('resize.beop.report.echarts',function(){for(var m in _this.chartList){_this.chartList[m].resize();}});},unregisterChartResize:function unregisterChartResize(){$(window).off('resize.beop.report.echarts');},uploadChart:function uploadChart(key,chart_base64){return WebAPI.post('/report/uploadChart/',{key:key,chart:chart_base64});},downloadFile:function downloadFile(href,filename){var a=$("<a id='test' download='"+filename+"' target='_self'' href='"+href+"'></a>")[0];try{try{a.click();}catch(ex){var evObj=document.createEvent('MouseEvents');evObj.initEvent('click',true,true,window);a.dispatchEvent(evObj);}}catch(ex){alert('download failed.Please contact the administrator.');return false;}},requestWordDownload:function requestWordDownload(){var report=[],$report=$('.step-play-list').clone(),_this=this,uploadPromises=[];$report.find('.step-item-container').each(function(index,chapterContainer){var $chapterContainer=$(chapterContainer);var chapter={title:$chapterContainer.find('.page-header').text().replace('\s+',''),unit:[]};$chapterContainer.find('.report-unit').each(function(index,unitContainer){var $unitContainer=$(unitContainer);var $children=$unitContainer.children();var unit={title:$unitContainer.find('.well').text().replace(/\s{4,}/g,'\n'),content:[]};$children.each(function(index,child){var $child=$(child);if($child.hasClass('canvas-container')){var chartId=$child.attr('_echarts_instance_');var chartInstance=echarts.getInstanceById(chartId);if(chartInstance){uploadPromises.push(_this.uploadChart(chartId,chartInstance.getDataURL()));unit.content.push({type:'chart',value:chartId});}}else if($child.hasClass('summary')){var summaryHtml=$child.text().replace(/\s{4,}/g,'\n');summaryHtml.split('<br>').forEach(function(summaryItem){if(summaryItem&&summaryItem.trim()){unit.content.push({type:'summary',value:summaryItem.trim()});}});}else if($child.hasClass('table')){var header=[],rows=[];$child.find('thead th').each(function(index,th){header.push($(th).text());});$child.find('tbody tr').each(function(index,tr){var row=[];$(tr).find('td').each(function(index,td){row.push($(td).text());});rows.push(row);});unit.content.push({type:'table',header:header,rows:rows});}});chapter.unit.push(unit);});report.push(chapter);});Spinner.spin(ElScreenContainer);$.when.apply(null,uploadPromises).then(function(){WebAPI.post('/report/exportWord/',{report:report,projectName:AppConfig.projectName,name:_this.reportText+'_'+_this.reportDate,folder:_this.reportFolder,version:_this.reportDate}).done(function(result){if(result.success){_this.downloadFile(result.data,_this.reportText+'_'+timeFormat(_this.reportDate,timeFormatChange('yyyy-mm-dd'))+'.docx');}else{alert('The server is busy. please try again later');}}).always(function(){Spinner.stop();});}).fail(function(){Spinner.stop();});},registerExportWordEvent:function registerExportWordEvent(){$(ElScreenContainer).off('click.report.exportWord','#exportWord').on('click.report.exportWord','#exportWord',this.requestWordDownload.bind(this));},registerExportPDFEvent:function registerExportPDFEvent(){var _this=this;$(ElScreenContainer).off('click.report.exportPDF','#exportPDF').on('click.report.exportPDF','#exportPDF',function(){var chart=null,$this=$(this),$report=$('.step-play-list').clone(),reportFolderName=$this.attr('reportFolderName'),version=$this.attr('version'),pdfName=AppConfig.projectShowName+'.'+_this.getReportName()+'.'+timeFormat(version,timeFormatChange('yyyy-mm-dd'))+'.pdf',uploadPromises=[];if(_this.pdfMap[version]){_this.downloadFile(_this.pdfMap[version],pdfName);}else{Spinner.spin(ElScreenContainer);for(var chartId in _this.chartList){chart=_this.chartList[chartId];if(chart){var imageKey=AppConfig.projectId+reportFolderName+version+chartId;uploadPromises.push(_this.uploadChart(imageKey,_this.chartList[chartId].getDataURL()));$report.find('[chart-id='+chartId+']').replaceWith('<img class="chartImage" img-src="'+'/static/projectReports/reports/'+imageKey+'.png"/>');}}
$('.canvas-container',$report).each(function(index,item){$(item).prev('.summary').addBack().wrapAll('<div class="pageHeaderWrapper"></div>');});var pdfTemplatePromise=WebAPI.get('/static/views/share/reportWrap/pdfTemplate.html');var coverPagePromise=WebAPI.get('/static/views/share/reportWrap/coverPage.html');$.when.apply(null,uploadPromises).done(function(){$.when(pdfTemplatePromise,coverPagePromise).done(function(template,result){WebAPI.get("/project/getinfo/"+AppConfig.projectId).done(function(rs){var projectInfo=rs.projectinfo;result=result[0].formatEL({projectImg:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.pdfCover),title:$("#reportNavList").find('.active').text(),logo:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.logo),date:timeFormat($("#beopReport").find(' .input-append input').val(),timeFormatChange('yyyy-mm-dd')),projName:localStorage.getItem("language")==="zh"?projectInfo.name_cn:projectInfo.name_english});template=template[0].formatEL({projectImg:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.pdfCover),title:_this.getReportName(),encoding:'UTF-8',projName:AppConfig.projectShowName,entitiesHtml:$report.attr('id','reportWrap').html(),date:timeFormat(version,timeFormatChange('yyyy-mm-dd')),logo:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.logo),footerLeft:i18n_resource.report.reportWrap.GENERATED_BY_BEOP,footerRight:localStorage.getItem("language")==="zh"?"第 [page] 页 共[topage]页":"Page [page] of [topage]"});WebAPI.post('/report/getReportPDF',{html:template,cover:result,skin:'default',folder:reportFolderName,version:version,projectName:AppConfig.projectName,projectShowName:AppConfig.projectShowName,projectId:AppConfig.projectId,reportName:_this.getReportName()}).done(function(result){if(result.success){_this.downloadFile(result.data.createdPDF,pdfName);_this.pdfMap=result.data.pdfMap;}}).always(function(){Spinner.stop();});});});}).fail(function(){Spinner.stop();});}});},getReportFolder:function getReportFolder(){return this.reportFolder;},getReportType:function getReportType(){return this.reportType;},getReportName:function getReportName(){if(!this.reportStringId){return'';}
if(!this.reportName){for(var i=0;i<AppConfig.navItems.length;i++){var navItem=AppConfig.navItems[i];if(navItem.id===this.reportStringId){this.reportName=navItem.text;}}}
return this.reportName;},initReportList:function initReportList(){if(!AppConfig.navItems){return false;}
$('#reportNavList').remove();var reportItem,reportItemList,$reportItemBtn,_this=this,$listGroup=$('<ul id="reportNavList" class="list-group reportList" style="width:110px;overflow-y: auto;height: 90%;overflow-x: hidden;top: 74px"></ul>');reportItemList=AppConfig.navItems.filter(function(item){return item.type==='ReportScreen';});for(var i=0;i<reportItemList.length;i++){reportItem=reportItemList[i];$reportItemBtn=$('<li class="list-group-item ellipsis" id="'+reportItem.id+'" title="'+reportItem.text+'" report_type="'+reportItem.reportType+'">'+'<span class="mr5 iconfont icon-report'+reportItem.reportType+'"></span>'+reportItem.text+'</li>');$reportItemBtn.click(function(reportItem){return function(){if(reportItem.reportType==_this.reportTypeMap.monthly){if(new Date().getMonth()==_this.reportDate.substring(5,7)){var date=new Date();date.setMonth(date.getMonth()-1,1);_this.reportDate=date.format('yyyy-MM');}else{_this.reportDate=_this.reportDate.substring(0,7);}}else if(reportItem.reportType==_this.reportTypeMap.daily&&_this.lastReportType==_this.reportTypeMap.monthly||reportItem.reportType==_this.reportTypeMap.daily&&_this.lastReportType==_this.reportTypeMap.weekly){var thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);_this.reportDate=thisDay.format('yyyy-MM-dd');}else if(reportItem.reportType==_this.reportTypeMap.weekly&&_this.lastReportType==_this.reportTypeMap.monthly){var thisDay=new Date();thisDay.setDate(thisDay.getDate()-7);_this.reportDate=thisDay.format('yyyy-MM-dd');}
ScreenManager.goTo({page:'ReportScreen',reportId:reportItem.id,reportType:reportItem.reportType,reportFolder:reportItem.reportFolder,reportDate:_this.reportDate,reportText:reportItem.text});};}(reportItem));$listGroup.append($reportItemBtn);}
$('#indexMain').append($listGroup);$("#"+_this.reportStringId).addClass("active");var $stepContainer=$("#indexMain .step-container");var $reportNavList=$("#reportNavList");var navLeftPosi=function navLeftPosi(){$reportNavList.css({left:parseInt($stepContainer.offset().left)-parseInt($reportNavList.width())+'px'});$(".reportNavigation").css({left:parseInt($stepContainer.offset().left)+parseInt($stepContainer.width())+40+'px',top:"92px"});};$stepContainer.css("margin-left","13%");navLeftPosi();$(window).resize(function(){navLeftPosi();});},getReportMsg:function getReportMsg(){var _this=this;var report_type,reportDate,i18n=I18n.resource.observer.reportScreen;$("#reportLoading").remove();if(this.reportType=='0'){report_type=i18n.DAILY;reportDate=timeFormat(this.reportDate,timeFormatChange('yyyy-mm-dd'));}else if(this.reportType=='1'){report_type=i18n.MONTHLY;reportDate=timeFormat(this.reportDate,timeFormatChange('yyyy-mm'));}else{report_type=i18n.WEEKLY;reportDate='';}
var reportLoadingHtml='<div id="reportLoading">'+'<div id="reportLoadingModal"></div>'+'<div class="report-loading-img-box">'+'<div id="reportLoadingText"><div><span> '+i18n.LOADING+' </span><span class="report-type-text">'+_this.reportText+' </span></div>'+'<div><span>'+reportDate+'</span> <span>'+report_type+'</span></div>'+'</div>'+'</div>'+'</div>';$("body").append(reportLoadingHtml);},reportMsgDestroy:function reportMsgDestroy(){var _this=this;this.$reportLoadingDtd=$.Deferred();setTimeout(function(){$("#reportLoading").remove();_this.$reportLoadingDtd.resolve();},1000);return _this.$reportLoadingDtd;},getReport:function getReport(year,month,day){var _this=this,version,thisDay;_this.getReportMsg();$(".step-container").empty();var reportFolderName=this.getReportFolder();if(this.getReportType()==this.reportTypeMap.daily){if(!month||!year||!day){thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);version=thisDay.format('yyyy-MM-dd');year=thisDay.getFullYear();month=thisDay.getMonth()+1;day=thisDay.getDate();}else{version=year+"-"+StringUtil.padLeft(month,2,'0')+"-"+StringUtil.padLeft(day,2,'0');}}else if(this.getReportType()==this.reportTypeMap.monthly){if(!month||!year){thisDay=new Date();thisDay.setMonth(thisDay.getMonth()-1);year=thisDay.getFullYear();month=thisDay.getMonth()+1;}
version=year+'-'+StringUtil.padLeft(month,2,'0');}else{if(!year){thisDay=new Date();year=thisDay.getFullYear();}
if(!day){day=new Date().getDate();}
if(!month){month=thisDay.getMonth()-1;if(month<=0){year=year-1;month=_this.iso8601Week(new Date(year,12));}else{month=_this.iso8601Week(thisDay);if(month<=0){month=1;}}
version=year+'-'+month+'-w';}else{month=_this.iso8601Week(new Date(year+'-'+month+'-'+day));_this.week=month;}
version=year+'-'+month+'-w';}
var getReportFailed=function getReportFailed(){WebAPI.get('/static/projectReports/emptyReport.html').done(function(resultHtml){_this.reportMsgDestroy().done(function(){if($('#reportFailCon').length===0){I18n.fillArea($(ElScreenContainer).html(resultHtml));}
if(day){day=day<10?day.length==2?day:'0'+day:day;}
_this.initDatePicker(year,month,day);_this.initReportList();});}).fail(function(){_this.reportMsgDestroy();}).always(function(){Spinner.stop();});};return WebAPI.get("/report/getReport/"+AppConfig.projectName+"/"+reportFolderName+'/'+version).done(function(resultHtml){_this.reportMsgDestroy().done(function(){$(ElScreenContainer).html(resultHtml);_this.renderCharts($('#beopReport .report-unit'));_this.$reportNavigation=$('.reportNavigation');_this.initDatePicker(year,month,day);_this.$reportNavigation.affix({offset:{top:100}});$('.step-container').scrollspy({target:'.reportNavigation'});_this.$reportNavigation.find('.active').removeClass('active');if(Permission.hasPermission('DReport')){var $pdfContent='<a id="exportPDF" class="report_file_download exportPDF pa" permission="DReport"><span class="add-on"><img class="report_file_img" src="/static/images/pdf_download.png"　alt="PDF Dowload" /></span><span class="report_file_text" i18n="observer.reportScreen.PDF_DOWNLOAD"></span></a>';_this.$reportNavigation.prepend($pdfContent);var $exportPDF=$('#exportPDF');if(!$exportPDF.length){$('#beopReport').append($exportPDF);}
$exportPDF.attr('reportFolderName',reportFolderName).attr('version',version);var $wordContent='<a id="exportWord" class="report_file_download exportWord pa" permission="DReport"><span class="add-on"><img class="report_file_img" src="/static/images/word_download.png"　alt="Word Dowload" /></span><span class="report_file_text" i18n="observer.reportScreen.WORD_DOWNLOAD"></span></a>';_this.$reportNavigation.prepend($wordContent);var $exportWord=$('#exportWord');if(!$exportWord.length){$('#beopReport').append($exportWord);}
$exportWord.attr('reportFolderName',reportFolderName).attr('version',version);}
_this.initReportList();_this.changeDatepickerStyle();I18n.fillArea($(ElScreenContainer));});}).fail(function(){getReportFailed();}).always(function(){WebAPI.get("/report/getReportList/"+AppConfig.projectName+"/"+reportFolderName+'/'+version).done(function(result){if(result.success){_this.dateList=$.unique(result.data.htmlReport);_this.pdfMap=result.data.pdfReportMap;}});Spinner.stop();});},changeDatepickerStyle:function changeDatepickerStyle(){var $reportNavigation=$(".reportNavigation");$reportNavigation.find(".add-on").addClass("input-group-addon");$reportNavigation.find(".icon-calendar").attr("class","glyphicon glyphicon-calendar");},addActiveWeeksStyle:function addActiveWeeksStyle(){var $con=this.datePickerInstance.picker,yearMonth=this.datePickerInstance.viewDate.format('yyyy-MM').split('-'),year=yearMonth[0],i,timeList;this.filterDateList('week');for(i=0;i<this.dateList.length;i++){timeList=this.dateList[i].split('-');if(timeList[0]==year){$con.find('.datetimepicker-days table tbody td.ui-week-col').each(function(){if($(this).text()==timeList[1]){$(this).parent().addClass('hasReport');}});}}},addActiveDaysStyle:function addActiveDaysStyle(){var $con=this.datePickerInstance.picker;var yearMonth=this.datePickerInstance.viewDate.format('yyyy-MM').split("-");var year=yearMonth[0];var month=yearMonth[1];this.filterDateList('day');for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList[0]==year&&timeList[1]==month){$con.find(".day:not('.old,.new')").eq(Number(timeList[2])-1).addClass("hasReport");}}},addActiveMonthsStyle:function addActiveMonthsStyle(){var $con=this.datePickerInstance.picker;var year=this.datePickerInstance.viewDate.format('yyyy').split("-");this.filterDateList('month');for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList[0]==year){$con.find(".month").eq(Number(timeList[1])-1).addClass("hasReport");}}},filterDateList:function filterDateList(val){var dayList=[];var monthList=[];var weekList=[];for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList.length==3&&this.getReportType()==this.reportTypeMap.weekly){weekList.push(this.dateList[i]);}else if(timeList.length>2){dayList.push(this.dateList[i]);}else{monthList.push(this.dateList[i]);}}
if(val=="day"){this.dateList=dayList;}else if(val=='month'){this.dateList=monthList;}else{this.dateList=weekList;}},triggerDateStyle:function triggerDateStyle(val){var _this=this;setTimeout(function(){if(val=="day"){_this.addActiveDaysStyle();}else if(val=="month"){_this.addActiveMonthsStyle();}else if(val=='weekly'){_this.addActiveWeeksStyle();$('.datetimepicker .datetimepicker-days table tbody').find('tr').find('td:first').each(function(){$this=$(this);if($this.text()==_this.week){$this.parent().addClass('active');$this.parent().siblings().removeClass('active');}});}},50);},iso8601Week:function iso8601Week(date){var addOneDayDate=new Date(new Date(date).getTime()+24*60*60*1000);var time,checkDate=new Date(addOneDayDate.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},renderCharts:function renderCharts($chartContainer){var echartForI18Option={};var _this=this;if(this.i18nEcharts){echartForI18Option={toolbox:{feature:{mark:{show:true,title:{mark:this.i18nEcharts.MARK,markUndo:this.i18nEcharts.MARKUNDO,markClear:this.i18nEcharts.MARKCLEAR}},dataZoom:{title:{dataZoom:this.i18nEcharts.DATAZOOM,dataZoomReset:this.i18nEcharts.DATAZOOMRESET}},dataView:{title:this.i18nEcharts.DATAVIEW,lang:[this.i18nEcharts.DATAVIEW,this.i18nEcharts.CLOSE,this.i18nEcharts.REFRESH],show:true,readOnly:true},magicType:{title:{line:this.i18nEcharts.LINE,bar:this.i18nEcharts.BAR,stack:this.i18nEcharts.STACK,tiled:this.i18nEcharts.TILED,force:this.i18nEcharts.FORCE,chord:this.i18nEcharts.CHORD,pie:this.i18nEcharts.PIE,funnel:this.i18nEcharts.FUNNEL}},restore:{show:true,title:this.i18nEcharts.REDUCTION},saveAsImage:{show:true,title:this.i18nEcharts.SAVE_AS_PICTURE,lang:[this.i18nEcharts.SAVE]}}}};}
if(jscd.mobile){window.addEventListener('load',function(){$('canvas').off().remove();ReportScreen=null;for(var m=0;m<_this.chartList.length;m++){_this.chartList[m].clear();_this.chartList[m].dispose();}
_this.chartList={};$('.canvas-container').off();$('.step-container').off();$(".form_datetime").off();},false);var extraOptionsForMobile={toolbox:{show:false},title:{textStyle:{fontSize:15,fontFamily:'Microsoft Yahei',fontWeight:'500'}},grid:{x:24,y:2,x2:28,y2:40},xAxis:[{axisLabel:{textStyle:{fontSize:12},interval:40,rotate:'90'},nameTextStyle:{fontSize:1.8}}],yAxis:[{axisLabel:{textStyle:{fontSize:2}},nameTextStyle:{fontSize:1.8}}],legend:{textStyle:{fontSize:2}},renderAsImage:'jpeg'};this.baseChartOption=$.extend(true,this.baseChartOption,extraOptionsForMobile,echartForI18Option);}else{this.baseChartOption=$.extend(true,this.baseChartOption,echartForI18Option);}
if(jscd.mobile){this.scrollInitEcharts($chartContainer);}else{$chartContainer.find('.chart-param').each(function(){_this.initCharts($(this));});}},scrollInitEcharts:function scrollInitEcharts($chartContainer){var offsets=[],_this=this;var scrollTop,i,activeClass="scrollActive";$chartContainer.each(function(){var top=$(this).offset().top-$(window).height();offsets.push(top>0?top:0);});_this.initCharts($chartContainer.eq(0).find('.chart-param'));$chartContainer.eq(0).addClass(activeClass);var activate=function activate(targetIndex){[].slice.call($chartContainer).forEach(function(item,index){if(index==targetIndex){var $item=$(item);if(!$item.hasClass(activeClass)){$item.addClass(activeClass);$item.find('.chart-param').each(function(){_this.initCharts($(this));});if(jscd.mobile){setTimeout(function(){for(var key in _this.chartList){if(_this.chartList.hasOwnProperty(key)){if(_this.chartList[key]){_this.chartList[key]=null;}}}
$('canvas').off().remove();},5000);}}}});};document.querySelector('.step-container').addEventListener('scroll',function(){scrollTop=$(this).scrollTop()+300;for(i=offsets.length;i--;){if(scrollTop>=offsets[i]&&(offsets[i+1]===undefined||scrollTop<offsets[i+1])){activate(i);return;}}});},initDatePicker:function initDatePicker(year,month,day){var now=new Date();year=!year?now.getFullYear():year;var monthNameShort=!month?DateUtil.getMonthNameShort(DateUtil.getLastMonth()-1):DateUtil.getMonthNameShort(month-1);var monthName=!month?DateUtil.getMonthName(DateUtil.getLastMonth()-1):DateUtil.getMonthName(month-1);day=!day?now.getDate():day;var $datePick=$(".form_datetime");if(this.dateTimePickerInline==true){$datePick.empty();}
var _this=this;var dateDisplay,timeFormatStr;$datePick.datetimepicker('remove').off();if(this.getReportType()==this.reportTypeMap.daily){var updateDaily=function updateDaily(){setTimeout(function(){_this.triggerDateStyle('day');$datePick.datetimepicker('update',new Date(year,Number(month)-1,day));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('day');});},0);};timeFormatStr=timeFormatChange('yyyy-mm-dd');$datePick.datetimepicker({format:timeFormatStr,minView:"month",startView:"month",todayBtn:true,inline:true,startDate:"2010-01-01 00:00",sideBySide:true,autoclose:true,forceParse:false,endDate:new Date(),initialDate:new Date(monthNameShort+' '+day+','+year)});if(!_this.dateTimePickerInline){$datePick.find('input').val(timeFormat(monthNameShort+' '+day+','+year,timeFormatStr));}
$datePick.on('changeDate',function(ev){try{ScreenManager.goTo({page:'ReportScreen',reportId:_this.reportStringId,reportType:_this.reportType,reportFolder:_this.reportFolder,reportDate:ev.date.toISOString().substring(0,10),reportText:_this.reportText});}catch(e){return false;}}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('day');}).on('show',function(ev){var dayFormat=ev.date.toISOString().substring(8,10);dateDisplay=DateUtil.getMonthNameShort(ev.date.getMonth())+' '+dayFormat+', '+ev.date.getFullYear();if(!_this.dateTimePickerInline){$datePick.find('input').val(timeFormat(dateDisplay,timeFormatStr));}
_this.addActiveDaysStyle();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('day');});});this.dateTimePickerInline==true?updateDaily():'';}else if(this.getReportType()==this.reportTypeMap.monthly){var updateMonthly=function updateMonthly(){setTimeout(function(){_this.triggerDateStyle('month');$datePick.datetimepicker('update',new Date(year,Number(month)-1));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('month');});},0);};timeFormatStr=timeFormatChange('yyyy-mm');$datePick.datetimepicker({format:timeFormatStr,minView:"year",startView:"year",todayBtn:true,inline:true,startDate:"2010-01-01 00:00",sideBySide:true,autoclose:true,endDate:new Date(new Date().setMonth(new Date().getMonth()-1)),monthAbbreviation:true,forceParse:false,initialDate:new Date(monthNameShort+','+year)});if(!_this.dateTimePickerInline){$datePick.find('input').val(timeFormat(monthNameShort+','+year,timeFormatStr));}
$datePick.on('changeDate',function(ev){try{ScreenManager.goTo({page:'ReportScreen',reportId:_this.reportStringId,reportType:_this.reportType,reportFolder:_this.reportFolder,reportDate:ev.date.toISOString().substring(0,7),reportText:_this.reportText});}catch(e){return false;}}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('month');}).on('show',function(ev){dateDisplay=DateUtil.getMonthNameShort(ev.date.getMonth())+','+ev.date.getFullYear();_this.addActiveMonthsStyle();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('month');});});this.dateTimePickerInline==true?updateMonthly():'';}else if(this.getReportType()==this.reportTypeMap.weekly){var updateWeekly=function updateWeekly(){setTimeout(function(){_this.triggerDateStyle('weekly');$datePick.datetimepicker('update',new Date(year,Number(month)-1));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('weekly');});_this.addActiveWeeksStyle();if(_this.currentTR!==null&&_this.currentTR!==undefined&&_this.currentTR!=='undefined'){if(_this.currentDatePicker){if(!_this.currentGoToday){$datePick.datetimepicker('update',new Date(_this.currentDatePicker).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();$('.datetimepicker:last .datetimepicker-days table tbody tr').eq(_this.currentTR).addClass('active');}else{var weekNow=_this.iso8601Week(new Date());$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});_this.currentGoToday=false;}
_this.addActiveWeeksStyle();}}else{if(_this.firstOpen){$datePick.datetimepicker('update',new Date(year,date.getMonth()-1).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();}else{var weekNow=_this.iso8601Week(new Date());$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});}}},0);};var week;if(this.week!=null){week=this.week;}else if(this.getMonthFirst){if(month){week=month;}else{var date=new Date();week=this.iso8601Week(new Date(date.getFullYear(),date.getMonth()-1));}}else{week=this.iso8601Week(new Date(year,['January','February','March','April','May','June','July','August','September','October','November','December'].indexOf(monthName)));}
this.getMonthFirst=false;if(this.currentYear){year=this.currentYear;}
if(!_this.dateTimePickerInline){$datePick.find('input').val(year+'-'+week+'-week');}
$datePick.datetimepicker({format:'yyyy-mm-dd hh:ii',todayBtn:true,autoclose:true,showWeek:true,inline:true,startDate:"2010-01-01 00:00",sideBySide:true,minView:2,endDate:new Date()});$datePick.data('date',this.reportDate);$datePick.on('changeYear changeMonth',function(ev){_this.triggerDateStyle('weekly');}).on('show',function(ev){_this.addActiveWeeksStyle();if(_this.currentTR!==null&&_this.currentTR!==undefined&&_this.currentTR!=='undefined'){if(_this.currentDatePicker){if(!_this.currentGoToday){$datePick.datetimepicker('update',new Date(_this.currentDatePicker).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();$('.datetimepicker:last .datetimepicker-days table tbody tr').eq(_this.currentTR).addClass('active');}else{var weekNow=_this.iso8601Week(new Date());$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});_this.currentGoToday=false;}
_this.addActiveWeeksStyle();}}else{$('.datetimepicker .datetimepicker-days table tbody').find('tr').find('td:first').each(function(){$this=$(this);if($this.text()==_this.week){$this.parent().addClass('active');$this.parent().siblings().removeClass('active');}});}
dateDisplay=DateUtil.getMonthName(ev.date.getMonth())+','+ev.date.getFullYear();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('weekly');});}).on('changeDay',function(date){try{var reportDate=new Date(date.date);ScreenManager.goTo({page:'ReportScreen',reportId:_this.reportStringId,reportType:_this.reportType,reportFolder:_this.reportFolder,reportDate:reportDate.format('yyyy-MM-dd'),reportText:_this.reportText});}catch(e){return false;}}).on('goToToday',function(date){_this.currentGoToday=false;try{ScreenManager.goTo({page:'ReportScreen',reportId:_this.reportStringId,reportType:_this.reportType,reportFolder:_this.reportFolder,reportDate:date.date.format('yyyy-MM-dd'),reportText:_this.reportText});}catch(e){return false;}});this.dateTimePickerInline==true?updateWeekly():'';}
this.datePickerInstance=$datePick.data('datetimepicker');},generateChartId:function generateChartId(){return new Date().getTime();},initCharts:function initCharts($canvasChart){var chartOpts=this.getChartParam($canvasChart);if(!chartOpts){return;}
var chartDom=$canvasChart.parent()[0],chartId=this.generateChartId(),chartInstance;$(chartDom).attr('chart-id',chartId);switch(chartOpts.type){case this.chartType.line:chartInstance=this.initChartLine(chartDom,chartOpts);break;case this.chartType.pie:chartInstance=this.initChartPie(chartDom,chartOpts);break;case this.chartType.bar:chartInstance=this.initChartBar(chartDom,chartOpts);break;case this.chartType.scatter:chartInstance=this.initChartScatter(chartDom,chartOpts);break;case this.chartType.area:chartInstance=this.initChartArea(chartDom,chartOpts);break;case this.chartType.table:chartInstance=this.initChartTable(chartDom,chartOpts);break;default:console.log('生成图像错误:没有类型'+chartOpts.type);break;}
if(chartOpts.theme){chartInstance.setTheme(chartOpts.theme);}
if(chartInstance){chartInstance.on("magictypechanged",function(event){if(event.currentType=='line'){this.setOption({tooltip:{axisPointer:{type:'line'}}});}else if(event.currentType=='bar'){this.setOption({tooltip:{axisPointer:{type:'shadow'}}});}});this.chartList[chartId]=chartInstance;this.registerChartResize();}},getChartParam:function getChartParam($chartParam){try{var unitString=$chartParam.html();if(!unitString){return null;}
unitString=unitString.replace(/"/g,"\\\"").replace(/'/g,"\"");return JSON.parse(unitString);}catch(e){console.error(e);return null;}},getChartSeriesData:function getChartSeriesData(type,x,yData,y){var result=[];switch(type){case this.chartType.bar:case this.chartType.line:case this.chartType.scatter:case this.chartType.area:{result=yData;break;}
case this.chartType.pie:{for(var i=0;i<y.length;i++){result.push({name:y[i].name,value:y[i].value});}
break;}
default:{result=yData;}}
return result;},getChartOptsFromParam:function getChartOptsFromParam(chartParam,type){var y=chartParam.chartItems.y,x=chartParam.chartItems.x,series=[],legend=[],chartSeriesData=[],yItem,seriesItem,result,yAxis=[],_this=this;if(x&&x.length&&/(\d{4}-)?\d{2}-\d{2}/.test(x[0])){if(/\d{4}-\d{2}-\d{2}/.test(x[0])){x=x.map(function(item){return timeFormat(item,timeFormatChange('yyyy-mm-dd'));});}else if(/\d{2}-\d{2}/.test(x[0])){x=x.map(function(item){return timeFormat(item,timeFormatChange('mm-dd'));});}}
if(type===this.chartType.pie){legend=x;seriesItem={};seriesItem.name=chartParam.title;seriesItem.data=this.getChartSeriesData(type,x,null,y);seriesItem.type=type;seriesItem.selectedMode='single';series.push(seriesItem);}else{if(!$.isArray(y)){var temp=[];for(var key in y){var obj={name:key,value:y[key],yAxisIndex:0};temp.push(obj);}
y=temp;}
for(var m=0,noMaxNoMinchartSeriesData=[],length=y.length;m<length;m++){yItem=y[m];seriesItem={};seriesItem.yAxisIndex=Number(yItem.yAxisIndex)||0;seriesItem.name=yItem.name;chartSeriesData=this.getChartSeriesData(type,x,yItem.value,yItem);if(chartParam.yMax&&chartParam.yMax.length||chartParam.yMin&&chartParam.yMin.length){noMaxNoMinchartSeriesData=[];for(var i=0,chartDataPush,iLen=chartSeriesData.length;i<iLen;i++){chartParam.yMax.length?chartDataPush=Math.min(chartParam.yMax,chartSeriesData[i]):'';chartParam.yMin.length?chartDataPush=chartParam.yMax.length?Math.max(chartParam.yMin,chartDataPush):Math.max(chartParam.yMin,chartSeriesData[i]):'';noMaxNoMinchartSeriesData.push(chartDataPush);}
seriesItem.data=noMaxNoMinchartSeriesData;}else{seriesItem.data=chartSeriesData;}
if(yItem.stack){seriesItem.stack=yItem.yAxisIndex+yItem.stack;}
if(type===this.chartType.area){seriesItem.type=this.chartType.line;seriesItem.stack=I18n.resource.observer.widgets.TOTAL_AMOUNT;seriesItem.itemStyle={normal:{areaStyle:{type:'default'}}};}else{if(yItem.type){seriesItem.type=yItem.type;}else{seriesItem.type=type;}}
if(yItem.otherOptions){$.extend(seriesItem,yItem.otherOptions);}
seriesItem._name=yItem.name;series.push(seriesItem);legend.push(yItem.name);}
if(!$.isArray(chartParam.Options.y)){yAxis.push({name:chartParam.Options.y,type:'value',scale:true});}else{for(var i=0;i<chartParam.Options.y.length;i++){var yAxisItem={name:chartParam.Options.y[i],type:'value',scale:true};if(!BEOPUtil.isUndefined(chartParam.yMax)&&chartParam.yMax.length){yAxisItem.max=+chartParam.yMax[i];yAxisItem.scale=false;}
if(!BEOPUtil.isUndefined(chartParam.yMin)&&chartParam.yMin.length){yAxisItem.min=+chartParam.yMin[i];yAxisItem.scale=false;}
yAxis.push(yAxisItem);}}}
if(yAxis&&yAxis.length==1){yAxis=yAxis[0];}
var sortedLegend=legend;if(chartParam.chartItems&&chartParam.chartItems.yOrder&&chartParam.chartItems.yOrder.length){sortedLegend=chartParam.chartItems.yOrder;}else{sortedLegend=this._sortLegend(legend);}
result={title:{text:chartParam.title},noDataLoadingOption:{text:I18n.resource.observer.reportScreen.TITLE_NO_DATA,effect:'whirling'},legend:{data:sortedLegend,padding:[-10,5,0,10],itemHeight:10},series:series.sort(function(a,b){return _this._sortFunction(a._name,b._name);}),xAxis:[{scale:true,name:chartParam.Options.x}],yAxis:yAxis};if(x&&x.length>0){result.xAxis[0].data=x;result.xAxis[0].type='category';}else{result.xAxis[0].type='value';}
if(result.xAxis&&result.xAxis.length==1){result.xAxis=result.xAxis[0];}
if(type===this.chartType.pie){delete result.xAxis;delete result.yAxis;}
if(chartParam.commonChartOptions){var convertTheFunction=function convertTheFunction(obj){for(var prop in obj){if(obj.hasOwnProperty(prop)){if(typeof obj[prop]==='string'&&obj[prop].indexOf('function(')!=-1){obj[prop]=eval(obj[prop]);}else if($.isPlainObject(obj[prop])){convertTheFunction(obj[prop]);}}}};try{convertTheFunction(chartParam.commonChartOptions);$.extend(result,chartParam.commonChartOptions);}catch(e){}}
return result;},_sortFunction:function _sortFunction(a,b){var ax=[],bx=[];a.replace(/(\d+)|(\D+)/g,function(_,$1,$2){ax.push([$1||Infinity,$2||""]);});b.replace(/(\d+)|(\D+)/g,function(_,$1,$2){bx.push([$1||Infinity,$2||""]);});while(ax.length&&bx.length){var an=ax.shift();var bn=bx.shift();var nn=an[0]-bn[0]||an[1].localeCompare(bn[1]);if(nn)return nn;}
return ax.length-bx.length;},_sortLegend:function _sortLegend(legend){if(!legend){return[];}
legend.sort(this._sortFunction);var ret=[],splitNum;if(legend.length>15){splitNum=Math.ceil(legend.length/3);}else{splitNum=5;}
for(var i=0,j=legend.length;i<j;i++){ret.push(legend[i]);if((i+1)%splitNum===0){ret.push('');}}
return ret;},initChartLine:function initChartLine(chartDom,chartParam){var _this=this;var x=chartParam.chartItems,y=chartParam.chartItems.y,tooltipRenturnData;var defaultOption={toolbox:{feature:{magicType:{show:true,type:['line','bar','stack','tiled']},dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};if(chartParam.yMax&&chartParam.yMax.length||chartParam.yMax&&chartParam.yMax.length){defaultOption.tooltip={formatter:function formatter(params){var tooltipReturnData='';tooltipReturnData+=x.x[params[0].dataIndex]+'<br/>';for(var i=0;i<params.length;i++){for(var j=0;j<y.length;j++){if(y[j].name==params[i].seriesName){tooltipReturnData+='<div style="display:inline-block;width:10px;width:10px;margin-right:4px;height:10px;border-radius:5px;background-color:'+params[i].color+'"></div>'+params[i].seriesName+' :'+y[j].value[params[i].dataIndex]+'<br />';break;}}}
return tooltipReturnData;}};}
var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.line));if(jscd.mobile){for(var i=0,xLabel;i<option.xAxis[0].data.length;i++){xLabel=option.xAxis[0].data[i].split(' ');if(xLabel.length==2){option.xAxis[0].data[i]=option.xAxis[0].data[i].split(' ')[1].substring(0,5);}}}
var instance=echarts.init(chartDom);instance.setOption(option);return instance;},initChartPie:function initChartPie(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.pieOptionToContent}}},legend:{orient:'vertical',x:'left',y:40}};var option=$.extend(true,defaultOption,this.getChartOptsFromParam(chartParam,this.chartType.pie),this.baseChartOption);if(jscd.mobile){delete option.xAxis;delete option.yAxis;delete option.grid;}
if(!option.tooltip.formatter||$.isEmptyObject(option.tooltip.formatter)){$.extend(true,option,{tooltip:{trigger:'item',formatter:"{a} <br/> {b} : {c} ({d}%)"}});}
var instance=echarts.init(chartDom);instance.setOption(option);return instance;},initChartBar:function initChartBar(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{magicType:{show:true,type:['line','bar','stack','tiled']},dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.bar));var instance=echarts.init(chartDom);if(option.yAxis&&option.yAxis.length==1){delete option.yAxis.scale;}
instance.setOption(option);return instance;},initChartScatter:function initChartScatter(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.scatter));var instance=echarts.init(chartDom);var optsSeries=option.series;Array.isArray(optsSeries)&&_typeof(option.grid)==='object'&&(option.grid.top=Math.floor((isNaN(optsSeries.length)?15:optsSeries.length)/5)*40);instance.setOption(option);return instance;},initChartArea:function initChartArea(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.area));var instance=echarts.init(chartDom);instance.setOption(option);return instance;},initChartTable:function initChartTable(chartDom,chartParam){if(chartParam&&chartParam.chartItems&&chartDom){chartParam.chartItems.title=chartParam.title?chartParam.title:'';chartParam.chartItems.firstColumn=chartParam.Options&&chartParam.Options.x?chartParam.Options.x:'';var $tableContainer=$(beopTmpl('tmpl_table',chartParam.chartItems));if($tableContainer.find('thead th').length>5){$tableContainer.filter('table').attr('style','width:90%');}
$(chartDom).replaceWith($tableContainer);}}};return ReportScreen;}();var DiagnosisScreen=function(){var _this=undefined;function DiagnosisScreen(){this.dictZone=undefined;this.dictEquipment=undefined;this.dictObserverText=undefined;this.arrLastNotice=[];this.workerUpdate=undefined;this.tabelModelData=undefined;this.tableModelUpdate=undefined;this.floorCount=0;this.dialog=undefined;this.langCfg=I18n.resource.diagnosis.config;this.noticeId=0;this.faId=0;this.faUserId=0;this.obScreen=undefined;this.$obContainer=undefined;this.urgentCount=0;this.criticalCount=0;this.judgeProjectId=AppConfig.projectId==80;_this=this;}
DiagnosisScreen.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/diagnosisScreen.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);I18n.fillArea($(ElScreenContainer));Spinner.spin(ElScreenContainer);_this.init();});},close:function close(){this.dictZone=null;this.dictEquipment=null;this.dictObserverText=null;this.tabelModelData=null;this.arrLastNotice=null;this.floorCount=null;if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;if(this.tableModelUpdate)this.tableModelUpdate.terminate();this.tableModelUpdate=null;if(this.dialog)this.dialog.close();if(this.obScreen)this.obScreen.close();if(ToolCurrent)ToolCurrent.close();$("#dialogContent").empty();},onresize:function onresize(){ScreenCurrent.obScreen.resize();},init:function init(){var side=new SidebarMenuEffect();side.init('#divCanvas');this.$obContainer=$('#obContainer');this.dictObserverText={};var _this=this;WebAPI.get('/diagnosis/getStruct/'+AppConfig.projectId).done(function(result){_this.result=result;_this.initStructData(result);_this.initPaneNav();if(_this.judgeProjectId){_this.changeModal();}
if(_this.judgeProjectId){$('#btnChangeModal').show().off('click').click(function(){var $tabelModelPanel=$('#panelIconNew');if($tabelModelPanel[0].style.display=='none'||$tabelModelPanel[0].style.display==''){Spinner.spin(ElScreenContainer);_this.tableModelDataUpdating();$tabelModelPanel.show();$('#errTipNew').hide();$('.tdFirst').off('click').click(function(e){var id=e.target.getAttribute('pageId');if(id){if(_this.obScreen===undefined){tabelModelClose();_this.showObserver(_this,id);}else if(_this.obScreen.id===id){tabelModelClose();return;}else{tabelModelClose();_this.obScreen.close();_this.showObserver(_this,id);}}else{tabelModelClose();alert('This floor has no details');}});$('.tdFirst').hover(function(){$(this).parent('tr').children('td:not(:first)').addClass('tdShadow');$(this).addClass('tdFirstHover');},function(){$(this).removeClass('tdFirstHover');$(this).parent('tr').children('td:not(:first)').removeClass('tdShadow');});}else{tabelModelClose();}});}
$('.subBuildingBtn','#paneIcon').eq(0).trigger('click');$('.div-nav-row','#paneIcon').eq(0).children('span:first').trigger('click');});function tabelModelClose(){$('#panelIconNew').hide();if(_this.tableModelUpdate)_this.tableModelUpdate.terminate();_this.tableModelUpdate=null;}
if(_this.judgeProjectId){$('#divPaneNotice').find('div.panel-body:eq(0)').addClass('noticeAll');var $reuseDemand=$('<div id="reuseDemand" class="panel-body gray-scrollbar"></div>');$('#divPaneNotice').append($reuseDemand);}
$("#btnNoticeHistory").off().click(function(e){ScreenModal=new DiagnosisLogHistory(_this);ScreenModal.show();});$("#btnNoticeConfig").off().click(function(e){ScreenModal=new DiagnosisConfig(_this);ScreenModal.show();});$('#btnWarningLog').off().click(function(){var $diagnosisLogCt=$('#diagnosisLogCt');var $btnPin=$('#btnStickyPost');if($diagnosisLogCt.is(':hidden')){viewLog(this);if(_this.judgeProjectId){$('#reuseDemand').hide();$('#divPaneNotice .noticeAll').show();}
$btnPin.show();$diagnosisLogCt.slideDown();}else{$btnPin.hide();$diagnosisLogCt.hide();$('#divCanvas').attr('class','col-sm-12');}});$('#btnStickyPost').off().click(function(){var $divCanvas=$('#divCanvas');$divCanvas.attr('class',$divCanvas.hasClass('col-sm-12')?'col-sm-9':'col-sm-12');window.setTimeout(function(){_this.obScreen.resize();},500);});function viewLog(obj){var $diagnosisLogCt=$('#diagnosisLogCt');if($diagnosisLogCt.is(':hidden')){$diagnosisLogCt.slideDown();}}
$('#btnChangeAlarm').click(function(e){var $this=$(this);var level=parseInt($('#selectAlarmLevel').find('option:selected').attr('setval'));var delayVal=$('#selectAlarmTime').find('option:selected').attr('setval');var changeVal=$('#dlgChangeRule').find('#selectAlarmLevel option:selected').html();var $changeEle,$changeSpan;var now=new Date().getTime();var time,status=0;if(0==delayVal){time=new Date(now);status=1;}else if(1==delayVal){time=new Date(now+3600000);}else if(2==delayVal){time=new Date(now+43200000);}else if(3==delayVal){time=new Date(now+86400000);}else if(4==delayVal){time=new Date(now+604800000);}else if(5==delayVal){time=new Date(now);time.setMonth(now.getMonth()+1);}else if(6==delayVal){time=new Date(now+999999999);}
time=time.format("yyyy-MM-dd HH:mm:ss");var postData={'id':_this.faId,'userId':_this.faUserId,'isUserDefined':true,'userFaultGrade':level,'userFaultDelay':time,status:status};var text=$this.text();$this.prop('disabled',true);WebAPI.post('/diagnosis/fault/customUpdate/'+AppConfig.projectId,postData).done(function(result){var data=result;if(data){var $divFault=$('#divPaneNoticeItem div[faultid="'+_this.faId+'"]');for(var i=0;i<_this.arrLastNotice.length;i++){if(_this.arrLastNotice[i].id==_this.noticeId){_this.arrLastNotice[i].grade=level;}}
if(_this.obScreen.dictTexts){var modelTextId=$divFault.attr('data-modaltextid');if(_this.obScreen.dictTexts[modelTextId]){_this.obScreen.dictTexts[modelTextId].updateDiagnosisGrade(level);}
if(status==0){_this.criticalCount--;$('#btnWarningLog .badge').html(_this.criticalCount);$divFault.remove();}}}}).error(function(result){}).always(function(e){$('#dlgChangeRule').modal('hide');$('#dlgChangeRule').one('hidden.bs.modal',function(){$this.text(text).prop('disabled',false);});});$changeEle=$('.div-pane-log[faultid='+_this.noticeId+']');$changeSpan=$changeEle.find('div:first-child').find('span:first-child');$changeSpan.html(changeVal);if($changeEle.hasClass('adNormal')){if(changeVal!==_this.langCfg.LEVEL_SET.CRITICAL){$changeEle.removeClass('adNormal').addClass('faultPro');$changeSpan.css('background-color','rgba(217, 83, 79, 0.9)');}}else{if(changeVal!==_this.langCfg.LEVEL_SET.URGENT){$changeEle.removeClass('faultPro').addClass('adNormal');$changeSpan.css('background-color','rgba(240, 173, 78, 0.9)');}}});var $flootCt=$('#floorCt');var $floorPB=$flootCt.find('.showCont');var $floorPH=$flootCt.find('.panel-default');$flootCt.find('.panel-heading').off('click').click(function(){$floorPH.hide();$floorPB.show();});$floorPB.off('click').click(function(){$(this).hide();$floorPH.show();});},initStructData:function initStructData(data){var item,arr;this.dictZone=new Object();this.dictEquipment=new Object();this.buildings=[];arr=data.equipments;for(var i=0,len=arr.length;i<len;i++){item=arr[i];item.faultIds=new Array();this.dictEquipment[item.id]=item;}
arr=data.zones;this.floorCount=arr.length;var index=-1,tempBuildingId=undefined;for(var i=0,len=arr.length;i<len;i++){item=arr[i];var equipments=[];for(var j=0;j<data.equipments.length;j++){if(data.equipments[j].zoneId==item.id){equipments.push({equipmentId:data.equipments[j].id,equipmentName:data.equipments[j].name});}}
this.dictZone[item.id]=item;if(tempBuildingId!=item.buildingId){tempBuildingId=item.buildingId;index++;var building={buildId:item.buildingId,buildName:item.buildingName,subBuilds:[{subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}]};this.buildings.push(building);}else{var subBuilding={subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments};this.buildings[index].subBuilds.push(subBuilding);}}},initWorkerForUpdating:function initWorkerForUpdating(){if(this.workerUpdate){this.workerUpdate.terminate();}
this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e);},true);this.workerUpdate.postMessage({projectId:AppConfig.projectId,type:"diagnosisScreen",zoneId:AppConfig.zoneId});},tableModelDataUpdating:function tableModelDataUpdating(){this.tableModelUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.tableModelUpdate.self=this;this.tableModelUpdate.addEventListener("message",this.refreshTableModelData,true);this.tableModelUpdate.addEventListener("error",function(e){console.log(e);Spinner.stop();},true);this.tableModelUpdate.postMessage({pointList:this.tabelModelData,projectId:AppConfig.projectId,type:"dataRealtime"});},initObScreen:function initObScreen(){this.obScreen.isInDiagnosis=true;this.obScreen.diagScreen=this;},resetFloor:function resetFloor(){this.refreshData({data:{notice:this.arrLastNotice}},true);},clearNullArr:function clearNullArr(arr){for(var i=0,len=arr.length;i<len;i++){if(arr[i]==""||typeof arr[i]=="undefined"){arr.splice(i,1);len--;i--;}}
return arr;},gradientColors:function gradientColors(colorArr,$gradientDom,valueCurrent,max,min){var valueMark=(max-min)/(colorArr.length-1);var regexp=/[0-9]{0,3}/g;for(var i=0;i<colorArr.length-1;i++){var colorMaxValue=min+(i+1)*valueMark;if(valueCurrent>colorMaxValue)continue;var colorSelPre=colorArr[i];var colorSelTo=colorArr[i+1];var colorValPreArr=[];colorValPreArr=colorSelPre.match(regexp);_this.clearNullArr(colorValPreArr);var colorValToArr=[];colorValToArr=colorSelTo.match(regexp);_this.clearNullArr(colorValToArr);var colorMinValue=min+i*valueMark;if(i==colorArr.length-2){colorMaxValue=max;}
if(valueCurrent<=colorMaxValue){$gradientDom.css('background','rgb('+(parseInt((parseInt(colorValToArr[0]-colorValPreArr[0])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[0]))+','+(parseInt((parseInt(colorValToArr[1]-colorValPreArr[1])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[1]))+','+(parseInt((parseInt(colorValToArr[2]-colorValPreArr[2])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[2]))+')');i=colorArr.length-1;}}},refreshTableModelData:function refreshTableModelData(e){var dataNumber=e.data,resultName=undefined;for(var beforeN in dataNumber){if(dataNumber[beforeN].name.split('_')[2]=='InFiAvT'){var buildNum=dataNumber[beforeN].name.split('_')[0].substring(0,2);var zoneNum=dataNumber[beforeN].name.split('_')[1].substring(6,8);var beforeValue=dataNumber[beforeN].value?parseFloat(dataNumber[beforeN].value):0;var valueCurrent;for(var resultN in dataNumber){resultName=dataNumber[resultN].name;var afterValue=dataNumber[resultN].value?parseFloat(dataNumber[resultN].value):0;if(resultName.split('_')[2]=='OutFiAvT'&&resultName.split('_')[0].substring(0,2)==buildNum&&resultName.split('_')[1].substring(6,8)==zoneNum){valueCurrent=parseInt(((afterValue+beforeValue)/2).toFixed(0));$('.rc'+buildNum+'_'+zoneNum).html(valueCurrent);if(valueCurrent===0){$('.rc'+buildNum+'_'+zoneNum).css('background','#d0d0d0');}else{_this.gradientColors(['rgb(0,0,255)','rgb(255,255,255)','rgb(255,0,0)'],$('.rc'+buildNum+'_'+zoneNum),valueCurrent,24,16);}}}}}
Spinner.stop();},refreshData:function refreshData(e,isOnlyRenderDictFault){if(!e.data||$.isEmptyObject(e.data)||e.data.error){Spinner.stop();}
_this=this.self?this.self:this;if(e.data.notice&&e.data.notice[0]){_this.arrLastNotice=e.data.notice;var existedIds=[];for(var i in _this.arrLastNotice){existedIds.push(_this.arrLastNotice[i].id);}
if($.inArray(e.data.notice[0].id,existedIds)<0){Array.prototype.push.apply(e.data.notice,_this.arrLastNotice);_this.arrLastNotice=e.data.notice;}
for(var key in _this.dictEquipment){_this.dictEquipment[key].faultIds=new Array();}
try{var dictFaultHighestGrade={};for(var i=0;i<e.data.notice.length;i++){var faultId=e.data.notice[i].faultId,equipmentId=e.data.notice[i].equipmentId;var grade;var eq=_this.dictEquipment[equipmentId];eq.faultIds.push(faultId);grade=dictFaultHighestGrade[eq.modalTextId];if(!grade||e.data.notice[i].grade>grade)dictFaultHighestGrade[eq.modalTextId]=e.data.notice[i].grade;}
for(var key in dictFaultHighestGrade){if(_this.dictObserverText[key])_this.dictObserverText[key].updateDiagnosisGrade(dictFaultHighestGrade[key]);}
typeof _this.obScreen.onUpdateFaultsCallback==='function'&&_this.obScreen.onUpdateFaultsCallback(e.data.notice);}catch(e){console.log(e);}
$('#spinnerLoadingNotice').remove();$('#btnWarningLog').fadeIn();}else{$('#spinnerLoadingNotice').remove();}
Spinner.stop();if(isOnlyRenderDictFault)return;$('.badge.warningCount','#paneIcon').empty();$('.badge.alertCount','#paneIcon').empty();if(e.data.count&&e.data.count instanceof Array){e.data.count.forEach(function(obj){for(var i in obj){var warningCount=parseInt(obj[i].warning);var alertCount=parseInt(obj[i].alert);var $targetWarning=$('#navFloor-'+i).next('.warningCount');var $targetAlert=$('#navFloor-'+i).siblings('.alertCount');if(warningCount>0){$targetWarning.html(warningCount);}else{$targetWarning.html('');}
if(alertCount>0){$targetAlert.html(alertCount);}else{$targetAlert.html('');}}});}
_this.statisticFaultCount();_this.renderPaneNoticeGroup();},initPaneNav:function initPaneNav(){var _this=this;var pane=document.createElement('div');var div,zoneItem,itemI,itemJ;var zoneItemList=[];var $buildingBox,$subBuilding=$('.subBuilding'),$subBuildingList,countHtml;for(var zoneId in this.dictZone){zoneItem=this.dictZone[zoneId];zoneItemList.push(zoneItem);}
var paneIcon=document.getElementById('paneIcon');paneIcon.innerHTML="";paneIcon.appendChild(pane);for(var i=0;i<zoneItemList.length;i++){countHtml='';var isSameBuild=false;itemI=zoneItemList[i];for(var j=0;j<zoneItemList.length;j++){itemJ=zoneItemList[j];if(itemI.buildingId==itemJ.buildingId){isSameBuild=true;break;}}
if(isSameBuild){$buildingBox=$('.div-nav-box'+itemI.buildingId);if($buildingBox.length===0){$buildingBox=$('<div class="div-nav-box'+itemI.buildingId+'"><span id="building_'+itemI.buildingId+'" class="grow subBuildingBtn"></span><span class="badge warningCount"></span><span class="badge alertCount"></span></div>');$buildingBox.find('#building_'+itemI.buildingId).html(itemI.buildingName);$subBuildingList=$('<div class="subBuildingList" id="subList_'+itemI.buildingId+'"></div>');$buildingBox.append($subBuildingList);$(pane).append($buildingBox);}
countHtml='<span class="badge warningCount"></span><span class="badge alertCount"></span>';var $subBuildings=$('#subList_'+itemI.buildingId).children('.subBuilding');var countArry=[];for(var k=0;k<$subBuildings.length;k++){countArry.push(parseInt($($subBuildings[k]).attr('count')));}
if(countArry.length===0||itemI.count>countArry[countArry.length-1]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$('#subList_'+itemI.buildingId).append($subBuilding);}else{for(var q=0;q<countArry.length;q++){if(itemI.count<countArry[q]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$($subBuildings[q]).before($subBuilding);break;}else if(itemI.count===countArry[q]){if(countArry[q]===countArry[countArry.length-1]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$('#subList_'+itemI.buildingId).append($subBuilding);break;}else{for(var p=q;p<countArry.length;p++){if(itemI.count<countArry[p]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$($subBuildings[p]).before($subBuilding);break;}}
break;}}}}
$subBuilding.find('.subBuildingItem').off('click').click(function(){var id=$(this).attr('pageId');if(AppConfig.projectId==80){$('#panelIconNew').hide();}
AppConfig.zoneId=this.id.split('-')[1];$('.subBuildingItem.selected').removeClass('selected');$(this).addClass('selected');if(id){if(_this.obScreen===undefined){_this.showObserver(_this,id);}else if(_this.obScreen.id===id){return;}else{_this.obScreen.close();_this.showObserver(_this,id);}}else{alert('This floor has no details');}
_this.arrLastNotice.length=0;_this.initWorkerForUpdating();});}}
$('.subBuildingBtn').off('click').click(function(){$(this).toggleClass('selected');var $subBuildListCur=$(this).siblings('.subBuildingList');if($subBuildListCur.is(':visible')){$subBuildListCur.hide();}else{$subBuildListCur.show();}});},statisticFaultCount:function statisticFaultCount(){$('[class ^="div-nav-box"]').each(function(){var warningCount=0,alertCount=0;$(this).children('.subBuildingList').find('.warningCount').not(':empty').each(function(){var text=$(this).text();if(Number(text).toString()!='NaN'){warningCount+=parseInt(text);}});if(warningCount>0){$(this).children('.warningCount').html(warningCount);}else{$(this).children('.warningCount').html('');}
$(this).children('.subBuildingList').find('.alertCount').not(':empty').each(function(){var text=$(this).text();if(Number(text).toString()!='NaN'){alertCount+=parseInt(text);}});if(alertCount>0){$(this).children('.alertCount').html(alertCount);}else{$(this).children('.alertCount').html('');}});},changeModal:function changeModal(){var _this=this;var $spanRow,$spanCeil,item,$spanRowOne;var $tabelModelPanel=$('#panelIconNew');var inFiAvTDt,outFiAvTDt;var requestData=[];$tabelModelPanel=$('<div id="panelIconNew" class="col-sm-12"><table></table></div>');var $tabelHead=$('<tr class="tabelHead"></tr>');for(var k=19;k>0;k--){$spanRowOne=$('<td></td>');if(k==19){$spanRowOne.html('');}else{$spanRowOne.html(k);}
$tabelHead.append($spanRowOne);}
$tabelModelPanel.find('table').append($tabelHead);for(var i=44;i>0;i--){$spanRow=$('<tr></tr>');if(i<10){i='0'+i;}
for(var j=19;j>0;j--){$spanCeil=$('<td></td>');if(j==19){$spanCeil.html(i+'F');$spanCeil.addClass('tdFirst');if(i==44){$spanCeil.attr('pageId','1');}else if(i==43){$spanCeil.attr('pageId','2');}else if(i==42){$spanCeil.attr('pageId','120000221');}else if(i==41){$spanCeil.attr('pageId','100000173');}else if(i==15){$spanCeil.attr('pageId','20000027');}else if(i==16){$spanCeil.attr('pageId','20000028');}}else{if(j<10){j='0'+j;}
inFiAvTDt=i+'F_Zone00'+j+'_InFiAvT';outFiAvTDt=i+'F_Zone00'+j+'_OutFiAvT';requestData.push(inFiAvTDt);requestData.push(outFiAvTDt);$spanCeil.addClass('rc'+i+'_'+j);$spanCeil.addClass('tdData');}
$spanRow.append($spanCeil);}
$tabelModelPanel.find('table').append($spanRow);}
this.tabelModelData=requestData;$tabelModelPanel.insertBefore($('#divCanvas'));},createWorkflowOrder:function createWorkflowOrder(notice){var wiInstance;var momentTime=notice.time.toDate();var back=function back(){wiInstance=null;};var insertCallback=function insertCallback(taskModelInfo){Alert.success(ElScreenContainer,I18n.resource.workflow.main.THE_WORK_ORDER+' '+(taskModelInfo?taskModelInfo.title:'')+' '+I18n.resource.workflow.main.IS_CREATED_SUCCESSFULLY).showAtTop(2000);var $faultCount=$('#btnWarningLog .badge');var faultCount=function(txt){if(parseInt(txt).toString()!="NaN"){return parseInt(txt);}
return 0;}($faultCount.text());if(faultCount>0){var count=faultCount-1;count=count>0?count:'';$faultCount.text(count);$('[noticeid="'+notice.id+'"]').remove();if(notice.grade===1){var $warningCount=$('#navFloor-'+AppConfig.zoneId).next('.warningCount');$warningCount.text($warningCount.text()-1);}else if(notice.grade===2){var $alertCount=$('#navFloor-'+AppConfig.zoneId).siblings('.alertCount');$alertCount.text($alertCount.text()-1);}}};var str=notice.description;var arr=notice.detail?notice.detail.split(','):[];var matchRt=str.match(/\{\d\}/g);if(matchRt&&matchRt instanceof Array){matchRt.forEach(function(val,index){str=str.replace(val,arr[index]?arr[index]:'');});}
wiInstance=new WorkflowInsert({noticeId:notice.id,title:notice.name,detail:notice.description,dueDate:new Date(+new Date()+172800000).format('yyyy-MM-dd'),critical:notice.grade,projectId:Number(notice.project),chartPointList:notice.points,chartQueryCircle:'m5',description:str,name:notice.name,time:new Date(momentTime).format('yyyy-MM-dd HH:mm:ss'),chartStartTime:new Date(new Date(momentTime).getTime()-12*60*60*1000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(new Date(momentTime).getTime()+12*60*60*1000).format('yyyy-MM-dd HH:mm:ss')});wiInstance.show().submitSuccess(function(taskModelInfo,uploadFiles){insertCallback(taskModelInfo);this.close();back();}).cancel(function(){back();}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.workflow.main.CREATE_WORKFLOW_FAILED).showAtTop(2000);});return true;},renderPaneBuilding:function renderPaneBuilding(notice,equipment,zone){var element=document.getElementById('div-floor-'+equipment.zoneId);if(!element)return;var divIcon=$('#div-floor-icon-'+zone.id+'-'+equipment.id);var color;switch(notice.grade){case 0:color='window';break;case 1:color='rgb(238, 170, 100)';break;case 2:color='rgb(200, 100, 100)';break;default:break;}
if(color){element.style.backgroundColor=color;divIcon.css('background-color',color);}
var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip">');sb.append('    <div class="tooltipTitle tooltip-inner">Equipment</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">Name: <span style="font-weight: bold;">').append(equipment.name).append('</span></p> ');sb.append('        <p style="white-space:nowrap;">System: <span style="font-weight: bold;">').append(equipment.systemName).append('</span></p> ');sb.append('        <p style="white-space:nowrap;">Subsystem: <span style="font-weight: bold;">').append(equipment.subSystemName).append('</span></p> ');sb.append('        <p style="white-space:nowrap;">Faults:</p> ');for(var i=0;i<equipment.faultIds.length;i++){sb.append('<p style="margin-left: 20px; white-space:nowrap;"><span style="font-weight: bold;">').append(this.dictFault[equipment.faultIds[i]].name);for(var j=0;j<this.arrLastNotice.length;j++){var noticeTemp=this.arrLastNotice[j];if(noticeTemp.faultId==equipment.faultIds[i]){if(noticeTemp.status&&noticeTemp.status!=''&&noticeTemp.status!=0){sb.append(' (').append(noticeTemp.status).append(')');}}}
sb.append('</span></p> ');}
sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={title:'Equipment',template:sb.toString()};divIcon.tooltip(options);},renderPaneNav:function renderPaneNav(notice,equipment){var element=document.getElementById('spanNav-icon-'+equipment.zoneId+'-'+equipment.id);$(element).attr('data-modaltextid',equipment.modalTextId);},showEquipmentDetail:function showEquipmentDetail(equipmentId){this.dialog=new ObserverScreen(this.dictEquipment[equipmentId].pageId);this.dialog.isDetailPage=true;this.dialog.show();},showZoneDetail:function showZoneDetail(zoneId){},renderPaneNoticeGroup:function renderPaneNoticeGroup(){var _this=this;var urgentCount=0,criticalCount=0,className;this.insertLogGroup();var item,parent;for(var i=0,len=_this.arrLastNotice.length;i<len;i++){item=_this.arrLastNotice[i];var grade=item.grade;if(1==grade){className='adNormal';criticalCount++;}else if(2==grade){className='faultPro';urgentCount++;}else{continue;}
_this.insertLogItem(item,i,className);}
_this.criticalCount=_this.arrLastNotice.length;if(_this.criticalCount>0){$('#btnWarningLog').find('.badge').html(_this.criticalCount);}else{$('#btnWarningLog').find('.badge').html('');}
var $btnErr=$('#abNomalP');if($btnErr&&$btnErr.length>0){$btnErr.change();}},insertLogGroup:function insertLogGroup(){var $abNomalP=$('#abNomalP');var $faultP=$('#faultP');var $divPaneNoticeItem=$('#divPaneNoticeItem');$divPaneNoticeItem.children().remove();$abNomalP.on('change',function(){var $adNormalOne=$divPaneNoticeItem.find('.adNormal');var $faultProOne=$divPaneNoticeItem.find('.faultPro');if($abNomalP.is(':checked')&&$faultP.is(':checked')||!$abNomalP.is(':checked')&&!$faultP.is(':checked')){$adNormalOne.show();$faultProOne.show();}else if($abNomalP.is(':checked')&&!$faultP.is(':checked')){$adNormalOne.show();$faultProOne.hide();}else if(!$abNomalP.is(':checked')&&$faultP.is(':checked')){$adNormalOne.hide();$faultProOne.show();}});$faultP.on('change',function(){var $adNormalTwo=$divPaneNoticeItem.find('.adNormal');var $faultProTwo=$divPaneNoticeItem.find('.faultPro');if($abNomalP.is(':checked')&&$faultP.is(':checked')||!$abNomalP.is(':checked')&&!$faultP.is(':checked')){$adNormalTwo.show();$faultProTwo.show();}else if($abNomalP.is(':checked')&&!$faultP.is(':checked')){$adNormalTwo.show();$faultProTwo.hide();}else if(!$abNomalP.is(':checked')&&$faultP.is(':checked')){$adNormalTwo.hide();$faultProTwo.show();}});},insertLogItem:function insertLogItem(item,itemNum,className){var divParent=$('#divPaneNoticeItem');var _this=this;var divNotice,equipment,zone,sb,span,textId,spanFirst;equipment=this.dictEquipment[item.equipmentId];textId=equipment.modalTextId;zone=this.dictZone[equipment.zoneId];divNotice=document.createElement('div');divNotice.id='divLog-'+itemNum;divNotice.setAttribute('path',zone.id+'-'+equipment.id);divNotice.setAttribute('faultid',item.faultId);divNotice.setAttribute('noticeId',item.id);if(textId!==null)divNotice.setAttribute('data-modaltextid',textId);divNotice.className='div-pane-log';$(divNotice).addClass(className);divNotice.onmouseenter=function(e){var $this=$(e.currentTarget);var modalTextId=$this.attr('data-modaltextid');var pageId=$this.children('[pageid]').attr('pageid');if(modalTextId===undefined||_this.obScreen===undefined)return;if(_this.obScreen.id!==pageId)return;_this.obScreen.showErrTip&&_this.obScreen.showErrTip(modalTextId);};divNotice.onmouseleave=function(e){var $this=$(e.currentTarget);var modalTextId=$this.attr('data-modaltextid');var pageId=$this.children('[pageid]').attr('pageid');if(modalTextId===undefined||_this.obScreen===undefined)return;if(_this.obScreen.id!==pageId)return;_this.obScreen.hideErrTip&&_this.obScreen.hideErrTip(modalTextId);};var parent=$(divNotice);var $spWrap=$('<div style="white-space: nowrap;">');sb=new StringBuilder();sb.append(item.name);if(item.status&&item.status!=''&&item.status!=0){sb.append(' (').append(item.status).append(')');}
spanFirst=$('<span>').addClass('badge').css('color','#fff');switch(item.grade){case 0:break;case 1:spanFirst.css('background-color','rgba(240, 173, 78, 0.9)').html(_this.langCfg.LEVEL_SET.CRITICAL);break;case 2:spanFirst.css('background-color','rgba(217, 83, 79, 0.9)').html(_this.langCfg.LEVEL_SET.URGENT);break;default:break;}
$spWrap.append(spanFirst);span=$('<span>').addClass('badge grow span-hover-pointer').attr('title','Equipment name').attr('equipment',equipment.pageId).text(equipment.name);span.click(function(e){this.dialog=new ObserverScreen(e.currentTarget.getAttribute('equipment'));this.dialog.isDetailPage=true;this.dialog.show();});$spWrap.append(span);$('<span>').addClass('badge grow span-hover-pointer').attr({'pageId':zone.pageId,'title':'Zone ID','data-zoneId':zone.id}).text(zone.subBuildingName).click(function(e){var pageId=e.currentTarget.getAttribute('pageId');var zoneId=e.currentTarget.getAttribute('data-zoneId');if(pageId&&pageId!=''&&pageId!=0){$('#navFloor-'+zoneId).click();}else{alert('This floor has no details');}}).appendTo($spWrap);$('<span>').attr({'title':'Triggering time','data-time':item.time}).text(timeFormat(item.time,timeFormatChange('mm-dd hh:ii'))).css({'text-decoration':'underline','font-weight':'bold','color':'#F0AD4E','text-shadow':'2px 2px 1px rgba(50,50,50,0.2)'}).appendTo($spWrap);$('<span>').addClass('glyphicon glyphicon-ok-sign grow span-hover-pointer span-btn').attr('title','Check').click(function(e){var $pane=$(e.currentTarget).closest('.div-pane-log');var noticeId=$pane.attr('noticeId');var faultId=$pane.attr('faultId');var item;for(var i=0;i<_this.arrLastNotice.length;i++){if(_this.arrLastNotice[i].id==noticeId)item=_this.arrLastNotice[i];}
if(item){_this.noticeId=noticeId;_this.faId=faultId;_this.faUserId=AppConfig.userId;var level=item.grade;var selectLevel=$('#selectAlarmLevel');if(0==level){selectLevel.val(_this.langCfg.LEVEL_SET.NORMAL);}else if(1==level){selectLevel.val(_this.langCfg.LEVEL_SET.CRITICAL);}else if(2==level){selectLevel.val(_this.langCfg.LEVEL_SET.URGENT);}else{selectLevel.val(_this.langCfg.LEVEL_SET.NORMAL);}
var selectTm=$('#selectAlarmTime');selectTm.val(_this.langCfg.defaultPeriod.DELAY_FOREVER);}
$('#dlgChangeRule').modal('show');}).appendTo($spWrap);if(item.orderId&&item.orderId!=0&&item.orderId!=''){$('<span>').addClass('glyphicon glyphicon-tags grow span-hover-pointer span-btn').attr('title','Show workflow order').attr('workflow',item.orderId).click(function(e){if(ScreenCurrent)ScreenCurrent.close();ScreenManager.show(beop.main,e.currentTarget.getAttribute('workflow'));}).appendTo($spWrap);}else{$('<span>').addClass('glyphicon glyphicon-share grow span-hover-pointer span-btn').attr('title','Create workflow order').click(function(e){_this.createWorkflowOrder(item);}).appendTo($spWrap);}
$('<span class="glyphicon glyphicon-comment grow span-hover-pointer span-btn" title="feedback">').click(function(e){WebAPI.get("/static/views/workflow/temp_user_comments.html").done(function(resultHtml){var $dialog=$('#dialogModal').find('#dialogContent').empty().html(resultHtml).end();$dialog.find('#feedbackTitle').text(item.name);$dialog.find('#feedbackCritical').text(I18n.resource.workflow.urgencyLevel[item.grade]);$dialog.find('#feedbackDetail').text(item.description);$dialog.modal();var curveInfo={projectId:Number(item.project),chartPointList:item.points,chartQueryCircle:'m5',chartStartTime:new Date(new Date(item.time.toDate()).getTime()-43200000).format(DateUtil.DATA_FORMAT.FULL_DATETIME),chartEndTime:new Date(new Date(item.time.toDate()).getTime()+43200000).format(DateUtil.DATA_FORMAT.FULL_DATETIME)};if(item.points){beop.view.faultCurve.configModel({transactions_model:beop.model.transactionsModel});beop.view.faultCurve.init($dialog.find('.fault-feedback-curve'),curveInfo);}else{$dialog.find('.fault-feedback-curve').hide();}
I18n.fillArea($dialog);$dialog.find('form').submit(function(){var itemEquipmentId=item.equipmentId;var diagnosisLength=_this.result.equipments.length;for(var i=0;i<diagnosisLength;i++){if(itemEquipmentId==_this.result.equipments[i].id){var currentEquipmentName=_this.result.equipments[i].name;break;}}
var formMap={'executor[]':[1],detail:I18n.resource.workflow.main.ORDER_EQUIPMENT_NAME+currentEquipmentName+"\n"+I18n.resource.workflow.main.ORDER_FAULT_INFO+item.description+"\n"+I18n.resource.workflow.main.ORDER_FEEDBACK_MSG+$('#commentsContent').val(),userId:AppConfig.userId,title:I18n.resource.workflow.main.FEEDBACK_TITLE+item.name,critical:item.grade,dueDate:new Date(new Date().getTime()+2592000000).format(DateUtil.DATA_FORMAT.FULL_DATETIME)};$.extend(formMap,curveInfo);Spinner.spin(document.body);WebAPI.post('/workflow/transaction/new/',formMap).done(function(result){if(result.success){$dialog.modal('hide');alert(I18n.resource.workflow.main.FEEDBACK_SUCCESS);}else{alert.danger('feedback failed');}}).always(function(){Spinner.stop();});});});}).appendTo($spWrap);parent.append($spWrap);$('<p>').addClass('pFaultName').css({'font-weight':'bold','padding':'0 8px 0 0'}).text(item.name).appendTo(parent);var strDesc=item.description;if(item.detail){var arr=item.detail.toString().split(',');for(var j=0;j<arr.length;j++){strDesc=strDesc.replace('{'+j.toString()+'}','<span class="variable"> '+arr[j]+' </span>');}}
if(item.energy&&parseFloat(item.energy)>0){strDesc+='<span style="margin-left:10px;">('+I18n.resource.diagnosis.diagnosticLog.ENERGY_CONSSERVATION+item.energy+'kWh)</span>';}
$('<p>').html(strDesc).appendTo(parent);divParent.append(parent);_this.renderPaneBuilding(item,item,equipment,zone);_this.renderPaneNav(item,item,equipment);},showObserver:function showObserver(_this,id){var $container;if(id.length&&id.length==24){_this.$obContainer.children('#divMain').hide();$container=_this.$obContainer.children('#pageContainer').show();Spinner.spin($container[0]);_this.obScreen=new observer.screens.PageScreen({'id':id},$container[0]);_this.obScreen.show();}else{_this.$obContainer.children('#divMain').show();_this.$obContainer.children('#pageContainer').hide();_this.obScreen=new ObserverScreen(id);_this.initObScreen();_this.obScreen.show(_this.$obContainer[0]);}}};return DiagnosisScreen;}();var DataCenter3D=function(){function Room(domElement,dataSource){this.scene=null;this.camera=null;this.renderer=null;this.controls=null;this.domElement=domElement;this.dataSource=dataSource;this.data=null;this.projector=new THREE.Projector();this.raycaster=new THREE.Raycaster();this.mouse=new THREE.Vector2();this.stats=null;this.INTERSECTED=null;this.cameraHelper=null;}
Room.prototype={initScene:function initScene(){this.scene=new THREE.Scene();this.scene.rotation.x=Math.PI/2;},initCamera:function initCamera(){this.camera=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,200000);this.resetView();this.camera.up=new THREE.Vector3(0,0,1);this.scene.add(this.camera);},initRender:function initRender(){this.renderer=new THREE.WebGLRenderer({antialias:true});this.renderer.setSize(window.innerWidth,window.innerHeight);this.renderer.setClearColor(0xf0f0f0,1);this.renderer.gammaInput=true;this.renderer.gammaOutput=true;this.renderer.shadowMapEnabled=true;this.domElement.appendChild(this.renderer.domElement);},initControl:function initControl(){this.controls=new THREE.TrackballControls(this.camera);this.controls.staticMoving=true;this.controls.addEventListener('change',this.render.bind(this));},initLight:function initLight(){var light_ambient=new THREE.AmbientLight(0x000000);this.scene.add(light_ambient);var hemiLight=new THREE.HemisphereLight(0xffffff,0xffffff,0.6);hemiLight.color.setHSL(0.6,1,0.6);hemiLight.groundColor.setHSL(0.095,1,0.75);hemiLight.position.set(0,0,500);this.scene.add(hemiLight);var light=new THREE.DirectionalLight(0xffffff,2.25);light.position.set(0,450,500);light.castShadow=true;light.shadowMapWidth=1024;light.shadowMapHeight=1024;this.scene.add(light);},initStats:function initStats(){this.stats=new Stats();this.stats.domElement.style.position='absolute';this.stats.domElement.style.bottom='0px';this.stats.domElement.style.zIndex=100;this.domElement.appendChild(this.stats.domElement);},initObjects:function initObjects(){if(!this.data){return;}
var units=this.data.units,unitItem;for(var n=0,length=units.length;n<length;n++){unitItem=units[n];var unitObj=this.executeUnitType(unitItem.type,unitItem,this);unitObj.castShadow=true;unitObj.receiveShadow=true;this.scene.add(unitObj);}
var gt=THREE.ImageUtils.loadTexture("/static/scripts/dataCenter3D/floor.jpg");var gg=new THREE.PlaneGeometry(this.data.width,this.data.height);var gm=new THREE.MeshBasicMaterial({color:0xffffff,map:gt});var ground=new THREE.Mesh(gg,gm);ground.position.z=-300;ground.material.map.repeat.set(18,18);ground.material.map.wrapS=ground.material.map.wrapT=THREE.RepeatWrapping;ground.receiveShadow=true;this.scene.add(ground);},loadData:function loadData(){var _this=this;return WebAPI.getJSON(this.dataSource).done(function(data){_this.data=data;});},executeUnitType:function executeUnitType(unitType,arg,scene){var namespaces=unitType.split(".");var func=namespaces.pop();var context=window;for(var i=0;i<namespaces.length;i++){context=context[namespaces[i]];}
return new context[func](arg,scene);},attachEvent:function attachEvent(){window.addEventListener('mousemove',this.onMouseMove.bind(this),false);document.addEventListener('mousedown',this.onMouseDown.bind(this),false);},cleanScene:function cleanScene(){var elementsInTheScene=this.scene.children.length;for(var i=elementsInTheScene-1;i>0;i--){if(this.scene.children[i].name!='camera'&&this.scene.children[i].name!='ambientLight'&&this.scene.children[i].name!='directionalLight'){this.scene.remove(this.scene.children[i]);}}},resetView:function resetView(){this.camera.position.x=6925.764174941334;this.camera.position.y=12.494895273811855;this.camera.position.z=4320.172377978487;if(this.controls){this.controls.reset();}},findMouseIntersection:function findMouseIntersection(type){if(!type){return[];}
var vector=new THREE.Vector3(this.mouse.x,this.mouse.y,1);this.projector.unprojectVector(vector,this.camera);this.raycaster.set(this.camera.position,vector.sub(this.camera.position).normalize());var machines=this.scene.children.filter(function(item){return item instanceof type;});var machinesChildren=[];for(var m=0;m<machines.length;m++){machinesChildren=machinesChildren.concat(machines[m].children);}
var intersects=this.raycaster.intersectObjects(machinesChildren);return intersects.map(function(item){return item.object.parent;})[0];},enableCameraHelper:function enableCameraHelper(){this.cameraHelper.update();this.cameraHelper.visible=true;},disableCameraHelper:function disableCameraHelper(){this.cameraHelper.visible=false;},animate:function animate(time){requestAnimationFrame(this.animate.bind(this));TWEEN.update(time);var curObj=this.findMouseIntersection(threeData.unitType.Machine);if(curObj){if(curObj instanceof threeData.unitType.Machine){if(curObj.userData.isMoving){return;}
if(this.INTERSECTED&&this.INTERSECTED.id!=curObj.id){this.INTERSECTED.beopHideMachineName();}
this.INTERSECTED=curObj;this.INTERSECTED.beopShowMachineName();this.domElement.style.cursor='pointer';}}else{if(this.INTERSECTED){this.INTERSECTED.beopHideMachineName();this.domElement.style.cursor='auto';}
this.INTERSECTED=null;}
this.render();this.controls.update();this.stats.update();},render:function render(){this.renderer.render(this.scene,this.camera);},start:function start(){var _this=this;this.initScene();this.initCamera();this.initRender();this.initLight();this.loadData().done(function(){_this.initObjects();}).fail(function(){alert('load data failed.');});this.initControl();this.attachEvent();this.initStats();this.animate();},showMouseClickedObj:function showMouseClickedObj(obj){if(!obj){return;}
var _this=this;obj.userData.isMoving=true;return new TWEEN.Tween(obj.position).to({x:2500,y:0,z:2000},2000).easing(TWEEN.Easing.Cubic.Out).onComplete(function(){obj.userData.isSingleShow=true;obj.userData.isMoving=false;}).start();},hideMouseClickedObj:function hideMouseClickedObj(obj){if(!obj){return;}
obj.userData.isMoving=true;return new TWEEN.Tween(obj.position).to({x:obj.userData.originPosition.x,y:obj.userData.originPosition.y,z:obj.userData.originPosition.z},2000).easing(TWEEN.Easing.Quartic.Out).onComplete(function(){obj.userData.isMoving=false;obj.userData.isSingleShow=false;}).start();},onMouseMove:function onMouseMove(event){this.mouse.x=event.clientX/window.innerWidth*2-1;this.mouse.y=-(event.clientY/window.innerHeight)*2+1;},onMouseDown:function onMouseDown(event){var _this=this,curObj=this.findMouseIntersection(threeData.unitType.Machine);if(!curObj||curObj.userData.isMoving){return;}
if(!curObj.userData.isSingleShow){this.hideMouseClickedObj(this.showingObj);this.showMouseClickedObj(curObj);this.showingObj=curObj;}else{this.hideMouseClickedObj(curObj);}}};function DataCenter3D(){}
DataCenter3D.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/dataCenter3D/index.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.init();}).always(function(){Spinner.stop();});},init:function init(){var room=new Room(document.getElementById('t3Container'),'/static/scripts/dataCenter3D/data_machine1.json');room.start();$('.showSkin').click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine;}).forEach(function(machine){machine.showSkin();});});$('.hideSkin').click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine;}).forEach(function(machine){machine.hideSkin();});});$('.showTemperature').click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine;})[0].beopShowTemperature();});$('.resetView').click(function(){room.resetView();});},close:function close(){}};return DataCenter3D;}();var BenchmarkScreen=function(){function BenchmarkScreen(){this.ctn=undefined;this.iotFilter=undefined;this.curModule=undefined;this.prevModuleType=undefined;this.moduleCtn=undefined;this.moduleList={'overview':{name:I18n.resource.benchmark.conmmenTree.ENERGY_OVERVIEW,cls:BenchmarkEnergyOverView},'diagnosis':{name:I18n.resource.benchmark.conmmenTree.ENERGY_DIAGNOSIS,cls:BenchmarkEnergyDiagnosis},'inquire':{name:I18n.resource.benchmark.conmmenTree.ENERGY_QUERY,cls:BenchmarkEnergyQuery},'analyze':{name:I18n.resource.benchmark.conmmenTree.ENERGY_ANALYSIS,cls:BenchmarkEnergyAnalysis},'datum':{name:I18n.resource.benchmark.conmmenTree.ENERGY_BENCH,cls:BenchmarkEnergyBenchmark},'predict':{name:I18n.resource.benchmark.conmmenTree.ENERGY_FORCAST,cls:BenchmarkEnergyForecast},'benchmark':{name:I18n.resource.benchmark.conmmenTree.ENERGY_BENCHMARKING,cls:BenchmarkEnergyBenchmarking},'config':{name:I18n.resource.benchmark.conmmenTree.PARAMS_CONFIG,cls:BenchmarkConfig}};this.dataSource=undefined;this.store={};this.opt=undefined;this.dataSourceCtn=undefined;}
BenchmarkScreen.prototype={show:function show(){var _this2=this;WebAPI.get('/static/views/observer/benchmark/benchmarkScreen.html').done(function(html){ElScreenContainer.innerHTML=html;_this2.ctn=ElScreenContainer.querySelector('.ctnBenchmark');_this2.moduleCtn=_this2.ctn.querySelector('.panelBmModule');_this2.dataSourceCtn=_this2.ctn.querySelector('.panelDataSource');_this2.init();});},init:function init(){this.initBtnList();this.initIotFilter();this.initDataSource();},initDataSource:function initDataSource(){this.dataSource=new DataSource(this,{disableIot:true});this.dataSource.show();},showDataSource:function showDataSource(){$(this.dataSourceCtn).addClass('focus');$(this.moduleCtn).addClass('onDataSource');},hideDataSource:function hideDataSource(){$(this.dataSourceCtn).removeClass('focus');$(this.moduleCtn).removeClass('onDataSource');},initBtnList:function initBtnList(){var _this3=this;var container=this.ctn.querySelector('.panelModuleList');Object.keys(this.moduleList).forEach(function(val){var divBtn=document.createElement('div');divBtn.className='btnBmModule';divBtn.textContent=_this3.moduleList[val].name;divBtn.dataset.type=val;container.appendChild(divBtn);});$(container).off('click').on('click','.btnBmModule',function(e){$(container).children().removeClass('selected');$(e.currentTarget).addClass('selected');if(!_this3.moduleList[e.currentTarget.dataset.type].cls)return;_this3.prevModuleType=_this3.curModule?_this3.curModule.type:null;_this3.curModule&&_this3.curModule.destroy&&_this3.curModule.destroy();_this3.curModule=new _this3.moduleList[e.currentTarget.dataset.type].cls(_this3.moduleCtn,_this3,{});_this3.curModule.type=e.currentTarget.dataset.type;_this3.curModule.show();});},setInitModule:function setInitModule(){var _this4=this;var iotProjId=this.iotFilter.tree.getNodes()[0]['_id'];if(!iotProjId)return;WebAPI.get('/benchmark/config/get/'+iotProjId).done(function(param){if(!param||$.isEmptyObject(param)){_this4.opt={};$('.panelModuleList .btnBmModule[data-type="config"]').trigger('click');}else{_this4.opt=param;$('.panelModuleList .btnBmModule').first().trigger('click');_this4.setNodeConfigStatus();}});},setNodeConfigStatus:function setNodeConfigStatus(){if(!this.iotFilter.tree)return;if(!(this.opt&&this.opt.point)||$.isEmptyObject(this.opt.point))return;this.iotFilter.$ctn.find('.completeConfig').removeClass('completeConfig');var len=Object.keys(this.opt.point);var num=0;var arrNode=this.iotFilter.tree.transformToArray(this.iotFilter.tree.getNodes());var $target;for(var i=0;i<arrNode.length;i++){if(num>=len)return;var ptConfig=this.opt.point[arrNode[i]['_id']];if(ptConfig){if(ptConfig.power&&ptConfig.energy){arrNode[i].completeConfig=true;$target=$(document.getElementById(arrNode[i].tId));$target.addClass('completeConfig');}
if(ptConfig.model&&ptConfig.model instanceof Array&&ptConfig.model.length>0)$target.addClass('hasModel');num++;}}
arrNode.forEach(function(node){});},initIotFilter:function initIotFilter(projId){var _this=this;if(this.iotFilter){this.iotFilter.tree.destroy();this.iotFilter.$ctn.html('');this.iotFilter=null;}
this.iotFilter=new HierFilter($('.ctnBenchmark .panelIotFilter'),projId,this);var option={class:{'projects':{showNone:true},'groups':{class:'Group'}},tree:{show:true,extend:{view:{addHoverDom:function addHoverDom(treeId,treeNode){var $target=$('#'+treeNode.tId);$target.addClass('focus');},removeHoverDom:function removeHoverDom(treeId,treeNode){var $target=$('#'+treeNode.tId);$target.removeClass('focus');}}},event:{afterInit:function afterInit(){var rootNode=_this.iotFilter.tree.getNodes()[0];if(rootNode){_this.iotFilter.childAppend(rootNode,function(){});}
if(!projId)_this.setInitModule();},click:{isDefault:false,act:function act(event,treeId,treeNode){_this.onNodeClick(event,treeNode);}},dblClick:function dblClick(event,treeId,treeNode){this.childAppend(treeNode,function(){});},addDom:function addDom(treeNode,$target){_this.onNodeAdd(treeNode,$target);}},drag:{enable:true,dragStart:function dragStart(e,node){EventAdapter.setData({dsItemId:node['_id']});}},tool:{delete:deleteNode,add:{act:addNode,default:true},edit:editNode}}};function onNodeClick(event,treeId,treeNode){_this.onNodeClick(event,treeNode);}
function onNodeDblClick(event,treeId,treeNode,widget){}
function deleteNode(treeNode){}
function addNode(arrParent,arrNode){}
function editNode(treeNode){}
this.iotFilter.init();this.iotFilter.setOption(option);},onNodeClick:function onNodeClick(e,node){this.curModule&&this.curModule.onNodeClick&&this.curModule.onNodeClick(e,node);},onNodeAdd:function onNodeAdd(node,$target){$target.find('>a>#'+node.tId+'_span').addClass('node_name');if(this.opt&&this.opt.point){var pointConfig=this.opt.point[node['_id']];if(pointConfig){if(pointConfig.power&&pointConfig.energy){node.completeConfig=true;$target.addClass('completeConfig');}
if(pointConfig.model&&pointConfig.model instanceof Array&&pointConfig.model.length>0)$target.addClass('hasModel');}}
var $btnShowModel=$('<span class="btnShowModel btnTreeNode glyphicon glyphicon-bookmark"></span>');$btnShowModel[0].onclick=this.showModelInfo(node);$target.find('>a').append($btnShowModel);this.curModule&&this.curModule.onNodeAdd&&this.curModule.onNodeAdd(node,$target);},fullScreenModuleCtn:function fullScreenModuleCtn(){},showModelInfo:function showModelInfo(node){},getModel:function getModel(ptId){if(!this.opt.point)return;var pointId;if(!ptId){pointId=this.iotFilter.tree.getSelectedNodes().map(function(node){return node['_id'];});}else{if(!(ptId instanceof Array))pointId=[ptId];}
if(!pointId[0])return;return WebAPI.get('/benchmark/config/getModelsByNodeId/'+pointId[0]);},close:function close(){this.ctn=null;this.iotFilter=null;this.curModule.destroy&&this.curModule.destroy();this.curModule=null;this.moduleList=null;}};return BenchmarkScreen;}();var HierFilter=function(){function HierFilter($ctn,projectId,parent,theme){this.$ctn=$ctn;this.projectId=projectId;this.theme=theme;this.opt=undefined;this.parent=parent;this.defaultOpt={title:{show:false},base:{divideByProject:true},search:{show:true},class:{show:true,projects:{show:true,class:'all',showAll:true,showNone:true,add:true,delete:true},groups:{show:true,class:'all',showAll:true,showNone:true,add:true,delete:true},things:{show:true,class:'all',showAll:true,showNone:true,add:true,delete:true}},tree:{show:true,event:{},drag:{enable:true},base:{expandReload:true},tool:{add:{},beforeAdd:{},edit:{},del:{}},check:{enable:false}}};this.dictClass={};this.store=undefined;this.initDeferred=$.Deferred();this.$paneClass=undefined;this.$paneSearch=undefined;this.$paneTree=undefined;this.$paneAdd=undefined;this.tree=undefined;this.setDefault=false;this.prevProjId=undefined;this.isSearch=false;this.showStatus={'projects':'all','groups':'all','things':'all'};}
HierFilter.prototype={init:function init(ctn,theme){var _this=this;_this.$ctn=ctn?ctn:_this.$ctn;_this.theme=theme?theme:_this.theme;if(!_this.projectId){if(AppConfig&&AppConfig.projectId){_this.projectId=AppConfig.projectId;}else{if(window.parent&&window.parent.AppConfig.projectId){_this.projectId=window.parent.AppConfig.projectId;}}}
if(!_this.projectId)_this.projectId=-1;WebAPI.get('/static/scripts/iot/hierFilter.html').done(function(resultHTML){_this.$ctn.append(resultHTML);I18n.fillArea($('#filterWrapper'));_this.initAddPane();_this.initSearch();_this.initDeferred.resolve();});},setOption:function setOption(opt){var _this=this;_this.initDeferred.done(function(){_this.opt=$.extend(true,{},_this.defaultOpt,opt);var postData={parent:[],projId:[_this.projectId]};if(!_this.opt.base.divideByProject)delete postData.projId;$.when(WebAPI.get('/iot/getClassFamily/group/cn'),WebAPI.get('/iot/getClassFamily/thing/cn'),WebAPI.get('/iot/getClassFamily/project/cn')).done(function(groups,things,projects){_this.dictClass['groups']=groups[0];_this.dictClass['things']=things[0];_this.dictClass['projects']=projects[0];WebAPI.post('/iot/search',postData).done(function(resultDate){_this.store={groups:resultDate.groups,projects:resultDate.projects,things:resultDate.things};_this.isSearch=false;var $Deffer=$.Deferred();if(resultDate.projects.length==0){_this.setIotProject().done(function(result){if(result&&result.status=='success'){_this.store.projects[0]._id=result._id;$Deffer.resolve();}else{$Deffer.reject();}}).fail(function(){$Deffer.reject();});}else{$Deffer.resolve();}
$Deffer.done(function(){for(var i=0;i<_this.store.groups.length;i++){_this.store.groups[i].isParent=true;_this.store.groups[i].baseType='groups';}
for(var i=0;i<_this.store.projects.length;i++){_this.store.projects[i].isParent=true;_this.store.projects[i].baseType='projects';}
for(var i=0;i<_this.store.things.length;i++){_this.store.things[i].baseType='things';}
for(var type in _this.store){if(_this.opt.class&&_this.opt.class[type]&&_this.opt.class[type].class){if(_this.dictClass[type][_this.opt.class[type].class]&&_this.dictClass[type][_this.opt.class[type].class].parent=='BaseIOT'){_this.showStatus[type]='all';}else{_this.showStatus[type]=_this.opt.class[type].class;}}}
_this.initClassPane();_this.initTreePane(_this.store);_this.opt.tree.event.afterInit&&_this.opt.tree.event.afterInit();var node=_this.tree.getNodes();if(node.length==0)return;node=node[0];_this.tree.selectNode(node);_this.setDefault=true;_this.tree.setting.callback.onClick({target:document.getElementById(node.tId)},node['_id'],node);});});});});},setIotProject:function setIotProject(){if(!(AppConfig&&AppConfig.projectList instanceof Array))return;if(!this.projectId)return;var info;for(var i=0;i<AppConfig.projectList.length;i++){if(AppConfig.projectList[i].id==this.projectId){info=AppConfig.projectList[i];break;}}
if(!info)return;var postData={'_idMgt':'bbbbbbbbbbbbf32fbc300001',codeName:info.name_en,dictName:{cn:info.name_cn,en:info.name_en},latLng:info.latlng,arrP:{},type:'Project',projId:this.projectId};this.store.projects=[{codeName:info.name_en,name:info.name_cn,latLng:info.latlng,arrP:{},type:'Project',projId:this.projectId}];return WebAPI.post('/iot/setIotProject',postData);},refresh:function refresh(){},dispose:function dispose(){},close:function close(){},initClassPane:function initClassPane(){var _this=this;if(!(_this.opt.class&&_this.opt.class.show))return;_this.$paneClass=$('#paneIotType');_this.$paneClass.html('');setClassSel('projects');setClassSel('groups');setClassSel('things');function setClassSel(type){if(_this.opt.class&&_this.opt.class[type]&&_this.opt.class[type].show){var strType=type.slice(0,type.length-1);strType=strType[0].toLocaleUpperCase()+strType.slice(1);var $divSelect=$('\
                    <div class="divSelect" value="all">\
                        <span class="spSelRs">'+I18n.resource.iot.TREE_ALL+'</span>\
                        <span class="glyphicon glyphicon-triangle-bottom"></span>\
                    </div>');var selOpt=[];if(_this.opt.class[type].showAll){selOpt.push({value:'all',name:I18n.resource.iot.TREE_ALL});}
if(_this.opt.class[type].showNone){selOpt.push({value:'none',name:I18n.resource.iot.TREE_HIDE});}
for(var cls in _this.dictClass[type]){if(_this.dictClass[type][cls].parent=='BaseIOT')continue;selOpt.push({value:cls,name:_this.dictClass[type][cls].name,parent:_this.dictClass[type][cls].parent});}
var $selector=_this.setSel(selOpt).addClass('selClass');if($selector.find('li').length==0)return;$selector.off('click').on('click','li',function(e){e.stopPropagation();var value=$(e.currentTarget).attr('value');$selector.prevAll('.spSelRs').text($(e.currentTarget).children('span').text());$selector.attr('value');var opt={'type':type,'val':value};_this.showStatus[opt.type]=opt.val;_this.initTreeData(opt);_this.initAttrPane(opt);});$selector.attr('value',_this.showStatus[type]);if(_this.showStatus[type]=='all'){$divSelect.children('.spSelRs').text(I18n.resource.iot.TREE_ALL);}else if(_this.showStatus[type]=='none'){$divSelect.children('.spSelRs').text(I18n.resource.iot.TREE_HIDE);}else{var arrKey=Object.keys(_this.dictClass[type]);for(var i=0;i<arrKey.length;i++){if(arrKey[i]==_this.showStatus[type]){$divSelect.children('.spSelRs').text(_this.dictClass[type][arrKey[i]].name);break;}}}
$divSelect.append($selector);_this.$paneClass.append($divSelect);}}},setSel:function setSel(selOpt){var _this=this;var $selector=$('<ul>');var tempArr=[].concat(selOpt);var dictTree={};var level=0;var length=tempArr.length;var numLeft=length;var isRoot;for(var i=0;i<length;i++){isRoot=true;for(var j=0;j<length;j++){if(i==j)continue;if(selOpt[j].value==tempArr[i].parent){isRoot=false;break;}}
if(isRoot){tempArr[i].level=level;if(!dictTree[level])dictTree[level]=[];dictTree[level].push(tempArr[i]);tempArr[i]=null;}}
while(numLeft>0){numLeft=0;level++;for(var i=0;i<length;i++){if(!tempArr[i])continue;for(var j=0;j<dictTree[level-1].length;j++){if(tempArr[i].parent==dictTree[level-1][j].value){if(!dictTree[level])dictTree[level]=[];dictTree[level].push(tempArr[i]);tempArr[i]=null;break;}}}
for(var i=0;i<length;i++){if(tempArr[i])numLeft++;}}
var $option,$parent=[],$parentTemp=[];var $spName;for(var i=0;i<dictTree['0'].length;i++){$option=$('<li>');$option.addClass('level_0 '+dictTree['0'][i].value).attr('value',dictTree['0'][i].value);$spName=$('<span>').text(dictTree['0'][i].name);$option.append($spName);$option.append('<ul>');$selector.append($option);$parent.push($option);}
for(var ele in dictTree){if(ele=='0')continue;for(var i=0;i<dictTree[ele].length;i++){$option=$('<li>');$option.addClass('level_'+ele+' '+dictTree[ele][i].value).attr('value',dictTree[ele][i].value);$spName=$('<span>').text(dictTree[ele][i].name);$option.append($spName);$option.append('<ul>');for(var j=0;j<$parent.length;j++){if($parent[j].attr('value')==dictTree[ele][i].parent){$parent[j].children('ul').append($option);break;}}
$parentTemp.push($option);}
$parent=$parentTemp;$parentTemp=[];}
return $selector;},initAttrPane:function initAttrPane(opt){var _this=this;var $paneClass,cls,type,clsStore,$divAttr,attrStore,$selAttr,parentStore;cls=opt.val;type=opt.type;clsStore=_this.searchClass(cls);$paneClass=$('#paneIot-'+type).html('').removeClass('on');if(!clsStore)return;$paneClass.append('<div class="className">'+clsStore.name+'</div>');parentStore=_this.searchClass(clsStore.parent);if(parentStore&&parentStore.name){$paneClass.append('<div class="classParentName">'+parentStore.name+'</div>');}
$divAttr=$('<div class="divAttr">');for(var attr in clsStore.attrs){attrStore=clsStore.attrs[attr];setAttr(attrStore,$divAttr);$paneClass.find('.className').after($divAttr);}
if($paneClass.find('select').length>0){$paneClass.addClass('on');}
function setAttr(attrStore,$divAttr){if(attrStore.filter){$divAttr.append('<span class="label">'+attrStore.name+'</span>');$selAttr=$('<select class="filterAttr">').addClass('attr').attr('filterMode',attrStore.filter.t);if(attrStore.filter.t='enum'){for(var attrOpt in attrStore.filter.opt){$selAttr.append('<option value="'+attrOpt+'">'+attrStore.filter.opt[attrOpt]+'</option>');}}else if(attrStore.filter.t='range'){for(var j=0;j<attrStore.filter.opt.length;j++){$selAttr.append('<option value="'+attrStore.filter.opt[j]+'">'+attrStore.filter.opt[j]+'</option>');}}
$divAttr.append($selAttr);}}},initSearch:function initSearch(){var _this=this;var $iptSearch=$('#paneIotSearch').find('input');$iptSearch.next().off('click').on('click',function(){if($iptSearch.val()=='')return;$iptSearch.val('');clearSearch();});$iptSearch.on('propertychange input',function(e){if($iptSearch.val()==''){clearSearch();}});$iptSearch.keyup(function(e){if(13==e.keyCode){$iptSearch.blur();var projId;var selectNode=_this.tree.getSelectedNodes()[0];if(!selectNode||!selectNode['projId']){projId=_this.prevProjId?_this.prevProjId:_this.projectId;}else{var parentNode=selectNode.getParentNode();while(parentNode){selectNode=parentNode;parentNode=selectNode.getParentNode();}
_this.prevProjId=selectNode['projId'];}
var postData;if($iptSearch.val()==''){clearSearch();}else{postData={searchName:$iptSearch.val(),projId:projId?projId:_this.projectId};if(!_this.opt.base.divideByProject)delete postData.projId;WebAPI.post('/iot/fuzzysearch',postData).done(function(result){if(!result||!result.data)return;_this.isSearch=true;$.fn.zTree.destroy('paneIotData');_this.store={projects:[],groups:[],things:[]};_this.tree=null;for(var i=0;i<result.data.length;i++){result.data[i].pId=result.data[i]['_idPrt'];_this.store[result.data[i].baseType].push(result.data[i]);}
for(var i=0;i<_this.store.groups.length;i++){_this.store.groups[i].isParent=true;_this.store.groups[i].baseType='groups';}
for(var i=0;i<_this.store.projects.length;i++){_this.store.projects[i].isParent=true;_this.store.projects[i].baseType='projects';}
for(var i=0;i<_this.store.things.length;i++){_this.store.things[i].baseType='things';}
_this.initTreePane(_this.store);});}}});function clearSearch(){var postData={parent:[],projId:[_this.projectId]};if(!_this.opt.base.divideByProject)delete postData.projId;WebAPI.post('/iot/search',postData).done(function(result){if(!result)return;_this.isSearch=false;$.fn.zTree.destroy('paneIotData');_this.store={projects:[],groups:[],things:[]};_this.tree=null;_this.store={groups:result.groups,projects:result.projects,things:result.things};for(var i=0;i<_this.store.groups.length;i++){_this.store.groups[i].isParent=true;_this.store.groups[i].baseType='groups';}
for(var i=0;i<_this.store.projects.length;i++){_this.store.projects[i].isParent=true;_this.store.projects[i].baseType='projects';}
for(var i=0;i<_this.store.things.length;i++){_this.store.things[i].baseType='things';}
_this.initClassPane();_this.initTreePane(_this.store);});}},searchName:function searchName(name){var _this=this;for(var type in _this.store.class){for(var keyName in _this.store.class[type]){if(keyName==name)return _this.store.class[type][keyName];}}},searchDeviceById:function searchDeviceById(id,type){var _this=this;if(!id)return[];var arrDevice=[];var arrId=[];if(type){if(id instanceof Array){for(var i=0;i<id.length;i++){arrId[i]={id:id[i],index:i};}
for(var i=0;i<_this.store[type].length;i++){for(var j=0;j<arrId.length;j++){if(_this.store[type][i]['_id']==arrId[j].id){arrDevice[arrId[j].index]=_this.store[type][i];arrId.splice(j,1);break;}}}}else{for(var i=0;i<_this.store[type].length;i++){if(_this.store[type][i]['_id']==id){return[_this.store[type][i]];}}}}else{if(id instanceof Array){for(var i=0;i<id.length;i++){arrId[i]={id:id[i],index:i};}
for(var ele in _this.store){for(var i=0;i<_this.store[ele].length;i++){for(var j=0;j<arrId.length;j++){if(_this.store[ele][i]['_id']==arrId[j].id){arrDevice[arrId[j].index]=_this.store[ele][i];arrId.splice(j,1);break;}}}}}else{for(var ele in _this.store){for(var i=0;i<_this.store[ele].length;i++){if(_this.store[ele][i]['_id']==id){return[_this.store[ele][i]];}}}}}
return arrDevice;},searchClass:function searchClass(cls){var _this=this;for(var type in _this.dictClass){for(var keyCls in _this.dictClass[type]){if(keyCls==cls)return _this.dictClass[type][keyCls];}}},initTreePane:function initTreePane(opt,parentNode){var _this2=this;var _this=this;if(_this.tree)return;_this.$paneTree=$('#paneIotData');_this.$paneTree.off('click');if(_this.opt.tree&&_this.opt.tree.show){var setting;var zNodes;(function(){var diyParam=function diyParam(treeNode){return{parent:[{id:treeNode['_id'],type:treeNode['baseType']}]};};var dataFilter=function dataFilter(treeId,parentNode,resultData){for(var type in resultData.class){for(var cls in resultData.class[type]){_this.dictClass[type][cls]=resultData.class[type][cls];}}
_this.initClassPane();};var addDiyDom=function addDiyDom(treeId,treeNode){var $target=$('#'+treeNode.tId);$target.attr('ptId',treeNode['_id']);$target.addClass(treeNode.baseType);if(treeNode.baseType=='groups'||treeNode.baseType=='things'){$target.children('a').append('\
                    <span class="btnDelete btnTreeNode glyphicon glyphicon-remove-sign"></span>\
                    <span class="btnEdit btnTreeNode glyphicon glyphicon-edit"></span>\
                    ');}
if(_this.opt.tree.drag&&_this.opt.tree.drag.enable){$target.attr('draggable',true);if(_this.opt.tree.drag.dragstart){attachDragEvent('dragstart',$target,treeNode);}
if(_this.opt.tree.drag.dragend){attachDragEvent('dragend',$target.children('a'),treeNode);}
if(_this.opt.tree.drag.drop){attachDragEvent('dragover',$target.children('a'),treeNode);attachDragEvent('dragleave',$target.children('a'),treeNode);attachDragEvent('drop',$target.children('a'),treeNode);}}
if(typeof _this.opt.tree.event.addDom=='function'){_this.opt.tree.event.addDom.call(_this,treeNode,$target);}};var addHoverDom=function addHoverDom(treeId,treeNode){if(treeNode.isParent)return;var $target=$('#'+treeNode.tId);$target.css({'background-color':'rgb(76, 100, 148)'});$target.children('a').css('color','black');};var removeHoverDom=function removeHoverDom(treeId,treeNode){if(treeNode.isParent)return;var $target=$('#'+treeNode.tId);$target.css({'background-color':'transparent'});$target.children('a').css('color','inherit');};var attachDragEvent=function attachDragEvent(type,target,treeNode){if(type=='dragover'||type=='dragleave'){target.on(type,function(e){e.preventDefault();_this.opt.tree.drag[type]&&_this.opt.tree.drag[type].call(_this,e,treeNode);});return;}
if(_this.opt.tree.drag[type]){if(_this.opt.tree.drag[type]instanceof Function){target.on(type,function(e){e.preventDefault();_this.opt.tree.drag[type].call(_this,e,treeNode);});}else if(_this.opt.tree.drag[type].act instanceof Function&&_this.opt.tree.drag[type].tar==treeNode.baseType){target.on(type,function(e){_this.opt.tree.drag[type].act.call(_this,e,treeNode);});}else if(_this.opt.tree.drag[type]instanceof Array){_this.opt.tree.drag[type].forEach(function(event,i){if(event.act instanceof Function&&event.tar==treeNode.baseType){target.on(type,function(e){e.stopPropagation();event.act.call(_this,e,treeNode);});}});}}};setting={data:{simpleData:{enable:true,idKey:'_id'}},keep:{leaf:true,parent:true},check:{enable:_this.opt.tree.check.enable},edit:{enable:true,drag:{isCopy:false,isMove:false},showRemoveBtn:false,showRenameBtn:false},view:{addDiyDom:addDiyDom,addHoverDom:addHoverDom,removeHoverDom:removeHoverDom,dblClickExpand:false,showIcon:true,showLine:true},callback:{beforeRename:function beforeRename(){return false;},beforeRemove:function beforeRemove(){},beforeDrag:function beforeDrag(){return false;},beforeAsync:function beforeAsync(){},onAsyncSuccess:function onAsyncSuccess(){},onDblClick:function onDblClick(event,treeId,treeNode){if(!_this.opt.tree.event.dblClick)return;_this.opt.tree.event.dblClick.call(_this,event,treeId,treeNode);},onClick:function onClick(event,treeId,treeNode){if(!_this.opt.tree.event.click)return;var that=this;var dblFlag=false;var clkInterval;if(typeof treeNode.clickTime=='undefined'){clkInterval=Infinity;}else{clkInterval=new Date()-treeNode.clickTime;}
treeNode.clickTime=new Date();$(event.target).on('click.judgeDbl',function(){dblFlag=true;});var dblJudge=window.setInterval(function(){$(event.target).off('click.judgeDbl');window.clearInterval(dblJudge);if(!dblFlag&&clkInterval>200){if(_this.opt.tree.event.click.isDefault===false){_this.opt.tree.event.click.act.call(that,event,treeId,treeNode);return;}
_this.childAppend(treeNode,function(){if(_this.opt.tree.event.click){if(!_this.opt.tree.event.click instanceof Array){_this.opt.tree.event.click.call(that,event,treeId,treeNode);}else{for(var i=0;i<_this.opt.tree.event.click.length;i++){if(_this.opt.tree.event.click[i].tar.toString().indexOf(treeNode.baseType)>-1||_this.opt.tree.event.click[i].tar=='all'){_this.opt.tree.event.click[i].act.call(that,event,treeId,treeNode);}}}}});}},200);}}};if(_this.opt.tree.extend){$.extend(true,setting,setting,_this.opt.tree.extend);}
zNodes=_this.initTreeData(opt);_this.tree=$.fn.zTree.init(_this2.$paneTree,setting,zNodes);_this.$paneTree.on('click','.btnEdit',function(e){e.stopPropagation();var treeNode=_this.tree.getNodeByTId(e.target.parentNode.parentNode.id);var parentNode=treeNode.getParentNode();new CreateDeviceModal({mode:'edit',baseType:treeNode.baseType,filter:_this,parentNode:parentNode,treeNode:treeNode});});_this.$paneTree.on('click','.btnDelete',function(e){e.stopPropagation();var treeNode=_this.tree.getNodeByTId(e.target.parentNode.parentNode.id);infoBox.confirm('确认删除节点 '+treeNode.name+' ? 注意子文件及文件夹也将被删除并不可恢复。',okCallback);function okCallback(){var postData=[{'id':[treeNode['_id']],'type':treeNode['baseType']}];WebAPI.post('/iot/delIotInfo',postData).done(function(){var nodes=_this.tree.getNodesByParam('_id',$(e.target.parentNode.parentNode).attr('ptid'));for(var i=0;i<nodes.length;i++){_this.tree.removeNode(nodes[i]);}
if(typeof _this.opt.tree.tool.delete=='function'){_this.opt.tree.tool.delete.call(_this,treeNode);}});}});_this.$paneTree.on('click','.btnTemplate',function(e){e.stopPropagation();var treeNode=_this.tree.getNodeByTId(e.target.parentNode.id);var strModalContent=new StringBuilder();strModalContent.append('               <iframe style="width:100%;height:100%;" name="ifram_factory" sandbox="allow-forms allow-popups allow-scripts allow-same-origin allow-modals" frameborder="0"></iframe>');var $modalContent=$(strModalContent.toString());var $modal=$('#templateModal');$modal.find('.modal-content').append($modalContent);$modal.modal('show');$modal.off().on('shown.bs.modal',function(){var form,ipt;form=document.createElement('form');form.action='/factory/preview/8f54051d0011456903054765';form.method='post';form.target='ifram_factory';ipt=document.createElement('input');ipt.type='hidden';ipt.name='params';ipt.value=JSON.stringify(treeNode.arrP);form.appendChild(ipt);document.body.appendChild(form);form.submit();document.body.removeChild(form);});$modal.on('hidden.bs.modal',function(){$modalContent.remove();});});_this.$paneTree.on('click','.projects>.button.switch',function(e){var $target=$(e.currentTarget);var node=_this.tree.getNodeByTId($target.parent().attr('id'));_this.childAppend(node,function(){});return false;});_this.$paneTree.on('click','.groups>.button.switch',function(e){var $target=$(e.currentTarget);var node=_this.tree.getNodeByTId($target.parent().attr('id'));_this.childAppend(node,function(){});return false;});})();}},initTreeData:function initTreeData(option){var _this=this;if(!_this.tree){var data=[];data=data.concat(this.store.projects);data=data.concat(this.store.groups);data=data.concat(this.store.things);}else{var root=_this.tree.getNodes();var data=_this.tree.transformToArray(root);for(var i=0;i<data.length;i++){if(data[i].baseType==option.type){_this.tree.showNode(data[i]);if(option.val=='all'){continue;}else if(option.val=='none'){_this.tree.hideNode(data[i]);}else if(data[i].type!=option.val){_this.tree.hideNode(data[i]);}}}}
if(typeof _this.opt.tree.data=='function'){_this.opt.tree.data.call(_this,data);}
return data;},getChildren:function getChildren(treeNode,func,opt){var _this=this;var postData={parent:[{id:treeNode['_id'],type:treeNode['baseType']}]};return WebAPI.post('/iot/search',postData).done(function(resultData){for(var type in resultData.class){for(var cls in resultData.class[type]){_this.dictClass[type][cls]=resultData.class[type][cls];}}
var tempArr=[];for(var ele in resultData){if(ele=='class')continue;if(typeof _this.opt.tree.data=='function'){_this.opt.tree.data.call(_this,resultData[ele],ele);}
var flag;for(var i=0;i<resultData[ele].length;i++){for(var j=0;j<_this.store[ele].length;j++){if(_this.store[ele][j]['_id']==resultData[ele][i]['_id']){if(ele=='groups'&&!resultData[ele][i].pId){resultData[ele][i].pId=resultData[ele][i]['_idProj'];}
if(_this.store[ele][j]['pId']==resultData[ele][i]['pId']){flag=true;}else{if(treeNode.children){for(var k=0;k<treeNode.children.length;k++){if(resultData[ele][i]['_id']==treeNode.children[k]['_id']){flag=true;break;}}}}
break;}}
if(resultData[ele][i].icon){resultData[ele][i].iconSkin='iconfont '+resultData[ele][i].icon;delete resultData[ele][i].icon;}
if(_this.opt.tree.base.expandReload||!flag){if(ele=='groups'||ele=='projects'){resultData[ele][i].isParent=true;}
resultData[ele][i].baseType=ele;if(!flag){_this.store[ele].push(resultData[ele][i]);}
tempArr.push(resultData[ele][i]);}}}
if(_this.opt.tree.base.expandReload){_this.tree.removeChildNodes(treeNode);}
if(tempArr.length==0){func(resultData);return;}
if(!opt||opt.add!==false){_this.tree.addNodes(treeNode,tempArr,true);}
if(!opt||opt.expand!==false){_this.tree.expandNode(treeNode,null,false,true,true);}
_this.initClassPane();func(resultData);});},childAppend:function childAppend(treeNode,func){var _this=this;if(treeNode.open){_this.tree.expandNode(treeNode,null,false,true,true);return;}else{if(treeNode.baseType=='things'){func();_this.tree.expandNode(treeNode,null,false,true,true);return;}else{var postData={parent:[{id:treeNode['_id'],type:treeNode['baseType']}]};WebAPI.post('/iot/search',postData).done(function(resultData){for(var type in resultData.class){for(var cls in resultData.class[type]){_this.dictClass[type][cls]=resultData.class[type][cls];}}
var tempArr=[];for(var ele in resultData){if(ele=='class')continue;if(typeof _this.opt.tree.data=='function'){_this.opt.tree.data.call(_this,resultData[ele],ele);}
var flag;for(var i=0;i<resultData[ele].length;i++){for(var j=0;j<_this.store[ele].length;j++){if(_this.store[ele][j]['_id']==resultData[ele][i]['_id']){if(ele=='groups'&&!resultData[ele][i].pId){resultData[ele][i].pId=resultData[ele][i]['_idProj'];}
if(_this.store[ele][j]['pId']==resultData[ele][i]['pId']){flag=true;}else{if(treeNode.children){for(var k=0;k<treeNode.children.length;k++){if(resultData[ele][i]['_id']==treeNode.children[k]['_id']){flag=true;break;}}}}
_this.store[ele][j]=resultData[ele][i];break;}}
if(_this.opt.tree.base.expandReload||!flag){if(ele=='groups'||ele=='projects'){resultData[ele][i].isParent=true;}
resultData[ele][i].baseType=ele;if(!flag){_this.store[ele].push(resultData[ele][i]);}
tempArr.push(resultData[ele][i]);}}}
if(_this.opt.tree.base.expandReload){_this.tree.removeChildNodes(treeNode);}
if(tempArr.length==0){func();_this.tree.expandNode(treeNode,null,false,true,true);return;}
_this.tree.addNodes(treeNode,tempArr,true);for(var base in _this.showStatus){_this.initTreeData({'type':base,'val':_this.showStatus[base]});}
_this.tree.expandNode(treeNode,null,false,true,true);_this.initClassPane();func();});}}},initAddPane:function initAddPane(){var _this=this;_this.$paneAdd=$('#paneIotAdd');var $btnAdd=$('.btnAddEle');$btnAdd.click(function(e){var parentNode=_this.tree.getSelectedNodes()[0];var callBack;if(typeof _this.opt.tree.tool.beforeAdd=='function'){callBack=_this.opt.tree.tool.beforeAdd.call(_this,parentNode);}
if(typeof _this.opt.tree.tool.beforeAdd.act=='function'){callBack=_this.opt.tree.tool.beforeAdd.act.call(_this,parentNode);}
if(callBack&&callBack.parentNode){parentNode=callBack.parentNode;}
if(parentNode.length==0){alert('请选择父节点');return;}
if(callBack&&callBack.isForbid){alert(callBack.msg);return;}
new CreateDeviceModal({mode:'add',baseType:$(e.currentTarget).attr('typeAdd'),filter:_this,parentNode:parentNode});});}};return HierFilter;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var CreateDeviceModal=function(){var _this;function CreateDeviceModal(opt){_this=this;this.devices=null;this.names=null;this.type=null;this.mode=opt.mode;this.baseType=opt.baseType?opt.baseType:undefined;this.filter=opt.filter?opt.filter:undefined;this.parentNode=opt.parentNode;this.treeNode=opt.treeNode;this.group=[];this.prefix=null;this.batch=null;this.batchErr={name:false,prefix:false};this.show();}
CreateDeviceModal.prototype={show:function show(){var _this=this;if(_this.mode=='add'&&_this.baseType=='things'&&_this.parentNode.baseType=='projects'){alert('项目下不支持直接增加设备');return;}
WebAPI.get("/static/scripts/iot/config/addThing.html").done(function(rsHtml){_this.content=rsHtml;_this.$createDev=$("#modalIotCfg");_this.$createDev.find("#ctnIotCfg").html(rsHtml);if(_this.mode=='add'){_this.$createDev.find('.modal-title').text('添加'+_this.baseType);}else{_this.$createDev.find('.modal-title').text('修改'+_this.baseType);}
_this.$createDev.modal({backdrop:'static',keyboard:false});_this.init();});},init:function init(){var _this=this;_this.names=[];_this.devices=[];_this.prefix=[];_this.type="";_this.batch=false;_this.$createDev.modal('show');_this.$innerSLD=$("#createModalSld");_this.closeBtn=document.getElementById("closeBtn");_this.skipBtn=document.getElementById("skipBtn");_this.nextBtn=document.getElementById("nextBtn");_this.confirmBtn=document.getElementById("confirmBtn");_this.nameInput=document.getElementById("nameInput");_this.nameConfigInput=document.getElementById("batchNameArea");_this.prefixInput=document.getElementById("prefixInput");_this.typeList=document.getElementById("typeList");_this.groupList=document.getElementById("addedGroup");_this.bindDataGroup=document.getElementById("bindDataGroup");_this.typeDataSource=null;if(_this.parentNode.baseType=='things'){_this.parentNode=_this.parentNode.getParentNode();}
_this.initTypeList();_this.initParentType();if(_this.mode=='edit'){_this.initEditMode();}
_this.attachEvent();},attachEvent:function attachEvent(){var _this=this;var btnAddParent=document.getElementById("btnAddParent");btnAddParent.addEventListener("click",_this.parentAdd,false);_this.closeBtn.onclick=function(){_this.closeModal(false);};_this.confirmBtn.onclick=function(){_this.closeModal(true);};_this.nextBtn.onclick=function(){var currentIndex=_this.$innerSLD.find('.active').index();_this.checkValid(currentIndex);};_this.$innerSLD.on('slide.bs.carousel',_this.onCarouselMove);$(".batchBtn").on("change",function(){var batch=$(this).attr("data-batch");if(batch==="true"){$("#divNameBatch").removeClass("hide");$("#divPrefixBatch").removeClass("hide");_this.batch=true;}else{$("#divNameBatch").addClass("hide");$("#divPrefixBatch").addClass("hide");_this.batch=false;}});},closeModal:function closeModal(flag){var _this=this;if(flag){if(_this.mode=='add'){_this.addModeClose();}else if(_this.mode=='edit'){_this.editModeClose();}
_this.devices=null;_this.name=null;_this.type=null;_this.group=[];_this.prefix=null;_this.batch=false;_this.$createDev.modal('hide');_this.$createDev.find("#dialogContent").empty();}else{var callback=function callback(){_this.devices=null;_this.names=null;_this.type=null;_this.group=[];_this.prefix=null;_this.batch=false;_this.$createDev.modal('hide');_this.$createDev.find("#dialogContent").empty();};var message="确定要中途退出吗？";infoBox.confirm(message,callback);}},editModeClose:function editModeClose(){var postData=[];for(var i=0;i<_this.devices.length;i++){postData.push({'_id':_this.treeNode['_id'],name:_this.devices[i].name,arrP:_this.devices[i].arrP,_idProj:_this.parentNode.baseType=='projects'?_this.parentNode['_id']:_this.parentNode['_idProj'],projId:_this.parentNode.projId,pId:_this.parentNode.baseType=='projects'?undefined:_this.pId,path:null,prefix:_this.devices[i].prefix,type:_this.type,weight:0,baseType:_this.baseType});}
WebAPI.post('/iot/setIotInfo',postData).done(function(result){if(result.data&&result.data.length==0)return;$.extend(true,_this.treeNode,postData[0]);_this.filter.tree.updateNode(_this.treeNode);for(var i=0;i<_this.filter.store[_this.treeNode['baseType']].length;i++){if(_this.filter.store[_this.treeNode['baseType']][i]['_id']==_this.treeNode['_id']){for(var ele in _this.filter.store[_this.treeNode['baseType']][i]){_this.filter.store[_this.treeNode['baseType']][i][ele]=_this.treeNode[ele];}
break;}}
var func;if(typeof _this.filter.opt.tree.tool.edit=='function'){func=_this.filter.opt.tree.tool.edit;}else if(typeof _this.filter.opt.tree.tool.edit.act=='function'){func=_this.filter.opt.tree.tool.edit.act;}else{return;}
if(_this.mode=='edit'){func.call(_this.filter,_this.treeNode);}});},addModeClose:function addModeClose(){var postData=[];for(var i=0;i<_this.devices.length;i++){postData.push({name:_this.devices[i].name,arrP:_this.devices[i].arrP,_idProj:_this.parentNode.baseType=='projects'?_this.parentNode['_id']:_this.parentNode['_idProj'],projId:_this.parentNode.projId,pId:_this.parentNode.baseType=='projects'?undefined:_this.pId,path:null,prefix:_this.devices[i].prefix,type:_this.type,weight:0,baseType:_this.baseType});}
WebAPI.post('/iot/setIotInfo',postData).done(function(result){if(result.data&&result.data.length==0)return;postData.forEach(function(val,index){val['_id']=result.data[index];if(_this.baseType=='groups'){val.isParent=true;}});var arrParent=[];var arrNodes=[];var parent;if(_this.pId instanceof Array){arrParent.push(_this.parentNode);_this.filter.tree.addNodes(_this.parentNode,postData);for(var i=0;i<_this.pId.length;i++){if(_this.parentNode['_id']==_this.pId[i])continue;parent=_this.filter.tree.getNodeByParam('_id',_this.pId[i]);arrParent.push(parent);_this.filter.tree.addNodes(parent,postData);}}else{_this.filter.tree.addNodes(_this.parentNode,postData);arrParent.push(_this.parentNode);}
_this.filter.store[_this.baseType]=_this.filter.store[_this.baseType].concat(postData);var func;if(typeof _this.filter.opt.tree.tool.add=='function'){func=_this.filter.opt.tree.tool.add;}else if(typeof _this.filter.opt.tree.tool.add.act=='function'){func=_this.filter.opt.tree.tool.add.act;}else{return;}
for(var i=0;i<postData.length;i++){arrNodes.push(_this.filter.tree.getNodeByParam('_id',postData[i]['_id']));}
func.call(_this.filter,arrParent,arrNodes);});},initEditMode:function initEditMode(){$('#divBatch').hide();$('#nameInput').val(_this.treeNode.name);$('#prefixInput').val(_this.treeNode.prefix);},createDevice:function createDevice(){var _this=this;var typeProp;for(var i=0,len=_this.names.length;i<len;i++){var obj={};obj.name=_this.names[i];obj.type=_this.type;if(_this.prefix&&_this.prefix[i]){obj.prefix=_this.prefix[i];}else{obj.prefix='';}
obj.attrs=[];obj.arrP={};typeProp=_this.typeDataSource[_this.type];for(var attr in typeProp['attrs']){if(typeProp['attrs'].hasOwnProperty(attr)){var att={};att['name']=attr;att["fullName"]=obj.prefix+attr;att["cnName"]=typeProp['attrs'][attr]["name"];att["value"]='--';att["id"]=null;obj["attrs"].push(att);}}
_this.devices.push(obj);}},updateDevice:function updateDevice(){var _this=this;},initTypeList:function initTypeList(){var _this=this;var arrHtml=["<option value='-1'>请选择</option>"];var $typeList=$("#typeList");var clsList=[];_this.typeDataSource=_this.filter.dictClass[_this.baseType];var baseType=_this.baseType.substring(0,_this.baseType.length-1);baseType=baseType?baseType:_this.treeNode.baseType.substring(0,_this.treeNode.baseType-1);WebAPI.get('/iot/getClassFamilyByProjId/'+_this.parentNode.getPath()[0]['_id']+'/'+baseType+'/cn').done(function(result){if(!result||$.isEmptyObject(result)){clsList=_this.typeDataSource;}else{clsList=result;}
for(var obj in clsList){if(clsList.hasOwnProperty(obj)){var name=clsList[obj]["name"];if(obj=='Thing'||obj=='Group'){arrHtml.push("<option selected value='"+obj+"'>"+name+"</option>");}else{arrHtml.push("<option value='"+obj+"'>"+name+"</option>");}}}
$typeList.html(arrHtml.join(''));if(_this.mode=='edit'){$('#typeList').val(_this.treeNode.type);}});},initParentType:function initParentType(){var _this=this;var arrHtml=['<option value="-1">全部</option>'];var $parentTypeList=$("#parentTypeList");var $parentList=$('.parentList');if(_this.baseType=='groups'){$parentList.html('<option value="'+_this.parentNode['_id']+'">'+_this.parentNode.name+'</option>');$parentList.attr("disabled","disabled");}else{$parentList.html(arrHtml.join(''));$('#btnAddParent').show();}
_this.groupDataSource=_this.filter.dictClass[_this.parentNode.baseType];if(_this.baseType=="groups"&&_this.groupDataSource[_this.parentNode.type]){$parentTypeList.html('<option value="'+_this.parentNode.type+'">'+_this.groupDataSource[_this.parentNode.type].name+'</option>').attr('disabled','disabled');return;}
for(var obj in _this.groupDataSource){if(_this.groupDataSource.hasOwnProperty(obj)){var name=_this.groupDataSource[obj]["name"];arrHtml.push("<option value='"+obj+"'>"+name+"</option>");}}
var arrParentList=['<option value="-1">请选择</option>'];for(var i=0;i<_this.filter.store.groups.length;i++){if(_this.filter.store.groups[i]['_id']==_this.parentNode['_id']){$parentList.val(_this.parentNode['_id']);}
arrParentList.push('<option value="'+_this.filter.store.groups[i]['_id']+'">'+_this.filter.store.groups[i].name+'</option>');}
$parentList.html(arrParentList.join(''));$parentTypeList.html(arrHtml.join(''));if(_this.mode=='add'){$parentList.val(_this.parentNode['_id']);}else if(_this.mode=='edit'){if(typeof _this.treeNode.pId=='string'){$('.parentList').eq(0).val(_this.treeNode.pId);}else if(_this.treeNode.pId instanceof Array){$('.parentList').eq(0).val(_this.treeNode.pId[0]);for(var i=1;i<_this.treeNode.pId.length;i++){_this.parentAdd().val(_this.treeNode.pId[i]);}}}
$parentTypeList.on("change",function(){if(_this.baseType=='groups')return;var selectedOpt=$("#parentTypeList option:selected").attr("value");_this.getParentList(selectedOpt);});},getParentList:function getParentList(val){var _this=this;var arrHtml=["<option value='-1'>请选择</option>"];var $parentList=$('.parentList');for(var i=0;i<_this.filter.store.groups.length;i++){if(val==-1||_this.filter.store.groups[i].type==val){if(_this.filter.store.groups[i]['_id']==_this.parentNode['_id']){$parentList.val(_this.parentNode['_id']);}
arrHtml.push('<option value="'+_this.filter.store.groups[i]['_id']+'">'+_this.filter.store.groups[i].name+'</option>');}else{}}
$parentList.html(arrHtml.join(""));},parentAdd:function parentAdd(){var $divParentList=$($('.divParentList')[0].outerHTML);$('#boxParentList').append($divParentList);return $divParentList;},generateName:function generateName(){var _this=this;var input=_this.nameInput.value.trim();var names=[];if(_this.batch){try{var config=$("#batchNameArea").val().trim();config=config.replace(/([\w]+)(:)/g,"\"$1\"$2");config=config.replace(/'/g,"\"");if(config==''){alert('名称批量设置为空！');return names;}else{var nameConfig=JSON.parse(config);for(var item in nameConfig){if(nameConfig.hasOwnProperty(item)){var reg=new RegExp('<#'+item+'#>','g');if(Object.prototype.toString.call(nameConfig[item]).slice()==='[object Array]'){for(var j=0;j<nameConfig[item].length;j++){if(names.length!==nameConfig[item].length){names.push(input.replace(reg,nameConfig[item][j]));}else{names[j]=names[j].replace(reg,nameConfig[item][j]);}}}else{var min=parseInt(nameConfig[item]["min"],10);var max=parseInt(nameConfig[item]["max"],10);var step=parseInt(nameConfig[item]["step"],10)||1;for(var k=0;k<max-min+1;k++){if(names.length!==max-min+1){names.push(input.replace(reg,k+min));}else{console.log(_typeof(names[k]));names[k]=names[k].replace(reg,k*step+min);}}}}}}}catch(e){_this.batchErr.name=true;}}else{names.push(input);}
return names;},generatePrefix:function generatePrefix(){var _this=this;var input=_this.prefixInput.value.trim();var prefix=[];if(_this.batch){try{if(input===''||input.length===0){for(var i=0;i<_this.names.length;i++){prefix.push('');}}else{var config=$("#batchPrefixArea").val().trim();config=config.replace(/([\w]+)(:)/g,"\"$1\"$2");config=config.replace(/'/g,"\"");if(config==''){alert('前缀批量设置为空！');return prefix;}
var prefixConfig=JSON.parse(config);for(var item in prefixConfig){if(prefixConfig.hasOwnProperty(item)){var reg=new RegExp('<#'+item+'#>','g');if(Object.prototype.toString.call(prefixConfig[item]).slice()==='[object Array]'){var pre;for(var j=0;j<prefixConfig[item].length;j++){if(prefix.length!==prefixConfig[item].length){pre=input.replace(reg,prefixConfig[item][j]);prefix.push(pre);}else{pre=prefix[j].replace(reg,prefixConfig[item][j]);prefix[j]=pre;}}}else{var min=parseInt(prefixConfig[item]["min"],10);var max=parseInt(prefixConfig[item]["max"],10);for(var k=0;k<max-min+1;k++){if(prefix.length!==max-min+1){prefix.push(input.replace(reg,k+min));}else{console.log(_typeof(prefix[k]));prefix[k]=prefix[k].replace(reg,k+min);}}}}}}}catch(e){_this.batchErr.prefix=true;}}else{if(input===''||input.length===0){prefix.push('');}else{prefix.push(input);}}
return prefix;},generatePId:function generatePId(){var $parentList=$('.parentList');var pId={};var arrPId=[];pId[_this.parentNode['_id']]=true;for(var i=0;i<$parentList.length;i++){if($parentList.eq(i).val()&&$parentList.eq(i).val()!='-1'){pId[$parentList.eq(i).val()]=true;}}
for(var ele in pId){arrPId.push(ele);}
if(arrPId.length==1)arrPId=arrPId.toString();return arrPId;},addGroup:function addGroup(){var _this=this;var groupList=document.getElementById("groupList"),subGroupList=document.getElementById("subGroupList"),group=groupList.options[groupList.selectedIndex].value,subGroup=subGroupList.options[subGroupList.selectedIndex].value,subGroupName=subGroupList.options[subGroupList.selectedIndex].text;if(group!=="-1"&&subGroup!=="-1"){var addedGroup=document.getElementById("addedGroup");var div=document.createElement("div"),name=document.createElement("span"),rmBtn=document.createElement("div"),icon=document.createElement("span");div.className="col-sm-3 btn";div.setAttribute("data-group",group);div.setAttribute("data-subgroup",subGroup);div.setAttribute("data-name",subGroupName);name.innerHTML=subGroupName;icon.className="glyphicon glyphicon-minus";rmBtn.appendChild(icon);rmBtn.style.float="right";div.appendChild(name);div.appendChild(rmBtn);addedGroup.appendChild(div);if(addedGroup.classList.contains("hide")){addedGroup.classList.remove("hide");}
rmBtn.onclick=function(e){var addedGroup=document.getElementById("addedGroup"),currentRow=e.target.parentElement.parentElement;addedGroup.removeChild(currentRow);if(addedGroup.childElementCount===0){addedGroup.classList.add("hide");}};}},removeGroup:function removeGroup(e){var addedGroup=document.getElementById("addedGroup"),currentRow=e.parentNode;addedGroup.removeChild(currentRow);if(addedGroup.childElementCount===0){addedGroup.classList.add("hide");}},getAddedGroup:function getAddedGroup(){var _this=this;var arr=[];var groupRow=document.getElementById("addedGroup").childNodes;for(var i=0;i<groupRow.length;i++){if(groupRow[i].nodeName.toLowerCase()=='div'&&groupRow[i].hasAttribute("data-group")){var g={};g.group=groupRow[i].getAttribute("data-group");g.subGroup=groupRow[i].getAttribute("data-subGroup");g.name=groupRow[i].getAttribute("data-name");arr.push(g);}}
return arr;},getBindDataSource:function getBindDataSource(){var _this=this;_this.devices.forEach(function(val,index){var device=val;var p=device.prefix;var attrs=device.attrs;var arrP=device.arrP;WebAPI.get("/point_tool/searchCloudPoint/"+_this.parentNode.projId+"/"+p+"/").done(function(result){if(result.success){var data=result.data["pointTable"];if(data.length==0){_this.initBindData(device);return;}
var idGroup=[];for(var n=0,len=data.length;n<len;n++){idGroup.push(data[n]._id);}
for(var j=0;j<attrs.length;j++){for(var k=0;k<data.length;k++){if(attrs[j]["fullName"]===data[k]["value"]){attrs[j]["id"]=data[k]["_id"];arrP[attrs[j]["name"]]=data[k]["_id"];}}}
var postData={"dsItemIds":idGroup};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(result){if(result.dsItemList&&result.dsItemList.length>0){var d=result["dsItemList"];for(var l=0;l<attrs.length;l++){for(var m=0;m<d.length;m++){if(attrs[l]["id"]===d[m]["dsItemId"]){attrs[l]["value"]=d[m]["data"];}}}}else{console.log("the data of bind point is not loaded");}
_this.initBindData(device);});}else{console.log("the data of prefix attrs is not loaded");}}).fail(function(){_this.initBindData(device);});});},initBindData:function initBindData(device){var _this=this;var names=_this.names;var frag=document.createDocumentFragment();var name=document.createElement("label"),wrap=document.createElement("div"),container=document.createElement("div");wrap.className="form-group row";container.className="container-fluid";container.setAttribute("data-name",device.name);name.className="text-center col-sm-12 form-control-label";name.innerHTML="名称(Name)："+device.name;wrap.appendChild(name);container.appendChild(wrap);for(var k=0,leng=device.attrs.length;k<leng;k++){var div=document.createElement("div"),lab=document.createElement("label"),cnlab=document.createElement("label"),btn=document.createElement("div");div.className="form-group row";lab.className="text-center col-sm-4 form-control-label";cnlab.className="text-center col-sm-4 form-control-label";btn.className="btn text-center col-sm-3";div.id=device.attrs[k]["id"];lab.innerHTML=device.attrs[k]["fullName"];cnlab.innerHTML=device.attrs[k]["cnName"];btn.innerHTML=device.attrs[k]["value"];div.appendChild(lab);div.appendChild(cnlab);div.appendChild(btn);container.appendChild(div);}
frag.appendChild(container);_this.bindDataGroup.appendChild(frag);},generateFullBindData:function generateFullBindData(){var _this=this;var arr=[];for(var i=0;i<_this.devices.length;i++){for(var attr in _this.type["attrs"]){if(_this.type["attrs"].hasOwnProperty(attr)){var obj={};obj["fullName"]=_this.devices[i]["prefix"]+attr;obj["cnName"]=_this.type["attrs"][attr]["name"];obj["value"]='--';obj["id"]=null;arr.push(obj);_this.devices[i]["attrs"].push(obj);}}}
return arr;},onCarouselMove:function onCarouselMove(){var _this=this;var currentIndex=$(this).find('.active').index()+1;if(currentIndex!==1){}else{$("#nextBtn").hide();$("#confirmBtn").removeClass("hide");}},checkValid:function checkValid(index){var _this=this;var valid;if(index===0){_this.batchErr={name:false,prefix:false};_this.names=_this.generateName();_this.prefix=_this.generatePrefix();if(_this.nameInput.value.trim()===""){alert("请输入设备名称");_this.nameInput.focus();valid=false;}else if(_this.batch&&_this.nameConfigInput.value.trim()===""){alert("请输入名称批量设置");_this.nameConfigInput.focus();}else if(_this.typeList.options[_this.typeList.selectedIndex].value==='-1'){alert("请选择类型");_this.typeList.focus();valid=false;}else if(_this.batchErr.name){alert("名字批量设置格式错误，请检查");}else if(_this.batchErr.prefix){alert("前缀批量设置格式错误，请检查");}else{valid=true;}
if(valid){_this.type=_this.typeList.options[_this.typeList.selectedIndex].value;_this.pId=_this.generatePId();_this.createDevice();if(_this.mode=='edit'||_this.prefix&&_this.prefix instanceof Array&&_this.prefix.join('').length>0){_this.getBindDataSource();$("#createModalSld").carousel("next");}else{_this.closeModal(true);}}}}};return CreateDeviceModal;}();var EquipmentScreen=function(window){function EquipmentScreen(){}
EquipmentScreen.prototype={show:function show(){Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/equipment/equipmentManage.html").done(function(resultHtml){Spinner.stop();$(ElScreenContainer).html(resultHtml);});},close:function close(){$(ElScreenContainer).empty();},init:function init(){}};return EquipmentScreen;}(window);var PartsPurchaseScreen=function(window){function PartsPurchaseScreen(){}
PartsPurchaseScreen.prototype={show:function show(){Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/equipment/partsPurchaseManage.html").done(function(resultHtml){Spinner.stop();$(ElScreenContainer).html(resultHtml);});},close:function close(){$(ElScreenContainer).empty();},init:function init(){}};return PartsPurchaseScreen;}(window);var PartsScreen=function(window){function PartsScreen(){}
PartsScreen.prototype={show:function show(){Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/equipment/partsManage.html").done(function(resultHtml){Spinner.stop();$(ElScreenContainer).html(resultHtml);});},close:function close(){$(ElScreenContainer).empty();},init:function init(){}};return PartsScreen;}(window);var ProductDownload=function(){function ProductDownload(){this.curr=undefined;this.interval=undefined;this.all=undefined;}
ProductDownload.prototype={show:function show(){WebAPI.get('/static/views/admin/productDownload.html').done(function(resultHtml){$('#indexMain').html(resultHtml);});this.init();},init:function init(){this.curr=1;this.interval=5000;this.all=0;var len=this.elemNodesLen(document.getElementById('scroll_product_list').childNodes);this.all=len;var _this=this;var $scrollProductList=$("#scroll_product_list");var $mediaAndSupport=$(".mediaandsupport .list-group-item");var $panel=$(".panel");var $divideTitle=$(".divide-title");$("#scroll_btn_list li").each(function(index,domEle){$(domEle).mouseover(function(event){_this.pause();var prev=_this.curr;if(prev==index){return;}
var curr=index+1;_this.timeoutSet=setTimeout(function(){_this.go(curr);},500);event.stopPropagation();}).mouseout(function(){_this.timeoutSet&&clearTimeout(_this.timeoutSet);_this.play();});});$scrollProductList.mouseover(function(){_this.pause();});$scrollProductList.mouseout(function(){_this.play();});_this.play();$(".panel>.panel-heading:first").css('background','#bce8f1');$panel.on('show.bs.collapse',function(){$(this).find('.panel-heading').css('background','#bce8f1');});$panel.on('hide.bs.collapse',function(){$(this).find('.panel-heading').css('background','white');});$mediaAndSupport.not($divideTitle).mouseenter(function(){$(this).css('border','1px solid #bce8f1');});$mediaAndSupport.not($divideTitle).mouseleave(function(){$(this).css('border','1px solid transparent');});$mediaAndSupport.mouseenter(function(){$(this).find('.btn').css('display','inline');});$mediaAndSupport.mouseleave(function(){$(this).find('.btn').css('display','none');});},next:function next(){var to;if(this.curr==this.all){to=1;}else{to=this.curr+1;}
this.go(to);},prev:function prev(){var to;if(this.curr==1){to=this.all;}else{to=this.curr-1;}
this.go(to);},go:function go(index){var curr=this.curr;if(curr==index){return;}
var elems_b=$("#scroll_product_list li");var curr_elem=elems_b.eq(curr-1);curr_elem.animate({opacity:0},500,null,function(){curr_elem.removeClass('on');});elems_b.eq(index-1).css('opacity',0).addClass('on').animate({opacity:1},500);var elems_btn=$("#scroll_btn_list li");elems_btn.removeClass('on');elems_btn.eq(index-1).addClass('on');var elems_download=$("#scroll_download_list li");elems_download.removeClass('on');elems_download.eq(index-1).addClass('on');this.curr=index;},pause:function pause(){this.timeSet&&clearInterval(this.timeSet);},play:function play(){this.timeSet&&clearInterval(this.timeSet);var e=this;this.timeSet=setInterval(function(){this.next();},this.interval);},elemNodesLen:function elemNodesLen(elems){if(!elems||typeof elems.length=='undefined'||elems.length==0)return 0;var len_true=0;for(var i=0,len=elems.length;i<len;i++){if(elems[i].nodeType==1){len_true++;}}
return len_true;}};return ProductDownload;}();var UserManagerController=function(){function User(){this.id=null;this.username=null;this.userfullname=null;this.userpic=null;}
User.prototype={updateUserfullname:function updateUserfullname(userfullname,usersex){var _this=this;return WebAPI.post('/admin/updateUser',{id:this.id,userfullname:userfullname,usersex:usersex}).done(function(result){if(result.success){_this.userfullname=userfullname;}});},updatePassword:function updatePassword(oldPwd,newPwd){return WebAPI.post('/admin/updateUser',{id:this.id,oldPassword:oldPwd,password:newPwd});},updateAvatar:function updateAvatar(fileData){var _this=this;var formData=new FormData();formData.append('file',fileData);formData.append('userId',this.id);return $.ajax({url:'/admin/updateAvatar',type:'POST',data:formData,cache:false,processData:false,contentType:false,success:function success(result,textStatus,jqXHR){if(typeof result.error==='undefined'&&result.success){_this.userpic=result.data;AppConfig.userProfile.picture=result.data;$("#iconList .userPic").attr("src",result.data);$("#btnAccountManage .userPic").attr("src",result.data);}else{var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[result.code]);alert.showAtTop(2000);}}});}};function Records(){this.recordType={0:I18n.resource.admin.panelManagement.ALL_RECORDS,1:I18n.resource.admin.panelManagement.ACCOUNT_LOGIN_RECORD,2:I18n.resource.admin.panelManagement.USER_MANAGEMENT_RECORD,3:I18n.resource.admin.panelManagement.PAGE_MANAGEMENT_RECORD};this.loginRecords=[];this.userManageRecords=[];this.pageManageRecords=[];this.allRecords=[];}
Records.prototype={fetchRecords:function fetchRecords(recordType,userId,beginTime,endTime){var postData={userId:userId,beginTime:beginTime,endTime:endTime};return WebAPI.post('/admin/getRecords',postData);},fetchLoginRecords:function fetchLoginRecords(userId,beginTime,endTime){var _this=this;if(arguments.length!=1){return this.fetchRecords(1,userId,beginTime,endTime).done(function(result){_this.loginRecords=result&&result.data||[];});}else{return this.fetchRecords(1,userId).done(function(result){_this.loginRecords=result&&result.data||[];});}}};function UserManagerController(manager){if(typeof manager==='string'){manager=window[manager];}
this.manager=manager;this.recordVM=new Records();this.viewSource="/static/views/admin/userManager/userManagerController.html";}
UserManagerController.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.viewSource).done(function(resultHtml){var $ElScreenContainer=$(ElScreenContainer).html($(resultHtml));var $tab=beopTmpl('managerTabTmpl',AppConfig);$ElScreenContainer.find('#manageTab').append($tab);_this.init();ScreenManager.applyScreen(_this.manager);I18n.fillArea($(ElScreenContainer));$('#manageTab li[screen="'+BEOPUtil.getFunctionName(_this.manager)+'"] a').tab('show');}).always(function(){});},init:function init(){var _this=this;$('#manageTab a').click(function(e){var screen=$(this).parent().attr('screen');if(screen&&window[screen]){_this.manager=window[screen];ScreenManager.show(UserManagerController,_this.manager.name);}});},close:function close(){$(document).off('click.userManager');this.addValidStatus("hide",$("#editInput"),'top');this.addValidStatus("hide",$('#editOldPwd'));this.addValidStatus("hide",$('#editNewPwd'));this.addValidStatus("hide",$('#editCheckNewPwd'));},addValidStatus:function addValidStatus(msg,$obj,placement){var placement=placement||'right';var errorTooltip=$obj.tooltip({container:'body',placement:placement,trigger:"manual",template:'<div class="tooltip" role="tooltip">'+'<div class="tooltip-arrow"></div>'+'<div class="tooltip-inner"></div>'+'</div>',html:true,title:msg||''});if(msg!="hide"){errorTooltip.tooltip('show');}else{errorTooltip&&errorTooltip.tooltip('destroy');}},loadUser:function loadUser(userId){var dfd=$.Deferred();if(!userId){dfd.reject();}
return WebAPI.get('/admin/accountManger/'+userId).pipe(function(result){if(result.success){var user=$.extend(true,new User(),result.data);dfd.resolve(user);}else{dfd.reject(result);}
return dfd;});},loadRecords:function loadRecords(){var dfd=$.Deferred();dfd.resolve(new Records());return dfd;},setFloatingWin:function setFloatingWin($win,h){var wh=$(window).height();var top=(wh-h)/2;$win.find(".modal-dialog").css({'top':top});$win.modal();},checkEmail:function checkEmail(str){var flag=true;var re=/^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;if(re.test(str)){flag=true;return flag;}else{flag=false;return flag;}},buildSubTree:function buildSubTree(buildTreeItemFunc,root,childField){if(!buildTreeItemFunc||typeof buildTreeItemFunc!=='function'){return'';}
if(!childField){childField='children';}
if(root[childField]&&root[childField].length>0){var $container=$('<ul></ul>');for(var i=0;i<root[childField].length;i++){var child=root[childField][i];var $li=$(buildTreeItemFunc(child));if(child[childField]&&child[childField].length){$li.append(this.buildSubTree(buildTreeItemFunc,child,childField));}
$container.append($li);}
return $container;}},validateTime:function validateTime($startTime,$endTime,$msg){var flag=false;var startTimeVal=$startTime.val();var endTimeVal=$endTime.val();if(startTimeVal==""){$msg.text(I18n.resource.admin.panelManagement.START_TIME_CHECKINFO).css("display","block");flag=false;}else if(endTimeVal==""){$msg.text(I18n.resource.admin.panelManagement.END_TIME_CHECKINFO).css("display","block");flag=false;}else if(startTimeVal>endTimeVal){$msg.text(I18n.resource.admin.panelManagement.TIME_GREATER_CHECKINFO).css("display","block");flag=false;}else{flag=true;}
if(flag){$msg.hide();}else{$msg.show();}
return flag;},isArrayRepeat:function isArrayRepeat(arr){return(/(\x0f[^\x0f]+)\x0f[\s\S]*\1/.test("\x0f"+arr.join("\x0f\x0f")+"\x0f"));},renderLoginRecords:function renderLoginRecords($container){var compiledTemplate=beopTmpl('loginRecordTmpl',this.recordVM.loginRecords);$container.html(compiledTemplate);},renderRecordsEvent:function renderRecordsEvent(userId,$startTime,$endTime,$msg,$container,isWinFlag){var flag=this.validateTime($startTime,$endTime,$msg);if(flag){if(!userId){return false;}
if(isWinFlag){$("#userAllRecord").show();}
var beginTime=$startTime.val(),endTime=$endTime.val(),_this=this;this.recordVM.fetchLoginRecords(userId,beginTime,endTime).done(function(){_this.renderLoginRecords($container);});}else{if(isWinFlag){$("#userAllRecord").hide();}}},getRecordsOne:function getRecordsOne(userId,$container,isWinFlag){if(!userId){return false;}
if(isWinFlag){$("#userAllRecord").show();}
var _this=this;this.recordVM.fetchLoginRecords(userId).done(function(){_this.renderLoginRecords($container);});}};return UserManagerController;}();var AccountManager=function(){function AccountManager(){this.viewSource="/static/views/admin/userManager/accountManager.html";this.managerCtrl=new UserManagerController();this.userVM=null;this.recordVM=null;this.$container=$();this.i18=I18n.resource.admin.panelManagement;this.datePickerInstance=null;this.reportEmailSetting={name:null,sex:null,email:{email1:null,email2:null,email3:null},data:[]};this.isHadSettingBefore=false;}
var timeOutValue=60;var wait=timeOutValue;var timerCheckCodes;AccountManager.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.viewSource).done(function(resultHtml){_this.$container=$('#accountManageWrapper').html(resultHtml).find('#accountManage');$("#panelContentWrapper").hide();_this.init();_this.managerCtrl.getRecordsOne.call(_this.managerCtrl,AppConfig.userId,$('#allRecord'),false);I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});},setUserInfoHeight:function setUserInfoHeight(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-20);},resetMonth:function resetMonth(ev){var _this=this;var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){var year=_this.datePickerInstance.viewDate.format('yyyy-MM').split("-")[0];var currentYear=new Date().getFullYear();var currentMonth=new Date().getMonth()+1;var monthItem=_this.datePickerInstance.picker.find(".month");if(year==currentYear){for(var i=0;i<currentMonth;i++){monthItem.eq(i).removeClass("disabled");}}},50);},init:function init(){var _this=this;this.setUserInfoHeight();$("#panelContentWrapper").show();this.renderManageUserInfo(AppConfig.userId);this.managerCtrl.loadRecords().done(function(result){_this.recordVM=result;});var $txtLogDateStart=$("#txtLogDateStart");$txtLogDateStart.datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true,endDate:new Date()}).on('show',function(ev){_this.resetMonth(ev);_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.resetMonth(ev);});}).on('changeYear changeMonth',function(ev){_this.resetMonth(ev);});this.datePickerInstance=$txtLogDateStart.data('datetimepicker');$("#txtLogDateEnd").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true});this.$inputBindPhone=$(ElScreenContainer).find('#inputBindPhone');this.$inputNewBindPhone=$(ElScreenContainer).find('#inputNewBindPhone');this.$inputCheckCode=$(ElScreenContainer).find('#inputCheckCode');this.$btnPhoneSubmit=$(ElScreenContainer).find('#btnPhoneSubmit');this.$btnChkCodeSubmit=$(ElScreenContainer).find('#btnChkCodeSubmit');this.$spanTimer=$(ElScreenContainer).find('#spanTimer');var phone=AppConfig.userProfile.core?AppConfig.userProfile.core:'';this.$inputBindPhone.val(phone);this.$inputBindPhone.attr('placeholder',I18n.resource.accountSecurity.BIND_PHONE_TIPS);this.$inputNewBindPhone.attr('placeholder',I18n.resource.accountSecurity.NEW_PHONE_TIPS);this.attachEvents();},renderManageUserInfo:function renderManageUserInfo(userId){var _this=this;Spinner.spin(ElScreenContainer);this.managerCtrl.loadUser(userId).done(function(user){_this.userVM=user;_this.refreshManageUserInfo();_this.refreshManageUserInfoForm();I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});},refreshManageUserInfo:function refreshManageUserInfo(){var compiledTemplate=beopTmpl('paneProjectUserInfoTmpl',this.userVM);this.$container.find('#userInfo').html(compiledTemplate);},refreshManageUserInfoForm:function refreshManageUserInfoForm(){var compiledTemplateForm=beopTmpl('paneProjectUserInfoFormTmpl',this.userVM);this.$container.find('#basicSet').html(compiledTemplateForm);},attachEvents:function attachEvents(){var _this=this;this.$container.on("click","#confrimEditName",function(){var userfullname=$.trim($('#accountManage #editInput').val());var flag=/^(\w|-|[\u4E00-\u9FA5]){2,10}$/g.test(userfullname);var sexVal=$('#basicSetInfoWrapper input:radio[name="userSex"]:checked').val().trim();var sexFlag=$('#basicSetInfoWrapper input:radio[name="userSex"]').is(":checked");if(!flag){_this.managerCtrl.addValidStatus(_this.i18.EMAIL_FORMAT,$("#editInput"),"right");return;}
if(!sexFlag){alert("性别不能为空！");return;}
_this.managerCtrl.addValidStatus("hide",$("#editInput"),"right");Spinner.spin(ElScreenContainer);_this.userVM.updateUserfullname(userfullname,sexVal).done(function(result){if(result.success){_this.refreshManageUserInfo();AppConfig.userProfile.fullname=userfullname;AppConfig.userProfile.sex=sexVal;}}).always(function(){I18n.fillArea($(ElScreenContainer));Spinner.stop();});$("#paneUser").text(userfullname);$("#useName").text(userfullname);});$('#submitResetPwd').click(function(){var $oldPwd=$('#editOldPwd'),$newPwd=$('#editNewPwd'),$editCheckNewPwd=$('#editCheckNewPwd');var oldPwd=$oldPwd.val(),newPwd=$newPwd.val(),editCheckNewPwd=$editCheckNewPwd.val();var $returnInfo=$("#returnInfo"),$returnInfoCon=$("#returnInfoCon");if(oldPwd==""){_this.managerCtrl.addValidStatus(_this.i18.ORIGINAL_PASSWORD_NULL,$oldPwd);$returnInfoCon.hide();return;}else{_this.managerCtrl.addValidStatus('hide',$oldPwd);}
if(newPwd==""){_this.managerCtrl.addValidStatus(_this.i18.NEW_PASSWORD_NULL,$newPwd);$returnInfoCon.hide();return;}else{_this.managerCtrl.addValidStatus('hide',$newPwd);}
if(editCheckNewPwd==""){_this.managerCtrl.addValidStatus(_this.i18.CONFIRMED_PASSWORD_NULL,$editCheckNewPwd);$returnInfoCon.hide();return;}else{_this.managerCtrl.addValidStatus('hide',$editCheckNewPwd);}
if(newPwd!=editCheckNewPwd){_this.managerCtrl.addValidStatus(_this.i18.PASSWORD_CONSISTENT_ERROR,$newPwd);$returnInfoCon.hide();return;}else{_this.managerCtrl.addValidStatus('hide',$newPwd);}
if(!(newPwd.length>5&&newPwd.length<16)){_this.managerCtrl.addValidStatus(_this.i18.PASSWORD_FORMAT_ERROR,$newPwd);$returnInfoCon.hide();return;}
_this.userVM.updatePassword(oldPwd,newPwd).done(function(result){$returnInfo.text(I18n.resource.code[result.code[0]]);$returnInfoCon.show();if(result.success){$oldPwd.val("");$newPwd.val("");$editCheckNewPwd.val("");$returnInfoCon.hide();var alert=new Alert(ElScreenContainer,Alert.type.success,"修改成功！");alert.showAtTop(2000);}else{errCode=result.code[0];if(errCode>=1101&&errCode<=1106){_this.managerCtrl.addValidStatus(I18n.resource.code[errCode],$newPwd);$returnInfoCon.hide();}else{$returnInfoCon.show();$returnInfo.show();}
return false;}}).fail(function(){$returnInfo.text(_this.i18.REQUEST_ERROR);$returnInfoCon.show();}).always(function(){I18n.fillArea($(ElScreenContainer));});});$('#tabsUl').on('show.bs.tab',"li",function(){_this.managerCtrl.addValidStatus("hide",$("#editInput"));_this.managerCtrl.addValidStatus('hide',$('#editOldPwd'));_this.managerCtrl.addValidStatus('hide',$('#editNewPwd'));_this.managerCtrl.addValidStatus('hide',$('#editCheckNewPwd'));_this.managerCtrl.addValidStatus('hide',_this.$inputNewBindPhone);_this.managerCtrl.addValidStatus('hide',_this.$inputCheckCode);$("#returnInfo").hide();});this.$container.on('change','#file-input',function(event){Spinner.spin(ElScreenContainer);event.stopPropagation();event.preventDefault();try{var fileData=event.target.files[0];if(fileData.size>1024*1024){$(".modal-dialog").css({'top':($(window).height()-200)/2});$("#PromptWinInfo").text(_this.i18.FILE_SIZE_LIMITED);$("#PromptWin").modal();var t=null;t&&clearTimeout(t);t=setTimeout(function(){$("#PromptWin").modal("hide");},2000);Spinner.stop();return false;}}catch(e){Spinner.stop();}
_this.userVM.updateAvatar(fileData).done(function(result){Spinner.spin(ElScreenContainer);if(result.success){$('.image-upload img').attr('src',result.data);AppConfig.userProfile.picture=result.data;}}).always(function(){Spinner.stop();});});$("#searchRecord").click(function(){_this.managerCtrl.renderRecordsEvent.call(_this.managerCtrl,AppConfig.userId,$("#txtLogDateStart"),$("#txtLogDateEnd"),$("#infoDate"),$('#allRecord'),false);});var accountPanel=_this.$container.find('#accountManagePanel');accountPanel.find('a[data-toggle="tab"]').on('shown.bs.tab',function(){var param=$(this).data('shown'),togglePlans=accountPanel.find('.panel-body div.row');togglePlans.hide();accountPanel.find('#'+param).show();if(param=='reportEmailSetting'){_this.renderProject();}});$(window).on("resize.setUserInfoHeight",function(){_this.setUserInfoHeight();});this.attachAccountSecurityEvent();},detachEvents:function detachEvents(){$(window).off("resize.setUserInfoHeight");},close:function close(){this.detachEvents();this.managerCtrl.addValidStatus("hide",$("#editInput"),'top');this.managerCtrl.addValidStatus("hide",$('#editOldPwd'));this.managerCtrl.addValidStatus("hide",$('#editNewPwd'));this.managerCtrl.addValidStatus("hide",$('#editCheckNewPwd'));this.managerCtrl.addValidStatus('hide',this.$inputNewBindPhone);this.managerCtrl.addValidStatus('hide',this.$inputCheckCode);},renderProject:function renderProject(){this.reportEmailSetting.data=[];this.reportEmailSettingIDList=[];Spinner.spin(ElScreenContainer);I18n.fillArea($(ElScreenContainer));var projectList=AppConfig.projectList,_this=this;if(projectList==null||projectList=='undefined'){alert(I18n.resource.admin.reportEmailSetting.READ_USER_FAIL);}
var i=0,projectNameList=[];var language=window.localStorage.getItem('language');if(language=='en'){for(i=0;i<projectList.length;i++){projectNameList.push({title:projectList[i].name_en,id:projectList[i].id});}
document.documentElement.setAttribute('lang','en-us');}else if(language=='zh'){for(i=0;i<projectList.length;i++){projectNameList.push({title:projectList[i].name_cn,id:projectList[i].id});}
document.documentElement.setAttribute('lang','zh');}
var $container=$('#reportEmailSetting');var $projectListContainer=$container.find('.wf-project-list');$container.find('.wf-report-setting-email').find('input[type="email"]').val('');$projectListContainer.html(beopTmpl('projectNameList',{projectNameList:projectNameList}));this.getUserReportEmailSetting();},getUserReportEmailSetting:function getUserReportEmailSetting(){var _this=this;if(AppConfig.userId==1){WebAPI.get('/workflow/reportEmailSetting/get/'+1).done(function(result){_this.renderUserReporterEmailSetting(result.data);}).always(function(){Spinner.stop();}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.reportEmailSetting.GET_FAILED).showAtTop(1000);});}else{WebAPI.get('/workflow/reportEmailSetting/get/'+1).done(function(result){}).always(function(result){WebAPI.get('/workflow/reportEmailSetting/get/'+AppConfig.userId).done(function(userSetting){_this.isHadSettingBefore=false;if(userSetting.data){try{var projectIdList=userSetting.data.projectId;if(Array.isArray(projectIdList)&&projectIdList.length){_this.isHadSettingBefore=true;}}catch(ex){}}
_this.renderUserReporterEmailSetting(userSetting.data,result.data);}).always(function(){Spinner.stop();}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.reportEmailSetting.GET_FAILED).showAtTop(1000);});}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.reportEmailSetting.GET_FAILED).showAtTop(1000);});}},renderUserReporterEmailSetting:function renderUserReporterEmailSetting(data,adminSetting){if(data!==null){var i=0,mailItem,mail=[],item,html='';this.reportEmailSetting.name=data.name;for(i=0;i<3;i++){mailItem=data['mail'+(i+1)];if(mailItem!==null&&mailItem!==undefined&&mailItem!==''){mail.push(mailItem);}}
for(i=0;i<mail.length;i++){item=$.trim(mail[i]);html+='<div class="col-sm-3 wf-report-setting-email"><input oninvalid="alert(I18n.resource.admin.reportEmailSetting.PLEASE_INPUT_RIGHT_EMAIL);return false;" value="'+item+'" type="email" class="form-control" placeholder="email" required/>'+'<span class="glyphicon glyphicon-remove wf-report-remove-email"></span></div>';}
if(mail.length==0){html='<div class="col-sm-3 wf-report-setting-email"><input oninvalid="alert(I18n.resource.admin.reportEmailSetting.PLEASE_INPUT_RIGHT_EMAIL);return false;" value="" type="email" class="form-control" placeholder="email" required/>'+'<span class="glyphicon glyphicon-remove wf-report-remove-email"></span></div>';}
if(mail.length<3){$('#wf-report-email-add').show();}
$('.wf-report-setting-email-container').empty().append(html);if(data.name){$('#wf-report-setting-name').val(data.name);}}
var $this,listProjectId,$list=$('.wf-project-list').find('li');var userSettings,admin;this.reportEmailSetting.sex=this.userVM.usersex;if(AppConfig.userId==1){if(data!==null&&data.projectId!==null&&data.projectId.length){userSettings=data.projectId;}else{userSettings=[];}
this.reportEmailSetting.data=userSettings;$list.each(function(){$this=$(this);listProjectId=$this.attr('data-project-id');userSettings.forEach(function(item){if(item==listProjectId){$this.addClass('selected');$this.find('input[type="checkbox"]').prop('checked','checked');}});});}else{if(data!==null&&data.projectId!==null&&data.projectId.length){userSettings=data.projectId;}else{userSettings=[];}
if(adminSetting){this.reportEmailSetting.data=userSettings;admin=adminSetting.projectId;$list.addClass('disabled').each(function(){$this=$(this);listProjectId=$this.attr('data-project-id');admin.forEach(function(item){if(item==listProjectId){$this.removeClass('disabled');}});userSettings.forEach(function(item){if(item==listProjectId){$this.addClass('selected');$this.find('input[type="checkbox"]').prop('checked','checked');}});});}else{$list.each(function(){$this=$(this);listProjectId=$this.attr('data-project-id');userSettings.forEach(function(item){if(item==listProjectId){$this.addClass('selected');$this.find('input[type="checkbox"]').prop('checked','checked');}});});}}
this.bindProjectListEvent();},bindProjectListEvent:function bindProjectListEvent(){$('#wf-report-setting-name').attr('placeholder',this.userVM.userfullname);var $container=$('#reportEmailSetting'),_this=this,projectList;if(AppConfig.userId==1){projectList=$container.find('.wf-project-list>li').find('label');}else{projectList=$container.find('.wf-project-list>li:not([class*="disabled"])').find('label');}
projectList.off().on('change',function(ev){ev.stopPropagation();var $this=$(this);if($this.find('input').is(':checked')){_this.enableProjectList($this);}else{_this.disableProjectList($this);}});var submit=$container.find('#submit-report-email-list');submit.off().on('submit',_this.submitReportEmailSetting.bind(_this));var emailAdd=$('#wf-report-email-add'),emailLength;emailAdd.off().on('click',function(){var html='<div class="col-sm-3 wf-report-setting-email"><input oninvalid="alert(I18n.resource.admin.reportEmailSetting.PLEASE_INPUT_RIGHT_EMAIL);return false;" type="email" class="form-control" placeholder="email" required>'+'<span class="glyphicon glyphicon-remove wf-report-remove-email"></span></div>',$this=$(this);emailLength=$('.wf-report-setting-email').find('input').length;if(emailLength<3){$this.prev().append(html);if(emailLength==2){emailAdd.hide();}}else{alert(I18n.resource.admin.reportEmailSetting.MAX_EMAIL_ADD);}});$('#accountManagePanel').on('click','.wf-report-remove-email',function(){$(this).parent().remove();if(emailLength<3){emailAdd.show();}});},disableProjectList:function disableProjectList($this){var $parent=$this.parent(),$projectDetail=$parent.find('ul.wf-project-detail'),projectId=$this.parent().attr('data-project-id');$parent.toggleClass('selected');this.reportEmailSetting.data.forEach(function(item,index,array){if(item==projectId){array.splice(index,1);}});},enableProjectList:function enableProjectList($this){var $parent=$this.parent(),id=$parent.attr('data-project-id');if(AppConfig.userId==1){$parent.toggleClass('selected');this.reportEmailSetting.data.push(id);}else{if($parent.hasClass('disabled')){$this.find('input[type="checkbox"]').prop('checked',false);return false;}else{$parent.toggleClass('selected');this.reportEmailSetting.data.push(id);}}},submitReportEmailSetting:function submitReportEmailSetting(ev){var data=this.reportEmailSetting,userId=AppConfig.userId,name;data.sex=this.userVM.usersex;name=$.trim($('#wf-report-setting-name').val());if(name){data.name=name;}else{data.name=this.userVM.userfullname;}
var email=$('.wf-report-setting-email-container').find('input');if(email.length==0){alert(I18n.resource.admin.reportEmailSetting.LEAST_ONE_EMAIL);ev.preventDefault();return false;}else if(data.data.length==0&&this.isHadSettingBefore){alert(I18n.resource.admin.reportEmailSetting.PLEASE_CHOOSE_PROJECT);ev.preventDefault();return false;}else{var extendData;Spinner.spin(ElScreenContainer);for(key in data.email){if(data.email.hasOwnProperty(key)){data.email[key]=null;}}
email.each(function(i){data.email['email'+(i+1)]=$.trim($(this).val());});extendData=$.extend(true,{},data);if(AppConfig.userId!==1){extendData.data=[];$('#reportEmailSetting').find('.wf-project-list>li:not([class*="disabled"])').each(function(){var $this=$(this);if($this.hasClass('selected')){extendData.data.push($this.attr('data-project-id'));}});}
extendData.projectIdList=JSON.stringify(extendData.data);WebAPI.post('workflow/reportEmailSetting/update/'+userId,extendData).done(function(result){if(result.success){Alert.success(ElScreenContainer,I18n.resource.admin.reportEmailSetting.ADD_SUCCESS).showAtTop(1000);}}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.reportEmailSetting.ADD_FAILED).showAtTop(1000);}).always(function(){Spinner.stop();});}},attachAccountSecurityEvent:function attachAccountSecurityEvent(){var _this=this;_this.$btnPhoneSubmit.click(function(e){var phoneNum=_this.$inputNewBindPhone.val();if(!phoneNum){_this.managerCtrl.addValidStatus(I18n.resource.accountSecurity.PHONE_CHECK,_this.$inputNewBindPhone,'bottom');return;}
_this.managerCtrl.addValidStatus('hide',_this.$inputNewBindPhone);wait=timeOutValue;_this.$spanTimer.text(wait);setCheckCodesTimer(_this.$spanTimer);var postData={'userId':AppConfig.userId,'phone':phoneNum};WebAPI.post('/user/sendverifymessage',postData).done(function(result){if(0==result.data){}else if(1==result.data){clearTimeout(timerCheckCodes);_this.$spanTimer.text('');alert(I18n.resource.accountSecurity.PHONE_EXISTED);}else{clearTimeout(timerCheckCodes);_this.$spanTimer.text('');alert(I18n.resource.accountSecurity.SEND_MESSAGE_FAILED);}}).error(function(){clearTimeout(timerCheckCodes);_this.$spanTimer.text('');alert(I18n.resource.accountSecurity.SEND_MESSAGE_FAILED);});});_this.$btnChkCodeSubmit.click(function(e){var phoneNum=_this.$inputNewBindPhone.val();if(!phoneNum){_this.managerCtrl.addValidStatus(I18n.resource.accountSecurity.PHONE_CHECK,_this.$inputNewBindPhone,'bottom');return;}
_this.managerCtrl.addValidStatus('hide',_this.$inputNewBindPhone);var code=_this.$inputCheckCode.val();if(!code){_this.managerCtrl.addValidStatus(I18n.resource.accountSecurity.CHECK_CODE_CHECK,_this.$inputCheckCode,'bottom');return;}
_this.managerCtrl.addValidStatus('hide',_this.$inputCheckCode);var postData={'userId':AppConfig.userId,'phone':phoneNum,'code':code};WebAPI.post('/user/bindingphone',postData).done(function(result){if(result.data){AppConfig.userProfile.core=phoneNum;_this.$inputBindPhone.val(phoneNum);_this.$inputNewBindPhone.val('');_this.$inputCheckCode.val('');clearTimeout(timerCheckCodes);_this.$spanTimer.text('');alert(I18n.resource.accountSecurity.BIND_SUCCESS);}else{_this.$inputCheckCode.val('');clearTimeout(timerCheckCodes);_this.$spanTimer.text('');alert(I18n.resource.accountSecurity.BIND_FAILED);}}).error(function(){_this.$inputCheckCode.val('');clearTimeout(timerCheckCodes);_this.$spanTimer.text('');alert(I18n.resource.accountSecurity.BIND_FAILED);});});}};function setCheckCodesTimer($obj){if(wait<=0){$obj.text(I18n.resource.accountSecurity.CHECK_CODE_TIMEOUT);wait=timeOutValue;}else{$obj.text(wait);wait--;timerCheckCodes=setTimeout(function(){setCheckCodesTimer($obj);},1000);}}
return AccountManager;}();var MemberManager=function(){function MemberManager(){this.viewSource="/static/views/admin/userManager/memberManager.html";this.managerCtrl=new UserManagerController();this.$container=$();this.userTree={};this.i18=I18n.resource.admin.panelManagement;this.datePickerInstance=null;this.allRoleGroupList=[];this.userRoleGroupList=[];}
MemberManager.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.viewSource).done(function(resultHtml){_this.$container=$('#memberManageWrapper').html(resultHtml).find('#memberManage');$("#manageTab li[screen='AccountManager']").remove();$("#manageTab").show();$("#panelContentWrapper").hide();_this.init();I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});},setMemberManagerHeight:function setMemberManagerHeight(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-62);$("#userTreeCon").height($(window).height()-$(".navbar").height()-205);},init:function init(){this.setMemberManagerHeight();$("#panelContentWrapper").show();this.loadUserTree();this.attachEvents();},resetMonth:function resetMonth(ev){var _this=this;var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){var year=_this.datePickerInstance.viewDate.format('yyyy-MM').split("-")[0];var currentYear=new Date().getFullYear();var currentMonth=new Date().getMonth()+1;var monthItem=_this.datePickerInstance.picker.find(".month");if(year==currentYear){for(var i=0;i<currentMonth;i++){monthItem.eq(i).removeClass("disabled");}}},50);},attachEvents:function attachEvents(){var _this=this;var $startDateRecord;var $endDateRecord;var $userSettingWin=$("#userSettingWin");var $userTreeCon=$("#userTreeCon");var $expiryDatePicker=null;var currentUserRoleGroup=[];$userTreeCon.on('click','.setting',function(event){var userId=$(this).closest('li').attr('userId');$userTreeCon.find("span").removeClass("selected");$(this).parents("span").addClass("selected");Spinner.spin(ElScreenContainer);WebAPI.post('/admin/loadUsersSetting',{userId:userId,currentUser:AppConfig.userId}).done(function(result){if(result.success){result.data.managers.sort(function(a,b){return a.userfullname>b.userfullname;});currentUserRoleGroup=result.data.currentUserRoleGroup;if(AppConfig.userId==1||currentUserRoleGroup.indexOf('14')!=-1||currentUserRoleGroup.indexOf('20')!=-1||currentUserRoleGroup.indexOf('22')!=-1){var addUserRoleId=function addUserRoleId(userRoleGroupList,id){if(userRoleGroupList.indexOf(id)==-1){userRoleGroupList.push(id);}},removeUserRoleId=function removeUserRoleId(userRoleGroupList,id){if(userRoleGroupList.indexOf(id)!==-1){userRoleGroupList.forEach(function(item,index,array){if(item==id){array.splice(index,1);}});}};$userSettingWin.find('.modal-body').empty().append(beopTmpl('userSettingTmpl',$.extend(true,{},result.data,{allRoleGroupList:_this.allRoleGroupList})));$userSettingWin.find('#user-role').find('label').each(function(){var $this=$(this),userRoleGroup=result.data.userRoleGroup;_this.userRoleGroupList=userRoleGroup;var roleId=$this.attr('data-role-id');if(AppConfig.userId==1){if(userRoleGroup.indexOf(roleId)!==-1){$this.addClass('active').find('input').prop('checked',true);}}else if(userId==AppConfig.userId){if(userRoleGroup.indexOf(roleId)!==-1){$this.addClass('active').find('input').prop('checked',true).prop('disabled',true);}else{$this.parent().remove();}}else{if(userRoleGroup.indexOf(roleId)!==-1){$this.addClass('active').find('input').prop('checked',true);}else{if(currentUserRoleGroup.indexOf(roleId)==-1){$this.parent().remove();}}}}).find('input[type="checkbox"]').off().change(function(){var $this=$(this),$parent=$this.closest('label'),userRoleId=$parent.attr('data-role-id');if($parent.hasClass('active')){$parent.removeClass('active');$parent.find('input').prop('checked',false);removeUserRoleId(_this.userRoleGroupList,userRoleId);}else{$parent.addClass('active');$parent.find('input').prop('checked',true);addUserRoleId(_this.userRoleGroupList,userRoleId);}});}else{$userSettingWin.find('.modal-body').empty().append(beopTmpl('userSettingTmpl',result.data));}
_this.managerCtrl.setFloatingWin($userSettingWin,700);$userSettingWin.attr("userId",userId);$startDateRecord=$("#recordLogDateStart").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true,endDate:new Date()}).on('show',function(ev){_this.resetMonth(ev);_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.resetMonth(ev);});}).on('changeYear changeMonth',function(ev){_this.resetMonth(ev);});_this.datePickerInstance=$startDateRecord.data('datetimepicker');$endDateRecord=$("#recordLogDateEnd").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true});_this.managerCtrl.getRecordsOne.call(_this.managerCtrl,userId,$('#userAllRecord'),true);}
I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});}).on('click','.glyphicon-minus-sign',function(){var $this=$(this);var $ul=$this.parents("span").next("ul");if($ul.length){$ul.slideUp(300);$this.removeClass("glyphicon-minus-sign").addClass("glyphicon-plus-sign");}}).on('click','.glyphicon-plus-sign',function(){var $this=$(this);var $ul=$this.parents("span").next("ul");if($ul.length){$ul.slideDown(300);$this.removeClass("glyphicon-plus-sign").addClass("glyphicon-minus-sign");}});$userSettingWin.on("click","#userDel",function(){_this.managerCtrl.setFloatingWin($("#isUserDelWin"),300);}).on("click","#userEditConfrim",function(){var userId=$userSettingWin.attr("userId");if(AppConfig.userId==userId){$userSettingWin.modal("hide");}
var isManager=$("#isManager option:selected").val();var supervisor=$('#supervisor  option:selected').val();var oldSupervisor=$('#oldSupervisor').val();var oldIsManager=$('#oldIsManager').val();if(AppConfig.userId==1||currentUserRoleGroup.indexOf('14')!=-1||currentUserRoleGroup.indexOf('20')!=-1||currentUserRoleGroup.indexOf('22')!=-1){WebAPI.post('/admin/updateUsersSetting',{userId:userId,isManager:isManager,supervisor:supervisor,userRoleGroupList:_this.userRoleGroupList}).done(function(result){if(result.success){_this.loadUserTree();$userSettingWin.modal("hide");}
I18n.fillArea($(ElScreenContainer));});}else{$userSettingWin.modal("hide");}}).on("click","#btnRecord",function(){var userId=$userSettingWin.attr('userId');if(!userId){return false;}
_this.managerCtrl.renderRecordsEvent.call(_this.managerCtrl,userId,$('#recordLogDateStart'),$('#recordLogDateEnd'),$('#recordInfoDate'),$('#userAllRecord'),true);}).on('click','#setAccountExpiry',function(){$('#expiryDisplay').hide();$('#expiryEditor').show();$expiryDatePicker=$('#expiryDatePicker').datetimepicker({format:'yyyy-mm-dd',minView:'month',autoclose:true});}).on('click','#setAccountExpiryCancel',function(){$('#expiryDisplay').show();$('#expiryEditor').hide();$('#expiryDatePicker').val('');$expiryDatePicker&&$expiryDatePicker.datetimepicker('remove');}).on('click','#setAccountExpirySave',function(){if(!$expiryDatePicker||!$expiryDatePicker.val()){Alert.danger($userSettingWin.find('.modal-content'),I18n.resource.admin.panelManagement.SET_VALIDITY_PERIOD).showAtTop(2000);return false;}
WebAPI.post('admin/setUserExpiredDate',{userId:$userSettingWin.attr('userid'),expiredDate:$expiryDatePicker.val()}).done(function(result){if(result.success){$('#expiryDisplay').show().find('.expiryText').show().end().find('.expiryDate').text($expiryDatePicker.val());$('#expiryEditor').hide();}});});$("#deleteUser").click(function(){var userId=$userSettingWin.attr("userId");WebAPI.post('/admin/deleteUser',{userId:userId,currentUserId:AppConfig.userId}).done(function(result){if(result.success){_this.loadUserTree();$userSettingWin.modal("hide");$("#isUserDelWin").modal("hide");I18n.fillArea($(ElScreenContainer));}});});$("#addPerson").on("click",function(){_this.loadManagersByUserId(AppConfig.userId).done(function(result){if(!result.success){return false;}
var $addPersonWin=$('#addPersonWin');$(".modal-dialog").css({'top':($(window).height()-600)/2});$addPersonWin.find('.modal-body').empty().append(beopTmpl('addUserTmpl',{addCount:5,managers:result.data}));I18n.fillArea($(ElScreenContainer));$addPersonWin.modal();});});var projectPermission={},selectedUserId,selectedProjectId;$('#addPersonWin').on('change','#selectSupervisor',function(){selectedUserId=$(this).find('option:checked').val();if(!selectedUserId){return false;}
WebAPI.post('/admin/getProjectPermissionByUserId',{userId:selectedUserId}).done(function(result){if(result.success){projectPermission=result.data;var $selectInitProject=$('#selectInitProject').empty();$('#selectInitRole option.roles').remove();var newSelectInitProjectHtml=beopTmpl('selectInitProjectTmpl',projectPermission);$selectInitProject.replaceWith(newSelectInitProjectHtml);}else{$('#selectInitProject').find('option.projects').remove();projectPermission={};}
I18n.fillArea($(ElScreenContainer));}).fail(function(){$('#selectInitProject').find('option.projects').remove();projectPermission={};});}).on('change','#selectInitProject',function(){selectedProjectId=$(this).find('option:checked').val();var $selectInitRole=$('#selectInitRole').empty();var roles=projectPermission[selectedProjectId].roles;if(roles){var newSelectInitRoleHtml=beopTmpl('selectInitRoleTmpl',roles);$selectInitRole.replaceWith(newSelectInitRoleHtml);I18n.fillArea($(ElScreenContainer));}});$('#addPersonOK').click(function(){var $this=$(this);var $addPersonWin=$('#addPersonWin');var emails=[];var userName=[];var $userEmails=$addPersonWin.find(".userEmail");var supervisorId=$('#selectSupervisor option:selected').val();var $addPersonErr=$("#addPersonErr");$addPersonErr.text("").hide();if(supervisorId=="0"){$addPersonErr.text(_this.i18.IMMEDIATE_INVITER_NULL+"！").show();return false;}
for(var i=0;i<$userEmails.length;i++){var $email=$userEmails.eq(i);var email=$email.val();if(email!=""){if(!_this.managerCtrl.checkEmail(email)){$email.focus();$addPersonErr.text(_this.i18.MAILBOX_FORMAT_WRONG+"！").show();return false;}
emails.push(email);userName.push($addPersonWin.find('.userName').eq(i).val());}}
$addPersonErr.text("").hide();if(_this.managerCtrl.isArrayRepeat(emails)){$addPersonErr.text(_this.i18.MAILBOX_CHECKINFO_REPEATED+"！").show();return false;}
var initProjectId=$('#selectInitProject option:selected').val(),initRoleId=$('#selectInitRole option:selected').val();if(initProjectId==='0'){$addPersonErr.text(_this.i18.INITIAL_PROJECT_NOTNULL+"！").show();return false;}
if(initRoleId==='0'){$addPersonErr.text(_this.i18.INITIAL_ROLE_NOTNULL+"！").show();return false;}
$addPersonErr.text("").hide();var postData={'inviterId':AppConfig.userId,'supervisorId':supervisorId,'isManager':$('#givenMR').get(0).checked?1:0,'userInfo':[],'initRole':initRoleId,'language':localStorage.getItem('language')};if(userName!=undefined){var postUserInfo=[];for(var i=0,len=userName.length;i<len;i++){if(undefined!=userName[i]){if(undefined==emails[i]){emails[i]='';}
postUserInfo.push({'userfullname':userName[i],'email':emails[i]});}}
postData.userInfo=postUserInfo;}
if(!postData.userInfo.length){$addPersonErr.text(_this.i18.PLEASE_ADD_USER+"。").show();return false;}
try{$this.button('loading');}catch(e){}
WebAPI.post('/admin/inviteUsers',postData).done(function(result){if(result.success){_this.loadUserTree().done(function(result){});result.data.info={"apply":_this.i18.MAILBOX_CHECKINFO_APPLY,"invited":_this.i18.MAILBOX_CHECKINFO_INVITED,"registered":_this.i18.MAILBOX_CHECKINFO_REGISTERED,"token_failed":_this.i18.SEND_MAIL_FAILED,"succeed":_this.i18.SEND_EMAIL_SUCCESS};var compiledTemplate=beopTmpl('inviteMsgTmpl',result.data);$("#inviteMsg").empty().html(compiledTemplate);$addPersonErr.text("").hide();}}).fail(function(){$addPersonErr.text(_this.i18.REQUEST_ERROR+"！").show();}).always(function(){I18n.fillArea($(ElScreenContainer));try{$this.button('reset');}catch(e){}});});$("#memberManage").on("click",".re-invite",function(){var postData={'reactivateId':parseInt($(this).closest("li").attr("userid")),'userId':AppConfig.userId};WebAPI.post('/admin/reactivateUser',postData).done(function(result){if(result.success){var alert=new Alert(ElScreenContainer,Alert.type.success,I18n.resource.admin.panelManagement.SUCCEED);alert.showAtTop(2000);}else{var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.panelManagement.FAILED);alert.showAtTop(2000);}}).fail(function(e){console.error('员工管理的一键激活错误'+e);}).always(function(){I18n.fillArea($(ElScreenContainer));});});$("#searchUserIc").click(function(){var val=$("#searchUser").val();_this.searchUserObj(val,$(".userTree"));});$("#searchUser").keyup(function(e){var val=$("#searchUser").val();_this.searchUserObj(val,$(".userTree"));if(e.keyCode==40){$("#userListUl li").eq(0).find("input").focus();}});$(document).on("click.memberManager",function(e){var $target=$(e.target);if(!$target.parents("#searchUserCon").length){$("#userListUl").slideUp(300);}});$("#userListUl").on("click","li",function(){var userid=$(this).attr("userid");var val=$(this).find("input").val();_this.selectedUserObj(userid,val);});$("#userListUl").on("keydown","li input",function(e){var $li=$(this).parents("li");var $liAll=$("#userListUl li");if(e.keyCode==38){if($liAll.index($li)+1==1){$liAll.eq($liAll.length-1).find("input").focus();var t2=null;t2&&clearTimeout(t2);t2=setTimeout(function(){$("#userListUl").scrollTop(10000);},30);}else{$li.prev().find("input").focus();$("#userListUl").scrollTop($liAll.index($li)*28);}}else if(e.keyCode==40){if($liAll.index($li)+1==$liAll.length){$liAll.eq(0).find("input").focus();var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){$("#userListUl").scrollTop(0);},30);}else{$("#userListUl").scrollTop($liAll.index($li)*28);$li.next().find("input").focus();}}else if(e.keyCode==13){$("#userListUl").slideUp(300);_this.selectedUserObj($li.attr("userid"),$(this).val());}});$(window).on("resize.setMemberManagerHeight",function(){_this.setMemberManagerHeight();});},detachEvents:function detachEvents(){$(window).off("resize.setMemberManagerHeight");$(window).off("click.memberManager");},close:function close(){this.detachEvents();},loadUserTree:function loadUserTree(){var _this=this;Spinner.spin(ElScreenContainer);return WebAPI.post('/admin/loadUsersTree',{userId:AppConfig.userId}).done(function(result){if(result.success){Spinner.spin(ElScreenContainer);if(result.data.UserRoleGroupList){_this.allRoleGroupList=result.data.UserRoleGroupList;delete result.data.UserRoleGroupList;}
_this.userTree=result.data;var $userTree=_this.buildUserTree(_this.userTree);$('.userTree').empty().append($userTree);$("#treeUl .setting").eq(0).find("img").css({"position":"relative","z-index":8});I18n.fillArea($(ElScreenContainer));Spinner.stop();}}).always(function(){Spinner.stop();});},buildUserTree:function buildUserTree(root){var buildUserTreeItem=function buildUserTreeItem(item){return beopTmpl('userTreeItemTmpl',item);};var $root=$('<ul id="treeUl"></ul>').append(buildUserTreeItem(root));$root.find('li').append(this.managerCtrl.buildSubTree(buildUserTreeItem,root,'sub'));return $root;},loadManagersByUserId:function loadManagersByUserId(userId){return WebAPI.post('/admin/loadManagersByUserId',{userId:userId});},loadInvitePanel:function loadInvitePanel(userId){return WebAPI.post('/admin/loadInvitePanel',{userId:userId});},searchUserObj:function searchUserObj(val,$tree){var arrNameInfo=[],arrPicInfo=[],arrIdInfo=[],arrEmailInfo=[];var userNameArr=[],userPicArr=[],userIdArr=[],userEmailArr=[];var $userLiAll=$tree.find("li");var $userNameAll=$userLiAll.find(".userfullname");var $userPicAll=$userLiAll.find(".setting>img");for(var i=0;i<$userNameAll.length;i++){userNameArr.push($userNameAll.eq(i).text());userEmailArr.push($userNameAll.eq(i).attr("user_email"));userPicArr.push($userPicAll.eq(i).attr("src"));userIdArr.push($userLiAll.eq(i).attr("userid"));}
for(var i=0;i<userNameArr.length;i++){if(userNameArr[i].toLowerCase().indexOf(val.toLowerCase())>-1||userEmailArr[i].toLowerCase().indexOf(val.toLowerCase())>-1){arrNameInfo.push(userNameArr[i]);arrPicInfo.push(userPicArr[i]);arrIdInfo.push(userIdArr[i]);arrEmailInfo.push(userEmailArr[i]);}}
var li='';for(var i=0;i<arrNameInfo.length;i++){if(i<20){li+='<li userId="'+arrIdInfo[i]+'" userEmail="'+arrEmailInfo[i]+'" class="pr">'+'<input type="text" value="'+arrNameInfo[i]+'" class="pa" readonly />'+'<img src="'+arrPicInfo[i]+'" class="pa" style="z-index:55" /></li>';}}
$("#userListUl").empty().append(li).slideDown(300);},selectedUserObj:function selectedUserObj(userid,searchText){$("#userListUl").slideUp(300);var $treeUl=$("#treeUl");var $userTreeCon=$("#userTreeCon");var $span=$treeUl.find("span");var $userSpan=$treeUl.find("li[userid="+userid+"]>span");var $targetUl=$userSpan.parents("ul");var $targetI=$targetUl.prev("span").find(".glyphicon-plus-sign");$span.removeClass("selected");$userSpan.addClass('selected');$targetI.removeClass("glyphicon-plus-sign").addClass("glyphicon-minus-sign");$targetUl.slideDown(300);$("#searchUser").val(searchText);var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){$userTreeCon.scrollTop($userSpan.offset().top+$userTreeCon.scrollTop()-300);$userTreeCon.scrollLeft($userSpan.offset().left+$userTreeCon.scrollLeft()-$treeUl.width()-15);$("#searchUser").focus();},500);}};return MemberManager;}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var ProjectPermissionManager=function(){function ProjectPermissionManager(){this.viewSource="/static/views/admin/userManager/projectPermissionManager.html";this.managerCtrl=new UserManagerController();this.$container=$();this.pageViewModel={};this.currentProjectId=AppConfig.projectId?AppConfig.projectId:null;this.i18=I18n.resource.admin.panelManagement;}
ProjectPermissionManager.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.viewSource).done(function(resultHtml){_this.$container=$('#permissionManageWrapper').html(resultHtml).find('#permissionManage');$("#manageTab li[screen='AccountManager']").remove();$("#manageTab").show();$("#panelContentWrapper").hide();_this.init();I18n.fillArea($(ElScreenContainer));}).always(function(){});},setPermissionManagerHeight:function setPermissionManagerHeight(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-62);$("#projectCon").height($(window).height()-$(".navbar").height()-185);},init:function init(){this.setPermissionManagerHeight();$("#panelContentWrapper").show();this.loadProjectPermission();},getProjectById:function getProjectById(projectId){for(var m=0;m<this.pageViewModel.projectList.length;m++){if(this.pageViewModel.projectList[m].id==projectId){return this.pageViewModel.projectList[m];}}},attachEvents:function attachEvents(){var _this=this,$isDelUserWin=$("#isDelUserWin"),deleteUserId=null,roleOfDeleteUser=null,$permissionManage=$('#permissionManage');$('#selectProject').off().change(function(){Spinner.spin(ElScreenContainer);_this.currentProjectId=this.value;_this.loadProjectPermission();});$("#addProject").click(function(){ScreenManager.show(PaneProjectCreator);AppConfig.systemEntrance='add';});$permissionManage.off().on("mouseover",'.proUser',function(){var $this=$(this);if($this.attr('userId')!=AppConfig.userId){$(this).find(".closed").show();}}).on("mouseout",'.proUser',function(){$(this).find(".closed").hide();}).on("click",'.closed',function(){var $this=$(this);deleteUserId=$this.attr('userId');roleOfDeleteUser=$this.attr('roleId');_this.managerCtrl.setFloatingWin($isDelUserWin,300);}).on("click",'.addGroup',function(){var $this=$(this);$("#groupName").val("");$("#groupNameInfo").hide();$(".proCompany>ul").removeClass("isAdd");$this.parents(".addGroupWrapper").prev("ul").addClass("isAdd");var obj=$('#addGroupWin');$(".modal-dialog").css({'top':($(window).height()-300)/2});obj.modal();}).on('click','.modify-btn',function(){AppConfig.systemEntrance='edit';var $this=$(this),projectId=$this.data('project-id');if(!BEOPUtil.isUndefined(projectId)){ScreenManager.show(PaneProjectCreator,projectId);}});$isDelUserWin.off().on("click",".btn-primary",function(){if(!BEOPUtil.isUndefined(deleteUserId)&&!BEOPUtil.isUndefined(roleOfDeleteUser)){WebAPI.post('/admin/deleteRoleUser',{'roleId':roleOfDeleteUser,'userId':deleteUserId}).done(function(result){if(result.success){$permissionManage.find('.proList[roleId="'+roleOfDeleteUser+'"] .proUser[userId="'+deleteUserId+'"]').remove();$isDelUserWin.modal("hide");}}).fail(function(){});}});$('#addGroupWin').off().on("click",".addGroupWinOK",function(){var $addGroupWin=$('#addGroupWin');var $roleNameInput=$("#groupName");var $groupNameInfo=$("#groupNameInfo");if($roleNameInput.val()==""){$groupNameInfo.text(_this.i18.GROUP_NAME_NOTNULL).show();return false;}else{var projectId=$('.isAdd').parent('.proCompany').attr('id');var groupNameArr=[];$("#"+projectId).find(".role").each(function(){groupNameArr.push($(this).text());});if($.inArray($roleNameInput.val(),groupNameArr)>=0){$groupNameInfo.text(_this.i18.GROUPINGNAME_NOT_REPEAT).show();return false;}else{$groupNameInfo.hide();Spinner.spin(ElScreenContainer);WebAPI.post('/admin/addProjectRole',{'projectId':projectId,'roleName':$roleNameInput.val(),'userId':AppConfig.userId}).done(function(result){if(result.success){$addGroupWin.modal("hide");_this.loadProjectPermission().always(function(){Spinner.stop();});}});$roleNameInput.val("");}}});$("#projectCon").off().on("click",".delCon",function(){var $this=$(this);var $op=$this.parents(".proListWrapper");var wh=$(window).height();var $isDelWin=$('#isDelWin');var top=(wh-300)/2;$(".proListWrapper").removeClass("isDel");$op.addClass("isDel");$isDelWin.attr("data-roleid",$this.attr("data-roleid")).attr("data-projectid",$this.attr("data-projectid"));$(".modal-dialog").css({'top':top});$isDelWin.modal();});$('#isDelWin').off().on("click",".btn-primary",function(){var $isDelWin=$('#isDelWin').modal("hide");var projectId=$isDelWin.attr('data-projectid');var roleId=$isDelWin.attr('data-roleid');WebAPI.post('/admin/deleteProjectRole',{'projectId':projectId,'roleId':roleId,'userId':AppConfig.userId}).done(function(result){if(result.success){$isDelWin.attr('data-projectid',"").attr('data-roleid',"");$("#projectCon .isDel").remove();}else{var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[result.code]);alert.showAtTop(2000);}}).fail(function(){var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code['0']);alert.showAtTop(2000);});});$("#searchProjectUser").keyup(function(e){var $listNameAll=$("#userList .listName");for(var i=0;i<$listNameAll.length;i++){var $listName=$listNameAll.eq(i);if($listName.text().toLowerCase().indexOf($(this).val().toLowerCase())<0){$listName.parents("li").hide();}else{$listName.parents("li").show();}}});$('#userList li').each(function(){this.draggable=true;this.ondragstart=function(e){var $this=$(this);var userInfo={userId:$this.attr('userid'),userName:$this.find(".listName").text(),userPic:$this.attr("userPic")};$("#dragObj").val("user");e.dataTransfer.setData("user",JSON.stringify(userInfo));};});$('.proUser').each(function(){this.draggable=true;this.ondragstart=function(e){var $this=$(this);var userInfo={userId:$this.attr('userid'),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser");e.dataTransfer.setData("itemUser",JSON.stringify(userInfo));};});$('.proList').each(function(){this.ondragover=function(e){e.preventDefault();};this.ondrop=_this.dropUserToRoleEvent;});$("#projectCon").off('click','.benchmark-btn').on('click','.benchmark-btn',function(){Spinner.spin(ElScreenContainer);var $this=$(this);var projectId=$this.data('project-id');WebAPI.post('/admin/loadBenchmarkMenu',{projectId:projectId}).done(function(result){if(result.success){var data=result.data,nav=data.nav,$menuTree,$benchmarkSet=$('#benchmarkSet');if(nav&&nav.length){$menuTree=_this.buildMenuTree(nav,'benchmarkMenuTreeItemTmpl');$benchmarkSet.find('.winCon').empty().append($menuTree);$benchmarkSet.find('#saveBenchmarkMenu').attr('project-id',projectId);_this.renderTreeView();}else{$benchmarkSet.find('.winCon').empty().append(_this.i18.MENU_NOT_CONFIGURED+'！');}
I18n.fillArea($(ElScreenContainer));$benchmarkSet.modal();}}).always(function(){Spinner.stop();});}).off('click','.delete-btn').on('click','.delete-btn',function(){var $this=$(this);var projectId=$this.attr('data-project-id');confirm(I18n.resource.admin.panelManagement.DELETE_PROJECT_SURE,function(){WebAPI.post('/admin/deleteProject',{'projectId':projectId}).done(function(result){if(result.success){alert(I18n.resource.common.DELETE_SUCCESS);$("#"+projectId).remove();for(var i=0;i<_this.pageViewModel.projectList.length;i++){if(_this.pageViewModel.projectList[i].id==projectId){_this.pageViewModel.projectList.splice(i,1);break;}}
for(var j=0;j<AppConfig.projectList.length;j++){if(AppConfig.projectList[j].id==projectId){AppConfig.projectList.splice(j,1);break;}}
_this.currentProjectId='all';_this.renderSelectProject();_this.renderAllProject();I18n.fillArea($(ElScreenContainer));}else{alert(I18n.resource.common.DELETE_FAIL);}}).fail(function(e){console.log(e);});});});$('#saveBenchmarkMenu').click(function(){var $benchmarkSet=$('#benchmarkSet');if($benchmarkSet.find('.winCon ul').size()===0){$benchmarkSet.modal('hide');return false;}
var benchmarkNavChecked=$benchmarkSet.find('input.benchmarkNav:checked').map(function(){return $(this).val();}).get();Spinner.spin($benchmarkSet.find('.modal-content').get(0));WebAPI.post('/admin/savePageMenu',{projectId:$(this).attr('project-id'),benchmarkList:benchmarkNavChecked}).done(function(result){if(result.success){var alert=new Alert($benchmarkSet.find('.modal-content').get(0),Alert.type.success,I18n.resource.code[result.code]);alert.showAtTop(2000);setTimeout(function(){$benchmarkSet.modal('hide');},1000);}}).always(function(){Spinner.stop();I18n.fillArea($(ElScreenContainer));});});$("#projectCon").off('click','.setPage').on('click','.setPage',function(){Spinner.spin(ElScreenContainer);var wh=$(window).height();var top=(wh-800)/2;$("#pageSet .modal-dialog").css({'top':top});var $this=$(this);var projectId=$this.data('projectid'),roleId=$this.data('roleid');WebAPI.post('/admin/loadPageMenu',{projectId:projectId,roleId:roleId}).done(function(result){if(result.success){var data=result.data,nav=data.nav,$menuTree,$pageSet=$('#pageSet');if(nav&&nav.length){$menuTree=_this.buildMenuTree(nav);$pageSet.find('.winCon').empty().append($menuTree);$pageSet.find('#savePageMenu').attr('project-id',projectId).attr('role-id',roleId);_this.renderTreeView();}else{$pageSet.find('.winCon').empty().append(_this.i18.MENU_NOT_CONFIGURED+'！');}
I18n.fillArea($(ElScreenContainer));$pageSet.modal();}}).always(function(){Spinner.stop();});});$("#projectCon").off('click','.permissionManage').on('click','.permissionManage',function(){var $this=$(this),$setPermissionWin=$("#setPermissionWin");$setPermissionWin.attr({"data-roleId":$this.attr("data-roleid")});$("#dashboardEditPermission")[0].checked=$this.attr("permission-dashboard")?true:false;$("#menuEditPermission")[0].checked=$this.attr("permission-menu")?true:false;$("#debugToolsPermission")[0].checked=$this.attr("permission-debug-tools")?true:false;$setPermissionWin.modal();});$("#savePermissionSetBtn").off().on('click',function(){Spinner.spin(ElScreenContainer);var $setPermissionWin=$("#setPermissionWin"),role_project_id=$setPermissionWin.attr("data-roleid");var permission_dashboard=$("#dashboardEditPermission").is(':checked')?"c_dashboard":"";var permission_menu=$("#menuEditPermission").is(':checked')?"c_menu":"";var permission_debug_tools=$("#debugToolsPermission").is(':checked')?"c_debug_tools":"";WebAPI.post('/admin/configurePermission',{role_project_id:role_project_id,permission_dashboard:permission_dashboard,permission_menu:permission_menu,permission_debug_tools:permission_debug_tools}).done(function(result){if(result.success){var permissionBtn=$("#projectCon").find(".permissionManage[data-roleid="+role_project_id+"]");permissionBtn.attr("permission-dashboard",permission_dashboard);permissionBtn.attr("permission-menu",permission_menu);permissionBtn.attr("permission-debug-tools",permission_debug_tools);$setPermissionWin.modal("hide");}}).always(function(){Spinner.stop();});});$("#pageSet").off().on("click",'input:checkbox',function(){var $this=$(this);var parent_liL=$this.parents(".parent_li").length;if(parent_liL){var $rootSpan=$this.parents(".parent_li").children("span");var $checkboxRoot=$rootSpan.find("input:checkbox");var $checkboxLeaf=$this.closest(".parent_li").find("ul").find("input:checkbox");var iL=$this.parents("label").prev("i").length;if($this.is(':checked')){if(iL){$checkboxLeaf.each(function(){this.checked=true;});$checkboxRoot.each(function(){this.checked=true;});}else{$checkboxRoot.each(function(){this.checked=true;});}}else{if(iL){$checkboxLeaf.each(function(){this.checked=false;});}}}});$('#savePageMenu').click(function(){var $pageSet=$('#pageSet');if($pageSet.find('.winCon ul').size()===0){$pageSet.modal('hide');return false;}
var allTopNavChecked=$pageSet.find('input.topNav:checked').map(function(){return $(this).val();}).get();var allFuncNavChecked=$pageSet.find('input.funcNav:checked').map(function(){return $(this).val();}).get();var $this=$(this);WebAPI.post('/admin/savePageMenu',{projectId:$this.attr('project-id'),roleId:$this.attr('role-id'),topNavList:allTopNavChecked,funcNavList:allFuncNavChecked}).done(function(result){if(result.success){var alert=new Alert($pageSet.find('.modal-content').get(0),Alert.type.success,I18n.resource.code[result.code]);alert.showAtTop(2000);setTimeout(function(){$pageSet.modal('hide');},1000);}}).always(function(){I18n.fillArea($(ElScreenContainer));});});$(window).on("resize.permissionManager",function(){_this.setPermissionManagerHeight();_this.setUserListPosition();});},detachEvents:function detachEvents(){$(window).off("resize.permissionManager");},close:function close(){this.detachEvents();},dropUserToRoleEvent:function dropUserToRoleEvent(e){Spinner.spin(ElScreenContainer);e.preventDefault();var $target=$(e.target);var dragObjStr=$("#dragObj").val();if(!$target.hasClass('proList')){$target=$target.closest('.proList');}
var data;if(dragObjStr=="user"){data=JSON.parse(e.dataTransfer.getData("user"));}else{data=JSON.parse(e.dataTransfer.getData("itemUser"));}
var isExisted=false;if(!data){Spinner.stop();return;}
$target.find('.userId').each(function(){if($(this).attr('userid')==data.userId){isExisted=true;Spinner.stop();return;}});if(!isExisted){var roleId=$target.attr('roleId');if(dragObjStr=="itemUser"){if(AppConfig.userId==data.userId){Spinner.stop();return false;}
var dragRoleId=data.roleid;if(roleId===dragRoleId){Spinner.stop();return false;}}
if(_typeof(data.userId)===(typeof undefined==='undefined'?'undefined':_typeof(undefined))||(typeof roleId==='undefined'?'undefined':_typeof(roleId))===(typeof undefined==='undefined'?'undefined':_typeof(undefined))){Spinner.stop();return false;}
if(dragObjStr=="user"){WebAPI.post('/admin/addRoleUser',{roleId:roleId,userId:data.userId}).done(function(result){if(result.success){data.roleId=roleId;$target.find('.userList').append(beopTmpl('proUserTmpl',data));$target.find('.proUser').each(function(){this.draggable=true;this.ondragstart=function(e){var $this=$(this);var userInfo={userId:$this.attr('userid'),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser");e.dataTransfer.setData("itemUser",JSON.stringify(userInfo));};});}
return false;}).fail(function(){var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.panelManagement.REQUEST_ERROR);alert.showAtTop(2000);}).always(function(){I18n.fillArea($(ElScreenContainer));Spinner.stop();});}else{WebAPI.post('/admin/deleteRoleUser',{'roleId':dragRoleId,'userId':data.userId}).then(function(result){if(result.success){$("#permissionManage").find('.proList[roleId="'+dragRoleId+'"] .proUser[userId="'+data.userId+'"]').remove();$("#isDelUserWin").modal("hide");}
WebAPI.post('/admin/addRoleUser',{roleId:roleId,userId:data.userId}).done(function(result){if(result.success){data.roleId=roleId;$target.find('.userList').append(beopTmpl('proUserTmpl',data));$target.find('.proUser').each(function(){this.draggable=true;this.ondragstart=function(e){var $this=$(this);var userInfo={userId:$this.attr('userid'),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser");e.dataTransfer.setData("itemUser",JSON.stringify(userInfo));};});}
return false;}).fail(function(){var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.panelManagement.REQUEST_ERROR);alert.showAtTop(2000);}).always(function(){I18n.fillArea($(ElScreenContainer));Spinner.stop();});});}}},loadProjectPermission:function loadProjectPermission(){var _this=this;return WebAPI.post('/admin/loadProjectPermission',{'userId':AppConfig.userId}).done(function(result){if(result.success){_this.pageViewModel=result.data;_this.renderUserList();if(!_this.currentProjectId){_this.renderProject(_this.pageViewModel.projectList[0]);_this.currentProjectId=_this.pageViewModel.projectList[0].id;}else if(_this.currentProjectId=='all'){_this.renderAllProject();}else{_this.renderProject(_this.getProjectById(_this.currentProjectId));}
_this.renderSelectProject();_this.attachEvents();I18n.fillArea($(ElScreenContainer));}}).always(function(){Spinner.stop();});},setUserListPosition:function setUserListPosition(){var $manageTab=$("#manageTab");$("#staffList").css({"left":$manageTab.width()+30});},renderSelectProject:function renderSelectProject(){$('#selectProject').html(beopTmpl('selectProjectListTmpl',{projectList:this.pageViewModel.projectList,currentProjectId:this.currentProjectId}));},renderUserList:function renderUserList(){var compiledTemplate=beopTmpl('userListTmpl',this.pageViewModel);$('#userList').html(compiledTemplate);this.setUserListPosition();$("#staffList").show();},renderAllProject:function renderAllProject(){var $projectContent=$('#projectCon').empty();for(var m=0,mLen=this.pageViewModel.projectList.length;m<mLen;m++){$projectContent.append(beopTmpl('tpl_project_manage',{project:this.pageViewModel.projectList[m]}));}
I18n.fillArea($('#permissionManage'));},renderProject:function renderProject(project){if(!project){alert('can\'t find this project');return;}
$('#projectCon').html(beopTmpl('tpl_project_manage',{project:project}));I18n.fillArea($('#permissionManage'));},buildMenuTree:function buildMenuTree(nav,template){var buildMenuTreeItem=function buildMenuTreeItem(item){return beopTmpl(template?template:'menuTreeItemTmpl',item);};var $html=$('<ul></ul>');for(var i=0,length=nav.length;i<length;i++){var root=nav[i];var $root=$(buildMenuTreeItem(root));$root.append(this.managerCtrl.buildSubTree(buildMenuTreeItem,root));$html.append($root);}
return $html;},renderTreeView:function renderTreeView(){$('.tree li:has(ul)').addClass('parent_li').find(' > span');$('.tree li.parent_li > span > i').on('click',function(e){var children=$(this).closest('li.parent_li').find(' > ul > li');if(children.is(":visible")){children.hide('fast');$(this).parent('span').find(' > i').addClass('glyphicon-plus-sign').removeClass('glyphicon-minus-sign');}else{children.show('fast');$(this).parent('span').find(' > i').addClass('glyphicon-minus-sign').removeClass('glyphicon-plus-sign');}
e.stopPropagation();});}};return ProjectPermissionManager;}();var PaneProjectCreator=function(){var util={upload:{readURL:function readURL(ele,onSuccess,onError){var file;if(!(ele.files&&ele.files[0])){alert('file upload failed, try again.');typeof onError==='function'&&onError(1);return false;}
if(!(window.File&&window.FileReader&&window.FileList&&window.Blob)){alert('he browser not support the latest API.');typeof onError==='function'&&onError(2);return false;}
if(typeof FileReader==="undefined"){alert("The browser not support the latest API.");typeof onError==='function'&&onError(3);return false;}
file=ele.files[0];if(!/image/i.test(file.type)){alert("invalid file type.");typeof onError==='function'&&onError(4);return false;}
var reader=new FileReader();reader.onload=onSuccess;reader.readAsDataURL(file);}}};function PaneProjectCreator(projId){this.map=null;this.projId=projId;this.validator=null;this.isAdvance=false;}
PaneProjectCreator.prototype={show:function show(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/admin/paneProjectCreator.html").done(function(resultHtml){Spinner.stop();$(ElScreenContainer).html(resultHtml);if(_this.projId!==undefined)$('.header','#reg-wizard').children('span').eq(0).attr('i18n','admin.projectCreator.REGIST_STEP1_TITLE_2');I18n.fillArea($('#reg-wizard').not('input, .map_wrap'));I18n.fillAreaAttribute($('.pi_left_ct').eq(0).find('input'),'placeholder');_this.init();});},init:function init(){var _this=this;this.$formWrap=$('#formWrap');this.$pjCode=$('#iptPjCode',this.$formWrap);this.$pjNameZh=$('#iptPjNameZh',this.$formWrap);this.$pjNameEn=$('#iptPjNameEn',this.$formWrap);this.iptPjRealityMarkValue=$("#iptPjRealityMarkValue",this.$formWrap);this.$pjAddr=$('#iptPjAddr',this.$formWrap);this.$pjLnglat=$('#iptPjLnglat',this.$formWrap);this.$imgPreview=$('#imgPreview');this.$pjFile=$('#iptPjFile');this.$pjLogo=$('#iptPjLogo');this.$imgLogoPreview=$('#imgLogoPreview');this.$isAdvance=$('#isAdvance');this.$regStep=$('.reg-step-ct');this.$btnSubmit=$('#btnSubmit');this.$btnSwitchMap=$('#switch-map-btn');this.pjRealityMarkValue=false;this.loadMap('AMap').done(function(){if(_this.projId!==undefined){_this.recoverForm(AppConfig.projectList.filter(function(row){return row.id===_this.projId;})[0]);}});this.attachEvents();this.initValidator();},loadMap:function loadMap(type){var defer=$.Deferred();beop.baseMap.loadAccurateMap(type,function(map){this.map=map;this.attachMapEvents();this.map.addSearchBox('#btnMapSch','#mapSchPane');defer.resolve();}.bind(this));return defer;},recoverForm:function recoverForm(form){var latlng;if(!form)return;this.$pjCode.val(form.name_en).prop('readonly',true);this.$pjNameZh.val(form.name_cn);this.$pjNameEn.val(form.name_english);if(form.isAdvance){this.$isAdvance.prop('disabled',true);this.$isAdvance.prop('checked',form.isAdvance?true:false);this.$regStep.addClass('advance');if(form.logo){this.$imgLogoPreview.attr('src',form.logo);}
this.isAdvance=Boolean(form.isAdvance);}
if(form.datadb){this.pjRealityMarkValue=form.datadb;this.iptPjRealityMarkValue.val(this.pjRealityMarkValue).attr('disabled',true);}
latlng=form.latlng.split(',');this.map&&this.map.trigger('click',{lnglat:this.map.getPoint(latlng[1],latlng[0])});this.$imgPreview.attr({'src':'/static/images/project_img/'+form.pic,'data-name':form.pic});},initValidator:function initValidator(){this.validator=new Validator(this.$formWrap,{elements:[{name:'pjCode',selector:this.$pjCode,rules:[{valid:'require',msg:'Project code must not be empty!'},{valid:'word',msg:'Project code should only containes letters, numbers and \'_\''},{valid:function valid(val){var _this=this;WebAPI.post("/proj_name/check",{proName:val}).done(function(rs){if(rs.status==='OK'&&!rs.data.isExist){_this.success();}else{_this.fail();}});},msg:'Project code already exists!'}]},{name:'pjNameZh',selector:this.$pjNameZh,rules:[{valid:'require',msg:'Project chinese name cannot be empty!'}]},{name:'pjNameEn',selector:this.$pjNameEn,rules:[{valid:'require',msg:'Project english name cannot be empty!'},{valid:'word',msg:'Project english name should only containes letters, numbers and \'_\''}]},{name:'pjAddr',selector:this.$pjAddr,rules:[{valid:'require',msg:'Project address cannot be empty!'}]}]});},attachEvents:function attachEvents(){var _this=this;var isImgUploadReady=false;this.$btnSwitchMap.off().on('click',function(){var $this=$(this),attrPrefix='data-map-type',type=$this.attr(attrPrefix);var $AMapSearch=$('.map-sch-wrap');_this.map.destroy();_this.$pjAddr.val('');if(type==='AMap'){$AMapSearch.find('input').val('').end().find('#mapSchPane li').remove().end().hide();if($('#btnGoogleSch').length==0){$('#mapContainer').before('<input type="text" class="form-control" id="btnGoogleSch" style="display:none;" placeholder="Search Box" />');}
_this.loadMap('GMap');$this.fadeOut(function(){$this.text(I18n.resource.admin.projectCreator.CHANGE_MAP_TO_AMAP).attr(attrPrefix,'GMap');}).fadeIn();}else if(type==='GMap'){$AMapSearch.show();_this.loadMap('AMap');$this.fadeOut(function(){$this.text(I18n.resource.admin.projectCreator.CHANGE_MAP_TO_GOOGLE).attr(attrPrefix,'AMap');}).fadeIn();}else{$this.fadeOut().text(I18n.resource.admin.projectCreator.CHANGE_MAP_ERROR).fadeIn();}});var checkPJRealityMarkValueTimer=null;var $iptPjRealityMarkValueParent=this.iptPjRealityMarkValue.closest('div.form-group');var iptPjRealityMarkValueSuccess=function iptPjRealityMarkValueSuccess(){$iptPjRealityMarkValueParent.addClass('has-success').removeClass('has-error').find(".help-block").text(I18n.resource.admin.projectCreator.PJ_REALITY_VALUE_TIPS_SUCCESS);},iptPjRealityMarkValueFailed=function iptPjRealityMarkValueFailed(){$iptPjRealityMarkValueParent.removeClass('has-success').addClass('has-error').find(".help-block").text(I18n.resource.admin.projectCreator.PJ_REALITY_VALUE_TIPS_FAILED);},iptPjRealityMarkValueServerError=function iptPjRealityMarkValueServerError(){$iptPjRealityMarkValueParent.removeClass('has-success').addClass('has-error').find(".help-block").text(I18n.resource.admin.projectCreator.PJ_REALITY_VALUE_TIPS_SERVER_ERROR);},iptPjRealityMarkValueDefault=function iptPjRealityMarkValueDefault(){$iptPjRealityMarkValueParent.removeClass('has-success').removeClass('has-error').find(".help-block").text(I18n.resource.admin.projectCreator.PJ_REALITY_VALUE_TIPS_DEFAULT);};this.iptPjRealityMarkValue.off().on('keyup',function(){var $this=$(this),value=$this.val().trim();if(!value){iptPjRealityMarkValueDefault();_this.pjRealityMarkValue=false;return false;}
checkPJRealityMarkValueTimer=setTimeout(function(){WebAPI.post('/admin/checkPJRealityMarkValue',{realityPJMarkValue:value}).done(function(result){if(result.success){if(!result.data.isReality){iptPjRealityMarkValueFailed();_this.pjRealityMarkValue=undefined;}else{iptPjRealityMarkValueSuccess();_this.pjRealityMarkValue=value;}}else{iptPjRealityMarkValueServerError();_this.pjRealityMarkValue=undefined;}}).fail(function(){_this.pjRealityMarkValue=undefined;iptPjRealityMarkValueServerError();});},1333);}).on('keydown',function(){clearTimeout(checkPJRealityMarkValueTimer);});this.$imgPreview.click(function(e){_this.$pjFile.click();e.preventDefault();});this.$pjFile.change(function(e){var file=$(this)[0].files[0];if(file.name.match(/\.[A-Za-z0-9]+$/)[0].toLowerCase()!=='.jpg'){isImgUploadReady=false;alert('invalid image format.');return;}
util.upload.readURL($(this)[0],function(e){$('#imgPreview').attr('src',e.target.result);isImgUploadReady=true;},function(errCode){isImgUploadReady=false;});e.preventDefault();});this.$imgLogoPreview.click(function(e){_this.$pjLogo.click();e.preventDefault();});this.$pjLogo.change(function(e){util.upload.readURL($(this)[0],function(e){_this.$imgLogoPreview.attr('src',e.target.result);});e.preventDefault();});this.$btnSubmit.click(function(ev){var defer;if(_this.pjRealityMarkValue===undefined){alert("Invalid project identification.");ev.preventDefault();return false;}
if(_this.projId!==undefined)defer=_this.validator.not('pjCode').valid();else defer=_this.validator.valid();defer.then(function(form){var formData=new FormData();if(isImgUploadReady)formData.append('pro-pic-file',_this.$pjFile[0].files[0]);if(_this.isAdvance){formData.append('isAdvance',_this.isAdvance?1:0);formData.append('pro-pic-logo',_this.$pjLogo[0].files[0]);}
if(_this.projId!==undefined){formData.append('projId',_this.projId);formData.append('projCode',_this.$pjCode.val());}else{formData.append('projCode',form.pjCode);}
if(_this.pjRealityMarkValue){formData.append("realityMarkValue",_this.pjRealityMarkValue);}
formData.append('userId',AppConfig.userId);formData.append('projNameZh',form.pjNameZh);formData.append('projNameEn',form.pjNameEn);formData.append('address',form.pjAddr);formData.append('latlng',_this.$pjLnglat.val());formData.append('weatherStationId',101020100);Spinner.spin($('body')[0]);$.ajax({url:'/project/create',type:'post',data:formData,dataType:'json',cache:false,contentType:false,processData:false}).done(function(rs){if(rs.status==='OK'){if(AppConfig.systemEntrance==='add'){alert('Create project successfully');}else{alert('Edit project successfully');}
AppConfig.projectId=rs.projectId;if(rs.projects){AppConfig.projectList=rs.projects;}
location.hash='#page=UserManagerController&manager=ProjectPermissionManager&projectId='+AppConfig.projectId;}else{alert('Server is busy, Please try again later.');}}).fail(function(e){alert('Server is busy, Please try again later.');}).always(function(e){Spinner.stop();});});});$('#cancelRegist').click(function(){ScreenManager.show(UserManagerController,'ProjectPermissionManager');});this.$isAdvance.change(function(){_this.isAdvance=$(this).prop('checked');if(_this.isAdvance){_this.$regStep.addClass('advance');}else{_this.$regStep.removeClass('advance');}});},attachMapEvents:function attachMapEvents(){var _this=this;this.map.addListener('click',function(e){var point=e.lnglat;_this.map.removeAllMarkers();_this.map.addMarker(point.lng,point.lat);_this.map.setFitView();_this.map.getAddress(point.lng,point.lat,function(rs){if(rs.status!==0)return;rs=rs.data;var components=rs[0].components;var city=components.city||components.province||rs[0].name;_this.$pjAddr.val(rs[0].name);_this.$pjLnglat.val(point.lat+','+point.lng);});});},detachEvents:function detachEvents(){this.$btnSubmit.unbind();this.$pjCode.unbind();this.$pjAddr.unbind();this.$imgPreview.unbind();$('body').off();},close:function close(){this.detachEvents();this.map.destroy();}};return PaneProjectCreator;}();var PaneProjectConfigure;PaneProjectConfigure=function(){function PaneProjectConfigure(){this.proName=undefined;this.stepCur=undefined;this.stepNext=undefined;this.stepPre=undefined;this.stepPreShow=undefined;this.stepAll=undefined;this.curPic=undefined;this.nextPic=undefined;this.prePic=undefined;this.preShowPic=undefined;this.allPic=undefined;this.initData=undefined;this.chartData=undefined;this.dataFlag=undefined;this.nameFlag=undefined;this.btnNext=undefined;this.scrollRange=undefined;this.i18=I18n.resource.admin.projectConfigure;}
PaneProjectConfigure.prototype={show:function show(){var _this=this;WebAPI.get('/static/views/admin/paneProjectConfigure.html').done(function(resultHtml){$('#indexMain').html(resultHtml);_this.init();});},init:function init(){this.stepCur=0;this.stepNext=-1;this.stepPre=-1;this.stepPreShow=-1;this.stepAll=4;this.curPic=0;this.nextPic=-1;this.prePic=-1;this.preShowPic=-1;this.allPic=$('.step3LiLg').length;this.dataFlag=0;this.nameFlag=0;this.btnNext=this.i18.NEXT;this.btnFinish=this.i18.FINISH;var _this=this;var windowWidth=$(window).width();if(windowWidth>1200){this.scrollRange=6;}else if(windowWidth>992){this.scrollRange=5;}else{this.scrollRange=3;this.scrollRange=3;}
_this.stepInit();$('#returnMain').click(function(){ScreenManager.show(ProjectManager);});$('.configNavA').click(function(){if(!$(this).hasClass('configNavEdit')){var i=$('.configNavA').index(this);if(i>-1){_this.stepJump(i);_this.wholeJudge();}else{alert("No configNavA exist.");}}});$('#stepPre').click(function(){_this.stepMinus();});$('#stepNext').click(function(){_this.stepPlus();});$('a[data-toggle="tab"]').on('shown.bs.tab',function(e){var activeTab=$(e.target)[0].id;if(_this.stepCur==3)_this.chartDraw();});$('#newProName').change(function(e){var $newProName=$('#newProName');if($newProName.val()==null||$newProName.val()==undefined||$newProName.val()==''){_this.dataFlag=0;}else{_this.dataFlag=1;}
if(_this.dataFlag&&_this.nameFlag){$('#configNavA4').removeClass('disabled');}else{$('#configNavA4').addClass('disabled');}});$('#newProData').change(function(e){document.getElementById('newProPath').value=this.value;_this.uploadConfigData();});$('#step2-data-delete').click(function(){_this.tableInit();});$('#step2DataDllSel').click(function(e){var arr=document.getElementsByClassName('chk-flag');for(var i=0;i<arr.length;i++){arr[i].checked=true;}});$('#step2DataReverseSel').click(function(e){var arr=document.getElementsByClassName('chk-flag');for(var i=0;i<arr.length;i++){arr[i].checked=!arr[i].checked;}});_this.modelSelInit();_this.btnlgInit();_this.btnsmInit();_this.smallPicSelected();$('#step3BtnLgLeft').click(function(){_this.modelSelMinus();});$('#step3BtnLgRight').click(function(){_this.modelSelPlus();});$('.step3LiSm').click(function(){if($(this).attr('class')!='step3ModelSelSm'){var i=$(".step3LiSm").index(this);_this.modelSelJump(i);_this.btnlgInit();_this.smallPicSelected();}});$('#step3BtnSmLeft').click(function(){var $step3ModelNavUl=$('#step3ModelNavUl');var $step3BtnSmRight=$('#step3BtnSmRight');var leftPosition=$step3ModelNavUl.css('left');var leftPositionNum=Number(leftPosition.substring(0,leftPosition.length-2));leftPosition=leftPositionNum+147+'px';var bestLeftNum=-($('.step3LiSm').length-_this.scrollRange)*147;if(leftPosition=='0px'){if(!$(this).hasClass('disabled')){$(this).addClass('disabled');}}
if(leftPositionNum+147>bestLeftNum&&$step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.removeClass('disabled');}
if($step3ModelNavUl.attr('rel')=='stop'){$step3ModelNavUl.attr('rel','moving');$step3ModelNavUl.stop();$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr('rel','stop');});}});$('#step3BtnSmRight').click(function(){var $step3ModelNavUl=$('#step3ModelNavUl');var $step3BtnSmLeft=$('#step3BtnSmLeft');var leftPosition=$step3ModelNavUl.css('left');var leftPositionNum=Number(leftPosition.substring(0,leftPosition.length-2));leftPosition=leftPositionNum-147+'px';var bestLeftNum=-($('.step3LiSm').length-_this.scrollRange)*147;if(leftPositionNum-147==bestLeftNum){$(this).addClass('disabled');}
if(leftPositionNum==0&&$step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.removeClass('disabled');}
if($step3ModelNavUl.attr('rel')=='stop'){$step3ModelNavUl.attr('rel','moving');$step3ModelNavUl.stop();$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr('rel','stop');});}});},stepInit:function stepInit(){this.stepNext=this.stepCur+1;this.stepPre=this.stepAll-1;},stepPlus:function stepPlus(){var $stepPre=$('#stepPre');var $stepNext=$('#stepNext');if(this.stepCur<this.stepAll-1){this.stepPre=this.stepCur;this.stepCur=this.stepNext;this.stepNext=this.stepCur+1;this.stepPreShow=this.stepPre;$('#configNavA'+(this.stepCur+1)).tab('show');}
$('#configNavSpan'+(this.stepPre+1)).removeClass('glyphicon-edit configNavEdit').addClass('glyphicon-check configNavComplete');$('#configNavSpan'+(this.stepCur+1)).removeClass('glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete').addClass('glyphicon-edit configNavEdit');this.wholeJudge();if(this.stepCur>0&&$stepPre.hasClass('disabled')){$stepPre.removeClass('disabled');}
if(this.stepCur==this.stepAll-1){if($stepNext.text()!=this.btnFinish){$stepNext.text(this.btnFinish);}else{this.finalDataUpload();}}},stepMinus:function stepMinus(){var $stepPre=$('#stepPre');var $stepNext=$('#stepNext');this.stepNext=this.stepCur;this.stepCur=this.stepPre;this.stepPre=this.stepCur-1;this.stepPreShow=this.stepNext;$('#configNavA'+(this.stepCur+1)).tab('show');$('#configNavSpan'+(this.stepNext+1)).removeClass('glyphicon-edit configNavEdit').addClass('glyphicon-check configNavComplete');$('#configNavSpan'+(this.stepCur+1)).removeClass('glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete').addClass('glyphicon-edit configNavEdit');this.wholeJudge();if(this.stepCur==0&&!$stepPre.hasClass('disabled')){$stepPre.addClass('disabled');}
if(this.stepCur<this.stepAll&&$stepNext.text()!=this.btnNext){$stepNext.text(this.btnNext);}},stepJump:function stepJump(num){var $stepPre=$('#stepPre');var $stepNext=$('#stepNext');this.stepPreShow=this.stepCur;this.stepCur=num;this.stepPre=num-1;this.stepNext=num+1;$('#configNavSpan'+(this.stepPreShow+1)).removeClass('glyphicon-edit configNavEdit').addClass('glyphicon-check configNavComplete');$('#configNavSpan'+(this.stepCur+1)).removeClass('glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete').addClass('glyphicon-edit configNavEdit');if(this.stepCur==0){$stepPre.addClass('disabled');$stepNext.text(this.btnNext);}else if(this.stepCur==this.stepAll-1){$stepNext.text(this.btnFinish);$stepPre.removeClass('disabled');}else{$stepPre.removeClass('disabled');$stepNext.text(this.btnNext);}},dataJudge:function dataJudge(){var dataFlag=0;if(this.chartData==undefined||this.chartData[0].value.length==0){$('#configNavSpan2').removeClass('glyphicon-check glyphicon-edit configNavPend configNavComplete configNavEdit').addClass('glyphicon-exclamation-sign configNavErr');dataFlag=0;}else{$('#configNavSpan2').removeClass('glyphicon-exclamation-sign configNavErr').addClass('glyphicon-check configNavComplete');dataFlag=1;}
return dataFlag;},proNameJudge:function proNameJudge(){var $newProName=$('#newProName');var nameFlag=0;if($newProName.val()==null||$newProName.val()==undefined||$newProName.val()==''){$('#configNavSpan1').removeClass('glyphicon-check glyphicon-edit configNavPend configNavComplete configNavEdit').addClass('glyphicon-exclamation-sign configNavErr');nameFlag=0;}else{$('#configNavSpan1').removeClass('glyphicon-exclamation-sign configNavErr').addClass('glyphicon-check configNavComplete');nameFlag=1;}
return nameFlag;},wholeJudge:function wholeJudge(){var $stepNext=$('#stepNext');if(this.stepPreShow==0){this.nameFlag=this.proNameJudge();}
if(this.stepPreShow==1){this.dataGet();this.dataFlag=this.dataJudge();}
if(this.dataFlag&&this.nameFlag){$stepNext.removeClass('disabled');$('#configNavA4').removeClass('disabled');}else{$('#configNavA4').addClass('disabled');if(this.stepCur==2){$stepNext.addClass('disabled');}else{$stepNext.removeClass('disabled');}}},tableInit:function tableInit(){var $initData=$('#initData');$initData.find('thead').remove();$initData.find('tr').remove();this.initData=undefined;this.chartData=undefined;},modelSelInit:function modelSelInit(){if(this.allPic>1){this.nextPic=this.curPic+1;this.prePic=this.allPic-1;}else if(this.allPic==1){this.nextPic=0;this.prePic=0;}
$('.step3LiLg:eq('+this.curPic+')').fadeIn().css('display','inline');},modelSelPlus:function modelSelPlus(){var $step3LiLg=$('.step3LiLg');var $step3BtnLgLeft=$('#step3BtnLgLeft');this.preShowPic=this.curPic;this.prePic=this.curPic;this.curPic=this.nextPic;if(this.curPic<this.allPic-1){this.nextPic=this.curPic+1;}else if(this.curPic==this.allPic-1){this.nextPic=0;}
$step3LiLg.eq(this.curPic).fadeIn().css('display','inline');if(this.preShowPic!=this.curPic){$step3LiLg.eq(this.preShowPic).css('display','none');}
this.btnsmInit();this.smallPicSelected();this.smallPicScroll();if(this.curPic==this.allPic-1){$('#step3BtnLgRight').addClass('disabled');}
if(this.curPic>0&&$step3BtnLgLeft.hasClass('disabled')){$step3BtnLgLeft.removeClass('disabled');}},modelSelMinus:function modelSelMinus(){var $step3LiLg=$('.step3LiLg');var $step3BtnLgRight=$('#step3BtnLgRight');this.preShowPic=this.curPic;this.nextPic=this.curPic;this.curPic=this.prePic;if(this.curPic>0){this.prePic=this.curPic-1;}else if(this.curPic==0&&this.allPic>1){this.prePic=this.allPic-1;}
$step3LiLg.eq(this.curPic).fadeIn().css('display','inline');if(this.preShowPic!=this.curPic){$step3LiLg.eq(this.preShowPic).css('display','none');}
this.btnsmInit();this.smallPicSelected();this.smallPicScroll();if(this.curPic==0){$('#step3BtnLgLeft').addClass('disabled');}
if(this.curPic<this.allPic-1&&$step3BtnLgRight.hasClass('disabled')){$step3BtnLgRight.removeClass('disabled');}},modelSelJump:function modelSelJump(num){var $step3LiLg=$('.step3LiLg');this.preShowPic=this.curPic;this.curPic=num;if(this.curPic==this.allPic-1){this.nextPic=0;if(this.allPic>1){this.prePic=this.curPic-1;}else if(this.allPic==1){this.prePic=0;}}else if(this.curPic==0){this.prePic=this.allPic-1;if(this.allPic>1){this.nextPic=1;}else if(this.allPic==1){this.nextPic=0;}}else{this.nextPic=this.curPic+1;this.prePic=this.curPic-1;}
$step3LiLg.eq(this.curPic).fadeIn().css('display','inline');if(this.preShowPic!=this.curPic){$step3LiLg.eq(this.preShowPic).css('display','none');}},btnlgInit:function btnlgInit(){var $step3BtnLgLeft=$('#step3BtnLgLeft');var $step3BtnLgRight=$('#step3BtnLgRight');if(this.allPic<2){$step3BtnLgLeft.addClass('disabled');$step3BtnLgRight.addClass('disabled');}else{if(this.curPic==0){$step3BtnLgLeft.addClass('disabled');$step3BtnLgRight.removeClass('disabled');}else if(this.curPic==this.allPic-1){$step3BtnLgRight.addClass('disabled');$step3BtnLgLeft.removeClass('disabled');}else{$step3BtnLgRight.removeClass('disabled');$step3BtnLgLeft.removeClass('disabled');}}},btnsmInit:function btnsmInit(){var $step3BtnSmLeft=$('#step3BtnSmLeft');var $step3BtnSmRight=$('#step3BtnSmRight');if(this.curPic>2&&this.allPic-this.curPic>4){if($step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.removeClass('disabled');}
if($step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.removeClass('disabled');}}else if(this.curPic<3){if(!$step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.addClass('disabled');}
if(this.allPic>6){if($step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.removeClass('disabled');}}else{if(!$step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.addClass('disabled');}}}else if(this.curPic>this.allPic-4){if(!$step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.addClass('disabled');}
if(this.allPic>6){if($step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.removeClass('disabled');}}else{if(!$step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.addClass('disabled');}}}},smallPicSelected:function smallPicSelected(){var $step3LiSm=$('.step3LiSm');if(!$step3LiSm.eq(this.curPic).hasClass('step3ModelSelSm')){$step3LiSm.eq(this.curPic).addClass('step3ModelSelSm');}
if(this.preShowPic!=-1){if($step3LiSm.eq(this.preShowPic).hasClass('step3ModelSelSm')){$step3LiSm.eq(this.preShowPic).removeClass('step3ModelSelSm');}}},smallPicScroll:function smallPicScroll(){var $step3ModelNavUl=$('#step3ModelNavUl');var $step3LiSm=$('.step3LiSm');if(this.curPic!=this.preShowPic){var leftPosition=0;if(this.curPic>2&&this.curPic<$step3LiSm.length-3){leftPosition=-(this.curPic-2)*147;}else if(this.curPic>$step3LiSm.length-4&&$step3LiSm.length>6){leftPosition=-($step3LiSm.length-this.scrollRange)*147;}
leftPosition+='px';$step3ModelNavUl.attr('rel','moving');$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr('rel','stop');});}},uploadConfigData:function uploadConfigData(){var _this=this;var fileObj=document.getElementById("newProData").files[0];var form=new FormData();if(this.initData!=undefined){this.tableInit();}
form.append("config-file",fileObj);var xhr=new XMLHttpRequest();xhr.onload=function(){if(xhr.readyState==4&&xhr.status==200){_this.initData=JSON.parse(xhr.responseText);new UploadConfigData(_this.initData).show();}else{alert(this.i18.READ_DATA_FAILED);}};xhr.open('post','/get_config_data',true);xhr.send(form);},dataGet:function dataGet(){if(this.initData!=undefined){var selDateNum=$(".chkPtSel input:checked").length;var ptSelData=new Array();for(var i=0;i<this.initData.length;++i){ptSelData[i]=new Object();ptSelData[i].pointName=this.initData[i].pointName;ptSelData[i].value=new Array();}
this.proName=$('#newProName').val();var selIndex;for(var i=0;i<selDateNum;++i){selIndex=$(".chkPtSel input:checked").eq(i).closest('tr').index();for(var j=0;j<this.initData.length;++j){ptSelData[j].value.push(this.initData[j].value[selIndex]);}}
this.chartData=ptSelData;}},chartDraw:function chartDraw(){var myChart1=echarts.init(document.getElementById('step4Chart1'),AppConfig.chartTheme);var myChart2=echarts.init(document.getElementById('step4Chart2'),AppConfig.chartTheme);var myChart3=echarts.init(document.getElementById('step4Chart3'),AppConfig.chartTheme);var myChart4=echarts.init(document.getElementById('step4Chart4'),AppConfig.chartTheme);var legendData=new Array();var seriesData1=new Array();var seriesData2=new Array();var xAxisData=new Array();legendData.push('2013'+this.chartData[0].pointName);legendData.push('2014'+this.chartData[0].pointName);for(var i=0;i<this.chartData[0].value.length/2;++i){xAxisData[i]=this.chartData[0].value[i].time.substr(5);}
for(var i=0;i<this.chartData[0].value.length/2;++i){seriesData1.push(this.chartData[0].value[i].value);}
for(var i=this.chartData[0].value.length/2;i<this.chartData[0].value.length;++i){seriesData2.push(this.chartData[0].value[i].value);}
var option1={backgroundColor:'rgba(0,0,0,0)',grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:'axis'},legend:{data:legendData},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:xAxisData}],yAxis:[{type:'value'}],series:[{name:'2013低温冰机',type:'line',data:seriesData1},{name:'2014低温冰机',type:'line',data:seriesData2}]};legendData=new Array();seriesData1=new Array();seriesData2=new Array();xAxisData=new Array();legendData.push('2013'+this.chartData[1].pointName);legendData.push('2014'+this.chartData[1].pointName);for(var i=0;i<this.chartData[1].value.length/2;++i){xAxisData[i]=this.chartData[1].value[i].time.substr(5);}
for(var i=0;i<this.chartData[1].value.length/2;++i){seriesData1.push(this.chartData[1].value[i].value);}
for(var i=this.chartData[1].value.length/2;i<this.chartData[1].value.length;++i){seriesData2.push(this.chartData[1].value[i].value);}
var option2={backgroundColor:'rgba(0,0,0,0)',grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:'axis'},legend:{data:legendData},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:xAxisData}],yAxis:[{type:'value'}],series:[{name:'2013低温冷冻泵',type:'line',data:seriesData1},{name:'2014低温冷冻泵',type:'line',data:seriesData2}]};legendData=new Array();seriesData1=new Array();seriesData2=new Array();xAxisData=new Array();legendData.push('2013'+this.chartData[2].pointName);legendData.push('2014'+this.chartData[2].pointName);for(var i=0;i<this.chartData[2].value.length/2;++i){xAxisData[i]=this.chartData[2].value[i].time.substr(5);}
for(var i=0;i<this.chartData[2].value.length/2;++i){seriesData1.push(this.chartData[2].value[i].value);}
for(var i=this.chartData[2].value.length/2;i<this.chartData[2].value.length;++i){seriesData2.push(this.chartData[2].value[i].value);}
var option3={backgroundColor:'rgba(0,0,0,0)',grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:'axis'},legend:{data:legendData},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:xAxisData}],yAxis:[{type:'value'}],series:[{name:'2013低冷却泵',type:'line',data:seriesData1},{name:'2014低温冷却泵',type:'line',data:seriesData2}]};legendData=new Array();seriesData1=new Array();seriesData2=new Array();xAxisData=new Array();legendData.push('2013');legendData.push('2014');var dataSum=0;for(var i=0;i<10;++i){xAxisData[i]=this.chartData[i].pointName;}
for(var i=0;i<10;++i){dataSum=0;for(var j=0;j<this.chartData[i].value.length/2;++j){if(!isNaN(parseInt(this.chartData[i].value[j].value))){dataSum=dataSum+parseInt(this.chartData[i].value[j].value);}}
seriesData1.push(dataSum);}
for(var i=0;i<10;++i){dataSum=0;for(var j=this.chartData[i].value.length/2;j<this.chartData[i].value.length;++j){if(!isNaN(parseInt(this.chartData[i].value[j].value))){dataSum=dataSum+parseInt(this.chartData[i].value[j].value);}}
seriesData2.push(dataSum);}
var option4={backgroundColor:'rgba(0,0,0,0)',grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:'axis'},legend:{data:legendData},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:xAxisData}],yAxis:[{type:'value'}],series:[{name:'2013能效',type:'bar',data:seriesData1},{name:'2014能效',type:'bar',data:seriesData2}]};myChart1.setOption(option1);myChart2.setOption(option2);myChart3.setOption(option3);myChart4.setOption(option4);},finalDataUpload:function finalDataUpload(){var _this=this;WebAPI.post('/project/create',{projName:this.proName,pointData:this.chartData,userName:AppConfig.account,userId:AppConfig.userId}).done(function(data){if(data.error)alert(I18n.resource.admin.projectConfigure.UPLOAD_PROJECT_FAILED);else{WebAPI.post('/project/update',{userId:AppConfig.userId}).done(function(proList){if(proList.error)alert(I18n.resource.admin.projectConfigure.UPDATE_FAILED);else AppConfig.projectList=proList;});new PaneProjectSelector().initProject(data,_this.proName).done(function(){ScreenManager.show(EnergyScreen);});}});}};return PaneProjectConfigure;}();var UploadConfigData=function(){function UploadConfigData(data){this.m_data=data;this.i18=I18n.admin.projectConfigure;}
UploadConfigData.prototype={show:function show(){var _this=this;var $tbody=$('#initDataTbody');var tr;var thead;var th;var td;var jsonData=_this.m_data;if(jsonData.length&&jsonData.length>0){thead=document.getElementById('initData').createTHead();th=document.createElement('th');th.innerHTML=this.i18.SELECT;thead.appendChild(th);th=document.createElement('th');th.innerHTML=this.i18.DATE;thead.appendChild(th);for(var i=0;i<jsonData.length;++i){th=document.createElement('th');th.className='ptName';th.innerHTML=jsonData[i].pointName;thead.appendChild(th);}
for(var i=0;i<jsonData[0].value.length;i++){tr=document.createElement('tr');td=document.createElement('td');td.className='chkPtSel';td.innerHTML="<input type='checkbox' class='chk-flag' />";tr.appendChild(td);td=document.createElement('td');td.className='ptTime';td.innerHTML=jsonData[0].value[i].time;tr.appendChild(td);for(var j=0;j<jsonData.length;j++){td=document.createElement('td');td.className='ptValue';td.innerHTML=jsonData[j].value[i].value;tr.appendChild(td);}
tbody=document.createElement('tbody');$tbody.append(tr);}}else{$tbody.append("<tr><td colspan=3>"+i18.NO_DATA_READ+"</td></tr>");}}};return UploadConfigData;}();var MenuConfigure=function(){var static_id=0,reportType={0:'日报',1:'月报',2:'周报'},menuType={ObserverScreen:'ObserverScreen',DiagnosisScreen:'DiagnosisScreen',AnalysisScreen:'AnalysisScreen',ReportScreen:'ReportScreen',DropDownList:'DropDownList',EnergyScreen:'EnergyScreen',EnergyScreen_M:'EnergyScreen_M'};function MenuItem(id,text,type,reportType,reportFolder,children,parentId){this.text=text;this.type=type;this.reportType=reportType;this.reportFolder=reportFolder;if(!children){this.children=[];}else{this.children=children;}
if(!id){this._id=this.uniqueId();}else{this._id=id;}
if(parentId){this.parent=parentId;}}
MenuItem.prototype={uniqueId:function uniqueId(){return'new_'+static_id++;}};function MenuConfigure(projectId){this.projectId=projectId?projectId:AppConfig.projectId;this.viewModel={traverseNav:function traverseNav(navCollection,id,cb){if(!id){if(cb&&typeof cb==='function'){return cb(navCollection);}else{return navCollection;}}
if(navCollection&&navCollection.length!==0){for(var m=0;m<navCollection.length;m++){var collectionItem=navCollection[m];if(collectionItem._id===id){if(cb&&typeof cb==='function'){cb(navCollection,m);}else{return collectionItem;}}else{this.traverseNav(collectionItem.children,id,cb);}}}},setNav:function setNav(id,text,type,reportType,reportFolder){var ret={};this.traverseNav(this.nav,id,function(collection,index){if(collection&&collection.length){ret=collection[index];if(ret.type===menuType.DropDownList&&type!==menuType.DropDownList){ret.children=[];}
ret.text=text;ret.type=type;if(type===menuType.ReportScreen){ret.reportType=reportType;ret.reportFolder=reportFolder;}}});return ret;},getNav:function getNav(id){if(!id){return{};}
var ret={};this.traverseNav(this.nav,id,function(collection,index){ret=collection[index];});return ret;},removeNav:function removeNav(id){var ret={};this.traverseNav(this.nav,id,function(collection,index){if(collection&&collection.length){ret=collection.splice(index,1);}});return ret;},clearChildren:function clearChildren(id){this.traverseNav(this.nav,id,function(collection,index){collection[index].children=[];});},addNav:function addNav(parentId,text,type,reportType,reportFolder){if(!type){return{};}
var nav=this.nav,ret={};this.traverseNav(this.nav,parentId,function(collection,index){if(!parentId){ret=new MenuItem(null,text,type,reportType,reportFolder);nav.push(ret);}else{if(collection&&collection.length&&collection[index]){if(BEOPUtil.isUndefined(collection[index].children)){collection[index].children=[];}
ret=new MenuItem(null,text,type,reportType,reportFolder,null,parentId);collection[index].children.push(ret);}}});return ret;}};this.userMenuPic={default:[],dark:[]};}
MenuConfigure.prototype={defaultTopNavNum:12,init:function init(){var _this=this;WebAPI.get('/static/views/admin/menuConfigure.html').done(function(htmlResult){$(ElScreenContainer).html(htmlResult);Spinner.spin(ElScreenContainer);WebAPI.post('/admin/menuConfigure',{userId:AppConfig.userId,projectId:_this.projectId}).done(function(result){if(result.success){$.extend(_this.viewModel,result.data.firstProjectMenu);}
_this.renderProjectMenu(_this.viewModel);_this.renderProjectSelector(result.data.projects);_this.initDrag();}).always(function(){Spinner.stop();});_this.bindEvents();}).always(function(){I18n.fillArea($(ElScreenContainer));});},show:function show(){$("#ulPages").empty();this.init();},close:function close(){},getIndexedMenuIds:function getIndexedMenuIds(){var indexedIds=[],$item;$.each($('#navTop').find('li[nav-id]'),function(index,item){$item=$(item);if($item.attr('nav-id')){indexedIds.push($item.attr('nav-id'));}});return indexedIds;},bindEvents:function bindEvents(){var _this=this;var $con=$("#menuConfigure");var $topNavConfigWin=$('#menuConfigureInfo');$con.off("liShow").on("mouseover.liShow",'.itemLi',function(e){$(this).find(".menuOperation .itemEdit").show();}).on("mouseout",'.itemLi',function(e){$(this).find(".menuOperation .itemEdit").hide();});$con.off('change','select').on('change','select',function(){var $this=$(this);var val=$this.val();var $li=$this.closest('li');var $input=$li.find(".displayName");var $itemInfo=$this.next(".itemInfo");var $configDropDownDenuUl=$this.parent("li").children(".configDropDownDenuUl");if($this.hasClass("reportTypeSelect")){return;}
$li.find("input").val("").attr("draggable",true);$li.find(".itemTextContent").remove();$li.find(".itemInfo").html('<input type="text" value="" class="form-control displayName menuName" placeholder="'+I18n.resource.admin.menuConfigure.MENU_INPUT_NAME_PLACEHOLDER+'" draggable="true" />');var lang=window.localStorage.getItem("language")=='en'?'enText':'text';if($this.hasClass("mainMenu")){$this.parents(".itemLi").find(".menuOperation").remove();if(val==menuType.DropDownList){$configDropDownDenuUl.html(beopTmpl('sub_nav_tmpl',{data:_this.viewModel,lang:lang})).slideDown(100);$configDropDownDenuUl.find("li").attr("parent-id",$(this).parents(".itemLi").attr("nav-id"));}else{$configDropDownDenuUl.slideUp(100).html("");}}else{if(val==menuType.DropDownList){$configDropDownDenuUl.html(beopTmpl('three_nav_tmpl',{data:_this.viewModel,lang:lang})).slideDown(100);$configDropDownDenuUl.find("li").attr("parent-id",$(this).parent("li").attr("nav-id"));}else{$configDropDownDenuUl.slideUp(100).html("");}}
$li.attr("draggable",true);if(!val){$li.find(".displayName").attr({"value":"","disabled":true,"placeholder":""});$itemInfo.find(".reportContent").remove();$li.attr("draggable",false);}else if(val==menuType.DropDownList){$input.attr("disabled",false).attr("draggable",false);$itemInfo.find(".reportContent").remove();}else if(val=="ReportScreen"){$input.attr("disabled",false).attr("draggable",false);$itemInfo.append(beopTmpl('operating_Report_tmpl'));}else{$input.attr("disabled",false).attr("draggable",false);$itemInfo.find(".reportContent").remove();}});$con.on('click','.itemEdit',function(){var $itemLi=$(this).parents(".itemLi");var $mainMenu=$itemLi.find(".mainMenu");var $itemInfo=$mainMenu.next(".itemInfo");var mainMenuText=$mainMenu.next('.itemInfo').find(".mainMenuText").text();var $ul=$itemLi.children(".configDropDownDenuUl");if($mainMenu.val()==menuType.DropDownList){if($ul.children("li").length>0){$ul.slideDown(100);$ul.find(".threeUL").has('li').slideDown(200);}else{$ul.html(beopTmpl('sub_nav_tmpl',_this.viewModel)).slideDown(100);$ul.find("li").attr("parent-id",$itemLi.attr("nav-id"));}
$itemLi.find(".menuOperation").html(beopTmpl('dropDown_okOrNo_tmpl'));$itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="'+I18n.resource.admin.menuConfigure.MENU_INPUT_NAME_PLACEHOLDER+'" draggable="true" />');$itemLi.find(".itemCancel").show();}else if($mainMenu.val()=='ReportScreen'){var directoryTypeText=$itemInfo.find(".directoryType").text();var reportTypeText=$itemInfo.find(".reportType").text();$itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="'+I18n.resource.admin.menuConfigure.MENU_INPUT_NAME_PLACEHOLDER+'" draggable="true" />').append(beopTmpl('operating_Report_tmpl'));$itemInfo.find(".directoryTypeInput").val(directoryTypeText).attr("originalValue",directoryTypeText);var selectVal;if(reportTypeText==I18n.resource.admin.menuConfigure.DAILY){selectVal=0;}else{selectVal=1;}
$itemInfo.find(".reportTypeSelect").val(selectVal).attr("originalValue",reportTypeText);}else{$itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="'+I18n.resource.admin.menuConfigure.MENU_INPUT_NAME_PLACEHOLDER+'" draggable="true" />');}
$itemInfo.find(".displayName").focus();I18n.fillArea($itemLi);$(this).remove();});$con.on('click','.itemCancel',function(){var $itemLi=$(this).parents(".itemLi");var index=$("#navTopUl>li").index($itemLi);var $li=$itemLi.find(".configDropDownDenuUl li");var dataNav=_this.viewModel.nav[index].children;$itemLi.find(".mainInfo").html(beopTmpl('itemText_Content_tmpl',{'text':_this.viewModel.nav[index]['text']}));$.each($li,function(indexItem,item){var $item=$(item);if(indexItem<dataNav.length){var originalSelectValue=$(item).find(".secondaryMenu").val();$item.find(".secondaryMenu").val(dataNav[indexItem].type);$item.find(".displayName").val(dataNav[indexItem].text).attr("disabled",false);if(dataNav[indexItem].type=='ReportScreen'){if(originalSelectValue!='ReportScreen'){$item.find(".itemInfo").append(beopTmpl('operating_Report_tmpl'));$item.css("width",'100%');}
$item.find(".reportTypeSelect").val(dataNav[indexItem].reportType);$item.find(".directoryTypeInput").val(dataNav[indexItem].reportFolder);}}else{$item.find(".secondaryMenu").val("");$item.find(".displayName").val("").attr({"disabled":"disabled","placeholder":""});}});$itemLi.find("ul").slideUp();$itemLi.find(".menuOperation").html(beopTmpl('item_edit_tmpl'));I18n.fillArea($li);});var getMenuModelFromPage=function getMenuModelFromPage($item){return{navId:$item.attr('nav-id'),text:$item.find(".menuName").text()||$item.find('.menuName').val(),type:$item.find('.typeSelector option:selected').val(),reportFolder:$item.find('.directoryType').text()||$item.find('.directoryTypeInput').val(),reportType:$item.find('.reportTypeSelect').length?$item.find('.reportTypeSelect option:selected').val():$item.find('.reportType').attr('report-type')};};var updateMenuModel=function updateMenuModel($item,parentId){var menuModel=getMenuModelFromPage($item);if(!menuModel.type){if(menuModel.navId){_this.viewModel.removeNav(menuModel.navId);$item.attr('nav-id','');}}else{if(menuModel.navId){_this.viewModel.setNav(menuModel.navId,menuModel.text,menuModel.type,menuModel.reportType,menuModel.reportFolder);}else{var newItem=_this.viewModel.addNav(parentId,menuModel.text,menuModel.type,menuModel.reportType,menuModel.reportFolder);$item.attr('nav-id',newItem._id);}}};$("#saveSet").click(function(){var commitFlag=true;$.each($("#navTopUl input:enabled"),function(i,inputItem){var val=$.trim($(inputItem).val());if(val==""){$(inputItem).focus();commitFlag=false;$("#errorConfigure").text(I18n.resource.admin.menuConfigure.MENU_INPUT_EMPTY_TIPS).show();return false;}});if(!commitFlag){return false;}
Spinner.spin(ElScreenContainer);$.each($("#navTopUl>li"),function(index,item){var $item=$(item);updateMenuModel($item);if($item.children(".configDropDownDenuUl").children("li").length){var $li=$item.children(".configDropDownDenuUl").children("li");$.each($li,function(indexChild,itemChild){updateMenuModel($(itemChild),$item.attr('nav-id'));if($(itemChild).children(".configDropDownDenuUl").children("li").length){var $threeli=$(itemChild).children(".configDropDownDenuUl").children("li");$.each($threeli,function(indexThreeChild,itemThreeChild){updateMenuModel($(itemThreeChild),$(itemChild).attr('nav-id'));});}});}});_this.resetViewModelNav();WebAPI.post('/admin/menuEdit',{userId:AppConfig.userId,projectId:parseInt($("#projectName").attr("project-id")),menu:_this.viewModel,indexedMenuIds:_this.getIndexedMenuIds()}).done(function(result){if(result.success){new Alert($topNavConfigWin,Alert.type.success,I18n.resource.code[result.code]).showAtTop(2000);_this.renderProjectMenu();}else{new Alert($topNavConfigWin,Alert.type.danger,I18n.resource.code[result.code]).showAtTop(2000);}
$("#errorConfigure").text("").hide();}).always(function(){_this.initDrag();Spinner.stop();});});},resetViewModelNav:function resetViewModelNav(){var _this=this;var navList=[];$.each($("#navTopUl>li"),function(index,item){var $item=$(item);if($item.attr("nav-id")!=''){for(var i=0;i<_this.viewModel.nav.length;i++){if($item.attr("nav-id")==_this.viewModel.nav[i]._id){navList.push(_this.viewModel.nav[i]);}}}});_this.viewModel.nav=navList;},resetSubViewModel:function resetSubViewModel(){var _this=this;for(var i=0;i<_this.viewModel.nav.length;i++){if(_this.viewModel.nav[i].children){var navSubList=[];var $li=$("#navTopUl>li[nav-id='"+_this.viewModel.nav[i]._id+"']").find("li");$.each($li,function(index,item){var $item=$(item);if($item.attr("nav-id")!=''){for(var j=0;j<_this.viewModel.nav[i].children.length;j++){if($item.attr("nav-id")==_this.viewModel.nav[i].children[j]._id){navSubList.push(_this.viewModel.nav[i].children[j]);}}}});_this.viewModel.nav[i].children=navSubList;}}},resetSubTwoModel:function resetSubTwoModel(id_source,id_target){var _this=this;var i_source,i_target;for(var i=0;i<_this.viewModel.nav.length;i++){if(_this.viewModel.nav[i].children){if(_this.viewModel.nav[i]._id==id_source){i_source=i;continue;}
if(_this.viewModel.nav[i]._id==id_target){i_target=i;continue;}}}
var $li_target=$("#navTopUl>li[nav-id='"+id_target+"']").find("li");var targetId_list=[];for(var i=0;i<_this.viewModel.nav[i_target].children.length;i++){targetId_list.push(_this.viewModel.nav[i_target].children[i]._id);}
$.each($li_target,function(index,item){var $item=$(item);if($item.attr("nav-id")!=''){if($.inArray($item.attr("nav-id"),targetId_list)<0){for(var i=0;i<_this.viewModel.nav[i_source].children.length;i++){if(_this.viewModel.nav[i_source].children[i]._id==$item.attr("nav-id")){_this.viewModel.nav[i_source].children[i].parent=id_target;_this.viewModel.nav[i_target].children.unshift(_this.viewModel.nav[i_source].children[i]);_this.viewModel.nav[i_source].children.splice(i,1);}}}}});},initDrag:function initDrag(){var _this=this;var $navTopUl=$("#navTopUl");var $li_source;$navTopUl.find(".itemLi").each(function(){this.ondragstart=function(e){var $target=$(e.target);if(e.target.tagName.toLowerCase()=="input"){$target.draggable=true;e.preventDefault();e.stopPropagation();return false;}
var $li=$target.closest("li");var $ul_source=$li.closest("ul");var index_drag;if(!$li.children("select").val()){return;}
if(typeof $li.attr("parent-id")!="undefined"){index_drag=$ul_source.find("li").index($li);e.dataTransfer.setData("source",'subItem');e.dataTransfer.setData("parent-id",$li.parents(".itemLi").attr("nav-id"));$li_source=$li;if(!$(this).attr("nav-id")){return;}}else{e.dataTransfer.setData("source",'mainItem');index_drag=$("#navTopUl>li").index($(this));}
e.dataTransfer.setData("index_drag",index_drag);};this.ondragover=function(e){var $li=$(e.target).closest("li");if($li.children("select").val()){$li.addClass("color_drop");};e.preventDefault();e.stopPropagation();};this.ondragleave=function(e){$("#navTopUl .color_drop").removeClass("color_drop");e.preventDefault();e.stopPropagation();};this.ondrop=function(e){var $target=$(e.target);var $li=$target.closest("li");var $ul_target=$li.closest("ul");var index_drag=parseInt(e.dataTransfer.getData("index_drag"));var index_target;$("#navTopUl .color_drop").removeClass("color_drop");$li.closest(".itemLi").removeClass("color_drop");if(typeof $li.attr("parent-id")!="undefined"){if(e.dataTransfer.getData("source")=="mainItem"){return;}else{index_target=Number($ul_target.find("li").index($li));var parentId_source=e.dataTransfer.getData("parent-id");var parentId_target=$li.attr("parent-id");if(parentId_source==parentId_target){var $li_sub=$ul_target.find("li");if(index_drag<index_target){$li_sub.eq(index_target).after($li_sub.eq(index_drag));}else{$li_sub.eq(index_target).before($li_sub.eq(index_drag));}
_this.resetSubViewModel();}else{$ul_target.prepend($li_source.attr("parent-id",$li.attr("parent-id")));if(parentId_source){_this.resetSubTwoModel(parentId_source,$li.closest(".itemLi").attr("nav-id"));}}}}else{if(!$li.children("select").val()){return;}
if(!$(this).find(".mainMenu").val()){return;}
if(e.dataTransfer.getData("source")=="subItem"){return;}else{index_target=Number($("#navTopUl>li").index($(this)));var $li_main=$("#navTopUl>li");if(index_drag<index_target){$li_main.eq(index_target).after($li_main.eq(index_drag));}else{$li_main.eq(index_target).before($li_main.eq(index_drag));}}}};});},interactionLine:function interactionLine($con,index_drag,index_target){var $li=$con.children('li');var itemList=[];for(var i=0;i<$li.length;i++){itemList.push($li[i]);}
var temp=itemList[index_target];itemList[index_target]=itemList[index_drag];itemList[index_drag]=temp;$con.empty();for(var i=0;i<itemList.length;i++){$con.append(itemList[i]);}},renderProjectMenu:function renderProjectMenu(model){if(!model){model=this.viewModel;}
var lang=window.localStorage.getItem("language")=='en'?'enText':'text';var html=beopTmpl('top_nav_tmpl',{nav:model.nav,type:model.type,defaultNum:this.defaultTopNavNum,reportType:reportType,systemSkin:window.localStorage.getItem('systemSkin_'+AppConfig.userId),lang:lang});var $navTop=$('#navTop'),_this=this;$navTop.empty().append(html);I18n.fillArea($navTop);$.each($(".configDropDownDenuUl li"),function(index,item){var $item=$(item);$item.attr("parent-id",$item.parents(".itemLi").attr("nav-id"));});this.initDrag();var getUserMenuPicFlag=false;var getUserMenuPic=function getUserMenuPic($dropDownMenu){if(!getUserMenuPicFlag){Spinner.spin($dropDownMenu.get(0));return WebAPI.get('/admin/ossMenuPic').done(function(result){result.data.default.forEach(function(item){_this.userMenuPic.default.push('/'+item.path);});result.data.dark.forEach(function(item){_this.userMenuPic.dark.push('/'+item.path);});}).fail(function(){}).always(function(){getUserMenuPicFlag=true;Spinner.stop();});}else{return $.Deferred().resolve();}};$navTop.find('li').on('show.bs.dropdown',function(){var $this=$(this);var $dropDownMenu=$this.find('.dropdown-menu');var systemSkin=window.localStorage.getItem('systemSkin_'+AppConfig.userId);if(!systemSkin||systemSkin==null||systemSkin==undefined){systemSkin='default';}
if(systemSkin=='default'){$dropDownMenu.css('background','#fff');}
if(systemSkin=='dark'){$dropDownMenu.css('background','#000');}
getUserMenuPic($dropDownMenu).done(function(){if(!$dropDownMenu.is('.'+systemSkin)){var remove='';if(systemSkin=='default'){remove='dark';}else if(systemSkin=='dark'){remove='default';}
$dropDownMenu.empty().html(beopTmpl('tpl_userMenuPicList',{list:_this.userMenuPic[systemSkin]})).removeClass(remove).addClass(systemSkin);$dropDownMenu.find("li").off().on('click',function(){if($(this).find('img').is(':visible')){var src=$(this).find('img').attr('src');$dropDownMenu.find('li').removeClass('active');$(this).addClass('active');$dropDownMenu.prev().removeClass(remove).addClass(systemSkin).empty().append('<img src="'+src+'"'+'>');_this.viewModel.nav[$navTop.find('#navTopUl>li').index($this)].pic=src;}});}});});},renderProjectSelector:function renderProjectSelector(projects){var lang=window.localStorage.getItem("language")=='en'?'en':'cn';var html=beopTmpl('project_selector_tmpl',{projects:projects,lang:lang});var $projectSelector=$('#projectSelector').empty().append(html);var projectName=$projectSelector.find("li[project-id="+this.projectId+"] a").text();var projectSrc=$projectSelector.find("li[project-id="+this.projectId+"] img").attr("src");$("#projectName").text(projectName).attr("project-id",this.projectId);$("#itemMainPic").attr("src",projectSrc);$("#saveSet").show();}};return MenuConfigure;}();var BenchmarkConfigure=function(){var static_id=0;function MenuItem(id,name,type,title,points,unit,description,desc,children,parentId){this.name=name;this.type=type;this.title=title;this.points=points;this.unit=unit;this.description=description;this.desc=isNaN(+desc)?0:+desc;if(!children){this.children=[];}else{this.children=children;}
if(!id){this._id=this.uniqueId();}else{this._id=id;}
if(parentId){this.parent=parentId;}}
MenuItem.prototype={uniqueId:function uniqueId(){return'new_'+static_id++;}};function BenchmarkConfigure(){this.viewModel={traverseNav:function traverseNav(navCollection,id,cb){if(!id){if(cb&&typeof cb==='function'){return cb(navCollection);}else{return navCollection;}}
if(navCollection&&navCollection.length!==0){for(var m=0;m<navCollection.length;m++){var collectionItem=navCollection[m];if(collectionItem._id===id){if(cb&&typeof cb==='function'){cb(navCollection,m);}else{return collectionItem;}}else{this.traverseNav(collectionItem.children,id,cb);}}}},setNav:function setNav(id,name,type,title,points,unit,description,desc,menuId){var ret={};this.traverseNav(this.nav,id,function(collection,index){if(collection&&collection.length){ret=collection[index];ret.name=name;ret.type=type;ret.title=title;if($.isArray(points)){ret.points=points;}else{ret.points=points&&points.split&&points.split(',');}
ret.unit=unit;ret.description=description;ret.desc=isNaN(+desc)?0:+desc;ret.menuId=menuId;}});return ret;},getNav:function getNav(id){if(!id){return{};}
var ret={};this.traverseNav(this.nav,id,function(collection,index){ret=collection[index];});return ret;},removeNav:function removeNav(id){var ret={};this.traverseNav(this.nav,id,function(collection,index){if(collection&&collection.length){ret=collection.splice(index,1);}});return ret;},clearChildren:function clearChildren(id){this.traverseNav(this.nav,id,function(collection,index){collection[index].children=[];});},addNav:function addNav(parentId,name,type,title,points,unit,description,desc){if(!type){return{};}
var nav=this.nav,ret={};this.traverseNav(this.nav,parentId,function(collection,index){if(!parentId){ret=new MenuItem(null,name,type,title,points,unit,description,desc);nav.push(ret);}else{if(collection&&collection.length&&collection[index]){if(BEOPUtil.isUndefined(collection[index].children)){collection[index].children=[];}
ret=new MenuItem(null,name,type,title,points,unit,description,desc,null,parentId);collection[index].children.push(ret);}}});return ret;}};}
BenchmarkConfigure.prototype={defaultTopNavNum:8,defaultSubNavNum:10,init:function init(){Spinner.spin(ElScreenContainer);var _this=this;WebAPI.get('/static/views/admin/benchmark/benchmarkConfigure.html').done(function(htmlResult){$(ElScreenContainer).html(htmlResult);I18n.fillArea($(ElScreenContainer));WebAPI.post('/admin/benchmarkConfigure',{userId:AppConfig.userId}).done(function(result){if(result.success){$.extend(_this.viewModel,result.data);}
_this.renderBenchmarkMenu(_this.viewModel);Spinner.stop();});_this.bindEvents();});},show:function show(){$("#ulPages").empty();this.init();},close:function close(){},bindEvents:function bindEvents(){var _this=this;var $con=$("#benchmarkConfigure");var $topNavConfigWin=$('#benchmarkConfigureInfo');$con.on('click','.benchmarkSetMenuBtn',function(){ScreenManager.show(EnergyScreen,event.target.attributes['data-menu-id'].value);});$con.on('click','#projectSelector li',function(){var projectId=parseInt($(this).attr("project-id"));var projectName=$(this).find("a").text();var projectSrc=$(this).find("img").attr("src");Spinner.spin(ElScreenContainer);WebAPI.post('/admin/loadProjectMenu',{projectId:projectId}).done(function(result){if(result.success){$("#projectMenu").text(projectName).attr("title",projectName);$("#projectName").text(projectName).attr("project-id",projectId);$("#itemMainPic").attr("src",projectSrc);AppConfig.projectId=projectId;_this.viewModel.nav=result.data.nav;_this.renderBenchmarkMenu();}}).always(function(){Spinner.stop();});});$con.on("mouseover",'.itemLi',function(e){$(this).find(".menuOperation .subItemEdit").show();}).on("mouseout",'.itemLi',function(e){$(this).find(".menuOperation .subItemEdit").hide();});$con.off('change','select').on('change','select',function(){var $this=$(this),selectText=$this.val();$this.closest('li.itemLi').addClass('editing');if(!selectText){$this.next(".itemInfo").empty();}else{$this.next(".itemInfo").html(beopTmpl('benchmark_editing_tmpl',{nav:{}}));}});$con.on('click','.subItemEdit',function(){var $item=$(this).parents(".itemLi"),itemId=$item.attr('nav-id');var $mainMenu=$item.find(".mainMenu");var $itemInfo=$mainMenu.next(".itemInfo");var mainMenuText=$mainMenu.next('.itemInfo').find(".mainMenuText").text();var $ul=$item.find(".configDropDownDenuUl");var navModel=_this.viewModel.getNav(itemId);if($ul.find("li").length>0){$ul.slideDown(100);}else{$ul.html(beopTmpl('sub_nav_tmpl',{type:_this.viewModel.type})).slideDown(100);}
$item.find(".menuOperation").html(beopTmpl('dropDown_okOrNo_tmpl'));$itemInfo.html(beopTmpl('benchmark_editing_tmpl',{nav:navModel}));$item.addClass('editing');$(this).remove();});$con.on('click','.itemCancel',function(){var $itemLi=$(this).parents(".itemLi");var index=$("#navTopUl>li").index($itemLi);var $li=$itemLi.find(".configDropDownDenuUl li");var dataNav=_this.viewModel.nav[index].children;$itemLi.find(".mainInfo").html(beopTmpl('itemText_Content_tmpl',{'text':_this.viewModel.nav[index].text}));$.each($li,function(indexItem,item){var $item=$(item);if(indexItem<dataNav.length){var originalSelectValue=$(item).find(".secondaryMenu").val();$item.find(".secondaryMenu").val(dataNav[indexItem].type);$item.find(".displayName").val(dataNav[indexItem].text).attr("disabled",false);if(dataNav[indexItem].type=='ReportScreen'){if(originalSelectValue!='ReportScreen'){$item.find(".itemInfo").append(beopTmpl('operating_Report_tmpl'));$item.css("width",'100%');}
$item.find(".reportTypeSelect").val(dataNav[indexItem].reportType);$item.find(".directoryTypeInput").val(dataNav[indexItem].reportFolder);}}else{$item.find(".secondaryMenu").val("");$item.find(".displayName").val("").attr({"disabled":"disabled","placeholder":""});}});$itemLi.find("ul").slideUp();$itemLi.find(".menuOperation").html(beopTmpl('item_edit_tmpl'));});var getMenuModelFromPage=function getMenuModelFromPage($item){var model={navId:$item.attr('nav-id'),name:$item.find('.benchmark-name').val(),title:$item.find('.benchmark-title').val(),points:$item.find('.benchmark-points').val(),description:$item.find('.benchmark-description').val(),unit:$item.find('.benchmark-unit').val(),type:$item.find('.typeSelector option:selected').val(),desc:$item.find('.benchmark-desc option:selected').val(),menuId:$item.find('.benchmarkSetMenuBtn').data('menu-id')};if(model.points){model.points=model.points.split(',');}
return model;};var updateMenuModel=function updateMenuModel($item,parentId){var menuModel=getMenuModelFromPage($item);if(!menuModel.type){if(menuModel.navId){_this.viewModel.removeNav(menuModel.navId);$item.attr('nav-id','');}}else{if(menuModel.navId){_this.viewModel.setNav(menuModel.navId,menuModel.name,menuModel.type,menuModel.title,menuModel.points,menuModel.unit,menuModel.description,menuModel.desc,menuModel.menuId);}else{var newItem=_this.viewModel.addNav(parentId,menuModel.name,menuModel.type,menuModel.title,menuModel.points,menuModel.unit,menuModel.description,menuModel.desc);$item.attr('nav-id',newItem._id);}}};$("#saveSet").click(function(){var commitFlag=true;$.each($("#navTopUl input.benchmark-name:visible:enabled"),function(i,inputItem){var val=$.trim($(inputItem).val());if(val==""){$(inputItem).focus();commitFlag=false;$("#errorConfigure").text("文本框不能为空！").show();return false;}});if(!commitFlag){return false;}
Spinner.spin(ElScreenContainer);$.each($("#navTopUl>li"),function(index,item){var $item=$(item);if(!$item.hasClass('editing')){return;}
updateMenuModel($item);if($item.find(".configDropDownDenuUl li").length){var $li=$item.find(".configDropDownDenuUl li");$.each($li,function(indexChild,itemChild){updateMenuModel($(itemChild),$item.attr('nav-id'));});}});WebAPI.post('/admin/benchmarkEdit',{userId:AppConfig.userId,menu:_this.viewModel}).done(function(result){if(result.success){new Alert($topNavConfigWin,Alert.type.success,I18n.resource.code[result.code]).showAtTop(2000);_this.viewModel.nav=result.data.nav;_this.renderBenchmarkMenu();}else{new Alert($topNavConfigWin,Alert.type.danger,I18n.resource.code[result.code]).showAtTop(2000);}
$("#errorConfigure").text("").hide();}).always(function(){Spinner.stop();});});},renderBenchmarkMenu:function renderBenchmarkMenu(model){if(!model){model=this.viewModel;}
var html=beopTmpl('benchmark_tmpl',{nav:model.nav,type:model.type,defaultNum:this.defaultTopNavNum,reportType:this.viewModel.type});$('#navTop').empty().append(html);$.each($(".configDropDownDenuUl li"),function(index,item){var $item=$(item);$item.attr("parent-id",$item.parents(".itemLi").attr("nav-id"));});}};return BenchmarkConfigure;}();var BenchMark=function(){var _this=undefined;function BenchMark(){_this=this;this.init();}
BenchMark.prototype={init:function init(){var $benchWrap=$('#benchWrap');I18n.fillArea($benchWrap);this.attachEvent();},showModal:function showModal(menuId){var $dialog=$('#dialogModal');var energyScreen=new EnergyScreen();var $dialogContent=$dialog.find('#dialogContent').css({height:'90%',width:'90%',margin:'auto',marginTop:'2.5%',backgroundColor:'#fff'});$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$dialogContent.removeAttr('style').html('');energyScreen.close();}).modal({});$dialog.show();energyScreen.id=menuId;energyScreen.container=$dialogContent[0];energyScreen.isForBencMark=true;energyScreen.init();},close:function close(){},getData:function getData(callbk){var data=[];for(var i in AppConfig.projectList){data.push(AppConfig.projectList[i].id);}
var $KPICt=$('#KPICt');if($KPICt[0]){$KPICt.css({opacity:'0.8'});Spinner.spin($KPICt[0]);}
$KPICt.find('.spinnerMask').css({borderRadius:'5px',backgroundColor:"rgba(170,170,170,0.5)"});WebAPI.post('/benchmark/getAll',data).done(function(result){AppConfig.benchMark=result;if(AppConfig.benchMark.length>0){_this.initDom(AppConfig.benchMark);$KPICt.css({opacity:'1'});if(callbk){callbk();}}}).fail(function(){}).always(function(){Spinner.stop();});},getDataByTargetId:function getDataByTargetId(id){var find=null;var data=AppConfig.benchMark;for(var i=0,row,len=data.length;i<len;i++){row=data[i];if(row.id===id){find=row;break;}}
return find;},getMaxAndMin:function getMaxAndMin(data){var max,min;for(var i=0,len=data.length;i<len;i++){if(data[i].value===-1)continue;if(max===undefined||data[i].value>max)max=data[i].value;if(min===undefined||data[i].value<min)min=data[i].value;}
return{min:min,max:max};},initDom:function initDom(data){var _this=this,prevRank={};var $KPICt=$('#KPICt');var $navTab=$KPICt.find('.navTab');var $targetUlCt=$('#targetUlCt');var tempDataParent=[];var tempDataChildren=[];var tempDate=[];if(!data||data.length<1)return;for(var i=0;i<data.length;i++){if(!data[i].parent){tempDataParent.push(data[i]);}else{tempDataChildren.push(data[i]);}}
tempDate=tempDataParent.concat(tempDataChildren);for(var i=0;i<tempDate.length;i++){var benchmark=tempDate[i];var $targetUl=$('<ul class="nav nav-stacked targetUl" data-angle="all">').attr('id',benchmark.id);var $liTab=undefined;if(!benchmark.parent){$liTab=$('<li role="presentation" data-target="'+benchmark.id+'" unit="'+benchmark.unit+'">').attr('menu-id',benchmark.menuId);$navTab.append($liTab);}else{var isParentExist=findParent(benchmark.parent);if(!isParentExist){continue;}
var $parentLi=$('.rows[parent-id="'+benchmark.parent+'"]');if($parentLi.length<1){$parentLi=$('<li class="rows">').attr('parent-id',benchmark.parent);var $prevLi=$('[data-target="'+benchmark.parent+'"]');$prevLi.after($parentLi);}
var $liTab=$('<div class="subRows" unit="'+benchmark.unit+'">').attr('data-target',benchmark.id).attr('menu-id',benchmark.menuId);$parentLi.append($liTab);}
$liTab.click(function(){var _that=this;var targetId=$(this).attr('data-target');var data=_this.getDataByTargetId(targetId);var maxmin=_this.getMaxAndMin(data.list);var options={range:{min:maxmin.min,max:maxmin.max}};options.colors=data.desc===0?['#87E034','#EDE24C','#F53F52']:['#F53F52','#EDE24C','#87E034'];_this.dataRangeCtrl.setOptions(options);_this.dataRangeCtrl.initMarkers(data.list);_this.dataRangeCtrl.show();$navTab.find('.selected').removeClass('selected').children('.glyphicon').remove();var $play=$('<span class="glyphicon glyphicon-play"></span>');$(this).addClass('selected').append($play);var unit=$(this).attr('unit');$('#spanUnit span').html(unit!=''?unit:'--');$('#btnViewDetail').off('click').click(function(){ScreenModal=new BenchMark(_this);ScreenModal.showModal($(_that).attr('menu-id'));});}).prepend('<span class="KPIName" title="'+benchmark.name+'">'+benchmark.name+'</span>');for(var j in benchmark.list){var rank={};var project=benchmark.list[j];var projectName=getNameByProjectId(project.projectId);var value='--';if(j>0&&project.value==benchmark.list[j-1].value){rank=prevRank;}else{rank=getRank(j);}
if(project.value!=-1){value=project.value.toFixed(2);}
var $orderItem=$('<li class="item" project-id="'+project.projectId+'" style="top:'+j*35.5+'px" index="'+rank.index+'"><span class="trophy"></span><span class="rank">'+rank.order+'</span><span class="name" title="'+projectName+'">'+projectName+'</span><span class="value">'+value+'</span></li>');$targetUl.append($orderItem);}
$targetUlCt.append($targetUl);}
$navTab.children('li:eq(0)').addClass('selected').append($('<span class="glyphicon glyphicon-play" style="-webkit-transform: rotate(-180deg) scaleX(0.8);">'));$targetUlCt.children('ul:eq(0)').show();$navTab.children('li:eq(0)').trigger('click');$('#benchTop').show();$navTab.find('[data-target]').wheelmenu({trigger:"click",animation:"fade",animationSpeed:"fast"});if($('#ulPages').children('li').length>0){_this.renderOrder();}
function getRank(i){var rank={};i=parseInt(i);switch(i){case 0:rank.order='1st';rank.index=1;break;case 1:rank.order='2st';rank.index=2;break;case 2:rank.order='3st';rank.index=3;break;default:rank.order=i+1+'th';rank.index=i+1;break;}
prevRank=rank;return rank;}
function getNameByProjectId(id){var name=undefined;for(var i in AppConfig.projectList){if(AppConfig.projectList[i].id==id){if(I18n.type=='zh'){name=AppConfig.projectList[i].name_cn;}else if(I18n.type=='en'){name=AppConfig.projectList[i].name_english;}}}
return name;}
function findParent(parent){for(var i in AppConfig.benchMark){var benchmark=AppConfig.benchMark[i];if(benchmark.id==parent){if(!benchmark.parent){if($navTab.find('[data-target="'+benchmark.id+'"]').length==1){return true;}else{return false;}}else{findParent(benchmark.parent);}}}
return false;}},attachEvent:function attachEvent(){var $btnViewKPI=$('#btnViewKPI');var $KPICt=$('#KPICt');$btnViewKPI.off('click').click(function(){if(!AppConfig.benchMark||AppConfig.benchMark.length==0){_this.getData();}else if($('.navTab').children('li').length<1){_this.initDom(AppConfig.benchMark);}
$btnViewKPI.children('.arrow').toggle();$btnViewKPI.children('.glyphicon').toggleClass('glyphicon-star-empty');$KPICt.toggle();});},refresh:function refresh(){var $navTab=$('.navTab');$('.selectedProj').removeClass('selectedProj');$navTab.find('.order').remove();if($navTab.children('li').length<1){if(AppConfig.benchMark&&AppConfig.benchMark.length>0){_this.initDom(AppConfig.benchMark);_this.renderOrder();}}else{_this.renderOrder();}},renderOrder:function renderOrder(){var $navTab=$('.navTab');var $list=$('.targetUl [project-id="'+AppConfig.projectId+'"]').addClass('selectedProj');$list.each(function(){var id=$(this).parent().attr('id');var $all=$(this).closest('.targetUl').children('li');var index=$(this).attr('index');var len=$all.length;var $index=$('<span class="rankIndex">').html(index).css({color:'#FFCC00'});var $len=$('<span class="rankLen">').html('/'+len);var $order=$('<span class="order"></span>').append($index).append($len);$navTab.find('[data-target="'+id+'"]').prepend($order);});$navTab.find('[data-target]').each(function(){var target=$(this).attr('data-target');if($.inArray(target,AppConfig.projectBenchmark)<0){$(this).hide();}else{$(this).show();}});},addDataRangeCtrl:function addDataRangeCtrl(ctrl){this.dataRangeCtrl=ctrl;}};return BenchMark;}();!function($){var defaults={trigger:"click",animation:"fade",angle:[0,360],animationSpeed:"medium"};$.fn.flyIn=function(el,button,width,height,angle,step,radius,settings){var d=0;this.stop(true,true);this.each(function(index){angle=(settings.angle[0]+step*index)*(Math.PI/180);var x=Math.round(width/2+radius*Math.cos(angle)-$(this).find("a").outerWidth()/2),y=Math.round(height/2+radius*Math.sin(angle)-$(this).find("a").outerHeight()/2);$(this).animateRotate(360).css({position:'absolute',opacity:0,left:"50%",top:"50%",marginLeft:"-"+$(this).outerWidth()/2,marginTop:"-"+$(this).outerHeight()/2}).delay(d).animate({opacity:1,left:x+'px',top:y+'px'},settings.animationSpeed[1]);d+=settings.animationSpeed[0];});};$.fn.flyOut=function(el,button){var d=0;this.stop(true,true);$(this.get().reverse()).each(function(){$(this).animateRotate(-360).delay(d).animate({opacity:0,left:el.outerWidth()/2+"px",top:el.outerHeight()/2+"px"},150);d+=15;}).promise().done(function(){el.removeClass("active").css("visibility","hidden").hide();button.removeClass("active");});};$.fn.fadeInIcon=function(el,button,width,height,angle,step,radius,settings){var d=0;el.siblings('.targetUl').hide();this.stop(true,true);this.each(function(index){$(this).css({position:'absolute',opacity:0}).delay(d).animate({opacity:1},settings.animationSpeed[1]);d+=settings.animationSpeed[0];});};$.fn.fadeOutIcon=function(el,button){button.removeClass("active");};$.fn.hideIcon=function(button,settings){var fields=this.find(".item"),el=this;switch(settings.animation){case'fade':fields.fadeOutIcon(el,button);break;case'fly':fields.flyOut(el,button);break;}};$.fn.showIcon=function(button,settings){var el=this,zindex='6';if(settings.trigger=="hover"){zindex='3';}
button.addClass("active").css({'z-index':zindex});el.show();el.addClass("wheel active").css("visibility","visible").show();if(el.attr('data-angle')){settings.angle=el.attr('data-angle');}
settings=predefineAngle(settings);var radius=el.width()/2,fields=el.find(".item"),container=el,width=container.innerWidth(),height=container.innerHeight(),angle=0,step=(settings.angle[1]-settings.angle[0])/fields.length;switch(settings.animation){case'fade':fields.fadeInIcon(el,button,width,height,angle,step,radius,settings);break;case'fly':fields.flyIn(el,button,width,height,angle,step,radius,settings);break;}};function predefineAngle(settings){var convert=false;if($.type(settings.angle)=="string"){try{if(eval(settings.angle).length>1)convert=true;}catch(err){convert=false;}
if(convert==true){settings.angle=JSON.parse(settings.angle);}else{switch(settings.angle){case'N':settings.angle=[180,380];break;case'NE':settings.angle=[270,380];break;case'E':settings.angle=[270,470];break;case'SE':settings.angle=[360,470];break;case'S':settings.angle=[360,560];break;case'SW':settings.angle=[90,200];break;case'W':settings.angle=[90,290];break;case'NW':settings.angle=[180,290];break;case'all':settings.angle=[0,360];break;}}}
return settings;}
function predefineSpeed(settings){if($.type(settings.animationSpeed)=="string"){switch(settings.animationSpeed){case'slow':settings.animationSpeed=[75,700];break;case'medium':settings.animationSpeed=[50,500];break;case'fast':settings.animationSpeed=[25,250];break;case'instant':settings.animationSpeed=[0,0];break;}}
return settings;}
$.fn.wheelmenu=function(options){var settings=$.extend({},defaults,options);settings=predefineSpeed(settings);return this.each(function(){var button=$(this);var el=$('#'+$(this).attr("data-target"));el.addClass("wheel");button.css("opacity",0).animate({opacity:1});if(settings.trigger=="hover"){button.bind({mouseenter:function mouseenter(){el.showIcon(button,settings);}});button.bind({mouseleave:function mouseleave(){el.hideIcon(button,settings);}});}else{button.click(function(){if(el.css('display')!='none'){el.hideIcon(button,settings);}else{el.showIcon(button,settings);}});}});};}(window.jQuery);var theme={};theme.Dark={backgroundColor:'transport',color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500'],title:{textStyle:{fontWeight:'normal',color:'#fff'}},legend:{textStyle:{color:'#999999'},top:30},visualMap:{itemWidth:15,color:['#FFF808','#21BCF9'],textStyle:{color:'#ccc'}},toolbox:{showTitle:false},tooltip:{trigger:'axis',backgroundColor:'rgba(250,250,250,0.9)',axisPointer:{type:'line',lineStyle:{color:'#aaa'},crossStyle:{color:'#aaa'},shadowStyle:{color:'rgba(200,200,200,0.2)'}},textStyle:{color:'#333'}},dataZoom:{dataBackgroundColor:'#555',fillerColor:'rgba(200,200,200,0.2)',handleColor:'#eee'},grid:{borderWidth:0,left:80,bottom:40,right:80,top:80},valueAxis:{axisLine:{show:false},axisTick:{show:false},axisLabel:{textStyle:{color:'#a2adbc'},margin:10},splitLine:{lineStyle:{color:['#4e5d77'],type:"solid",opacity:'0.6'}},nameTextStyle:{color:'#999999'}},categoryAxis:{axisLine:{lineStyle:{color:'#4e5d77'}},axisTick:{show:false},axisLabel:{textStyle:{color:'#a2adbc'},margin:10},splitLine:{show:false},nameTextStyle:{color:'#999999'}},textStyle:{fontFamily:'Microsoft YaHei, Arial, Verdana, sans-serif'},polar:{name:{textStyle:{color:'#ccc'}},axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{label:{textStyle:{color:'#ccc'}},lineStyle:{color:'#aaa'},controlStyle:{normal:{color:'#fff'},emphasis:{color:'#FE8463'}},symbolSize:3},line:{smooth:true},pie:{type:'pie',radius:['50%','70%'],labelLine:{normal:{show:true,lineStyle:{width:[2]}}},hoverAnimation:false},gauge:{center:['50%','70%'],itemStyle:{normal:{color:['#d7603f']}},detail:{offsetCenter:['0','20%'],textStyle:{color:'#ccc'}},radius:'105%',data:[{value:50,name:'完成率'}],startAngle:180,endAngle:0,axisLine:{show:true,lineStyle:{color:[[0.25,'#04A0D6'],[0.5,'#689C0F'],[0.75,'#FEC500'],[1,'#109d83']],width:5}},axisTick:{length:35,lineStyle:{color:'auto',width:3}},axisLabel:{textStyle:{color:'#a2adbc'}},splitLine:{length:45,lineStyle:{width:4,color:'auto'}}}};