(function(root,factory){if(typeof exports=='object')module.exports=factory()
else if(typeof define=='function'&&define.amd)define(factory)
else root.LoadingSpinner=factory()}
(this,function(){"use strict";var prefixes=['webkit','Moz','ms','O'],animations={},useCssAnimations;function createEl(tag,prop){var el=document.createElement(tag||'div'),n;for(n in prop)el[n]=prop[n]
return el}
function ins(parent){for(var i=1,n=arguments.length;i<n;i++)
parent.appendChild(arguments[i])
return parent}
var sheet=(function(){var el=createEl('style',{type:'text/css'})
ins(document.getElementsByTagName('head')[0],el)
return el.sheet||el.styleSheet}())
function addAnimation(alpha,trail,i,lines){var name=['opacity',trail,~~(alpha*100),i,lines].join('-'),start=0.01+i/lines*100,z=Math.max(1-(1-alpha)/trail*(100-start),alpha),prefix=useCssAnimations.substring(0,useCssAnimations.indexOf('Animation')).toLowerCase(),pre=prefix&&'-'+prefix+'-'||''
if(!animations[name]){sheet.insertRule('@'+pre+'keyframes '+name+'{'+'0%{opacity:'+z+'}'+
start+'%{opacity:'+alpha+'}'+
(start+0.01)+'%{opacity:1}'+
(start+trail)%100+'%{opacity:'+alpha+'}'+'100%{opacity:'+z+'}'+'}',sheet.cssRules.length)
animations[name]=1}
return name}
function vendor(el,prop){var s=el.style,pp,i
prop=prop.charAt(0).toUpperCase()+prop.slice(1)
for(i=0;i<prefixes.length;i++){pp=prefixes[i]+prop
if(s[pp]!==undefined)return pp}
if(s[prop]!==undefined)return prop}
function css(el,prop){for(var n in prop)
el.style[vendor(el,n)||n]=prop[n]
return el}
function merge(obj){for(var i=1;i<arguments.length;i++){var def=arguments[i]
for(var n in def)
if(obj[n]===undefined)obj[n]=def[n]}
return obj}
function pos(el){var o={x:el.offsetLeft,y:el.offsetTop}
while((el=el.offsetParent))
o.x+=el.offsetLeft,o.y+=el.offsetTop
return o}
function getColor(color,idx){return typeof color=='string'?color:color[idx%color.length]}
var defaults={lines:12,length:10,width:5,radius:15,rotate:0,corners:1,color:'#000',direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:1001,className:'spinner',top:'50%',left:'50%',position:'absolute'}
function LoadingSpinner(o){this.opts=merge(o||{},LoadingSpinner.defaults,defaults)}
LoadingSpinner.defaults={}
merge(LoadingSpinner.prototype,{spin:function(target){this.stop()
this.opts.target=target;var divMask=document.createElement("div");divMask.className="spinnerMask";divMask.style.width=target.width;divMask.style.height=target.height;target.appendChild(divMask);this.divMask=divMask;var self=this,o=self.opts,el=self.el=css(createEl(0,{className:o.className}),{position:o.position,width:0,zIndex:o.zIndex}),mid=o.radius+o.length+o.width
css(el,{left:o.left,top:o.top})
if(target){target.insertBefore(el,target.firstChild||null)}
el.setAttribute('role','progressbar')
self.lines(el,self.opts)
if(!useCssAnimations){var i=0,start=(o.lines-1)*(1-o.direction)/2,alpha,fps=o.fps,f=fps/o.speed,ostep=(1-o.opacity)/(f*o.trail/100),astep=f/o.lines;(function anim(){i++;for(var j=0;j<o.lines;j++){alpha=Math.max(1-(i+(o.lines-j)*astep)%f*ostep,o.opacity)
self.opacity(el,j*o.direction+start,alpha,o)}
self.timeout=self.el&&setTimeout(anim,~~(1000/fps))})()}
return self},stop:function(){var el=this.el
if(el){clearTimeout(this.timeout)
if(el.parentNode)el.parentNode.removeChild(el)
this.el=undefined
if(this.divMask){if(this.divMask.parentNode)this.divMask.parentNode.removeChild(this.divMask)
this.el=undefined}}
return this},lines:function(el,o){var i=0,start=(o.lines-1)*(1-o.direction)/2,seg
function fill(color,shadow){return css(createEl(),{position:'absolute',width:(o.length+o.width)+'px',height:o.width+'px',background:color,boxShadow:shadow,transformOrigin:'left',transform:'rotate('+~~(360/o.lines*i+o.rotate)+'deg) translate('+o.radius+'px'+',0)',borderRadius:(o.corners*o.width>>1)+'px'})}
for(;i<o.lines;i++){seg=css(createEl(),{position:'absolute',top:1+~(o.width/2)+'px',transform:o.hwaccel?'translate3d(0,0,0)':'',opacity:o.opacity,animation:useCssAnimations&&addAnimation(o.opacity,o.trail,start+i*o.direction,o.lines)+' '+1/o.speed+'s linear infinite'})
if(o.shadow)ins(seg,css(fill('#000','0 0 4px '+'#000'),{top:2+'px'}))
ins(el,ins(seg,fill(getColor(o.color,i),'0 0 1px rgba(0,0,0,.1)')))}
return el},opacity:function(el,i,val){if(i<el.childNodes.length)el.childNodes[i].style.opacity=val}})
function initVML(){function vml(tag,attr){return createEl('<'+tag+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',attr)}
sheet.addRule('.spin-vml','behavior:url(#default#VML)')
LoadingSpinner.prototype.lines=function(el,o){var r=o.length+o.width,s=2*r
function grp(){return css(vml('group',{coordsize:s+' '+s,coordorigin:-r+' '+-r}),{width:s,height:s})}
var margin=-(o.width+o.length)*2+'px',g=css(grp(),{position:'absolute',top:margin,left:margin}),i
function seg(i,dx,filter){ins(g,ins(css(grp(),{rotation:360/o.lines*i+'deg',left:~~dx}),ins(css(vml('roundrect',{arcsize:o.corners}),{width:r,height:o.width,left:o.radius,top:-o.width>>1,filter:filter}),vml('fill',{color:getColor(o.color,i),opacity:o.opacity}),vml('stroke',{opacity:0}))))}
if(o.shadow)
for(i=1;i<=o.lines;i++)
seg(i,-2,'progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)')
for(i=1;i<=o.lines;i++)seg(i)
return ins(el,g)}
LoadingSpinner.prototype.opacity=function(el,i,val,o){var c=el.firstChild
o=o.shadow&&o.lines||0
if(c&&i+o<c.childNodes.length){c=c.childNodes[i+o];c=c&&c.firstChild;c=c&&c.firstChild
if(c)c.opacity=val}}}
var probe=css(createEl('group'),{behavior:'url(#default#VML)'})
if(!vendor(probe,'transform')&&probe.adj)initVML()
else useCssAnimations=vendor(probe,'animation')
return LoadingSpinner}));var theme={};theme.Dark={backgroundColor:'transport',color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500'],title:{textStyle:{fontWeight:'normal',color:'#fff'}},legend:{textStyle:{color:'#999999'},top:30},visualMap:{itemWidth:15,color:['#FFF808','#21BCF9'],textStyle:{color:'#ccc'}},toolbox:{showTitle:false},tooltip:{trigger:'axis',backgroundColor:'rgba(250,250,250,0.9)',axisPointer:{type:'line',lineStyle:{color:'#aaa'},crossStyle:{color:'#aaa'},shadowStyle:{color:'rgba(200,200,200,0.2)'}},textStyle:{color:'#333'}},dataZoom:{dataBackgroundColor:'#555',fillerColor:'rgba(200,200,200,0.2)',handleColor:'#eee'},grid:{borderWidth:0,left:80,bottom:40,right:80,top:80},valueAxis:{axisLine:{show:false},axisTick:{show:false},axisLabel:{textStyle:{color:'#a2adbc'},margin:10},splitLine:{lineStyle:{color:['#4e5d77'],type:"solid",opacity:'0.6'}},nameTextStyle:{color:'#999999'}},categoryAxis:{axisLine:{lineStyle:{color:'#4e5d77'}},axisTick:{show:false},axisLabel:{textStyle:{color:'#a2adbc'},margin:10},splitLine:{show:false},nameTextStyle:{color:'#999999'}},textStyle:{fontFamily:'Microsoft YaHei, Arial, Verdana, sans-serif'},polar:{name:{textStyle:{color:'#ccc'}},axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{label:{textStyle:{color:'#ccc'}},lineStyle:{color:'#aaa'},controlStyle:{normal:{color:'#fff'},emphasis:{color:'#FE8463'}},symbolSize:3},line:{smooth:true},pie:{type:'pie',radius:['50%','70%'],labelLine:{normal:{show:true,lineStyle:{width:[2]}}},hoverAnimation:false},gauge:{center:['50%','70%'],itemStyle:{normal:{color:['#d7603f']}},detail:{offsetCenter:['0','20%'],textStyle:{color:'#ccc'}},radius:'105%',data:[{value:50,name:'完成率'}],startAngle:180,endAngle:0,axisLine:{show:true,lineStyle:{color:[[0.25,'#04A0D6'],[0.5,'#689C0F'],[0.75,'#FEC500'],[1,'#109d83']],width:5}},axisTick:{length:35,lineStyle:{color:'auto',width:3}},axisLabel:{textStyle:{color:'#a2adbc'}},splitLine:{length:45,lineStyle:{width:4,color:'auto'}}}};var Validator=(function($,undefined){var push=[].push;var rulesMap={};function RuleWrap(ele,name,rule){this.$ele=$(ele);this.name=name;this.rule=rule;this.defer=$.Deferred();this.value=this.$ele.val();};RuleWrap.prototype.valid=function(){var handler=this.rule.valid;var _this=this;var type=$.type(handler);if(type!=='function'&&type!=='string'){console.warn('rule is illigal!');return;}
else if(type==='string'&&rulesMap[handler]===undefined){console.warn('rule is not exists!');return;}
else if(type==='string'){handler=rulesMap[handler];}
return handler;};RuleWrap.prototype.success=function(){this.defer.resolveWith(this);};RuleWrap.prototype.fail=function(){this.defer.rejectWith(this);};function Validator(ele,options){if(arguments.length===0)return this;if(arguments.length===1){options=ele;ele='body';}
this.$ele=$.type(ele)==='object'?ele:$(ele);this.options=$.extend({},Validator.DEFAULTS,options);this.__merge(this,this.options.elements||[]);this.__init();return this;}
Validator.prototype.__init=function(){var $selectors;var html='<span class="glyphicon'+
(this.options.icon?' glyphicon-pencil':'')+' form-control-feedback"></span>';for(var i=0,row,len=this.length;i<len;i++){row=this[i];$selectors=$.type(row['selector'])==='object'?row['selector']:$(row['selector'],this.$ele);$selectors.each(function(i,ele){var $ele=$(ele),$formGroup;$formGroup=$ele.closest('.form-group');$formGroup.addClass('has-feedback');if($formGroup.children('form-control-feedback').length===0){$(html).insertAfter($ele);}});}};Validator.prototype.valid=function(callback){var self=this;var row,results=[];var $selectors;var deferGroups=[];this.resetStatus();for(var i=0,len=this.length;i<len;i++){row=this[i];$selectors=$.type(row['selector'])==='object'?row['selector']:$(row['selector'],this.$ele);if($selectors.length===0)continue;$selectors.each(function(i,ele){var $ele=$(ele);var val=$ele.val();var defers=[];var obj;for(var t=0,len2=row.rules.length;t<len2;t++){obj=new RuleWrap(ele,row.name,row.rules[t]);defers.push(obj);}
defers[0].valid().call(defers[0],defers[0].value);defers=defers.map(function(row,i,arr){if(i+1<len2){row.defer.done(function(){arr[i+1].valid().call(arr[i+1],defers[0].value);});}
return row.defer;});deferGroups.push(defers);});}
deferGroups=deferGroups.map(function(deferGrp,i){var newDefer=$.Deferred();$.when.apply($,deferGrp).done(function(){var $ele,$formGroup;var _this,obj={};if(this.length)_this=this[0];else _this=this;$ele=_this.$ele;self.setStatus($ele,'success');obj[_this.name]=_this.value;newDefer.resolve(obj);}).fail(function(){var $ele=this.$ele,ele=$ele[0];self.setStatus($ele,'error');if(ele.timer!==null){window.clearTimeout(ele.timer);ele.timer=null;}
$ele.tooltip({placement:'top',trigger:'manual'}).attr('data-original-title',this.rule['msg']).tooltip('show');ele.timer=window.setTimeout((function($ele){return function(){$ele.tooltip('hide');$ele[0].timer=null;}}($ele)),2000);newDefer.reject();});return newDefer;});return $.when.apply($,deferGroups).then(function(rs){return $.extend.apply($,([]).slice.call(arguments));});};Validator.prototype.setStatus=function($ele,type){if(!this.options.icon)return;if(type==='error'){$ele.closest('.form-group').addClass('has-error').children('.form-control-feedback').removeClass(['glyphicon-ok','glyphicon-pencil'].join(' ')).addClass('glyphicon-remove');}else if(type==='success'){$ele.closest('.form-group').addClass('has-success').children('.form-control-feedback').removeClass(['glyphicon-pencil','glyphicon-remove'].join(' ')).addClass('glyphicon-ok');}};Validator.prototype.resetStatus=function(){var $selectors,row,$ele,ele,data;for(var i=0,len=this.length;i<len;i++){row=this[i];$selectors=typeof row['selector']==='object'?row['selector']:$(row['selector'],this.$ele);for(var t=0,len2=$selectors.length;t<len2;t++){$ele=$selectors.eq(t);ele=$selectors[t];$ele.parents('.form-group').removeClass('has-error has-success');if(ele.timer){window.clearTimeout(ele.timer);ele.timer=null;}
if(data=$ele.data('bs.tooltip')){data.$tip.detach();}}}};Validator.prototype.filter=function(selector){return this.__seek(selector,true);};Validator.prototype.not=function(selector){return this.__seek(selector,false);};Validator.prototype.__seek=function(selector,isNeed){var results=[],ret;var eles=this.options.elements;var regx=$.type(selector)==='string'?new RegExp('^'+selector+'$'):regx;if($.type(regx)!=='regexp'){throw'selector is not a RegExp object or a string!';}
isNeed=isNeed||false;for(var i=0,len=eles.length;i<len;i++){if(!!regx.test(eles[i]['name'])===isNeed)results.push(eles[i]);}
ret=this.__merge(new this.constructor(),results);ret.prevObj=this;ret.$ele=this.$ele;ret.options=this.options;return ret;}
Validator.prototype.__merge=function(newObj,arr){for(var i=0,len=arr.length;i<len;i++){push.call(newObj,arr[i]);}
return newObj;};Validator.prototype.length=0;Validator.prototype.splice=[].splice;Validator.extendRules=function(name,handler){var rules={},fn;if($.type(name)==='string')rules[name]=handler;else if($.type(name)==='object')rules=name;else return;for(var i in rules){if(!rules.hasOwnProperty(i))continue;fn=rules[i]
if($.type(fn)!=='function')continue;rulesMap[i]=fn;}};Validator.extendRules({'require':function(val){if(val.trim()==='')this.fail();else this.success();},'word':function(val){if(/^\w+$/.test(val))this.success();else this.fail();}});Validator.DEFAULTS={tooltipDelay:2000,icon:true};return Validator;}(jQuery))
﻿
var Internationalization=(function(){function Internationalization(lang,resource){this.type=lang||localStorage["language"];this.resource=resource||{};}
Internationalization.prototype={getResource:function(){return this.resource;},fillPage:function(){this.fill2($('[i18n]'));},fillArea:function(element){this.fill2(element.find('[i18n]'));try{Permission.check(element);}catch(e){console.log('check permission failed:'+e);}},fillAreaAttribute:function(element,attributeName){this.fill(element.find('[i18n]['+attributeName+']'),attributeName);},fill:function(arrElement,attributeName){for(var i=0,arrPath,text,len=arrElement.length;i<len;i++){arrPath=arrElement[i].attributes["i18n"].value.split('.');text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
if(!attributeName){arrElement[i].innerHTML=text;}
else{arrElement[i].setAttribute(attributeName,text);}}},getI18nValue:function(i18nKey){if(!i18nKey){return'';}
var arrPath=i18nKey.split('.');var text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
return text;},fill2:function(arrElement){for(var i=0,len=arrElement.length;i<len;i++){var i18nValue=arrElement[i].attributes["i18n"];var items=i18nValue.value.split(';'),item,attrMap;for(var j=0;j<items.length;j++){item=items[j];if(!item){continue;}
if(item.indexOf('=')===-1){i18nValue=this.getI18nValue(item);arrElement[i].innerHTML=i18nValue;}else{attrMap=item.split('=');if(!attrMap[0]){continue;}
arrElement[i].setAttribute(attrMap[0],this.getI18nValue(attrMap[1]));}}}},findContent:function(strPath){var arrPath=strPath.split('.');var text=this.resource;for(var i=0,len=arrPath.length;i<len;i++){text=text&&text[arrPath[i]];}
return text;}};return Internationalization;})();function InitI18nResource(strLanguage,isForce,filePath){if(!strLanguage){strLanguage=localStorage["isUserSelectedLanguage"]||navigator.language.split('-')[0];}
if(isForce){localStorage["isUserSelectedLanguage"]=strLanguage;}else if(localStorage["isUserSelectedLanguage"]){strLanguage=localStorage["isUserSelectedLanguage"];}
filePath=filePath||'/static/views/js/i18n/';return $.ajax({async:false,url:filePath+strLanguage+".js",dataType:"script"}).then(function(){localStorage["language"]=strLanguage;return i18n_resource;},function(){return $.ajax({async:false,url:filePath+"en.js",dataType:'script'}).then(function(){localStorage["language"]="en";return i18n_resource;},function(){console.warn('i18n files loading failed!');return{};});});}
var FactoryIoC=(function(){function FactoryIoC(strType){this.listClass=[];this.init(strType);};FactoryIoC.prototype={init:function(strType){switch(strType){case'analysis':this.initAnalysisModule();break;case'dashboard':this.initDashboardModule();break;case'report':this.initReportModule();break;default:break;}},add:function(entityClass){this.listClass.push(entityClass);},getModel:function(strModelName){for(var i=0,len=this.listClass.length;i<len;i++){if(strModelName.toLowerCase()==this.listClass[i].name.toLowerCase()){return this.listClass[i];}}
return null;},getList:function(){return this.listClass;},initAnalysisModule:function(){this.add(AnlzTendency);this.add(AnlzSpectrum);this.add(AnlzScatter);this.add(AnlzHistoryCompare);this.add(AnlzHistoryCompare_Line);this.add(AnlzStack);this.add(AnlzPieRealtime);this.add(AnlzEnergy);this.add(AnlzCluster);this.add(AnlzCluster_AHU);this.add(AnlzCluster_Chiller);},initDashboardModule:function(){this.add(ModalNone);this.add(ModalAnalysis);this.add(ModalHistoryChart);this.add(ModalHistoryChartNormal);this.add(ModalHistoryChartEnergyConsume);this.add(ModalHistoryChartYearOnYearLine);this.add(ModalHistoryChartYearOnYearBar);this.add(ModalHistoryDataAnalyze);this.add(ModalChart);this.add(ModalRealtimePieEnegBrkd);this.add(ModalRealtimeLineOutdoor);this.add(ModalRealtimeBarSub);this.add(ModalRealtimeGauge);this.add(ModalRealtimeBarEnegBrkd);this.add(ModalMultiple);this.add(ModalKPIChart);this.add(ModalObserver);this.add(ModalPredictPointLine);this.add(ModalNote);this.add(ModalRank);this.add(ModalRankNormal);this.add(ModalMix);this.add(ModalHtml);this.add(ModalChartCustom);this.add(ModalPointKPI);this.add(ModalReportChapter);(typeof ModalReportFactory!="undefined")&&this.add(ModalReportFactory);this.add(ModalInteract);this.add(ModalMonitor);this.add(ModalAppChart);this.add(ModalAppGauge);this.add(ModalAppButton);this.add(ModalAppHistory);this.add(ModalHistoryDataAnalyze);this.add(ModalKPIStruct);this.add(ModalAppBlind);this.add(ModalAppDiagRanking);this.add(ModalAPPMonthHistory);this.add(ModalAppKPICollect);this.add(ModalAppPie);this.add(ModalDiagnosisPanelHtml);this.add(ModalRealtimeWeather);this.add(ModalDataMonitorList);this.add(ModalKpiOverview);this.add(ModalDiagnosisStruct);this.add(ModalCumulantChart);},initReportModule:function(){var ns=namespace('factory.report.components');this.add(ns.Summary);this.add(ns.ChapterContainer);this.add(ns.Text);this.add(ns.Html);this.add(ns.Chart);this.add(ns.Block);this.add(ns.Table);},}
return FactoryIoC;})();﻿
var beop=beop||{};beop.constant={project_img_path:'/static/images/project_img/',project_default_img:'default.jpg',BEOP_IMG_HOST:'http://images.rnbtech.com.hk',OSS_PROJECT_IMG_PATH:'/custom/project_img/'};var ObjectId=function(){var timestamp=new Date().valueOf();var userId=('000'+(AppConfig.userId||'000')).slice(-3);var hex8=('00000000'+Math.floor(Math.random()*0xFFFFFFFF).toString(16)).slice(-8);return timestamp+userId+hex8;};(function(exports){exports.namespace=function(path){var obj=window;path=path.split('.');path.forEach(function(p,i){p=p.trim();if(i===0&&p==='window')return;obj=obj[p]=obj[p]||{};});return obj;};}(window));(function(exports){exports.Mixin=function(){var prototype={};var methods;for(var i=0,len=arguments.length;i<len;i++){methods=arguments[i];for(var m in methods){prototype[m]=methods[m];}}
return prototype;};}(window));(function(){var ENUM_LEVEL={LOG:1,INFO:2,DEBUG:3,WARN:4,ERROR:5,EXCEPTION:6};window.Log={level:ENUM_LEVEL.WARN,log:function(){if(this.level>ENUM_LEVEL.LOG)return;Log._out('log',arguments);},info:function(){if(this.level>ENUM_LEVEL.INFO)return;Log._out('info',arguments);},debug:function(){if(this.level>ENUM_LEVEL.DEBUG)return;Log._out('debug',arguments);},warn:function(){if(this.level>ENUM_LEVEL.WARN)return;Log._out('warn',arguments);},error:function(){if(this.level>ENUM_LEVEL.ERROR)return;Log._out('error',arguments);},exception:function(message,exception){if(this.level>ENUM_LEVEL.EXCEPTION)return;if(exception){Log.error('Exception: ',message,exception.stack||exception);}else{Log.error('Exception: ',message);}},_out:function(type,args){console[type].apply(console,args)}};}());var FullScreenManager=(function(){var manager=Object.create({init:function(){var _this=this;$(document).off('webkitfullscreenchange');$(document).on('webkitfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('mozfullscreenchange');$(document).on('mozfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('msfullscreenchange');$(document).on('msfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});if(typeof onError==='function'){$(document).off('webkitfullscreenerror');$(document).on('webkitfullscreenerror',this.onFullScreenError);$(document).off('mozfullscreenerror');$(document).on('mozfullscreenerror',this.onFullScreenError);$(document).off('msfullscreenerror');$(document).on('msfullscreenerror',this.onFullScreenError);}},onFullScreenEnter:function(){},onFullScreenOut:function(){},onFullScreenError:function(){},toggle:function(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!document.msFullscreenElement){if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}}});manager.init();return manager;}());function StringBuilder(){this.data=Array("");}
StringBuilder.prototype.append=function(){this.data.push(arguments[0]);return this;};StringBuilder.prototype.toString=function(){return this.data.join("");};StringBuilder.prototype.getLength=function(){return this.data.length;};if(!String.prototype.format){String.prototype.format=function(){if(arguments[0]===undefined){return'';}
if(arguments[0].constructor===Array){var args=arguments[0];}else{var args=arguments;}
return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
if(!String.prototype.formatEL){String.prototype.formatEL=function(o){var str=this.toString();if(!str||!o)return'';for(var p in o){if(o.hasOwnProperty(p)){str=str.replace(new RegExp('{'+p+'}','g'),o[p]);}}
return str;};}
String.prototype.toDate=function(){var str=this;if(str.indexOf('-')>-1)
str=str.replace('-','/').replace('-','/');return new Date(str);};if(!String.prototype.startsWith){String.prototype.startsWith=function(word){return new RegExp('^'+word).test(this);}}
Number.prototype.toDate=function(){return new Date(this);};function Alert(targetElement,type,msg){this.element=targetElement;this.str=new StringBuilder();this.str.append('<div style="display:none;" class="alert beop-alert alert-').append(type).append(' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<div class="alert-msg">'+msg+'</div>').append('</div>');this.$alert=$(this.str.toString());}
Alert.danger=function(targetElement,msg){return new Alert(targetElement,Alert.type.danger,msg);};Alert.warning=function(targetElement,msg){return new Alert(targetElement,Alert.type.warning,msg);};Alert.success=function(targetElement,msg){return new Alert(targetElement,Alert.type.success,msg);};Alert.info=function(targetElement,msg){return new Alert(targetElement,Alert.type.info,msg);};Alert.closeAll=function(){$('.beop-alert').remove();};Alert.type={danger:'danger',warning:'warning',success:'success',info:'info'};Alert.prototype.show=function(duration){Alert.closeAll();if(duration){var _this=this;setTimeout(function(){_this.close();},duration);}
$(this.element).append(this.$alert);this.$alert.slideDown(500);return this;};Alert.prototype.close=function(){var _this=this;this.$alert.slideUp(500,function(){_this.$alert.remove();_this=null;});};Alert.prototype.setMessage=function(msg){if(!msg){return false}
this.$alert.find('.alert-msg').text(msg);};Alert.prototype.setStyle=function(style){if(style&&typeof style!=='string'){this.$alert.css(style);}
return this;};Alert.prototype.showAtTop=function(duration){this.setStyle({position:'absolute',top:0,left:0,right:0,margin:'auto',width:'30%',textAlign:'center',zIndex:10000});if(!duration){duration=2000;}
this.show(duration);};function showDialog(url){return WebAPI.get(url).done(function(resultHtml){$("#dialogContent").html(resultHtml);$('#dialogModal').modal({});});}
function clone(obj){if(obj==null||typeof(obj)!='object')
return obj;var temp=obj.constructor();for(var key in obj){if(obj.hasOwnProperty(key)){temp[key]=clone(obj[key]);}}
return temp;}
Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var week={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
if(/(E+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,((RegExp.$1.length>1)?(RegExp.$1.length>2?"/u661f/u671f":"/u5468"):"")+week[this.getDay()+""]);}
for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)));}}
return fmt;};Date.prototype.timeFormat=function(format,type,language,option){var date=this;if(format&&(typeof format=='string'||typeof format=='object')){if(typeof format=='object'&&(!format.separators||!format.parts)){format='yyyy-mm-dd hh:ii:ss';}}else{format='yyyy-mm-dd hh:ii:ss';}
if(arguments.length>=2){var paramArr=(function(arrayish){return[].slice.call(arrayish);})(arguments);paramArr.shift();type=language=option=null;paramArr.forEach(function(it,i){if(typeof it=='string'){language=it;}else if(typeof it=='number'){type=it;}else if(typeof it=='object'){option=it;}});}
var isReturnNull=false;if(option){for(var k in option){if(k=='isReturnNull'){isReturnNull=option[k];}}}
if(date=='Invalid Date'){console.warn("Invalid date.");if(isReturnNull){return'';}else{return date.toString();}}
var DATES={en:{"days":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"daysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],"daysMin":["Su","Mo","Tu","We","Th","Fr","Sa","Su"],"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"meridiem":["am","pm"]}};language=language?(DATES[language]?language:'en'):'en';var formatObj=(function(formatStr){if(typeof formatStr=='object'){return formatStr;}
if(type){formatStr=timeFormatChange(formatStr,type);}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};})(format);var val={yy:date.getFullYear().toString().substring(2),yyyy:date.getFullYear(),m:date.getMonth()+1,M:DATES[language].monthsShort[date.getMonth()],MM:DATES[language].months[date.getMonth()],d:date.getDate(),D:DATES[language].daysShort[date.getDay()],DD:DATES[language].days[date.getDay()],p:(DATES[language].meridiem.length==2?DATES[language].meridiem[date.getHours()<12?0:1]:''),h:date.getHours(),i:date.getMinutes(),s:date.getSeconds()};if(DATES[language].meridiem.length==2){val.H=(val.h%12==0?12:val.h%12);}
else{val.H=val.h;}
val.HH=(val.H<10?'0':'')+val.H;val.P=val.p.toUpperCase();val.hh=(val.h<10?'0':'')+val.h;val.ii=(val.i<10?'0':'')+val.i;val.ss=(val.s<10?'0':'')+val.s;val.dd=(val.d<10?'0':'')+val.d;val.mm=(val.m<10?'0':'')+val.m;var finTime='';for(var i=0,len=formatObj.separators.length;i<len;i++){finTime+=formatObj.separators[i]+(formatObj.parts[i]?val[formatObj.parts[i]]:'');}
return finTime;};var DateUtil=(function(){var dateLocale={month:{en:{month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],month_names_short:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']},zh:{month_names:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],month_names_short:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']}}};function getWeekNumber(d){d=new Date(+d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7);return[d.getFullYear(),weekNo];}
function getLastWeekNumberOf(y,w){w-=1;if(w===0){y=y-1;w=52;}
return[y,w];}
function getNextWeekNumberOf(y,w){w+=1;if(w===53){y+=1;w=1;}
return[y,w];}
function isLeapYear(y){if(Object.prototype.toString.call(y)==='[object Date]'){y=y.getFullYear();}
return((y%4===0)&&(y%100!==0))||(y%400===0);}
function daysInMonth(dt){var m=dt.getMonth();if(m===1){return isLeapYear(dt)?29:28;}
return[31,28,31,30,31,30,31,31,30,31,30,31][m];}
function getFirstDayOfWeek(year,week){var d=new Date(year,0,1),offset=d.getTimezoneOffset();d.setDate(d.getDate()+4-(d.getDay()||7));d.setTime(d.getTime()+7*24*60*60*1000*(week+(year==d.getFullYear()?-1:0)));d.setTime(d.getTime()
+(d.getTimezoneOffset()-offset)*60*1000);d.setDate(d.getDate()-3);return d;}
function getDateRangeOnWeekNumber(year,week){if(!year||!week){return;}
var firstDay=getFirstDayOfWeek(year,week),lastDay=new Date(firstDay);lastDay.setDate(firstDay.getDate()+6);return[firstDay,lastDay];}
function getMonthName(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names:dateLocale.month['en'].month_names;return monthList[index];}
function getMonthNameShort(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names_short:dateLocale.month['en'].month_names_short;return monthList[index];}
function getLastMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===1){return 12;}else{return currentMonth-1;}}
function getNextMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===12){return 1;}else{return currentMonth+1;}}
function getRelativeDateInfo(date1,date2){var now=new Date();var lang=I18n.type;var value1,value2,ts,info;if(!date1&&!date2)return'';value1=(date1||now).valueOf();value2=(date2||now).valueOf();ts=Math.floor(Math.abs(value1-value2)/1000);switch(true){case ts<60:info=ts+(ts===1?' second':' seconds');break;case ts<3600:ts=Math.floor(ts/60);info=ts+(ts===1?' minute':' minutes');break;case ts<86400:ts=Math.floor(ts/(3600));info=ts+(ts===1?' hour':' hours');break;case ts<31536000:ts=Math.floor(ts/(86400));info=ts+(ts===1?' day':' days');break;default:ts=Math.floor(ts/(31536000));info=ts+(ts===1?' year':' years');break;}
info+=value1>value2?' ago':' later';if(lang==='zh'){info=info.replace(/\s(seconds?|minutes?|hours?|days?|years?)\s(ago|later)$/,function($0,$1,$2){var rs='';if($1.indexOf('second')>-1)rs+='秒';if($1.indexOf('minute')>-1)rs+='分钟';if($1.indexOf('hour')>-1)rs+='小时';if($1.indexOf('day')>-1)rs+='天';if($1.indexOf('year')>-1)rs+='年';if($2==='ago')rs+='前';if($2==='later')rs+='后';return rs;});}
return info;}
return{getWeekNumber:getWeekNumber,isLeapYear:isLeapYear,daysInMonth:daysInMonth,getLastWeekNumberOf:getLastWeekNumberOf,getNextWeekNumberOf:getNextWeekNumberOf,getDateRangeOnWeekNumber:getDateRangeOnWeekNumber,getFirstDayOfWeek:getFirstDayOfWeek,getMonthName:getMonthName,getMonthNameShort:getMonthNameShort,getLastMonth:getLastMonth,getNextMonth:getNextMonth,getRelativeDateInfo:getRelativeDateInfo,DATA_FORMAT:{FULL_DATETIME:'yyyy-MM-dd HH:mm:ss',FULL_DATE:'yyyy-MM-dd',TIME:'HH:mm:ss'}}})();var StringUtil=(function(){var HTML_ENTITIES={'&':'&amp;','>':'&gt;','<':'&lt;','"':'&quot;',"'":'&#39;','`':'&#x60;'},HTML_ENTITIES_INVERT=invert(HTML_ENTITIES);function invert(obj){var result={},keys=Object.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i];}
return result;}
function padLeft(oldStr,padNum,padStr){if(!padStr){return oldStr;}
return new Array(padNum-String(oldStr).length+1).join(padStr)+oldStr;}
function htmlEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES[character];});}
function htmlUnEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES_INVERT).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES_INVERT[character];});}
var getI18nProjectName=function(project){if(!I18n||!project){return'';}
var result='';switch(I18n.type){case'en':{result=project.name_english;break;}
case'zh':{result=project.name_cn;break;}
default:{result=project.name_english;}}
return result||'';};return{padLeft:padLeft,htmlEscape:htmlEscape,htmlUnEscape:htmlUnEscape,getI18nProjectName:getI18nProjectName}})();var BEOPUtil=(function(){var jsType={function:typeof $.noop,number:typeof 0,string:typeof'',undefined:typeof undefined};var projectImgPath=beop.constant.project_img_path;var setRelativePosition=function($obj,$target,topOffset,leftOffset){$target.css({"left":$obj.offset().left+$obj.width()+(leftOffset||5),"top":$obj.offset().top+(topOffset||10)});};var projectDefaultImgPath=projectImgPath+beop.constant.project_default_img;var getProjectImgPath=function(project){if(project){return project.pic?projectImgPath+project.pic:projectDefaultImgPath;}};var getProjectFromAppConfig=function(projectId){for(var m=0,len=AppConfig.projectList.length;m<len;m++){if(AppConfig.projectList[m].id==projectId){return AppConfig.projectList[m];}}};function getFunctionName(func){if(!func||typeof func!=jsType.function){return'';}
var ret=func.toString();ret=ret.substr('function '.length);ret=ret.substr(0,ret.indexOf('('));return ret;}
function isUndefined(obj){return typeof obj===jsType.undefined;}
function getCookie(name){var value="; "+document.cookie;var parts=value.split("; "+name+"=");if(parts.length==2)return parts.pop().split(";").shift();}
function logicContentHandle(content){if(content){content=content.replace(/\t/g,'    ')}
return content;}
function copyToClipboard(text){if(window.clipboardData&&window.clipboardData.setData){return clipboardData.setData("Text",text);}else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var textarea=document.createElement("textarea");textarea.textContent=text;textarea.style.position="fixed";document.body.appendChild(textarea);textarea.select();try{return document.execCommand("copy");}catch(ex){console.warn("Copy to clipboard failed.",ex);return false;}finally{document.body.removeChild(textarea);}}}
var projectImgType={logo:'logo.png',pdfCover:'pdf_cover.jpg'};function getProjectImgByType(projectId,name,extension){var img='';if(projectId){img+=projectId+'_';}
img+=name;if(extension){img+='.'+extension;}
return beop.constant.BEOP_IMG_HOST+beop.constant.OSS_PROJECT_IMG_PATH+img;}
return{setRelativePosition:setRelativePosition,getProjectImgPath:getProjectImgPath,getFunctionName:getFunctionName,isUndefined:isUndefined,getCookie:getCookie,getProjectFromAppConfig:getProjectFromAppConfig,logicContentHandle:logicContentHandle,copyToClipboard:copyToClipboard,getProjectImgByType:getProjectImgByType,projectImgType:projectImgType}})();(function(){var beop_tmpl_cache={};this.beopTmpl=function tmpl(str,data,frameStr){var fn=!/\W/.test(str)?beop_tmpl_cache[str]=beop_tmpl_cache[str]||tmpl(frameStr?frameStr:document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split(/<!/).join("\t").replace(/((^|!>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)!>/g,"',$1,'").split("\t").join("');").split(/!>/).join("p.push('").split("\r").join("\\'")
+"');}return p.join('');");return data?fn(data):fn;};})();var SidebarMenuEffect=(function(){function SidebarMenuEffect(){}
SidebarMenuEffect.prototype.init=function(center,left,right){var _this=this;this.$paneCt=$(center);this.$leftBtn=$(center).find('#leftCt');this.$rightBtn=$(center).find('#rightCt');var container=document.getElementById('st-container'),buttons=Array.prototype.slice.call(document.querySelectorAll('.sideTrans')),refresh=function(){var leftCol=0,rightCol=0,centerCol=0;var leftArrow='<span class="glyphicon glyphicon-chevron-left"></span>';var rightArrow='<span class="glyphicon glyphicon-chevron-right"></span>';if(_this.$leftBtn.length>0){if(container.className.indexOf('st-effect-7')>0){var prev=_this.$paneCt.prev('div')[0];if(prev&&prev.className.indexOf('col-')>-1){leftCol=parseInt(prev.classList[0].split('-')[2]);}else{leftCol=0;}
_this.$leftBtn.removeClass('leftCtClose').addClass('leftCtOpen').html(leftArrow);}else{leftCol=0;_this.$leftBtn.removeClass('leftCtOpen').addClass('leftCtClose').html(rightArrow);}}
if(_this.$rightBtn.length>0){if(container.className.indexOf('st-effect-1')>0){var next=_this.$paneCt.next('div')[0];if(next&&next.className.indexOf('col-')>-1){rightCol=parseInt(next.classList[0].split('-')[2]);}else{rightCol=0;}
_this.$rightBtn.removeClass('rightCtClose').addClass('rightCtOpen').html(rightArrow);}else{rightCol=0;_this.$rightBtn.removeClass('rightCtOpen').addClass('rightCtClose').html(leftArrow);}}
centerCol=12-leftCol-rightCol;_this.$paneCt.removeClass().addClass('col-sm-'+centerCol+' st-content');};buttons.forEach(function(el,i){var effect=el.getAttribute('data-effect');el.addEventListener('click',function(ev){var target=ev.target.getAttribute('data-effect')!=null?ev.target.getAttribute('data-effect'):ev.target.parentNode.getAttribute('data-effect');var stCtClass=document.getElementById('st-container').className;if(stCtClass.indexOf(target)<0){ev.stopPropagation();ev.preventDefault();container.classList.add(effect);setTimeout(function(){if($(container.children[0]).children('div').length==3){container.classList.add('st-menu-open');}
refresh();},250);}else{container.classList.remove(target);refresh();}});});};return SidebarMenuEffect;})();(function(window){{var unknown='-';var screenSize='';if(screen.width){var width=(screen.width)?screen.width:'';var height=(screen.height)?screen.height:'';screenSize+=''+width+" x "+height;}
var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var browser=navigator.appName;var version=''+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if((verOffset=nAgt.indexOf('Opera'))!=-1){browser='Opera';version=nAgt.substring(verOffset+6);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('MSIE'))!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(verOffset+5);}
else if((verOffset=nAgt.indexOf('Chrome'))!=-1){browser='Chrome';version=nAgt.substring(verOffset+7);}
else if((verOffset=nAgt.indexOf('Safari'))!=-1){browser='Safari';version=nAgt.substring(verOffset+7);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('Firefox'))!=-1){browser='Firefox';version=nAgt.substring(verOffset+8);}
else if(nAgt.indexOf('Trident/')!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(nAgt.indexOf('rv:')+3);}
else if((nameOffset=nAgt.lastIndexOf(' ')+1)<(verOffset=nAgt.lastIndexOf('/'))){browser=nAgt.substring(nameOffset,verOffset);version=nAgt.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName;}}
if((ix=version.indexOf(';'))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(' '))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(')'))!=-1)version=version.substring(0,ix);majorVersion=parseInt(''+version,10);if(isNaN(majorVersion)){version=''+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10);}
var mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);var cookieEnabled=(navigator.cookieEnabled)?true:false;if(typeof navigator.cookieEnabled=='undefined'&&!cookieEnabled){document.cookie='testcookie';cookieEnabled=(document.cookie.indexOf('testcookie')!=-1)?true:false;}
var os=unknown;var clientStrings=[{s:'Windows 3.11',r:/Win16/},{s:'Windows 95',r:/(Windows 95|Win95|Windows_95)/},{s:'Windows ME',r:/(Win 9x 4.90|Windows ME)/},{s:'Windows 98',r:/(Windows 98|Win98)/},{s:'Windows CE',r:/Windows CE/},{s:'Windows 2000',r:/(Windows NT 5.0|Windows 2000)/},{s:'Windows XP',r:/(Windows NT 5.1|Windows XP)/},{s:'Windows Server 2003',r:/Windows NT 5.2/},{s:'Windows Vista',r:/Windows NT 6.0/},{s:'Windows 7',r:/(Windows 7|Windows NT 6.1)/},{s:'Windows 8.1',r:/(Windows 8.1|Windows NT 6.3)/},{s:'Windows 8',r:/(Windows 8|Windows NT 6.2)/},{s:'Windows NT 4.0',r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:'Windows ME',r:/Windows ME/},{s:'Android',r:/Android/},{s:'Open BSD',r:/OpenBSD/},{s:'Sun OS',r:/SunOS/},{s:'Linux',r:/(Linux|X11)/},{s:'iOS',r:/(iPhone|iPad|iPod)/},{s:'Mac OS X',r:/Mac OS X/},{s:'Mac OS',r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:'QNX',r:/QNX/},{s:'UNIX',r:/UNIX/},{s:'BeOS',r:/BeOS/},{s:'OS/2',r:/OS\/2/},{s:'Search Bot',r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var id in clientStrings){var cs=clientStrings[id];if(cs.r.test(nAgt)){os=cs.s;break;}}
var osVersion=unknown;if(/Windows/.test(os)){osVersion=/Windows (.*)/.exec(os)[1];os='Windows';}
switch(os){case'Mac OS X':osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];break;case'Android':osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1];break;case'iOS':osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);osVersion=osVersion[1]+'.'+osVersion[2]+'.'+(osVersion[3]|0);break;}}
window.jscd={screen:screenSize,browser:browser,browserVersion:version,mobile:mobile,os:os,osVersion:osVersion,cookies:cookieEnabled};}(this));var getUrlParams=function(){var search=window.location.search.substring(1);var kvArr=search.split('&');var rs={};kvArr.forEach(function(kv){var arr=kv.split('=');if(typeof arr[1]!=='undefined'){rs[arr[0]]=arr[1];}});return rs;};$.fn.serializeObject=function(){var obj={};this.serializeArray().map(function(item){if(/\[\]$/.test(item.name)){if(obj[item.name]){obj[item.name].push(item.value);}else{obj[item.name]=[item.value];}}else{obj[item.name]=item.value;}});return obj;};function kIntSeparate(num,n){var number=num.toFixed(n?n:0);var source=String(number).split(".");source[0]=source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)','ig'),"$1,");return source.join(".");}
function timeFormatChange(format,type){var lastStr='';var formatObj=(function(formatStr){if(!formatStr||typeof formatStr=='object'){return;}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){return;}
return{separators:separators,parts:parts};})(format);if(formatObj){format='';for(var i=0,len=formatObj.separators.length-1;i<len;i++){format+=formatObj.separators[i]+formatObj.parts[i];}
lastStr=formatObj.separators[len];}
var formatArr=['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'];var formatChangeArr=[['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'],['M d, yyyy hh:ii:ss','M d, yyyy hh:ii','M d, yyyy hh','M d, yyyy','M, yyyy','M d hh:ii:ss','M d hh:ii','M d hh','M d'],['dd/mm/yyyy hh:ii:ss','dd/mm/yyyy hh:ii','dd/mm/yyyy hh','dd/mm/yyyy','mm/yyyy','dd/mm hh:ii:ss','dd/mm hh:ii','dd/mm hh','dd/mm']];var index=formatArr.findIndex(function(v){return v===format;});type=Number(type);type&&(type>=formatChangeArr.length)&&(type=formatChangeArr.length-1);if(index==-1){console.log('format is not defined');return format+lastStr;}else{return formatChangeArr[type||AppConfig.projectTimeFormat||0][index]+lastStr;}}
function timeFormat(time,format,language,option){var date,arr,arr2;if(time instanceof Date){date=time;}else if(/^\d{1,2}\/\d{4}$/.test(time)){arr=time.split('/');date=new Date(arr[0]+'/01/'+arr[1]);}else if(/^\d{1,2}\/\d{1,2}$/.test(time)){arr=time.split('/');date=new Date(arr[1]+'/'+arr[0]);}else if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(time)){arr=time.split('/');date=new Date(arr[1]+'/'+arr[0]+'/'+arr[2]);}else if(/^\d{1,2}\/\d{1,2} /.test(time)){arr=time.split(' ');arr2=arr[0].split('/');date=new Date(arr2[1]+'/'+arr2[0]+' '+arr[1]);}else if(/^\d{1,2}\/\d{1,2}\/\d{4} /.test(time)){arr=time.split(' ');arr2=arr[0].split('/');date=new Date(arr2[1]+'/'+arr2[0]+'/'+arr2[2]+' '+arr[1]);}else{date=new Date(time);}
return date.timeFormat(format,language,option);}
(function(exports){var MINITE_1=60000;var MINITE_5=300000;var HOUR_1=3600000;var DAY_1=86400000;var DAY_365=31536000000;function _formatTimeStr(str,format){var arr=str.split(' ');var date=arr[0].split('-');var time=arr[1].split(':');return format.replace('yyyy',date[0]).replace('MM',date[1]).replace('dd',date[2]).replace('HH',time[0]).replace('mm',time[1]).replace('ss',time[2]);}
function _explainPattern(timeShaft){var startTime=new Date(timeShaft[0]);var endTime=new Date(timeShaft[timeShaft.length-1]);var timeRange=endTime.valueOf()-startTime.valueOf();var timeInterval=timeRange/(timeShaft.length-1);var pattern='MM-dd HH:mm';if(timeInterval<=MINITE_5){if(timeRange<=HOUR_1){pattern='HH:mm';}else if(timeRange<=DAY_1){pattern='HH:mm';}}
else if(timeInterval<=HOUR_1){if(timeRange<=DAY_1){pattern='HH:mm';}else{pattern='MM-dd HH:mm';}}
else if(timeInterval<=DAY_1){if(timeRange<=DAY_365){pattern='MM-dd';}else{pattern='yyyy-MM-dd';}}
else{pattern='yyyy-MM';}
return pattern;}
function _explain(timeShaft){pattern=getPattern(timeShaft);if(pattern){timeShaft=timeShaft.map(function(row){return _formatTimeStr(row,pattern);});}
return timeShaft;}
function _valid(params){var flag=Object.prototype.toString.call(params)==='[object Array]';return flag&&/^[\d-]{10} [\d:]{8}$/.test(params[0]);}
var _getTimePattern=function(timeShaft){if(!_valid(timeShaft)){return;}
if(timeShaft.length<=1){return;}
return _explainPattern(timeShaft);};var formatTimeShaft=exports.formatTimeShaft=function(timeShaft){if(!_valid(timeShaft)){console.warn('function arguments is not a valid time shaft array!');return timeShaft;}
if(timeShaft.length<=1){return timeShaft;}
return _explain(timeShaft);};function _formatTimeStrByAppConfig(data){var formatArr,formatStr,regularArr,language,formatObj;switch(AppConfig.projectTimeFormat||0){case 0:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';break;case 1:formatArr=['M d, yyyy','M d hh:ii','M, yyyy','M, yyyy','M d'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;case 2:formatArr=['dd/mm/yyyy','dd/mm hh:ii','mm/yyyy','mm/yyyy','dd/mm'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;default:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';}
for(var i=0,len=regularArr.length;i<len;i++){if(regularArr[i].test(data)){formatStr=formatArr[i];break;}}
if(formatStr){formatObj=(function _parseFormat(formatStr){var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};})(formatStr);return{formatStr:formatStr,language:language,formatObj:formatObj};}else{return;}}
if(window.echarts){echarts.registerPreprocessor(function(option){var pattern;var formatInfo,firstValue;if(option.xAxis&&option.xAxis.length){option.xAxis.forEach(function(row){if(row.data&&row.data.length){pattern=_getTimePattern(row.data);formatInfo=_formatTimeStrByAppConfig(row.data[0]);if(pattern){row.data=row.data.map(function(row){return row.substr(0,16);});firstValue=_formatTimeStr(row.data[0],pattern);formatInfo=_formatTimeStrByAppConfig(firstValue);if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}else{row.data=row.data.map(function(it,i){return _formatTimeStr(it,pattern);});}}else if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}}});}});}}(window));﻿var WebAPI=(function(){var siteId;switch(window.location.hostname){case'beop.rnbtech.com.hk':siteId='b79c068f77198848e22fe79758836e53';break;case'beop6.rnbtech.com.hk':siteId='f1f6b2b9e6b64592c0b4cb5e9b8bd79e';break;case'beopdemo.rnbtech.com.hk':siteId='ac0df98f274d9a5980a571297248d80b';break;default:break;}
(function(){if(siteId){var hm=document.createElement("script");hm.src="//hm.baidu.com/hm.js?"+siteId;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);}})();var mockList={'/static/mock/analysis_workspace_saveLayout.json':/\/analysis\/workspace\/saveLayout\/\d+\/[01]/i,'/static/mock/analysis_template_get.json':/\/analysis\/template\/get\/\d+/i};function mock(url){var match=null;for(var i in mockList){match=url.match(mockList[i]);if(match!==null)return i;}
return url;}
function requestFailHandle(result){if(result&&result.status==401){alert(i18n_resource.error.noPermission);}}
function WebAPI(){}
WebAPI.isMock=false;$.ajaxSetup({converters:{"text json":true},dataFilter:function(result,type){var data=result;if(type==='script'){return data;}else if(typeof data==='string'){if(/^\s*</.test(data)){return data;}
try{data=JSON.parse(result);}catch(e){console.log('request error: '+e+', the data is :'+data);return data;}}
if(data){if(data.error){switch(data.error){case'token_invalid':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');if(typeof LoginValidate!='undefined'){var validate=new LoginValidate();validate.show();return;}
confirm(i18n_resource.error.token[data.msg]+'. '+i18n_resource.error.relogin+'.',function(){if(AppConfig.isMobile){location.reload();}else{location.href='/';}});}
case'historyData':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');alert(data.msg);return{};}
default:break;}}
if(data.code==403){console.log(this.url+' ('+data.msg+'")');alert(I18n.resource.error.noPermission);return{};}}
return data;}});WebAPI.post=function(url,data,isMock){var mockUrl;isMock=isMock===undefined?WebAPI.isMock:isMock;if(isMock){mockUrl=mock(url);if(url!==mockUrl)return this.get(mockUrl,false);}
if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1)}}
return $.ajax({url:url,type:'POST',data:JSON.stringify(data),contentType:'application/json'}).fail(requestFailHandle);};WebAPI.get=function(url,isMock){isMock=isMock===undefined?WebAPI.isMock:isMock;url=isMock?mock(url):url;if(window._hmt&&url.indexOf('.html')>0)window._hmt.push(['_trackPageview',url]);if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1)}}
return $.ajax({url:url,type:'Get',contentType:'application/json'}).fail(requestFailHandle);};WebAPI.getHistoryDS=function(callback){};WebAPI.getHistory=function(callback){};WebAPI.ajaxForDebugTool=function(ajaxObj,host,dtuName,endpoint){var defaultUrl='http://'+host+'/'+endpoint+'/'+dtuName,defaultAjaxObj={url:defaultUrl,crossDomain:true,dataType:'json'},dfd,timer=10,intervalFlags,url,requestFlag='requestFlag='+new Date().getTime()+Math.ceil(Math.random()*100);$.extend(defaultAjaxObj,ajaxObj);url=defaultAjaxObj.url;if(url.indexOf('?')<0){requestFlag='?'+requestFlag}else{requestFlag='&'+requestFlag}
var userId=BEOPUtil.getCookie('userId');defaultAjaxObj.url+=requestFlag+'&userId='+userId;return $.ajax(defaultAjaxObj).then(function(result){dfd=$.Deferred();if(result.success){intervalFlags=setInterval(function(){if(timer<0){clearInterval(intervalFlags);return dfd.reject({success:false,msg:'no response from server'});}
$.ajax({type:'GET',url:'http://'+host+'/getCMDResponse/'+dtuName+requestFlag,crossDomain:true,dataType:'json'}).done(function(result){if(result.success){clearInterval(intervalFlags);return dfd.resolve(result);}}).always(function(){timer--;})},2000);}else{return dfd.reject(result);}
return dfd;});};return WebAPI;})();var EventAdapter=(function(){var eventData,eventStatus;function EventAdapter($){}
EventAdapter.on=function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<3||arguments.length>5){console.log('EventAdapter.on arguments.length error');return;}
if(typeof arguments[0]!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}}
if(typeof arguments[1]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[1];}
if(typeof arguments[2]=='function'){eventFunction=arguments[2];eventSelector=null;eventHmt=arguments[3]}else if(typeof arguments[2]=='string'){if(arguments[3]&&typeof arguments[3]=='function'){eventSelector=arguments[2];eventFunction=arguments[3];eventHmt=arguments[4]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':eventTarget.on('touchstart',eventSelector,function(e){mobileDragStart.call(this,e,eventTarget,finalFunction)});break;case'dragover':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragOver.call(this,e,eventTarget,finalFunction)});break;case'dragleave':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragLeave.call(this,e,eventTarget,finalFunction)});break;case'drop':$(document).on('touchend.drop',eventSelector,function(e){mobileDrop.call(this,e,eventTarget,finalFunction)});break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;};EventAdapter.off=function(){if((arguments.length>3||arguments.length<1)||(arguments[0]&&typeof arguments[1]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}
if(arguments.length==1){eventTarget.off();return eventTarget;}
if(typeof arguments[1]=='string'){eventType=arguments[1]}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[2]=='string'){eventSelector=arguments[2];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;};$.fn.extend({'eventOn':function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<2||arguments.length>4){console.log('EventAdapter.on arguments.length error');return;}
if(typeof this!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(this instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=this;}}
if(typeof arguments[0]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[0];}
if(typeof arguments[1]=='function'){eventFunction=arguments[1];eventSelector=null;eventHmt=arguments[2]}else if(typeof arguments[1]=='string'){if(arguments[2]&&typeof arguments[2]=='function'){eventSelector=arguments[1];eventFunction=arguments[2];eventHmt=arguments[3]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':mobileDragStart(eventTarget,eventSelector,finalFunction);break;case'dragover':mobileDragOver(eventTarget,eventSelector,finalFunction);break;case'dragleave':mobileDragLeave(eventTarget,eventSelector,finalFunction);break;case'drop':mobileDrop(eventTarget,eventSelector,finalFunction);break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;},'eventOff':function(){if((arguments.length>2)||(arguments[0]&&typeof arguments[0]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(this instanceof jQuery)){eventTarget=jQuery(this);}else{eventTarget=this;}
if(arguments.length==0){eventTarget.off();return eventTarget;}
if(typeof arguments[0]=='string'){eventType=arguments[0];}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[1]=='string'){eventSelector=arguments[1];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector,mobileDragStart);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;}});EventAdapter.setData=function(date){if(date==undefined)return;eventData=date;};EventAdapter.getData=function(){return eventData;};document.addEventListener('drop',function(){eventData=null;},false);document.addEventListener('touchend',function(){eventData=null;},false);EventAdapter.clearEvent=function(){$(document).off('touchmove.copy');$(document).off('touchmove.drag');$(document).off('touchend.drop');};EventAdapter.analyse=function(e,eventType,hmtInfo){var mainInfo='',initArrTag,finalArrTag,tag,unitTag;var target=$(e.currentTarget);if(hmtInfo instanceof Array&&hmtInfo[0]){mainInfo=judgeWay(hmtInfo[0]);initArrTag=hmtInfo.filter(function(ele,index){return index>0&&ele!='';});finalArrTag=[];for(var i=0;i<initArrTag.length;i++){unitTag=judgeWay(initArrTag[i]);if(unitTag=='')continue;finalArrTag.push(unitTag)}
tag=finalArrTag.join('-');}else{if(typeof hmtInfo=='string'){mainInfo=hmtInfo;}else{mainInfo=getInfo(target);}
mainInfo=mainInfo?mainInfo:'';tag=mainInfo;}
_hmt.push(['_trackEvent',mainInfo.substr(0,30),eventType,tag.substr(0,100)]);function getInfo(tar){if(tar.length==0)return;var tarInfo;if(tar.attr('id')){tarInfo=tar.attr('id');}else if(tar.attr('i18n')){tarInfo=tar.attr('i18n');}else if(tar.attr('title')){tarInfo=tar.attr('title');}else{tarInfo=tar[0].innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30);}
return tarInfo;}
function judgeWay(arg){if(typeof arg=='undefined'){return'';}
if(arg instanceof Function){return arg.call(this,e)}else if(typeof arg=='string'){if(arg=='text'){return e.currentTarget.innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30)}else{return $(e.currentTarget).attr(arg)?$(e.currentTarget).attr(arg):arg;}}else if(typeof arg=='number'){return arg;}}};var mobileDragStart=function(e,target,eventFunction){var originalTarget=$(e.target).closest('[draggable="true"]')[0];var ev=e.type=='touchstart'?e.originalEvent.touches[0]:e,startPos={left:$(originalTarget).css('left'),top:$(originalTarget).css('top'),zIndex:$(originalTarget).css('z-index')},disX=originalTarget.offsetWidth/2,disY=originalTarget.offsetHeight/2;var $copyTarget=$(originalTarget).clone();$copyTarget.data('startPos',startPos);$copyTarget.css('z-index',10000);$copyTarget.css('position','absolute');$copyTarget.css('opacity','0.5');$copyTarget.css('pointer-events','none');var $container=$('body');$container.append($copyTarget);var sPos=$(originalTarget)[0].getBoundingClientRect();$copyTarget.css('left',sPos.left-$container[0].offsetLeft+'px');$copyTarget.css('top',sPos.top-$container[0].offsetTop+'px');$copyTarget[0].cssText=originalTarget.cssText;$copyTarget.css('width',originalTarget.offsetWidth);$copyTarget.css('height',originalTarget.offsetHeight);eventStatus='dragStart';eventFunction.call(this,ev);$(document).off('touchend.copy').on('touchend.copy',function(e){$copyTarget.remove();eventStatus='dragEnd';});$(document).on('touchmove.copy',function(e){eventStatus='dragMove';var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var $parent=$copyTarget.offsetParent();$parent=$parent.is(':root')?$(window):$parent;var targetLeft=ev.pageX-disX;var targetTop=ev.pageY-disY;$copyTarget.css({left:targetLeft+'px',top:targetTop+'px','z-index':10000});})};var mobileDragOver=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn'&&eventStatus!='dragMoveOut')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveIn';eventFunction.call(this,e);break;}}};var mobileDragLeave=function(e,target,eventFunction){if(eventStatus!='dragMoveIn')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(!((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY))){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveOut';eventFunction.call(this,e);}}};var mobileDragEnd=function(e,target,eventFunction){eventFunction.call(this,e);};var mobileDrop=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn')return;var ev=e.type=='touchend'?e.originalEvent.changedTouches[0]:e;var eventTarget=target;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventFunction.call(this,e);break;}}};return EventAdapter;})(jQuery);(function(){'use strict';var indexedDB=indexedDB||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(!indexedDB){return;}
function _initStorage(options){var _this=this;this._dbInfo=$.extend({db:null},options);var promise=$.Deferred();(function(){var _this=this;var dbInfo=this._dbInfo;var openreq=indexedDB.open(dbInfo.name,dbInfo.version);openreq.onerror=function(){promise.reject(openreq.error);};openreq.onsuccess=function(){dbInfo.db=openreq.result;promise.resolve();};openreq.onupgradeneeded=function(){var names=openreq.result.objectStoreNames;var length,key;var indexOf=([]).indexOf;if(indexOf.call(names,'cache')>-1){openreq.result.deleteObjectStore('cache');}
if(indexOf.call(names,'datasource')>-1){openreq.result.deleteObjectStore('datasource');}
if(indexOf.call(names,'thumbnail')>-1){openreq.result.deleteObjectStore('thumbnail');}
if(indexOf.call(names,'buffer')===-1){openreq.result.createObjectStore('buffer');}
openreq.result.createObjectStore('datasource');openreq.result.createObjectStore('thumbnail');for(var i=0,len=localStorage.length;i<len;i++){key=localStorage.key(i);if(key.indexOf('workSpacePicStorageEnable')===0){localStorage.removeItem(key);}}};}).call(this);}
function length(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.count();req.onsuccess=function(){promise.resolve(req.result);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.get(key);req.onsuccess=function(){var value=req.result;value=value===undefined?null:value;promise.resolve(value);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var result={};var promise=this.iterate(function(key,value,i){if(keyList.indexOf(key)>-1){result[key]=value;}}).then(function(){return result;},function(){console.warn('getItemList error!');});excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.put(value,key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();try{(function(){var _this=this;var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var result={};kvList.forEach(function(kv,i){var key=kv.key,value=kv.value;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
store.put(value,key);});transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=transaction.error;promise.reject(err);};}).call(this);}catch(e){console.warn('setItemList error!');promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.delete(key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;var request;if(!cursor){promise.resolve();return;}
if(keyList.indexOf(cursor.key)>-1){cursor.delete();}
cursor.continue();};req.onerror=function(err){promise.reject(err);};}).call(this);}catch(e){promise.reject();}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.clear();transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var advanced=false;req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(null);return;}
if(n===0){promise.resolve(cursor.key);}else{if(!advanced){advanced=true;cursor.advance(n);}else{promise.resolve(cursor.key);}}};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var keys=[];var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(keys);return;}
keys.push(cursor.key);cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var index=0;req.onsuccess=function(){var cursor=req.result;var result;if(!cursor){promise.resolve();return;}
result=iterator(cursor.key,cursor.value,index++);if(result===false){promise.resolve();return;}
cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var indexDBWrapper={_driver:'indexedDBWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.indexedDB=indexDBWrapper;}).call(this);(function($){'use strict';var localStorage;try{if(!this.localStorage||!('setItem'in this.localStorage)){return;}
localStorage=this.localStorage;}catch(e){return;}
function _initStorage(options){this._dbInfo=$.extend({},options);this._dbInfo.keyPrefix=this._dbInfo.name+'/';}
function length(callback){var _this=this;var promise=this.keys().then(function(keys){return keys.length;});excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var result;result=localStorage.getItem(this._dbInfo.keyPrefix+key);try{result=JSON.parse(result);}catch(e){}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var _this=this;var promise=$.Deferred();(function(){var result={};keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
result[key]=localStorage.getItem(_this._dbInfo.keyPrefix+key);try{result[key]=JSON.parse(result[key]);}catch(e){}});promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var _this=this;var result;try{try{value=JSON.stringify(value);}catch(e){}
result=localStorage.setItem(_this._dbInfo.keyPrefix+key,value);promise.resolve(result);}catch(e){result=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}
promise.reject(e);}}).call(this);excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();(function(){var _this=this;var result={};kvList.forEach(function(kv,i){var value;if(typeof kv.key!=='string'){console.warn('The key is not a string!');kv.key=String(kv.key);}
try{try{value=JSON.stringify(kv.value);}catch(e){value=kv.value;}
result[kv.key]=localStorage.setItem(_this._dbInfo.keyPrefix+kv.key,value);}catch(e){console.warn('occur error when set data into storage [key: "'+kv.key+'", value: "'+kv.value+'"]');result[kv.key]=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}}});promise.resolve();}).call(this);excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){localStorage.removeItem(this._dbInfo.keyPrefix+key);promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var _this=this;keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
localStorage.removeItem(_this._dbInfo.keyPrefix+key);});promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){localStorage.removeItem(key);}}
promise.resolve();}).call(this);}catch(e){proimse.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();(function(){var result;result=localStorage.key(n);if(result){result=result.substring(_this._dbInfo.keyPrefix.length);}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();(function(){var keyPrefix=this._dbInfo.keyPrefix;var length=localStorage.length;var keys=[],key;for(var i=0;i<length;i++){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){keys.push(key.substring(keyPrefix.length));}}
promise.resolve(keys);}).call(this);excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key,value;var result;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){value=localStorage.getItem(key);try{value=JSON.parse(value);}catch(e){}
result=iterator(key.substring(keyPrefix.length),value,i);}
if(result===false){break;}}
promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var localStorageWrapper={_driver:'localStorageWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.localStorage=localStorageWrapper;}).call(this,jQuery);(function($){function BaseCache(options){this.options=$.extend({},DEFAULTS,options);this.storage=Object.create(Beop.cache.drivers[this.options.driver]);this.init();}
BaseCache.prototype.init=function(){this.storage._initStorage(this.options);};BaseCache.prototype.length=function(){return this.storage.length();};BaseCache.prototype.key=function(n,callback){return this.storage.key(n,callback);};BaseCache.prototype.keys=function(callback){return this.storage.keys(callback);};BaseCache.prototype.getItem=function(key,callback){return this.storage.getItem(key,callback);};BaseCache.prototype.getItemList=function(keyList,callback){return this.storage.getItemList(keyList,callback);};BaseCache.prototype.setItem=function(key,value,callback){return this.storage.setItem(key,value,callback);};BaseCache.prototype.setItemList=function(kvList,callback){return this.storage.setItemList(kvList,callback);};BaseCache.prototype.removeItem=function(key,callback){return this.storage.removeItem(key,callback);};BaseCache.prototype.removeItemList=function(keyList,callback){return this.storage.removeItemList(keyList,callback);};BaseCache.prototype.clear=function(callback){return this.storage.clear(callback);};BaseCache.prototype.iterate=function(iterator,callback){return this.storage.iterate(iterator,callback);};var DEFAULTS={dbType:'localStorage',name:'beopcache',version:3};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.BaseCache=BaseCache;}).call(this,jQuery);(function($,undefined){var TIME_STAMP={m1:60000,m5:300000,h1:3600000,d1:86400000};var TIMEZONE_OFFSET=new Date().getTimezoneOffset()*60000;var DB_INFO={driver:'indexedDB',storeName:'datasource'};function DSCache(){this.db=new Beop.cache.BaseCache(DB_INFO);this.keyTpl='anal_{id}_{fmt}_{start}_{end}';this.useCache=false;};DSCache.prototype.get=function(id,tmFmt,tmStart,tmEnd){var promise=$.Deferred();if(!this.useCache){promise.resolve(null);return promise;}
var _this=this;var key;if(tmFmt==='M1'){promise.resolve(null);return promise;}
if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=this.formatTime(tmStart,tmFmt,'up');tmEnd=this.formatTime(tmEnd,tmFmt);key=this.keyTpl.formatEL({id:id,fmt:tmFmt,start:tmStart.valueOf(),end:tmEnd.valueOf()});this.db.getItem(key).done(function(rs){var index1,index2;if(rs!==null){promise.resolve(rs);return promise;};tmStart=tmStart.format('yyyy-MM-dd HH:mm:ss');tmEnd=tmEnd.format('yyyy-MM-dd HH:mm:ss');_this.db.iterate(function(key,value,i){if(_this.isExist(key,id,tmFmt,tmStart,tmEnd)){index1=value.timeShaft.indexOf(tmStart);index2=value.timeShaft.indexOf(tmEnd);value.list[0].data=value.list[0].data.slice(index1,index2+1);value.timeShaft=value.timeShaft.slice(index1,index2+1);rs=value;return false;}}).done(function(){promise.resolve(rs);}).fail(function(e){promise.reject(e);});}).fail(function(e){promise.reject(e);});return promise;};DSCache.prototype.getBatch=function(ids,tmFmt,tmStart,tmEnd){if(!this.useCache){return $.when($,[]).then(function(){return;});}
var find,rs=null;var promiseArr=[];var idsNotFound=[];for(var i=0,len=ids.length;i<len;i++){(function(i){promiseArr.push(this.get(ids[i],tmFmt,tmStart,tmEnd).done(function(find){if(find!==null){if(rs===null)rs=find;else rs.list.push(find.list[0]);}else{idsNotFound.push(ids[i]);}}));}).call(this,i);}
return $.when.apply($,promiseArr).then(function(){return{data:rs,idsNotFound:idsNotFound};});};DSCache.prototype.set=function(data,tmFmt,tmStart,tmEnd){var promise=$.Deferred();if(!this.useCache){promise.resolve(null);return promise;}
var list=data.list.concat();if(tmFmt==='M1'){promise.resolve(null);return promise;}
if(data===null||!data.timeShaft||!data.timeShaft.length){promise.resolve(null);return promise;}
if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=this.formatTime(tmStart,tmFmt,'up');tmEnd=this.formatTime(tmEnd,tmFmt);function circle(){var _this=this;var item=list.shift();var id,key;if(!item){promise.resolve();return;}
id=item.dsItemId;key=this.keyTpl.formatEL({id:id,fmt:tmFmt,start:tmStart.valueOf(),end:tmEnd.valueOf()});this.merge2Cache(key,{list:[item],timeShaft:data.timeShaft}).done(function(){circle.call(_this);}).fail(function(e){promise.reject(e);});}
circle.call(this);return promise;};DSCache.prototype.remove=function(itemIds){var _this=this;var keys=[];var promise=$.Deferred();if(typeof itemIds==='string'){itemIds=[itemIds];}
this.db.keys().done(function(rs){console.log(rs);});this.db.iterate(function(key){var isExist=itemIds.some(function(row,i){if(key.indexOf('anal_'+row)>-1)return true;});if(isExist)keys.push(key);}).done(function(){if(keys.length>0){_this.db.removeItemList(keys).done(function(){promise.resolve();}).fail(function(){promise.reject();});return;}
promise.reject();}).fail(function(){console.warn('remove ds key failed! key: '+keys.join(','));promise.reject();});return promise;};DSCache.prototype.merge2Cache=function(newKey,newValue){var _this=this;var arr=newKey.split('_');var kk=[arr[0],arr[1],arr[2]].join('_');var filter=[];var promise=$.Deferred();this.db.iterate(function(key,value,index){if(key.indexOf(kk)>-1){filter.push({key:key,value:value});}}).done(function(){if(filter.length===0){_this.db.setItem(newKey,newValue).done(function(){promise.resolve();});return;}
_this.merge2group({key:newKey,value:newValue,fmt:arr[2],start:parseInt(arr[3]),end:parseInt(arr[4])},filter).then(function(){promise.resolve();},function(e){promise.reject(e);});}).fail(function(e){promise.reject(e);});return promise;};DSCache.prototype.merge2group=function(row,group){var _this=this;var timeArr=[],arr,ts,item;var start1,end1,start2,end2;var srcData;var promise=$.Deferred();for(var i=0,len=group.length;i<len;i++){arr=group[i].key.split('_');item={key:group[i].key,fmt:arr[2],start:parseInt(arr[3]),end:parseInt(arr[4])};timeArr.push(item);}
ts=TIME_STAMP[row.fmt];if(ts===undefined){promise.reject();return;}
start1=row.start-ts;end1=row.end+ts;srcData={key:row.key,value:row.value};function circle(){var _this=this;var item=timeArr.shift();var start2,end2;if(!item){this.db.setItem(srcData.key,srcData.value);promise.resolve();return;}
start2=item.start;end2=item.end;if(start1>end2||end1<start2){circle.call(this);}else{this.db.getItem(item.key).done(function(value){_this.mergeData(srcData,{key:item.key,value:value}).done(function(rs){srcData=rs;if(srcData===null){promise.resolve();return;}
circle.call(_this);});}).fail(function(){promise.reject();return;});}}
circle.call(this);return promise;};DSCache.prototype.mergeData=function(d1,d2){var key1=d1.key,key2=d2.key;var item1=d1.value,item2=d2.value;var arr=key1.split('_');var dsId=arr[1];var prefix=this.keyTpl.formatEL({id:arr[1],fmt:arr[2]});var start1,end1,start2,end2;var start,end;var index,data,ts,result;var promise=$.Deferred();startStr1=item1.timeShaft[0];endStr1=item1.timeShaft[item1.timeShaft.length-1];startStr2=item2.timeShaft[0];endStr2=item2.timeShaft[item2.timeShaft.length-1];start1=startStr1.toDate().valueOf();end1=endStr1.toDate().valueOf();start2=startStr2.toDate().valueOf();end2=endStr2.toDate().valueOf();start=Math.min(start1,start2);end=Math.max(end1,end2);if(start===start2&&end===end2){promise.resolve(null);return promise;}
if(start===start1&&end===end1){this.db.removeItem(key2).done(function(){promise.resolve(d1);});return promise;}
if(start===start1&&end===end2){index=item1.timeShaft.indexOf(startStr2);if(index===-1)index=item1.timeShaft.length;data=item1.list[0].data.slice(0,index).concat(item2.list[0].data);ts=item1.timeShaft.slice(0,index).concat(item2.timeShaft);this.db.removeItem(key2).done(function(){promise.resolve({key:prefix.formatEL({start:start1,end:end2}),value:{list:[{data:data,dsItemId:dsId}],timeShaft:ts}});});return promise;}
if(start===start2&&end===end1){index=item1.timeShaft.indexOf(endStr2);if(index===-1)index=0;data=item2.list[0].data.concat(item1.list[0].data.slice(index));ts=item2.timeShaft.concat(item1.timeShaft.slice(index));this.db.removeItem(key2).done(function(){promise.resolve({key:prefix.formatEL({start:start2,end:end1}),value:{list:[{data:data,dsItemId:dsId}],timeShaft:ts}});});return promise;}
promise.resolve(d1);return promise;};DSCache.prototype.isExist=function(key,id,tmFmt,tmStart,tmEnd){var arr=[];var rangeStart,rangeEnd;if(key.indexOf('anal_'+id+'_'+tmFmt)===-1)return false;arr=key.split('_');if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=tmStart.valueOf();tmEnd=tmEnd.valueOf();if(tmStart>=parseInt(arr[3])&&tmEnd<=parseInt(arr[4]))return true;return false;};DSCache.prototype.formatTime=function(time,fmt,mode){var ts=TIME_STAMP[fmt];mode=mode==='up'?'ceil':'floor';if(ts===undefined)return;if(typeof time==='string')time=time.toDate();time=time.valueOf()-TIMEZONE_OFFSET;if(fmt==='d1'){time=new Date(Math[mode](time/ts)*ts).format('yyyy-MM-dd 00:mm:ss');}else{time=new Date(Math[mode](time/ts)*ts+TIMEZONE_OFFSET).format('yyyy-MM-dd HH:mm:ss');}
return new Date(time);};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.ds=new DSCache();}).call(this,jQuery);﻿
var EnergyScreen=(function(){function EnergyScreen(id,store,shareSaveChange,dsInfoList,isForMobile){if(!id){this.id=ScreenCurrent.id;}else{this.id=id;}
this.factoryIoC=undefined;this.factoryIoCAnalysis=undefined;this.listEntity=undefined;this.mapRefresh={};this.popRefresh={};this.arrEntityOrder=undefined;this.requestPoints=[];this.dictPopToEntity={};this.store=store?store:undefined;this.container=undefined;this.dsInfolist=dsInfoList;if(store){this.sharedesc=store.desc;}else if(shareSaveChange){this.sharedesc=shareSaveChange.desc;}
this.isForReport=store?true:false;this.shareLogId=shareSaveChange?shareSaveChange.shareLogId:false;if(this.shareLogId){this.isForReport=true;}
this.isForBencMark=undefined;this.modalConfigPane=undefined;this.isConfigMode=false;this.workerUpdate=undefined;this.paneDatasource=undefined;this.arrColor=echarts.config.color;this.isScreenChange=undefined;this.isPlayback=false;this.$obCanvasContainer=undefined;this.canvas=undefined;this.toolContainer=undefined;this.isForMobile=isForMobile;this.options={isForMobile:isForMobile}}
EnergyScreen.prototype={show:function(){var _this=this;ElScreenContainer.innerHTML='';WebAPI.get("/static/views/observer/energyScreen.html").done(function(resultHtml){var divMain=document.createElement('div');divMain.className='indexContent st-pusher';divMain.innerHTML=resultHtml;var stCt=$('<div id="st-container" class="st-container">')[0];stCt.appendChild(divMain);ElScreenContainer.appendChild(stCt);_this.container=document.getElementById('paneCenter');_this.$obCanvasContainer=$(_this.container);_this.modalConfigPane=new modalConfigurePane(document.getElementById('energyModal'),_this,'dashboard');_this.modalConfigPane.show();_this.init();});},close:function(){if(this.isConfigMode){if(this.isScreenChange){var _this=this;confirm('There are some changes haven\'t been saved, do you want to save them before quit? ',function(){_this.saveLayout();});}}
for(var key in this.listEntity){this.listEntity[key].close();}
if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;this.factoryIoC=null;this.factoryIoCAnalysis=null;this.listEntity=null;this.arrEntityOrder=null;this.store=null;this.container=null;this.dictPopToEntity=null;this.UNIT_WIDTH=null;this.UNIT_HEIGHT=null;AppConfig.datasource=null;this.paneDatasource&&this.paneDatasource.close&&this.paneDatasource.close();this.$obCanvasContainer=null;this.canvas=null;this.arrColor=null;this.dsInfolist=null;this.mapRefresh=null;this.modalConfigPane=null;this.popRefresh=null;this.requestPoints=null;this.toolContainer=null;this.isForReport=null;this.isPlayback=null;this.shareLogId=null;if(!this.isForBencMark){if(ToolCurrent)ToolCurrent.close();ToolCurrent=null;$('#ulTools').html('');$('.toolBacktrace').remove();$('#btnConfigDashboard').remove();}
this.isForBencMark=null;},stop:function(){if(this.workerUpdate)this.workerUpdate.terminate();},onresize:function(){var entity;for(var key in ScreenCurrent.listEntity){entity=ScreenCurrent.listEntity[key];if(entity.chart)entity.chart.resize();if(entity.entityAnalysis&&entity.entityAnalysis.chart)entity.entityAnalysis.chart.resize();}},init:function(){var _this=this;Spinner.spin(ElScreenContainer);if(this.store){initByData();Spinner.stop();}else{WebAPI.get("/spring/get/"+this.id).done(function(result){_this.store=result;initByData();}).always(function(e){Spinner.stop();});}
function initByData(){_this.paneDatasource=new DataSource(_this);AppConfig.datasource=_this.paneDatasource;_this.initIoc();_this.initLayout();_this.initToolBar();_this.initWorkerForUpdating();_this.initScreen();if(_this.isForBencMark!==true){_this.initReplay();}}
$('#btnModalAdd').off('click').click(function(e){var entity=new ModalNone(_this,{id:(+new Date()).toString(),spanC:6,spanR:2,modal:{type:"ModalNone"}});_this.arrEntityOrder.push(entity.entity.id);_this.listEntity[entity.entity.id]=entity;entity.render();entity.configure();});},initToolBar:function(){var _this=this;var ulTools;if(AppConfig.isMobile)return;if(this.isForBencMark)return;ulTools=$('#ulTools');ulTools.html('');if(this.isForReport){var btnMode=$('<span>').addClass('badge grow toolbar-btn-selected').text('ok').css('cursor','pointer').css('background-color','#5bc0de').click(function(e){_this.saveLayout();_this.isConfigMode=false;});_this.isConfigMode=true;$('.springLinkBtn').hide();$('.sideTrans').fadeIn();$($('.nav-header')[0]).click();btnMode.appendTo($('<li><a>')).appendTo(ulTools);}else{if(AppConfig.permission.DBWrite){var $liConfig=$('<li class="iconWrap" id="btnConfigDashboard" permission="DBWrite"><a><span class="glyphicon glyphicon-cog"></span><span class="dropdownNav">'+I18n.resource.observer.widgets.CONFIG_MODE+'</span> </a></li>');var btnMode=$('<span>').addClass('badge grow').text('').css('cursor','pointer').css('background-color','#5bc0de').click(function(e){_this.isConfigMode=false;e.currentTarget.classList.remove('toolbar-btn-selected');_this.saveLayout();$('.springLinkBtn').removeAttr('style');});$liConfig.click(function(e){_this.isConfigMode=true;$('.springLinkBtn').hide();_this.showConfigMode();$('.sideTrans').fadeIn();document.querySelector('#leftCt').click();$($('.nav-header')[0]).click();btnMode.text(I18n.resource.observer.widgets.CONFIG_SAVE);});btnMode.appendTo($('<li><a>')).appendTo(ulTools);$liConfig.appendTo($('#liProjectMenu .list-inline'));}else{$('#btnConfigDashboard').remove();}}
try{Permission.check($('#liProjectMenu ul'));}catch(e){console.log(e);}},initIoc:function(){this.factoryIoC=new FactoryIoC('dashboard');this.factoryIoCAnalysis=new FactoryIoC('analysis');},initLayout:function(){this.listEntity={};this.arrEntityOrder=[];if(!this.isForBencMark){var side=new SidebarMenuEffect();side.init('#paneContent');}
I18n.fillArea($('#toolBox'));if(!(this.store&&this.store.layout))return;for(var i=0,item;i<this.store.layout.length;i++){for(var j=0;j<this.store.layout[i].length;j++){item=this.store.layout[i][j];var modelClass,entity;if(item.modal.type&&(item.modal.type!='ModalNone'||item.isNotRender==true)){modelClass=this.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender)continue;entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);if(item.modal.interval&&item.modal.interval>=0&&item.modal.points){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(this.requestPoints.indexOf(point)<0){this.requestPoints.push(point);}}}
if(item.modal.popId){if(!this.dictPopToEntity[item.modal.popId])this.dictPopToEntity[item.modal.popId]=[];this.dictPopToEntity[item.modal.popId].push(item.id);if(this.requestPoints.indexOf(item.modal.popId)<0){this.requestPoints.push(item.modal.popId);}}
entity.render();}else if(item.modal.type=='ModalNone'){modelClass=this.factoryIoC.getModel(item.modal.type);entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);entity.render();}}}
var $springCtn=$('#paneCenter').children('.springContainer');if($springCtn.length==1&&parseFloat($springCtn[0].style.height)>=parseFloat("99%")&&parseFloat($springCtn[0].style.width)>=parseFloat("99%")){$springCtn.children('.panel-default').css({border:'none',left:0,top:0,width:'100%',height:'100%'});}
if(this.options.isForMobile)this.$obCanvasContainer.addClass('forMobile');var _this=this;if(_this.isForReport){_this.showConfigMode();document.querySelector('#leftCt').click();}},initWorkerForUpdating:function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);if(this.requestPoints&&this.requestPoints.length>0){this.workerUpdate.postMessage({pointList:this.requestPoints,type:"datasourceRealtime"});}},refreshData:function(e){var _this=this.self?this.self:this;if(!e.data.error&&e.data.dsItemList){var point;for(var i=0,iLen=e.data.dsItemList.length;i<iLen;i++){point=e.data.dsItemList[i];_this.mapRefresh[point.dsItemId]=point;if(_this.dictPopToEntity[point.dsItemId]){_this.popRefresh[point.dsItemId]=point;}}
var entity,arrUpdataData;for(var key in _this.listEntity){entity=_this.listEntity[key];if(entity.entity.modal.type=="ModalNone"||entity.entity.modal.type=="ModalMix")continue;arrUpdataData=[];if(entity.entity.modal&&entity.entity.modal.points){for(var i=0,iLen=entity.entity.modal.points.length;i<iLen;i++){var point=entity.entity.modal.points[i];if(!point)continue;if(entity.entity.modal.points.indexOf(point)!=i)continue;if(_this.mapRefresh[point]!=undefined)
arrUpdataData.push(_this.mapRefresh[point]);}
if(entity.entity.modal.type=="ModalAppGauge"){arrUpdataData.push({'guageTitle':entity.entity.modal.option.guageTitle,'guageFulTitle':entity.entity.modal.option.guageFulTitle,'guageFixed':entity.entity.modal.option.guageFixed,'guageUnit':entity.entity.modal.option.guageUnit,'timeLocal':entity.entity.modal.option.timeLocal,'guageDirect':entity.entity.modal.option.guageDirect,'guageBgColor':entity.entity.modal.option.guageBgColor,'transDataDot':entity.entity.modal.option.transDataDot});}
entity.entity.modal.popId&&entity.renderPop(_this.popRefresh[entity.entity.modal.popId]);entity.update(arrUpdataData);}}}else{}},refreshDataTrace:function(e){var _this=this;_this.refreshData(e);for(var key in this.listEntity){if(undefined!=_this.listEntity[key].goBackTrace){_this.listEntity[key].goBackTrace(e);}}},saveLayout:function(){var _this=this;var arrEntity=[];var entity=null;for(var i=0;i<this.arrEntityOrder.length;i++){entity=this.listEntity[this.arrEntityOrder[i]].entity;if(this.listEntity[this.arrEntityOrder[i]].optionTemplate.needRefresh===false){arrEntity.push(entity);}
if(['ModalAppKPICollect','ModalObserver','ModalNote','ModalMix','ModalHtml','ModalChartCustom','ModalWeather','ModalReportFactory','ModalRealtimeWeather','ModalCumulantChart'].indexOf(entity.modal.type)>-1){arrEntity.push(entity);}else if(entity.modal.type=='ModalPointKPI'){arrEntity.push(this.dealWithEntity(entity));}else if(entity.modal.type=='ModalReportChapter'){if(entity.modal.option&&entity.modal.option.menuId&&entity.modal.option.menuId!=''){arrEntity.push(entity);}}else if(entity.modal.type=='ModalAppButton'){if(entity.modal.option&&entity.modal.option.appButton&&entity.modal.option.appButton.length!=0){arrEntity.push(entity);}}else if(entity.modal.type=='ModalDiagnosisPanelHtml'){if(!entity.modal.option){entity.modal.option={html:'<div id="modalDiagnosisPanel'+i+'" style="height:100%;"></div>↵<script>new ModalDiagnosisPanel(document.getElementById("modalDiagnosisPanel'+i+'")).show()</script>'};entity.modal.dsChartCog=[{accuracy:2}];entity.modal.interval=60000;entity.modal.points=[];}
arrEntity.push(entity);}else if(entity.modal.type=='ModalAppBlind'){if(entity.modal.option&&entity.modal.option.length>0){for(var j=0;j<entity.modal.option.length;j++){if(entity.modal.option[j]&&entity.modal.option[j].subChartIds&&entity.modal.option[j].subChartIds[0].id){var id=entity.modal.option[j].subChartIds[0].id;if(!this.listEntity[id]){entity.modal.option.splice(j,1);break;}}}}
arrEntity.push(entity);}else{if(entity.modal.type!='ModalNone'&&(!entity.modal.points||entity.modal.points.length==0))continue;arrEntity.push(entity);}}
var data={creatorId:AppConfig.userId,menuItemId:this.id,layout:[arrEntity]};this.store.id&&(data.id=this.store.id);Spinner.spin(ElScreenContainer);WebAPI.post('/spring/saveLayout',data).done(function(result){if(_this.isForReport){var argSkin=AppConfig.chartTheme=='macarons'?'':'?skin=dark';_this.initShareIframe("/share/db/"+AppConfig.userId+"/"+_this.id+argSkin);ScreenManager.show(shareLogging,AppConfig.userId);}else{if(_this.isConfigMode&&_this.isScreenChange)return;if(_this.options.isForMobile){ScreenManager.applyScreen(EnergyScreen,null,null,null,null,true);}else{ScreenManager.applyScreen(EnergyScreen);}}}).always(function(result){if(_this.isConfigMode&&_this.isScreenChange)return;Spinner.stop();});if(_this.isForReport){var modeType;if(_this.shareLogId){modeType=true;}else{modeType=false;}
var argSkin=AppConfig.chartTheme=='macarons'?'':'?skin=dark';var arrDesc=_this.sharedesc.split(' ');if(parseInt(arrDesc[arrDesc.length-3])!==_this.arrEntityOrder.length){arrDesc[arrDesc.length-3]=_this.arrEntityOrder.length;_this.sharedesc=arrDesc.join(' ');}
var postData={menuId:_this.id+argSkin,mode:modeType,shareLogId:_this.shareLogId,desc:_this.sharedesc}
WebAPI.post('/analysis/saveShareLog/'+AppConfig.userId,postData).done(function(result){console.log(result.status)})}},saveLayoutOnly:function(){var _this=this;var arrEntity=[];var entity=null;for(var i=0;i<this.arrEntityOrder.length;i++){entity=this.listEntity[this.arrEntityOrder[i]].entity;if(['ModalObserver','ModalNote','ModalMix','ModalHtml','ModalChartCustom','ModalWeather'].indexOf(entity.modal.type)>-1){arrEntity.push(entity);}else if(entity.modal.type=='ModalPointKPI'){arrEntity.push(this.dealWithEntity(entity));}else if(entity.modal.type=='ModalReportChapter'){if(entity.modal.option&&entity.modal.option.menuId&&entity.modal.option.menuId!=''){arrEntity.push(entity);}}else{if(entity.modal.type!='ModalNone'&&(!entity.modal.points||entity.modal.points.length==0))continue;arrEntity.push(entity);}}
var data={creatorId:AppConfig.userId,menuItemId:this.id,layout:[arrEntity]};this.store.id&&(data.id=this.store.id);Spinner.spin(ElScreenContainer);WebAPI.post('/spring/saveLayout',data).done(function(result){}).always(function(result){Spinner.stop();});},dealWithEntity:function(entity){entity.modal.points=[];entity.modal.interval=5;entity.modal.option&&entity.modal.option.kpiList&&entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){dealWithNode(tree);traverse(tree,0);}
function traverse(node,i){var children=node.list;if(children!=null&&children.length>0){dealWithNode(children[i]);if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}
function dealWithNode(child){delete child.pointPassData;delete child.show;if(child.pointKPI){entity.modal.points.push(child.pointKPI);}
if(child.pointGrade){entity.modal.points.push(child.pointGrade);}
if(child.pointPass){entity.modal.points.push(child.pointPass);}}
return entity;},setEntity:function(entity){},replaceEntity:function(sourceId,targetId,parentId){if(sourceId==targetId)return;var _this=this;var source=this.listEntity[sourceId];var target=this.listEntity[targetId];source.entity.id=(+new Date()).toString();target.entity.id=(+new Date()+1).toString();this.listEntity[source.entity.id]=source;this.listEntity[target.entity.id]=target;delete this.listEntity[sourceId];delete this.listEntity[targetId];source.initContainer(targetId).configure();target.initContainer(sourceId).configure();this.arrEntityOrder[this.arrEntityOrder.indexOf(targetId)]=source.entity.id;this.arrEntityOrder[this.arrEntityOrder.indexOf(sourceId)]=target.entity.id;if(parentId){this.listEntity[parentId].entity.modal.option.subChartIds.forEach(function(i){if(i.id==sourceId){i.id=target.entity.id;}});this.listEntity[parentId].entity.modal.option.subChartIds.forEach(function(i){if(i.id==targetId){i.id=source.entity.id;}});}
if(source.entity.modal.type=='ModalMix'){source.entity.modal.option&&source.entity.modal.option.subChartIds&&source.entity.modal.option.subChartIds.forEach(function(i){var entity=_this.listEntity[i.id].entity,modelClass,item;modelClass=_this.factoryIoC.getModel(entity.modal.type);_this.container=$('#divContainer_'+source.entity.id).find('.chartsCt')[0];item=new modelClass(_this,entity);item.configure()});}
if(target.entity.modal.type=='ModalMix'&&target.entity.modal.option&&target.entity.modal.option.subChartIds){target.entity.modal.option.subChartIds.forEach(function(i){var entity=_this.listEntity[i.id].entity,modelClass,item;modelClass=_this.factoryIoC.getModel(entity.modal.type);_this.container=$('#divContainer_'+target.entity.id).find('.chartsCt')[0];item=new modelClass(_this,entity);item.configure()});}},rebornEntity:function(entityParams,tragetType,targetTitle,modalNoneEdit){this.removeEntity(entityParams.id);entityParams.modal.type=tragetType;entityParams.modal.title='';var modelClass=this.factoryIoC.getModel(tragetType);if((!entityParams.isNotRender)&&entityParams.modal.type!=='ModalMix'&&!modalNoneEdit){entityParams.spanC=modelClass.prototype.optionTemplate.defaultWidth?modelClass.prototype.optionTemplate.defaultWidth:modelClass.prototype.optionTemplate.minWidth;entityParams.spanR=modelClass.prototype.optionTemplate.defaultHeight?modelClass.prototype.optionTemplate.defaultHeight:modelClass.prototype.optionTemplate.minHeight;}
var entity=new modelClass(this,entityParams);this.listEntity[entity.entity.id]=entity;this.arrEntityOrder.push(entity.entity.id);entity.configure();},removeEntity:function(id){this.listEntity[id]=null;delete this.listEntity[id];this.arrEntityOrder.splice(this.arrEntityOrder.indexOf(id),1);},render:function(data){for(var key in this.listEntity){this.listEntity[key].render();}},showConfigMode:function(){this.stop();Spinner.spin(document.getElementById('paneCenter'));for(var key in this.listEntity){this.listEntity[key].configure();}
this.initDataSourcePanel();this.initToolBox();Spinner.stop();},initToolBox:function(){var $toolBox=$($('.col-sm-2')[0].children[0]);var $modals=$('<div id="modalCt" class="panel-body">').appendTo($toolBox);var list,template,option,groupList=[];list=this.factoryIoC.getList();for(var ele=0;ele<list.length;ele++){template=list[ele];option=template.prototype.optionTemplate;if(!option)continue;if(option.parent!=null){if(!groupList[option.parent]){groupList[option.parent]=new Array();}
groupList[option.parent].push(option)}}
for(var i=0;i<groupList.length;i++){$modals.append(getModalList(groupList[i]));}
function getModalList(group){var $ul=$('<ul class="nav nav-list accordion-group">');var $liList=$('<li class="rows" style="display: none;">').appendTo($ul);for(var i in group){if(i==0){var $liHd=$('<li class="nav-header">').append('<i class="icon-plus icon-white"></i>'+I18n.findContent(group[i].name)).click(function(){var $otherUl=$(this).parent('ul').siblings('ul');$otherUl.find('.rows').slideUp();$otherUl.find('i').removeClass('icon-minus').addClass('icon-plus');$(this).next('.rows').slideToggle();var $i=$(this).find('i');var toggleClass=(function(){if($i.hasClass('icon-minus'))
return'icon-plus icon-white'
else
return'icon-minus icon-white'})();$(this).find('i').removeClass().addClass(toggleClass)});$ul.prepend($liHd);}else{var $div=$('<div class="lyrow ui-draggable" draggable="true"> ').html(I18n.findContent(group[i].name)).attr('type',group[i].type);$div[0].ondragstart=function(e){e.dataTransfer.setData("type",$(this).attr('type'));e.dataTransfer.setData("title",$(this).text());}
$liList.append($div);}}
return $ul;}},initDataSourcePanel:function(){this.paneDatasource=new DataSource(this);AppConfig.datasource=this.paneDatasource;this.paneDatasource.show();},hideAnlsPane:function(){$('#paneCenter').hide();$('#energyModal').hide();},showAnlsPane:function(){$('#paneCenter').show();$('#energyModal').show();},getDSItemById:function(datasourceItemId){for(var i=0,len=this.store.datasources[0].list.length;i<len;i++){if(this.store.datasources[0].list[i].id===datasourceItemId){return this.store.datasources[0].list[i];}}
return null;},updateDataSources:function(updateData){this.store.group=updateData;},initReplay:function(){var _this=this;var $ele=$('#btnDropdownNavList').find('.toolBacktrace');if($ele.length>0){$ele.remove();}
this.toolContainer=$('#divEnergyTools');var btnTimeShaft=$('<li class="iconWrap"><a><span class="glyphicon glyphicon-play-circle"></span><span class="dropdownNav"></span></a></li>').addClass('toolBacktrace');var enterTime;btnTimeShaft.find('.dropdownNav').text(I18n.resource.observer.widgets.BACKTRACE);btnTimeShaft.eventOn('click',function(e){if(_this.isPlayback){_this.quitBacktraceMode(_this,e);if(enterTime){enterTime=new Date()-enterTime;_hmt.push(['_trackEvent','navTool-backTrace-time','click','btnBakTrace-'+AppConfig.projectShowName+'-'+AppConfig.projectId,enterTime/1000]);}}else{_this.enterBacktraceMode(_this,e);enterTime=new Date();_hmt.push(['_trackEvent','navTool-backTrace-enter','click','btnBakTrace-'+AppConfig.projectShowName+'-'+AppConfig.projectId]);}},['navTool-backTrace','btnBackTrace',AppConfig.projectShowName,AppConfig.projectId]);$('#right-nav').find('#btnOperatingRecord').after(btnTimeShaft);if(this.isInDiagnosis)ToolCurrent=new TimeShaftDashboard(_this);},enterBacktraceMode:function(screen,e){var _this=screen?screen:this;_this.isPlayback=true;if(e){e.currentTarget.classList.add('selected');}
if(!ToolCurrent)ToolCurrent=new TimeShaftDashboard(_this);ToolCurrent.containerHeight=100;ToolCurrent.show();if(_this.workerUpdate){_this.workerUpdate.terminate();_this.workerUpdate=null;}
$.when(ToolCurrent.defer).done(function(){var jCanvas=_this.$obCanvasContainer;jCanvas.css({height:'100%',width:'100%'});var jParent=jCanvas.parent();var height=jCanvas.height()-ToolCurrent.containerHeight;var width=jCanvas.width();if(width>jParent.width()){width=jParent.width();height=width/(_this.canvas.width/_this.canvas.height);}
jCanvas.animate({height:height,width:width,marginTop:(jParent.height()-height-ToolCurrent.containerHeight)/2+'px'},400,function(){_this.initScreen();_this.renderElements();_this.initWorkerForUpdating();});});},quitBacktraceMode:function(screen,e){var _this=screen?screen:this;_this.isPlayback=false;if(e){e.currentTarget.classList.remove('selected');}
ToolCurrent.close();ToolCurrent=null;_this.$obCanvasContainer.animate({height:'100%',width:'100%'},300,function(){_this.initScreen();_this.renderElements();_this.initWorkerForUpdating();});},initScreen:function(){if(this.isDetailPage){var _this=this;var dialogWidth=this.store.page.width+40>$(window).width()?$(window).width()-200:this.store.page.width+40;var detailScreenModal=$('#detailScreenModal');var $toolBacktrace=$('.toolBacktrace');I18n.fillArea($('#detailScreenModal'));$toolBacktrace.remove();if(this.dialogTitle){var oldDialogTitle=detailScreenModal.find('.modal-title').text();detailScreenModal.find('.modal-title').text(this.dialogTitle);}
detailScreenModal.find('.modal-dialog').css("margin","0 auto 0 auto").css("width",dialogWidth);detailScreenModal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){if(ScreenModal){ScreenModal.close();ScreenModal=null;}
_this.initToolBar(tObscreen);Spinner.stop();oldDialogTitle&&$(this).find('.modal-title').text(oldDialogTitle);}).modal({});Spinner.spin(detailScreenModal.find('.modal-body')[0]);var paddingLeft=(1920-this.store.page.width)/2;var paddingTop=(955-this.store.page.height)/2;convertPositionToReal(this.store.equipments);convertPositionToReal(this.store.buttons);convertPositionToReal(this.store.texts);convertTempDistributionsToReal(this.store.tempDistributions);function convertPositionToReal(arr){if(arr){for(var i=0;i<arr.length;i++){var temp=arr[i];temp.x=temp.x-paddingLeft;temp.y=temp.y-paddingTop;}}}
function convertTempDistributionsToReal(dis){if(!dis){return}
dis.x-=paddingLeft;dis.y-=paddingTop;convertPositionToReal(dis.data);}}else{if(ScreenModal&&!this.isInDiagnosis){if(ScreenCurrent)ScreenCurrent.close();ScreenCurrent=ScreenModal;ScreenModal=null;}
if(this.isInDiagnosis)this.diagScreen.obScreen=this;tObscreen=this;$("#page-"+this.id).parent().addClass("active");}},renderElements:function(){this.dictRefreshMap={};},renderData:function(dataList,curTm,startTm,endTm){var data={};data.dsItemList=dataList;this.refreshDataTrace({data:data,currentTime:curTm,startTime:startTm,endTime:endTm});},initShareIframe:function(shareURL){var strIframe=new StringBuilder();strIframe.append('<div class="modal fade" id="modalShareIframe" style="overflow-y:hidden">');strIframe.append('  <div class="modal-dialog" style="height:95%;width:80%">');strIframe.append('      <div class="modal-content" style="height:100%;">');strIframe.append('          <div class="modal-header" style="height:60px">');strIframe.append('              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>');strIframe.append('              <h4 class="modal-title">'+this.sharedesc+'</h4>');strIframe.append('          </div>');strIframe.append('          <div class="modal-body" id="divShareIframe" style="height:calc(100% - 60px);padding:0">');strIframe.append('              <iframe src="'+shareURL+'" style="height:100%;width:100%;border:none;"></iframe>');strIframe.append('          </div>');strIframe.append('      </div>');strIframe.append('  </div>');strIframe.append('</div>');$('body').append(strIframe.toString());var $modalShareIframe=$('#modalShareIframe');I18n.fillArea($modalShareIframe);$modalShareIframe.modal({show:true});$modalShareIframe.on('hidden.bs.modal',function(e){$modalShareIframe.remove();})}}
return EnergyScreen;})();var ElScreenContainer=document.getElementById('indexMain');var ScreenCurrent=undefined;var ScreenModal=undefined;var ScreenPrevious=undefined;var ToolCurrent=undefined;var Spinner=new LoadingSpinner({color:'#00FFFF'});var chartTheme=undefined;theme.Dark.backgroundColor='rgb(25, 34, 52)';var AppConfig={projectId:1,projectName:undefined,userId:undefined,account:undefined,level:undefined,projectList:undefined,isMobile:false,chartTheme:'macarons'};var I18n=undefined;echarts.config=echarts.config||{color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500']};(function($,window,undefined){var userMailList=null;var reportItemTpl='<div class="rp-ctn" style="width: {width}; height:{height}">\
        <div class="panel panel-default rp-ctn-p">\
            <div class="panel-heading rp-ctn-p-h">\
                <h3 class="panel-title" style="font-weight: bold;">{title}</h3>\
            </div>\
            <div class="panel-body rp-ctn-p-b">\
                {chartContent}\
                {note}\
                {graph}\
            </div>\
        </div>\
    </div>';var MM2PX=$('#mm2px').width();var initI18n=function(lang,isForce){InitI18nResource(lang,isForce).always(function(rs){I18n=new Internationalization(null,rs);Init();});};var Init=function(){var hidData=JSON.parse($('#hidData').html());AppConfig.userId=hidData.userId;I18n.fillArea($('body'));ScreenCurrent=new EnergyScreen(hidData.menuId);ScreenCurrent.show();}
var attachEvents=function(){var $lkCopyLink=$('#lkCopyLink');var $lkSendEmail=$('#lkSendEmail');var $lkPrint=$('#lkPrint');var $changeSkinReport=$('#changeSkinReport');var $modalSendEmail=$('#modalSendEmail');$lkCopyLink.click(function(){var input=document.createElement('textarea');var successful;document.body.appendChild(input);input.value=window.location.href;input.focus();input.select();successful=document.execCommand('Copy');input.remove();if(successful){alert(I18n.resource.shareBoard.COPY_LINK_SUCCESS);}else{alert(I18n.resource.shareBoard.COPY_LINK_FAILED);}});$lkSendEmail.click(function(){$modalSendEmail.modal('show');});initEmailBox();$lkPrint.click(function(){var entities=ScreenCurrent.listEntity;var entity,params;var noteList,noteHtml,layout,graphList,graphHtml;var arrHtml=[];var promise;Spinner.spin(document.body);var pageHeight=106;promise=WebAPI.get('/static/views/share/export/pdfTemplate.html');for(var k in entities){if(!entities.hasOwnProperty(k))continue;entity=entities[k];if(!entity.entityAnalysis)continue;pageHeight+=707;params={};noteHtml=[];graphHtml=[];params.title=entity.entity.modal.title;var divCtn=document.getElementById('divContainer_'+k);var style=getComputedStyle(divCtn);params.width='1342px';params.height='707px';var $target=$(divCtn).find('.springContent div:eq(0)');var pos=$target.position();var posParams={top:pos.top,left:pos.left,width:$target.width()*1366/document.body.clientWidth,height:657};var isChartEmpty=false;if(!entity.entityAnalysis.chart){isChartEmpty=true;}else{var isDataEmpty=(function(s){function isEmpty(obj){if(obj==null)return true;if(obj.length>0)return false;if(obj.length===0)return true;for(var key in obj){if(hasOwnProperty.call(obj,key))return false;}
return true;}
if(isEmpty(s))return true;for(var i=0,len=s.length;i<len;i++){if(!isEmpty(s[i])){return false;}}
return true;}(entity.entityAnalysis.chart.getOption().series));if(isDataEmpty){isChartEmpty=true;}else{isChartEmpty=false;}}
if(isChartEmpty){params.chartContent='<h4 style="position:absolute; top:50%; left: 50%; width:200px; height: 20px; margin-left:-100px; margin-top:-10px;">This page has no data.</h4>'.formatEL(posParams);}else{posParams.imgSrc=entity.entityAnalysis.chart.getDataURL();params.chartContent='<img src="{imgSrc}" style="top:{top}px; left: {left}px; width:{width}px; height:{height}px;"/>'.formatEL(posParams);}
noteList=entity.curModal.noteList;layout=entity.curModal.layout||{};if(!noteList||!noteList.length){params.note='';}else{noteList.forEach(function(row,i){var dockPosition=null;for(var t in layout){if(!layout.hasOwnProperty(t)){continue;}
if(!layout[t]||!layout[t].length){continue;}
if(layout[t].indexOf(row.id)>-1){dockPosition=t;break;}}
if(!!dockPosition){noteHtml.push(createDockNote(row,dockPosition));}else{noteHtml.push('<div class="note" style="left:{x};top:{y};width:{width};height:{height};background-color:{bgColor}">{text}</div>'.formatEL(row))}});params.note=noteHtml.join('');}
graphList=entity.curModal.graphList;if(!graphList||graphList.length==0){params.graph='';}else{var temp;var tpl_arrow='<div class="svgCopyBox" style="width:{boxWidth}px;height:{boxHeight}px;padding:2px;position:absolute;left:{left}%;top:{top}%;z-index:201;">\
                                    <svg class="svgGraphCopy" id="{id}" viewBox="0 0 {width} {height}" width="{width}" height="{height}"  type="arrow">\
                                    <defs><marker id="{marker_id}" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="{color}"/></marker></defs>\
                                    <path class="arrow-line2" marker-end="url(#{marker_id})" stroke-width="4" stroke="{color}" d="{path_d}"/>\
                                    </svg></div>';var tpl_circle='<div class="svgCopyBox" style="width:{boxWidth}px;height:{boxHeight}px;padding:2px;position:absolute;left:{left}%;top:{top}%;z-index:201;">\
                                    <svg class="svgGraphCopy" id="{id}" viewBox="0 0 {width} {height}" width="{width}" height="{height}" >\
                                    <ellipse style="fill:rgba(0,0,0,0);stroke-width:3px;stroke:{color}" orient="auto" cx="{cx}" cy="{cy}" rx="{rx}" ry="{ry}" x="0" y="0"/>\
                                    </svg></div>';var tpl_rect='<div class="svgCopyBox" style="width:{boxWidth}px;height:{boxHeight}px;padding:2px;position:absolute;left:{left}%;top:{top}%;z-index:201;">\
                                    <svg class="svgGraphCopy" id="{id}" viewBox="0 0 {width} {height}" width="{width}" height="{height}" >\
                                    <rect style="fill:rgba(0,0,0,0);stroke-width:4px;stroke:{color}" orient="auto" width="{width}" height="{height}"/>\
                                    </svg></div>';graphList.forEach(function(row){var boxWidth=parseInt(params.width.split('px')[0]);var boxHeight=parseInt(params.height.split('px')[0]);var downX=row.downX*boxWidth;var downY=row.downY*boxHeight;var upX=row.upX*boxWidth;var upY=row.upY*boxHeight;var xDiffer=Math.abs(upX-downX);var yDiffer=Math.abs(upY-downY);if(xDiffer<20){xDiffer=20}
if(yDiffer<20){yDiffer=20}
if(row.type=='arrow'){if(upX>=downX&&upY<downY){temp=tpl_arrow.formatEL({id:row.id,width:xDiffer,height:yDiffer,marker_id:'marker_'+row.id,color:row.color,path_d:'M0,'+yDiffer+' L'+Math.abs(upX-downX-8)+',8',boxWidth:xDiffer+8,boxHeight:yDiffer+8,left:downX*100/boxWidth-1,top:upY*100/boxHeight+4});}else if(upX>downX&&upY>=downY){temp=tpl_arrow.formatEL({id:row.id,width:xDiffer,height:yDiffer,marker_id:'marker_'+row.id,color:row.color,path_d:'M0,0 L'+Math.abs(upX-downX-8)+','+Math.abs(upY-downY-8),boxWidth:xDiffer+8,boxHeight:yDiffer+8,left:downX*100/boxWidth-1,top:downY*100/boxHeight+4});}else if(upX<=downX&&upY<=downY){temp=tpl_arrow.formatEL({id:row.id,width:xDiffer,height:yDiffer,marker_id:'marker_'+row.id,color:row.color,path_d:'M'+xDiffer+','+yDiffer+' L8,8',boxWidth:xDiffer+8,boxHeight:yDiffer+8,left:upX*100/boxWidth-1,top:upY*100/boxHeight+4});}else if(upX<downX&&upY>=downY){temp=tpl_arrow.formatEL({id:row.id,width:xDiffer,height:yDiffer,marker_id:'marker_'+row.id,color:row.color,path_d:'M'+xDiffer+',0 L8 ,'+Math.abs(upY-downY-8),boxWidth:xDiffer+8,boxHeight:yDiffer+8,left:upX*100/boxWidth-1,top:downY*100/boxHeight+4});}}else if(row.type=='rect'){temp=tpl_rect.formatEL({id:row.id,width:xDiffer,height:yDiffer,color:row.color,boxWidth:xDiffer+8,boxHeight:yDiffer+8,left:downX*100/boxWidth-1,top:downY*100/boxHeight+4});}else if(row.type=='circle'){temp=tpl_circle.formatEL({id:row.id,width:xDiffer,height:yDiffer,color:row.color,cx:xDiffer/2,cy:yDiffer/2,rx:Math.abs(upX-downX-4)/2,ry:Math.abs(upY-downY-4)/2,boxWidth:xDiffer+8,boxHeight:yDiffer+8,left:downX*100/boxWidth-1,top:downY*100/boxHeight+4});}
graphHtml.push(temp);});params.graph=graphHtml.join('');}
arrHtml.push(reportItemTpl.formatEL(params));}
function createDockNote(note,direction){var $ctn=$('<div class="dock-window-ctn">');var $divNote=$('<div class="dock-note" style="background-color: '+note.bgColor+'">'+'<div class="dock-note-ct gray-scrollbar" data-id="'+note.id+'"></div>'+'</div>');var $divNoteCt=$divNote.children('.dock-note-ct');var $layoutCtn,$layoutCtnWrap;var $layoutContainer;if(['top','bottom'].indexOf(direction)>-1){$layoutContainer=$ctn;$divNoteCt.height(note.height);}
if(['left','right'].indexOf(direction)>-1){$layoutCtnWrap=$ctn.children('.dock-layout-wrap');if($layoutCtnWrap.length===0){var $wrap=$('[data-id="'+note.id+'"]').closest('.dock-layout-wrap');var style=getComputedStyle($wrap[0]);$layoutCtnWrap=$('<div class="dock-layout-wrap" style="bottom: '+style.bottom+'; top: '+style.top+';">');$ctn.append($layoutCtnWrap);}
$layoutContainer=$layoutCtnWrap;$divNoteCt.width(note.width);}
$layoutCtn=$layoutContainer.children('.dock-layout-'+direction);if($layoutCtn.length===0){$layoutCtn=$('<div class="dock-layout dock-layout-'+direction+'" data-direction="'+direction+'">');$layoutContainer.append($layoutCtn);}
$divNoteCt.html(note.text.replace(/body/g,'div'));$layoutCtn.append($divNote);return $ctn[0].outerHTML;}
promise.done(function(html){var xhr,formData;html=html.formatEL({title:I18n.resource.shareBoard.TITLE,pageWidth:1366/MM2PX+'mm',pageHeight:pageHeight/MM2PX+'mm',encoding:'UTF-8',entitiesHtml:arrHtml.join('')});formData=new FormData();formData.append('html',html);formData.append('skin',AppConfig.chartTheme=='macarons'?'default':'dark');xhr=new XMLHttpRequest();xhr.responseType='arraybuffer';xhr.open('POST','/admin/getShareReportPDF');xhr.onload=function(){var blob,url,lkPdfFile;if(this.status===200){blob=new Blob([xhr.response],{type:"application/pdf"});url=URL.createObjectURL(blob);lkPdfFile=document.createElement('a');lkPdfFile.style="display: none";lkPdfFile.id="lkPdfFile";lkPdfFile.href=url;lkPdfFile.download='BeopReport_'+new Date().format('yyyy-MM-dd HH-mm-ss')+'.pdf';document.body.appendChild(lkPdfFile);lkPdfFile.click();window.URL.revokeObjectURL(url);window.setTimeout(function(){lkPdfFile.parentNode.removeChild(lkPdfFile);},0);}else{alert('Generate report failed, please try it again soon!');}
Spinner.stop();};xhr.send(formData);}).fail(function(e){throw e;});});$changeSkinReport.click(function(){var $indexNav=$('#indexNav'),$selectSkinWrap=$('.selectSkinWrap'),$skinList;if($selectSkinWrap.length==1){$selectSkinWrap.slideToggle();}else{var html='<div class="selectSkinWrap">\
                        <ul id="skinList">\
                            <li id="btnDark" class="skinItem">'+I18n.resource.admin.ddlUser.MENU_CHANGE_SKIN_DARK+'</li>\
                            <li id="btnDefault" class="skinItem">'+I18n.resource.admin.ddlUser.MENU_CHANGE_SKIN_DEFAULT+'</li>\
                        </ul>\
                    </div>';$indexNav.append(html);$selectSkinWrap=$indexNav.find('.selectSkinWrap');$selectSkinWrap.slideDown();if(AppConfig.chartTheme=='macarons'){$('#btnDefault').addClass('checked').siblings().removeClass('checked');}else{$('#btnDark').addClass('checked').siblings().removeClass('checked');}
$('li','#skinList').off('click').click(function(){$selectSkinWrap.slideUp(100);$(this).addClass('checked');if(this.id=='btnDark'){var oldUrl=window.location.href.split('#');window.location.href=oldUrl[0]+'?skin=dark';}else if(this.id=='btnDefault'){var oldUrl=window.location.href;window.location.href=oldUrl.split('?')[0];}});}});};var initEmailBox=function(){var $modalSendEmail=$('#modalSendEmail');var $mailList=$('#mailList');var $mailTo=$('#mailTo');var $btnSend=$('#btnSend');var store=null;function displayLoading(){$mailList.html('<div class="list-group-item item-loading">Loading...</div>');}
function displayErr(){$mailList.html('<div class="list-group-item item-failed">load failed, \
                    <a href="javascript:;">click to reload</a></div>');}
function displayEmpty(){$mailList.html('<div class="list-group-item item-empty">No avaliable users.</div>');}
function addEmail(index){var row=store[index];if($mailTo.find('[data-mail="'+row.useremail+'"]').length>0)return;var html='<div class="inner-mail-wrap" spellcheck="false" data-mail="{2}" data-index="{0}"><div class="inner-mail" contenteditable="false">\
                        <span class="user-name">{1}</span>\
                        <span class="mail-addr">&lt;{2}&gt;;</span>\
                        </div>&nbsp;</div>'.format(index,row.userfullname,row.useremail)
$mailTo.append(html);}
function removeEmail(index){$mailTo.find('[data-index="'+index+'"]').remove();}
function loadMailList(){if($mailList.find('.item-mail').length>0)return;return WebAPI.get('/admin/sharedUserList/'+AppConfig.userId).done(function(rs){var arrHtml=[];if(rs.success===true){rs.data=rs.data.filter(function(row,i){if(row.useremail)return true;return false;});store=rs.data||[];if(rs.data&&rs.data.length>0){$mailList.empty();rs.data.forEach(function(row,i){arrHtml.push('<div class="list-group-item item-mail" data-index="{0}">\
                                    <span class="user-name">{1}</span>\
                                    <span class="mail-addr">&lt;{2}&gt;</span>\
                                    <span class="item-status glyphicon glyphicon-ok-circle"></span>\
                                    </div>'.format(i,row.userfullname,row.useremail));});$mailList.html(arrHtml.join(''));}else{displayEmpty();}}else{displayErr();}}).fail(function(){displayErr();});}
$modalSendEmail.off('shown').on('shown.bs.modal',function(){window.setTimeout(loadMailList,500);});$modalSendEmail.off('hidden').on('hidden.bs.modal',function(){$mailTo.empty();$mailList.children('.on').removeClass('on');});$modalSendEmail.on('click','item-failed>a',function(e){loadMailList();e.stopPropagation();});$modalSendEmail.on('click','.item-mail',function(){var $this=$(this);var isRemove=$this.hasClass('on');if(isRemove){$this.removeClass('on');removeEmail($this.attr('data-index'));}else{$this.addClass('on');addEmail($this.attr('data-index'));}});$btnSend.click(function(){var list=$mailTo.children('.inner-mail-wrap').map(function(){return $(this).attr('data-mail')});if(!list||!list.length)return;$.post('/sendEmail',{'subject':'Beop 数据分析报告分享','body':'%s %s用户使用BeOP平台向您发送了一份报告，请点击链接进行查看: '+window.location.href,'recipients':([]).join.call(list,';'),'userId':AppConfig.userId}).done(function(rs){if(rs.status==='OK'){alert(I18n.resource.shareBoard.SEND_MAIL_SUCCESS);}else{alert(I18n.resource.shareBoard.SEND_MAIL_FAILED);}});});};$(function(){if(navigator.userAgent.match(/iP(ad|hone|od)/i))AppConfig.isMobile=true;ElScreenContainer.innerHTML='';initI18n(navigator.language.split('-')[0],false);attachEvents();});}(jQuery,window));var ModalConfig=(function($,undefined){var arrForEach=Array.prototype.forEach;function ModalConfig(options){this.options=$.extend({},this.DEFAULTS,options);this.$wrap=null;};ModalConfig.prototype={constructor:ModalConfig,show:function(){var _this=this;var htmlUrl=this.options.htmlUrl;var matches=htmlUrl.match(/\/?(\w+)(?:\.html)/);var id,domPanelContent,$ele;var promise=$.Deferred();if(!matches||matches[1]===undefined){console.error('the url of config modal is illigal: '+htmlUrl);return false;}
id=matches[1]+'Wrap';domPanelContent=document.getElementById(this.options.container||'paneContent');if(($ele=$('#'+id)).length>0){if(!$.contains(domPanelContent,$ele[0])){domPanelContent.appendChild($ele[0]);}
promise.resolve();}else{Spinner.spin(domPanelContent);WebAPI.get(htmlUrl).then(function(html){var rs;Spinner.stop();_this.$wrap=$('<div class="modal-config-wrap" id="'+id+'">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this._attachEvents();return _this.init();}).always(function(){promise.resolve();});}
return promise.done(function(){_this.$modal.modal('show');});},_setField:function(type,$ele,value){var itemMap,name;var _this=this;switch(type){case'dropdown':itemMap=$ele.data('dropdown-items');if(!itemMap){$ele.data('dropdown-items',itemMap=(function(){var rs={};$ele.siblings('ul').find('a').each(function(i,item){var $item=$(item);var value=$item.attr('data-value');var text=$item.text();if(!rs[value])rs[value]=text;});return rs;}()));}
$ele.attr('data-value',value).children('span').eq(0).text(itemMap[value]);break;case'input':case'textarea':value=value||'';$ele.val(value);break;case'droparea':if(!value||value.trim()===''){$ele.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');}
else{name=AppConfig.datasource.getDSItemById(value).alias;$ele.attr({'data-value':value,'title':name}).html('<span>'+name+'</span>');}
break;case'select':$ele.val(value);break;default:break;}},_attachEvents:function(){var _this=this;var $modal;$('.dropdown-menu',this.$wrap).off('click.selected').on('click.selected','a',function(e){var $this=$(this);var $btn=$this.parents('.dropdown-wrap').children('button');var value=$this.attr('data-value');var text=$this.text();$btn.attr('data-value',value);$btn.children('span').eq(0).text(text);e.preventDefault();});$modal=$('.modal',this.$wrap);$modal.off('show.bs.modal').on('show.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.recoverForm(_this.options.modalIns.entity.modal);if(!$rightCt.hasClass('rightCtOpen'))$rightCt.click();});$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.reset();if($rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$wrap.off('dragover').on('dragover','.drop-area',function(e){e.preventDefault();});this.$wrap.off('dragenter').on('dragenter','.drop-area',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});this.$wrap.off('dragleave').on('dragleave','.drop-area',function(e){$(e.target).removeClass('on');e.stopPropagation();});this.$wrap.off('drop').on('drop','.drop-area',function(e){_this.onDropActionPerformed(e);});},onDropActionPerformed:function(e){var _this=this;var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');_this._setField('droparea',$target,itemId);e.stopPropagation();},setOptions:function(options){this.options=$.extend({},this.options,options);}};return ModalConfig;}(jQuery));var modalConfigurePane=(function(){var _this;function modalConfigurePane(container,screen,modalType){_this=this;this.container=container;this.screen=screen;this.modalType=modalType;this.templateObj=undefined;this.optionType=undefined;this.option=undefined;this.dataLose=undefined;this.editorData=undefined;this.ue=undefined;this.UILoadPromise=undefined;}
modalConfigurePane.prototype={show:function(){this.UILoadPromise=WebAPI.get("/static/views/observer/widgets/modalConfigurePane.html").done(function(resultHtml){_this.container.innerHTML+=resultHtml;if(_this.modalType=="dataAnalysis"){document.getElementById('startConfig').setAttribute('i18n','modalConfig.btnStartConfig.TYPE1');}else if(_this.modalType=="dashboard"){document.getElementById('startConfig').setAttribute('i18n','modalConfig.btnStartConfig.TYPE2');}
I18n.fillArea($('#modalConfig'));});},showModalInit:function(optionType,option,templateObj){this.optionType=optionType;this.option=option;this.templateObj=templateObj;if(this.UILoadPromise&&this.UILoadPromise.state()==='pending'){}else{this.UILoadPromise=$.Deferred().resolve();}
this.UILoadPromise.done(function(){this.init();if(_this.option.templateType=="ModalNote"){_this.initEditor();}
$('#modalConfig').modal('show');}.bind(this));},init:function(){var $modalConfig=$('#modalConfig');var $inputRealTimeInterval=$('#inputRealTimeInterval')
var $labelText=$('#divRealTimeInterval label');var $option30s=$('#inputRealTimeInterval option[value = "30s"]');var $option10m=$('#inputRealTimeInterval option[value = "10m"]');var $option30m=$('#inputRealTimeInterval option[value = "30m"]');var $optionh1=$('#inputRealTimeInterval option[value = "h1"]');var $optiond1=$('#inputRealTimeInterval option[value = "d1"]');var $optionM1=$('#inputRealTimeInterval option[value = "M1"]');$modalConfig.off('show.bs.modal').on('show.bs.modal',function(e){if(e.namespace!=='bs.modal')return true;_this.initOption();_this.initConfigData();$('#inputAddGroup').click(function(e){$(e.target).focus();});if(_this.modalType=="dashboard"){_this.toggleDataSource(true);}
if(_this.templateObj instanceof ModalRealtimeLineOutdoor||_this.templateObj instanceof ModalRealtimeBarSub){if(!_this.templateObj.entity.modal.option){$inputRealTimeInterval.find('option[value= "m5"]').attr('selected',true);}else if(_this.templateObj.entity.modal.option.timeFormat){$inputRealTimeInterval.find('option[value='+_this.templateObj.entity.modal.option.timeFormat+']').attr('selected',true);}
$labelText.text(I18n.resource.modalConfig.option.LABEL_INTERVAL_ONE);$optionh1.show();$optiond1.show();$optionM1.show();$option30s.hide();$option10m.hide();$option30m.hide();}else{$labelText.text(I18n.resource.modalConfig.option.LABEL_REAL_TIME_INTERVAL_ONE);$optionh1.hide();$optiond1.hide();$optionM1.hide();$option30s.show();$option10m.show();$option30m.show();}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppGauge'){$('#modalConfig .modal-body>.row>div').css('display','none');if(!_this.templateObj.entity.modal.option||(_this.templateObj.entity.modal.option&&!_this.templateObj.entity.modal.option.guageBgColor)){$('.guageBgColor').html('<input type="color" value="#2F91E8" data-key="guageBgColor"/>');}
$('#divAppGauge').css('display','block');}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppHistory'){$('#modalConfig .modal-body>.row>div').css('display','none');$('#divAppHistory').css('display','block');}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppDiagRanking'){$('#modalConfig .modal-body>.row>div').css('display','none');$('.chartPointCog').css("pointer-events","none");$('#appDiagRank').css('display','block');}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&(_this.option.templateType==='ModalAPPMonthHistory'||_this.option.templateType==='ModalAppPie')){$('#modalConfig .modal-body>.row>div').css('display','none');}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalKpiOverview'){$('#modalConfig .modal-body>.row>div').css('display','none');$('.chartPointCog').css("pointer-events","none");}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalDataMonitorList'){$('#modalConfig .modal-body>.row>div').css('display','none');$('.chartPointCog').css("pointer-events","none");}});$modalConfig.off('shown.bs.modal').on('shown.bs.modal',function(){_this.initTime();_this.initDrag();_this.initConfigStart();});$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$modalConfig.find('#dataConfig').html('<div><span I18n="modalConfig.data.DATA_CONFIG_TITLE"></span></div>');I18n.fillArea($modalConfig.find('#dataConfig'));if(_this.modalType=="dashboard"){_this.toggleDataSource(false);}
$('#divChartPointCog').css('display','none');_this.dataLose=undefined;});},toggleDataSource:function(bool){var ele=$('#paneContent')[0];var colCount;if(!ele){return;}
colCount=ele.classList.contains('col-sm-10');if(bool&&colCount){ele=document.getElementById('rightCt');ele&&ele.click();}
if(!bool&&!colCount){ele=document.getElementById('rightCt');ele&&ele.click();}},initDataTypeWidth:function(ele){if(window.innerWidth>1200){if(ele.outerWidth()<ele.parent().outerWidth()/4){ele.addClass('col-lg-3');}else if(ele.outerWidth()<ele.parent().outerWidth()/2){ele.addClass('col-lg-6');}else if(ele.outerWidth()<ele.parent().outerWidth()*3/4){ele.addClass('col-lg-9');}else{ele.addClass('col-lg-12');}}else{if(ele.outerWidth()<ele.parent().outerWidth()/3){ele.addClass('col-xs-4');}else if(ele.outerWidth()<ele.parent().outerWidth()*2/3){ele.addClass('col-xs-8');}else{ele.addClass('col-xs-12');}}},initOption:function(){var $inputMode=$('#inputMode');var $divMode=$inputMode.parent();var $inputInterval=$('#inputInterval');var $divInterval=$inputInterval.parent();var $divInputGroupPeriod=$('#divInputGroupPeriod');var $divPeriod=$divInputGroupPeriod.parent();var $inputPeriodUnit=$('#inputPeriodUnit');var $inputPeriodValue=$('#inputPeriodValue');var $inputPeriodDropDown=$('#inputPeriodDropDown');var $divPeriodDropDown=$inputPeriodDropDown.parent();var $divInputGroupTimeRange=$('#divInputGroupTimeRange');var $divTimeRange=$divInputGroupTimeRange.parent();var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');var $gaugeMode=$('#gaugeMode');var $divGaugeMode=$gaugeMode.parent();var $divGauge=$('#divGauge');var $gaugeLowerLimit=$('#gaugeLowerLimit');var $gaugeUpperLimit=$('#gaugeUpperLimit');var $normalLowerLimit=$('#normalLowerLimit');var $normalUpperLimit=$('#normalUpperLimit');var $inputComparePeriod=$('#inputComparePeriod');var $divComparePeriod=$inputComparePeriod.parent();var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');var $divCompareDate=$('#divCompareDate');var $inputRealTimeInterval=$('#inputRealTimeInterval');var $divRealTimeInterval=$inputRealTimeInterval.parent();var $divHistoryRange=$('#divHistoryRange');var $inputHistoryRange=$('#inputHistoryRange');var $divChartSelect=$('#divChartSelect');var $divAppHistory=$("#divAppHistory");var i;var totalModeType={easy:[$divPeriodDropDown],fixed:[$divInterval,$divTimeRange],recent:[$divInterval,$divPeriod],realTime:[],easyEnergy:[$divPeriodDropDown],realTimeDashboard:[$divRealTimeInterval],easyCompareAnalyz:[$divCompareDate],easyCompare:[$divComparePeriod],easyCompareToggle:[$divComparePeriod,$divChartSelect],compareSensor:[$divInterval,$divComparePeriod,$divCompareDate],compareMeter:[$divInterval,$divComparePeriod,$divCompareDate],gauge:[$divGauge,$divGaugeMode],weather:[],easyHistory:[$divHistoryRange],easyHistorySelect:[$divHistoryRange,$divChartSelect],multiple:[$divRealTimeInterval],modalRankNormal:[$divPeriodDropDown]};var $dataConfig=$('#dataConfig');var $startConfig=$('#startConfig');$dataConfig.css('display','block');$startConfig.removeClass('alwaysEnable');$inputMode.children().css('display','none');var modeSelectInit=false;if(_this.option.modeUsable&&_this.option.modeUsable[0]&&(_this.option.templateType==='ModalAppGauge'||_this.option.templateType==='ModalAppPie'||_this.option.templateType==='ModalAppDiagRanking'||_this.option.templateType==='ModalAPPMonthHistory'||_this.option.templateType==='ModalKpiOverview'||_this.option.templateType==='ModalDataMonitorList')){return;}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppHistory'){$divAppHistory.css('display','block');var startTime=new Date().format("yyyy-MM-dd 00:00:00");var endTime=new Date().format("yyyy-MM-dd HH:mm:ss");$divAppHistory.find("#startTime").val(startTime);$divAppHistory.find("#endTime").val(endTime);var modalOption=_this.templateObj.entity.modal.option;return;}
for(i=0;i<_this.option.modeUsable.length;i++){$inputMode.children('option[value='+_this.option.modeUsable[i]+']').css('display','block');if(_this.optionType){if(sessionStorage.getItem('mode')==_this.option.modeUsable[i]&&!modeSelectInit){$inputMode.val(_this.option.modeUsable[i]);modeSelectInit=true;}}else{if(_this.option.modeUsable[i]=='fixed'&&!modeSelectInit){$inputMode.val('fixed');modeSelectInit=true;}}}
if(!modeSelectInit){$inputMode.val(_this.option.modeUsable[0]);}
function initMode(mode){sessionStorage.setItem('mode',$inputMode.val());$divMode.siblings().css('display','none');$inputInterval.children().removeClass('forbid');for(var i=0;i<totalModeType[mode].length;i++){totalModeType[mode][i].css('display','block');}
switch(mode){case'easy':initPeriodDropDown(mode);initInterval(mode);break;case'recent':initInterval(mode);break;case'easyEnergy':initPeriodDropDown(mode);initInterval(mode);break;case'weather':$dataConfig.css('display','none');$startConfig.addClass('alwaysEnable');break;case'easyCompareAnalyz':$inputComparePeriod.val('month');break;case'easyCompare':case'easyCompareToggle':$inputComparePeriod.val('day');break;default:break;}}
if(this.optionType){if(sessionStorage.getItem('interval')!=null){if($inputInterval.children('option[value="'+sessionStorage.getItem('interval')+'"]').hasClass('forbid')){$inputInterval.val($inputInterval.children(':not(.forbid)').first());}else{$inputInterval.val(sessionStorage.getItem('interval'));}}else{sessionStorage.setItem('interval',$inputInterval.val());}}else{if(_this.option.optionPara.interval){$inputInterval.val(_this.option.optionPara.interval);}else{$inputInterval.val($inputInterval.children(':not(.forbid)').first());}
this.setTimePrecision($inputInterval.val(),$inputTimeStart,$inputTimeEnd);}
$inputInterval.off('change').change(function(e){sessionStorage.setItem('interval',$(e.target).val());_this.setTimePrecision(this.value,$inputTimeStart,$inputTimeEnd)});function initInterval(mode){$inputInterval.children().addClass('forbid');if(mode=='recent'){switch($inputPeriodUnit.children(':selected').val()){case'second':firstSelect='m5';secondSelect='m1';break;case'minute':firstSelect='m5';secondSelect='m1';break;case'hour':firstSelect='h1';secondSelect='m5';break;case'day':firstSelect='d1';secondSelect='h1';break;case'month':firstSelect='M1';secondSelect='d1';break;}
$inputInterval.find('option[value="'+secondSelect+'"]').removeClass('forbid');}
if(mode=='easy'){switch($inputPeriodDropDown.val()){case'today':firstSelect='h1';break;case'yesterday':firstSelect='h1';break;case'thisWeek':firstSelect='d1';break;case'lastWeek':firstSelect='d1';break;case'thisYear':firstSelect='M1';break;}}
$inputInterval.find('option[value="'+firstSelect+'"]').removeClass('forbid').attr('selected',true);sessionStorage.setItem('interval',$inputInterval.val());}
var firstSelect,secondSelect;if(this.optionType){if(sessionStorage.getItem('periodValue')){$inputPeriodValue.val(sessionStorage.getItem('periodValue'));}
if(sessionStorage.getItem('periodUnit')){$inputPeriodUnit.val(sessionStorage.getItem('periodUnit'));}
if(sessionStorage.getItem('periodDropDown')){if($inputPeriodDropDown.children('option[value="'+sessionStorage.getItem('periodDropDown')+'"]').hasClass('forbid')){$inputPeriodDropDown.val($inputPeriodDropDown.children(':not(.forbid)').first());}
$inputPeriodDropDown.val(sessionStorage.getItem('periodDropDown'));}}
$inputPeriodValue.off('change').change(function(e){sessionStorage.setItem('periodValue',e.target.value)});$inputPeriodUnit.off('change').change(function(e){sessionStorage.setItem('periodUnit',e.target.value);initInterval($inputMode.val());});$divPeriodDropDown.off('change').change(function(e){sessionStorage.setItem('periodDropDown',e.target.value);initInterval($inputMode.val());});function initPeriodDropDown(mode){$inputPeriodDropDown.children('').removeClass('forbid');if(mode=='easy'){$inputPeriodDropDown.children().eq(1).addClass('forbid');}else if(mode=='easyEnergy'){$inputPeriodDropDown.children().eq(2).addClass('forbid');$inputPeriodDropDown.children().eq(4).addClass('forbid');$inputPeriodDropDown.children().eq(5).addClass('forbid');}}
if(_this.optionType&&sessionStorage.getItem('anlzTimeStart')!=null){$inputTimeStart.val(sessionStorage.getItem('anlzTimeStart'));$inputCompareDate1.val(sessionStorage.getItem('anlzTimeStart'));}else{$inputTimeStart.val(new Date(_this.option.optionPara.startTime).format(_this.getDateFmtByInputFmt($inputTimeStart[0].dataset.format)));$inputCompareDate1.val(new Date(_this.option.optionPara.startTime).format(_this.getDateFmtByInputFmt($inputCompareDate1[0].dataset.format)));}
$inputTimeStart.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeStart',e.target.value)}});$inputCompareDate1.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeStart',e.target.value)}});if(_this.optionType&&sessionStorage.getItem('anlzTimeEnd')!=null){$inputTimeEnd.val(sessionStorage.getItem('anlzTimeEnd'));$inputCompareDate2.val(sessionStorage.getItem('anlzTimeEnd'));}else{$inputTimeEnd.val(new Date(_this.option.optionPara.endTime).format(_this.getDateFmtByInputFmt($inputTimeEnd[0].dataset.format)));$inputCompareDate2.val(new Date(_this.option.optionPara.endTime).format(_this.getDateFmtByInputFmt($inputCompareDate2[0].dataset.format)));}
$inputTimeEnd.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeEnd',e.target.value)}});$inputCompareDate2.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeEnd',e.target.value)}});if(_this.option.optionPara.timeType&&$inputMode.val()=='easyCompareAnalyz'){$inputComparePeriod.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('comparePeriodAnalyz')!=null){$inputComparePeriod.val(sessionStorage.getItem('comparePeriodAnalyz'));}
if(_this.option.optionPara.timeType&&($inputMode.val()=='easyCompare'||$inputMode.val()=='easyCompareToggle')){$inputComparePeriod.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('comparePeriod')!=null){$inputComparePeriod.val(sessionStorage.getItem('comparePeriod'));}
$inputComparePeriod.change(function(e){sessionStorage.setItem('comparePeriod',$inputComparePeriod.val());});if(sessionStorage.getItem('gaugeMode')!=null){$gaugeMode.val(sessionStorage.getItem('gaugeMode'))}
$gaugeMode.change(function(){sessionStorage.setItem('gaugeMode',$gaugeMode.val())});initGaugeMode();$gaugeMode.change(function(){initGaugeMode();});function initGaugeMode(){var green='<span class="input-group-addon gaugeGreen" i18n="modalConfig.option.GAUGE_GREEN"></span>';var red='<span class="input-group-addon gaugeRed" i18n="modalConfig.option.GAUGE_RED"></span>';if($gaugeMode.val()=='high'){$gaugeLowerLimit.next().remove();$gaugeLowerLimit.after(green);$normalUpperLimit.next().remove();$normalUpperLimit.after(red);}else if($gaugeMode.val()=='low'){$gaugeLowerLimit.next().remove();$gaugeLowerLimit.after(red);$normalUpperLimit.next().remove();$normalUpperLimit.after(green);}
I18n.fillArea($('#divGauge'));}
if(_this.option.optionPara.scaleList){_this.option.optionPara.scaleList.sort(function(a,b){return a>b?1:-1});}
if(_this.optionType&&sessionStorage.getItem('gaugeLowerLimit')!=null){$gaugeLowerLimit.val(sessionStorage.getItem('gaugeLowerLimit'))}else if(!_this.optionType&&_this.option.optionPara.scaleList){$gaugeLowerLimit.val(_this.option.optionPara.scaleList[0])}
$gaugeLowerLimit.change(function(){sessionStorage.setItem('gaugeLowerLimit',$gaugeLowerLimit.val())});if(_this.optionType&&sessionStorage.getItem('gaugeUpperLimit')!=null){$gaugeUpperLimit.val(sessionStorage.getItem('gaugeUpperLimit'))}else if(!_this.optionType&&_this.option.optionPara.scaleList){$gaugeUpperLimit.val(_this.option.optionPara.scaleList[3])}
$gaugeUpperLimit.change(function(){sessionStorage.setItem('gaugeUpperLimit',$gaugeUpperLimit.val())});if(_this.optionType&&sessionStorage.getItem('normalLowerLimit')!=null){$normalLowerLimit.val(sessionStorage.getItem('normalLowerLimit'))}else if(!_this.optionType&&_this.option.optionPara.scaleList){$normalLowerLimit.val(_this.option.optionPara.scaleList[1])}
$normalLowerLimit.change(function(){sessionStorage.setItem('normalLowerLimit',$normalLowerLimit.val())});if(_this.optionType&&sessionStorage.getItem('normalUpperLimit')!=null){$normalUpperLimit.val(sessionStorage.getItem('normalUpperLimit'))}else if(!_this.optionType&&_this.option.optionPara.scaleList){$normalUpperLimit.val(_this.option.optionPara.scaleList[2])}
$normalUpperLimit.change(function(){sessionStorage.setItem('normalUpperLimit',$normalUpperLimit.val())});if(_this.option.optionPara.timeType&&($inputMode.val()=='realTimeDashboard'||$inputMode.val()=='multiple')){$inputHistoryRange.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('historyRange')!=null){$inputHistoryRange.val(sessionStorage.getItem('historyRange'));}
$inputHistoryRange.change(function(){sessionStorage.setItem('historyRange',$inputHistoryRange.val());});if(_this.option.optionPara.timeType&&($inputMode.val()=='easyHistory'||$inputMode.val()=='easyHistorySelect')){$inputHistoryRange.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('historyRange')!=null){$inputHistoryRange.val(sessionStorage.getItem('historyRange'));}
$inputHistoryRange.change(function(){sessionStorage.setItem('historyRange',$inputHistoryRange.val());});initMode($inputMode.val());$inputMode.change(function(e){initMode($inputMode.val())});if('AnlzTendency'==this.option.templateType){$('#dataConfig').css('height','100%');$('#modifyChart').show();if(this.optionType){$('#modifyChartTitle').val('');$('#modifyChartYMax').val('');$('#modifyChartYMin').val('');$('#modifyChartYMark').val('');$('#modifyChartYUnitName').val('');$('#modifyChartYUnitEx')[0].selectedIndex=0;}
else{var opt=_this.screen.curModal.chartOption;if(opt){$('#modifyChartTitle').val(opt.chartName);$('#modifyChartYMax').val(opt.yMax);$('#modifyChartYMin').val(opt.yMin);$('#modifyChartYMark').val(opt.yMark);var yUnit=opt.yUnit;var flag=' ';var index=yUnit.indexOf(flag);$('#modifyChartYUnitName').val(yUnit.substr(0,index));if(yUnit.substr(index+1)){$('#modifyChartYUnitEx').val(yUnit.substr(index+1));}else{$('#modifyChartYUnitEx')[0].selectedIndex=0;}}}}
else{$('#dataConfig').css('height','350px');$('#modifyChart').hide();}
$('#modifyChart .anlsModifyCobfig').off('click').click(function(){if($('#modifyChart .row').is(':visible')){$('#modifyChart .row').hide();}else{$('#modifyChart .row').show();}});},initConfigData:function(){var $dataConfig=$('#dataConfig');var $divAppGauge=$('#divAppGauge');var $appDiagRank=$('#appDiagRank');$dataConfig.html('<div><span I18n="modalConfig.data.DATA_CONFIG_TITLE"></span></div>');var strConfigModalBody=$dataConfig.html();var strDataTypeShowName=[];if(_this.option.rowDataTypeShowName){for(var i=0;i<_this.option.rowDataType.length;++i){strDataTypeShowName.push(_this.option.rowDataTypeShowName[_this.option.rowDataType[i]])}}else{strDataTypeShowName=_this.option.rowDataType;}
for(var i=0;i<_this.option.rowDataType.length;++i){strConfigModalBody+='<div class="divConfigData" dataType="'+_this.option.rowDataType[i]+'">\
                                                <div class="dataTypeName">'+
strDataTypeShowName[i]+'</div>\
                                                <span class="chartPointCog glyphicon glyphicon-cog grow"></span>\
                                                <div class="row rowDataValue"><div class="dataDragTip col-lg-3 col-xs-4"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></div></div>\
                                    </div>';}
$dataConfig.html(strConfigModalBody);if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppDiagRanking'){$appDiagRank.css('display','block');var rankType;if(_this.templateObj.entity.modal.option){rankType=_this.templateObj.entity.modal.option.diagType?_this.templateObj.entity.modal.option.diagType:'fault';}else{rankType='fault';}
$('#appDiagRank').find('select').val(rankType);}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppGauge'){$divAppGauge.css('display','block');var modalOption=_this.templateObj.entity.modal.option;var gaugeTitleVal=modalOption?modalOption.guageTitle:'';$('#appGuageTitle').val(gaugeTitleVal);$('#appGuageFulTitle').val(modalOption?modalOption.guageFulTitle:'');$('#appGuageDot').val(modalOption?modalOption.guageFixed:'');$('#appGuageUnit').val(modalOption?modalOption.guageUnit:'');var guageText=modalOption?modalOption.timeLocal:'';$('.timeDirectSelect').find('option[value="'+guageText+'"]').attr("selected",true);var guageDSelect=modalOption?modalOption.guageDirect:'';$('.GuageDirectSelect').find('option[value="'+guageDSelect+'"]').attr("selected",true);var bgColor=modalOption?modalOption.guageBgColor:'';if(bgColor){$('.guageBgColor').html('<input type="color" value="'+bgColor+'" data-key="guageBgColor"/>');}
$('#guageBgColor').val()
$('#appDataDot').val(modalOption?modalOption.transDataDot:'')}
var btnStartConfigEnable;for(i=0;i<_this.option.optionPara.dataItem.length;++i){var $dataDragTip=$dataConfig.find('[dataType="'+_this.option.optionPara.dataItem[i].dsType+'"]').find('.dataDragTip');if($dataDragTip.length==0){$dataDragTip=$('.dataDragTip').eq(i);}
var strDSConfig;var loseJudge;for(var j=0;j<_this.option.optionPara.dataItem[i].dsId.length;++j){loseJudge="ptExist";if(_this.option.optionPara.dataItem[i].dsName[j]==undefined){_this.option.optionPara.dataItem[i].dsName[j]=I18n.resource.modalConfig.data.DATA_LOSE;_this.dataLose=true;loseJudge="ptLose";}
strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow '+loseJudge+'" dsid="'+_this.option.optionPara.dataItem[i].dsId[j]+'"><span class="contentDS" title="'+_this.option.optionPara.dataItem[i].dsName[j]+'">'+
_this.option.optionPara.dataItem[i].dsName[j]+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig);btnStartConfigEnable=true;}}
if(_this.modalType=="dataAnalysis"||_this.option.templateType==='ModalAppGauge'||_this.option.templateType==='ModalAppPie'||_this.option.templateType==='ModalAppHistory'||_this.option.templateType==='ModalAppDiagRanking'||_this.option.templateType==='ModalAPPMonthHistory'||_this.option.templateType==='ModalKpiOverview'||_this.option.templateType==='ModalDataMonitorList'){$('.chartPointCog').css('display','none');}else if(_this.modalType=="dashboard"){$('.chartPointCog').css('display','');}
$dataConfig.off('click').on('click','.chartPointCog',function(e){$('#divChartPointCog').css('display','block');_this.initChartPtCog($('.chartPointCog').index($(e.target)))});if(_this.dataLose){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE11+"</strong>").show().close();}
initDataTipAndButton();$('.alwaysEnable').removeClass('disabled');$('.divDSConfigure span').on('click',function(e){var $thisPar=$(e.target).parent();$thisPar.remove();if($('.ptLose').length==0){_this.dataLose=false;}
initDataTipAndButton();$('#dataConfig').css('height','100%');});function initDataTipAndButton(){var NumOfDataTypeWithValue=0;var $rowDataValue=$('.rowDataValue');for(var i=0;i<$rowDataValue.length;++i){if($rowDataValue.eq(i).children().length>1){NumOfDataTypeWithValue+=1;}}
if(_this.option.allDataNeed==true){if(NumOfDataTypeWithValue==$rowDataValue.length){$('#startConfig').removeClass('disabled');}else{$('#startConfig').addClass('disabled');}}else{if(NumOfDataTypeWithValue){$('#startConfig').removeClass('disabled');}else{$('#startConfig').addClass('disabled');}}
if(_this.dataLose){$('#startConfig').addClass('disabled');}
if(_this.templateObj&&_this.templateObj.entity.modal.type=='ModalNote'){$('#startConfig').removeClass('disabled');}}
_this.renderEditor();},initChartPtCog:function(index){var $inputUpper=$('#inputPtValUpper');var $inputLower=$('#inputPtValLower');var $inputUnit=$('#inputPtUnit');var $inputAccuracy=$('#inputPtAccuracy');var $inputLineVal1=$('#inputLineVal1');var $inputLineName1=$('#inputLineName1');var $inputLineVal2=$('#inputLineVal2');var $inputLineName2=$('#inputLineName2');var $inputLineVal3=$('#inputLineVal3');var $inputLineName3=$('#inputLineName3');var $inputLineVal4=$('#inputLineVal4');var $inputLineName4=$('#inputLineName4');var $inputLineNameTotal=$('.inputLineName');var $inputLineValTotal=$('.inputLineVal');if(_this.option.dsChartCog&&_this.option.dsChartCog[index]){$inputUpper.val(_this.option.dsChartCog[index].upper);$inputLower.val(_this.option.dsChartCog[index].lower);$inputUnit.val(_this.option.dsChartCog[index].unit);$inputAccuracy.val(_this.option.dsChartCog[index].accuracy);for(var i=0;i<4;i++){$inputLineNameTotal.eq(i).val(_this.option.dsChartCog[index].markLine[i].name);$inputLineValTotal.eq(i).val(_this.option.dsChartCog[index].markLine[i].value);}}else{$('#divChartPointCog').find('input').val('');}
$('#btnPtCogSure').off('click').click(function(){if(!_this.option.dsChartCog){_this.option.dsChartCog=[];for(var i=0;i<_this.option.rowDataType.length;++i){_this.option.dsChartCog[i]={};_this.option.dsChartCog[i].markLine=[{},{},{},{}];}}
if(isNaN(Number($inputUpper.val()))||isNaN(Number($inputLower.val()))||isNaN(Number($inputAccuracy.val()))||isNaN(Number($inputLineVal1.val()))||isNaN(Number($inputLineVal2.val()))||isNaN(Number($inputLineVal3.val()))||isNaN(Number($inputLineVal4.val()))){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE10+"</strong>").show().close();return;}
if($inputUpper.val()!=''&&$inputLower.val()!=''&&Number($inputUpper.val())<Number($inputLower.val())){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE12+"</strong>").show().close();return;}
_this.option.dsChartCog[index].upper=$inputUpper.val();_this.option.dsChartCog[index].lower=$inputLower.val();_this.option.dsChartCog[index].unit=$inputUnit.val();_this.option.dsChartCog[index].accuracy=$inputAccuracy.val();for(var i=0;i<4;++i){if(!_this.option.dsChartCog[index].markLine[i]){_this.option.dsChartCog[index].markLine[i]={}}
_this.option.dsChartCog[index].markLine[i].value=$inputLineValTotal.eq(i).val();_this.option.dsChartCog[index].markLine[i].name=$inputLineNameTotal.eq(i).val();}
$('#divChartPointCog').css('display','none');});$('#btnPtCogCancel').off('click').click(function(){$inputUpper.val('');$inputLower.val('');$inputUnit.val('');$inputAccuracy.val('');$('#divChartPointCog').css('display','none');});$('#btnPtCogRemove').off('click').click(function(){$inputUpper.val('');$inputLower.val('');$inputUnit.val('');$inputAccuracy.val('');$('#divChartPointCog').css('display','none');});},initTime:function(){var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');$inputTimeStart.datetimepicker('remove');$inputTimeStart.datetime();$inputTimeEnd.datetimepicker('remove');$inputTimeEnd.datetime();var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');$inputCompareDate1.datetimepicker('remove');$inputCompareDate2.datetimepicker('remove');$inputCompareDate1.datetime();$inputCompareDate2.datetime();if(_this.optionType){var now=new Date();var time=new Date(now-259200000).format('yyyy-MM-dd HH:mm');var initCompareDate1=new Date(now.getFullYear(),now.getMonth()-2).format('yyyy-MM-dd HH:mm');var initCompareDate2=new Date(now.getFullYear(),now.getMonth()-1).format('yyyy-MM-dd HH:mm');if(!sessionStorage.getItem('anlzTimeStart')){$inputTimeStart.val(time);$inputCompareDate1.val(initCompareDate1)}
now=now.format('yyyy-MM-dd HH:mm');if(!sessionStorage.getItem('anlzTimeEnd')){$inputTimeEnd.val(now);$inputCompareDate2.val(initCompareDate2)}}},initDrag:function(){var $divConfigData=$('.divConfigData');var $btnConfigStart=$('#startConfig');var _this=this;$divConfigData.on('dragover',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');});$divConfigData.on('dragleave',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');});var targetId,targetContent;var initBtnStartEnable;var initDragTipShow=[];var index;$divConfigData.on('drop',function(e,arg){$('.addData').removeClass('addData');var $note=$('#noteEditor');if(!$note.is(':hidden')&&!arg){return;}
if(_this.option.templateType==="ModalAPPMonthHistory"||_this.option.templateType==="ModalAppDiagRanking"||_this.option.templateType==="ModalDataMonitorList"){var dsItemLength=$(e.currentTarget).find(".rowDataValue>div").length;if(dsItemLength===2){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE13+"</strong>").show().close();return;}}
index=$(e.currentTarget).index()-1;var $rowTempData=$(e.currentTarget).find('.rowDataValue');var $dataDragTip=$rowTempData.find('.dataDragTip');targetId=EventAdapter.getData().dsItemId;if(!targetId)return;if(Object.prototype.toString.call(targetId)==='[object Array]'){var len=targetId.length;var isContainue=false;for(var i=0;i<len;i++){if($rowTempData.find('.divDSConfigure[dsid="'+targetId[i]+'"]').length>0){targetId.splice(i,i+1);len=len-1;i=i-1;}else{targetContent=AppConfig.datasource.getDSItemById(targetId[i]).alias;var strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow" dsid="'+targetId[i]+'"><span class="contentDS" title="'+targetContent+'">'+
targetContent+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig);}}
if(targetId.length<1){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE2+"</strong>").show().close();}else{$('#startConfig').removeClass('disabled');}}else{var info=AppConfig.datasource.getDSItemById(targetId);targetContent=info.alias===""?info.value:info.alias;if($rowTempData.find('.divDSConfigure[dsid="'+targetId+'"]').length>0){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE2+"</strong>").show().close();return;}
var strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow" dsid="'+targetId+'"><span class="contentDS" title="'+targetContent+'">'+
targetContent+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig);$('#startConfig').removeClass('disabled');}
initBtnStartAndDragTip(index);$(e.currentTarget).find('.divDSConfigure span').off('click').on('click',function(e){var $thisPar=$(e.target).parent();var dsid=$thisPar.attr('dsid');$thisPar.remove();if($('.ptLose').length==0){_this.dataLose=false;}
initBtnStartAndDragTip(index);var $dataConfig=$('#dataConfig');$dataConfig.css('height','100%');});var $dataConfig=$('#dataConfig');if('AnlzTendency'!=_this.option.templateType){$dataConfig.height('');}
if($dataConfig.height()>window.innerHeight-80){$dataConfig.css('height','100%');}
if(!$note.is(':hidden')&&arg){if(Object.prototype.toString.call(targetId)==='[object Array]'){var len=targetId.length;for(var i=0;i<len;i++){targetContent=AppConfig.datasource.getDSItemById(targetId[i]).alias;var format='&nbsp;<span id = "'+targetId[i]+'" contenteditable="false" class="pointValue" title="'+targetContent+'"><%'+targetContent+'%></span>&nbsp;';insertHtmlAtCaret(format,targetId[i]);}}else{var format='&nbsp;<span id = "'+targetId+'" contenteditable="false" class="pointValue" title="'+targetContent+'"><%'+targetContent+'%></span>&nbsp;';insertHtmlAtCaret(format,targetId);}
function insertHtmlAtCaret(html,targetId){var sel,range;var iframeWin=_this.ue.window;if(iframeWin.getSelection){sel=iframeWin.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var el=document.createElement("div");el.innerHTML=html;var frag=document.createDocumentFragment(),node,lastNode;while((node=el.firstChild)){lastNode=frag.appendChild(node);}
range.insertNode(frag);if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range);}
$(iframeWin.document).find('#'+targetId)[0].addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);$(iframeWin.document).find('#'+targetId).off('click').on('click',function(e){_this.initNotePtCfg($(iframeWin.document).find('.pointValue').index($(e.target)));});}}}}});function initBtnStartAndDragTip(indexOfDataType){var tempDivDS=$divConfigData.find('.rowDataValue').eq(indexOfDataType).children();if(_this.option.allDataNeed==true){initBtnStartEnable=true;for(var i=0;i<$divConfigData.length;++i){if($divConfigData.find('.rowDataValue').eq(i).children().length<=1){initBtnStartEnable=false;break;}}
if(tempDivDS.length>1){}else{initBtnStartEnable-=1;initDragTipShow[indexOfDataType]=true;}}else{if($divConfigData.find('.divDSConfigure').length>0){initBtnStartEnable=true;}else{initBtnStartEnable=false;}}
if(initBtnStartEnable>0){$btnConfigStart.removeClass('disabled');}else{$btnConfigStart.addClass('disabled');}
if(_this.dataLose){$btnConfigStart.addClass('disabled');}}},initConfigStart:function(){var $modalConfig=$('#modalConfig');var $inputModal=$('#inputMode');document.getElementById('startConfig').onclick=function(){if($(this).hasClass('disabled'))return;var tempStartTime,tempEndTime,tempPeriodTime;var tempInterval=0;var $inputPeriodValue=$('#inputPeriodValue');var periodValue=$inputPeriodValue.val();var tempDSId,tempDS,arrItemDS=[];var $rowDataValue=$('.rowDataValue');var $inputInterval=$('#inputInterval');var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');var $inputPeriodUnit=$('#inputPeriodUnit');var $inputPeriodDropDown=$('#inputPeriodDropDown');var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');var $inputComparePeriod=$('#inputComparePeriod');var $gaugeMode=$('#gaugeMode');var $gaugeLowerLimit=$('#gaugeLowerLimit');var $gaugeUpperLimit=$('#gaugeUpperLimit');var $normalLowerLimit=$('#normalLowerLimit');var $normalUpperLimit=$('#normalUpperLimit');var $inputRealTimeInterval=$('#inputRealTimeInterval');var $optionSelescted=$('#inputRealTimeInterval option:selected').val();var $inputHistoryRange=$('#inputHistoryRange');var timeType,scaleList;var now;for(var i=0;i<$rowDataValue.length;++i){tempDS={};tempDS.type=$rowDataValue[i].parentNode.getAttribute('dataType');tempDSId=[];for(var j=0;j<$rowDataValue[i].children.length-1;++j){tempDSId.push($rowDataValue[i].children[j].getAttribute('dsid'));}
tempDS.arrId=tempDSId;arrItemDS.push(tempDS);}
var totalModeType={easy:'easy',fixed:'fixed',recent:'recent',realTime:'realTime',easyCompareAnalyz:'easyCompareAnalyz',easyCompare:'easyCompare',easyCompareToggle:'easyCompareToggle',compareSensor:'compareSensor',compareMeter:'compareMeter',realTimeDashboard:"realTimeDashboard",gauge:'gauge',weather:'weather',easyHistory:"easyHistory",easyHistorySelect:"easyHistorySelect",multiple:'multiple'};switch($inputModal.val()){case totalModeType['fixed']:tempStartTime=$inputTimeStart.val().toDate().format('yyyy-MM-dd HH:mm');tempEndTime=$inputTimeEnd.val().toDate().format('yyyy-MM-dd HH:mm');if(tempStartTime.toDate()>=tempEndTime.toDate()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE3+"</strong>").show().close();return;}
if(tempEndTime.toDate()>=new Date()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE4+"</strong>").show().close();return;}
break;case totalModeType['recent']:tempEndTime=new Date().format('yyyy-MM-dd HH:mm:ss');switch($inputPeriodUnit.val()){case'hour':tempPeriodTime=periodValue*3600000;break;case'day':tempPeriodTime=periodValue*86400000;break;case'month':tempPeriodTime=periodValue*2592000000;break;case'year':tempPeriodTime=periodValue*31536000000;break;}
now=new Date();tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case totalModeType['realTime']:tempStartTime='';tempEndTime='';break;case totalModeType['easy']:now=new Date();switch($inputPeriodDropDown.val()){case'today':tempPeriodTime=86400000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case'yesterday':var yesterday=new Date();yesterday=new Date(yesterday.setDate(yesterday.getDate()-1));tempEndTime=new Date(getTimeOfMidnightZero(now).getTime()-1000).format('yyyy-MM-dd HH:mm:ss');tempStartTime=getTimeOfMidnightZero(yesterday).format('yyyy-MM-dd HH:mm:ss');break;case'thisWeek':tempPeriodTime=604800000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case'lastWeek':tempPeriodTime=604800000;tempEndTime=getTimeOfMidnightZero(new Date(now-(now.getDay()+1)*86400000)).format('yyyy-MM-dd HH:mm:ss');tempStartTime=getTimeOfMidnightZero(new Date(now-(now.getDay()+7)*86400000)).format('yyyy-MM-dd HH:mm:ss');break;case'thisYear':tempPeriodTime=31536000000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;}
break;case totalModeType['realTimeDashboard']:tempStartTime='';tempEndTime='';tempInterval=$inputRealTimeInterval.val();timeType=$inputRealTimeInterval.val();break;case totalModeType['multiple']:tempStartTime='';tempEndTime='';tempInterval=$inputInterval.val();timeType=$inputRealTimeInterval.val();var paraType=arrItemDS;break;case totalModeType['easyCompareAnalyz']:tempPeriodTime='month';$inputInterval.val('d1');timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['easyCompare']:tempPeriodTime='month';$inputInterval.val('d1');timeType=$inputComparePeriod.val();break;case totalModeType['easyCompareToggle']:tempPeriodTime='month';$inputInterval.val('d1');timeType=$inputComparePeriod.val();var chartType=$('#inputChartSelect').val();break;case totalModeType['compareSensor']:tempPeriodTime=$inputComparePeriod.val();timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['compareMeter']:tempPeriodTime=$inputComparePeriod.val();timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['gauge']:if($gaugeMode.val()=='high'){scaleList=[$gaugeLowerLimit.val(),$normalLowerLimit.val(),$normalUpperLimit.val(),$gaugeUpperLimit.val()];}else{scaleList=[$gaugeUpperLimit.val(),$normalUpperLimit.val(),$normalLowerLimit.val(),$gaugeLowerLimit.val()];}
for(i=0;i<scaleList.length;i++){if(isNaN(Number(scaleList[i]))){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE10+"</strong>").show().close();return;}
scaleList[i]=parseFloat(scaleList[i]);}
var tempArr=scaleList.concat();if($gaugeMode.val()=='high'){tempArr.sort(function(a,b){return a>b?1:-1});}else{tempArr.sort(function(a,b){return a<b?1:-1});}
if(tempArr.toString()!=scaleList.toString()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE5+"</strong>").show().close();return;}
break;case totalModeType['weather']:tempStartTime='';tempEndTime='';break;case totalModeType['easyHistory']:timeType=$inputHistoryRange.val();break;case totalModeType['easyHistorySelect']:timeType=$inputHistoryRange.val();var chartType=$('#inputChartSelect').val();break;default:break;}
function initCompareTime(period,time){var startTime;switch(period){case'hour':startTime=time.toDate().format('yyyy-MM-dd HH')+':00:00';break;case'day':startTime=time.toDate().format('yyyy-MM-dd')+' 00:00:00';break;case'week':var weekDay=time.toDate().getDay();var date=time.toDate().getDate();startTime=new Date(time.toDate().setDate(date-weekDay+1)).format('yyyy-MM-dd')+' 00:00:00';break;case'month':startTime=time.toDate().format('yyyy-MM')+'-01 00:00:00';break;default:break;}
return startTime;}
function getTimeOfMidnightZero(date){var tempDate;if(date){tempDate=date}else{tempDate=new Date();}
return(date.format('yyyy-MM-dd')+' 00:00:00').toDate();}
if(_this.modalType=="dataAnalysis"){if(_this.optionType){_this.screen.curModal={startTime:tempStartTime,endTime:tempEndTime,format:$inputInterval.val(),mode:$inputModal.val(),type:_this.option.templateType,itemDS:arrItemDS,comparePeriod:tempPeriodTime,dsChartCog:_this.option.dsChartCog,noteList:[],graphList:[]};}else{_this.screen.curModal={startTime:tempStartTime,endTime:tempEndTime,format:$inputInterval.val(),mode:$inputModal.val(),type:_this.option.templateType,itemDS:arrItemDS,comparePeriod:tempPeriodTime,dsChartCog:_this.option.dsChartCog,noteList:_this.screen.curModal.noteList,graphList:_this.screen.curModal.graphList};}}else if(_this.modalType=="dashboard"){_this.templateObj.entity.modal.option={timeFormat:$optionSelescted};_this.templateObj.configParams={};var $divDSConfigure=$('.divDSConfigure');_this.templateObj.entity.modal.title=$('.springSel .chartTitle input').val();_this.templateObj.entity.modal.points=[];_this.templateObj.entity.modal.StartTime=tempStartTime;_this.templateObj.entity.modal.EndTime=tempEndTime;_this.templateObj.entity.modal.dsChartCog=_this.option.dsChartCog;if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppGauge'){var appGuageList={};var guageTitle=$('#appGuageTitle').val().trim();var guageFulTitle=$('#appGuageFulTitle').val().trim();var guageFixed=$('#appGuageDot').val().trim();var guageUnit=$('#appGuageUnit').val().trim();var timeLocal=$('.timeDirectSelect').val();var guageDirect=$('.GuageDirectSelect').val();var guageBgColor=$('.guageBgColor').find('input').val();var transDataDot=$('#appDataDot').val().trim();if(guageFixed!==''&&!(/^(0|[1-9]\d*)$/.test(guageFixed))){alert('请输入非负整数！');return;}
if(parseInt(transDataDot)<0||parseInt(transDataDot)>1){alert('请输入0-1之间的小数！');return;}}
if(_this.option.templateType==='ModalAppDiagRanking'){var diagType=$('#appDiagRank').find('select.selecTDiagType').val()}
if(_this.option.modeUsable&&_this.option.modeUsable[0]&&_this.option.templateType==='ModalAppHistory'){var historyTitle=$('#appHistoryTitle').val();}
if(_this.templateObj.entity.modal.type=='ModalNote'){var $divModalTextSpan=$(_this.ue.body).find('.pointValue');_this.templateObj.entity.modal.modalText=_this.ue.getContent();for(var i=0;i<$divModalTextSpan.length;++i){_this.templateObj.entity.modal.points.push($divModalTextSpan.get(i).attributes['id'].value);}
_this.templateObj.entity.modal.modalTextUrl=_this.editorData;}else{if(_this.templateObj.entity.modal.type==='ModalAppPie'){_this.templateObj.entity.modal.points.push($divDSConfigure.get(0).attributes['dsid'].value);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:$divDSConfigure.get(0).attributes['dsid'].value}).done(function(result){var data=JSON.parse(result.dsItemList[0].data);var projectId=data.EnergyList[0].projectId;if(!projectId){if(AppConfig.project&&AppConfig.project.bindId){projectId=AppConfig.project.bindId;}else{projectId=AppConfig.projectId;}}
_this.templateObj.entity.modal.points.push('@'+projectId+'|'+data.EnergyList[0].accumCostPoint);_this.templateObj.entity.modal.points.push('@'+projectId+'|'+data.EnergyList[0].accumEnergyPoint);})}else{for(var i=0;i<$divDSConfigure.length;++i){_this.templateObj.entity.modal.points.push($divDSConfigure.get(i).attributes['dsid'].value);}}}
var option={};timeType&&(option.timeType=timeType);scaleList&&(option.scaleList=scaleList);paraType&&(option.paraType=paraType);chartType&&(option.showType=chartType);if(_this.option.templateType==='ModalAppGauge'){option['guageTitle']=guageTitle!==''?guageTitle:null;option['guageFulTitle']=guageFulTitle!==''?guageFulTitle:null;option['guageFixed']=guageFixed!==''?parseInt(guageFixed):null;option['guageUnit']=guageUnit!==''?guageUnit:null;option['timeLocal']=timeLocal!==''?timeLocal:null;option['guageDirect']=guageDirect!==''?guageDirect:null;option['guageBgColor']=guageBgColor!==''?guageBgColor:null;option['transDataDot']=transDataDot!==''?parseFloat(transDataDot):null;}
historyTitle&&(option.historyTitle=historyTitle);if(_this.option.templateType==='ModalAppDiagRanking'){option['diagType']=diagType;}}
$modalConfig.modal('hide');_this.newPageFlag=true;if(_this.modalType=='dataAnalysis'){var yMax=$('#modifyChartYMax').val();var yMin=$('#modifyChartYMin').val();var yUintSpare=$('#modifyChartYUnitEx').find("option:selected").text();yUintSpare=(yUintSpare==='--')?'':yUintSpare;if(yMax){yMax=parseInt(yMax,10);}
if(yMin){yMin=parseInt(yMin,10);}
var chartOpt={'chartName':$('#modifyChartTitle').val(),'yUnit':$('#modifyChartYUnitName').val()+' '+yUintSpare,'yMax':yMax,'yMin':yMin,'yMark':$('#modifyChartYMark').val()};_this.screen.curModal.chartOption=chartOpt;_this.screen.renderModal();}else if(_this.modalType=='dashboard'){_this.templateObj.setModalOption(option);_this.templateObj.render();}}},close:function(){this.screen=null;this.container.parentNode.removeChild(this.container);this.container=null;this.modalType=null;this.ue=null;},initEditor:function(){var _this=this;this.editorData=_this.templateObj.entity.modal.modalTextUrl?_this.templateObj.entity.modal.modalTextUrl:[];if(!this.ue){UE.delEditor('noteEditor');this.ue=UE.getEditor('noteEditor',{lang:(I18n.type=='zh'?'zh-cn':'en')});this.ue.ready(function(){$('#noteEditor').slideDown('fast');$('#dataConfig').hide();this.setContent(_this.templateObj.entity.modal.modalText?_this.templateObj.entity.modal.modalText:'');$(this.iframe).addClass('gray-scrollbar');this.body.ondrop=dropBody;this.body.ondragover=ondragoverBody;this.body.ondragleave=dragleaveBody;this.body.onmouseup=onmouseupBody;this.body.onkeydown=onkeydownBody;$(this.body).find('.pointValue').each(function(){this.addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);});});}else{this.ue.setContent(this.templateObj.entity.modal.modalText?this.templateObj.entity.modal.modalText:'');}
function dropBody(e){e.preventDefault();this.focus();var $divConfigData=$('#modalConfig').find('.divConfigData');$divConfigData.trigger('drop',[e]);var $editorPoint=$(_this.ue.body).find('.pointValue');var modalTextUrl=_this.editorData?_this.editorData:[];var tempModalTexUrl=[];var flag;for(var i=0;i<$editorPoint.length;i++){flag=false;for(var j=0;j<modalTextUrl.length;j++){if($editorPoint[i].id==modalTextUrl[j].ptId){tempModalTexUrl[i]=modalTextUrl[j];flag=true;break;}}
if(!flag){tempModalTexUrl[i]={ptId:$editorPoint[i].id,ptName:$editorPoint[i].innerText.match(/\b\w+\b/g),ptTextUrl:[]}}}
_this.editorData=tempModalTexUrl;}
function ondragoverBody(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');}
function dragleaveBody(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');}
function onmouseupBody(e){var selection=window.getSelection();if(selection.type=="Range"){var content=selection.getRangeAt(0).cloneContents();for(var i in content.childNodes){if(content.childNodes[i].className=='pointValue'){$('.pointValue').attr("contenteditable",true);_this.isSelection=true;return;}}}else{$('.pointValue').attr("contenteditable",false);}
_this.isSelection=false;}
function onkeydownBody(e){if(_this.isSelection)window.event.returnValue=false;};},renderEditor:function(){var $note=$('#noteEditor');var $dataConfig=$('#dataConfig');if(this.templateObj&&this.templateObj.entity.modal.type=='ModalNote'){$dataConfig.hide();$note.show();if(this.editorData){var $editor=$('#editor');$editor.find('.pointValue').off('click').on('click',function(e){_this.initNotePtCfg($editor.find('.pointValue').index($(e.target)));})}}else{$dataConfig.show();$note.hide();}},domNodeRemoved:function(){var id=$(this).attr('id');var $target=$('.divDSConfigure[dsid="'+id+'"]');var index=$target.parent().children('.divDSConfigure').index($target);setTimeout(function(){var newDom=$(_this.ue.body).find('#'+id);if(newDom.length<1){$target.find('.btnRemoveDS').trigger('click');var tempArray=[];for(var i=0;i<_this.editorData.length;i++){if(i==index)continue;tempArray.push(_this.editorData[i]);}
_this.editorData=tempArray;}else{newDom[0].addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);}},1000);},initNotePtCfg:function(index){var modalTextUrl;var $editorPoint=$(_this.ue.body).find('.pointValue');if(_this.editorData&&$editorPoint.length==_this.editorData.length){modalTextUrl=_this.editorData;}else{modalTextUrl=[];for(var i=0;i<$editorPoint.length;++i){modalTextUrl.push({ptId:$editorPoint[i].id,ptName:$editorPoint[i].innerText.match(/\b\w+\b/g),ptTextUrl:[]})}}
var temp;var $tempDivUrl=$('<div class="col-xs-4 "><select type="text" class="form-control inputNotePtCfgUrl"></select></div>');var $tempSelUrl=$tempDivUrl.children();$tempSelUrl[0].options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,'',true));for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);$tempSelUrl[0].options.add(option);}
$tempSelUrl[0].onchange=function(){_this.templateObj.entity.modal.link=$tempSelUrl[0].value;};var strNotePtCfg=new StringBuilder();strNotePtCfg.append('<div id="containerNotePtCfg">');strNotePtCfg.append('   <span class="glyphicon glyphicon-plus" id="btnNotePtCfgAdd" aria-hidden="true"></span>');strNotePtCfg.append('   <span class="glyphicon glyphicon-remove" id="btnNotePtCfgExit" aria-hidden="true"></span>');strNotePtCfg.append('   <div class="rowNotePtCfgTitle row">');strNotePtCfg.append('       <div class="col-xs-3">Value</div>');strNotePtCfg.append('       <div class="col-xs-5">Name</div>');strNotePtCfg.append('       <div class="col-xs-4">Url</div>');strNotePtCfg.append('   </div>');strNotePtCfg.append('   <div id="divNotePtCfg">');strNotePtCfg.append('   </div>');strNotePtCfg.append('   <div id="divBtnNotePtCfg">');strNotePtCfg.append('       <button type="button" class="btn btn-primary" id="btnNotePtCogSure" i18n="modalConfig.data.PT_COG_SURE"></button>');strNotePtCfg.append('       <button type="button" class="btn btn-primary" id="btnNotePtCogCancel" i18n="modalConfig.data.PT_COG_CANCEL"></button>');strNotePtCfg.append('   </div>');strNotePtCfg.append('</div>');$('#noteEditor').append(strNotePtCfg.toString());strNotePtCfg=new StringBuilder();if(modalTextUrl[index]&&modalTextUrl[index].ptTextUrl.length>0){for(var i=0;i<modalTextUrl[index].ptTextUrl.length;i++){temp=modalTextUrl[index].ptTextUrl[i];strNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal" value="'+temp.value+'"></div>');strNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName" value="'+temp.name+'"></div>');strNotePtCfg.append('   </div>');}}
else
{strNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal"></div>');strNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName"></div>');strNotePtCfg.append('   </div>');}
$('#divNotePtCfg').append(strNotePtCfg.toString());var $rowNotePtCfg=$('.rowNotePtCfg');var tempVal;for(var i=0;i<$rowNotePtCfg.length;i++){$rowNotePtCfg.eq(i).append($tempDivUrl.clone());tempVal=modalTextUrl[index].ptTextUrl[i]?modalTextUrl[index].ptTextUrl[i].url:'';$rowNotePtCfg.eq(i).find('.inputNotePtCfgUrl').val(tempVal)}
I18n.fillArea($('#divBtnNotePtCfg'));var $self=$('#containerNotePtCfg');$('#btnNotePtCfgAdd').off('click').on('click',function(e){var strRowNotePtCfg=new StringBuilder();strRowNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strRowNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strRowNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal"></div>');strRowNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName"></div>');strRowNotePtCfg.append('   </div>');$('#divNotePtCfg').append(strRowNotePtCfg.toString());$('.rowNotePtCfg').last().append($tempDivUrl.clone());$('.btnRowNoteCfgRemove').last().off('click').on('click',function(e){var tempPtTextUrl=[];var tempIndex=$('.btnRowNoteCfgRemove').index($(e.target));tempPtTextUrl=[_this.editorData[index].ptTextUrl.slice(0,tempIndex),_this.editorData[index].ptTextUrl.slice(tempIndex+1)];tempPtTextUrl=tempPtTextUrl[0].concat(tempPtTextUrl[1]);_this.editorData[index].ptTextUrl=tempPtTextUrl.concat();$(e.target).parent().remove();});});$('#btnNotePtCfgExit').off('click').on('click',function(e){$self.remove();});$('#btnNotePtCogSure').off('click').on('click',function(e){$rowNotePtCfg=$('.rowNotePtCfg');modalTextUrl[index].ptTextUrl=[];for(var j=0;j<$rowNotePtCfg.length;j++){modalTextUrl[index].ptTextUrl.push({value:$rowNotePtCfg.eq(j).find('.inputNotePtCfgVal').val(),name:$rowNotePtCfg.eq(j).find('.inputNotePtCfgName').val(),url:$rowNotePtCfg.eq(j).find('.inputNotePtCfgUrl').val()})}
_this.editorData=modalTextUrl;$self.remove();});$('#btnNotePtCogCancel').off('click').on('click',function(e){$self.remove();});$('.btnRowNoteCfgRemove').off('click').on('click',function(e){var tempPtTextUrl=[];var tempIndex=$('.btnRowNoteCfgRemove').index($(e.target));tempPtTextUrl=[_this.editorData[index].ptTextUrl.slice(0,tempIndex),_this.editorData[index].ptTextUrl.slice(tempIndex+1)];tempPtTextUrl=tempPtTextUrl[0].concat(tempPtTextUrl[1]);_this.editorData[index].ptTextUrl=tempPtTextUrl.concat();$(e.target).parent().remove();});},setTimePrecision:function(cycle,$iptTime1,$iptTime2){var option={format:"yyyy-mm-dd hh:ii",autoclose:true,todayBtn:true,initialDate:new Date(),startView:2}
$iptTime1.datetimepicker('remove');$iptTime2&&$iptTime2.datetimepicker('remove');switch(cycle){case'm1':option.minView=0;break;case'm5':option.minView=0;break;case'h1':option.minView=1;option.format="yyyy-mm-dd hh:00";break;case'd1':option.minView=2;option.format="yyyy-mm-dd 00:00";break;case'M1':option.minView=3;option.startView=3;option.format="yyyy-mm-01 00:00";break;default:option.minView=2;option.format="yyyy-mm-dd 00:00";break;}
$iptTime1.datetime();$iptTime2&&$iptTime2.datetime();},getDateFmtByInputFmt:function(inputFmt){var arrFmt=inputFmt.split(' ');var dtFmt='';for(var i=0;i<arrFmt.length;i++){if(/yyyy(.)mm(.)dd/.test(arrFmt[i])){dtFmt+=arrFmt[i].replace(/mm/,'MM');}
if(/hh:ii/.test(arrFmt[i])){dtFmt+=' HH:mm';}}
return dtFmt;}};return modalConfigurePane;})();var DiagnosisInfo=(function(){var _this;function DiagnosisInfo(){this.diagnosisDetailInfo=undefined;this.$disgnosisDetailInfoModal=undefined;_this=this;}
DiagnosisInfo.prototype={show:function(diagnosisDetailInfo){var _this=this;this.diagnosisDetailInfo=diagnosisDetailInfo;WebAPI.get("/static/views/observer/diagnosis/diagnosisInfo.html").done(function(resultHtml){_this.$disgnosisDetailInfoModal=$('#disgnosisDetailInfoModal');if(_this.$disgnosisDetailInfoModal.length===0){_this.diagnosisDetailInfo.containerScreen.append(resultHtml);_this.$disgnosisDetailInfoModal=$('#disgnosisDetailInfoModal');}else{_this.$disgnosisDetailInfoModal.find('.diagnosisTable tbody').html('');}
I18n.fillArea(_this.$disgnosisDetailInfoModal);_this.$disgnosisDetailInfoModal.modal('show');_this.$disgnosisDetailInfoModal.find('h4.modal-title').text(_this.diagnosisDetailInfo.faultName);var timeFormatStr=timeFormatChange('yyyy-mm-dd hh');$('#startTimeCog').datetimepicker({format:timeFormatStr+":00:00",autoclose:true,minView:1,startView:2,forceParse:false}).val(new Date(new Date().valueOf()-86400000*7).timeFormat(timeFormatChange('yyyy-mm-dd'))+' 00:00:00');$('#endTimeCog').datetimepicker({format:timeFormatStr+":00:00",autoclose:true,minView:1,forceParse:false,startView:2}).val(new Date().timeFormat(timeFormatStr)+':00:00');_this.init();_this.addEvents();Spinner.stop();});},close:function(){this.diagnosisDetailInfo=null;this.$disgnosisDetailInfoModal.empty().remove();this.$disgnosisDetailInfoModal=null;},addEvents:function(){var _this=this;$('#checkDiagnosis').off('click').click(function(){_this.$disgnosisDetailInfoModal.find('.diagnosisTable tbody').html('');var diagType=$(_this.diagnosisDetailInfo.containerScreen.context).find('.diagRanking').attr('data-type');var startTime=timeFormat($('#startTimeCog').val(),'yyyy-mm-dd hh:ii:ss');var endTime=timeFormat($('#endTimeCog').val(),'yyyy-mm-dd hh:ii:ss');if(new Date(startTime).valueOf()>new Date(endTime).valueOf()){alert(I18n.resource.modalConfig.modalApp.TIME_ERROR);return;}
Spinner.spin($('#disgnosisDetailInfoModal')[0]);var postData={value:_this.diagnosisDetailInfo.faultName,type:diagType,startTime:startTime,endTime:endTime,projId:AppConfig.projectId}
WebAPI.post('/diagnosis/getFaultDetails',postData).done(function(faultDetailCl){_this.diagnosisDetailInfo.faultDetailData=faultDetailCl.data;_this.init();Spinner.stop();})});},init:function(){var _this=this;var detailInfoData=_this.diagnosisDetailInfo.faultDetailData;var timeIntervalObj=_this.timeInterval();function unique(arr){var result=[],hash={};for(var i=0,elem;(elem=arr[i])!=null;i++){if(!hash[elem]){result.push(elem);hash[elem]=true;}}
return result;}
function spectrumCreate(detailInfoData){var spectrumDiv='';function spectrumDivChild(faultTimeArr){var faultTimeArrTime=unique(faultTimeArr.time);var faultTimeArrCount=faultTimeArr.counts;var spectrumDivCh='';for(var p=0;p<faultTimeArrTime.length;p++){var cuerH=parseInt(faultTimeArrTime[p].split(' ')[1]);spectrumDivCh+='<div class="spectrumDivCh" title="'+timeFormat(faultTimeArrTime[p]+':00:00',timeFormatChange('yyyy-mm-dd hh:ii:ss'))+'('+faultTimeArrCount[p]+')'+'" style="width:'+100/24+'%;height:26px;display:inline-block;background:rgba(193, 33, 33, 0.8);position:absolute;top:0;left:'+100*(cuerH-1)/24+'%"></div>'}
return spectrumDivCh}
for(var m=0;m<timeIntervalObj.length;m++){var detailInfoI=timeIntervalObj[m];var faultTimeArr={};faultTimeArr['time']=[];faultTimeArr['counts']=[];for(var n=0;n<detailInfoI.length;n++){var count=0;var hourPrimTime=detailInfoI[n].split(' ')[0]+' '+detailInfoI[n].split(' ')[1].split(':')[0];for(var k=0;k<detailInfoData.arrNoticeTime.length;k++){var noticeTime=detailInfoData.arrNoticeTime[k].Time;var hourCompaTime=noticeTime.split(' ')[0]+' '+noticeTime.split(' ')[1].split(':')[0];if(hourPrimTime==hourCompaTime){count=count+1;faultTimeArr.time.push(hourPrimTime);}}
if(count!==0){faultTimeArr.counts.push(count);}}
if(m%2===0){spectrumDiv+='<div class="spectrumDiv" title="'+timeFormat(detailInfoI[0].split(' ')[0],timeFormatChange('yyyy-mm-dd'))+'" style="width:'+100/timeIntervalObj.length+'%;background:-webkit-linear-gradient(top,#f0f4fb,#e4ecf9);position:relative">'+spectrumDivChild(faultTimeArr)+'</div>';}else{var evenColor='-webkit-linear-gradient(top,#ffffff,#f0f4fb)';spectrumDiv+='<div class="spectrumDiv" title="'+timeFormat(detailInfoI[0].split(' ')[0],timeFormatChange('yyyy-mm-dd'))+'" style="width:'+100/timeIntervalObj.length+'%;background:-webkit-linear-gradient(top,#ffffff,#f0f4fb);position:relative">'+spectrumDivChild(faultTimeArr)+'</div>';}}
return spectrumDiv}
var rankType=$(_this.diagnosisDetailInfo.containerScreen.context).find('.diagRanking').attr('data-type');var diagnosisHead='';if(rankType==='equipment'){diagnosisHead='<tr">\
                        <th  width="20%">'+I18n.resource.modalConfig.modalApp.ZONE+'</th>\
                        <th width="20%">'+I18n.resource.modalConfig.modalApp.TIMES+'</th>\
                        <th>'+I18n.resource.modalConfig.modalApp.FREQUENCY+'</th>\
                        </tr>';}else if(rankType==='zone'){diagnosisHead='<tr">\
                        <th  width="30%">'+I18n.resource.modalConfig.modalApp.ZONE+'</th>\
                        <th>'+I18n.resource.modalConfig.modalApp.FREQUENCY+'</th>\
                        </tr>';}else{diagnosisHead='<tr">\
                        <th  width="15%">'+I18n.resource.modalConfig.modalApp.ZONE+'</th>\
                        <th  width="15%">'+I18n.resource.modalConfig.modalApp.EQUIPMENT+'</th>\
                        <th width="15%">'+I18n.resource.modalConfig.modalApp.TIMES+'</th>\
                        <th>'+I18n.resource.modalConfig.modalApp.FREQUENCY+'</th>\
                        </tr>';}
_this.$disgnosisDetailInfoModal.find('.diagnosisTable thead').html('');_this.$disgnosisDetailInfoModal.find('.diagnosisTable thead').append(diagnosisHead);for(var i=0;i<detailInfoData.length;i++){var diagnosisDetailTr='';if(rankType==='equipment'){diagnosisDetailTr='<tr class="diagnosisDetailTr" data-faultId="'+detailInfoData[i].FaultId+'">\
                        <td>'+detailInfoData[i].SubBuildingName+'</td>\
                        <td>'+detailInfoData[i].arrNoticeTime.length+'</td>\
                        <td class="spectrumCommen">'+
spectrumCreate(detailInfoData[i])
+'</td>\
                        </tr>';}else if(rankType==='zone'){diagnosisDetailTr='<tr class="diagnosisDetailTr" data-faultId="'+detailInfoData[i].FaultId+'">\
                        <td>'+detailInfoData[i].SubBuildingName+'</td>\
                        <td class="spectrumCommen">'+
spectrumCreate(detailInfoData[i])
+'</td>\
                        </tr>';}else{diagnosisDetailTr='<tr class="diagnosisDetailTr" data-faultId="'+detailInfoData[i].FaultId+'">\
                        <td>'+detailInfoData[i].SubBuildingName+'</td>\
                        <td>'+detailInfoData[i].EquipmentName+'</td>\
                        <td>'+detailInfoData[i].arrNoticeTime.length+'</td>\
                        <td class="spectrumCommen">'+
spectrumCreate(detailInfoData[i])
+'</td>\
                        </tr>';}
_this.$disgnosisDetailInfoModal.find('.diagnosisTable tbody').append(diagnosisDetailTr);}},hslOrRgb:function(n){var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return[h,s,l];}
function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var hue2rgb=function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
var colorBasic='#055197';var rgb=colorBasic.colorRgb().split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var hsl=rgbToHsl(r,g,b);var hslCo;if(n===0){hsl[2]=1;}else if(n===1){hsl[2]=0.92;hslCo=0.88;}else{hsl[2]=96-n*3<10?10:(96-n*3);hsl[2]=hsl[2]/100;hslCo=96-n*5<10?10:(96-n*5);hslCo=hslCo/100}
var rgbStartColor=hslToRgb(hsl[0],hsl[1],hsl[2]);var rgbStartColor1=hslToRgb(hsl[0],hsl[1],hslCo);if(n===0){return'-webkit-linear-gradient(top,#f0f4fb,#e4ecf9)';}else{return'rgba(193, 33, 33, 0.8)';}},timeInterval:function(){var timeIntervalObj={};var startTimeCogVal=timeFormat($('#startTimeCog').val(),'yyyy-mm-dd hh:ii:ss');var endTimeCogVal=timeFormat($('#endTimeCog').val(),'yyyy-mm-dd hh:ii:ss');var startYear=parseInt(startTimeCogVal.split('-')[0]);var startMonth=parseInt(startTimeCogVal.split('-')[1]);var startDay=parseInt(startTimeCogVal.split(' ')[0].split('-')[2]);var endYear=parseInt(endTimeCogVal.split('-')[0]);var endMonth=parseInt(endTimeCogVal.split('-')[1]);var endDay=parseInt(endTimeCogVal.split(' ')[0].split('-')[2]);var startHour=parseInt(startTimeCogVal.split(' ')[1].split(':')[0]);startHour=startHour===0?24:startHour;var endHour=parseInt(endTimeCogVal.split(' ')[1].split(':')[0]);endHour=endHour===0?24:endHour;var monthLength=0;var monthArrCount=[];var monthDayArr=[];if(new Date(startTimeCogVal).valueOf()>new Date(endTimeCogVal).valueOf()){alert(I18n.resource.modalConfig.modalApp.TIME_ERROR);return;}
if(endYear-startYear>1){alert(I18n.resource.modalConfig.modalApp.TIME_INTERVAL);return;}else{if(startMonth===endMonth){if(startDay===endDay){var monthDay=[];startHour=startHour===24?0:startHour;var intervalHour=endHour-startHour;monthLength+=intervalHour+1;for(var i=0;i<=intervalHour;i++){var currentTimes
var startHourF=startHour+i>9?(startHour+i):('0'+(startHour+i).toString());if(startHourF===24){startHourF='00';currentTimes=startYear+'-'+(startMonth>9?startMonth:('0'+startMonth.toString()))+'-'+(startDay+1>9?(startDay+1):('0'+(startDay+1).toString()))+' '+startHourF+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:('0'+startMonth.toString()))+'-'+(startDay>9?startDay:('0'+startDay.toString()))+' '+startHourF+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);}else{startHour=startHour===24?0:startHour;var startDayHour=24-startHour+1;monthLength+=startDayHour;var monthDay=[];for(var i=0;i<startDayHour;i++){var currentTimes;var startDayHourF=startHour+i>9?(startHour+i):('0'+(startHour+i).toString());if(startDayHourF===24){startDayHourF='00';currentTimes=startYear+'-'+(startMonth>9?startMonth:('0'+startMonth.toString()))+'-'+(startDay+1>9?(startDay+1):('0'+(startDay+1).toString()))+' '+startDayHourF+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:('0'+startMonth.toString()))+'-'+(startDay>9?startDay:('0'+startDay.toString()))+' '+startDayHourF+':00:00'
monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);if(endDay-startDay>1){var intervalDays=endDay-startDay;for(var i=1;i<intervalDays;i++){var monthDays=[];monthLength+=24;for(var j=1;j<=24;j++){var currentTimes;var endHourCur=(j>9?j:'0'+j.toString());if(endHourCur===24){endHourCur='00';currentTimes=startYear+'-'+(startMonth>9?(startMonth):('0'+(startMonth).toString()))+'-'+(startDay+i+1>9?(startDay+i+1):('0'+(startDay+i+1).toString()))+' '+endHourCur+':00:00';monthArrCount.push(currentTimes);monthDays.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?(startMonth):('0'+(startMonth).toString()))+'-'+(startDay+i>9?(startDay+i):('0'+(startDay+i).toString()))+' '+endHourCur+':00:00';monthArrCount.push(currentTimes);monthDays.push(currentTimes);}}
monthDayArr.push(monthDays);}}
var monthDayss=[];monthLength+=endHour;if(endHour===1){monthArrCount.push(startYear+'-'+(endMonth>9?endMonth:('0'+endMonth.toString()))+'-'+(endDay>9?endDay:('0'+endDay.toString()))+' '+'01:00:00');monthDayss.push(startYear+'-'+(endMonth>9?endMonth:('0'+endMonth.toString()))+'-'+(endDay>9?endDay:('0'+endDay.toString()))+' '+'01:00:00');}else{for(var i=1;i<=endHour;i++){var currentTimes;var endHourCue=i>9?i:'0'+i.toString();if(endHourCue===24){endHourCue='00';currentTimes=startYear+'-'+(endMonth>9?endMonth:('0'+endMonth.toString()))+'-'+(endDay+1>9?(endDay+1):('0'+(endDay+1).toString()))+' '+endHourCue+':00:00'
monthArrCount.push(currentTimes);monthDayss.push(currentTimes);}else{currentTimes=startYear+'-'+(endMonth>9?endMonth:('0'+endMonth.toString()))+'-'+(endDay>9?endDay:('0'+endDay.toString()))+' '+endHourCue+':00:00'
monthArrCount.push(currentTimes);monthDayss.push(currentTimes);}}}
monthDayArr.push(monthDayss);}}else{startHour=startHour===24?0:startHour;var startDayHour=24-startHour+1;monthLength+=startDayHour;var monthDays=[];for(var i=0;i<startDayHour;i++){var startDayHourF=startHour+i>9?(startHour+i):('0'+(startHour+i).toString());var currentTimes;if(startDayHourF===24){startDayHourF='00';currentTimes=startYear+'-'+(startMonth>9?startMonth:('0'+startMonth.toString()))+'-'+(startDay+1>9?(startDay+1):('0'+(startDay+1).toString()))+' '+startDayHourF+':00:00'
monthArrCount.push(currentTimes);monthDays.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:('0'+startMonth.toString()))+'-'+(startDay>9?startDay:('0'+startDay.toString()))+' '+startDayHourF+':00:00'
monthArrCount.push(currentTimes);monthDays.push(currentTimes);}}
monthDayArr.push(monthDays);var startMonthDCount=new Date(startYear,startMonth,0).getDate();var intervalDay=startMonthDCount-startDay;for(var i=1;i<=intervalDay;i++){var monthDay=[];var pushStartDay=(startDay+i)>9?(startDay+i):('0'+(startDay+i).toString());var pushStartDay1=(startDay+i+1)>9?(startDay+i+1):('0'+(startDay+i+1).toString());monthLength+=24;for(var j=1;j<=24;j++){var currentTimes;var pushDayHourCound=j>9?j:('0'+j.toString());if(pushDayHourCound===24){pushDayHourCound='00';if(pushStartDay1>startMonthDCount){startMonth=startMonth+1;pushStartDay1='01';}
currentTimes=startYear+'-'+(startMonth>9?startMonth:('0'+startMonth.toString()))+'-'+pushStartDay1+' '+pushDayHourCound+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+(startMonth>9?startMonth:('0'+startMonth.toString()))+'-'+pushStartDay+' '+pushDayHourCound+':00:00'
monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);}
var startMonthArr=endMonth-startMonth;if(endMonth-startMonth>1){var monthHourArr=endMonth-startMonth;for(var i=1;i<monthHourArr;i++){var currentMonths=startMonth+i>9?(startMonth+i):('0'+(startMonth+i).toString());var currentMonthDays=new Date(startYear,currentMonths,0).getDate();for(var j=1;j<=currentMonthDays;j++){var monthDay=[];var currentMonthDay=j>9?j:('0'+j.toString());var currentMonthDay1=j+1>9?j+1:('0'+(j+1).toString());monthLength+=24;for(var k=1;k<=24;k++){var currentTimes;var currentMonthDayHour=k>9?k:('0'+k.toString());if(currentMonthDayHour===24){currentMonthDayHour='00';currentTimes=startYear+'-'+currentMonths+'-'+currentMonthDay1+' '+currentMonthDayHour+':00:00';monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+currentMonths+'-'+currentMonthDay+' '+currentMonthDayHour+':00:00'
monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);}}}
var endMonthGe=endMonth>9?endMonth:('0'+endMonth.toString());for(var i=1;i<endDay;i++){var monthDay=[];var currendEndDay=i>9?i:('0'+i.toString());var currendEndDay1=i+1>9?i+1:('0'+(i+1).toString());monthLength+=24;for(var j=1;j<=24;j++){var currentTimes;var currentEndDayHours=j>9?j:('0'+j.toString());if(currentEndDayHours===24){currentEndDayHours='00';currentTimes=startYear+'-'+endMonthGe+'-'+currendEndDay1+' '+currentEndDayHours+':00:00'
monthArrCount.push(currentTimes);monthDay.push(currentTimes);}else{currentTimes=startYear+'-'+endMonthGe+'-'+currendEndDay+' '+currentEndDayHours+':00:00'
monthArrCount.push(currentTimes);monthDay.push(currentTimes);}}
monthDayArr.push(monthDay);}
monthLength+=endHour;var monthDayF=[];if(endHour===1){monthArrCount.push(startYear+'-'+endMonthGe+'-'+(endDay>9?endDay:('0'+endDay.toString()))+' '+'01:00:00');monthDayF.push(startYear+'-'+endMonthGe+'-'+(endDay>9?endDay:('0'+endDay.toString()))+' '+'01:00:00');}else{for(var i=1;i<=endHour;i++){var currentTimes=startYear+'-'+endMonthGe+'-'+(endDay>9?endDay:('0'+endDay.toString()))+' '+(i>9?i:('0'+i.toString()))+':00:00';monthArrCount.push(currentTimes);monthDayF.push(currentTimes);}}
monthDayArr.push(monthDayF);}}
timeIntervalObj['timeIntervalCount']=monthLength;timeIntervalObj['timeIntervalArr']=monthArrCount;for(var k=0;k<monthDayArr.length-1;k++){var arrFirst=monthDayArr[k].pop();monthDayArr[k+1].splice(0,0,arrFirst);}
return monthDayArr;}}
return DiagnosisInfo;})();(function($){function ModalDBHistory(){this.options=undefined;this.modal=null;this.refChart=null;this.$wrap=null;this.showOptions={};}
ModalDBHistory.prototype.show=function(){var _this=this;var domPanelContent=document.getElementById('paneCenter');if(!this.modal)return;this.options=getDefaultOption();if(this.$wrap){this.$wrap.appendTo(document.body);this.initCustomShow();return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalDBHistory.html').done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-db-history-wrap" id="modalDBHistoryWrap">').appendTo(document.body).html(html);_this.$modal=_this.$wrap.children('.modal');I18n.fillArea(_this.$wrap);_this.init();_this.initCustomShow();});};ModalDBHistory.prototype.displayCustomShow=function(options){if(!options)return;this.$selMode.val(options.mode);this.$selMode.trigger('change');if(options.mode==='fast'){this.$selTimerange.val(options.timeRange);}else{this.$selInterval.val(options.timeFmt);this.$selInterval.trigger('change');this.$iptTimeStart.val(options.startTimeStr);this.$iptTimeEnd.val(options.endTimeStr);}
this.$modal.modal('show');};ModalDBHistory.prototype.initCustomShow=function(){var showOptions=this.showOptions;var now;if(this.modal.type==="ModalMultiple"){now=new Date();showOptions.mode='custom';showOptions.timeFmt='h1';showOptions.startTimeStr=function(){return new Date(now.valueOf()-360000000).format('yyyy-MM-dd HH:00');}.call(this);showOptions.endTimeStr=function(){return now.format('yyyy-MM-dd HH:00');}.call(this);}else{showOptions=this.showOptions={mode:'fast',timeRange:'day'};}
this.displayCustomShow(showOptions);};ModalDBHistory.prototype.getOptionsByType=function(data){var options=[];if(this.modal.type==='ModalMultiple'){options=function(){var series=[];var legend=[];var typeMap={};var paraType=this.modal.option.paraType||[];var usedDsNameMap={};paraType.forEach(function(row){if(!row.arrId||!row.arrId.length)return;row.arrId.forEach(function(dsId){if(typeMap[dsId]===undefined){typeMap[dsId]=[row.type];}else{typeMap[dsId].push(row.type);}});});var arrId=[];var arrItem=[];data.list.forEach(function(row){var dsId=row.dsItemId;if(dsId){arrId.push(dsId);}});arrItem=AppConfig.datasource.getDSItemById(arrId);data.list.forEach(function(row){var type=typeMap[row.dsItemId].shift();var dsId=row.dsItemId;var name;for(var i=0,len=arrItem.length;i<len;i++){if(dsId==arrItem[i].id){name=arrItem[i].alias;usedDsNameMap[dsId]=usedDsNameMap[dsId]||0;usedDsNameMap[dsId]+=1;if(usedDsNameMap[dsId]>1){name=name+'_'+usedDsNameMap[dsId];}
legend.push(name);switch(type){case'line':series.push({name:name,type:'line',symbol:'none',data:row.data,yAxisIndex:1,z:4});break;case'bar':series.push({name:name,type:'bar',symbol:'none',data:row.data,yAxisIndex:0});break;case'area':series.push({name:name,type:'line',itemStyle:{normal:{areaStyle:{type:'default'}}},symbol:'none',data:row.data,yAxisIndex:0,z:3});break;case'cumulativeBar':series.push({name:name,type:'bar',stack:'realtime total',symbol:'none',data:row.data,yAxisIndex:0});break;default:break;}
break;}}});return{series:series,legend:{data:legend},yAxis:[{type:'value',scale:false,splitArea:{show:false}},{type:'value',scale:false,splitArea:{show:false}}]};}.call(this);}else{options=function(){var series=[];var legend=[];var usedDsNameMap={};data.list=data.list.filter(function(row,i){if((!row.data||!row.data.length)&&this.modal.type==='ModalNote'){return false;}
var dsId=row.dsItemId;var name=AppConfig.datasource.getDSItemById(dsId).alias||dsId;usedDsNameMap[dsId]=usedDsNameMap[dsId]||0;usedDsNameMap[dsId]+=1;if(usedDsNameMap[dsId]>1){name=name+'_'+usedDsNameMap[dsId];}
series.push({name:name,symbol:'none',type:'line',markLine:{data:[{type:'average',name:'average'}]},data:row.data});legend.push(name);return true;},this);return{series:series,legend:{data:legend}};}.call(this);}
if(this.refChart){try{options.color=this.refChart.getOption().color||[];}catch(e){}}
return options;};ModalDBHistory.prototype.init=function(){this.$chartContainer=$('.chart-container',this.$modal);this.$btnSearch=$('.btn-search',this.$modal);this.$selMode=$('.sel-mode',this.$modal);this.$selTimerange=$('.sel-timerange',this.$modal);this.$selInterval=$('.sel-interval',this.$modal);this.$iptTimeStart=$('.ipt-timestart',this.$modal);this.$iptTimeEnd=$('.ipt-timeend',this.$modal);this.$groupFast=$('[data-group="fast"]',this.$modal);this.$groupCustom=$('[data-group="custom"]',this.$modal);this.initValidator();this.attachEvents();};ModalDBHistory.prototype.initValidator=function(){var _this=this;this.validator=new Validator({elements:[{name:'endTime',selector:this.$iptTimeEnd,rules:[{valid:function(val){var startTimeVal=_this.$iptTimeStart.val();if(val<=startTimeVal){this.fail();}else{this.success();}},msg:'the end time should later than start time.'}]}],icon:false});};ModalDBHistory.prototype.initTimePlugin=function(fmt){var now=new Date();var formatStr;if(!fmt){formatStr=timeFormatChange('yyyy-mm-dd hh:ii');fmt={format:formatStr,showFormat:formatStr,minView:'hour',startView:'month',startTime:new Date(now.valueOf()-60*60*24*1000)};}else{this.$iptTimeStart.datetimepicker('remove').val('');this.$iptTimeEnd.datetimepicker('remove').val('');}
this.$iptTimeStart.datetimepicker({format:fmt.format,minView:fmt.minView,startView:fmt.startView,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:new Date(),initialDate:new Date(fmt.startTime)});this.$iptTimeStart.val(timeFormat(fmt.startTime,fmt.showFormat));this.$iptTimeEnd.datetimepicker({format:fmt.format,minView:fmt.minView,startView:fmt.startView,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:new Date(),initialDate:now});this.$iptTimeEnd.val(now.timeFormat(fmt.showFormat));};ModalDBHistory.prototype.initChart=function(){if(!this.chart){this.chart=echarts.init(this.$chartContainer[0],'macarons');}};ModalDBHistory.prototype.setOptions=function(options){this.options=options;};ModalDBHistory.prototype.setModal=function(modal,chart){this.modal=modal;this.refChart=chart;};ModalDBHistory.prototype.attachEvents=function(){var _this=this;this.$selMode.off('change').on('change',function(e){var mode=$(this).val();if(mode==='fast'){_this.$selTimerange.val('hour');_this.$groupFast.show();_this.$groupCustom.hide();}else{_this.$groupFast.hide();_this.$groupCustom.show();_this.$selInterval.trigger('change');}
_this.showOptions.mode=mode;});this.$selInterval.off('change').on('change',function(e){var interval=$(this).val();var fmt={};var now=new Date(),nowTick=now.valueOf();var formatStr;fmt.endTime=now;switch(interval){case'm1':formatStr=timeFormatChange("yyyy-mm-dd hh:ii");fmt.startTime=new Date(nowTick-60000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='hour';fmt.startView='month';break;case'm5':formatStr=timeFormatChange("yyyy-mm-dd hh:ii");fmt.startTime=new Date(nowTick-300000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='hour';fmt.startView='month';break;case'h1':formatStr=timeFormatChange("yyyy-mm-dd hh");fmt.startTime=new Date(nowTick-3600000);fmt.format=formatStr+":00";fmt.showFormat=formatStr+":00";fmt.minView='day';fmt.startView='month';break;case'd1':formatStr=timeFormatChange("yyyy-mm-dd");fmt.startTime=new Date(nowTick-86400000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='month';fmt.startView='month';break;case'M1':formatStr=timeFormatChange("yyyy-mm");fmt.startTime=new Date(nowTick-2592000000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='year';fmt.startView='year';break;}
_this.initTimePlugin(fmt);});this.$btnSearch.off('click').on('click',function(e){var startTime,endTime,timeFmt;var rangeTick;if(_this.showOptions.mode==='fast'){switch(_this.$selTimerange.val()){case'hour':rangeTick=3600000;timeFmt='m5';break;case'day':rangeTick=86400000;timeFmt='h1';break;case'week':rangeTick=604800000;timeFmt='h1';break;case'month':rangeTick=2592000000;timeFmt='d1';break;case'quarter':rangeTick=7776000000;timeFmt='d1';break;default:break;}
endTime=new Date();startTime=new Date(endTime.valueOf()-rangeTick);_this.updateChart(startTime,endTime,timeFmt);}else{startTime=timeFormat(_this.$iptTimeStart.val()).toDate();endTime=timeFormat(_this.$iptTimeEnd.val()).toDate();timeFmt=_this.$selInterval.val();_this.updateChart(startTime,endTime,timeFmt);}
e.stopPropagation();});this.$modal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.reset();_this.$wrap.detach();e.preventDefault();e.stopPropagation();});this.$modal.off('shown.bs.modal').on('shown.bs.modal',function(e){_this.initChart();_this.$btnSearch.trigger('click');});};ModalDBHistory.prototype.updateChart=function(start,end,timeFmt){var _this=this;var startTick,endTick;var points=this.modal.points;if(!points||!points.length){this.chart.getOption().series=[];return;}
this.chart.showLoading({text:'Loading',effect:'spin',textStyle:{fontSize:20}});return WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:points,timeStart:start.format('yyyy-MM-dd HH:mm:ss'),timeEnd:end.format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeFmt}).then(function(rs){var seriesData=[];var timeShaft=rs.timeShaft;var list=rs.list;var optionsFromType;if(!rs.timeShaft||!rs.timeShaft.length){_this.chart.setOption({series:[]},true);return;}
optionsFromType=_this.getOptionsByType(rs);_this.options.chartOptions.xAxis=[{boundaryGap:false,type:'category',data:timeShaft}];_this.options.chartOptions=$.extend(false,_this.options.chartOptions,optionsFromType);_this.chart.setOption(_this.options.chartOptions,true);},function(){_this.chart.setOption({series:[]},true);}).always(function(){_this.chart.hideLoading();});};ModalDBHistory.prototype.reset=function(){if(!!this.chart){this.chart.clear();this.chart.dispose();this.chart=null;}};ModalDBHistory.prototype.close=function(){this.$wrap.remove();this.$wrap=null;};function getDefaultOption(){var i18nEcharts=I18n.resource.echarts;return{chartOptions:{toolbox:{show:true,feature:{dataZoom:{show:false,title:{zoom:i18nEcharts.DATAZOOM,back:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},tooltip:{trigger:'axis'},dataZoom:{show:true},grid:{y:50,y2:80},yAxis:[{type:'value',boundaryGap:[0.1,0.1]}],series:[]}};}
this.ModalDBHistory=ModalDBHistory;}).call(this,jQuery);var ModalBase=(function(){function ModalBase(parent,entity,_funcRender,_funcUpdate,_funcConfigMode,configModalOpt){if(!parent)return;this.screen=parent;this.entity=entity;this.wikis={};this.container=undefined;this.chart=undefined;this.spinner=undefined;this.subEntity=undefined;this.executeRender=_funcRender;this.executeConfigMode=_funcConfigMode;this.executeUpdate=_funcUpdate;this.hasEdit=false;this.spanRange={};if(this.configModalOptDefault)this.configModalOpt=$.extend(true,{},this.configModalOptDefault,configModalOpt);this.initContainer();!AppConfig.datasource&&(AppConfig.datasource={getDSItemById:DataSource.prototype.getDSItemById.bind({m_parent:{store:{dsInfoList:[]}},m_arrCloudTableInfo:[]})})};ModalBase.prototype={UNIT_WIDTH:100/12,UNIT_HEIGHT:100/6,initContainer:function(replacedElementId){var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass='';if((!divParent)||replacedElementId){var isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}
else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
$(divParent).addClass('springContainer');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){this.spanRange={minWidth:1,maxWidth:3,minHeight:1,maxHeight:4.5,yScale:4/3,xScale:4};}else{this.spanRange={minWidth:this.optionTemplate.minWidth,maxWidth:this.optionTemplate.maxWidth,minHeight:this.optionTemplate.minHeight,maxHeight:this.optionTemplate.maxHeight,yScale:1,xScale:1};}
if(AppConfig.isMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){var height=100;if((this.optionTemplate.scroll===false||this.entity.scroll===false)&&!(this.screen.options&&this.screen.options.isConfig)){divParent.className+=' noScroll';}else{height=this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale;height>100&&(height=100);divParent.style.height=height+'%';}
divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale+'%';if(this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale>100){divParent.style.width='100%';}
if(this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale>100){divParent.style.height='100%';}}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.type=='ModalNote'||this.entity.modal.type=='ModalMix'){scrollClass=' gray-scrollbar scrollY'}
if(this.entity.modal.title&&this.entity.modal.title!=''&&(!this.entity.isNotRender)){divParent.innerHTML='<div class="panel panel-default">\
                    <div class="panel-heading springHead">\
                        <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                    </div>\
                    <div class="panel-body springContent'+scrollClass+'" style="position: relative;"></div>\
                </div>';}else{divParent.innerHTML='<div class="panel panel-default">\
                    <span class="springSeHead fontTemp6">'+(this.entity.modal.title?this.entity.modal.title:'')+'</span>\
                    <div class="panel-body springContent'+scrollClass+'" style="position: relative;height:100%;"></div>\
                </div>';}
if(!(this instanceof ModalAnalysis)){var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];var lkHistory;if('ModalInteract'==this.entity.modal.type){var aInterCfg;aInterCfg=document.createElement('a');aInterCfg.className='springLinkBtn';aInterCfg.title='Config time parameter';aInterCfg.href='javascript:;';aInterCfg.innerHTML='<span class="glyphicon glyphicon-cog"></span>';divBtnCtn.appendChild(aInterCfg);aInterCfg.onclick=function(){new ModalInteractCfgPanel(_this).show();}}
if(this.entity.modal.points&&this.entity.modal.points.length>0){var lkJump;lkJump=document.createElement('a');lkJump.className='springLinkBtn';lkJump.title='Add to datasource';lkJump.href='javascript:;';lkJump.innerHTML='<span class="glyphicon glyphicon-export"></span>';divBtnCtn.appendChild(lkJump);lkJump.onclick=function(){new ModalAppendPointToDs(true,_this.entity.modal.points,null).show();}}
if(['ModalHtml','ModalMix','ModalObserver','ModalRank','ModalRankNormal','ModalNone','ModalInteract'].indexOf(this.entity.modal.type)>-1||!this.entity.modal.points||!this.entity.modal.points.length){}else{lkHistory=document.createElement('a');lkHistory.className='springLinkBtn';lkHistory.title='Show History';lkHistory.href='javascript:;';lkHistory.innerHTML='<span class="glyphicon glyphicon-stats"></span>';divBtnCtn.appendChild(lkHistory);this.attachLkHistoryEvents(lkHistory);}
var link=this.entity.modal.link;var _this=this;if(link&&AppConfig.menu[link]){var linkBtn=document.createElement('a');linkBtn.className='springLinkBtn';linkBtn.innerHTML='<span class="glyphicon glyphicon-link"></span>';linkBtn.setAttribute('pageid',link);linkBtn.title='Link to '+AppConfig.menu[link];divBtnCtn.appendChild(linkBtn);linkBtn.onclick=function(e){var $ev=$('#ulPages [pageid="'+link+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');}}
domPanel.appendChild(divBtnCtn);}
this.container=divParent.getElementsByClassName('springContent')[0];if(this.entity.modal.type!=='ModalMix'&&this.entity.modal.type!=='ModalAppBlind'&&this.entity.modal.type!=='ModalAppPie'){this.spinner=new LoadingSpinner({color:'#00FFFF'});this.spinner.spin(this.container);}
return this;},initToolTips:function(parent){var _this=this;if(!parent)return;var descTip=new StringBuilder();descTip.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');descTip.append('    <div class="tooltipTitle tooltip-inner" style="display:none">GeneralRegressor</div>');descTip.append('    <div class="tooltipContent" style="border:1px solid black">');descTip.append('        <p class="containerDesc" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.entity.modal.desc).append('</span> ').append('</p>');descTip.append('    </div>');descTip.append('    <div class="tooltip-arrow"></div>');descTip.append('</div>');var options={placement:'bottom',title:_this.entity.modal.title,template:descTip.toString()};if(_this.entity.modal.desc&&_this.entity.modal.desc!=''){$(parent).tooltip(options);}},render:function(){try{this.executeRender();}catch(e){console.warn(e);}
if(this.chart){this.chart.on('resize',function(param){this.resize();});}},update:function(options){var modal,dsChartConfig,accuracy;var num,specialCond;if((!options)||options.length==0)return;modal=this.entity.modal;dsChartConfig=modal.dsChartCog&&modal.dsChartCog.length?modal.dsChartCog[0]:{};accuracy=dsChartConfig.accuracy;if(accuracy!==''&&!isNaN(accuracy)){specialCond=['',null,undefined];options=options.map(function(row,i){if(specialCond.indexOf(row.data)>-1||isNaN(row.data)){return row;}else{num=+row.data;row.data=num.toFixed(accuracy);return row;}});}
try{this.executeUpdate(options);}catch(e){console.warn(e);}},configure:function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e,callback){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this.screen.isScreenChange=true;_this=null;callback&&callback(true);})};divMask.appendChild(btnRemove);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;(this.entity.spanR>this.optionTemplate.maxHeight)&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);if(!(this instanceof ModalAnalysis)){var $divLink=$('<div class="divResize chartLink">');var $labelLink=$('<label>').text(I18n.resource.dashboard.show.LINK_TO);var chartLink=document.createElement('select');chartLink.className='form-control';chartLink.options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,''));for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);if(this.entity.modal.link==i){option.selected='selected';}
chartLink.options.add(option);}
chartLink.onchange=function(){_this.entity.modal.link=chartLink.value;_this.screen.isScreenChange=true;};$divLink.append($labelLink).append($(chartLink));divMask.appendChild($divLink[0]);}
var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();if(this.entity.isNotRender){var parentId=undefined,subChartIds;if(this.screen.entity&&this.screen.entity.id){parentId=this.screen.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'){if(!entity.modal.option)break;if(entity.modal.option.arrItem.length>0&&entity.modal.option.arrItem[0].subChartIds.length>0){var opts=entity.modal.option.arrItem;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}}
if(parentId){if(this.container.parentNode.parentNode.parentNode.className.indexOf('chartsCt')>=0)return;$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();if(!$sourceParent[0].classList.contains('chartsCt')&&$targetParent[0].classList.contains('chartsCt')){_this.screen.insertChartIntoMix(sourceId,$(e.target).closest('.chartsCt')[0])}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}
_this.screen.isScreenChange=true;}
this.executeConfigMode();},modalInit:function(){var _this=this;var dataItem=[],option;var dataTypeUnit;var type=false;if(_this.entity.modal.points!=undefined){if(_this.entity.modal.option&&_this.entity.modal.option.paraType){for(var i=0;i<_this.entity.modal.option.paraType.length;i++){dataTypeUnit={dsId:[],dsType:'',dsName:[]};dataTypeUnit.type=_this.entity.modal.option.paraType[i].type;var arrId=[];var arrItem=[];for(var j=0;j<_this.entity.modal.option.paraType[i].arrId.length;j++){arrId.push(_this.entity.modal.option.paraType[i].arrId[j]);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var j=0;j<_this.entity.modal.option.paraType[i].arrId.length;j++){var id=_this.entity.modal.option.paraType[i].arrId[j];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){dataTypeUnit.dsId.push(id);dataTypeUnit.dsName.push(arrItem[m].alias);break;}}}
dataItem.push(dataTypeUnit);}}else{dataTypeUnit={dsId:[],dsType:'',dsName:[]};var arrId=[];var arrItem=[];for(var i=0;i<_this.entity.modal.points.length;i++){arrId.push(_this.entity.modal.points[i]);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<_this.entity.modal.points.length;i++){var id=_this.entity.modal.points[i];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){dataTypeUnit.dsId.push(id);dataTypeUnit.dsName.push(arrItem[m].alias===""?arrItem[m].value:arrItem[m].alias);break;}}}
dataItem.push(dataTypeUnit);}}
if(_this.optionTemplate.mode==='custom'){_this.showConfigModal&&_this.showConfigModal();return;}
if(['ModalReportChapter','ModalReportFactory'].indexOf(_this.optionTemplate.type)>-1){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalMonitor'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalAppButton'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalAppKPICollect'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalReportFactory'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalDiagnosisPanelHtml'){return;}
var tempOptionPara;_this.entity.modal.option?tempOptionPara=_this.entity.modal.option:tempOptionPara={};tempOptionPara.dataItem=dataItem;option={modeUsable:_this.optionTemplate.mode,allDataNeed:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraAnlysMode:true,rowDataType:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraName:[I18n.resource.analysis.paneConfig.DATA_TYPE_DEFAULT],rowDataTypeShowName:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraShowName:undefined,dataTypeMaxNum:[_this.optionTemplate.maxNum],templateType:_this.optionTemplate.type,dsChartCog:_this.entity.modal.dsChartCog?_this.entity.modal.dsChartCog:null,optionPara:tempOptionPara};if(dataItem.length==0){type=true;}
if(_this.screen.screen){_this.screen.screen.modalConfigPane.showModalInit(type,option,_this);}else{if(!_this.screen.modalConfigPane){_this.screen.initModalConfigPane();}
_this.screen.modalConfigPane.showModalInit(type,option,_this);}
_this.screen.isScreenChange=true;},showConfigModal:function(){this.initConfigModalOpt();var ctn;try{var ctn=this.screen.container.querySelector('.cfgModal');}catch(e){var ctn=this.screen.shape.parentNode.parentNode.querySelector('.cfgModal')}
if(!ctn){if(this.screen.shape&&this.screen.shape.parentNode.parentNode){ctn=this.screen.shape.parentNode.parentNode;}else if(this.screen.screen){ctn=this.screen.screen.container;}else{ctn=this.screen.container;}}
this.configModal=new ConfigModal(this.configModalOpt,ctn,this);this.configModal.init();this.configModal.show();},initConfigModalOpt:function(){var _this=this;this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.render();}},setModalOption:function(option){},divResizeByToolInit:function(){var _this=this;var $divContainer=$('#divContainer_'+_this.entity.id);$divContainer.find('#heightResize').mousedown(function(e){$('.springConfigMask').attr('draggable','false');$('.springContent').attr('draggable','false');$(e.target).mousemove(function(e){$(e.target).closest('.springContainer').css('height',$(e.target).val()*_this.UNIT_HEIGHT*_this.spanRange.yScale+'%');_this.entity.spanR=Number($(e.target).val());$(e.target).next().text($(e.target).val()+' /'+_this.spanRange.maxHeight);if(_this.screen.screen){_this.screen.screen.setEntity(_this.entity);}else{_this.screen.setEntity(_this.entity);}});}).mouseup(function(e){$('.springConfigMask').attr('draggable','true');$('.springContent').attr('draggable','true');$(e.target).off('mousemove');if(_this.chart)_this.chart.resize();_this.screen.isScreenChange=true;_this.hasEdit=true;});$divContainer.find('#widthResize').mousedown(function(e){$('.springConfigMask').attr('draggable','false');$('.springContent').attr('draggable','false');$(e.target).mousemove(function(e){$(e.target).closest('.springContainer').css('width',$(e.target).val()*_this.UNIT_WIDTH*_this.spanRange.xScale+'%');_this.entity.spanC=Number($(e.target).val());$(e.target).next().text($(e.target).val()+' /'+_this.spanRange.maxWidth);if(_this.screen.screen){_this.screen.screen.setEntity(_this.entity);}else{_this.screen.setEntity(_this.entity);}});}).mouseup(function(e){$('.springConfigMask').attr('draggable','true');$('.springContent').attr('draggable','true');$(e.target).off('mousemove');if(_this.chart)_this.chart.resize();_this.screen.isScreenChange=true;_this.hasEdit=true;});$divContainer.find('.rangeVal').click(function(e){e.stopPropagation();var valueCurrent=Number($(e.target).prev().val());var valuePre=$(e.target).prev().val();var valueMax=Number($(e.target).prevAll('.inputResize').attr('max'));var valueMin=Number($(e.target).prevAll('.inputResize').attr('min'));$(e.target).nextAll('.rangeChange').css('display','inline-block').focus().off('blur').blur(function(e){valueCurrent=Number($(e.target).val());if(valueCurrent<=valueMax&&valueCurrent>=valueMin){$(e.target).prevAll('.inputResize').val(valueCurrent.toString());if($(e.target).prevAll('.inputResize').attr('id')=='widthResize'){$(e.target).closest('.springContainer').css('width',$(e.target).val()*_this.UNIT_WIDTH*_this.spanRange.xScale+'%');_this.entity.spanC=Number($(e.target).val());_this.screen.setEntity(_this.entity);$(e.target).prev().text($(e.target).val()+' /'+_this.spanRange.maxWidth);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{$(e.target).closest('.springContainer').css('height',$(e.target).val()*_this.UNIT_HEIGHT*_this.spanRange.yScale+'%');_this.entity.spanR=Number($(e.target).val());_this.screen.setEntity(_this.entity);$(e.target).prev().text($(e.target).val()+' /'+_this.spanRange.maxHeight);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
$(e.target).css('display','none');}else if(valueCurrent>valueMax){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR1+"</strong>").show().close();$(e.target).val(valuePre).css('display','none');}else if(valueCurrent<valueMin){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR2+"</strong>").show().close();$(e.target).val(valuePre).css('display','none');}else{if($(e.target).val()!=""){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR3+"</strong>").show().close();}
$(e.target).val(valuePre).css('display','none');}
_this.hasEdit&&(_this.screen.isScreenChange=true);})});},divResizeByMouseInit:function(){var _this=this;var $widthResize;var $heightResize;var divContainer=$('#divContainer_'+_this.entity.id).get(0);var resizeOnRight=document.createElement('div');resizeOnRight.className='resizeOnRight';divContainer.appendChild(resizeOnRight);var resizeOnBottom=document.createElement('div');resizeOnBottom.className='resizeOnBottom';divContainer.appendChild(resizeOnBottom);var resizeOnCorner=document.createElement('div');resizeOnCorner.className='resizeOnCorner';divContainer.appendChild(resizeOnCorner);var mouseStart={};var divStart={};var rightStart={};var bottomStart={};var w,h,tempSpanR,tempSpanC;resizeOnRight.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$widthResize=$(e.target).parent().find('#widthResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;rightStart.x=resizeOnRight.offsetLeft;doResizeOnRight(e);if(resizeOnRight.setCapture){resizeOnRight.onmousemove=doResizeOnRight;resizeOnRight.onmouseup=stopResizeOnRight;resizeOnRight.setCapture();}else{document.addEventListener("mousemove",doResizeOnRight,false);document.addEventListener("mouseup",stopResizeOnRight,false);}};function doResizeOnRight(e){var oEvent=e||event;var l=oEvent.clientX-mouseStart.x+rightStart.x;w=l+resizeOnCorner.offsetWidth;if(w<resizeOnCorner.offsetWidth){w=resizeOnCorner.offsetWidth;}
else if(w>document.documentElement.clientWidth-divContainer.offsetLeft){w=document.documentElement.clientWidth-divContainer.offsetLeft-2;}
divContainer.style.width=w+"px";}
function stopResizeOnRight(e){if(resizeOnRight.releaseCapture){tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";_this.entity.spanC=tempSpanC;resizeOnRight.onmousemove=null;resizeOnRight.onmouseup=null;resizeOnRight.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";_this.entity.spanC=tempSpanC;document.removeEventListener("mousemove",doResizeOnRight,false);document.removeEventListener("mouseup",stopResizeOnRight,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;$(e.target).prev().children(':last-child').attr('draggable',true);var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}}
resizeOnBottom.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$heightResize=$(e.target).parent().find('#heightResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;bottomStart.y=resizeOnBottom.offsetTop;doResizeOnBottom(e);if(resizeOnBottom.setCapture){resizeOnBottom.onmousemove=doResizeOnBottom;resizeOnBottom.onmouseup=stopResizeOnBottom;resizeOnBottom.setCapture();}else{document.addEventListener("mousemove",doResizeOnBottom,false);document.addEventListener("mouseup",stopResizeOnBottom,false);}};function doResizeOnBottom(e){var oEvent=e||event;var t=oEvent.clientY-mouseStart.y+bottomStart.y;h=t+resizeOnCorner.offsetHeight;if(h<resizeOnCorner.offsetHeight){h=resizeOnCorner.offsetHeight;}else if(h>document.documentElement.clientHeight-divContainer.offsetTop){h=document.documentElement.clientHeight-divContainer.offsetTop-2;}
divContainer.style.height=h+"px";}
function stopResizeOnBottom(e){if(resizeOnBottom.releaseCapture){tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanR=tempSpanR;resizeOnBottom.onmousemove=null;resizeOnBottom.onmouseup=null;resizeOnBottom.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanR=tempSpanR;document.removeEventListener("mousemove",doResizeOnBottom,false);document.removeEventListener("mouseup",stopResizeOnBottom,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;$(e.target).prev().children(':last-child').attr('draggable',true);var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}}
resizeOnCorner.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$widthResize=$(e.target).parent().find('#widthResize');$heightResize=$(e.target).parent().find('#heightResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;divStart.x=resizeOnCorner.offsetLeft;divStart.y=resizeOnCorner.offsetTop;doResizeOnCorner(e);if(resizeOnCorner.setCapture){resizeOnCorner.onmousemove=doResizeOnCorner;resizeOnCorner.onmouseup=stopResizeOnCorner;resizeOnCorner.setCapture();}else{document.addEventListener("mousemove",doResizeOnCorner,false);document.addEventListener("mouseup",stopResizeOnCorner,false);}};function doResizeOnCorner(e){var oEvent=e||event;var l=oEvent.clientX-mouseStart.x+divStart.x;var t=oEvent.clientY-mouseStart.y+divStart.y;w=l+resizeOnCorner.offsetWidth;h=t+resizeOnCorner.offsetHeight;if(w<resizeOnCorner.offsetWidth){w=resizeOnCorner.offsetWidth;}
else if(w>document.documentElement.clientWidth-divContainer.offsetLeft){w=document.documentElement.clientWidth-divContainer.offsetLeft-2;}
if(h<resizeOnCorner.offsetHeight){h=resizeOnCorner.offsetHeight;}else if(h>document.documentElement.clientHeight-divContainer.offsetTop){h=document.documentElement.clientHeight-divContainer.offsetTop-2;}
divContainer.style.width=w+"px";divContainer.style.height=h+"px";}
function stopResizeOnCorner(e){if(resizeOnCorner.releaseCapture){tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$widthResize.val(tempSpanC.toString()).get(0).setAttribute('value',tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());$heightResize.val(tempSpanR.toString()).get(0).setAttribute('value',tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanC=tempSpanC;_this.entity.spanR=tempSpanR;resizeOnCorner.onmousemove=null;resizeOnCorner.onmouseup=null;resizeOnCorner.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanC=tempSpanC;_this.entity.spanR=tempSpanR;document.removeEventListener("mousemove",doResizeOnCorner,false);document.removeEventListener("mouseup",stopResizeOnCorner,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}
$(e.target).prev().children(':last-child').attr('draggable',true);}
function rangeJudge(){if(tempSpanC>_this.spanRange.maxWidth){tempSpanC=_this.spanRange.maxWidth}else if(tempSpanC<_this.spanRange.minWidth){tempSpanC=_this.spanRange.minWidth}
if(tempSpanR>_this.spanRange.maxHeight){tempSpanR=_this.spanRange.maxHeight}else if(tempSpanR<_this.spanRange.minHeight){tempSpanR=_this.spanRange.minHeight}}},attachLkHistoryEvents:function(domItem){var _this=this;domItem.onclick=function(e){_this.modalDBHistory.setModal(_this.entity.modal,_this.chart);_this.modalDBHistory.show();e.preventDefault();e.stopPropagation();};},modalDBHistory:new ModalDBHistory(),initPointAlias:function(arrPoints){var arrPointsAlias=[];var lastRepeatIndex=-1;var tempAlias;var repeatNum=0;var tempIndex;var arrId=[];var arrItem=[];for(var i=0;i<arrPoints.length;++i){arrId.push(arrPoints[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<arrPoints.length;++i){for(var m=0;m<arrItem.length;m++){if(arrPoints[i].dsItemId==arrItem[m].id){arrPointsAlias.push(arrItem[m].alias);break;}}}
for(var i=0;i<arrPoints.length;++i){lastRepeatIndex=arrPointsAlias.lastIndexOf(arrPointsAlias[i]);if(lastRepeatIndex>i){repeatNum=1;tempAlias=arrPointsAlias[i];arrPointsAlias[i]=tempAlias+'_No1';tempIndex=i;for(var j=tempIndex+1;j<lastRepeatIndex+1;j++){repeatNum+=1;tempIndex=arrPointsAlias.indexOf(tempAlias);if(tempIndex==-1)break;arrPointsAlias[tempIndex]=tempAlias+'_No'+repeatNum;}}}
return arrPointsAlias;},close:function(){if(this.chart){this.chart.dispose();}
this.container=null;this.entity=null;this.executeConfigMode=null;this.executeRender=null;this.executeUpdate=null;this.screen=null;this.isConfigMode=null;this.reportScreen=null;typeof this._close==='function'&&this._close();},renderPop:function(pop){if(!pop)return;var $target=$('#divContainer_'+this.entity.id).find('.panel');var $panePop=$target.find('.panePop');var tpl='<div class="divMove"><span>{popMsg}</span></div>\
                <span class="glyphicon glyphicon-remove-circle btnClosePop" title="Close"></span>';if(!$panePop[0]){$panePop=$('<div class="panel-body panePop"></div>');$target.append($panePop);}
$panePop.html(tpl.formatEL({popMsg:pop.data}));var spanWidth=$panePop.find('span').width();var $divMove=$panePop.find('.divMove');if(spanWidth>$divMove.width()){var $marquee=$('<marquee direction="left" onmouseover="this.stop()" onmouseout="this.start()" scrollAmount="3" style="height: 40px; width: calc(100% - 28px);"></marquee>');$marquee.html($panePop.find('span').html());$marquee.appendTo($panePop);$divMove.remove();}
$panePop.find('.btnClosePop').off().click(function(){$panePop.hide();});},toggleDataSource:function(bool){var colCount=$('#paneContent')[0].classList.contains('col-sm-10');var ele=null;if(bool&&colCount){ele=document.getElementById('rightCt');ele&&ele.click();}
if(!bool&&!colCount){ele=document.getElementById('rightCt');ele&&ele.click();}},getSiblingChart:function(){var arrChartId=Object.keys(this.screen.listEntity);var arrChart=[];for(var i=0;i<arrChartId.length;i++){if(arrChartId[i]==this.entity.id)continue;arrChart.push({id:arrChartId[i],title:this.screen.listEntity[arrChartId[i]].entity.modal.title,name:this.screen.listEntity[arrChartId[i]].entity.modal.title})}
return arrChart;},initSubEntity:function(ctn,entity,cls){var id=+new Date();ctn.id='divContainer_'+id;entity.id=id;if(!cls)cls=ModalHtml;this.subEntity=new cls(this,entity);this.subEntity.render();},updateSubEntity:function(){this.subEntity.render()}};return ModalBase;})();﻿var ModalNone=(function(){function ModalNone(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,null,null);}
ModalNone.prototype=new ModalBase();ModalNone.prototype.optionTemplate={name:'',mode:['realTime'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalNone'};ModalNone.prototype.renderModal=function(){I18n.fillArea($('#coalSaveName').parent());$(this.container).parent().css('visibility','hidden');this.spinner.stop();},ModalNone.prototype.configure=function(){this.spinner.stop();var _this=this;$(_this.container).parent().css('visibility','');var divAdd=document.createElement('span');divAdd.className='springConfigTips';divAdd.innerHTML='Drag data meta from left panel';this.container.appendChild(divAdd);var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this=null;};this.container.appendChild(btnRemove);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;(this.entity.spanR>this.optionTemplate.maxHeight)&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';this.container.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';this.container.appendChild(btnWidthResize);this.divResizeByMouseInit();this.divResizeByToolInit();if(this.entity.isNotRender&&this.screen.entity){$(document.getElementById('divContainer_'+this.screen.entity.id)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}
if(this.entity.isNotRender){var parentId=undefined,subChartIds;if(this.screen.entity&&this.screen.entity.id){parentId=this.screen.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}
if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
var divParent=$(this.container).closest('.springContainer')[0];var divContent=$(divParent).find('.springContent')[0];divContent.draggable='true';divContent.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divContent.ondragover=function(e){e.preventDefault();};divContent.ondragleave=function(e){e.preventDefault();};divParent.ondrop=function(e){e.stopPropagation();if(e.dataTransfer.getData("type")&&e.dataTransfer.getData("title")){if(_this.screen.screen){var entity=_this.entity;if(_this.screen.entity.modal.type==='ModalAppBlind'){if(e.dataTransfer.getData("type")=='ModalMix'){alert('百叶窗内不能拖入组合图');return;}if(e.dataTransfer.getData("type")=="ModalPointKPI"){alert('百叶窗内不能拖入KPI尊享版');return false;}
if(e.dataTransfer.getData("type")=="ModalReportFactory"){alert('百叶窗内不能拖入报表章节');return false;}
if(e.dataTransfer.getData("type")=="ModalAppBlind"){alert('百叶窗内不能拖入百叶窗');return false;}else{_this.screen.screen.rebornEntity(entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"));}}else{if(e.dataTransfer.getData("type")=='ModalMix'){alert(I18n.resource.toolBox.modal.MSG_MIX_NOT_ALLOW_TO_MIX);return;}
if(e.dataTransfer.getData("type")=="ModalPointKPI"){alert(I18n.resource.toolBox.modal.MSG_KPI_NOT_ALLOW_TO_MIX);return false;}else{_this.screen.screen.rebornEntity(entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"));}}}else{_this.screen.rebornEntity(_this.entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"),_this.hasEdit);}}else if(e.dataTransfer.getData("id")){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');_this.screen.replaceEntity(e.dataTransfer.getData("id"),targetId);}}};return ModalNone;})();﻿var ModalAnalysis=(function(){var _this=undefined;function ModalAnalysis(screen,entityParams){entityParams.spanR=6;entityParams.spanC=12;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.spinner.stop();this.container=$('<div style="padding: 20px;position: absolute;left:0;top:0;right:0;bottom:0; z-index: 102; overflow-y: auto;"></div>').appendTo(this.container)[0];_this=this;this.curModal=this.entity.modal.option.option;this.entityAnalysis=undefined;this.saveModalJudge=$.Deferred();}
ModalAnalysis.prototype=new ModalBase();ModalAnalysis.prototype.optionTemplate={name:'toolBox.modal.TRANSIT',parent:2,mode:['realTimeWithoutRange'],maxNum:1,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalAnalysis'};ModalAnalysis.prototype.renderModal=function(){var modalClass=this.screen.factoryIoCAnalysis.getModel(this.entity.modal.option.type);this.screen.curModal=this.curModal;this.entityAnalysis=new modalClass(this.container,this.curModal,this);this.entityAnalysis.isShareMode=1;this.entityAnalysis.paneChart=null;this.entityAnalysis.chartAnimationDuration=500;this.entityAnalysis.animation=false;this.entityAnalysis.show();};ModalAnalysis.prototype.onresize=function(){if(this.entityAnalysis.chart)this.entityAnalysis.chart.resize();};ModalAnalysis.prototype.updateModal=function(points){};ModalAnalysis.prototype.showConfigMode=function(){};ModalAnalysis.prototype.setModalOption=function(option){};ModalAnalysis.prototype.alertNoData=function(){};ModalAnalysis.prototype.spinnerStop=function(){};ModalAnalysis.prototype.saveModal=function(){};return ModalAnalysis;})();﻿var ModalChart=(function(){function ModalChart(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.dicPeriod={'30s':30000,'m1':60000,'m5':300000,'10m':600000,'30m':1800000,'h1':3600000,'d1':86400000,'M1':2592000000}}
ModalChart.prototype=new ModalBase();ModalChart.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART',parent:0,mode:['realTime'],maxNum:10,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalChart'};ModalChart.prototype.optionDefault={color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500'],title:{textStyle:{fontWeight:'normal',color:'#008acd'}},legend:{textStyle:{fontFamily:"Microsoft YaHei",fontSize:10},top:'10',left:'center'},dataRange:{itemWidth:15,color:['#5ab1ef','#e0ffff']},toolbox:{x:'right',y:'center',feature:{mark:{show:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}},color:['#1e90ff','#1e90ff','#1e90ff','#1e90ff'],effectiveColor:'#ff4500'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{color:'#008acd'},crossStyle:{color:'#008acd'},shadowStyle:{color:'rgba(200,200,200,0.2)'}}},dataZoom:{dataBackgroundColor:'#efefff',fillerColor:'rgba(182,162,222,0.2)',handleColor:'#008acd'},grid:(function(isMobile){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:50,top:40}
if(isMobile){grid.x=40;}
return grid;}(AppConfig.isMobile)),categoryAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitLine:{lineStyle:{color:['#eee']}}},valueAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']}},splitLine:{lineStyle:{color:['#eee']}}},polar:{axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{lineStyle:{color:'#008acd'},controlStyle:{normal:{color:'#008acd'},emphasis:{color:'#008acd'}},symbol:'emptyCircle',symbolSize:3},bar:{itemStyle:{normal:{barBorderRadius:5},emphasis:{barBorderRadius:5}},barMaxWidth:80},line:{smooth:true,symbol:'none',symbolSize:3},k:{itemStyle:{normal:{color:'#d87a80',color0:'#2ec7c9',lineStyle:{color:'#d87a80',color0:'#2ec7c9'}}}},scatter:{symbol:'circle',symbolSize:4},radar:{symbol:'emptyCircle',symbolSize:3},map:{itemStyle:{normal:{areaStyle:{color:'#ddd'},label:{textStyle:{color:'#d87a80'}}},emphasis:{areaStyle:{color:'#fe994e'}}}},force:{itemStyle:{normal:{linkStyle:{color:'#1e90ff'}}}},chord:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}},emphasis:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}}}},gauge:{axisLine:{lineStyle:{color:[[0.2,'#2ec7c9'],[0.8,'#5ab1ef'],[1,'#d87a80']],width:10}},axisTick:{splitNumber:10,length:15,lineStyle:{color:'auto'}},splitLine:{length:22,lineStyle:{color:'auto'}},pointer:{width:5}},textStyle:{fontFamily:'微软雅黑, Arial, Verdana, sans-serif'}};ModalChart.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption(this.options);},ModalChart.prototype.updateModal=function(pointName,pointValue){},ModalChart.prototype.showConfigMode=function(){},ModalChart.prototype.dsChartCog=function(cog,option){if(!cog)return;if(cog[0].upper)option.yAxis[0].max=cog[0].upper;if(cog[0].lower)option.yAxis[0].min=cog[0].lower;if(cog[0].unit)option.yAxis[0].name=cog[0].unit;if(cog[0].markLine){if(!option.series[0].markLine){option.series[0].markLine={};option.series[0].markLine.data=new Array();}
for(var i in cog[0].markLine){var markLine=cog[0].markLine[i];if(!markLine.value)continue;var arr=[{name:markLine.name,xAxis:-1,yAxis:markLine.value},{name:markLine.name,xAxis:option.series[0].data.length,yAxis:markLine.value}];option.series[0].markLine.data.push(arr);}}}
ModalChart.prototype.coordinate=function(timeShaft){var arr=[],timeFormat=this.entity.modal.option.timeFormat,format;switch(timeFormat){case'm5':format='HH:mm';break;case'h1':format='HH:00';break;case'd1':format='yyyy-MM-dd';break;case'M1':format='yyyy-MM';break;default:format='yyyy-MM-dd HH:mm';break;}
for(var i=0,l=timeShaft.length;i<l;i++){arr.push(timeShaft[i].toDate().format(format));}
return[{data:arr}];},ModalChart.prototype.resize=function(){this.chart&&this.chart.resize();}
ModalChart.prototype.getData=function(params){var startTime,endTime,timeFormat,unit,postData={},arrPoint;var now=new Date();if(params&&params.dsItemIds){arrPoint=params.dsItemIds;}else{arrPoint=this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points;}
if(params&&params.timeFormat){timeFormat=params.timeFormat;}else{timeFormat=this.entity.modal.option.format;}
if(!params||!params.startTime||!params.endTime){if(this.entity.modal.option.mode==0){switch(this.entity.modal.option.recentTime){case'today':startTime=new Date(now.getTime()-86400000+3600000).format('yyyy-MM-dd HH:00:00');endTime=now.format('yyyy-MM-dd HH:00:00');break;case'threeDay':startTime=new Date(now.getTime()-86400000*3+3600000).format('yyyy-MM-dd HH:00:00');endTime=now.format('yyyy-MM-dd HH:00:00');break;case'yesterday':endTime=now;endTime.setHours(0);endTime.setMinutes(0);endTime.setSeconds(0);startTime=new Date(endTime.getTime()-86400000+3600000).format('yyyy-MM-dd HH:00:00');endTime=endTime.format('yyyy-MM-dd HH:00:00');break;case'thisWeek':endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(endTime);startTime.setDate(startTime.getDate()-6);startTime=startTime.format('yyyy-MM-dd 00:00:00');break;case'lastWeek':endTime=new Date(now.getTime()-now.getDay()*86400000).format('yyyy-MM-dd 00:00:00');;startTime=new Date(now.getTime()-(now.getDay()+6)*86400000).format('yyyy-MM-dd 00:00:00');;break;case'thisYear':endTime=now.format('yyyy-MM-01 00:00:00');startTime=now;startTime.setMonth(startTime.getMonth()-12);startTime=startTime.format('yyyy-MM-01 00:00:00');break;}}else if(this.entity.modal.option.mode==1){if(this.entity.modal.option.startTime&&this.entity.modal.option.endTime){startTime=new Date(this.entity.modal.option.startTime).format('yyyy-MM-dd HH:mm:ss');endTime=new Date(this.entity.modal.option.endTime).format('yyyy-MM-dd HH:mm:ss');}else{alert('请配置开始时间/结束时间');return;}}else if(this.entity.modal.option.mode==2){if(this.entity.modal.option.unit==='hour'){unit=3600000;endTime=new Date();if(timeFormat==='h1'){endTime.setMinutes(0);endTime.setSeconds(0);}
startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+1000).format('yyyy-MM-dd HH:mm:ss');}else if(this.entity.modal.option.unit==='day'){unit=86400000;endTime=new Date();endTime.setMinutes(0);endTime.setSeconds(0);if(timeFormat==='h1'){startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+3600000).format('yyyy-MM-dd HH:mm:ss');}else if(timeFormat==='d1'){startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+1000).format('yyyy-MM-dd HH:mm:ss');}}else if(this.entity.modal.option.unit==='month'){unit=2592000000;if(timeFormat==='d1'){endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(now.getTime()-86400000*30).format('yyyy-MM-dd 00:00:00');}else if(timeFormat==='M1'){alert('开发中');return;}}
endTime=endTime.format('yyyy-MM-dd HH:mm:ss');}}else{startTime=params.startTime;endTime=params.endTime;}
if(!arrPoint||arrPoint.length===0){postData.errorMsg='Data source is error';}
if(!startTime||!endTime){postData.errorMsg='Start time or end time is error';}
if(!timeFormat){postData.errorMsg='timeFormat is error';}
if(postData.errorMsg){alert(postData.errorMsg);return;}
postData.dsItemIds=arrPoint;postData.timeStart=startTime;postData.timeEnd=endTime;postData.timeFormat=timeFormat;return WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData);}
return ModalChart;})();var ModalRealtimePie=(function(){function ModalRealtimePie(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalRealtimePie.prototype=new ModalBase();ModalRealtimePie.prototype.optionTemplate={name:'',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};ModalRealtimePie.prototype.optionDefault={tooltip:{trigger:'item',formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:'vertical',x:'left',y:'center'},toolbox:{show:false,feature:{mark:{show:true},dataView:{show:true,readOnly:false},magicType:{show:true,type:['pie','funnel'],option:{funnel:{x:'25%',width:'50%',funnelAlign:'center',max:1548}}},restore:{show:true},saveAsImage:{show:true}}},calculable:true,color:['#E2583A','#FD9F08','#FEC500','#1D74A9','#04A0D6','#689C0F','#109d83'],series:[{type:'pie',radius:['50%','70%'],center:['50%','50%'],labelLine:{normal:{show:true,length:6,length2:60,lineStyle:{width:[2]}}},itemStyle:{normal:{label:{show:true,formatter:'{d}%'},labelLine:{show:true}},emphasis:{label:{show:true,position:'center',textStyle:{fontSize:'20',fontWeight:'bold'}}}}}]};ModalRealtimePie.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},ModalRealtimePie.prototype.updateModal=function(points){},ModalRealtimePie.prototype.showConfigMode=function(){},ModalRealtimePie.prototype.dealWithData=function(points,len){var arr=[];var arrLegend=this.initPointAlias(points);var arrSeries=[];for(var i=0;i<points.length;i++){var seriesData={value:tofixed(points[i].data),name:arrLegend[i]};arrSeries.push(seriesData);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimePie.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePie;})();var ModalRealtimeLine=(function(){function ModalRealtimeLine(screen,entityParams){if(!entityParams)return;ModalChart.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalRealtimeLine.prototype=new ModalChart();ModalRealtimeLine.prototype.optionTemplate={name:'',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};ModalRealtimeLine.prototype.optionDefault=$.extend(true,{},{grid:ModalChart.prototype.optionDefault.grid,legend:ModalChart.prototype.optionDefault.legend},{tooltip:{trigger:'axis'},legend:{data:[],orient:'horizontal'},toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']}}},calculable:(function(){if(AppConfig.isMobile){return false;}else{return true;}}()),color:['#E2583A','#FEC500','#04A0D6','#FD9F08','#1D74A9','#689C0F','#109d83'],xAxis:[{type:'category',boundaryGap:false,splitLine:{show:false},splitArea:{show:false},axisTick:{show:false}}],yAxis:[{type:'value',scale:true,splitLine:{show:(function(){if(AppConfig.isMobile){return false;}else{return true;}}())},splitArea:{show:false},axisLabel:{formatter:function(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],series:[{type:'line',symbol:'none',smooth:true}],animation:true});ModalRealtimeLine.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},ModalRealtimeLine.prototype.updateModal=function(points){},ModalRealtimeLine.prototype.showConfigMode=function(){},ModalRealtimeLine.prototype.dealWithData=function(points,dsChartCog){var arr=[],arrLegend=[],arrSeries=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);}
arrLegend=this.initPointAlias(points.list);for(var i=0;i<points.list.length;i++){var dataList=[];for(var j in points.list[i].data){if(typeof(points.list[i].data[j])==='number'){dataList.push(points.list[i].data[j].toFixed(accuracy));}}
var series={name:arrLegend[i],type:this.entity.modal.option.showType?this.entity.modal.option.showType:'line',symbol:'none',smooth:true,data:dataList,z:3,itemStyle:{normal:{label:{show:false,position:'top',formatter:'{b}\n{c}'},barBorderRadius:[5,5,0,0]}}}
arrSeries.push(series);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimeLine.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimeLine;})();var modalRealtimeBar=(function(){function modalRealtimeBar(screen,entityParams){if(!entityParams)return;ModalChart.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};modalRealtimeBar.prototype=new ModalChart();modalRealtimeBar.prototype.optionTemplate={parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};modalRealtimeBar.prototype.optionDefault=$.extend(true,{},{grid:ModalChart.prototype.optionDefault.grid,legend:ModalChart.prototype.optionDefault.legend},{tooltip:{trigger:'item'},calculable:(function(){if(AppConfig.isMobile){return false;}else{return true;}}()),xAxis:[{type:'category',show:true,splitLine:{show:false},splitArea:{show:false},axisTick:{show:false}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:(function(){if(AppConfig.isMobile){return false;}else{return true;}}())},axisLabel:{formatter:function(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true});modalRealtimeBar.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},modalRealtimeBar.prototype.updateModal=function(points){},modalRealtimeBar.prototype.showConfigMode=function(){},modalRealtimeBar.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return modalRealtimeBar;})();var ModalRealtimeBarEnegBrkd=(function(){function ModalRealtimeBarEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;modalRealtimeBar.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimeBarEnegBrkd.prototype=new modalRealtimeBar();ModalRealtimeBarEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_BAR_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeBarEnegBrkd'};ModalRealtimeBarEnegBrkd.prototype.renderModal=function(){},ModalRealtimeBarEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){this.lastRenderTime=now;var _this=this;var dsChartCog=this.entity.modal.dsChartCog;var entityItem=dealWithData(points,dsChartCog);var optionDefault={tooltip:{trigger:'item'},toolbox:{show:false},calculable:true,xAxis:[{type:'category',show:true}],yAxis:[{type:'value',show:true}],series:[{type:'bar',itemStyle:{normal:{color:function(params){var colorList=['#C1232B','#B5C334','#FCCE10','#E87C25','#27727B','#FE8463','#9BCA63','#FAD860','#F3A43B','#60C0DD','#D7504B','#C6E579','#F4E001','#F0805A','#26C0C0'];return colorList[params.dataIndex]},label:{show:true,position:'top',formatter:'{c}'}}},barMaxWidth:80}]};var entityData={xAxis:[{data:entityItem[0]}],series:[{data:entityItem[1],markPoint:{data:entityItem[2]}}]};this.dsChartCog(dsChartCog,entityData);!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption($.extend(true,{},this.optionDefault,optionDefault,entityData));}
function dealWithData(points,dsChartCog){var arr=[],arrXAxis=[],arrData=[],arrMpData=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);};arrXAxis=_this.initPointAlias(points);for(var i=0,temp;i<points.length;i++){temp=points[i];arrData.push(tofixed(temp.data,accuracy));arrMpData.push({xAxis:i,value:tofixed(temp.data,accuracy),name:arrXAxis[i],symbol:'none'})}
arr.push(arrXAxis);arr.push(arrData);arr.push(arrMpData);return arr;}},ModalRealtimeBarEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimeBarEnegBrkd;})();var ModalRealtimeBarSub=(function(){function ModalRealtimeBarSub(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;modalRealtimeBar.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalRealtimeBarSub.prototype=new modalRealtimeBar();ModalRealtimeBarSub.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_BAR',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeBarSub'};ModalRealtimeBarSub.prototype.renderModal=function(){},ModalRealtimeBarSub.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date();_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime);_this.optionDefault.animation=false;}
if(!this.entity.modal.option)this.entity.modal.option={};if(!this.entity.modal.option.timeFormat){this.entity.modal.option.timeFormat='h1';}
if(this.entity.modal.option.timeFormat==='m1'||this.entity.modal.option.timeFormat==='m5'||this.entity.modal.option.timeFormat==='h1'){var startTime=new Date(endTime-86400000);}else if(this.entity.modal.option.timeFormat==='d1'){var startTime=new Date(endTime-2592000000);}else if(this.entity.modal.option.timeFormat==='M1'){var startTime=new Date(endTime-31536000000);}
this.lastRenderTime=now;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime.format('yyyy-MM-dd HH:mm:ss'),timeEnd:endTime.format('yyyy-MM-dd HH:mm:ss'),timeFormat:_this.entity.modal.option.timeFormat}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10},xAxis:_this.coordinate(dataSrc.timeShaft),yAxis:[{}],toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']}}},series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,entityData));}).error(function(e){}).always(function(e){});}},ModalRealtimeBarSub.prototype.dealWithData=function(points,dsChartCog){var arr=[],arrLegend=[],arrSeries=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);}
arrLegend=this.initPointAlias(points.list);for(var i=0;i<points.list.length;i++){var key=points.list[i].dsItemId,dataList=[];for(var j in points.list[i].data){dataList.push(points.list[i].data[j].toFixed(accuracy));}
var series={name:arrLegend[i],type:'bar',symbol:'none',smooth:true,data:dataList,itemStyle:{normal:{label:{show:false,position:'top',formatter:'{b}\n{c}'},barBorderRadius:[5,5,0,0]}}}
arrSeries.push(series);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimeBarSub.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeBarSub.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalRealtimeBarSub;})();var ModalRealtimePieEnegBrkd=(function(){function ModalRealtimePieEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimePie.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimePieEnegBrkd.prototype=new ModalRealtimePie();ModalRealtimePieEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_PIE_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimePieEnegBrkd'};ModalRealtimePieEnegBrkd.prototype.renderModal=function(){}
ModalRealtimePieEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){this.lastRenderTime=now;var entityItem=this.dealWithData(points,4);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10,top:20},series:[{data:entityItem[1]}]};this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},this.optionDefault,entityData));}},ModalRealtimePieEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePieEnegBrkd;})();var ModalRealtimeLineOutdoor=(function(){function ModalRealtimeLineOutdoor(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalRealtimeLineOutdoor.prototype=new ModalRealtimeLine();ModalRealtimeLineOutdoor.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_LINE_OUTDOOR',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeLineOutdoor'},ModalRealtimeLineOutdoor.prototype.renderModal=function(){this.updateModal();}
ModalRealtimeLineOutdoor.prototype.updateModal=function(points){var pointNameList=[];if(!points&&this.entity.modal.points){if(this.entity.modal.points[0]instanceof Array){pointNameList=this.entity.modal.points[0];}else{pointNameList=this.entity.modal.points;}}else{points&&points.length>0&&(pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points));}
if(pointNameList.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var endTime,startTime;if(!_this.m_bIsGoBackTrace){endTime=new Date();_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime);_this.optionDefault.animation=false;}
if(!this.entity.modal.option)this.entity.modal.option={};if(!this.entity.modal.option.timeFormat){this.entity.modal.option.timeFormat='h1';}
if(this.entity.modal.option.timeFormat==='m1'||this.entity.modal.option.timeFormat==='m5'||this.entity.modal.option.timeFormat==='h1'){startTime=new Date(endTime-86400000);}else if(this.entity.modal.option.timeFormat==='d1'){startTime=new Date(endTime-2592000000);}else if(this.entity.modal.option.timeFormat==='M1'){startTime=new Date(endTime-31536000000);}
this.lastRenderTime=now;this.getData({dsItemIds:pointNameList,timeFormat:this.entity.modal.option.timeFormat}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10},xAxis:_this.coordinate(dataSrc.timeShaft),yAxis:[{}],series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,entityData));}).error(function(e){}).always(function(e){});}},ModalRealtimeLineOutdoor.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeLineOutdoor.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};ModalRealtimeLineOutdoor.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={})
var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,format:this.entity.modal.option.format,recentTime:this.entity.modal.option.recentTime,val:this.entity.modal.option.val,unit:this.entity.modal.option.unit,startTime:this.entity.modal.option.startTime,endTime:this.entity.modal.option.endTime}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:data=>{!this.entity.modal.option&&(this.entity.modal.option={});this.entity.modal.option.mode=data.mode;this.entity.modal.option.format=data.format;if(data.mode==='1'){this.entity.modal.option.startTime=data.startTime;this.entity.modal.option.endTime=data.endTime;}else if(data.mode==='2'){this.entity.modal.option.unit=data.unit;this.entity.modal.option.val=data.val;}
this.entity.modal.option.recentTime=data.recentTime;this.entity.modal.option.showType=data.selChartType.val;this.entity.modal.points=data.points[0];this.lastRenderTime=null;this.setModalOption();this.updateModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalRealtimeLineOutdoor;})();var ModalRealtimeGauge=(function(){function ModalRealtimeGauge(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalRealtimeGauge.prototype=new ModalBase();ModalRealtimeGauge.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_GAUGE',parent:0,mode:['gauge'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeGauge'};ModalRealtimeGauge.prototype.optionDefault={tooltip:{formatter:"{c}"},animation:true,animationDuration:1000,animationDurationUpdate:1000,series:[{name:'PUE',type:'gauge',splitNumber:10,axisLine:{show:true,lineStyle:{width:8}},axisTick:{show:true,splitNumber:5,length:15,lineStyle:{width:1,type:'solid',color:'auto'}},axisLabel:{textStyle:{color:'auto'},formatter:function(v){return v.toFixed(2);}},splitLine:{show:true,length:20,lineStyle:{color:'auto'}},pointer:{width:5},detail:{formatter:'{value}',textStyle:{fontSize:12}}}]};ModalRealtimeGauge.prototype.renderModal=function(){},ModalRealtimeGauge.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var scaleList=[];for(var i=0;i<_this.entityOption.scaleList.length;i++){scaleList.push(_this.entityOption.scaleList[i]);}
var colorList=['#1abc9c','#3598db','#e84c3d'];if(scaleList[scaleList.length-1]<scaleList[0]){scaleList.reverse();colorList=['#e84c3d','#3598db','#1abc9c'];}
this.optionDefault.series[0].max=scaleList[scaleList.length-1];this.optionDefault.series[0].min=scaleList[0];this.optionDefault.series[0].data=[{value:parseFloat(points[0].data).toFixed(2)}];this.optionDefault.series[0].axisLine.lineStyle.color=function(option){var arr=[],colorIndex=0;for(var i=0;i<option.length;i++){if(i==0){continue;}
arr.push([((option[i]-option[0])/(_this.optionDefault.series[0].max-_this.optionDefault.series[0].min)).toFixed(3),colorList[colorIndex]]);colorIndex++;}
return arr;}(scaleList);!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption(this.optionDefault);},ModalRealtimeGauge.prototype.showConfigMode=function(){},ModalRealtimeGauge.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.scaleList=option.scaleList;this.entity.modal.interval=5;};return ModalRealtimeGauge;})();function tofixed(str,accuracy){if(!accuracy)accuracy=2;return parseFloat(str).toFixed(accuracy);}
var ModalHistoryChart=(function(){function ModalHistoryChart(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalHistoryChart.prototype=new ModalChart();ModalHistoryChart.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChart'};ModalHistoryChart.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:true},grid:(function(){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:40,top:40}
if(AppConfig.isMobile){grid.x=40;}
return grid;}()),xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:(function(){if(AppConfig.isMobile){return false;}else{return true;}}())},axisLabel:{formatter:function(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true};ModalHistoryChart.prototype.renderModal=function(){!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var _this=this;if(!_this.m_bIsGoBackTrace){_this.optionDefault.animation=true;}
this.getData().done(function(dataSrc){if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var option=_this.initOption(dataSrc);if(undefined==option||undefined==option.series[0].data||0==option.series[0].data.length){return;}
var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChart.prototype.updateModal=function(options){},ModalHistoryChart.prototype.showConfigMode=function(){},ModalHistoryChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;}
ModalHistoryChart.prototype.resize=function(){this.chart&&this.chart.resize();}
return ModalHistoryChart;})();var ModalHistoryChartNormal=(function(){var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];var m_colorLen=m_color.length;function ModalHistoryChartNormal(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartNormal.prototype=new ModalHistoryChart();ModalHistoryChartNormal.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ENERGY_LINE',parent:1,mode:['easyHistorySelect'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartNormal'}
ModalHistoryChartNormal.prototype.initOption=function(dataSrc){if(!dataSrc||!dataSrc.list[0].data){return;}
var xLen=dataSrc.timeShaft.length;var xAxis,format;var arrXAxis=[];if('month'==this.entity.modal.option.timeType||this.entity.modal.option.format==='d1'){format="MM-dd"}
else if('week'==this.entity.modal.option.timeType){format="yyyy-MM-dd";}
else if('day'==this.entity.modal.option.timeType||this.entity.modal.option.format==='h1'){format="MM-dd HH:00";}else if(this.entity.modal.option.format==='m5'){format="MM-dd HH:mm";}else if(this.entity.modal.option.format==='M1'){format="yyyy-MM";}
for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format(format));}
xAxis=[{type:'category',data:arrXAxis}]
var dataName=this.initPointAlias(dataSrc.list);var arrSeries=[];var showColor='#1abd9b';for(var i=0;i<dataSrc.list.length;i++){if(dataSrc.list.length>1){showColor=m_color[i%m_colorLen];}
arrSeries.push({name:dataName[i],type:this.entity.modal.option.showType,data:dataSrc.list[i].data,itemStyle:{normal:{barBorderRadius:[5,5,0,0]},emphasis:{barBorderRadius:[5,5,0,0]}}});}
var dataOption={title:{text:'',subtext:''},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},dataZoom:{show:false},xAxis:xAxis,series:arrSeries};return dataOption;};ModalHistoryChartNormal.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType=option.showType;this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartNormal.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={})
var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,format:this.entity.modal.option.format,recentTime:this.entity.modal.option.recentTime,val:this.entity.modal.option.val,unit:this.entity.modal.option.unit,startTime:this.entity.modal.option.startTime,endTime:this.entity.modal.option.endTime}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:data=>{!this.entity.modal.option&&(this.entity.modal.option={});this.entity.modal.option.mode=data.mode;this.entity.modal.option.format=data.format;if(data.mode==='1'){this.entity.modal.option.startTime=data.startTime;this.entity.modal.option.endTime=data.endTime;}else if(data.mode==='2'){this.entity.modal.option.unit=data.unit;this.entity.modal.option.val=data.val;}
this.entity.modal.option.showType=data.selChartType.val;this.entity.modal.option.recentTime=data.recentTime;this.entity.modal.points=data.points[0];this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalHistoryChartNormal;})();var ModalHistoryChartEnergyConsume=(function(){function ModalHistoryChartEnergyConsume(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartEnergyConsume.prototype=new ModalHistoryChart();ModalHistoryChartEnergyConsume.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ENERGY_BAR',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartEnergyConsume'}
ModalHistoryChartEnergyConsume.prototype.initOption=function(dataSrc){if(!dataSrc||!dataSrc.list||!dataSrc.list[0]){return;}
var xLen=dataSrc.timeShaft.length;var xAxis,format;var arrXAxis=[];if('month'==this.entity.modal.option.timeType||this.entity.modal.option.format==='d1'){format="MM-dd"}
else if('week'==this.entity.modal.option.timeType){format="yyyy-MM-dd";}
else if('day'==this.entity.modal.option.timeType||this.entity.modal.option.format==='h1'){format="MM-dd HH:00";}else if(this.entity.modal.option.format==='m5'){format="MM-dd HH:mm";}else if(this.entity.modal.option.format==='M1'){format="yyyy-MM";}
for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format(format));}
xAxis=[{type:'category',data:arrXAxis}]
var dataName=this.initPointAlias(dataSrc.list);var arrSeries=[];for(var i=0;i<dataSrc.list.length;i++){if(dataSrc.list.length>1){}
var arrData=[];var hisLen=dataSrc.list[0].data.length;var defVal;var fixNum=0;for(var j=1;j<hisLen;j++){var preVal=dataSrc.list[0].data[j-1];if(0==preVal){arrData.push(0);continue;}
defVal=dataSrc.list[0].data[j]-preVal;if(defVal<100){fixNum=2;}
else{fixNum=0;}
arrData.push(parseFloat(defVal.toFixed(fixNum)));}
arrSeries.push({name:dataName[i],type:this.entity.modal.option.showType,data:arrData,itemStyle:{normal:{barBorderRadius:[5,5,5,5]},emphasis:{barBorderRadius:[5,5,5,5]}}});i++;}
var dataOption={title:{text:'',subtext:''},legend:{show:true,data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},dataZoom:{show:false},xAxis:xAxis,series:arrSeries};return dataOption;};ModalHistoryChartEnergyConsume.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='bar';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartEnergyConsume.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={})
var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,format:this.entity.modal.option.format,recentTime:this.entity.modal.option.recentTime,val:this.entity.modal.option.val,unit:this.entity.modal.option.unit,startTime:this.entity.modal.option.startTime,endTime:this.entity.modal.option.endTime}},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:data=>{!this.entity.modal.option&&(this.entity.modal.option={});this.entity.modal.option.mode=data.mode;this.entity.modal.option.format=data.format;if(data.mode==='1'){this.entity.modal.option.startTime=data.startTime;this.entity.modal.option.endTime=data.endTime;}else if(data.mode==='2'){this.entity.modal.option.unit=data.unit;this.entity.modal.option.val=data.val;}
this.entity.modal.option.recentTime=data.recentTime;this.entity.modal.option.showType='bar';this.entity.modal.points=data.points[0];this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalHistoryChartEnergyConsume;})();var ModalHistoryChartYearOnYearLine=(function(){var _this;function ModalHistoryChartYearOnYearLine(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigModal=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigModal);this.option=entityParams.option;this.spinner&&this.spinner.spin(this.container);this.store={};this.pointAlias=this.entity.modal.points?AppConfig.datasource.getDSItemById(this.entity.modal.points[0]).alias:'';this.m_bIsGoBackTrace=false;this.m_traceData=undefined;_this=this;!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartYearOnYearLine.prototype=new ModalHistoryChart();ModalHistoryChartYearOnYearLine.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_YEAR_LINE',parent:1,mode:['easyCompareToggle'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartYearOnYearLine'};ModalHistoryChartYearOnYearLine.prototype.optionDefault={tooltip:{trigger:'axis',formatter:function(params){var tar0=params[0];var tar1=params[1];var pointAlias=_this.pointAlias;return pointAlias+' : '+tar0.name+'<br/>'+tar0.seriesName+' : '+tar0.value+'<br/>'
+tar1.seriesName+' : '+tar1.value;}},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:false},color:['#E2583A','#FD9F08','#FEC500','#1D74A9','#04A0D6','#689C0F','#109d83'],xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChartYearOnYearLine.prototype.renderModal=function(){var _this=this;!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var hourMilSec=3600000;var dayMilSec=86400000;var startDate=new Date();var endDate=new Date();var tmFlag=new Date();var timeType=_this.entity.modal.option.format?_this.entity.modal.option.format:'h1';if('hour'==_this.entity.modal.option.timeType||'m5'===timeType){startDate.setTime(endDate.getTime()-hourMilSec);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(endDate.getTime());tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}else if('day'==_this.entity.modal.option.timeType||'h1'==timeType){startDate.setTime(endDate.getTime()-dayMilSec);startDate.setHours(0);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(endDate.getTime());tmFlag.setHours(0);tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else{return;}
var curDate,startTime,endTime;if(!_this.m_bIsGoBackTrace){startTime=startDate.format('yyyy-MM-dd 00:00:00');endTime=endDate.format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('hour'==_this.entity.modal.option.timeType){timeType='m5';startDate.setTime(curDate.getTime()-hourMilSec);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(curDate.getTime());tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(curDate.getTime()-dayMilSec);startDate.setHours(0);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(curDate.getTime());tmFlag.setHours(0);tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else{return;}
startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=curDate.format('yyyy-MM-dd HH:mm:ss');}
this.getData({startTime:startTime,endTime:endTime,timeFormat:timeType}).done(function(dataSrc){if(!dataSrc||!dataSrc.list||!dataSrc.list[0]||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var arrXAxis=[];var flagCount=0;var len=dataSrc.timeShaft.length;tmFlag=tmFlag.format('yyyy-MM-dd HH:mm:ss');for(flagCount=0;flagCount<len;flagCount++){if(dataSrc.timeShaft[flagCount]>=tmFlag){break;}}
_this.store.timeShaft=dataSrc.timeShaft.slice(0,flagCount);_this.store.deadline=dataSrc.timeShaft[flagCount-1].toDate().valueOf();var fixNum=0;var setVal;var dataName=[];var arrSeries=[];for(var k=0,lenK=Math.min(flagCount,dataSrc.timeShaft.length);k<lenK;k++){arrXAxis.push(dataSrc.timeShaft[k].toDate().format("HH:mm"));}
var chartType=_this.entity.modal.option.showType?_this.entity.modal.option.showType:'line';var currentCount=0;for(var n=0;n<dataSrc.list.length;n++){var key=dataSrc.list[n].dsItemId;var dataSrc1=[];var dataSrc2=[];var eachName=[];if(1==dataSrc.list.length){dataName.push(I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(I18n.resource.dataSource.TIME_TODAY);eachName.push(I18n.resource.dataSource.TIME_YESTERDAY);eachName.push(I18n.resource.dataSource.TIME_TODAY);}
else{dataName.push(key+'_'+I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(key+'_'+I18n.resource.dataSource.TIME_TODAY);eachName.push(key+'_'+I18n.resource.dataSource.TIME_YESTERDAY);eachName.push(key+'_'+I18n.resource.dataSource.TIME_TODAY);}
for(var j=0,len=dataSrc.list[n].data.length;j<len;j++){setVal=dataSrc.list[n].data[j];if(setVal<100){fixNum=2;}
else{fixNum=0;}
setVal=parseFloat(setVal.toFixed(fixNum));if(j<flagCount){dataSrc1.push(setVal);}
else{dataSrc2.push(setVal);}}
var showColor;var showData;var showMark;for(var i=0;i<2;i++){if(0==i){if(0==currentCount){showColor='#1abd9b';}
else{showColor=echarts.config.color[currentCount*2];}
showData=dataSrc1;showMark={data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.MAXIMUM},{type:'min',name:I18n.resource.dashboard.modalHistoryChart.MINIMUM}]}}
else if(1==i){if(0==currentCount){showColor='#e74a37';}
else{showColor=echarts.config.color[currentCount*2+1];}
showData=dataSrc2;var lastCntX=dataSrc2.length-1;var lastCntY=Number(dataSrc2[lastCntX]);showMark={symbol:'emptyCircle',symbolSize:10,effect:{show:true,shadowBlur:0},itemStyle:{normal:{label:{show:false}},emphasis:{label:{position:'top'}}},data:[{name:'',value:lastCntY,xAxis:lastCntX,yAxis:lastCntY}]}}
arrSeries.push({name:eachName[i],type:chartType,data:showData,itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,0,0]},emphasis:{color:showColor,barBorderRadius:[5,5,0,0]}},symbolSize:3});if(i===1){arrSeries[1].symbol='rect';var blingDot=$.extend(true,{},arrSeries[1]);var seriesOne=arrSeries[1];seriesOne.type='effectScatter';seriesOne.symbolSize=10;seriesOne.symbol='circle'
seriesOne.rippleEffect={brushType:'stroke'};seriesOne.itemStyle.normal.shadowBlur=10;var blingDotData=$.extend(true,{},showData);for(var p=0,lens=showData.length;p<lens;p++){if(p<lens-1){showData[p]='-';}}
var blingDotDataArr=[];for(var item in blingDotData){blingDotDataArr.push(blingDotData[item]);}
blingDot.data=showData;arrSeries[1]=blingDot;arrSeries[1].data=blingDotDataArr;arrSeries.push(seriesOne);}
showColor='';}
currentCount++;}
var xAxis=[{type:'category',boundaryGap:false,data:arrXAxis}]
var option={title:{text:'',subtext:''},dataZoom:{show:false},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},xAxis:xAxis,series:arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=option.series[i].data[j].toFixed(n);}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChartYearOnYearLine.prototype.updateModal=function(options){var _this=this;var modalOptions=this.entity.modal.option;var lastIndex,lastTick,nowTick;if(undefined===options||options.length<1||undefined===options[0]){return;}
lastIndex=this.chart.getOption().series[1].data.length-1;lastTick=this.store.timeShaft[lastIndex].toDate().valueOf();nowTick=new Date().valueOf();if(lastTick===undefined)return;if('hour'===modalOptions.timeType){lastTick+=3600000;refreshInterval=300000;}
if('day'===modalOptions.timeType){lastTick+=86400000;refreshInterval=3600000;}
else{return;}
if(nowTick<lastTick+refreshInterval)return;var opt=_this.chart.getOption();for(var i=0,len=options.length;i<len;i++){if(options[i].data!==null){opt.series[1].data.push(options[i].data);}}
_this.chart.setOption(opt);var dataSeries=_this.chart.getOption().series;if(dataSeries.length<2){return;}
var temp=dataSeries[1].data;var lastCntX=temp.length-1;var lastCntY=Number(temp[lastCntX]);var showMark={symbol:'emptyCircle',symbolSize:10,effect:{show:true,shadowBlur:0},itemStyle:{normal:{label:{show:false}},emphasis:{label:{position:'top'}}},data:[{name:'',value:lastCntY,xAxis:lastCntX,yAxis:lastCntY}]}
_this.chart.addMarkPoint(1,showMark);},ModalHistoryChartYearOnYearLine.prototype.showConfigMode=function(){},ModalHistoryChartYearOnYearLine.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType=option.showType?option.showType:'line';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartYearOnYearLine.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={})
var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:'0',format:'h1',recentTime:'yesterday'}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:data=>{!this.entity.modal.option&&(this.entity.modal.option={});this.entity.modal.option.mode=0;this.entity.modal.option.format='h1';this.entity.modal.option.showType=data.selChartType.val;this.entity.modal.option.recentTime='yesterday';this.entity.modal.points=data.points[0];this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.modalBody.querySelector('.divMode select').disabled=true;this.configModal.modalBody.querySelector('.divRecentTime select').disabled=true;this.configModal.show();};return ModalHistoryChartYearOnYearLine;})();var ModalHistoryChartYearOnYearBar=(function(){var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];function ModalHistoryChartYearOnYearBar(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigModal=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigModal);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;this.option=entityParams.option;this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartYearOnYearBar.prototype=new ModalHistoryChart();ModalHistoryChartYearOnYearBar.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_YEAR_BAR',parent:1,mode:['easyCompare'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartYearOnYearBar'};ModalHistoryChartYearOnYearBar.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:false},xAxis:[{type:'category',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChartYearOnYearBar.prototype.renderModal=function(){var _this=this;!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var dayMilSec=86400000;var startDate=new Date();var endDate=new Date();var startDateZero=new Date();var endDateZero=new Date();var timeType=_this.entity.modal.option.format?_this.entity.modal.option.format:'h1';if('day'==_this.entity.modal.option.timeType||'h1'==timeType){startDate.setTime(endDate.getTime()-dayMilSec);startDateZero.setTime(startDate.getTime());startDateZero.setHours(0);startDateZero.setMinutes(0);startDateZero.setSeconds(0);endDateZero.setTime(endDate.getTime());endDateZero.setHours(0);endDateZero.setMinutes(0);endDateZero.setSeconds(0);}
else{return;}
var curDate;if(!_this.m_bIsGoBackTrace){_this.optionDefault.animation=true;}
else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(curDate.getTime()-dayMilSec);startDateZero.setTime(startDate.getTime());startDateZero.setHours(0);startDateZero.setMinutes(0);startDateZero.setSeconds(0);endDateZero.setTime(curDate.getTime());endDateZero.setHours(0);endDateZero.setMinutes(0);endDateZero.setSeconds(0);}
else{return;}}
this.getData({startTime:startDateZero.format('yyyy-MM-dd HH:mm:ss'),endTime:endDate.format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeType}).done(function(dataSrc){if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var flag1,flag2;var len=dataSrc.timeShaft.length;for(var i=0;i<len;i++){if(dataSrc.timeShaft[i].toDate()>=startDate){flag1=i;break;}}
for(var i=0;i<len;i++){if(dataSrc.timeShaft[i].toDate()>=endDateZero){flag2=i;break;}}
var arrVal1=[];var arrVal2=[];var val1=0;var val2=0;var fixNum1=0;var fixNum2=0;var preVal=0;for(var i=0;i<dataSrc.list.length;i++){for(var j=0,len=dataSrc.list[i].data.length;j<len;j++){if(j==flag1){preVal=dataSrc.list[i].data[0];if(0==preVal){val1=0;}
else{val1=dataSrc.list[i].data[j]-preVal;}}
else if(j==flag2){preVal=dataSrc.list[i].data[j];if(0==preVal){val2=0;}
else{val2=dataSrc.list[i].data[len-1]-preVal;}}}
if(val1<100){fixNum1=2;}
else{fixNum1=0;}
if(val2<100){fixNum2=2;}
else{fixNum2=0;}
arrVal1.push(parseFloat(val1.toFixed(fixNum1)));arrVal2.push(parseFloat(val2.toFixed(fixNum2)));break;}
var tmFlag=new Date();var arrXAxis=[];tmFlag=tmFlag.format('yyyy-MM-dd HH:mm:ss');for(var flagCount=0;flagCount<len;flagCount++){if(dataSrc.timeShaft[flagCount]>=tmFlag){break;}}
for(var k=0,lenK=Math.min(flagCount,dataSrc.timeShaft.length);k<lenK;k++){arrXAxis.push(dataSrc.timeShaft[k].toDate().format("HH:mm"));}
var xAxis=[{type:'category',boundaryGap:true,data:arrXAxis}];var chartType=_this.entity.modal.option.showType?_this.entity.modal.option.showType:'bar';var dataName=[];dataName.push(I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(I18n.resource.dataSource.TIME_TODAY);var arrSeries=[{name:dataName[0],type:chartType,data:arrVal1,itemStyle:{normal:{color:m_color[2],barBorderRadius:[5,5,0,0]},emphasis:{color:m_color[2],barBorderRadius:[5,5,0,0]}},markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.EnergyConsumption}]}},{name:dataName[1],type:chartType,data:arrVal2,itemStyle:{normal:{color:m_color[1],barBorderRadius:[5,5,0,0]},emphasis:{color:m_color[1],barBorderRadius:[5,5,0,0]}},markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.EnergyConsumption}]}},];var option={title:{text:'',subtext:''},dataZoom:{show:false},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},xAxis:xAxis,series:arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=option.series[i].data[j].toFixed(n);}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChartYearOnYearBar.prototype.updateModal=function(options){},ModalHistoryChartYearOnYearBar.prototype.showConfigMode=function(){},ModalHistoryChartYearOnYearBar.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='bar';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartYearOnYearBar.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={})
var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:'0',format:'h1',recentTime:'yesterday'}},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:data=>{!this.entity.modal.option&&(this.entity.modal.option={});this.entity.modal.option.mode=0;this.entity.modal.option.format='h1';this.entity.modal.option.recentTime='yesterday';this.entity.modal.points=data.points[0];this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.modalBody.querySelector('.divMode select').disabled=true;this.configModal.modalBody.querySelector('.divRecentTime select').disabled=true;this.configModal.show();};return ModalHistoryChartYearOnYearBar;})();var ModalHistoryDataAnalyze=(function(){function ModalHistoryDataAnalyze(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.store=[];!AppConfig.datasource&&(AppConfig.datasource={getDSItemById:DataSource.prototype.getDSItemById.bind({m_parent:{store:{dsInfoList:[]}},m_arrCloudTableInfo:[]})})}
ModalHistoryDataAnalyze.prototype=new ModalHistoryChart();ModalHistoryDataAnalyze.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ANALYSE',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryDataAnalyze'};ModalHistoryDataAnalyze.prototype.renderModal=function(){this.container.innerHTML='\
        <div class="ctnTimeConfig"><div class="divTimeConfig clearfix"></div>\
            <!--<div class="divDataConfig"></div>-->\
            <div class="btnTimeConfigGrp">\
            <div class="divConfigConfirm btn btn-primary" i18n="dashboard.modalHistoryDataAnalyze.DATE_CONFIRM">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DATE_CONFIRM+'</div>\
            <div class="divConfigCancel btn btn-default" i18n="dashboard.modalHistoryDataAnalyze.DATE_CANCEL">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DATE_CANCEL+'</div>\
            </div>\
        </div>\
        <div class="btnShowTimeConfig glyphicon glyphicon-cog"></div>\
        <div class="dragTip" i18n="dashboard.modalHistoryDataAnalyze.DRAG_TIP_FOR_CHART">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DRAG_TIP_FOR_CHART+'</div>\
        <div class="divHistoryChart"></div>\
        ';this.container.parentNode.className+=' widgetHistoryAnalyze forDashboard';this.ctnTimeConfig=this.container.querySelector('.ctnTimeConfig');this.divTimeConfig=this.container.querySelector('.divTimeConfig');this.ctnChart=this.container.querySelector('.divHistoryChart');this.createTimeConfig();this.attachEvent();I18n.fillArea($(this.container));};ModalHistoryDataAnalyze.prototype.createTimeConfig=function(){var mode=document.createElement('div');mode.className='divTimeMode';mode.innerHTML='\
        <label i18n="modalConfig.option.LABEL_MODE">'+I18n.resource.modalConfig.option.LABEL_MODE+'</label>\
        <select class="form-control iptTimeMode">\
            <option value="0" i18n="modalConfig.option.MODE_CURRENT">'+I18n.resource.modalConfig.option.MODE_CURRENT+'</option>\
            <option value="1" i18n="modalConfig.option.MODE_RECENT">'+I18n.resource.modalConfig.option.MODE_RECENT+'</option>\
            <option value="2" i18n="modalConfig.option.MODE_FIXED">'+I18n.resource.modalConfig.option.MODE_FIXED+'</option>\
        </select>';this.divTimeConfig.appendChild(mode);this.createTimeRange(0);I18n.fillArea($(this.ctnTimeConfig));};ModalHistoryDataAnalyze.prototype.createTimeRange=function(mode){$(this.divTimeConfig).find('.divTimeInterval').remove();$(this.divTimeConfig).find('.divTimeRange').remove();var divTimeRange=document.createElement('div');divTimeRange.className='divTimeRange form-group';switch(mode){case 0:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <select class="form-control selRecentTimeRange">\
                    <option value="today" i18n="modalConfig.option.PERIOD_DROP_DOWN_TODAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_TODAY+'</option>\
                    <option value="threeDay"  i18n="modalConfig.option.PERIOD_DROP_DOWN_THREE_DAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THREE_DAY+'</option>\
                    <option value="yesterday" selected=""  i18n="modalConfig.option.PERIOD_DROP_DOWN_YESTERDAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_YESTERDAY+'</option>\
                    <option value="thisWeek" i18n="modalConfig.option.PERIOD_DROP_DOWN_THIS_WEEK">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THIS_WEEK+'</option>\
                    <option value="lastWeek" i18n="modalConfig.option.PERIOD_DROP_DOWN_LAST_WEEK">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_LAST_WEEK+'</option>\
                    <option value="thisYear" i18n="modalConfig.option.PERIOD_DROP_DOWN_THIS_YEAR">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THIS_YEAR+'</option>\
                </select>\
                ';break;case 1:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <div class="input-group" style="width:100%">\
                    <input class="iptRecentTimeVal form-control" style="width:60%">\
                    <select class="selRecentTimeUnit form-control" style="width:40%">\
                        <option value="minute" i18n="modalConfig.option.PERIOD_UNIT_MIN">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MIN+'</option>\
                        <option value="hour" i18n="modalConfig.option.PERIOD_UNIT_HOUR">'+I18n.resource.modalConfig.option.PERIOD_UNIT_HOUR+'</option>\
                        <option value="day" i18n="modalConfig.option.PERIOD_UNIT_DAY">'+I18n.resource.modalConfig.option.PERIOD_UNIT_DAY+'</option>\
                        <option value="month" i18n="modalConfig.option.PERIOD_UNIT_MON">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MON+'</option>\
                    </select>\
                </div>\
                ';this.divTimeConfig.insertBefore(this.createTimeInterval('minute'),divTimeRange);var _this=this;$(divTimeRange).find('.selRecentTimeUnit').off('change').on('change',function(e){$(_this.divTimeConfig).find('.divTimeInterval').remove();_this.divTimeConfig.insertBefore(_this.createTimeInterval(e.currentTarget.value),e.currentTarget.parentNode.parentNode);I18n.fillArea($(_this.ctnTimeConfig));});break;case 2:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <div class="input-group">\
                    <input class="form-control form_datetime iptStartTime" size="16" type="text" data-format="yyyy-mm-dd hh:ii" datetimepicker>\
                    <span class="input-group-addon" i18n="modalConfig.option.TIP_RANGE_TO">${I18n.resource.modalConfig.option.TIP_RANGE_TO}</span>\
                    <input class="form-control form_datetime iptEndTime" size="16" type="text" data-format="yyyy-mm-dd hh:ii" datetimepicker>\
                </div>\
                ';this.divTimeConfig.insertBefore(this.createTimeInterval(),divTimeRange);break;default:break;I18n.fillArea($(this.ctnTimeConfig));}};ModalHistoryDataAnalyze.prototype.setFixedRangeInterval=function(interval){var iptStartTime=this.divTimeConfig.querySelector('.iptStartTime');var iptEndTime=this.divTimeConfig.querySelector('.iptEndTime');var format='yyyy-MM-dd HH:mm';var datePikerFormat='yyyy-mm-dd hh:ii';$(iptStartTime).attr('value',new Date().format(format)).datetimepicker({todayBtn:'linked',endTime:new Date(),format:datePikerFormat,autoclose:true,initialDate:new Date().format(format)});$(iptEndTime).attr('value',new Date().format(format)).datetimepicker({todayBtn:'linked',endTime:new Date(),format:datePikerFormat,autoclose:true,initialDate:new Date().format(format)});};ModalHistoryDataAnalyze.prototype.getTimeConfig=function(){var mode=this.divTimeConfig.querySelector('.iptTimeMode').value;var dateTimeRange=this.divTimeConfig.querySelector('.divTimeRange');var dateInterval=$(this.divTimeConfig).find('.divTimeInterval>select')[0];var startTime,endTime,interval,range;var now=new Date();if(mode==0){var timeRangeVal=dateTimeRange.querySelector('.selRecentTimeRange').value;switch(timeRangeVal){case'today':startTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='h1';break;case'threeDay':startTime=new Date(now.getTime()-259200000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='h1';break;case'yesterday':startTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd 00:00:00');endTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd 23:59:59');interval='h1';break;case'thisWeek':startTime=new Date(now.getTime()-604800000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='d1';break;case'lastWeek':var weekVal=DateUtil.getWeekNumber(now);var dateRange=DateUtil.getDateRangeOnWeekNumber(weekVal[0],weekVal[1]-1);startTime=new Date(dateRange[0].getTime()-604800000).format('yyyy-MM-dd 00:00:00');endTime=new Date(dateRange[1].getTime()-604800000).format('yyyy-MM-dd 23:59:59');interval='d1';break;case'thisYear':startTime=new Date(now.getTime()-31536000000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='M1';break;}}else if(mode==1){var dateTimeUnit=dateTimeRange.querySelector('.selRecentTimeUnit').value;var unitTime=0;var dataTimeVal=parseInt(dateTimeRange.querySelector('.iptRecentTimeVal').value);if(isNaN(dataTimeVal))return;switch(dateTimeUnit){case'minute':unitTime=60000;break;case'hour':unitTime=3600000;break;case'day':unitTime=86400000;break;case'month':unitTime=2592000000;break;}
interval=dateInterval.value;startTime=new Date(now.getTime()-unitTime*dataTimeVal).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');}else if(mode==2){interval=dateInterval.value;startTime=new Date(dateTimeRange.querySelector('.iptStartTime').value).format('yyyy-MM-dd HH:mm:ss');endTime=new Date(dateTimeRange.querySelector('.iptEndTime').value).format('yyyy-MM-dd HH:mm:ss');}
return{startTime:startTime,endTime:endTime,interval:interval}};ModalHistoryDataAnalyze.prototype.createTimeInterval=function(unit){var interval=document.createElement('div');interval.className='divTimeInterval';switch(unit){case'minute':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="m1" i18n="modalConfig.option.INTERVAL_MIN1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                </select>\
                ';break;case'hour':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                </select>\
                ';break;case'day':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                </select>\
                ';break;case'month':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                    <option value="M1" i18n="modalConfig.option.INTERVAL_MON1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                </select>\
                ';break;default:interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">${I18n.resource.modalConfig.option.LABEL_INTERVAL}</label>\
                <select class="form-control">\
                    <option value="m1" i18n="modalConfig.option.INTERVAL_MIN1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                    <option value="M1" i18n="modalConfig.option.INTERVAL_MON1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                </select>\
                ';this.setFixedRangeInterval('m1');var _this=this;interval.getElementsByTagName('select')[0].onchange=function(e){_this.setFixedRangeInterval(e.currentTarget.value)};break;}
I18n.fillArea($(this.ctnTimeConfig));return interval;};ModalHistoryDataAnalyze.prototype.chartPreSet=function(){var _this=this;$(this.container).find('.dragTip').hide();var timeConfig=this.getTimeConfig();this.getData({startTime:timeConfig.startTime,endTime:timeConfig.endTime,timeFormat:timeConfig.interval,dsItemIds:_this.store.map(function(pt){return pt.id})}).done(function(dataSrc){_this.renderChart(dataSrc,timeConfig.interval);});};ModalHistoryDataAnalyze.prototype.renderChart=function(data,interval){var formatDate='';var formatTime='';switch(interval){case'm1':formatTime='HH:mm';break;case'm5':formatTime='HH:mm';break;case'h1':formatTime='HH:mm';break;case'd1':formatDate='MM-dd';break;case'M1':formatDate='yyyy-MM-dd';formatTime='';break;}
var timeInit=data.timeShaft;var timeShaft=[].concat(data.timeShaft);for(var i=0;i<timeShaft.length;i++){if(formatDate&&formatTime){timeShaft[i]=new Date(timeShaft[i]).format(formatDate)+'\n\r'+new Date(timeShaft[i]).format(formatTime);}else if(formatDate){timeShaft[i]=new Date(timeShaft[i]).format(formatDate);}else{timeShaft[i]=new Date(timeShaft[i]).format(formatTime);}}
var dsName='';var legend=[];var series=[];for(var i=0;i<data.list.length;i++){if(data.list[i].data.length==0)continue;dsName=AppConfig.datasource.getDSItemById(data.list[i].dsItemId).alias;this.store[i].name=dsName;legend.push(dsName);series.push({name:dsName,data:data.list[i].data,type:'line',itemStyle:{normal:{color:AppConfig.chartTheme.color[i%7]}}})}
var option={title:{show:false,left:'center',text:I18n.resource.dashboard.modalHistoryDataAnalyze.HISTORY_DATA,textStyle:{color:'#fff'}},legend:{data:legend,padding:2,textStyle:{color:'#fff',fontSize:8,fontWeight:'lighter'},formatter:function(opt){var str='';if(opt.length>10){str=opt.slice(0,5)+'...'+opt.slice(opt.length-5)}else{str=opt;}
return str;},orient:'horizontal',left:'center',top:'10'},grid:{x:45,y:25,x2:25,y2:25},toolbox:{},tooltip:{trigger:'axis',formatter:function(data){var strTip='';strTip+=new Date(timeInit[data[0].dataIndex]).format('yyyy-MM-dd HH:mm')+'</br>';for(var i=0;i<data.length;i++){strTip+=data[i].seriesName+' : '+data[i].data;if(i!=(data.length-1)){strTip+='</br>';}}
return strTip;}},xAxis:{type:'category',boundaryGap:false,data:timeShaft,axisLine:{lineStyle:{color:'#fff'}}},yAxis:{type:'value',scale:true,axisLabel:{formatter:function(value){var ret;if(value<1000){ret=value;}
else if(value<1000000){ret=value/1000+'k';}
else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0.8}},axisLine:{lineStyle:{color:'#fff'}}},series:series};var _this=this;var hisChart=echarts.init(this.ctnChart,AppConfig.chartTheme);hisChart.setOption(option);hisChart.on('legendselectchanged',function(params){for(var i=0;i<_this.store.length;i++){if(_this.store[i].name==params.name){_this.store.splice(i,1);series.splice(i,1);legend.splice(i,1);hisChart.setOption(option);break;}}});};ModalHistoryDataAnalyze.prototype.attachEvent=function(){var _this=this;$(this.divTimeConfig).find('.divTimeMode>select').off('change').on('change',function(e){_this.createTimeRange(parseInt(e.currentTarget.value))});var $btnShowTimeConfig=$(this.container.querySelector('.btnShowTimeConfig'));$(_this.ctnTimeConfig).hide();$(this.container).find('.divConfigCancel').off('click').on('click',function(e){$(_this.ctnTimeConfig).hide();$btnShowTimeConfig.show();});$(this.container).find('.divConfigConfirm').off('click').on('click',function(e){$(_this.ctnTimeConfig).hide();$btnShowTimeConfig.show();_this.chartPreSet();});$(this.divTimeConfig).find('.divTimeMode>select').off('change').on('change',function(e){_this.createTimeRange(parseInt(e.currentTarget.value))});$('#paneCenter').off('dragstart').on('dragstart','[data-h5-draggable-node]',function(e){EventAdapter.setData({dsItemId:e.currentTarget.dataset.dsId})});var $ctnChart=$(this.ctnChart);$ctnChart.off('dragover').on('dragover',function(e){e.preventDefault();});$ctnChart.off('dragleave').on('dragleave',function(e){e.preventDefault();});$ctnChart.off('drop').on('drop',function(e){e.preventDefault();var id=EventAdapter.getData().dsItemId;for(var i=0;i<this.store.length;i++){if(this.store[i].id==id){(typeof infoBox!='undefined')&&infoBox.alert(I18n.resource.dashboard.modalHistoryDataAnalyze.POINT_EXIST_TIP);return;}}
this.store.push({id:id});this.chartPreSet();});$btnShowTimeConfig.off('click').on('click',function(){$(_this.ctnTimeConfig).show();$btnShowTimeConfig.hide();});};ModalHistoryDataAnalyze.prototype.showConfigMode=function(){};return ModalHistoryDataAnalyze})();﻿
var ModalCarbonFootprint=(function(){function ModalCarbonFootprint(containerId,entityParams){ModalBase.call(this,containerId,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.isFirstTime=true;this.widthRuler=undefined;this.$elMask=undefined;this.elPaneValue=undefined;this.elPaneTitle=undefined;this.maxValue=undefined;};ModalCarbonFootprint.prototype=new ModalBase();ModalCarbonFootprint.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CARBON_FOOTPRINT',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:3,minWidth:4,maxHeight:6,maxWidth:12,type:'ModalCarbonFootprint'};ModalCarbonFootprint.prototype.renderModal=function(){if(this.isFirstTime)this.init();},ModalCarbonFootprint.prototype.init=function(){var _this=this;WebAPI.get('/static/scripts/spring/entities/modalCarbonFootprint.html').done(function(resultHTML){_this.container.innerHTML=resultHTML;_this.initStandard();_this.isFirstTime=false;I18n.fillArea($('.divCFTitle').parent());});},ModalCarbonFootprint.prototype.initStandard=function(){$divMain=$(this.container);this.widthRuler=$divMain.find('.cfProcessScale').width();this.$elMask=$divMain.find('.cfProcessMask');this.elPaneValue=document.getElementById('cfFootprintDashboardCurrent');this.elPaneTitle=document.getElementById('divCFTitle');var unitValue=this.entity.modal.option.valueStandard/4;this.maxValue=unitValue*5;var tdScaleNums=this.container.getElementsByClassName('cfProcessScaleNum');for(var i=0,len=tdScaleNums.length;i<len;i++){tdScaleNums[i].textContent=parseInt(unitValue*i).toString();}
$divMain.find('.cfLegendBarWarning').animate({width:this.widthRuler*0.2+'px'},1000);document.getElementById('cfFootprintDashboardStandard').textContent=this.entity.modal.option.valueStandard;},ModalCarbonFootprint.prototype.updateModal=function(points){var value=parseFloat(points[0].data).toFixed(1).toString();this.elPaneValue.textContent=value;this.elPaneTitle.textContent=value;this.$elMask.animate({width:this.widthRuler-value*this.widthRuler/this.maxValue+'px'},1000);},ModalCarbonFootprint.prototype.showConfigMode=function(){};ModalCarbonFootprint.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.valueStandard=3500;};return ModalCarbonFootprint;})();﻿var ModalAppChart=(function(){function ModalAppChart(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.dicPeriod={'30s':30000,'m1':60000,'m5':300000,'10m':600000,'30m':1800000,'h1':3600000,'d1':86400000,'M1':2592000000}}
ModalAppChart.prototype=new ModalBase();ModalAppChart.prototype.optionTemplate={name:'toolBox.modal.APP_CHART',parent:3,mode:['realTime'],maxNum:10,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalAppChart'};ModalAppChart.prototype.optionDefault={color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500'],title:{textStyle:{fontWeight:'normal',color:'#008acd'}},legend:{textStyle:{fontFamily:"Microsoft YaHei",fontSize:10}},dataRange:{itemWidth:15,color:['#5ab1ef','#e0ffff']},toolbox:{x:'right',y:'center',feature:{mark:{show:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}},color:['#1e90ff','#1e90ff','#1e90ff','#1e90ff'],effectiveColor:'#ff4500'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{color:'#008acd'},crossStyle:{color:'#008acd'},shadowStyle:{color:'rgba(200,200,200,0.2)'}}},dataZoom:{dataBackgroundColor:'#efefff',fillerColor:'rgba(182,162,222,0.2)',handleColor:'#008acd'},grid:(function(isMobile){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:50,top:40}
if(isMobile){grid.x=40;}
return grid;}(AppConfig.isMobile)),categoryAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitLine:{lineStyle:{color:['#eee']}}},valueAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']}},splitLine:{lineStyle:{color:['#eee']}}},polar:{axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{lineStyle:{color:'#008acd'},controlStyle:{normal:{color:'#008acd'},emphasis:{color:'#008acd'}},symbol:'emptyCircle',symbolSize:3},bar:{itemStyle:{normal:{barBorderRadius:5},emphasis:{barBorderRadius:5}},barMaxWidth:80},line:{smooth:true,symbol:'none',symbolSize:3},k:{itemStyle:{normal:{color:'#d87a80',color0:'#2ec7c9',lineStyle:{color:'#d87a80',color0:'#2ec7c9'}}}},scatter:{symbol:'circle',symbolSize:4},radar:{symbol:'emptyCircle',symbolSize:3},map:{itemStyle:{normal:{areaStyle:{color:'#ddd'},label:{textStyle:{color:'#d87a80'}}},emphasis:{areaStyle:{color:'#fe994e'}}}},force:{itemStyle:{normal:{linkStyle:{color:'#1e90ff'}}}},chord:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}},emphasis:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}}}},gauge:{axisLine:{lineStyle:{color:[[0.2,'#2ec7c9'],[0.8,'#5ab1ef'],[1,'#d87a80']],width:10}},axisTick:{splitNumber:10,length:15,lineStyle:{color:'auto'}},splitLine:{length:22,lineStyle:{color:'auto'}},pointer:{width:5}},textStyle:{fontFamily:'微软雅黑, Arial, Verdana, sans-serif'}};ModalAppChart.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption(this.options);},ModalAppChart.prototype.updateModal=function(pointName,pointValue){},ModalAppChart.prototype.showConfigMode=function(){},ModalAppChart.prototype.dsChartCog=function(cog,option){if(!cog)return;if(cog[0].upper)option.yAxis[0].max=cog[0].upper;if(cog[0].lower)option.yAxis[0].min=cog[0].lower;if(cog[0].unit)option.yAxis[0].name=cog[0].unit;if(cog[0].markLine){if(!option.series[0].markLine){option.series[0].markLine={};option.series[0].markLine.data=new Array();}
for(var i in cog[0].markLine){var markLine=cog[0].markLine[i];if(!markLine.value)continue;var arr=[{name:markLine.name,xAxis:-1,yAxis:markLine.value},{name:markLine.name,xAxis:option.series[0].data.length,yAxis:markLine.value}];option.series[0].markLine.data.push(arr);}}}
ModalAppChart.prototype.coordinate=function(e){var arr=[];var endTime=new Date().valueOf();if(e=='m1'){var startTime=endTime-21600000;var interval=60000;while(startTime<=endTime){arr.push(new Date(startTime).format('HH:mm'));startTime+=interval;}}else if(e=='m5'){var startTime=endTime-86100000;var interval=300000;while(startTime<=endTime){arr.push(new Date(startTime-startTime%300000).format('HH:mm'));startTime+=interval;}}else if(e=='h1'){var startTime=endTime-82800000;var interval=3600000;while(startTime<=endTime){arr.push(new Date(startTime).format('HH:00'));startTime+=interval;}}else if(e=='d1'){var startTime=endTime-2592000000;var interval=86400000;while(startTime<=endTime){arr.push(new Date(startTime).format('yyyy-MM-dd'));startTime+=interval;}}else if(e=='M1'){var fullYear=new Date().getFullYear()-1;var month=new Date().getMonth()+1;var interval=1;for(var i=0;i<12;i++){var startTime=fullYear+'-'+month;arr.push(startTime);month=month%12+interval;if(month===1){fullYear+=1;}}}
return[{data:arr}];}
return ModalAppChart;})();var ModalAppGauge=(function(){function ModalAppGauge(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppGauge.prototype=new ModalBase();ModalAppGauge.prototype.optionTemplate={name:'toolBox.modal.APP_GAUGE_CHART',parent:3,mode:['appGauge'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppGauge'};ModalAppGauge.prototype.optionDefault={tooltip:{formatter:"{a} <br/>{b} : {c}"},backgroundColor:'#2f91e8',animation:true,animationDuration:1000,animationDurationUpdate:1000,toolbox:{show:false},title:{show:true,text:'项目实时评估得分',textStyle:{fontWeight:'100',fontFamily:'Microsoft Yahei',fontSize:16,color:'#fff'},x:'center'},series:[{type:'gauge',splitNumber:4,center:['50%','55%'],radius:'75%',startAngle:-270,endAngle:89.9999,axisLine:{show:false,lineStyle:{width:13,opacity:0}},axisTick:{splitNumber:20,length:12,lineStyle:{color:'auto',width:2}},axisLabel:{show:true,textStyle:{color:'#eee'}},splitLine:{show:true,length:12,lineStyle:{width:2,color:'auto'}},pointer:{show:false},itemStyle:{normal:{opacity:0}},title:{show:true,textStyle:{fontWeight:'bolder',color:'white'},offsetCenter:[0,'-40%']},detail:{formatter:'{value}',offsetCenter:['0%','-5%'],textStyle:{color:'#fff',fontSize:36}}}]};ModalAppGauge.prototype.renderModal=function(){},ModalAppGauge.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var dataSeries;if(points[1]){if(points[1].guageTitle){this.optionDefault.title.text=points[1].guageTitle;}
var guageFulTitle=points[1].guageFulTitle?points[1].guageFulTitle:'';if(points[1].guageFixed===0||points[1].guageFixed){dataSeries=parseFloat(points[0].data).toFixed(points[1].guageFixed);}else{dataSeries=parseFloat(points[0].data).toFixed(2);}
if(parseFloat(points[0].data)>100){this.optionDefault.series[0].max=parseFloat(points[0].data).toFixed(0);this.optionDefault.series[0].formatter=function(v){switch(v+''){case(parseFloat(points[0].data)/4).toFixed(0):return(parseFloat(points[0].data)/4).toFixed(0);case(parseFloat(points[0].data)/2).toFixed(0):return(parseFloat(points[0].data)/2).toFixed(0);case(parseFloat(points[0].data)*3/4).toFixed(0):return(parseFloat(points[0].data)*3/4).toFixed(0);case parseFloat(points[0].data).toFixed(0):return parseFloat(points[0].data).toFixed(0);default:return'';}}}else{this.optionDefault.series[0].max=100;this.optionDefault.series[0].formatter=function(v){switch(v+''){case'25':return'25';case'50':return'50';case'75':return'75';case'0':return'0';default:return'';}}}
if(points[1].guageUnit){this.optionDefault.series[0].detail.formatter='{value}'+points[1].guageUnit;}
var guageDirect=points[1].guageDirect?points[1].guageDirect:'';if(guageDirect==='antiClockwise'){this.optionDefault.series[0].startAngle=-270;this.optionDefault.series[0].endAngle=89.9999;}else{this.optionDefault.series[0].startAngle=90;this.optionDefault.series[0].endAngle=-269.9999;}
if(points[1].guageBgColor){this.optionDefault.backgroundColor=points[1].guageBgColor;}
if(points[1].transDataDot){var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};var currentRGB=points[1].guageBgColor.colorRgb();var rgb=currentRGB.split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var finalRGB='rgba('+r+','+g+','+b+','+points[1].transDataDot+')';this.optionDefault.backgroundColor=finalRGB;}}
this.optionDefault.series[0].data=[{value:dataSeries,name:guageFulTitle}];this.optionDefault.series[0].axisLine.lineStyle.color=function(){var arrColor=['tomato','#f7ba49','#11fff1','#89dd4b'];var seriesDataInt=parseInt(dataSeries);var numCount=dataSeries.toString().length;var numCount1=numCount-2<=0?1:(numCount-2);var numFinally=Math.pow(10,numCount1);var kpiColor;if(seriesDataInt>100){kpiColor='#89dd4b';}else{kpiColor=arrColor[Math.floor(Math.abs(seriesDataInt-1)/25)];}
return[[seriesDataInt/100,kpiColor],[1,'#87a8c5']];}();!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption(this.optionDefault);var spanTime='<span class="spanTime" style="position:absolute;color:#fff">'+new Date().format('yyyy-MM-dd')+'</span>'
$(this.container).find('.spanTime').empty().remove();$(this.container).append(spanTime);var timeLocal=points[1].timeLocal?points[1].timeLocal:'leftTop';if(timeLocal){var $spanTimeDom=$(this.container).find('.spanTime');if(timeLocal==='leftTop'){$spanTimeDom.css({'top':'10px','left':'10px'});}else if(timeLocal==='rightTop'){$spanTimeDom.css({'top':'10px','right':'10px'});}else if(timeLocal==='leftBottom'){$spanTimeDom.css({'bottom':'10px','left':'10px'});}else{$spanTimeDom.css({'bottom':'10px','right':'10px'});}}},ModalAppGauge.prototype.showConfigMode=function(){},ModalAppGauge.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.guageTitle=option.guageTitle;this.entity.modal.option.guageFulTitle=option.guageFulTitle;this.entity.modal.option.guageFixed=option.guageFixed;this.entity.modal.option.guageUnit=option.guageUnit;this.entity.modal.option.timeLocal=option.timeLocal;this.entity.modal.option.guageDirect=option.guageDirect;this.entity.modal.option.guageBgColor=option.guageBgColor;this.entity.modal.option.transDataDot=option.transDataDot;this.entity.modal.interval=5;};return ModalAppGauge;})();var ModalAppButton=(function(){var _this;function ModalAppButton(screen,entityParams,_renderModal,_updateModal,_showConfigMode){_this=this;if(!screen)return;this.screen=screen;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppButton.prototype=new ModalBase();ModalAppButton.prototype.optionTemplate={name:'toolBox.modal.APP_BUTTON',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:1.5,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppButton'};ModalAppButton.prototype.show=function(){this.init();};ModalAppButton.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalAppButton.prototype.configure=function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this.screen.isScreenChange=true;_this=null;})};divMask.appendChild(btnRemove);if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
var btnHeightResize=document.createElement('div');var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};_this.entity.modal.interval='300000';this.container.parentNode.appendChild(divMask);if(this.entity.isNotRender&&this.screen.listEntity){var parentId=undefined,subChartIds;if(this.entity&&this.entity.id){parentId=this.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}
if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
this.divResizeByToolInit();this.executeConfigMode();};ModalAppButton.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();var divAppButton,divIcon,divDetail,spName,spValue,spUnit;var $springContentCur=$(this.container);$springContentCur.css("overflow","auto");var appButtonArr=_this.entity.modal.option.appButton;var len=appButtonArr.length;var staticColor=['#5A95F7','#FBDE54','#89D164','#89D164','#5A95F7','#23D29C'];for(var i=0;i<len;i++){divAppButton=document.createElement('div');divAppButton.className='divAppButton';if(appButtonArr[i].link!==''){divAppButton.setAttribute('data-link-to',appButtonArr[i].link);}
if(appButtonArr[i].linkType!==''){divAppButton.setAttribute('data-type',appButtonArr[i].linkType);}
$(divAppButton).on('tap',function(){var triggerId=$(this).attr('data-link-to');var dataType=$(this).attr('data-type');var linkName=$(this).find('.divMonitorInfo .spName').text();if(!triggerId)return;if(!AppConfig.isMobile){ScreenManager.show(EnergyScreen,triggerId);}else{var isIndex=dataType=='EnergyScreen_M';router.to({typeClass:ProjectDashboard,data:{menuId:triggerId,isIndex:isIndex,name:linkName}})}});switch(len){case 1:divAppButton.className+=' divAppButtonOne col-xs-6 zepto-ev';break;case 2:divAppButton.className+=' divAppButtonTwo col-xs-6 zepto-ev';break;case 3:divAppButton.className+=' divAppButtonThree col-xs-4 zepto-ev';break;case 4:divAppButton.className+=' divAppButtonFour col-xs-6 zepto-ev';break;case 5:divAppButton.className+=' divAppButtonFive col-xs-4 zepto-ev';break;case 6:divAppButton.className+=' divAppButtonSix col-xs-4 zepto-ev';break;default:divAppButton.className+=' divAppButtonSix col-xs-4 zepto-ev';break;}
divIcon=document.createElement('div');divIcon.className='divIcon '+appButtonArr[i].icon;if(appButtonArr[i].icon)divIcon.style.color=appButtonArr[i].iconColor;divDetail=document.createElement('div');divDetail.className='divMonitorInfo';spName=document.createElement('span');spName.className='spName';spName.textContent=appButtonArr[i].name;if(appButtonArr[i].backColor==""){divIcon.style.background=staticColor[i];}else{divIcon.style.background=appButtonArr[i].backColor;}
divDetail.appendChild(spName);divAppButton.appendChild(divIcon);divAppButton.appendChild(divDetail);_this.container.appendChild(divAppButton);}
if($springContentCur.height()<200){$springContentCur.find('.divIcon').addClass('divIconLittle');$springContentCur.find('.divMonitorInfo').addClass('divMonitorInfoLit');}else{$springContentCur.find('.divIcon').removeClass('divIconLittle');$springContentCur.find('.divMonitorInfo').removeClass('divMonitorInfoLit');}};ModalAppButton.prototype.showConfigMode=function(){};ModalAppButton.prototype.showConfigModal=function(){_this.tempOpt=$.extend(true,{},this.entity.modal);var configModalTpl='\
                <div id="ModalAppButtonConfig" class="modal fade"  role="dialog" aria-labelledby="ttlNodeTool">\
                    <div class="modal-dialog">\
                        <div class="modal-content">\
                            <div class="modal-header">\
                                <span id="btnMonitorAdd" class="glyphicon glyphicon-plus-sign btnMonitorAdd grow"></span>\
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                                <h4 class="modal-title" id="ttlNodeTool">Diagnosis Edit</h4>\
                            </div>\
                            <div class="modal-body gray-scrollbar" id="ctnMonitor">\
                            </div>\
                            <div class="modal-footer">\
                                <input type ="color">\
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
                                <button type="button" class="btn btnSure btn-primary">Save</button>\
                            </div>\
                        </div>\
                    </div>\
                </div>';_this.$configModal=$('#ModalAppButtonConfig');if(_this.$configModal.length==0)_this.$configModal=$(configModalTpl);_this.$configModal.appendTo($(_this.container).parentsUntil('.springContainer').parent().parent());var $ctnMonitor=_this.$configModal.find('#ctnMonitor').html('');var btnAdd=_this.$configModal.find('#btnMonitorAdd')[0];btnAdd.title='Monitor Type Add';btnAdd.onclick=function(){$ctnMonitor.append(_this.createDivMonitor());_this.attachMonitorEvent();};if(this.entity.modal.option&&this.entity.modal.option.appButton&&this.entity.modal.option.appButton.length>0){for(var i=0;i<this.entity.modal.option.appButton.length;i++){if(this.entity.modal.option.appButton[i].entityId===this.entity.id){$ctnMonitor[0].appendChild(_this.createDivMonitor(this.entity.modal.option.appButton[i]));}}}else{$ctnMonitor[0].appendChild(_this.createDivMonitor());}
_this.$configModal.modal('show');_this.$configModal.find('.btnSure').off('click').on('click',function(){if(_this.tempOpt.option.appButton&&_this.tempOpt.option.appButton.length>0){var appButtonArr=_this.tempOpt.option.appButton;for(var i=0;i<appButtonArr.length;i++){if(!appButtonArr[i].entityId){appButtonArr[i].entityId=_this.entity.id;}}}
_this.entity.modal=$.extend(true,{},_this.tempOpt);_this.$configModal.modal('hide');});_this.attachMonitorEvent();};ModalAppButton.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalAppButton.prototype.close=function(){_this.entity=null;this.entity=null;}
ModalAppButton.prototype.createDivMonitor=function(opt){var divMonitor=document.createElement('div');divMonitor.className='divMonitor';var $divMonitor=$(divMonitor);divMonitor.innerHTML='\
            <div class="divIcon"></div>\
            <div class="divMonitorInfo">\
                <div class="divName">\
                    <label>name:</label>\
                    <span class="spName"></span>\
                    <input class="iptName form-control" ></input>\
                </div>\
                <div class="divLink">\
                    <label>link:</label>\
                    <select class="form-control linkList"></select>\
                </div>\
            </div>\
            <div class="divMonitorDel glyphicon glyphicon-remove-circle"></div>';var $linkList=$divMonitor.find('select.linkList');$linkList[0].options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,''));if(AppConfig.menu.length>0){for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);if(opt&&opt.link&&opt.link==i){option.selected='selected';}
$linkList[0].options.add(option);}}else{if(_this.screen.facScreen){var pageDataMenus=_this.screen.facScreen.pagePanel.getPageList();for(var i=0;i<pageDataMenus.length;i++){var option=new Option(pageDataMenus[i].text,pageDataMenus[i]._id);$(option).attr('data-type',pageDataMenus[i].type);if(opt&&opt.link&&opt.link==pageDataMenus[i]._id){option.selected='selected';}
$linkList[0].options.add(option);}}}
$linkList[0].onchange=function(){var index=$('#ctnMonitor').children().index($divMonitor);_this.tempOpt.option.appButton[index].link=$linkList[0].value;_this.tempOpt.option.appButton[index].linkType=$(this).find('option:selected').attr('data-type');};if(opt&&opt.icon){$divMonitor.find('.divIcon').addClass(opt.icon);if(opt.iconColor)$divMonitor.find('.divIcon').css({'color':opt.iconColor,'box-shadow':'0 0 15px '+opt.iconColor})}else{$divMonitor.find('.divIcon').addClass('glyphicon glyphicon-plus').css('color','black');}
if(opt&&opt.name){$divMonitor.find('.spName').show().text(opt.name);$divMonitor.find('.iptName').hide().val(opt.name)}else{$divMonitor.find('.spName').hide();$divMonitor.find('.iptName').show();}
if(opt&&opt.backColor){$divMonitor.css('background',opt.backColor);}
if(!opt){if(!_this.tempOpt.option){_this.tempOpt.option={};}
if(!_this.tempOpt.option.appButton){_this.tempOpt.option.appButton=[];}
_this.tempOpt.option.appButton.push({icon:'glyphicon glyphicon-plus',iconColor:'#000000',name:'',link:'',backColor:'',linkType:''})}
return divMonitor};ModalAppButton.prototype.attachMonitorEvent=function(){var $ctnMonitor=_this.$configModal.find('#ctnMonitor');var $iptColor;var indexDivMonitor;$ctnMonitor.find(".divMonitor").off('click').on('click',function(){var currentBg=$(this).css('background');$ctnMonitor.find(".divMonitor").css("border","1px dotted");indexDivMonitor=$ctnMonitor.find(".divMonitor").index($(this));$(this).css("border","1px solid black");})
$(".modal-footer").find("input").off("change").on("change",function(){var colorVal=$(this).val();var rgb=colorVal.colorRgb().split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var hsl=rgbToHsl(r,g,b);var hslEndL=hsl[2]+0.05;var rgbStartColor=hslToRgb(hsl[0],hsl[1],hsl[2]);var rgbEndColor=hslToRgb(hsl[0],hsl[1],hslEndL);var backColor='-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(rgb('+rgbStartColor[0]+','+rgbStartColor[1]+','+rgbStartColor[2]+')), to(rgb('+rgbEndColor[0]+','+rgbEndColor[1]+','+rgbEndColor[2]+'))';if(indexDivMonitor!==0){if(!indexDivMonitor)return;}
_this.tempOpt.option.appButton[indexDivMonitor].backColor=colorVal;$ctnMonitor.find(".divMonitor").eq(indexDivMonitor).css("background",colorVal);})
var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return[h,s,l];}
function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var hue2rgb=function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
$(".divMonitor").on('click','.divIcon',function(e){e.stopPropagation();$('#ctnMonitor .divMonitor.selected').removeClass('selected');var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').addClass('selected');var index=$ctnMonitor.children().index($divMonitor);if(_this.$modal){_this.$modal.modal('show');$iptColor=_this.$modal.find('#iptColorSel');if(_this.tempOpt.option.appButton[index].iconColor){$iptColor.val(_this.tempOpt.option.appButton[index].iconColor);}
if(_this.tempOpt.option.appButton[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option.appButton[index].icon.split(' ')[1]).parent().addClass('selected');}}else{WebAPI.get('static/scripts/spring/entities/modalMonitor.html').done(function(resultHTML){_this.$modal=$(resultHTML);$iptColor=_this.$modal.find('#iptColorSel');_this.$modal.modal('show');if(_this.tempOpt.option.appButton[index].iconColor){_this.$modal.find('#iptColorSel').val(_this.tempOpt.option.appButton[index].iconColor);}
if(_this.tempOpt.option.appButton[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option.appButton[index].icon.split(' ')[1]).parent().addClass('selected');}
_this.$modal.find('.bs-glyphicons-list>li').click(function(e){if($(e.currentTarget).hasClass('selected'))return;$('.bs-glyphicons-list>li.selected').removeClass('selected');$(e.currentTarget).addClass('selected');});_this.$modal.find('.btnSure').click(function(e){e.stopPropagation();var $divMonitor=$('#ctnMonitor .divMonitor.selected');var index=$ctnMonitor.children().index($divMonitor);var icon=$('.bs-glyphicons-list>li.selected>.glyphicon-class').text();_this.tempOpt.option.appButton[index].icon=icon;_this.tempOpt.option.appButton[index].iconColor=$iptColor.val();$divMonitor.find('.divIcon')[0].className='divIcon '+icon;$divMonitor.find('.divIcon').css({'color':$iptColor.val(),'box-shadow':'0 0 15px '+$iptColor.val()});_this.tempOpt.option.appButton[index].entityId=_this.entity.id;_this.$modal.modal('hide');})})}});$(".divMonitor").on('click','.divMonitorDel',function(e){var index=$ctnMonitor.children().index($(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor'));$ctnMonitor.children().eq(index).remove();_this.tempOpt.option.appButton.splice(index,1);_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}});$(".divMonitor").on('click','.spName',function(e){$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptName').show().focus();});$ctnMonitor.off('blur').on('blur','input',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();if($(e.currentTarget).hasClass('iptName')){_this.tempOpt.option.appButton[index].name=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spName').text(value).show();}
_this.tempOpt.option.appButton[index].entityId=_this.entity.id;});$ctnMonitor.find('.linkList').off('change').on('change',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();_this.tempOpt.option.appButton[index].entityId=_this.entity.id;if($(e.currentTarget).hasClass('linkList')){_this.tempOpt.option.appButton[index].link=value;if(!value)return;}})};return ModalAppButton;})();var ModalAppHistory=(function(){function ModalAppHistory(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.attachEvent();};ModalAppHistory.prototype=new ModalBase();ModalAppHistory.prototype.optionTemplate={name:'toolBox.modal.APP_HISTORY_QUERY',parent:3,mode:['appGauge'],maxNum:1,title:'',minHeight:4,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppHistory',scroll:false};ModalAppHistory.prototype.optionDefault={title:{text:"1"},color:['rgb(250,214,74)'],tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:[]},grid:{left:'3%',right:'4%',bottom:'3%',containLabel:true},xAxis:[{type:'category',axisTick:{alignWithLabel:true},data:['Mon','Tue','Wed','Thu','Fri','Sat','Sun']}],yAxis:[{type:'value'}],series:[{name:'直接访问',type:'bar',barWidth:'60%',data:0}]};ModalAppHistory.prototype.renderPreviewModal=function(points){var _this=this;var pointsId=[];var pointsData=[];for(var i=0,length=points.length;i<length;i++){pointsId.push(points[i].dsItemId);pointsData.push(points[i].data);}
WebAPI.post('/analysis/datasource/getDsItemsById',pointsId).done(function(result){if($(_this.container).find(".listDataBox").html()===""){for(var j=0,jLength=result.length;j<jLength;j++){if(j===0){var singlePointer='<div class="singleContent activeSingle" data-id='+result[j].id+'>\
                                            <div class="singleTitle">'+result[j].alias+'</div>\
                                            <div class="singleValue">'+Number(pointsData[j]).toFixed(2)+'</div>\
                                        </div>';}else{var singlePointer='<div class="singleContent" data-id='+result[j].id+'>\
                                            <div class="singleTitle">'+result[j].alias+'</div>\
                                            <div class="singleValue">'+Number(pointsData[j]).toFixed(2)+'</div>\
                                        </div>';}
$(singlePointer).appendTo($(_this.container).find(".listDataBox"));}}else{var $list=$(_this.container).find(".singleContent");$list.each(function(){var index=$list.index($(this));$(this).find(".singleValue").text(Number(pointsData[index]).toFixed(2));})}
var $allSingleContent=$(_this.container).find(".singleContent");var sumWidth=0;$allSingleContent.each(function(){sumWidth+=$(this).width()+5;})
$(_this.container).find(".listDataBox").width(sumWidth);})
if($(_this.container).find("#bottomPoints").length===0){var content='<div id="bottomPoints">\
                        </div>\
                        <div id="bottomSearchHistory">\
                            <div class="bottomTitle">历史查询</div>\
                            <div class="bottomContent">\
                                <div class="clearfix hisCommenBox">\
                                    <div class="col-xs-4 hisCommen">采样周期</div>\
                                    <select class="col-xs-6 hisCommen" id="timePeriod" value="h1">\
                                        <option value="m5">5分钟</option>\
                                        <option value="h1">1小时</option>\
                                        <option value="d1">1天</option>\
                                        <option value="M1">1月</option>\
                                    </select>\
                                </div>\
                                <div class="clearfix hisCommenBox">\
                                    <div class="col-xs-4 hisCommen">开始时间</div>\
                                    <div class="input-append date col-xs-8">\
                                        <input id="datetimepickerStarts" class="form_datetime hisCommen" data-date="12-02-2012" type="text" readonly />\
                                        <span class="add-on"><i class="icon-th"></i></span>\
                                    </div>\
                                </div>\
                                <div class="clearfix hisCommenBox">\
                                    <div class="col-xs-4 hisCommen">结束时间</div>\
                                    <div class="input-append date col-xs-8">\
                                        <input id="datetimepickerEnds" class="form_datetime hisCommen" data-date="12-02-2012" type="text" readonly />\
                                        <span class="add-on"><i class="icon-th"></i></span>\
                                    </div>\
                                </div>\
                                <div class="text-center">\
                                    <button class="btnQuery" id="btnQuery"><span>查询</span></button>\
                                </div>\
                            </div>\
                        </div>';$(_this.container).find(".bottomBox").html(content);var nowDate=new Date();var endTime=nowDate.timeFormat(timeFormatChange('yyyy-mm-dd hh:ii:ss'));var startTime=nowDate.timeFormat(timeFormatChange("yyyy-mm-dd"))+' 00:00:00';var $datetimepickerStart=$(_this.container).find('#datetimepickerStarts');var $datetimepickerEnd=$(_this.container).find('#datetimepickerEnds');$datetimepickerStart.val(startTime);$datetimepickerEnd.val(endTime);$datetimepickerStart.datetimepicker({format:timeFormatChange("yyyy-mm-dd")+' 00:00:00',pickerPosition:'bottom-left',pickerReferer:'input',startView:2,minView:2,autoclose:true,forceParse:false});$datetimepickerEnd.datetimepicker({format:timeFormatChange('yyyy-mm-dd hh:ii:ss'),pickerPosition:'bottom-right',pickerReferer:'input',startView:2,minView:2,autoclose:true,forceParse:false});}},ModalAppHistory.prototype.updateModal=function(points){this.renderPreviewModal(points);},ModalAppHistory.prototype.renderModal=function(id,startTime,endTime,tPeriod){if($(this.container).find(".middlePointers").length===0&&$(this.container).find(".bottomBox").length===0&&$(this.container).find("#chartBox").length===0){var $middlePointers=$('<div class="middlePointers gray-scrollbar"><div class="listDataBox"></div></div>');$middlePointers.appendTo(this.container);var $bottomBox=$('<div class="bottomBox" style="height:40%"></div>');$bottomBox.appendTo(this.container);var $chartBox=$('<div id="chartBox" style="height:235px"></div>');$middlePointers.before($chartBox);}
var _this=this;var todayEndTime=new Date().format('yyyy-MM-dd HH:mm:ss');var todayStartTime=new Date().format("yyyy-MM-dd 00:00:00");var id=id===undefined?this.entity.modal.points:[id];var startTime=startTime===undefined?todayStartTime:startTime;var endTime=endTime===undefined?todayEndTime:endTime;var tPeriod=tPeriod===undefined?'h1':tPeriod;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:id,timeStart:startTime,timeEnd:endTime,timeFormat:tPeriod}).done(function(dataSrc){var dataArr;var time=dataSrc.timeShaft;if($("#chartBox").html()===""){WebAPI.post('/analysis/datasource/getDsItemsById',id).done(function(result){for(var i=0,length=dataSrc.list.length;i<length;i++){dataArr=dataSrc.list[0].data;_this.optionDefault.title.text=result[0].alias;_this.optionDefault.series[0].name=result[0].alias;_this.optionDefault.legend.data[0]=result[0].alias;}
_this.optionDefault.series[0].data=dataArr;_this.optionDefault.xAxis[0].data=time;var $chartContainer=$(_this.container).find("#chartBox");!_this.chart&&(_this.chart=echarts.init($chartContainer[0],AppConfig.chartTheme));_this.chart.setOption(_this.optionDefault);_this.spinner&&_this.spinner.stop();})}else{var $firstSelected=$(_this.container).find(".activeSingle");var singlePointerId=$firstSelected.attr("data-id");var singlePointerTitle=$firstSelected.find(".singleTitle").text();for(var i=0,length=dataSrc.list.length;i<length;i++){if(dataSrc.list[i].dsItemId===singlePointerId){var dataArr=dataSrc.list[i].data;_this.optionDefault.title.text=singlePointerTitle;_this.optionDefault.series[0].name=singlePointerTitle;_this.optionDefault.legend.data[0]=singlePointerTitle;}}
_this.optionDefault.series[0].data=dataArr;_this.optionDefault.xAxis[0].data=time;var $chartContainer=$(_this.container).find("#chartBox");!_this.chart&&(_this.chart=echarts.init($chartContainer[0],AppConfig.chartTheme));_this.chart.setOption(_this.optionDefault);_this.spinner&&_this.spinner.stop();}})},ModalAppHistory.prototype.attachEvent=function(){var _this=this;$(this.container).off('click').on("click","#btnQuery",function(){var tPeriod=$(_this.container).find("#timePeriod").val();var startTime=$(_this.container).find("#datetimepickerStarts").val().toDate().timeFormat('yyyy-mm-dd hh:ii:ss');var endTime=$(_this.container).find("#datetimepickerEnds").val().toDate().timeFormat('yyyy-mm-dd hh:ii:ss');var id=$(_this.container).find(".activeSingle").attr("data-id");_this.renderModal(id,startTime,endTime,tPeriod);})
$(this.container).off('click.singleContent').on("click.singleContent",".singleContent",function(){var $this=$(this);$(_this.container).find('.singleContent').removeClass('activeSingle');$this.addClass('activeSingle');var id=$this.attr("data-id");_this.renderModal(id);});},ModalAppHistory.prototype.showConfigMode=function(){},ModalAppHistory.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.interval=5;};return ModalAppHistory;})();var ModalAppDiagRanking=(function(){function ModalAppDiagRanking(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalAppDiagRanking.prototype=new ModalBase();ModalAppDiagRanking.prototype.optionTemplate={name:'toolBox.modal.APP_DIAGNOSTIC_RANKING',parent:3,mode:['appDiagRanking'],maxNum:1,title:'',minHeight:4,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppDiagRanking',scroll:false};ModalAppDiagRanking.prototype.optionDefault={};ModalAppDiagRanking.prototype.updateModal=function(points){},ModalAppDiagRanking.prototype.renderModal=function(){var _this=this;var dsItemIds=this.entity.modal.points;var diagType=this.entity.modal.option.diagType?this.entity.modal.option.diagType:'fault';var rankName;if(diagType==='equipment'){rankName=I18n.resource.modalConfig.modalApp.EQUIPMENT_NAME;}else if(diagType==='zone'){rankName=I18n.resource.modalConfig.modalApp.ZONE_NAME;}else{rankName=I18n.resource.modalConfig.modalApp.FAULT_NAME;}
var str='<table class="diagRanking" data-type="'+diagType+'">\
                        <thead class="bgColorTemp2">\
                            <tr>\
                                <th width="15%" title="'+I18n.resource.modalConfig.modalApp.RANKING+'">'+I18n.resource.modalConfig.modalApp.RANKING+'</th>\
                                <th title="'+rankName+'">'+rankName+'</th>\
                                <th title="'+I18n.resource.modalConfig.modalApp.MOTH_TIME+'">'+I18n.resource.modalConfig.modalApp.TIMES+'</th>\
                                <th title="'+I18n.resource.modalConfig.modalApp.AVE_DURATION+'">'+I18n.resource.modalConfig.modalApp.DURATION+'</th>\
                            </tr>\
                        </thead>\
                        <tbody>\
                        </tbody>\
                    </table>';WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:dsItemIds}).done(function(result){if($(_this.container).find(".alertError")||$(_this.container).find(".diagRanking")){$(_this.container).find(".alertError").remove();$(_this.container).find(".diagRanking").remove();}
$(_this.container).append($(str));var dataArr=result.dsItemList;if(result.dsItemList[0].data.indexOf('MonthRankList')!==-1){var data=JSON.parse(result.dsItemList[0].data).MonthRankList;for(var j=0,jLength=data.length;j<jLength;j++){var sonContent='<tr class="diagnosisTr borderColorTemp3">\
                                    <td>'+(j+1)+'</td>\
                                    <td class="disgnosisName">'+data[j].name+'</td>\
                                    <td>'+data[j].count+'</td>\
                                    <td>'+data[j].timespan+'</td>\
                                </tr>';$(_this.container).find(".diagRanking").find("tbody").append($(sonContent));}
_this.spinner&&_this.spinner.stop();$(_this.container).find('.diagnosisTr').off('click').click(function(){var faultName=$(this).find('.disgnosisName').text().trim();var diagType=$(this).parents('table.diagRanking').attr('data-type');var faultInfos={};var postData={value:faultName,type:diagType,startTime:new Date(new Date().valueOf()-86400000*7).format('yyyy-MM-dd ')+'00:00:00',endTime:new Date().format('yyyy-MM-dd HH:mm:ss'),projId:AppConfig.projectId}
Spinner.spin($(_this.container).parents('.indexContent')[0]);WebAPI.post('/diagnosis/getFaultDetails',postData).done(function(faultDetail){var faultDetailData=faultDetail.data;faultInfos['faultName']=faultName;faultInfos['faultDetailData']=faultDetailData;faultInfos['containerScreen']=$(_this.container).parents('.indexContent');new DiagnosisInfo().show(faultInfos);})});}else{var alertError='<div class="alertError" style="width:40%;height:12%;position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;z-index:1200;background:#eee;color:#aaa;border-radius:6px;padding:10px;">所填数据点的格式不符合该控件所需的数据格式</div></div>'
$(_this.container).append($(alertError))}})},ModalAppDiagRanking.prototype.attachEvent=function(){},ModalAppDiagRanking.prototype.showConfigMode=function(){},ModalAppDiagRanking.prototype.setModalOption=function(option){this.entity.modal.option.diagType=option.diagType;};return ModalAppDiagRanking;})()
var ModalAPPMonthHistory=(function(){function ModalAPPMonthHistory(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;this.dsItems=undefined;this.layout();this.attachEvent();};ModalAPPMonthHistory.prototype=new ModalBase();ModalAPPMonthHistory.prototype.optionTemplate={name:'toolBox.modal.APP_MONTH_HISTORY_QUERY',parent:3,mode:['appMonthHistory'],maxNum:1,title:'',minHeight:2.5,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAPPMonthHistory'};ModalAPPMonthHistory.prototype.optionDefault={title:{left:'center',textStyle:{color:'#000000'}},tooltip:{trigger:'axis',axisPointer:{type:'shadow'},backgroundColor:'rgba(0,0,0,0.6)',textStyle:{color:'#ffffff'}},legend:{data:[]},grid:{left:'3%',right:'4%',bottom:'4%',containLabel:true},xAxis:[{type:'category',axisTick:{alignWithLabel:true},data:['Mon','Tue','Wed','Thu','Fri','Sat','Sun']}],yAxis:[{type:'value'}],series:[]};ModalAPPMonthHistory.prototype.updateModal=function(points){},ModalAPPMonthHistory.prototype.layout=function(){var showMonth='<div id="topMonthShow" style="height:9%">\
                            <div class="col-xs-4 leftButton">\
                                <span class="glyphicon glyphicon-arrow-left"></span>\
                            </div>\
                            <div class="col-xs-4 month">\
                            </div>\
                            <div class="col-xs-4 rightButton">\
                                <span class="glyphicon glyphicon-arrow-right"></span>\
                            </div>\
                        </div>';var chartContainer='<div id="chartContainer" style="height:91%"></div>';$(this.container).append(showMonth);$(this.container).append(chartContainer);},ModalAPPMonthHistory.prototype.getDsItemsById=function(){var ids=this.entity.modal.points;var _this=this;WebAPI.post('/analysis/datasource/getDsItemsById',ids).done(function(result){_this.dsItems=result;});;},ModalAPPMonthHistory.prototype.renderModal=function(start,end,month){this.getDsItemsById();var nowYear=Number(new Date().format("yyyy"));var nowMonth=Number(new Date().format('yyyy-MM-dd').split("-")[1]);var showYear,showMonth,startTime,endTime;if(1<nowMonth&&nowMonth<=10){showYear=nowYear;showMonth='0'+(nowMonth-1);}else if(10<nowMonth&&nowMonth<=12){showYear=nowYear;showMonth=nowMonth-1;}else if(nowMonth===1){showYear=nowYear-1;showMonth=12;}
startTime=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(startTime));endTime=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");var topMonth=month===undefined?showMonth:month;$(this.container).find(".month").html(topMonth+" 月");var id=this.entity.modal.points;var tPeriod='d1';var timeStart=start===undefined?startTime:start;var timeEnd=end===undefined?endTime:end;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:id,timeStart:timeStart,timeEnd:timeEnd,timeFormat:tPeriod}).done(function(result){this.optionDefault.xAxis[0].data=[];this.optionDefault.series=[];this.optionDefault.title.text=[];this.optionDefault.legend.data=[];var dataList=result.list;var timeData=result.timeShaft;var timeArr=[];var datas=[];var ids=[];var obj={name:'1',type:'bar',data:[]}
for(var i=0,length=dataList.length;i<length;i++){datas.push(dataList[i].data);ids.push(dataList[i].dsItemId);}
for(var j=0,jLength=datas.length;j<jLength;j++){for(var k=0,kLength=this.dsItems.length;k<kLength;k++){if(this.dsItems[k].id===ids[j]){obj.data=datas[j];obj.name=this.dsItems[k].alias;this.optionDefault.series.push(obj);this.optionDefault.title.text=this.dsItems[k].alias;this.optionDefault.legend.data.push(this.dsItems[k].alias);}}}
for(var t=0,tLength=timeData.length;t<tLength;t++){timeArr.push(timeData[t].split(" ")[0].split("-")[2])}
this.optionDefault.xAxis[0].data=timeArr;var $chartContainer=$(this.container).find("#chartContainer");!this.chart&&(this.chart=echarts.init($chartContainer[0],AppConfig.chartTheme));this.chart.setOption(this.optionDefault);this.spinner&&this.spinner.stop();}.bind(this))},ModalAPPMonthHistory.prototype.attachEvent=function(){var _this=this;var leftCount=0,rightCount=0;var nowYear=Number(new Date().format("yyyy"));var current;$(this.container).find(".leftButton").click(function(){leftCount=leftCount+1;if(leftCount===1){current=Number($(_this.container).find(".month").html().split(" ")[0]);}
var value=(leftCount-current)/12;var yearNums,showYear,showMonth;if(value>0){yearNums=parseInt(value)+1;}else if(value===0){yearNums=1;}else{yearNums=0;}
showYear=nowYear-yearNums;var showCurrentMonth=Number($(_this.container).find(".month").html().split(" ")[0]);if(1<showCurrentMonth&&showCurrentMonth<=10){showMonth='0'+(showCurrentMonth-1);}else if(10<showCurrentMonth&&showCurrentMonth<=12){showMonth=showCurrentMonth-1;}else if(showCurrentMonth===1){showMonth=12;}
$(_this.container).find(".month").html(showMonth);timeStart=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(timeStart));timeEnd=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");_this.renderModal(timeStart,timeEnd,showMonth);})
$(this.container).find(".rightButton").click(function(){rightCount=rightCount+1;if(rightCount===1){current=Number($(_this.container).find(".month").html().split(" ")[0]);}
var value=(rightCount-(12-current))/12;var yearNums,showYear,showMonth;if(value>0){yearNums=parseInt(value)+1;}else if(value===0){yearNums=1;}else{yearNums=0;}
showYear=nowYear-yearNums;var showCurrentMonth=Number($(_this.container).find(".month").html().split(" ")[0]);if(showCurrentMonth>=1&&showCurrentMonth<9){showMonth='0'+(showCurrentMonth+1);}else if(showCurrentMonth>=9){showMonth=showCurrentMonth+1;}else if(showCurrentMonth===12){showMonth='01';}
$(_this.container).find(".month").html(showMonth);timeStart=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(timeStart));timeEnd=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");_this.renderModal(timeStart,timeEnd,showMonth);})},ModalAPPMonthHistory.prototype.showConfigMode=function(){},ModalAPPMonthHistory.prototype.setModalOption=function(option){this.entity.modal.option={};};return ModalAPPMonthHistory;})()
var ModalAppBlind=(function(){function ModalAppBlind(screen,entityParams){if(!screen)return;if(!entityParams)return;this.screen=screen;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.tempOpt=undefined;};ModalAppBlind.prototype=new ModalBase();ModalAppBlind.prototype.optionTemplate={name:'toolBox.modal.APP_BLIND',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppBlind',scroll:false};ModalAppBlind.prototype.show=function(){this.init();}
ModalAppBlind.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';}
ModalAppBlind.prototype.renderModal=function(){var _this=this;if(this.entity.modal.option&&this.entity.modal.option instanceof Array){var arrItem=this.entity.modal.option;this.entity.modal.option={};this.entity.modal.option.arrItem=arrItem;}
var blindOpt=undefined;_this.entity.modal.option&&(blindOpt=_this.entity.modal.option.arrItem);if(!blindOpt||blindOpt.length===0)return;var $currentContainer=$(_this.container);var blindDivBox='<div id="blindDivBox" class="gray-scrollbar"></div>';$currentContainer.append(blindDivBox);var $blindDivBox=$currentContainer.find('#blindDivBox');for(var m=0;m<blindOpt.length;m++){var isExist=false;var classNameFlag;if(m%2===0){classNameFlag='blindContainerOdd';}else{classNameFlag='blindContainerEven';}
for(var i=0,item;i<_this.screen.store.layout.length;i++){$currentContainer.css({'display':'flex','overflow-y':'hidden','flex-flow':'wrap'});for(var j=0;j<_this.screen.store.layout[i].length;j++){item=_this.screen.store.layout[i][j];if(blindOpt[m].subChartIds[0].id!=item.id)continue;isExist=true;var modelClass,entity;var blindContainerSin='<div class="blindContainerSin '+classNameFlag+'">\
                                        <div class="blindConTitle bgColorTemp1 borderColorTemp1" style="border-radius:0"><span class="glyphicon glyphicon-align-justify" style="color:#ca2929;padding-right:10px;"></span>'+blindOpt[m].blindTitle+'</div>\
                                        <div class="blindConContent gray-scrollbar" style="width:100%;overflow-y:auto"></div>\
                                    </div>';$blindDivBox.append(blindContainerSin);$currentContainer.find('.blindConTitle').off('click').click(function(){var $this=$(this);if($this.siblings('.blindConContent').hasClass('showSibling'))return;$currentContainer.find('.blindConContent').removeClass('showSibling').hide();$this.siblings('.blindConContent').addClass('showSibling').show().css({maxHeight:$blindDivBox.parent().height()-$('.blindContainerSin',$currentContainer).length*$('.blindContainerSin',$currentContainer).height()});});if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalAppBlind'){item.scroll=false;entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){entity.container.style.overflowY="auto";entity.render();var $currentBlindCon=$blindDivBox.find('.blindContainerSin').eq(m).children('.blindConContent');$currentBlindCon.height($currentContainer.children('.springContainer').height());$currentBlindCon.append($currentContainer.children('.springContainer'));continue;}
if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
if(entity.optionTemplate.scroll!==false){if(AppConfig.isMobile){entity.container.style.height=ElScreenContainer.offsetHeight*entity.entity.spanR*2/9+'px';}else{entity.container.style.height=$blindDivBox.height()*entity.entity.spanR/6+'px';}}
entity.container.style.width=$(entity.container).parent().parent('.springContainer').width()+'px';entity.container.style.overflowY="auto";entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);entity.render();_this.screen.isForReport&&entity.configure();}
var $currentBlindCon=$blindDivBox.find('.blindContainerSin').eq(m).children('.blindConContent');if(entity.optionTemplate.scroll!==false){if(!AppConfig.isMobile){$currentBlindCon.height($currentContainer.children('.springContainer').height());}}
$currentBlindCon.append($currentContainer.children('.springContainer'));}}}
$currentContainer.find('#blindDivBox').find('.blindContainerSin').find('.blindConContent').hide();$currentContainer.find('#blindDivBox').find('.blindContainerSin:first-child').find('.blindConContent').addClass('showSibling').show();Spinner&&Spinner.stop();}
ModalAppBlind.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
ModalAppBlind.prototype.configureModalNone=function($chartsCt,opt){var spanC=12,spanR=3;if($chartsCt.children().length>0){var lastDiv=$chartsCt.children()[$chartsCt.children().length-1];spanC=Math.round(parseInt(lastDiv.style.width.split('%')[0])/10)*12/10;spanR=Math.round(parseInt(lastDiv.style.height.split('%')[0])/10)*6/10;}
if(!this.container.classList.contains('chartsCt')){this.container=this.container.parentElement.getElementsByClassName('chartsCt')[0];}
var entity=new ModalNone(this,{id:(+new Date()).toString(),spanC:spanC,spanR:spanR,modal:{type:"ModalNone"},isNotRender:true});this.screen.arrEntityOrder.push(entity.entity.id);this.screen.listEntity[entity.entity.id]=entity;opt.subChartIds=new Array();opt.subChartIds.push({id:entity.entity.id});entity.render();entity.configure();this.entity.modal=this.tempOpt;}
ModalAppBlind.prototype.showConfigMode=function(){}
ModalAppBlind.prototype.configure=function(){var _this=this;if(this.spinner)this.spinner.stop();if(this.chart)this.chart.clear();this.divResizeByMouseInit();if(this.entity.modal.option&&this.entity.modal.option instanceof Array){var arrItem=this.entity.modal.option;this.entity.modal.option={};this.entity.modal.option.arrItem=arrItem;}
var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();_this.tempOpt=_this.tempOpt?_this.tempOpt:_this.entity.modal;if(_this.tempOpt.option&&_this.tempOpt.option.arrItem&&_this.tempOpt.option.arrItem.length>0){for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(_this.tempOpt.option.arrItem[i].subChartIds.length===0)continue;if(_this.tempOpt.option.arrItem[i].subChartIds[0].id===_this.screen.arrEntityOrder[j]){_this.screen.removeEntity(_this.screen.arrEntityOrder[j]);}}}
_this.tempOpt.option=[];}
_this.screen.removeEntity(_this.entity.id);$('#divContainer_'+_this.entity.id).remove();};divMask.appendChild(btnRemove);var btnInstall=document.createElement('span');btnInstall.className='glyphicon glyphicon-cog springBlindConfigInstallBtn grow';btnInstall.title='config';btnInstall.onclick=function(e){_this.showConfigModal();}
divMask.appendChild(btnInstall);var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $chartCt=$('<div class="divResize chartsCt gray-scrollbar">');divMask.appendChild($chartCt[0]);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};this.showConfigMode();}
ModalAppBlind.prototype.attBlindEvent=function(){var _this=this;$('.blindNameEnter').off('blur').blur(function(){var $this=$(this);var currentTitle=$this.val().trim();if(currentTitle==='')return;var $currentBlind=$this.parents('.divBlind');$this.hide();$this.siblings('.blindNameShow').text(currentTitle).css('display','inline-block');var index=$('.divBlind').index($currentBlind);_this.tempOpt.option.arrItem[index].blindTitle=currentTitle;});$('.blindNameShow').off('click').click(function(){var $this=$(this);var currentTitle=$this.text();$this.hide();$this.siblings('.blindNameEnter').val(currentTitle).css('display','inline-block').focus();});$('.deleteBlind').off('click').click(function(){var $this=$(this);var $parents=$this.parents('.divBlind');var parentId=$parents.attr('data-id');for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){var currentOpt;if(_this.tempOpt.option.arrItem[i].domDataId.toString()===parentId){currentOpt=_this.tempOpt.option.arrItem[i];if(currentOpt&&currentOpt.subChartIds.length!==0){for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(currentOpt.subChartIds[0].id===_this.screen.arrEntityOrder[j]){var isNotModalNone=false;if($('#divContainer_'+_this.screen.arrEntityOrder[j]).length>0&&$('#divContainer_'+_this.screen.arrEntityOrder[j]).find('.divTitleAndType').length>0){isNotModalNone=true;}
if(!isNotModalNone){if(_this.chart)_this.chart.clear();_this.tempOpt.option.arrItem.splice(i,1);$parents.empty().remove();i=i-1;}
var num=i;$('#divContainer_'+_this.screen.arrEntityOrder[j]).find('span.springConfigRemoveBtn').trigger('click',callback);function callback(isDelete){if(isDelete){if(_this.chart)_this.chart.clear();_this.tempOpt.option.arrItem.splice(num,1);$parents.empty().remove();}}}}}else{_this.tempOpt.option.arrItem.splice(i,1);$parents.empty().remove();i=i-1;}}}
_this.entity.modal.option=_this.tempOpt.option;});}
ModalAppBlind.prototype.createDivBlind=function(opt){var divBlind=document.createElement('div');divBlind.className='divBlind';if(opt&&opt.domDataId){divBlind.setAttribute('data-id',opt.domDataId);}else{var nowValue=new Date().valueOf();divBlind.setAttribute('data-id',nowValue);}
var $divBlind=$(divBlind);divBlind.innerHTML='<label class="blindName">标题：</label>\
            <span class="blindNameShow"></span>\
            <input type="text" class="blindNameEnter"/>\
            <span class="deleteBlind glyphicon glyphicon-remove-circle"></span>\
            ';if(opt&&opt.blindTitle){$divBlind.find('.blindNameShow').text(opt.blindTitle).css('display','inline-block');$divBlind.find('.blindNameEnter').hide();}
if(!opt){if(!this.tempOpt.option){this.tempOpt.option={};this.tempOpt.option.arrItem=[];}else if(this.tempOpt.option instanceof Array){var arrItem=this.tempOpt.option;this.tempOpt.option={};this.tempOpt.option.arrItem=arrItem;}
this.tempOpt.option.arrItem.push({id:'',domDataId:nowValue,title:'',blindTitle:'',modalType:'',subChartIds:[]})};return divBlind;}
ModalAppBlind.prototype.showConfigModal=function(){var _this=this;var $blindChartShow=$('#blindChartShow');$blindChartShow.empty().remove();if($blindChartShow.length===0){$blindChartShow=$('<div class="modal fade" id="blindChartShow"></div>');}
$('#paneContent').append($blindChartShow);var blindChartCon='<div class="modal-dialog"><div class="modal-content">'+'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">APP百叶窗</h4><span class="glyphicon glyphicon-plus-sign blindAddBtn grow" style=""></span></div>'+'<div class="modal-body gray-scrollbar">'+'</div>'+'<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="btnBlindListShow">确定</button></div>'+'</div></div>';$blindChartShow.append(blindChartCon);_this.tempOpt=_this.tempOpt?_this.tempOpt:$.extend(true,{},_this.entity.modal);$blindChartShow.find('.modal-body').html('<div class="row" style="margin:15px 0;">\
                        <div class="col-xs-3">背景颜色</div>\
                        <div class="col-xs-2">\
                        <select id="selBgColor">\
                        <option value="transparent">无</option>\
                        <option value="#ffffff">白</option>\
                        <option value="#000000">黑</option>\
                        <option value="#337ab7">蓝</option>\
                        <option value="#5cb85c">绿</option>\
                        <option value="custom">自定义</option>\
                        </select>\
                        </div>\
                        <div class="col-xs-2"><input type="input" id="iptBgColor" placeholder="#ffffff" style="width:60px;display:none;"/></div>\
                        <div class="col-xs-2"><input type="color" class="" id="bgColorView" style="display:none;"/></div>\
                        </div>');if(!_this.tempOpt.option||!_this.tempOpt.option.arrItem||_this.tempOpt.option.arrItem.length===0){$blindChartShow.find('.modal-body').append(_this.createDivBlind());}else{for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){var item=_this.tempOpt.option.arrItem[i];var isExist=false;for(var j in _this.screen.listEntity){if(item.subChartIds.length===0){continue;}
if(item.subChartIds[0].id===j){isExist=true;break;}}
if(!isExist){_this.tempOpt.option.arrItem.splice(i,1);i=i-1;}else{$blindChartShow.find('.modal-body').append(_this.createDivBlind(_this.tempOpt.option.arrItem[i]));}}}
$blindChartShow.modal('show');$blindChartShow.find('.blindAddBtn').off('click').click(function(e){$blindChartShow.find('.modal-body').append(_this.createDivBlind());_this.attBlindEvent();});_this.attBlindEvent();var $iptBgColor=$('#iptBgColor',$blindChartShow);var $bgColorView=$('#bgColorView',$blindChartShow);var $selBgColor=$('#selBgColor',$blindChartShow);$('#btnBlindListShow').off('click').click(function(){var opts=_this.tempOpt.option.arrItem;if(opts){var $chartsCt=_this.container.classList.contains('chartsCt')?$(_this.container):$(_this.container).siblings().find('.chartsCt');if(opts[0].subChartIds.length===0){$chartsCt.children().empty().remove();for(var i=0;i<opts.length;i++){_this.configureModalNone($chartsCt,opts[i]);}}else{var $containerChartsCt=$(_this.container);if(_this.screen.arrEntityOrder.length===1){_this.tempOpt.option=[];return;}
for(var i=0;i<opts.length;i++){var isExist=false;var currentOption=$containerChartsCt.children('.springContainer').length>0?$containerChartsCt.children('.springContainer'):$containerChartsCt.siblings('.springConfigMask').find('.chartsCt').find('.springContainer');for(var j=0;j<currentOption.length;j++){var currentId=currentOption[j].id.split('_')[1];if(opts[i].subChartIds.length!==0){if(currentId===opts[i].subChartIds[0].id){isExist=true;continue;}}}
if(!isExist){_this.configureModalNone($chartsCt,opts[i]);}}}
_this.entity.modal.option.bgColor=$iptBgColor.val();}});_this.entity.modal.option&&setShow(_this.entity.modal.option.bgColor);$selBgColor.off('change').on('change',function(e){setShow(this.value,e);});$iptBgColor.off('input').on('input',function(){$bgColorView.val(this.value);});$blindChartShow.children('.modal').modal();function setShow(selected,event){if(selected==='transparent'){$bgColorView.hide();}else{$bgColorView.val(selected);$bgColorView.show();}
if(selected==='custom'){$iptBgColor.show();$iptBgColor.val('').focus();}else{$iptBgColor.hide();$iptBgColor.val(selected);}
if(!event){$selBgColor.val(selected);if(!$selBgColor.val()){$selBgColor.val('custom');$iptBgColor.val(selected).show().focus();}}}}
return ModalAppBlind;})()
var ModalAppPie=(function(){function ModalAppPie(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;this.screen=screen;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppPie.prototype=new ModalBase();ModalAppPie.prototype.optionTemplate={name:'toolBox.modal.APP_PIE',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppPie'};ModalAppPie.prototype.show=function(){this.init();};ModalAppPie.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalAppPie.prototype.renderModal=function(){this.entity.modal.interval=5;var $appPieTotalBox=$(this.container).find('.appPieTotalBox');if($appPieTotalBox.length>0)return;var appPieTotalBox='<div class="appPieTotalBox"><div class="appPieTextShow">\
                <div class="appPieTotalBoxTitle"><span>能耗统计</span></div>\
                <div class="leftAppChartLegend divAppChartTip row">\
                </div>\
                <div class="divAppEnergyLabel">\
                    <div class="ctnRealVal">\
                        <div class="divRealVal">\
                            <span class="spLabelName">今日能耗：</span></br>\
                            <span class="spRealVal spTodayEnergy"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">昨日能耗：</span></br>\
                            <span class="spRealVal spYestEnergy"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">今日费用：</span></br>\
                            <span class="spRealVal spAppTodayCost"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">昨日费用：</span></br>\
                            <span class="spRealVal spAppYestCost"></span>\
                        </div>\
                    </div>\
                    <div class="ctnPercentage">\
                        <div class="divPercentage">\
                            <span class="spPercentVal spTodayEnergyPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spYestEnergyPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spAppTodayCostPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spAppYestCostPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                    </div>\
                </div>\
            </div>\
            <div class="divAppChart " id="divEnergyChart">\
                <div class="divAppChildChart divAppItemEnergy"></div>\
                <div class="divAppChildChart divAppTotalEnergy"></div>\
            </div>\
            </div>';$(this.container).append(appPieTotalBox);$(this.container).find('.divAppItemEnergy').css({width:$(this.container).width()*0.6,height:$(this.container).height()});$(this.container).find('.divAppTotalEnergy').css({width:$(this.container).width()*0.37,height:$(this.container).height()});};ModalAppPie.prototype.updateModal=function(point){var $currentContainer=$(this.container);$currentContainer.find('.panel-default').css('background-color','#fff')
var data=JSON.parse(point[0].data);var nameList=[];var pointList=[];var spIconColor=['#6dbef3','#008ae2','#028f68','#00a045','#6cc332','#eeed00'];var colorJ=0;var $leftAppChartLegend=$currentContainer.find('.leftAppChartLegend');$leftAppChartLegend.children().empty().remove();var projectId=data.EnergyList[0].projectId;if(!projectId){if(AppConfig.project&&AppConfig.project.bindId){projectId=AppConfig.project.bindId;}else{projectId=AppConfig.projectId;}}
for(var i=0;i<data.EnergyList[0].children.length;i++){var item=data.EnergyList[0].children[i];nameList.push(item.name);pointList.push('@'+projectId+'|'+item.accumEnergyPoint);var singleLegendDiv='<div class="spAppChartLegend col-xs-6">\
                                <span class="spIcon" style="background-color:'+spIconColor[colorJ]+'"></span>\
                                <span class="spName">\
                                </span>\
                            </div>'
$leftAppChartLegend.append(singleLegendDiv);if(colorJ===data.EnergyList[0].children.length-1)colorJ=0;$currentContainer.find('.appPieTotalBox').find('.spAppChartLegend').eq(i).find('.spName').text(item.name);colorJ++;}
var accumPostData={dsItemIds:pointList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'m5',timeStart:new Date().format('yyyy-MM-dd')+' 00:00:00'}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',accumPostData).done(function(result){if(result&&result.list&&result.list.length!==0){var dataArr=[];for(var i=0;i<result.list.length;i++){if(result.list[i].data&&result.list[i].data.length>0){dataArr.push({value:(result.list[i].data[result.list[i].data.length-1]-result.list[i].data[0]).toFixed(2),name:nameList[i]});}else{dataArr.push({value:0,name:nameList[i]});}}
var $divAppItemEnergy=$currentContainer.find('.divAppItemEnergy');var leftOption={color:['#6dbef3','#008ae2','#028f68','#00a045','#6cc332','#eeed00'],tooltip:{trigger:'item'},calculable:false,legend:{show:false,data:nameList},toolbox:{show:false},series:[{name:'能耗(kWh)',type:'pie',radius:['40%','60%'],clockWise:false,center:['48%','46%'],itemStyle:{normal:{borderColor:'white',label:{show:true,formatter:function(params){return params.percent.toFixed(1)+'%'},textStyle:{color:'#646464',fontFamily:'Microsoft Yahei'}},labelLine:{show:true,length:0}}},data:dataArr}]}
var chart=echarts.init($divAppItemEnergy[0]);chart.setOption(leftOption);}});var dsItemIds=[];dsItemIds.push('@'+projectId+'|'+data.EnergyList[0].accumCostPoint);dsItemIds.push('@'+projectId+'|'+data.EnergyList[0].accumEnergyPoint);var postData={dsItemIds:dsItemIds,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'m5',timeStart:new Date().format('yyyy-MM-dd')+' 00:00:00'}
var yestodayEnergy,yestodayCost,todayEnergy,todayCost,todayEnergyEnd,todayCostEnd;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(resultData){if(resultData.list.length>0){var todayEnergyDataAll=resultData.list[1].data;var todayCostDataAll=resultData.list[0].data;if(point.length===2){todayEnergyEnd=point[1].data;todayCostEnd=point[1].data;}else if(point.length===3){todayEnergyEnd=point[2].data;todayCostEnd=point[1].data;}else{todayEnergyEnd=todayEnergyDataAll[todayEnergyDataAll.length-1];todayCostEnd=todayCostDataAll[todayCostDataAll.length-1];}
if(todayEnergyDataAll.length!==0){todayEnergy=todayEnergyEnd-todayEnergyDataAll[0];}else{todayEnergy=0;}
if(todayCostDataAll.length!==0){todayCost=todayCostEnd-todayCostDataAll[0];}else{todayCost=0;}}
var $divAppEnergyLabel=$currentContainer.find('.divAppEnergyLabel');$divAppEnergyLabel.find('.spTodayEnergy').text(kIntSeparate(todayEnergy)+' kwh');$divAppEnergyLabel.find('.spAppTodayCost').text('￥ '+kIntSeparate(todayCost));var postDataYes={dsItemIds:dsItemIds,timeEnd:new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd')+' 23:59:59',timeFormat:'m5',timeStart:new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd')+' 00:00:00'}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postDataYes).done(function(resultDataYes){if(resultDataYes.list.length>0){var yestodayEnergyDataAll=resultDataYes.list[1].data;var yestodayCostDataAll=resultDataYes.list[0].data;if(yestodayEnergyDataAll.length!==0){yestodayEnergy=yestodayEnergyDataAll[yestodayEnergyDataAll.length-1]-yestodayEnergyDataAll[0];}else{yestodayEnergy=0;}
if(yestodayCostDataAll.length!==0){yestodayCost=yestodayCostDataAll[yestodayCostDataAll.length-1]-yestodayCostDataAll[0];}else{yestodayCost=0;}
$divAppEnergyLabel.find('.spYestEnergy').text(kIntSeparate(yestodayEnergy)+' kwh');$divAppEnergyLabel.find('.spAppYestCost').text('￥ '+kIntSeparate(yestodayCost));$divAppEnergyLabel.find('.spTodayEnergyPercent').text((todayEnergy*100/(todayEnergy+yestodayEnergy)).toFixed(0)+'%');$divAppEnergyLabel.find('.spYestEnergyPercent').text((yestodayEnergy*100/(todayEnergy+yestodayEnergy)).toFixed(0)+'%');$divAppEnergyLabel.find('.spAppTodayCostPercent').text((todayCost*100/(todayCost+yestodayCost)).toFixed(0)+'%');$divAppEnergyLabel.find('.spAppYestCostPercent').text((yestodayCost*100/(todayCost+yestodayCost)).toFixed(0)+'%');var labelTop={normal:{color:'#6aa7fd',label:{show:false,position:'center',formatter:'{b}',textStyle:{baseline:'bottom'}},labelLine:{show:false}}};var labelFromatter={normal:{label:{show:false,formatter:function(params){return 100-params.value+'%'},textStyle:{baseline:'top'}}}};var labelBottom={normal:{color:'white',label:{show:false,position:'center'},labelLine:{show:false}},emphasis:{color:'rgba(0,0,0,0)'}};var borderItemStyle={normal:{color:'#6aa7fd',label:{show:false},labelLine:{show:false}}};var radius=[0,'16%'];var borderRadius=['17%','21%'];var rightOption={legend:{show:false,data:['今日能耗','昨日能耗','今日费用','昨日费用']},title:{text:'The App World',show:false},toolbox:{show:false},series:[{type:'pie',center:['75%','25%'],radius:radius,x:'0%',itemStyle:labelFromatter,data:[{name:'other',value:yestodayEnergy,itemStyle:labelBottom},{name:'今日能耗',value:todayEnergy,itemStyle:labelTop}]},{type:'pie',center:['75%','25%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','45%'],radius:radius,x:'20%',itemStyle:labelFromatter,data:[{name:'other',value:todayEnergy,itemStyle:labelBottom},{name:'昨日能耗',value:yestodayEnergy,itemStyle:labelTop}]},{type:'pie',center:['75%','45%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','65%'],radius:radius,x:'40%',itemStyle:labelFromatter,data:[{name:'other',value:yestodayCost,itemStyle:labelBottom},{name:'今日费用',value:todayCost,itemStyle:labelTop}]},{type:'pie',center:['75%','65%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','85%'],radius:radius,x:'60%',itemStyle:labelFromatter,data:[{name:'other',value:todayCost,itemStyle:labelBottom},{name:'昨日费用',value:yestodayCost,itemStyle:labelTop}]},{type:'pie',center:['75%','85%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]}]};var $divAppTotalEnergy=$currentContainer.find('.divAppTotalEnergy');var chart=echarts.init($divAppTotalEnergy[0]);chart.setOption(rightOption);}}).always(function(){this.spinner&&this.spinner.stop();})})};ModalAppPie.prototype.showConfigMode=function(){}
return ModalAppPie;})()
function tofixed(str,accuracy){if(!accuracy)accuracy=2;return parseFloat(str).toFixed(accuracy);}
var ModalKPIStruct=(function(){function ModalKPIStruct(screen,entityParams){this.$configModal=undefined;this.$modal=undefined;this.tempOpt=undefined;this.subEntity=undefined;this.store={};if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalKPIStruct.prototype=new ModalBase();ModalKPIStruct.prototype.optionTemplate={name:'toolBox.modal.KPI_STRUCT',parent:3,mode:'custom',maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalKPIStruct',scroll:false};ModalKPIStruct.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"type":'option',"widget":[{id:'needDetail',type:'checkbox',name:'是否显示细节'}]},{"module":"dsDrag","data":[{type:'point',name:'KPI分项统计来源',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalKPIStruct.prototype.show=function(){this.init();};ModalKPIStruct.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.needDetail)this.configModalOpt.area[0].widget[0].data=this.entity.modal.option.needDetail;if(this.entity.modal.option.structPoint)this.configModalOpt.area[1].data[0].data=this.entity.modal.option.structPoint;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();}};ModalKPIStruct.prototype.getRealTimePoint=function(list,arr){var _this=this;if(!arr)arr=[];list.forEach(function(item){if(item.point){arr.push(_this.entity.modal.option.prefix+item.point);}
if(item.children instanceof Array&&item.children.length>0){_this.getRealTimePoint(item.children,arr)}});return arr;};ModalKPIStruct.prototype.init=function(){};ModalKPIStruct.prototype.renderModal=function(e){$(this.container).addClass('widgetKPIItemEval gray-scrollbar');var _this=this;var postData={'dsItemIds':this.entity.modal.option.structPoint};this.container.innerHTML='<div class="divKPIIndex"></div><div class="divKPIDetail"></div>';if(this.entity.modal.option.needDetail){_this.renderDetailContainer();$(_this.container).addClass('showSubContainer');}
_this.attachEvent();};ModalKPIStruct.prototype.renderDetailContainer=function(){var containerDetail=this.container.querySelector('.divKPIDetail');var item={modal:{type:'ModalHtml',interval:60000,option:{html:'<div>开发中</div>'},points:[],title:''},spanC:9,spanR:6};this.initSubEntity(containerDetail,item)};ModalKPIStruct.prototype.attachEvent=function(){var _this=this;var clickEvent=AppConfig.isMobile?'tap':'click';$(this.container).off(clickEvent).on(clickEvent,'.divStructTtl',function(e){$(e.currentTarget).parent().toggleClass('focus');});$(this.container).on(clickEvent,'.divStructItem',function(e){var $target=$(e.currentTarget);if($target.hasClass('focus')){$target.removeClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().removeClass('focus')}else{$(_this.container).find('.rowPointDetail.focus').removeClass('focus');$(_this.container).find('.divStructItem.focus').removeClass('focus');$target.addClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().addClass('focus');_this.subEntity&&_this.refreshSubEntity($target)}});};ModalKPIStruct.prototype.refreshSubEntity=function($target){var itemIndex=$target.parentsUntil('.divKPIIndex','.divStructCtn')[0].dataset.itemIndex;var childIndex=$target[0].dataset.itemChildIndex;if(!this.store.KPIList)return;var arrPoint=[],strPoint;try{arrPoint=this.store.KPIList[itemIndex].children[childIndex].relatedPoints;strPoint=arrPoint.map(function(point){return point.point}).toString();}catch(e){strPoint='数据格式不符合'}
var _this=this;this.subEntity.entity.modal.points=arrPoint.map(function(point){return(_this.entity.modal.option.prefix+point.point)});this.subEntity.entity.modal.option.html='<div>'+strPoint+'</div><script>this.onUpdateComplete=function(data){console.log(data)}</script>';this.updateSubEntity();};ModalKPIStruct.prototype.initPointMap=function(points){var _this=this;var $dom;points.forEach(function(point){_this.initPointDetail(point.dsItemId,point.data)})};ModalKPIStruct.prototype.initPointDetail=function(id,strData){var $dom=$('[data-point="'+id+'"]');if($dom.length==0)return;var data;if(!isNaN(Number(strData))){data={score:Number(strData)}}else{try{data=JSON.parse(strData)}catch(e){$dom.text('No Data');$('.pointDetail[data-detail="'+id+'"]').text('No Data');return;}}
var status='';if(parseFloat(data.score)>=60){status='success';$dom.text(parseFloat(data.score.toFixed(2))+'%');}else if(parseInt(data.score)>=0){status='danger';$dom.text(parseFloat(data.score.toFixed(2))+'%');}else{status='default';$dom.text('--');}
$dom.removeClass('success danger default').addClass(status);var $detail=$('.pointDetail[data-detail="'+id+'"]');if($detail.length>0){$detail.removeClass('success danger default').addClass(status);$detail.text(data.detail);}
if($dom.hasClass('spItemInfo')){$dom.next().removeClass('success danger default').addClass(status)}};ModalKPIStruct.prototype.initStruct=function(struct,index){var _this=this;var structDom=this.container.querySelector('[data-item="'+struct.name+'"]');var kpiIndexDom=this.container.querySelector('.divKPIIndex');if(!structDom){structDom=document.createElement('div');structDom.className='divStructCtn focus';structDom.dataset.item=struct.name;structDom.dataset.itemIndex=index;var defaultSvg='<svg version="1.1" id="图形" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                    <path class="svgpath" data-index="path_0" fill="#272636" d="M1002.496 414.208c-5.44-28.672-22.592-47.04-43.456-46.528l-4.352 0c-71.808 0-130.24-58.432-130.24-130.24 0-23.68 11.264-49.6 11.328-49.792 11.072-24.96 2.56-55.616-19.84-71.232l-1.216-0.832-125.248-69.568-1.28-0.576c-7.424-3.2-15.552-4.864-24.192-4.864-17.856 0-35.328 7.104-46.784 19.008-15.296 15.808-63.488 56.768-102.4 56.768-39.296 0-87.808-41.792-103.168-57.856-11.52-12.16-29.12-19.392-47.168-19.392-8.448 0-16.448 1.6-23.744 4.672L339.2 44.224 209.536 115.456l-1.28 0.896C185.792 131.968 177.216 162.56 188.288 187.52c0.128 0.256 11.328 26.24 11.328 49.856 0 71.808-58.432 130.24-130.24 130.24L65.024 367.616c-20.928-0.512-38.08 17.92-43.456 46.528C21.12 416.448 11.072 470.144 11.072 512.384c0 42.304 10.048 95.936 10.496 98.176 5.376 28.288 22.08 46.592 42.688 46.592 0.256 0 0.512 0 0.768 0l4.352 0c71.808 0 130.24 58.432 130.24 130.24 0 23.68-11.264 49.6-11.328 49.792-11.072 24.96-2.56 55.616 19.776 71.232l1.216 0.832 122.88 68.736 1.28 0.576c7.424 3.264 15.488 4.928 24.128 4.928 18.048 0 35.648-7.424 47.04-19.84 14.4-15.68 64.576-60.352 104.704-60.352 40.448 0 89.792 44.416 105.408 61.504 11.456 12.608 29.184 20.16 47.36 20.16l0 0 0 0c8.448 0 16.384-1.6 23.68-4.736l1.344-0.576 127.36-70.4 1.28-0.896c22.4-15.616 30.976-46.272 19.904-71.168-0.128-0.256-11.328-26.24-11.328-49.856 0-71.808 58.432-130.24 130.24-130.24l4.352 0c20.928 0.448 38.08-17.92 43.456-46.528 0.448-2.24 10.496-55.936 10.496-98.176C1012.928 470.144 1002.88 416.448 1002.496 414.208L1002.496 414.208zM509.824 685.248c-95.68 0-173.504-77.824-173.504-173.504 0-95.68 77.824-173.504 173.504-173.504 95.68 0 173.504 77.824 173.504 173.504C683.264 607.424 605.44 685.248 509.824 685.248L509.824 685.248zM509.824 685.248"></path>\
                    <path class="svgpath" data-index="path_1" fill="#272636" d="M509.824 397.248 509.824 397.248c-63.104 0-114.496 51.328-114.496 114.496 0 63.104 51.328 114.496 114.496 114.496 63.104 0 114.496-51.328 114.496-114.496C624.256 448.64 572.928 397.248 509.824 397.248L509.824 397.248zM509.824 397.248"></path>\
                </svg>';var structTtl=document.createElement('div');structTtl.className='divStructTtl';structTtl.innerHTML='\
            <span class="spStructIcon">'+defaultSvg+'</span>\
            <span class="spStructName">'+struct.name+'</span>\
            <span class="spStructValue">综合达标率：<span class="spStructPt" data-point="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'">Loading</span></span>\
            <!--<span class="pointDetail" data-detail="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'">Loading</span>-->';var structBody=document.createElement('div');structBody.className='divStuctBody';structBody.appendChild(this.createStructItemTtl(struct.children));if((struct.children instanceof Array)&&struct.children.length>0){struct.children.forEach(function(item,index){structBody.appendChild(_this.createStructItem(item,index));structBody.appendChild(_this.createPointDetail(item))})}
structDom.appendChild(structTtl);structBody.appendChild(_this.createPointDetail(struct));structDom.appendChild(structBody);kpiIndexDom.appendChild(structDom);}};ModalKPIStruct.prototype.createStructItemTtl=function(){var structItemTtl=document.createElement('div');structItemTtl.className='divStructItemTtl';structItemTtl.innerHTML='\
            <span class="spStructItemTtl">考核项</span>\
            <span class="spStructItemTtl">月达标率</span>\
            <span class="spStructItemTtl">考核结果</span>\
            ';return structItemTtl};ModalKPIStruct.prototype.createPointDetail=function(item){var structDetail=document.createElement('tr');structDetail.className='rowPointDetail';if(item.desc){structDetail.innerHTML='<td class="divPointDetail" colspan="5"><span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">'+item.desc+'</span></td>'}else{structDetail.innerHTML='<td class="divPointDetail" colspan="5"><span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">'+I18n.resource.dashboard.modalKPIStruct.NO_DATA_TEMP+'</span></td>';}
return structDetail;};ModalKPIStruct.prototype.createStructItem=function(item,index){var structItem=document.createElement('div');structItem.dataset.itemChildIndex=index;structItem.className='divStructItem';structItem.innerHTML='\
            <span class="spItemInfo">'+(item.name?item.name:'')+'</span>\
            <span class="spItemInfo" data-point="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">Loading</span>\
            <span class="spItemInfo spItemKPIRs">\
                <span class="label label-success">达&nbsp;&nbsp;&nbsp;标</span>\
                <span class="label label-danger">不达标</span>\
                <span class="label label-default">未开启</span>\
            </span>\
            <!--<span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">Loading</span>-->';return structItem;};ModalKPIStruct.prototype.updateModal=function(points){this.spinner.stop();if(!(points[0]&&points[0].data))return;var structList;var _this=this;try{structList=JSON.parse(points[0].data).KPIList;}catch(e){return;}
this.store.KPIList=structList;structList.forEach(function(struct,index){_this.initStruct(struct,index);});var arrPoint=this.getRealTimePoint(structList);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:arrPoint}).done(function(result){if(!result.dsItemList)return;_this.initPointMap(result.dsItemList);});};ModalKPIStruct.prototype.showConfigMode=function(){};ModalKPIStruct.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];var projectId=1;if(AppConfig.project&&AppConfig.project.bindId){projectId=AppConfig.project.bindId;}else{projectId=AppConfig.projectId}
this.entity.modal.option.prefix='@'+projectId+'|';};return ModalKPIStruct;})();var ModalEnergySaveRate=(function(){function ModalEnergySaveRate(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalEnergySaveRate.prototype=new ModalBase();ModalEnergySaveRate.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_ENERGY_SAVE_RATE',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalEnergySaveRate'};ModalEnergySaveRate.prototype.renderModal=function(){var _this=this;WebAPI.get('/static/scripts/spring/entities/modalEnergySaveRate.html').done(function(resultHtml){_this.container.innerHTML=resultHtml;I18n.fillArea($('#energySaveName').parent());});},ModalEnergySaveRate.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+'%';$('#energySavePerVal').text(show);$('#progressItem').css('width',show);},ModalEnergySaveRate.prototype.showConfigMode=function(){var _this=this;},ModalEnergySaveRate.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalEnergySaveRate;})();var ModalCoalSaveTotal=(function(){function ModalCoalSaveTotal(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalCoalSaveTotal.prototype=new ModalBase();ModalCoalSaveTotal.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_COAL_SAVE_TOTAL',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalCoalSaveTotal'};ModalCoalSaveTotal.prototype.renderModal=function(){this.container.innerHTML=template;I18n.fillArea($('#coalSaveName').parent());},ModalCoalSaveTotal.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+' Ton';$('#coalSaveVal').text(show);},ModalCoalSaveTotal.prototype.showConfigMode=function(){var _this=this;},ModalCoalSaveTotal.prototype.setModalOption=function(option){this.entity.modal.interval=5;};var template='<style type="text/css">\
        .frameCtl {position: relative;height: 100%;}\
        .imgBackground {position: absolute;width: 100%;height: 100%;right: 0;bottom: 0;top: 0;left: 0;z-index: -1;}\
        #coalSaveVal {position: absolute;left: 60px;top: 40px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
        #coalSaveName {position: absolute;left: 60px;top: 80px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
    </style>\
    <div class="frameCtl">\
        <img src="/static/images/spring/entities/modalCoalSaveTotal.png" class="imgBackground" alt="Background image">\
        <div id="coalSaveVal"> Ton</div>\
        <div id="coalSaveName" i18n="dashboard.carbonFootprint.STANDARD_COAL_SAVING"></div>\
    </div>';return ModalCoalSaveTotal;})();var ModalCo2SaveTotal=(function(){function ModalCo2SaveTotal(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalCo2SaveTotal.prototype=new ModalBase();ModalCo2SaveTotal.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CO2_SAVE_TOTAL',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalCo2SaveTotal'};ModalCo2SaveTotal.prototype.renderModal=function(){this.container.innerHTML=template;I18n.fillArea($('#co2Name').parent());},ModalCo2SaveTotal.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+' Ton';$('#co2SaveVal').text(show);},ModalCo2SaveTotal.prototype.showConfigMode=function(){var _this=this;};ModalCo2SaveTotal.prototype.setModalOption=function(option){this.entity.modal.interval=5;};var template='<style type="text/css">\
        .frameCtl {position: relative;height: 100%;}\
        .imgBackground {position: absolute;width: 100%;height: 100%;right: 0;bottom: 0;top: 0;left: 0;z-index: -1;}\
        #co2SaveVal {position: absolute;left: 60px;top: 40px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
        #co2Name {position: absolute;left: 60px;top: 80px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
    </style>\
    <div class="frameCtl">\
        <img src="/static/images/spring/entities/modalCo2SaveTotal.png" class="imgBackground" alt="Background image">\
        <div id="co2SaveVal"></div>\
        <div id="co2Name" i18n="dashboard.carbonFootprint.CO2_SAVING"></div>\
    </div>';return ModalCo2SaveTotal;})();var ModalKPIConfig=(function($,window,undefined){var _this;function ModalKPIConfig(options){_this=this;this.options=$.extend({},DEFAULTS,options);this.$wrap=null;}
ModalKPIConfig.prototype.show=function(){var domPanelContent=document.getElementById('paneContent');if($('#modalKPIConfigWrap').length>0){this.$modal.modal('show');return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalKPIConfig.html').done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-kpi-config-wrap" id="modalKPIConfigWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this.init();_this.$modal.modal('show');});};ModalKPIConfig.prototype.init=function(){this.$formWrap=$("#formWrap",this.$wrap);this.$btnClose=$('.close',this.$wrap);this.$btnWarnMode=$('#btnWarnMode',this.$formWrap);this.$ulWarnMode=$('#ulWarnMode',this.$formWrap);this.$btnWarnTimeMode=$('#btnWarnTimeMode',this.$formWrap);this.$ulWarnTimeMode=$('#ulWarnTimeMode',this.$formWrap);this.$btnPreWarnMode=$('#btnPreWarnMode',this.$formWrap);this.$ulPreWarnMode=$('#ulPreWarnMode',this.$formWrap);this.$btnPreWarnTimeMode=$('#btnPreWarnTimeMode',this.$formWrap);this.$ulPreWarnTimeMode=$('#ulPreWarnTimeMode',this.$formWrap);this.$btnDataCycleMode=$('#btnDataCycleMode',this.$formWrap);this.$ulDataCycleMode=$('#ulDataCycleMode',this.$formWrap);this.$btnStartMonth=$('#btnStartMonth',this.$formWrap);this.$ulStartMonth=$('#ulStartMonth',this.$formWrap);this.$btnHistoryValUsage=$('#btnHistoryValUsage',this.$formWrap);this.$btnPreHistoryValUsage=$('#btnPreHistoryValUsage',this.$formWrap);this.$fgWarnRange=$('#fgWarnRange',this.$formWrap);this.$fgWarnTime=$('#fgWarnTime',this.$formWrap);this.$fgWarnTimeRange=$('#fgWarnTimeRange',this.$formWrap);this.$fgPreWarnRange=$('#fgPreWarnRange',this.$formWrap);this.$fgPreWarnTime=$('#fgPreWarnTime',this.$formWrap);this.$fgPreWarnTimeRange=$('#fgPreWarnTimeRange',this.$formWrap);this.$fgiStartMonth=$('#fgiStartMonth',this.$formWrap);this.$iptChartName=$('#iptChartName',this.$formWrap);this.$iptChartLowerLimit=$('#iptChartLowerLimit',this.$formWrap);this.$iptChartUpperLimit=$('#iptChartUpperLimit',this.$formWrap);this.$divTargetPoint=$('#divTargetPoint',this.$formWrap);this.$divReferencePoint=$('#divReferencePoint',this.$formWrap);this.$btnCondition=$('#btnCondition',this.$formWrap);this.$iptConditionVal=$('#iptConditionVal',this.$formWrap);this.$btnIsShowRC=$('#btnIsShowRC',this.$formWrap);this.$iptLowerWarnVal=$('#iptLowerWarnVal',this.$formWrap);this.$iptUpperWarnVal=$('#iptUpperWarnVal',this.$formWrap);this.$iptPreGreaterThan=$('#iptPreGreaterThan',this.$formWrap);this.$iptPreLessThan=$('#iptPreLessThan',this.$formWrap);this.$iptWarnTimeRangeStart=$('#iptWarnTimeRangeStart',this.$formWrap);this.$iptPreWarnTimeRangeStart=$('#iptPreWarnTimeRangeStart',this.$formWrap);this.$dropArea=$('.drop-area',this.$formWrap);this.$btnSubmit=$('#btnSubmit',this.$wrap);this.attachEvents();this.initValidator();$(".datetime").datetimepicker('remove');$(".datetime").datetime({pickerPosition:'top-right'});};ModalKPIConfig.prototype.initValidator=function(){};ModalKPIConfig.prototype.displayField=function(animArr,doAnim){var $animWrap=animArr[0].$ele.parent('.optional');var actionGroup={$show:$(),$hide:$()};var showLen,curShowLen=$animWrap.children('.on').length;var $all;if(doAnim===undefined)doAnim=true;for(var i=0,len=animArr.length;i<len;i++){actionGroup['$'+animArr[i].action]=actionGroup['$'+animArr[i].action].add(animArr[i].$ele);}
showLen=actionGroup.$show.length;if(!doAnim){actionGroup.$hide.removeClass('on').css('display','none');actionGroup.$show.addClass('on').css('display','');$animWrap.height(49*showLen);return;}
$all=actionGroup.$hide.add(actionGroup.$show).filter('.on');$all.filter('.on').eq(0).one('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'){$all.css('display','none');if(showLen!==curShowLen){$animWrap.height(49*showLen);$animWrap.off('transitionend').on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='height'){actionGroup.$show.css('display','');window.setTimeout(function(){actionGroup.$show.addClass('on');},0);}
e.stopPropagation();});}else{actionGroup.$show.css('display','');window.setTimeout(function(){actionGroup.$show.addClass('on');},0);}}
e.stopPropagation();});$all.removeClass('on');};ModalKPIConfig.prototype.reset=function(name){var animArr=[];name=typeof name==='string'?[name]:name;if(!name){this.$iptChartName.val('');this.$iptChartLowerLimit.val('');this.$iptChartUpperLimit.val('');this.$divTargetPoint.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');this.$divReferencePoint.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');this.$btnCondition.attr('data-value',0).children('span').eq(0).text('Equal To (=)');this.$iptConditionVal.val('');this.$btnWarnMode.attr('data-value',0).children('span').eq(0).text('From User Input');this.$btnHistoryValUsage.attr('data-value',0).children('span').eq(0).text('Use As Lower Limit');this.$iptWarnTimeRangeStart.val('');this.$iptLowerWarnVal.val('');this.$iptUpperWarnVal.val('');this.$btnPreWarnMode.attr('data-value',0).children('span').eq(0).text('From User Input');this.$iptPreGreaterThan.val('');this.$iptPreLessThan.val('');animArr=[];animArr.push({$ele:this.$fgWarnRange,action:'show'});animArr.push({$ele:this.$fgWarnTime,action:'hide'});animArr.push({$ele:this.$fgWarnTimeRange,action:'hide'});this.displayField(animArr,false);animArr=[];animArr.push({$ele:this.$fgPreWarnRange,action:'show'});animArr.push({$ele:this.$fgPreWarnTime,action:'hide'});animArr.push({$ele:this.$fgPreWarnTimeRange,action:'hide'});this.displayField(animArr,false);}
if(!name||name.indexOf('warn-time')>-1){this.$btnWarnTimeMode.attr('data-value',0);this.$btnWarnTimeMode.children('span').eq(0).text('From User Input');this.$btnHistoryValUsage.attr('data-value',0);this.$btnHistoryValUsage.children('span').eq(0).text('Use As Lower Limit');}
if(!name||name.indexOf('start-month')>-1){this.$btnStartMonth.attr('data-value','');this.$btnStartMonth.children('span').eq(0).text('Start Month');}
if(!name||name.indexOf('pre-warn-time')>-1){this.$btnPreWarnTimeMode.attr('data-value',0);this.$btnPreWarnTimeMode.children('span').eq(0).text('From User Input');}};ModalKPIConfig.prototype.recoverForm=function(form){var name,animArr=[],animArr2=[];var _this=this;if(!form)return;this.$iptChartName.val(form.chartName);this.$iptChartLowerLimit.val(form.chartLowerLimit);this.$iptChartUpperLimit.val(form.chartUpperLimit);name=AppConfig.datasource.getDSItemById(form.targetPointId).alias;this.$divTargetPoint.attr({'data-value':form.targetPointId,'title':name}).html('<span>'+name+'</span>');name=AppConfig.datasource.getDSItemById(form.referencePointId).alias;if(name){this.$divReferencePoint.attr({'data-value':form.referencePointId,'title':name}).html('<span>'+name+'</span>');}
this.$btnCondition.attr('data-value',form.referenceCondition).children('span').eq(0).text(form.referenceConditionName);this.$iptConditionVal.val(form.referenceConditionVal);this.$btnDataCycleMode.attr('data-value',form.dataCycleMode).children('span').eq(0).text(form.dataCycleModeName);this.$btnWarnMode.attr('data-value',form.warnMode).children('span').eq(0).text(form.warnModeName);this.$btnWarnTimeMode.attr('data-value',form.warnTimeMode).children('span').eq(0).text(form.warnTimeModeName);this.$btnHistoryValUsage.attr('data-value',form.historyValUsage).children('span').eq(0).text(form.historyValUsageName);this.$iptWarnTimeRangeStart.val(form.warnTimeRangeStart);if(form.warnMode===1){animArr.push({$ele:this.$fgWarnRange,action:'hide'});animArr.push({$ele:this.$fgWarnTime,action:'show'});if(form.warnTimeMode===0){animArr.push({$ele:this.$fgWarnTimeRange,action:'show'});}else{animArr.push({$ele:this.$fgWarnTimeRange,action:'hide'});}
window.setTimeout(function(){_this.displayField(animArr);},1200);}
this.$iptLowerWarnVal.val(form.warnLowerLimit);this.$iptUpperWarnVal.val(form.warnUpperLimit);this.$btnPreWarnMode.attr('data-value',form.preWarnMode).children('span').eq(0).text(form.preWarnModeName);this.$iptPreGreaterThan.val(form.preGreaterThan);this.$iptPreLessThan.val(form.preLessThan);this.$btnPreWarnTimeMode.attr('data-value',form.preWarnTimeMode).children('span').eq(0).text(form.preWarnTimeModeName);this.$btnPreHistoryValUsage.attr('data-value',form.preHistoryValUsage).children('span').eq(0).text(form.preHistoryValUsageName);this.$iptPreWarnTimeRangeStart.val(form.preWarnTimeRangeStart);if(form.preWarnMode===1){animArr2.push({$ele:this.$fgPreWarnRange,action:'hide'});animArr2.push({$ele:this.$fgPreWarnTime,action:'show'});if(form.preWarnTimeMode===0){animArr2.push({$ele:this.$fgPreWarnTimeRange,action:'show'});}else{animArr2.push({$ele:this.$fgPreWarnTimeRange,action:'hide'});}
window.setTimeout(function(){_this.displayField(animArr2);},1200);}};ModalKPIConfig.prototype.setOptions=function(options){this.options=$.extend({},this.options,options);};ModalKPIConfig.prototype.attachEvents=function(){$('.dropdown-menu',this.$wrap).off('click.selected').on('click.selected','a',function(e){var $this=$(this);var $btn=$this.parents('.dropdown-wrap').children('button');var value=$this.attr('data-value');var text=$this.text();$btn.attr('data-value',value);$btn.children('span').eq(0).text(text);e.preventDefault();});this.$modal.off('show.bs.modal').on('show.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.recoverForm(_this.options.modalIns.entity.modal.option);if(!$rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.reset();if($rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$ulWarnMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnWarnMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnWarnMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgWarnRange,action:'show'});animArr.push({$ele:_this.$fgWarnTime,action:'hide'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'hide'});}else{_this.reset(['warn-time']);animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'show'});}
_this.displayField(animArr);});this.$ulWarnTimeMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnWarnTimeMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnWarnTimeMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'show'});}else{animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'hide'});}
_this.displayField(animArr);});this.$ulPreWarnMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnPreWarnMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnPreWarnMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgPreWarnRange,action:'show'});animArr.push({$ele:_this.$fgPreWarnTime,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'hide'});}else{_this.reset('pre-warn-time');animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'show'});}
_this.displayField(animArr);});this.$ulPreWarnTimeMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnPreWarnTimeMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnPreWarnTimeMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'show'});}else{animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'hide'});}
_this.displayField(animArr);});this.$ulDataCycleMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnDataCycleMode.attr('data-value'));var lastMonth,lastMonth2,nowMonth,lang,arrHtml=[];var liTmpl='<li><a href="javascript:;" data-value="{0}">{1}</a></li>';if(value===lastValue)return;_this.$btnDataCycleMode.attr('data-value',value);if(value===0)_this.$fgiStartMonth.removeClass('on');else{lang=I18n.type
nowMonth=DateUtil.getNextMonth(new Date().getMonth());lastMonth=DateUtil.getLastMonth(nowMonth);lastMonth2=DateUtil.getLastMonth(lastMonth);arrHtml.push(liTmpl.format(lastMonth2,DateUtil.getMonthNameShort(lastMonth2-1,lang)));arrHtml.push(liTmpl.format(lastMonth,DateUtil.getMonthNameShort(lastMonth-1,lang)));arrHtml.push(liTmpl.format(nowMonth,DateUtil.getMonthNameShort(nowMonth-1,lang)));_this.$ulStartMonth.html(arrHtml.join(''));_this.reset('start-month');_this.$fgiStartMonth.addClass('on');}});this.$dropArea.off('dragover').on('dragover',function(e){e.preventDefault();});this.$dropArea.off('dragenter').on('dragenter',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});this.$dropArea.off('dragleave').on('dragleave',function(e){$(e.target).removeClass('on');e.stopPropagation();});this.$dropArea.off('drop').on('drop',function(e){var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');name=AppConfig.datasource.getDSItemById(itemId).alias;$target.attr({'data-value':itemId,'title':name});$target.html('<span>'+name+'</span>');e.stopPropagation();});this.$btnSubmit.off().click(function(){var form={};form.chartName=_this.$iptChartName.val();form.chartLowerLimit=parseFloat(_this.$iptChartLowerLimit.val());form.chartUpperLimit=parseFloat(_this.$iptChartUpperLimit.val());form.targetPointId=_this.$divTargetPoint.attr('data-value');form.referencePointId=_this.$divReferencePoint.attr('data-value');form.referenceCondition=parseInt(_this.$btnCondition.attr('data-value'));form.referenceConditionName=_this.$btnCondition.children('span').eq(0).text();form.referenceConditionVal=parseFloat(_this.$iptConditionVal.val());form.dataCycleMode=parseInt(_this.$btnDataCycleMode.attr('data-value'));form.dataCycleModeName=_this.$btnDataCycleMode.children('span').eq(0).text();form.btnStartMonth=_this.$btnStartMonth.attr('data-value');form.warnMode=parseInt(_this.$btnWarnMode.attr('data-value'));form.warnModeName=_this.$btnWarnMode.children('span').eq(0).text();form.isShowRC=parseInt(_this.$btnIsShowRC.attr('data-value'));form.isShowRCName=_this.$btnIsShowRC.children('span').eq(0).text();form.warnLowerLimit=parseFloat(_this.$iptLowerWarnVal.val());form.warnUpperLimit=parseFloat(_this.$iptUpperWarnVal.val());form.warnTimeMode=parseInt(_this.$btnWarnTimeMode.attr('data-value'));form.warnTimeModeName=_this.$btnWarnTimeMode.children('span').eq(0).text();form.historyValUsage=parseInt(_this.$btnHistoryValUsage.attr('data-value'));form.historyValUsageName=_this.$btnHistoryValUsage.children('span').eq(0).text();form.warnTimeRangeStart=_this.$iptWarnTimeRangeStart.val();form.preWarnMode=parseInt(_this.$btnPreWarnMode.attr('data-value'));form.preWarnModeName=_this.$btnPreWarnMode.children('span').eq(0).text();form.preGreaterThan=parseFloat(_this.$iptPreGreaterThan.val());form.preLessThan=parseFloat(_this.$iptPreLessThan.val());form.preWarnTimeMode=parseInt(_this.$btnPreWarnTimeMode.attr('data-value'));form.preWarnTimeModeName=_this.$btnPreWarnTimeMode.children('span').eq(0).text();form.preHistoryValUsage=parseInt(_this.$btnPreHistoryValUsage.attr('data-value'));form.preHistoryValUsageName=_this.$btnPreHistoryValUsage.children('span').eq(0).text();form.preWarnTimeRangeStart=_this.$iptPreWarnTimeRangeStart.val();_this.options.onSubmit.call(_this.options.modalIns,form);_this.$btnClose.trigger('click');});};ModalKPIConfig.prototype.detachEvents=function(){};ModalKPIConfig.prototype.destroy=function(){this.detachEvents();this.$wrap.remove();};var DEFAULTS={};return ModalKPIConfig;}(jQuery,window));var ModalKPIChart=(function($){var PRECISION=2;function ModalKPIChart(screen,entityParams){ModalBase.call(this,screen,entityParams,this._render,null,this._showConfig);this.options=$.extend(true,{},DEFAULTS);this.historyChartOptions=$.extend(true,{},HISTORY_CHART_DEFAULTS);this.startline=null;this.endline=null;this.targetPointData=null;this.referencePointData=null;this.refreshTimesInOneHour=1;this.period=null;this.indicators={};this.samplingPeriod={format:'h1',value2ms:3600000};this.historyChart=null;this.$lkUpdateTime=null;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;}
ModalKPIChart.prototype=Object.create(ModalBase.prototype);ModalKPIChart.prototype.constructor=ModalKPIChart;ModalKPIChart.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_KPI_CHART',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalKPIChart'};ModalKPIChart.prototype.init=function(){var $panel=$(this.container).closest('.panel');this.$lkUpdateTime=$('<div class="lk-update-time" title="Last Update Time"><span class="glyphicon glyphicon-time"></span><span>updating...</span></div>').appendTo($panel);};ModalKPIChart.prototype._render=function(){var _this=this;var option=this.entity.modal.option;var min=option.chartLowerLimit||0;var max=option.chartUpperLimit||100;var warnMode=option.warnMode;var warnLower=option.warnLowerLimit;var warnUpper=option.warnUpperLimit;var preWarnMode=option.preWarnMode;var preWarnLower=warnLower+option.preGreaterThan;var preWarnUpper=warnUpper-option.preLessThan;var historyValUsage=option.historyValUsage;var targetPointId=option.targetPointId;var referencePointId=option.referencePointId;var dataCycleMode=option.dataCycleMode;var period=this.period=this.getTimePeriod();var postData;var ids=referencePointId?[targetPointId,referencePointId]:[targetPointId];postData=[{dsItemIds:ids,timeStart:period.nowStart,timeEnd:period.nowEnd,timeFormat:this.samplingPeriod.format}];if(warnMode===1){postData.push({dsItemIds:ids,timeStart:period.refStart,timeEnd:period.refEnd,timeFormat:this.samplingPeriod.format});}
this.init();this.options.series[0].data[0].value=min;this.options.series[0].min=min;this.options.series[0].max=max;this.historyChartOptions.yAxis[0].min=min;this.historyChartOptions.yAxis[0].max=max;this.options.tooltip.formatter=function(p){return p.seriesName+': <strong>'+p.value+'</strong><br/>From: '+
_this.store.timeShaft[0]+'<br/>To: '+_this.store.timeShaft[_this.store.timeShaft.length-1];};this.spinner.spin(this.container);WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(rs){var axisColor=_this.options.series[0].axisLine.lineStyle.color;var range=max-min;var maxIndex;_this.store={list:{},timeShaft:rs[0].timeShaft};for(var i=0,len=rs[0].list.length;i<len;i++){_this.store.list[rs[0].list[i].dsItemId]=rs[0].list[i].data;}
if(rs[1]!==undefined){_this.store2={list:{},timeShaft:rs[1].timeShaft};for(i=0,len=rs[1].list.length;i<len;i++){_this.store2.list[rs[1].list[i].dsItemId]=rs[1].list[i].data;}}
_this.filterPointData();_this.initIndicators();_this.setTimeParams();maxIndex=_this.store.fullTimeShaft.length-1;if(warnMode===0){if(warnLower!==undefined&&(warnLower-min)>0){axisColor.push([(warnLower-min)/range,'#ff4500']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Warn Line',value:warnLower,xAxis:0,yAxis:warnLower,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:warnLower}]);}
if(preWarnLower!==undefined&&(preWarnLower-min)>0){axisColor.push([(preWarnLower-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:preWarnLower,xAxis:0,yAxis:preWarnLower,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnLower}]);}
if(preWarnUpper!==undefined&&(preWarnUpper-min)>0){axisColor.push([(preWarnUpper-min)/range,'lightgreen']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:preWarnUpper,xAxis:0,yAxis:preWarnUpper,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:maxIndex,yAxis:preWarnUpper}]);}
if(warnUpper!==undefined&&(warnUpper-min)>0){axisColor.push([(warnUpper-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Warn Line',value:warnUpper,xAxis:0,yAxis:warnUpper,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:maxIndex,yAxis:warnUpper}]);}
axisColor.push([1,'#ff4500']);}
else{if(historyValUsage===0){axisColor.push([(_this.indicators.average2-min)/range,'#ff4500']);if(preWarnMode===0){preWarnLower=_this.indicators.average2+option.preGreaterThan;if(preWarnLower!==undefined&&(preWarnLower-min)>0){axisColor.push([(preWarnLower-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:preWarnLower.toFixed(PRECISION),xAxis:0,yAxis:preWarnLower,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnLower}]);}}else if(preWarnMode===1&&_this.indicators.preWarnValue>_this.indicators.average2){axisColor.push([(_this.indicators.preWarnValue-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:_this.indicators.preWarnValue.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.preWarnValue,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.preWarnValue}]);}
axisColor.push([1,'lightgreen']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Warn Line',value:_this.indicators.average2.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.average2,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.average2}]);}
else{if(preWarnMode===0){preWarnUpper=_this.indicators.average2-option.preLessThan;if(preWarnUpper!==undefined&&(preWarnUpper-min)>0){axisColor.push([(preWarnUpper-min)/range,'lightgreen']);axisColor.push([(_this.indicators.average2-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:preWarnUpper.toFixed(PRECISION),xAxis:0,yAxis:preWarnUpper,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnUpper}]);}}else if(preWarnMode===1&&_this.indicators.preWarnValue<_this.indicators.average2){axisColor.push([(_this.indicators.preWarnValue-min)/range,'lightgreen']);axisColor.push([(_this.indicators.average2-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:_this.indicators.preWarnValue.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.preWarnValue,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.preWarnValue}]);}else{axisColor.push([(_this.indicators.average2-min)/range,'lightgreen']);}
axisColor.push([1,'#ff4500']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Warn Line',value:_this.indicators.average2.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.average2,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.average2}]);}}
_this.fitContainer();_this.chart=echarts.init(_this.container,AppConfig.chartTheme);_this.chart.clear();_this.chart.setOption(_this.options);_this.reloadChart();}).always(function(){_this.spinner.stop();});};ModalKPIChart.prototype.filterPointData=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var cond=option.referenceCondition;var condVal=option.referenceConditionVal;var tPoints=null,rPoints=null;if(!option.referencePointId)return;tPoints=this.store.list[option.targetPointId];rPoints=this.store.list[option.referencePointId];if(tPoints.length!==rPoints.length)return;for(var i=0,len=rPoints.length;i<len;i++){tPoints[i]=parseFloat(tPoints[i]);rPoints[i]=parseFloat(rPoints[i]);if(!this.isPointRuled(rPoints[i],condVal,cond)){tPoints[i]='-';}}
if(warnMode===1){tPoints=this.store2.list[option.targetPointId];rPoints=this.store2.list[option.referencePointId];if(tPoints.length!==rPoints.length)return;for(var i=0,len=rPoints.length;i<len;i++){tPoints[i]=parseFloat(tPoints[i]);rPoints[i]=parseFloat(rPoints[i]);if(!this.isPointRuled(rPoints[i],condVal,cond)){tPoints[i]='-';}}}};ModalKPIChart.prototype.isPointRuled=function(pointVal,condVal,cond){if(condVal===null)return true;switch(cond){case 0:return pointVal===condVal;case 1:return pointVal<condVal;case 2:return pointVal>condVal;default:return true;}};ModalKPIChart.prototype.setAnimation=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var historyValUsage=option.historyValUsage;var warnLower=option.warnLowerLimit;var warnUpper=option.warnUpperLimit;var preWarnLower=warnLower+option.preGreaterThan;var preWarnUpper=warnUpper-option.preLessThan;var $parent=$(this.container).parents('.panel');var curVal=this.indicators.average;$parent.removeClass('warn-anim pre-warn-anim');if(warnMode===1){if((historyValUsage===0&&curVal<this.indicators.average2)||(historyValUsage===1&&curVal>this.indicators.average2)){$parent.addClass('warn-anim');}}else{switch(true){case curVal<preWarnLower:$parent.addClass('pre-warn-anim');break;case curVal<warnLower:$parent.addClass('warn-anim');break;case curVal<preWarnUpper:break;case curVal<warnUpper:$parent.addClass('pre-warn-anim');break;default:$parent.addClass('warn-anim');break;}}};ModalKPIChart.prototype.update=function(rs){var option=this.entity.modal.option;var targetPointId=option.targetPointId;var referencePointId=option.referencePointId;var targetPointData,referencePointData;var lastTick,nowTick;if(!this.store)return;lastTick=this.store.timeShaft[this.store.timeShaft.length-1];lastTick=lastTick.toDate().valueOf()+60000;nowTick=new Date().valueOf();if(nowTick<lastTick){return;}
for(var i=0,len=rs.length;i<len;i++){if(targetPointId===rs[i].dsItemId){targetPointData=parseFloat(rs[i].data);}
if(referencePointId===rs[i].dsItemId){referencePointData=parseFloat(rs[i].data);}}
if(isNaN(targetPointData))return;this.appendData(targetPointData,referencePointData);this.reloadChart();};ModalKPIChart.prototype.reloadChart=function(){this.options.series[0].data[0].value=this.indicators.average.toFixed(PRECISION);var opt=this.chart.getOption();opt.series=this.options.series;this.chart.setOption(opt);this.setAnimation();this.$lkUpdateTime.children('span').eq(1).text(new Date().format('HH:mm'));};ModalKPIChart.prototype._showConfig=function(){};ModalKPIChart.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalKPIChart.prototype.setOptions=function(options){this.options=$.extend({},this.opitons,options);};ModalKPIChart.prototype.destroy=function(){};ModalKPIChart.prototype.saveConfig=function(form){this.entity.modal.title=form.chartName;this.entity.modal.points=[form.targetPointId];if(form.referencePointId)this.entity.modal.points.push(form.referencePointId);this.entity.modal.option=form;this.entity.modal.interval=60000;};ModalKPIChart.prototype.configModal=new ModalKPIConfig({onSubmit:function(form){this.saveConfig(form);}});ModalKPIChart.prototype.getTimePeriod=function(){var now;var period={};var option=this.entity.modal.option;var warnMode=option.warnMode;var historyValUsage=option.historyValUsage;var warnStart=option.warnTimeRangeStart;var warnTimeMode=option.warnTimeMode;var startDate=option.warnTimeRangeStart;var circleMode=option.dataCycleMode;var startMonth;if(!this.m_bIsGoBackTrace){now=new Date();this.DEFAULTS=true;this.HISTORY_CHART_DEFAULTS=true;}
else{now=this.m_traceData.currentTime;this.DEFAULTS=false;this.HISTORY_CHART_DEFAULTS=false;}
if(circleMode===0){period.nowStart=now.format('yyyy-MM-01 00:00:00');period.nowEnd=now.format('yyyy-MM-dd HH:mm:ss');if(warnMode===0)return period;if(warnTimeMode===0){period.refStart=warnStart.toDate().format('yyyy-MM');period.refEnd=period.refStart+'-'+DateUtil.daysInMonth(period.refStart.toDate())+' 23:59:59';period.refStart+='-01 00:00:00';}else{period.refStart=(now.format('yyyy')-1)+now.format('-MM');period.refEnd=period.refStart+'-'+DateUtil.daysInMonth(period.refStart.toDate())+' 23:59:59';period.refStart+='-01 00:00:00';}
period.lag=period.nowStart.toDate().valueOf()-period.refStart.toDate().valueOf();}
else{}
return period;};ModalKPIChart.prototype.initIndicators=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var preWarnMode=option.preWarnMode;var dsId=option.targetPointId;var data=this.store.list[dsId];var average=0,sum=0;var list1,list2;for(var i=0,len=data.length;i<len;i++){if(isNaN(data[i]))continue;average+=data[i]*1;};if(isNaN(average))this.indicators.average=this.entity.modal.option.chartLowerLimit;else this.indicators.average=average/len;if(warnMode===1){average=0;data=this.store2.list[dsId];for(var i=0,len=data.length;i<len;i++){if(isNaN(parseFloat(data[i])))continue;average+=data[i]*1;};if(isNaN(average))this.indicators.average2=this.entity.modal.option.chartLowerLimit;else this.indicators.average2=average/len;}
if(preWarnMode===1){this.setPreWarnValue();}};ModalKPIChart.prototype.setPreWarnValue=function(){var option=this.entity.modal.option;var targetPointId=option.targetPointId;var warnMode=option.warnMode;var preHistoryValUsage=option.preHistoryValUsage;var list1=this.store.list[targetPointId];var list2=this.store2.list[targetPointId];var average=0;var sum=0;var validNum=0;for(var i=0,len1=list1.length,len2=list2.length;i<len2;i++){if(i>=len1){if(isNaN(list2[i]))continue;sum+=list2[i];}else{if(isNaN(list1[i]))continue;sum+=list1[i];}
validNum+=1;}
if(warnMode===1){this.indicators.preWarnValue=this.indicators.average+this.indicators.average2-sum/validNum;}else{if(preHistoryValUsage===0){this.indicators.preWarnValue=this.indicators.average+option.warnLowerLimit-sum/validNum;}else{this.indicators.preWarnValue=this.indicators.average+option.warnUpperLimit-sum/validNum;}}};ModalKPIChart.prototype.appendData=function(tValue,rValue){var lastTick=this.store.timeShaft[this.store.timeShaft.length-1];var option=this.entity.modal.option;var preWarnMode=option.preWarnMode;var targetPointId=option.targetPointId;var targetPointList=this.store.list[targetPointId];var cond=option.referenceCondition;var condVal=option.referenceConditionVal;var len=this.store.list[targetPointId].length;var nowStr=new Date().format('yyyy-MM-dd HH:00:00')
var lastValue,newLastValue;var timeStamp;if(isNaN(rValue)||this.isPointRuled(rValue,condVal,cond)){tValue=tValue.toFixed(3)*1;if(lastTick!==nowStr){timeStamp=lastTick.toDate().valueOf();if((nowStr.toDate().valueOf()-timeStamp)>3600000){this.store.timeShaft.push(new Date(timeStamp+3600000).format('yyyy-MM-dd HH:00:00'));}
this.store.timeShaft.push(nowStr);this.refreshTimesInOneHour=0;this.indicators.average=(this.indicators.average*len+tValue)/(len+1);targetPointList.push(tValue);}else{lastValue=targetPointList[targetPointList.length-1]
newLastValue=(lastValue*this.refreshTimesInOneHour+tValue)/(this.refreshTimesInOneHour+1);targetPointList[targetPointList.length-1]=newLastValue.toFixed(3)*1;this.indicators.average=(this.indicators.average*len-lastValue+newLastValue)/len;this.refreshTimesInOneHour+=1;}
if(preWarnMode===1){this.setPreWarnValue();}}};ModalKPIChart.prototype.setTimeParams=function(){if(this.store.timeShaft.length==0)return;var lastTick=this.store.timeShaft[this.store.timeShaft.length-1].toDate().valueOf();var option=this.entity.modal.option;var tick=lastTick+this.samplingPeriod.value2ms;var now=new Date();this.store.fullTimeShaft=this.store.timeShaft.concat();if(option.dataCycleMode===0){this.store.deadline=now.format('yyyy-MM-'+DateUtil.daysInMonth(now)+' 23:55:00').toDate();while(tick<=this.store.deadline){tick+=this.samplingPeriod.value2ms;this.store.fullTimeShaft.push(tick.toDate().format('yyyy-MM-dd HH:mm:ss'));}}
else{}};ModalKPIChart.prototype.fitContainer=function(){var row=this.entity.spanR;var column=this.entity.spanC;if(Math.min(row,column)<3){this.options.series[0].splitLine.length=15;this.options.series[0].axisLine.lineStyle.width=6;this.options.series[0].axisTick.length=12;this.options.series[0].pointer.width=4;this.options.series[0].detail.textStyle.fontSize=16;}};ModalKPIChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this._render();this.m_bIsGoBackTrace=false;};var DEFAULTS={tooltip:{},visualMap:{show:false},series:[{name:'KPI Indicator',type:'gauge',precision:2,splitNumber:10,axisTick:{show:true,splitNumber:5,length:20,lineStyle:{color:'auto',width:1,type:'solid'}},axisLine:{show:true,lineStyle:{color:[],width:1}},axisLabel:{textStyle:{color:'#a2adbc'}},splitLine:{show:true,length:30,lineStyle:{color:'auto',width:2,type:'solid'}},pointer:{length:'80%',width:4},detail:{offsetCenter:['0','-30%'],textStyle:{color:'#ccc',fontSize:20}},data:[{name:''}]}],animation:true};var HISTORY_CHART_DEFAULTS={title:{text:'History Data'},legend:{data:['Target Point']},tooltip:{trigger:'axis'},dataZoom:{show:false,realtime:true,start:0,end:100},grid:{y2:80},xAxis:[{type:'category'}],yAxis:[{type:'value'}],series:[{name:'Target Point',type:'line',symbolSize:0,markLine:{precision:3,symbol:'none',data:[]},markPoint:{symbol:'emptyCircle',effect:{show:true,shadowBlur:0},data:[]}}],animation:true};return ModalKPIChart;}(jQuery));var ModalObserverConfig=(function($,window,undefined){var _this;function ModalObserverConfig(options){_this=this;this.options=$.extend({},DEFAULTS,options);this.$wrap=null;}
ModalObserverConfig.prototype.show=function(){var domPanelContent=document.getElementById('paneContent');if($('#modalObserverConfigWrap').length>0){this.$modal.modal('show');return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalObserverConfig.html').done(function(html){_this.$wrap=$('<div class="modal-observer-config-wrap" id="modalObserverConfigWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');WebAPI.get("/get_s3db_pages/"+AppConfig.projectId+"/"+AppConfig.userId).done(function(result){_this.init(result.pages);_this.$modal.modal('show');}).always(function(msg){Spinner.stop();});});};ModalObserverConfig.prototype.init=function(data){this.$formWrap=$('#obFormWrap','#modalObserverConfigWrap');this.$btnClose=$('.close','#modalObserverConfigWrap');this.$sltObserverId=$('#sltObserverId','#obFormWrap');this.$btnSubmit=$('#btnObSubmit','#modalObserverConfigWrap');var sb=new StringBuilder();for(var i=0,item,len=data.length;i<len;i++){item=data[i];sb.append('<option value="').append(item.id).append('">').append(item.name+' (width: '+item.width+', height: '+item.height+')</option>');}
this.$sltObserverId.html(sb.toString());this.attachEvents();};ModalObserverConfig.prototype.attachEvents=function(){this.$btnSubmit.off().click(function(e){var form={};form.id=_this.$sltObserverId.val().trim();_this.options.onSubmit.call(_this.options.modalIns,form);_this.$btnClose.trigger('click');e.preventDefault();});};ModalObserverConfig.prototype.setOptions=function(options){this.options=$.extend({},this.options,options);};var DEFAULTS={};return ModalObserverConfig;}(jQuery,window));var ModalObserver=(function ModalObserver($,window,undefined){function ModalObserver(screen,entityParams){ModalBase.call(this,screen,entityParams,this._render,null,this._showConfig);this.options=$.extend(true,{},DEFAULTS);this.obScreen=null;};ModalObserver.prototype=Object.create(ModalBase.prototype);ModalObserver.prototype.constructor=ModalObserver;ModalObserver.prototype.optionTemplate={name:'toolBox.modal.OBSERVER',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalObserver'};ModalObserver.prototype._render=function(){var options=this.entity.modal.option;var id=options.id||'200000360';this.obScreen=new ObserverScreen(id);this.container=$(this.container).html('<div class="divMain" style="width: 100%; height: 100%;">\
                <div class="div-canvas-ctn" style="padding: 0; margin: 0 auto; height: 100%; width: 100%;">\
                    <canvas class="canvas-ctn" style="width: 100%; height: 100%;">浏览器不支持</canvas>\
                </div>\
                <div id="divObserverTools" style="height: 0"></div>\
            </div>')[0];this.obScreen.isInDashBoard=true;this.obScreen.show(this.container);};ModalObserver.prototype._showConfig=function(){};ModalObserver.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalObserver.prototype.saveConfig=function(form){this.entity.modal.option=form;this.entity.modal.points=[];};ModalObserver.prototype.configModal=new ModalObserverConfig({onSubmit:function(form){this.saveConfig(form);}});ModalObserver.prototype._close=function(){if(this.obScreen)this.obScreen.close();};var DEFAULTS={};return ModalObserver;}(jQuery,window));var ModalMultiple=(function(){function ModalMultiple(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalMultiple.prototype=new ModalRealtimeLine();ModalMultiple.prototype.optionTemplate={name:'toolBox.modal.MULTIPLE',parent:0,mode:['multiple'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMultiple',modelParams:{paraName:['line','bar','area','cumulativeBar'],paraShowName:{'line':'Line Chart Parameters','bar':"Bar Chart Parameters",'area':"Area Chart Parameters",'cumulativeBar':"Cumulative Bar Chart Parameters"},paraAnlysMode:'part'}};ModalMultiple.prototype.renderModal=function(){};ModalMultiple.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime).format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
var startTime=endTime.split(' ')[0]+' 00:00:00';this.lastRenderTime=now;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var entityItem=_this.dealWithData(dataSrc,2);var option={legend:{data:entityItem.arrLegend},grid:(function(){if(AppConfig.isMobile){return{x2:40}}else{return{x2:50}}}()),xAxis:[{data:['00:00','01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00'],boundaryGap:true}],yAxis:[{type:'value',scale:false,splitArea:{show:false}},{type:'value',scale:false,splitArea:{show:false},splitLine:{show:(function(){if(AppConfig.isMobile){return false;}else{return true;}}())}}],series:entityItem.arrSeries};if(_this.entity.modal.dsChartCog){var ptIndex=0;if(_this.entity.modal.dsChartCog[0].upper!=''){option.yAxis[1].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){option.yAxis[1].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){option.yAxis[1].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<_this.entity.modal.option.paraType[0].arrId.length;i++){for(var j=0;j<option.series[ptIndex].data.length;j++){option.series[ptIndex].data[j]=Number(option.series[ptIndex].data[j]).toFixed(n);}
ptIndex+=1;}}
var tempChartMax,tempChartMin;for(var m=1;m<4;++m){tempChartMax=null;tempChartMin=null;if(_this.entity.modal.dsChartCog[m].upper!=''){if(tempChartMax==null||tempChartMax<Number(_this.entity.modal.dsChartCog[m].upper)){tempChartMax=Number(_this.entity.modal.dsChartCog[m].upper);}}
if(_this.entity.modal.dsChartCog[m].lower!=''){if(tempChartMin==null||tempChartMin>Number(_this.entity.modal.dsChartCog[m].lower)){tempChartMin=Number(_this.entity.modal.dsChartCog[m].lower);}}
if(_this.entity.modal.dsChartCog[m].unit!=''){option.yAxis[0].name=_this.entity.modal.dsChartCog[m].unit;}
if(_this.entity.modal.dsChartCog[m].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[m].accuracy);for(var i=0;i<_this.entity.modal.option.paraType[m].arrId.length;i++){for(var j=0;j<option.series[ptIndex].data.length;j++){option.series[ptIndex].data[j]=Number(option.series[ptIndex].data[j]).toFixed(n);}
ptIndex+=1;}}}
if(tempChartMax!=null){option.yAxis[0].max=Number(tempChartMax);}
if(tempChartMin!=null){option.yAxis[0].min=Number(tempChartMin);}
var tempMarkLine;var seriesNum=0;for(var l=0;l<4;l++){for(var index=0;index<_this.entity.modal.option.paraType[l].arrId.length;++index){for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[l].markLine[k].value){if(!option.series[seriesNum].markLine){option.series[seriesNum].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[l].markLine[k].name,value:_this.entity.modal.dsChartCog[l].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[l].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[l].markLine[k].value)}];option.series[seriesNum].markLine.data.push(tempMarkLine);}}
seriesNum++;}}}
!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,option));}).error(function(e){}).always(function(e){});}};ModalMultiple.prototype.dealWithData=function(points){if(points.error){this.container.innerHTML='<div id="dataAlert" ></div>';new Alert($("#dataAlert"),"danger","<strong>"+points.error+"</strong>").show();return;}
var arr={arrLegend:{},arrSeries:{}};arr.arrLegend=[];arr.arrSeries=[];var arrTempPoints=[];var dataType=this.entity.modal.option.paraType;for(var i=0;i<dataType.length;++i){for(var j=0;j<dataType[i].arrId.length;++j)
arrTempPoints.push({dsItemId:dataType[i].arrId[j]})}
var arrPointAlias=this.initPointAlias(arrTempPoints);var tempNum=0;for(var i=0;i<dataType.length;i++){switch(dataType[i].type){case'bar':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'bar',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'line':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'line',symbol:'none',smooth:true,data:points.list[k].data,yAxisIndex:1,z:3}
arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'area':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'line',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0,z:3};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'cumulativeBar':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'bar',stack:'实时累计图',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;}}
return arr;}
ModalMultiple.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.interval=5;this.entity.modal.option.paraType=option.paraType};ModalMultiple.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalMultiple;})();var ModalPredictPointLineConfig=(function($,window,undefined){var _this;function ModalPredictPointLineConfig(options){_this=this;ModalConfig.call(this,options);}
ModalPredictPointLineConfig.prototype=Object.create(ModalConfig.prototype);ModalPredictPointLineConfig.prototype.constructor=ModalPredictPointLineConfig;ModalPredictPointLineConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalPredictPointLineConfig.html'};ModalPredictPointLineConfig.prototype.init=function(){this.$formWrap=$('.form-wrap',this.$wrap);this.$iptChartYaxisMin=$('.ipt-chart-y-axis-min',this.$formWrap);this.$iptChartYaxisMax=$('.ipt-chart-y-axis-max',this.$formWrap);this.$iptChartValUnits=$('.ipt-chart-val-units',this.$formWrap);this.$iptChartValPrecision=$('.ipt-chart-val-precision',this.$formWrap);this.$btnOptionMode=$('.btn-option-mode',this.$formWrap);this.$btnTimeMode=$('.btn-time-mode',this.$formWrap);this.$btnPredictMode=$('.btn-predict-mode',this.$formWrap);this.$divTargetPoint=$('.div-target-point',this.$formWrap);this.$divPredictPoint=$('.div-predict-point',this.$formWrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$dropArea=$('.drop-area',this.$formWrap);this.attachEvents();};ModalPredictPointLineConfig.prototype.recoverForm=function(modal){var name,form,dsChartConfig;if(!modal)return;form=modal.option;dsChartConfig=(modal.dsChartCog&&modal.dsChartCog.length)?modal.dsChartCog[0]:{};if(!form)return;this._setField('input',this.$iptChartYaxisMin,dsChartConfig.lower);this._setField('input',this.$iptChartYaxisMax,dsChartConfig.upper);this._setField('input',this.$iptChartValUnits,dsChartConfig.unit);this._setField('input',this.$iptChartValPrecision,dsChartConfig.accuracy);this._setField('droparea',this.$divTargetPoint,form.targetPointId);this._setField('droparea',this.$divPredictPoint,form.predictPointId);this._setField('dropdown',this.$btnOptionMode,form.optionsMode);this._setField('dropdown',this.$btnTimeMode,form.timeMode);this._setField('dropdown',this.$btnPredictMode,form.predictMode);};ModalPredictPointLineConfig.prototype.reset=function(){this._setField('input',this.$iptChartYaxisMin);this._setField('input',this.$iptChartYaxisMax);this._setField('input',this.$iptChartValUnits);this._setField('input',this.$iptChartValPrecision);this._setField('droparea',this.$divTargetPoint);this._setField('droparea',this.$divPredictPoint);this._setField('dropdown',this.$btnOptionMode);this._setField('dropdown',this.$btnTimeMode);this._setField('dropdown',this.$btnPredictMode);};ModalPredictPointLineConfig.prototype.attachEvents=function(){this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var dsChartConfig={},form={};var val;val=parseFloat(_this.$iptChartYaxisMin.val());dsChartConfig.lower=!isNaN(val)?val:'';val=parseFloat(_this.$iptChartYaxisMax.val());dsChartConfig.upper=!isNaN(val)?val:'';val=parseInt(_this.$iptChartValPrecision.val());dsChartConfig.accuracy=!isNaN(val)?val:'';dsChartConfig.unit=_this.$iptChartValUnits.val();form.optionMode=parseInt(_this.$btnOptionMode.attr('data-value'));form.timeMode=parseInt(_this.$btnTimeMode.attr('data-value'));form.predictMode=parseInt(_this.$btnPredictMode.attr('data-value'));form.targetPointId=_this.$divTargetPoint.attr('data-value');form.predictPointId=_this.$divPredictPoint.attr('data-value');modal.dsChartCog=[dsChartConfig];modal.option=form;modal.points=form.predictMode===0?[form.targetPointId,form.predictPointId]:[form.targetPointId];modal.interval=60000;_this.$modal.modal('hide');e.preventDefault();});};return ModalPredictPointLineConfig;}(jQuery,window));var ModalPredictPointLine=(function($,window,undefined){function ModalPredictPointLine(screen,entityParams,_renderModal,_updateModal,_showConfigMode){var _this=this;if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.chart=null;this.chartOptions=$.extend(true,{},this.optionDefault,DEFAULTS_CHARTS_OPTIONS);this.period=null;this.firstload=$.Deferred();this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalPredictPointLine.prototype=Object.create(ModalRealtimeLine.prototype);ModalPredictPointLine.prototype.constructor=ModalPredictPointLine;ModalPredictPointLine.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_PREDICT_POINT_LINE',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalPredictPointLine'};ModalPredictPointLine.prototype.renderModal=function(){var _this=this;var modal=this.entity.modal;var dsChartOption=(modal.dsChartCog&&modal.dsChartCog.length)?modal.dsChartCog[0]:{};var option=modal.option;var chartYaxisMin=dsChartOption.lower;var chartYaxisMax=dsChartOption.upper;var chartValUnits=dsChartOption.unit;var chartValPrecision=dsChartOption.accuracy;var timeMode=option.timeMode;var targetPointId=this.entity.modal.points[0];var predictPointId=option.predictPointId;var predictMode=option.predictMode;var period=this.period=this.getPeriod(timeMode);var params=[];var dsName=[];if(predictMode===undefined)predictMode=option.predictMode=0;params.push({dsItemIds:[targetPointId],timeStart:period.startTime,timeEnd:period.endTime,timeFormat:period.tmFmt});dsName=AppConfig.datasource.getDSItemById(targetPointId).alias||targetPointId;this.chartOptions.legend.data=[dsName];this.chartOptions.series[0].name=dsName;if(predictMode===1&&period.endTime<period.rangeEndTime){params.push({dsItemIds:[predictPointId],timeStart:period.endTime,timeEnd:period.rangeEndTime,timeFormat:period.tmFmt});this.chartOptions.legend.data.push('Predict Line');}
if(chartYaxisMin!=='')this.chartOptions.yAxis[0].min=chartYaxisMin;if(chartYaxisMax!=='')this.chartOptions.yAxis[0].max=chartYaxisMax;this.chartOptions.yAxis[0].name=chartValUnits;if(chartValPrecision==='')chartValPrecision=2;WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',params).done(function(rsList){var predictData;var i,t,leni,lent;for(i=0,leni=rsList.length;i<leni;i++){rsList[i].list[0].data=rsList[i].list[0].data.map(function(row,i){return row.toFixed(chartValPrecision);});}
_this.chartOptions.xAxis[0].data=_this.period.timeShaft;predictData=rsList[0].list[0].data;predictData[0]=rsList[0].list[0].data[rsList[0].list[0].data.length-1];predictData=predictData.concat(new Array(_this.period.timeShaft.length-predictData.length+1).join('-').split(''));_this.chartOptions.series[0].data=predictData;if(_this.chart){_this.chart.clear();_this.chart=null;}
_this.chart=echarts.init(_this.container,AppConfig.chartTheme);if(predictMode===1&&rsList[1]){_this.chartOptions.legend.data.push()
predictData=rsList[1].list[0].data;predictData[0]=rsList[0].list[0].data[rsList[0].list[0].data.length-1];predictData=new Array(_this.period.timeShaft.length-predictData.length+1).join('-').split('').concat(predictData);_this.chartOptions.series.push({type:'line',name:'Predict Line',symbol:'none',itemStyle:{normal:{lineStyle:{type:'dotted'},color:'#6495ed',label:{position:'right'}}},data:predictData});_this.chart.clear();_this.chart.setOption(_this.chartOptions);return;}
_this.firstload.done(function(points){_this.updateModal(points,true);});});};ModalPredictPointLine.prototype.updateModal=function(points,force){if(this.firstload.state()==='pending')return this.firstload.resolve(points);if(!points||points.length===0)return;var _this=this;var data=this.chartOptions.series[0].data,predictData;var timeShaft=this.chartOptions.xAxis[0].data;var modal=this.entity.modal;var predictMode=modal.option.predictMode;var pointVal,predictPointVal;var pointId=modal.points[0],predictPointId=modal.points[1];var timeInterval=this.period.tmInterval;var dataLen=data.indexOf('-')-1,timeLen=timeShaft.length;var lastTickVal=timeShaft[dataLen].toDate().valueOf();var nowTick=new Date().valueOf();var row,i,len;force=force===undefined?false:force;if((nowTick-lastTickVal)<this.period.tmInterval&&!force)return;for(i=0,len=points.length;i<len;i++){row=points[i];if(row.dsItemId===pointId){pointVal=parseFloat(row.data);}
if(row.dsItemId===predictPointId){predictPointVal=parseFloat(row.data);}}
if(pointVal!==undefined&&!force){pointVal=Math.round(pointVal*1000)/1000
data.push(pointVal);}
if(predictMode===1){if(!this.chartOptions.series[1])return;predictData=this.chartOptions.series[1].data;if(predictData[predictData.length-1]==='-'){this.chartOptions.series.pop();}
else{predictData.splice(predictData.lastIndexOf('-')+1,1,'-');}
if(predictData[predictData.length-1]!=='-'){predictData.splice(predictData.lastIndexOf('-')+1,1,pointVal);}}
else if(predictPointVal!==undefined){dataLen=data.indexOf('-')-1;if(dataLen===timeLen){timeShaft.push(new Date(lastTickVal+timeInterval).format('yyyy-MM-dd HH:00:00'));}
this.chartOptions.series[0].markPoint.data=[{name:'Predict Value',value:predictPointVal,xAxis:dataLen+1,yAxis:predictPointVal}];lastVal=data[data.indexOf('-')-1];var seriesRepeat=$.extend(true,{},this.chartOptions.series[0]);var seriesOne=this.chartOptions.series[0];seriesRepeat.data[dataLen+1]=predictPointVal;for(var i=0;i<=dataLen;i++){seriesRepeat.data[i]='-';}
seriesRepeat['lineStyle']={normal:{color:'#81a9f0',type:'dotted'}};seriesRepeat.type='effectScatter';seriesRepeat.markLine.data=[[{xAxis:dataLen,yAxis:lastVal},{xAxis:dataLen+1,yAxis:predictPointVal}]];seriesRepeat.markLine.label.normal.show=false;seriesRepeat.showEffectOn='render';seriesRepeat.rippleEffect={brushType:'stroke'};seriesRepeat.itemStyle={normal:{color:'#6898ed',shadowBlur:10,shadowColor:'#333'}};seriesRepeat.symbol='circle'
seriesRepeat.symbolSize=10;seriesOne['lineStyle']={normal:{color:'#e84c3d'}};this.chartOptions.series.push(seriesRepeat);}
this.chart.setOption(this.chartOptions);};ModalPredictPointLine.prototype.getPeriod=function(timeMode){var _this=this;var now,tmFmt,tmInterval,tick,endTick;var start,end;var timeShaft=[];if(!this.m_bIsGoBackTrace){now=new Date();_this.optionDefault.animation=true;}
else{now=this.m_traceData.currentTime;_this.optionDefault.animation=false;}
switch(timeMode){case 0:tmFmt='h1';tmInterval=3600000;start=now.format('yyyy-MM-dd')+' 00:00:00';end=now.format('yyyy-MM-dd HH:00:00');endTick=end.toDate().valueOf();deadlineTick=Math.max(start.toDate().valueOf()+86400000,endTick+28800000);break;case 1:default:tmFmt='d1';tmInterval=86400000;start=now.format('yyyy-MM')+'-01 00:00:00';end=now.format('yyyy-MM-dd 00:00:00');endTick=end.toDate().valueOf();if(this.entity.modal.option.predictMode===1){deadlineTick=now.valueOf()+604800000;}else{deadlineTick=Math.max(start.toDate().valueOf()+DateUtil.daysInMonth(now)*86400000,endTick+604800000);}
break;case 2:tmFmt='h1';tmInterval=3600000;start=new Date(now.valueOf()-((now.getDay()+6)%7)*86400000).format('yyyy-MM-dd 00:00:00');end=now.format('yyyy-MM-dd HH:00:00');endTick=end.toDate().valueOf();deadlineTick=Math.max(start.toDate().valueOf()+604800000,endTick+144000000);break;};tick=start.toDate().valueOf();while(tick<deadlineTick){timeShaft.push(tick.toDate().format('yyyy-MM-dd HH:00:00'));tick+=tmInterval;};return{startTime:start,endTime:end,rangeStartTime:start,rangeEndTime:timeShaft[timeShaft.length-1],tmFmt:tmFmt,tmInterval:tmInterval,timeShaft:timeShaft,deadlineTick:deadlineTick}};ModalPredictPointLine.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalPredictPointLine.prototype.setOptions=function(options){this.options=$.extend({},this.opitons,options);};ModalPredictPointLine.prototype.setModalOption=function(option){};ModalPredictPointLine.prototype.configModal=new ModalPredictPointLineConfig();ModalPredictPointLine.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;};var DEFAULTS_CHARTS_OPTIONS={tooltip:{formatter:function(p){var arrHtml=[p[0].name];p.forEach(function(row){if(row.value==='-')return;arrHtml.push(row.seriesName+': '+row.value);});return arrHtml.join('<br/>');}},series:[{markPoint:{symbol:'emptyCircle',symbolSize:5,effect:{show:true,shadowBlur:0},itemStyle:{normal:{color:'#6495ed',label:{position:'top'}}},data:[]},markLine:{symbol:'circle',symbolSize:1.5,itemStyle:{normal:{lineStyle:{type:'dotted'},color:'#6495ed',label:{position:'right'}}},label:{normal:{show:true}},tooltip:{show:false},data:[]}}],toolbox:{show:false}};return ModalPredictPointLine;}(jQuery,window));var ModalNote=(function(){function ModalNote(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalNote.prototype=new ModalBase();ModalNote.prototype.optionTemplate={name:'toolBox.modal.NOTE',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalNote'};ModalNote.prototype.show=function(){this.init();}
ModalNote.prototype.init=function(){}
ModalNote.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();if(!this.entity.modal.modalText)return;var temp=this.entity.modal.modalText;temp=temp.replace(/&lt;%\S+\.*\S+%&gt;/g,'--');this.container.style.padding='8px';this.container.innerHTML=temp;}
ModalNote.prototype.showConfigMode=function(){}
ModalNote.prototype.updateModal=function(points){var arrId=[];for(var i=0;i<points.length;i++){var data=points[i].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
var $target=$('#divContainer_'+this.entity.id).find('#'+points[i].dsItemId);var textUrl=this.entity.modal.modalTextUrl?this.entity.modal.modalTextUrl:undefined;var index=$target.closest('.springContent').find('.pointValue').index($target);$target.html(data);arrId.push('');if(textUrl&&textUrl.length>0){for(var j=0;j<textUrl[index].ptTextUrl.length;++j){if(textUrl[index].ptTextUrl[j].value==parseInt(data)){arrId[index]=textUrl[index].ptTextUrl[j].url;if(arrId[index]!=''){$target.css({'cursor':'pointer','text-decoration':'underline'});if(textUrl[index].ptTextUrl[j].name&&textUrl[index].ptTextUrl[j].name!=''){$target.html(textUrl[index].ptTextUrl[j].name);}}
break;}}}}
var _this=this;arrId.forEach(function(value,index){if(arrId[index]=='')return;var $target=$('#ulPages').find('[pageId="'+arrId[index]+'"]');var ScreenType;for(var i=0;i<AppConfig.navItems.length;i++){if(AppConfig.navItems[i].id==arrId[index]){ScreenType=AppConfig.navItems[i].type;break;}}
if(!ScreenType){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){ScreenManager.show(ScreenType,arrId[index]);})}else{if(ScreenType=='ReportScreen'){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){var $ev=$('#ulPages [pageid="'+arrId[index]+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');})}else if(ScreenType=='EnergyScreen'){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){ScreenManager.show(EnergyScreen,arrId[index]);})}}})}
ModalNote.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
return ModalNote;})();var ModalRankConfig=(function($,window,undefined){function ModalRankConfig(options){ModalConfig.call(this,options);}
ModalRankConfig.prototype=Object.create(ModalConfig.prototype);ModalRankConfig.prototype.constructor=ModalRankConfig;ModalRankConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalRank.html'};ModalRankConfig.prototype.init=function(){this.$dropArea=$('.drop-area',this.$wrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$rankPointList=$('#rankPointList',this.$wrap);this.$radioRankAsc=$('#radioRankAsc',this.$wrap);this.$radioRankDesc=$('#radioRankDesc',this.$wrap);this.attachEvents();};ModalRankConfig.prototype.recoverForm=function(modal){this._setField('input',this.$rankPointList,modal.points);if(0==modal.desc||null==modal.desc){this.$radioRankAsc.prop('checked',true);this.$radioRankDesc.prop('checked',false);}
else{this.$radioRankAsc.prop('checked',false);this.$radioRankDesc.prop('checked',true);}};ModalRankConfig.prototype.reset=function(){this._setField('input',this.$rankPointList);};ModalRankConfig.prototype.attachEvents=function(){var _this=this;_this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var ptList=_this.$rankPointList.val();modal.points=ptList.split(',');var radioVal=0;if($('#radioRankAsc')[0].checked){radioVal=0;}
else{radioVal=1;}
modal.desc=radioVal;_this.$modal.modal('hide');e.preventDefault();});};return ModalRankConfig;}(jQuery,window));var ModalRank=(function(){function ModalRank(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalRank.prototype=new ModalBase();ModalRank.prototype.optionTemplate={name:'toolBox.modal.WHIRLWIND_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRank'};ModalRank.prototype.show=function(){this.init();}
ModalRank.prototype.init=function(){}
ModalRank.prototype.renderModal=function(e){var _this=this;var arrPrjId=[];for(var i=0,len=AppConfig.projectList.length;i<len;i++){arrPrjId.push(AppConfig.projectList[i].id);}
var arrRankPt=_this.modal.points;var rankDesc=_this.modal.desc;var postData={'projectIds':arrPrjId,'points':arrRankPt,'desc':rankDesc};var showlist={list:[]};var descFlag=0;if(AppConfig.benchMark!=undefined){for(var i=0,len=arrRankPt.length;i<len;i++){for(var j=0,len2=AppConfig.benchMark.length;j<len2;j++){for(var k=0,len3=AppConfig.benchMark[j].points.length;k<len3;k++){if(arrRankPt[i]==AppConfig.benchMark[j].points[k]){showlist.list=AppConfig.benchMark[j].list;descFlag=AppConfig.benchMark[j].desc;break;}}}}}
if(showlist.list.length>0){var flag=true;if(rankDesc!=descFlag){flag=false;}
_this.drawRankChart(showlist,arrRankPt.length,flag);}
else{WebAPI.post('/benchmark/getListByPointsAndProjectIds',postData).done(function(result){_this.drawRankChart(result,arrRankPt.length,true);}).always(function(e){});}
_this.spinner.stop();}
ModalRank.prototype.updateModal=function(){}
ModalRank.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();}
ModalRank.prototype._showConfig=function(){};ModalRank.prototype.setModalOption=function(option){}
ModalRank.prototype.drawRankChart=function(dataSrc,ptLen,sortFlag){var _this=this;var showValue=[];var yAxis=[];var prjId,prjName,ptVal;var curPrjId=AppConfig.projectId;if(sortFlag){for(var i=dataSrc.list.length-1;i>=0;i--){ptVal=dataSrc.list[i].value;if(-1==ptVal){continue;}
prjId=dataSrc.list[i].projectId;if(prjId==curPrjId){showValue.push({value:ptVal,itemStyle:{normal:{color:'#ff6347'}}});}
else{showValue.push(ptVal);}
var findName=false;for(var j=0,len2=AppConfig.projectList.length;j<len2;j++){if(prjId==AppConfig.projectList[j].id){findName=true;break;}}
if(1==ptLen){if(0==_this.m_langFlag){yAxis.push(AppConfig.projectList[j].name_cn);}
else{yAxis.push(AppConfig.projectList[j].name_english);}}
else{if(findName){if(0==_this.m_langFlag){prjName=AppConfig.projectList[j].name_cn;}
else{prjName=AppConfig.projectList[j].name_english;}
yAxis.push(prjName+'-'+dataSrc.list[i].name);}
else{yAxis.push(dataSrc.list[i].name);}}}}
else{for(var i=0,len=dataSrc.list.length;i<len;i++){ptVal=dataSrc.list[i].value;if(-1==ptVal){continue;}
prjId=dataSrc.list[i].projectId;if(prjId==curPrjId){showValue.push({value:ptVal,itemStyle:{normal:{color:'#ff6347'}}});}
else{showValue.push(ptVal);}
var findName=false;for(var j=0,len2=AppConfig.projectList.length;j<len2;j++){if(prjId==AppConfig.projectList[j].id){findName=true;break;}}
if(1==ptLen){if(0==_this.m_langFlag){yAxis.push(AppConfig.projectList[j].name_cn);}
else{yAxis.push(AppConfig.projectList[j].name_english);}}
else{if(findName){if(0==_this.m_langFlag){prjName=AppConfig.projectList[j].name_cn;}
else{prjName=AppConfig.projectList[j].name_english;}
yAxis.push(prjName+'-'+dataSrc.list[i].name);}
else{yAxis.push(dataSrc.list[i].name);}}}}
var chartOption={title:{subtext:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:['value'],show:false},calculable:false,grid:{x:100,y:10,x2:20,y2:60},xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},axisLabel:{show:true,rotate:45},data:yAxis}],series:[{name:'value',type:'bar',data:showValue,itemStyle:{normal:{label:{show:true,position:'inside'},barBorderRadius:[0,5,5,0]},emphasis:{barBorderRadius:[0,5,5,0]}}}]};_this.chart.setOption(chartOption);}
ModalRank.prototype.configModal=new ModalRankConfig();return ModalRank;})();var ModalRankNormal=(function(){function ModalRankNormal(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalRankNormal.prototype=new ModalBase();ModalRankNormal.prototype.optionTemplate={name:'toolBox.modal.RANK_CHART',parent:0,mode:['modalRankNormal'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRankNormal'};ModalRankNormal.prototype.show=function(){this.init();}
ModalRankNormal.prototype.init=function(){}
ModalRankNormal.prototype.renderModal=function(e){var _this=this;var arrPoint=_this.modal.points;var postData={'dataSourceId':0,'dsItemIds':arrPoint};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(data){_this.drawRankChart(data.dsItemList);}).always(function(e){_this.spinner.stop();});}
ModalRankNormal.prototype.updateModal=function(){}
ModalRankNormal.prototype.showConfigModal=function(){}
ModalRankNormal.prototype._showConfig=function(){}
ModalRankNormal.prototype.setModalOption=function(option){}
ModalRankNormal.prototype.drawRankChart=function(dataSrc){var _this=this;var yAxis=[];var showValue=[];var arrId=[];var arrItem=[];for(var i=dataSrc.length-1;i>=0;i--){arrId.push(dataSrc[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=arrItem.length;i<len;i++){var item=arrItem[i];yAxis.push(item.alias);for(var j=0,len2=dataSrc.length;j<len2;j++){if(item.id==dataSrc[j].dsItemId){showValue.push(parseInt(dataSrc[j].data));break;}}}
for(var i=dataSrc.length-1;i>=0;i--){for(var m=0;m<arrItem.length;m++){if(dataSrc[i].dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;yAxis.push(itemName);showValue.push(parseInt(dataSrc[i].data));break;}}}
var chartOption={title:{subtext:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:[],show:false},calculable:false,grid:{x:100,y:10,x2:20,y2:40},xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},axisLabel:{show:true,rotate:45},data:yAxis}],series:[{name:'value',type:'bar',data:showValue,itemStyle:{normal:{label:{show:true,position:'inside'},barBorderRadius:[0,5,5,0]},emphasis:{barBorderRadius:[0,5,5,0]}}}]};_this.chart.setOption(chartOption);}
return ModalRankNormal;})();var ModalMix=(function(){function ModalMix(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.subChartIds&&(this.entity.modal.option.subChartIds=[]);};ModalMix.prototype=new ModalBase();ModalMix.prototype.optionTemplate={name:'toolBox.modal.MIX',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMix'};ModalMix.prototype.show=function(){this.init();}
ModalMix.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';}
ModalMix.prototype.initContainer=function(replacedElementId){var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass=' gray-scrollbar scrollY';if((!divParent)||replacedElementId){isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
$(divParent).addClass('springContainer');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){this.spanRange={minWidth:1,maxWidth:3,minHeight:1,maxHeight:4.5,yScale:4/3,xScale:4};}else{this.spanRange={minWidth:this.optionTemplate.minWidth,maxWidth:this.optionTemplate.maxWidth,minHeight:this.optionTemplate.minHeight,maxHeight:this.optionTemplate.maxHeight,yScale:1,xScale:1};}
if(AppConfig.isMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){var height=100;if((this.optionTemplate.scroll===false||this.entity.scroll===false)&&!(this.screen.options&&this.screen.options.isConfig)){divParent.className+=' noScroll';}else{height=this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale;height>100&&(height=100);divParent.style.height=height+'%';}
divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale+'%';if(this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale>100){divParent.style.width='100%';}
if(this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale>100){divParent.style.height='100%';}}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.title&&this.entity.modal.title!=''&&(!this.entity.isNotRender)){divParent.innerHTML='<div class="panel panel-default">\
                <div class="panel-heading springHead">\
                    <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                </div>\
                <div class="panel-body springContent'+scrollClass+'" style="position: relative;"></div>\
            </div>';}else{divParent.innerHTML='<div class="panel panel-default">\
                <span class="springSeHead fontTemp6">'+(this.entity.modal.title?this.entity.modal.title:'')+'</span>\
                <div class="panel-body springContent'+scrollClass+'" style="position: relative;height:100%;"></div>\
            </div>';}
if(!(this instanceof ModalAnalysis)){var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];if(this.entity.modal.points&&this.entity.modal.points.length>0){var lkJump;lkJump=document.createElement('a');lkJump.className='springLinkBtn';lkJump.title='Add to datasource';lkJump.href='javascript:;';lkJump.innerHTML='<span class="glyphicon glyphicon-export"></span>';divBtnCtn.appendChild(lkJump);lkJump.onclick=function(){new ModalAppendPointToDs(true,_this.entity.modal.points,null).show();}}
var link=this.entity.modal.link;var _this=this;if(link&&AppConfig.menu[link]){var linkBtn=document.createElement('a');linkBtn.className='springLinkBtn';linkBtn.innerHTML='<span class="glyphicon glyphicon-link"></span>';linkBtn.setAttribute('pageid',link);linkBtn.title='Link to '+AppConfig.menu[link];divBtnCtn.appendChild(linkBtn);linkBtn.onclick=function(e){var $ev=$('#ulPages [pageid="'+link+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');}}
domPanel.appendChild(divBtnCtn);}
this.container=divParent.getElementsByClassName('springContent')[0];return this;}
ModalMix.prototype.renderModal=function(e){var _this=this;var $sliderCont;var $sliderDiv=$('.sliderDiv');if(_this.entity.modal.option.displaySlider&&!_this.entity.modal.option.displayInterval){_this.entity.modal.option.displayInterval=5;}
var displaySlider=_this.entity.modal.option.displayInterval;var carouselTime=new Date();this.container.classList.add('modalMix');if(displaySlider){$sliderDiv=$('\
                                <div id="carousel_'+carouselTime.getTime()+'" class="carousel slide sliderDiv" data-ride="carousel">'+'<ol class="carousel-indicators" style="bottom:0">'+'</ol><div class="carousel-inner" role="listbox">'+'</div>'+'<a class="left carousel-control" href="#carousel_'+carouselTime.getTime()+'" role="button" data-slide="prev">'+'<span class="glyphicon glyphicon-chevron-left" aria-hidden="true" style="transform: scale(1,1.3)"></span><span class="sr-only">Previous</span></a>'+'<a class="right carousel-control" href="#carousel_'+carouselTime.getTime()+'" role="button" data-slide="next">'+'<span class="glyphicon glyphicon-chevron-right" aria-hidden="true" style="transform: scale(1,1.3)"></span><span class="sr-only">Next</span></a>'+'</div>');$(_this.container).append($sliderDiv);if(AppConfig.isMobile){$(_this.container).append('<style>.carousel-indicators .active{background-image: -webkit-radial-gradient(center,#fff 0%,#F7B702 80%,#fff 85%);border: none;}.carousel-indicators li{border-color:#aaa}</style>');}}
if(!this.entity.modal.option||!this.entity.modal.option.subChartIds)return;var index=0;this.entity.modal.option.subChartIds.forEach(function(obj){for(var i=0,item;i<_this.screen.store.layout.length;i++){if(displaySlider){$(_this.container).css({'display':'block','overflow-y':'hidden'});for(var z=0;z<_this.screen.store.layout[i].length;z++){item=_this.screen.store.layout[i][z];if(obj.id!=item.id)continue;var modelClass,entity;_this.screen.store.layout[i][z].spanC=12;var $sliderIner=$('<div class="item sliderIner"><div class="carousel-caption" style="height:100%;width:100%;right:0;left:0;padding-bottom:0;bottom:0px;padding-top:0px;"></div></div>');var $sliderDot=$('<li data-target="#carousel_'+carouselTime.getTime()+'" data-slide-to="'+index+'" style="border-color:#aaa;box-shadow:1px rgba(0,0,0,.05);margin:1.5px 3px;"></li>')
if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalMix'){entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){if(entity){$(entity.container).height($(_this.container).height()-30);$(entity.container).width($(_this.container).width());}
entity.render();$sliderCont=$(_this.container).children('.springContainer');$sliderIner.children('.carousel-caption').append($sliderCont);$sliderIner.height($(_this.container).height());$sliderDiv.children('.carousel-inner').append($sliderIner);$sliderDiv.children('.carousel-indicators').append($sliderDot);++index;continue;}
if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
if(entity){if(AppConfig.isMobile){$(entity.container).height($(_this.container).height()-40);}else{$(entity.container).height($(_this.container).height()-30);}
$(entity.container).width($(_this.container).width());}
entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);if(entity){$(entity.container).height($(_this.container).height()-30);$(entity.container).width($(_this.container).width());}
entity.render();_this.screen.isForReport&&entity.configure();}
$sliderCont=$(_this.container).children('.springContainer');$sliderIner.children('.carousel-caption').append($sliderCont);$sliderIner.height($(_this.container).height());$sliderDiv.children('.carousel-inner').append($sliderIner);$sliderDiv.children('.carousel-indicators').append($sliderDot);++index;}}else{$(_this.container).css({'display':'flex','overflow-y':'auto','flex-flow':'wrap'});for(var j=0;j<_this.screen.store.layout[i].length;j++){item=_this.screen.store.layout[i][j];if(obj.id!=item.id)continue;var modelClass,entity;if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalMix'){entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){entity.render();continue;}
if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);entity.render();_this.screen.isForReport&&entity.configure();}}}}});if(displaySlider){if($(_this.container).find('.item:first')){$(_this.container).find('.item:first').addClass('active');}
if($(_this.container).find('.carousel-indicators').children(':first')){$(_this.container).find('.carousel-indicators').children(':first').addClass('active');}
$(_this.container).find('.sliderDiv').carousel({interval:this.entity.modal.option.displayInterval*1000});}
if(this.entity.modal.option.bgColor){this.container.style.backgroundColor=this.entity.modal.option.bgColor;$(this.container).find('.panel.panel-default').css('cssText','background-color:transparent !important')}}
ModalMix.prototype.showConfigMode=function(){}
ModalMix.prototype.updateModal=function(points){for(var i in points){var data=points[i].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
$('#'+points[i].dsItemId).html(data);}}
ModalMix.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
ModalMix.prototype.configure=function(){if(this.spinner)this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();if(_this.entity.modal.option.subChartIds.length>0){var subChartsIdsMix=_this.entity.modal.option.subChartIds;for(var i=0;i<subChartsIdsMix.length;i++){var item=subChartsIdsMix[i];for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(item.id===_this.screen.arrEntityOrder[j]){_this.screen.removeEntity(_this.screen.arrEntityOrder[j]);}}}
_this.entity.modal.option.subChartIds=[];}
_this.screen.removeEntity(_this.entity.id);$('#divContainer_'+_this.entity.id).remove();_this=null;};divMask.appendChild(btnRemove);var btnAdd=document.createElement('span');btnAdd.className='glyphicon glyphicon-plus-sign springConfigAddBtn grow';btnAdd.title='Add';btnAdd.onclick=function(e){var spanC=6,spanR=6;var $chartsCt=_this.container.classList.contains('chartsCt')?$(_this.container):$(_this.container).siblings().find('.chartsCt');if($chartsCt.children().length>0){var lastDiv=$chartsCt.children()[$chartsCt.children().length-1];spanR=Number(lastDiv.querySelector('#heightResize').value);spanC=Number(lastDiv.querySelector('#widthResize').value);}
if(!_this.container.classList.contains('chartsCt')){_this.container=_this.container.parentElement.getElementsByClassName('chartsCt')[0];}
var entity=new ModalNone(_this,{id:(+new Date()).toString(),spanC:spanC,spanR:spanR,modal:{type:"ModalNone"},isNotRender:true});_this.screen.arrEntityOrder.push(entity.entity.id);_this.screen.listEntity[entity.entity.id]=entity;if(!_this.entity.modal.option){_this.entity.modal.option={};_this.entity.modal.option.subChartIds=new Array();}
_this.entity.modal.option.subChartIds.push({id:entity.entity.id});entity.render();entity.configure();};divMask.appendChild(btnAdd);var btnInstall=document.createElement('span');btnInstall.className='glyphicon glyphicon-cog springConfigInstallBtn grow';btnInstall.title='config';btnInstall.onclick=function(e){_this.showConfigModal();}
divMask.appendChild(btnInstall);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;(this.entity.spanR>this.optionTemplate.maxHeight)&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $chartCt=$('<div class="divResize chartsCt gray-scrollbar">');divMask.appendChild($chartCt[0]);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent,$chartsCt;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();$chartsCt=e.target.classList.contains('chartsCt')?$(e.target):$(e.target).closest('.chartsCt');if(!$sourceParent[0].classList.contains('chartsCt')&&($targetParent[0].classList.contains('chartsCt')||$chartsCt.length==1)){if($targetParent[0].classList.contains('chartsCt')){_this.insertChartIntoMix(sourceId,$targetParent[0])}else if($chartsCt.length==1){_this.insertChartIntoMix(sourceId,$chartsCt[0])}}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}}
this.executeConfigMode();},ModalMix.prototype.insertChartIntoMix=function(sourceId,container){if(sourceId){if(this.screen.listEntity[sourceId].entity.modal.type=='ModalMix'){alert(I18n.resource.toolBox.modal.MSG_MIX_NOT_ALLOW_TO_MIX);return false;}
var modelClass,item,entity=this.screen.listEntity[sourceId].entity;$('#divContainer_'+sourceId).remove();entity.isNotRender=true;if(!this.entity.modal.option){this.entity.modal.option={};}
if(!this.entity.modal.option.subChartIds){this.entity.modal.option.subChartIds=[];}
modelClass=this.screen.factoryIoC.getModel(entity.modal.type);this.screen.container=container;if(container.children.length>0){var lastDiv=container.children[container.children.length-1];entity.spanC=Math.round(parseInt(lastDiv.style.width.split('%')[0])/10)*12/10;entity.spanR=Math.round(parseInt(lastDiv.style.height.split('%')[0])/10)*6/10;}else{entity.spanC=6;entity.spanR=6;}
item=new modelClass(this.screen,entity);item.configure()
this.entity.modal.option.subChartIds.push({id:entity.id});}}
ModalMix.prototype.showConfigModal=function(){var _this=this;var $mixChartShow=$('#mixChartShow');if($mixChartShow.length===0){$mixChartShow=$('\
                            <style>.mixChartShow .row{margin-top: 15px;margin-bottom: 15px;}</style>\
                            <div id="mixChartShow" class="mixChartShow"><div class="modal fade"  style="position:absolute;"><div class="modal-dialog"><div class="modal-content">\
                            <div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                            <h4 class="modal-title">组合图显示模式</h4></div>\
                            <div class="modal-body">\
                            <div class="row">\
                            <div class="col-xs-3">组合图轮播</div>\
                            <div class="col-xs-6"><input type="number" id="iptInterval" placeholder="时间间隔" style="width:100px"/>s(0或者不填写表示不轮播)</div>\
                            </div>\
                            <div class="row">\
                            <div class="col-xs-3">背景颜色</div>\
                            <div class="col-xs-2">\
                            <select id="selBgColor">\
                            <option value="transparent">无</option>\
                            <option value="#ffffff">白</option>\
                            <option value="#000000">黑</option>\
                            <option value="#337ab7">蓝</option>\
                            <option value="#5cb85c">绿</option>\
                            <option value="custom">自定义</option>\
                            </select>\
                            </div>\
                            <div class="col-xs-2"><input type="input" id="iptBgColor" placeholder="#ffffff" style="width:60px"/></div>\
                            <div class="col-xs-2"><input type="color" class="" id="bgColorView"/></div>\
                            </div>\
                            <div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="btnSaveConfig">确定</button></div>\
                            </div></div></div></div>');}
$('#paneContent').append($mixChartShow);var $iptBgColor=$('#iptBgColor',$mixChartShow);var $bgColorView=$('#bgColorView',$mixChartShow);var $selBgColor=$('#selBgColor',$mixChartShow);var $iptInterval=$('#iptInterval',$mixChartShow);$iptInterval.val(_this.entity.modal.option.displayInterval?_this.entity.modal.option.displayInterval:20);setShow(_this.entity.modal.option.bgColor?_this.entity.modal.option.bgColor:'transparent');$selBgColor.off('change').on('change',function(e){setShow(this.value,e);});$iptBgColor.off('input').on('input',function(){$bgColorView.val(this.value);});$bgColorView.off('change').on('change',function(e){$iptBgColor.val(this.value);});$('#btnSaveConfig',$mixChartShow).off('click').click(function(){_this.entity.modal.option.displayInterval=$iptInterval.val();_this.entity.modal.option.bgColor=$iptBgColor.val();});$mixChartShow.children('.modal').modal();function setShow(selected,event){if(selected==='transparent'){$bgColorView.hide();}else{$bgColorView.val(selected);$bgColorView.show();}
if(selected==='custom'){$iptBgColor.show();$iptBgColor.val('').focus();}else{$iptBgColor.hide();$iptBgColor.val(selected);}
if(!event){$selBgColor.val(selected);if(!$selBgColor.val()){$selBgColor.val('custom');$iptBgColor.val(selected).show().focus();}}}}
return ModalMix;})();var ModalMonitor=(function(){var _this;function ModalMonitor(screen,entityParams){_this=this;_this.$configModal=undefined;_this.$modal=undefined;_this.tempOpt=undefined;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalMonitor.prototype=new ModalBase();ModalMonitor.prototype.optionTemplate={name:'toolBox.modal.Monitor',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMonitor'};ModalMonitor.prototype.show=function(){this.init();};ModalMonitor.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalMonitor.prototype.configure=function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this.screen.isScreenChange=true;_this=null;})};divMask.appendChild(btnRemove);if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
var btnHeightResize=document.createElement('div');var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};_this.entity.modal.interval='300000';this.container.parentNode.appendChild(divMask);if(this.entity.isNotRender&&this.screen.entity){$(document.getElementById('divContainer_'+this.screen.entity.id)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}
if(this.entity.isNotRender&&this.screen.listEntity){var parentId=undefined,subChartIds;if(this.entity&&this.entity.id){parentId=this.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}
if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
this.divResizeByToolInit();this.executeConfigMode();};ModalMonitor.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();var divMonitor,divIcon,divDetail,spName,spValue,spUnit;var isSemi=false;$(_this.container).addClass('clearfix');$(".springContent").css("overflow","auto");for(var i=0;i<_this.entity.modal.option.length;i++){divMonitor=document.createElement('div');divMonitor.className='divMonitor';isSemi=false;(_this.entity.modal.option[i].col=='1')&&(isSemi=true);isSemi&&(divMonitor.className+=' semiCol');divMonitor.setAttribute("type",_this.entity.modal.option[i].type);divIcon=document.createElement('div');divIcon.className='divIcon';divIcon.innerHTML='<span class="'+_this.entity.modal.option[i].icon+'"></span>';if(_this.entity.modal.option[i].icon){divIcon.style.color=_this.entity.modal.option[i].iconColor;if(isSemi){divIcon.querySelector('span').style.border='2px solid '+_this.entity.modal.option[i].iconColor;}}
divDetail=document.createElement('div');divDetail.className='divMonitorInfo';spName=document.createElement('span');spName.className='spName';spName.textContent=_this.entity.modal.option[i].name;spValue=document.createElement('span');spValue.dataset.dsId=_this.entity.modal.option[i].dsId;spValue.className='spValue';spUnit=document.createElement('span');spUnit.className='spUnit';spUnit.textContent=_this.entity.modal.option[i].unit;if(_this.entity.modal.option[i].backColor==""){}else{divMonitor.style.background=_this.entity.modal.option[i].backColor;}
divDetail.appendChild(spValue);divDetail.appendChild(spUnit);divDetail.appendChild(spName);divMonitor.appendChild(divIcon);divMonitor.appendChild(divDetail);(!isSemi)&&(divMonitor.style.height=100/Math.ceil(_this.entity.spanR)+'%');_this.container.appendChild(divMonitor);}};ModalMonitor.prototype.showConfigMode=function(){};ModalMonitor.prototype.showConfigModal=function(){_this.tempOpt=$.extend(true,{},_this.entity.modal);var configModalTpl='\
                <div id="modalMonitorConfig" class="modal fade"  role="dialog" aria-labelledby="ttlNodeTool">\
                    <div class="modal-dialog">\
                        <div class="modal-content">\
                            <div class="modal-header">\
                                <span id="btnMonitorAdd" class="glyphicon glyphicon-plus-sign btnMonitorAdd grow"></span>\
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                                <h4 class="modal-title" id="ttlNodeTool">Diagnosis Edit</h4>\
                            </div>\
                            <div class="modal-body gray-scrollbar" id="ctnMonitor">\
                            </div>\
                            <div class="modal-footer">\
                                <input type ="color">\
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
                                <button type="button" class="btn btnSure btn-primary">Save</button>\
                            </div>\
                        </div>\
                    </div>\
                </div>';_this.$configModal=$('#modalMonitorConfig');if(_this.$configModal.length==0){_this.$configModal=$(configModalTpl);}else{_this.$configModal.modal('show');return;}
_this.$configModal.appendTo($(_this.container).parentsUntil('.springContainer').parent().parent());var $ctnMonitor=_this.$configModal.find('#ctnMonitor').html('');var btnAdd=_this.$configModal.find('#btnMonitorAdd')[0];btnAdd.title='Monitor Type Add';btnAdd.onclick=function(){$ctnMonitor.append(_this.createDivMonitor())};if(_this.entity.modal.option&&_this.entity.modal.option.length>0){for(var i=0;i<_this.entity.modal.option.length;i++){$ctnMonitor[0].appendChild(_this.createDivMonitor(_this.entity.modal.option[i]));}}else{$ctnMonitor[0].appendChild(_this.createDivMonitor());}
_this.$configModal.modal('show');_this.$configModal.find('.btnSure').off('click').on('click',function(){_this.entity.modal=$.extend(true,{},_this.tempOpt);_this.$configModal.modal('hide');});_this.attachMonitorEvent();};ModalMonitor.prototype.updateModal=function(points){this.spinner&&this.spinner.stop();var MonitorInfoS=$(_this.container).find('.divMonitor');var arrSpVal=$(_this.container).find('.spValue');for(var i=0;i<arrSpVal.length;i++){for(var j in points){var data=points[j].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
if(points[j].dsItemId==arrSpVal[i].dataset.dsId){if(MonitorInfoS[i].getAttribute("type")=="数值型"){arrSpVal[i].textContent=data;}else{if(!data==""||!data==0){arrSpVal[i].textContent=data;}else{$(MonitorInfoS[i]).css("background","-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(#D31212), to(#FC1B1B))");arrSpVal[i].textContent=data;}}
break;}}}};ModalMonitor.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalMonitor.prototype.createDivMonitor=function(opt){var divMonitor=document.createElement('div');divMonitor.className='divMonitor';var $divMonitor=$(divMonitor);divMonitor.innerHTML='\
            <div class="divIcon"></div>\
            <div class="divMonitorInfo">\
                <div class="divName">\
                    <label>name:</label>\
                    <span class="spName"></span>\
                    <input class="iptName form-control" ></input>\
                </div>\
                <div class="divValue">\
                    <label>value:</label>\
                    <span class="spValueTip glyphicon glyphicon-plus"></span>\
                    <span class="spValue"></span>\
                </div>\
                <div class="divUnit">\
                    <label>unit:</label>\
                    <span class="spUnit"></span>\
                    <input class="iptUnit form-control"></input>\
                </div>\
                <div class="divType">\
                    <label>type:</label>\
                    <span class="spTypeShow"></span>\
                    <select class="spType">\
                        <option>数值型</option>\
                        <option>报警型</option>\
                    </select>\
                </div>\
                <div class="divCol">\
                    <label>col:</label>\
                    <select class="iptCol form-control" value="1">\
                        <option value="0">一行</option>\
                        <option value="1">半行</option>\
                    </select>\
                </div>\
            </div>\
            <div class="divMonitorDel glyphicon glyphicon-remove-circle"></div>';if(opt&&opt.icon){$divMonitor.find('.divIcon').addClass(opt.icon);if(opt.iconColor)$divMonitor.find('.divIcon').css({'color':opt.iconColor,'box-shadow':'0 0 15px '+opt.iconColor})}else{$divMonitor.find('.divIcon').addClass('glyphicon glyphicon-plus').css('color','#f6c700');}
if(opt&&opt.name){$divMonitor.find('.spName').show().text(opt.name);$divMonitor.find('.iptName').hide().val(opt.name)}else{$divMonitor.find('.spName').hide();$divMonitor.find('.iptName').show();}
if(opt&&opt.dsId){$divMonitor.find('.spValue').show().text(AppConfig.datasource.getDSItemById(opt.dsId).alias)[0]
$divMonitor.find('.divValue')[0].dataset.dsId=opt.dsId;$divMonitor.find('.spValueTip').hide()}else{$divMonitor.find('.spValue').hide();$divMonitor.find('.spValueTip').show()}
if(opt&&opt.unit){$divMonitor.find('.spUnit').show().text(opt.unit);$divMonitor.find('.iptUnit').hide().val(opt.unit)}else{$divMonitor.find('.spUnit').hide();$divMonitor.find('.iptUnit').show();}
if(opt&&opt.type){$divMonitor.find('.spTypeShow').show().text(opt.type);$divMonitor.find('.spType').hide();}else{$divMonitor.find('.spTypeShow').hide();$divMonitor.find('.spType').show();}
if(opt&&opt.col){$divMonitor.find('.iptCol').val(opt.col);}
if(opt&&opt.backColor){$divMonitor.css("background",opt.backColor);}else{$divMonitor.css("background","#fff");}
if(!opt){if(!_this.tempOpt.option){_this.tempOpt.option=[];}
_this.tempOpt.option.push({icon:'glyphicon glyphicon-plus',iconColor:'#f6c700',name:'',unit:'',dsId:'',type:'',backColor:'',col:'6'})}
return divMonitor};ModalMonitor.prototype.attachMonitorEvent=function(){var $ctnMonitor=_this.$configModal.find('#ctnMonitor');var $iptColor;var indexDivMonitor;$ctnMonitor.off('click').on('click','.divMonitor',function(){$ctnMonitor.find(".divMonitor").css("border","1px dotted");indexDivMonitor=$ctnMonitor.find(".divMonitor").index($(this));$(this).css("border","1px solid black");})
$(".modal-footer").find("input").off("change").on("change",function(){var colorVal=$(this).val();var rgb=colorVal.colorRgb().split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var hsl=rgbToHsl(r,g,b);var hslEndL=hsl[2]+0.05;var rgbStartColor=hslToRgb(hsl[0],hsl[1],hsl[2]);var rgbEndColor=hslToRgb(hsl[0],hsl[1],hslEndL);var backColor='-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(rgb('+rgbStartColor[0]+','+rgbStartColor[1]+','+rgbStartColor[2]+')), to(rgb('+rgbEndColor[0]+','+rgbEndColor[1]+','+rgbEndColor[2]+'))';_this.tempOpt.option[indexDivMonitor].backColor=backColor;$ctnMonitor.find(".divMonitor").eq(indexDivMonitor).css("background",backColor);})
var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return[h,s,l];}
function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var hue2rgb=function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
$ctnMonitor.on('click','.divIcon',function(e){e.stopPropagation();$('#ctnMonitor .divMonitor.selected').removeClass('selected');var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').addClass('selected');var index=$ctnMonitor.children().index($divMonitor);if(_this.$modal){_this.$modal.modal('show');$iptColor=_this.$modal.find('#iptColorSel');if(_this.tempOpt.option[index].iconColor){$iptColor.val(_this.tempOpt.option[index].iconColor);}
if(_this.tempOpt.option[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option[index].icon.split(' ')[1]).parent().addClass('selected');}}else{WebAPI.get('static/scripts/spring/entities/modalMonitor.html').done(function(resultHTML){_this.$modal=$(resultHTML);$iptColor=_this.$modal.find('#iptColorSel');_this.$modal.modal('show');if(_this.tempOpt.option[index].iconColor){_this.$modal.find('#iptColorSel').val(_this.tempOpt.option[index].iconColor);}
if(_this.tempOpt.option[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option[index].icon.split(' ')[1]).parent().addClass('selected');}
_this.$modal.find('.bs-glyphicons-list>li').click(function(e){if($(e.currentTarget).hasClass('selected'))return;$('.bs-glyphicons-list>li.selected').removeClass('selected');$(e.currentTarget).addClass('selected');});_this.$modal.find('.btnSure').click(function(e){var $divMonitor=$('#ctnMonitor .divMonitor.selected');var index=$ctnMonitor.children().index($divMonitor);var icon=$('.bs-glyphicons-list>li.selected>.glyphicon-class').text();_this.tempOpt.option[index].icon=icon;_this.tempOpt.option[index].iconColor=$iptColor.val();$divMonitor.find('.divIcon')[0].className='divIcon '+icon;$divMonitor.find('.divIcon').css({'color':$iptColor.val(),'box-shadow':'0 0 15px '+$iptColor.val()});_this.$modal.modal('hide');})})}});$ctnMonitor.on('click','.divMonitorDel',function(e){e.stopPropagation();var index=$ctnMonitor.children().index($(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor'));$ctnMonitor.children().eq(index).remove();_this.tempOpt.option.splice(index,1);_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}});$ctnMonitor.on('click','.spName',function(e){e.stopPropagation();$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptName').show().focus();});$ctnMonitor.on('click','.spUnit',function(e){e.stopPropagation();$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptUnit').show().focus();});$ctnMonitor.off('blur').on('blur','input',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();if($(e.currentTarget).hasClass('iptName')){_this.tempOpt.option[index].name=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spName').text(value).show();}else if($(e.currentTarget).hasClass('iptUnit')){_this.tempOpt.option[index].unit=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spUnit').text(value).show();}});$ctnMonitor.off('blur').on('blur','select',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var type=this.value;if($(e.currentTarget).hasClass('iptCol')){if(!type)return;_this.tempOpt.option[index].col=type;}else{_this.tempOpt.option[index].type=type;$(this).hide();$divMonitor.find(".spTypeShow").show().html(type);}});$ctnMonitor.on('click','.spTypeShow',function(e){var $divMonitor=$(this).parentsUntil('.ctnMonitor','.divMonitor');$(this).hide();$divMonitor.find(".spType").show();})
$ctnMonitor[0].ondragenter=function(e){e.preventDefault();};$ctnMonitor[0].ondragover=function(e){e.preventDefault();};$ctnMonitor[0].ondragleave=function(e){e.preventDefault();};$ctnMonitor[0].ondrop=function(e){e.preventDefault();var dsItemId=EventAdapter.getData().dsItemId;if(!dsItemId)return;var $divValue=$(e.target).parentsUntil('.ctnMonitor','.divValue');if($divValue.length>0){var index=$ctnMonitor.children().index($divValue.parentsUntil('.ctnMonitor','.divMonitor'));_this.tempOpt.option[index].dsId=dsItemId;$divValue[0].dataset.dsId=dsItemId;$divValue.find('.spValue').text(AppConfig.datasource.getDSItemById(dsItemId).alias).show();$divValue.find('.spValueTip').hide();_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}}};};return ModalMonitor;})();(function(){var tags={};var TOOLBOX=['DataSource','LinkTo'];var PATTERN_STR='<('+TOOLBOX.join('|')+').*?(/|'+TOOLBOX.join('|')+')>';window.__spring_html_modal={};function runScript(content){var done=false;var script=document.createElement("script");var head=document.getElementsByTagName("head")[0];script.type="text\/javascript";script.text=content;head.appendChild(script);head.removeChild(script);}
tags.Base=(function(){function Base(modal){this.$textarea=modal.$textarea;this.$modalCt=modal.$modalCt;this.$toolBtn=null;this.init();}
Base.prototype.init=function(){throw new Error('init 方法未被实现，不可直接调用');};Base.prototype.render=function($container){throw new Error('render 方法未被实现，不可直接调用');};return Base;}());tags.DataSource=(function(){var _this;function DataSource(modal){_this=this;tags.Base.call(this,modal);}
DataSource.prototype=Object.create(tags.Base.prototype);DataSource.prototype.constructor=DataSource;DataSource.prototype.insertTpl='<DataSource data-id="{id}"{linkTo}/>';DataSource.prototype.init=function(){var arrHtml=[];this.$toolBtn=$('<button type="button" class="btn btn-default" data-toggle="collapse" data-target="#panelDataSourceConfig" aria-expanded="false">\
                DataSource\
                </button>');this.$toolConfig=$('#panelDataSourceConfig',this.$modalCt);};DataSource.prototype.render=function($btnCtn){$btnCtn.append(this.$toolBtn);this.attachEvents();};DataSource.prototype.attachEvents=function(){};DataSource.save=function(dataset,modal){var id;if(!dataset)return;id=dataset.id;if(id&&modal.points.indexOf(id)===-1)modal.points.push(id);};DataSource.getStaticRender=function(dom){var dataset=dom.dataset;var menuId=dataset.linkTo;var $ele;if(menuId){$ele=$('<a href="javascript:;" data-is="DataSource" data-id="'+dataset.id+'">Loading</a>');$ele.click(function(e){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');});return $ele;}
else return $('<span data-is="DataSource" data-id="'+dataset.id+'">Loading</span>');};DataSource.getRealTimeRender=function($ele,map){var dataset=$ele[0].dataset;if(isNaN(map[dataset.id])){$ele.html(map[dataset.id]);}else{$ele.html(parseFloat(map[dataset.id]));}};return DataSource;}());tags.LinkTo=(function(){var _this;function LinkTo(modal){_this=this;tags.Base.call(this,modal);}
LinkTo.prototype=Object.create(tags.Base.prototype);LinkTo.prototype.constructor=LinkTo;LinkTo.prototype.insertTpl='<LinkTo data-id="{id}" ></LinkTo>';LinkTo.prototype.init=function(){var arrHtml=[];this.$toolBtn=$('<button type="button" class="btn btn-default" data-parent="#collapseList" data-toggle="collapse" data-target="#panelLinkToConfig" aria-expanded="false">LinkTo</button>');this.$toolConfig=$('#panelLinkToConfig',this.$modalCt);};LinkTo.prototype.render=function($btnCtn){$btnCtn.append(this.$toolBtn);this.attachEvents();};LinkTo.prototype.attachEvents=function(){};LinkTo.save=function(dataset,modal){};LinkTo.getStaticRender=function(dom,doc){var dataset=dom.dataset;var menuId=dataset.id;doc=doc||window.document;$ele=$('<a href="javascript:;">'+(dom.innerHTML||'Link To')+'</a>',doc);$ele.click(function(){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');});return $ele;};return LinkTo;}());var ModalHtmlConfig=(function(){var _this;var gMenusHtml;function ModalHtmlConfig(options){_this=this;ModalConfig.call(this,options);this.toolbox=[];}
ModalHtmlConfig.prototype=Object.create(ModalConfig.prototype);ModalHtmlConfig.prototype.constructor=ModalHtmlConfig;ModalHtmlConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalHtmlConfig.html'};ModalHtmlConfig.prototype.init=function(){this.$modal=$('.modal',this.$wrap);this.$modalCt=$('.modal-content',this.$wrap);this.$formWrap=$('.form-wrap',this.$wrap);this.$dsGroupList=$('.form-horizontal','#panelDataSourceConfig');this.$linkGroupList=$('.form-horizontal','#panelLinkToConfig');this.$textarea=$('.form-textarea',this.$formWrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$toolboxCtn=$('.toolbox-ctn',this.$formWrap);this.$btnResizeFull=$('.btn-resize-full',this.$wrap);this.$btnResizeSmall=$('.btn-resize-small',this.$wrap);this.attachEvents();this.initToolbox();};ModalHtmlConfig.prototype.initToolbox=function(){var $toolboxGroup=$('<div class="btn-group" role="group">').appendTo(this.$toolboxCtn);TOOLBOX.forEach(function(row){var labelClass=tags[row];var labelIns;if(typeof labelClass!=='function'){console.warn(I18n.resource.dashboard.modalJumpPages.NO_LABLE+row);return;}
labelIns=new labelClass(_this);labelIns.render($toolboxGroup);});var $tools=$('.btn',$toolboxGroup);$toolboxGroup.on('click','.btn',function(){$(this).toggleClass('btn-primary');});};ModalHtmlConfig.prototype.recoverForm=function(form){var _this=this;var options;if(!form||!form.option){this.addDsFormGroup();return;}
options=form.option;var arrId=[];form.points.forEach(function(row){arrId.push(row);});var arrItem=AppConfig.datasource.getDSItemById(arrId);form.points.forEach(function(row){for(var m=0;m<arrItem.length;m++){if(row==arrItem[m].id){var $ele=_this.addDsFormGroup({id:row,cls:' dropped',value:row,name:arrItem[m].alias||'未找到名称',display:'inline'});break;}}});this.addDsFormGroup();this._setField('textarea',this.$textarea,options.html);};ModalHtmlConfig.prototype.reset=function(){this.$dsGroupList.empty();this._setField('textarea',this.$textarea);};ModalHtmlConfig.prototype.addDsFormGroup=function(data){if(data===undefined){data={id:I18n.resource.dashboard.modalJumpPages.PARAM_INTRO,cls:'',value:'',name:'<span class="glyphicon glyphicon-plus"></span>'}}
return $('<div class="form-group{cls}">\
                <label class="col-md-2 control-label" for="">Point</label>\
                <div class="col-md-4">\
                    <div class="label-area div-ds-id">{id}</div>\
                </div>\
                <div class="col-md-4">\
                    <div class="drop-area div-ds-point" data-value="{value}">\
                        {name}\
                    </div>\
                </div>\
                <div class="col-md-2">\
                    <div class="opt-icon-area">\
                        <span class="glyphicon glyphicon-remove"></span>\
                    </div>\
                </div>\
            </div>'.formatEL(data)).appendTo(_this.$dsGroupList);};ModalHtmlConfig.prototype.initLinkFormGroup=function(){var arrHtml=[];for(var i in AppConfig.menu){if(!AppConfig.menu.hasOwnProperty(i))continue;arrHtml.push('<div class="form-group">\
                    <label class="col-md-2 control-label" for="">Link</label>\
                    <div class="col-md-4">\
                        <div class="label-area">{id}</div>\
                    </div>\
                    <div class="col-md-4"><div class="label-area">{name}</div></div>\
                </div>'.formatEL({id:i,name:AppConfig.menu[i]}));}
return this.$linkGroupList.html(arrHtml.join(''));};ModalHtmlConfig.prototype.onDropActionPerformed=function(e){$(e.target).removeClass('on');var itemId=EventAdapter.getData().dsItemId;var isNotShowMsg=true;if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){addPointDrag(itemId[i]);}}else{addPointDrag(itemId);}
if(isNotShowMsg){alert(I18n.resource.dashboard.modalJumpPages.DATA_EXIST);return false;}
function addPointDrag(itemId){var $target=$('.drop-area[data-value=""]');_this._setField('droparea',$target,itemId);var dsId=$target[0].dataset.value;var $formGroup=$target.closest('.form-group');if(_this.$dsGroupList.find('[data-value="'+dsId+'"]').length>1){_this._setField('droparea',$formGroup.find('.drop-area'));}else{$formGroup.addClass('dropped');$formGroup.find('.label-area').text(dsId);isNotShowMsg=false;_this.addDsFormGroup();}}
e.stopPropagation();};ModalHtmlConfig.prototype.attachEvents=function(){var _this=this;this.$modal.on('show.bs.modal',function(){_this.initLinkFormGroup();});this.$wrap.on('click','.opt-icon-area',function(e){$(this).closest('.form-group').remove();});this.$btnResizeFull.off().click(function(){var height=_this.$modal.height();_this.$modal.addClass('maxium-screen');_this.$textarea.height(height-208);});this.$btnResizeSmall.off().click(function(){_this.$modal.removeClass('maxium-screen');_this.$textarea.height('auto');});this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var form={};var html;var toolboxStr,pattern,match;html=form.html=_this.$textarea.val();modal.points=[];_this.$dsGroupList.find('.dropped .drop-area').each(function(){modal.points.push($(this)[0].dataset.value);});toolboxStr=TOOLBOX.join('|');pattern=new RegExp(PATTERN_STR,'ig');while((match=pattern.exec(html))!==null){try{var dom=$(match[0])[0];}catch(e){continue;}
tags[match[1]].save(dom.dataset,modal);}
pattern=new RegExp('<%([^,<>%]+).*?%>','mg');while((match=pattern.exec(html))!==null){if(modal.points.indexOf(match[1])===-1){modal.points.push(match[1]);}}
modal.option=form;modal.dsChartCog=[{accuracy:2}];modal.interval=60000;_this.$modal.modal('hide');modalIns.preview();e.preventDefault();});this.$textarea[0].addEventListener("dragover",function(event){event.preventDefault();});this.$textarea[0].addEventListener("drop",function(event){event.preventDefault();var itemId=EventAdapter.getData().dsItemId;if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){dotIsExist(itemId[i]);}}else{dotIsExist(itemId);}
function dotIsExist(itemId){var dropAreaList=$('.drop-area',_this.$wrap);var lens=dropAreaList.length;var isExist=false;for(var j=0;j<lens;j++){if(dropAreaList.eq(j).attr('data-value')===itemId){isExist=true;}}
if(!isExist){var text='<%'+itemId+'%>';insertText(event.target,text);}else{return false;}}
_this.$wrap.find('.drop-area[data-value=""]').trigger('drop',true);});function insertText(obj,str){if(typeof obj.selectionStart==='number'&&typeof obj.selectionEnd==='number'){var startPos=obj.selectionStart,endPos=obj.selectionEnd,cursorPos=startPos,tmpStr=obj.value;obj.value=tmpStr.substring(0,startPos)+str+tmpStr.substring(endPos,tmpStr.length);cursorPos+=str.length;obj.selectionStart=obj.selectionEnd=cursorPos;}else{obj.value+=str;}}};return ModalHtmlConfig;}());this.ModalHtml=(function(ToolTipMixin){function ModalHtml(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.promise=$.Deferred();this.firstUpdateData=null;this.lastUpdateTimeTick=null;this.customTags={};this.initCustomVaribles();}
ModalHtml.prototype=Object.create(ModalBase.prototype);ModalHtml.prototype.constructor=ModalHtml;ModalHtml.prototype=Mixin(ModalHtml.prototype,ToolTipMixin);ModalHtml.prototype.optionTemplate={name:'toolBox.modal.MODAL_HTML',parent:0,mode:'custom',maxNum:10,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,defaultHeight:4.5,defaultWidth:3,type:'ModalHtml'};ModalHtml.prototype.initCustomVaribles=function(){var container=this.container;var screen;window.__spring_html_modal[this.entity.id]=this.customVaribles={};this.customVaribles.dataMap={};var arrParams=window.location.hash.split('&');if(arrParams&&arrParams.length>0){for(var i=0;i<arrParams.length;i++){if(arrParams[i].indexOf('response=')>-1){this.customVaribles.dataParams=arrParams[i];}}}
this.customVaribles.linkTo=function(menuId,ctnSelector,linkType,linkName,linkParams){var $ev,ctn;if(!ctnSelector&&!linkType){$ev=$('#ulPages [pageid="'+menuId+'"]');if($ev.length>0){if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');if(linkParams){window.location.hash=window.location.hash+'&response='+linkParams;}
return;}}
if(ctnSelector){ctn=document.querySelector(ctnSelector);if(!ctn)return;ctn.innerHTML='';if(screen){screen.close();screen=null;}}
linkType=linkType||'EnergyScreen';switch(linkType){case'EnergyScreen_M':case'EnergyScreen':if(!ctn){if(!AppConfig.isMobile){ScreenManager.show(EnergyScreen,menuId);}else{var isIndex=linkType=='EnergyScreen_M';router.to({typeClass:ProjectDashboard,data:{menuId:menuId,isIndex:isIndex,name:linkName}})}}else{screen=new EnergyScreen();screen.id=menuId;screen.container=ctn;screen.isForBencMark=true;screen.init();}
break;case'ObserverScreen':if(!ctn){ScreenManager.show(ObserverScreen,menuId);}else{screen=new ObserverScreen(menuId);ctn.innerHTML='<div class="divMain" style="width: 100%; height: 100%;">\
                                    <div class="div-canvas-ctn" style="padding: 0; margin: 0 auto; height: 100%; width: 100%;">\
                                        <canvas class="canvas-ctn" style="width: 100%; height: 100%;">浏览器不支持</canvas>\
                                    </div>\
                                    <div id="divObserverTools" style="height: 0"></div>\
                                </div>';screen.isInDashBoard=true;screen.show(ctn);}
break;case'FacReportScreen':if(!ctn){ScreenManager.goTo({page:'observer.screens.FacReportScreen',options:{id:menuId},container:'indexMain'});}
break;case'FacReportWrapScreen':if(!ctn){if(AppConfig.isMobile){router.to({typeClass:MessageFactoryReport,data:{}})}else{ScreenManager.goTo({page:'observer.screens.FacReportWrapScreen',options:{id:menuId},container:'indexMain',response:linkParams});}}
break;default:return;}};};ModalHtml.prototype.initCustomTags=function(doc){var _this=this;doc=doc||document;TOOLBOX.forEach(function(row,i){var $tagEle=$(row,doc);var thisTags=[];var staticHtmlRender;if(!$tagEle.length)return;if(typeof(staticHtmlRender=tags[row].getStaticRender)!=='function')return;([]).forEach.call($tagEle,function(rowt,t){var $rs=staticHtmlRender(rowt);if(!$rs)return;thisTags.push($rs);$(rowt).replaceWith($rs);});if(thisTags.length)_this.customTags[row]=thisTags;});};ModalHtml.prototype.initCustomAttrs=function(){var _this=this;var $container=$(this.container);var energyScreen;$container.on('click','[data-link-to]',function(e){var linkType=this.dataset['linkType'];var ctnSelector=this.dataset['linkTarget'];var menuId=this.dataset['linkTo'];var linkName=this.dataset['linkName'];var linkParams=this.dataset['linkParams'];try{linkParams=JSON.parse(linkParams);}catch(e){}
_this.customVaribles.linkTo(menuId,ctnSelector,linkType,linkName,linkParams);e.preventDefault();});};ModalHtml.prototype._parseOptionStr=function(optionStr){var arr=optionStr.split(',');var opt={};arr.forEach(function(kv){var kvArr=kv.split('=');if(kvArr.length===1){opt[kv]='true';}else{opt[kvArr[0]]=kvArr[1];}});return opt;};ModalHtml.prototype._formatNumber=function(num,options){var rs='';var toString=Object.prototype.toString;var decimalPortion;var numstr,isNegative;if(isNaN(num))return num;num=parseFloat(num);isNegative=num<0;num=Math.abs(num);if(!isNaN(options.p)){options.p=parseInt(options.p);num=num.toFixed(options.p);}
decimalPortion=(num+'').split('.')[1]||'';num=parseInt(num);if(options.ts==='true'){numstr=num+'';while(numstr.length>3){rs=','+numstr.substr(-3,3)+rs;numstr=numstr.substr(0,numstr.length-3);}
rs=numstr+rs;}else{rs=num+'';}
rs=decimalPortion===''?rs:(rs+'.'+decimalPortion);if(parseFloat(rs)===0){return rs;}
return(isNegative?'-':'')+rs;};ModalHtml.prototype._formatNode=function(node,options,params){var domWrap;if(options.draggable&&!node.parentNode.dataset.h5DraggableNode){domWrap=document.createElement('span');domWrap.draggable='true';domWrap.dataset.h5DraggableNode='true';domWrap.dataset.dsId=params.dsId||'';node.parentNode.insertBefore(domWrap,node);domWrap.appendChild(node);}};ModalHtml.prototype.setToolTip=function(node,params){var domWrap;if(node.parentNode.dataset.h5DraggableNode==='true'){domWrap=node.parentNode;}else{domWrap=document.createElement('span');domWrap.dataset.dsId=params.dsId||'';domWrap.dataset.h5DraggableNode='true';node.parentNode.insertBefore(domWrap,node);domWrap.appendChild(node);}
this.initTooltip({shape:domWrap,ds:params.dsId,container:this.screen.container,clickable:AppConfig.isFactory===0});};ModalHtml.prototype.buildDsBinding=function(){var _this=this;var dataMap=this.customVaribles.dataMap={};var $container=$(this.container);var ds=dataMap;var textNodeMap={},attrNodeMap={};var dsNameList=this.entity.modal.points;var $textNodes=$container.find('.text-node-placeholder');var $attrNodes=$container.find('[data-inner-ds-info]');dsNameList.forEach(function(name){var $nodes;if(($nodes=$textNodes.filter('[data-name^="'+name+'"]')).length){$nodes.each(function(){var nodeDataName=$(this).attr('data-name');if(nodeDataName.split(',')[0]!==name)return;var text=document.createTextNode('');if(!textNodeMap[name]){textNodeMap[name]=[{name:this.getAttribute('data-name'),node:text}];}else{textNodeMap[name].push({name:this.getAttribute('data-name'),node:text});}
this.parentNode.replaceChild(text,this);});}else{textNodeMap[name]=[];}
if(($nodes=$attrNodes.filter('[data-inner-ds-info*="'+name+'"]')).length){$nodes.each(function(){var $this=$(this);var attr=$this.data('ds.attr');var info=$this.data('ds.info');if(attr===undefined){$this.data('ds.attr',(attr=this.getAttribute('data-inner-ds-attr')));}
if(info===undefined){info=window.decodeURIComponent(this.getAttribute('data-inner-ds-info'));$this.data('ds.info',(info=JSON.parse(info)));}
if(!attrNodeMap[name]){attrNodeMap[name]=[{node:this.getAttributeNode(attr),info:info}]}else{attrNodeMap[name].push({node:this.getAttributeNode(attr),info:info});}});}else{attrNodeMap[name]=[];}
if(!ds.__observerProps)ds.__observerProps={};if(!ds.__observerProps.hasOwnProperty(name)){ds.__observerProps[name]=null;Object.defineProperty(ds,name,{get:function(){return this.__observerProps[name];},set:function(value){if(value===this.__observerProps[name])return;this.__observerProps[name]=value;textNodeMap[name].forEach(function(row){var content=row.name;var node=row.node;var idx=content.indexOf(',');var options;if(idx>-1){options=_this._parseOptionStr(content.substr(idx+1));node.data=_this._formatNumber(value,options);_this._formatNode(node,options,{dsId:content.substr(0,idx)});}else{node.data=isNaN(value)?_this._decodeHtml(value):parseFloat(value).toString();}
if(!isNaN(value)&&!AppConfig.isMobile){_this.setToolTip(node,{dsId:idx>-1?content.substr(0,idx):content});}});attrNodeMap[name].forEach(function(row){var info=row.info;var str='';info.forEach(function(row){var idx;if(row.type===TextTemplateParser.types.text){str+=row.value;}else if(row.type===TextTemplateParser.types.binding){if(row.value.indexOf(name)>-1){idx=row.value.indexOf(',');if(idx>-1){row.content=_this._formatNumber(value,_this._parseOptionStr(row.value.substr(idx+1)));}else{row.content=isNaN(value)?value:parseFloat(value).toString();}}
str+=row.content;}});row.node.value=str;});}});}});$attrNodes.each(function(){this.removeAttribute('data-inner-ds-info');this.removeAttribute('data-inner-ds-attr');});};ModalHtml.prototype._decodeHtml=function(html){var txt=document.createElement("textarea");txt.innerHTML=html;return txt.value;};ModalHtml.prototype.renderModal=function(){var _this=this;var options=this.entity.modal.option;var info;var parser=TextTemplateParser;if(!options){$(this.container).html('');this.spinner.stop();return;}
info=this.getFormatHtml(options.html);info.html=info.html.replace(/([\w-]+?)="([^"]*<%[^<>]+?%>[^"]*)"/mg,function($0,$1,$2){var tokens=parser.parse($2,['<%','%>']);var infoStr;tokens.forEach(function(row){if(row.type===parser.types.binding){row.content='';}});infoStr=window.encodeURIComponent(JSON.stringify(tokens));return $1+'="" data-inner-ds-info="'+infoStr+'" data-inner-ds-attr="'+$1+'"';});info.html=info.html.replace(/<%(.+?)%>/mg,function($0,$1){return'<span class="text-node-placeholder" data-name="'+$1+'">'+$1+'</span>';});$(this.container).html(info.html);runScript(info.scriptContent);_this.initCustomTags();_this.initCustomAttrs();_this.buildDsBinding();if(typeof _this.customVaribles.onRenderComplete==='function'){_this.customVaribles.onRenderComplete.call(null);}
_this.promise.done(function(data){if(!data)return;_this.updateModal(data);});_this.promise.resolve(_this.firstUpdateData);_this.spinner.stop();};ModalHtml.prototype.updateModal=function(data){var _this=this;var modal,updateInterval,options,now;var thisTags;var dataMap=this.customVaribles.dataMap;var customEventHandlers;if(this.promise.state()==='pending'){this.firstUpdateData=data;return;}
modal=this.entity.modal;updateInterval=modal.interval;options=this.entity.options;nowTick=new Date().valueOf();data.forEach(function(row){dataMap[row.dsItemId]=row.data;});for(var tagName in this.customTags){if(!this.customTags.hasOwnProperty(tagName))continue;thisTags=this.customTags[tagName];thisTags.forEach(function($row,i){var handler=tags[tagName].getRealTimeRender;if(typeof handler!=='function')return;handler($row,dataMap);});}
if(typeof this.customVaribles.onUpdateComplete==='function'){this.customVaribles.onUpdateComplete.call(null,dataMap);}};ModalHtml.prototype.showConfigMode=function(){};ModalHtml.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalHtml.prototype.configModal=new ModalHtmlConfig();ModalHtml.prototype.getFormatHtml=function(html){var _this=this;var patternScript=/(<script\b[^>]*>)([\s\S]*?)(<\/script>)/img;var scriptContent=[];var wrapTpl='(function() { |code| }).call(window.__spring_html_modal[\''+_this.entity.id+'\'])';var formatHtml=html.replace(patternScript,function($0,$1,$2,$3){if($2.trim()!=='')scriptContent.push($2);return'';});return{scriptContent:wrapTpl.replace('|code|',scriptContent.join(';\n')),html:formatHtml};};ModalHtml.prototype.preview=function(){};ModalHtml.prototype.close=function(){this.container.innerHTML='';};return ModalHtml;}(namespace('mixins.TooltipMixin')));var TextTemplateParser=(function(){function TextTemplateParser(){}
TextTemplateParser.types={text:0,binding:1};TextTemplateParser.parse=function(template,delimiters){var index,lastIndex,lastToken,length,substring,tokens,value;tokens=[];length=template.length;index=lastIndex=0;while(lastIndex<length){index=template.indexOf(delimiters[0],lastIndex);if(index<0){tokens.push({type:this.types.text,value:template.slice(lastIndex)});break;}else{if(index>0&&lastIndex<index){tokens.push({type:this.types.text,value:template.slice(lastIndex,index)});}
lastIndex=index+delimiters[0].length;index=template.indexOf(delimiters[1],lastIndex);if(index<0){substring=template.slice(lastIndex-delimiters[0].length);lastToken=tokens[tokens.length-1];if((lastToken!==undefined?lastToken.type:void 0)===this.types.text){lastToken.value+=substring;}else{tokens.push({type:this.types.text,value:substring});}
break;}
value=template.slice(lastIndex,index).trim();tokens.push({type:this.types.binding,value:value});lastIndex=index+delimiters[1].length;}}
return tokens;};return TextTemplateParser;}());}).call(this);var ModalChartCustomConfig=(function($,window,undefined){function ModalChartCustomConfig(options){ModalConfig.call(this,options);this.m_bIsRealTime=true;this.m_bIsHisFixCycle=true;}
ModalChartCustomConfig.prototype=Object.create(ModalConfig.prototype);ModalChartCustomConfig.prototype.constructor=ModalChartCustomConfig;ModalChartCustomConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalChartCustom.html'};ModalChartCustomConfig.prototype.init=function(){var _this=this;_this.$btnSubmit=$('#btnSubmit',_this.$wrap);_this.$editor=$('#editor',_this.$wrap);_this.$selectMode=$('#inputMode',_this.$wrap);_this.$selRealInterval=$('#selRealInterval',_this.$wrap);_this.$tmStart=$('#timeStart',_this.$wrap);_this.$tmEnd=$('#timeEnd',_this.$wrap);_this.$tmGroup=$('#rangeSel',_this.$wrap);_this.$divRealtmCycle=$('#divRealTimeCycle',_this.$wrap);_this.$selectHisCycleMode=$('#hisCycleMode',_this.$wrap);_this.$selectHisInterval=$('#selHisInterval',_this.$wrap);_this.$divHisTmRange=$('#historyTmRange',_this.$wrap);_this.$divHisTmCycle=$('#historyTmCycle',_this.$wrap);_this.$inputPeriodVal=$('#inputPeriodValue',_this.$wrap);_this.$selPeriUnit=$('#inputPeriodUnit',_this.$wrap);var modal=_this.options.modalIns.entity.modal;EventAdapter.on($(_this.$editor[0]),'drop',function(e){e.preventDefault();this.focus();var itemId=EventAdapter.getData().dsItemId;if(Boolean(itemId)){if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){var itemName=AppConfig.datasource.getDSItemById(itemId[i]).alias;dropTextInter(itemId[i],itemName);}}else{var itemName=AppConfig.datasource.getDSItemById(itemId).alias;dropTextInter(itemId,itemName);}
function dropTextInter(itemId,itemName){var spanCtl=$('<span id="'+itemId+'" title="'+itemName+'" class="pointValue"></span>');spanCtl.text('"<%'+itemName+'%>"');var sel,range;if(window.getSelection){sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var insertDiv=$('<div>');insertDiv.append('&nbsp;');insertDiv.append(spanCtl);insertDiv.append('&nbsp;');var el=insertDiv[0];var frag=document.createDocumentFragment(),node,lastNode;while((node=el.firstChild)){lastNode=frag.appendChild(node);}
range.insertNode(frag);if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range);}}}
_this.$editor.append('&nbsp;');}}});EventAdapter.on($(_this.$editor[0]),'dragover',function(e){e.preventDefault();});if(Boolean(modal.option)){if(!modal.option.isRealTime){_this.m_bIsRealTime=false;_this.$selectMode.val('history');_this.$tmGroup.css('display','block');_this.$divRealtmCycle.css('display','none');}
else{_this.m_bIsRealTime=true;_this.$selectMode.val('realTime');_this.$tmGroup.css('display','none');_this.$divRealtmCycle.css('display','block');}
if(!modal.option.isHisFixCycle){_this.m_bIsHisFixCycle=false;_this.$selectHisCycleMode.val('recent');_this.$divHisTmRange.css('display','none');_this.$divHisTmCycle.css('display','block');}
else{_this.m_bIsHisFixCycle=true;_this.$selectHisCycleMode.val('fixed');_this.$divHisTmRange.css('display','block');_this.$divHisTmCycle.css('display','none');}
switch(modal.interval){case'm1':case'm5':case'h1':case'd1':case'M1':_this.$selRealInterval.val(modal.interval);_this.$selectHisInterval.val(modal.interval);break;default:_this.$selRealInterval.val('h1');_this.$selectHisInterval.val('h1');break;}
_this.$tmStart.val(modal.option.timeStart);_this.$tmEnd.val(modal.option.timeEnd);_this.$inputPeriodVal.val(modal.option.timeCycleValue);if(!modal.option.timeCycleUnit){_this.$selPeriUnit.val(modal.option.timeCycleUnit);}
else{_this.$selPeriUnit.val('hour');}}
else{_this.$selectMode.val('realTime');_this.$tmGroup.css('display','none');}
_this.$selectMode.change(function(e){var flag=$(e.currentTarget).val();if('history'==flag){_this.$tmGroup.css('display','block');_this.m_bIsRealTime=false;_this.$divRealtmCycle.css('display','none');}
else{_this.m_bIsRealTime=true;_this.$tmGroup.css('display','none');_this.$divRealtmCycle.css('display','block');}});_this.$selectHisCycleMode.change(function(e){var $opt=_this.$selectHisInterval.children('option');var flag=$(e.currentTarget).val();if('fixed'==flag){_this.m_bIsHisFixCycle=true;$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$divHisTmRange.css('display','block');_this.$divHisTmCycle.css('display','none');}
else{_this.m_bIsHisFixCycle=false;_this.$selPeriUnit.change();_this.$divHisTmRange.css('display','none');_this.$divHisTmCycle.css('display','block');}});_this.$selPeriUnit.change(function(e){var $opt=_this.$selectHisInterval.children('option');$opt.eq(0).css('display','none');var flag=$(e.currentTarget).val();switch(flag){case'hour':$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','none');$opt.eq(4).css('display','none');_this.$selectHisInterval.val('m5');break;case'day':$opt.eq(1).css('display','none');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','none');_this.$selectHisInterval.val('h1');break;case'month':$opt.eq(1).css('display','none');$opt.eq(2).css('display','none');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$selectHisInterval.val('d1');break;default:break;}});if(!_this.m_bIsHisFixCycle){_this.$selPeriUnit.change();}
$(".form_datetime").datetimepicker('remove');$(".form_datetime").datetime();_this.attachEvents();I18n.fillArea($('#modalCustom'));};ModalChartCustomConfig.prototype.recoverForm=function(modal){if(Boolean(modal.modalText)){this.$editor.html(modal.modalText);}};ModalChartCustomConfig.prototype.reset=function(){};ModalChartCustomConfig.prototype.attachEvents=function(){var _this=this;_this.$btnSubmit.off().click(function(e){var modal=_this.options.modalIns.entity.modal;var customOption=$('#modalCustom').find('#editor');modal.modalText=customOption.html();modal.modalTextUrl=customOption.text();modal.option=new Object();modal.option.list=[];modal.points=[];var arraySpan=customOption.find('.pointValue');for(var i=0,len=arraySpan.length;i<len;i++){modal.option.list.push({dsItemId:arraySpan[i].id,name:arraySpan[i].title,data:0});modal.points.push(arraySpan[i].id);}
modal.interval=_this.m_bIsRealTime?_this.$selRealInterval.val():_this.$selectHisInterval.val();modal.option.isRealTime=_this.m_bIsRealTime;modal.option.isHisFixCycle=_this.m_bIsHisFixCycle;if(_this.m_bIsHisFixCycle){modal.option.timeStart=_this.$tmStart.val();modal.option.timeEnd=_this.$tmEnd.val();}
else{var tmStart=new Date();var tmEnd=new Date();var periodVal=parseInt(_this.$inputPeriodVal.val());var periodUnit=_this.$selPeriUnit.val();switch(periodUnit){case'hour':var time=tmEnd.getTime()-3600000*periodVal;tmStart.setTime(time);break;case'day':var time=tmEnd.getTime()-86400000*periodVal;tmStart.setTime(time);break;case'month':var month=tmEnd.getMonth();if(0==month){tmStart.setFullYear(tmEnd.getFullYear()-1);tmStart.setMonth(11);}
else{tmStart.setMonth(month-1);}
break;default:break;}
modal.option.timeStart=tmStart.format('yyyy-MM-dd HH:mm:ss');modal.option.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:ss');modal.option.timeCycleValue=_this.$inputPeriodVal.val();modal.option.timeCycleUnit=_this.$selPeriUnit.val();}
_this.$modal.modal('hide');e.preventDefault();});};return ModalChartCustomConfig;}(jQuery,window));var ModalChartCustom=(function(){function ModalChartCustom(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalChartCustom.prototype=new ModalBase();ModalChartCustom.prototype.optionTemplate={name:'toolBox.modal.CUSTOM_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalChartCustom'};ModalChartCustom.prototype.show=function(){this.init();}
ModalChartCustom.prototype.init=function(){}
ModalChartCustom.prototype.renderModal=function(e){var _this=this;var optList=_this.modal.option.list;if(!optList){_this.spinner.stop();return;}
var len=optList.length;if(len>0){if(_this.modal.option.isRealTime){var postData={'dataSourceId':0,'dsItemIds':_this.modal.points};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(res){var data=res.dsItemList;if(!data){return;}
if(data.length>0){for(var i=0,len=data.length;i<len;i++){for(var j=0,len2=optList.length;j<len2;j++){if(optList[j].dsItemId==data[i].dsItemId){optList[j].data=parseFloat(parseFloat(data[i].data).toFixed(2));break;}}}
_this.updateModal(data);}}).always(function(e){_this.spinner.stop();});}
else{WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:_this.modal.points,timeStart:new Date(_this.modal.option.timeStart).format('yyyy-MM-dd HH:mm:00'),timeEnd:new Date(_this.modal.option.timeEnd).format('yyyy-MM-dd HH:mm:00'),timeFormat:'m5'}).done(function(dataSrc){if(!dataSrc||dataSrc.timeShaft.length<=0){return;}
_this.updateHistoryChart(dataSrc.list,dataSrc.timeShaft);}).error(function(e){}).always(function(e){_this.spinner.stop();});}}
else{try{var showOption=eval('({'+_this.modal.modalTextUrl+'})');_this.drawChart(showOption);_this.spinner.stop();}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.updateModal=function(src){if(this.modal.option.isRealTime){this.updateRealTimeChart(src);}}
ModalChartCustom.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();}
ModalChartCustom.prototype._showConfig=function(){}
ModalChartCustom.prototype.setModalOption=function(option){}
ModalChartCustom.prototype.drawChart=function(chartOption){this.chart.setOption(chartOption);}
ModalChartCustom.prototype.close=function(){}
ModalChartCustom.prototype.updateRealTimeChart=function(src){var _this=this;if(!src){return;}
if(src.length>0){var optList=_this.modal.option.list;for(var m=0,lenM=optList.length;m<lenM;m++){for(var n=0,lenN=src.length;n<lenN;n++){if(optList[m].dsItemId==src[n].dsItemId){optList[m].data=src[n].data;break;}}}
var showOption=_this.modal.modalTextUrl;var arr=showOption.split('<%');for(var j=1,len2=arr.length;j<len2;j++){var name=arr[j].split('%>')[0];if(''==name){continue;}
var data=-1;for(var k=0,len3=optList.length;k<len3;k++){if(optList[k].name==name){data=optList[k].data;break;}}
if(-1!=data&&Boolean(data)){if('object'==typeof(data)){var temp;for(var p=0,lenP=data.length;p<lenP;p++){temp+=data[p]+',';}
showOption=showOption.replace(name,temp);}
else{showOption=showOption.replace(name,data);}}}
showOption=showOption.replace(/"<%/g,'');showOption=showOption.replace(/%>"/g,'');try{showOption=eval('({'+showOption+'})');_this.drawChart(showOption);}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.updateHistoryChart=function(list,timeShaft){var _this=this;if(!list){return;}
if(list.length>0){var infoList=[];var arrId=[];for(var i=0,len=list.length;i<len;i++){arrId.push(list[i].dsItemId);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=list.length;i<len;i++){var id=list[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var itemName=arrItem[m].alias;var item={id:id,name:itemName,data:list[i].data};infoList.push(item);break;}}}
var showOption=_this.modal.modalTextUrl;var arr=showOption.split('<%');for(var j=1,len2=arr.length;j<len2;j++){var name=arr[j].split('%>')[0];if(''==name){continue;}
var data;for(var k=0,len3=infoList.length;k<len3;k++){if(infoList[k].name==name){data=infoList[k].data;break;}}
if(Boolean(data)){if('object'==typeof(data)){var temp='';for(var p=0,lenP=data.length-1;p<lenP;p++){temp+=data[p]+',';}
temp+=data[lenP-1];showOption=showOption.replace(name,temp);}
else{showOption=showOption.replace(name,data);}}}
showOption=showOption.replace(/"<%/g,'');showOption=showOption.replace(/%>"/g,'');try{showOption=eval('({'+showOption+'})');if(!showOption.xAxis||0==showOption.xAxis.length){var arrAxis=[{type:'category',boundaryGap:false,data:timeShaft}];showOption.xAxis=arrAxis;}
else if(!showOption.xAxis[0].data||0==showOption.xAxis[0].data.length){showOption.xAxis[0].data=timeShaft;}
_this.drawChart(showOption);}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.configModal=new ModalChartCustomConfig();return ModalChartCustom;})();var ModalPointKpiGrid=(function(){var _this;function ModalPointKpiGrid(data,dateCycle){if(Boolean(data)){this.m_kpiDataTree=data;this.m_dateCycle=dateCycle;this.m_selectYear=0;this.m_htmlPage;this.m_htmlTreeTemp;this.m_htmlGridTemp;this.m_bIsCurrentYear=false;this.m_nCurrentSeason=0;this.m_nCurrentMonth=0;this.m_strGood='达标';this.m_strBad='未达标';this.m_strCurrentGood='当前达标';this.m_strCurrentBad='当前超标';this.m_strCurrentWarn='警戒';this.m_nStartYear=0;this.m_nEndYear=0;_this=this;}}
ModalPointKpiGrid.prototype=new ModalPointKpiGrid();ModalPointKpiGrid.prototype.show=function(){this.init();}
ModalPointKpiGrid.prototype.init=function(){WebAPI.get('/static/views/observer/widgets/modalPointKpiGrid.html').done(function(resultHtml){_this.m_htmlPage=$(resultHtml);var timeControl=_this.m_htmlPage.find('#timeSelect');var tmNow=new Date();var tmStart=new Date();tmStart.setFullYear(tmNow.getFullYear()-10);_this.m_nStartYear=tmStart.getFullYear();_this.m_nEndYear=tmNow.getFullYear();timeControl.val(tmNow.format('yyyy'));timeControl.datetimepicker({format:'yyyy',startView:'decade',minView:'decade',autoclose:true,todayBtn:false,pickerPosition:'bottom-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){_this.m_selectYear=timeControl.val();var tmNow=new Date();var nCurYear=tmNow.getFullYear();if(nCurYear==_this.m_selectYear){_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;}
else{_this.m_bIsCurrentYear=false;}
_this.postDataShow(false);});var yearPre=_this.m_htmlPage.find('#btnYearPre');if(Boolean(yearPre)){yearPre.click(function(e){var year=parseInt(timeControl.val());if(year<=_this.m_nStartYear){year=_this.m_nStartYear;return;}
else{year-=1;}
timeControl.val(year);_this.timeSetting(timeControl.val());_this.postDataShow(false);});}
var yearNext=_this.m_htmlPage.find('#btnYearNext');if(Boolean(yearNext)){yearNext.click(function(e){var year=parseInt(timeControl.val());if(year>=_this.m_nEndYear){year=_this.m_nEndYear;return;}
else{year+=1;}
timeControl.val(year);_this.timeSetting(timeControl.val());_this.postDataShow(false);});}
var tmNow=new Date();_this.m_selectYear=tmNow.getFullYear();_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;_this.postDataShow(true);}).always(function(){});}
ModalPointKpiGrid.prototype.postDataShow=function(bIsFirst){var ptPassArray=[];ptPassArray=_this.recursiveTreeGetPointPassId(_this.m_kpiDataTree);var tmStart=new Date();tmStart.setMonth(0);tmStart.setDate(1);tmStart.setHours(0);tmStart.setMinutes(0);tmStart.setSeconds(0);var tmEnd=new Date();if(!bIsFirst&&tmStart.getFullYear()!=_this.m_selectYear){tmStart.setFullYear(_this.m_selectYear);tmEnd.setFullYear(_this.m_selectYear);tmEnd.setMonth(11);tmEnd.setDate(31);tmEnd.setHours(23);tmEnd.setMinutes(59);tmEnd.setSeconds(59);}
var postData={};postData.dataSourceId='';postData.dsItemIds=ptPassArray;postData.timeStart=tmStart.format('yyyy-MM-dd hh:mm:ss');postData.timeEnd=tmEnd.format('yyyy-MM-dd hh:mm:ss');postData.timeFormat='M1';if(bIsFirst){Spinner.spin($('#paneCenter')[0]);}
else{Spinner.spin(_this.m_htmlPage[2]);}
var tree=_this.m_htmlPage.find('#treeCtl');tree.html('');var table=_this.m_htmlPage.find('#tableCtl');table.html('');WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(res){if(!res||!res.list){return;}
for(var i=0,len=res.list.length;i<len;i++){_this.recursiveTreeSetPointPassData(_this.m_kpiDataTree,res.list[i].dsItemId,res.list[i].data);}
var divContain=$('<div style="cursor:pointer"></div>');divContain.append('<ul class="kpiGridHeader" style="height:32px;margin-bottom:0px"></ul>');tree.append(divContain);var head=$('<thead class="kpiGridHeader"></thead>');var headTr=$('<tr></tr>');if('season'==_this.m_dateCycle){for(var i=0;i<4;i++){var headTh=$('<th colspan="3" class="colSeason">'+(i+1)+'季度</th>');headTr.append(headTh);}
head.append(headTr);}
else if('month'==_this.m_dateCycle){headTr=$('<tr></tr>');for(var i=0;i<12;i++){var headTh=$('<th class="colMonth">'+(i+1)+'月</th>');headTr.append(headTh);}
head.append(headTr);}
table.append(head);_this.showControlInfo();if(bIsFirst){_this.m_htmlPage.modal('show');}}).always(function(){Spinner.stop();});}
ModalPointKpiGrid.prototype.showControlInfo=function(){_this.m_htmlTreeTemp=$('<div style="cursor:pointer"></div>');_this.m_htmlGridTemp=$('<tbody class="kpiGridBody"></tbody>');_this.recursiveTreeSetting(_this.m_kpiDataTree);_this.m_htmlPage.find('#treeCtl').append(_this.m_htmlTreeTemp);_this.m_htmlPage.find('#tableCtl').append(_this.m_htmlGridTemp);}
ModalPointKpiGrid.prototype.recursiveTreeSetting=function(item){var parentNode;if(''==item.parentId){parentNode=_this.m_htmlTreeTemp;}
else{parentNode=_this.m_htmlTreeTemp.find('#tree_'+item.parentId).find('.rows').eq(0);}
if(parentNode.length>0){var bLeaf=(0==item.list.length)?true:false;_this.insertTreeCtrl(item.id,item.name,parentNode,bLeaf);}
var nLen=item.pointPassData.length;if(nLen<12){for(var i=nLen,len=12-nLen;i<12;i++){item.pointPassData.push(-1);}}
nLen=12;var gridTr1=$('<tr class="kpiGridRow" id="grid1_'+item.id+'"></tr>');var gridTd1='';var nLen=item.pointPassData.length;var bIsCurrent=false;var strShow;if('season'==_this.m_dateCycle){var arrSeason=[item.pointPassData[0],item.pointPassData[3],item.pointPassData[6],item.pointPassData[9]];for(var i=0;i<4;i++){if(_this.m_bIsCurrentYear&&i==_this.m_nCurrentSeason){bIsCurrent=true;}
else{bIsCurrent=false;}
if(-1==arrSeason[i]){gridTd1+='<td colspan=3></td>';}
else if(Boolean(arrSeason[i])){strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=3 class="kpiGridGood">'+strShow+'</td>';}
else{strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=3 class="kpiGridBad">'+strShow+'</td>';}}}
else if('month'==_this.m_dateCycle){for(var i=0;i<nLen;i++){if(_this.m_bIsCurrentYear&&i==_this.m_nCurrentMonth){bIsCurrent=true;}
else{bIsCurrent=false;}
if(-1==item.pointPassData[i]){gridTd1+='<td colspan=1></td>';}
else if(Boolean(item.pointPassData[i])){strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=1 class="kpiGridGood">'+strShow+'</td>';}
else{strShow=bIsCurrent?_this.m_strCurrentBad:_this.m_strBad;gridTd1+='<td colspan=1 class="kpiGridBad">'+strShow+'</td>';}}}
gridTr1.append($(gridTd1));_this.m_htmlGridTemp.append(gridTr1);var nChildNum=item.list.length;if(0==nChildNum){}
else{for(var i=0;i<nChildNum;i++){arguments.callee(item.list[i]);}}}
ModalPointKpiGrid.prototype.recursiveTreeSetShow=function(item,nFindId,bIsShow){if(nFindId==item.id){for(var i=0,len=item.list.length;i<len;i++){item.list[i].show=bIsShow;}
return;}
else{for(var i=0,len=item.list.length;i<len;i++){arguments.callee(item.list[i],nFindId,bIsShow);}}}
ModalPointKpiGrid.prototype.recursiveTreeGetShow=function(item){var arr=[];var nLen=item.list.length;if(nLen>0){if(item.show){arr.push(item.id);for(var i=0;i<nLen;i++){var temp=arguments.callee(item.list[i]);arr=arr.concat(temp);}}}
else{if(item.show){return[item.id];}}
return arr;}
ModalPointKpiGrid.prototype.recursiveTreeGetPointPassId=function(item){var arr=[];var nLen=item.list.length;if(nLen>0){if(item.show){arr.push(item.pointPass);for(var i=0;i<nLen;i++){var temp=arguments.callee(item.list[i]);arr=arr.concat(temp);}}}
else{if(item.show){return[item.pointPass];}}
return arr;}
ModalPointKpiGrid.prototype.recursiveTreeSetPointPassData=function(item,nPtPassId,ptPassData){if(nPtPassId==item.pointPass){item.pointPassData=ptPassData;return;}
else{for(var i=0,len=item.list.length;i<len;i++){arguments.callee(item.list[i],nPtPassId,ptPassData);}}}
ModalPointKpiGrid.prototype.insertTreeCtrl=function(groupId,groupName,parentNode,bIsLeaf){var $ul=$('<ul class="nav nav-list kpiTreeGroup" id="tree_'+groupId+'">');var $liHd;if(bIsLeaf){$liHd=$('<li class="kpiTreeHeader"><span style="margin-left:40px"></span></li>');}
else{$liHd=$('<li class="kpiTreeHeader"><img src="/static/images/dataSource/group_head_sel.png" alt="png" class="dsTreeHeaderIcon"></li>');}
var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);$liHd.click(function(e){var tar=$(e.currentTarget);if(Boolean(tar)){var treeItemId=tar.closest('.kpiTreeGroup')[0].id;var num=treeItemId.substring(5);var bindRow=tar.next('.rows');if(Boolean(bindRow)){var bIsShow=true;var showFlag=bindRow.eq(0).css('display');if('block'==showFlag){bIsShow=false;}
else{bIsShow=true;}
_this.recursiveTreeSetShow(_this.m_kpiDataTree,num,bIsShow);var arr=_this.recursiveTreeGetShow(_this.m_kpiDataTree);var arrGrid=[];for(var k=0,len3=arr.length;k<len3;k++){arrGrid.push('grid1_'+arr[k]);arrGrid.push('grid2_'+arr[k]);}
var body=_this.m_htmlPage.find('#tableCtl tbody tr');for(var i=0,len=body.length;i<len;i++){var trFind=false;for(var j=0,len2=arrGrid.length;j<len2;j++){if(body[i].id==arrGrid[j]){trFind=true;break;}}
if(!trFind){$(body[i]).css('display','none');}
else{$(body[i]).css('display','');}}
bindRow.slideToggle();}}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow);parentNode.append($ul);}
ModalPointKpiGrid.prototype.timeSetting=function(selYear){_this.m_selectYear=selYear;var tmNow=new Date();var nCurYear=tmNow.getFullYear();if(nCurYear==_this.m_selectYear){_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;}
else{_this.m_bIsCurrentYear=false;}}
return ModalPointKpiGrid;})();var ModalPointKPI=(function(){function ModalPointKPI(screen,entityParams){if(!entityParams)return;this.isConfigMode=false;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalPointKPI.prototype=new ModalBase();ModalPointKPI.prototype.optionTemplate={name:'toolBox.modal.POINT_KPI',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalPointKPI'};ModalPointKPI.prototype.show=function(){this.init();}
ModalPointKPI.prototype.init=function(){this.pointKPIWiki=undefined;}
ModalPointKPI.prototype.renderModal=function(e){var _this=this,tempHtml='',level=1,rootId;this.spinner&&this.spinner.stop();if(!(this.entity.modal.option&&this.entity.modal.option.kpiList))return
this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});$(this.container).append(tempHtml);function traverseTree(tree){new PointKPIItem(tree,_this,0);rootId=tree.id;traverse(tree,0);}
function traverse(node,i){var children=node.list;node.pointPassData=[];node.show=true;if(children!=null&&children.length>0){if(node.parentId==rootId){level=2;}
new PointKPIItem(children[i],_this,level);if(i==children.length-1){for(var j=0;j<children.length;j++){j==0&&level++;traverse(children[j],0);}}else{traverse(node,i+1);}}}}
ModalPointKPI.prototype.showConfigMode=function(){}
ModalPointKPI.prototype.updateModal=function(points){}
ModalPointKPI.prototype.configure=function(){var _this=this;this.spinner&&this.spinner.stop();this.isConfigMode=true;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};var $btnRemove=$('<span class="glyphicon glyphicon-remove-circle springConfigRemoveBtn"></span>');var $btnAdd=$('<span class="glyphicon glyphicon-remove-circle springConfigRemoveBtn addTree" style="transform: rotateZ(45deg);color: #333;right: 50px !important;"></span>');divMask.appendChild($btnAdd[0]);divMask.appendChild($btnRemove[0]);this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer&&(divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');if(sourceId==targetId)return;$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();if(!$sourceParent[0].classList.contains('chartsCt')&&$targetParent[0].classList.contains('chartsCt')){_this.screen.insertChartIntoMix(sourceId,$(e.target).closest('.chartsCt')[0])}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}
_this.screen.isScreenChange=true;})
var $select='<div class="form-group" style="position: absolute;top: 5px;left: 5px;">\
            <label for="inputEmail3" class="col-sm-2 control-label" style="height: 34px;line-height: 34px;">Cycle</label>\
            <div class="col-sm-8" style="display:inline-block;">\
                <select id="selectCycle" class="form-control" style="width: 100px;padding: 0;"> \
                    <option value="month">'+I18n.resource.dashboard.modalPointKPI.MONTH+'</option> \
                    <option value="season">'+I18n.resource.dashboard.modalPointKPI.QUARTER+'</option> \
                    </select>\
            </div>\
            </div>';$(this.container).append($select);var $selectCycle=$(this.container).find('#selectCycle');if(_this.entity.modal.option&&_this.entity.modal.option.dateCycle&&_this.entity.modal.option.dateCycle=='season'){$selectCycle.find('option:nth-of-type(2)')[0].selected='selected';}else{$selectCycle.find('option:nth-of-type(1)')[0].selected='selected';}
$selectCycle[0].onchange=function(){_this.entity.modal.option.dateCycle=$selectCycle[0].value;}
var $chartCt=$('<div class="divResize chartsCt gray-scrollbar" style="overflow:auto;">');$chartCt.append($(this.container));divMask.appendChild($chartCt[0]);if($('.level_2').width()>($chartCt.width()-320)){$('.domTree',$chartCt).width($('.level_2').width()+40);}
if($(this.container).find('.domTree').length==1){$btnAdd.attr('title','Already exists a root').addClass('btnDisabled');}
this.executeConfigMode();$btnRemove.off('click').on('click',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this=null;});$btnAdd.off('click').on('click',function(){if($(_this.container).find('.domTree').length==0){new PointKPIItem({parentId:''},_this,0);$('#divContainer_'+_this.entity.id).find('.addTree').attr('title','Already exists a root').addClass('btnDisabled');_this.screen.isScreenChange=true;}});}
ModalPointKPI.prototype.initContainer=function(replacedElementId){var _this=this;var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass=' gray-scrollbar';if((!divParent)||replacedElementId){isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}
else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
divParent.className='springContainer';if(AppConfig.isMobile){divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR*2+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*2+'%';}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.title&&this.entity.modal.title!=''&&(!this.entity.isNotRender)){divParent.innerHTML='<div class="panel panel-default">\
                <div class="panel-heading springHead">\
                    <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                </div>\
                <div class="panel-body springContent'+scrollClass+'" style="overflow:auto;"></div>\
            </div>';}else{divParent.innerHTML='<div class="panel panel-default" style="background: none;">\
                <div class="panel-body springContent'+scrollClass+'" style="height:100%;overflow:auto;"></div>\
            </div>';}
var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];var lkHistory=document.createElement('a');lkHistory.className='springLinkBtn';lkHistory.title='Show History';lkHistory.href='javascript:;';lkHistory.innerHTML='<span class="glyphicon glyphicon-stats"></span>';divBtnCtn.appendChild(lkHistory);lkHistory.onclick=function(){var dataTree=_this.entity.modal.option.kpiList[0];var dateCycle=!_this.entity.modal.option.dateCycle?'month':_this.entity.modal.option.dateCycle;if(Boolean(dataTree)){new ModalPointKpiGrid(dataTree,dateCycle).show();}};domPanel.appendChild(divBtnCtn);this.initToolTips(divParent.getElementsByClassName('springHead'));this.container=divParent.getElementsByClassName('springContent')[0];}
ModalPointKPI.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
return ModalPointKPI;})();var PointKPIItem=(function(){function PointKPIItem(item,entity,i){this.parentArgt=entity;this.entity=entity.entity;this.container=entity.container;this.kpiItem={id:!item.id?new Date().getTime():item.id,parentId:!item.parentId?'':item.parentId,name:!item.name?'Unaming':item.name,pointKPI:!item.pointKPI?'':item.pointKPI,pointGrade:!item.pointGrade?'':item.pointGrade,pointPass:!item.pointPass?'':item.pointPass,rule:!item.rule?'':item.rule,weight:!item.weight?'':item.weight,wikiId:!item.wikiId?'':item.wikiId,list:!item.list?[]:item.list};if(i===0&&!item.id&&item.parentId==''){!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.kpiList&&(this.entity.modal.option.kpiList=[]);this.entity.modal.option.kpiList.push(this.kpiItem);}
this.addItemDom(this.kpiItem,i)
this.attachEventsItem(this.kpiItem);}
PointKPIItem.prototype.addItem=function(id){var _this=this;var level=1;var pointKPIItem;this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(id==node.id){pointKPIItem=new PointKPIItem({parentId:id},_this.parentArgt,level);node.list.push(pointKPIItem.kpiItem);return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){j==0&&level++;traverse(children[j],0);}}else{traverse(node,i+1);}}}}
var btn_tpl='\
            <div class="btnGroup">\
                <span class="glyphicon glyphicon-remove-circle btnAddItem" style="transform: rotateZ(45deg);"></span>\
                <span class="glyphicon glyphicon-cog btnConfigItem"></span>\
                <span class="glyphicon glyphicon-info-sign btnConfigWiki"></span>\
                <span class="glyphicon glyphicon-remove-circle btnRemoveItem"></span>\
                <span class="glyphicon glyphicon-info-sign btnViewWiki{isShow}" wikiId="{wikiId}"></span>\
            </div>';PointKPIItem.prototype.tpl={treeWrap:'<div class="domTree"></div>',level_1_Tpl:'\
            <div class="totalLevel">\
                <div class="itemWrap" id="kpi_{id}">\
                    <div class="hrLine"></div>\
                    <span class="pointName">{name}</span>\
                    <span class="glyphicon glyphicon-pencil"></span>\
                    <div class="circle {bgColor}">\
                        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                        <span>{pointPassVal}</span>\
                    </div>'+btn_tpl+'</div>\
            </div>',level_2_Ctn:'\
            <div class="level_2">\
                <div class="hrLine1"></div>\
                <ul></ul>\
            </div>',level_2_Tpl:'<li class="level_3" parentId="{parentId}" id="item_{id}">\
            	<div class="thirdCon1">\
                	<div class="itemWrap" id="kpi_{id}">\
                	    <div class="circle {bgColor}">\
                	        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                	        <span>{pointPassVal}</span>\
                	    </div>\
                	    <span class="pointName">{name}</span><span class="glyphicon glyphicon-pencil"></span><br class="clear"><div class="hrLine2"></div>'+btn_tpl+'</div>\
                </div>\
                <ul class="childLevel">\
                </ul>\
            </li>',level_3_Tpl:'<li parentId="{parentId}" id="item_{id}">\
                <div class="hrLine3"></div>\
                <div class="itemWrap" id="kpi_{id}">\
                    <div class="smCircle {bgColor}">\
                        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                        <span>{pointPassVal}</span>\
                    </div>\
                    <span class="pointName">{name}</span>\
                    <span class="glyphicon glyphicon-pencil"></span><br class="clear">\
                    <div class="hrLine4"></div>'+btn_tpl+'</div>\
                <ul class="childLevel">\
                </ul>\
            </li>'}
PointKPIItem.prototype.addItemDom=function(kpiItem,i){var kpiItemForEl={id:kpiItem.id,parentId:kpiItem.parentId,name:kpiItem.name,isShow:kpiItem.wikiId!=''?' showWiki':'',pointPassVal:kpiItem.pointPass!=''?I18n.resource.dashboard.modalPointKPI.UNPASS:I18n.resource.dashboard.modalPointKPI.PASS,bgColor:kpiItem.pointPass!=''?'unpass':'pass'}
var $domTree=$(this.container).children('.domTree'),$level_2_ul,$level_3_ul;$domTree&&($level_2_ul=$domTree.find('.level_2>ul'));$level_2_ul&&($level_3_ul=$level_2_ul.find('#item_'+kpiItem.parentId+' > .childLevel'));if(kpiItem.parentId==''){$(this.container).append(this.tpl.treeWrap);$domTree=$(this.container).children('.domTree');$domTree.html(this.tpl.level_1_Tpl.formatEL(kpiItemForEl));}else if(i==1&&$domTree){if($level_2_ul.length==0){$domTree.append(this.tpl.level_2_Ctn);$level_2_ul=$domTree.find('.level_2>ul');}
if($domTree.parent().width()-$level_2_ul.width()<270){$domTree.width($domTree.width()+255);}
$level_2_ul.append(this.tpl.level_2_Tpl.formatEL(kpiItemForEl))}else if($level_2_ul){$level_3_ul.append(this.tpl.level_3_Tpl.formatEL(kpiItemForEl));if($level_3_ul.find('.itemWrap').width()<140){$level_3_ul.find('.btnAddItem').hide();}}}
PointKPIItem.prototype.removeItem=function(id){var _this=this;this.entity.modal.option.kpiList.forEach(function(kpiItem,index){if(kpiItem.id==id&&kpiItem.parentId==''){_this.entity.modal.option.kpiList.splice(index,1);$('#kpi_'+id).closest('.domTree').remove();$('#divContainer_'+_this.entity.id).find('.addTree').removeClass('btnDisabled').attr('title','');}else{traverseTree(kpiItem);}});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(children!=null&&children.length>0){if(id==children[i].id){node.list.splice(i,1);$('#kpi_'+id).closest('li').remove();return;}else{if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}}
PointKPIItem.prototype.showConfigModal=function(){var _this=this,$modalConfig=$('#modalConfig');var tempHtml='\
            <div class="modal-body" id="pointKPI">\
                <div class="form-horizontal">\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divKPI">KPI</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divKPI">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divGrade">Grade</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divGrade">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divIsPass">Is pass</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divIsPass">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divDashboard">Config dashboard</label>\
                        <div class="col-md-4">\
                            <button type="button" id="btnDashboard" class="btn btn-default">Config</button>\
                        </div>\
                    </div>\
                </div>\
            </div>';$modalConfig.off('show.bs.modal').on('show.bs.modal',function(e){var pointKPIAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointKPI).alias;var pointGradeAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointGrade).alias;var pointPassAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointPass).alias;$modalConfig.find('.modal-body').hide();$modalConfig.find('.modal-footer').before(tempHtml);$modalConfig.find('#divKPI').attr('data-value',_this.kpiItem.pointKPI).attr('title',pointKPIAlias).html(pointKPIAlias);$modalConfig.find('#divGrade').attr('data-value',_this.kpiItem.pointGrade).attr('title',pointKPIAlias).html(pointGradeAlias);$modalConfig.find('#divIsPass').attr('data-value',_this.kpiItem.pointPass).attr('title',pointKPIAlias).html(pointPassAlias);if(pointPassAlias){$modalConfig.find('#startConfig').removeClass('disabled');}
_this.parentArgt.screen.modalConfigPane.toggleDataSource(true);_this.attachEventsConfig($modalConfig)});$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$modalConfig.find('#pointKPI').remove();_this.parentArgt.screen.modalConfigPane.toggleDataSource(false);});$modalConfig.modal('show');}
PointKPIItem.prototype.viewDetail=function(){var $dialog=$('#dialogModal');var energyScreen=new EnergyScreen();var $dialogContent=$dialog.find('#dialogContent').css({height:'90%',width:'90%',margin:'auto',marginTop:'2.5%',backgroundColor:'#fff'});$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$dialogContent.removeAttr('style').html('');energyScreen.workerUpdate&&energyScreen.workerUpdate.terminate();}).modal({});energyScreen.id=this.kpiItem.id+'_'+AppConfig.userId;energyScreen.container=$dialogContent[0];energyScreen.isForBencMark=true;energyScreen.init();}
PointKPIItem.prototype.attachEventsItem=function(kpiItem){var $kpiWrap=$('#kpi_'+kpiItem.id),_this=this;$('.btnAddItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.addItem(_this.kpiItem.id);_this.parentArgt.screen.isScreenChange=true;});$('.btnRemoveItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.removeItem(_this.kpiItem.id);var $domTree=$('.domTree');if($(this).closest('.thirdCon1').length==1&&$domTree.width()-$('.level_2').width()>260){$domTree.width($domTree.width()-255);}
_this.parentArgt.screen.isScreenChange=true;});$('.btnConfigItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.showConfigModal();});$('.btnConfigWiki',$kpiWrap).off().on('click',function(e){e.stopPropagation();if(_this.kpiItem.wikiId){_this.showWikiEditModal();}else{_this.showWikiSearchModal();}});$('.btnViewWiki',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.viewWikiInfoModal();});$('.glyphicon-pencil',$kpiWrap).off().on('click',function(e){e.stopPropagation();if(_this.parentArgt.isConfigMode==true){_this.editPointKPIName();}});$kpiWrap.off().on('click',function(e){e.stopPropagation();if(_this.parentArgt.isConfigMode==false){_this.viewDetail(_this.kpiItem.id);}});}
PointKPIItem.prototype.attachEventsConfig=function($modalConfig){var _this=this;var $dropArea=$modalConfig.find('.drop-area');var $btnConfig=$modalConfig.find('#startConfig');var $btnDashboard=$modalConfig.find('#btnDashboard');$dropArea.off('dragover').on('dragover',function(e){e.preventDefault();});$dropArea.off('dragenter').on('dragenter',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});$dropArea.off('dragleave').on('dragleave',function(e){$(e.target).removeClass('on');e.stopPropagation();});$dropArea.off('drop').on('drop',function(e){var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');name=AppConfig.datasource.getDSItemById(itemId).alias;$target.attr({'data-value':itemId,'title':name});$target.html('<span>'+name+'</span>');e.stopPropagation();if($target.attr('id')=='divIsPass'){$btnConfig.removeClass('disabled');}
_this.parentArgt.screen.isScreenChange=true;});$btnConfig.off().on('click',function(){var KPI=$('#divKPI').attr('data-value');var grade=$('#divGrade').attr('data-value');var pass=$('#divIsPass').attr('data-value');_this.kpiItem.pointKPI=!KPI?'':KPI;_this.kpiItem.pointGrade=!grade?'':grade;_this.kpiItem.pointPass=!pass?'':pass;_this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.kpiItem.id){node.pointKPI=_this.kpiItem.pointKPI;node.pointGrade=_this.kpiItem.pointGrade;node.pointPass=_this.kpiItem.pointPass;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}
$('#modalConfig').modal('hide');});$btnDashboard.off('click').on('click',function(){ScreenManager.show(EnergyScreen,_this.kpiItem.id+'_'+AppConfig.userId);});}
PointKPIItem.prototype.showWikiSearchModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.showWikiSearch();}
PointKPIItem.prototype.showWikiEditModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.getWikiById();}
PointKPIItem.prototype.viewWikiInfoModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.viewWikiInfo(this.kpiItem.wikiId);}
PointKPIItem.prototype.editPointKPIName=function(){var _this=this,$divKPI=$('#kpi_'+this.kpiItem.id),$input=$divKPI.find('.pointNameInput'),$springConfigMask;if($input.length==0){var $input=$('<input type="text" class="form-control pointNameInput"/>').val(_this.kpiItem.name);var $spanName=$('.pointName','#kpi_'+this.kpiItem.id).hide().after($input);$springConfigMask=$divKPI.closest('.springConfigMask[draggable="true"]').attr('draggable',false);$input.blur(function(){savePointName(this);}).keyup(function(e){if(e.keyCode==13){savePointName(this);}});}else{savePointName($input[0]);}
function savePointName(divInput){_this.kpiItem.name=$(divInput).val();$(divInput).remove();$spanName.html(_this.kpiItem.name).show();$springConfigMask.attr('draggable',true);_this.parentArgt.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});_this.parentArgt.screen.isScreenChange=true;function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.kpiItem.id){node.name=_this.kpiItem.name;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}}
return PointKPIItem;})();var ModalReportChapter=(function(){function ModalReportChapter(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalReportChapter.prototype=new ModalBase();ModalReportChapter.prototype.optionTemplate={name:'toolBox.modal.REPORT_CHAPTER',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalReportChapter'};ModalReportChapter.prototype.show=function(){this.init();}
ModalReportChapter.prototype.init=function(){}
ModalReportChapter.prototype.renderModal=function(e){var _this=this;var postData={projectId:AppConfig.projectId,menuId:this.entity.modal.option.menuId,chapter:this.entity.modal.option.chapter,unit:this.entity.modal.option.unit};WebAPI.post('/report/getReportHtml/',postData).done(function(result){if(result.success){_this.spinner&&_this.spinner.stop();_this.container.innerHTML=result.data;_this.reportScreen=new ReportScreen();_this.reportScreen.renderCharts($('#beopReport .report-unit'))}else{alert(result.msg);}}).always(function(){_this.spinner&&_this.spinner.stop();});}
ModalReportChapter.prototype.showConfigMode=function(){}
ModalReportChapter.prototype.updateModal=function(points){}
ModalReportChapter.prototype.setModalOption=function(option){}
ModalReportChapter.prototype.modalDialog='\
        <div class="modal-content">\
            <div class="modal-header">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>\
                <h4 class="modal-title" id="">Config</h4>\
            </div>\
            <div class="modal-body">\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Type</label>\
                    </div>\
                    <div class="col-xs-4">\
                        <select id="typeList" class="form-control type"></select>\
                    </div>\
                </div>\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Chapter</label>\
                    </div>\
                    <div class="col-xs-4" id="chapterList">\
                    </div>\
                </div>\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Section</label>\
                    </div>\
                    <div class="col-xs-4" id="unitList">\
                    </div>\
                </div>\
            </div>\
            <div class="modal-footer">\
                <div id="configAlert"></div>\
                <button type="button" class="btn btn-primary" id="confirm">Confirm</button>\
            </div>\
        </div>';ModalReportChapter.prototype.showConfigModal=function(){var _this=this;var $dialogModal=$('#dialogModal');var $dialogContent=$dialogModal.find('#dialogContent').html(this.modalDialog);var $modalBody=$dialogContent.find('.modal-body');var $confirm=$dialogContent.find('#confirm');$dialogModal.modal('show');Spinner.spin($dialogContent.find('.modal-content')[0]);WebAPI.get('/report/getReportMenu/'+AppConfig.projectId).done(function(result){var $typeList=$modalBody.find('#typeList').empty();var $chapterList=$modalBody.find('#chapterList').empty();var $unitList=$modalBody.find('#unitList').empty();var typeTemp='',$firstUnitSelect,$firstChapterSelect;if(result.data&&result.data.length>0){for(var i=0;i<result.data.length;i++){var type=result.data[i];typeTemp+=('<option value="'+type._id+'" id="'+i+'">'+type.text+'</option>');var $selectChapter=$('<select id="chapter_'+i+'" class="form-control chapter" style="display: none;"></select>');if(type.structure&&type.structure.data&&type.structure.data.length>0){$selectChapter.append('<option value="all" class="type">All Chapter</option>')
for(var j=0;j<type.structure.data.length;j++){var chapter=type.structure.data[j];$selectChapter.append('<option value="'+chapter.name+'" id="'+j+'" parentId="'+i+'">'+chapter.name+'</option>');var $selectUnit=$('<select id="unit_'+i+'_'+j+'" class="form-control unit" style="display: none;"></select>');if(chapter.units&&chapter.units.length>0){$selectUnit.append('<option value="all">All Section</option>');for(var k=0;k<chapter.units.length;k++){var unit=chapter.units[k];$selectUnit.append('<option value="'+unit.unitName+'" id="'+k+'" parentId="'+j+'">'+unit.unitName+'</option>');}}else{$selectUnit.append('<option value="no">No Section</option>');}
$unitList.append($selectUnit);}}else{$selectChapter.append('<option value="no" class="type">No Chapter</option>')}
$chapterList.append($selectChapter);}}else{typeTemp+='<option value="no" class="type">No type</option>';}
$typeList.html(typeTemp);$firstChapterSelect=$chapterList.find('select:eq(0)').show();$firstUnitSelect=$unitList.find('select:eq(0)').show();if($firstChapterSelect.length==0){$chapterList.append('<select class="form-control chapter no"><option value="no" class="type">No Section</option></select>');}
if($firstUnitSelect.length==0){$unitList.append('<select class="form-control unit no"><option value="no" class="type">No Section</option></select>');}
if(_this.entity.modal.option&&result.data&&result.data.length>0){var $selectedChapter=undefined;var $selectedUnit=undefined;var $typeOption=undefined;var $chapterOption=undefined;if(_this.entity.modal.option.menuId){$typeList.val(_this.entity.modal.option.menuId);$typeOption=$typeList.find('option[value="'+_this.entity.modal.option.menuId+'"]');}
if(_this.entity.modal.option.chapter!=undefined){$chapterList.children().hide();$selectedChapter=$chapterList.find('#chapter_'+$typeOption.attr('id'));$selectedChapter.show()
if(_this.entity.modal.option.chapter!=''){$selectedChapter.val(_this.entity.modal.option.chapter);$chapterOption=$selectedChapter.find('option[value="'+_this.entity.modal.option.chapter+'"]');}}
if(_this.entity.modal.option.unit!=undefined&&$chapterOption!=undefined&&$chapterOption.length>0){$unitList.children().hide();$selectedUnit=$unitList.find('#unit_'+$chapterOption.attr('parentId')+'_'+$chapterOption.attr('id'));$selectedUnit.show()
if(_this.entity.modal.option.unit!=''){$selectedUnit.val(_this.entity.modal.option.unit)}}}
$modalBody.off('change').on('change','select',function(){$modalBody.find('select.no').remove();if($(this).hasClass('type')){var typeId=$(this).find('option[value="'+this.value+'"]')[0].id;var $chapterSelect=$('#chapter_'+typeId);$chapterList.children().hide();$chapterSelect.show();var chapterId=$chapterSelect.find('option[value="'+$chapterSelect[0].value+'"]').attr('id');$unitList.children().hide();if(chapterId){var $unitSelect=$('#unit_'+typeId+'_'+chapterId);$unitSelect.show();}else if($chapterSelect[0].value=='all'){$unitList.append('<select class="form-control unit no"><option value="all">All Section</option></select>');}else{$unitList.append('<select class="form-control unit no"><option value="no" class="type">No Section</option></select>');}}
if($(this).hasClass('chapter')){var $typeList=$('#typeList');var typeId=$typeList.find('option[value="'+$typeList[0].value+'"]')[0].id;var $chapterSelect=$('#chapter_'+typeId);var chapterId=$chapterSelect.find('option[value="'+this.value+'"]').attr('id');$unitList.children().hide();if(chapterId){var $unitSelect=$('#unit_'+typeId+'_'+chapterId);$unitSelect.show();}else if($chapterSelect[0].value=='all'){$unitList.append('<select class="form-control unit no"><option value="all">All Section</option></select>');}else{$unitList.append('<select class="form-control unit no"><option value="no">No Section</option></select>');}}});$dialogModal.off('shown.bs.modal').on('shown.bs.modal',function(){});$dialogModal.off('hidden.bs.modal').on('hidden.bs.modal',function(){$dialogContent.empty();});$confirm.off('click').on('click',function(){var chapterVal=$chapterList.find('select:not(:hidden)')[0].value;var unitVal=$unitList.find('select:not(:hidden)')[0].value;var menuId=$typeList[0].value;!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.menuId=menuId=='no'?'':menuId;_this.entity.modal.option.chapter=(chapterVal=='no'||chapterVal=='all')?'':chapterVal;_this.entity.modal.option.unit=(unitVal=='no'||unitVal=='all')?'':unitVal;$dialogModal.modal('hide');if(_this.entity.modal.option.menuId&&_this.entity.modal.option.menuId!=''){_this.screen.isScreenChange=true;}});}).fail(function(){}).always(function(){Spinner.stop();});};return ModalReportChapter;})();var ModalInteractConfig=(function($,window,undefined){var _this;function ModalInteractConfig(options){_this=this;ModalConfig.call(_this,options);}
ModalInteractConfig.prototype=Object.create(ModalConfig.prototype);ModalInteractConfig.prototype.constructor=ModalInteractConfig;ModalInteractConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalInteract.html'};ModalInteractConfig.prototype.init=function(){this.$contain=$('#modalInteract',this.$wrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$divCfgData=$('.divConfigData',this.$wrap);this.$divDataGrid=$('#divDataGrid',this.$wrap);this.$divDataTip=$('.dataDragTip',this.$wrap);I18n.fillArea(this.$contain);this.attachEvents();};ModalInteractConfig.prototype.recoverForm=function(modal){var item=_this.$divDataGrid.children('.item');if(item.length>0){item.remove();}
if(modal.points){var dictPtStat=modal.option.dictPtStatus;if(dictPtStat){var num=1;for(var id in dictPtStat){this.insertItem(id,dictPtStat[id].unit,num,dictPtStat[id].name,dictPtStat[id].projName);num++;}}}};ModalInteractConfig.prototype.reset=function(){};ModalInteractConfig.prototype.attachEvents=function(){this.$divCfgData.on('dragover',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');});this.$divCfgData.on('dragleave',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');});this.$divCfgData.on('drop',function(e,arg){$('.addData').removeClass('addData');var dragItemId=EventAdapter.getData().dsItemId;if(!dragItemId){return;}
var item=_this.$divDataGrid.find('.divDsGridItem');var len=item.length;if(Object.prototype.toString.call(dragItemId)==='[object Array]'){var lens=dragItemId.length;for(var j=0;j<lens;j++){var isExist=false;for(var i=0;i<len;i++){if(dragItemId[j]==item.eq(i).attr('dsid')){dragItemId.splice(j,1);lens=lens-1;j=j-1;isExist=true;continue;}}
if(!isExist){dotAdd(dragItemId[j],'array');}}
if(lens<1){return;}}else{var bFind=false;for(var i=0;i<len;i++){if(dragItemId==item.eq(i).attr('dsid')){bFind=true;break;}}
if(bFind){return;}
dotAdd(dragItemId);}
function dotAdd(dragItemId,isArray){if(len>=20){return;}
if(dragItemId){var item=AppConfig.datasource.getDSItemById(dragItemId);if(item&&item.alias){var parent=_this.options.modalIns;var prjName;if(parent){var temp=parent.getProjectNameFromId(item.projId,parent.m_langFlag);if(0==parent.m_langFlag){prjName='项目名：'+temp;}
else{prjName='Project Name:'+temp;}}
_this.insertItem(dragItemId,'',len+1,item.alias,prjName);len=_this.$divDataGrid.find('.divDsGridItem').length;}}}});this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;modal.points=[];if(!modal.option){modal.option={}
modal.option.dictPtStatus={};}
if(modal.option){modal.option.dictPtStatus={};}
var arrGrid=_this.$divDataGrid.find('.grow');for(var i=0,len=arrGrid.length;i<len;i++){var item=arrGrid.eq(i);var id=item.attr('dsid');var name=item.find('input').val();var proName=item.find('.contentDS').attr('title');modal.points.push(id);modal.option.dictPtStatus[id]={show:((0==i)?true:false),count:i,unit:'',name:name,projName:proName};}
if(!modal.option.timeMode){var tmEnd=new Date();tmEnd.setHours(23);tmEnd.setMinutes(59);var tmStart=new Date();tmStart.setTime(tmEnd.getTime()-172800000);tmStart.setHours(0);tmStart.setMinutes(0);modal.option.timeMode='recent';modal.option.interval='h1';modal.option.timeStart=tmStart.format('yyyy-MM-dd HH:mm:00');modal.option.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:00');modal.option.periodVal=3;modal.option.periodUnit='day';modal.interval=3;}
_this.$modal.modal('hide');e.preventDefault();});};ModalInteractConfig.prototype.insertItem=function(id,unit,num,name,projName){if(name==undefined){name=AppConfig.datasource.getDSItemById(id).alias;}
if(!projName){projName='';}
var $item=$('<div class="col-lg-3 col-xs-4 divDsGrid item">\
            <span class="divDsGridNum">'+num+'</span>\
            <span class="divDsGridItem grow" dsid="'+id+'">\
                <span class="contentDS" title="'+projName+'">'+name+'</span>\
                <input type="text" value="'+name+'" style="display:none">\
                <span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true"></span>\
            </span></div>');$item.click(function(e){var $tar=$(e.currentTarget);var $name=$tar.find('.contentDS');var $input=$tar.find('input');$name.hide();$input.show();$input.focus();$input.select();$input.keyup(function(e){if(13==e.keyCode){var newVal=$input.val();$name.text(newVal);$input.blur();}});$input.blur(function(e){$input.val($name.text());$name.show();$input.hide();});})
_this.$divDataTip.before($item);_this.$divDataGrid.find('.btnRemoveDS').last().click(function(e){var $dsGrid=$(e.currentTarget).closest('.divDsGrid');if($dsGrid){$dsGrid.remove();}
var gridNum=_this.$divDataGrid.find('.divDsGridNum');if(gridNum){for(var i=0;i<gridNum.length;i++){gridNum.eq(i).text(i+1);}}});_this.$divDataGrid.find('.contentDS').last().dblclick(function(e){var $spanTar=$(e.currentTarget);var name=$spanTar.text();var $inputName=$spanTar.next('input');$inputName.keydown(function(e){if(13==e.keyCode){var $inputTar=$(e.currentTarget);var newName=$inputTar.val();$inputTar.hide();$spanTar.text(newName);$spanTar.show();}});$inputName.blur(function(e){var $inputTar=$(e.currentTarget);var newName=$inputTar.val();$inputTar.hide();$spanTar.text(newName);$spanTar.show();});$spanTar.hide();$inputName.show();$inputName.focus();$inputName.select();});};ModalInteractConfig.prototype.destroy=function(){this.detachEvents();this.$wrap.remove();};return ModalInteractConfig;}(jQuery,window));var ModalInteract=(function(){var _this;var g_dictChart={};function ModalInteract(screen,entityParams){_this=this;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.modalId=entityParams.id;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.m_lang=I18n.resource.dataSource;this.screen=screen;this.init();this.arrColor=echarts.config.color;this.timeFlag=undefined;this.arrModal=screen.store.layout[0];g_dictChart[this.modalId]={chart:this.chart,contain:this.container};this.spinner.spin(this.container);};ModalInteract.prototype=new ModalBase();ModalInteract.prototype.optionTemplate={name:'toolBox.modal.INTERACT_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:3,minWidth:9,maxHeight:12,maxWidth:12,type:'ModalInteract'};ModalInteract.prototype.defaultOptions={title:{text:''},tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},dataZoom:{show:true},yAxis:[{type:'value',axisLabel:{textStyle:{color:'#777'}},splitLine:{show:true,lineStyle:{color:'#777',width:1,type:'dashed'}}}],animation:false,grid:[{bottom:70}]};ModalInteract.prototype.init=function(){var containWidth=$(this.container).width();var containHeight=$(this.container).height();var $divLeftPart=$('<div style="display:inline-block;height:100%"></div>');$divLeftPart.css('width',containWidth-220+'px');var $divChartCtrl=$('<div id="chartShow"></div>');$divChartCtrl.css('height',containHeight-10+'px');$divLeftPart.append($divChartCtrl);var $divDataCtrl=$('<div id="dataList" style="display:inline-block;position:absolute;top:10px;right:0;width:220px;height:100%;overflow-y:auto"><div class="form-group"></div></div>');if(this.modal.points&&this.modal.option.dictPtStatus){var arrId=[]
for(var id in this.modal.option.dictPtStatus){arrId.push(id);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var id in this.modal.option.dictPtStatus){for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var name=this.modal.option.dictPtStatus[id].name;var unit=this.modal.option.dictPtStatus[id].unit;this.insertInteractData($divDataCtrl,id,name,unit);var target=$divDataCtrl.find('.form-inline').last();if(0==arrItem[m].type){}
else if(1==arrItem[m].type){var showFormula=AppConfig.datasource.getShowNameFromFormula(arrItem[m].value);this.setFormulaToolTips(target,name,showFormula,arrItem[m].note);}
break;}}}}
$(this.container).empty();$(this.container).append($divLeftPart);$(this.container).append($divDataCtrl);}
ModalInteract.prototype.renderModal=function(e){this.drawCharts();this.spinner.stop();}
ModalInteract.prototype.updateModal=function(e){var dsId=e[0].dsItemId;var modeName;for(var i=0;i<_this.arrModal.length;i++){var arrPt=_this.arrModal[i].modal.points;for(var j=0;j<arrPt.length;j++){if(dsId==arrPt[j]){modeName=_this.arrModal[i].modal.option.timeMode;break;}}
if(modeName){break;}}
if('recent'==modeName){var newOption=_this.chart.getOption();var newSeries=newOption.series;var arrId=[];for(var i=0,len=e.length;i<len;i++){arrId.push(e[i].dsItemId);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=e.length;i<len;i++){var id=e[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var name=arrItem[m].alias;var bFind=false;var j=0;for(var len2=newSeries.length;j<len2;j++){if(name==newSeries[j].name){bFind=true;break;}}
if(bFind){var flag=false;for(var k=0;k<newSeries[j].data.length;k++){if(undefined==newSeries[j].data[k]){newSeries[j].data[k]=e[i].data;flag=true;break;}}
if(!flag){newSeries[j].data.push(e[i].data);}}
break;}}}
_this.chart.setOption(newOption);_this.chart.refresh();}
var spanReal=$('#dataList').find('.frontCtrl');if(spanReal){for(var j=0,len2=e.length;j<len2;j++){var id=e[j].dsItemId;for(var k=0,len3=spanReal.length;k<len3;k++){if(id==spanReal.eq(k).attr('pId')){spanReal.eq(k).find('.interactRealVal').text(e[j].data);break;}}}}}
ModalInteract.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();}
ModalInteract.prototype._showConfig=function(){};ModalInteract.prototype.setModalOption=function(option){}
ModalInteract.prototype.drawCharts=function(parmOption,parmChart,parmContain){if(!parmOption){parmOption=_this.modal.option;}
if(!parmChart){parmChart=_this.chart;}
if(!parmContain){parmContain=_this.container;}
if(parmOption){var arrPoints=[];for(var itemId in parmOption.dictPtStatus){if(parmOption.dictPtStatus[itemId].show){arrPoints.push(itemId);}}
if(0==arrPoints.length){parmChart.clear();_this.setDataListColor();return;}
if('recent'==parmOption.timeMode){var tmEnd=new Date();tmEnd.setHours(23);tmEnd.setMinutes(59);var tmTemp=tmEnd.getTime()-86400000*(parmOption.periodVal-1);var tmStart=new Date();tmStart.setTime(tmTemp);tmStart.setHours(0);tmStart.setMinutes(0);parmOption.timeStart=tmStart.format('yyyy-MM-dd HH:mm:00');parmOption.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:00');}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:arrPoints,timeStart:new Date(parmOption.timeStart).format('yyyy-MM-dd HH:mm:00'),timeEnd:new Date(parmOption.timeEnd).format('yyyy-MM-dd HH:mm:00'),timeFormat:parmOption.interval}).done(function(result){if(result.timeShaft.length<=0){parmChart=echarts.init($(parmContain,AppConfig.chartTheme).find('#chartShow')[0]).clear();return;}
var arrName=[];var series=[];var arrId=[];var arrItem=[];for(var i=0,len=result.list.length;i<len;i++){arrId.push(result.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);var cntNow=(new Date()).getTime();var dictLastData={};for(var i=0,len=result.list.length;i<len;i++){var id=result.list[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var showData=[];var lastData;var flag=false;if('recent'==parmOption.timeMode){var n=0;for(;n<result.timeShaft.length;n++){if(Date.parse(result.timeShaft[n])>cntNow){if(!flag){lastData=result.list[i].data[n];flag=true;}
showData.push(undefined);}
else{showData.push(result.list[i].data[n]);}}
dictLastData[id]=lastData;}
else{showData=result.list[i].data;}
var name=arrItem[m].alias;arrName.push(name);var count=parmOption.dictPtStatus[id].count;var color=_this.arrColor[count];series.push({name:name,type:'line',data:showData,itemStyle:{normal:{color:color}}});break;}}}
var options={legend:{show:false,data:arrName},xAxis:[{type:'category',boundaryGap:false,data:result.timeShaft,axisLabel:{textStyle:{color:'#777'}},splitLine:{show:true,lineStyle:{color:'#777',width:1,type:'dashed'}}}],series:series}
var drawOptions={}
jQuery.extend(drawOptions,ModalInteract.prototype.defaultOptions,options);parmChart=echarts.init($(parmContain).find('#chartShow')[0],AppConfig.chartTheme);parmChart.setOption(drawOptions);_this.chart=parmChart;_this.setDataListColor(parmContain);if('recent'==parmOption.timeMode){var spanReal=$(parmContain).find('.frontCtrl');if(spanReal){for(var p=0;p<spanReal.length;p++){var $item=spanReal.eq(p);var id=$item.attr('pid');$item.find('.interactRealVal').text(dictLastData[id]);}}}
else{var spanReal=$(parmContain).find('.frontCtrl');if(spanReal){for(var p=0;p<spanReal.length;p++){var $item=spanReal.eq(p);var id=$item.attr('pid');$item.find('.interactRealVal').text('');}}}});}}
ModalInteract.prototype.drawChartsEx=function(parmOption,modalId){_this.drawCharts(parmOption,g_dictChart[modalId].chart,g_dictChart[modalId].contain);}
ModalInteract.prototype.insertInteractData=function($divDst,ptId,ptName,ptUnit){$divDst.append('\
            <form class="form-inline">\
                <span class="form-control frontCtrl interactDsFrame" pId="'+ptId+'" style="cursor:pointer;width:200px;border-radius: 0em 0em 0em 0em;margin-right: -4px;border-width: 0;color: #ccc;border-bottom:1px solid #465b85;">\
                    <span class="interactSpanDsName" style="display:inline-block;width:100px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;vertical-align: bottom;">'+ptName+'</span>\
                    <span class="interactRealVal" style="display:inline-block;width:70px;overflow: hidden;text-overflow:ellipsis;white-space:nowrap;vertical-align:bottom;"></span>\
                </span>\
            </form>\
        ');var $front=$divDst.find('.frontCtrl');$front.off().click(function(e){if(_this.modal.option&&_this.modal.option.dictPtStatus){var $tar=$(e.currentTarget);var id=$tar.attr('pId');var $contain=$tar.closest('.springContainer');var modalId;if($contain){var temp=$contain.attr('id');modalId=temp.split('_')[1];for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(modalId==item.id){item.modal.option.dictPtStatus[id].show=!item.modal.option.dictPtStatus[id].show;break;}}}
_this.screen.saveLayoutOnly();_this.drawCharts(item.modal.option,g_dictChart[modalId].chart,g_dictChart[modalId].contain);}})}
ModalInteract.prototype.initInteractTime=function($divDst){$divDst.append('\
            <form class="form-inline" style="margin-top: 3px;font-family:Microsoft YaHei;font-size:14px">\
                <div class="form-group" style="width:140px">\
                    <label for="selMode" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_MODE+'</label>\
                    <select class="form-control" id="selMode" style="background-color:#f4f6f8;border:1px solid #465b85;color:#646464;width:inherit">\
                        <option value="fixed">'+I18n.resource.modalConfig.option.MODE_FIXED+'</option>\
                        <option value="recent">'+I18n.resource.modalConfig.option.MODE_RECENT+'</option>\
                    </select>\
                </div>\
                <div class="form-group" style="width:120px">\
                    <label for="selInterval" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                    <select class="form-control" id="selInterval" style="background-color:#f4f6f8;border:1px solid #465b85;color:#646464;width:inherit">\
                        <option value="m1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                        <option value="m5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                        <option value="h1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                        <option value="d1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                        <option value="M1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                    </select>\
                </div>\
                <div class="form-group" id="divTmRange" style="width:380px">\
                    <label for="divRange" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                    <div id="divRange" style="display:inline">\
                        <input class="form-control" type="text" id="tmStart" style="width:165px;cursor:pointer;text-align:center" readonly>\
                        <span class="input-group-addon" style="display: inline;padding-top:6px;padding-bottom:7px;text-align:center;border:1px solid rgb(39, 51, 75);color:#646464;margin-right:-6px;background-color:#f4f6f8;">'+I18n.resource.modalConfig.option.TIP_RANGE_TO+'</span>\
                        <input class="form-control" type="text" id="tmEnd" style="width:165px;cursor:pointer;text-align:center" readonly>\
                    </div>\
                </div>\
                <div class="form-group" id="divTmLast" style="width:340px;display:none">\
                    <label for="divLast" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_PERIOD+'</label>\
                    <div id="divLast">\
                        <input class="form-control" type="text" id="inputPeriodValue" style="width:165px;background-color:#f4f6f8;border:1px solid #27334b;border-radius:0.5em 0 0 0.5em;margin-right:-5px;color:#646464">\
                        <select class="form-control" id="selPeriodUnit" style="width:165px;background-color:#f4f6f8;border:1px solid #27334b;border-radius:0 0.5em 0.5em 0;color:#646464">\
                            <option value="hour">'+I18n.resource.modalConfig.option.PERIOD_UNIT_HOUR+'</option>\
                            <option value="day">'+I18n.resource.modalConfig.option.PERIOD_UNIT_DAY+'</option>\
                            <option value="month">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MON+'</option>\
                        </select>\
                    </div>\
                </div>\
                <button class="btn" type="button" id="btnOk" modalId="'+_this.modalId+'" style="width:70px;vertical-align:bottom;color:#f4f6f8;background-color:#288add;">'+I18n.resource.observer.widgets.YES+'</button>\
            </form>\
        ');var $selMode=$divDst.find('#selMode');var $selInter=$divDst.find('#selInterval');var $divTmRange=$divDst.find('#divTmRange');var $divTmLast=$divDst.find('#divTmLast');$selMode.change(function(e){var $opt=$selInter.children('option');var flag=$(e.currentTarget).val();switch(flag){case'fixed':$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');$divTmRange.css('display','inline-block');$divTmLast.css('display','none');break;case'recent':$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','none');$divTmRange.css('display','none');$divTmLast.css('display','inline-block');break;default:break;}});var tmNow=new Date();var tmStart=new Date();tmStart.setFullYear(tmNow.getFullYear()-10);var $inputStart=$divDst.find('#tmStart');$inputStart.val(tmNow.format('yyyy-MM-dd HH:mm:00'));$inputStart.css('background-color','#f4f6f8');$inputStart.css('border','1px solid #27334b');$inputStart.css('color','#646464');$inputStart.css('border-radius','0.5em 0 0 0.5em');$inputStart.css('margin-right','-5px');$inputStart.datetimepicker({format:'yyyy-mm-dd hh:mm:00',startView:'month',minView:'hour',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){});var $inputEnd=$divDst.find('#tmEnd');$inputEnd.val(tmNow.format('yyyy-MM-dd HH:mm:00'));$inputEnd.css('background-color','#f4f6f8');$inputEnd.css('border','1px solid #27334b');$inputEnd.css('color','#646464');$inputEnd.css('border-radius','0 0.5em 0.5em 0');$inputEnd.datetimepicker({format:'yyyy-mm-dd hh:mm:00',startView:'month',minView:'hour',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){});var $inputPerVal=$divDst.find('#inputPeriodValue');var $selPerUnit=$divDst.find('#selPeriodUnit');var $btnOk=$divDst.find('#btnOk');$btnOk.off().click(function(e){var tmMode=$selMode.val();var strStart,strEnd;if('fixed'==tmMode){strStart=$inputStart.val();strEnd=$inputEnd.val();}
else if('recent'==tmMode){var tmStart=new Date();var periodVal=parseInt($inputPerVal.val());if(!periodVal){alert('Please input time !');return;}
var periodUnit=$selPerUnit.val();switch(periodUnit){case'hour':var time=tmNow.getTime()-3600000*periodVal;tmStart.setTime(time);break;case'day':var time=tmNow.getTime()-86400000*periodVal;tmStart.setTime(time);break;case'month':var month=tmNow.getMonth();if(0==month){tmStart.setFullYear(tmNow.getFullYear()-1);tmStart.setMonth(11);}
else{tmStart.setMonth(month-1);}
break;default:break;}
strStart=tmStart.format('yyyy-MM-dd HH:mm:00');strEnd=tmNow.format('yyyy-MM-dd HH:mm:00');}
else{alert('Please select mode !');return;}
var modalId=$(e.currentTarget).attr('modalId');if(modalId){for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(item){if(modalId==item.id){if(!item.modal.option){item.modal.option={};item.modal.option.dictPtStatus={};}
item.modal.option.timeMode=tmMode;item.modal.option.interval=$selInter.val();item.modal.option.timeStart=strStart;item.modal.option.timeEnd=strEnd;item.modal.option.periodVal=periodVal;item.modal.option.periodUnit=periodUnit;if('recent'==tmMode){item.interval=1000;}
else{item.interval=null;}
break;}}}}
_this.screen.saveLayoutOnly();_this.drawCharts(item.modal.option,g_dictChart[modalId].chart,g_dictChart[modalId].contain);});if(_this.modal.option){$selMode.val(_this.modal.option.timeMode);$selInter.val(_this.modal.option.interval);$inputStart.val(_this.modal.option.timeStart);$inputEnd.val(_this.modal.option.timeEnd);$inputPerVal.val(_this.modal.option.periodVal);$selPerUnit.val(_this.modal.option.periodUnit);if('recent'==_this.modal.option.timeMode){$selMode.change();}}}
ModalInteract.prototype.setDataListColor=function(contain){var dataListName;if(!contain){dataListName=$('#dataList').find('.frontCtrl');}
else{dataListName=$(contain).find('.frontCtrl');}
if(dataListName){for(var j=0,len=dataListName.length;j<len;j++){var $item=dataListName.eq(j);var id=$item.attr('pId');var $contain=$item.closest('.springContainer');var modalId;if($contain){var temp=$contain.attr('id');modalId=temp.split('_')[1];for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(modalId==item.id){var count=item.modal.option.dictPtStatus[id].count;var bShow=item.modal.option.dictPtStatus[id].show;var $spanDsName=$item.find('.interactSpanDsName');if($spanDsName){if(bShow){$spanDsName.css('color',_this.arrColor[count]);}
else{$spanDsName.css('color','');}}
break;}}}}}}
ModalInteract.prototype.setToolTips=function(target,customName,projectName,pointName,pointDesc){var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px">');show.append('    <div class="tooltipContent interactTipsBackground">');show.append('        <p class="customName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="projectName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.PROJECT_NAME).append('</span>: ').append(projectName).append('</p> ');show.append('        <p class="pointName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_NAME).append('</span>: ').append(pointName).append('</p> ');show.append('        <p class="pointDesc interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(pointDesc).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'left',title:_this.m_lang.PARAM,template:show.toString()};target.tooltip(options);}
ModalInteract.prototype.setFormulaToolTips=function(target,customName,formula,desc){var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:400px;">');show.append('    <div class="tooltipContent interactTipsBackground">');show.append('        <p class="customName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="formula interactTipsStyle" style="word-break:normal;"><span class="interactTipsTitleStyle">').append(_this.m_lang.FORMULA_NAME).append('</span>: ').append('</p>');show.append('        <p class="pointDesc interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(desc).append('</p>');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var showFormula=$('<span>'+formula+'</span>');var showObj=$(show.toString());showFormula.appendTo(showObj.find('.formula')).mathquill();var options={placement:'left',title:_this.m_lang.PARAM,template:showObj};target.tooltip(options);}
ModalInteract.prototype.getProjectNameFromId=function(id,langFlag){var name;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(id==item.id){if(0==langFlag){name=item.name_cn;}
else{name=item.name_en;}
break;}}
return name;}
ModalInteract.prototype.configModal=new ModalInteractConfig();return ModalInteract;})();var ModalMobile=(function(){function ModalMobile(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalMobile.prototype=new ModalChart();ModalMobile.prototype.optionTemplate={name:'toolBox.modal.MOBILE_CHART',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMobile'};ModalMobile.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:true},grid:(function(){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:40,top:40}
if(AppConfig.isMobile){grid.x=40;}
return grid;}()),xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:(function(){if(AppConfig.isMobile){return false;}else{return true;}}())},axisLabel:{formatter:function(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true};ModalMobile.prototype.renderModal=function(){},ModalMobile.prototype.updateModal=function(options){},ModalMobile.prototype.showConfigMode=function(){},ModalMobile.prototype.goBackTrace=function(data){}
return ModalMobile;})();var ModalAppKPICollect=(function(){function ModalAppKPICollect(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalAppKPICollect.prototype=new ModalBase();ModalAppKPICollect.prototype.optionTemplate={name:'toolBox.modal.APP_KPI_COLLECT',parent:3,mode:'custom',maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppKPICollect',scroll:false};ModalAppKPICollect.prototype.configModalOptDefault={header:{'title':'配置','needBtnClose':true},area:[{'module':'multiDataConfig','data':{'variable':[],'param':[{'type':'name','name':'数据标题'},{'type':'data','name':'数据点位'},{'type':'unit','name':'数据单位'},{'type':'scale','name':'小数点位'}]}}],result:{}};ModalAppKPICollect.prototype.renderModal=function(){this.spinner.stop();var _this=this;var divAppKPi=document.createElement('div');var divKpiList=document.createElement('div');divAppKPi.className='appKpi';divKpiList.className='divKPIList';this.container.appendChild(divAppKPi);divAppKPi.appendChild(divKpiList);divKpiList.innerHTML='';var optTitle=_this.entity.modal.option.title;if(optTitle){if(optTitle.text||optTitle.data){divKpiList.innerHTML='\
				<div class="divSingleType divListTitle">\
	                <div class="divTypeTitle ">'+_this.entity.modal.option.title.text+'</div>\
	                <div class="divKPIListRight">\
						<div class="divTypeVal divKPINow" data-pt="'+_this.entity.modal.option.title.data+'" data-scale="'+_this.entity.modal.option.title.scale+'"></div>\
	               		<div class="divTypeUnit divKPIUnit">'+(_this.entity.modal.option.title.unit?_this.entity.modal.option.title.unit:'')+'</div>\
	                </div>\
	            </div>';}}
for(var i=0;i<_this.entity.modal.option.param.length;i++){divKpiList.innerHTML+='\
	        	<div class="divSingleType">\
	                <div class="divTypeTitle ">'+_this.entity.modal.option.param[i].name+'</div>\
	                <div class="divKPIListRight">\
						<div class="divTypeVal" data-scale="'+_this.entity.modal.option.param[i].scale+'" data-pt="'+_this.entity.modal.option.param[i].data+'"></div>\
	               		<div class="divTypeUnit ">'+_this.entity.modal.option.param[i].unit+'</div>\
	                </div>\
	            </div>\
			';}
this.container.appendChild(divAppKPi);};ModalAppKPICollect.prototype.updateModal=function(points){var data;for(var i=0;i<points.length;i++){var dom=this.container.querySelector('[data-pt="'+points[i].dsItemId+'"]');if(dom){if(!isNaN(Number(points[i].data))){if(dom.dataset.scale&&!isNaN(parseInt(dom.dataset.scale))){if(parseInt(dom.dataset.scale)>10){data=parseFloat(points[i].data).toFixed(10);}else{data=parseFloat(points[i].data).toFixed(parseInt(dom.dataset.scale));}}else{data=parseFloat(points[i].data).toFixed(2);}}else{data=points[i].data;}
dom.innerText=data;}}};ModalAppKPICollect.prototype.showConfigMode=function(){};ModalAppKPICollect.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option)this.configModalOpt.area[0].data.variable=[this.entity.modal.option];this.configModalOpt.result.func=function(option){_this.setModalOption(option);}};ModalAppKPICollect.prototype.setModalOption=function(option){this.entity.modal.points=[];this.entity.modal.option={};for(var i=0;i<option.dataInfoList.length;i++){option.dataInfoList[i].title.data&&this.entity.modal.points.push(option.dataInfoList[i].title.data);this.entity.modal.option=option.dataInfoList[i];for(var j=0;j<option.dataInfoList[i].param.length;j++){if(option.dataInfoList[i].param[j].data)this.entity.modal.points.push(option.dataInfoList[i].param[j].data);}}
this.entity.modal.interval=5;};ModalAppKPICollect.prototype.goBackTrace=function(data){};return ModalAppKPICollect;})();var ModalDataMonitorList=(function(){function ModalDataMonitorList(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalDataMonitorList.prototype=new ModalBase();ModalDataMonitorList.prototype.optionTemplate={name:'toolBox.modal.DATA_MONITOR_LIST',parent:0,mode:['dataMonitorList'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDataMonitorList',scroll:false};ModalDataMonitorList.prototype.configModalOpt={};ModalDataMonitorList.prototype.initLeftMonitorList=function(monitorList,data){var _this=this;var _value;var listLeft=document.createElement('div');listLeft.className='monitorListLeft gray-scrollbar';var listLeftContentGroup=document.createElement('div');listLeftContentGroup.className='listLeftContentGroup';for(var i=0;i<monitorList.content.length;i++){var item=monitorList.content[i];var listLeftContent=document.createElement('div');listLeftContent.className='panel panel-default';var listLeftTitle=document.createElement('div');listLeftTitle.className='listLeftTitle';var listLeftContentList=document.createElement('div');listLeftContentList.className='listLeftContentList';listLeftTitle.innerHTML+='\
                    <div class="panel-title">\
                        <table class="table table-hover">\
                            <tbody>\
                                <tr class="kpi-tr-index show-detail">\
                                    <td>'+item.system+'</td>\
                                </tr>\
                            </tbody>\
                        </table>\
                    </div>\
                    ';listLeftContentList.innerHTML='\
                <table>\
                    <tbody>\
                        <tr>\
                            <td>参数</td>\
                            <td>当前值</td>\
                            <td>选择</td>\
                        </tr>\
                    </tbody>\
                </table>\
                ';listLeftContent.appendChild(listLeftTitle);for(var j=0;j<item.parameter.length;j++){for(var m=0;m<data.length;m++){if(item.parameter[j].point!=data[m].name){continue;}else{_value=data[m].value;}};listLeftContentList.innerHTML+='\
                    <div id="para-collapse" class="">\
                        <div class="bodyPn borderColorTemp4">\
                            <table class="table table-hover">\
                                <tbody>\
                                    <tr class="kpi-tr-index show-detail">\
                                        <td>'+item.parameter[j].legend+'</td>\
                                        <td>'+Number(_value).toFixed(1)+'</td>\
                                        <td>\
                                            <form>\
                                                <input type="checkbox" id="selectedCheckbox" value="'+item.parameter[i].point+'" name="'+item.parameter[j].legend+'">\
                                            </form>\
                                       </td>\
                                    </tr>\
                                </tbody>\
                            </table>\
                        </div>\
                    </div>\
                ';listLeftContent.appendChild(listLeftContentList);};listLeftContentGroup.appendChild(listLeftContent);};listLeft.appendChild(listLeftContentGroup);this.container.appendChild(listLeft);this.attachEvent();if($._data($('#selectedCheckbox')[0],"events")&&$._data($('.table tr'),"events")){$('.monitorListLeft').css("width","24%");}else{$('.monitorListLeft').css("width","100%");}};ModalDataMonitorList.prototype.renderModal=function(){this.spinner.stop();var _this=this;var _pId=393;var postData=this.entity.modal.points;WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:postData}).done(function(result){if($(_this.container).find(".alertErrorInfo")){$(_this.container).find(".alertErrorInfo").remove();}
if(!(result.dsItemList[0]&&result.dsItemList[0].data))return;if(result.dsItemList[0].data.indexOf('content')!==-1){var monitorList=JSON.parse(result.dsItemList[0].data);var pArr=[];for(var i=0;i<monitorList.content.length;i++){var arr=monitorList.content[i].parameter;for(var j=0;j<arr.length;j++){pArr.push(arr[j].point);}}
var opt1={pointList:pArr,proj:_pId}
console.log(opt1);WebAPI.post('/get_realtimedata',opt1).done(function(data){console.log(data);_this.initLeftMonitorList(monitorList,data);})}else{var alertErrorInfo=document.createElement('div');alertErrorInfo.className='alertErrorInfo';alertErrorInfo.innerHTML='所拖入数据点的格式不符合该控件所需的数据格式,数据点格式参考上海来福士的Proj_ParaQueyInfo';_this.container.appendChild(alertErrorInfo);}});};ModalDataMonitorList.prototype.updateModal=function(points){var _this=this;};ModalDataMonitorList.prototype.attachEvent=function(){$('.listLeftTitle').on('click',function(e){var index=$(".listLeftTitle").index($(this));$('.listLeftContentList').eq(index).toggle('slow');})}
ModalDataMonitorList.prototype.showConfigMode=function(){};ModalDataMonitorList.prototype.initConfigModalOpt=function(){};ModalDataMonitorList.prototype.setModalOption=function(option){};return ModalDataMonitorList;})();﻿var ModalDiagnosisPanel=(function(){var _this=undefined;function ModalDiagnosisPanel(dom){this.ElScreenContainer=window.ElScreenContainer||$('body')[0];this.parent=dom||this.ElScreenContainer;this.dictZone=undefined;this.dictEquipment=undefined;this.dictObserverText=undefined;this.arrLastNotice=[];this.workerUpdate=undefined;this.tabelModelData=undefined;this.tableModelUpdate=undefined;this.floorCount=0;this.dialog=undefined;this.langCfg=I18n.resource.diagnosis.config;this.noticeId=0;this.faId=0;this.faUserId=0;this.obScreen=undefined;this.$obContainer=undefined;this.urgentCount=0;this.criticalCount=0;_this=this;}
ModalDiagnosisPanel.prototype={show:function(){Spinner.spin(this.ElScreenContainer);WebAPI.get("/static/views/observer/widgets/modalDiagnosisPanel.html").done(function(resultHtml){$(_this.parent).html(resultHtml);I18n.fillArea($(_this.parent));_this.init();}).always(function(){Spinner.stop();});},optionTemplate:{name:'toolBox.modal.DIAGNOSIS_PANEL',parent:0,mode:[''],maxNum:1,title:'',minHeight:2,minWidth:4,maxHeight:6,maxWidth:12,type:'ModalDiagnosisPanel'},initStructData:function(data){var item,arr;this.dictZone=new Object();this.dictEquipment=new Object();this.buildings=[];arr=data.equipments;for(var i=0,len=arr.length;i<len;i++){item=arr[i];item.faultIds=new Array();this.dictEquipment[item.id]=item;}
arr=data.zones;this.floorCount=arr.length;var index=-1,tempBuildingId=undefined;for(var i=0,len=arr.length;i<len;i++){item=arr[i];var equipments=[];for(var j=0;j<data.equipments.length;j++){if(data.equipments[j].zoneId==item.id){equipments.push({equipmentId:data.equipments[j].id,equipmentName:data.equipments[j].name})}}
this.dictZone[item.id]=item;if(tempBuildingId!=item.buildingId){tempBuildingId=item.buildingId;index++;var building={buildId:item.buildingId,buildName:item.buildingName,subBuilds:[{subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}]}
this.buildings.push(building)}else{var subBuilding={subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}
this.buildings[index].subBuilds.push(subBuilding);}}},close:function(){this.dictZone=null;this.dictEquipment=null;this.dictObserverText=null;this.tabelModelData=null;this.arrLastNotice=null;this.floorCount=null;if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;if(this.tableModelUpdate)this.tableModelUpdate.terminate();this.tableModelUpdate=null;if(this.dialog)this.dialog.close();if(this.obScreen)this.obScreen.close();if(ToolCurrent)ToolCurrent.close();},onresize:function(){ScreenCurrent.obScreen.resize();},init:function(){this.$obContainer=$('#obContainer');this.dictObserverText={};WebAPI.get('/diagnosis/getStruct/'+AppConfig.projectId).done(function(result){_this.initStructData(result);_this.initPaneNav();$('.subBuildingBtn','#paneIcon').eq(0).trigger('click');$('.div-nav-row','#paneIcon').eq(0).children('span:first').trigger('click');});function tabelModelClose(){$('#panelIconNew').hide();if(_this.tableModelUpdate)_this.tableModelUpdate.terminate();_this.tableModelUpdate=null;}
$("#btnNoticeHistory").off().click(function(e){ScreenModal=new DiagnosisLogHistory(_this);ScreenModal.setIsModal(true);ScreenModal.show();});var $flootCt=$('#floorCt');var $floorPB=$flootCt.find('.showCont');var $floorPH=$flootCt.find('.panel-default');$flootCt.find('.panel-heading').off('click').click(function(){$floorPH.hide();$floorPB.show();});$floorPB.off('click').click(function(){$(this).hide();$floorPH.show();});},initWorkerForUpdating:function(){if(this.workerUpdate){this.workerUpdate.terminate();}
this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);this.workerUpdate.postMessage({projectId:AppConfig.projectId,type:"allDiagnosisScreen"});},initObScreen:function(){this.obScreen.isInDiagnosis=true;this.obScreen.diagScreen=this;},resetFloor:function(){this.refreshData({data:{notice:this.arrLastNotice}},true);},clearNullArr:function(arr){for(var i=0,len=arr.length;i<len;i++){if(arr[i]==""||typeof(arr[i])=="undefined"){arr.splice(i,1);len--;i--;}}
return arr;},gradientColors:function(colorArr,$gradientDom,valueCurrent,max,min){var valueMark=(max-min)/(colorArr.length-1);var regexp=/[0-9]{0,3}/g;for(var i=0;i<colorArr.length-1;i++){var colorMaxValue=min+(i+1)*valueMark;if(valueCurrent>colorMaxValue)continue;var colorSelPre=colorArr[i];var colorSelTo=colorArr[i+1];var colorValPreArr=[];colorValPreArr=colorSelPre.match(regexp);_this.clearNullArr(colorValPreArr);var colorValToArr=[];colorValToArr=colorSelTo.match(regexp);_this.clearNullArr(colorValToArr);var colorMinValue=min+i*valueMark;if(i==colorArr.length-2){colorMaxValue=max;}
if(valueCurrent<=colorMaxValue){$gradientDom.css('background','rgb('+(parseInt((parseInt(colorValToArr[0]-colorValPreArr[0])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[0]))+','+(parseInt((parseInt(colorValToArr[1]-colorValPreArr[1])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[1]))+','+(parseInt((parseInt(colorValToArr[2]-colorValPreArr[2])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[2]))+')');i=colorArr.length-1;}}},refreshData:function(e,isOnlyRenderDictFault){if(!e.data||$.isEmptyObject(e.data)||e.data.error){Spinner.stop();}
_this=this.self?this.self:this;if(e.data.notice&&e.data.notice[0]){_this.arrLastNotice=e.data.notice;var existedIds=[];for(var i in _this.arrLastNotice){existedIds.push(_this.arrLastNotice[i].id);}
if($.inArray(e.data.notice[0].id,existedIds)<0){Array.prototype.push.apply(e.data.notice,_this.arrLastNotice);_this.arrLastNotice=e.data.notice;}
for(var key in _this.dictEquipment){_this.dictEquipment[key].faultIds=new Array();}
try{var dictFaultHighestGrade={};for(var i=0;i<e.data.notice.length;i++){var faultId=e.data.notice[i].faultId,equipmentId=e.data.notice[i].equipmentId;var grade;var eq=_this.dictEquipment[equipmentId];eq.faultIds.push(faultId);grade=dictFaultHighestGrade[eq.modalTextId];if(!grade||e.data.notice[i].grade>grade)
dictFaultHighestGrade[eq.modalTextId]=e.data.notice[i].grade;}
for(var key in dictFaultHighestGrade){if(_this.dictObserverText[key])
_this.dictObserverText[key].updateDiagnosisGrade(dictFaultHighestGrade[key]);}}catch(e){console.log(e)}
$('#spinnerLoadingNotice').remove();$('#btnWarningLog').fadeIn();$('#navigation').fadeIn();$('#diagnosisLogCt').slideDown();}else{$('#spinnerLoadingNotice').remove();}
Spinner.stop();if(isOnlyRenderDictFault)return;$('.badge.warningCount','#paneIcon').empty();$('.badge.alertCount','#paneIcon').empty();if(e.data.count&&e.data.count instanceof Array){e.data.count.forEach(function(obj){for(var i in obj){var warningCount=parseInt(obj[i].warning);var alertCount=parseInt(obj[i].alert);var $targetWarning=$('#navFloor-'+i).next('.warningCount');var $targetAlert=$('#navFloor-'+i).siblings('.alertCount');if(warningCount>0){$targetWarning.html(warningCount);}else{$targetWarning.html('');}
if(alertCount>0){$targetAlert.html(alertCount);}else{$targetAlert.html('');}}});}
_this.statisticFaultCount();_this.renderPaneNoticeGroup();},initPaneNav:function(){var pane=document.createElement('div');var div,zoneItem,itemI,itemJ;var zoneItemList=[];var $buildingBox,$subBuilding=$('.subBuilding'),$subBuildingList,countHtml;var $dropdownBtn=$('#dropdownBtn');for(var zoneId in this.dictZone){zoneItem=this.dictZone[zoneId];zoneItemList.push(zoneItem);}
var paneIcon=document.getElementById('paneIcon');paneIcon.innerHTML="";paneIcon.appendChild(pane);for(var i=0;i<zoneItemList.length;i++){countHtml='';var isSameBuild=false;itemI=zoneItemList[i];for(var j=0;j<zoneItemList.length;j++){itemJ=zoneItemList[j];if(itemI.buildingId==itemJ.buildingId){isSameBuild=true;break;}}
if(isSameBuild){$buildingBox=$('.div-nav-box'+itemI.buildingId);if($buildingBox.length===0){$buildingBox=$('<div class="div-nav-box'+itemI.buildingId+'"><span id="building_'+itemI.buildingId+'" class="grow subBuildingBtn"></span><span class="badge warningCount"></span><span class="badge alertCount"></span></div>');$buildingBox.find('#building_'+itemI.buildingId).html(itemI.buildingName);$subBuildingList=$('<div class="subBuildingList" id="subList_'+itemI.buildingId+'"></div>');$buildingBox.append($subBuildingList);$(pane).append($buildingBox);}
if(itemI.count&&itemI.count>0){countHtml='<span class="badge warningCount">'+itemI.count+'</span><span class="badge alertCount"></span>';}else{countHtml='<span class="badge warningCount"></span><span class="badge alertCount"></span>';}
var $subBuildings=$('#subList_'+itemI.buildingId).children('.subBuilding');var countArry=[];for(var k=0;k<$subBuildings.length;k++){countArry.push(parseInt($subBuildings.eq(k).attr('count')));}
if((countArry.length===0)||(itemI.count>countArry[countArry.length-1])){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$('#subList_'+itemI.buildingId).append($subBuilding);}else{for(var q=0;q<countArry.length;q++){if(itemI.count<countArry[q]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$($subBuildings[q]).before($subBuilding);break;}else if(itemI.count===countArry[q]){if(countArry[q]===countArry[countArry.length-1]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$('#subList_'+itemI.buildingId).append($subBuilding);break;}else{for(var p=q;p<countArry.length;p++){if(itemI.count<countArry[p]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$($subBuildings[p]).before($subBuilding);break;}}
break;}}}}
$dropdownBtn.off('click').on('click',function(){$(this).siblings('.dropdownList').toggleClass('hidden');});$subBuilding.find('.subBuildingItem').off('click').click(function(){var $this=$(this);var id=$this.attr('pageId');AppConfig.zoneId=this.id.split('-')[1];$('.subBuildingItem.selected').removeClass('selected');$this.addClass('selected');$dropdownBtn.html($this.text()+'<span class="caret"></span>');_this.arrLastNotice.length=0;_this.initWorkerForUpdating();$this.closest('.dropdownList').addClass('hidden');});}}
this.statisticFaultCount();$('.subBuildingBtn').off('click').click(function(){$(this).toggleClass('selected');var $subBuildListCur=$(this).siblings('.subBuildingList');if($subBuildListCur.is(':visible')){$subBuildListCur.hide();}else{$subBuildListCur.show();}});},statisticFaultCount:function(){$('[class ^="div-nav-box"]').each(function(){var warningCount=0,alertCount=0;$(this).children('.subBuildingList').find('.warningCount').not(':empty').each(function(){var text=$(this).text();if(Number(text).toString()!='NaN'){warningCount+=parseInt(text);}});if(warningCount>0){$(this).children('.warningCount').html(warningCount);}else{$(this).children('.warningCount').html('');}
$(this).children('.subBuildingList').find('.alertCount').not(':empty').each(function(){var text=$(this).text();if(Number(text).toString()!='NaN'){alertCount+=parseInt(text);}});if(alertCount>0){$(this).children('.alertCount').html(alertCount);}else{$(this).children('.alertCount').html('');}});},renderPaneNoticeGroup:function(){var _this=this;var urgentCount=0,criticalCount=0,className;this.insertLogGroup();var item,parent;for(var i=0,len=_this.arrLastNotice.length;i<len;i++){item=_this.arrLastNotice[i];var grade=item.grade;if(1==grade){className='adNormal';criticalCount++;}
else if(2==grade){className='faultPro';urgentCount++;}
else{continue;}
_this.insertLogItem(item,i,className);}
_this.criticalCount=_this.arrLastNotice.length;if(_this.criticalCount>0){$('#btnWarningLog').find('.badge').html(_this.criticalCount);}else{$('#btnWarningLog').find('.badge').html('');}
var $btnErr=$('#abNomalP');if($btnErr&&$btnErr.length>0){$btnErr.change();}},insertLogGroup:function(){var $abNomalP=$('#abNomalP');var $faultP=$('#faultP');var $divPaneNoticeItem=$('#divPaneNoticeItem');$divPaneNoticeItem.children().remove();$abNomalP.on('change',function(){var $adNormalOne=$divPaneNoticeItem.find('.adNormal');var $faultProOne=$divPaneNoticeItem.find('.faultPro');if(($abNomalP.is(':checked')&&$faultP.is(':checked'))||((!$abNomalP.is(':checked'))&&(!$faultP.is(':checked')))){$adNormalOne.show();$faultProOne.show();}else if($abNomalP.is(':checked')&&(!$faultP.is(':checked'))){$adNormalOne.show();$faultProOne.hide();}else if((!$abNomalP.is(':checked'))&&$faultP.is(':checked')){$adNormalOne.hide();$faultProOne.show();}});$faultP.on('change',function(){var $adNormalTwo=$divPaneNoticeItem.find('.adNormal');var $faultProTwo=$divPaneNoticeItem.find('.faultPro');if(($abNomalP.is(':checked')&&$faultP.is(':checked'))||((!$abNomalP.is(':checked'))&&(!$faultP.is(':checked')))){$adNormalTwo.show();$faultProTwo.show();}else if($abNomalP.is(':checked')&&(!$faultP.is(':checked'))){$adNormalTwo.show();$faultProTwo.hide();}else if((!$abNomalP.is(':checked'))&&$faultP.is(':checked')){$adNormalTwo.hide();$faultProTwo.show();}});},insertLogItem:function(item,itemNum,className){var divParent=$('#divPaneNoticeItem');var _this=this;var divNotice,equipment,zone,sb,span,textId,spanFirst;equipment=this.dictEquipment[item.equipmentId];textId=equipment.modalTextId;zone=this.dictZone[equipment.zoneId];divNotice=document.createElement('div');divNotice.id='divLog-'+itemNum;divNotice.setAttribute('path',zone.id+'-'+equipment.id);divNotice.setAttribute('faultid',item.faultId);divNotice.setAttribute('noticeId',item.id);if(textId!==null)divNotice.setAttribute('data-modaltextid',textId);divNotice.className='div-pane-log';$(divNotice).addClass(className);var parent=$(divNotice);var $spWrap=$('<div style="white-space: nowrap;">');spanFirst=$('<span>');switch(item.grade){case 0:break;case 1:spanFirst.addClass('badge wrongTag').html(_this.langCfg.LEVEL_SET.CRITICAL);break;case 2:spanFirst.addClass('badge dangerTag').html(_this.langCfg.LEVEL_SET.URGENT);break;default:break;}
$spWrap.append(spanFirst);span=$('<span>').addClass('badge grow span-hover-pointer').attr('title','Equipment name').attr('equipment',equipment.pageId).text(equipment.name);span.click(function(e){});$spWrap.append(span);$('<span>').addClass('badge grow span-hover-pointer').attr({'pageId':zone.pageId,'title':'Zone ID','data-zoneId':zone.id}).text(zone.subBuildingName).click(function(e){}).appendTo($spWrap);$('<span>').attr({'title':'Triggering time','data-time':item.time}).text(timeFormat(item.time,timeFormatChange('mm-dd hh:ii'))).addClass('dateTime').appendTo($spWrap);parent.append($spWrap);$('<p>').addClass('pFaultName').css({'font-weight':'bold','padding':'0 8px 0 0'}).text(item.name).appendTo(parent);var strDesc=item.description;if(item.detail){var arr=item.detail.toString().split(',');for(var j=0;j<arr.length;j++){strDesc=strDesc.replace('{'+j.toString()+'}','<span class="variable"> '+arr[j]+' </span>');}}
$('<p>').html(strDesc).appendTo(parent);divParent.append(parent);},};return ModalDiagnosisPanel;})();var ModalDiagnosisPanelHtml=(function(){function ModalDiagnosisPanelHtml(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.screen=screen;this.entity=entityParams;}
ModalDiagnosisPanelHtml.prototype=Object.create(ModalHtml.prototype);ModalDiagnosisPanelHtml.prototype.constructor=ModalDiagnosisPanelHtml;ModalDiagnosisPanelHtml.prototype.optionTemplate={name:'toolBox.modal.DIAGNOSIS_PANEL',parent:0,mode:[''],maxNum:1,title:'',minHeight:4,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDiagnosisPanelHtml'};return ModalDiagnosisPanelHtml;})();﻿var ModalRealtimeWeather=(function(){var weatherImgs={yin:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.291,34.467C70.5,26.344,61.767,21.32,52.311,21.32c-12.728,0-23.524,8.832-26.105,21.158  c-6.569,2.188-11.324,8.382-11.324,15.676c0,9.111,7.414,16.525,16.526,16.525c3.289,0,6.415-0.945,9.119-2.745  c3.647,1.8,7.688,2.745,11.785,2.745c4.251,0,8.451-1.029,12.205-2.966c3.149,1.939,6.733,2.966,10.492,2.966  c11.089,0,20.11-9.021,20.11-20.109C95.118,43.577,86.249,34.621,75.291,34.467z M75.007,69.104c-3.247,0-6.315-1.046-8.877-3.023  c-1.219-0.941-2.969-0.716-3.91,0.503c-0.018,0.021-0.027,0.047-0.045,0.07c-3.019,1.6-6.42,2.45-9.865,2.45  c-3.653,0-7.255-0.947-10.41-2.74c-0.795-0.451-1.713-0.461-2.488-0.123c-0.447,0.072-0.883,0.245-1.263,0.542  c-1.94,1.519-4.271,2.32-6.744,2.32c-6.038,0-10.95-4.911-10.95-10.949s4.912-10.951,10.95-10.951c3.048,0,5.979,1.285,8.048,3.521  c1.044,1.132,2.809,1.201,3.938,0.157c1.131-1.045,1.202-2.809,0.157-3.938c-2.941-3.187-7.042-5.088-11.354-5.296  C34.91,32.951,42.94,26.893,52.31,26.893c6.688,0,12.931,3.178,16.885,8.443c-2.639,0.797-5.108,2.118-7.232,3.93  c-1.171,0.999-1.311,2.761-0.313,3.932c1,1.172,2.762,1.31,3.932,0.31c2.624-2.239,5.973-3.472,9.428-3.472  c8.014,0,14.535,6.52,14.535,14.534C89.542,62.584,83.021,69.104,75.007,69.104z"/>\
                </g>\
                </svg>',dayu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.293,23.69c-4.791-8.123-13.525-13.147-22.981-13.147c-12.726,0-23.525,8.832-26.107,21.159   c-6.568,2.188-11.323,8.381-11.323,15.675c0,9.112,7.414,16.526,16.525,16.526c3.289,0,6.415-0.945,9.119-2.744   c3.648,1.797,7.689,2.744,11.786,2.744c4.25,0,8.452-1.029,12.206-2.966c3.149,1.938,6.732,2.966,10.492,2.966   c11.088,0,20.108-9.021,20.108-20.11C95.118,32.798,86.251,23.841,75.293,23.69z M75.01,58.326c-3.246,0-6.315-1.045-8.877-3.023   c-1.22-0.941-2.971-0.717-3.91,0.503c-0.019,0.021-0.027,0.047-0.043,0.069c-3.021,1.601-6.422,2.451-9.867,2.451   c-3.656,0-7.256-0.947-10.411-2.74c-0.794-0.453-1.713-0.461-2.491-0.123c-0.444,0.074-0.879,0.244-1.26,0.543   c-1.938,1.52-4.271,2.32-6.743,2.32c-6.038,0-10.951-4.912-10.951-10.95c0-6.038,4.913-10.951,10.951-10.951   c3.045,0,5.979,1.285,8.047,3.523c1.047,1.131,2.81,1.202,3.939,0.156c1.131-1.045,1.201-2.81,0.156-3.938   c-2.942-3.185-7.043-5.086-11.354-5.294c2.718-8.697,10.748-14.755,20.117-14.755c6.69,0,12.929,3.177,16.885,8.443   c-2.64,0.797-5.109,2.118-7.233,3.93c-1.17,0.999-1.311,2.76-0.312,3.931c0.999,1.172,2.759,1.311,3.931,0.311   c2.624-2.239,5.973-3.472,9.43-3.472c8.014,0,14.533,6.52,14.533,14.534C89.544,51.806,83.023,58.326,75.01,58.326z"/>\
                    <path d="M44.751,79.875c0,3.084-2.5,5.582-5.583,5.582s-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S44.751,76.791,44.751,79.875z"/>\
                    <path d="M59.557,79.875c0,3.084-2.5,5.582-5.582,5.582c-3.084,0-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S59.557,76.791,59.557,79.875z"/>\
                    <path d="M74.362,79.875c0,3.084-2.499,5.582-5.583,5.582c-3.083,0-5.583-2.498-5.583-5.582   s5.583-11.408,5.583-11.408S74.362,76.791,74.362,79.875z"/>\
                </g>\
                </svg>',baoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.292,23.756c-4.791-8.123-13.524-13.146-22.98-13.146c-12.729,0-23.527,8.832-26.107,21.159   c-6.569,2.187-11.324,8.381-11.324,15.675c0,9.112,7.414,16.526,16.526,16.526c3.29,0,6.416-0.946,9.118-2.745   c3.648,1.799,7.69,2.745,11.787,2.745c4.25,0,8.452-1.03,12.206-2.967c3.148,1.939,6.731,2.967,10.492,2.967   c11.088,0,20.109-9.021,20.109-20.11C95.119,32.865,86.25,23.909,75.292,23.756z M75.008,58.394c-3.246,0-6.316-1.046-8.878-3.024   c-1.219-0.94-2.969-0.716-3.909,0.503c-0.019,0.021-0.027,0.047-0.045,0.07c-3.02,1.6-6.421,2.451-9.865,2.451   c-3.655,0-7.256-0.948-10.412-2.741c-0.795-0.451-1.713-0.461-2.49-0.122c-0.445,0.074-0.881,0.244-1.261,0.542   c-1.94,1.519-4.271,2.321-6.743,2.321c-6.038,0-10.951-4.912-10.951-10.95s4.913-10.951,10.951-10.951   c3.046,0,5.979,1.285,8.047,3.522c1.044,1.132,2.808,1.2,3.938,0.156c1.132-1.045,1.202-2.809,0.157-3.938   c-2.94-3.187-7.042-5.087-11.354-5.295c2.717-8.697,10.748-14.755,20.118-14.755c6.688,0,12.928,3.177,16.884,8.442   c-2.641,0.797-5.11,2.118-7.234,3.931c-1.171,0.999-1.31,2.76-0.313,3.931c1,1.172,2.762,1.31,3.932,0.31   c2.623-2.238,5.973-3.472,9.428-3.472c8.016,0,14.535,6.521,14.535,14.534C89.543,51.872,83.021,58.394,75.008,58.394z"/>\
                    <path d="M30.448,85.391c-0.531,0-1.067-0.149-1.543-0.47c-1.281-0.854-1.628-2.584-0.773-3.864l9.026-13.539   c0.854-1.28,2.584-1.629,3.865-0.772c1.281,0.854,1.627,2.584,0.773,3.865L32.77,84.151C32.232,84.955,31.348,85.391,30.448,85.391   z"/>\
                    <path d="M45.313,85.391c-0.53,0-1.067-0.149-1.543-0.47c-1.281-0.854-1.627-2.584-0.772-3.864l9.026-13.539   c0.854-1.28,2.585-1.629,3.865-0.772c1.281,0.854,1.627,2.584,0.773,3.865l-9.026,13.541   C47.099,84.955,46.214,85.391,45.313,85.391z"/>\
                    <path d="M60.182,85.391c-0.53,0-1.067-0.149-1.543-0.47c-1.283-0.854-1.627-2.584-0.772-3.864l9.024-13.539   c0.854-1.28,2.586-1.629,3.867-0.772c1.279,0.854,1.627,2.584,0.772,3.865l-9.027,13.541   C61.967,84.955,61.083,85.391,60.182,85.391z"/>\
                </g>\
                </svg>',duoyun:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <g>\
                            <path d="M59.271,34.332c-4.592-8.123-12.961-13.146-22.021-13.146c-12.197,0-22.546,8.832-25.019,21.159    C5.936,44.531,1.379,50.726,1.379,58.02c0,9.111,7.104,16.525,15.836,16.525c3.152,0,6.148-0.945,8.739-2.745    c3.495,1.8,7.368,2.745,11.295,2.745c4.074,0,8.098-1.029,11.696-2.966c3.017,1.939,6.451,2.966,10.053,2.966    c10.627,0,19.271-9.021,19.271-20.109C78.271,43.441,69.772,34.485,59.271,34.332z M58.998,68.97    c-3.109,0-6.051-1.047-8.506-3.024c-1.168-0.94-2.845-0.715-3.747,0.503c-0.017,0.021-0.025,0.047-0.042,0.07    c-2.893,1.601-6.153,2.452-9.453,2.452c-3.504,0-6.953-0.948-9.977-2.741c-0.759-0.45-1.639-0.46-2.384-0.123    c-0.428,0.074-0.846,0.244-1.211,0.542c-1.86,1.519-4.096,2.321-6.463,2.321c-5.787,0-10.494-4.912-10.494-10.95    s4.707-10.951,10.494-10.951c2.92,0,5.729,1.285,7.711,3.521c1.003,1.134,2.692,1.202,3.775,0.157    c1.084-1.045,1.15-2.809,0.147-3.938c-2.817-3.187-6.749-5.087-10.88-5.295c2.604-8.697,10.3-14.755,19.277-14.755    c6.411,0,12.39,3.177,16.181,8.442c-2.528,0.797-4.897,2.118-6.934,3.93c-1.121,0.999-1.254,2.761-0.296,3.932    c0.959,1.171,2.645,1.31,3.767,0.31c2.514-2.238,5.722-3.472,9.033-3.472c7.682,0,13.93,6.52,13.93,14.534    C72.928,62.448,66.68,68.97,58.998,68.97z"/>\
                            <g>\
                                <path d="M93.438,42.01c-3.744-6.411-10.431-10.365-17.66-10.365c-3.071,0-6.082,0.715-8.819,2.063     c1.803,1.117,3.451,2.482,4.896,4.05c1.271-0.351,2.588-0.537,3.923-0.537c4.587,0,8.882,2.146,11.767,5.744     c-1.765,0.665-3.414,1.654-4.861,2.941c-1.121,1-1.254,2.759-0.297,3.931c0.957,1.17,2.644,1.312,3.767,0.313     c1.874-1.67,4.269-2.59,6.735-2.59c5.729,0,10.388,4.861,10.388,10.839c0,5.977-4.659,10.84-10.388,10.84     c-2.319,0-4.514-0.78-6.344-2.256c-1.148-0.927-2.791-0.718-3.701,0.452c-2.168,1.176-4.6,1.804-7.064,1.804     c-0.736,0-1.473-0.063-2.195-0.17c-1.275,1.733-2.77,3.286-4.441,4.603c2.129,0.752,4.373,1.145,6.638,1.145     c3.188,0,6.343-0.781,9.181-2.25c2.396,1.469,5.099,2.25,7.93,2.25c8.675,0,15.73-7.365,15.73-16.416     C108.619,49.538,101.856,42.316,93.438,42.01z"/>\
                            </g>\
                        </g>\
                        <path d="M59.271,34.332c-4.592-8.123-12.961-13.146-22.021-13.146c-12.197,0-22.546,8.832-25.019,21.159   C5.936,44.531,1.379,50.726,1.379,58.02c0,9.111,7.104,16.525,15.836,16.525c3.152,0,6.148-0.945,8.739-2.745   c3.495,1.8,7.368,2.745,11.295,2.745c4.074,0,8.098-1.029,11.696-2.966c3.017,1.939,6.451,2.966,10.053,2.966   c10.627,0,19.271-9.021,19.271-20.109C78.271,43.441,69.772,34.485,59.271,34.332z M58.998,68.97c-3.109,0-6.051-1.047-8.506-3.024   c-1.168-0.94-2.845-0.715-3.747,0.503c-0.017,0.021-0.025,0.047-0.042,0.07c-2.893,1.601-6.153,2.452-9.453,2.452   c-3.504,0-6.953-0.948-9.977-2.741c-0.759-0.45-1.639-0.46-2.384-0.123c-0.428,0.074-0.846,0.244-1.211,0.542   c-1.86,1.519-4.096,2.321-6.463,2.321c-5.787,0-10.494-4.912-10.494-10.95s4.707-10.951,10.494-10.951   c2.92,0,5.729,1.285,7.711,3.521c1.003,1.134,2.692,1.202,3.775,0.157c1.084-1.045,1.15-2.809,0.147-3.938   c-2.817-3.187-6.749-5.087-10.88-5.295c2.604-8.697,10.3-14.755,19.277-14.755c6.411,0,12.39,3.177,16.181,8.442   c-2.528,0.797-4.897,2.118-6.934,3.93c-1.121,0.999-1.254,2.761-0.296,3.932c0.959,1.171,2.645,1.31,3.767,0.31   c2.514-2.238,5.722-3.472,9.033-3.472c7.682,0,13.93,6.52,13.93,14.534C72.928,62.448,66.68,68.97,58.998,68.97z"/>\
                    </g>\
                    </svg>',xiaoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.293,23.69c-4.791-8.123-13.523-13.147-22.98-13.147c-12.727,0-23.526,8.831-26.107,21.159   c-6.567,2.188-11.323,8.382-11.323,15.675c0,9.112,7.414,16.526,16.525,16.526c3.289,0,6.415-0.945,9.119-2.744   c3.647,1.799,7.688,2.744,11.786,2.744c4.25,0,8.451-1.029,12.205-2.966c3.147,1.938,6.731,2.966,10.492,2.966   c11.09,0,20.108-9.021,20.108-20.11C95.118,32.798,86.25,23.842,75.293,23.69z M75.009,58.326c-3.246,0-6.316-1.047-8.877-3.023   c-1.22-0.941-2.971-0.717-3.91,0.501c-0.02,0.021-0.027,0.048-0.045,0.069c-2.15,1.142-4.495,1.896-6.912,2.238l-6.184-0.043   c-2.521-0.39-4.963-1.224-7.183-2.482c-0.795-0.453-1.716-0.463-2.493-0.121c-0.443,0.074-0.877,0.244-1.256,0.539   c-1.942,1.52-4.274,2.322-6.745,2.322c-6.038,0-10.951-4.912-10.951-10.951c0-6.038,4.913-10.951,10.951-10.951   c3.046,0,5.979,1.285,8.048,3.523c1.044,1.13,2.811,1.2,3.939,0.156c1.129-1.044,1.2-2.81,0.155-3.938   c-2.941-3.185-7.043-5.086-11.354-5.294c2.716-8.697,10.747-14.755,20.116-14.755c6.689,0,12.929,3.177,16.885,8.443   c-2.639,0.797-5.107,2.118-7.232,3.93c-1.173,1-1.313,2.76-0.313,3.931c0.997,1.17,2.758,1.312,3.93,0.313   c2.625-2.24,5.975-3.473,9.431-3.473c8.015,0,14.534,6.519,14.534,14.534C89.544,51.808,83.024,58.326,75.009,58.326z"/>\
                    <path d="M59.558,79.875c0,3.084-2.5,5.582-5.583,5.582s-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S59.558,76.791,59.558,79.875z"/>\
                </g>\
                </svg>',qing_duoyun:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <g>\
                        <g>\
                            <path d="M90.923,16.534c1.333,0.771,1.79,2.479,1.021,3.811l-3.938,6.816c-0.77,1.334-2.475,1.791-3.809,1.021     c-1.332-0.771-1.79-2.477-1.02-3.811l3.938-6.814C87.885,16.225,89.588,15.768,90.923,16.534z"/>\
                        </g>\
                        <g>\
                            <path d="M103.951,29.564c0.771,1.334,0.313,3.039-1.021,3.809l-6.818,3.938c-1.332,0.771-3.039,0.313-3.809-1.02     c-0.77-1.336-0.314-3.039,1.02-3.811l6.818-3.938C101.477,27.773,103.18,28.232,103.951,29.564z"/>\
                        </g>\
                        <g>\
                            <path d="M108.721,47.36c0,1.541-1.25,2.787-2.787,2.787h-7.873c-1.541,0.002-2.789-1.248-2.789-2.787     c0-1.541,1.248-2.785,2.789-2.787l7.873,0.002C107.471,44.575,108.719,45.819,108.721,47.36z"/>\
                        </g>\
                        <g>\
                            <path d="M103.951,65.157c-0.77,1.334-2.475,1.789-3.809,1.021l-6.817-3.938c-1.333-0.77-1.79-2.475-1.021-3.807     c0.771-1.336,2.475-1.791,3.809-1.021l6.818,3.938C104.266,62.118,104.721,63.823,103.951,65.157z"/>\
                        </g>\
                        <path d="M62.053,28.184c-1.332,0.77-3.037,0.313-3.808-1.021l-3.937-6.818c-0.771-1.332-0.314-3.035,1.02-3.809    c1.333-0.77,3.038-0.313,3.807,1.021l3.938,6.814C63.844,25.708,63.387,27.413,62.053,28.184z"/>\
                        <g>\
                            <path d="M73.126,25.215c-1.541,0-2.788-1.247-2.788-2.787v-7.873c0-1.539,1.247-2.787,2.788-2.787     c1.54,0,2.787,1.248,2.787,2.787v7.873C75.913,23.969,74.666,25.215,73.126,25.215z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M61.691,44.021c-4.791-8.123-13.524-13.15-22.981-13.15c-12.727,0-23.525,8.83-26.105,21.16    C6.035,54.22,1.279,60.412,1.279,67.707c0,9.111,7.414,16.525,16.526,16.525c3.29,0,6.415-0.947,9.118-2.746    c3.648,1.799,7.691,2.746,11.787,2.746c4.251,0,8.451-1.031,12.205-2.965c3.15,1.938,6.732,2.965,10.493,2.965    c11.088,0,20.108-9.021,20.108-20.109C81.518,53.127,72.648,44.172,61.691,44.021z M61.406,78.654    c-3.247,0-6.317-1.045-8.879-3.025c-1.217-0.939-2.969-0.715-3.909,0.505c-0.017,0.022-0.027,0.048-0.046,0.067    c-3.02,1.604-6.42,2.453-9.864,2.453c-3.655,0-7.255-0.945-10.411-2.742c-0.792-0.449-1.71-0.457-2.485-0.121    c-0.447,0.074-0.884,0.244-1.266,0.541c-1.939,1.521-4.271,2.322-6.742,2.322c-6.038,0-10.951-4.912-10.951-10.949    c0-6.039,4.913-10.951,10.951-10.951c3.047,0,5.979,1.283,8.048,3.523c1.045,1.131,2.809,1.201,3.938,0.156    s1.201-2.809,0.156-3.939c-2.942-3.186-7.042-5.086-11.354-5.295c2.719-8.697,10.748-14.754,20.117-14.754    c6.688,0,12.929,3.176,16.884,8.441c-2.638,0.799-5.109,2.117-7.232,3.932c-1.17,0.998-1.312,2.76-0.312,3.93    s2.761,1.311,3.931,0.313c2.625-2.24,5.973-3.475,9.429-3.475c8.014,0,14.534,6.521,14.534,14.535    C75.941,72.134,69.421,78.654,61.406,78.654z"/>\
                        <g>\
                            <path d="M91.902,47.586c0-10.354-8.422-18.775-18.775-18.775c-5.336,0.002-10.3,2.225-13.822,6.068     c1.295,1.174,2.498,2.453,3.584,3.846c2.557-2.959,6.254-4.684,10.238-4.686c7.469,0,13.544,6.076,13.544,13.547     c0,3.023-0.987,5.854-2.702,8.139c0.727,1.932,1.217,3.977,1.42,6.1C89.443,58.344,91.902,53.208,91.902,47.586z"/>\
                            <g>\
                                <path d="M91.943,74.377l-3.938-6.816c-0.55-0.951-1.574-1.445-2.604-1.379c-0.172,2.033-0.6,3.998-1.25,5.855      l2.961,5.126c0.77,1.334,2.475,1.791,3.808,1.021C92.256,77.414,92.713,75.711,91.943,74.377z"/>\
                            </g>\
                        </g>\
                    </g>\
                    <path d="M61.691,44.021c-4.791-8.123-13.524-13.15-22.981-13.15c-12.727,0-23.525,8.83-26.105,21.16   C6.035,54.22,1.279,60.412,1.279,67.707c0,9.111,7.414,16.525,16.526,16.525c3.29,0,6.415-0.947,9.118-2.746   c3.648,1.799,7.691,2.746,11.787,2.746c4.251,0,8.451-1.031,12.205-2.965c3.15,1.938,6.732,2.965,10.493,2.965   c11.088,0,20.108-9.021,20.108-20.109C81.518,53.127,72.648,44.172,61.691,44.021z M61.406,78.654   c-3.247,0-6.317-1.045-8.879-3.025c-1.217-0.939-2.969-0.715-3.909,0.505c-0.017,0.022-0.027,0.048-0.046,0.067   c-3.02,1.604-6.42,2.453-9.864,2.453c-3.655,0-7.255-0.945-10.411-2.742c-0.792-0.449-1.71-0.457-2.485-0.121   c-0.447,0.074-0.884,0.244-1.266,0.541c-1.939,1.521-4.271,2.322-6.742,2.322c-6.038,0-10.951-4.912-10.951-10.949   c0-6.039,4.913-10.951,10.951-10.951c3.047,0,5.979,1.283,8.048,3.523c1.045,1.131,2.809,1.201,3.938,0.156   s1.201-2.809,0.156-3.939c-2.942-3.186-7.042-5.086-11.354-5.295c2.719-8.697,10.748-14.754,20.117-14.754   c6.688,0,12.929,3.176,16.884,8.441c-2.638,0.799-5.109,2.117-7.232,3.932c-1.17,0.998-1.312,2.76-0.312,3.93   s2.761,1.311,3.931,0.313c2.625-2.24,5.973-3.475,9.429-3.475c8.014,0,14.534,6.521,14.534,14.535   C75.941,72.134,69.421,78.654,61.406,78.654z"/>\
                </g>\
                </svg>',qing:'<svg style="fill: #eee;"  x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
				<g>\
					<path d="M54.999,67c-10.354,0-18.776-8.424-18.776-18.774c0-10.354,8.425-18.776,18.776-18.776   c10.354,0,18.775,8.424,18.775,18.776C73.776,58.576,65.354,67,54.999,67z M54.999,34.681c-7.469,0-13.545,6.076-13.545,13.545   c0,7.47,6.076,13.545,13.545,13.545c7.468,0,13.545-6.075,13.545-13.545C68.544,40.756,62.468,34.681,54.999,34.681z"/>\
					<g>\
						<g>\
							<path d="M43.927,67.176c1.333,0.771,1.79,2.479,1.021,3.811l-3.938,6.816c-0.769,1.332-2.476,1.791-3.808,1.023     c-1.334-0.773-1.791-2.479-1.021-3.813l3.938-6.818C40.889,66.865,42.594,66.408,43.927,67.176z"/>\
							<path d="M72.796,17.174c1.333,0.771,1.79,2.476,1.021,3.81l-3.938,6.815c-0.771,1.334-2.476,1.791-3.808,1.022     c-1.334-0.77-1.791-2.475-1.021-3.809l3.938-6.818C69.758,16.861,71.462,16.404,72.796,17.174z"/>\
						</g>\
						<g>\
							<path d="M35.821,59.07c0.771,1.334,0.313,3.039-1.021,3.811l-6.817,3.936c-1.334,0.77-3.039,0.313-3.81-1.02     c-0.771-1.334-0.313-3.036,1.021-3.809l6.816-3.938C33.346,57.281,35.052,57.738,35.821,59.07z"/>\
							<path d="M85.825,30.204c0.77,1.334,0.313,3.039-1.021,3.807l-6.816,3.938c-1.334,0.77-3.039,0.313-3.811-1.021     c-0.77-1.336-0.313-3.039,1.021-3.809l6.816-3.938C83.351,28.413,85.054,28.87,85.825,30.204z"/>\
						</g>\
						<g>\
							<path d="M32.854,48c0,1.539-1.246,2.785-2.787,2.785h-7.873c-1.539,0-2.787-1.248-2.787-2.785     c0-1.541,1.246-2.787,2.787-2.787l7.873-0.002C31.608,45.211,32.854,46.459,32.854,48z"/>\
							<path d="M90.593,48c0,1.539-1.248,2.785-2.788,2.785h-7.872c-1.541,0.002-2.787-1.248-2.787-2.785     c0-1.541,1.246-2.787,2.787-2.789l7.872,0.002C89.345,45.213,90.593,46.459,90.593,48z"/>\
						</g>\
						<g>\
							<path d="M35.821,36.926c-0.771,1.336-2.475,1.791-3.809,1.021l-6.816-3.938c-1.334-0.768-1.791-2.473-1.021-3.807     c0.771-1.334,2.477-1.791,3.809-1.021l6.817,3.938C36.134,33.89,36.591,35.595,35.821,36.926z"/>\
							<path d="M85.825,65.797c-0.771,1.334-2.475,1.789-3.811,1.02l-6.816-3.936c-1.332-0.77-1.791-2.477-1.021-3.809     c0.771-1.334,2.476-1.791,3.81-1.021l6.817,3.937C86.137,62.758,86.594,64.463,85.825,65.797z"/>\
						</g>\
						<g>\
							<path d="M43.927,28.822c-1.334,0.769-3.038,0.312-3.809-1.021l-3.938-6.817c-0.77-1.334-0.313-3.037,1.021-3.808     c1.332-0.771,3.037-0.313,3.808,1.021l3.938,6.818C45.717,26.349,45.26,28.054,43.927,28.822z"/>\
							<path d="M72.796,78.824c-1.333,0.771-3.038,0.313-3.809-1.021l-3.938-6.815c-0.77-1.334-0.313-3.039,1.021-3.809     c1.332-0.77,3.037-0.313,3.808,1.021l3.938,6.816C74.586,76.35,74.129,78.053,72.796,78.824z"/>\
						</g>\
						<g>\
							<path d="M54.999,25.854c-1.54,0-2.788-1.248-2.788-2.787v-7.873c0-1.538,1.248-2.786,2.788-2.786     c1.539,0,2.787,1.248,2.787,2.786v7.873C57.788,24.607,56.54,25.854,54.999,25.854z"/>\
							<path d="M54.999,83.592c-1.54,0-2.788-1.246-2.788-2.787v-7.871c0-1.541,1.248-2.789,2.788-2.789     c1.539,0,2.787,1.248,2.787,2.789v7.871C57.788,82.346,56.54,83.592,54.999,83.592z"/>\
						</g>\
					</g>\
				</g>\
			</svg>',duoyun_zhenyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                        <g>\
                            <g>\
                                <g>\
                                    <g>\
                                        <path d="M90.924,5.36c1.334,0.771,1.791,2.476,1.021,3.81l-3.938,6.817c-0.77,1.334-2.475,1.791-3.809,1.021      c-1.332-0.771-1.789-2.476-1.021-3.81l3.939-6.815C87.885,5.049,89.59,4.592,90.924,5.36z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M103.953,18.39c0.77,1.334,0.313,3.039-1.021,3.807l-6.818,3.938c-1.332,0.771-3.037,0.313-3.809-1.021      c-0.77-1.334-0.313-3.039,1.021-3.809l6.818-3.938C101.477,16.599,103.18,17.056,103.953,18.39z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M108.721,36.187c0,1.541-1.248,2.787-2.787,2.787h-7.873c-1.543,0-2.787-1.248-2.787-2.787      c0-1.541,1.244-2.787,2.785-2.787h7.873C107.473,33.399,108.719,34.646,108.721,36.187z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M103.953,53.983c-0.771,1.334-2.477,1.789-3.811,1.021l-6.816-3.937      c-1.334-0.771-1.791-2.476-1.021-3.808c0.771-1.336,2.477-1.79,3.809-1.021l6.816,3.938      C104.264,50.944,104.721,52.649,103.953,53.983z"/>\
                                    </g>\
                                    <path d="M62.053,17.008c-1.332,0.771-3.037,0.313-3.807-1.021l-3.938-6.818c-0.77-1.334-0.313-3.037,1.021-3.808     c1.332-0.771,3.037-0.313,3.807,1.021l3.939,6.815C63.844,14.534,63.387,16.239,62.053,17.008z"/>\
                                    <g>\
                                        <path d="M73.127,14.041c-1.539,0-2.787-1.247-2.787-2.788V3.38c0-1.539,1.248-2.786,2.787-2.786      c1.541,0,2.789,1.247,2.789,2.786v7.873C75.916,12.794,74.668,14.041,73.127,14.041z"/>\
                                    </g>\
                                </g>\
                                <g>\
                                    <path d="M61.691,32.845c-4.791-8.121-13.523-13.148-22.98-13.148c-12.729,0-23.527,8.83-26.107,21.16     C6.035,43.043,1.279,49.235,1.279,56.532c0,9.111,7.414,16.523,16.525,16.523c3.291,0,6.416-0.945,9.121-2.742     c3.646,1.797,7.689,2.742,11.785,2.742c4.252,0,8.453-1.031,12.207-2.966c3.148,1.938,6.73,2.966,10.492,2.966     c11.088,0,20.107-9.021,20.107-20.109C81.516,41.952,72.65,32.998,61.691,32.845z M61.408,67.48     c-3.246,0-6.316-1.045-8.879-3.025c-1.219-0.939-2.971-0.716-3.91,0.505c-0.018,0.021-0.027,0.047-0.043,0.067     c-3.02,1.604-6.422,2.453-9.867,2.453c-3.654,0-7.254-0.947-10.41-2.742c-0.793-0.449-1.711-0.459-2.488-0.121     c-0.445,0.074-0.883,0.244-1.264,0.541c-1.939,1.521-4.271,2.322-6.744,2.322c-6.039,0-10.951-4.912-10.951-10.949     c0-6.041,4.914-10.953,10.951-10.953c3.047,0,5.98,1.285,8.047,3.523c1.045,1.133,2.811,1.203,3.941,0.155     c1.131-1.043,1.199-2.808,0.154-3.938c-2.939-3.187-7.043-5.088-11.354-5.295c2.717-8.697,10.748-14.756,20.115-14.756     c6.689,0,12.93,3.178,16.885,8.442c-2.639,0.799-5.109,2.116-7.234,3.931c-1.172,1-1.311,2.76-0.311,3.932     c1,1.17,2.76,1.31,3.93,0.312c2.623-2.239,5.973-3.474,9.43-3.474c8.014,0,14.533,6.521,14.533,14.533S69.422,67.48,61.408,67.48     z"/>\
                                    <g>\
                                        <path d="M91.904,36.411c0-10.354-8.424-18.773-18.777-18.773c-5.336,0-10.301,2.225-13.822,6.068      c1.295,1.173,2.498,2.453,3.584,3.846c2.557-2.96,6.254-4.684,10.238-4.686c7.469,0,13.547,6.076,13.547,13.545      c0,3.025-0.99,5.854-2.705,8.141c0.727,1.932,1.217,3.977,1.42,6.098C89.445,47.166,91.904,42.034,91.904,36.411z"/>\
                                        <g>\
                                            <path d="M91.945,63.203l-3.939-6.819c-0.549-0.948-1.574-1.442-2.604-1.377c-0.174,2.034-0.6,3.998-1.248,5.856       l2.959,5.125c0.771,1.336,2.477,1.791,3.809,1.021C92.258,66.24,92.715,64.537,91.945,63.203z"/>\
                                        </g>\
                                    </g>\
                                </g>\
                                <path d="M61.691,32.845c-4.791-8.121-13.523-13.148-22.98-13.148c-12.729,0-23.527,8.83-26.107,21.16    C6.035,43.043,1.279,49.235,1.279,56.532c0,9.111,7.414,16.523,16.525,16.523c3.291,0,6.416-0.945,9.121-2.742    c3.646,1.797,7.689,2.742,11.785,2.742c4.252,0,8.453-1.031,12.207-2.966c3.148,1.938,6.73,2.966,10.492,2.966    c11.088,0,20.107-9.021,20.107-20.109C81.516,41.952,72.65,32.998,61.691,32.845z M61.408,67.48c-3.246,0-6.316-1.045-8.879-3.025    c-1.219-0.939-2.971-0.716-3.91,0.505c-0.018,0.021-0.027,0.047-0.043,0.067c-3.02,1.604-6.422,2.453-9.867,2.453    c-3.654,0-7.254-0.947-10.41-2.742c-0.793-0.449-1.711-0.459-2.488-0.121c-0.445,0.074-0.883,0.244-1.264,0.541    c-1.939,1.521-4.271,2.322-6.744,2.322c-6.039,0-10.951-4.912-10.951-10.949c0-6.041,4.914-10.953,10.951-10.953    c3.047,0,5.98,1.285,8.047,3.523c1.045,1.133,2.811,1.203,3.941,0.155c1.131-1.043,1.199-2.808,0.154-3.938    c-2.939-3.187-7.043-5.088-11.354-5.295c2.717-8.697,10.748-14.756,20.115-14.756c6.689,0,12.93,3.178,16.885,8.442    c-2.639,0.799-5.109,2.116-7.234,3.931c-1.172,1-1.311,2.76-0.311,3.932c1,1.17,2.76,1.31,3.93,0.312    c2.623-2.239,5.973-3.474,9.43-3.474c8.014,0,14.533,6.521,14.533,14.533S69.422,67.48,61.408,67.48z"/>\
                            </g>\
                            <path d="M39.525,89.822c0,3.086-2.5,5.584-5.582,5.584c-3.084,0-5.584-2.498-5.584-5.584   c0-3.082,5.584-11.406,5.584-11.406S39.525,86.74,39.525,89.822z"/>\
                            <path d="M54.332,89.822c0,3.086-2.5,5.584-5.582,5.584c-3.084,0-5.584-2.498-5.584-5.584   c0-3.082,5.584-11.406,5.584-11.406S54.332,86.74,54.332,89.822z"/>\
                        </g>\
                        </svg>',dalei:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <g>\
                        <path d="M75.294,27.418c-4.791-8.121-13.525-13.146-22.98-13.146c-12.729,0-23.527,8.83-26.107,21.16    c-6.57,2.187-11.324,8.379-11.324,15.674c0,9.11,7.414,16.524,16.525,16.524c3.291,0,6.416-0.945,9.119-2.744    c0.365,0.181,0.738,0.347,1.111,0.508c0.352-0.805,1.945-5.232,1.945-5.232c-0.57-0.261-1.137-0.537-1.682-0.849    c-0.795-0.449-1.51-0.694-2.453-0.248c-0.445,0.073-0.918,0.37-1.301,0.67c-1.938,1.519-4.271,2.319-6.742,2.319    c-6.037,0-10.949-4.912-10.949-10.948c0-6.039,4.912-10.951,10.949-10.951c3.047,0,5.979,1.283,8.047,3.523    c1.047,1.131,2.811,1.201,3.939,0.156s1.199-2.808,0.156-3.938c-2.943-3.187-7.045-5.088-11.354-5.293    c2.717-8.699,10.746-14.756,20.115-14.756c6.689,0,12.93,3.176,16.887,8.441c-2.641,0.801-5.109,2.118-7.234,3.934    c-1.172,0.998-1.311,2.758-0.311,3.928c0.996,1.172,2.758,1.312,3.93,0.312c2.623-2.24,5.973-3.474,9.43-3.474    c8.014,0,14.535,6.521,14.535,14.535c0,8.015-6.521,14.532-14.535,14.532c-2.246,0-4.402-0.51-6.369-1.475    c-0.469,1.172-2.086,5.172-2.086,5.172c2.625,1.228,5.48,1.879,8.455,1.879c11.088,0,20.107-9.021,20.107-20.108    C95.118,36.528,86.251,27.571,75.294,27.418z"/>\
                    </g>\
                    <path d="M56.185,45.789c0.055-0.529-0.09-0.57-0.32-0.093l-9.371,19.437c-0.23,0.479,0.016,0.871,0.545,0.871h6.012   c0.529,0,0.936,0.432,0.896,0.961l-1,14.333c-0.035,0.529,0.129,0.576,0.367,0.103l10.475-20.774c0.24-0.476,0-0.869-0.529-0.881   l-7.525-0.149c-0.527-0.011-0.92-0.451-0.863-0.979L56.185,45.789z"/>\
                </g>\
                </svg>',dalei_baoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                        <g>\
                            <g>\
                                <g>\
                                    <path d="M75.293,20.978C70.502,12.855,61.768,7.832,52.311,7.832c-12.727,0-23.523,8.83-26.104,21.159     c-6.57,2.187-11.326,8.38-11.326,15.675c0,9.11,7.414,16.524,16.525,16.524c3.289,0,6.416-0.944,9.119-2.744     c0.365,0.181,0.738,0.345,1.111,0.509c0.35-0.806,1.947-5.234,1.947-5.234c-0.572-0.26-1.137-0.535-1.684-0.848     c-0.795-0.449-1.508-0.695-2.453-0.248c-0.445,0.073-0.918,0.373-1.301,0.668c-1.938,1.52-4.27,2.319-6.742,2.319     c-6.037,0-10.949-4.909-10.949-10.946c0-6.039,4.912-10.953,10.949-10.953c3.047,0,5.979,1.285,8.049,3.524     c1.047,1.132,2.809,1.201,3.938,0.156s1.201-2.809,0.156-3.938c-2.939-3.187-7.043-5.089-11.354-5.295     c2.719-8.697,10.748-14.755,20.115-14.755c6.691,0,12.932,3.175,16.887,8.441c-2.641,0.799-5.109,2.119-7.234,3.932     c-1.17,1-1.311,2.759-0.311,3.929c1,1.174,2.76,1.311,3.932,0.313c2.623-2.24,5.971-3.473,9.426-3.473     c8.016,0,14.535,6.521,14.535,14.535c0,8.012-6.521,14.53-14.535,14.53c-2.244,0-4.4-0.511-6.367-1.476     c-0.471,1.174-2.086,5.174-2.086,5.174c2.625,1.229,5.482,1.88,8.453,1.88c11.09,0,20.111-9.021,20.111-20.108     C95.119,30.088,86.252,21.131,75.293,20.978z"/>\
                                </g>\
                                <path d="M56.182,39.349c0.055-0.529-0.09-0.57-0.32-0.092L46.49,58.693c-0.229,0.479,0.018,0.869,0.547,0.869    h6.012c0.531,0,0.936,0.435,0.896,0.961l-1,14.332c-0.035,0.529,0.129,0.576,0.365,0.104l10.479-20.774    c0.236-0.476,0-0.869-0.529-0.881l-7.525-0.15c-0.529-0.01-0.92-0.45-0.865-0.979L56.182,39.349z"/>\
                            </g>\
                            <path d="M69.432,88.168c-0.484,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.965-3.821l5.5-9.219   c0.787-1.322,2.502-1.753,3.82-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.502,9.219C71.307,87.68,70.383,88.168,69.432,88.168z   "/>\
                            <path d="M40.76,88.168c-0.486,0-0.98-0.127-1.426-0.396c-1.322-0.786-1.756-2.495-0.967-3.821l5.5-9.219   c0.789-1.322,2.502-1.753,3.822-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.502,9.219C42.635,87.68,41.709,88.168,40.76,88.168z   "/>\
                            <path d="M26.424,88.168c-0.486,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.967-3.821l5.502-9.219   c0.789-1.322,2.502-1.753,3.82-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.5,9.219C28.299,87.68,27.375,88.168,26.424,88.168z"/>\
                            <path d="M55.096,88.168c-0.486,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.967-3.821l5.5-9.219   c0.789-1.322,2.504-1.753,3.822-0.968c1.322,0.793,1.754,2.502,0.967,3.824l-5.502,9.219C56.971,87.68,56.047,88.168,55.096,88.168   z"/>\
                        </g>\
                        </svg>',daxue:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.294,18.086C70.503,9.963,61.771,4.94,52.313,4.94c-12.729,0-23.525,8.828-26.107,21.158   c-6.568,2.187-11.324,8.381-11.324,15.676c0,9.11,7.414,16.524,16.525,16.524c3.291,0,6.416-0.946,9.119-2.745   c3.648,1.797,7.689,2.745,11.787,2.745c4.25,0,8.451-1.032,12.205-2.967c3.146,1.938,6.73,2.967,10.492,2.967   c11.088,0,20.107-9.022,20.107-20.11C95.12,27.196,86.251,18.237,75.294,18.086z M75.011,52.721c-3.248,0-6.316-1.048-8.877-3.022   c-1.219-0.941-2.971-0.716-3.91,0.5c-0.02,0.022-0.027,0.049-0.045,0.073c-3.021,1.599-6.42,2.449-9.865,2.449   c-3.654,0-7.254-0.944-10.41-2.742c-0.795-0.45-1.715-0.461-2.492-0.123c-0.445,0.074-0.881,0.248-1.26,0.546   c-1.939,1.518-4.271,2.319-6.744,2.319c-6.037,0-10.951-4.912-10.951-10.946c0-6.041,4.914-10.955,10.951-10.955   c3.047,0,5.98,1.284,8.047,3.526c1.045,1.129,2.809,1.198,3.939,0.153c1.129-1.045,1.201-2.812,0.156-3.938   c-2.941-3.185-7.043-5.088-11.355-5.295c2.717-8.696,10.748-14.754,20.117-14.754c6.689,0,12.93,3.176,16.885,8.44   c-2.639,0.799-5.111,2.119-7.234,3.932c-1.172,1-1.311,2.763-0.311,3.932c1,1.17,2.76,1.313,3.93,0.313   c2.623-2.241,5.973-3.477,9.428-3.477c8.016,0,14.533,6.521,14.533,14.536C89.544,46.204,83.026,52.721,75.011,52.721z"/>\
                    <g>\
                        <g>\
                            <path d="M45.401,65.618c0.529,0.918,0.217,2.09-0.701,2.621l-10.115,5.84c-0.918,0.528-2.09,0.215-2.617-0.703     c-0.529-0.918-0.217-2.088,0.699-2.619l10.117-5.84C43.7,64.387,44.872,64.702,45.401,65.618z"/>\
                        </g>\
                        <g>\
                            <path d="M45.401,73.375c-0.529,0.918-1.701,1.232-2.619,0.703l-10.115-5.84c-0.918-0.531-1.229-1.703-0.701-2.621     c0.529-0.916,1.701-1.229,2.617-0.701l10.117,5.84C45.616,71.288,45.931,72.457,45.401,73.375z"/>\
                        </g>\
                        <g>\
                            <path d="M38.683,77.255c-1.059,0-1.916-0.856-1.916-1.92v-11.68c0-1.059,0.857-1.918,1.916-1.918     s1.918,0.859,1.918,1.918v11.68C40.601,76.398,39.741,77.255,38.683,77.255z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M76.196,65.618c0.529,0.918,0.215,2.09-0.701,2.621l-10.115,5.84c-0.918,0.528-2.09,0.215-2.619-0.701     c-0.529-0.92-0.215-2.09,0.701-2.621l10.115-5.84C74.495,64.387,75.667,64.702,76.196,65.618z"/>\
                        </g>\
                        <g>\
                            <path d="M76.196,73.375c-0.529,0.918-1.701,1.232-2.617,0.703l-10.117-5.84c-0.916-0.531-1.23-1.703-0.701-2.621     c0.529-0.916,1.701-1.229,2.619-0.701l10.115,5.84C76.411,71.288,76.726,72.457,76.196,73.375z"/>\
                        </g>\
                        <g>\
                            <path d="M69.479,77.255c-1.061,0-1.916-0.856-1.916-1.92v-11.68c0-1.059,0.855-1.918,1.916-1.918     c1.059,0,1.916,0.859,1.916,1.918v11.68C71.396,76.398,70.538,77.255,69.479,77.255z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M60.798,79.425c0.529,0.916,0.217,2.089-0.701,2.615l-10.115,5.842c-0.916,0.527-2.088,0.218-2.619-0.7     c-0.529-0.916-0.215-2.091,0.703-2.619l10.115-5.839C59.097,78.192,60.269,78.505,60.798,79.425z"/>\
                        </g>\
                        <g>\
                            <path d="M60.798,87.182c-0.527,0.918-1.701,1.229-2.617,0.7l-10.115-5.84c-0.918-0.528-1.232-1.701-0.703-2.617     c0.531-0.919,1.703-1.233,2.619-0.702l10.117,5.839C61.013,85.091,61.327,86.266,60.798,87.182z"/>\
                        </g>\
                        <g>\
                            <path d="M54.079,91.06c-1.059,0-1.916-0.857-1.916-1.916V77.462c0-1.059,0.857-1.916,1.916-1.916     c1.061,0,1.918,0.857,1.918,1.916v11.682C55.997,90.202,55.138,91.06,54.079,91.06z"/>\
                        </g>\
                    </g>\
                </g>\
                </svg>',yujiaxue:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <path d="M60.281,85.717c0,3.082-2.5,5.582-5.582,5.582c-3.084,0-5.584-2.5-5.584-5.582s5.584-11.406,5.584-11.406   S60.281,82.635,60.281,85.717z"/>\
                        <path d="M75.291,17.851C70.5,9.728,61.766,4.701,52.311,4.701c-12.727,0-23.525,8.832-26.107,21.16   c-6.568,2.187-11.322,8.381-11.322,15.674c0,9.115,7.414,16.525,16.525,16.525c3.289,0,6.414-0.944,9.117-2.74   c3.648,1.796,7.691,2.74,11.787,2.74c4.252,0,8.451-1.028,12.205-2.964c3.15,1.939,6.734,2.964,10.494,2.964   c11.088,0,20.109-9.021,20.109-20.107C95.117,26.961,86.248,18.004,75.291,17.851z M75.006,52.488   c-3.246,0-6.316-1.048-8.877-3.025c-1.219-0.94-2.969-0.717-3.91,0.5c-0.018,0.022-0.029,0.049-0.045,0.074   c-3.02,1.598-6.42,2.451-9.865,2.451c-3.656,0-7.256-0.949-10.412-2.742c-0.795-0.453-1.713-0.463-2.492-0.123   c-0.441,0.074-0.879,0.246-1.258,0.543c-1.939,1.521-4.27,2.322-6.744,2.322c-6.037,0-10.951-4.913-10.951-10.954   c0-6.037,4.914-10.948,10.951-10.948c3.047,0,5.98,1.284,8.049,3.522c1.043,1.131,2.809,1.201,3.939,0.156   c1.131-1.045,1.201-2.81,0.158-3.938c-2.941-3.184-7.043-5.086-11.355-5.297c2.717-8.694,10.746-14.752,20.117-14.752   c6.689,0,12.928,3.176,16.883,8.441c-2.639,0.799-5.109,2.119-7.232,3.932c-1.17,1.002-1.311,2.76-0.311,3.928   c1,1.175,2.76,1.313,3.93,0.313c2.623-2.24,5.971-3.473,9.428-3.473c8.014,0,14.535,6.521,14.535,14.534   C89.543,45.969,83.021,52.488,75.006,52.488z"/>\
                        <g>\
                            <g>\
                                <path d="M45.396,65.385c0.531,0.916,0.215,2.088-0.701,2.617L34.58,73.844c-0.918,0.529-2.09,0.213-2.619-0.7     c-0.529-0.918-0.215-2.091,0.701-2.621l10.115-5.838C43.695,64.154,44.869,64.469,45.396,65.385z"/>\
                            </g>\
                            <g>\
                                <path d="M45.396,73.142c-0.529,0.913-1.701,1.229-2.619,0.7L32.662,68c-0.916-0.529-1.23-1.701-0.701-2.617     s1.701-1.229,2.617-0.701l10.117,5.839C45.611,71.053,45.928,72.223,45.396,73.142z"/>\
                            </g>\
                            <g>\
                                <path d="M38.68,77.021c-1.061,0-1.918-0.858-1.918-1.918V63.42c0-1.057,0.857-1.918,1.918-1.918     c1.059,0,1.916,0.861,1.916,1.918v11.683C40.596,76.162,39.738,77.021,38.68,77.021z"/>\
                            </g>\
                        </g>\
                        <g>\
                            <g>\
                                <path d="M76.191,65.383c0.531,0.918,0.217,2.09-0.699,2.619l-10.117,5.842c-0.918,0.529-2.09,0.213-2.619-0.7     c-0.529-0.918-0.215-2.091,0.701-2.621l10.117-5.838C74.492,64.154,75.666,64.469,76.191,65.383z"/>\
                            </g>\
                            <g>\
                                <path d="M76.193,73.142c-0.529,0.913-1.701,1.229-2.617,0.7L63.459,68c-0.918-0.529-1.23-1.701-0.703-2.617     c0.529-0.916,1.701-1.229,2.619-0.701l10.117,5.839C76.408,71.053,76.723,72.223,76.193,73.142z"/>\
                            </g>\
                            <g>\
                                <path d="M69.475,77.021c-1.061,0-1.916-0.858-1.916-1.918V63.42c0-1.057,0.855-1.918,1.916-1.918     s1.918,0.861,1.918,1.918v11.683C71.393,76.162,70.535,77.021,69.475,77.021z"/>\
                            </g>\
                        </g>\
                    </g>\
                    </svg>',leizhenyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M44.017,83.052c0,3.084-2.5,5.582-5.582,5.582c-3.084,0-5.582-2.498-5.582-5.582   c0-3.085,5.582-11.407,5.582-11.407S44.017,79.967,44.017,83.052z"/>\
                    <path d="M61.212,83.052c0,3.084-2.5,5.582-5.584,5.582c-3.082,0-5.582-2.498-5.582-5.582   c0-3.085,5.582-11.407,5.582-11.407S61.212,79.967,61.212,83.052z"/>\
                    <path d="M78.733,83.052c0,3.084-2.498,5.582-5.58,5.582c-3.084,0-5.584-2.498-5.584-5.582   c0-3.085,5.584-11.407,5.584-11.407S78.733,79.967,78.733,83.052z"/>\
                    <g>\
                        <g>\
                            <path d="M48.616,38.884c0.053-0.528-0.09-0.569-0.32-0.091l-9.371,19.436c-0.23,0.479,0.016,0.869,0.545,0.869     h6.012c0.531,0,0.936,0.435,0.896,0.963l-1,14.336c-0.035,0.528,0.129,0.573,0.367,0.102l10.477-20.775     c0.238-0.474,0-0.869-0.529-0.881l-7.523-0.15c-0.529-0.011-0.92-0.449-0.865-0.979L48.616,38.884z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M48.616,38.884c0.053-0.528-0.09-0.569-0.32-0.091l-9.371,19.436c-0.23,0.479,0.016,0.869,0.545,0.869    h6.012c0.531,0,0.936,0.435,0.896,0.963l-1,14.336c-0.035,0.528,0.129,0.573,0.367,0.102l10.477-20.775    c0.238-0.474,0-0.869-0.529-0.881l-7.523-0.15c-0.529-0.011-0.92-0.449-0.865-0.979L48.616,38.884z"/>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M68.927,38.884c0.055-0.528-0.092-0.569-0.32-0.091l-9.373,19.436c-0.23,0.479,0.016,0.869,0.545,0.869     h6.012c0.531,0,0.936,0.435,0.898,0.963l-1,14.336c-0.037,0.528,0.127,0.573,0.367,0.102L76.53,53.723     c0.238-0.474,0-0.869-0.531-0.881l-7.523-0.15c-0.531-0.011-0.92-0.449-0.865-0.979L68.927,38.884z"/>\
                        </g>\
                        <g>\
                            <path d="M95.118,40.618c0-10.994-8.869-19.951-19.826-20.104c-4.791-8.123-13.523-13.148-22.98-13.148     c-12.727,0-23.523,8.834-26.105,21.157c-6.57,2.189-11.324,8.386-11.324,15.679c0,9.11,7.414,16.521,16.523,16.521     c1.021,0,2.023-0.098,3.008-0.273c-0.52-1.365-0.461-2.908,0.207-4.295l0.863-1.793c-1.283,0.514-2.654,0.788-4.078,0.788     c-6.039,0-10.949-4.911-10.949-10.948c0-6.041,4.91-10.953,10.949-10.953c3.045,0,5.98,1.285,8.049,3.524     c1.043,1.132,2.809,1.199,3.938,0.154c1.131-1.045,1.201-2.807,0.156-3.938c-2.941-3.184-7.043-5.086-11.354-5.293     c2.717-8.699,10.746-14.754,20.117-14.754c6.689,0,12.928,3.176,16.885,8.442c-2.641,0.797-5.111,2.115-7.236,3.928     c-1.17,1.002-1.309,2.761-0.309,3.933c1,1.17,2.76,1.311,3.93,0.311c2.623-2.242,5.973-3.475,9.428-3.475     c8.016,0,14.533,6.521,14.533,14.537c0,5.723-3.336,10.674-8.156,13.041c-0.041,0.752-0.23,1.506-0.588,2.213l-2.289,4.543     C87.935,58.754,95.118,50.512,95.118,40.618z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M68.927,38.884c0.055-0.528-0.092-0.569-0.32-0.091l-9.373,19.436c-0.23,0.479,0.016,0.869,0.545,0.869    h6.012c0.531,0,0.936,0.435,0.898,0.963l-1,14.336c-0.037,0.528,0.127,0.573,0.367,0.102L76.53,53.723    c0.238-0.474,0-0.869-0.531-0.881l-7.523-0.15c-0.531-0.011-0.92-0.449-0.865-0.979L68.927,38.884z"/>\
                    </g>\
                </g>\
                </svg>',ye_yin:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M77.502,43.357c-5.789-9.226-3.951-21.271,3.67-29.865c-2.723,0.771-5.41,1.939-7.963,3.545   C65.748,21.723,61.068,29,59.826,36.529c-4.893-4.662-11.439-7.381-18.389-7.381c-12.727,0-23.525,8.832-26.105,21.161   C8.764,52.496,4.008,58.689,4.008,65.982c0,9.109,7.414,16.525,16.525,16.525c3.287,0,6.416-0.949,9.117-2.744   c3.648,1.793,7.691,2.744,11.787,2.744c4.252,0,8.451-1.031,12.205-2.967c3.15,1.938,6.734,2.967,10.492,2.967   c10.787,0,19.611-8.535,20.088-19.205c5.082-0.135,10.33-1.639,15.113-4.643c2.555-1.604,4.775-3.51,6.656-5.631   C94.941,56.162,83.291,52.578,77.502,43.357z M64.137,76.932c-3.246,0-6.314-1.047-8.877-3.021c-1.219-0.943-2.969-0.717-3.91,0.5   c-0.018,0.021-0.025,0.049-0.043,0.068c-3.02,1.604-6.422,2.453-9.867,2.453c-3.654,0-7.256-0.945-10.41-2.74   c-0.795-0.451-1.713-0.459-2.488-0.123c-0.445,0.072-0.881,0.248-1.262,0.545c-1.941,1.518-4.273,2.318-6.744,2.318   c-6.037,0-10.949-4.91-10.949-10.949c0-6.037,4.912-10.949,10.949-10.949c3.047,0,5.979,1.283,8.049,3.521   c1.045,1.129,2.809,1.201,3.938,0.156s1.201-2.809,0.156-3.939c-2.943-3.184-7.045-5.086-11.354-5.297   c2.717-8.693,10.746-14.754,20.115-14.754c6.691,0,12.93,3.177,16.887,8.441c-2.639,0.799-5.109,2.117-7.234,3.932   c-1.17,1-1.313,2.758-0.313,3.93c0.998,1.172,2.758,1.311,3.932,0.313c2.625-2.24,5.973-3.475,9.428-3.475   c8.016,0,14.535,6.521,14.535,14.534C78.672,70.412,72.15,76.932,64.137,76.932z"/>\
                    <polygon points="91.719,25.223 95.803,23.078 95.021,27.626 98.326,30.843 93.762,31.509 91.719,35.648    89.676,31.509 85.109,30.843 88.412,27.626 87.635,23.078  "/>\
                    <polygon points="52.994,19.479 55.869,17.97 55.32,21.171 57.648,23.441 54.432,23.908 52.994,26.824    51.555,23.908 48.338,23.441 50.664,21.171 50.117,17.97  "/>\
                </g>\
                </svg>',ye_qing:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <polygon points="64.13,36.086 68.216,33.936 67.435,38.487 70.739,41.709 66.173,42.369 64.13,46.507    62.087,42.369 57.522,41.709 60.825,38.487 60.046,33.936  "/>\
                        <polygon points="68.909,51.216 71.786,49.707 71.237,52.91 73.565,55.179 70.347,55.645 68.909,58.559    67.472,55.645 64.253,55.179 66.581,52.91 66.032,49.707  "/>\
                        <g>\
                            <path d="M61.856,77.953c-0.002,0-0.002,0-0.002,0c-11.102-0.002-21.279-5.582-27.236-14.936    c-4.629-7.266-6.15-15.896-4.283-24.311c1.865-8.414,6.896-15.594,14.162-20.224c0.977-0.623,2.24-0.575,3.17,0.119    c0.928,0.697,1.328,1.896,1.004,3.011c-0.043,0.15-4.369,15.786,4.723,29.371c8.965,13.393,24.672,16.801,24.828,16.83    c1.109,0.23,1.973,1.111,2.176,2.229c0.203,1.115-0.285,2.246-1.242,2.854C73.962,76.203,67.981,77.953,61.856,77.953z     M42.101,27.705c-3.113,3.405-5.299,7.582-6.324,12.209c-1.543,6.959-0.285,14.102,3.545,20.109    c4.926,7.734,13.35,12.352,22.533,12.352c0,0,0,0,0.002,0c2.838,0,5.639-0.453,8.309-1.332    c-6.154-2.521-15.107-7.549-21.402-16.953C42.384,44.563,41.64,34.421,42.101,27.705z"/>\
                        </g>\
                    </g>\
                    </svg>'};function ModalRealtimeWeather(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimeWeather.prototype=Object.create(ModalBase.prototype);ModalRealtimeWeather.prototype.constructor=ModalRealtimeWeather;ModalRealtimeWeather.prototype.optionTemplate={name:'toolBox.modal.REALTIME_WEATHER',parent:0,mode:['realTimeWeather'],maxNum:0,title:'',minHeight:1,minWidth:2,maxHeight:3,maxWidth:6,type:'ModalRealtimeWeather'};ModalRealtimeWeather.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={})
var configModalOpt={area:[{type:'option',widget:[{type:'select',opt:{option:[{val:'degreesCelsius',name:'摄氏度'},{val:'degreesFahrenheit',name:'华氏度'}],data:{val:this.entity.modal.option?this.entity.modal.option.tempUnit:'degreesCelsius'}}}]},{data:[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[]}],module:"dsDrag",style:".divDsWorkspace .spVarLabel {font-size: 14px;background-color: white; }.divDsWorkspace .btnChartCog {background: white;}",},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]}],header:{needBtnClose:true,title:"配置"},result:{func:data=>{!this.entity.modal.option&&(this.entity.modal.option={});this.entity.modal.points=data.points[0];this.entity.modal.option.tempUnit=data.select.val;this.entity.modal.interval=5;this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();}
ModalRealtimeWeather.prototype.setModalOption=function(option){this.entity.modal.option.tempUnit=(option&&option.tempUnit)?option.tempUnit:'degreesCelsius';this.entity.modal.interval=5;};ModalRealtimeWeather.prototype.updateModal=function(result){console.log(result)
if(!result||!result[0]||!result[0].data)return;var tempDare=JSON.parse(result[0].data);this.renderWeatherStatus(tempDare);};ModalRealtimeWeather.prototype.renderModal=function(){var _this=this;var options=this.entity.modal.option;var weatherImg=weatherImgs['qing'];var html=`<style>#weatherWrap{width:100%;height:100%;animation:appear 500ms ease-out forwards;}@keyframes appear{0%{-webkit-transform:scale(0);transform:scale(0);}
50%{-webkit-transform:scale(1.05);transform:scale(1.05);}
75%{-webkit-transform:scale(0.95);transform:scale(0.95);}
100%{-webkit-transform:scale(1);transform:scale(1);}}#imgWrap{width:50%;height:100%;float:left;}#imgWrap svg{fill:#eee;float:right;width:80%;height:80%;}#tempWrap{width:50%;height:100%;float:left;}#tempWrap>div{height:50%;width:100%;padding-left:10%;color:#eee;font-weight:bolder;text-align:left;}#tempWrap>div>div{height:50%;width:100%;padding-left:10%;color:#eee;font-weight:bolder;text-align:left;}</style><div id="weatherWrap"><div id="imgWrap">${weatherImg}</div><div id="tempWrap"><div id="temp"></div><div id="humidity"></div></div></div>`;this.container.innerHTML=html;this.resize();};ModalRealtimeWeather.prototype.resize=function(){var $container=$(this.container);var height=$('#tempWrap',$container).height(),width=$('#tempWrap',$container).width();var svgHeight,svgWidth;svgHeight=svgWidth=Math.min(height,width)*0.8;$container.find('#imgWrap').siblings('#tempWrap').find('#temp').css({'line-height':height*0.75+'px','font-size':height/8}).siblings('#humidity').css({'line-height':height/4+'px','font-size':height/8});$('svg',$container).css({'height':svgHeight+'px','width':svgWidth+'px','margin-top':(height-svgHeight)/2+'px'});}
ModalRealtimeWeather.prototype.renderWeatherStatus=function(rslt){if(rslt&&rslt.tmp){var temp=rslt.tmp,humidity=rslt.hum,weather=rslt.cond.txt.replace(' ',''),weatherImg,weatherType;switch(weather)
{case'阴':case'Overcast':weatherType='yin';break;case'大雨':case'HeavyRain':weatherType='dayu';break;case'暴雨':case'Storm':weatherType='baoyu';break;case'多云':case'Cloudy':weatherType='duoyun';break;case'小雨':case'LightRain':weatherType='xiaoyu';break;case'晴转多云':case'PartlyCloudy':weatherType='qing_duoyun';break;case'晴':case'Sunny':weatherType='qing';break;case'阵雨':case'ShowerRain':weatherType='duoyun_zhenyu';break;case'打雷':case'Thundershower':weatherType='dalei';break;case'打雷暴雨':case'HeavyThunderstorm':weatherType='dalei_baoyu';break;case'大雪':case'HeavySnow':weatherType='daxue';break;case'雨夹雪':case'Sleet':weatherType='yujiaxue';break;case'雷阵雨':case'Thundershower':weatherType='leizhenyu';break;default:weatherType='qing';}
weatherImg=weatherImgs[weatherType];$(this.container).find('#imgWrap').html(weatherImg).siblings('#tempWrap').find('#temp').html(temp+(this.entity.modal.option.tempUnit=='degreesFahrenheit'?'℉':'℃')).siblings('#humidity').html(humidity+'%');this.resize();}};ModalRealtimeWeather.prototype.showConfigMode=function(){};return ModalRealtimeWeather;})();var ModalKpiOverview=(function(){function ModalKpiOverview(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.lastFiveMinutes=undefined;this.option=undefined;};ModalKpiOverview.prototype=new ModalBase();ModalKpiOverview.prototype.optionTemplate={name:'toolBox.modal.KPI_OVERVIEW',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:6,maxHeight:6,maxWidth:12,type:'ModalKpiOverview',scroll:false};ModalKpiOverview.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"module":"dsDrag","data":[{type:'point',name:'KPI总览',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalKpiOverview.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.structPoint)this.configModalOpt.area[0].data[0].data=_this.entity.modal.points;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();_this.renderModal();}};ModalKpiOverview.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];};ModalKpiOverview.prototype.updateModal=function(points){this.getDsItemsById(points);};ModalKpiOverview.prototype.renderModal=function(){var _this=this;var dsItemIds=_this.entity.modal.points;if(dsItemIds!==undefined){WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:dsItemIds}).done(function(result){_this.getDsItemsById(result.dsItemList);})}};ModalKpiOverview.prototype.getDsItemsById=function(data){var _this=this;var remarks=[],ids=[],scores=[];for(var i=0,length=data.length;i<length;i++){ids.push(data[i].dsItemId);scores.push(Number(data[i].data).toFixed(2));}
WebAPI.post('/analysis/datasource/getDsItemsById',ids).done(function(result){for(var i=0,length=result.length;i<length;i++){remarks.push(result[i].alias);}
_this.spinner&&_this.spinner.stop();if($(_this.container).html()===""||$(_this.container).find(".kpiInfoBox>div").length!==remarks.length){_this.firstRenderModal(remarks,scores,ids);}else{_this.laterRenderModal(remarks,scores,ids);}})};ModalKpiOverview.prototype.firstRenderModal=function(names,values,ids){var $container=$(this.container);$container.html("");var kpiOverviewCtn='<div class="kpiOverviewCtn"></div>';$container.html(kpiOverviewCtn);var colorClass,num=0,noIncluded=0;var topTitle='';var leftContainer='<div class="leftKpiOverview">\
                                <div class="circleContainer">\
                                    <canvas id="myCanvas" width="180px" height="180px"></canvas>\
                                    <div class="smallCircleContainer">\
                                        <div class="smallWhite"></div>\
                                    </div>\
                                    <span class="percentageNum">91%</span>\
                                </div>\
                            </div>';var rightContainer='<div class="rightKpiOverview gray-scrollbar container">\
                                <h3>KPI</h3>\
                                <div class="kpiInfoBox row"></div>\
                            </div>';$container.find(".kpiOverviewCtn").append($(leftContainer));$container.find(".kpiOverviewCtn").append($(rightContainer));$(rightContainer).html(topTitle);for(var i=0,length=names.length;i<length;i++){if(values[i]>=60){colorClass='passGreen';num+=1;}else{if(values[i]<0){noIncluded+=1;}
colorClass='noPassGreen';}
var str='<div class="col-xs-6">\
                            <div class="kpiInfo '+colorClass+'" data-id="'+ids[i]+'">\
                                <div>\
                                    <span title="'+names[i]+'">'+names[i]+' </span>\
                                    <span title="'+values[i]+'"> '+values[i]+'</span>\
                                    <span></span>\
                                </div>\
                            </div>\
                        </div>';$(this.container).find(".kpiInfoBox").append($(str));}
this.resize();var option=this.option;var c=$container.find("#myCanvas")[0];var ctx=c.getContext("2d");ctx.beginPath();var gradient=ctx.createLinearGradient(0,0,170,0);gradient.addColorStop("0","#63b15b");gradient.addColorStop("1.0","#f1b23e");ctx.strokeStyle=gradient;ctx.lineWidth=option.divWidth*9/180;ctx.arc(option.divWidth/2,option.divWidth/2,option.divWidth/2-ctx.lineWidth/2,0,2*Math.PI);ctx.stroke();var percentage=(num/(names.length-noIncluded)*100).toFixed(0);$container.find(".percentageNum").html(percentage+'%');option.r=option.divWidth/2-(option.divWidth*8/180)/2;this.smallCircle(Number(percentage),option);};ModalKpiOverview.prototype.resize=function(){var option={};var $container=$(this.container);var height=$(this.container).height(),width=$(this.container).width();var leftHeight,leftWidth;leftHeight=leftWidth=Math.min(height,width)*0.6;$('.leftKpiOverview',$container).css({'height':leftHeight+'px','width':leftWidth+'px','margin-top':'-'+leftHeight/2+'px'});$('.percentageNum',$container).css("fontSize",leftWidth/4+'px');$('#myCanvas',$container).attr("width",leftWidth+'px');$('#myCanvas',$container).attr("height",leftHeight+'px');var smallBoxWidth=leftWidth*16/180;$('.smallCircleContainer',$container).css({'height':smallBoxWidth+'px','width':smallBoxWidth+'px'});$('.rightKpiOverview',$container).css({'height':leftHeight+'px','width':'calc(100% - '+(leftWidth+20)+'px)','margin-top':'-'+leftHeight/2+'px'});$('.rightKpiOverview h3',$container).css({'fontSize':leftWidth*24/180+'px'})
$('.rightKpiOverview .kpiInfo>div span',$container).css({'fontSize':leftWidth*12/180+'px'})
$('.rightKpiOverview .kpiInfo:before',$container).css({'width':leftWidth*12/180+'px','height':leftWidth*12/180+'px'})
option.divWidth=leftWidth;option.smallBoxWidth=smallBoxWidth;this.option=option;if($container.html()!==""&&window.location.href.indexOf("preview/page")===-1){var percentage=$container.find(".percentageNum").html().split("%")[0];var c=$container.find("#myCanvas")[0];var ctx=c.getContext("2d");ctx.beginPath();var gradient=ctx.createLinearGradient(0,0,170,0);gradient.addColorStop("0","#63b15b");gradient.addColorStop("1.0","#f1b23e");ctx.strokeStyle=gradient;ctx.lineWidth=option.divWidth*9/180;ctx.arc(option.divWidth/2,option.divWidth/2,option.divWidth/2-ctx.lineWidth/2,0,2*Math.PI);ctx.stroke();option.r=option.divWidth/2-(option.divWidth*8/180)/2;this.smallCircle(Number(percentage),option);}};ModalKpiOverview.prototype.smallCircle=function(percentage,option){var $container=$(this.container);var deg=percentage/100*360;var top,left;var param=Math.PI/180;if(0<percentage&&percentage<25){deg=deg-270;y=Math.sin(deg*param)*option.r;x=Math.cos(deg*param)*option.r;top=option.divWidth/2-y;left=option.divWidth/2-x;}else if(25<=percentage&&percentage<50){if(percentage===25){top=option.divWidth/2;left=option.divWidth-(option.divWidth*9/180)/2;}else{deg=deg-180;x=Math.sin(deg*param)*option.r;y=Math.cos(deg*param)*option.r;top=option.divWidth/2+y;left=option.divWidth/2-x;}}else if(50<=percentage&&percentage<75){if(percentage===50){top=option.divWidth-(option.divWidth*9/180)/2;left=option.divWidth/2;}else{deg=deg-90;y=Math.sin(deg*param)*option.r;x=Math.cos(deg*param)*option.r;top=option.divWidth/2+y;left=option.divWidth/2+x;}}else if(75<=percentage&&percentage<100){if(percentage===75){top=option.divWidth/2;left=(option.divWidth*9/180)/2;}else{deg=deg;x=Math.sin(deg*param)*option.r;y=Math.cos(deg*param)*option.r;top=option.divWidth/2-y;left=option.divWidth/2+x;}}else if(percentage===0||percentage===100){top=(option.divWidth*9/180)/2;left=option.divWidth/2;}
$container.find(".smallCircleContainer").css({'top':(top-option.smallBoxWidth/2)+'px','left':(left-option.smallBoxWidth/2)+'px'});};ModalKpiOverview.prototype.laterRenderModal=function(names,values,ids){var colorClass,fontColor,num=0,noIncluded=0;$(this.container).find(".kpiInfoBox>div").each(function(){var $kpiInfo=$(this).find(".kpiInfo");var $infos=$(this).find(".kpiInfo span");for(var i=0,length=ids.length;i<length;i++){if(ids[i]===$kpiInfo.attr("data-id")){if(values[i]>=60){colorClass='passGreen';num+=1;}else{if(values[i]<0){noIncluded+=1;}
colorClass='noPassGreen';}
$kpiInfo.removeClass().addClass("kpiInfo "+colorClass);var value=Number($infos.eq(1).html());var arrowClass;if(values[i]>value){arrowClass="glyphicon glyphicon-arrow-up";fontColor="#63b15b";}else if(values[i]<value){arrowClass="glyphicon glyphicon-arrow-down";fontColor="#f1b23e";}else if(values[i]==value){arrowClass="";}
$kpiInfo.find("span").eq(2).removeClass().addClass(arrowClass).css("color",fontColor);$infos.eq(1).html(values[i]);}}})
var percentage=(num/(names.length-noIncluded)*100).toFixed(0);$(this.container).find(".percentageNum").html(percentage+'%');this.smallCircle(Number(percentage),this.option)};ModalKpiOverview.prototype.attachEvent=function(){};ModalKpiOverview.prototype.showConfigMode=function(){};return ModalKpiOverview;})()
var ModalDiagnosisStruct=(function(){function ModalDiagnosisStruct(screen,entityParams){this.$configModal=undefined;this.$modal=undefined;this.tempOpt=undefined;this.store={};this.subEntity=undefined;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalDiagnosisStruct.prototype=new ModalBase();ModalDiagnosisStruct.prototype.optionTemplate={name:'toolBox.modal.DIAGNOSIS_SUMMARY',parent:3,mode:'custom',maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDiagnosisStruct',scroll:false};ModalDiagnosisStruct.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"type":'option',"widget":[{id:'needDetail',type:'check',name:'是否显示细节'}]},{"module":"dsDrag","data":[{type:'point',name:'KPI分项统计来源',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalDiagnosisStruct.prototype.show=function(){this.init();};ModalDiagnosisStruct.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.needDetail)this.configModalOpt.area[0].widget[0].data=this.entity.modal.option.needDetail;if(this.entity.modal.option.structPoint)this.configModalOpt.area[1].data[0].data=this.entity.modal.option.structPoint;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();}};ModalDiagnosisStruct.prototype.getRealTimePoint=function(list,arr){var _this=this;if(!arr)arr=[];list.forEach(function(item){if(item.point){arr.push(_this.entity.modal.option.prefix+item.point);}
if(item.children instanceof Array&&item.children.length>0){_this.getRealTimePoint(item.children,arr)}});return arr;};ModalDiagnosisStruct.prototype.init=function(){};ModalDiagnosisStruct.prototype.renderModal=function(e){$(this.container).addClass('widgetKPIItemEval');this.container.innerHTML='<div class="divKPIIndex diagnosisCtn"></div><div class="divKPIDetail"></div>';if(this.entity.modal.option.needDetail){this.renderDetailContainer();$(this.container).addClass('showSubContainer');}
this.attachEvent();};ModalDiagnosisStruct.prototype.renderDetailContainer=function(){var containerDetail=this.container.querySelector('.divKPIDetail');var item={modal:{type:'ModalHtml',interval:60000,option:{html:'<div>开发中</div>'},points:[],title:''},spanC:9,spanR:6};this.initSubEntity(containerDetail,item)};ModalDiagnosisStruct.prototype.attachEvent=function(){var _this=this;var clickEvent=AppConfig.isMobile?'tap':'click';$(this.container).off(clickEvent).on(clickEvent,'.divStructTtl',function(e){$(e.currentTarget).parent().toggleClass('focus');});$(this.container).on(clickEvent,'.divStructItem',function(e){var $target=$(e.currentTarget);if($target.hasClass('focus')){$target.removeClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().removeClass('focus')}else{$(_this.container).find('.rowPointDetail.focus').removeClass('focus');$(_this.container).find('.divStructItem.focus').removeClass('focus');$target.addClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().addClass('focus');_this.refreshSubEntity($target);}});};ModalDiagnosisStruct.prototype.refreshSubEntity=function($target){var arrPoint=[],strPoint;try{arrPoint=$target.data('bindPoints');strPoint=arrPoint.map(function(point){return point.pointname}).toString();}catch(e){strPoint='数据格式不符合'}
var _this=this;this.subEntity.entity.modal.points=arrPoint.map(function(point){return(_this.entity.modal.option.prefix+point.point)});this.subEntity.entity.modal.option.html='<div>'+strPoint+'</div><script>this.onUpdateComplete=function(data){console.log(data)}</script>';this.updateSubEntity();};ModalDiagnosisStruct.prototype.updateSubEntity=function($target){this.subEntity.render();};ModalDiagnosisStruct.prototype.initPointMap=function(points){var _this=this;var $dom;points.forEach(function(point){_this.initPointDetail(point.dsItemId,point.data)})};ModalDiagnosisStruct.prototype.initPointDetail=function(id,strData){var $dom=$('[data-point="'+id+'"]');if($dom.length==0)return;var data;if(!isNaN(Number(strData))){data={score:Number(strData)}}else{try{data=JSON.parse(strData)}catch(e){$dom.text('No Data');$('.pointDetail[data-detail="'+id+'"]').text('No Data');return;}}
var status='';if(parseFloat(data.score)>=60){status='success';$dom.text(parseFloat(data.score)+'%');}else if(parseInt(data.score)>=0){status='danger';$dom.text(parseFloat(data.score)+'%');}else{status='default';$dom.text('--');}
$dom.removeClass('success danger default').addClass(status);var $detail=$('.pointDetail[data-detail="'+id+'"]');if($detail.length>0){$detail.removeClass('success danger default').addClass(status);$detail.text(data.detail);}
if($dom.hasClass('spItemInfo')){$dom.next().removeClass('success danger default').addClass(status)}};ModalDiagnosisStruct.prototype.initStruct=function(struct){var _this=this;var structDom=this.container.querySelector('[data-item="'+struct.name+'"]');if(!structDom){structDom=document.createElement('div');structDom.className='divStructCtn focus';structDom.dataset.item=struct.name;var structTtl=document.createElement('div');structTtl.className='divStructTtl';structTtl.innerHTML='\
            <span class="spStructIcon glyphicon glyphicon-dashboard"></span>\
            <span class="spStructName">'+struct.name+'</span>\
            <!--<span class="pointDetail" data-detail="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'"></span>-->';var structBody=document.createElement('div');structBody.className='divStuctBody';if((struct.items instanceof Array)&&struct.items.length>0){struct.items.forEach(function(item,index){structBody.appendChild(_this.createStructItem(item));})}
structDom.appendChild(structTtl);structDom.appendChild(structBody);this.container.querySelector('.diagnosisCtn').appendChild(structDom);}};ModalDiagnosisStruct.prototype.createStructItem=function(item){var structItem=document.createElement('div');structItem.className='divStructItem';structItem.innerHTML='\
            <span class="spItemInfo">'+(item.name?item.name:'')+'</span>\
            <span class="spItemInfo">'+(item.result?item.result:'')+'</span>\
            <span class="spItemInfo spItemKPIRs">'+(item.description?item.description:'')+'</span>';$(structItem).data('bindPoints',item.bindPoints);return structItem;};ModalDiagnosisStruct.prototype.updateModal=function(points){this.spinner.stop();if(!(points[0]&&points[0].dsItemId))return;var structList;var _this=this;try{structList=JSON.parse(points[0].data).content;}catch(e){return;}
structList.forEach(function(struct){_this.initStruct(struct);});this.store.structList=structList;};ModalDiagnosisStruct.prototype.showConfigMode=function(){};ModalDiagnosisStruct.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];this.entity.modal.option.prefix='@'+AppConfig.project.bindId+'|';};return ModalDiagnosisStruct;})();var ModalCumulantChart=(function(){function ModalCumulantChart(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalCumulantChart.prototype=new ModalBase();ModalCumulantChart.prototype.optionTemplate={name:'toolBox.modal.CUMULANT_CHART',parent:0,mode:'custom',maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalCumulantChart',scroll:false,needRefresh:false};ModalCumulantChart.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"module":'timeConfig',},{'type':'option',widget:[{type:'select',name:'图表类型',id:'chartType',opt:{attr:{class:'form-inline'},option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]}},{type:'checkbox',name:'启用堆叠',id:'isStack',opt:{}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],"result":{}};ModalCumulantChart.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){(this.entity.modal.option.dsItemIds instanceof Array)&&(this.configModalOpt.area[2].data[0].data=this.entity.modal.option.dsItemIds);(this.entity.modal.option.chartType)&&(this.configModalOpt.area[1].widget[0].data={val:this.entity.modal.option.chartType});(this.entity.modal.option.isStack)&&(this.configModalOpt.area[1].widget[1].data=this.entity.modal.option.isStack);(this.entity.modal.option.timeStart&&this.entity.modal.option.timeEnd)&&(this.configModalOpt.area[0].data={mode:'1',date:{startTime:this.entity.modal.option.timeStart,endTime:this.entity.modal.option.timeEnd},format:this.entity.modal.option.timeFormat});}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();}};ModalCumulantChart.prototype.optionDefault={};ModalCumulantChart.prototype.renderModal=function(){var postData={timeStart:this.entity.modal.option.timeStart,timeEnd:this.entity.modal.option.timeEnd,timeFormat:this.entity.modal.option.timeFormat,dsItemIds:this.entity.modal.option.dsItemIds};var _this=this;WebAPI.post('/analysis/startWorkspaceDataGenHistogram/increment',postData).done(function(result){var arrLegend=_this.entity.modal.option.dsItemIds.map(function(point){var point=AppConfig.datasource.getDSItemById(point);return(point.alias?point.alias:point.value);});var arrSeries=[];for(var i=0;i<result.list.length;i++){arrSeries.push({name:arrLegend[i],type:_this.entity.modal.option.chartType,areaStyle:{normal:{}},stack:_this.entity.modal.option.isStack,data:result.list[i].data.map(function(data){var val=parseFloat(data);if(!(isNaN(val))){return val.toFixed(2);}else{return 0}})});}
var opt={text:'历史累积量折线图',legend:{data:arrLegend,top:10},grid:{left:40,right:20,top:35},tooltip:{trigger:'axis'},toolbox:{showTitle:true,feature:{magicType:{type:['line','bar','stack','tiled']}}},xAxis:{data:result.timeShaft.slice(1),type:'category',axisLabel:{formatter:function(value,index){var date=new Date(value);var texts;if(index===0){texts=date.format('yyyy-MM-dd')+'\n'+date.format('HH:mm:ss');}else{var preDate=new Date(result.timeShaft[index-1]);if(preDate.format('yyyy-MM-dd')==date.format('yyyy-MM-dd')){texts=date.format('HH:mm:ss')}else{texts=date.format('yyyy-MM-dd')+'\n'+date.format('HH:mm:ss');}}
return texts;}}},yAxis:[{type:'value'}],series:arrSeries};var chart=echarts.init(_this.container,AppConfig.chartTheme);chart.setOption(opt);_this.spinner.stop();})};ModalCumulantChart.prototype.updateModal=function(points){};ModalCumulantChart.prototype.showConfigMode=function(){};ModalCumulantChart.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.points=[];this.entity.modal.option={timeStart:option.startTime,timeEnd:option.endTime,timeFormat:option.format,dsItemIds:option.points[0],isStack:option.isStack?1:0,chartType:option.chartType.val};};ModalCumulantChart.prototype.goBackTrace=function(data){};return ModalCumulantChart;})();var ModalReportFactory=(function(FacReportScreen){function ModalReportFactory(screen,entityParams,configModalOpt){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode,configModalOpt);this.reportList=[];this.getReportWrap();};ModalReportFactory.prototype=new ModalBase();ModalReportFactory.prototype.optionTemplate={name:'toolBox.modal.REPORT_CHAPTER',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalReportFactory'};ModalReportFactory.prototype.show=function(){this.init();}
ModalReportFactory.prototype.init=function(){}
ModalReportFactory.prototype.renderModal=function(e){var _this=this;var arr=this.entity.modal.option.arrReport;var domWrap=this.container;domWrap.style.overflowY='auto';domWrap.innerHTML='';arr.forEach(function(row){var container=document.createElement('div');container.style.width='100%';container.style.position='relative';domWrap.appendChild(container);namespace('api.report').renderReport(container,row.pageId,row.chapterId,{onlySummary:row.isSummary===1}).done(function(){var a=document.createElement('a');a.href='/factory/preview/report/'+row.pageId+'/'+AppConfig.isFactory+'?projectId='+AppConfig.projectId;a.innerText='查看更多';a.target="_blank";if(container.offsetHeight>20){a.style.position='absolute';a.style.bottom='20px';a.style.left='35px';}else{a.style.marginTop='10px';a.style.marginBottom='30px';a.style.marginLeft='35px';a.style.color='#fff';}
a.className='btn btn-primary';container.appendChild(a);var reportName,report,date,title;for(var i=0,l=_this.reportList.length;i<l;i++){if(row.pageId===_this.reportList[i].reportId){report=_this.reportList[i];break;}}
if(report){reportName=report.reportName;if(report.period==='day'){date=new Date().format('MM月dd日')}else if(report.period==='month'){date=new Date().format('MM月')}
title=document.createElement('h4');title.style.marginLeft='35px';title.innerText=reportName+'-'+date;$(container).prepend(title);}});});this.spinner&&_this.spinner.stop();}
ModalReportFactory.prototype.showConfigMode=function(){};ModalReportFactory.prototype.updateModal=function(points){};ModalReportFactory.prototype.setModalOption=function(option){};ModalReportFactory.prototype.getReportWrap=function(){var _this=this,projectId;_this.reportList=[];if(AppConfig.project&&AppConfig.project.id){projectId=AppConfig.project.id;}else if(this.entity.modal.option.facProjectId){projectId=this.entity.modal.option.facProjectId;}
if(!projectId){return;}
WebAPI.get('/factory/getFirstLevelReports/'+projectId).done(function(result){if(!result.data||result.data.length==0)return;result.data.forEach(function(item){if(item.list&&item.list.length>0){item.list.forEach(function(report){_this.reportList.push(report);});}});})};ModalReportFactory.prototype.modalDialog='\
                <style>.btnRemove{height: 34px;line-height: 34px;font-size: 16px;}</style>\
                <div style="position: absolute;top: 0;right: 10px;z-index: 1;padding: 15px 10px;font-size: 24px;">\
                    <span class="glyphicon glyphicon-plus-sign" id="btnAddSummary"></span>\
                </div>\
                <div class="row" style="margin-bottom: 15px;"><div class="col-xs-4 col-xs-offset-1"><input class="form-control" id="title" type="text" placeholder="标题"/></div></div>';ModalReportFactory.prototype.showConfigModal=function(){var _this=this;this.configModal=new ConfigModal(this.configModalOptDefault,this.screen.container,this);this.configModal.init();this.configModal.modalBody.innerHTML=this.modalDialog;this.attachEvents();if(this.entity.modal.option&&this.entity.modal.option.arrReport){this.entity.modal.option.arrReport.forEach(function(report){_this.createItem(report);});}else{$('#btnAddSummary',this.configModal.modal).click();}
if(this.entity.modal.title){$('#title',this.configModal.modal).val(this.entity.modal.title);}
this.configModal.show();};ModalReportFactory.prototype.attachEvents=function(){var _this=this;$('#btnAddSummary',this.configModal.modal).off('click').on('click',function(){_this.createItem();});$('.btnConfirm',this.configModal.modal).off('click').on('click',function(){var title=$('#title',_this.configModal.modal).val();_this.configModal.hide();if(!_this.entity.modal.option)_this.entity.modal.option={};if(!_this.entity.modal.option.arrReport)_this.entity.modal.option.arrReport=[];var arrParams=[];$('.summaryRow',_this.configModal.modal).each(function(){arrParams.push({pageId:$(this).find('.pageList').val(),isSummary:$(this).find('.isSummary').prop('checked')?1:0});});_this.entity.modal.option.arrReport=arrParams;_this.entity.modal.option.facProjectId=AppConfig.project.id;_this.entity.modal.title=title;_this.render();});};ModalReportFactory.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalReportFactory.prototype.getChapterListByReportId=function(reportId){return WebAPI.get("/spring/get/"+reportId+'/'+AppConfig.isFactory).then(function(rs){var list=[];var data=rs.layout;var layouts=rs.layout[0];var layout,modal,path=[1];while(layout=layouts.shift()){modal=layout.modal;if(layout==='end'){path.pop();path[path.length-1]+=1;continue;}
if(modal.type==='ReportContainer'){list.push({name:'全部',value:layout.id});layouts.unshift('end');layouts=modal.option.layouts.concat(layouts);}else if(modal.type==='ChapterContainer'){list.push({name:'第'+path.join('.')+'章 - '+(modal.option.chapterTitle||'未命名'),value:layout.id});layouts.unshift('end');layouts=modal.option.layouts.concat(layouts);path.push(1);}}
return list;});};ModalReportFactory.prototype.initOption=function($row,report){var _this=this;var strHtml='';var $pageList=$('.pageList',$row),$isSummary=$('.isSummary',$row);if(!report){report={}}
if(report.isSummary==0){$isSummary.prop('checked',false);}
if(this.reportList&&this.reportList.length>0){this.reportList.forEach(function(item){strHtml+=('<option value="'+item.reportId+'">'+item.reportName+'</option>');});$pageList.append(strHtml);setValue($pageList,report.pageId);}
$pageList.change(function(){var pageVal=this.value;var $typeList=$(this).closest('.row').find('.typeList');$typeList.children().hide();$typeList.children('[parent-id="'+pageVal+'"]').show();$typeList.val($typeList.children('[parent-id="'+pageVal+'"]:eq(0)').val());});$('.btnRemove',$row).off('click').on('click',function(){for(var i=0,l=_this.entity.modal.option.arrReport.length;i<l;i++){if(_this.entity.modal.option.arrReport[i].pageId===report.pageId){_this.entity.modal.option.arrReport.splice(i,1);break;}}
$(this).closest('.summaryRow').remove();});function setValue($select,val){if(!!val){$select.val(val);}}};ModalReportFactory.prototype.createItem=function(report){$('.modal-body',this.configModal.modal).append('<div class="row summaryRow" style="margin-bottom: 15px;">\
            <div class="col-xs-4 col-xs-offset-1">\
                <select class="form-control pageList"></select>\
            </div>\
            <div class="col-xs-4">\
                <label class="checkbox-inline form-control" style="border: none;box-shadow: none;"> <input type="checkbox" class="isSummary" checked disabled> 仅显示摘要 </label>\
            </div>\
            <div class="col-xs-2">\
                <span class="glyphicon glyphicon-remove-sign btnRemove"></span>\
            </div>\
        </div>');this.initOption($('.modal-body .summaryRow',this.configModal.modal).last(),report);};return ModalReportFactory;})();﻿
var DrawGraph=(function(){var _this;function DrawGraph(screenPre,graph,container,color){_this=this;this.container=container;this.color=color;this.screenPre=screenPre;this.graph=graph;this.svgW=undefined;this.svgH=undefined;}
DrawGraph.prototype={show:function(){},render:function(){},createBoard:function(){var $svgGraph=$('.svgGraph');var $boxWOrH;if($svgGraph.length===0){$svgGraph=$('<svg class="svgGraph" style="position:absolute;z-index:149;">\
                        <defs><marker id="arrowHead" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="red"/></marker>\
                        </defs>\
                        <path id="arrow-line" marker-end="url(#arrowHead)" stroke-width="4" fill="none" stroke="red" d=""/>\
                        <ellipse style="fill:rgba(0,0,0,0);stroke-width:2px;" orient="auto" class="circle" orient="auto"/>\
                        <rect style="fill:rgba(0,0,0,0);stroke-width:2px;" class="rect" orient="auto"/>\
                        </svg>');_this.$svgBox.append($svgGraph);}
if(_this.screenPre.curModal.type==='AnlzTendency'){$boxWOrH=$('#anlsPaneContain .panel-body .containerChi');}else{$boxWOrH=$('#anlsPaneContain .panel-body');}
this.svgW=$boxWOrH.width();this.svgH=$boxWOrH.height();$svgGraph[0].setAttribute("viewBox","0 0 "+this.svgW+" "+this.svgH);$svgGraph[0].setAttribute("width",this.svgW);$svgGraph[0].setAttribute("height",this.svgH);return $svgGraph;},deleteGraph:function(){if($('.deleteGraph').length===0){return;}
$('.deleteGraph').hover(function(e){$(this).css('cursor','pointer');},function(){$(this).css('cursor','');});$('.deleteGraph').off('click').click(function(){$(this).parent('.svgCopyBox').remove();var index=_this.getGraphListIndex($(this).parent('.svgCopyBox').children('.svgGraphCopy').attr('id'));if(index!=undefined){_this.screenPre.curModal.graphList.splice(index,1);_this.screenPre.saveModal();_this.screenPre.saveModalJudge.resolveWith(_this.screenPre,[_this.screenPre,1,_this.chart,$('#divWSPane .selected'),_this.screenPre.curModal,false]);}});},graphHover:function($svgCopyBox){$svgCopyBox.hover(function(){_this.deleteGraph();$(this).children('.deleteGraph').show();$(this).css({'cursor':'move'}).addClass('svgCopyBoxTem');},function(){$(this).removeClass('svgCopyBoxTem');$(this).children('.deleteGraph').hide();$(this).css('border','none');});},graphDrag:function(graphDraw){var $target=$('#'+graphDraw.id);if($target.length===0){return;}
var svgGraphCopy=$target[0];var disX=0,disY=0;svgGraphCopy.onmousedown=function(e){var svgCopyBox=svgGraphCopy.parentNode;var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=e.clientX+scrollLeft-svgCopyBox.offsetLeft;disY=e.clientY+scrollTop-svgCopyBox.offsetTop;this.onmousemove=function(e){var ol=e.clientX+scrollLeft;var ot=e.clientY+scrollTop;var l=ol-disX;var t=ot-disY;svgCopyBox.style.left=l+"px";svgCopyBox.style.top=t+"px";var isTop=svgCopyBox.offsetTop<0;var isLeft=svgCopyBox.offsetLeft<0;var isRight=svgCopyBox.offsetParent.offsetWidth-svgCopyBox.offsetLeft<svgCopyBox.offsetWidth;var isBottom=svgCopyBox.offsetParent.offsetHeight-svgCopyBox.offsetTop<svgCopyBox.offsetHeight;if(isTop){svgCopyBox.style.top='0px';}
if(isLeft){svgCopyBox.style.left='0px';}
if(isRight){svgCopyBox.style.left=svgCopyBox.parentNode.offsetWidth-svgCopyBox.offsetWidth+'px';}
if(isBottom){svgCopyBox.style.top=svgCopyBox.parentNode.offsetHeight-svgCopyBox.offsetHeight+'px';}}
this.onmouseup=function(e){this.onmousemove=null;this.onmouseup=null;var graph={id:graphDraw.id,downX:svgCopyBox.offsetLeft/_this.$svgBox.width(),downY:svgCopyBox.offsetTop/_this.$svgBox.height(),upX:svgCopyBox.offsetLeft/_this.$svgBox.width()+graphDraw.upX-graphDraw.downX,upY:svgCopyBox.offsetTop/_this.$svgBox.height()+graphDraw.upY-graphDraw.downY}
_this.saveGraph(graph);}}},getGraphListIndex:function(id){for(var i=0;i<_this.screenPre.curModal.graphList.length;i++){if(_this.screenPre.curModal.graphList[i].id==id){return i;}}},saveGraph:function(graph){var isSave=false;var index=_this.getGraphListIndex(graph.id);if(index==undefined){_this.screenPre.curModal.graphList.push(graph);doSave();}else{var graph_old=_this.screenPre.curModal.graphList[index];if(graph.downX&&graph.downX!=graph_old.downX){isSave=true}
if(!isSave&&graph.downY&&graph.downY!=graph_old.downY){isSave=true}
if(!isSave&&graph.upX&&graph.upX!=graph_old.upX){isSave=true}
if(!isSave&&graph.upY&&graph.upY!=graph_old.upY){isSave=true}
if(isSave){_this.screenPre.curModal.graphList[index].downX=graph.downX;_this.screenPre.curModal.graphList[index].downY=graph.downY;_this.screenPre.curModal.graphList[index].upX=graph.upX;_this.screenPre.curModal.graphList[index].upY=graph.upY;doSave();}}
function doSave(){_this.screenPre.saveModal();_this.screenPre.saveModalJudge.resolveWith(_this.screenPre,[_this.screenPre,1,_this.chart,$('#divWSPane .selected'),_this.screenPre.curModal,false]);}}}
return DrawGraph;})();var DrawArrow=(function(){var _this;function DrawArrow(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.screenPre=screenPre;this.graph=graph;this.container=container;if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
this.$svgBox=$(this.container).find('.svgBox');this.$parentContainer=$(this.container);if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=null;this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
_this=this;}
DrawArrow.prototype=new DrawGraph();DrawArrow.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawArrow.prototype.showArrow=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;var xDiffer=Math.abs(upX-downX);var yDiffer=Math.abs(upY-downY);if(xDiffer<20){xDiffer=20}
if(yDiffer<20){yDiffer=20}
if(upX>=downX&&upY<downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgBoxW)+'%;top:'+(upY*100/svgBoxH-0.6)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy"  id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line2" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M0 , '+yDiffer+'L'+Math.abs(upX-downX-8)+',8"/>'+'</svg>');}
else if(upX>downX&&upY>=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgBoxW)+'%;top:'+(downY*100/svgBoxH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M0 ,0 '+'L'+Math.abs(upX-downX-8)+','+Math.abs(upY-downY-8)+'"/>'+'</svg>');}
else if(upX<=downX&&upY<=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(upX*100/svgBoxW)+'%;top:'+((upY)*100/svgBoxH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" id="new Date().getTime()" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M '+xDiffer+','+yDiffer+'L8,8"/>'+'</svg>');}
else if(upX<downX&&upY>=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(upX*100/svgBoxW)+'%;top:'+(downY*100/svgBoxH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow" >\
                            <defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>\
                            <path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M'+xDiffer+' ,0 '+' L8,'+Math.abs(upY-downY-8)+'"/>\
                            </svg>');}
$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawArrow.prototype.render=function(graph){var $box_arrow=_this.showArrow(graph);this.$svgBox.append($box_arrow);};DrawArrow.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function rotate(angle){var arrowLine=$('#arrow-line')[0];arrowLine.setAttribute("transform","rotate("+angle+")");}
function lineTo(start,end){var arrowLine=$('#arrow-line')[0];var arrowHeadP=$('#arrowHead path')[0];arrowLine.setAttribute('d','M'+start.join(',')+' L'+end.join(','));arrowLine.setAttribute("stroke",_this.color);arrowHeadP.setAttribute('fill',_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;lineTo([downX,downY],[curX,curY]);}
$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return;}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'arrow',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()};$svgCopyBox=_this.showArrow(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);$('.svgGraph').remove();_this.saveGraph(graphDraw);$('#graphBox').hide();$('.graphActive').click();$('.svgGraph').remove();}}};return DrawArrow;})();var DrawCircle=(function(){var _this;function DrawCircle(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.graph=graph;this.container=container;this.screenPre=screenPre;this.$svgBox=$(this.container).find('.svgBox');;this.$parentContainer=$(this.container).parent();if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
_this=this;}
DrawCircle.prototype=new DrawGraph();DrawCircle.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawCircle.prototype.showCircle=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(Math.abs(upX-downX)+8)+'px;height:'+(Math.abs(upY-downY)+8)+'px;position:absolute;left:'+(downX*100/svgBoxW)+'%;top:'+(downY*100/svgBoxH)+'%;z-index:149;padding:2px;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+Math.abs(upX-downX)+' '+Math.abs(upY-downY)+'" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'" type="circle">'+'<ellipse style="fill:rgba(0,0,0,0);stroke-width:3px;stroke:'+graphDraw.color+'" orient="auto" cx="'+Math.abs(upX-downX)/2+'" cy="'+Math.abs(upY-downY)/2+'" rx="'+Math.abs(upX-downX-4)/2+'" ry="'+Math.abs(upY-downY-4)/2+'" x="0" y="0"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawCircle.prototype.render=function(graph){var $box_cicle=_this.showCircle(graph);this.$svgBox.append($box_cicle);};DrawCircle.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function circleTo(start,end){var circle=$('.circle')[0];circle.setAttribute("cx",start[0]+Math.abs(end[0]-start[0])/2);circle.setAttribute("cy",start[1]+Math.abs(end[1]-start[1])/2);circle.setAttribute("rx",Math.abs(end[0]-start[0])/2);circle.setAttribute("ry",Math.abs(end[1]-start[1])/2);circle.setAttribute("stroke",_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;circleTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'circle',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()}
$svgCopyBox=_this.showCircle(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);_this.saveGraph(graphDraw);$('#graphBox').hide();$('.svgGraph').remove();}}};return DrawCircle;})();var DrawRect=(function(){var _this;function DrawRect(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.graph=graph;this.container=container;this.screenPre=screenPre;this.$svgBox=$(this.container).find('.svgBox');;this.$parentContainer=$(this.container).parent();if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
_this=this;}
DrawRect.prototype=new DrawGraph();DrawRect.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawRect.prototype.showRect=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(Math.abs(upX-downX)+8)+'px;height:'+(Math.abs(upY-downY)+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgBoxW)+'%;top:'+(downY*100/svgBoxH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+Math.abs(upX-downX)+' '+Math.abs(upY-downY)+'" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'" type="rect">'+'<rect style="fill:rgba(0,0,0,0);stroke-width:4px;stroke:'+graphDraw.color+'" orient="auto" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawRect.prototype.render=function(graph){var $box_rect=_this.showRect(graph);this.$svgBox.append($box_rect);};DrawRect.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function rectTo(start,end){var rect=$('.rect')[0];rect.setAttribute('width',Math.abs(end[0]-start[0]));rect.setAttribute('height',Math.abs(end[1]-start[1]));rect.setAttribute('x',start[0]);rect.setAttribute('y',start[1]);rect.setAttribute('stroke',_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;rectTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'rect',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()};$svgCopyBox=_this.showRect(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);_this.saveGraph(graphDraw);$('#graphBox').hide();$('.svgGraph').remove();}}};return DrawRect;})();var AnlzBase=(function(){var _this;function AnlzBase(container,option,screen){_this=this;this.container=container;this.options=option;this.screen=screen;this.paneChart=undefined;this.paneNotes=undefined;this.chart=undefined;this.noteCount=0;this.chartAnimationDuration=500;this.spinnerRender=new LoadingSpinner({color:'#00FFFF'});this.noteDefaultWidth=440;this.noteDefaultHeight=220;this.dockArea=[];this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;}
AnlzBase.prototype={show:function(){this.initTools();this.container.innerHTML='';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.noteList){this.screen.curModal.noteList=[];}else{_this.initNotes();}
$divBackgroundContainer=$('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">');if(!this.paneChart){this.paneChart=$('<div style="width: 100%; height: 100%;">')[0];$(this.container).append($divBackgroundContainer).append(this.paneChart);}
else{$(this.container).append($divBackgroundContainer);}
_this.spinnerRender.spin(this.container.parentElement);if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;var containerChilBox;if(_this.screen.curModal.type==='AnlzTendency'){containerChilBox=$(_this.container).find('.containerChi')[0];}else{containerChilBox=_this.container;}
for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],containerChilBox,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],containerChilBox,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],containerChilBox,'');}
graph.show();}}
this.init();},renderModal:function(data){_this=this;_this.spinnerRender.stop();try{_this.render(data);}catch(e){console.warn(e);}
setTimeout(function(){_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);_this.spinnerRender.stop();},_this.chartAnimationDuration);},spinnerStop:function(){Spinner.stop();_this.spinnerRender.stop();},close:function(){this.spinnerRender.stop();this.screen=null;this.options=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;},init:function(){},errAlert:function(err){var $dataAlert=$('#dataAlert');switch(err){case'no data history':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE6+"</strong>").show().close();break;case'time':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE7+"</strong>").show().close();break;case'invalid time string':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE8+"</strong>").show().close();break;default:new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE9+"</strong>").show().close();break;}},initDock:function(){var arrHtml=[],previewerHtml=[];var $paneDock=$('.pane-dock',this.$parentContainer);if($paneDock.length){this.$paneDock=$paneDock;this.$dockManager=$('.dock-manager',$paneDock);this.$dockPreviewer=$('.dock-previewer-manager',$paneDock);return;}
arrHtml.push('<div class="dock-wheel dock-wheel-fill-icon" data-type="fill"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-fill" data-type="fill" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-top-icon" data-type="top"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-top" data-type="top" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-right-icon" data-type="right"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-right" data-type="right" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-down-icon" data-type="bottom"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-down" data-type="bottom" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-left-icon" data-type="left"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-left" data-type="left" style="display:none;"></div>');this.$paneDock=$('<div class="pane-dock" style="position: absolute; left: 0; top: 0; width:100%; height:100%;">');this.$dockManager=$('<div class="dock-manager" style="position: absolute;left: 0; top: 0; width:100%; height:100%;">');this.$dockPreviewer=$('<div class="dock-previewer-manager" style="position: absolute; left:0; top:0; width:100%;height:100%;">');this.$dockManager[0].innerHTML=arrHtml.join('');this.$dockPreviewer[0].innerHTML=previewerHtml.join('');this.$paneDock[0].appendChild(this.$dockManager[0]);this.$paneDock[0].appendChild(this.$dockPreviewer[0]);this.$parentContainer[0].appendChild(this.$paneDock[0]);},resetDock:function(){this.$parentContainer.children('.dock-window-ctn').remove();this.$parentContainer.children('.dock-note-toolbar').remove();this.$paneDock.remove();$(this.container).css({'top':0,'left':0,'bottom':0,'right':0});},initTools:function(){var _this=this;var $noteHideShow=$('#btnNoteHideOrShow');var $graphsBox=$('#graphBox');$('.itemTools .glyphicon-log-out').off('click').on('click',function(){if(!_this.screen)return;_this.screen.refreshPaneCenter(new window.analysis.panels.AnalysisTemplate(_this.screen));$('.divPage.selected').removeClass('selected');$('.itemTools .glyphicon-cog').off('click');$('#rightCt').trigger('click');});$('.itemTools .glyphicon-cog').off('click').on('click',function(){var optionTemplate=_this.screen.factoryIoC.getModel(_this.screen.curModal.type).prototype.optionTemplate;var data=[];for(var i=0;i<_this.screen.curModal.itemDS.length;i++){data.push({});data[i].dsType=_this.screen.curModal.itemDS[i].type;data[i].dsId=_this.screen.curModal.itemDS[i].arrId;data[i].dsName=[];var arrId=_this.screen.curModal.itemDS[i].arrId;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);for(var j=0;j<arrId.length;j++){var id=arrId[j];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){data[i].dsName.push(arrItem[m].alias);break;}}}}
var option={modeUsable:optionTemplate.chartConfig,allDataNeed:(optionTemplate.templateParams.paraAnlysMode=='all'),rowDataType:optionTemplate.templateParams.paraName,dataTypeMaxNum:optionTemplate.templateParams.dataTypeMaxNum,templateType:_this.screen.curModal.type,dsChartCog:_this.screen.curModal.dsChartCog,optionPara:{mode:_this.screen.curModal.mode,startTime:_this.screen.curModal.startTime,endTime:_this.screen.curModal.endTime,interval:_this.screen.curModal.format,dataItem:data}};_this.screen.modalConfig.showModalInit(false,option)});$('.itemTools .glyphicon-edit').off('click').click(function(){_this.createNote();$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$('.divNote').show();});$('#btnDownLoadExcel_a').off('click').click(function(){var xAxisList=_this.options.xAxisData;var str='坐标轴';var dataListArr=[];var dictDataList=_this.options.dataList?_this.options.dataList:{};if(dictDataList){for(var item in dictDataList){var itemL=dictDataList[item];if(itemL.length>1&&Object.prototype.toString.call(itemL[0])==='[object Array]'){for(var m=0,lens=itemL.length;m<lens;m++){dataListArr.push(itemL[m]);}}else{dataListArr.push(itemL);}
str+=','+item;}
if(xAxisList&&xAxisList.length!==0){for(var i=0,len=xAxisList.length;i<len;i++){str+='\n'+xAxisList[i];for(var j=0,lens=dataListArr.length;j<lens;j++){str+=','+dataListArr[j][i];}}}else{for(var n=0;n<1;n++){str+='\n';for(var p=0,length=dataListArr.length;p<length;p++){str+=','+dataListArr[p][n];}}}}else{str='无数据';}
$(this).attr('download',_this.screen.path[_this.screen.path.length-1].title+'.csv');str="\ufeff"+str;var blob=new Blob([str],{type:'text/csv;charset=utf-8'});var csvUrl=URL.createObjectURL(blob);document.getElementById("btnDownLoadExcel_a").href=csvUrl;});$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$noteHideShow.off('click').click(function(){if($noteHideShow.hasClass('glyphicon-eye-close')){$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$('.divNote').show();}else if($noteHideShow.hasClass('glyphicon-eye-open')){$noteHideShow.removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');$('.divNote').hide();}});if($graphsBox.length===0){$graphsBox=$('<ul id="graphBox" style="top:36px;left:auto;right:18px;width:118px;float:right;padding:5px 10px;position:absolute;z-index:150;border:1px solid #DDDDDE;border-radius:5px;background:#fff;display:none;">'+'<li style="width:98px;margin:0 auto;list-style:none;" class="graphSel"><span class="glyphicon glyphicon-arrow-right firstSpan" value="arrow" style="font-size:18px;color:#B6B4B4;margin-right:15px;display:inline-block!important;" id="arrowActive"></span>'+'<span class="icon-check-empty" id="rectActive" value="rect" style="width:16px;height:16px;border:2px solid #B6B4B4;margin-right:15px;display:inline-block!important;"></span>'+'<span class="icon-circle-blank" id="circleActive" value="circle" style="width:18px;height:18px;border:2px solid #B6B4B4;border-radius:9px;display:inline-block!important;"></span></li>'+'<li class="colorTotal" style="width:98px;margin:10px auto 0px;list-style:none;display:none;"><div style="width:24px;height:24px;border:1px solid #BDBEBF;float:left;margin-right:10px;">'+'<span class="colorSelect" style="display:block;width:20px;height:20px;margin:1px;background:red;"></span></div>'+'<div class="colorList" style="float:left;width:60px;margin-top:-5px;">'+'<span style="display:inline-block;width:11px;height:11px;background:#000;margin-right:3px;line-height:11px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;background:#7ab900;margin-right:3px;line-height:11px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#007acc;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ecede5;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ff2525;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#fcd209;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ff5500;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#a6b16c;font-size:11px;"></span></div>'+'<br style="clear:both;"></li>'+'</ul>');$('#anlsPaneContain').append($graphsBox);}
$('#anlsPaneContain').css('position','relative');$('#graphSelsect').off('click').click(function(){if($graphsBox.is(':hidden')){$graphsBox.show();}else{$graphsBox.hide();}});$('#btnDataFilter').off('click').click(function(){new DataCalcFilterContain(_this).show();});$('#anlsPaneContain .colorList span').hover(function(){$(this).css({'border-width':'1px','border-style':'solid','border-color':'#ddddde','border-radius':'5px'});},function(){$(this).css({'border':'none','border-radius':'0px'});});$('#anlsPaneContain .colorList span').off('click').click(function(){var graphType=$('.graphActive').attr('value');$('#anlsPaneContain .colorSelect').css('background-color',$(this).css('background-color'));var color=$('#anlsPaneContain .colorSelect').css('background-color');$('.svgGraph').remove();drawGraph(graphType,color);});$('#anlsPaneContain .graphSel span').off('click').click(function(){var color=$('#anlsPaneContain .colorSelect').css('background-color');var $graphSel=$(this);var graphType=$graphSel.attr('value');if(!$graphSel.hasClass('graphActive')){if($graphSel.hasClass('firstSpan')){$graphSel.css('color','#000');}else{$graphSel.css('border','2px solid #000');}
$graphSel.siblings().css('color','#B6B4B4');$graphSel.siblings().removeClass('graphActive');$graphSel.addClass('graphActive');}else{if($graphSel.hasClass('firstSpan')){$graphSel.css('color','#B6B4B4');}else{$graphSel.css('border','2px solid #B6B4B4');}
$graphSel.removeClass('graphActive');}
if($('#anlsPaneContain .graphSel span').hasClass('graphActive')){$('#anlsPaneContain .colorTotal').show();}else{$('#anlsPaneContain .colorTotal').hide();}
drawGraph(graphType,color);});function drawGraph(graphType,color){var drawGraph=undefined;var containerChilBox;if(_this.screen.curModal.type==='AnlzTendency'){containerChilBox=$(_this.container).find('.containerChi')[0];}else{containerChilBox=_this.container;}
if(graphType=='arrow'){drawGraph=new DrawArrow(_this.screen,{},containerChilBox,color);}else if(graphType=='rect'){drawGraph=new DrawRect(_this.screen,{},containerChilBox,color);}else if(graphType=='circle'){drawGraph=new DrawCircle(_this.screen,{},containerChilBox,color);}
drawGraph.drawing();}},createNote:function(note){var origZIndex;var notePos=getDivNotePos();var dockTriggerIndex=null;var $divNote=$('<div class="divNote">').click(function(){if($('.divNote').length>1){_this.curtNote=$divNote[0];if(this.style.zIndex<_this.getNoteMaxZIndex()){this.style.zIndex=_this.getNoteMaxZIndex()+1;origZIndex=this.style.zIndex;}}}).hover(function(e){if(this.style.zIndex<_this.getNoteMaxZIndex()){origZIndex=getComputedStyle(this).zIndex;this.style.zIndex=_this.getNoteMaxZIndex()+1;}}).attr('id',note?note.id:(new Date()).valueOf()).css({zIndex:_this.getNoteMaxZIndex()+1,left:note?note.x:'auto',right:note?'auto':notePos.x+'px',top:note?note.y:notePos.y,width:note?note.width:this.noteDefaultWidth+'px',height:note?note.height:this.noteDefaultHeight+'px',backgroundColor:note?note.bgColor:''}).mousedown(_this.doDown).mouseup(_this.doUp);var $divDrag=$('<div class="divDrag">').appendTo($divNote);var $divTitle=$('<div class="title">').appendTo($divDrag);$divDrag[0].draggable=true;setDrag($divDrag[0]);var disX=0;var disY=0;function setDrag(obj){obj.onmouseover=function(){obj.style.cursor="move";}
obj.onmousedown=function(event){var realDragObj=obj.parentNode;var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=event.clientX+scrollLeft-realDragObj.offsetLeft;disY=event.clientY+scrollTop-realDragObj.offsetTop;_this.showDockWheel();document.onmousemove=function(event){var ol=event.clientX+scrollLeft;var ot=event.clientY+scrollTop;var l=ol-disX;var t=ot-disY;realDragObj.style.left=l+"px";realDragObj.style.top=t+"px";var isTop=realDragObj.offsetTop<0
var isLeft=realDragObj.offsetLeft<0;var isRight=realDragObj.offsetParent.offsetWidth-realDragObj.offsetLeft<realDragObj.offsetWidth;var isBottom=realDragObj.offsetParent.offsetHeight-realDragObj.offsetTop<realDragObj.offsetHeight;if(isTop){realDragObj.style.top='0px';}
if(isLeft){realDragObj.style.left='0px';}
if(isRight){realDragObj.style.left=realDragObj.parentNode.offsetWidth-realDragObj.offsetWidth+'px';}
if(isBottom){realDragObj.style.top=realDragObj.parentNode.offsetHeight-realDragObj.offsetHeight+'px';}
var area;if(dockTriggerIndex!==null){area=_this.dockArea[dockTriggerIndex];if(ol>area.left&&ol<area.right&&ot>area.top&&ot<area.bottom){}else{dockTriggerIndex=null;area.$ele.removeClass('on');_this.hideDockPreviewer();}
return;}
for(var i=0,len=_this.dockArea.length;i<len;i++){area=_this.dockArea[i];if(ol>area.left&&ol<area.right&&ot>area.top&&ot<area.bottom){dockTriggerIndex=i;area.$ele.addClass('on');_this.showDockPreviewer(area.$ele[0].dataset.type);return;}}}
document.onmouseup=function(){var area=_this.dockArea[dockTriggerIndex];document.onmousemove=null;document.onmouseup=null;var note={id:realDragObj.id,x:((realDragObj.offsetLeft/realDragObj.offsetParent.offsetWidth)*100).toFixed(2)+'%',y:((realDragObj.offsetTop/realDragObj.offsetParent.offsetHeight)*100).toFixed(2)+'%'};_this.hideDockPreviewer();_this.hideDockWheel();if(dockTriggerIndex!==null){_this.saveDockNoteLayout(note.id,area.$ele[0].dataset.type);note.x='10%';note.y='10%';_this.saveDockLayout();return false;}
_this.saveNote(note);}
return false;}}
var $divPin=$('<div class="glyphicon pinIcon grow">&times;</div>').appendTo($divTitle);$divPin.mousedown(function(e){_this.removeNote(this);e.stopPropagation();});var $divText=$('<div class="divText gray-scrollbar">').appendTo($divDrag);if(_this.isShareMode!==1){+function(){var timer=null,mousePos=null;$divText.off('mousedown').mousedown(function(e){mousePos={x:e.clientX,y:e.clientY};});$divText.off('mouseup').mouseup(function(e){if(timer!==null){return;}
timer=window.setTimeout(function(){timer=null;},500);if(Math.abs(mousePos.x-e.clientX)<10&&Math.abs(mousePos.y-e.clientY)<10){showEditor();}
mousePos=null;});}.call(this);function showEditor(e){var $modalConfig;WebAPI.get('/static/views/observer/widgets/modalUEditor.html').done(function(resultHTML){$('.divNote').hide();$('.dock-layout').hide();$('.svgBox').hide();$(_this.container).append(resultHTML);$modalConfig=$('#modalUEditor');$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$('.divNote').show();$('.dock-layout').show();$('#modalUEditorContainer').remove();$('#edui_fixedlayer').remove();$('#anlsPane').css({overflowX:'hidden',overflowY:'auto'})
$('.svgBox').show();UE.delEditor('ueditor');});$modalConfig.off('show.bs.modal').on('show.bs.modal',function(){$('#anlsPane').css({overflow:'visible'})
UE.getEditor('ueditor',{lang:(I18n.type=='zh'?'zh-cn':'en')}).ready(function(){UE.insertPic(this);$(document.querySelector('iframe')).addClass('gray-scrollbar')
var bodyEditor=document.querySelector('iframe').contentWindow.document.querySelector('body');note&&note.bgColor&&(bodyEditor.style.backgroundColor=note.bgColor);bodyEditor.innerHTML=note?note.text:'';});});$modalConfig.off('shown.bs.modal').on('shown.bs.modal',function(){});$modalConfig.modal('show');$(_this.container).find('#saveNote').off('click').on('click',function(){var body=$('iframe','.edui-editor-iframeholder')[0].contentWindow.document.querySelector('body');var content=body.innerHTML;var newNote={id:$divNote[0].id};if(note){newNote.text=content;newNote.bgColor=body.style.backgroundColor;}else{newNote.text=content;newNote.bgColor=body.style.backgroundColor;newNote.height=_this.noteDefaultHeight+'px';newNote.width=_this.noteDefaultWidth+'px';$divNote[0].style.right='';$divNote[0].style.left=($divNote.parent().width()-_this.noteDefaultWidth)+'px';}
_this.saveNote(newNote);$divText.html(content);$divNote.css({backgroundColor:newNote.bgColor})
$modalConfig.modal('hide');if(note){note.text=content;note.bgColor=newNote.bgColor;}else{note=newNote;}})});}}
$divText.html(note?note.text:'');note&&note.bgColor&&$divNote.css({backgroundColor:note.bgColor});$(this.paneNotes).append($divNote);$(document).on('click','#st-container',_this.doClick);$(document).on('mousemove','#st-container',_this.doMove);function getDivNotePos(){var pos={}
var $lastNote=$('.divNote:nth-last-child(1)');if($lastNote[0]){if($lastNote[0].offsetLeft<100){pos.x=0;pos.y=$lastNote[0].offsetTop+$lastNote[0].offsetHeight+20;_this.noteCount=0;}else{++_this.noteCount;pos.x=_this.noteCount*130;pos.y=$lastNote[0].offsetTop;}}else{pos.x=0;pos.y=0;}
return pos;}},removeNote:function(obj){confirm(i18n_resource.analysis.workspace.CONFIRM_NOTE_DELETE,function(){var $divNote=$(obj).closest('.divNote');$divNote.remove();var index=_this.getNoteListIndex($divNote.attr('id'));if(index!=undefined){_this.screen.curModal.noteList.splice(index,1);_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);}});},initNotes:function(){var _this=this;var notes=this.screen.curModal.noteList;var layout=this.screen.curModal.layout||{};if(!notes.length)return;notes.forEach(function(row){var dockPosition=null;for(var t in layout){if(!layout.hasOwnProperty(t)){continue;}
if(!layout[t]||!layout[t].length){continue;}
if(layout[t].indexOf(row.id)>-1){dockPosition=t;break;}}
if(!!dockPosition){_this.createDockNote(row,dockPosition);}else{_this.createNote(row);}});_this.layoutDockNotes();},hideNotes:function(){},showNotes:function(){},getNoteMaxZIndex:function(){var divNoteList=$('.divNote');var maxZIndex=102;for(var i=0;i<divNoteList.length;i++){var zIndex=parseInt(getComputedStyle(divNoteList[i]).zIndex);if(zIndex>maxZIndex){maxZIndex=zIndex;}}
return maxZIndex;},getNoteListIndex:function(id){for(var i=0;i<_this.screen.curModal.noteList.length;i++){if(_this.screen.curModal.noteList[i].id==id){return i;}}},showDockWheel:function(){var _this=this;var $dockFill=this.$dockManager.children('.dock-wheel-fill-icon');var $dockTop=this.$dockManager.children('.dock-wheel-top-icon');var $dockRight=this.$dockManager.children('.dock-wheel-right-icon');var $dockDown=this.$dockManager.children('.dock-wheel-down-icon');var $dockLeft=this.$dockManager.children('.dock-wheel-left-icon');var offset;this.$parentContainer.addClass('on');[$dockFill,$dockTop,$dockRight,$dockDown,$dockLeft].forEach(function($dock,i){offset=$dock.offset();_this.dockArea.push({'left':offset.left,'top':offset.top,'right':offset.left+$dock.width(),'bottom':offset.top+$dock.height(),'$ele':$dock});});},hideDockWheel:function(){this.$parentContainer.removeClass('on');this.$dockManager.children().removeClass('on');},showDockPreviewer:function(type){this.$dockPreviewer.show();this.$dockPreviewer.children('[data-type="'+type+'"]').show();},hideDockPreviewer:function(){this.$dockPreviewer.children().hide();this.$dockPreviewer.hide();},saveDockNoteLayout:function(noteId,direction){var layout=this.screen.curModal.layout;var notes=this.screen.curModal.noteList;var note;if(['top','right','bottom','left'].indexOf(direction)===-1)return;if(!layout){layout=this.screen.curModal.layout={};}
layout[direction]=layout[direction]||[];if(layout[direction].indexOf(noteId)>-1)return;layout[direction].push(noteId);$('#'+noteId).remove();note=notes.filter(function(row,i){return row.id===noteId;});if(note&&note.length){this.createDockNote(note[0],direction);this.layoutDockNotes();_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},createDockNote:function(note,direction){var _this=this;var $ctn=this.$parentContainer.children('.dock-window-ctn');var $divNote=$('<div class="dock-note" style="background-color: '+note.bgColor+'">'+'<div class="dock-note-resizer" data-direction="'+direction+'"></div>'+'<button type="button" class="close editor"><span aria-hidden="true">'+I18n.resource.analysis.workspace.EDIT_NOTE+'</span></button>'+'<button type="button" class="close cancel"><span aria-hidden="true">'+I18n.resource.analysis.workspace.CANCEL_FIX+'</span></button>'+'<div class="dock-note-ct gray-scrollbar" data-id="'+note.id+'"></div>'+'<button id="saveDockNote" type="button" class="" style="display:none;position:absolute;bottom:5px;right:5px;z-index: 9999;color: #333;border-radius: 4px;box-shadow: 0px 3px 8px 2px #ccc;border: 1px solid #ccc;">Save</button>'+'</div>');var $divNoteCt=$divNote.children('.dock-note-ct');var $noteResizer=$divNote.children('.dock-note-resizer');var $layoutCtn,$layoutCtnWrap;var $layoutContainer;if($ctn.length===0){$ctn=$('<div class="dock-window-ctn">');this.$parentContainer.append($ctn[0]);}
if(['top','bottom'].indexOf(direction)>-1){$layoutContainer=$ctn;$divNoteCt.height(note.height);}
if(['left','right'].indexOf(direction)>-1){$layoutCtnWrap=$ctn.children('.dock-layout-wrap');if($layoutCtnWrap.length===0){$layoutCtnWrap=$('<div class="dock-layout-wrap">');$ctn.append($layoutCtnWrap);}
$layoutContainer=$layoutCtnWrap;$divNoteCt.width(note.width);}
$layoutCtn=$layoutContainer.children('.dock-layout-'+direction);if($layoutCtn.length===0){$layoutCtn=$('<div class="dock-layout dock-layout-'+direction+'" data-direction="'+direction+'">');$layoutContainer.append($layoutCtn);}
$divNoteCt.html(note.text);$layoutCtn.append($divNote);$divNote.children('.cancel').off().click(function(){var $this=$(this);var $curNote=$this.closest('.dock-note');var $curNoteCt=$curNote.children('.dock-note-ct');var id=$curNoteCt[0].dataset.id;var index=_this.getNoteListIndex(id);var note=_this.screen.curModal.noteList[index];var arr=_this.screen.curModal.layout[direction];for(var i=0,len=arr.length;i<len;i++){if(arr[i]===id){arr.splice(i,1);break;}}
_this.createNote({id:id,text:$curNoteCt.html(),x:note.x,y:note.y,width:note.width,height:note.height,bgColor:note.bgColor});$curNote.remove();_this.layoutDockNotes('top');_this.saveDockLayout();});$divNote.children('.editor').off().click(function(e){$(document).click();var realHeight=getComputedStyle($divNoteCt[0]).height;var height=realHeight<'100px'?'100px':realHeight;var width=getComputedStyle($divNoteCt[0]).width;var $saveDockNote=$('#saveDockNote');$divNoteCt.hide();$('.divNote').hide();$('.svgBox').hide();$divNote.append('<div style="width: '+width+';height: '+height+';"><script id="ueditor" type="text/plain" style="height:calc(100% - 20px);"></script></div>');UE.delEditor('ueditor');UE.getEditor('ueditor',{lang:(I18n.type=='zh'?'zh-cn':'en')}).ready(function(){UE.insertPic(this);$saveDockNote.show();var iframe=document.querySelector('iframe');var iframeHtml=iframe.contentWindow.document.querySelector('html');var bodyEditor=iframe.contentWindow.document.querySelector('body');$(iframe).addClass('gray-scrollbar');$(iframeHtml).css({overflowX:'hidden'});note&&note.bgColor&&(bodyEditor.style.backgroundColor=note.bgColor);$('.edui-editor-iframeholder').css({height:parseInt(height.split('px')[0])-$('.edui-editor-toolbarbox').height()});bodyEditor.innerHTML=note?note.text:'';$saveDockNote.off('click').on('click',function(){Spinner.spin($('.dock-layout')[0]);$divNoteCt[0].innerHTML=bodyEditor.innerHTML;var newNote={id:$divNoteCt.attr('data-id'),text:$divNoteCt[0].innerHTML,bgColor:bodyEditor.style.backgroundColor}
_this.saveNote(newNote);note.text=$divNoteCt[0].innerHTML;note.bgColor=bodyEditor.style.backgroundColor;$(this).hide();var timer=setTimeout(function(){UE.delEditor('ueditor');$('#ueditor').parent().remove();$divNoteCt.show();$('.divNote').show();$('.svgBox').show();clearTimeout(timer);Spinner.stop();},500);});});});$noteResizer.off('mousedown').mousedown(function(e){$(document).click();var $resizer=$(this);var $note=$resizer.closest('.dock-note');var $noteCt=$note.children('.dock-note-ct');var $wrap=_this.$parentContainer.find('.dock-layout-wrap');var $container=$(_this.container);var direction=$resizer[0].dataset.direction;var downX,downY;var downWidth=$noteCt.width();var downHeight=$noteCt.height();var ctnPos={left:parseFloat($container.css('left'))||0,right:parseFloat($container.css('right'))||0,top:parseFloat($container.css('top'))||0,bottom:parseFloat($container.css('bottom'))||0}
downX=e.pageX;downY=e.pageY;$(document).mousemove(function(e){var moveX=e.pageX;var moveY=e.pageY;var delta;if(direction==='left'){delta=moveX-downX;$noteCt.width(downWidth+delta);}else if(direction==='right'){delta=downX-moveX;$noteCt.width(downWidth+delta);}else if(direction==='top'){delta=moveY-downY;$noteCt.height(downHeight+delta);$wrap.css('top',ctnPos.top+delta);}else if(direction==='bottom'){delta=downY-moveY;$noteCt.height(downHeight+delta);$wrap.css('bottom',ctnPos.bottom+delta);}});$(document).mouseup(function(e){var $this=$(this);var id=$noteCt[0].dataset.id;var params={id:id};var moveX=e.pageX;var moveY=e.pageY;var delta;if(direction==='left'){delta=moveX-downX;$noteCt.width(downWidth+delta);$container.css('left',ctnPos.left+delta);}else if(direction==='right'){delta=downX-moveX;$noteCt.width(downWidth+delta);$container.css('right',ctnPos.right+delta);}else if(direction==='top'){delta=moveY-downY;$noteCt.height(downHeight+delta);$wrap.css('top',ctnPos.top+delta);$container.css('top',ctnPos.top+delta);}else if(direction==='bottom'){delta=downY-moveY;$noteCt.height(downHeight+delta);$wrap.css('bottom',ctnPos.bottom+delta);$container.css('bottom',ctnPos.bottom+delta);}
if(direction==='left'||direction==='right'){params['width']=$note.width();}else{params['height']=$note.height();}
_this.saveNote(params);_this.screen.onresize();$this.off('mousemove');$this.off('mouseup');});e.stopPropagation();});},layoutDockNotes:function(){var _this=this;var $ctn=this.$parentContainer.children('.dock-window-ctn');var $layoutCtnWrap=$ctn.children('.dock-layout-wrap');var $container=$(this.container);$ctn.find('.dock-layout').each(function(i,dom){var $this=$(this);var direction=$this[0].dataset.direction;var $notes=$this.children('.dock-note');var sum=0;if($notes.length===0){$this.remove();}
if(['left','right'].indexOf(direction)>-1){$notes.each(function(i,dom){var $this=$(this);var width=$this.outerWidth();sum+=width;});}
if(['top','bottom'].indexOf(direction)>-1){$notes.each(function(i,dom){var $this=$(this);var height=$this.outerHeight();sum+=height;});$layoutCtnWrap.css(direction,sum);}
$container.css(direction,sum);});_this.screen.onresize();},saveDockLayout:function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);},resizeObject:function(){this.el=null;this.dir="";this.grabx=null;this.graby=null;this.width=null;this.height=null;this.left=null;this.top=null;},getDirection:function(el){var xPos,yPos,offset,dir;dir="";xPos=window.event.offsetX;yPos=window.event.offsetY;offset=8;if(yPos<offset)dir+="n";else if(yPos>el.offsetHeight-offset)dir+="s";if(xPos<offset)dir+="w";else if(xPos>el.offsetWidth-offset)dir+="e";return dir;},doDown:function(){if(this.style.cursor.indexOf('-resize')>-1){$('.divTextEditor').blur();var el=_this.getReal(event.srcElement,"className","divNote");if(el==null){_this.theobject=null;return;}
if(el.className&&el.className.indexOf('divNote')<0)return;_this.dir=_this.getDirection(el);if(_this.dir=="")return;_this.leftObject=new _this.resizeObject();_this.leftObject.el=el;_this.leftObject.dir=_this.dir;_this.leftObject.grabx=window.event.clientX;_this.leftObject.graby=window.event.clientY;_this.leftObject.width=el.offsetWidth;_this.leftObject.height=el.offsetHeight;_this.leftObject.left=el.offsetLeft;_this.leftObject.top=el.offsetTop;window.event.returnValue=false;window.event.cancelBubble=true;}},doUp:function(e){if(e.target.classList.contains('pinIcon'))return;if(_this.leftObject!=null){var note={id:_this.leftObject.el.id,width:_this.leftObject.el.style.width,height:_this.leftObject.el.style.height}
_this.saveNote(note);_this.leftObject=null;}},doMove:function(e){var el,str,xMin,yMin;xMin=_this.noteDefaultWidth/4;yMin=_this.noteDefaultHeight/5;el=event.srcElement;if(!el)return;if(el.className&&typeof(el.className)=='string'&&el.className.indexOf("divNote")>-1){str=_this.getDirection(el);if(str=="")str="default";else str+="-resize";el.style.cursor=str;}
if(_this.leftObject!=null){if(_this.dir.indexOf("e")!=-1)
_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width+window.event.clientX-_this.leftObject.grabx)+"px";if(_this.dir.indexOf("s")!=-1)
_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height+window.event.clientY-_this.leftObject.graby)+"px";if(_this.dir.indexOf("w")!=-1){_this.leftObject.el.style.left=Math.min(_this.leftObject.left+window.event.clientX-_this.leftObject.grabx,_this.leftObject.left+_this.leftObject.width-xMin)+"px";_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width-window.event.clientX+_this.leftObject.grabx)+"px";}
if(_this.dir.indexOf("n")!=-1){_this.leftObject.el.style.top=Math.min(_this.leftObject.top+window.event.clientY-_this.leftObject.graby,_this.leftObject.top+_this.leftObject.height-yMin)+"px";_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height-window.event.clientY+_this.leftObject.graby)+"px";}
window.event.returnValue=false;window.event.cancelBubble=true;}},doClick:function(e){if(!_this.screen||!_this.screen.curModal)return;if(_this.curtNote){if(e.target.classList.contains('pinIcon'))return;if(e.target==_this.curtNote||$(e.target).closest('.divNote')[0]==_this.curtNote){_this.curtNote.style.zIndex=_this.getNoteMaxZIndex()+1;}else{var $thisEditor=$(_this.curtNote).find('.divTextEditor');$(_this.curtNote).find('.btn-toolbar').slideUp('1000',function(){$thisEditor.hide();$(_this.curtNote).find('.divText').html($thisEditor.html()).show();_this.curtNote.style.minWidth='';_this.curtNote.style.minHeight='';});$thisEditor.removeClass('editing');var id=$(_this.curtNote).attr('id');var index=_this.getNoteListIndex(id);var note={id:id,text:$(_this.curtNote).find('.divTextEditor').html(),width:$(_this.curtNote).css('width'),height:$(_this.curtNote).css('height')}
_this.saveNote(note)}}},getReal:function(el,type,value){var temp=el;while((temp!=null)&&(temp.tagName!="BODY")){if(eval("temp."+type)==value){el=temp;return el;}
temp=temp.parentElement;}
return el;},saveNote:function(note){var id=note.id;var isSave=false
if(_this.screen.curModal.noteList==undefined)return;var index=_this.getNoteListIndex(id);if(index==undefined){if(!note.text||$.trim(note.text.length)==0)return;var $divNote=$('#'+id);var note={id:id,x:((parseInt(getComputedStyle($divNote[0]).left.split('px')[0])/$divNote.parent().width())*100).toFixed(2)+'%',y:((parseInt(getComputedStyle($divNote[0]).top.split('px')[0])/$divNote.parent().height())*100).toFixed(2)+'%',width:note.width,height:note.height,text:note.text,bgColor:note.bgColor}
_this.screen.curModal.noteList.push(note);doSave();}else{var note_old=_this.screen.curModal.noteList[index];if(note.x&&note.x!=note_old.x){isSave=true}
if(!isSave&&note.y&&note.y!=note_old.y){isSave=true}
if(!isSave&&note.width&&note.width!=note_old.width){isSave=true}
if(!isSave&&note.height&&note.height!=note_old.height){isSave=true}
if(!isSave&&note.text&&note.text!=note_old.text){isSave=true}
if(isSave){_this.screen.curModal.noteList[index]={id:id,x:note.x?note.x:note_old.x,y:note.y?note.y:note_old.y,width:note.width?note.width:note_old.width,height:note.height?note.height:note_old.height,text:note.text?note.text:note_old.text,bgColor:note.bgColor?note.bgColor:note_old.bgColor}
doSave();}}
function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},initPointAlias:function(arrPointsAlias){var lastRepeatIndex=-1;var tempAlias;var repeatNum=0;var tempIndex;for(var i=0;i<arrPointsAlias.length;++i){lastRepeatIndex=arrPointsAlias.lastIndexOf(arrPointsAlias[i]);if(lastRepeatIndex>i){repeatNum=1;tempAlias=arrPointsAlias[i];arrPointsAlias[i]=tempAlias+'_No1';tempIndex=i;for(var j=tempIndex+1;j<lastRepeatIndex+1;++j){repeatNum+=1;tempIndex=arrPointsAlias.indexOf(tempAlias);if(tempIndex==-1)break;arrPointsAlias[tempIndex]=tempAlias+'_No'+repeatNum;}}}
return arrPointsAlias;}};return AnlzBase;})();﻿var AnlzChart=(function(){function AnlzChart(containerId,entityParams){}
AnlzChart.prototype.renderModal=function(){this.container.innerHTML=template;},AnlzChart.prototype.updateModal=function(name,value){},AnlzChart.prototype.showConfigMode=function(){}
return AnlzChart;})();var AnlzPieRealtime=(function(){var _this;function AnlzPieRealtime(container,option,screen){AnlzBase.call(this,container,option,screen);_this=this;this.paneChart=undefined;this.chart=undefined;this.dictLegend={};this.postData={};this.interv=undefined;this.options.dataList={};}
AnlzPieRealtime.prototype=new AnlzBase();AnlzPieRealtime.prototype.optionTemplate={imgName:'anlsPieRealtime.png',imgIndex:5,imgColor:'211,97,78',templateName:'analysis.modalType.PIE_REAL_TIME',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['realTime']};AnlzPieRealtime.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.dictLegend=null;clearInterval(_this.interv);this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzPieRealtime.prototype.init=function(){_this.postData={dsItemIds:_this.options.itemDS[0].arrId};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',_this.postData).done(function(result){if(result&&result.dsItemList){var rslt=result.dsItemList;if(rslt.error&&rslt.error.length>0){alert(rslt.error);_this.spinnerStop();return;}
_this.renderModal(rslt);}}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});_this.interv=setInterval(function(){_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',_this.postData).done(function(result){var data=result.dsItemList;if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
if(data&&data!=''){var arrData=[];var arrId=[];var arrItem=[];for(var i=0;i<data.length;i++){arrId.push(data[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,item;i<data.length;i++){item=data[i];for(var m=0;m<arrItem.length;m++){if(item.dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;arrData.push({value:parseFloat(item.data),name:itemName});break;}}}
var series=[{type:'pie',radius:'55%',center:['50%','60%'],data:arrData}];_this.chart&&_this.chart.getOption().series.push(series);}
_this.spinnerStop();}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});},60000);};AnlzPieRealtime.prototype.render=function(data){var arrLabel=[],arrData=[];var arrId=[];var arrItem=[];for(var i=0;i<data.length;i++){arrId.push(data[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,item;i<data.length;i++){item=data[i];for(var m=0;m<arrItem.length;m++){if(item.dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;arrLabel.push(itemName);arrData.push({value:parseFloat(item.data),name:itemName});this.options.dataList[itemName]=this.options.dataList[itemName]?this.options.dataList[itemName]:[];this.options.dataList[itemName].push(parseFloat(item.data));break;}}}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:'',x:'center'},tooltip:{trigger:'item',formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:'vertical',x:'left',data:arrLabel},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:true,series:[{type:'pie',center:['50%','60%'],data:arrData}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzPieRealtime;})();﻿var AnlzHistoryCompare=(function(){var _this;function AnlzHistoryCompare(container,option,screen){AnlzBase.call(this,container,option,screen);_this=this;this.curIndex=1;if(this.options){this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}}
AnlzHistoryCompare.prototype=new AnlzBase();AnlzHistoryCompare.prototype.optionTemplate={imgName:'anlsHistory.png',imgIndex:3,imgColor:'65,131,189',templateName:'analysis.modalType.HISTORY_COMPARE',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easyCompareAnalyz','compareSensor','compareMeter']};AnlzHistoryCompare.prototype.show=function(){this.container.innerHTML='';this.initTools();this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});var temp;this.paneChart=document.createElement('div');temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='100% ';this.container.appendChild(this.paneChart);temp=null;_this.spinnerRender.spin(this.container.parentElement);this.init();};AnlzHistoryCompare.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.dictLegend=null;this.curIndex=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzHistoryCompare.prototype.init=function(){AppConfig.datasource.getDSItemDataMulti(this,this.options.itemDS[0].arrId);};AnlzHistoryCompare.prototype.render=function(data){this.chart?this.refreshChart(data):this.initChart(data);};AnlzHistoryCompare.prototype.initChart=function(data){this.createSeries(data);var i18nEcharts=I18n.resource.echarts;var option={title:{text:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{x:'right',data:this.arrLegendData},toolbox:{show:false,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,grid:{x:60,x2:20,y:60,borderColor:'#eee'},xAxis:[{type:'category',data:this.options.arrComparePeriodLabel}],yAxis:[{type:'value'}],series:this.arrSeries};this.options.xAxisData=this.options.arrComparePeriodLabel;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);var _this=this;};AnlzHistoryCompare.prototype.refreshChart=function(data){var arrData=[],item=data.list[0];if(this.dictLegend[item.dsItemId])return;var tempOption=this.chart.getOption();var arrTemp=tempOption.series;arrTemp.push(this.createSeries(item.data));this.chart.setOption(tempOption);arrTemp=null;this.options.itemDS[0].arrId.push(item.dsItemId);var _this=this;this.screen.saveModal();};AnlzHistoryCompare.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],calcResult=[],arrId=[];var mode=this.options.mode;if(mode=='easyCompareAnalyz'||mode=='compareSensor'){for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];var dsItemIdName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;calcResult[i][j]=0;if(i==0){arrId.push(point.dsItemId);arrLegendData.push(dsItemIdName);}
for(var k=0;k<point.data.length;k++){calcResult[i][j]+=parseFloat(point.data[k])}
calcResult[i][j]=calcResult[i][j]/point.data.length;this.options.dataList[dsItemIdName]=this.options.dataList[dsItemIdName]?this.options.dataList[dsItemIdName]:[];this.options.dataList[dsItemIdName].push(calcResult[i][j]);}}}else if(mode=='compareMeter'){for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];if(i==0){arrLegendData.push(AppConfig.datasource.getDSItemById(point.dsItemId).alias);}
calcResult[i][j]=point.data[point.data.length-1]-point.data[0];this.options.dataList[dsItemIdName]=this.options.dataList[dsItemIdName]?this.options.dataList[dsItemIdName]:[];this.options.dataList[dsItemIdName].push(calcResult[i][j]);}}}
arrLegendData=_this.initPointAlias(arrLegendData);var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(data[0].list[0].dsItemId);for(var i=0;i<data[0].list.length;i++){var seriesData=[];for(var j=0;j<data.length;j++){seriesData.push(calcResult[j][i])}
var color=echarts.config.color[this.curIndex++];var series={name:arrLegendData[i],type:'bar',data:seriesData,itemStyle:{normal:{lineStyle:{color:color},barBorderRadius:[5,5,5,5]}}}
arrSeries.push(series);}
this.arrSeries=arrSeries;this.arrLegendData=arrLegendData;};return AnlzHistoryCompare;})();var AnlzHistoryCompare_Line=(function(){var _this;function AnlzHistoryCompare_Line(container,option,screen){_this=this;AnlzHistoryCompare.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzHistoryCompare_Line.prototype=new AnlzHistoryCompare();AnlzHistoryCompare_Line.prototype.optionTemplate={imgName:'anlsHistory.png',imgIndex:3,imgColor:'65,131,189',templateName:'analysis.modalType.HISTORY_COMPARE_LINE',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easyCompareAnalyz','compareSensor','compareMeter']};AnlzHistoryCompare_Line.prototype.initChart=function(data){this.createSeries(data);var xAxis=[];for(var i=0;i<data[0].timeShaft.length;++i){xAxis.push('Day'+new Date(data[0].timeShaft[i]).getDate()+' '+new Date(data[0].timeShaft[i]).format("HH:mm:ss"));}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'},formatter:function(params){var strToolTip='',date;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(_this.options.itemDS[0].arrId);for(var i=0;i<params.length;i++){if(i%2==0){for(var m=0;m<arrItem.length;m++){if(_this.options.itemDS[0].arrId[i/2]==arrItem[m].id){strToolTip+=arrItem[m].alias+'<br/>';strToolTip+=data[0].timeShaft[params[i].dataIndex]+'<br/>Value: '+params[i].value+'<br/>'
break;}}}else{strToolTip+=data[1].timeShaft[params[i].dataIndex]+'<br/>Value: '+params[i].value+'<br/>'}}
return strToolTip;}},legend:{x:'right',data:this.arrLegendData},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:false,grid:{x:60,x2:20,y:60,borderColor:'#eee'},dataZoom:{show:false},xAxis:[{type:'category',data:xAxis,splitLine:{show:false}}],yAxis:[{type:'value',scale:true}],series:this.arrSeries};this.options.xAxisData=xAxis;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);var _this=this;};AnlzHistoryCompare_Line.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],pointData=[],arrId=[];var mode=this.options.mode;if(mode=='easyCompareAnalyz'||mode=='compareSensor'){for(var i=0;i<data.length;i++){var item=data[i];pointData[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];var pointName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;pointData[i][j]=[];if(i==0){arrId.push(point.dsItemId);arrLegendData.push(this.options.arrComparePeriodLabel[0]+':'+pointName);arrLegendData.push(this.options.arrComparePeriodLabel[1]+':'+pointName);}
for(var k=0;k<point.data.length;k++){pointData[i][j].push(parseFloat(point.data[k]));}
this.options.dataList[pointName]=this.options.dataList[pointName]?this.options.dataList[pointName]:[];this.options.dataList[pointName].push(pointData[i][j]);}}}else if(mode=='compareMeter'){for(var i=0;i<data.length;i++){pointData[i]=[];var item=data[i];for(var j=0;j<item.list.length;j++){pointData[i][j]=[];var point=item.list[j];var pointName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;if(i==0){arrLegendData.push(this.options.arrComparePeriodLabel[0]+':'+pointName);arrLegendData.push(this.options.arrComparePeriodLabel[1]+':'+pointName);}
for(var k=0;k<point.data.length;k++){pointData[i][j].push(parseFloat(point.data[k]));}
this.options.dataList[pointName]=this.options.dataList[pointName]?this.options.dataList[pointName]:[];this.options.dataList[pointName].push(pointData[i][j]+'\n');}}}
if(arrLegendData[0]==arrLegendData[1]){arrLegendData[0]+='_No1';arrLegendData[1]+='_No2';}
var index=0;for(var i=0;i<data[0].list.length;i++){var seriesData=[];for(var j=0;j<data.length;j++){seriesData=pointData[j][i];var color=echarts.config.color[this.curIndex++];var series={name:arrLegendData[index],type:'line',data:seriesData,itemStyle:{normal:{barBorderRadius:[5,5,5,5]}}};arrSeries.push(series);index=index+1;}}
this.arrSeries=arrSeries;this.arrLegendData=arrLegendData;};return AnlzHistoryCompare_Line;})();﻿var AnlzScatter=(function(){function AnlzScatter(container,option,screen){AnlzBase.call(this,container,option,screen);this.animation=true;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzScatter.prototype=new AnlzBase();AnlzScatter.prototype.optionTemplate={imgName:'anlsScatter.png',imgIndex:2,imgColor:'211,97,78',templateName:'analysis.modalType.SCATTER',templateParams:{paraName:['X','Y'],paraAnlysMode:'all',dataTypeMaxNum:[1,5]},chartConfig:['easy','fixed','recent']};AnlzScatter.prototype.init=function(){var _this=this;var arrIds=[];arrIds.push(this.options.itemDS[0].arrId[0]);arrIds=arrIds.concat(this.options.itemDS[1].arrId);var postData={dsItemIds:arrIds,timeStart:new Date(this.options.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(this.options.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.options.format};WebAPI.post('/analysis/startWorkspaceDataGenScatterChart',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});};AnlzScatter.prototype.render=function(data){var arrXAxis=data.list[0].data,arrData=[],arrLegend=[],arrSeries=[];var arrId=[];var arrItem=[];var dataListBack={};for(var i=1;i<data.list.length;i++){arrId.push(data.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<data.list.length;i++){if(i===0){this.options.xAxisData=data.list[i].data;}else{arrData.push([]);for(var m=0;m<arrItem.length;m++){if(data.list[i].dsItemId==arrItem[m].id){arrLegend.push(arrItem[m].alias);this.options.dataList[arrItem[m].alias]=data.list[i].data;break;}}}}
for(var dictItems in this.options.dataList){var dictYItem=this.options.dataList[dictItems];dataListBack[dictItems]=[];for(var n=0,len=dictYItem.length;n<len;n++){dataListBack[dictItems].push('('+this.options.xAxisData[n]+'、'+dictYItem[n]+')');}}
this.options.dataList=dataListBack;for(var i=0,valueX;i<arrXAxis.length;i++){valueX=data.list[0].data[i];for(var j=0,jLen=data.list.length-1;j<jLen;j++){arrData[j].push([valueX,data.list[j+1].data[i]]);}}
for(var i=0;i<arrData.length;i++){arrSeries.push({name:arrLegend[i],type:'scatter',data:arrData[i],markLine:{data:[{type:'average',name:I18n.resource.observer.analysis.AVERAGE}]}});}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:'X: '+AppConfig.datasource.getDSItemById(data.list[0].dsItemId).alias,subtext:'Scatter'},tooltip:{trigger:'axis',showDelay:0,axisPointer:{show:true,type:'cross',lineStyle:{type:'dashed',width:1}}},legend:{data:arrLegend},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},xAxis:[{type:'value',scale:true}],yAxis:[{type:'value',scale:true}],series:arrSeries,animation:this.animation,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzScatter;})();﻿var AnlzSpectrum=(function(){function AnlzSpectrum(container,option,screen){AnlzBase.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzSpectrum.prototype=new AnlzBase();AnlzSpectrum.prototype.optionTemplate={imgName:'anlsSpectrum.png',imgIndex:1,imgColor:'148,193,142',templateName:'analysis.modalType.SPECTRUM',templateParams:{paraName:['X'],paraAnlysMode:'all',dataTypeMaxNum:[1]},chartConfig:['easy','fixed','recent']};AnlzSpectrum.prototype.init=function(){var _this=this;var postData={dsItemIds:[this.options.itemDS[0].arrId[0]],timeStart:new Date(this.options.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(this.options.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.options.format};WebAPI.post('/analysis/startWorkspaceDataGenPattern',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});};AnlzSpectrum.prototype.render=function(data){var arrLabel=[],arrData=[];for(var i=0,item;i<data.list.length;i++){item=data.list[i];arrLabel.push(item.data);arrData.push(item.pattern);}
var i18nEcharts=I18n.resource.echarts;var name=AppConfig.datasource.getDSItemById(this.options.itemDS[0].arrId[0]).alias;var option={title:{text:name,subtext:'Spectrum'},tooltip:{trigger:'axis'},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:true,xAxis:[{type:'category',boundaryGap:true,data:arrLabel}],yAxis:[{type:'value'}],series:[{type:'bar',data:arrData,itemStyle:{normal:{color:'#5bc0de',barBorderRadius:[5,5,0,0]}},markLine:{data:[{type:'average',name:I18n.resource.observer.analysis.AVERAGE}]}}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.options.xAxisData=arrLabel;this.options.dataList[name]=arrData;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzSpectrum;})();﻿var AnlzTendency=(function(){var _this;function AnlzTendency(container,option,screen){AnlzBase.call(this,container,option,screen);this.paneLegend=undefined;this.dictLegend={};this.dictTooltip={};this.curIndex=0;this.legendType={NORMAL:0,Prediction:1,Regression:2};this.screen=screen;this.animation=true;this.timeType=!option?'h1':option.format;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};if(this.options.chartOption){this.modifyData=this.options.chartOption;if(!this.modifyData.chartName){this.modifyData.chartName='';}
if(!this.modifyData.xUnit){this.modifyData.xUnit='';}
if(!this.modifyData.yUnit){this.modifyData.yUnit='';}
if(!this.modifyData.yMark){this.modifyData.yMark='';}
if(!this.modifyData.yMax){this.modifyData.yMax='';}
if(this.modifyData.yMin||this.modifyData.yMin==0){this.modifyData.yMin=this.modifyData.yMin;}else{this.modifyData.yMin='';}}else{this.modifyData={};}
if(!this.options.dictShowData){this.options.dictShowData={}}
this.dictShowData=this.options.dictShowData;for(var key in this.dictShowData){for(var i=0,len=this.dictShowData[key].length;i<len;i++){this.dictShowData[key][i]=this.fillData(this.dictShowData[key][i]);}}
if(!this.options.dictShowFlag){this.options.dictShowFlag={};}
this.dictShowFlag=this.options.dictShowFlag;_this=this;}
AnlzTendency.prototype=new AnlzBase();AnlzTendency.prototype.optionTemplate={imgName:'anlsTendency.png',imgIndex:0,imgColor:'65,131,189',templateName:'analysis.modalType.TENDENCY',templateParams:{paraName:['X','X2'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent']};AnlzTendency.prototype.show=function(){this.container.innerHTML='';this.initTools();this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();$('#chartModify').hide();$('#btnDataFilter').hide();if(this.container.id==='anlsPane'&&!$(this.container).hasClass('panel-readonly')){$('#chartModify').show();$('#btnDataFilter').show();}
_this.modifyEcharts();$('#modifyChart .row').hide();if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});var temp,wrap;this.paneChart=document.createElement('div');this.paneChart.className='divPaneChart';temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='calc(100% - 170px)';this.paneLegend=document.createElement('div');this.paneLegend.className='divHover';temp=this.paneLegend.style;temp.marginTop='10px';temp.padding='10px';temp.cssFloat='left';temp.width='100%';temp.height='160px';temp.position='relative';this.container.appendChild(this.paneChart);this.container.appendChild(this.paneLegend);if(this.isShareMode===1)$(this.container).addClass('read-mode');temp=null;_this.spinnerRender.spin(this.container.parentElement);this.init();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;var containerChilBox='<div class="containerChi" style=""></div>';$(this.container).prepend(containerChilBox);$('.containerChi').css({width:'100%',height:'calc(100% - 210px)',position:'absolute',top:'20px',left:0});for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}
graph.show();}}};AnlzTendency.prototype.modifyEcharts=function(){var _this=this;var $modifyLayer=$('.modifyLayer');if($modifyLayer.length===0){$modifyLayer=$('<div class="modal fade modifyLayer" style="position:absolute;z-index:151;"><div class="modal-dialog" style="width:65%;"><div class="modal-content">'+'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">'+I18n.resource.modalConfig.editChart.TITLE+'</h4></div>'+'<div class="modal-body">'+'<div width="100%" style="margin-top:20px;"><div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.CHART_NAME+':</span><input type="text" id="changeEchName" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.X_AXIS_UNIT+':</span><input type="text" id="addXUnit" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_UNIT+':</span><input type="text" id="addYUnit" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_SCALE+':</span><input type="text" id="changeYMark" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_MAX+':</span><input type="text" id="changeYMax" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 40px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_MIN+':</span><input type="text" id="changeYMin" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div></div>'+'<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="modifyBtn">'+I18n.resource.modalConfig.editChart.BTN_CONFIRM+'</button></div>'+'</div></div></div>');$(_this.container).parents('#anlsPaneContain').append($modifyLayer);}
$('#chartModify').off('click').click(function(){_this.modifyEcharts();if($modifyLayer.is(':hidden')){$modifyLayer.modal('show');$('#changeEchName')[0].value=_this.modifyData.chartName?_this.modifyData.chartName:'';$('#addXUnit')[0].value=_this.modifyData.xUnit?_this.modifyData.xUnit:'';$('#addYUnit')[0].value=_this.modifyData.yUnit?_this.modifyData.yUnit:'';$('#changeYMark')[0].value=_this.modifyData.yMark?_this.modifyData.yMark:'';$('#changeYMax')[0].value=_this.modifyData.yMax?_this.modifyData.yMax:'';$('#changeYMin')[0].value=(_this.modifyData.yMin===0||_this.modifyData.yMin)?_this.modifyData.yMin:'';}else{$modifyLayer.modal('hide');}});$('#modifyBtn').off('click').click(function(){if($('#addYUnit').val()==null||$('#addYUnit').val()==0||$('#addYUnit').val()==undefined){_this.modifyData.yUnit='';}else{_this.modifyData.yUnit=$('#addYUnit').val();}
if($('#addXUnit').val()==null||$('#addXUnit').val()==0||$('#addXUnit').val()==undefined){_this.modifyData.xUnit='';}else{_this.modifyData.xUnit=$('#addXUnit').val();}
if($('#changeEchName').val()==null||$('#changeEchName').val()==0||$('#changeEchName').val()==undefined){_this.modifyData.chartName='';}else{_this.modifyData.chartName=$('#changeEchName').val();}
if($('#changeYMark').val()==null||$('#changeYMark').val()==0||$('#changeYMark').val()==undefined){_this.modifyData.yMark=null;}else{if(isNaN($('#changeYMark').val())){_this.modifyData.yMark=null;}else{_this.modifyData.yMark=parseInt($('#changeYMark').val());}}
if($('#changeYMax').val()==null||$('#changeYMax').val()==0||$('#changeYMax').val()==undefined){_this.modifyData.yMax=null;}else{if(isNaN($('#changeYMax').val())){_this.modifyData.yMax=null;}else{_this.modifyData.yMax=parseInt($('#changeYMax').val());}}
if($('#changeYMin').val()==null||$('#changeYMin').val()==undefined){_this.modifyData.yMin=null;}else{if(isNaN($('#changeYMin').val())){_this.modifyData.yMin=null;}else{_this.modifyData.yMin=parseInt($('#changeYMin').val());}}
if(parseInt(_this.yMin)>=parseInt(_this.yMax)){_this.modifyData.yMin=0;_this.modifyData.yMax=100;}
_this.saveChartModify();$('.divPage.selected').trigger('click');});},AnlzTendency.prototype.saveChartModify=function(){_this.options.chartOption={chartName:_this.modifyData.chartName?_this.modifyData.chartName:null,xUnit:_this.modifyData.xUnit?_this.modifyData.xUnit:null,yUnit:_this.modifyData.yUnit?_this.modifyData.yUnit:null,yMark:_this.modifyData.yMark?parseInt(_this.modifyData.yMark):null,yMax:_this.modifyData.yMax?parseInt(_this.modifyData.yMax):null,yMin:(_this.modifyData.yMin||_this.modifyData.yMin===0)?parseInt(_this.modifyData.yMin):null}
doSave();function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,false]);}},AnlzTendency.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.dropMaskLayer=null;this.paneLegend=null;this.paneChart=null;this.chart=null;this.dictLegend=null;this.curIndex=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();$('#chartModify').hide();$('#btnDataFilter').hide();$('#modifyChart .row').hide();this.chartName=null;this.xUnit=null;this.yUnit=null;this.yMark=null;this.yMax=null;this.yMin=null;this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzTendency.prototype.init=function(){var _this=this;var itemDSLength=this.options.itemDS?this.options.itemDS.length:0;var arrIdList=[];if(itemDSLength){for(var j=0;j<itemDSLength;j++){var arrDsId=this.options.itemDS[j].arrId;if(arrDsId){for(var i=0,len=arrDsId.length;i<len;i++){var bFind=false;for(var key in this.dictShowFlag){if(key==arrDsId[i]){bFind=true;break;}}
if(!bFind){this.dictShowFlag[arrDsId[i]]=true;}}}}}
arrIdList=arrIdList.concat(this.options.itemDS[0].arrId);arrIdList=this.options.itemDS[1]?arrIdList.concat(this.options.itemDS[1].arrId):arrIdList;AppConfig.datasource.getDSItemData(this,arrIdList);this.paneLegend.ondragenter=function(e){var $ele=$(_this.paneLegend);if($ele.hasClass('dis'))return;$ele.addClass('dragHover');e.stopPropagation();e.preventDefault();};this.paneLegend.ondragleave=function(e){$(_this.paneLegend).removeClass('dragHover');e.stopPropagation();e.preventDefault();};this.paneLegend.ondragover=function(e){e.preventDefault();};this.paneLegend.ondrop=function(e){_this.spinnerRender.spin(_this.container.parentElement);var dsItemId=EventAdapter.getData().dsItemId;var $ele=$(_this.paneLegend);$ele.removeClass('dragHover dis');if(dsItemId){if(Object.prototype.toString.call(dsItemId)==='[object Array]'){var len=dsItemId.length;for(var i=0,len=dsItemId.length;i<len;i++){if($ele.find('[id="lg_'+dsItemId[i]+'"]').length>0){dsItemId.splice(i,1);len=len-1;i=i-1;}}
if(dsItemId.length<1){_this.spinnerStop();}else{AppConfig.datasource.getDSItemData(_this,dsItemId);}}else{if($ele.find('[id="lg_'+dsItemId+'"]').length>0){_this.spinnerStop();return;}
AppConfig.datasource.getDSItemData(_this,[dsItemId]);}}else _this.spinnerStop();}};AnlzTendency.prototype.render=function(data){if(data){this.chart?this.refreshChart(data):this.initChart(data);}
this.spinnerRender.stop();};AnlzTendency.prototype.initChart=function(data){var arrSeries=[],legend=[];var series,item,i,option;for(i=0;i<data.list.length;i++){item=data.list[i];series=this.createSeries(item.dsItemId,item.data);arrSeries.push(series);}
this.showFilterCharts(arrSeries);for(i=0;i<arrSeries.length;i++){legend.push(arrSeries[i].name);}
this.resetShowData(data,0);for(var key in this.dictShowFlag){for(var j=0,lenJ=arrSeries.length;j<lenJ;j++){if(key==arrSeries[j].id){if(!this.dictShowFlag[key]){arrSeries[j].data=[];}
break;}}}
var itemDsList=this.options.itemDS;if(itemDsList[0].arrId&&itemDsList.length>1){if(itemDsList[0].arrId.length>0&&itemDsList[1].arrId.length>0){for(var n=0,len=itemDsList.length;n<len;n++){var item=itemDsList[n];if(item){if(item.type==='X2'){var itemOneArrId=item.arrId;for(var p=0,lenP=itemOneArrId.length;p<lenP;p++){for(var m=0,lenJ=arrSeries.length;m<lenJ;m++){if(itemOneArrId[p]===arrSeries[m].id){arrSeries[m].yAxisIndex=1;}}}}else if(item.type==='X'){continue;}}}}}
option=this.initOption(arrSeries,data.timeShaft);if(this.isShareMode===1)option.legend={data:legend};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};AnlzTendency.prototype.initOption=function(series,timeSHaft){var i18nEcharts=I18n.resource.echarts;var option={tooltip:{trigger:'axis'},grid:{x:60,x2:60,y:60,y2:70,borderColor:'#eee'},toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:true,dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,data:timeSHaft,axisLabel:{formatter:'{value} '}}],yAxis:[{type:'value',scale:true,axisLabel:{formatter:function(value){var ret;if(value<1000){ret=value;}
else if(value<1000000){ret=value/1000+'k';}
else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0.8}}}],series:series,animation:this.animation,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};if(this.modifyData&&this.modifyData.chartName){option.title={text:this.modifyData.chartName};}
if(this.modifyData&&this.modifyData.xUnit){option.xAxis[0].name=this.modifyData.xUnit;option.xAxis[0].nameLocation='start';}
if(this.modifyData&&this.modifyData.yUnit){option.yAxis[0].name=this.modifyData.yUnit;}
if(this.modifyData&&this.modifyData.yMax){option.yAxis[0].max=this.modifyData.yMax;}
if(this.modifyData&&this.modifyData.yMin!==null&&this.modifyData.yMin!==''){option.yAxis[0].min=this.modifyData.yMin;}
if(this.modifyData&&this.modifyData.yMark){option.yAxis[0].splitNumber=(this.modifyData.yMax-this.modifyData.yMin)/this.modifyData.yMark;}
this.options.xAxisData=option.xAxis[0].data;var itemDsList=this.options.itemDS;if(itemDsList.length>1){if(itemDsList[0].arrId.length>0&&itemDsList[1].arrId.length>0){var yAxisTwo={type:'value',scale:true,axisLabel:{formatter:function(value){var ret;if(value<1000){ret=value;}
else if(value<1000000){ret=value/1000+'k';}
else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0}}}
option.yAxis.push(yAxisTwo);}else{var isRight=0;for(var i=0;i<itemDsList.length;i++){var item=itemDsList[i]
if(item.type==='X2'&&item.arrId.length>0){isRight+=1;}else if(item.type==='X'&&item.arrId.length<=0){isRight+=1;}}
if(isRight===2){option.yAxis[0].position='right';}}}
return option;};AnlzTendency.prototype.refreshChart=function(data){for(var i=0,len=data.list.length;i<len;i++){var item=data.list[i];if(this.dictLegend[item.dsItemId])return;this.resetShowData(data,0);this.dictShowFlag[item.dsItemId]=true;var tempOption=this.chart.getOption();if(tempOption.xAxis[0].data.length===0&&data.timeShaft.length>0){tempOption.xAxis[0].data=data.timeShaft;this.timeShift=data.timeShaft;}
var arrTemp=tempOption.series;arrTemp.push(this.createSeries(item.dsItemId,item.data));this.chart.setOption(tempOption);arrTemp=null;this.options.itemDS[0].arrId.push(item.dsItemId);var _this=this;this.screen.saveModal();}};AnlzTendency.prototype.createSeries=function(id,data,type){if(!type)type=this.legendType.NORMAL;var name,len;if(type==this.legendType.NORMAL){name=AppConfig.datasource.getDSItemById(id).alias;}
else{name=id.split('_');name=AppConfig.datasource.getDSItemById(name[0]).alias+'_'+id[1];}
this.options.dataList[name]=data;len=echarts.config.color.length;var color=echarts.config.color[this.curIndex%len];this.curIndex++;var div=this.renderLegend(id,name,type,color);var tipInf=this.getStatisticsInfo(data);if(Boolean(tipInf)){this.initTendencyTips($(div),tipInf.max,tipInf.min,tipInf.avg,tipInf.sum);}
return{id:id,name:name,type:'line',symbol:'none',data:data,itemStyle:{normal:{color:color}}}};AnlzTendency.prototype.refreshChartFilter=function(data,condition,series){var item=data.list[0];if(this.dictLegend[item.dsItemId])return;var newFilterId=item.dsItemId+'_filter';var bFilterFind=false;for(var i=0,len=series.length;i<len;i++){if(newFilterId==series[i].id){bFilterFind=true;break;}}
if(bFilterFind){series[i].data=item.data;var $div=$('#lg_'+newFilterId);var tipTmp=$div.data('bs.tooltip');if(!tipTmp){return;}
var tip=tipTmp.$tip;if(tip){var tipInf=this.getStatisticsInfo(item.data);tip.find('.filterMax').text(I18n.resource.observer.widgets.MAXIMUM+': '+tipInf.max);tip.find('.filterMin').text(I18n.resource.observer.widgets.MINIMUM+': '+tipInf.min);tip.find('.filterAvg').text(I18n.resource.observer.widgets.AVERAGE+': '+tipInf.avg);tip.find('.filterSum').text(I18n.resource.observer.widgets.TOTAL_AMOUNT+': '+tipInf.sum);tip.find('.filterCondition').text(I18n.resource.observer.widgets.FILTER_FORMULA+': '+condition);}
var appendId=item.dsItemId+'_append';var arrAppend=[];for(var i=0,len=series.length;i<len;i++){if(appendId==series[i].id){arrAppend.push(i);}}
if(arrAppend.length>0){for(var j=0,len2=arrAppend.length;j<len2;j++){series.splice(arrAppend[j],1);}}}
else{series.unshift(this.createSeriesFilter(item.dsItemId,item.data,newFilterId,condition));}
this.spinnerRender.stop();};AnlzTendency.prototype.createSeriesFilter=function(id,data,newId,condition){var name,len;name=AppConfig.datasource.getDSItemById(id).alias+'_filter';len=echarts.config.color.length;var color=echarts.config.color[this.curIndex%len];this.curIndex++;var div=this.renderLegend(newId,name,0,color);var tipInf=this.getStatisticsInfo(data);if(Boolean(tipInf)){this.initTendencyTipsFilter($(div),tipInf.max,tipInf.min,tipInf.avg,tipInf.sum,condition);}
return{id:newId,name:name,type:'line',symbol:'none',data:data,itemStyle:{normal:{lineStyle:{color:color}}}}};AnlzTendency.prototype.removeSeries=function(id){var _this=this;delete this.dictLegend[id];$('#lg_'+id).remove();var option=this.chart.getOption();var arrSeries=option.series;for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].id==id){arrSeries.splice(i,1);break;}}
var arrIds=this.options.itemDS[0].arrId;for(var i=0;i<arrIds.length;i++){if(arrIds[i]==id){arrIds.splice(i,1);}}
this.options.itemDS[0].arrId=arrIds;var nIdx=id.indexOf('_filter');if(-1!=nIdx){var origId=id.substr(0,nIdx);var arrFilter=this.options.arrFilter;if(arrFilter){for(var i=0,len=arrFilter.length;i<len;i++){if(origId==arrFilter[i].pointId){arrFilter.splice(i,1);break;}}}}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,option.xAxis[0].data));window.setTimeout(function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,true]);},500);};AnlzTendency.prototype.getDataById=function(id){var arrSeries=this.chart.getOption().series;for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].id==id){return arrSeries[i].data;}}};AnlzTendency.prototype.renderLegend=function(id,name,type,color){var _this=this;var name=name;var div=document.createElement("div");var closeBtn='<button type="button" class="close"><span>&times;</span></button>';var btnShow;if(this.dictShowFlag[id]){btnShow='<span class="glyphicon glyphicon-eye-open btnShow" aria-hidden="true"></span>';}
else{btnShow='<span class="glyphicon glyphicon-eye-close btnShow" aria-hidden="true"></span>';}
div.id='lg_'+id;div.dataset.id=id;div.className="divLegend";div.draggable=true;div.style.backgroundColor=color;div.setAttribute('ty',type);switch(type){case this.legendType.Regression:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split('_Regression_')[0]+"_Regression</div>"+btnShow+closeBtn;this.initGeneralRegressorTooltip(id,div);};break;case this.legendType.Prediction:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split('_Prediction_')[0]+"_Prediction</div>"+btnShow+closeBtn;this.initGeneralPredictorTooltip(id,div);};break;default:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-stats' style='margin-right: 10px;'></span>"+name+'</div>'+btnShow+closeBtn;};break}
div.getElementsByClassName('close')[0].onclick=function(e){var $ele=$(e.currentTarget).parent();var id=$ele[0].dataset.id;if($('.divLegend').length>1){var option=_this.chart.getOption();if(option){var arrSeries=option.series;if(arrSeries){var cnt=0;for(var key in _this.options.dataList)cnt++;if(cnt<=1){alert('The only parameters can\'t be removed');return;}}}
var doct=$ele.eq(0).find('.divTxtWrap').text();delete _this.options.dataList[doct];$ele.tooltip('destroy');_this.removeSeries(id);var cnt=id.indexOf('_filter');if(-1!=cnt){var preId=id.substr(0,cnt);if(preId){_this.removeSeries(preId+'_append');}}}else{alert('The only parameters can\'t be removed');}
e.stopPropagation();};div.getElementsByClassName('btnShow')[0].onclick=function(e){var $ele=$(e.currentTarget).parent();var id=$ele[0].dataset.id;_this.switchSeries(id);e.stopPropagation();};div.ondragstart=function(e){$(_this.paneLegend).addClass('dis');e.dataTransfer.effectAllowed="move";e.dataTransfer.setData("id",e.currentTarget.dataset.id);e.dataTransfer.setData("source","legend");};div.ondragenter=function(e){e.preventDefault();e.stopPropagation();};div.ondragover=function(e){e.preventDefault();e.stopPropagation();};div.ondrop=function(e){var srcId=e.dataTransfer.getData('id');var toId=e.currentTarget.dataset.id;$(_this.paneLegend).removeClass('dis');e.stopPropagation();if(srcId===''||srcId===toId)return;var source=e.dataTransfer.getData("source");if(source&&source=="legend"){if(e.currentTarget.getAttribute('ty')==_this.legendType.Regression)
generatePredictor(e,srcId,toId);else
generateRegressor(e,srcId,toId);}
function generateRegressor(e,sourceId,targetId){var data={source:[_this.getDataById(sourceId).map(function(row,i){return row+'';})],target:_this.getDataById(targetId).map(function(row,i){return row+'';}),sourceNames:sourceId,targetName:targetId};_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/generalRegressor',data).done(function(data){var id=targetId+"_Regression_"+(+new Date());var tempOption=_this.chart.getOption();var arrTemp=tempOption.series;data.SourceId=sourceId;data.TargetId=targetId;_this.dictTooltip[id]=data;arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Regression));_this.chart.setOption(tempOption);arrTemp=null;_this.spinnerRender.stop();}).error(function(result){_this.spinnerRender.stop();});}
function generatePredictor(e,sourceId,targetId){var arrCoefficient=_this.dictTooltip[e.currentTarget.dataset.id].Coefficients;for(var i=0;i<arrCoefficient.length;i++)arrCoefficient[i]=arrCoefficient[i].toString();var data={source:[_this.getDataById(sourceId).map(function(row,i){return row+'';})],Coefficients:arrCoefficient};_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/generalPredictor',data).done(function(data){var id=targetId.split('_')[0]+"_Prediction_"+(+new Date());var tempOption=_this.chart.getOption();var arrTemp=tempOption.series;if(data.PredicatedResults){arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Prediction));_this.chart.setOption(tempOption);}
_this.spinnerRender.stop();}).error(function(result){_this.spinnerRender.stop();});}}
this.paneLegend.appendChild(div);return div;};AnlzTendency.prototype.initGeneralRegressorTooltip=function(id,element){var data=this.dictTooltip[id];var arrId=[];arrId.push(data.SourceId);arrId.push(data.TargetId);var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);var srcAlias,tarAlias;for(var m=0;m<arrItem.length;m++){if(data.SourceId==arrItem[m].id){srcAlias=arrItem[m].alias;}
if(data.TargetId==arrItem[m].id){tarAlias=arrItem[m].alias;}}
var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip" style="position: fixed;">');sb.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">RSquared: ').append(data.RSquared).append('</p> ');sb.append('        <p>Formula: </p><p style="margin-left: 20px; white-space:nowrap;">').append(data.Formula).append('</p> ');sb.append('        <p style="margin-left: 20px; white-space:nowrap;">x: ').append(srcAlias).append('</p>');sb.append('        <p style="margin-left: 20px; white-space:nowrap;">y: ').append(tarAlias).append('</p>');sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={placement:'top',title:'GeneralRegressor',template:sb.toString()};$(element).tooltip(options);};AnlzTendency.prototype.initGeneralPredictorTooltip=function(id,element){var data=this.dictTooltip[id];var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip" style="position: fixed;">');sb.append('    <div class="tooltipTitle tooltip-inner">GeneralPredictor</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">Source: ').append(AppConfig.datasource.getDSItemById(id.split('_')[0]).alias).append('</p> ');sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={placement:'top',title:'GeneralPredictor',template:sb.toString()};$(element).tooltip(options);};AnlzTendency.prototype.initTendencyTips=function(parent,max,min,avg,sum){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">Statistics</div>');show.append('    <div class="tooltipContent">');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MAXIMUM).append('</span>: ').append(max).append('</p>');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MINIMUM).append('</span>: ').append(min).append('</p> ');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.AVERAGE).append('</span>: ').append(avg).append('</p> ');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.TOTAL_AMOUNT).append('</span>: ').append(sum).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'top',title:I18n.resource.observer.widgets.PARAMETER,template:show.toString()};parent.tooltip(options);};AnlzTendency.prototype.initTendencyTipsFilter=function(parent,max,min,avg,sum,condition){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">Statistics</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="filterMax" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MAXIMUM).append('</span>: ').append(max).append('</p>');show.append('        <p class="filterMin" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MINIMUM).append('</span>: ').append(min).append('</p> ');show.append('        <p class="filterAvg" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.AVERAGE).append('</span>: ').append(avg).append('</p> ');show.append('        <p class="filterSum" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.TOTAL_AMOUNT).append('</span>: ').append(sum).append('</p> ');show.append('        <p class="filterCondition" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.FILTER_FORMULA).append('</span>: ').append(condition).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'top',title:I18n.resource.observer.widgets.PARAMETER,template:show.toString()};parent.tooltip(options);};AnlzTendency.prototype.getStatisticsInfo=function(data){if(!data||data.length<=0){return{'max':0,'min':0,'avg':0,'sum':0};}
var max=0;var min=0;for(var i=0,len=data.length;i<len;i++){if(data[i]){max=data[i];min=data[i];break;}}
var avg=0;var sum=0;var flag=2;var len=data.length;var lenAct=len;if('h1'==this.timeType||'d1'==this.timeType||'M1'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
sum+=data[i];}}
else if('m5'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
if(0==i%12){sum+=data[i];}}}
else if('m1'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
if(0==i%60){sum+=data[i];}}}
else{return null;}
avg=sum/lenAct;return{'max':max,'min':min,'avg':avg.toFixed(flag),'sum':sum.toFixed(flag)};};AnlzTendency.prototype.showFilterCharts=function(series){if(!series){series=this.chart.getOption().series;}
if(this.options.arrFilter){for(var i=0,len=this.options.arrFilter.length;i<len;i++){var item=this.options.arrFilter[i];for(var j=0,len2=item.appendData.length;j<len2;j++){if(!item.appendData[j]){item.appendData[j]=undefined;}}
for(var k=0,len3=item.filterDrawObj.list[0].data.length;k<len3;k++){if(!item.filterDrawObj.list[0].data[k]){item.filterDrawObj.list[0].data[k]=undefined;}}
if(item.filterDrawObj){this.refreshChartFilter(item.filterDrawObj,item.filterCondition,series);}
if(0==item.showType){this.removeAppendCharts(item,series);}
else{this.setAppendCharts(item,series);}}}};AnlzTendency.prototype.setAppendCharts=function(itemFilter,series){var colorShow;var id=itemFilter.pointId;var idLen=id.length;var bFind=false;for(var i=0,len=series.length;i<len;i++){var tempLen=series[i].id.length;var tempEx=(tempLen>idLen)?(series[i].id.substr(idLen,tempLen-idLen)):('');if(series[i].id.substr(0,idLen)==id&&'_filter'==tempEx){bFind=true;break;}}
if(bFind){var itemAppend={id:itemFilter.pointId+'_append',name:'',type:'line',symbol:'none',data:itemFilter.appendData,smooth:false,itemStyle:{normal:{lineStyle:{width:3,type:'dotted'}}}}
series.push(itemAppend);}};AnlzTendency.prototype.removeAppendCharts=function(itemFilter,series){var id=itemFilter.pointId;var idLen=id.length;var bFind=false;for(var i=0,len=series.length;i<len;i++){var tempLen=series[i].id.length;var tempEx=(tempLen>idLen)?(series[i].id.substr(idLen,tempLen-idLen)):('');if(series[i].id.substr(0,idLen)==id&&'_append'==tempEx){bFind=true;series.splice(i,1);break;}}};AnlzTendency.prototype.switchSeries=function(id){var option=this.chart.getOption();if(!option){return;}
var arrSeries=option.series;if(!arrSeries){return;}
var cnt=0;var flag=false;for(var i=0;i<arrSeries.length;i++){if(-1!=arrSeries[i].id.indexOf('_append')){continue;}
if(arrSeries[i].data.length>0){cnt++;}
if(arrSeries[i].id==id&&arrSeries[i].data.length>0){flag=true;}}
if(cnt<=1&&flag){alert('The only parameters can\'t be removed');return;}
var spanPic=$('#lg_'+id).children('.btnShow');if(spanPic){var bIsExist=false;for(var key in this.dictShowFlag){if(id==key){bIsExist=true;break;}}
if(!bIsExist){return;}
var bIsShow=!this.dictShowFlag[id];this.dictShowFlag[id]=bIsShow;if(bIsShow){spanPic.attr('class','glyphicon glyphicon-eye-open btnShow');}
else{spanPic.attr('class','glyphicon glyphicon-eye-close btnShow');}
for(var i=0,len=arrSeries.length;i<len;i++){if(arrSeries[i].id==id){if(bIsShow){arrSeries[i].data=this.dictShowData[id];}
else{arrSeries[i].data=[];}
break;}}
var appendId='';var nIdx=id.indexOf('_filter');if(-1!=nIdx){appendId=id.substr(0,nIdx)+'_append';for(var i=0,len=arrSeries.length;i<len;i++){if(arrSeries[i].id==appendId){if(bIsShow){arrSeries[i].data=this.dictShowData[appendId];}
else{arrSeries[i].data=[];}
break;}}}}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,option.xAxis[0].data));window.setTimeout(function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,true]);},500);};AnlzTendency.prototype.setTendencyOption=function(series){if(!series){series=this.chart.getOption().series;}
var opt=this.chart.getOption();opt.series=series;this.chart.clear();this.chart.setOption(opt);};AnlzTendency.prototype.resetIcon=function(arrCloseId){if(!arrCloseId){return;}
var legend=$('.divHover').find('.divLegend');if(legend){for(var i=0,lenI=legend.length;i<lenI;i++){var bFind=false;for(var j=0,lenJ=arrCloseId.length;j<lenJ;j++){if('lg_'+arrCloseId[j]==legend[i].id){bFind=true;break;}}
if(bFind){var icon=legend.eq(i).children('.btnShow');if(icon){icon.attr('class','glyphicon glyphicon-eye-close btnShow');}}}}};AnlzTendency.prototype.resetShowData=function(data,nFlag){if(!data){return;}
var list=data.list;if(list){var nLenTime=data.timeShaft.length;if(0==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId]=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId][j]=this.fillData(list[i].data[j]);}}}
else if(1==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId+'_filter']=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId+'_filter'][j]=this.fillData(list[i].data[j]);}}}
else if(2==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId+'_append']=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId+'_append'][j]=this.fillData(list[i].data[j]);}}}}};AnlzTendency.prototype.fillData=function(data){if(!data&&0!=data){data=undefined;}
return data;};AnlzTendency.prototype.getExistDsData=function(arrSrc){var arrPoints=AppConfig.datasource.m_allPointList;if(arrPoints.length<=0){return arrSrc;}
var arrRet=[];if(!arrSrc||arrSrc.length<=0||!arrPoints||arrPoints.length<=0){return arrRet;}
for(var i=0,len=arrSrc.length;i<len;i++){for(var j=0,len2=arrPoints.length;j<len2;j++){if(arrSrc[i]==arrPoints[j].itemId){arrRet.push(arrSrc[i]);break;}}}
return arrRet;};return AnlzTendency;})();﻿var AnlzStack=(function(){var _this;function AnlzStack(container,option,screen){AnlzBase.call(this,container,option,screen);this.screen=screen;_this=this;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzStack.prototype=new AnlzBase();AnlzStack.prototype.optionTemplate={imgName:'anlsStack.png',imgIndex:4,imgColor:'148,193,142',templateName:'analysis.modalType.STACK',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzStack.prototype.show=function(){this.initTools();this.container.innerHTML='';var temp;this.paneChart=document.createElement('div');temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='100%';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
this.container.appendChild(this.paneChart);this.spinnerRender.spin(this.container.parentElement);this.init();if(!this.options.noteList){this.options.noteList=[];}else{_this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});};AnlzStack.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzStack.prototype.init=function(){var _this=this;AppConfig.datasource.getDSItemData(this,this.options.itemDS[0].arrId);};AnlzStack.prototype.render=function(data){this.initChart(data);var _this=this;};AnlzStack.prototype.initChart=function(data){var arrSeries=[];var arrLengend=[];this.options.xAxisData=data.timeShaft;for(var i=0;i<data.list.length;i++){var item=data.list[i];arrSeries.push(this.createSeries(item.dsItemId,item.data));arrLengend.push(arrSeries[i].name);this.options.dataList[arrSeries[i].name]=item.data;}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,arrLengend,data.timeShaft));};AnlzStack.prototype.initOption=function(series,arrLengend,timeSHaft){var i18nEcharts=I18n.resource.echarts;return{tooltip:{trigger:'axis'},legend:{data:arrLengend},grid:{x:60,x2:20,y:60,borderColor:'#eee'},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar','stack','tiled'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR,stack:i18nEcharts.STACK,tiled:i18nEcharts.TILED}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:true,dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,data:timeSHaft}],yAxis:[{type:'value',scale:true}],series:series,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};};AnlzStack.prototype.createSeries=function(id,data,type){return{id:id,name:AppConfig.datasource.getDSItemById(id).alias,type:'line',smooth:true,itemStyle:{normal:{areaStyle:{type:'default'}}},symbol:'none',stack:I18n.resource.observer.analysis.TOTAL_AMOUNT,data:data}};return AnlzStack;})();﻿var AnlzCluster=(function(){function AnlzCluster(container,option,screen){AnlzBase.call(this,container,option,screen);this.m_panelTrend=undefined;this.m_panelScatter=undefined;}
AnlzCluster.prototype=new AnlzBase();AnlzCluster.prototype.optionTemplate={imgName:'anlsPattern.png',imgIndex:6,imgColor:'65,131,189',templateName:'analysis.modalType.CLUSTER',templateParams:{paraName:['X'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:''};AnlzCluster.prototype.show=function(){var _this=this;this.initTools();this.container.innerHTML='';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});$(this.container).append($('<div style="width: 100%; height: 450px;">\
                <ul class="nav nav-tabs" role="tablist" id="myTab">\
                    <li role="presentation" class="active">\
                        <a id="aTendency" href="#tabTendency" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TREND_DISTRIBUTE"></span></a>\
                    </li>\
                    <li role="presentation">\
                        <a id="aScatter" href="#tabScatter" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TYPE_POINT"></span></a>\
                    </li>\
                </ul>\
                <div class="tab-content">\
                    <div role="tabpanel" class="tab-pane fade in active" id="tabTendency" style="height: 400px;"></div>\
                    <div role="tabpanel" class="tab-pane fade" id="tabScatter" style="height: 400px;"></div>\
                </div>\
             </div>\
             <div class="panel panel-default" style="position: absolute; height: calc(100% - 450px); top: 450px; left: 0; right: 0;">\
                 <div class="panel-heading"><span i18n="analysis.paneConfig.TYPICAL_CONDITION"></span></div>\
                 <div class="panel-body" style="padding: 0; height: calc(100% - 40px); overflow-y: auto;">\
                     <table class="table" id="tableGroup" style="overflow-x: auto;"></table>\
                 </div>\
             </div>'));I18n.fillArea($(this.container));_this.spinnerRender.spin(this.container.parentElement);this.init();}
AnlzCluster.prototype.close=function(){this.spinnerRender.stop();this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();}
AnlzCluster.prototype.init=function(){var _this=this;var arrIds=[];var arrType=[];var arrDSItems=this.options.itemDS;for(var i=0;i<arrDSItems.length;i++){var arrTemp=arrDSItems[i].arrId;if(arrTemp&&arrTemp.length>0){arrIds=arrIds.concat(arrTemp);arrType.push(this.optionTemplate.templateParams.paraName[i]);}}
var postData={dsItemIds:arrIds,timeStart:new Date(this.options.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(this.options.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.options.format,pointType:arrType,systemType:this.optionTemplate.type};WebAPI.post('/analysis/startWorkspaceDataGenCluster',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});},AnlzCluster.prototype.render=function(data){var _this=this;this.initTable(data);this.initTendency(data);$('#aScatter').on('shown.bs.tab',function(e){if($("#tabScatter div").length==0){_this.initScatter(data);}});_this.spinnerStop();$('#btnDownLoadExcel').hide();};AnlzCluster.prototype.initTable=function(data){var table=$("#tableGroup");table.html("");$('#btnDownLoadExcel').hide();var tbody=document.createElement("tbody");var tr,td,divLegend,details;if(!data.dataAnalysisResult.Pattern)return;for(var i=0;i<data.dataAnalysisResult.Pattern.length;i++){details=data.dataAnalysisResult.Pattern[i].Diagnosis;tr=document.createElement("tr");td=document.createElement("td");td.rowSpan=details?details.length:1;divLegend=document.createElement("span");divLegend.textContent="Group "+data.dataAnalysisResult.Pattern[i].name;divLegend.className='label label-warning';divLegend.style.padding='3px';divLegend.style.backgroundColor=echarts.config.color[i];td.appendChild(divLegend);tr.appendChild(td);td=document.createElement('td');if(details)td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[0].name+'</span>'+details[0].detail;tr.appendChild(td);tbody.appendChild(tr);if(details&&details.length>1){for(var j=1;j<details.length;j++){tr=document.createElement("tr");td=document.createElement("td");td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[j].name+'</span>'+details[j].detail;tr.appendChild(td);tbody.appendChild(tr);}}}
$("#tableGroup").append(tbody);};AnlzCluster.prototype.initTendency=function(data){var arrSeries=new Array();var arrLegend=new Array();for(var i=0;i<data.dataAnalysisResult.Pattern.length;i++){var item=data.dataAnalysisResult.Pattern[i]
arrLegend.push(item.name);arrSeries.push({name:item.name,type:'line',stack:'总量',itemStyle:{normal:{areaStyle:{type:'default'}}},data:item.TrendValue});}
var i18nEcharts=I18n.resource.echarts;var option={tooltip:{trigger:'axis'},legend:{data:arrLegend},toolbox:{show:true,feature:{magicType:{show:true,type:['line','bar','stack','tiled'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR,stack:i18nEcharts.STACK,tiled:i18nEcharts.TILED}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,xAxis:[{type:'category',boundaryGap:false,data:data.dataAnalysisResult.Pattern[0].TrendLabel}],yAxis:[{min:0,max:100,type:'value'}],series:arrSeries,animationDuration:this.chartAnimationDuration};this.m_panelTrend=echarts.init(document.getElementById("tabTendency"),AppConfig.chartTheme);this.m_panelTrend.setOption(option);this.chart=this.m_panelTrend;};AnlzCluster.prototype.initScatter=function(data){var series=new Array();var seriesNames=new Array();for(var i=0,item,name,arrData,len=data.dataAnalysisResult.ScatterChart.length;i<len;i++){item=data.dataAnalysisResult.ScatterChart[i];name=item.name[0];arrData=new Array();for(var j=0,itemPoint;j<item.data.length;j++){itemPoint=item.data[j];arrData.push(itemPoint.split(','));}
seriesNames.push(name);series.push({name:name,type:'scatter',symbolSize:5,data:arrData});}
var i18nEcharts=I18n.resource.echarts;var option={title:{},tooltip:{trigger:'item',formatter:function(params){return params.seriesName+'<br/>'
+params.value[0]+', '+params.value[1];}},toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},legend:{data:seriesNames},xAxis:[{type:'value',scale:true}],yAxis:[{type:'value',scale:true}],animation:true,series:series,animationDuration:this.chartAnimationDuration};var myChart=echarts.init(document.getElementById("tabScatter"),AppConfig.chartTheme);myChart.setOption(option);};return AnlzCluster;})();var AnlzCluster_AHU=(function(){function AnlzCluster_AHU(container,option,screen){AnlzCluster.call(this,container,option,screen);}
AnlzCluster_AHU.prototype=new AnlzCluster();AnlzCluster_AHU.prototype.optionTemplate={imgName:'anlsClusterAhu.png',imgIndex:7,imgColor:'148,193,142',templateName:'analysis.modalType.CLUSTER_AHU',templateParams:{paraName:['MATemp','SATemp','RACO2','OATemp','RATemp','RATempSetting','SATempSetting','RACO2Setting','HWTemp','CWTemp','OperationMode','OADamperRatio','HCDamperRatio','CCDamperRatio','SAStaticPressure','SAStaticPressureSetting','FanVSDFrequency','CWRetrunTemp'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:'AHU'};return AnlzCluster_AHU;})();var AnlzCluster_Chiller=(function(){function AnlzCluster_Chiller(container,option,screen){AnlzCluster.call(this,container,option,screen);}
AnlzCluster_Chiller.prototype=new AnlzCluster();AnlzCluster_Chiller.prototype.optionTemplate={imgName:'anlsClusterChiller.png',imgIndex:8,imgColor:'211,97,78',templateName:'analysis.modalType.CLUSTER_CHILLER',templateParams:{paraName:['OADryTemp','OAWetBulbTemp','AmperRatio','ChwSupplyTemp','ChwReturnTemp','CwReturnTemp','CwSupplyTemp','EvpTemp','CondTemp'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:'Chiller'};return AnlzCluster_Chiller;})();﻿var AnlzEnergy=(function(){function AnlzEnergy(container,option,screen){AnlzBase.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzEnergy.prototype=new AnlzBase();AnlzEnergy.prototype.optionTemplate={imgName:'anlsEnergy.png',imgIndex:9,imgColor:'65,131,189',templateName:'analysis.modalType.ENERGY',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzEnergy.prototype.init=function(){AppConfig.datasource.getDSItemData(this,this.options.itemDS[0].arrId);};AnlzEnergy.prototype.getDefaultOption=function(){var i18nEcharts=I18n.resource.echarts;return{tooltip:{trigger:'axis'},toolbox:{show:true,feature:{dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:false,dataZoom:{show:false},grid:{"x":70,"x2":10,"y2":24},xAxis:[{type:'category',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}]};}
AnlzEnergy.prototype.render=function(dataSrc){var _this=this;if(undefined==dataSrc||dataSrc.length<=0||undefined==dataSrc.timeShaft||dataSrc.timeShaft.length<=0){_this.screen.saveModalJudge.rejectWith(_this.screen,[_this.screen]);alert('No data')
return;}
var xAxis;var arrXAxis=[];var len=dataSrc.timeShaft.length;for(var i=0;i<len;i++){arrXAxis.push(dataSrc.timeShaft[i]);}
xAxis=[{type:'category',data:arrXAxis}]
this.options.xAxisData=arrXAxis;var dataName=[];var arrSeries=[];var showColor;len=dataSrc.list.length;var arrId=[];var arrItem=[];for(var i=0;i<len;i++){arrId.push(dataSrc.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<len;i++){showColor=echarts.config.color[i];for(var m=0;m<arrItem.length;m++){if(dataSrc.list[i].dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;dataName.push(itemName);var arrData=[];var len2=dataSrc.list[i].data.length;var defVal;for(var j=1;j<len2;j++){defVal=dataSrc.list[i].data[j]-dataSrc.list[i].data[j-1];arrData.push(parseFloat(defVal.toFixed(1)));}
this.options.dataList[itemName]=arrData;arrSeries.push({name:dataName[i],type:'bar',data:arrData,markPoint:{data:[{type:'max',name:'最大值'},{type:'min',name:'最小值'}]},itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,5,5]},emphasis:{color:showColor,barBorderRadius:[5,5,5,5]}}});break;}}}
dataOption={title:{text:'',subtext:''},legend:{data:dataName},dataZoom:{show:false},grid:{"x":70,"x2":10,"y2":24},xAxis:xAxis,series:arrSeries};_this.chart=echarts.init(_this.paneChart,AppConfig.chartTheme);_this.chart.setOption($.extend(true,{},_this.getDefaultOption(),dataOption));}
return AnlzEnergy;})();var DataSource=(function(){var _this;function DataSource(parent,opt){_this=this;this.m_parent=parent;this.m_newPointList=[];this.m_allPointList=[];this.m_allGroupList=[];this.m_arrProjIdColorMap={};this.m_dataSourceId;this.m_lang=I18n.resource.dataSource;this.m_selectItemId=0;this.m_selectGroupId=0;this.m_groupIconOpen='/static/images/dataSource/group_head_sel.png';this.m_groupIconClose='/static/images/dataSource/group_head_normal.png';this.m_cfgPanel;this.m_unassigned='unassigned';this.m_langFlag=('zh'==localStorage['language'])?0:1;this.$dsNavContain=undefined;this.m_curPageNum=1;this.m_arrCloudTableInfo=[];this.disableIot=opt&&opt.disableIot?true:false;this.treeObj=undefined;this.iotFilter=undefined;this.iotOpt={};}
DataSource.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);I18n.fillArea($('#divAnlsDatasourcePane'));I18n.fillArea($('#divEnergyAnlsPane'));_this.loadDataSourceRecord();_this.initContain();_this.initElement();Spinner.stop();},close:function(){this.m_newPointList=null;this.m_allPointList=null;},initContain:function(){this.initTreeNavStyle();},initTreeNavStyle:function(){WebAPI.get('/static/views/observer/dataSource.html').done(function(resultHtml){_this.$dsNavContain=$(resultHtml);I18n.fillArea(_this.$dsNavContain);var $pageMine=_this.$dsNavContain.find('#pageMine');var $pageCloud=_this.$dsNavContain.find('#pageCloud');var $pageIot=_this.$dsNavContain.find('#pageIot');AppConfig.isFactory&&_this.$dsNavContain.find('#liMine').css('display','none').attr('class','');_this.$dsNavContain.find('#liMine').click(function(e){$('#liMine').attr('class','active');$('#liCloud').attr('class','');$('#liIot').attr('class','');$pageMine.show();$pageCloud.hide();$pageIot.hide();_this.currentObj='mine';});_this.$dsNavContain.find('#liCloud').click(function(e){if(_this.m_arrCloudTableInfo.length<=0){_this.initDsCloud();}
$('#liMine').attr('class','');$('#liCloud').attr('class','active');$('#liIot').attr('class','');$pageMine.hide();$pageIot.hide();$pageCloud.show();_this.currentObj='cloud';});if(_this.disableIot){_this.$dsNavContain.find('#liIot').remove();}else{_this.$dsNavContain.find('#liIot').click(function(e){$('#liMine').attr('class','');$('#liCloud').attr('class','');$('#liIot').attr('class','active');$pageMine.hide();$pageIot.html('').show();$pageCloud.hide();_this.initIotFilter();_this.currentObj='iot';});_this.initIotFilter();}
_this.initDsMine();AppConfig.isFactory&&_this.initDsCloud();$('#dataSrcContain').empty();$('#dataSrcContain').append(_this.$dsNavContain);AppConfig.isFactory&&$('#liCloud').click();var addGroup=$('<div id="dataSrcAddGroup"><input type="text" id="inputAddGroup" placeholder="+ Add group" ></div>');$pageMine.append(addGroup);$('#inputAddGroup').attr('placeholder',I18n.resource.dataSource.ADD_GROUP);$pageMine.keyup(function(e){if(13==e.keyCode){_this.addNewGroup();}});var inputAdd=addGroup.find('#inputAddGroup');inputAdd.attr('placeholder',_this.m_lang.ADD_GROUP);inputAdd.blur(function(e){_this.addNewGroup();});}).always(function(e){});},initIotFilter:function(){var $ctn=_this.$dsNavContain.find('#pageIot');_this.iotFilter=new HierFilter($ctn);_this.iotFilter.init();_this.iotOpt=$.extend(true,{},{base:{divideByProject:true},tree:{show:true,event:{click:[{act:onNodeClick,tar:['groups','projects']},{act:ontThingClick,tar:'things'},{act:function(){console.log('click things')},tar:'things'}],},drag:{dragstart:[{act:onAttrDragStart,tar:'attrs'},{act:onThingsDragStart,tar:'things'}],dragend:[{act:onAttrDragEnd,tar:'attrs'},]}}},_this.iotOpt);_this.iotFilter.setOption(_this.iotOpt);function onNodeClick(event,treeId,treeNode){if(_this.iotFilter.setDefault===true){if(!treeNode.children||treeNode.children.length==0)return;var node=treeNode.children[0];_this.iotFilter.tree.selectNode(node);_this.iotFilter.tree.setting.callback.onClick({target:document.getElementById(node.tId)},node['_id'],node);_this.iotFilter.setDefault=false}}
function ontThingClick(event,treeId,treeNode){var attrs=_this.iotFilter.dictClass['things'][treeNode.type].attrs;var arrNode=[];var node;for(var pt in treeNode.arrP){if(!attrs[pt])continue;node={'_id':treeNode.arrP[pt],'name':attrs[pt].name,'attrType':pt,'baseType':'attrs'};arrNode.push(node)}
if(!treeNode.children||treeNode.children.length==0){_this.iotFilter.tree.addNodes(treeNode,arrNode,true);}}
function onThingsDragStart(event,treeNode){EventAdapter.setData({'dsItemId':treeNode['_id'],'dsNode':treeNode});$('.templatePara').css('display','block');}
function onAttrDragStart(event,treeNode){EventAdapter.setData({'dsItemId':treeNode['_id'],'dsNode':treeNode});$('.templatePara').css('display','block');}
function onAttrDragEnd(){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');}
function onNodeDblClick(event,treeId,treeNode,widget){}},initDsMine:function(){var $inputSearch=_this.$dsNavContain.find('#inputDsMineSearch');$inputSearch.keyup(function(e){var searchVal=$(this).val().trim();if(13==e.keyCode&&searchVal){WebAPI.get('/analysis/datasource/searchDsItemInfo/'+AppConfig.userId+'/'+searchVal).done(function(result){var treeMine=_this.$dsNavContain.find('#treeMine');var zSetting={async:{enable:false},view:{addDiyDom:addDiyDom,addHoverDom:addHoverDom,removeHoverDom:removeHoverDom,selectedMulti:false,nameIsHTML:true},edit:{enable:true,drag:{isCopy:false,isMove:false}},data:{simpleData:{enable:true}},callback:{beforeRename:zTreeBeforeRename,beforeRemove:zTreeBeforeRemove}};function addDiyDom(treeId,treeNode){var $itemLeaf=$('#'+treeNode.tId);$itemLeaf.attr('ptid',treeNode.id);$itemLeaf.attr('draggable',true);EventAdapter.on($itemLeaf,'dragstart',function(e){$('.templatePara').css('display','block');var tar=$(e.target);var dragSrcId=tar.attr('ptid');EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($itemLeaf,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemLeaf,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});if(!treeNode.isParent){if(0==treeNode.type){var prjName=_this.getProjectNameFromId(treeNode.projId,_this.m_langFlag);_this.initToolTips($itemLeaf,treeNode.name,prjName,treeNode.value,treeNode.note);}
else if(1==treeNode.type){var showName=_this.getShowNameFromFormula(treeNode.value);_this.initFormulaToolTips($itemLeaf,treeNode.name,showName,treeNode.note);}}}
function addHoverDom(treeId,treeNode){if(!treeNode.isParent){_this.setHoverColor(treeNode);}}
function removeHoverDom(treeId,treeNode){if(!treeNode.isParent){_this.removeHoverColor(treeNode);}}
function zTreeBeforeRename(treeId,treeNode,newName,isCancel){_this.zTreeBeforeRenameFunc(treeNode,newName);}
function zTreeBeforeRemove(treeId,treeNode){_this.zTreeBeforeRemoveFunc(treeNode);}
var zNodes=_this.generateSearchTree(result,searchVal);_this.treeObj=$.fn.zTree.init(treeMine,zSetting,zNodes);$('#dataSrcAddGroup').hide();});}
if(!searchVal){_this.initDsMineTree();$('#dataSrcAddGroup').show();}});_this.$dsNavContain.find('#spanDsMineSearch').click(function(e){$inputSearch.val('');_this.initDsMineTree();$('#dataSrcAddGroup').show();});_this.initDsMineTree();$('#dataSrcAddGroup').show();},initDsMineTree:function(){var zSetting={async:{enable:true,type:'get',url:function(treeId,treeNode){return'/analysis/datasource/getDsItemInfo/'+AppConfig.userId+'/'+(typeof treeNode==='undefined'?'null':treeNode.id);},dataFilter:dsItemfilter},view:{addDiyDom:addDiyDom,addHoverDom:addHoverDom,removeHoverDom:removeHoverDom,selectedMulti:false},edit:{enable:true,renameTitle:I18n.resource.dataSource.RENAME,removeTitle:I18n.resource.dataSource.REMOVE,drag:{isCopy:false,isMove:false}},data:{keep:{leaf:true,parent:true},simpleData:{enable:true}},callback:{beforeRename:zTreeBeforeRename,beforeRemove:zTreeBeforeRemove,onAsyncSuccess:zTreeOnAsyncSuccess,onAsyncError:zTreeOnAsyncError,beforeEditName:zTreeBeforEditName}};function zTreeBeforEditName(treeId,treeNode){if(treeNode.note&&treeNode.note!==''&&treeNode.name.indexOf(treeNode.note)>=0){treeNode.name=treeNode.name.split('(')[1].split(')')[0];}}
function dsItemfilter(treeId,parentNode,responseData){Spinner.spin(_this.$dsNavContain[2]);return _this.generateTreeEx(responseData);}
function addDiyDom(treeId,treeNode){if(treeNode.num){var aObj=_this.$dsNavContain.find("#"+treeNode.tId+"_switch");var $badge=$('<span class="badge treeBadge">'+treeNode.num+'</span>');aObj.next('a').after($badge);}
var $itemLeaf=_this.$dsNavContain.find('#'+treeNode.tId);$itemLeaf.attr('ptid',treeNode.id);$itemLeaf.attr('draggable',true);EventAdapter.on($itemLeaf,'dragstart',function(e){$('.templatePara').css('display','block');var tar=$(e.target);var dragSrcId=tar.attr('ptid');EventAdapter.setData({'dsItemId':dragSrcId});_this.stopBubble(e);});EventAdapter.on($itemLeaf,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemLeaf,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});EventAdapter.on($itemLeaf,'drop',function(e){var tar=$(e.target);var dstTLi=tar.closest('li');var dstId=dstTLi.eq(0).attr('id');var dstNode=_this.treeObj.getNodeByTId(dstId);var srcId=EventAdapter.getData().dsItemId;var srcJq=$('li[ptid$='+srcId+']');var srcTId=srcJq.eq(0).attr('id');var srcNode=_this.treeObj.getNodeByTId(srcTId);var dstParentId=dstNode.pId;var dstParentJq=$('li[ptid$='+dstParentId+']');var dstParentTId=dstParentJq.eq(0).attr('id');var dstParentNode=_this.treeObj.getNodeByTId(dstParentTId);var srcParentId=srcNode.pId;var srcParentJq=$('li[ptid$='+srcParentId+']');var srcParentTId=srcParentJq.eq(0).attr('id');var srcParentNode=_this.treeObj.getNodeByTId(srcParentTId);var postData={};var arrSrc=[];var arrDst=[];var srcParId=srcNode.pId;var dstParId=dstNode.pId;var saveType=0;if(srcNode.isParent&&!dstNode.isParent){return;}
else if(!srcNode.isParent&&!dstNode.isParent){if(_this.treeObj.moveNode(dstNode,srcNode,'next',true)){if(srcParId==dstParId){$.each((dstParentNode.children),function(i,n){arrDst.push(n.id);});postData[dstParentId]=arrDst;}
else{$.each((srcParentNode.children),function(i,n){arrSrc.push(n.id);});$.each((dstParentNode.children),function(i,n){arrDst.push(n.id);});var nSrcIdx=srcParentNode.getIndex();var nDstIdx=dstParentNode.getIndex();if(nDstIdx<nSrcIdx){postData[dstParId]=arrDst;postData[srcParId]=arrSrc;}
else{postData[srcParId]=arrSrc;postData[dstParId]=arrDst;}}}}
else if(!srcNode.isParent&&dstNode.isParent){if(_this.treeObj.moveNode(dstNode,srcNode,'inner',true)){if(srcParentNode.children){$.each((srcParentNode.children),function(i,n){arrSrc.push(n.id);});}
$.each((dstNode.children),function(i,n){arrDst.push(n.id);});var nSrcIdx=srcParentNode.getIndex();var nDstIdx=dstNode.getIndex();if(nDstIdx<nSrcIdx){postData[dstNode.id]=arrDst;postData[srcParId]=arrSrc;}
else{postData[srcParId]=arrSrc;postData[dstNode.id]=arrDst;}}}
else if(srcNode.isParent&&dstNode.isParent){saveType=1;var nSrcIdx=srcNode.getIndex();var nDstIdx=dstNode.getIndex();if(_this.treeObj.moveNode(dstNode,srcNode,'next',true)){var liGroup=$('#treeMine').children('li');if(liGroup&&liGroup.length>0){postData.groupIdList=[];$.each(liGroup,function(i,n){postData.groupIdList.push($(n).attr('ptid'));});}}}
if(0==saveType){WebAPI.post('/analysis/datasource/saveLayout/'+AppConfig.userId,postData).done(function(data){if(data.success){}}).always(function(){});}
else if(1==saveType){WebAPI.post('/datasource/saveDataSourceGroupLayout/'+AppConfig.userId,postData).done(function(data){if('successful'==data.error){}}).always(function(){});}
_this.stopBubble(e);});if(treeNode.id==sessionStorage.getItem('dsOpenGroupId')){sessionStorage.removeItem('dsOpenGroupId');if(treeNode.isParent&&_this.treeObj){_this.treeObj.expandNode(treeNode,true,false,true);}}
if(!treeNode.isParent){if(0==treeNode.type){var prjName=_this.getProjectNameFromId(treeNode.projId,_this.m_langFlag);_this.initToolTips($itemLeaf,treeNode.name,prjName,treeNode.value,treeNode.note);}
else if(1==treeNode.type){var showName=_this.getShowNameFromFormula(treeNode.value);_this.initFormulaToolTips($itemLeaf,treeNode.name,showName,treeNode.note);}}}
function addHoverDom(treeId,treeNode){if(treeNode.isParent){var sObj=$("#"+treeNode.tId+"_span");if(treeNode.editNameFlag||$("#addBtn_"+treeNode.tId).length>0){return;}
if(0==$("#addBtnFormula_"+treeNode.tId).length){var addStr="<span class='iconfont' id='addBtnFormula_"+treeNode.tId+"' title='add group' onfocus='this.blur();' style='margin-left:4px'>&#xe63e;</span>";sObj.after(addStr);var btnGroup=$("#addBtnFormula_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_FORMULA);if(btnGroup)btnGroup.bind("click",function(){if(_this.m_cfgPanel){$(_this.m_cfgPanel.container).remove();}
var addInterface=$('#addPointPanelContain');if(!addInterface||addInterface.length>0){return;}
_this.m_selectGroupId=treeNode.id;WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).always(function(e){});return false;});}
if(0==$("#addBtnPage_"+treeNode.tId).length){var addStr="<span class='glyphicon glyphicon-plus-sign button' id='addBtnPage_"+treeNode.tId+"' title='add point' onfocus='this.blur();' style='margin-left:4px;top:2px'></span>";sObj.after(addStr);var btnGroup=$("#addBtnPage_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_POINT);if(btnGroup)btnGroup.bind("click",function(){var parentNodes=_this.treeObj.getNodesByParam('id',treeNode.id,null);if(parentNodes.length>0){if(!parentNodes[0].zAsync){_this.treeObj.expandNode(parentNodes[0],true,false,true);}}
if(_this.m_cfgPanel){$(_this.m_cfgPanel.container).remove();}
var addInterface=$('#addPointPanelContain');if(!addInterface||addInterface.length>0){return;}
_this.m_selectGroupId=treeNode.id;WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).always(function(e){});return false;});}
if(0==$("#addBtnGroup_"+treeNode.tId).length){var addStr="<span class='glyphicon glyphicon-object-align-bottom button' aria-hidden='true' id='addBtnGroup_"+treeNode.tId+"' title='add group' onfocus='this.blur();' style='margin-left:20px;top:2px'></span>";sObj.after(addStr);var btnGroup=$("#addBtnGroup_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_POINT_GROUP);if(btnGroup)btnGroup.bind("click",function(){var newName='new group';var postData={'groupId':'','name':newName,'parent':(treeNode.id).toString(),'userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){if('successful'!=result.error){return;}
var groupId=result.groupId;if(groupId){if(_this.treeObj){if(treeNode.zAsync){_this.treeObj.addNodes(treeNode,{id:result.groupId,pId:result.parentId,name:result.groupName,isParent:true});}
else{_this.treeObj.expandNode(treeNode,true,false,true);}}}}).always(function(e){});return false;});}}
else{_this.setHoverColor(treeNode);}};function removeHoverDom(treeId,treeNode){$("#addBtnGroup_"+treeNode.tId).unbind().remove();$("#addBtnPage_"+treeNode.tId).unbind().remove();$("#addBtnFormula_"+treeNode.tId).unbind().remove();if(!treeNode.isParent){_this.removeHoverColor(treeNode);}};function zTreeBeforeRename(treeId,treeNode,newName,isCancel){_this.zTreeBeforeRenameFunc(treeNode,newName);}
function zTreeBeforeRemove(treeId,treeNode){confirm(I18n.resource.dataSource.DELETE_GROUP_INFO,function(){_this.zTreeBeforeRemoveFunc(treeNode);_this.treeObj.removeNode(treeNode);});return false;}
function zTreeOnAsyncSuccess(event,treeId,treeNode,msg){Spinner.stop();};function zTreeOnAsyncError(event,treeId,treeNode,XMLHttpRequest,textStatus,errorThrown){Spinner.stop();};$(document).ready(function(){var treeMine=_this.$dsNavContain.find('#treeMine');var arrInit=_this.generateTreeEx(_this.m_parent.store.group);_this.treeObj=$.fn.zTree.init(treeMine,zSetting,arrInit);});},zTreeBeforeRenameFunc:function(treeNode,newName){if(treeNode.isParent){var postData={'groupId':treeNode.id,'name':newName,'parent':Boolean(treeNode.pId)?(treeNode.pId).toString():'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){if('successful'!=result.error){return false;}}).always(function(e){return true;});}
else{var treeNodeNote=treeNode.note?treeNode.note:'';newName=(treeNodeNote!=='')?(treeNodeNote+'('+newName+')'):newName;var postData={itemList:[{id:treeNode.id,type:0,projId:treeNode.projId,alias:newName,note:treeNode.note,value:treeNode.value,groupId:treeNode.pId}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.itemIdList.length>0){return true;}
return false;}).error(function(e){return false;}).always(function(e){treeNode.name=newName;$('#treeMine').find('li[ptid='+treeNode.id+']').find('a span').eq(1).text(newName);});}},zTreeBeforeRemoveFunc:function(treeNode){if(treeNode.isParent){WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+treeNode.id).done(function(result){if(('successful'!=result.error)){return false}}).always(function(e){return true;});}
else{var $itemLeaf=_this.$dsNavContain.find('#'+treeNode.tId);if($itemLeaf&&$itemLeaf.length>0){$itemLeaf.tooltip('destroy');}
WebAPI.get('/analysis/datasource/removeSingle/'+treeNode.id).done(function(data){if(!data.success){return false;}
else{var parentId=treeNode.pId;var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num-=1;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge')
if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}
break;}}
return true;}}).always(function(){});}},generateTreeEx:function(arr){var result=[];if(!arr){return result;}
var params;var unassigned;for(var i=0,len=arr.length;i<len;i++){var item=arr[i];if(item){var itemNode=item.note?item.note:'';var itemAlias=item.alias?item.alias:'';var itemName=itemAlias;if(itemNode!==''&&itemAlias!==''){if(itemAlias.indexOf(itemNode)<0){itemName=itemNode+' ('+itemAlias+')'}}
params={id:item.id,pId:item.parentId,isParent:item.isParent,name:itemName,value:item.value,note:item.note,projId:item.projId,num:item.num,type:item.type}
if(!item.isParent){var leafIcon=(1==item.type)?'ptFormula':'ptNormal';params['iconSkin']=leafIcon;}
if('unassigned'==item.alias){unassigned=params;}
else{result.push(params);}}}
if(unassigned){result.push(unassigned);}
return result;},generateSearchTree:function(arr,searchText){var result=[];var params;for(var id in arr){params={id:id,pId:null,isParent:true,name:arr[id].groupName,value:id,note:'',projId:'',type:0,open:true};result.push(params);if(arr[id].dsList){for(var i=0,len=arr[id].dsList.length;i<len;i++){var item=arr[id].dsList[i];var keyWordName=item.alias;searchText.replace(/[^\w\d\s\u4e00-\u9fa5]/g,' ').split(/\s/g).forEach(function(search_item){if(search_item){keyWordName=keyWordName.replace(new RegExp("("+search_item+")(?![^<]*>|[^<>]*</)","gi"),'<span class="keyword">$1</span>');}});params={id:item.id,pId:id,isParent:false,name:keyWordName,value:item.value,note:item.note,projId:item.projId,type:item.type,iconSkin:(1==item.type)?'ptFormula':'ptNormal'};result.push(params);}}}
return result;},setHoverColor:function(treeNode){var $row=$('#'+treeNode.tId);if($row&&$row.length>0){$row.css('background-color','#FFE6B0');var $name=$('#'+treeNode.tId+'_span');if($name&&$name.length>0){$name.css('color','#000');}
$row.find('.edit').css('color','#000');$row.find('.remove').css('color','#000');}},removeHoverColor:function(treeNode){var $row=$('#'+treeNode.tId);if($row&&$row.length>0){$row.css('background-color','');var $name=$('#'+treeNode.tId+'_span');if($name&&$name.length>0){$name.css('color','');}
$row.find('.edit').css('color','');$row.find('.remove').css('color','');}},initDsCloud:function(){var $selPrjName=_this.$dsNavContain.find('#selectPrjName');$selPrjName.empty();var opt;var prjId=AppConfig.project&&AppConfig.project.bindId?AppConfig.project.bindId:AppConfig.projectId;var nSize=AppConfig.projectList.length;for(var i=0;i<nSize;i++){var project=AppConfig.projectList[i];opt=document.createElement('option');if(0==_this.m_langFlag){opt.textContent=project.name_cn;}
else{opt.textContent=project.name_english;}
opt.value=project.id;$selPrjName.append(opt);}
$selPrjName.val(prjId);$selPrjName.change(function(e){var prjId=$('#selectPrjName').find('option:selected').val();_this.initDsCloudTable(prjId,1,50);});var $inputSearch=_this.$dsNavContain.find('#inputDsCloudSearch');$inputSearch.keyup(function(e){var searchVal=$(e.currentTarget).val();if(13==e.keyCode){var prjId=_this.$dsNavContain.find('#selectPrjName').val();if(!prjId){return false;}
var size=50;WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:1,pageSize:size,searchText:searchVal}).done(function(result){if(result.success&&result.data){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');$tableBody.empty();_this.setCloudTable(result.data.pointTable);var ptTotal=result.data.pointTotal;var allPageNum=Math.ceil(ptTotal/size);_this.setCloudNav(allPageNum);}}).always(function(e){});}
if(''==searchVal){_this.initDsCloudFunc();}});_this.$dsNavContain.find('#spanDsCloudSearch').click(function(e){$inputSearch.val('');_this.initDsCloudFunc();});_this.initDsCloudTable(prjId,1,50);},initDsCloudTable:function(prjId,page,size){if(!prjId){return false;}
Spinner.spin(_this.$dsNavContain[2]);WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:page,pageSize:size}).done(function(result){if(result.success&&result.data){_this.m_arrCloudTableInfo=result.data.pointTable;_this.setCloudTable(_this.m_arrCloudTableInfo);var ptTotal=result.data.pointTotal;var allPageNum=Math.ceil(ptTotal/size);_this.setCloudNav(allPageNum);}}).always(function(e){Spinner.stop();});},initDsCloudFunc:function(){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');$tableBody.empty();var prjId=_this.$dsNavContain.find('#selectPrjName').val();_this.initDsCloudTable(prjId,1,50);},setCurrentPage:function(curPageNum,size){curPageNum=parseInt(curPageNum,10);var prjId=_this.$dsNavContain.find('#selectPrjName').val();if(!prjId){return false;}
Spinner.spin(_this.$dsNavContain[2]);WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:curPageNum,pageSize:size,searchText:_this.$dsNavContain.find('#inputDsCloudSearch').val()}).done(function(result){if(result.success&&result.data){var ptTotal=result.data.pointTotal?result.data.pointTotal:0;var allPageNum=Math.ceil(ptTotal/size);_this.m_curPageNum=curPageNum;var liPageNum=$('#navPageNum').find('.pageNum');if(curPageNum<=3){liPageNum.eq(0).attr('value','1');liPageNum.eq(1).attr('value','2');liPageNum.eq(2).attr('value','3');liPageNum.eq(3).attr('value','4');liPageNum.eq(4).attr('value','5');liPageNum.eq(0).text('1');liPageNum.eq(1).text('2');liPageNum.eq(2).text('3');liPageNum.eq(3).text('4');liPageNum.eq(4).text('5');}
else if(curPageNum>=allPageNum-2){liPageNum.eq(0).attr('value',allPageNum-4);liPageNum.eq(1).attr('value',allPageNum-3);liPageNum.eq(2).attr('value',allPageNum-2);liPageNum.eq(3).attr('value',allPageNum-1);liPageNum.eq(4).attr('value',allPageNum);liPageNum.eq(0).text(allPageNum-4);liPageNum.eq(1).text(allPageNum-3);liPageNum.eq(2).text(allPageNum-2);liPageNum.eq(3).text(allPageNum-1);liPageNum.eq(4).text(allPageNum);}
else{liPageNum.eq(0).attr('value',curPageNum-2);liPageNum.eq(1).attr('value',curPageNum-1);liPageNum.eq(2).attr('value',curPageNum);liPageNum.eq(3).attr('value',curPageNum+1);liPageNum.eq(4).attr('value',curPageNum+2);liPageNum.eq(0).text(curPageNum-2);liPageNum.eq(1).text(curPageNum-1);liPageNum.eq(2).text(curPageNum);liPageNum.eq(3).text(curPageNum+1);liPageNum.eq(4).text(curPageNum+2);}
for(var i=0,len=liPageNum.length;i<len;i++){var item=liPageNum.eq(i);if(item.attr('value')==curPageNum){item.closest('li').attr('class','active');}
else{item.closest('li').removeAttr('class');}}
_this.setCloudTable(result.data.pointTable);}}).always(function(e){Spinner.stop();});},setCloudTable:function(ptTable,searchText){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');if($tableBody){$tableBody.empty();for(var i=0,len=ptTable.length;i<len;i++){var $itemTr=$('<tr ptId="'+ptTable[i]._id+'" draggable="true" title="'+ptTable[i].value+' : '+ptTable[i].alias+' "></tr>');var $itemTd=$('<td>');var $itemTdName=$('<span class="tabColName" data-value="'+ptTable[i].value+'">'+ptTable[i].value+'</span>');var $itemTdDesc=$('<span class="tabColDesc"> -- '+ptTable[i].alias+'</span>');var $itemTdIcon=$('<span class="btnFav glyphicon glyphicon-plus-sign" aria-hidden="true"></span>');$itemTdIcon.off().click(function(e){var $row=$(e.currentTarget).closest('tr');var ptId=$row.attr('ptId');for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){if(ptId==_this.m_arrCloudTableInfo[i]._id){_this.insertIntoMineTable(_this.m_arrCloudTableInfo[i]);break;}}});$itemTd.append($itemTdName);$itemTdDesc.append($itemTdIcon);$itemTd.append($itemTdDesc);$itemTr.append($itemTd);var start=null;EventAdapter.on($itemTr,'click',function(e){e=e||event;var $this=$(this);var $tableDsCloud=$('#tableDsCloud');var trArr=$tableDsCloud.find('tr');if(e.ctrlKey){if(!e.shiftKey){if($this.hasClass('activeTr')){$this.removeClass('activeTr');}else{$this.addClass('activeTr');}
start=this;}else{var startIndex=$(start).index(),lastIndex=$this.index();var selTr=trArr.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);if($(start).hasClass('activeTr')){selTr.addClass('activeTr');}else{selTr.removeClass('activeTr');}}}else if(e.shiftKey){if($('.activeTr').length!==0){var startIndex=$(start).index(),lastIndex=$this.index();var selTr=trArr.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);selTr.addClass('activeTr');trArr.not(selTr).removeClass('activeTr');}else{$this.addClass('activeTr');}}else{trArr.removeClass('activeTr');$this.addClass('activeTr');start=this;}});EventAdapter.on($itemTr,'dragstart',function(e){$('.templatePara').css('display','block');var tar=($('.activeTr').length>1)?$('.activeTr'):$(e.target);var targetId=$(e.target).attr('ptid');var dragSrcId=undefined,isDragMore=false,dragId=[];if($('.activeTr').length>1){tar.each(function(i,item){var itemId=$(item).attr('ptid');if(itemId===targetId){isDragMore=true;}
dragId.push(itemId);});if(isDragMore){dragSrcId=dragId;}else{dragSrcId=targetId;}}else{dragSrcId=tar.attr('ptid');}
EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($itemTr,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemTr,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});$tableBody.append($itemTr);}}},setCloudNav:function(allPageNum){var ul=$('<ul class="pagination">\
                <li><a class="pageFlag" value="First"><span aria-hidden="true">&laquo;</span></a></li>\
                <li><a class="pageFlag" value="Previous"><span aria-hidden="true">&lsaquo;</span></a></li>\
            </ul>');if(allPageNum>5){ul.append('<li class="active"><a class="pageFlag pageNum" value="1">1</a></li>\
                    <li><a class="pageFlag pageNum" value="2">2</a></li>\
                    <li><a class="pageFlag pageNum" value="3">3</a></li>\
                    <li><a class="pageFlag pageNum" value="4">4</a></li>\
                    <li><a class="pageFlag pageNum" value="5">5</a></li>');}
else{for(var i=0;i<allPageNum;i++){var numTmp=i+1;if(0==i){ul.append('<li class="active"><a class="pageFlag pageNum" value="'+numTmp+'">'+numTmp+'</a></li>');}
else{ul.append('<li><a class="pageFlag pageNum" value="'+numTmp+'">'+numTmp+'</a></li>');}}}
ul.append('<li><a class="pageFlag" value="Next"><span aria-hidden="true">&rsaquo;</span></a></li>\
                        <li><a class="pageFlag" value="Last"><span aria-hidden="true">&raquo;</span></a></li>');var pageFlag=ul.find('.pageFlag');pageFlag.click(function(e){var value=$(e.currentTarget).attr('value');if('First'==value){if(_this.m_curPageNum!=1){_this.setCurrentPage(1,50);}}
else if('Previous'==value){if(_this.m_curPageNum>1){_this.setCurrentPage(_this.m_curPageNum-1,50);}}
else if('Next'==value){if(_this.m_curPageNum<allPageNum){_this.setCurrentPage(_this.m_curPageNum+1,50);}}
else if('Last'==value){if(_this.m_curPageNum!=allPageNum){_this.setCurrentPage(allPageNum,50);}}
else{if(_this.m_curPageNum!=value){_this.setCurrentPage(value,50);}}});var $navPage=_this.$dsNavContain.find('#navPageNum');$navPage.empty();$navPage.append(ul);},insertIntoMineTable:function(newNode){var nodeParent=_this.treeObj.getNodesByParam('name','unassigned',null);if(nodeParent.length>0){var postData={itemList:[{type:0,projId:newNode.projId,alias:newNode.value,value:newNode.value,groupId:nodeParent[0].id}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.itemIdList.length>0){var item=data.itemIdList[0];var obj={id:item.id,pId:item.groupId,name:item.alias,isParent:false,value:item.value,note:item.note}
_this.treeObj.addNodes(nodeParent[0],-1,obj);}}).always(function(e){});}},initElement:function(){var _this=this;var len=AppConfig.projectList.length;var item;if(!(_this.m_parent.arrColor instanceof Array))return;var nColorSize=_this.m_parent.arrColor.length;for(var i=0;i<len;i++){item=AppConfig.projectList[i];_this.m_arrProjIdColorMap[item.id]=_this.m_parent.arrColor[i-parseInt(i/nColorSize)*nColorSize];}
EventAdapter.on($('#data_source_add'),'click',function(e){if(0==_this.m_selectGroupId){alert(_this.m_lang.NO_SELECT_GROUP);return;}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});EventAdapter.on($('#data_source_formula_add'),'click',function(e){if(0==_this.m_selectGroupId){alert(_this.m_lang.NO_SELECT_GROUP);return;}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});EventAdapter.on($('#divAnlsDatasourcePane'),'click',function(e){_this.clearSelect();},false);$('#inputDsSearch').keyup(function(e){var searchVal=$(e.currentTarget).val();if(13==e.keyCode){$('#dataSrcPanel').empty();searchVal=searchVal.toLowerCase();_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,searchVal);$('#dataSrcAddGroup').hide();}
if(''==searchVal){$('#dataSrcPanel').empty();_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,'');_this.colapseGroupsDefault();$('#dataSrcAddGroup').show();}});},insertIntoDataList:function(customName,ptName,ptDesc,prjName,iconColor,itemId,baseNode,bIsAppend,bIsSelected){var _this=this;var div;if(bIsSelected){div=$('<div draggable="true" class="dsItem grow dsSelected" style="height:34px"></div>');}
else{div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');}
div.attr('id',itemId);div.click(function(e){_this.clearSelect();var target=$(e.currentTarget);if('dsItem grow'==target.attr('class')){target.attr('class','dsItem grow dsSelected');}else{target.attr('class','dsItem grow');}
_this.stopBubble(e);});var icon=$('<div class="dsMark"></div>');icon.css('background-color',iconColor);div.append(icon);var custName=$('<div class="dsValue" style="height:36px;">'+customName+'</div>');div.append(custName);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
_this.m_selectItemId=$(e.currentTarget).closest('.dsItem').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){confirm(_this.m_lang.REMOVE_CONFIRM_TIPS,function(){var div=$(e.currentTarget).closest('.dsItem');var dataSrcItemId=div.attr('id');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=data.deleteModal;var len=arr.length;if(len>0){var delMod;var arrDelTitle=[];for(var i=0;i<len;i++){delMod=$('#'+arr[i]);arrDelTitle.push(delMod.find('.newDivPageTitle').val());delMod.remove();}
var delTitle=_this.m_lang.WORKSPACE+':';for(var i=0,len=arrDelTitle.length;i<len;i++){delTitle+=arrDelTitle[i]+' ';}
delTitle+=_this.m_lang.REMOVE_RESULT;alert(delTitle);}}});});});div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>');var ctlPrjName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.PROJECT_NAME+': '+prjName+'</label></div>');ctlPrjName.click(function(e){_this.stopBubble(e);});divChange.append(ctlPrjName);var ctlPtName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.POINT_NAME+': '+ptName+'</label></div>');ctlPtName.click(function(e){_this.stopBubble(e);});divChange.append(ctlPtName);var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find('label').text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find('input');ctlInput.attr('value',customName);ctlInput.attr('placeholder',_this.m_lang.CUSTOM_NAME);inputCustName.click(function(e){_this.stopBubble(e);});divChange.append(inputCustName);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find('label').text(_this.m_lang.POINT_DESC);ctlInput=inputDesc.find('input');ctlInput.attr('value',ptDesc);ctlInput.attr('placeholder',_this.m_lang.POINT_DESC);inputDesc.click(function(e){_this.stopBubble(e);});divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE);btnOk.click(function(e){var temp=$(e.currentTarget).closest('.dsDivChange').find('input');var strName=$(temp[0]).val();var strDesc=$(temp[1]).val();var prjId,ptName,item;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){prjId=item.prjId;ptName=item.ptName;break;}}
var postData={itemList:[{id:itemId,type:0,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:''}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){var id=(data.itemIdList)[0].id;for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName;_this.m_allPointList[i].ptDesc=strDesc;break;}}
_this.setToolTipsCustomName(div,strName);_this.setToolTipsDesc(div,strDesc);_this.calUpdateDataSources();$('#'+id).find('.dsValue').text(strName);}).error(function(e){});});divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL);btnCancel.click(function(e){});divChange.append(btnCancel);div.append(divChange);if(bIsAppend){baseNode.append(div);}
else{baseNode.after(div);}},initToolTips:function(parent,customName,projectName,pointName,pointDesc){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="customName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="projectName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.PROJECT_NAME).append('</span>: ').append(projectName).append('</p> ');show.append('        <p class="pointName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_NAME).append('</span>: ').append(pointName).append('</p> ');show.append('        <p class="pointDesc tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(pointDesc).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'left',title:_this.m_lang.PARAM,template:show.toString(),trigger:'hover'};parent.tooltip(options);},setToolTipsAll:function(row,userName,customName,projectName,pointName,pointDesc){var tip=row.data('bs.tooltip').$tip;userName=': '+userName;customName=': '+customName;projectName=': '+projectName;pointName=': '+pointName;pointDesc=': '+pointDesc;tip.find('.userName').text(this.m_lang.USER_NAME+userName);tip.find('.customName').text(this.m_lang.CUSTOM_NAME+customName);tip.find('.projectName').text(this.m_lang.PROJECT_NAME+projectName);tip.find('.pointName').text(this.m_lang.POINT_NAME+pointName);tip.find('.pointDesc').text(this.m_lang.POINT_DESC+pointDesc);},setToolTipsCustomName:function(row,customName){var tip=row.data('bs.tooltip').$tip;tip.find('.customName').text(this.m_lang.CUSTOM_NAME+': '+customName);},setToolTipsDesc:function(row,ptDesc){var tip=row.data('bs.tooltip').$tip;tip.find('.pointDesc').text(this.m_lang.POINT_DESC+': '+ptDesc);},renderTabel:function(){var _this=this;var len=_this.m_newPointList.length;if(len<=0){return;}
var div=$('#dataSrcPanel');var rowBaseNum=div.find('.dsItem').length;var rowCount;var item;var eachItem;var postData;len=_this.m_newPointList.length;if(len>0){postData={itemList:[]};var arrOld=[];var bIsExist=false;var parentId=_this.m_newPointList[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){arrOld=parentNodes[0].children;}
for(var i=0;i<len;i++){item=_this.m_newPointList[i];eachItem={type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId}
var bFlag=false;for(var j=0;j<arrOld.length;j++){if(item.prjId==arrOld[j].projId&&item.ptName==arrOld[j].value){bIsExist=true;bFlag=true;break;}}
if(!bFlag){postData.itemList.push(eachItem);}}
if(bIsExist){alert(I18n.resource.dataSource.ALREADY_EXIST);}
var projName=_this.m_newPointList[0].prjName;var iconColor=_this.m_newPointList[0].iconColor;if(postData.itemList.length>0){WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.datasourceId){_this.m_dataSourceId=data.datasourceId;}
var list=data.itemIdList;var nAddlen=postData.itemList.length;for(var i=0;i<nAddlen;i++){if(postData.itemList[i].alias==list[i].alias){postData.itemList[i].itemId=list[i].id;}}
if(_this.treeObj){var parentId=_this.m_newPointList[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){if(parentNodes[0].zAsync){var arrNodes=[];for(var i=0;i<postData.itemList.length;i++){var item=postData.itemList[i];var itemNode=item.note?item.note:'';var itemAlias=item.alias?item.alias:'';var itemName=itemAlias;if(itemNode!==''&&itemAlias!==''){if(itemAlias.indexOf(itemNode)<0){itemName=itemNode+' ('+itemAlias+')'}}
arrNodes.push({id:item.itemId,pId:item.groupId,isParent:false,name:itemName,value:item.value,projId:item.projId,note:item.note,type:0,iconSkin:'ptNormal'});}
_this.treeObj.addNodes(parentNodes[0],arrNodes);}
else{_this.treeObj.expandNode(parentNodes[0],true,false,true);}
var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num+=nAddlen;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge')
if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}
break;}}}}
_this.m_allPointList=_this.m_allPointList.concat(_this.m_newPointList);_this.calUpdateDataSources();}).error(function(){}).always(function(){});}}},modifyTable:function(){var _this=this;var item;var eachItem;var postData;var len=_this.m_newPointList.length;if(len>0){postData={itemList:[]};item=_this.m_newPointList[0];eachItem={id:item.itemId,type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.datasourceId){_this.m_dataSourceId=data.datasourceId;}
for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(item.itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].prjId=item.prjId;_this.m_allPointList[i].prjName=_this.m_newPointList[0].prjName;_this.m_allPointList[i].customName=item.customName;_this.m_allPointList[i].ptName=item.ptName;_this.m_allPointList[i].ptDesc=item.ptDesc;break;}}
var divItem=$('#'+item.itemId);divItem.find('.showName').text(item.customName);_this.setToolTipsAll(divItem,item.userName,item.customName,item.prjName,item.ptName,item.ptDesc);_this.calUpdateDataSources();Beop.cache.ds.remove(item.itemId);}).error(function(){}).always(function(){});}},initDrag:function(){var _this=this;_this.dragOperateSrc($('#dataSrcPanel').get(0));_this.dragOperateCfg($('.springConfigMask').parent().get(0));},dragOperateSrc:function(tableList){if(undefined==tableList){return;}
var _this=this;EventAdapter.on($(tableList),'dragstart',function(e){var tar=$(e.target);var className=tar.attr('class');if(!className){e.preventDefault();return;}
if(tar.children('input').length>0){e.preventDefault();}
if(-1!=className.indexOf('nav nav-list tree-group')){var dragSrcId=tar.attr('id');EventAdapter.setData({'dsGroupId':dragSrcId});}
else if(-1!=className.indexOf('treeRow ui-draggable')){var dragSrcId=tar.attr('id');EventAdapter.setData({'dsItemId':dragSrcId});}
else{return;}
$('.templatePara').css('display','block');});EventAdapter.on($(tableList),'dragover',function(e){e.preventDefault();});EventAdapter.on($(tableList),'drop',function(e){var tarItem=$(e.target);var tarId=0;var dstGroupId=0;var srcGroupId=0;var rowClass=tarItem.attr('class');if(!rowClass){return;}
var dragType=-1;var draggedID=0;if(-1!=rowClass.indexOf('nav nav-list tree-group')||-1!=rowClass.indexOf('dsTreeHeader')){tarId=tarItem.closest('.nav').attr('id');draggedID=EventAdapter.getData().dsGroupId;if(Boolean(draggedID)){dragType=0;}
else{draggedID=EventAdapter.getData().dsItemId;if(Boolean(draggedID)){dragType=2;tarId=tarItem.closest('.nav').attr('id');dstGroupId=tarId;srcGroupId=$('#'+draggedID).closest('.nav').attr('id');}}}
else if(-1!=rowClass.indexOf('showName')||-1!=rowClass.indexOf('treeRow ui-draggable')){dragType=1;draggedID=EventAdapter.getData().dsItemId;tarId=tarItem.closest('.treeRow').attr('id');dstGroupId=tarItem.closest('.nav').attr('id');srcGroupId=$('#'+draggedID).closest('.nav').attr('id');}
else{return;}
if(draggedID==tarId||!draggedID){return;}
if(0===dragType){var item,groupName;for(var i=0,len=_this.m_allGroupList.length;i<len;i++){item=_this.m_allGroupList[i];if(draggedID==item.id){groupName=item.name;break;}}
$('#'+draggedID).remove();_this.insertTreeGroup(draggedID,groupName,1,$('#'+tarId));for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(draggedID==item.groupId){if(item.itemType==0){_this.insertTreeItem($('#'+draggedID),item.itemId,item.iconColor,item.customName,0,'',true);}else{_this.insertTreeItem($('#'+draggedID),item.itemId,item.iconColor,item.customName,0,'',false);}
var prjName=_this.getProjectNameFromId(item.prjId,_this.m_langFlag);_this.initToolTips($('#'+item.itemId),item.customName,prjName,item.ptName,item.ptDesc);}}
var dstGroup,srcGroup;var arrDst=[],arrSrc=[];dstGroup=$('#'+tarId).find('.rows').find('.treeRow');srcGroup=$('#'+draggedID).find('.rows').find('.treeRow');$.each(dstGroup,function(i,n){arrDst.push(n.id);});$.each(srcGroup,function(i,n){arrSrc.push(n.id);});var postData={};postData[tarId]=arrDst;postData[draggedID]=arrSrc;WebAPI.post('/datasource/saveDataSourceGroupLayout/'+AppConfig.userId,postData).done(function(data){if('successful'==data.error){}}).error(function(){}).always(function(){});}
else if(1===dragType||2===dragType){var itemType=0;var iconColor='';var custName='';var projId=0;var pointName='';var pointDesc='';for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(draggedID==_this.m_allPointList[i].itemId){_this.m_allPointList[i].groupId=dstGroupId;itemType=_this.m_allPointList[i].itemType;iconColor=_this.m_allPointList[i].iconColor;custName=_this.m_allPointList[i].customName;projId=_this.m_allPointList[i].prjId;pointName=_this.m_allPointList[i].ptName;pointDesc=_this.m_allPointList[i].ptDesc;break;}}
var selItem=$('#'+draggedID);selItem.tooltip('destroy');selItem.remove();if(itemType==0){_this.insertTreeItem($('#'+dstGroupId),draggedID,iconColor,custName,dragType,$('#'+tarId),true);}else{_this.insertTreeItem($('#'+dstGroupId),draggedID,iconColor,custName,dragType,$('#'+tarId),false);}
if(0==itemType){var prjName=_this.getProjectNameFromId(projId,_this.m_langFlag);_this.initToolTips($('#'+draggedID),custName,prjName,showName,pointDesc);}
else if(1==itemType){var showName=_this.getShowNameFromFormula(pointName);_this.initFormulaToolTips($('#'+draggedID),custName,showName,pointDesc);}
else{return;}
var postData={};if(dstGroupId==srcGroupId){var srcGroup,arrSrc=[];srcGroup=$('#'+srcGroupId).find('.rows').find('.treeRow');$.each(srcGroup,function(i,n){arrSrc.push(n.id);});postData[srcGroupId]=arrSrc;}
else{var dstGroup,srcGroup;var arrDst=[],arrSrc=[];dstGroup=$('#'+dstGroupId).find('.rows').find('.treeRow');srcGroup=$('#'+srcGroupId).find('.rows').find('.treeRow');$.each(dstGroup,function(i,n){arrDst.push(n.id);});$.each(srcGroup,function(i,n){arrSrc.push(n.id);});var dstGroupCnt=0,srcGroupCnt=0;var groups=$('#dataSrcPanel .nav');$.each(groups,function(i,n){if(n.id==dstGroupId){dstGroupCnt=i;}
if(n.id==srcGroupId){srcGroupCnt=i;}});if(dstGroupCnt<srcGroupCnt){postData[dstGroupId]=arrDst;postData[srcGroupId]=arrSrc;}
else{postData[dstGroupId]=arrDst;postData[srcGroupId]=arrSrc;}}
WebAPI.post('/analysis/datasource/saveLayout/'+AppConfig.userId,postData).done(function(data){if(data.success){}}).error(function(){}).always(function(){});}});},dragOperateCfg:function(divItem){if(undefined==divItem){return;}
var _this=this;EventAdapter.on($(divItem),'dragstart',function(e){var target=$(e.target);var className=target.attr('class');if('dsItem grow'!=className&&'dsItem grow dsSelected'!=className){return;}
var dragSrcId=target.attr('id');EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($(divItem),'dragover',function(e){e.preventDefault();});EventAdapter.on($(divItem),'drop',function(e){var target=$(e.target);});},saveCurrentRecords:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.post('/delete_data_source_records_by_userid',{userId:AppConfig.userId}).done(function(result){if(result!=0){Spinner.stop();return;}
var newPtList=[];var id;var len=_this.m_allPointList.length;var newRow;var item;$('#dataSrcPanel .dsItem').each(function(){id=$(this).attr('id');for(var i=0;i<len;i++){item=_this.m_allPointList[i];if(id==item.itemId){newRow={'itemId':id,'userId':item.userId,'userName':item.userName,'customName':item.customName,'prjId':item.prjId,'prjName':item.prjName,'ptName':item.ptName,'ptDesc':item.ptDesc,'iconColor':item.iconColor,'itemId':item.itemId}
newPtList.push(newRow);break;}}});_this.m_allPointList=newPtList;var row;var data=[];var len=_this.m_allPointList.length;for(var i=0;i<len;i++){item=_this.m_allPointList[i];row={'userId':item.userId,'customName':item.customName,'projectId':item.prjId,'pointName':item.ptName,'pointDesc':item.ptDesc,'iconColor':item.iconColor}
data.push(row);}
WebAPI.post('/save_data_source_record',{sourceList:data}).done(function(result){if(0==result){}}).error(function(result){alert(I18n.resource.observer.widgets.DATABASE_OPERATION_FAILED+'！');return;});}).error(function(result){alert(I18n.resource.observer.widgets.FAIL_BEFORE_EXECUTING+'！');return;}).always(function(){Spinner.stop();});},loadDataSourceRecord:function(){var _this=this;var groupInfo=_this.m_parent.store.group;if(!groupInfo){return;}
_this.m_allGroupList=[];_this.m_allPointList=[];var itemDefault=null;for(var m=0,n=groupInfo.length;m<n;m++){var groupId=groupInfo[m].groupId;var groupName=groupInfo[m].groupName;var groupIsDefault=(Boolean(groupInfo[m].isDefault))?true:false;var data=groupInfo[m].datasourceList;var groupItem={'id':groupId,'name':groupName,'isDefault':groupIsDefault};if(groupIsDefault){itemDefault=groupItem;}
else{_this.m_allGroupList.push(groupItem);}
if(data){var len=data.length;var item;for(var i=0;i<len;i++){item={userId:AppConfig.userId,userName:AppConfig.account,customName:data[i].alias,prjId:data[i].projId,prjName:_this.getProjectNameFromId(data[i].projId),ptName:data[i].value,ptDesc:data[i].note,iconColor:_this.m_arrProjIdColorMap[data[i].projId],itemId:data[i].id,itemType:data[i].type,itemValue:data[i].value,groupId:groupId,groupName:groupName}
if(item.itemType==1){item.iconColor='#000000';}
_this.m_allPointList.push(item);}}}
if(itemDefault){_this.m_allGroupList.push(itemDefault);}},colapseGroupsDefault:function(){var treeAllHead=$('.dsTreeHeader .dsGroupName');var item,row;for(var i=0,len=treeAllHead.length;i<len;i++){item=treeAllHead.eq(i);row=item.closest('.tree-group').find('.rows');if(!row||row.length<=0){continue;}
if(item.text()==this.m_unassigned){row.css('display','block');}
else{row.css('display','none');}}},colapseGroups:function(openGroupId){if(!openGroupId){return;}
var treeAllRow=$('#dataSrcPanel .tree-group');var item,row;for(var i=0,len=treeAllRow.length;i<len;i++){item=treeAllRow.eq(i);row=item.find('.rows');if(!row||row.length<=0){continue;}
if(item.attr('id')==openGroupId){row.css('display','block');}
else{row.css('display','none');}}
sessionStorage.removeItem('dsOpenGroupId');},getProjectNameFromId:function(id,langFlag){var name;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(id==item.id){if(0==langFlag){name=item.name_cn;}
else{name=item.name_en;}
break;}}
return name;},getProjectIdFromName:function(projectName){var id;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(projectName==item.name_cn){id=item.id;break;}}
return id;},calUpdateDataSources:function(){return;var _this=this;var updateData=[];for(var i=0,len=_this.m_allGroupList.length;i<len;i++){var groupItem={'groupId':_this.m_allGroupList[i].id,'groupName':_this.m_allGroupList[i].name,'parentId':'','datasourceList':''};var dsList=[];for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){var curItem=_this.m_allPointList[j];if(groupItem.groupId==curItem.groupId){var pushItem={'id':curItem.itemId,'type':curItem.itemType,'projId':curItem.prjId,'alias':curItem.customName,'note':curItem.ptDesc,'value':curItem.ptName,'groupId':curItem.groupId};dsList.push(pushItem);}}
groupItem.datasourceList=dsList;updateData.push(groupItem);}
this.m_parent.updateDataSources(updateData);},renderFormula:function(_customName,_formulaVal,_formulaDesc){var _this=this;var postData={itemList:[]};var prjId=0;var eachItem={type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var item;var arrNewFormula=[];for(var i=0,len=list.length;i<len;i++){item={'itemId':list[i].id,'itemType':1,'customName':list[i].alias,'itemValue':list[i].value,'ptName':list[i].value,'prjId':prjId,'iconColor':'#000000','ptDesc':_formulaDesc,'groupId':list[i].groupId};arrNewFormula.push(item);}
if(_this.treeObj){var parentId=arrNewFormula[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){if(parentNodes[0].zAsync){var arrNodes=[];for(var i=0;i<len;i++){arrNodes.push({id:arrNewFormula[i].itemId,pId:arrNewFormula[i].groupId,isParent:false,name:arrNewFormula[i].customName,value:arrNewFormula[i].itemValue,projId:arrNewFormula[i].prjId,note:arrNewFormula[i].ptDesc,type:1,iconSkin:'ptFormula'});}
_this.treeObj.addNodes(parentNodes[0],arrNodes);}
else{_this.treeObj.expandNode(parentNodes[0],true,false,true);}
var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num+=1;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge')
if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}
break;}}}}
_this.calUpdateDataSources();});},modifyFormula:function(_customName,_formulaVal,_formulaDesc){var _this=this;var postData={itemList:[]};var itemId=_this.m_selectItemId;var prjId=Number(AppConfig.projectId);var eachItem={id:itemId,type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;if(list.length>0){var showName=list[0].value;var arr=showName.split('<%');var arrId=[];var arrItem=[];for(var j=0,len2=arr.length;j<len2;j++){var id=arr[j].split('%>')[0];if(''!=id){arrId.push(id);}}
arrItem=_this.getDSItemById(arrId);for(var j=0,len2=arr.length;j<len2;j++){var id=arr[j].split('%>')[0];if(''==id){continue;}
for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var retVal=arrItem[m];if(null==retVal){continue;}
showName=showName.replace(id,retVal.value);break;}}}
showName=showName.replace(/<%/g,'');showName=showName.replace(/%>/g,'');for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=list[0].alias;_this.m_allPointList[i].ptName=list[0].value;_this.m_allPointList[i].ptDesc=list[0].note;break;}}
var divFormula=$('#'+itemId);divFormula.find('.showName').text(list[0].alias);_this.setFormulaToolTipsAll(divFormula,list[0].alias,showName,list[0].note);_this.calUpdateDataSources();Beop.cache.ds.remove(itemId);}});},insertFormula:function(itemId,customName,iconColor,formula,desc){var _this=this;var div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');div.attr('id',itemId);div.click(function(e){_this.clearSelect();var tar=$(e.currentTarget);if('dsItem grow'==tar.attr('class')){tar.attr('class','dsItem grow dsSelected');}
else{tar.attr('class','dsItem grow');}
_this.stopBubble(e);});var icon=$('<div class="dsMark"></div>');icon.css('background-color',iconColor);div.append(icon);var name=$('<div class="dsValue" style="height:36px"></div>');name.text(customName);div.append(name);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){var show=$(e.currentTarget).prevAll('.dsValue');show.css('display','none');var target=$(e.currentTarget).nextAll('.dsDivChange');target.attr('class','dsDivChange show');div.css('height','240px');div.css('width','100%');var item;var strName='';var strFormula='';var strDesc='';for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){strName=item.customName;strFormula=item.ptName;strDesc=item.ptDesc;break;}}
var temp=target.find('input');if(temp.length==2){$(temp[0]).val(strName);$(temp[1]).val(strDesc);}
_this.stopBubble(e);}).error(function(e){});div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){confirm(_this.m_lang.REMOVE_CONFIRM,function(){var div=$(e.currentTarget).closest('.dsItem');var dataSrcItemId=div.attr('id');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();}});});});div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>');var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find('label').text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find('input');ctlInput.attr('value',customName);ctlInput.attr('placeholder',_this.m_lang.CUSTOM_NAME);inputCustName.click(function(e){_this.stopBubble(e);});divChange.append(inputCustName);var ctlFormula=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.FORMULA_NAME+': </label></div>');var showFormula=$('<span>'+formula+'</span>');showFormula.appendTo(ctlFormula.find('label')).mathquill();ctlFormula.click(function(e){_this.stopBubble(e);});divChange.append(ctlFormula);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find('label').text(_this.m_lang.POINT_DESC);ctlInput=inputDesc.find('input');ctlInput.attr('value',desc);ctlInput.attr('placeholder',_this.m_lang.POINT_DESC);inputDesc.click(function(e){_this.stopBubble(e);});divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE);btnOk.click(function(e){var temp=$(e.currentTarget).closest('.dsDivChange').find('input');var strName=$(temp[0]).val();var strDesc=$(temp[1]).val();var prjId,ptName,item;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){prjId=item.prjId;ptName=item.ptName;break;}}
var postData={itemList:[{id:itemId,type:1,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:''}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(0==data.itemIdList.length){return;}
var id=(data.itemIdList)[0].id;for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName;_this.m_allPointList[i].ptDesc=strDesc;break;}}
_this.setToolTipsCustomName(div,strName);_this.setToolTipsDesc(div,strDesc);_this.calUpdateDataSources();$('#'+id).find('.dsValue').text(strName);}).error(function(e){});});divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL);btnCancel.click(function(e){});divChange.append(btnCancel);div.append(divChange);$('#dataSrcPanel').append(div);},initFormulaToolTips:function(parent,customName,formula,desc){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:400px;">');show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="customName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="formula tipStyle" style="word-break:normal;"><span class="tipTitleStyle">').append(_this.m_lang.FORMULA_NAME).append('</span>: ').append('</p>');show.append('        <p class="pointDesc tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(desc).append('</p>');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var showFormula=$('<span>'+formula+'</span>');var showObj=$(show.toString());showFormula.appendTo(showObj.find('.formula')).mathquill();var options={placement:'left',title:_this.m_lang.PARAM,template:showObj};parent.tooltip(options);},setFormulaToolTipsAll:function(row,customName,formulaVal,formulaDesc){var tip=row.data('bs.tooltip').$tip;tip.find('.customName').html('<span style="font-weight:bold">'+this.m_lang.CUSTOM_NAME+'</span>: '+customName);tip.find('.pointDesc').html('<span style="font-weight:bold">'+this.m_lang.POINT_DESC+'</span>: '+formulaDesc);var showFormula=$('<span>'+formulaVal+'</span>');var dst=tip.find('.formula').html('<span style="font-weight:bold">'+this.m_lang.FORMULA_NAME+'</span>: ');showFormula.appendTo(dst).mathquill();},checkRepeatWithCustomName:function(_name){var _this=this;var bRet=false;var grids=$('#dataSrcPanel .dsItem .dsValue');$.each(grids,function(i,n){if(_name==$(n).text()){bRet=true;return false;}});return bRet;},stopBubble:function(e){if(e&&e.stopPropagation){e.stopPropagation();}else{window.event.cancelBubble=true;}},clearSelect:function(e){var itemList=$('#dataSrcPanel .dsItem');itemList.attr('class','dsItem grow');itemList.css('height','34px');itemList.css('width','33%');var panel=$('#dataSrcPanel');panel.find('.dsDivChange').attr('class','dsDivChange');panel.find('.dsValue').css('display','inline');},insertTreeGroup:function(groupId,groupName,type,baseGroup){var _this=this;var divContain=$('#dataSrcPanel');var $ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true">');var $liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon open"></span></li>');var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);if(groupName!=_this.m_unassigned){var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true"></span>');EventAdapter.on(btnRemove,'click',function(e){var div=$(e.currentTarget).closest('.nav');WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(_this.m_lang.REMOVE_CONFIRM);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
var groupId=div.attr('id');div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+groupId).done(function(data){if(('successful'==data.error)){var len=_this.m_allGroupList.length;for(var i=0;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1);div.remove();break;}}
_this.calUpdateDataSources();}}).fail(function(e){});});res.modal('show');}).always(function(e){});}).error(function(e){});$liHd.append(btnRemove);}
var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add"></span>');EventAdapter.on(btnAddDs,'click',function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add" /></span>');EventAdapter.on(btnAddFormula,'click',function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_hover.png');img.css('width','23px');img.css('height','20px');}).error(function(e){});btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_normal.png');img.css('width','21px');img.css('height','19px');}).error(function(e){});$liHd.append(btnAddFormula);if(groupName!=_this.m_unassigned){var spanEdit=$('<span class="glyphicon glyphicon-pencil panel-heading-btn grow dsEditGroupName" aria-hidden="true"></span>');EventAdapter.on(spanEdit,'click',function(e){var tar=$(e.currentTarget);var groupName=tar.siblings('.dsGroupName');groupName.hide();var input=tar.siblings('.inputEditGroup');input.val(groupName.text());input.show();input.select();tar.siblings('.btn').show();_this.stopBubble(e);});$liHd.append(spanEdit);var inputEdit=$('<input type="text" value="'+groupName+'" class="inputEditGroup">');inputEdit.hide();EventAdapter.on(inputEdit,'click',function(e){_this.stopBubble(e);});inputEdit.keyup(function(e){if(13==e.keyCode){var tar=$(e.currentTarget);tar.siblings('button').click();}
_this.stopBubble(e);});$liHd.append(inputEdit);var btnEdit=$('<button class="btn btn-default btn-sm" type="submit">Change</button>');btnEdit.hide();EventAdapter.on(btnEdit,'click',function(e){var tar=$(e.currentTarget);tar.hide();var input=tar.siblings('.inputEditGroup');var newName=input.val();input.hide();var groupName=tar.siblings('.dsGroupName');var oldName=groupName.text();groupName.show();if(oldName!=newName&&''!=newName){var postData={'groupId':groupId,'name':newName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if(undefined==data){return;}
if('successful'==data.error){for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList[i].name=data.groupName;break;}}
spanName.text(data.groupName);}}).fail(function(e){});}
_this.stopBubble(e);});$liHd.append(btnEdit);}
EventAdapter.on($liHd,'click',function(e){divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');divContain.find('.dsEditGroupName').css('display','none');var curTarHead=$(e.currentTarget);curTarHead.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarHead.closest('.tree-group').get(0).id;$(this).next('.rows').slideToggle();var icon=$(this).find('.dsTreeHeaderIcon');var imgPath=icon.attr('src');if(icon.hasClass('open')){icon.removeClass('open');curTarHead.find('.dsGroupName').css('font-weight','400');curTarHead.find('.dsTreeBtnFormula').css('display','none');curTarHead.find('.dsTreeBtnAdd').css('display','none');curTarHead.find('.dsTreeBtnDel').css('display','none');curTarHead.find('.dsEditGroupName').css('display','none');}
else{icon.addClass('open');curTarHead.find('.dsGroupName').css('font-weight','700');curTarHead.find('.dsTreeBtnFormula').css('display','inline');curTarHead.find('.dsTreeBtnAdd').css('display','inline');curTarHead.find('.dsTreeBtnDel').css('display','inline');curTarHead.find('.dsEditGroupName').css('display','inline');}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow);if(0===type){divContain.append($ul);}
else if(1===type){if(''!=baseGroup){baseGroup.after($ul);}}
else if(2===type){if(''!=baseGroup){baseGroup.before($ul);}}},insertTreeItem:function(divParentGroup,itemId,iconColor,itemName,insertType,baseItem,bIsPoint){var _this=this;var div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true"> ');var icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css('background-color',iconColor);div.append(icon);var divShowName=$('<span class="showName">'+itemName+'</span>');EventAdapter.on(divShowName,'click',function(e){var oldCustName=$(e.currentTarget).text();var input=$('<input type="text" value="'+oldCustName+'" style="width:300px;position: absolute;top: 4px">');input.blur(function(e){var newCustName=$(e.currentTarget).val();if(oldCustName!=newCustName){var item,type,prjId,ptName,ptDesc,groupId,postData;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){type=item.itemType;prjId=item.prjId;ptName=item.ptName;ptDesc=item.ptDesc;groupId=item.groupId;break;}}
postData={itemList:[]};var eachItem={id:itemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var dstId,dstCustomName;for(var i=0,len=list.length;i<len;i++){dstId=list[i].id;dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break;}}
divShowName.text(dstCustomName);_this.setToolTipsCustomName(divShowName.closest('.treeRow'),dstCustomName);}
_this.calUpdateDataSources();});}
input.remove();divShowName.css('display','inline');});input.keyup(function(e){if(13==e.keyCode){input.blur();}
_this.stopBubble(e);});divShowName.after(input);divShowName.css('display','none');input.select();});div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');EventAdapter.on(btnRemove,'click',function(e){var promise=$.Deferred();var div=$(e.currentTarget).closest('.treeRow');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;if(typeof _this.m_parent.doSync==='function'){_this.m_parent.doSync().done(function(){promise.resolve();});}else{promise.resolve();}
promise.done(function(){WebAPI.get('/analysis/checkDatasourceBeforeDelete/'+dataSrcItemId+'/'+AppConfig.userId).done(function(chkData){var nWorkSpLen=chkData.workspaceInfo.length;var nDashBoLen=chkData.dashboardInfo.length;if(nWorkSpLen>0||nDashBoLen>0){var show=_this.m_lang.REMOVE_CONFIRM_TIPS;var name;for(var i=0;i<nWorkSpLen;i++){if(0==i){show+='workspace: ';}
name=chkData.workspaceInfo[i].modalName;name=Boolean(name)?name:'Untitled';show+=name+',';}
for(var j=0;j<nDashBoLen;j++){if(0==j){show+='dashboard: ';}
show+=chkData.dashboardInfo[j].modalType+',';}
show+=_this.m_lang.REMOVE_CONFIRM;WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(show);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});});res.modal('show');}).always(function(e){});}
else{if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});}}).fail(function(e){});});}).error(function(e){});div.append(btnRemove);if(bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on(btnCfg,'click',function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}else{var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on(btnCfg,'click',function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}
EventAdapter.on(div,'click',function(e){var divContain=$('#dataSrcPanel');divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');var curTarItem=$(e.currentTarget);curTarItem.find('.dsTreeBtnCfg').css('display','inline');curTarItem.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarItem.closest('.tree-group').get(0).id;});if(0===insertType){divParentGroup.find('.rows').append(div);}
else if(1===insertType){if(''!=baseItem){baseItem.after(div);}}
else if(2===insertType){var lyRow=divParentGroup.find('.rows').find('.treeRow');if(0==lyRow.length){divParentGroup.find('.rows').append(div);}
else{lyRow.eq(0).before(div);}}},insertTreeAllGroupItem:function(groupList,pointList,searchPointName){var _this=this;var divContain=$('#dataSrcPanel');var groupId,groupName,bIsDefault;for(var i=0,len=groupList.length;i<len;i++){groupId=groupList[i].id;groupName=groupList[i].name;bIsDefault=groupList[i].isDefault;var $ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true" dropable="true" isDefault="'+bIsDefault+'">');var $liHd;if(groupName==this.m_unassigned){$liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon open"></span></li>');}
else{$liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon"></span></li>');}
var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);if(groupName!=_this.m_unassigned){var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true" style="display:none"></span>');EventAdapter.on($(btnRemove),'click',function(e){var div=$(e.currentTarget).closest('.nav');WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(_this.m_lang.REMOVE_CONFIRM);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
var groupId=div.attr('id');div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+groupId).done(function(data){if(('successful'==data.error)){var len=_this.m_allGroupList.length;for(var i=0;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1);div.remove();break;}}
_this.calUpdateDataSources();}}).fail(function(e){});});res.modal('show');}).always(function(e){});});$liHd.append(btnRemove);}
var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add" style="display:none"></span>');if(groupName==this.m_unassigned){btnAddDs.css('display','inline');}
EventAdapter.on($(btnAddDs),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add"  style="display:none"/></span>');if(groupName==this.m_unassigned){btnAddFormula.children('img').css('display','inline');}
EventAdapter.on($(btnAddFormula),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_hover.png');img.css('width','23px');img.css('height','20px');}).error(function(e){});btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_normal.png');img.css('width','21px');img.css('height','19px');}).error(function(e){});$liHd.append(btnAddFormula);if(groupName!=_this.m_unassigned){var spanEdit=$('<span class="glyphicon glyphicon-pencil panel-heading-btn grow dsEditGroupName" aria-hidden="true" style="display:none"></span>');EventAdapter.on($(spanEdit),'click',function(e){var tar=$(e.currentTarget);var groupName=tar.siblings('.dsGroupName');groupName.hide();var input=tar.siblings('.inputEditGroup');input.val(groupName.text());input.show();input.select();tar.siblings('.btn').show();_this.stopBubble(e);});$liHd.append(spanEdit);var inputEdit=$('<input type="text" value="'+groupName+'" class="inputEditGroup">');inputEdit.hide();EventAdapter.on($(inputEdit),'click',function(e){_this.stopBubble(e);});inputEdit.keyup(function(e){if(13==e.keyCode){var tar=$(e.currentTarget);tar.siblings('button').click();}
_this.stopBubble(e);});$liHd.append(inputEdit);var btnEdit=$('<button class="btn btn-primary btn-sm" type="submit">Change</button>');btnEdit.hide();EventAdapter.on($(btnEdit),'click',function(e){var tar=$(e.currentTarget);tar.hide();var input=tar.siblings('.inputEditGroup');var newName=input.val();input.hide();var groupName=tar.siblings('.dsGroupName');var oldName=groupName.text();groupName.show();if(oldName!=newName&&''!=newName){var ulNav=tar.closest('.nav');var groupId=ulNav.attr('id');var postData={'groupId':groupId,'name':newName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if(undefined==data){return;}
if('successful'==data.error){for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList[i].name=data.groupName;break;}}
var spanName=ulNav.find('.dsGroupName');if(Boolean(spanName)){spanName.text(data.groupName);}}}).fail(function(e){});}
_this.stopBubble(e);});$liHd.append(btnEdit);}
EventAdapter.on($($liHd),'click',function(e){divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');divContain.find('.dsEditGroupName').css('display','none');var curTarHead=$(e.currentTarget);curTarHead.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarHead.closest('.tree-group').get(0).id;$(this).next('.rows').slideToggle();var icon=$(this).find('.dsTreeHeaderIcon');if(icon.hasClass('open')){icon.removeClass('open');curTarHead.find('.dsGroupName').removeClass('selected');curTarHead.find('.dsTreeBtnFormula').css('display','none');curTarHead.find('.dsTreeBtnAdd').css('display','none');curTarHead.find('.dsTreeBtnDel').css('display','none');curTarHead.find('.dsEditGroupName').css('display','none');}
else{icon.addClass('open');curTarHead.find('.dsGroupName').addClass('selected');curTarHead.find('.dsTreeBtnFormula').css('display','inline-block');curTarHead.find('.dsTreeBtnAdd').css('display','inline');curTarHead.find('.dsTreeBtnDel').css('display','inline');curTarHead.find('.dsEditGroupName').css('display','inline');}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');if(groupName==_this.m_unassigned){divLiRow.css('display','block');}
else{divLiRow.css('display','none');}
$ul.append(divLiRow);var itemId,iconColor,itemName,itemPtName;var bHasSearched=false;for(var j=0,len2=pointList.length;j<len2;j++){if(groupId==pointList[j].groupId){itemId=pointList[j].itemId;iconColor=pointList[j].iconColor;itemName=pointList[j].customName;itemPtName=pointList[j].ptName;if(''!=searchPointName){var custNameLower=itemName.toLowerCase();var ptNameLower=itemPtName.toLowerCase();if(-1==custNameLower.indexOf(searchPointName)&&-1==ptNameLower.indexOf(searchPointName)){continue;}
else{bHasSearched=true;}}
var div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true" dropable="true"> ');var icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css('background-color',iconColor);div.append(icon);var divShowName=$('<span class="showName">'+itemName+'</span>');EventAdapter.on($(divShowName),'click',function(e){var divCurShowName=$(e.currentTarget);var oldCustName=divCurShowName.text();var selItemId=divCurShowName.closest('.treeRow').attr('id');var input=$('<input type="text" value="'+oldCustName+'" style="width:300px;position: absolute;top: 4px;background-color:#465b85">');input.blur(function(e){var $tar=$(e.currentTarget);var newCustName=$tar.val();if(''==newCustName){$tar.select();alert(I18n.resource.dataSource.CUSTOM_NOT_NULL);return;}
if(oldCustName!=newCustName){var item,type,prjId,ptName,ptDesc,groupId,postData;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(selItemId==item.itemId){type=item.itemType;prjId=item.prjId;ptName=item.ptName;ptDesc=item.ptDesc;groupId=item.groupId;break;}}
postData={itemList:[]};var eachItem={id:selItemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var dstId,dstCustomName;for(var i=0,len=list.length;i<len;i++){dstId=list[i].id;dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break;}}
divCurShowName.text(dstCustomName);_this.setToolTipsCustomName(divCurShowName.closest('.treeRow'),dstCustomName);}
_this.calUpdateDataSources();});}
input.remove();divCurShowName.css('display','inline');});input.keyup(function(e){if(13==e.keyCode){input.blur();}
_this.stopBubble(e);});divCurShowName.after(input);divCurShowName.css('display','none');input.select();});div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');EventAdapter.on($(btnRemove),'click',function(e){var promise=$.Deferred();var div=$(e.currentTarget).closest('.treeRow');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;if(typeof _this.m_parent.doSync==='function'){_this.m_parent.doSync().done(function(){promise.resolve();});}else{promise.resolve();}
Spinner.spin(div[0]);promise.done(function(){WebAPI.get('/analysis/checkDatasourceBeforeDelete/'+dataSrcItemId+'/'+AppConfig.userId).done(function(chkData){var nWorkSpLen=chkData.workspaceInfo.length;var nDashBoLen=chkData.dashboardInfo.length;if(nWorkSpLen>0||nDashBoLen>0){var show=_this.m_lang.REMOVE_CONFIRM_TIPS;var name;for(var i=0;i<nWorkSpLen;i++){if(0==i){show+='workspace: ';}
name=chkData.workspaceInfo[i].modalName;name=Boolean(name)?name:'Untitled';show+=name+',';}
for(var j=0;j<nDashBoLen;j++){if(0==j){show+='dashboard: ';}
show+=chkData.dashboardInfo[j].modalType+',';}
show+=_this.m_lang.REMOVE_CONFIRM;WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(show);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});});res.modal('show');}).always(function(e){});}
else{div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});}}).fail(function(e){}).always(function(e){Spinner.stop();});});});div.append(btnRemove);var bIsPoint=(0==pointList[j].itemType)?true:false;if(bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on($(btnCfg),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}else{var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on($(btnCfg),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}
EventAdapter.on($(div),'click',function(e){var divContain=$('#dataSrcPanel');divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');var curTarItem=$(e.currentTarget);curTarItem.find('.dsTreeBtnCfg').css('display','inline');curTarItem.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarItem.closest('.tree-group').get(0).id;});$ul.find('.rows').append(div);if(bIsPoint){var prjName=_this.getProjectNameFromId(pointList[j].prjId,_this.m_langFlag);_this.initToolTips(div,pointList[j].customName,prjName,pointList[j].ptName,pointList[j].ptDesc);}
else{var showName=_this.getShowNameFromFormula(pointList[j].ptName);_this.initFormulaToolTips(div,pointList[j].customName,showName,pointList[j].ptDesc);}}}
if(''==searchPointName){divContain.append($ul);}
else{if(bHasSearched){divContain.append($ul);}}}},getDSItemById:function(datasourceItemId){var _this=this;var postData=[];var bIsArray=Object.prototype.toString.call(datasourceItemId)==='[object Array]';if(!bIsArray){if(this.m_parent.store.dsInfoList){var itemInfo;for(var i=0,len=this.m_parent.store.dsInfoList.length;i<len;i++){itemInfo=this.m_parent.store.dsInfoList[i];if(datasourceItemId==itemInfo.id){return itemInfo;}}}
for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){var item=_this.m_arrCloudTableInfo[i];if(datasourceItemId==item._id){return{id:item._id,groupId:'',alias:item.alias,projId:item.projId,type:0,value:item.value}}}}
else{var ret=[];if(this.m_parent.store.dsInfoList){var itemInfo;for(var j=0;j<datasourceItemId.length;j++){for(var i=0,len=this.m_parent.store.dsInfoList.length;i<len;i++){itemInfo=this.m_parent.store.dsInfoList[i];if(datasourceItemId[j]==itemInfo.id){ret.push(itemInfo);break;}}}
if(ret.length>0){return ret;}}
for(var j=0;j<datasourceItemId.length;j++){for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){var item=_this.m_arrCloudTableInfo[i];if(datasourceItemId[j]==item._id){ret.push({id:item._id,groupId:'',alias:!!(item.alias)?item.alias:item.value,projId:item.projId,type:0,value:item.value});}}}
if(ret.length>0){return ret;}}
if(!bIsArray){postData.push(datasourceItemId);}
else{postData=datasourceItemId;}
var dsRet=$.ajax({type:'POST',url:'/analysis/datasource/getDsItemsById',data:JSON.stringify(postData),contentType:'application/json',async:false}).responseText;if(dsRet){var temp=JSON.parse(dsRet);var ret;if(!bIsArray){ret=temp[0];if(!ret){ret={alias:undefined,groupId:undefined,id:undefined,note:undefined,projId:undefined,type:undefined,value:undefined}}}
else{if(temp instanceof Array){temp.map(function(i){if(!i.alias){i.alias=i.value}});}
ret=temp;}
return ret;}
return{};},getDSItemData:function(target,arrDSItemIds){var _this=this.m_parent;var tmStart=_this.curModal.startTime.toDate();var tmEnd=_this.curModal.endTime.toDate();var tmFmt=_this.curModal.format;var key;var preloadIds=[];var row=null,arrId;var ids=arrDSItemIds.concat();var postData={dsItemIds:ids,timeStart:tmStart.format('yyyy-MM-dd HH:mm:ss'),timeEnd:tmEnd.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt};var promise=$.Deferred();Beop.cache.ds.getBatch(ids,tmFmt,tmStart,tmEnd).done(function(rs){promise.resolve(rs);}).fail(function(e){console.warn(e);promise.reject();});promise.always(function(rs){var idsNotFound,cacheData;if(rs){idsNotFound=rs.idsNotFound;cacheData=rs.data;if(idsNotFound.length>0){postData.dsItemIds=idsNotFound;}else{target.spinnerStop();target.renderModal(cacheData);return;}}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(data){if(data.error&&data.error.length>0){target.errAlert(data.error);target.spinnerStop();return;}
Beop.cache.ds.set(data,tmFmt,tmStart,tmEnd).done(function(){if(cacheData&&cacheData!==null){data={list:data.list.concat(cacheData.list),timeShaft:(data.timeShaft.length>0)?data.timeShaft:cacheData.timeShaft};}}).fail(function(e){console.warn(e);}).always(function(){target.renderModal(data);});}).error(function(e){_this.paneCenter.spinnerStop();_this.alertNoData();});});},getDSItemDataMulti:function(target,arrDSItemIds){var _this=this.m_parent;_this.curModal.arrComparePeriodLabel=[];var tmStart=_this.curModal.startTime;tmStart=tmStart.length<=10?tmStart+' 00:00:00':tmStart;var tmEnd=_this.curModal.endTime;tmEnd=tmEnd.length<=10?tmEnd+' 00:00:00':tmEnd;var tmFmt=_this.curModal.format;var comparePeriod=_this.curModal.comparePeriod;var period1,period2,time;var startDate=new Date(tmStart);var endDate=new Date(tmEnd);var compareDateI18n=I18n.resource.analysis.historyCompare;if(comparePeriod=='hour'){time=3600000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1)+'-'+startDate.getDate()+' '+startDate.getHours()+':00');_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1)+'-'+endDate.getDate()+' '+endDate.getHours()+':00');}
if(comparePeriod=='day'){time=86400000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1)+'-'+startDate.getDate());_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1)+'-'+endDate.getDate());}
if(comparePeriod=='week'){time=604800000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(compareDateI18n.YEAR_WEEK.replace('<%year%>',startDate.getFullYear()).replace('<%week%>',getWeekNumber(tmStart)));_this.curModal.arrComparePeriodLabel.push(compareDateI18n.YEAR_WEEK.replace('<%year%>',endDate.getFullYear()).replace('<%week%>',getWeekNumber(tmEnd)));}
if(comparePeriod=='month'){period1=getCurrentMonthLastDay(tmStart);period2=getCurrentMonthLastDay(tmEnd);function getCurrentMonthLastDay(date){var current=date.toDate();var currentMonth=current.getMonth();var nextMonth=++currentMonth;var nextMonthDayOne=new Date(current.getFullYear(),nextMonth,1);return new Date(nextMonthDayOne.getTime());}
_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1));_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1));}
var postData=[{dsItemIds:arrDSItemIds,timeStart:tmStart.format('yyyy-MM-dd HH:mm:ss'),timeEnd:period1.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt},{dsItemIds:arrDSItemIds,timeStart:tmEnd.format('yyyy-MM-dd HH:mm:ss'),timeEnd:period2.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt}];WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(data){if(data.error&&data.error.length>0){target.errAlert(data.error);target.spinnerStop();return;}
target.renderModal(data);}).error(function(e){_this.paneCenter.spinnerStop();_this.alertNoData();});function isLeapYear(year){return(year%400==0)||(year%4==0&&year%100!=0);}
function getMonthDays(year,month){return[31,null,31,30,31,30,31,31,30,31,30,31][month]||(isLeapYear(year)?29:28);}
function getWeekNumber(date){var now=date.toDate(),year=now.getFullYear(),month=now.getMonth(),days=now.getDate();for(var i=0;i<month;i++){days+=getMonthDays(year,i);}
var yearFirstDay=new Date(year,0,1).getDay()||7;var week=null;if(yearFirstDay==1){week=Math.ceil(days/yearFirstDay);}else{days-=(7-yearFirstDay+1);week=Math.ceil(days/7)+1;}
return week;}},getShowNameFromFormula:function(formula){var _this=this;var inputStr=formula;var nStart=inputStr.indexOf('<%');var nEnd=inputStr.indexOf('%>');if(-1==nStart||-1==nEnd){return inputStr;}
var id=inputStr.substring(nStart+2,nEnd);if(''==id){return _this.getShowNameFromFormula(inputStr);}
var retVal=_this.getDSItemById(id);if(null==retVal){return _this.getShowNameFromFormula(inputStr);}
inputStr=inputStr.replace('<%'+id+'%>',retVal.value);return _this.getShowNameFromFormula(inputStr);},addNewGroup:function(){var groupName=$('#inputAddGroup').val();if(''==groupName){return;}
var _this=this;var postData={'groupId':'','name':groupName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if('successful'!=data.error){return;}
var groupId=data.groupId;if(groupId){if(_this.treeObj){var nodeUnassigned=_this.treeObj.getNodesByParam('name','unassigned',null);var index=-1;if(nodeUnassigned.length>0){index=_this.treeObj.getNodeIndex(nodeUnassigned[0]);}
_this.treeObj.addNodes(null,index,{id:data.groupId,pId:data.parentId,name:data.groupName,isParent:true});}}
$('#inputAddGroup').val('');$('#inputAddGroup').blur();}).fail(function(result){}).always(function(e){});}}
return DataSource;})();