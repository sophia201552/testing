;(function(exports,tabsPackage){var DEFAULTS={modules:[{'title':'Template',data:['Report','Page','Layer','Widget','Image']},{'title':'Other',data:['Recycle']}]};function Template(container,options){this.container=container;this.options=$.extend(false,{},DEFAULTS,options);this.leftCtn=null;this.rightCtn=null;this.tabs={};this.activeTabIns=null;}
+function(){this.show=function(){var _this=this;this._getHtml().done(function(){_this._initTabs();_this._attachEvents();});};this._getHtml=function(){var _this=this;return WebAPI.get('/static/app/WebFactory/scripts/components/template/template.html').then(function(html){_this.container.innerHTML=html;_this.leftCtn=_this.container.querySelector('#templateLeft');_this.rightCtn=_this.container.querySelector('#templateRight');});};this._attachEvents=function(){var _this=this;var $divTab=$('.divTab',this.leftCtn);$divTab.off('click').on('click',function(){var $this=$(this);$divTab.removeClass('divCheck');$this.addClass('divCheck');$this.parent().siblings().find('.treeTemplate').hide();var currentTreeTemplate=$this.next('.treeTemplate');if(currentTreeTemplate.css('display')==='none'){currentTreeTemplate.show();}else{currentTreeTemplate.hide();}
_this._showTab($(this).parent('.tab-item')[0].dataset.type);});};this._initTabs=function(){var _this=this;var tabs=this.options.modules;var domContainer=this.rightCtn.querySelector('#tabContent');tabs.forEach(function(item){var arrHtml=[];item.data.forEach(function(row){var clazz,ins;var arr,type,options;if(typeof row==='object'){type=row.type;options=row.options;}else{type=row;}
type=type.substr(0,1).toUpperCase()+type.substr(1);arr=type.split('.');clazz=tabsPackage[arr[0]+'Tab'];if(!clazz){Log.warn('template tab type not supportted: '+type);return;}
ins=new clazz(_this,domContainer,$.extend(false,$.extend(false,_this.options.tabOptions,options)));_this.tabs[type]=ins;arrHtml.push('<li class="tab-item" data-type="'+type+'">'+ins.tabOptions.title+'</li>');});_this.leftCtn.querySelector('#ul'+item.title+'Tabs').innerHTML=arrHtml.join('');$(_this.leftCtn).find('#div'+item.title).show();});this._showTab(Object.keys(this.tabs)[0]);};this._showTab=function(type){var _this=this;var ins=this.tabs[type];var $tabItems;if(!ins){Log.warn('the tab with type \''+type+'\' is not a valiable TabClass.');return;}
$tabItems=$('.tab-item',this.leftCtn);$tabItems.find('.divTab').removeClass('divCheck');$tabItems.filter('[data-type="'+type+'"]').find('.divTab').addClass('divCheck');this.activeTabIns&&this.activeTabIns.hide();this.activeTabIns=ins;ins.list=[];ins.show();};this.close=function(){var _this=this;Object.keys(this.tabs).forEach(function(row){var tab=_this.tabs[row];tab.close();});this.container.innerHTML='';this.container.parentNode.removeChild(this.container);this.container=this.leftCtn=this.rightCtn=null;typeof this.options.onClose==='function'&&this.options.onClose();};}.call(Template.prototype);exports.Template=Template;}(namespace('factory.components.template'),namespace('factory.components.template.tabs')));;(function(exports){function Tab(screen,container,options){this.container=container;this.domWrap=this.container.parentNode.parentNode;this.$domCache=null;this.screen=screen;this.options=options;this.toolCtn=null;this.itemCtn=null;this.store=null;this.search={};this.list=[];this.treeObj=null;}
+function(){this.tabOptions={title:'',toolsTpl:'',itemTpl:'',dataUrl:''};this.format2VO=function(data){return data;};this.show=function(fromCache){var _this=this;fromCache=false;if(fromCache&&this.$domCache){this.$domCache.appendTo(_this.container);return;}
this.getData().done(function(){_this.treeTemplate();_this.render();_this.commonEvents();_this.attachEvents();});};this.getData=function(){var _this=this;var url=this.tabOptions.dataUrl;if(typeof url==='function'){url=url.call(this);}
return WebAPI.get(url).then(function(rs){_this.store=rs.data;});};this.treeTemplate=function(){var zSetting={view:{showIcon:false,showLine:false,fontCss:{color:"#ffffff"}},edit:{enable:true,editNameSelectAll:true,showRenameBtn:false,showRemoveBtn:false},data:{keep:{leaf:true,parent:true},simpleData:{enable:true,idKey:'id',pIdKey:'pId',rootPId:''}},callback:{onClick:zTreeOnClick,onDrop:zTreeOnDrop,onNodeCreated:zTreeOnNodeCreated,beforeExpand:zTreeBeforeExpand,onExpand:zTreeOnExpand}};var zProjNodes=this.generateTreeEx(this.store);var obj=$(this.screen.leftCtn).find('#tree'+$('.divCheck',this.screen.leftCtn).parent('.tab-item').attr('data-type')+'Template');this.treeObj=$.fn.zTree.init(obj,zSetting,zProjNodes);var _this=this;function zTreeOnClick(event,treeId,treeNode){var leftCtn=$(_this.screen.leftCtn);var rightCtn=$(_this.screen.rightCtn);if(!$.isEmptyObject(_this.screen.activeTabIns.search)&&rightCtn.find('.spanSearch').find('.glyphicon-remove').css('display')!='none'){rightCtn.find('.spanSearch').click();}
if(event.ctrlKey){leftCtn.find('#'+treeNode.tId+'_a').addClass('treeNodeCheck');}else{leftCtn.find('.treeNodeCheck').removeClass('treeNodeCheck');leftCtn.find('#'+treeNode.tId+'_a').addClass('treeNodeCheck');}
if(treeNode.isParent){var upGroupData={_id:'...',group:treeNode.id,parentGroupId:treeNode.pId,type:treeNode.type};var list=_this.getList(treeNode,[treeNode.id]);_this.list=list;WebAPI.get('/factory/material/group/'+treeNode.type+'/'+treeNode.id).done(function(result){if(!treeNode.children){var newNodes=_this.generateTreeEx(result.data);_this.treeObj.addNodes(treeNode,newNodes,true);}
_this.downFolder(result,upGroupData);});}}
function zTreeOnDrop(event,treeId,treeNodes,targetNode,moveType){var $current=$(event.target);var $curTreeNode=treeNodes[0];var $panelBody=$('#tabContent',_this.domWrap);var params,targetItem,$curItem;var notDrog=false;if($current.hasClass('group-item')||$current.closest('.group-item').length>0){$curItem=$current.hasClass('group-item')?$current:$current.closest('.group-item');if($curItem.attr('id')===$curTreeNode.id)return;targetItem=_this.treeObj.getNodeByParam('id',$curItem.attr('id'));notDrog=_this.isChildren(targetItem,$curTreeNode,notDrog);if(notDrog){alert('目标文件夹是拖拽文件夹的子元素！');return;}
$curTreeNode.pId=$curItem.attr('id');_this.treeObj.updateNode($curTreeNode);params={_id:treeNodes[0].id,group:$curItem.attr('id')};_this.treeObj.moveNode(targetItem,$curTreeNode,'inner');$('#'+$curTreeNode.id).remove();}else if($current.hasClass('upGroup')||$current.closest('.upGroup').length>0){$curItem=$current.hasClass('upGroup')?$current:$current.closest('.upGroup');if($curItem.attr('data-parent-group-id')===$curTreeNode.pId)return;targetItem=_this.treeObj.getNodeByParam('id',$curItem.attr('data-groupid'));notDrog=_this.isChildren(targetItem,$curTreeNode,notDrog);if(notDrog){alert('目标文件夹是拖拽文件夹的子元素！');return;}
$curTreeNode.pId=$curItem.attr('data-parent-group-id');_this.treeObj.updateNode($curTreeNode);params={_id:treeNodes[0].id,group:$curItem.attr('data-parent-group-id')};_this.treeObj.moveNode(targetItem.getParentNode(),$curTreeNode,'inner');$('#'+$curTreeNode.id).remove();}else if($current.attr('id')==='tabContent'){if($panelBody.find('.upGroup').length>0){var $upGroup=$panelBody.find('.upGroup');if($upGroup.attr('data-groupid')===treeNodes[0].pId)return;targetItem=_this.treeObj.getNodeByParam('id',$upGroup.attr('data-groupid'));notDrog=_this.isChildren(targetItem,$curTreeNode,notDrog);if(notDrog){alert('目标文件夹是拖拽文件夹的子元素！');return;}
params={_id:treeNodes[0].id,group:$upGroup.attr('data-groupid')};}else{if(treeNodes[0].pId==='')return;targetItem=null;params={_id:treeNodes[0].id,group:''};}
var data={_id:treeNodes[0].id,name:treeNodes[0].name,group:params.group,creator:treeNodes[0].creator,time:treeNodes[0].time,type:treeNodes[0].type};var $item=$(_this.groupItemGroup.formatEL(data));$panelBody.append($item);_this.treeObj.moveNode(targetItem,$curTreeNode,'inner');}else if($current.closest('.ztree').length>0){if(!targetNode)return;var pageGroupId=$panelBody.find('.upGroup').length>0?$panelBody.find('.upGroup').attr('data-groupid'):'';if(moveType==='inner'){params={_id:treeNodes[0].id,group:targetNode.id};$('#'+treeNodes[0].id).remove();if(pageGroupId===targetNode.id){$panelBody.append($(_this.groupItemGroup.formatEL({_id:treeNodes[0].id,name:treeNodes[0].name,group:params.group,creator:treeNodes[0].creator,time:treeNodes[0].time,type:treeNodes[0].type})))}}else{params={_id:treeNodes[0].id,group:targetNode.pId};$('#'+treeNodes[0].id).remove();if(pageGroupId===targetNode.pId){$panelBody.append($(_this.groupItemGroup.formatEL({_id:treeNodes[0].id,name:treeNodes[0].name,group:params.group,creator:treeNodes[0].creator,time:treeNodes[0].time,type:treeNodes[0].type})))}}}else{return;}
WebAPI.post('/factory/material/edit',params).done(function(result){});}
function zTreeOnNodeCreated(event,treeId,treeNode){$('#'+treeNode.tId+'_switch').prependTo($('#'+treeNode.tId+'_a'));}
function zTreeBeforeExpand(treeId,treeNode){_this.treeObj.removeChildNodes(treeNode);}
function zTreeOnExpand(event,treeId,treeNode){WebAPI.get('/factory/material/group/'+treeNode.type+'/'+treeNode.id).done(function(result){var newNodes=_this.generateTreeEx(result.data);_this.treeObj.addNodes(treeNode,newNodes);})}};this.generateTreeEx=function(data){var result=[];var params;for(var i=0,len=data.length;i<len;i++){var item=data[i];params={id:item._id,pId:item.group,name:item.name,type:item.type,time:item.time,creator:item.creator};if(item.isFolder===1){params.isParent=true;result.push(params);}}
return result;};this.isChildren=function(targetNode,parentNode,notDrog){var _this=this;if(targetNode.getParentNode()){if(targetNode.getParentNode().id===parentNode.id){notDrog=true;return notDrog;}else{return _this.isChildren(targetNode.getParentNode(),parentNode,notDrog);}}};this.getList=function(treeNode,arr){var _this=this;if(treeNode.getParentNode()){arr.unshift(treeNode.getParentNode().id);return _this.getList(treeNode.getParentNode(),arr);}else{return arr;}};this.render=function(){this.renderTools();this.renderItems(this.store);};this.renderTools=function(){$('#tabName',this.domWrap).empty().append(this.tabOptions.toolsTpl);};this.renderItems=function(data){var _this=this;var arrHtml=[];if(data){data.forEach(function(row){var rowData=_this.format2VO(row);if(!rowData.isFolder){rowData.isFolder=0;}
rowData['creator']=rowData.creator?rowData.creator:'未知';if(rowData.isFolder===0){if(_this.screen.options.showTemplateType&&_this.screen.options.showTemplateType.length>0){_this.screen.options.showTemplateType.forEach(function(row){var rowDataType;if(rowData.type.split('.')[1]){rowDataType=rowData.type.split('.')[1];}else{if(rowData.type==='page'){rowDataType="PageScreen";}}
if(rowDataType.toLowerCase()===row.toLowerCase()){arrHtml.push(_this.tabOptions.itemTpl.formatEL(rowData));}})}else{arrHtml.push(_this.tabOptions.itemTpl.formatEL(rowData));}}else{arrHtml.push(_this.groupItemGroup.formatEL(rowData));}});}
this.container.innerHTML=arrHtml.join('');this.store=data;this.initTooltip();};this.initTooltip=function(){var $tabContent=$('#tabContent',this.domWrap);$tabContent.find(".tpl-item:not('.group-item ')").each(function(){var $tplItemHover=$(this);if($tplItemHover.hasClass('upGroup'))return;var id=$tplItemHover.attr('id');var creator=$tplItemHover.attr('data-creator')?$tplItemHover.attr('data-creator'):$tplItemHover.find('.pageCreator span.pageText').html();var materialType=$tplItemHover.attr('data-type');function showInfo(materialInfo,userName){var contentInfo='';var contentTime=materialInfo.time?materialInfo.time:'未知';var contentName=materialInfo.name?materialInfo.name:'未知';var materialType=materialInfo.type?materialInfo.type:'未知';var nameTime='<div class="col-xs-6 item-nameF">创建人:</div><div class="item-name col-xs-6" title="'+userName+'">'+userName+'</div>'+'<div class="col-xs-6 item-nameF">创建时间:</div><div class="col-xs-6 item-name" title="'+contentTime+'">'+contentTime+'</div>';contentInfo+='<div class="col-xs-6 item-nameF">名称:</div><div class="col-xs-6 item-name" title="'+contentName+'">'+contentName+'</div>';if(materialType.indexOf('image')>=0){var contentW=materialInfo.content?materialInfo.content.w:'xx';var contentH=materialInfo.content?materialInfo.content.h:'xx';var contentIterval=materialInfo.content?materialInfo.content.interval:'';contentInfo+='<div class="col-xs-6 item-nameF">大小:</div><div class="col-xs-6 item-name" title="'+contentW+'*'+contentH+'">'+contentW+'*'+contentH+'</div>';if(contentIterval&&parseInt(contentIterval)!==0){contentInfo+='<div class="col-xs-6 item-nameF">速度:</div><div class="col-xs-6 item-name" title="一秒'+(1000/parseInt(contentIterval)).toFixed(2)+'帧">一秒'+(1000/parseInt(contentIterval)).toFixed(2)+'帧</div>';contentInfo+=nameTime;contentInfo+='<div class="col-xs-12 itemAnimation"><div class="displayAnamition"></div></div>';}else{contentInfo+=nameTime;}}else if(materialType.indexOf('page')>=0){var pageType='';if(materialType==='page'||materialType==='page.PageScreen'){pageType='page';}else if(materialType==='page.EnergyScreen'){pageType='Dashboard';}else if(materialType==='page.ReportScreen'){pageType='Report';}else{pageType='未知';}
contentInfo+='<div class="col-xs-6 item-nameF">类型:</div><div class="col-xs-6 item-name" title="'+pageType+'">'+pageType+'</div>';contentInfo+=nameTime;}else if(materialType.indexOf('widget')>=0){var widgetType='';if(materialType==='widget'||materialType==='widget.HtmlContainer'){widgetType='Html Container';}else if(materialType==='widget.HtmlText'){widgetType='Html Text';}else if(materialType==='widget.HtmlButton'){widgetType='Html Button';}else{widgetType='未知';}
contentInfo+='<div class="col-xs-6 item-nameF">类型:</div><div class="col-xs-6 item-name" title="'+widgetType+'">'+widgetType+'</div>';contentInfo+=nameTime;}else{contentInfo+=nameTime;}
return contentInfo;}
var tooltipTemplate='<div class="tooltip tplItemTooltip" role="tooltip">'+'<div class="tooltip-arrow"></div>'+'<div class="tooltipContent clearfix">'+'</div>'+'</div>';var options={placement:'auto right',title:'预览',delay:{show:1500,hide:200},template:tooltipTemplate};$tplItemHover.tooltip(options);$tplItemHover.trigger('hover');$tplItemHover.on('shown.bs.tooltip',function(){var animation;var postData={userId:creator,id:id};WebAPI.post('/factory/material/showInfo',postData).done(function(result){var tooltipContent=showInfo(result.materialInfo,result.userName)
$tabContent.find('.tooltipContent').html('').append(tooltipContent);if($tplItemHover.hasClass('photoItem')){var w=$tplItemHover.find(".bgImg").width();var h=$tplItemHover.find(".bgImg").height();var img=$tplItemHover.find(".bgImg").css('backgroundImage');var interval=Number($tplItemHover.find(".bgImg").attr("data_interval"));var pf=Number($tplItemHover.find(".bgImg").attr("data_pf"));$tabContent.find(".itemAnimation .displayAnamition").width(w);$tabContent.find(".itemAnimation .displayAnamition").height(h);$tabContent.find(".itemAnimation .displayAnamition").css('backgroundImage',img);if(interval!==0){animation=setInterval(autoplay,interval);var i=0;function autoplay(){if(i===pf){i=-1;}
i=i+1;var position=-w*i;if(position<-w*(pf-1)){autoplay()}else{$tabContent.find(".itemAnimation .displayAnamition").css("background-position",position+"px");}}}}
$tplItemHover.mouseleave(function(){var interval=Number($tplItemHover.find(".bgImg").attr("data_interval"));if(interval!==0){$tabContent.find(".itemAnimation .displayAnamition").css("background-position","0");clearInterval(animation);}});})})})};this.commonEvents=function(){var _this=this;var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);var $templateTabs=$('#templateTabs',this.domWrap);_this.initTooltip();$tabName.find('.spanSearch').off().on('click',function(){if($(this).find('.glyphicon-search').css('display')!='none'){var searchVal=$(this).prev('input').val();if(searchVal===''){alert(' Please enter search keyword！');return;}
var data={name:searchVal};WebAPI.post('/factory/material/search',data).done(function(result){_this.searchRenderItems(result.data);}).always(function(){$tabName.find('.addTempate').hide();$tabName.find('.addGroup').hide();$tabName.find('.spanSearch').find('.glyphicon-search').hide();$tabName.find('.spanSearch').find('.glyphicon-remove').show();})}else{if(_this.search.list.length===0){$(_this.container).empty();_this.renderItems(_this.search.store);}else{var upGroupData={_id:'...',group:_this.search.list[_this.search.list.length-1],parentGroupId:_this.search.list.length-2>0?_this.search.list[_this.search.list.length-2]:'',type:$templateTabs.find('.divCheck').parent('.tab-item').attr('data-type').toLowerCase()};_this.downFolder({data:_this.search.store},upGroupData);}
_this.search={};$tabName.find('.iptSearch').val('');$tabName.find('.addTempate').show();$tabName.find('.addGroup').show();$tabName.find('.divEdit').hide();$tabName.find('.divBatchApply').hide();$tabName.find('.spanSearch').find('.glyphicon-search').show();$tabName.find('.spanSearch').find('.glyphicon-remove').hide();}});$tabName.find('.iptSearch').off().on('keyup',function(e){if(e.which===13){$tabName.find('.spanSearch').click();}});var start=null;$tabContent.off('click',".tpl-item:not('.upGroup ')").on('click',".tpl-item:not('.upGroup ')",function(e){var e=e||window.event;e.stopPropagation();e.preventDefault();var $target=$(e.currentTarget);var allPageBox=$tabContent.children('.tpl-item');if(e.ctrlKey){if(!e.shiftKey){if($target.hasClass('active')){$target.removeClass('active');}else{$target.addClass('active');}
start=this;}else{var startIndex=$(start).index(),lastIndex=$target.index();var selPageBox=allPageBox.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);if($(start).hasClass('active')){selPageBox.addClass('active');}else{selPageBox.removeClass('active');}}}else if(e.shiftKey){if($tabContent.find('.active').length!==0){var startIndex=$(start).index(),lastIndex=$target.index();var selPageBox=allPageBox.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);selPageBox.addClass('active');allPageBox.not(selPageBox).removeClass('active');}else{$target.addClass('active');}}else{allPageBox.removeClass('active');$target.addClass('active');start=this;}
_this.toolsTpl();});$tabName.find('.divDelete').off('click').on('click',function(){var $active;var type=$templateTabs.find('.divCheck').parent('.tab-item').attr('data-type').toLowerCase();$active=$tabContent.find('.active');if($active.length<=0){alert('Please choose Template!');return;}
if(typeof _this.permission($active)==='object'){var pubMateId=_this.permission($active);confirm('Sure to delete the template!',function(){WebAPI.post('/factory/material/remove',pubMateId).done(function(result){if(result.status==='OK'){$active.remove();if(type!='report'){$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();$tabName.find('.divBatchApply').hide();}
var data=[];pubMateId.ids.forEach(function(row){data.push(_this.treeObj.getNodeByParam('id',row));});data.forEach(function(row){_this.treeObj.removeNode(row);});alert('Deleted Successfully!');}});})}else{alert(_this.permission($active));}});};this.permission=function(data){var pubMateId={'ids':[]};var userName=[];var _this=this;data.each(function(){pubMateId.ids.push($(this).attr('data-id'));for(var i=0,len=_this.store.length;i<len;i++){if(_this.store[i]._id===$(this).attr('data-id')){if(!_this.store[i].creator){_this.store[i].creator='admin';}
if(userName.indexOf(_this.store[i].creator)<0){userName.push(_this.store[i].creator);}}}});if(AppConfig.userProfile.fullname==='admin'){return pubMateId;}else{if(userName.length>0){var noPermission=[];userName.forEach(function(row){if(!isNaN(parseInt(row))){if(AppConfig.userId!=row){noPermission.push(row);}}else{if(row.split('@').length>1){if(AppConfig.userProfile.email!=row){noPermission.push(row);}}else{if(AppConfig.userProfile.fullname!=row){noPermission.push(row);}}}});if(noPermission.length>0){return'选择模板中含有不是自己创建的！';}else{return pubMateId;}}else{return'只有admin权限才可以进行操作!';}}};this.searchRenderItems=function(data){var _this=this;if(data){var type=$('#templateTabs',this.domWrap).find('.divCheck').parent('.tab-item').attr('data-type');var searchData=[];data.forEach(function(row){if(row.type&&row.type.toLowerCase().indexOf(type.toLowerCase())>-1){row.group='';searchData.push(row);}});_this.search.data=searchData;_this.search.store=_this.store.slice();_this.search.list=_this.list.slice();_this.search.searchList=[];$(_this.container).empty();if(searchData.length>0){_this.renderItems(_this.search.data);_this.attachEvents();}}else{$(_this.container).empty();}};this.drag=function(){var _this=this;var _start=function(e){var ev=e||window.event;var $tabContent=$('#tabContent',_this.domWrap);var dataTransfer=ev.originalEvent.dataTransfer;var idArr=[],groupIdArr=[];if($tabContent.find('.active').length===1){idArr.push(this.dataset.id);}else if($tabContent.find('.active').length>1){$tabContent.find('.active').each(function(){idArr.push(this.dataset.id);});}else{idArr.push(this.dataset.id);}
dataTransfer.setData('id',idArr);};var _end=function(e){$(this).parents().children().find('.tpl-item').removeClass('hove');};var _over=function(e){var ev=e||window.event;ev.preventDefault();};var _enter=function(e){$(this).addClass('hove');e.preventDefault();};var _drop=function(e){var $this=$(this);$this.addClass('act');var ev=e||window.event;var dataTransfer=ev.originalEvent.dataTransfer;var idArr=dataTransfer.getData('id').split(',');var curTreeNode=_this.treeObj.getNodeByParam('id',$this.attr('id'));var elTarget=[];for(var i=0,len=idArr.length;i<len;i++){if(this.dataset.id===idArr[i]){$this.removeClass('act');return;}
elTarget.push($('.tpl-item[data-id="'+idArr[i]+'"]',_this.container)[0]);}
if(elTarget.length>0){var r=0;for(var j=0,len=elTarget.length;j<len;j++){var params={};params={_id:elTarget[j].dataset.id};if(this.dataset.id==='...'){params['group']=this.dataset.parentGroupId||'';}else{params['group']=this.dataset.id||'';}
WebAPI.post('/factory/material/edit',params).done(function(){if($(elTarget[r]).hasClass('group-item')){var treeNode=_this.treeObj.getNodeByParam('id',$(elTarget[r]).attr('id'));if(treeNode){treeNode.pId=params.group;_this.treeObj.updateNode(treeNode);_this.treeObj.moveNode(curTreeNode,treeNode,'inner');}}
r++;if(r===elTarget.length){elTarget.forEach(function(row){$(row).remove();})}});}}};var _leave=function(e){$(this).removeClass('hove');e.preventDefault();};return{start:_start,end:_end,over:_over,enter:_enter,drop:_drop,leave:_leave}};this.drog=function(){var _this=this;var _over=function(e){e.preventDefault();};var _enter=function(e){$(this).addClass('drog');e.preventDefault();};var _drop=function(e){var $this=$(this);$this.removeClass('drog');var ev=e||window.event;var dataTransfer=ev.originalEvent.dataTransfer;var idArr=dataTransfer.getData('id').split(',');var curTreeNode=_this.treeObj.getNodeByTId($this.parent().attr('id'));var r=0;var notDrog;idArr.forEach(function(row){if(row===curTreeNode.id){notDrog=true;}else{var item=_this.treeObj.getNodeByParam('id',row);if(item){notDrog=_this.isChildren(curTreeNode,item,notDrog);}}
if(notDrog)return;});if(notDrog){alert('目标文件夹是拖拽文件夹的子元素！');return;}
idArr.forEach(function(row){var params={_id:row,group:curTreeNode.id};WebAPI.post('/factory/material/edit',params).done(function(){r++;var treeNode=_this.treeObj.getNodeByParam('id',row);if(treeNode){treeNode.pId=params.group;_this.treeObj.updateNode(treeNode);_this.treeObj.moveNode(curTreeNode,treeNode,'inner');}
if(r===idArr.length){idArr.forEach(function(item){$('#'+item).remove();});}});})};var _leave=function(e){$(this).removeClass('drog');e.preventDefault();};var _end=function(){};return{over:_over,enter:_enter,drop:_drop,leave:_leave,end:_end}};this.attachEvents=function(){var _this=this;var $itemCtn=$('#tabContent',this.container);$itemCtn.off();$itemCtn.on('click','.tpl-item',function(e){_this.onItemClickActionPerformed(e);});$itemCtn.on('click','.tpl-item .slider-cb',function(e){_this.onItemChangeActionPerformed(e);});};this.toolsTpl=function(){var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);var $templateTabs=$('#templateTabs',this.domWrap);var type=$templateTabs.find('.divCheck').parent('.tab-item').attr('data-type');if($tabContent.find('.active').length===0){$tabName.find('.divEdit').hide();$tabName.find('.divBatchApply').hide();$tabName.find('.divDelete').hide();}else if($tabContent.find('.active').length===1){if($tabContent.find('.active').hasClass('group-item')){$tabName.find('.divEdit').hide();$tabName.find('.divBatchApply').hide();$tabName.find('.divDelete').show();}else{$tabName.find('.divEdit').show();$tabName.find('.divBatchApply').show();$tabName.find('.divDelete').show();}}else{if(type==='Image'){$tabName.find('.divEdit').show();$tabName.find('.divDelete').show();$tabContent.find('.active').each(function(){if($(this).hasClass('group-item')){$tabName.find('.divEdit').hide();}})}else{$tabName.find('.divEdit').hide();$tabName.find('.divBatchApply').hide();$tabName.find('.divDelete').show();}}
if($('#materialModal').length<1){$tabName.find('.divBatchApply').hide();}};this.onItemClickActionPerformed=function(){throw new Error('"onItemClickActionPerformed" method need to be instantiate!');};this.onItemChangeActionPerformed=function(){throw new Error('"onItemChangeActionPerformed" method need to be instantiate!');};this.hide=function(){$(this.container).off('click dblclick','.tpl-item');this.container.innerHTML='';this.treeObj=null;$(this.screen.leftCtn).find('.treeTemplate').empty();};this.close=function(){if(this.$domCache){this.$domCache.remove();this.$domCache=null;}
this.store=null;this.search=null;this.list=null;this.treeObj=null;this.container.innerHTML='';};}.call(Tab.prototype);exports.Tab=Tab;}(namespace('factory.components.template.tabs')));;(function(exports,SuperClass){var clickTimer=null;var CLICK_DELAY=500;function LayerTab(){SuperClass.apply(this,arguments);}
LayerTab.prototype=Object.create(SuperClass.prototype);LayerTab.prototype.constructor=LayerTab;+function(){this.groupItemGroup='<div class="tpl-item group-item pageBox" draggable="true" id="{_id}" data-id="{_id}" data-type="layer" data-groupid ="{group}">\
        <div class="pageName"><span class="glyphicon glyphicon-folder-open"></span><span class="item-name">{name}</span></div>\
        <div class="pageCreator"><span class="pageText">{creator}</span></div>\
        <div class="pageTime"><span class="pageText">{time}</span></div>\
                            <span class="slider-cb-wrap"><i class="slider-cb"></i></span></div>';this.upGroup='<div class="tpl-item upGroup pageBox" data-type="{type}" data-id="{_id}" data-groupid ="{group}" data-parent-group-id="{parentGroupId}"><span class="glyphicon glyphicon-chevron-left"></span>\
        <span class="group-item-name" title="...">...</span></div>';this.tabOptions={title:'<div class="divTab"><span class="glyphicon glyphicon-education"></span>Layer</div><ul id="treeLayerTemplate" class="ztree treeTemplate" style="display: none;"></ul>',itemTpl:'<div class="child-item tpl-item pageBox" draggable="true" id="{_id}" data-type="layer" data-id="{_id}" data-groupid ="{group}">\
                            <div class="pageName"><span class="glyphicon glyphicon-file"></span><span class="item-name">{name}</span></div>\
                            <div class="pageBody"><div class="pageCreator"><span class="pageText">{creator}</span></div>\
                            <div class="pageTime"><span class="pageText">{time}</span></div>\
                            <span class="slider-cb-wrap"><i class="slider-cb"></i></span></div></div>',toolsTpl:'<div class="paneTempButton">\
                    <div class="addTempate" title="Add Layer"><span class="glyphicon glyphicon-file"></span></div>\
                    <div class="addGroup" title="Add Folder"><span class="glyphicon glyphicon-folder-open"></span></div>\
                    <div class="divEdit" title="Edit" style="display:none;"><span class="glyphicon glyphicon-edit"></span></div>\
                    <div class="divDelete" title="Remove" style="display: none;"><span class="glyphicon glyphicon-trash"></span></div>\
                    <div class="col-sm-4 divSearch"><div class="input-group"><input type="text" class="form-control iptSearch" placeholder="Search for name!"><span class="spanSearch"><span class="glyphicon glyphicon-search" aria-hidden="true"></span><span class="glyphicon glyphicon-remove" aria-hidden="true" style="display:none;"></span></span></div></div>\
                </div>',dataUrl:'/factory/material/group/layer'};this.attachEvents=function(){var _this=this;var $tabContent=$('#tabContent',this.domWrap);var $templateLeft=$('#templateLeft',this.domWrap);$tabContent.off('dblclick','.group-item').on('dblclick','.group-item',function(){_this.slider(this);});$tabContent.off('dragstart','.tpl-item').on('dragstart','.tpl-item',_this.drag().start);$tabContent.off('dragend','.tpl-item').on('dragend','.tpl-item',_this.drag().end);$tabContent.off('dragover','.tpl-item.group-item,.tpl-item.upGroup').on('dragover','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().over);$templateLeft.off('dragover','#treeLayerTemplate li a').on('dragover','#treeLayerTemplate li a',_this.drog().over);$tabContent.off('dragenter','.tpl-item.group-item,.tpl-item.upGroup').on('dragenter','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().enter);$templateLeft.off('dragenter','#treeLayerTemplate li a').on('dragenter','#treeLayerTemplate li a',_this.drog().enter);$tabContent.off('dragleave','.tpl-item').on('dragleave','.tpl-item',_this.drag().leave);$templateLeft.off('dragleave','#treeLayerTemplate li a').on('dragleave','#treeLayerTemplate li a',_this.drog().leave);$tabContent.off('drop','.tpl-item.group-item,.tpl-item.upGroup').on('drop','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().drop);$templateLeft.off('drop','#treeLayerTemplate li a').on('drop','#treeLayerTemplate li a',_this.drog().drop);$tabContent.off('click','.pageBox .pageName').on('click','.pageBox .pageName',function(e){var $this=$(this);var ipt;var $item=$this.parent('.tpl-item');if(!$item.hasClass('active')){clickTimer=window.setTimeout(function(){window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);return;}
if(clickTimer){window.clearTimeout(clickTimer);clickTimer=null;if($item.hasClass('group-item')){_this.slider($item[0]);}
else{_this.editLayerBox();}
return;}
if($item.attr('id')!=''){if(typeof _this.permission($item)==='string'){alert(_this.permission($item));return;}}
clickTimer=window.setTimeout(function(){var $spName=$this.find('.item-name');ipt=document.createElement('input');ipt.className='ipt-name-editor';ipt.value=$spName.text();ipt.onblur=function(){$tabContent.on('dblclick','.group-item',function(){_this.slider(this);});$tabContent.find('.tpl-item').prop('draggable',true);var params={};if(this.value!==$spName.text()||!$this.closest('.pageBox')[0].dataset.id){params={_id:$this.closest('.pageBox')[0].dataset.id,name:this.value,type:'layer'};_this.modifyGroupItem(params);$this.closest('.pageBox').attr('id',params._id);$this.closest('.pageBox')[0].dataset.id=params._id;$this.closest('.pageBox')[0].dataset.groupid=params.group;}
$spName.text(this.value);this.parentNode.removeChild(this);$spName.show();};ipt.onkeyup=function(e){if(e.which===13){this.blur();}};ipt.onclick=function(e){e.stopPropagation();};$spName.hide();$this.append(ipt);ipt.onfocus=function(){$tabContent.off('dblclick','.group-item');$tabContent.find('.tpl-item').prop('draggable',false);};ipt.focus();window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);});$tabContent.off('dblclick','.pageBody').on('dblclick','.pageBody',function(){_this.editLayerBox();});if(this.options.allowUse){$tabContent.off('click','.pageBox .pageName');$tabContent.off('dblclick','.pageBody');$tabContent.off('dblclick','.child-item').on('dblclick','.child-item',function(e){var id=this.dataset.id;var data={ids:[id]};WebAPI.post('/factory/material/getByIds',data).done(function(result){typeof _this.options.callback==='function'&&_this.options.callback(result[0]);})
_this.screen.close();});}
this.attachToolEvents();};this.attachToolEvents=function(){var _this=this;var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);$tabName.find('.addTempate').off('click').click(function(){var $widgitNameModal=$('<div class="modal fade" id="widgitNameModal">\
                  <div class="modal-dialog">\
                    <div class="modal-content">\
                      <div class="modal-header">\
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                        <h4 class="modal-title">Layer</h4>\
                      </div>\
                      <div class="modal-body">\
                            <div class="form-group form-goupCy">\
                                <label for="widgetName" class="col-sm-2 control-label">Name:</label>\
                                <div class="col-sm-10">\
                                    <input type="text" class="form-control" id="widgetName" placeholder="Please input template name">\
                                </div>\
                            </div>\
                      </div>\
                      <div class="modal-footer">\
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>\
                        <button type="button" class="btn btn-primary" id="nameSub">Ok</button>\
                      </div>\
                    </div>\
                  </div>\
                </div>');$('#widgitNameModal').remove();$(document.body).append($widgitNameModal);I18n.fillArea($widgitNameModal);$widgitNameModal.modal('show');$('#nameSub').on('click',function(){var widgetName=$('#widgetName').val();if(widgetName===''){alert('Please input template name!');}else{$widgitNameModal.modal('hide');var _id=ObjectId();var data={_id:_id,layerId:ObjectId(),name:widgetName,content:{},creator:AppConfig.userProfile.fullname,time:new Date().format('yyyy-MM-dd HH:mm:ss'),group:$('.upGroup',this.container).length===0?'':$('.upGroup',this.container)[0].dataset.groupid,isFolder:0,'public':1,type:'layer'};$tabContent.append($(_this.tabOptions.itemTpl.formatEL(data)));WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);var content='{}';EditorModal.show(content,false,function(newContent){try{content=JSON.parse(newContent);}catch(e){alert('Format Error!');return true;}
if(content){if($('#materialModal').length===0){id=$('#tabContent',this.domWrap).children('.pageBox:last').attr('id');}else{id=$('#materialModal').find('#tabContent').children('.pageBox:last').attr('id');}
var data={_id:id,content:content}
WebAPI.post('/factory/material/edit',data).done(function(result){}).fail(function(){}).always(function(){});}});}else{alert(result.msg||'There are files with the same!');}});}});});$tabName.find('.addGroup').off('click').click(function(){_this.addGroupItem();});$tabName.find('.divEdit').off('click').on('click',function(){_this.editLayerBox();});};this.editLayerBox=function(){var _this=this;var $tabContent=$('#tabContent',this.domWrap);var $active=$tabContent.find('.active');if(typeof _this.permission($active)==='object'){var data=_this.permission($active);WebAPI.post('/factory/material/getByIds',data).done(function(result){var layer=result[0];if(layer.type==='layer'){var content=JSON.stringify(layer.content);EditorModal.show(content,false,function(newContent){try{layer.content=JSON.parse(newContent);}catch(e){alert('Format Error!');return true;}
if(layer.content){var data={_id:layer._id,content:layer.content}
WebAPI.post('/factory/material/edit',data).done(function(result){}).fail(function(){}).always(function(){});}});}})}else{alert(_this.permission($active));}};this.addGroupItem=function(data){var domItemCtn=this.domWrap.querySelector('#tabContent');var isNew=!data;if(!data){data={_id:'',name:I18n.resource.report.REPORT_SUB_NAME,group:'',creator:AppConfig.userProfile.fullname,time:new Date().format('yyyy-MM-dd HH:mm:ss')};}
var $item=$(this.groupItemGroup.formatEL(data));domItemCtn.appendChild($item[0]);if(isNew){$('.tpl-item',domItemCtn).removeClass('active');$item.addClass('active');$item.children('.pageName').trigger('click');}};this.modifyGroupItem=function(data){var _this=this;var $upGroup=$('.upGroup',this.container);if(!data._id){data._id=ObjectId();data.layerId=ObjectId();data.content={};data.group=$upGroup.length===0?'':$upGroup[0].dataset.groupid;data.isFolder=1;data.creator=AppConfig.userProfile.fullname;data.time=new Date().format('yyyy-MM-dd HH:mm:ss');data.public=1;return WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);}});}
return WebAPI.post('/factory/material/edit',data).done(function(){var treeNode=_this.treeObj.getNodeByParam('id',data._id);treeNode&&(treeNode.name=data.name);_this.treeObj.updateNode(treeNode);});};this.slider=function(current){var _this=this;var $this=$(current);var upGroupData={_id:'...',group:current.dataset.id,parentGroupId:current.dataset.groupid,type:'layer'};if(!$.isEmptyObject(_this.search)){_this.search.searchList.push($this[0].dataset.id);}else{_this.list.push($this[0].dataset.id);}
WebAPI.get('/factory/material/group/'+$this[0].dataset.type+'/'+$this[0].dataset.id).done(function(result){_this.downFolder(result,upGroupData);})};this.downFolder=function(result,upGroupData){var _this=this;var $panelBody=$('#tabContent',this.domWrap);var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();_this.store=result.data;if(!result.data){$panelBody.empty().append(_this.upGroup.formatEL(upGroupData));}else{$panelBody.empty().append(_this.upGroup.formatEL(upGroupData));var len=result.data.length;for(var i=0;i<len;i++){if(!result.data[i].isFolder){result.data[i].isFolder=0;}
if(result.data[i].isFolder===0){$panelBody.append(_this.tabOptions.itemTpl.formatEL(result.data[i]));}else{$panelBody.append(_this.groupItemGroup.formatEL(result.data[i]));}}}
$panelBody.find('.upGroup').off('dblclick').on('dblclick',function(){if(!$.isEmptyObject(_this.search)){_this.search.searchList.splice(_this.search.searchList.length-1,1);if(_this.search.searchList.length>0){WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.search.searchList[_this.search.searchList.length-1]).done(function(result){$panelBody.empty();var groupId=_this.search.searchList[_this.search.searchList-1];var upGroupData={_id:'...',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'layer'};_this.downFolder(result,upGroupData);})}else{_this.renderItems(_this.search.data);}
return;}
if(!_this.list[_this.list.length-2]){var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();_this.list.splice(_this.list.length-1,1);WebAPI.get('/factory/material/group/layer').done(function(result){_this.renderItems(result.data);});}else{WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.list[_this.list.length-2]).done(function(result){$panelBody.empty();_this.list.splice(_this.list.length-1,1);var groupId=_this.list[_this.list.length-1];var upGroupData={_id:_this.list.length>0?'...':'',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'layer'};_this.downFolder(result,upGroupData);})}})
_this.initTooltip();}}.call(LayerTab.prototype);exports.LayerTab=LayerTab;}(namespace('factory.components.template.tabs'),namespace('factory.components.template.tabs.Tab')));;(function(exports,SuperClass){var clickTimer=null;var CLICK_DELAY=500;function PageTab(){SuperClass.apply(this,arguments);}
PageTab.prototype=Object.create(SuperClass.prototype);PageTab.prototype.constructor=PageTab;+function(){this.groupItemGroup='<div class="tpl-item group-item pageBox" draggable="true" id="{_id}" data-id="{_id}" data-type="page" data-groupid ="{group}">\
        <div class="pageName"><span class="glyphicon glyphicon-folder-open"></span><span class="item-name">{name}</span></div>\
        <div class="pageCreator"><span class="pageText">{creator}</span></div>\
        <div class="pageTime"><span class="pageText">{time}</span></div>\
                            <span class="slider-cb-wrap"><i class="slider-cb"></i></span></div>';this.upGroup='<div class="tpl-item upGroup pageBox" data-type="{type}" data-id="{_id}" data-groupid ="{group}" data-parent-group-id="{parentGroupId}"><span class="glyphicon glyphicon-chevron-left"></span>\
        <span class="group-item-name" title="...">...</span></div>';this.tabOptions={title:'<div class="divTab"><span class="glyphicon glyphicon-list-alt"></span>Page</div><ul id="treePageTemplate" class="ztree treeTemplate gray-scrollbar" style="display: none;"></ul>',itemTpl:'<div class="child-item tpl-item pageBox" draggable="true" id="{_id}" data-type="page" data-id="{_id}" data-groupid ="{group}">\
                            <div class="pageName"><span class="glyphicon glyphicon-file"></span><span class="item-name">{name}</span></div>\
                            <div class="pageBody"><div class="pageCreator"><span class="pageText">{creator}</span></div>\
                            <div class="pageTime"><span class="pageText">{time}</span></div>\
                            <span class="slider-cb-wrap"><i class="slider-cb"></i></span></div></div>',toolsTpl:'<div class="paneTempButton">\
                    <div class="addTempate" title="Add Page"><span class="glyphicon glyphicon-file"></span></div>\
                    <div class="addGroup" title="Add Folder"><span class="glyphicon glyphicon-folder-open"></span></div>\
                    <div class="divBatchApply" title="Batch Apply Page" style="display:none;"><span class="glyphicon glyphicon-tags"></span></div>\
                    <div class="divEdit" title="Edit" style="display:none;"><span class="glyphicon glyphicon-edit"></span></div>\
                    <div class="divDelete" title="Remove" style="display: none;"><span class="glyphicon glyphicon-trash"></span></div>\
                    <div class="col-sm-4 divSearch"><div class="input-group"><input type="text" class="form-control iptSearch" placeholder="Search for name!"><span class="spanSearch"><span class="glyphicon glyphicon-search" aria-hidden="true"></span><span class="glyphicon glyphicon-remove" aria-hidden="true" style="display:none;"></span></span></div></div>\
                </div>',dataUrl:'/factory/material/group/page'};this.attachEvents=function(){var _this=this;var $tabContent=$('#tabContent',this.domWrap);var $templateLeft=$('#templateLeft',this.domWrap);$tabContent.off('dblclick','.group-item').on('dblclick','.group-item',function(){_this.slider(this);});$tabContent.off('dragstart','.tpl-item').on('dragstart','.tpl-item',_this.drag().start);$tabContent.off('dragend','.tpl-item').on('dragend','.tpl-item',_this.drag().end);$tabContent.off('dragover','.tpl-item.group-item,.tpl-item.upGroup').on('dragover','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().over);$templateLeft.off('dragover','#treePageTemplate li a').on('dragover','#treePageTemplate li a',_this.drog().over);$tabContent.off('dragenter','.tpl-item.group-item,.tpl-item.upGroup').on('dragenter','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().enter);$templateLeft.off('dragenter','#treePageTemplate li a').on('dragenter','#treePageTemplate li a',_this.drog().enter);$tabContent.off('dragleave','.tpl-item').on('dragleave','.tpl-item',_this.drag().leave);$templateLeft.off('dragleave','#treePageTemplate li a').on('dragleave','#treePageTemplate li a',_this.drog().leave);$tabContent.off('drop','.tpl-item.group-item,.tpl-item.upGroup').on('drop','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().drop);$templateLeft.off('drop','#treePageTemplate li a').on('drop','#treePageTemplate li a',_this.drog().drop);$tabContent.off('click','.pageBox .pageName').on('click','.pageBox .pageName',function(e){var $this=$(this);var ipt;var $item=$this.parent('.tpl-item');if(!$item.hasClass('active')){clickTimer=window.setTimeout(function(){window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);return;}
if(clickTimer){window.clearTimeout(clickTimer);clickTimer=null;if($item.hasClass('group-item')){_this.slider($item[0]);}else{_this.editPageBox();}
return;}
if($item.attr('id')!=''){if(typeof _this.permission($item)==='string'){alert(_this.permission($item));return;}}
clickTimer=window.setTimeout(function(){var $spName=$this.find('.item-name');ipt=document.createElement('input');ipt.className='ipt-name-editor';ipt.value=$spName.text();ipt.onblur=function(){$tabContent.on('dblclick','.group-item',function(){_this.slider(this);});$tabContent.find('.tpl-item').prop('draggable',true);var params={};if(this.value!==$spName.text()||!$this.closest('.pageBox')[0].dataset.id){params={_id:$this.closest('.pageBox')[0].dataset.id,name:this.value};_this.modifyGroupItem(params);$this.closest('.pageBox').attr('id',params._id);$this.closest('.pageBox')[0].dataset.id=params._id;$this.closest('.pageBox')[0].dataset.groupid=params.group;}
$spName.text(this.value);this.parentNode.removeChild(this);$spName.show();};ipt.onkeyup=function(e){if(e.which===13){this.blur();}};ipt.onclick=function(e){e.stopPropagation();};$spName.hide();$this.append(ipt);ipt.onfocus=function(){$tabContent.off('dblclick','.group-item');$tabContent.find('.tpl-item').prop('draggable',false);};ipt.focus();window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);});$tabContent.off('dblclick','.pageBody').on('dblclick','.pageBody',function(){_this.editPageBox();});if(this.options.allowUse){$tabContent.off('click','.pageBox .pageName');$tabContent.off('dblclick','.pageBody');$tabContent.off('dblclick','.child-item').on('dblclick','.child-item',function(e){var id=this.dataset.id;var data={ids:[id]};WebAPI.post('/factory/material/getByIds',data).done(function(result){if(result[0].type.indexOf('EnergyScreen')>-1||result[0].type.indexOf('ReportScreen')>-1){typeof _this.options.callback==='function'&&_this.options.callback(result[0]);}else{confirm(I18n.resource.mainPanel.materalPanel.buttonMateral.USE_COPY,function(){window.AddByTplModal.show(result[0],0,function(rs){typeof _this.options.callback==='function'&&_this.options.callback(rs,true);});},function(){window.AddByTplModal.show(result[0],0,function(rs){typeof _this.options.callback==='function'&&_this.options.callback(rs,false);});});}});_this.screen.close();});}
this.attachToolEvents();};this.attachToolEvents=function(){var _this=this;var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);var $templateTabs=$('#templateTabs',this.container);$tabName.find('.addTempate').off('click').click(function(){var $widgitNameModal=$('<div class="modal fade" id="widgitNameModal">\
                  <div class="modal-dialog">\
                    <div class="modal-content">\
                      <div class="modal-header">\
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                        <h4 class="modal-title">Page</h4>\
                      </div>\
                      <div class="modal-body">\
                            <div class="form-group form-goupCy">\
                                <label for="widgetName" class="col-sm-2 control-label">Name:</label>\
                                <div class="col-sm-10">\
                                    <input type="text" class="form-control" id="widgetName" placeholder="Please input template name">\
                                </div>\
                            </div>\
                      </div>\
                      <div class="modal-footer">\
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>\
                        <button type="button" class="btn btn-primary" id="nameSub">Ok</button>\
                      </div>\
                    </div>\
                  </div>\
                </div>');$('#widgitNameModal').remove();$(document.body).append($widgitNameModal);I18n.fillArea($widgitNameModal);$widgitNameModal.modal('show');$('#nameSub').on('click',function(){var widgetName=$('#widgetName').val();if(widgetName===''){alert('Please input template name!');}else{$widgitNameModal.modal('hide');var _id=ObjectId();var data={_id:_id,pageId:ObjectId(),name:widgetName,content:{},creator:AppConfig.userProfile.fullname,time:new Date().format('yyyy-MM-dd HH:mm:ss'),group:$('.upGroup',this.container).length===0?'':$('.upGroup',this.container)[0].dataset.groupid,isFolder:0,'public':1,type:'page.PageScreen'};$tabContent.append($(_this.tabOptions.itemTpl.formatEL(data)));WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);var content={template:'',js:''};TemplateEditorModal.show({js:"",template:'{"layers": [], "widgets": []}',variable:"{}"},function(code){try{JSON.parse(code.template);content.template=code.template;content.js=code.js;}catch(e){alert('Format Error!');return false;}
if(content){var id;if($('#materialModal').length===0){id=$('#tabContent',this.domWrap).children('.pageBox:last').attr('id');}else{id=$('#materialModal').find('#tabContent').children('.pageBox:last').attr('id');}
var data={_id:id,content:$.extend(false,content,{template:code.template,js:code.js})};WebAPI.post('/factory/material/edit',data).done(function(result){}).fail(function(){}).always(function(){});}});}else{alert(result.msg||'There are files with the same!');}});}});});$tabName.find('.addGroup').off('click').click(function(){_this.addGroupItem();});$tabName.find('.divBatchApply').off('click').on('click',function(){var $active=$(_this.container).find('.child-item.active').eq(0);var data={'ids':[$active.attr('data-id')]};WebAPI.post('/factory/material/getByIds',data).done(function(result){window.AddByTplModal.show(result[0],1,function(rs){_this.options.callback&&_this.options.callback(rs);});});_this.screen.close();});$tabName.find('.divEdit').off('click').on('click',function(){_this.editPageBox();});};this.editPageBox=function(){var _this=this;var $tabContent=$('#tabContent',this.domWrap);var $active=$tabContent.find('.active');if(typeof _this.permission($active)==='object'){var data=_this.permission($active);WebAPI.post('/factory/material/getByIds',data).done(function(result){var page=result[0];var content=page.content;if(page.type.indexOf('PageScreen')>-1||page.type.indexOf('page')>-1){TemplateEditorModal.show({js:content.js,template:typeof content.template==='string'?content.template:JSON.stringify(content.template)},function(code){try{JSON.parse(code.template);content.template=code.template;content.js=code.js;}catch(e){alert('Format Error!');return false;}
if(content){var data={_id:page._id,content:$.extend(false,content,{template:code.template,js:code.js})};WebAPI.post('/factory/material/edit',data).done(function(result){}).fail(function(){}).always(function(){});}});}})}else{alert(_this.permission($active));}};this.addGroupItem=function(data){var domItemCtn=this.domWrap.querySelector('#tabContent');var isNew=!data;if(!data){data={_id:'',name:I18n.resource.report.REPORT_SUB_NAME,group:'',creator:AppConfig.userProfile.fullname,time:new Date().format('yyyy-MM-dd HH:mm:ss')};}
var $item=$(this.groupItemGroup.formatEL(data));domItemCtn.appendChild($item[0]);if(isNew){$('.tpl-item',domItemCtn).removeClass('active');$item.addClass('active');$item.children('.pageName').trigger('click');}};this.modifyGroupItem=function(data){var _this=this;if(!data._id){data._id=ObjectId();data.pageId=ObjectId();data.type='page';data.content={};data.group=$('.upGroup',this.container).length===0?'':$('.upGroup',this.container)[0].dataset.groupid;data.isFolder=1;data.creator=AppConfig.userProfile.fullname;data.time=new Date().format('yyyy-MM-dd HH:mm:ss');data.public=1;return WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);}});}
return WebAPI.post('/factory/material/edit',data).done(function(){var treeNode=_this.treeObj.getNodeByParam('id',data._id);treeNode&&(treeNode.name=data.name);_this.treeObj.updateNode(treeNode);});};this.slider=function(current){var _this=this;var $this=$(current);var upGroupData={_id:'...',group:current.dataset.id,parentGroupId:current.dataset.groupid,type:'page'};if(!$.isEmptyObject(_this.search)){_this.search.searchList.push($this[0].dataset.id);}else{_this.list.push($this[0].dataset.id);}
WebAPI.get('/factory/material/group/'+$this[0].dataset.type+'/'+$this[0].dataset.id).done(function(result){_this.downFolder(result,upGroupData);})};this.downFolder=function(result,upGroupData){var _this=this;var $panelBody=$('#tabContent',this.domWrap);var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();$tabName.find('.divBatchApply').hide();_this.store=result.data;if(!result.data){$panelBody.empty().append(_this.upGroup.formatEL(upGroupData));}else{$panelBody.empty().append(_this.upGroup.formatEL(upGroupData));var len=result.data.length;for(var i=0;i<len;i++){if(!result.data[i].isFolder){result.data[i].isFolder=0;}
if(result.data[i].isFolder===0){if(_this.screen.options.showTemplateType&&_this.screen.options.showTemplateType.length>0){_this.screen.options.showTemplateType.forEach(function(row){var rowDataType;if(result.data[i].type.split('.')[1]){rowDataType=result.data[i].type.split('.')[1];}else{if(result.data[i].type==='page'){rowDataType="PageScreen";}}
if(rowDataType.toLowerCase()===row.toLowerCase()){$panelBody.append(_this.tabOptions.itemTpl.formatEL(result.data[i]));}})}else{$panelBody.append(_this.tabOptions.itemTpl.formatEL(result.data[i]));}}else{$panelBody.append(_this.groupItemGroup.formatEL(result.data[i]));}}}
$panelBody.find('.upGroup').off('dblclick').on('dblclick',function(){if(!$.isEmptyObject(_this.search)){_this.search.searchList.splice(_this.search.searchList.length-1,1);if(_this.search.searchList.length>0){WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.search.searchList[_this.search.searchList.length-1]).done(function(result){$panelBody.empty();var groupId=_this.search.searchList[_this.search.searchList-1];var upGroupData={_id:'...',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'page'};_this.downFolder(result,upGroupData);})}else{_this.renderItems(_this.search.data);}
return;}
if(!_this.list[_this.list.length-2]){var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();$tabName.find('.divBatchApply').hide();_this.list.splice(_this.list.length-1,1);WebAPI.get('/factory/material/group/page').done(function(result){_this.renderItems(result.data);});}else{WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.list[_this.list.length-2]).done(function(result){$panelBody.empty();_this.list.splice(_this.list.length-1,1);var groupId=_this.list[_this.list.length-1];var upGroupData={_id:_this.list.length>0?'...':'',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'page'};_this.downFolder(result,upGroupData);})}})
_this.initTooltip();}}.call(PageTab.prototype);exports.PageTab=PageTab;}(namespace('factory.components.template.tabs'),namespace('factory.components.template.tabs.Tab')));;(function(exports,SuperClass){var clickTimer=null;var CLICK_DELAY=500;function WidgetTab(){SuperClass.apply(this,arguments);}
WidgetTab.prototype=Object.create(SuperClass.prototype);WidgetTab.prototype.constructor=WidgetTab;+function(){this.groupItemGroup='<div class="tpl-item group-item pageBox" draggable="true" id="{_id}" data-id="{_id}" data-type="widget" data-groupid ="{group}">\
        <div class="pageName"><span class="glyphicon glyphicon-folder-open"></span><span class="item-name">{name}</span></div>\
        <div class="pageCreator"><span class="pageText">{creator}</span></div>\
        <div class="pageTime"><span class="pageText">{time}</span></div>\
                            <span class="slider-cb-wrap"><i class="slider-cb"></i></span></div>';this.upGroup='<div class="tpl-item upGroup pageBox" data-type="{type}" data-id="{_id}" data-groupid ="{group}" data-parent-group-id="{parentGroupId}"><span class="glyphicon glyphicon-chevron-left"></span>\
        <span class="group-item-name" title="...">...</span></div>';this.tabOptions={title:'<div class="divTab"><span class="glyphicon glyphicon-th-large"></span>Widget</div><ul id="treeWidgetTemplate" class="ztree treeTemplate" style="display: none;"></ul>',itemTpl:'<div class="child-item tpl-item pageBox" draggable="true" id="{_id}" data-type="widget" data-id="{_id}" data-groupid ="{group}">\
                            <div class="pageName"><span class="glyphicon glyphicon-file"></span><span class="item-name">{name}</span></div>\
                            <div class="pageBody"><div class="pageCreator"><span class="pageText">{creator}</span></div>\
                            <div class="pageTime"><span class="pageText">{time}</span></div>\
                            <div class="pageType" style="display:none;"><span class="pageText">{type}</span></div>\
                            <span class="slider-cb-wrap"><i class="slider-cb"></i></span></div></div>',toolsTpl:'<div class="paneTempButton">\
                    <div class="addTempate" title="Add Widget"><span class="glyphicon glyphicon-file"></span></div>\
                    <div class="addGroup" title="Add Folder"><span class="glyphicon glyphicon-folder-open"></span></div>\
                    <div class="divEdit" title="Edit Widget" style="display:none;"><span class="glyphicon glyphicon-edit"></span></div>\
                    <div class="divDelete" title="Remove" style="display:none;"><span class="glyphicon glyphicon-trash"></span></div>\
                    <div class="col-sm-4 divSearch"><div class="input-group"><input type="text" class="form-control iptSearch" placeholder="Search for name!"><span class="spanSearch"><span class="glyphicon glyphicon-search" aria-hidden="true"></span><span class="glyphicon glyphicon-remove" aria-hidden="true" style="display:none;"></span></span></div></div>\
                </div>',dataUrl:function(){var url='factory/material/group/widget';if(this.options.filter){return url+'.'+this.options.filter;}
return url;}};this.attachEvents=function(){var _this=this;var $tabContent=$('#tabContent',this.domWrap);var $templateLeft=$('#templateLeft',this.domWrap);$tabContent.off('dblclick','.group-item').on('dblclick','.group-item',function(){_this.slider(this);});$tabContent.off('dragstart','.tpl-item').on('dragstart','.tpl-item',_this.drag().start);$tabContent.off('dragend','.tpl-item').on('dragend','.tpl-item',_this.drag().end);$tabContent.off('dragover','.tpl-item.group-item,.tpl-item.upGroup').on('dragover','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().over);$templateLeft.off('dragover','#treeWidgetTemplate li a').on('dragover','#treeWidgetTemplate li a',_this.drog().over);$tabContent.off('dragenter','.tpl-item.group-item,.tpl-item.upGroup').on('dragenter','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().enter);$templateLeft.off('dragenter','#treeWidgetTemplate li a').on('dragenter','#treeWidgetTemplate li a',_this.drog().enter);$tabContent.off('dragleave','.tpl-item').on('dragleave','.tpl-item',_this.drag().leave);$templateLeft.off('dragleave','#treeWidgetTemplate li a').on('dragleave','#treeWidgetTemplate li a',_this.drog().leave);$tabContent.off('drop','.tpl-item.group-item,.tpl-item.upGroup').on('drop','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().drop);$templateLeft.off('drop','#treeWidgetTemplate li a').on('drop','#treeWidgetTemplate li a',_this.drog().drop);$tabContent.off('click','.pageBox .pageName').on('click','.pageBox .pageName',function(e){var $this=$(this);var ipt;var $item=$this.parent('.tpl-item');if(!$item.hasClass('active')){clickTimer=window.setTimeout(function(){window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);return;}
if(clickTimer){window.clearTimeout(clickTimer);clickTimer=null;if($item.hasClass('group-item')){_this.slider($item[0]);}else{_this.editWidgetBox();}
return;}
if($item.attr('id')!=''){if(typeof _this.permission($item)==='string'){alert(_this.permission($item));return;}}
clickTimer=window.setTimeout(function(){var $spName=$this.find('.item-name');ipt=document.createElement('input');ipt.className='ipt-name-editor';ipt.value=$spName.text();ipt.onblur=function(){$tabContent.on('dblclick','.group-item',function(){_this.slider(this);});$tabContent.find('.tpl-item').prop('draggable',true);var params={};if(this.value!==$spName.text()||!$this.closest('.pageBox')[0].dataset.id){params={_id:$this.closest('.pageBox')[0].dataset.id,name:this.value};_this.modifyGroupItem(params);$this.closest('.pageBox').attr('id',params._id);$this.closest('.pageBox')[0].dataset.id=params._id;$this.closest('.pageBox')[0].dataset.groupid=params.group;}
$spName.text(this.value);this.parentNode.removeChild(this);$spName.show();};ipt.onkeyup=function(e){if(e.which===13){this.blur();}};ipt.onclick=function(e){e.stopPropagation();};$spName.hide();$this.append(ipt);ipt.onfocus=function(e){e.stopPropagation();$tabContent.off('dblclick','.group-item');$tabContent.find('.tpl-item').prop('draggable',false);};ipt.focus();window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);});$tabContent.off('dblclick','.pageBody').on('dblclick','.pageBody',function(){_this.editWidgetBox();});if(this.options.allowUse){$tabContent.off('click','.pageBox .pageName');$tabContent.off('dblclick','.pageBody');$tabContent.off('dblclick','.child-item').on('dblclick','.child-item',function(e){var id=this.dataset.id;var data={ids:[id]};WebAPI.post('/factory/material/getByIds',data).done(function(result){confirm(I18n.resource.mainPanel.materalPanel.buttonMateral.USE_COPY,function(){typeof _this.options.callback==='function'&&_this.options.callback(result[0],true);},function(){typeof _this.options.callback==='function'&&_this.options.callback(result[0],false);});});_this.screen.close();});}
this.attachToolEvents();};this.attachToolEvents=function(){var _this=this;var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);var $templateTabs=$('#templateTabs',this.container);$tabName.find('.addTempate').off('click').click(function(){var $widgitNameModal=$('<div class="modal fade" id="widgitNameModal">\
                  <div class="modal-dialog">\
                    <div class="modal-content">\
                      <div class="modal-header">\
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                        <h4 class="modal-title">Widget</h4>\
                      </div>\
                      <div class="modal-body">\
                            <div class="form-group form-goupCy">\
                                <label for="widgetName" class="col-sm-2 control-label">Name:</label>\
                                <div class="col-sm-10">\
                                    <input type="text" class="form-control" id="widgetName" placeholder="Please input template name">\
                                </div>\
                            </div>\
                            <div class="form-group form-goupCy">\
                                <label for="widgetType" class="col-sm-2 control-label">Type:</label>\
                                <div class="col-sm-10">\
                                    <select class="form-control" id="widgetType"><option value="text">TextWidget</option><option value="button">ButtonWidget</option><option value="htmlContainer">HTMLContainerWidget</option><option value="htmlScreenContainer">HTMLScreenContainerWidget</option></select>\
                                </div>\
                            </div>\
                            <div class="form-group" id="wrongInfo">\
                            </div>\
                      </div>\
                      <div class="modal-footer">\
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>\
                        <button type="button" class="btn btn-primary" id="nameSub">Ok</button>\
                      </div>\
                    </div>\
                  </div>\
                </div>');$('#widgitNameModal').remove();$(document.body).append($widgitNameModal);I18n.fillArea($widgitNameModal);$widgitNameModal.modal('show');$('#nameSub').on('click',function(){var widgetName=$('#widgetName').val();var widgetType='widget.HtmlText';var widgetTypeSign=$('#widgetType').val();if(widgetTypeSign==='text'){widgetType='widget.HtmlText';}else if(widgetTypeSign==='button'){widgetType='widget.HtmlButton';}else if(widgetTypeSign==='htmlContainer'){widgetType='widget.HtmlContainer';}else if(widgetTypeSign==='htmlScreenContainer'){widgetType='widget.HtmlScreenContainer';}
if(widgetName===''){alert('Please input template name!');}else{$widgitNameModal.modal('hide');var _id=ObjectId();var data={_id:_id,name:widgetName,content:(widgetTypeSign==='text'||widgetTypeSign==='button')?{html:'',style:'',js:''}:{html:'',css:'',js:''},creator:AppConfig.userProfile.fullname,time:new Date().format('yyyy-MM-dd HH:mm:ss'),group:$('.upGroup',this.container).length===0?'':$('.upGroup',this.container)[0].dataset.groupid,isFolder:0,'public':1,type:widgetType};$tabContent.append($(_this.tabOptions.itemTpl.formatEL(data)));WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);CodeEditorModal.show({},function(code){var codeCopy;if(widgetTypeSign==='text'||widgetTypeSign==='button'){codeCopy={style:code.css||''};}else{codeCopy=code;}
var widget={_id:_id,content:codeCopy};WebAPI.post('/factory/material/edit',widget).done(function(result){}).always(function(){});});}else{alert(result.msg||'There are files with the same!');}});}});});$tabName.find('.addGroup').off('click').click(function(){_this.addGroupItem();});$tabName.find('.divEdit').off('click').click(function(){_this.editWidgetBox();});};this.editWidgetBox=function(){var _this=this;var $tabContent=$('#tabContent',this.domWrap);var $active=$tabContent.find('.active');if(typeof _this.permission($active)==='object'){var data=_this.permission($active);WebAPI.post('/factory/material/getByIds',data).done(function(result){var widget=result[0];var content=widget.content;var type='html';if(widget.type.indexOf('HtmlContainer')===-1){content={css:content['style']||''};type='style';}
CodeEditorModal.show(content,function(code){var data;if(type=='style'){widget.content.style=code.css;}else if(type=='html'){widget.content=code;}
data={_id:widget._id,content:widget.content};WebAPI.post('/factory/material/edit',data).done(function(result){}).fail(function(){});});})}else{alert(_this.permission($active));}};this.addGroupItem=function(data){var domItemCtn=this.domWrap.querySelector('#tabContent');var isNew=!data;if(!data){data={_id:'',name:I18n.resource.report.REPORT_SUB_NAME,group:'',creator:AppConfig.userProfile.fullname,time:new Date().format('yyyy-MM-dd HH:mm:ss')};}
var $item=$(this.groupItemGroup.formatEL(data));domItemCtn.appendChild($item[0]);if(isNew){$('.tpl-item',domItemCtn).removeClass('active');$item.addClass('active');$item.children('.pageName').trigger('click');}};this.modifyGroupItem=function(data){var _this=this;if(!data._id){data._id=ObjectId();data.content={};data.type='widget';data.group=$('.upGroup',this.container).length===0?'':$('.upGroup',this.container)[0].dataset.groupid;data.isFolder=1;data.creator=AppConfig.userProfile.fullname;data.time=new Date().format('yyyy-MM-dd HH:mm:ss');data.public=1;return WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);}});}
return WebAPI.post('/factory/material/edit',data).done(function(){var treeNode=_this.treeObj.getNodeByParam('id',data._id);treeNode&&(treeNode.name=data.name);_this.treeObj.updateNode(treeNode);});};this.slider=function(current){var _this=this;var $this=$(current);var upGroupData={_id:'...',group:current.dataset.id,parentGroupId:current.dataset.groupid,type:'widget'};if(!$.isEmptyObject(_this.search)){_this.search.searchList.push($this[0].dataset.id);}else{_this.list.push($this[0].dataset.id);}
WebAPI.get('/factory/material/group/'+$this[0].dataset.type+'/'+$this[0].dataset.id).done(function(result){_this.downFolder(result,upGroupData);})};this.downFolder=function(result,upGroupData){var $panelBody=$('#tabContent',this.domWrap);var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();var _this=this;_this.store=result.data;if(!result.data){$panelBody.empty().append(_this.upGroup.formatEL(upGroupData));}else{$panelBody.empty().append(_this.upGroup.formatEL(upGroupData));var len=result.data.length;for(var i=0;i<len;i++){if(!result.data[i].isFolder){result.data[i].isFolder=0;}
if(result.data[i].isFolder===1){$panelBody.append(_this.groupItemGroup.formatEL(result.data[i]));}else{if(_this.screen.options.showTemplateType&&_this.screen.options.showTemplateType.length>0){_this.screen.options.showTemplateType.forEach(function(row){var rowDataType;if(result.data[i].type.split('.')[1]){rowDataType=result.data[i].type.split('.')[1];}else{rowDataType=result.data[i].type;}
if(rowDataType.toLowerCase()===row.toLowerCase()){$panelBody.append(_this.tabOptions.itemTpl.formatEL(result.data[i]));}})}else{$panelBody.append(_this.tabOptions.itemTpl.formatEL(result.data[i]));}}}
_this.initTooltip();}
$panelBody.find('.upGroup').off('dblclick').on('dblclick',function(){if(!$.isEmptyObject(_this.search)){_this.search.searchList.splice(_this.search.searchList.length-1,1);if(_this.search.searchList.length>0){WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.search.searchList[_this.search.searchList.length-1]).done(function(result){$panelBody.empty();var groupId=_this.search.searchList[_this.search.searchList-1];var upGroupData={_id:'...',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'widget'};_this.downFolder(result,upGroupData);})}else{_this.renderItems(_this.search.data);}
return;}
if(!_this.list[_this.list.length-2]){var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();_this.list.splice(_this.list.length-1,1);WebAPI.get('/factory/material/group/widget').done(function(result){_this.renderItems(result.data);});}else{WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.list[_this.list.length-2]).done(function(result){$panelBody.empty();_this.list.splice(_this.list.length-1,1);var groupId=_this.list[_this.list.length-1];var upGroupData={_id:_this.list.length>0?'...':'',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'widget'};_this.downFolder(result,upGroupData);})}})}}.call(WidgetTab.prototype);exports.WidgetTab=WidgetTab;}(namespace('factory.components.template.tabs'),namespace('factory.components.template.tabs.Tab')));;(function(exports,SuperClass){var clickTimer=null;var CLICK_DELAY=500;function ReportTab(){SuperClass.apply(this,arguments);}
ReportTab.prototype=Object.create(SuperClass.prototype);ReportTab.prototype.constructor=ReportTab;+function(){this.groupItemGroup='<div class="tpl-item group-item" draggable="true" id="{_id}" data-id="{_id}" data-type="{type}" data-groupid ="{group}"><span class="glyphicon glyphicon-folder-open"></span>\
        <span class="tpl-item-name" title="{name}">{name}</span></div>';this.upGroup='<div class="tpl-item upGroup" data-type="{type}" data-id="{_id}" data-groupid ="{group}" data-parent-group-id="{parentGroupId}"><span class="glyphicon glyphicon-chevron-left"></span>\
        <span class="tpl-item-name" title="...">...</span></div>';this.tabOptions={title:'<div class="divTab"><span class="glyphicon glyphicon-list"></span>Report</div><ul id="treeReportTemplate" class="ztree treeTemplate" style="display: none;"></ul>',toolsTpl:'<div class="paneTempButton">\
                    <div class="addTempate" title="Add Template"><span class="glyphicon glyphicon-file"></span></div>\
                    <div class="addGroup" title="Add Folder"><span class="glyphicon glyphicon-folder-open"></span></div>\
                    <div class="divEdit" title="Edit" style="display:none;"><span class="glyphicon glyphicon-edit"></span></div>\
                    <div class="divDelete" title="Remove"><span class="glyphicon glyphicon-trash"></span></div>\
                    <div class="col-sm-4 divSearch"><div class="input-group"><input type="text" class="form-control iptSearch" placeholder="Search for name!"><span class="spanSearch"><span class="glyphicon glyphicon-search" aria-hidden="true"></span><span class="glyphicon glyphicon-remove" aria-hidden="true" style="display:none;"></span></span></div></div>\
                </div>',itemTpl:'<div class="tpl-item report-item" draggable="true" id="{_id}" data-id="{_id}" data-type="{type}" data-groupid ="{group}" data-creator="{creator}"><div class></div><span class="glyphicon glyphicon-file"></span>\
            <span class="tpl-item-name">{name}</span></div>',dataUrl:'/factory/material/group/report'};this.attachEvents=function(){var _this=this;var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);var $templateLeft=$('#templateLeft',this.domWrap);$tabName.find('.addTempate').off().on('click',function(e){_this.addTplItem();});$tabName.find('.addGroup').off().on('click',function(e){_this.addGroupItem();});$tabName.find('.divEdit').off('click').on('click',function(){var $tabContent=$('#tabContent',this.domWrap);var data=$tabContent.find('.active');if(typeof _this.permission(data)==='object'){data.name=$tabContent.find('.active').find('.tpl-item-name').html();_this.showTemplateScreen({id:data[0].dataset.id,name:data.name},data[0].dataset.type);}else{alert(_this.permission(data));}});$tabContent.off('dblclick','.group-item');$tabContent.off('dragstart','.tpl-item').on('dragstart','.tpl-item',_this.drag().start);$tabContent.off('dragend','.tpl-item').on('dragend','.tpl-item',_this.drag().end);$tabContent.off('dragover','.tpl-item.group-item,.tpl-item.upGroup').on('dragover','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().over);$templateLeft.off('dragover','#treeReportTemplate li a').on('dragover','#treeReportTemplate li a',_this.drog().over);$tabContent.off('dragenter','.tpl-item.group-item,.tpl-item.upGroup').on('dragenter','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().enter);$templateLeft.off('dragenter','#treeReportTemplate li a').on('dragenter','#treeReportTemplate li a',_this.drog().enter);$tabContent.off('dragleave','.tpl-item').on('dragleave','.tpl-item',_this.drag().leave);$templateLeft.off('dragleave','#treeReportTemplate li a').on('dragleave','#treeReportTemplate li a',_this.drog().leave);$tabContent.off('drop','.tpl-item.group-item,.tpl-item.upGroup').on('drop','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().drop);$templateLeft.off('drop','#treeReportTemplate li a').on('drop','#treeReportTemplate li a',_this.drog().drop);var start=null;$tabContent.off('click',".tpl-item:not('.upGroup ')").on('click',".tpl-item:not('.upGroup ')",function(e){var $this=$(this);var ipt;var allPageBox=$tabContent.children('.tpl-item');if(e.ctrlKey){if(!e.shiftKey){if($this.hasClass('active')){$this.removeClass('active');}else{$this.addClass('active');}
start=this;}else{var startIndex=$(start).index(),lastIndex=$this.index();var selPageBox=allPageBox.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);if($(start).hasClass('active')){selPageBox.addClass('active');}else{selPageBox.removeClass('active');}}
return;}else if(e.shiftKey){if($tabContent.find('.active').length!==0){var startIndex=$(start).index(),lastIndex=$this.index();var selPageBox=allPageBox.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);selPageBox.addClass('active');allPageBox.not(selPageBox).removeClass('active');}else{$this.addClass('active');}
return;}
if(!$this.hasClass('active')){allPageBox.removeClass('active');$this.addClass('active');start=this;_this.toolsTpl();clickTimer=window.setTimeout(function(){window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);return;}
if(clickTimer){window.clearTimeout(clickTimer);clickTimer=null;if($this.hasClass('report-item')){if(typeof _this.permission($this)==='string'){alert(_this.permission($this));return;}
_this.showTemplateScreen({id:this.dataset.id,name:this.querySelector('.tpl-item-name').innerHTML},this.dataset.type);}else{_this.slider(this);}
return;}
if($this.hasClass('active')){allPageBox.removeClass('active');$this.addClass('active');start=this;clickTimer=window.setTimeout(function(){if($this.hasClass('upGroup')){return;}
if($this.attr('id')!=''){if(typeof _this.permission($this)==='string'){alert(_this.permission($this));window.clearTimeout(clickTimer);clickTimer=null;return;}}
var $spName=$this.children('.tpl-item-name');ipt=document.createElement('input');ipt.className='ipt-name-editor';ipt.value=$spName.text();ipt.onblur=function(){$tabContent.find('.tpl-item').prop('draggable',true);if($this.hasClass('group-item')){$tabContent.on('dblclick','.group-item',function(){_this.slider(this);});}
var params={};if(this.value!==$spName.text()||!$this[0].dataset.id){params={_id:$this[0].dataset.id,name:this.value};if($this.hasClass('report-item')){_this.modifyTplItem(params);}else{_this.modifyGroupItem(params);}
$this.attr('id',params._id);$this[0].dataset.id=params._id;$this[0].dataset.groupid=params.group;}
$spName.text(this.value);this.parentNode.removeChild(this);$spName.show();};ipt.onkeyup=function(e){if(e.which===13){this.blur();}};ipt.onclick=function(e){e.stopPropagation();};$spName.hide();$this.append(ipt);ipt.onfocus=function(){$tabContent.find('.tpl-item').prop('draggable',false);if($this.hasClass('group-item')){$tabContent.off('dblclick','.group-item');}};ipt.focus();window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);}})};this.addTplItem=function(data){var domItemCtn=this.domWrap.querySelector('#tabContent');var isNew=!data;if(!data){data={_id:'',name:I18n.resource.report.REPORT_SUB_NAME,type:'report',group:'',creator:AppConfig.userProfile.fullname};}
var $item=$(this.tabOptions.itemTpl.formatEL(data));domItemCtn.appendChild($item[0]);if(isNew){$('.tpl-item',domItemCtn).removeClass('active');$item.addClass('active');$item.trigger('click');}};this.addGroupItem=function(data){var domItemCtn=this.domWrap.querySelector('#tabContent');var isNew=!data;if(!data){data={_id:'',name:I18n.resource.report.REPORT_SUB_NAME,type:'report',group:''};}
var $item=$(this.groupItemGroup.formatEL(data));domItemCtn.appendChild($item[0]);if(isNew){$('.tpl-item',domItemCtn).removeClass('active');$item.addClass('active');$item.trigger('click');}};this.modifyTplItem=function(data){var _this=this;if(!data._id){data._id=ObjectId();data.type='report';data.content={layouts:[]};data.group=$('.upGroup',this.container).length===0?'':$('.upGroup',this.container)[0].dataset.groupid;data.isFolder=0;data.creator=AppConfig.userProfile.fullname;return WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);}});}
return WebAPI.post('/factory/material/edit',data).done(function(){var treeNode=_this.treeObj.getNodeByParam('id',data._id);treeNode&&(treeNode.name=data.name);_this.treeObj.updateNode(treeNode);});};this.modifyGroupItem=function(data){var _this=this;if(!data._id){data._id=ObjectId();data.type='report';data.content={layouts:[]};data.group=$('.upGroup',this.container).length===0?'':$('.upGroup',this.container)[0].dataset.groupid;data.isFolder=1;data.creator=AppConfig.userProfile.fullname;return WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);}});}
return WebAPI.post('/factory/material/edit',data).done(function(){var treeNode=_this.treeObj.getNodeByParam('id',data._id);treeNode.name=data.name;_this.treeObj.updateNode(treeNode);});};this.slider=function(current){var _this=this;var $this=$(current);var upGroupData={_id:'...',group:current.dataset.id,parentGroupId:current.dataset.groupid,type:'report'};if(!$.isEmptyObject(_this.search)){_this.search.searchList.push($this[0].dataset.id);}else{_this.list.push($this[0].dataset.id);}
WebAPI.get('/factory/material/group/'+$this[0].dataset.type+'/'+$this[0].dataset.id).done(function(result){_this.downFolder(result,upGroupData);})};this.downFolder=function(result,upGroupData){var _this=this;var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();_this.store=result.data;var $panelBody=$('#tabContent',this.domWrap);if(!result.data){$panelBody.empty().append(_this.upGroup.formatEL(upGroupData));}else{$panelBody.empty().append(_this.upGroup.formatEL(upGroupData));var len=result.data.length;for(var i=0;i<len;i++){var resultDataCur=result.data[i];if(!resultDataCur.isFolder){resultDataCur.isFolder=0;}
resultDataCur['creator']=resultDataCur.creator?resultDataCur.creator:'未知';if(resultDataCur.isFolder===0){$panelBody.append(_this.tabOptions.itemTpl.formatEL(resultDataCur));}else{$panelBody.append(_this.groupItemGroup.formatEL(resultDataCur));}}}
$panelBody.find('.upGroup').off('dblclick').on('dblclick',function(){if(!$.isEmptyObject(_this.search)){_this.search.searchList.splice(_this.search.searchList.length-1,1);if(_this.search.searchList.length>0){WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.search.searchList[_this.search.searchList.length-1]).done(function(result){$panelBody.empty();var groupId=_this.search.searchList[_this.search.searchList-1];var upGroupData={_id:'...',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'report'};_this.downFolder(result,upGroupData);})}else{_this.renderItems(_this.search.data);}
return;}
if(!_this.list[_this.list.length-2]){$tabName.find('.divEdit').hide();_this.list.splice(_this.list.length-1,1);WebAPI.get('/factory/material/group/report').done(function(result){_this.renderItems(result.data);});}else{WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.list[_this.list.length-2]).done(function(result){$panelBody.empty();_this.list.splice(_this.list.length-1,1);var groupId=_this.list[_this.list.length-1];var upGroupData={_id:_this.list.length>0?'...':'',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'report'};_this.downFolder(result,upGroupData);})}})
_this.initTooltip();};this.toolsTpl=function(){var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);if($tabContent.find('.active').length===0){$tabName.find('.divEdit').hide();}else{if($tabContent.find('.active').hasClass('group-item')){$tabName.find('.divEdit').hide();}else{$tabName.find('.divEdit').show();}}}
this.showTemplateScreen=function(params,type){$('#modalframe').hide();I18n.fillArea($('#mainframe').fadeIn());if(type==='report'){var FactoryTplScreen=new namespace('factory.FactoryTplScreen');new FactoryTplScreen().show(params,type);}};}.call(ReportTab.prototype);exports.ReportTab=ReportTab;}(namespace('factory.components.template.tabs'),namespace('factory.components.template.tabs.Tab')));;(function(exports,SuperClass){var clickTimer=null;var CLICK_DELAY=500;function ImageTab(){SuperClass.apply(this,arguments);}
ImageTab.prototype=Object.create(SuperClass.prototype);ImageTab.prototype.constructor=ImageTab;+function(){this.imgFileCellTpl='<div class="formSingle clearfix">\
                        <div class="imgCheck col-sm-2">\
                            <div class="imgCheckBox"><img id="{id}" src="{src}"/></div>\
                        </div>\
                        <div class="imgInfos col-sm-9">\
                            <div class="form-group">\
                                <label for="inputName" class="col-sm-1 control-label">Name:</label>\
                                <div class="col-sm-11">\
                                    <input type="text" class="form-control" id="inputName_{i}" placeholder="Name" value="{name}">\
                                </div>\
                            </div><div class="form-group" type="{type}">\
                                <label class="col-sm-1 control-label">Type:</label>\
                                <label class="radio-inline radio-inline_{i}">\
                                    <input type="radio" name="inlineRadioOptions_{i}" id="inlineRadio1_{i}" value="option1" > static\
                                </label>\
                                <label class="radio-inline radio-inline_{i} ">\
                                    <input type="radio" name="inlineRadioOptions_{i}" id="inlineRadio2_{i}" class="inlineRadio" value="option2"> animation\
                                </label>\
                            </div>\
                            <div id="radioAnimation_{i}" class="clearfix radioAnimation">\
                                <div class="form-group animationInfo">\
                                    <label for="inputWidth" class="col-sm-3 control-label">Frame:</label><div class="col-sm-8">\
                                        <input type="text" class="form-control" id="inputFrame_{i}" placeholder="Frame" value="{pf}">\
                                    </div><span></span>\
                                </div>\
                                <div class="form-group animationInfo">\
                                    <label for="inputInterval" class="col-sm-3 control-label">Interval:</label><div class="col-sm-8">\
                                        <input type="text" class="form-control" id="inputInterval_{i}" placeholder="Interval" value="{interval}">\
                                    </div><span>ms</span>\
                                </div>\
                            </div>\
                        </div>\
                    </div>';this.groupItemGroup='<div class="tpl-item group-item pageBox groupPhotoItem" draggable="true" id="{_id}" data-id="{_id}" data-type="image" data-groupid ="{group}">\
        <div class="pageName"><span class="glyphicon glyphicon-folder-close"></span><span class="item-name">{name}</span></div>\
        <div class="pageCreator"><span class="pageText">{creator}</span></div>\
        <div class="pageTime"><span class="pageText">{time}</span></div>\
        <span class="slider-cb-wrap"><i class="slider-cb"></i></span></div>';this.upGroup='<div class="tpl-item upGroup pageBox groupPhotoItem" data-type="{type}" data-id="{_id}" data-groupid ="{group}"  data-parent-group-id="{parentGroupId}"><span class="glyphicon glyphicon-chevron-left"></span>\
                    <span class="group-item-name" title="...">...</span></div>';this.tabOptions={title:'<div class="divTab"><span class="glyphicon glyphicon-picture"></span>Image</div><ul id="treeImageTemplate" class="ztree treeTemplate" style="display: none;"></ul>',itemTpl:'<div class="{classAll}" id="{id}" data-id="{_id}" draggable="true" data-type="image" data-groupid ="{group}" data-creator="{creator}"><span class="animFlag"></span>\
                    <div class="thumbnail"><div draggable="false" id="inner-{id}" data_interval="{interval}" data_pf="{pf}" class="bgImg"></div>\
                    <span class="slider-cb-wrap"><i class="slider-cb"></i></span>\
                    <div class="caption"><h3 class="imgName">{title}</h3><h3 class="imgSize">{w}*{h}</h3></div></div></div>',toolsTpl:'<div class="paneTempButton">\
                    <div class="addTempate" title="Uploading"><span class="glyphicon glyphicon-upload"></span></div>\
                    <div class="addGroup" title="Add Folder"><span class="glyphicon glyphicon-folder-open"></span></div>\
                    <div class="divEdit" title="Edit" style="display:none;"><span class="glyphicon glyphicon-edit"></span></div>\
                    <div class="divDelete" title="Remove" style="display: none;"><span class="glyphicon glyphicon-trash"></span></div>\
                    <div class="col-sm-4 divSearch"><div class="input-group"><input type="text" class="form-control iptSearch" placeholder="Search for name!"><span class="spanSearch"><span class="glyphicon glyphicon-search" aria-hidden="true"></span><span class="glyphicon glyphicon-remove" aria-hidden="true" style="display:none;"></span></span></div></div>\
                    <input type="file" value="Select image" class="fileUpload" id="fileUpload" multiple="multiple" style="display:none;">\
                </div>',dataUrl:'factory/material/group/image'};this.attachEvents=function(){var _this=this;var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);var $templateLeft=$('#templateLeft',this.domWrap);$tabContent.off('dblclick','.group-item').on('dblclick','.group-item',function(){_this.slider(this);});$tabContent.off('dragstart','.tpl-item').on('dragstart','.tpl-item',_this.drag().start);$tabContent.off('dragend','.tpl-item').on('dragend','.tpl-item',_this.drag().end);$tabContent.off('dragover','.tpl-item.group-item,.tpl-item.upGroup').on('dragover','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().over);$templateLeft.off('dragover','#treeImageTemplate li a').on('dragover','#treeImageTemplate li a',_this.drog().over);$tabContent.off('dragenter','.tpl-item.group-item,.tpl-item.upGroup').on('dragenter','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().enter);$templateLeft.off('dragenter','#treeImageTemplate li a').on('dragenter','#treeImageTemplate li a',_this.drog().enter);$tabContent.off('dragleave','.tpl-item').on('dragleave','.tpl-item',_this.drag().leave);$templateLeft.off('dragleave','#treeImageTemplate li a').on('dragleave','#treeImageTemplate li a',_this.drog().leave);$tabContent.off('drop','.tpl-item.group-item,.tpl-item.upGroup').on('drop','.tpl-item.group-item,.tpl-item.upGroup',_this.drag().drop);$templateLeft.off('drop','#treeImageTemplate li a').on('drop','#treeImageTemplate li a',_this.drog().drop);if(this.options.allowUse){$tabContent.off('dblclick','.photoItem').on('dblclick','.photoItem',function(e){var id=this.dataset.id;var data={ids:[id]};WebAPI.post('/factory/material/getByIds',data).done(function(result){if(result[0].content.w<0||result[0].content.h<0){var dblImg=$('#'+result[0]._id)[0];result[0].content.w=dblImg.naturalWidth;result[0].content.h=dblImg.naturalHeight;}
typeof _this.options.callback==='function'&&_this.options.callback($.extend(false,{_id:result[0]._id},result[0].content));_this.screen.close();});});}else{$tabContent.off('dblclick','.photoItem').on('dblclick','.photoItem',function(){editImage();})};$tabName.find('.addGroup').off('click').click(function(){_this.addGroupItem();});$tabContent.off('click','.pageBox .pageName').on('click','.pageBox .pageName',function(e){var $this=$(this);var ipt;var $item=$this.parent('.tpl-item');if(!$item.hasClass('active')){clickTimer=window.setTimeout(function(){window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);return;}
if(clickTimer){window.clearTimeout(clickTimer);clickTimer=null;if($item.hasClass('group-item')){_this.slider($item[0]);}
return;}
if($item.attr('id')!=''){if(typeof _this.permission($item)==='string'){alert(_this.permission($item));return;}}
clickTimer=window.setTimeout(function(){var $spName=$this.find('.item-name');ipt=document.createElement('input');ipt.className='ipt-name-editor';ipt.value=$spName.text();ipt.onblur=function(){$tabContent.on('dblclick','.group-item',function(){_this.slider(this);});$tabContent.find('.tpl-item').prop('draggable',true);var params={};if(this.value!==$spName.text()||!$this.closest('.pageBox')[0].dataset.id){params={_id:$this.closest('.pageBox')[0].dataset.id,name:this.value,type:'image'};_this.modifyGroupItem(params);$this.closest('.pageBox').attr('id',params._id);$this.closest('.pageBox')[0].dataset.id=params._id;$this.closest('.pageBox')[0].dataset.groupid=params.group;}
$spName.text(this.value);this.parentNode.removeChild(this);$spName.show();};ipt.onkeyup=function(e){if(e.which===13){this.blur();}};ipt.onclick=function(e){e.stopPropagation();};$spName.hide();$this.append(ipt);ipt.onfocus=function(){$tabContent.off('dblclick','.group-item');$tabContent.find('.tpl-item').prop('draggable',false);};ipt.focus();window.clearTimeout(clickTimer);clickTimer=null;},CLICK_DELAY);});$tabName.children('.paneTempButton').on('click','.addTempate',function(){$('#fileUpload').click();});$('#fileUpload').change(function(e){var imgCheck=e.target.files||e.dataTransfer.files;var imgStandardArr=filterImg(imgCheck);var $imgFilterBox=$('#imgFilterBox',$(_this.domWrap).parent().find('#formModal'));$imgFilterBox.children().remove();for(var i=0,file;file=imgStandardArr[i];i++){file.index=i;}
readImage(imgStandardArr);});$tabName.children('.paneTempButton').on('click','.divEdit',function(){editImage();});function editImage(){var $tabContent=$('#tabContent',this.domWrap);var $active=$tabContent.find('.active');if(typeof _this.permission($active)==='object'){$("#imgFilterBox",$(_this.domWrap).parent().find('#formModal')).html("");var pubMate={'ids':[],'paths':[],'names':[],'types':[],'intervals':[],"pfs":[]};for(var j=0,len=$active.length;j<len;j++){var itemId=$active.eq(j).find(".photoLoad").attr('id').split('-')[1];var itemPath=$active.eq(j).find(".photoLoad").css('background-image').slice(5,-2);var itemInterval=$active.eq(j).find(".photoLoad").attr("data_interval");var itemPf=$active.eq(j).find(".photoLoad").attr("data_pf");var itemName=$active.eq(j).find(".imgName").html();var itemType=$active.eq(j).find(".animFlag").text();if(itemType!="animation"){itemType="static";}
pubMate.ids.push(itemId);pubMate.paths.push(itemPath);pubMate.names.push(itemName);pubMate.types.push(itemType);pubMate.intervals.push(itemInterval);pubMate.pfs.push(itemPf);}
for(var i=0,len=pubMate.paths.length;i<len;i++){$("#imgFilterBox",$(_this.domWrap).parent().find('#formModal')).append(_this.imgFileCellTpl.formatEL({src:pubMate.paths[i],i:i,name:pubMate.names[i],type:pubMate.types[i],id:pubMate.ids[i],interval:pubMate.intervals[i],pf:pubMate.pfs[i]}));}
$(".formSingle",$(_this.domWrap).parent().find('#formModal')).each(function(){if($(this).find(".form-group").eq(1).attr("type")=="animation"){$(this).find(".radio-inline").eq(1).children("input").attr("checked","checked");}else{$(this).find(".radio-inline").eq(0).children("input").attr("checked","checked");}});imgsLoadSuccess(pubMate.paths,pubMate.paths);}else{alert(_this.permission($active));}}
function filterImg(files){var arrFiles=[];for(var i=0,len=files.length;i<len;i++){var file=files[i];if(!/(gif|jpg|png|jpeg)$/i.test(file.type)){alert('Image format should be gif, jpg, png or jpeg!');}else{if(file.size>614400){alert('Picture is too large!');}else{arrFiles.push(file);}}}
return arrFiles;}
function readImage(files){var image=new Image();var $imgFilterBox=$('#imgFilterBox',$(_this.domWrap).parent().find('#formModal'));var file;var imgInfoArr=[];var count=0,i=0;var len=files.length;var editImgInfo=function(){var reader=new FileReader();file=files[i];if(file){reader.readAsDataURL(file);reader.onload=function(_file){image.src=_file.target.result;image.onload=function(){imgInfoArr.push({pw:this.width,ph:this.height});count+=1;if(count===len){imgsLoadSuccess(imgInfoArr,files);}else if(count<len){editImgInfo();}};image.onerror=function(){alert('Invaild file type'+file.type);};$imgFilterBox.append(_this.imgFileCellTpl.formatEL({src:image.src,i:i,id:"",name:"",pf:"",interval:""}));i++;};}};editImgInfo();}
function imgsLoadSuccess(imgInfoArr,imgStandardArr){var imgContentArr=[];var $formModal=$('#formModal',$(_this.domWrap).parent());var $fileUpload=$('#fileUpload',_this.domWrap);$formModal.modal('show');$formModal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$fileUpload.replaceWith($fileUpload=$fileUpload.clone(true));e.stopPropagation();});var $inputSelect=$formModal.find('.radio-inline');$formModal.find(".formSingle").each(function(){var $radioAnimation=$(this).find('.radioAnimation');if($(this).find(".form-group").eq(1).attr("type")=="animation"){$radioAnimation.show();}else{$radioAnimation.hide();}});$inputSelect.off('click').on('click',function(){var $radioAnimation=$(this).parents('.imgInfos').find('.radioAnimation');if($(this).parent().find('.inlineRadio').is(":checked")){$radioAnimation.show();}else{$radioAnimation.hide();}});$formModal.off('shown.bs.modal').on('shown.bs.modal',function(){var currentFormModal=$(_this.domWrap).parent().find('#formModal');$('#btnClose',currentFormModal).off('click').on('click',function(){$formModal.modal('hide');});if(imgInfoArr[0].pw){$formModal.find('input[value="option1"]').prop('checked',true);}
$('#buttonOk',currentFormModal).off('click').on('click',function(){var groupId;var $upGroup=$(_this.domWrap).find('.upGroup');if($upGroup.length===0){groupId='';}else{groupId=$upGroup[0].dataset.groupid;}
for(var j=0,len=imgStandardArr.length;j<len;j++){if(imgInfoArr[j].pw){var imgContent={isFolder:0,group:groupId,name:'',time:new Date().format('yyyy-MM-dd'),content:{interval:0,list:[]}};imgContent.content.w=imgInfoArr[j].pw;imgContent.content.h=imgInfoArr[j].ph;}else{var imgContent={isFolder:0,group:groupId,name:'',time:new Date().format('yyyy-MM-dd'),content:{interval:0,url:imgStandardArr[j],list:[]}};var img_url=imgInfoArr[j];var img=new Image();img.src=img_url;if(img.complete){imgContent.content.w=img.width;imgContent.content.h=img.height;}else{img.onload=function(){imgContent.content.w=img.width;imgContent.content.h=img.height;};}}
if(currentFormModal.find('#inputName_'+j).val()===''){alert('Image name is not completed!');return;}
if($('#inlineRadio2_'+j).is(":checked")){imgContent.name=currentFormModal.find('#inputName_'+j).val();if(currentFormModal.find('#inputFrame_'+j).val()===''||currentFormModal.find('#inputInterval_'+j).val()===''){alert('Animation parameters are missing! ');return;}
imgContent.content.pf=parseInt(currentFormModal.find('#inputFrame_'+j).val());imgContent.content.pw=parseInt(imgContent.content.w/imgContent.content.pf);imgContent.content.interval=parseFloat(currentFormModal.find('#inputInterval_'+j).val());imgContent.content.list=[];for(var i=0;i<imgContent.content.pf;i++){imgContent.content.list.push(i*imgContent.content.pw,0,imgContent.content.pw,imgContent.content.h);}}else{imgContent.name=currentFormModal.find('#inputName_'+j).val();}
imgContentArr.push(imgContent);}
if(!imgInfoArr[0].pw){editNamePub(imgStandardArr);}else{submit();}
$formModal.modal('hide');});function editNamePub(imgStandardArr){var arr=[];for(var i=0,len=imgStandardArr.length;i<len;i++){var idArr=imgStandardArr[i].split("/");var id=idArr[idArr.length-1].split(".")[0];var datas={_id:id,name:imgContentArr[i].name,content:$.extend(false,imgContentArr[i].content,{pf:imgContentArr[i].content.pf,interval:imgContentArr[i].content.interval})};arr.push(datas);}
WebAPI.post('/factory/material/edit',arr).done(function(result){if(result.status=="OK"){var $active=$tabContent.find('.active');for(var i=0,len=$active.length;i<len;i++){$active.eq(i).find(".imgName").html(imgContentArr[i].name);$active.eq(i).find(".photoLoad").attr("data_interval",imgContentArr[i].content.interval);var imgUrlDom=$('#'+arr[i]._id).find('#inner-'+arr[i]._id);if(imgContentArr[i].content.interval===0){$active.eq(i).find(".animFlag").css('background','#078A98').html('image');imgUrlDom.removeClass('center');}else{$active.eq(i).find(".animFlag").css('background','#6D3F1F').html('animation');}
imgUrlDom.get(0).style=null;_this.loadImage(arr[i],_this.loadResult);$active.eq(i).find(".photoLoad").attr("data_pf",imgContentArr[i].content.pf||'');}
arr.forEach(function(row){var treeNode=_this.treeObj.getNodeByParam('id',row._id);if(treeNode)treeNode.name=row.name;_this.treeObj.updateNode(treeNode);})}});}
function submit(){var groupId;var formData=new FormData();var $upGroup=$(_this.domWrap).find('.upGroup');var id;if($upGroup.length===0){groupId='';}else{groupId=$upGroup[0].dataset.groupid;}
for(var i=0,len=imgStandardArr.length;i<len;i++){id=ObjectId();imgContentArr[i]._id=id;imgContentArr[i].content._id=id;formData.append('_id',id);formData.append('isFolder',imgContentArr[i].isFolder);formData.append('name',imgContentArr[i].name+'.'+imgStandardArr[i].type.substring(6));formData.append('creator',AppConfig.userId);formData.append('time',new Date().format('yyyy-MM-dd'));formData.append('public',1);formData.append('group',groupId);formData.append('type','image');formData.append('content',JSON.stringify(imgContentArr[i].content));formData.append('image',imgStandardArr[i]);}
$.ajax({type:'POST',url:'/factory/material/saveform',data:formData,cache:false,processData:false,contentType:false,success:function(data){var domId=[];for(var i=0,len=data.length;i<len;i++){var count=0;var standId=data[i].split('/')[4].split('.')[0];if(count<imgStandardArr.length){for(var j=0,len=imgContentArr.length;j<len;j++){if(imgContentArr[j]._id===standId){imgContentArr[j].creator=AppConfig.userProfile['fullname'];if(imgContentArr[j]){imgContentArr[j].content.url='http://images.rnbtech.com.hk/'+data[i];}
_this.photoCell(imgContentArr[j],'tpl-item photoItem');_this.store.push(imgContentArr[j]);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',imgContentArr[j].group),_this.generateTreeEx([imgContentArr[j]]),true);_this.loadImage(imgContentArr[j],_this.loadResult);domId.push(standId);break;}}
count++;}}
var imgLastBoxId=domId[domId.length-1];$('#'+imgLastBoxId)[0].scrollIntoView(false);},error:function(data){console.log(data);}});}});}};this.renderItems=function(result){for(var i=0;i<result.length;i++){if(result[i].isFolder===1){$('#tabContent',this.domWrap).append(this.groupItemGroup.formatEL(result[i]));}else{this.photoCell(result[i],'tpl-item photoItem');this.loadImage(result[i],this.loadResult);}}
this.store=result;this.initTooltip();};this.photoCell=function(result,classAll){var $tabContent=$('#tabContent',this.domWrap);var tempHtml=[];var imgInterval;if(result.interval){imgInterval=parseInt(result.interval);}else{if(result.content){imgInterval=result.content.interval?result.content.interval:0;}else{imgInterval=0;}}
tempHtml.push(this.tabOptions.itemTpl.formatEL({classAll:classAll,_id:result._id,id:result._id,title:result.name?result.name:'',interval:imgInterval,pf:result.content.pf?result.content.pf:'',type:result.type,group:result.group,h:result.content?result.content.h:result.h,w:result.content?result.content.w:result.w,creator:result.creator?result.creator:'未知'}));$tabContent.append(tempHtml.join(''));var $caption=$tabContent.find(".caption:last");var text=$caption.find(".imgName").text().split(".")[0];$caption.find(".imgName").text(text);if(parseInt(imgInterval)===0){$tabContent.find('.animFlag:last').css('background','#078A98').html('image');}else{$tabContent.find('.animFlag:last').css('background','#6D3F1F').html('animation');}};this.loadImage=function(result,callback){var imgLoad=new window.Image();imgLoad.onload=function(e){if(typeof imgLoad.readyState=='undefined'){imgLoad.readyState='undefined';}
if((imgLoad.readyState=='complete'||imgLoad.readyState=='loaded')||imgLoad.complete){callback({'id':result._id,'src':result.content.url,'msg':'ok','pw':result.content.w,'ph':result.content.h,'pf':result.content.pf,'interval':result.content.interval});}else{}};imgLoad.onerror=function(e){callback({'id':result._id,'msg':'error'});};imgLoad.src=result.content.url;};this.loadResult=function(data){var currentObj=document.getElementById('inner-'+data.id);if(!currentObj){return;}
if($(currentObj).css("background").indexOf("url")!==-1){currentObj=$('#materialModal').find('#inner-'+data.id)[0];}
data=data||{};if(typeof(data.msg)!='undefined'){if(data.msg=='ok'){if(currentObj){var boxW=$(currentObj).parent(".thumbnail").width();var boxH=$(currentObj).parent(".thumbnail").height();$(currentObj).addClass('photoLoad');currentObj.style.backgroundImage='url('+data.src+')';currentObj.style.backgroundRepeat='no-repeat';if(data.interval&&data.interval!=0){var w=Number(data.pw);var h=Number(data.ph);var ratio=w/h;var actualW,actualH;$(currentObj).addClass('center');if(w/data.pf<=boxW&&h<=boxH){actualW=data.pw/data.pf+'px';actualH=data.ph+'px';}else{if(w/data.pf<h){actualH=boxH+'px';actualW=(boxH*ratio)/data.pf+'px';}else{var ratio=(w/data.pf)/h;actualH=boxW/ratio+'px';actualW=boxW+'px';}}
currentObj.style.height=actualH;currentObj.style.width=actualW;currentObj.style.backgroundSize='cover';currentObj.style.backgroundPosition='0';}else{currentObj.style.height='100%';currentObj.style.width='100%';currentObj.style.backgroundPosition='center';if(data.pw>boxW){currentObj.style.backgroundSize='contain';}}}}else{if(currentObj){currentObj.style.backgroundImage='url('+data.src+')';currentObj.style.backgroundRepeat='no-repeat';$(currentObj).addClass('noImg photoLoad');}}}};this.addGroupItem=function(data){var domItemCtn=this.domWrap.querySelector('#tabContent');var isNew=!data;if(!data){data={_id:'',name:I18n.resource.report.REPORT_SUB_NAME,type:'image',group:'',creator:AppConfig.userProfile.fullname,time:new Date().format('yyyy-MM-dd HH:mm:ss')};}
var $item=$(this.groupItemGroup.formatEL(data));domItemCtn.appendChild($item[0]);if(isNew){$('.tpl-item',domItemCtn).removeClass('active');$item.addClass('active');$item.children('.pageName').trigger('click');}};this.modifyGroupItem=function(data){var _this=this;if(!data._id){data._id=ObjectId();data.content={};data.group=$('.upGroup',this.container).length===0?'':$('.upGroup',this.container)[0].dataset.groupid;data.isFolder=1;data.creator=AppConfig.userId;data.time=new Date().format('yyyy-MM-dd HH:mm:ss');data.public=1;return WebAPI.post('/factory/material/save',data).done(function(result){if(result.status==='OK'){_this.store.push(data);_this.treeObj.addNodes(_this.treeObj.getNodeByParam('id',data.group),_this.generateTreeEx([data]),true);}});}
return WebAPI.post('/factory/material/edit',data).done(function(){var treeNode=_this.treeObj.getNodeByParam('id',data._id);treeNode&&(treeNode.name=data.name);_this.treeObj.updateNode(treeNode);});};this.slider=function(current){var _this=this;var $this=$(current);var upGroupData={_id:'...',group:current.dataset.id,parentGroupId:current.dataset.groupid,type:'image'};if(!$.isEmptyObject(_this.search)){_this.search.searchList.push($this[0].dataset.id);}else{_this.list.push($this[0].dataset.id);}
WebAPI.get('/factory/material/group/'+$this[0].dataset.type+'/'+$this[0].dataset.id).done(function(result){_this.downFolder(result,upGroupData);})};this.downFolder=function(result,upGroupData){var _this=this;var $panelBody=$('#tabContent',this.domWrap);var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();_this.store=result.data;if(!result.data){$panelBody.empty().append(this.upGroup.formatEL(upGroupData));}else{$panelBody.empty().append(this.upGroup.formatEL(upGroupData));_this.renderItems(result.data);}
$panelBody.find('.upGroup').off('dblclick').on('dblclick',function(){if(!$.isEmptyObject(_this.search)){_this.search.searchList.splice(_this.search.searchList.length-1,1);if(_this.search.searchList.length>0){WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.search.searchList[_this.search.searchList.length-1]).done(function(result){$panelBody.empty();var groupId=_this.search.searchList[_this.search.searchList-1];var upGroupData={_id:'...',group:groupId,parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'image'};_this.downFolder(result,upGroupData);})}else{$(_this.container).empty();_this.renderItems(_this.search.data);}
return;}
if(!_this.list[_this.list.length-2]){var $tabName=$('#tabName',this.domWrap);$tabName.find('.divEdit').hide();$tabName.find('.divDelete').hide();_this.list.splice(_this.list.length-1,1);WebAPI.get('/factory/material/group/image').done(function(result){$panelBody.empty();_this.renderItems(result.data);});}else{WebAPI.get('/factory/material/group/'+$(this)[0].dataset.type+'/'+_this.list[_this.list.length-2]).done(function(result){$panelBody.empty();_this.list.splice(_this.list.length-1,1);var upGroupData={_id:'...',group:_this.list[_this.list.length-1],parentGroupId:_this.list.length>1?_this.list[_this.list.length-2]:'',type:'image'};_this.downFolder(result,upGroupData);})}});}}.call(ImageTab.prototype);exports.ImageTab=ImageTab;}(namespace('factory.components.template.tabs'),namespace('factory.components.template.tabs.Tab')));;(function(exports,SuperClass){var clickTimer=null;var CLICK_DELAY=500;function RecycleTab(){SuperClass.apply(this,arguments);}
RecycleTab.prototype=Object.create(SuperClass.prototype);RecycleTab.prototype.constructor=RecycleTab;+function(){this.groupItemGroup='<div class="tpl-item group-item" id="{_id}" data-id="{_id}" data-type="{type}" data-parentid ="{parent}"><span class="glyphicon glyphicon-folder-open"></span>\
        <span class="tpl-item-name" title="{text}">{text}</span></div>';this.tabOptions={title:'<div class="divTab"><span class="glyphicon glyphicon-tree-deciduous"></span>Recycle</div>',itemTpl:'<div class="tpl-item report-item" id="{_id}" data-id="{_id}" data-type="{type}" data-parentid ="{parent}"><span class="glyphicon glyphicon-file"></span>\
            <span class="tpl-item-name">{text}</span></div>',toolsTpl:'<div class="paneTempButton">\
                    <div class="cleanAll" title="Clean Recycle Bin"><span class="glyphicon glyphicon-fire"></span></div>\
                    <div class="restoreAll" title="Restore all the items"><span class="glyphicon glyphicon-refresh"></span></div>\
                    <div class="divRestore" title="Restore" style="display:none;"><span class="glyphicon glyphicon-repeat"></span></div>\
                    <div class="divDelete" title="Remove" style="display: none;"><span class="glyphicon glyphicon-trash"></span></div>\
                </div>',dataUrl:'/factory/recycle'};this.attachEvents=function(){var _this=this;var $tabContent=$('#tabContent',this.domWrap);var $tabName=$('#tabName',this.domWrap);$tabContent.off('dblclick click','.group-item').on('dblclick','.group-item',function(){return;});$tabName.find('.cleanAll').off('click').on('click',function(){var message='确认要清空回收站？';var url='/factory/recycle/delete';_this.itemOperate(message,url,true);});$tabName.find('.restoreAll').off('click').on('click',function(){var message='确认要还原所有项目？';var url='/factory/recycle/restore';_this.itemOperate(message,url,true);});$tabName.find('.divRestore').off('click').on('click',function(){var message='确认要还原选中项目？';var url='/factory/recycle/restore';_this.itemOperate(message,url,false);});$tabName.find('.divDelete').off('click').on('click',function(){var message='确认要清空选中项目？';var url='/factory/recycle/delete';_this.itemOperate(message,url,false);});};this.renderItems=function(data){var _this=this;var arrHtml=[];if(data){data.forEach(function(row){var rowData=_this.format2VO(row);if(rowData.type!='DropDownList'){arrHtml.push(_this.tabOptions.itemTpl.formatEL(rowData));}else{arrHtml.push(_this.groupItemGroup.formatEL(rowData));}});}
this.container.innerHTML=arrHtml.join('');};this.itemOperate=function(message,url,all){var $tabContent=$('#tabContent',this.domWrap);confirm(message,function(){var allItem;if(all){allItem=$tabContent.children('.tpl-item');}else{allItem=$tabContent.find('.active');}
var allItemId=[];allItem.each(function(){allItemId.push($(this).attr('id'));});var data={ids:allItemId};WebAPI.post(url,data).done(function(){allItem.remove();})},function(){return;})};this.toolsTpl=function(){var $tabName=$('#tabName',this.domWrap);var $tabContent=$('#tabContent',this.domWrap);if($tabContent.find('.active').length===0){$tabName.find('.divRestore').hide();$tabName.find('.divDelete').hide();}else{$tabName.find('.divRestore').show();$tabName.find('.divDelete').show();}}}.call(RecycleTab.prototype);exports.RecycleTab=RecycleTab;}(namespace('factory.components.template.tabs'),namespace('factory.components.template.tabs.Tab')));