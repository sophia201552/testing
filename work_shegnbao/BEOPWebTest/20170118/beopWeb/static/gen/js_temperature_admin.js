(function(root,factory){if(typeof exports=='object')module.exports=factory()
else if(typeof define=='function'&&define.amd)define(factory)
else root.LoadingSpinner=factory()}
(this,function(){"use strict";var prefixes=['webkit','Moz','ms','O'],animations={},useCssAnimations;function createEl(tag,prop){var el=document.createElement(tag||'div'),n;for(n in prop)el[n]=prop[n]
return el}
function ins(parent){for(var i=1,n=arguments.length;i<n;i++)
parent.appendChild(arguments[i])
return parent}
var sheet=(function(){var el=createEl('style',{type:'text/css'})
ins(document.getElementsByTagName('head')[0],el)
return el.sheet||el.styleSheet}())
function addAnimation(alpha,trail,i,lines){var name=['opacity',trail,~~(alpha*100),i,lines].join('-'),start=0.01+i/lines*100,z=Math.max(1-(1-alpha)/trail*(100-start),alpha),prefix=useCssAnimations.substring(0,useCssAnimations.indexOf('Animation')).toLowerCase(),pre=prefix&&'-'+prefix+'-'||''
if(!animations[name]){sheet.insertRule('@'+pre+'keyframes '+name+'{'+'0%{opacity:'+z+'}'+
start+'%{opacity:'+alpha+'}'+
(start+0.01)+'%{opacity:1}'+
(start+trail)%100+'%{opacity:'+alpha+'}'+'100%{opacity:'+z+'}'+'}',sheet.cssRules.length)
animations[name]=1}
return name}
function vendor(el,prop){var s=el.style,pp,i
prop=prop.charAt(0).toUpperCase()+prop.slice(1)
for(i=0;i<prefixes.length;i++){pp=prefixes[i]+prop
if(s[pp]!==undefined)return pp}
if(s[prop]!==undefined)return prop}
function css(el,prop){for(var n in prop)
el.style[vendor(el,n)||n]=prop[n]
return el}
function merge(obj){for(var i=1;i<arguments.length;i++){var def=arguments[i]
for(var n in def)
if(obj[n]===undefined)obj[n]=def[n]}
return obj}
function pos(el){var o={x:el.offsetLeft,y:el.offsetTop}
while((el=el.offsetParent))
o.x+=el.offsetLeft,o.y+=el.offsetTop
return o}
function getColor(color,idx){return typeof color=='string'?color:color[idx%color.length]}
var defaults={lines:12,length:10,width:5,radius:15,rotate:0,corners:1,color:'#000',direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:1001,className:'spinner',top:'50%',left:'50%',position:'absolute'}
function LoadingSpinner(o){this.opts=merge(o||{},LoadingSpinner.defaults,defaults)}
LoadingSpinner.defaults={}
merge(LoadingSpinner.prototype,{spin:function(target){this.stop()
this.opts.target=target;var divMask=document.createElement("div");divMask.className="spinnerMask";divMask.style.width=target.width;divMask.style.height=target.height;target.appendChild(divMask);this.divMask=divMask;var self=this,o=self.opts,el=self.el=css(createEl(0,{className:o.className}),{position:o.position,width:0,zIndex:o.zIndex}),mid=o.radius+o.length+o.width
css(el,{left:o.left,top:o.top})
if(target){target.insertBefore(el,target.firstChild||null)}
el.setAttribute('role','progressbar')
self.lines(el,self.opts)
if(!useCssAnimations){var i=0,start=(o.lines-1)*(1-o.direction)/2,alpha,fps=o.fps,f=fps/o.speed,ostep=(1-o.opacity)/(f*o.trail/100),astep=f/o.lines;(function anim(){i++;for(var j=0;j<o.lines;j++){alpha=Math.max(1-(i+(o.lines-j)*astep)%f*ostep,o.opacity)
self.opacity(el,j*o.direction+start,alpha,o)}
self.timeout=self.el&&setTimeout(anim,~~(1000/fps))})()}
return self},stop:function(){var el=this.el
if(el){clearTimeout(this.timeout)
if(el.parentNode)el.parentNode.removeChild(el)
this.el=undefined
if(this.divMask){if(this.divMask.parentNode)this.divMask.parentNode.removeChild(this.divMask)
this.el=undefined}}
return this},lines:function(el,o){var i=0,start=(o.lines-1)*(1-o.direction)/2,seg
function fill(color,shadow){return css(createEl(),{position:'absolute',width:(o.length+o.width)+'px',height:o.width+'px',background:color,boxShadow:shadow,transformOrigin:'left',transform:'rotate('+~~(360/o.lines*i+o.rotate)+'deg) translate('+o.radius+'px'+',0)',borderRadius:(o.corners*o.width>>1)+'px'})}
for(;i<o.lines;i++){seg=css(createEl(),{position:'absolute',top:1+~(o.width/2)+'px',transform:o.hwaccel?'translate3d(0,0,0)':'',opacity:o.opacity,animation:useCssAnimations&&addAnimation(o.opacity,o.trail,start+i*o.direction,o.lines)+' '+1/o.speed+'s linear infinite'})
if(o.shadow)ins(seg,css(fill('#000','0 0 4px '+'#000'),{top:2+'px'}))
ins(el,ins(seg,fill(getColor(o.color,i),'0 0 1px rgba(0,0,0,.1)')))}
return el},opacity:function(el,i,val){if(i<el.childNodes.length)el.childNodes[i].style.opacity=val}})
function initVML(){function vml(tag,attr){return createEl('<'+tag+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',attr)}
sheet.addRule('.spin-vml','behavior:url(#default#VML)')
LoadingSpinner.prototype.lines=function(el,o){var r=o.length+o.width,s=2*r
function grp(){return css(vml('group',{coordsize:s+' '+s,coordorigin:-r+' '+-r}),{width:s,height:s})}
var margin=-(o.width+o.length)*2+'px',g=css(grp(),{position:'absolute',top:margin,left:margin}),i
function seg(i,dx,filter){ins(g,ins(css(grp(),{rotation:360/o.lines*i+'deg',left:~~dx}),ins(css(vml('roundrect',{arcsize:o.corners}),{width:r,height:o.width,left:o.radius,top:-o.width>>1,filter:filter}),vml('fill',{color:getColor(o.color,i),opacity:o.opacity}),vml('stroke',{opacity:0}))))}
if(o.shadow)
for(i=1;i<=o.lines;i++)
seg(i,-2,'progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)')
for(i=1;i<=o.lines;i++)seg(i)
return ins(el,g)}
LoadingSpinner.prototype.opacity=function(el,i,val,o){var c=el.firstChild
o=o.shadow&&o.lines||0
if(c&&i+o<c.childNodes.length){c=c.childNodes[i+o];c=c&&c.firstChild;c=c&&c.firstChild
if(c)c.opacity=val}}}
var probe=css(createEl('group'),{behavior:'url(#default#VML)'})
if(!vendor(probe,'transform')&&probe.adj)initVML()
else useCssAnimations=vendor(probe,'animation')
return LoadingSpinner}));﻿var ScreenManager=(function(){function ScreenManager(){}
ScreenManager.screenFlag='page';ScreenManager.root='#page=IndexScreen';ScreenManager.paneRoot="#page=PaneProjectSelector";ScreenManager.isListening=false;ScreenManager.setProjectSelector=function(ProjectSelector){if(typeof ProjectSelector==='function'){ScreenManager.projectSelector=new ProjectSelector();}};ScreenManager.Init=function(){I18n.fillArea($(".navbar"));};ScreenManager.show=function(){if(arguments.length===0){return;}
var screenClass=arguments[0];if(typeof screenClass!=='function'){return;}
if(ScreenManager.isListening){ScreenManager.applyGoTo.apply(null,arguments);}else{ScreenManager.applyScreen.apply(null,arguments);}};ScreenManager.applyGoTo=function(){var screenClass=arguments[0];if(!screenClass.name){alert(I18n.resource.common.NOT_FOUND_PAGE);return false;}
var paramObj={page:screenClass.name},paramList=ScreenManager._getFunctionParams(screenClass);for(var m=0,n=paramList.length;m<n;m++){if(typeof arguments[m+1]!=typeof undefined){paramObj[paramList[m]]=arguments[m+1];}}
ScreenManager.goTo(paramObj);};ScreenManager.applyScreen=function(){var screenClass=arguments[0];if(!screenClass){alert('Can\'t find the page.');return;}
if(ScreenCurrent){window.onresize=null;try{if(ScreenCurrent.close&&ScreenCurrent.close()===false){return;}}catch(e){console.warn(ScreenCurrent.constructor.name+' close 方法报错:'+e);}}
var screenObj=Object.create(screenClass.prototype);ScreenCurrent=(screenClass.apply(screenObj,Array.prototype.slice.call(arguments,1))||screenObj);if(ScreenCurrent.onresize)window.onresize=ScreenCurrent.onresize;ScreenCurrent.show();};ScreenManager._getFunctionParams=function(func){var STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg,ARGUMENT_NAMES=/([^\s,]+)/g,fnStr,result;fnStr=func.toString().replace(STRIP_COMMENTS,'');result=fnStr.slice(fnStr.indexOf('(')+1,fnStr.indexOf(')')).match(ARGUMENT_NAMES);if(result===null){result=[];}
return result;};ScreenManager._getHashParamsMap=function(){var list,map={};list=location.hash.substr(1).split('&');for(var m=0;m<list.length;m++){var item=list[m].split('=');map[item[0]]=_unserializeParams(item[1]);}
return map;};ScreenManager.getPageId=function(){var hashMap=ScreenManager._getHashParamsMap();var params;if(typeof hashMap.id!==typeof undefined){return hashMap.id;}
if(hashMap.reportId){return hashMap.reportId;}
if(typeof hashMap.options==='string'){params={};try{params=JSON.parse(window.decodeURIComponent(hashMap.options));}catch(e){}
return params.id;}
if(typeof hashMap.options==='object'&&hashMap.options){return hashMap.options.id;}};ScreenManager.loadProjectMenu=function(project,page_id){ScreenManager.projectSelector.initProject(project['id'],page_id);};ScreenManager.loadUserPanel=function(){$("#right-nav").show();};ScreenManager.screenChange=function(e){var paramsMap=ScreenManager._getHashParamsMap(),project;if(typeof paramsMap.projectId!==typeof undefined){AppConfig.projectId=parseInt(paramsMap.projectId);project=BEOPUtil.getProjectFromAppConfig(AppConfig.projectId);if(!project){alert.danger(I18n.resource.error.noPermission);return false;}
AppConfig.projectTimeFormat=project.time_format||0;}
var promise=$.Deferred();if(I18n&&I18n.resource){promise.resolve();}else{InitI18nResource().always(function(rs){I18n=new Internationalization(null,rs);promise.resolve();});}
promise.always(function(){var screen,currentPage,screenParamsNameList=[],screenParamsValueList=[];if(AppConfig.afterLogin){$('#navHeader').fadeIn();$('#indexMain').css({top:'53px'});}
if(project){AppConfig.projectEnName=project['name_en'];AppConfig.projectName=project['name_en'];if(location.hash!=ScreenManager.paneRoot&&!AppConfig.navItems){ScreenManager.loadProjectMenu(project,paramsMap.id);}else{ScreenManager.projectSelector.setMenuActive();}}
ScreenManager.loadUserPanel();currentPage=paramsMap[ScreenManager.screenFlag];if(currentPage){if(currentPage.indexOf('.')>0){screen=namespace(currentPage)}else{if(currentPage==='EnergyScreen_M'){currentPage='EnergyScreen';}
screen=window[currentPage]||namespace('observer.screens')[currentPage];}}else{console.error('无法识别的location hash! hash is '+location.hash);return true;}
if(screen&&typeof screen==='function'){screenParamsNameList=ScreenManager._getFunctionParams(screen);for(var m=0;m<screenParamsNameList.length;m++){var paramName=screenParamsNameList[m];if(typeof paramsMap[paramName]!=='undefined'){screenParamsValueList[m]=paramsMap[paramName];}else{screenParamsValueList[m]=undefined;}}
ScreenManager.applyScreen.apply(null,[screen].concat(screenParamsValueList));I18n.fillArea($('#navPane'));return false;}else{return true;}});};ScreenManager.goTo=function(pageInfo){var hashFlag='#',hashList=[];if(!pageInfo){return false;}
if(AppConfig.projectId){pageInfo['projectId']=AppConfig.projectId;}
if(pageInfo[ScreenManager.screenFlag]){hashList.push(ScreenManager.screenFlag+'='+pageInfo[ScreenManager.screenFlag]);}
for(var param in pageInfo){if(pageInfo.hasOwnProperty(param)){if(param!==ScreenManager.screenFlag){hashList.push(param+'='+_serializeParams(pageInfo[param]));}}}
if(location.hash===hashFlag+hashList.join('&')){Spinner&&Spinner.stop();}else{location.hash=hashFlag+hashList.join('&');}};ScreenManager.listen=function(){if("onhashchange"in window&&(!document.documentMode||document.documentMode>=8)){ScreenManager.isListening=true;window.onhashchange=ScreenManager.screenChange;ScreenManager.detectAnchorHash();if(location.hash===''){if(AppConfig.afterLogin){window.addEventListener('load',function(){location.hash=ScreenManager.paneRoot;ScreenManager.projectSelector.show();},false);}else{location.hash=ScreenManager.root;}}else{if(location.hash==ScreenManager.root){if(AppConfig.afterLogin){location.hash=ScreenManager.paneRoot;}else{ScreenManager.screenChange();}}
if(AppConfig.afterLogin){window.addEventListener('load',function(){ScreenManager.screenChange();ScreenManager.projectSelector.init();},false)}else{location.hash=ScreenManager.root;}}}else{console.error('This browser can\'t support onhashchange event.')}};ScreenManager.detectAnchorHash=function(){var isValidHash=function(hash){if(typeof hash===typeof undefined||hash.startsWith('http')||hash.startsWith('https')||hash.startsWith('blob')){return true;}else if(hash==='/factory'||hash==='/point_tool/editor'){return true;}else{return hash.indexOf('=')!=-1;}};$(document).on('click.anchorHash','a',function(ev){var $this=$(this),hash=$this.attr('href'),isManagedHash=$this.attr('nothash');if(typeof isManagedHash!==typeof undefined&&isManagedHash!==false){return true;}
if(!isValidHash(hash)){ev.preventDefault();var dom=document.getElementById(hash.substr(1));if(dom){dom.scrollIntoView();}}
return true;})};if(typeof AppConfig!=typeof undefined){ScreenManager.listen();try{ScreenManager.setProjectSelector(PaneProjectSelector);}catch(e){}}
function _serializeParams(params){return window.encodeURIComponent(JSON.stringify(params));}
function _unserializeParams(params){try{params=JSON.parse(window.decodeURIComponent(params));}catch(e){}
return params;}
return ScreenManager;})();﻿
var beop=beop||{};beop.constant={project_img_path:'/static/images/project_img/',project_default_img:'default.jpg',BEOP_IMG_HOST:'http://images.rnbtech.com.hk',OSS_PROJECT_IMG_PATH:'/custom/project_img/'};var ObjectId=function(){var timestamp=new Date().valueOf();var userId=('000'+((window.AppConfig&&window.AppConfig.userId)||'000')).slice(-3);var hex8=('00000000'+Math.floor(Math.random()*0xFFFFFFFF).toString(16)).slice(-8);return timestamp+userId+hex8;};(function(exports){exports.namespace=function(path){var obj=window;path=path.split('.');path.forEach(function(p,i){p=p.trim();if(i===0&&p==='window')return;obj=obj[p]=obj[p]||{};});return obj;};}(window));(function(exports){exports.Mixin=function(){var prototype={};var methods;for(var i=0,len=arguments.length;i<len;i++){methods=arguments[i];for(var m in methods){prototype[m]=methods[m];}}
return prototype;};}(window));(function(){var ENUM_LEVEL={LOG:1,INFO:2,DEBUG:3,WARN:4,ERROR:5,EXCEPTION:6};window.Log={level:ENUM_LEVEL.WARN,log:function(){if(this.level>ENUM_LEVEL.LOG)return;Log._out('log',arguments);},info:function(){if(this.level>ENUM_LEVEL.INFO)return;Log._out('info',arguments);},debug:function(){if(this.level>ENUM_LEVEL.DEBUG)return;Log._out('debug',arguments);},warn:function(){if(this.level>ENUM_LEVEL.WARN)return;Log._out('warn',arguments);},error:function(){if(this.level>ENUM_LEVEL.ERROR)return;Log._out('error',arguments);},exception:function(message,exception){if(this.level>ENUM_LEVEL.EXCEPTION)return;if(exception){Log.error('Exception: ',message,exception.stack||exception);}else{Log.error('Exception: ',message);}},_out:function(type,args){console[type].apply(console,args)}};}());if(!Array.toMap){Array.toMap=function(arr,key){var map={};arr.forEach(function(row,i){map[row[key]]=row;});return map;};}
var FullScreenManager=(function(){var manager=Object.create({init:function(){var _this=this;$(document).off('webkitfullscreenchange');$(document).on('webkitfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('mozfullscreenchange');$(document).on('mozfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('msfullscreenchange');$(document).on('msfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});if(typeof onError==='function'){$(document).off('webkitfullscreenerror');$(document).on('webkitfullscreenerror',this.onFullScreenError);$(document).off('mozfullscreenerror');$(document).on('mozfullscreenerror',this.onFullScreenError);$(document).off('msfullscreenerror');$(document).on('msfullscreenerror',this.onFullScreenError);}},onFullScreenEnter:function(){},onFullScreenOut:function(){},onFullScreenError:function(){},toggle:function(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!document.msFullscreenElement){if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}}});manager.init();return manager;}());function StringBuilder(){this.data=Array("");}
StringBuilder.prototype.append=function(){this.data.push(arguments[0]);return this;};StringBuilder.prototype.toString=function(){return this.data.join("");};StringBuilder.prototype.getLength=function(){return this.data.length;};if(!String.prototype.format){String.prototype.format=function(){if(arguments[0]===undefined){return'';}
if(arguments[0].constructor===Array){var args=arguments[0];}else{var args=arguments;}
return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
if(!String.prototype.formatEL){String.prototype.formatEL=function(o,defaultVal){var str=this.toString();if(!str||!o)return'';for(var p in o){if(o.hasOwnProperty(p)){str=str.replace(new RegExp('{'+p+'}','g'),o[p]);}}
if(typeof defaultVal!=='undefined'){str=str.replace(/{[^{}]*?}/g,defaultVal);}
return str;};}
String.prototype.toDate=function(){var str=this;if(str.indexOf('-')>-1)
str=str.replace('-','/').replace('-','/');return new Date(str);};if(!String.prototype.startsWith){String.prototype.startsWith=function(word){return new RegExp('^'+word).test(this);}}
Number.prototype.toDate=function(){return new Date(this);};function Alert(targetElement,type,msg){this.element=targetElement;this.str=new StringBuilder();this.str.append('<div style="display:none;" class="alert beop-alert alert-').append(type).append(' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<div class="alert-msg">'+msg+'</div>').append('</div>');this.$alert=$(this.str.toString());}
Alert.danger=function(targetElement,msg){return new Alert(targetElement,Alert.type.danger,msg);};Alert.warning=function(targetElement,msg){return new Alert(targetElement,Alert.type.warning,msg);};Alert.success=function(targetElement,msg){return new Alert(targetElement,Alert.type.success,msg);};Alert.info=function(targetElement,msg){return new Alert(targetElement,Alert.type.info,msg);};Alert.closeAll=function(){$('.beop-alert').remove();};Alert.type={danger:'danger',warning:'warning',success:'success',info:'info'};Alert.prototype.show=function(duration){Alert.closeAll();if(duration){var _this=this;setTimeout(function(){_this.close();},duration);}
$(this.element).append(this.$alert);this.$alert.slideDown(500);return this;};Alert.prototype.close=function(){var _this=this;this.$alert.slideUp(500,function(){_this.$alert.remove();_this=null;});};Alert.prototype.setMessage=function(msg){if(!msg){return false}
this.$alert.find('.alert-msg').text(msg);};Alert.prototype.setStyle=function(style){if(style&&typeof style!=='string'){this.$alert.css(style);}
return this;};Alert.prototype.showAtTop=function(duration){this.setStyle({position:'absolute',top:0,left:0,right:0,margin:'auto',width:'30%',textAlign:'center',zIndex:10000});if(!duration){duration=2000;}
this.show(duration);};function showDialog(url){return WebAPI.get(url).done(function(resultHtml){$("#dialogContent").html(resultHtml);$('#dialogModal').modal({});});}
function clone(obj){if(obj==null||typeof(obj)!='object')
return obj;var temp=obj.constructor();for(var key in obj){if(obj.hasOwnProperty(key)){temp[key]=clone(obj[key]);}}
return temp;}
Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var week={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
if(/(E+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,((RegExp.$1.length>1)?(RegExp.$1.length>2?"/u661f/u671f":"/u5468"):"")+week[this.getDay()+""]);}
for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)));}}
return fmt;};Date.prototype.timeFormat=function(format,type,language,option){var date=this;if(format&&(typeof format=='string'||typeof format=='object')){if(typeof format=='object'&&(!format.separators||!format.parts)){format='yyyy-mm-dd hh:ii:ss';}}else{format='yyyy-mm-dd hh:ii:ss';}
if(arguments.length>=2){var paramArr=(function(arrayish){return[].slice.call(arrayish);})(arguments);paramArr.shift();type=language=option=null;paramArr.forEach(function(it,i){if(typeof it=='string'){language=it;}else if(typeof it=='number'){type=it;}else if(typeof it=='object'){option=it;}});}
var isReturnNull=false;if(option){for(var k in option){if(k=='isReturnNull'){isReturnNull=option[k];}}}
if(date=='Invalid Date'){console.warn("Invalid date.");if(isReturnNull){return'';}else{return date.toString();}}
var DATES={en:{"days":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"daysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],"daysMin":["Su","Mo","Tu","We","Th","Fr","Sa","Su"],"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"meridiem":["am","pm"]}};language=language?(DATES[language]?language:'en'):'en';var formatObj=(function(formatStr){if(typeof formatStr=='object'){return formatStr;}
if(type){formatStr=timeFormatChange(formatStr,type);}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};})(format);var val={yy:date.getFullYear().toString().substring(2),yyyy:date.getFullYear(),m:date.getMonth()+1,M:DATES[language].monthsShort[date.getMonth()],MM:DATES[language].months[date.getMonth()],d:date.getDate(),D:DATES[language].daysShort[date.getDay()],DD:DATES[language].days[date.getDay()],p:(DATES[language].meridiem.length==2?DATES[language].meridiem[date.getHours()<12?0:1]:''),h:date.getHours(),i:date.getMinutes(),s:date.getSeconds()};if(DATES[language].meridiem.length==2){val.H=(val.h%12==0?12:val.h%12);}
else{val.H=val.h;}
val.HH=(val.H<10?'0':'')+val.H;val.P=val.p.toUpperCase();val.hh=(val.h<10?'0':'')+val.h;val.ii=(val.i<10?'0':'')+val.i;val.ss=(val.s<10?'0':'')+val.s;val.dd=(val.d<10?'0':'')+val.d;val.mm=(val.m<10?'0':'')+val.m;var finTime='';for(var i=0,len=formatObj.separators.length;i<len;i++){finTime+=formatObj.separators[i]+(formatObj.parts[i]?val[formatObj.parts[i]]:'');}
return finTime;};var DateUtil=(function(){var dateLocale={month:{en:{month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],month_names_short:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']},zh:{month_names:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],month_names_short:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']}}};function getWeekNumber(d){d=new Date(+d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7);return[d.getFullYear(),weekNo];}
function getLastWeekNumberOf(y,w){w-=1;if(w===0){y=y-1;w=52;}
return[y,w];}
function getNextWeekNumberOf(y,w){w+=1;if(w===53){y+=1;w=1;}
return[y,w];}
function isLeapYear(y){if(Object.prototype.toString.call(y)==='[object Date]'){y=y.getFullYear();}
return((y%4===0)&&(y%100!==0))||(y%400===0);}
function daysInMonth(dt){var m=dt.getMonth();if(m===1){return isLeapYear(dt)?29:28;}
return[31,28,31,30,31,30,31,31,30,31,30,31][m];}
function getFirstDayOfWeek(year,week){var d=new Date(year,0,1),offset=d.getTimezoneOffset();d.setDate(d.getDate()+4-(d.getDay()||7));d.setTime(d.getTime()+7*24*60*60*1000*(week+(year==d.getFullYear()?-1:0)));d.setTime(d.getTime()
+(d.getTimezoneOffset()-offset)*60*1000);d.setDate(d.getDate()-3);return d;}
function getDateRangeOnWeekNumber(year,week){if(!year||!week){return;}
var firstDay=getFirstDayOfWeek(year,week),lastDay=new Date(firstDay);lastDay.setDate(firstDay.getDate()+6);return[firstDay,lastDay];}
function getMonthName(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names:dateLocale.month['en'].month_names;return monthList[index];}
function getMonthNameShort(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names_short:dateLocale.month['en'].month_names_short;return monthList[index];}
function getLastMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===1){return 12;}else{return currentMonth-1;}}
function getNextMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===12){return 1;}else{return currentMonth+1;}}
function getRelativeDateInfo(date1,date2){var now=new Date();var lang=I18n.type;var value1,value2,ts,info;if(!date1&&!date2)return'';value1=(date1||now).valueOf();value2=(date2||now).valueOf();ts=Math.floor(Math.abs(value1-value2)/1000);switch(true){case ts<60:info=ts+(ts===1?' second':' seconds');break;case ts<3600:ts=Math.floor(ts/60);info=ts+(ts===1?' minute':' minutes');break;case ts<86400:ts=Math.floor(ts/(3600));info=ts+(ts===1?' hour':' hours');break;case ts<31536000:ts=Math.floor(ts/(86400));info=ts+(ts===1?' day':' days');break;default:ts=Math.floor(ts/(31536000));info=ts+(ts===1?' year':' years');break;}
info+=value1>value2?' ago':' later';if(lang==='zh'){info=info.replace(/\s(seconds?|minutes?|hours?|days?|years?)\s(ago|later)$/,function($0,$1,$2){var rs='';if($1.indexOf('second')>-1)rs+='秒';if($1.indexOf('minute')>-1)rs+='分钟';if($1.indexOf('hour')>-1)rs+='小时';if($1.indexOf('day')>-1)rs+='天';if($1.indexOf('year')>-1)rs+='年';if($2==='ago')rs+='前';if($2==='later')rs+='后';return rs;});}
return info;}
return{getWeekNumber:getWeekNumber,isLeapYear:isLeapYear,daysInMonth:daysInMonth,getLastWeekNumberOf:getLastWeekNumberOf,getNextWeekNumberOf:getNextWeekNumberOf,getDateRangeOnWeekNumber:getDateRangeOnWeekNumber,getFirstDayOfWeek:getFirstDayOfWeek,getMonthName:getMonthName,getMonthNameShort:getMonthNameShort,getLastMonth:getLastMonth,getNextMonth:getNextMonth,getRelativeDateInfo:getRelativeDateInfo,DATA_FORMAT:{FULL_DATETIME:'yyyy-mm-dd hh:ii:ss',FULL_DATETIME_CHANGE:'yyyy-MM-dd HH:mm:ss',FULL_DATETIME_ALL_SEC_CHANGE:'yyyy-MM-dd 00:00:00',FULL_DATETIME_ZERO_SEC_CHANGE:'yyyy-MM-dd HH:mm:00',FULL_DATETIME_NO_SEC_CHANGE:'yyyy-MM-dd HH:mm',FULL_DATETIME_ZERO_SEC:'yyyy-mm-dd hh:ii:00',FULL_DATETIME_HH_00_00:'yyyy-mm-dd hh:00:00',FULL_DATETIME_00_00_00:'yyyy-mm-dd 00:00:00',FULL_DATETIME_NO_SEC:'yyyy-mm-dd hh:ii',FULL_DATETIME_HH_00:'yyyy-mm-dd hh:00',FULL_DATETIME_00_00:'yyyy-mm-dd 00:00',FULL_DATE:'yyyy-mm-dd',TIME:'hh:ii:ss',TIME_HOUR_MINUTE:'hh:ii',TIME_ZERO_SEC:'hh:ii:00'}}})();var StringUtil=(function(){var HTML_ENTITIES={'&':'&amp;','>':'&gt;','<':'&lt;','"':'&quot;',"'":'&#39;','`':'&#x60;'},HTML_ENTITIES_INVERT=invert(HTML_ENTITIES);function invert(obj){var result={},keys=Object.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i];}
return result;}
function padLeft(oldStr,padNum,padStr){if(!padStr){return oldStr;}
return new Array(padNum-String(oldStr).length+1).join(padStr)+oldStr;}
function htmlEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES[character];});}
function htmlUnEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES_INVERT).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES_INVERT[character];});}
var getI18nProjectName=function(project){if(!I18n||!project){return'';}
var result='';switch(I18n.type){case'en':{result=project.name_english;break;}
case'zh':{result=project.name_cn;break;}
default:{result=project.name_english;}}
return result||'';};return{padLeft:padLeft,htmlEscape:htmlEscape,htmlUnEscape:htmlUnEscape,getI18nProjectName:getI18nProjectName}})();var BEOPUtil=(function(){var jsType={function:typeof $.noop,number:typeof 0,string:typeof'',undefined:typeof undefined};var projectImgPath=beop.constant.project_img_path;var setRelativePosition=function($obj,$target,topOffset,leftOffset){$target.css({"left":$obj.offset().left+$obj.width()+(leftOffset||5),"top":$obj.offset().top+(topOffset||10)});};var projectDefaultImgPath=projectImgPath+beop.constant.project_default_img;var getProjectImgPath=function(project){if(project){return project.pic?projectImgPath+project.pic:projectDefaultImgPath;}};var getProjectFromAppConfig=function(projectId){for(var m=0,len=AppConfig.projectList.length;m<len;m++){if(AppConfig.projectList[m].id==projectId){return AppConfig.projectList[m];}}};function getFunctionName(func){if(!func||typeof func!=jsType.function){return'';}
var ret=func.toString();ret=ret.substr('function '.length);ret=ret.substr(0,ret.indexOf('('));return ret;}
function isUndefined(obj){return typeof obj===jsType.undefined;}
function getCookie(name){var value="; "+document.cookie;var parts=value.split("; "+name+"=");if(parts.length==2)return parts.pop().split(";").shift();}
function logicContentHandle(content){if(content){content=content.replace(/\t/g,'    ')}
return content;}
function copyToClipboard(text,valueContainer){var valueContainer=valueContainer?valueContainer:document.body;if(window.clipboardData&&window.clipboardData.setData){return clipboardData.setData("Text",text);}else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var textarea=document.createElement("textarea");textarea.textContent=text;textarea.style.position="fixed";valueContainer.appendChild(textarea);textarea.select();try{return document.execCommand("copy");}catch(ex){console.warn("Copy to clipboard failed.",ex);return false;}finally{valueContainer.removeChild(textarea);}}}
var projectImgType={logo:'logo.png',pdfCover:'pdf_cover.jpg'};function getProjectImgByType(projectId,name,extension){var img='';if(projectId){img+=projectId+'_';}
img+=name;if(extension){img+='.'+extension;}
return beop.constant.BEOP_IMG_HOST+beop.constant.OSS_PROJECT_IMG_PATH+img;}
function getProjectById(id){if(!id||!AppConfig.projectList){return null;}
for(var i=0;i<AppConfig.projectList.length;i++){var project=AppConfig.projectList[i];if(project.id==id){return project;}}
return null;}
return{setRelativePosition:setRelativePosition,getProjectImgPath:getProjectImgPath,getFunctionName:getFunctionName,isUndefined:isUndefined,getCookie:getCookie,getProjectFromAppConfig:getProjectFromAppConfig,logicContentHandle:logicContentHandle,copyToClipboard:copyToClipboard,getProjectImgByType:getProjectImgByType,getProjectById:getProjectById,projectImgType:projectImgType}})();(function(){var beop_tmpl_cache={};this.beopTmpl=function tmpl(str,data,htmlStr){var fn=!/\W/.test(str)?beop_tmpl_cache[str]=beop_tmpl_cache[str]||tmpl(htmlStr?htmlStr:document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split(/<!/).join("\t").replace(/((^|!>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)!>/g,"',$1,'").split("\t").join("');").split(/!>/).join("p.push('").split("\r").join("\\'")
+"');}return p.join('');");return data?fn(data):fn;};})();var SidebarMenuEffect=(function(){function SidebarMenuEffect(){}
SidebarMenuEffect.prototype.init=function(center,left,right){var _this=this;this.$paneCt=$(center);this.$leftBtn=$(center).find('#leftCt');this.$rightBtn=$(center).find('#rightCt');var container=document.getElementById('st-container'),buttons=Array.prototype.slice.call(document.querySelectorAll('.sideTrans')),refresh=function(){var leftCol=0,rightCol=0,centerCol=0;var leftArrow='<span class="glyphicon glyphicon-chevron-left"></span>';var rightArrow='<span class="glyphicon glyphicon-chevron-right"></span>';if(_this.$leftBtn.length>0){if(container.className.indexOf('st-effect-7')>0){var prev=_this.$paneCt.prev('div')[0];if(prev&&prev.className.indexOf('col-')>-1){leftCol=parseInt(prev.classList[0].split('-')[2]);}else{leftCol=0;}
_this.$leftBtn.removeClass('leftCtClose').addClass('leftCtOpen').html(leftArrow);}else{leftCol=0;_this.$leftBtn.removeClass('leftCtOpen').addClass('leftCtClose').html(rightArrow);}}
if(_this.$rightBtn.length>0){if(container.className.indexOf('st-effect-1')>0){var next=_this.$paneCt.next('div')[0];if(next&&next.className.indexOf('col-')>-1){rightCol=parseInt(next.classList[0].split('-')[2]);}else{rightCol=0;}
_this.$rightBtn.removeClass('rightCtClose').addClass('rightCtOpen').html(rightArrow);}else{rightCol=0;_this.$rightBtn.removeClass('rightCtOpen').addClass('rightCtClose').html(leftArrow);}}
centerCol=12-leftCol-rightCol;_this.$paneCt.removeClass().addClass('col-sm-'+centerCol+' st-content');};buttons.forEach(function(el,i){var effect=el.getAttribute('data-effect');el.addEventListener('click',function(ev){var target=ev.target.getAttribute('data-effect')!=null?ev.target.getAttribute('data-effect'):ev.target.parentNode.getAttribute('data-effect');var stCtClass=document.getElementById('st-container').className;if(stCtClass.indexOf(target)<0){ev.stopPropagation();ev.preventDefault();container.classList.add(effect);setTimeout(function(){if($(container.children[0]).children('div').length==3){container.classList.add('st-menu-open');}
refresh();},250);}else{container.classList.remove(target);refresh();}});});};return SidebarMenuEffect;})();(function(window){{var unknown='-';var screenSize='';if(screen.width){var width=(screen.width)?screen.width:'';var height=(screen.height)?screen.height:'';screenSize+=''+width+" x "+height;}
var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var browser=navigator.appName;var version=''+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if((verOffset=nAgt.indexOf('Opera'))!=-1){browser='Opera';version=nAgt.substring(verOffset+6);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('MSIE'))!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(verOffset+5);}
else if((verOffset=nAgt.indexOf('Chrome'))!=-1){browser='Chrome';version=nAgt.substring(verOffset+7);}
else if((verOffset=nAgt.indexOf('Safari'))!=-1){browser='Safari';version=nAgt.substring(verOffset+7);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('Firefox'))!=-1){browser='Firefox';version=nAgt.substring(verOffset+8);}
else if(nAgt.indexOf('Trident/')!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(nAgt.indexOf('rv:')+3);}
else if((nameOffset=nAgt.lastIndexOf(' ')+1)<(verOffset=nAgt.lastIndexOf('/'))){browser=nAgt.substring(nameOffset,verOffset);version=nAgt.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName;}}
if((ix=version.indexOf(';'))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(' '))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(')'))!=-1)version=version.substring(0,ix);majorVersion=parseInt(''+version,10);if(isNaN(majorVersion)){version=''+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10);}
var mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);var cookieEnabled=(navigator.cookieEnabled)?true:false;if(typeof navigator.cookieEnabled=='undefined'&&!cookieEnabled){document.cookie='testcookie';cookieEnabled=(document.cookie.indexOf('testcookie')!=-1)?true:false;}
var os=unknown;var clientStrings=[{s:'Windows 3.11',r:/Win16/},{s:'Windows 95',r:/(Windows 95|Win95|Windows_95)/},{s:'Windows ME',r:/(Win 9x 4.90|Windows ME)/},{s:'Windows 98',r:/(Windows 98|Win98)/},{s:'Windows CE',r:/Windows CE/},{s:'Windows 2000',r:/(Windows NT 5.0|Windows 2000)/},{s:'Windows XP',r:/(Windows NT 5.1|Windows XP)/},{s:'Windows Server 2003',r:/Windows NT 5.2/},{s:'Windows Vista',r:/Windows NT 6.0/},{s:'Windows 7',r:/(Windows 7|Windows NT 6.1)/},{s:'Windows 8.1',r:/(Windows 8.1|Windows NT 6.3)/},{s:'Windows 8',r:/(Windows 8|Windows NT 6.2)/},{s:'Windows NT 4.0',r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:'Windows ME',r:/Windows ME/},{s:'Android',r:/Android/},{s:'Open BSD',r:/OpenBSD/},{s:'Sun OS',r:/SunOS/},{s:'Linux',r:/(Linux|X11)/},{s:'iOS',r:/(iPhone|iPad|iPod)/},{s:'Mac OS X',r:/Mac OS X/},{s:'Mac OS',r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:'QNX',r:/QNX/},{s:'UNIX',r:/UNIX/},{s:'BeOS',r:/BeOS/},{s:'OS/2',r:/OS\/2/},{s:'Search Bot',r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var id in clientStrings){var cs=clientStrings[id];if(cs.r.test(nAgt)){os=cs.s;break;}}
var osVersion=unknown;if(/Windows/.test(os)){osVersion=/Windows (.*)/.exec(os)[1];os='Windows';}
switch(os){case'Mac OS X':osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];break;case'Android':osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1];break;case'iOS':osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);osVersion=osVersion[1]+'.'+osVersion[2]+'.'+(osVersion[3]|0);break;}}
window.jscd={screen:screenSize,browser:browser,browserVersion:version,mobile:mobile,os:os,osVersion:osVersion,cookies:cookieEnabled};}(this));var getUrlParams=function(){var search=window.location.search.substring(1);var kvArr=search.split('&');var rs={};kvArr.forEach(function(kv){var arr=kv.split('=');if(typeof arr[1]!=='undefined'){rs[arr[0]]=arr[1];}});return rs;};$.fn.serializeObject=function(){var obj={};this.serializeArray().map(function(item){if(/\[\]$/.test(item.name)){if(obj[item.name]){obj[item.name].push(item.value);}else{obj[item.name]=[item.value];}}else{obj[item.name]=item.value;}});return obj;};function kIntSeparate(num,n){var number=num.toFixed(n?n:0);var source=String(number).split(".");source[0]=source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)','ig'),"$1,");return source.join(".");}
function timeFormatChange(format,type){var lastStr='';var formatObj=(function(formatStr){if(!formatStr||typeof formatStr=='object'){return;}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){return;}
return{separators:separators,parts:parts};})(format);if(formatObj){format='';for(var i=0,len=formatObj.separators.length-1;i<len;i++){format+=formatObj.separators[i]+formatObj.parts[i];}
lastStr=formatObj.separators[len];}
var formatArr=['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'];var formatChangeArr=[['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'],['M d, yyyy hh:ii:ss','M d, yyyy hh:ii','M d, yyyy hh','M d, yyyy','M, yyyy','M d hh:ii:ss','M d hh:ii','M d hh','M d'],['dd/mm/yyyy hh:ii:ss','dd/mm/yyyy hh:ii','dd/mm/yyyy hh','dd/mm/yyyy','mm/yyyy','dd/mm hh:ii:ss','dd/mm hh:ii','dd/mm hh','dd/mm']];if(formatArr.findIndex){var index=formatArr.findIndex(function(v){return v===format;});}else{for(var i=0;i<formatArr.length;i++){if(formatArr[i]===format){var index=i;break;}}}
type=Number(type);type&&(type>=formatChangeArr.length)&&(type=formatChangeArr.length-1);if(index==-1){console.log('format is not defined');return format+lastStr;}else{if(type===0){return formatChangeArr[0][index]+lastStr;}
return formatChangeArr[type||AppConfig.projectTimeFormat||0][index]+lastStr;}}
function timeFormat(time,format,language,option){var date,arr,arr2;var sort=function(year,month,day,time){year=year==undefined?'2001':year;month=month==undefined?'01':month;day=day==undefined?'01':day;time=time==undefined?'':(' '+time);return new Date(year+'/'+month+'/'+day+time);}
if(time instanceof Date){date=time;}else if(typeof(time)=='string'){if(/^\d{1,2}-\d{1,2}/.test(time)){arr=time.split(' ');arr2=arr[0].split('-');time=arr2[1]+'-'+arr2[0]+(arr2[2]==undefined?'':('-'+arr2[2]))+(arr[1]==undefined?'':(' '+arr[1]));}
time=time.replace(/-/g,"/");arr=time.split(' ');arr2=arr[0].split('/');if(/^\d{4}/.test(time)){date=sort(arr2[0],arr2[1],arr2[2],arr[1]);}else if(/^\d{1,2}\/\d{4}/.test(time)){date=sort(arr2[1],arr2[0],'01',arr[1]);}else if(/^\d{1,2}\/\d{1,2}/.test(time)){date=sort(arr2[2],arr2[1],arr2[0],arr[1]);}else{date=new Date(time);}}else{date=new Date(time);}
return date.timeFormat(format,language,option);}
(function(exports){var MINITE_1=60000;var MINITE_5=300000;var HOUR_1=3600000;var DAY_1=86400000;var DAY_365=31536000000;function _formatTimeStr(str,format){var arr=str.split(' ');var date=arr[0].split('-');var time=arr[1].split(':');return format.replace('yyyy',date[0]).replace('MM',date[1]).replace('dd',date[2]).replace('HH',time[0]).replace('mm',time[1]).replace('ss',time[2]);}
function _explainPattern(timeShaft){var startTime=new Date(timeShaft[0]);var endTime=new Date(timeShaft[timeShaft.length-1]);var timeRange=endTime.valueOf()-startTime.valueOf();var timeInterval=timeRange/(timeShaft.length-1);var pattern='MM-dd HH:mm';if(timeInterval<=MINITE_5){if(timeRange<=HOUR_1){pattern='HH:mm';}else if(timeRange<=DAY_1){pattern='HH:mm';}}
else if(timeInterval<=HOUR_1){if(timeRange<=DAY_1){pattern='HH:mm';}else{pattern='MM-dd HH:mm';}}
else if(timeInterval<=DAY_1){if(timeRange<=DAY_365){pattern='MM-dd';}else{pattern='yyyy-MM-dd';}}
else{pattern='yyyy-MM';}
return pattern;}
function _explain(timeShaft){pattern=getPattern(timeShaft);if(pattern){timeShaft=timeShaft.map(function(row){return _formatTimeStr(row,pattern);});}
return timeShaft;}
function _valid(params){var flag=Object.prototype.toString.call(params)==='[object Array]';return flag&&/^[\d-]{10} [\d:]{8}$/.test(params[0]);}
var _getTimePattern=function(timeShaft){if(!_valid(timeShaft)){return;}
if(timeShaft.length<=1){return;}
return _explainPattern(timeShaft);};var formatTimeShaft=exports.formatTimeShaft=function(timeShaft){if(!_valid(timeShaft)){console.warn('function arguments is not a valid time shaft array!');return timeShaft;}
if(timeShaft.length<=1){return timeShaft;}
return _explain(timeShaft);};function _formatTimeStrByAppConfig(data){var formatArr,formatStr,regularArr,language,formatObj;switch(AppConfig.projectTimeFormat||0){case 0:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';break;case 1:formatArr=['M d, yyyy','M d hh:ii','M, yyyy','M, yyyy','M d'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;case 2:formatArr=['dd/mm/yyyy','dd/mm hh:ii','mm/yyyy','mm/yyyy','dd/mm'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;default:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';}
for(var i=0,len=regularArr.length;i<len;i++){if(regularArr[i].test(data)){formatStr=formatArr[i];break;}}
if(formatStr){formatObj=(function _parseFormat(formatStr){var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};})(formatStr);return{formatStr:formatStr,language:language,formatObj:formatObj};}else{return;}}
if(window.echarts){echarts.registerPreprocessor(function(option){var pattern;var formatInfo,firstValue;if(option.formatTime===false){pattern=_getTimePattern(option.xAxis[0].data);echarts.formatTimePattern=pattern;return;}
if(option.xAxis&&option.xAxis.length){option.xAxis.forEach(function(row){if(row.data&&row.data.length){pattern=_getTimePattern(row.data);formatInfo=_formatTimeStrByAppConfig(row.data[0]);if(pattern){row.data=row.data.map(function(row){return row.substr(0,16);});firstValue=_formatTimeStr(row.data[0],pattern);formatInfo=_formatTimeStrByAppConfig(firstValue);if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}else{row.data=row.data.map(function(it,i){return _formatTimeStr(it,pattern);});}}else if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}}});}});}}(window));var generateTimeOption=function(option){var timeConfig=clone(option);(!timeConfig.timeStart)&&(timeConfig.timeStart=timeConfig.startTime);(!timeConfig.timeEnd)&&(timeConfig.timeEnd=timeConfig.endTime);(!timeConfig.timeFormat)&&(timeConfig.timeFormat=timeConfig.format);var recentTime={};var now=new Date();if(typeof option=='string'){recentTime=generateRecentTime(option)}else if(option&&option.timeRecent){if(typeof option.timeRecent=='string'){recentTime=generateRecentTime(option.timeRecent)}else if(option.timeRecent.hasOwnProperty('unit')&&option.timeRecent.hasOwnProperty('val')){recentTime=generateRecentTimeCustom(option.timeRecent)}}
if(recentTime&&Object.keys(recentTime).length>0){timeConfig.timeStart=recentTime.timeStart;timeConfig.timeEnd=recentTime.timeEnd;if(recentTime.format){timeConfig.timeFormat=recentTime.format;}
switch(timeConfig.timeFormat){case'h1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-dd HH:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-dd HH:00:00');break;case'd1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-dd 00:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-dd 00:00:00');break;case'M1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-01 00:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-01 00:00:00');break;}}
timeConfig.startTime=timeConfig.timeStart;timeConfig.endTime=timeConfig.timeEnd;timeConfig.format=timeConfig.timeFormat;return timeConfig;function generateRecentTime(time){var startTime,endTime,format;switch(time){case'today':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-86400000).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'threeDay':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-259200000).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'yesterday':endTime=new Date(new Date().setDate(now.getDate()-1)).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(new Date().setDate(now.getDate()-2)).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'thisWeek':endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(now-604800000).format('yyyy-MM-dd HH:mm:ss');format='d1';break;case'lastWeek':endTime=new Date(now-(now.getDay()+1)*86400000).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-(now.getDay()+7)*86400000).format('yyyy-MM-dd HH:mm:ss');format='d1';break;case'thisYear':endTime=new Date(now-(now.getDay()+1)*86400000).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-(now.getDay()+7)*86400000).format('yyyy-MM-dd HH:mm:ss');format='M1';break;}
return{timeStart:startTime,timeEnd:endTime,format:format}}
function generateRecentTimeCustom(time){var startTime,endTime,format;switch(time.unit){case'hour':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-3600000*time.val).format('yyyy-MM-dd HH:mm:ss');break;case'day':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-86400000*time.val).format('yyyy-MM-dd HH:00:00');break;case'month':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-2592000000*time.val).format('yyyy-MM-dd HH:00:00');break;}
return{timeStart:startTime,timeEnd:endTime}}};﻿var WebAPI=(function(){var siteId;switch(window.location.hostname){case'beop.rnbtech.com.hk':siteId='b79c068f77198848e22fe79758836e53';break;case'beop6.rnbtech.com.hk':siteId='f1f6b2b9e6b64592c0b4cb5e9b8bd79e';break;case'beopdemo.rnbtech.com.hk':siteId='ac0df98f274d9a5980a571297248d80b';break;default:break;}
(function(){if(siteId){var hm=document.createElement("script");hm.src="//hm.baidu.com/hm.js?"+siteId;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);}})();var mockList={'/static/mock/analysis_workspace_saveLayout.json':/\/analysis\/workspace\/saveLayout\/\d+\/[01]/i,'/static/mock/analysis_template_get.json':/\/analysis\/template\/get\/\d+/i};function mock(url){var match=null;for(var i in mockList){match=url.match(mockList[i]);if(match!==null)return i;}
return url;}
function requestFailHandle(result){if(result&&result.status==401){alert(i18n_resource.error.noPermission);}}
function WebAPI(){}
WebAPI.isMock=false;$.ajaxSetup({converters:{"text json":true},dataFilter:function(result,type){var data=result;if(type==='script'){return data;}else if(typeof data==='string'){if(/^\s*</.test(data)){return data;}
try{data=JSON.parse(result);}catch(e){console.log('request error: '+e+', the data is :'+data);return data;}}
if(data){if(data.error){switch(data.error){case'token_invalid':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');if(typeof LoginValidate!='undefined'){var validate=new LoginValidate();validate.show();return;}
confirm(i18n_resource.error.token[data.msg]+'. '+i18n_resource.error.relogin+'.',function(){if(AppConfig.isMobile){location.reload();}else{location.href='/';}});break;}
case'historyData':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');alert(data.msg);return{};}
default:break;}}
if(data.code==403){console.log(this.url+' ('+data.msg+'")');alert(I18n.resource.error.noPermission);return{};}}
return data;}});WebAPI.post=function(url,data,isMock){var mockUrl;isMock=isMock===undefined?WebAPI.isMock:isMock;if(isMock){mockUrl=mock(url);if(url!==mockUrl)return this.get(mockUrl,false);}
if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1)}}
return $.ajax({url:url,type:'POST',data:JSON.stringify(data),contentType:'application/json'}).fail(requestFailHandle);};WebAPI.get=function(url,isMock){isMock=isMock===undefined?WebAPI.isMock:isMock;url=isMock?mock(url):url;if(window._hmt&&url.indexOf('.html')>0)window._hmt.push(['_trackPageview',url]);if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1)}}
return $.ajax({url:url,type:'Get',contentType:'application/json'}).fail(requestFailHandle);};WebAPI.getHistoryDS=function(callback){};WebAPI.getHistory=function(callback){};return WebAPI;})();(function(){'use strict';var indexedDB=indexedDB||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(!indexedDB){return;}
function _initStorage(options){var _this=this;this._dbInfo=$.extend({db:null},options);var promise=$.Deferred();(function(){var _this=this;var dbInfo=this._dbInfo;var openreq=indexedDB.open(dbInfo.name,dbInfo.version);openreq.onerror=function(){promise.reject(openreq.error);};openreq.onsuccess=function(){dbInfo.db=openreq.result;promise.resolve();};openreq.onupgradeneeded=function(){var names=openreq.result.objectStoreNames;var length,key;var indexOf=([]).indexOf;if(indexOf.call(names,'cache')>-1){openreq.result.deleteObjectStore('cache');}
if(indexOf.call(names,'datasource')>-1){openreq.result.deleteObjectStore('datasource');}
if(indexOf.call(names,'thumbnail')>-1){openreq.result.deleteObjectStore('thumbnail');}
if(indexOf.call(names,'buffer')===-1){openreq.result.createObjectStore('buffer');}
openreq.result.createObjectStore('datasource');openreq.result.createObjectStore('thumbnail');for(var i=0,len=localStorage.length;i<len;i++){key=localStorage.key(i);if(key.indexOf('workSpacePicStorageEnable')===0){localStorage.removeItem(key);}}};}).call(this);}
function length(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.count();req.onsuccess=function(){promise.resolve(req.result);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.get(key);req.onsuccess=function(){var value=req.result;value=value===undefined?null:value;promise.resolve(value);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var result={};var promise=this.iterate(function(key,value,i){if(keyList.indexOf(key)>-1){result[key]=value;}}).then(function(){return result;},function(){console.warn('getItemList error!');});excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.put(value,key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();try{(function(){var _this=this;var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var result={};kvList.forEach(function(kv,i){var key=kv.key,value=kv.value;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
store.put(value,key);});transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=transaction.error;promise.reject(err);};}).call(this);}catch(e){console.warn('setItemList error!');promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.delete(key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;var request;if(!cursor){promise.resolve();return;}
if(keyList.indexOf(cursor.key)>-1){cursor.delete();}
cursor.continue();};req.onerror=function(err){promise.reject(err);};}).call(this);}catch(e){promise.reject();}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.clear();transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var advanced=false;req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(null);return;}
if(n===0){promise.resolve(cursor.key);}else{if(!advanced){advanced=true;cursor.advance(n);}else{promise.resolve(cursor.key);}}};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var keys=[];var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(keys);return;}
keys.push(cursor.key);cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var index=0;req.onsuccess=function(){var cursor=req.result;var result;if(!cursor){promise.resolve();return;}
result=iterator(cursor.key,cursor.value,index++);if(result===false){promise.resolve();return;}
cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var indexDBWrapper={_driver:'indexedDBWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.indexedDB=indexDBWrapper;}).call(this);(function($){'use strict';var localStorage;try{if(!this.localStorage||!('setItem'in this.localStorage)){return;}
localStorage=this.localStorage;}catch(e){return;}
function _initStorage(options){this._dbInfo=$.extend({},options);this._dbInfo.keyPrefix=this._dbInfo.name+'/';}
function length(callback){var _this=this;var promise=this.keys().then(function(keys){return keys.length;});excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var result;result=localStorage.getItem(this._dbInfo.keyPrefix+key);try{result=JSON.parse(result);}catch(e){}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var _this=this;var promise=$.Deferred();(function(){var result={};keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
result[key]=localStorage.getItem(_this._dbInfo.keyPrefix+key);try{result[key]=JSON.parse(result[key]);}catch(e){}});promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var _this=this;var result;try{try{value=JSON.stringify(value);}catch(e){}
result=localStorage.setItem(_this._dbInfo.keyPrefix+key,value);promise.resolve(result);}catch(e){result=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}
promise.reject(e);}}).call(this);excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();(function(){var _this=this;var result={};kvList.forEach(function(kv,i){var value;if(typeof kv.key!=='string'){console.warn('The key is not a string!');kv.key=String(kv.key);}
try{try{value=JSON.stringify(kv.value);}catch(e){value=kv.value;}
result[kv.key]=localStorage.setItem(_this._dbInfo.keyPrefix+kv.key,value);}catch(e){console.warn('occur error when set data into storage [key: "'+kv.key+'", value: "'+kv.value+'"]');result[kv.key]=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}}});promise.resolve();}).call(this);excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){localStorage.removeItem(this._dbInfo.keyPrefix+key);promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var _this=this;keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
localStorage.removeItem(_this._dbInfo.keyPrefix+key);});promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){localStorage.removeItem(key);}}
promise.resolve();}).call(this);}catch(e){proimse.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();(function(){var result;result=localStorage.key(n);if(result){result=result.substring(_this._dbInfo.keyPrefix.length);}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();(function(){var keyPrefix=this._dbInfo.keyPrefix;var length=localStorage.length;var keys=[],key;for(var i=0;i<length;i++){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){keys.push(key.substring(keyPrefix.length));}}
promise.resolve(keys);}).call(this);excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key,value;var result;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){value=localStorage.getItem(key);try{value=JSON.parse(value);}catch(e){}
result=iterator(key.substring(keyPrefix.length),value,i);}
if(result===false){break;}}
promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var localStorageWrapper={_driver:'localStorageWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.localStorage=localStorageWrapper;}).call(this,jQuery);(function($){function BaseCache(options){this.options=$.extend({},DEFAULTS,options);this.storage=Object.create(Beop.cache.drivers[this.options.driver]);this.init();}
BaseCache.prototype.init=function(){this.storage._initStorage(this.options);};BaseCache.prototype.length=function(){return this.storage.length();};BaseCache.prototype.key=function(n,callback){return this.storage.key(n,callback);};BaseCache.prototype.keys=function(callback){return this.storage.keys(callback);};BaseCache.prototype.getItem=function(key,callback){return this.storage.getItem(key,callback);};BaseCache.prototype.getItemList=function(keyList,callback){return this.storage.getItemList(keyList,callback);};BaseCache.prototype.setItem=function(key,value,callback){return this.storage.setItem(key,value,callback);};BaseCache.prototype.setItemList=function(kvList,callback){return this.storage.setItemList(kvList,callback);};BaseCache.prototype.removeItem=function(key,callback){return this.storage.removeItem(key,callback);};BaseCache.prototype.removeItemList=function(keyList,callback){return this.storage.removeItemList(keyList,callback);};BaseCache.prototype.clear=function(callback){return this.storage.clear(callback);};BaseCache.prototype.iterate=function(iterator,callback){return this.storage.iterate(iterator,callback);};var DEFAULTS={dbType:'localStorage',name:'beopcache',version:3};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.BaseCache=BaseCache;}).call(this,jQuery);﻿
var Internationalization=(function(){function Internationalization(lang,resource){this.type=lang||localStorage["language"];this.resource=resource||{};}
Internationalization.prototype={getResource:function(){return this.resource;},fillPage:function(){this.fill2($('[i18n]'));},fillArea:function(element){this.fill2(element.find('[i18n]'));try{Permission.check(element);}catch(e){console.log('check permission failed:'+e);}},fillAreaAttribute:function(element,attributeName){this.fill(element.find('[i18n]['+attributeName+']'),attributeName);},fill:function(arrElement,attributeName){for(var i=0,arrPath,text,len=arrElement.length;i<len;i++){arrPath=arrElement[i].attributes["i18n"].value.split('.');text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
if(!attributeName){arrElement[i].innerHTML=text;}
else{arrElement[i].setAttribute(attributeName,text);}}},getI18nValue:function(i18nKey){if(!i18nKey){return'';}
var arrPath=i18nKey.split('.');var text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
return text;},fill2:function(arrElement){for(var i=0,len=arrElement.length;i<len;i++){var i18nValue=arrElement[i].attributes["i18n"];var items=i18nValue.value.split(';'),item,attrMap;for(var j=0;j<items.length;j++){item=items[j];if(!item){continue;}
if(item.indexOf('=')===-1){i18nValue=this.getI18nValue(item);arrElement[i].innerHTML=i18nValue;}else{attrMap=item.split('=');if(!attrMap[0]){continue;}
arrElement[i].setAttribute(attrMap[0],this.getI18nValue(attrMap[1]));}}}},findContent:function(strPath){var arrPath=strPath.split('.');var text=this.resource;for(var i=0,len=arrPath.length;i<len;i++){text=text&&text[arrPath[i]];}
return text;}};return Internationalization;})();function InitI18nResource(strLanguage,isForce,filePath){if(!strLanguage){strLanguage=localStorage["isUserSelectedLanguage"]||navigator.language.split('-')[0];}
if(isForce){localStorage["isUserSelectedLanguage"]=strLanguage;}else if(localStorage["isUserSelectedLanguage"]){strLanguage=localStorage["isUserSelectedLanguage"];}
filePath=filePath||'/static/views/js/i18n/';return $.ajax({async:false,url:filePath+strLanguage+".js",dataType:"script"}).then(function(){localStorage["language"]=strLanguage;return i18n_resource;},function(){return $.ajax({async:false,url:filePath+"en.js",dataType:'script'}).then(function(){localStorage["language"]="en";return i18n_resource;},function(){console.warn('i18n files loading failed!');return{};});});}
var EventAdapter=(function(){var eventData,eventStatus;function EventAdapter($){}
EventAdapter.on=function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<3||arguments.length>5){console.log('EventAdapter.on arguments.length error');return;}
if(typeof arguments[0]!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}}
if(typeof arguments[1]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[1];}
if(typeof arguments[2]=='function'){eventFunction=arguments[2];eventSelector=null;eventHmt=arguments[3]}else if(typeof arguments[2]=='string'){if(arguments[3]&&typeof arguments[3]=='function'){eventSelector=arguments[2];eventFunction=arguments[3];eventHmt=arguments[4]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':eventTarget.on('touchstart',eventSelector,function(e){mobileDragStart.call(this,e,eventTarget,finalFunction)});break;case'dragover':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragOver.call(this,e,eventTarget,finalFunction)});break;case'dragleave':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragLeave.call(this,e,eventTarget,finalFunction)});break;case'drop':$(document).on('touchend.drop',eventSelector,function(e){mobileDrop.call(this,e,eventTarget,finalFunction)});break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;};EventAdapter.off=function(){if((arguments.length>3||arguments.length<1)||(arguments[0]&&typeof arguments[1]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}
if(arguments.length==1){eventTarget.off();return eventTarget;}
if(typeof arguments[1]=='string'){eventType=arguments[1]}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[2]=='string'){eventSelector=arguments[2];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;};$.fn.extend({'eventOn':function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<2||arguments.length>4){console.log('EventAdapter.on arguments.length error');return;}
if(typeof this!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(this instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=this;}}
if(typeof arguments[0]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[0];}
if(typeof arguments[1]=='function'){eventFunction=arguments[1];eventSelector=null;eventHmt=arguments[2]}else if(typeof arguments[1]=='string'){if(arguments[2]&&typeof arguments[2]=='function'){eventSelector=arguments[1];eventFunction=arguments[2];eventHmt=arguments[3]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':mobileDragStart(eventTarget,eventSelector,finalFunction);break;case'dragover':mobileDragOver(eventTarget,eventSelector,finalFunction);break;case'dragleave':mobileDragLeave(eventTarget,eventSelector,finalFunction);break;case'drop':mobileDrop(eventTarget,eventSelector,finalFunction);break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;},'eventOff':function(){if((arguments.length>2)||(arguments[0]&&typeof arguments[0]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(this instanceof jQuery)){eventTarget=jQuery(this);}else{eventTarget=this;}
if(arguments.length==0){eventTarget.off();return eventTarget;}
if(typeof arguments[0]=='string'){eventType=arguments[0];}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[1]=='string'){eventSelector=arguments[1];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector,mobileDragStart);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;}});EventAdapter.setData=function(date){if(date==undefined)return;eventData=date;};EventAdapter.getData=function(){return eventData;};document.addEventListener('drop',function(){eventData=null;},false);document.addEventListener('touchend',function(){eventData=null;},false);EventAdapter.clearEvent=function(){$(document).off('touchmove.copy');$(document).off('touchmove.drag');$(document).off('touchend.drop');};EventAdapter.analyse=function(e,eventType,hmtInfo){var mainInfo='',initArrTag,finalArrTag,tag,unitTag;var target=$(e.currentTarget);if(hmtInfo instanceof Array&&hmtInfo[0]){mainInfo=judgeWay(hmtInfo[0]);initArrTag=hmtInfo.filter(function(ele,index){return index>0&&ele!='';});finalArrTag=[];for(var i=0;i<initArrTag.length;i++){unitTag=judgeWay(initArrTag[i]);if(unitTag=='')continue;finalArrTag.push(unitTag)}
tag=finalArrTag.join('-');}else{if(hmtInfo!=undefined){mainInfo=judgeWay(hmtInfo);}else{mainInfo=getInfo(target);}
mainInfo=mainInfo?mainInfo:'';tag=mainInfo;}
_hmt.push(['_trackEvent',mainInfo.substr(0,30),eventType,'user-'+(AppConfig.userId?AppConfig.userId:0)+'/project-'+(AppConfig.projectId?AppConfig.projectId:0)]);function getInfo(tar){if(tar.length==0)return;var tarInfo;if(tar.attr('id')){tarInfo=tar.attr('id');}else if(tar.attr('i18n')){tarInfo=tar.attr('i18n');}else if(tar.attr('title')){tarInfo=tar.attr('title');}else{tarInfo=tar[0].innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30);}
return tarInfo;}
function judgeWay(arg){if(typeof arg=='undefined'){return'';}
if(arg instanceof Function){return arg.call(this,e)}else if(typeof arg=='string'){if(arg=='text'){return e.currentTarget.innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30)}else{return $(e.currentTarget).attr(arg)?$(e.currentTarget).attr(arg):arg;}}else if(typeof arg=='number'){return arg;}}};var mobileDragStart=function(e,target,eventFunction){var originalTarget=$(e.target).closest('[draggable="true"]')[0];var ev=e.type=='touchstart'?e.originalEvent.touches[0]:e,startPos={left:$(originalTarget).css('left'),top:$(originalTarget).css('top'),zIndex:$(originalTarget).css('z-index')},disX=originalTarget.offsetWidth/2,disY=originalTarget.offsetHeight/2;var $copyTarget=$(originalTarget).clone();$copyTarget.data('startPos',startPos);$copyTarget.css('z-index',10000);$copyTarget.css('position','absolute');$copyTarget.css('opacity','0.5');$copyTarget.css('pointer-events','none');var $container=$('body');$container.append($copyTarget);var sPos=$(originalTarget)[0].getBoundingClientRect();$copyTarget.css('left',sPos.left-$container[0].offsetLeft+'px');$copyTarget.css('top',sPos.top-$container[0].offsetTop+'px');$copyTarget[0].cssText=originalTarget.cssText;$copyTarget.css('width',originalTarget.offsetWidth);$copyTarget.css('height',originalTarget.offsetHeight);eventStatus='dragStart';eventFunction.call(this,ev);$(document).off('touchend.copy').on('touchend.copy',function(e){$copyTarget.remove();eventStatus='dragEnd';});$(document).on('touchmove.copy',function(e){eventStatus='dragMove';var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var $parent=$copyTarget.offsetParent();$parent=$parent.is(':root')?$(window):$parent;var targetLeft=ev.pageX-disX;var targetTop=ev.pageY-disY;$copyTarget.css({left:targetLeft+'px',top:targetTop+'px','z-index':10000});})};var mobileDragOver=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn'&&eventStatus!='dragMoveOut')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveIn';eventFunction.call(this,e);break;}}};var mobileDragLeave=function(e,target,eventFunction){if(eventStatus!='dragMoveIn')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(!((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY))){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveOut';eventFunction.call(this,e);}}};var mobileDragEnd=function(e,target,eventFunction){eventFunction.call(this,e);};var mobileDrop=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn')return;var ev=e.type=='touchend'?e.originalEvent.changedTouches[0]:e;var eventTarget=target;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventFunction.call(this,e);break;}}};return EventAdapter;})(jQuery);var HierFilter=(function(){function HierFilter($ctn,projectId,parent,theme){this.$ctn=$ctn;this.projectId=projectId;this.theme=theme;this.opt=undefined;this.parent=parent;this.defaultOpt={title:{show:false},base:{divideByProject:true},search:{show:true},class:{show:true,projects:{show:true,class:'all',showAll:true,showNone:true,add:true,delete:true},groups:{show:true,class:'all',showAll:true,showNone:true,add:true,delete:true},things:{show:true,class:'all',showAll:true,showNone:true,add:true,delete:true}},tree:{show:true,event:{},drag:{enable:true},base:{expandReload:true,},tool:{add:{},beforeAdd:{},edit:{},del:{}},check:{enable:false}}};this.dictClass={};this.store=undefined;this.initDeferred=$.Deferred();this.$paneClass=undefined;this.$paneSearch=undefined;this.$paneTree=undefined;this.$paneAdd=undefined;this.tree=undefined;this.setDefault=false;this.prevProjId=undefined;this.isSearch=false;this.showStatus={'projects':'all','groups':'all','things':'all'};}
HierFilter.prototype={init:function(ctn,theme){var _this=this;_this.$ctn=ctn?ctn:_this.$ctn;_this.theme=theme?theme:_this.theme;if(!_this.projectId){if(AppConfig&&AppConfig.projectId){_this.projectId=AppConfig.projectId;}else{if(window.parent&&window.parent.AppConfig.projectId){_this.projectId=window.parent.AppConfig.projectId;}}}
if(!_this.projectId)_this.projectId=-1;WebAPI.get('/static/scripts/iot/hierFilter.html').done(function(resultHTML){_this.$ctn.append(resultHTML);I18n.fillArea($('#filterWrapper'));_this.initAddPane();_this.initSearch();_this.initDeferred.resolve();});},setOption:function(opt){var _this=this;_this.initDeferred.done(function(){_this.opt=$.extend(true,{},_this.defaultOpt,opt);var postData={parent:[],projId:[_this.projectId]};if(!_this.opt.base.divideByProject)delete postData.projId;$.when(WebAPI.get('/iot/getClassFamily/group/cn'),WebAPI.get('/iot/getClassFamily/thing/cn'),WebAPI.get('/iot/getClassFamily/project/cn')).done(function(groups,things,projects){_this.dictClass['groups']=groups[0];_this.dictClass['things']=things[0];_this.dictClass['projects']=projects[0];WebAPI.post('/iot/search',postData).done(function(resultDate){_this.store={groups:resultDate.groups,projects:resultDate.projects,things:resultDate.things};_this.isSearch=false;var $Deffer=$.Deferred();if(resultDate.projects.length==0&&_this.setIotProject()){_this.setIotProject().done(function(result){if(result&&result.status=='success'){_this.store.projects[0]._id=result._id;$Deffer.resolve();}else{$Deffer.reject();}}).fail(function(){$Deffer.reject();});}else{$Deffer.resolve();}
$Deffer.done(function(){for(var i=0;i<_this.store.groups.length;i++){_this.store.groups[i].isParent=true;_this.store.groups[i].baseType='groups';}
for(var i=0;i<_this.store.projects.length;i++){_this.store.projects[i].isParent=true;_this.store.projects[i].baseType='projects';}
for(var i=0;i<_this.store.things.length;i++){_this.store.things[i].baseType='things';}
for(var type in _this.store){if(_this.opt.class&&_this.opt.class[type]&&_this.opt.class[type].class){if(_this.dictClass[type][_this.opt.class[type].class]&&_this.dictClass[type][_this.opt.class[type].class].parent=='BaseIOT'){_this.showStatus[type]='all'}else{_this.showStatus[type]=_this.opt.class[type].class}}}
_this.initClassPane();_this.initTreePane(_this.store);_this.opt.tree.event.afterInit&&_this.opt.tree.event.afterInit();var node=_this.tree.getNodes();if(node.length==0)return;node=node[0];_this.tree.selectNode(node);_this.setDefault=true;_this.tree.setting.callback.onClick({target:document.getElementById(node.tId)},node['_id'],node);});});});});},setIotProject:function(){if(!(AppConfig&&(AppConfig.projectList instanceof Array)))return;if(!this.projectId)return;var info;for(var i=0;i<AppConfig.projectList.length;i++){if(AppConfig.projectList[i].id==this.projectId){info=AppConfig.projectList[i];break;}}
if(!info)return;var postData={'_idMgt':'bbbbbbbbbbbbf32fbc300001',codeName:info.name_en,dictName:{cn:info.name_cn,en:info.name_en},latLng:info.latlng,arrP:{},type:'Project',projId:this.projectId};this.store.projects=[{codeName:info.name_en,name:info.name_cn,latLng:info.latlng,arrP:{},type:'Project',projId:this.projectId}];return WebAPI.post('/iot/setIotProject',postData)},refresh:function(){},dispose:function(){},close:function(){},initClassPane:function(){var _this=this;if(!(_this.opt.class&&_this.opt.class.show))return;_this.$paneClass=$('#paneIotType');_this.$paneClass.html('');setClassSel('projects');setClassSel('groups');setClassSel('things');function setClassSel(type){if(_this.opt.class&&_this.opt.class[type]&&_this.opt.class[type].show){var strType=type.slice(0,type.length-1);strType=strType[0].toLocaleUpperCase()+strType.slice(1);var $divSelect=$('\
                    <div class="divSelect" value="all">\
                        <span class="spSelRs">'+I18n.resource.iot.TREE_ALL+'</span>\
                        <span class="glyphicon glyphicon-triangle-bottom"></span>\
                    </div>');var selOpt=[];if(_this.opt.class[type].showAll){selOpt.push({value:'all',name:I18n.resource.iot.TREE_ALL})}
if(_this.opt.class[type].showNone){selOpt.push({value:'none',name:I18n.resource.iot.TREE_HIDE})}
for(var cls in _this.dictClass[type]){if(_this.dictClass[type][cls].parent=='BaseIOT')continue;selOpt.push({value:cls,name:_this.dictClass[type][cls].name,parent:_this.dictClass[type][cls].parent,})}
var $selector=_this.setSel(selOpt).addClass('selClass');if($selector.find('li').length==0)return;$selector.off('click').on('click','li',function(e){e.stopPropagation();var value=$(e.currentTarget).attr('value');$selector.prevAll('.spSelRs').text($(e.currentTarget).children('span').text());$selector.attr('value');var opt={'type':type,'val':value};_this.showStatus[opt.type]=opt.val;_this.initTreeData(opt);_this.initAttrPane(opt)});$selector.attr('value',_this.showStatus[type]);if(_this.showStatus[type]=='all'){$divSelect.children('.spSelRs').text(I18n.resource.iot.TREE_ALL);}else if(_this.showStatus[type]=='none'){$divSelect.children('.spSelRs').text(I18n.resource.iot.TREE_HIDE);}else{var arrKey=Object.keys(_this.dictClass[type]);for(var i=0;i<arrKey.length;i++){if(arrKey[i]==_this.showStatus[type]){$divSelect.children('.spSelRs').text(_this.dictClass[type][arrKey[i]].name);break;}}}
$divSelect.append($selector);_this.$paneClass.append($divSelect);}}},setSel:function(selOpt){var _this=this;var $selector=$('<ul>');var tempArr=[].concat(selOpt);var dictTree={};var level=0;var length=tempArr.length;var numLeft=length;var isRoot;for(var i=0;i<length;i++){isRoot=true;for(var j=0;j<length;j++){if(i==j)continue;if(selOpt[j].value==tempArr[i].parent){isRoot=false;break;}}
if(isRoot){tempArr[i].level=level;if(!dictTree[level])dictTree[level]=[];dictTree[level].push(tempArr[i]);tempArr[i]=null;}}
while(numLeft>0){numLeft=0;level++;for(var i=0;i<length;i++){if(!tempArr[i])continue;for(var j=0;j<dictTree[level-1].length;j++){if(tempArr[i].parent==dictTree[level-1][j].value){if(!dictTree[level])dictTree[level]=[];dictTree[level].push(tempArr[i]);tempArr[i]=null;break;}}}
for(var i=0;i<length;i++){if(tempArr[i])numLeft++;}}
var $option,$parent=[],$parentTemp=[];var $spName;for(var i=0;i<dictTree['0'].length;i++){$option=$('<li>');$option.addClass('level_0 '+dictTree['0'][i].value).attr('value',dictTree['0'][i].value);$spName=$('<span>').text(dictTree['0'][i].name);$option.append($spName);$option.append('<ul>');$selector.append($option);$parent.push($option);}
for(var ele in dictTree){if(ele=='0')continue;for(var i=0;i<dictTree[ele].length;i++){$option=$('<li>');$option.addClass('level_'+ele+' '+dictTree[ele][i].value).attr('value',dictTree[ele][i].value);$spName=$('<span>').text(dictTree[ele][i].name);$option.append($spName);$option.append('<ul>');for(var j=0;j<$parent.length;j++){if($parent[j].attr('value')==dictTree[ele][i].parent){$parent[j].children('ul').append($option);break;}}
$parentTemp.push($option);}
$parent=$parentTemp;$parentTemp=[];}
return $selector},initAttrPane:function(opt){var _this=this;var $paneClass,cls,type,clsStore,$divAttr,attrStore,$selAttr,parentStore;cls=opt.val;type=opt.type;clsStore=_this.searchClass(cls);$paneClass=$('#paneIot-'+type).html('').removeClass('on');if(!clsStore)return;$paneClass.append('<div class="className">'+clsStore.name+'</div>');parentStore=_this.searchClass(clsStore.parent);if(parentStore&&parentStore.name){$paneClass.append('<div class="classParentName">'+parentStore.name+'</div>');}
$divAttr=$('<div class="divAttr">');for(var attr in clsStore.attrs){attrStore=clsStore.attrs[attr];setAttr(attrStore,$divAttr);$paneClass.find('.className').after($divAttr);}
if($paneClass.find('select').length>0){$paneClass.addClass('on');}
function setAttr(attrStore,$divAttr){if(attrStore.filter){$divAttr.append('<span class="label">'+attrStore.name+'</span>');$selAttr=$('<select class="filterAttr">').addClass('attr').attr('filterMode',attrStore.filter.t);if(attrStore.filter.t='enum'){for(var attrOpt in attrStore.filter.opt){$selAttr.append('<option value="'+attrOpt+'">'+attrStore.filter.opt[attrOpt]+'</option>')}}else if(attrStore.filter.t='range'){for(var j=0;j<attrStore.filter.opt.length;j++){$selAttr.append('<option value="'+attrStore.filter.opt[j]+'">'+attrStore.filter.opt[j]+'</option>')}}
$divAttr.append($selAttr);}}},initSearch:function(){var _this=this;var $iptSearch=$('#paneIotSearch').find('input');$iptSearch.next().off('click').on('click',function(){if($iptSearch.val()=='')return;$iptSearch.val('');clearSearch();});$iptSearch.on('propertychange input',function(e){if($iptSearch.val()==''){clearSearch();}});$iptSearch.keyup(function(e){if(13==e.keyCode){$iptSearch.blur();var projId;var selectNode=_this.tree.getSelectedNodes()[0];if(!selectNode||!selectNode['projId']){projId=_this.prevProjId?_this.prevProjId:_this.projectId;}else{var parentNode=selectNode.getParentNode();while(parentNode){selectNode=parentNode;parentNode=selectNode.getParentNode();}
_this.prevProjId=selectNode['projId'];}
var postData;if($iptSearch.val()==''){clearSearch();}else{postData={searchName:$iptSearch.val(),projId:projId?projId:_this.projectId};if(!_this.opt.base.divideByProject)delete postData.projId;WebAPI.post('/iot/fuzzysearch',postData).done(function(result){if(!result||!result.data)return;_this.isSearch=true;$.fn.zTree.destroy('paneIotData');_this.store={projects:[],groups:[],things:[]};_this.tree=null;for(var i=0;i<result.data.length;i++){result.data[i].pId=result.data[i]['_idPrt'];_this.store[result.data[i].baseType].push(result.data[i])}
for(var i=0;i<_this.store.groups.length;i++){_this.store.groups[i].isParent=true;_this.store.groups[i].baseType='groups';}
for(var i=0;i<_this.store.projects.length;i++){_this.store.projects[i].isParent=true;_this.store.projects[i].baseType='projects';}
for(var i=0;i<_this.store.things.length;i++){_this.store.things[i].baseType='things';}
_this.initTreePane(_this.store);})}}});function clearSearch(){var postData={parent:[],projId:[_this.projectId]};if(!_this.opt.base.divideByProject)delete postData.projId;WebAPI.post('/iot/search',postData).done(function(result){if(!result)return;_this.isSearch=false;$.fn.zTree.destroy('paneIotData');_this.store={projects:[],groups:[],things:[]};_this.tree=null;_this.store={groups:result.groups,projects:result.projects,things:result.things};for(var i=0;i<_this.store.groups.length;i++){_this.store.groups[i].isParent=true;_this.store.groups[i].baseType='groups';}
for(var i=0;i<_this.store.projects.length;i++){_this.store.projects[i].isParent=true;_this.store.projects[i].baseType='projects';}
for(var i=0;i<_this.store.things.length;i++){_this.store.things[i].baseType='things';}
_this.initClassPane();_this.initTreePane(_this.store);})}},searchName:function(name){var _this=this;for(var type in _this.store.class){for(var keyName in _this.store.class[type]){if(keyName==name)return _this.store.class[type][keyName]}}},searchDeviceById:function(id,type){var _this=this;if(!id)return[];var arrDevice=[];var arrId=[];if(type){if(id instanceof Array){for(var i=0;i<id.length;i++){arrId[i]={id:id[i],index:i}}
for(var i=0;i<_this.store[type].length;i++){for(var j=0;j<arrId.length;j++){if(_this.store[type][i]['_id']==arrId[j].id){arrDevice[arrId[j].index]=_this.store[type][i];arrId.splice(j,1);break;}}}}else{for(var i=0;i<_this.store[type].length;i++){if(_this.store[type][i]['_id']==id){return[_this.store[type][i]]}}}}else{if(id instanceof Array){for(var i=0;i<id.length;i++){arrId[i]={id:id[i],index:i}}
for(var ele in _this.store){for(var i=0;i<_this.store[ele].length;i++){for(var j=0;j<arrId.length;j++){if(_this.store[ele][i]['_id']==arrId[j].id){arrDevice[arrId[j].index]=_this.store[ele][i];arrId.splice(j,1);break;}}}}}else{for(var ele in _this.store){for(var i=0;i<_this.store[ele].length;i++){if(_this.store[ele][i]['_id']==id){return[_this.store[ele][i]]}}}}}
return arrDevice;},searchClass:function(cls){var _this=this;for(var type in _this.dictClass){for(var keyCls in _this.dictClass[type]){if(keyCls==cls)return _this.dictClass[type][keyCls]}}},initTreePane:function(opt,parentNode){var _this=this;if(_this.tree)return;_this.$paneTree=$('#paneIotData');_this.$paneTree.off('click');if(_this.opt.tree&&_this.opt.tree.show){var setting={data:{simpleData:{enable:true,idKey:'_id'}},keep:{leaf:true,parent:true},check:{enable:_this.opt.tree.check.enable},edit:{enable:true,drag:{isCopy:false,isMove:false},showRemoveBtn:false,showRenameBtn:false},view:{addDiyDom:addDiyDom,addHoverDom:addHoverDom,removeHoverDom:removeHoverDom,dblClickExpand:false,showIcon:true,showLine:true},callback:{beforeRename:function(){return false;},beforeRemove:function(){},beforeDrag:function(){return false;},beforeAsync:function(){},onAsyncSuccess:function(){},onDblClick:function(event,treeId,treeNode){if(!_this.opt.tree.event.dblClick)return;_this.opt.tree.event.dblClick.call(_this,event,treeId,treeNode);},onClick:function(event,treeId,treeNode){if(!_this.opt.tree.event.click)return;var that=this;var dblFlag=false;var clkInterval;if(typeof treeNode.clickTime=='undefined'){clkInterval=Infinity;}else{clkInterval=new Date()-treeNode.clickTime;}
treeNode.clickTime=new Date();$(event.target).on('click.judgeDbl',function(){dblFlag=true;});var dblJudge=window.setInterval(function(){$(event.target).off('click.judgeDbl');window.clearInterval(dblJudge);if(!dblFlag&&clkInterval>200){if(_this.opt.tree.event.click.isDefault===false){_this.opt.tree.event.click.act.call(that,event,treeId,treeNode);return;}
_this.childAppend(treeNode,function(){if(_this.opt.tree.event.click){if(!_this.opt.tree.event.click instanceof Array){_this.opt.tree.event.click.call(that,event,treeId,treeNode);}else{for(var i=0;i<_this.opt.tree.event.click.length;i++){if(_this.opt.tree.event.click[i].tar.toString().indexOf(treeNode.baseType)>-1||_this.opt.tree.event.click[i].tar=='all'){_this.opt.tree.event.click[i].act.call(that,event,treeId,treeNode)}}}}});}},200);}}};if(_this.opt.tree.extend){$.extend(true,setting,setting,_this.opt.tree.extend)}
var zNodes=_this.initTreeData(opt);_this.tree=$.fn.zTree.init(this.$paneTree,setting,zNodes);_this.$paneTree.on('click','.btnEdit',function(e){e.stopPropagation();var treeNode=_this.tree.getNodeByTId(e.target.parentNode.parentNode.id);var parentNode=treeNode.getParentNode();new CreateDeviceModal({mode:'edit',baseType:treeNode.baseType,filter:_this,parentNode:parentNode,treeNode:treeNode});});_this.$paneTree.on('click','.btnDelete',function(e){e.stopPropagation();var treeNode=_this.tree.getNodeByTId(e.target.parentNode.parentNode.id);infoBox.confirm('确认删除节点 '+treeNode.name+' ? 注意子文件及文件夹也将被删除并不可恢复。',okCallback);function okCallback(){var postData=[{'id':[treeNode['_id']],'type':treeNode['baseType']}];WebAPI.post('/iot/delIotInfo',{itemList:postData,projId:AppConfig.projectId}).done(function(){var nodes=_this.tree.getNodesByParam('_id',$(e.target.parentNode.parentNode).attr('ptid'));for(var i=0;i<nodes.length;i++){_this.tree.removeNode(nodes[i]);}
if(typeof _this.opt.tree.tool.delete=='function'){_this.opt.tree.tool.delete.call(_this,treeNode)}});}});_this.$paneTree.on('click','.btnTemplate',function(e){e.stopPropagation();var treeNode=_this.tree.getNodeByTId(e.target.parentNode.id);var strModalContent=new StringBuilder();strModalContent.append('               <iframe style="width:100%;height:100%;" name="ifram_factory" sandbox="allow-forms allow-popups allow-scripts allow-same-origin allow-modals" frameborder="0"></iframe>');var $modalContent=$(strModalContent.toString());var $modal=$('#templateModal');$modal.find('.modal-content').append($modalContent);$modal.modal('show');$modal.off().on('shown.bs.modal',function(){var form,ipt;form=document.createElement('form');form.action='/factory/preview/8f54051d0011456903054765';form.method='post';form.target='ifram_factory';ipt=document.createElement('input');ipt.type='hidden';ipt.name='params';ipt.value=JSON.stringify(treeNode.arrP);form.appendChild(ipt);document.body.appendChild(form);form.submit();document.body.removeChild(form);});$modal.on('hidden.bs.modal',function(){$modalContent.remove();})});_this.$paneTree.on('click','.projects>.button.switch',function(e){var $target=$(e.currentTarget);var node=_this.tree.getNodeByTId($target.parent().attr('id'));_this.childAppend(node,function(){});return false;});_this.$paneTree.on('click','.groups>.button.switch',function(e){var $target=$(e.currentTarget);var node=_this.tree.getNodeByTId($target.parent().attr('id'));_this.childAppend(node,function(){});return false;});function diyParam(treeNode){return{parent:[{id:treeNode['_id'],type:treeNode['baseType']}]}}
function dataFilter(treeId,parentNode,resultData){for(var type in resultData.class){for(var cls in resultData.class[type]){_this.dictClass[type][cls]=resultData.class[type][cls]}}
_this.initClassPane();}
function addDiyDom(treeId,treeNode){var $target=$('#'+treeNode.tId);$target.attr('ptId',treeNode['_id']);$target.addClass(treeNode.baseType);if(treeNode.baseType=='groups'||treeNode.baseType=='things'){$target.children('a').append('\
                    <span class="btnDelete btnTreeNode glyphicon glyphicon-remove-sign"></span>\
                    <span class="btnEdit btnTreeNode glyphicon glyphicon-edit"></span>\
                    ');}
if(_this.opt.tree.drag&&_this.opt.tree.drag.enable){$target.attr('draggable',true);if(_this.opt.tree.drag.dragstart){attachDragEvent('dragstart',$target,treeNode);}
if(_this.opt.tree.drag.dragend){attachDragEvent('dragend',$target.children('a'),treeNode);}
if(_this.opt.tree.drag.drop){attachDragEvent('dragover',$target.children('a'),treeNode);attachDragEvent('dragleave',$target.children('a'),treeNode);attachDragEvent('drop',$target.children('a'),treeNode);}}
if(typeof _this.opt.tree.event.addDom=='function'){_this.opt.tree.event.addDom.call(_this,treeNode,$target);}}
function addHoverDom(treeId,treeNode){if(treeNode.isParent)return;var $target=$('#'+treeNode.tId);$target.css({'background-color':'rgb(76, 100, 148)'});$target.children('a').css('color','black');}
function removeHoverDom(treeId,treeNode){if(treeNode.isParent)return;var $target=$('#'+treeNode.tId);$target.css({'background-color':'transparent'});$target.children('a').css('color','inherit');}
function attachDragEvent(type,target,treeNode){if(type=='dragover'||type=='dragleave'){target.on(type,function(e){e.preventDefault();_this.opt.tree.drag[type]&&_this.opt.tree.drag[type].call(_this,e,treeNode);});return;}
if(_this.opt.tree.drag[type]){if(_this.opt.tree.drag[type]instanceof Function){target.on(type,function(e){e.preventDefault();_this.opt.tree.drag[type].call(_this,e,treeNode);});}else if(_this.opt.tree.drag[type].act instanceof Function&&_this.opt.tree.drag[type].tar==treeNode.baseType){target.on(type,function(e){_this.opt.tree.drag[type].act.call(_this,e,treeNode);});}else if(_this.opt.tree.drag[type]instanceof Array){_this.opt.tree.drag[type].forEach(function(event,i){if(event.act instanceof Function&&event.tar==treeNode.baseType){target.on(type,function(e){e.stopPropagation();event.act.call(_this,e,treeNode);});}})}}}}},initTreeData:function(option){var _this=this;if(!_this.tree){var data=[];data=data.concat(this.store.projects);data=data.concat(this.store.groups);data=data.concat(this.store.things);}else{var root=_this.tree.getNodes();var data=_this.tree.transformToArray(root);for(var i=0;i<data.length;i++){if(data[i].baseType==option.type){_this.tree.showNode(data[i]);if(option.val=='all'){continue;}else if(option.val=='none'){_this.tree.hideNode(data[i]);}else if(data[i].type!=option.val){_this.tree.hideNode(data[i]);}}}}
if(typeof _this.opt.tree.data=='function'){_this.opt.tree.data.call(_this,data)}
return data;},getChildren:function(treeNode,func,opt){var _this=this;var postData={parent:[{id:treeNode['_id'],type:treeNode['baseType']}]};return WebAPI.post('/iot/search',postData).done(function(resultData){for(var type in resultData.class){for(var cls in resultData.class[type]){_this.dictClass[type][cls]=resultData.class[type][cls]}}
var tempArr=[];for(var ele in resultData){if(ele=='class')continue;if(typeof _this.opt.tree.data=='function'){_this.opt.tree.data.call(_this,resultData[ele],ele)}
var flag;for(var i=0;i<resultData[ele].length;i++){for(var j=0;j<_this.store[ele].length;j++){if(_this.store[ele][j]['_id']==resultData[ele][i]['_id']){if(ele=='groups'&&!resultData[ele][i].pId){resultData[ele][i].pId=resultData[ele][i]['_idProj'];}
if(_this.store[ele][j]['pId']==resultData[ele][i]['pId']){flag=true;}else{if(treeNode.children){for(var k=0;k<treeNode.children.length;k++){if(resultData[ele][i]['_id']==treeNode.children[k]['_id']){flag=true;break;}}}}
break;}}
if(resultData[ele][i].icon){resultData[ele][i].iconSkin='iconfont '+resultData[ele][i].icon;delete resultData[ele][i].icon;}
if(_this.opt.tree.base.expandReload||!flag){if(ele=='groups'||ele=='projects'){resultData[ele][i].isParent=true;}
resultData[ele][i].baseType=ele;if(!flag){_this.store[ele].push(resultData[ele][i]);}
tempArr.push(resultData[ele][i]);}}}
if(_this.opt.tree.base.expandReload){_this.tree.removeChildNodes(treeNode);}
if(tempArr.length==0){func(resultData);return;}
if(!opt||opt.add!==false){_this.tree.addNodes(treeNode,tempArr,true);}
if(!opt||opt.expand!==false){_this.tree.expandNode(treeNode,null,false,true,true);}
_this.initClassPane();func(resultData);})},childAppend:function(treeNode,func){var _this=this;if(treeNode.open){_this.tree.expandNode(treeNode,null,false,true,true);return;}else{if(treeNode.baseType=='things'){func();_this.tree.expandNode(treeNode,null,false,true,true);return;}else{var postData={parent:[{id:treeNode['_id'],type:treeNode['baseType']}]};WebAPI.post('/iot/search',postData).done(function(resultData){for(var type in resultData.class){for(var cls in resultData.class[type]){_this.dictClass[type][cls]=resultData.class[type][cls]}}
var tempArr=[];for(var ele in resultData){if(ele=='class')continue;if(typeof _this.opt.tree.data=='function'){_this.opt.tree.data.call(_this,resultData[ele],ele)}
var flag;for(var i=0;i<resultData[ele].length;i++){for(var j=0;j<_this.store[ele].length;j++){if(_this.store[ele][j]['_id']==resultData[ele][i]['_id']){if(ele=='groups'&&!resultData[ele][i].pId){resultData[ele][i].pId=resultData[ele][i]['_idProj'];}
if(_this.store[ele][j]['pId']==resultData[ele][i]['pId']){flag=true;}else{if(treeNode.children){for(var k=0;k<treeNode.children.length;k++){if(resultData[ele][i]['_id']==treeNode.children[k]['_id']){flag=true;break;}}}}
_this.store[ele][j]=resultData[ele][i];break;}}
if(_this.opt.tree.base.expandReload||!flag){if(ele=='groups'||ele=='projects'){resultData[ele][i].isParent=true;}
resultData[ele][i].baseType=ele;if(!flag){_this.store[ele].push(resultData[ele][i]);}
tempArr.push(resultData[ele][i]);}}}
if(_this.opt.tree.base.expandReload){_this.tree.removeChildNodes(treeNode);}
if(tempArr.length==0){func();_this.tree.expandNode(treeNode,null,false,true,true);return;}
_this.tree.addNodes(treeNode,tempArr,true);for(var base in _this.showStatus){_this.initTreeData({'type':base,'val':_this.showStatus[base]});}
_this.tree.expandNode(treeNode,null,false,true,true);_this.initClassPane();func();})}}},initAddPane:function(){var _this=this;_this.$paneAdd=$('#paneIotAdd');var $btnAdd=$('.btnAddEle');$btnAdd.click(function(e){var parentNode=_this.tree.getSelectedNodes()[0];var callBack;if(typeof _this.opt.tree.tool.beforeAdd=='function'){callBack=_this.opt.tree.tool.beforeAdd.call(_this,parentNode)}
if(typeof _this.opt.tree.tool.beforeAdd.act=='function'){callBack=_this.opt.tree.tool.beforeAdd.act.call(_this,parentNode)}
if(callBack&&callBack.parentNode){parentNode=callBack.parentNode;}
if(parentNode.length==0){alert('请选择父节点');return;}
if(callBack&&callBack.isForbid){alert(callBack.msg);return;}
new CreateDeviceModal({mode:'add',baseType:$(e.currentTarget).attr('typeAdd'),filter:_this,parentNode:parentNode});});}};return HierFilter;})();var CreateDeviceModal=(function(){var _this;function CreateDeviceModal(opt){_this=this;this.devices=null;this.names=null;this.type=null;this.mode=opt.mode;this.baseType=opt.baseType?opt.baseType:undefined;this.filter=opt.filter?opt.filter:undefined;this.parentNode=opt.parentNode;this.treeNode=opt.treeNode;this.group=[];this.prefix=null;this.batch=null;this.batchErr={name:false,prefix:false};this.show();}
CreateDeviceModal.prototype={show:function(){var _this=this;if(_this.mode=='add'&&_this.baseType=='things'&&_this.parentNode.baseType=='projects'){alert('项目下不支持直接增加设备');return;}
WebAPI.get("/static/scripts/iot/config/addThing.html").done(function(rsHtml){_this.content=rsHtml;_this.$createDev=$("#modalIotCfg");_this.$createDev.find("#ctnIotCfg").html(rsHtml);if(_this.mode=='add'){_this.$createDev.find('.modal-title').text('添加'+_this.baseType);}else{_this.$createDev.find('.modal-title').text('修改'+_this.baseType);}
_this.$createDev.modal({backdrop:'static',keyboard:false});_this.init();});},init:function(){var _this=this;_this.names=[];_this.devices=[];_this.prefix=[];_this.type="";_this.batch=false;_this.$createDev.modal('show');_this.$innerSLD=$("#createModalSld");_this.closeBtn=document.getElementById("closeBtn");_this.skipBtn=document.getElementById("skipBtn");_this.nextBtn=document.getElementById("nextBtn");_this.confirmBtn=document.getElementById("confirmBtn");_this.nameInput=document.getElementById("nameInput");_this.nameConfigInput=document.getElementById("batchNameArea");_this.prefixInput=document.getElementById("prefixInput");_this.typeList=document.getElementById("typeList");_this.groupList=document.getElementById("addedGroup");_this.bindDataGroup=document.getElementById("bindDataGroup");_this.typeDataSource=null;if(_this.parentNode.baseType=='things'){_this.parentNode=_this.parentNode.getParentNode();}
_this.initTypeList();_this.initParentType();if(_this.mode=='edit'){_this.initEditMode();}
_this.attachEvent();},attachEvent:function(){var _this=this;var btnAddParent=document.getElementById("btnAddParent");btnAddParent.addEventListener("click",_this.parentAdd,false);_this.closeBtn.onclick=function(){_this.closeModal(false);};_this.confirmBtn.onclick=function(){_this.closeModal(true);};_this.nextBtn.onclick=function(){var currentIndex=_this.$innerSLD.find('.active').index();_this.checkValid(currentIndex);};_this.$innerSLD.on('slide.bs.carousel',_this.onCarouselMove);$(".batchBtn").on("change",function(){var batch=$(this).attr("data-batch");if(batch==="true"){$("#divNameBatch").removeClass("hide");$("#divPrefixBatch").removeClass("hide");_this.batch=true;}else{$("#divNameBatch").addClass("hide");$("#divPrefixBatch").addClass("hide");_this.batch=false;}});},closeModal:function(flag){var _this=this;if(flag){if(_this.mode=='add'){_this.addModeClose();}else if(_this.mode=='edit'){_this.editModeClose();}
_this.devices=null;_this.name=null;_this.type=null;_this.group=[];_this.prefix=null;_this.batch=false;_this.$createDev.modal('hide');_this.$createDev.find("#dialogContent").empty();}else{var message="确定要中途退出吗？";infoBox.confirm(message,callback);function callback(){_this.devices=null;_this.names=null;_this.type=null;_this.group=[];_this.prefix=null;_this.batch=false;_this.$createDev.modal('hide');_this.$createDev.find("#dialogContent").empty();}}},editModeClose:function(){var postData=[];var node={};for(var i=0;i<_this.devices.length;i++){node={'_id':_this.treeNode['_id'],name:_this.devices[i].name,arrP:_this.devices[i].arrP,_idProj:_this.parentNode.baseType=='projects'?_this.parentNode['_id']:_this.parentNode['_idProj'],projId:_this.parentNode.projId,pId:_this.parentNode.baseType=='projects'?undefined:_this.pId,path:null,prefix:_this.devices[i].prefix,type:_this.type,weight:0,baseType:_this.baseType};if(_this.treeNode['params'])node.params=_this.treeNode['params'];postData.push(node)}
WebAPI.post('/iot/setIotInfo',postData).done(function(result){if(result.data&&result.data.length==0)return;$.extend(true,_this.treeNode,postData[0]);_this.filter.tree.updateNode(_this.treeNode);for(var i=0;i<_this.filter.store[_this.treeNode['baseType']].length;i++){if(_this.filter.store[_this.treeNode['baseType']][i]['_id']==_this.treeNode['_id']){for(var ele in _this.filter.store[_this.treeNode['baseType']][i]){_this.filter.store[_this.treeNode['baseType']][i][ele]=_this.treeNode[ele]}
break;}}
var func;if(typeof _this.filter.opt.tree.tool.edit=='function'){func=_this.filter.opt.tree.tool.edit;}else if(typeof _this.filter.opt.tree.tool.edit.act=='function'){func=_this.filter.opt.tree.tool.edit.act;}else{return;}
if(_this.mode=='edit'){func.call(_this.filter,_this.treeNode)}});},addModeClose:function(){var postData=[];for(var i=0;i<_this.devices.length;i++){postData.push({name:_this.devices[i].name,arrP:_this.devices[i].arrP,_idProj:_this.parentNode.baseType=='projects'?_this.parentNode['_id']:_this.parentNode['_idProj'],projId:_this.parentNode.projId,pId:_this.parentNode.baseType=='projects'?undefined:_this.pId,path:null,prefix:_this.devices[i].prefix,type:_this.type,weight:0,baseType:_this.baseType})}
WebAPI.post('/iot/setIotInfo',postData).done(function(result){if(result.data&&result.data.length==0)return;postData.forEach(function(val,index){val['_id']=result.data[index];if(_this.baseType=='groups'){val.isParent=true;}});var arrParent=[];var arrNodes=[];var parent;if(_this.pId instanceof Array){arrParent.push(_this.parentNode);_this.filter.tree.addNodes(_this.parentNode,postData);for(var i=0;i<_this.pId.length;i++){if(_this.parentNode['_id']==_this.pId[i])continue;parent=_this.filter.tree.getNodeByParam('_id',_this.pId[i]);arrParent.push(parent);_this.filter.tree.addNodes(parent,postData);}}else{_this.filter.tree.addNodes(_this.parentNode,postData);arrParent.push(_this.parentNode);}
_this.filter.store[_this.baseType]=_this.filter.store[_this.baseType].concat(postData);var func;if(typeof _this.filter.opt.tree.tool.add=='function'){func=_this.filter.opt.tree.tool.add;}else if(typeof _this.filter.opt.tree.tool.add.act=='function'){func=_this.filter.opt.tree.tool.add.act;}else{return;}
for(var i=0;i<postData.length;i++){arrNodes.push(_this.filter.tree.getNodeByParam('_id',postData[i]['_id']))}
func.call(_this.filter,arrParent,arrNodes)});},initEditMode:function(){$('#divBatch').hide();$('#nameInput').val(_this.treeNode.name);$('#prefixInput').val(_this.treeNode.prefix)},createDevice:function(){var _this=this;var typeProp;for(var i=0,len=_this.names.length;i<len;i++){var obj={};obj.name=_this.names[i];obj.type=_this.type;if(_this.prefix&&_this.prefix[i]){obj.prefix=_this.prefix[i];}else{obj.prefix='';}
obj.attrs=[];obj.arrP={};typeProp=_this.typeDataSource[_this.type];for(var attr in typeProp['attrs']){if(typeProp['attrs'].hasOwnProperty(attr)){var att={};att['name']=attr;att["fullName"]=obj.prefix+attr;att["cnName"]=typeProp['attrs'][attr]["name"];att["value"]='--';att["id"]=null;obj["attrs"].push(att);}}
_this.devices.push(obj);}},updateDevice:function(){var _this=this;},initTypeList:function(){var _this=this;var arrHtml=["<option value='-1'>请选择</option>"];var $typeList=$("#typeList");var clsList=[];_this.typeDataSource=_this.filter.dictClass[_this.baseType];var baseType=_this.baseType.substring(0,_this.baseType.length-1);baseType=baseType?baseType:_this.treeNode.baseType.substring(0,_this.treeNode.baseType-1);WebAPI.get('/iot/getClassFamilyByProjId/'+_this.parentNode.getPath()[0]['_id']+'/'+baseType+'/cn').done(function(result){if(!result||$.isEmptyObject(result)){clsList=_this.typeDataSource;}else{clsList=result;}
for(var obj in clsList){if(clsList.hasOwnProperty(obj)){var name=clsList[obj]["name"];if(obj=='Thing'||obj=='Group'){arrHtml.push("<option selected value='"+obj+"'>"+name+"</option>");}else{arrHtml.push("<option value='"+obj+"'>"+name+"</option>");}}}
$typeList.html(arrHtml.join(''));if(_this.mode=='edit'){$('#typeList').val(_this.treeNode.type);}});},initParentType:function(){var _this=this;var arrHtml=['<option value="-1">全部</option>'];var $parentTypeList=$("#parentTypeList");var $parentList=$('.parentList');if(_this.baseType=='groups'){$parentList.html('<option value="'+_this.parentNode['_id']+'">'+_this.parentNode.name+'</option>');$parentList.attr("disabled","disabled");}else{$parentList.html(arrHtml.join(''));$('#btnAddParent').show();}
_this.groupDataSource=_this.filter.dictClass[_this.parentNode.baseType];if(_this.baseType=="groups"&&_this.groupDataSource[_this.parentNode.type]){$parentTypeList.html('<option value="'+_this.parentNode.type+'">'+_this.groupDataSource[_this.parentNode.type].name+'</option>').attr('disabled','disabled');return;}
for(var obj in _this.groupDataSource){if(_this.groupDataSource.hasOwnProperty(obj)){var name=_this.groupDataSource[obj]["name"];arrHtml.push("<option value='"+obj+"'>"+name+"</option>");}}
var arrParentList=['<option value="-1">请选择</option>'];for(var i=0;i<_this.filter.store.groups.length;i++){if(_this.filter.store.groups[i]['_id']==_this.parentNode['_id']){$parentList.val(_this.parentNode['_id'])}
arrParentList.push('<option value="'+_this.filter.store.groups[i]['_id']+'">'+_this.filter.store.groups[i].name+'</option>')}
$parentList.html(arrParentList.join(''));$parentTypeList.html(arrHtml.join(''));if(_this.mode=='add'){$parentList.val(_this.parentNode['_id']);}else if(_this.mode=='edit'){if(typeof _this.treeNode.pId=='string'){$('.parentList').eq(0).val(_this.treeNode.pId)}else if(_this.treeNode.pId instanceof Array){$('.parentList').eq(0).val(_this.treeNode.pId[0]);for(var i=1;i<_this.treeNode.pId.length;i++){_this.parentAdd().val(_this.treeNode.pId[i])}}}
$parentTypeList.on("change",function(){if(_this.baseType=='groups')return;var selectedOpt=$("#parentTypeList option:selected").attr("value");_this.getParentList(selectedOpt);});},getParentList:function(val){var _this=this;var arrHtml=["<option value='-1'>请选择</option>"];var $parentList=$('.parentList');for(var i=0;i<_this.filter.store.groups.length;i++){if(val==-1||_this.filter.store.groups[i].type==val){if(_this.filter.store.groups[i]['_id']==_this.parentNode['_id']){$parentList.val(_this.parentNode['_id'])}
arrHtml.push('<option value="'+_this.filter.store.groups[i]['_id']+'">'+_this.filter.store.groups[i].name+'</option>')}else{}}
$parentList.html(arrHtml.join(""));},parentAdd:function(){var $divParentList=$($('.divParentList')[0].outerHTML);$('#boxParentList').append($divParentList);return $divParentList;},generateName:function(){var _this=this;var input=_this.nameInput.value.trim();var names=[];if(_this.batch){try{var config=$("#batchNameArea").val().trim();config=config.replace((/([\w]+)(:)/g),"\"$1\"$2");config=config.replace((/'/g),"\"");if(config==''){alert('名称批量设置为空！');return names}else{var nameConfig=JSON.parse(config);for(var item in nameConfig){if(nameConfig.hasOwnProperty(item)){var reg=new RegExp('<#'+item+'#>','g');if(Object.prototype.toString.call(nameConfig[item]).slice()==='[object Array]'){for(var j=0;j<nameConfig[item].length;j++){if(names.length!==nameConfig[item].length){names.push(input.replace(reg,nameConfig[item][j]));}else{names[j]=names[j].replace(reg,nameConfig[item][j]);}}}else{var min=parseInt(nameConfig[item]["min"],10);var max=parseInt(nameConfig[item]["max"],10);var step=parseInt(nameConfig[item]["step"],10)||1;for(var k=0;k<max-min+1;k++){if(names.length!==max-min+1){names.push(input.replace(reg,k+min));}else{console.log(typeof names[k]);names[k]=names[k].replace(reg,k*step+min);}}}}}}}
catch(e){_this.batchErr.name=true;}}else{names.push(input);}
return names;},generatePrefix:function(){var _this=this;var input=_this.prefixInput.value.trim();var prefix=[];if(_this.batch){try{if(input===''||input.length===0){for(var i=0;i<_this.names.length;i++){prefix.push('');}}else{var config=$("#batchPrefixArea").val().trim();config=config.replace((/([\w]+)(:)/g),"\"$1\"$2");config=config.replace((/'/g),"\"");if(config==''){alert('前缀批量设置为空！');return prefix}
var prefixConfig=JSON.parse(config);for(var item in prefixConfig){if(prefixConfig.hasOwnProperty(item)){var reg=new RegExp('<#'+item+'#>','g');if(Object.prototype.toString.call(prefixConfig[item]).slice()==='[object Array]'){var pre;for(var j=0;j<prefixConfig[item].length;j++){if(prefix.length!==prefixConfig[item].length){pre=input.replace(reg,prefixConfig[item][j]);prefix.push(pre);}else{pre=prefix[j].replace(reg,prefixConfig[item][j]);prefix[j]=pre;}}}else{var min=parseInt(prefixConfig[item]["min"],10);var max=parseInt(prefixConfig[item]["max"],10);for(var k=0;k<max-min+1;k++){if(prefix.length!==max-min+1){prefix.push(input.replace(reg,k+min));}else{console.log(typeof prefix[k]);prefix[k]=prefix[k].replace(reg,k+min);}}}}}}}catch(e){_this.batchErr.prefix=true;}}else{if(input===''||input.length===0){prefix.push('');}else{prefix.push(input);}}
return prefix;},generatePId:function(){var $parentList=$('.parentList');var pId={};var arrPId=[];pId[_this.parentNode['_id']]=true;for(var i=0;i<$parentList.length;i++){if($parentList.eq(i).val()&&$parentList.eq(i).val()!='-1'){pId[$parentList.eq(i).val()]=true}}
for(var ele in pId){arrPId.push(ele)}
if(arrPId.length==1)arrPId=arrPId.toString();return arrPId;},addGroup:function(){var _this=this;var groupList=document.getElementById("groupList"),subGroupList=document.getElementById("subGroupList"),group=groupList.options[groupList.selectedIndex].value,subGroup=subGroupList.options[subGroupList.selectedIndex].value,subGroupName=subGroupList.options[subGroupList.selectedIndex].text;if(group!=="-1"&&subGroup!=="-1"){var addedGroup=document.getElementById("addedGroup");var div=document.createElement("div"),name=document.createElement("span"),rmBtn=document.createElement("div"),icon=document.createElement("span");div.className="col-sm-3 btn";div.setAttribute("data-group",group);div.setAttribute("data-subgroup",subGroup);div.setAttribute("data-name",subGroupName);name.innerHTML=subGroupName;icon.className="glyphicon glyphicon-minus";rmBtn.appendChild(icon);rmBtn.style.float="right";div.appendChild(name);div.appendChild(rmBtn);addedGroup.appendChild(div);if(addedGroup.classList.contains("hide")){addedGroup.classList.remove("hide");}
rmBtn.onclick=function(e){var addedGroup=document.getElementById("addedGroup"),currentRow=e.target.parentElement.parentElement;addedGroup.removeChild(currentRow);if(addedGroup.childElementCount===0){addedGroup.classList.add("hide");}}}},removeGroup:function(e){var addedGroup=document.getElementById("addedGroup"),currentRow=e.parentNode;addedGroup.removeChild(currentRow);if(addedGroup.childElementCount===0){addedGroup.classList.add("hide");}},getAddedGroup:function(){var _this=this;var arr=[];var groupRow=document.getElementById("addedGroup").childNodes;for(var i=0;i<groupRow.length;i++){if(groupRow[i].nodeName.toLowerCase()=='div'&&groupRow[i].hasAttribute("data-group")){var g={};g.group=groupRow[i].getAttribute("data-group");g.subGroup=groupRow[i].getAttribute("data-subGroup");g.name=groupRow[i].getAttribute("data-name");arr.push(g);}}
return arr;},getBindDataSource:function(){var _this=this;_this.devices.forEach(function(val,index){var device=val;var p=device.prefix;var attrs=device.attrs;var arrP=device.arrP;WebAPI.get("/point_tool/searchCloudPoint/"+_this.parentNode.projId+"/"+p+"/").done(function(result){if(result.success){var data=result.data["pointTable"];if(data.length==0){_this.initBindData(device);return;}
var idGroup=[];for(var n=0,len=data.length;n<len;n++){idGroup.push(data[n]._id);}
for(var j=0;j<attrs.length;j++){for(var k=0;k<data.length;k++){if(attrs[j]["fullName"]===data[k]["value"]){attrs[j]["id"]=data[k]["_id"];arrP[attrs[j]["name"]]=data[k]["_id"];}}}
var postData={"dsItemIds":idGroup};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(result){if(result.dsItemList&&result.dsItemList.length>0){var d=result["dsItemList"];for(var l=0;l<attrs.length;l++){for(var m=0;m<d.length;m++){if(attrs[l]["id"]===d[m]["dsItemId"]){attrs[l]["value"]=d[m]["data"];}}}}else{console.log("the data of bind point is not loaded");}
_this.initBindData(device);});}else{console.log("the data of prefix attrs is not loaded");}}).fail(function(){_this.initBindData(device);});})},initBindData:function(device){var _this=this;var names=_this.names;var frag=document.createDocumentFragment();var name=document.createElement("label"),wrap=document.createElement("div"),container=document.createElement("div");wrap.className="form-group row";container.className="container-fluid";container.setAttribute("data-name",device.name);name.className="text-center col-sm-12 form-control-label";name.innerHTML="名称(Name)："+device.name;wrap.appendChild(name);container.appendChild(wrap);for(var k=0,leng=device.attrs.length;k<leng;k++){var div=document.createElement("div"),lab=document.createElement("label"),cnlab=document.createElement("label"),btn=document.createElement("div");div.className="form-group row";lab.className="text-center col-sm-4 form-control-label";cnlab.className="text-center col-sm-4 form-control-label";btn.className="btn text-center col-sm-3";div.id=device.attrs[k]["id"];lab.innerHTML=device.attrs[k]["fullName"];cnlab.innerHTML=device.attrs[k]["cnName"];btn.innerHTML=device.attrs[k]["value"];div.appendChild(lab);div.appendChild(cnlab);div.appendChild(btn);container.appendChild(div);}
frag.appendChild(container);_this.bindDataGroup.appendChild(frag);},generateFullBindData:function(){var _this=this;var arr=[];for(var i=0;i<_this.devices.length;i++){for(var attr in _this.type["attrs"]){if(_this.type["attrs"].hasOwnProperty(attr)){var obj={};obj["fullName"]=_this.devices[i]["prefix"]+attr;obj["cnName"]=_this.type["attrs"][attr]["name"];obj["value"]='--';obj["id"]=null;arr.push(obj);_this.devices[i]["attrs"].push(obj);}}}
return arr;},onCarouselMove:function(){var _this=this;var currentIndex=$(this).find('.active').index()+1;if(currentIndex!==1){}else{$("#nextBtn").hide();$("#confirmBtn").removeClass("hide");}},checkValid:function(index){var _this=this;var valid;if(index===0){_this.batchErr={name:false,prefix:false};_this.names=_this.generateName();_this.prefix=_this.generatePrefix();if(_this.nameInput.value.trim()===""){alert("请输入设备名称");_this.nameInput.focus();valid=false;}else if(_this.batch&&_this.nameConfigInput.value.trim()===""){alert("请输入名称批量设置");_this.nameConfigInput.focus();}else if(_this.typeList.options[_this.typeList.selectedIndex].value==='-1'){alert("请选择类型");_this.typeList.focus();valid=false;}else if(_this.batchErr.name){alert("名字批量设置格式错误，请检查");}else if(_this.batchErr.prefix){alert("前缀批量设置格式错误，请检查");}else{valid=true;}
if(valid){_this.type=_this.typeList.options[_this.typeList.selectedIndex].value;_this.pId=_this.generatePId();_this.createDevice();if(_this.mode=='edit'||_this.prefix&&_this.prefix instanceof Array&&_this.prefix.join('').length>0){_this.getBindDataSource();$("#createModalSld").carousel("next");}else{_this.closeModal(true)}}}}};return CreateDeviceModal;})();var ElScreenContainer=document.getElementById('indexMain');var ScreenCurrent=undefined;var ScreenPrevious=undefined;var Spinner=new LoadingSpinner({color:'#00FFFF'});var AppConfig={projectId:121,userId:undefined,account:undefined,roomList:undefined,isMobile:true};var roomAll=undefined;var I18n=undefined;var appConfigManager=(function(){var DEFAULT_CONFIG={gps:0};function get(){var options=window.localStorage.getItem('appConfig');if(options===null){set(DEFAULT_CONFIG);return DEFAULT_CONFIG;}
try{options=JSON.parse(options);}catch(e){}
return options;}
function set(options){window.localStorage.setItem('appConfig',JSON.stringify(options));}
return{get:get,set:set}}());$(document).ready(function(){if(navigator.userAgent.match(/iP(ad|hone|od)|Android/i))AppConfig.isMobile=true;InitI18nResource(navigator.language.split('-')[0],null,'/static/app/temperatureControl/views/i18n/').always(function(rs){I18n=new Internationalization(null,rs);ScreenManager.show(IndexScreen);});});var IndexScreen=(function(){function IndexScreen(){}
IndexScreen.prototype={show:function(){var _this=this;WebAPI.get('/static/app/temperatureControl/admin/views/admin/login.html').done(function(resultHTML){$('#indexMain').html(resultHTML);I18n.fillArea($('#indexMain'));_this.init();});},close:function(){document.onkeydown=false;},init:function(){var _this=this;_this.initLogin();_this.initNav();},initLogin:function(){this.restorePwd();var _this=this;$("#btnLogin").off('click').on('click',function(e){_this.login();});$(document).on("keydown","#divLogin input",function(event){var e=event||window.event||arguments.callee.caller.arguments[0];if(e&&e.keyCode==13){_this.login();}});},login:function(){var _this=this;var $btnLogin=$('#btnLogin');Spinner.spin($btnLogin[0]);var userName=$("#userName").val(),password=$("#password").val();var loginFail=function(msg){$('.alert').remove();new Alert($("#divLoginAlert"),"danger",msg).show().close();Spinner.stop();};if(!(userName&&password)){loginFail(I18n.resource.admin.index.NAME_ERROR);return;}
WebAPI.post("/login",{name:userName,pwd:password,agent:jscd?jscd:{}}).then(function(login_result){try{var after_login=function(){if(login_result.status!=undefined&&login_result.status==true){if(login_result.projects&&login_result.projects.length>0){_this.rememberPwd();AppConfig.userId=login_result.id;AppConfig.account=$("#userName").val();ScreenManager.show(ConfigScreen);}else{loginFail(I18n.resource.admin.index.LOGIN_ERROR_INFO);}}else{loginFail(I18n.resource.admin.index.NAME_ERROR);}}}catch(e){loginFail(I18n.resource.admin.index.LOGIN_ERROR);return false;}
after_login();}).always(function(){Spinner.stop();})},rememberPwd:function(){localStorage["userInfo"]=JSON.stringify({name:$("#userName").val(),pwd:$("#password").val()});},restorePwd:function(){if(localStorage["userInfo"]){var data=JSON.parse(localStorage["userInfo"]);if(data.pwd&&data.pwd!=""){$("#userName").val(data.name);$("#password").val(data.pwd);}}},initNav:function(){}};return IndexScreen;})();var ConfigScreen=(function(){var _this;function ConfigScreen(){_this=this;this.curBase=undefined;this.curArrSpace=undefined;this.curArrSensor=undefined;this.curArrController=undefined;this.configTool=undefined;this.roomTree=undefined;this.$roomManagerPanel=undefined;_this.curStore=undefined;_this.store={};_this.default={ctrW:40,ctrH:40,sensorW:40,sensorH:40}}
ConfigScreen.prototype={show:function(){WebAPI.get('/static/app/temperatureControl/admin/views/configure/configScreen.html').done(function(resultHTML){ElScreenContainer.innerHTML=resultHTML;_this.init();})},init:function(){_this.curStore={room:[],space:[],sensor:[],controller:[]};_this.initRoomTree();_this.initRoomConfig();_this.initBaseInfoModal();},initRoomTree:function(){this.$roomManagerPanel=$('#divConfigManager');this.roomTree=new HierFilter(this.$roomManagerPanel,null,_this);this.roomTree.init();var option={class:{'projects':{showNone:true},'groups':{class:['Group']}},tree:{show:true,data:dataFilter,event:{click:[{act:onNodeClick,tar:['groups']},{act:onProjClick,tar:['projects']},{act:function(){console.log('click things')},tar:'things'}],addDom:beforeAddDom},drag:{enable:false},tool:{add:{act:_this.initRoomAdd,default:false},delete:_this.initRoomDelete,beforeAdd:function(parentNode){if(parentNode.baseType=='groups'){return{parentNode:parentNode.getParentNode()}}}}}};function dataFilter(dataList,baseType){for(var i=0;i<dataList.length;i++){if(baseType!='projects'&&dataList[i].baseType!='projects'){if(dataList[i].type!='GroupRoom'){dataList.splice(i,1);i--}}}}
function onProjClick(e,treeId,treeNode){roomAll=[];for(var i=0;i<_this.roomTree.store.groups.length;i++){if(_this.roomTree.store.groups[i].type=='GroupRoom'){_this.roomTree.store.groups[i].baseType='groups';roomAll.push(_this.roomTree.store.groups[i]);}}}
function onNodeClick(e,treeId,treeNode){WebAPI.get('/appTemperature/room/getDetail/'+treeNode['_id']).done(function(detailInfo){var sensor=[],controller=[];detailInfo.data.device.forEach(function(val){if(val.type.indexOf('Sensor')>-1){sensor.push(val)}else{controller.push(val)}});_this.store[treeNode['_id']]={room:_this.searchRoom(treeNode['_id']),space:detailInfo.data.space,sensor:sensor,controller:controller};_this.curStore={room:_this.searchRoom(treeNode['_id']),space:detailInfo.data.space,sensor:sensor,controller:controller};_this.store[treeNode['_id']]=_this.curStore;if(_this.configTool){_this.configTool.toolStatus='init';_this.configTool.eventStatus='init';$('.btnConfigTool.selected').removeClass('selected');for(var i=0;i<_this.configTool.tempEvent.length;i++){$('#containerMap').off(_this.configTool.tempEvent[i]);}
$('.divMapTool').css('display','');$('.main').removeClass('main');$('.relate').removeClass('relate');}
_this.initConfigMapInfo();})}
var btnUpdate,btnCfg,btnRemove;function beforeAddDom(treeNode,treeTar){if(treeNode.type!='GroupRoom'){return;}
treeNode.open=false;treeNode.isParent=false;treeTar.find('.bottom_close').removeClass('bottom_close').addClass('bottom_docu');treeTar.find('.center_close').removeClass('center_close').addClass('center_docu');treeTar.find('.ico_close').removeClass('ico_close').addClass('ico_docu');btnCfg=document.createElement('span');btnCfg.className='btnRoomConfig btnTreeNode glyphicon glyphicon-cog';btnRemove=document.createElement('span');btnRemove.className='btnDelete btnTreeNode glyphicon glyphicon-remove-sign';treeTar.find('>a').append(btnCfg);treeTar.find('>a').append(btnUpdate);treeTar.attr('roomid',treeNode['_id'])}
this.roomTree.setOption(option);},initRoomAdd:function(parentNode,treeNode){var arrNewRoom=[];var newRoom;for(var i=0;i<treeNode.length;i++){if(treeNode[i].baseType!='groups')continue;newRoom={'_id':treeNode[i]['_id'],'_idProj':parentNode[0]['_id'],'arrP':{},name:treeNode[i].name,pId:'',prefix:'',projId:treeNode[i].projId,type:'GroupRoom',weight:0,params:{mode:0,password:'',gatewayId:'',map:{height:"",width:"",img:"",gps:[],orientation:0,scale:1},sm:1},baseType:'groups'};arrNewRoom.push(newRoom);_this.roomTree.tree.updateNode(newRoom);treeNode[i].params={mode:0,password:'',gatewayId:'',map:{height:"",width:"",img:"",gps:[],orientation:0,scale:1},sm:1}}
WebAPI.post('/iot/setIotInfo',arrNewRoom).done(function(result){_this.curBase=arrNewRoom[0];roomAll=roomAll.concat(arrNewRoom);_this.roomTree.store['groups']=_this.roomTree.store['groups'].concat(arrNewRoom);for(var i=0;i<arrNewRoom.length;i++){_this.store[arrNewRoom[i]['_id']]={room:arrNewRoom[i],space:[],sensor:[],controller:[]};WebAPI.post('/appTemperature/room/corelateUser',{userId:AppConfig.userId,roomId:arrNewRoom[i]['_id']}).done(function(){});var postData={roomId:arrNewRoom[i]['_id'],userId:AppConfig.userId,grade:30};WebAPI.post('/appTemperature/room/setUserGrade',postData).done(function(){});}
_this.curStore=_this.store[arrNewRoom[0]['_id']];_this.initConfigMapInfo();});},initRoomDelete:function(treeNode){WebAPI.get('/appTemperature/room/getDetail/'+treeNode['_id']).done(function(detailInfo){var sensor=[],controller=[];detailInfo.data.device.forEach(function(val){if(val.type.indexOf('Sensor')>-1){sensor.push(val)}else{controller.push(val)}});var arrDelete=[{id:[],type:'groups'},{id:[],type:'things'}];for(var i=0;i<detailInfo.data.space.length;i++){arrDelete[0].id.push(detailInfo.data.space[i]['_id']);}
for(var i=0;i<detailInfo.data.device.length;i++){arrDelete[1].id.push(detailInfo.data.device[i]['_id']);}
WebAPI.post('/iot/delIotInfo',{itemList:arrDelete}).done(function(result){console.log(result.status);delete _this.store[treeNode['_id']];_this.curStore=null;document.getElementById('imageMap').src='';document.getElementById('ctnSvg').innerHTML='';$('#containerMap .divMapEle').remove();});});},initRoomConfig:function(){var $btnRoomUpdate=$('.btnRoomUpdate');var index;var $divRoom=$('.divRoom');this.$roomManagerPanel.on('click','.btnDelete',function(e){Spinner.spin(ElScreenContainer);});$divRoom.first().trigger('click');},initAddRoom:function(){var $btnNewRoom=$('#btnNewRoom');var ctn=document.getElementById('divRoomList');var id,roomConfig;var room,btnCfg,btnUpdate;$btnNewRoom.off('click').on('click',function(){if($('.newRoom').length>0)return;id=ObjectId();room=document.createElement('button');room.className='divRoom newRoom';room.id=id;room.textContent='新房间';btnCfg=document.createElement('span');btnCfg.className='btnRoomConfig glyphicon glyphicon-cog';btnUpdate=document.createElement('span');btnUpdate.className='btnRoomUpdate glyphicon glyphicon-floppy-save';room.appendChild(btnCfg);room.appendChild(btnUpdate);ctn.appendChild(room);roomConfig={'_idProj':'','arrP':{},name:"新房间",pId:'',prefix:'',projId:1,type:'GroupRoom',weight:0,params:{gatewayId:'',map:{height:"",width:"",img:"",gps:[],orientation:0,scale:1}}};$('.divRoom.selected').removeClass('selected');roomAll.push(roomConfig);$(room).trigger('click');})},initBaseInfoModal:function(){var $modalConfigBaseInfo=$('#modalConfigBaseInfo');var $divConfigBaseInfo=$('#divConfigBaseInfo');var btnBaseInfoConfirm=$('#btnBaseInfoConfirm');var $inputRoomName=$('#inputRoomName');var $inputGatewayId=$('#inputGatewayId');var baseInfo;var tId='',node;this.$roomManagerPanel.on('click','.btnRoomConfig',function(e){baseInfo=_this.searchRoom($(e.currentTarget).parentsUntil('.projects','.groups').attr('roomId'));tId=$(e.currentTarget).parent().parent()[0].id;$inputRoomName.val(baseInfo.name);$inputGatewayId.val(baseInfo.params.gatewayId);$modalConfigBaseInfo.modal('show');});$modalConfigBaseInfo.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$divConfigBaseInfo.find('input').val('');});btnBaseInfoConfirm.off('click').on('click',function(e){baseInfo.name=$inputRoomName.val();node=_this.roomTree.tree.getNodeByTId(tId);node.name=baseInfo.name;_this.roomTree.tree.updateNode(_this.roomTree.tree.getNodeByTId(tId));baseInfo.params.gatewayId=$inputGatewayId.val();var index=$('.divRoom').index($(e.currentTarget));$modalConfigBaseInfo.modal('hide');tId='';var postData;var roomId=baseInfo['_id'];WebAPI.post('/iot/setIotInfo',[baseInfo]).done(function(result){console.log(result.status);});})},initConfigMapInfo:function(){var $imgMap=$('#imageMap');var ctnMap=document.getElementById('containerMap');var $divDirectionTool=$('#divDirectionTool');var $divScaleTool=$('#divScaleTool');$('.divSpace').remove();$('.divSensor').remove();$('.divController').remove();$(ctnMap).find('svg').html('');$imgMap.attr('src','');_this.initConfigTool();if(!(_this.curStore.room&&_this.curStore.room.params&&_this.curStore.room.params.map))return;$divDirectionTool.css('transform','rotate('+_this.curStore.room.params.map.orientation+'deg)');if(_this.curStore.room.params.map.scale)$divScaleTool.val(_this.curStore.room.params.map.scale);if(_this.curStore.room.params.map.img)$imgMap.attr('src',_this.curStore.room.params.map.img);var $ctnSvg=$('#ctnSvg');var $ctnSvgWall=$('#ctnSvgWall');var space,topWall,rightWall,bottomWall,leftWall,sensor,controller,rightTopCorner,rightBottomCorner,leftTopCorner,leftBottomCorner,path,circle,pathAttr,arrPath;var relateLine;if(_this.curStore.room.params.map.img){$imgMap[0].onload=function(){for(var i=0;i<_this.curStore.space.length;i++){pathAttr=_this.curStore.space[i].params.path;if(!pathAttr||pathAttr.length==0){space=document.createElement('div');space.className='divSpace divMapEle';space.id=_this.curStore.space[i]['_id'];space.style.left=_this.curStore.space[i].params.x+'px';space.style.top=_this.curStore.space[i].params.y+'px';space.style.height=_this.curStore.space[i].params.height+'px';space.style.width=_this.curStore.space[i].params.width+'px';space.dataset.type='space';space.dataset.relate='sensor';space.dataset.sensor='';topWall=document.createElement('div');topWall.className='topWall wall divMapEle';topWall.dataset.orient='top';rightWall=document.createElement('div');rightWall.className='rightWall wall divMapEle';rightWall.dataset.orient='right';bottomWall=document.createElement('div');bottomWall.className='bottomWall wall divMapEle';bottomWall.dataset.orient='bottom';leftWall=document.createElement('div');leftWall.className='leftWall wall divMapEle';leftWall.dataset.orient='left';rightTopCorner=document.createElement('div');rightTopCorner.className='divCorner rightTopCorner divMapEle';rightTopCorner.dataset.orient='rightTop';rightBottomCorner=document.createElement('div');rightBottomCorner.className='divCorner rightBottomCorner divMapEle';rightBottomCorner.dataset.orient='rightBottom';leftTopCorner=document.createElement('div');leftTopCorner.className='divCorner leftTopCorner divMapEle';leftTopCorner.dataset.orient='leftTop';leftBottomCorner=document.createElement('div');leftBottomCorner.className='divCorner leftBottomCorner divMapEle';leftBottomCorner.dataset.orient='leftBottom';space.appendChild(topWall);space.appendChild(rightWall);space.appendChild(bottomWall);space.appendChild(leftWall);space.appendChild(rightTopCorner);space.appendChild(rightBottomCorner);space.appendChild(leftTopCorner);space.appendChild(leftBottomCorner);ctnMap.appendChild(space);}else{space=document.createElementNS('http://www.w3.org/2000/svg','g');space.setAttribute('class','divSpace divMapEle');space.setAttribute('data-sensor','');space.id=_this.curStore.space[i]['_id'];path=document.createElementNS('http://www.w3.org/2000/svg','path');path.setAttribute('class','pathSpace pathWall divMapEle');if(_this.curStore.space[i].params.path){}
path.setAttribute('d',pathAttr);space.appendChild(path);arrPath=pathAttr.split(' ');for(var j=0;j<arrPath.length-3;j+=2){circle=document.createElementNS('http://www.w3.org/2000/svg','circle');if(j==0){circle.setAttribute('class','divMapEle divCorner startWallNode')}else{circle.setAttribute('class','divMapEle divCorner')}
circle.setAttribute('cx',arrPath[j].slice(1));circle.setAttribute('cy',arrPath[j+1]);circle.setAttribute('r',5);space.appendChild(circle)}
$ctnSvgWall.append(space);}}
for(var i=0;i<_this.curStore.controller.length;i++){if(!_this.curStore.controller[i].params)continue;controller=document.createElement('div');controller.id=_this.curStore.controller[i]['_id'];controller.className='divController divMapEle glyphicon glyphicon-cog';controller.dataset.type='controller';controller.dataset.relate='sensor';controller.dataset.sensor='';controller.style.left=_this.curStore.controller[i].params.gps[0]-_this.default.ctrW/2+'px';controller.style.top=_this.curStore.controller[i].params.gps[1]-_this.default.ctrH/2+'px';ctnMap.appendChild(controller);}
for(var i=0;i<_this.curStore.sensor.length;i++){if(!_this.curStore.sensor[i].params)continue;sensor=document.createElement('div');sensor.id=_this.curStore.sensor[i]['_id'];sensor.className='divSensor divMapEle glyphicon glyphicon-eye-open';sensor.dataset.space=_this.curStore.sensor[i].pId.join(' ');sensor.dataset.controller=_this.curStore.sensor[i].params.cId;sensor.dataset.type='sensor';sensor.dataset.relate='space controller';sensor.style.left=_this.curStore.sensor[i].params.gps[0]-_this.default.sensorW/2+'px';sensor.style.top=_this.curStore.sensor[i].params.gps[1]-_this.default.sensorH/2+'px';ctnMap.appendChild(sensor);var relate=document.getElementById(_this.curStore.sensor[i].params.cId);if(relate){relate.dataset.sensor=sensor.id;relateLine=document.createElementNS('http://www.w3.org/2000/svg','line');relateLine.className.baseVal='relateLine';relateLine.setAttribute('x1',_this.curStore.sensor[i].params.gps[0]);relateLine.setAttribute('y1',_this.curStore.sensor[i].params.gps[1]);relateLine.setAttribute('x2',_this.searchDevice('controller',relate.id).params.gps[0]);relateLine.setAttribute('y2',_this.searchDevice('controller',relate.id).params.gps[1]);relateLine.setAttribute('data-sensor',_this.curStore.sensor[i]['_id']);relateLine.setAttribute('data-controller',relate.id);$ctnSvg.append(relateLine);}
if(typeof _this.curStore.sensor[i].pId=='string'){relate=document.getElementById(_this.curStore.sensor[i].pId);if(relate)relate.setAttribute('data-sensor',sensor.id);}else if(_this.curStore.sensor[i].pId instanceof Array){for(var j=0;j<_this.curStore.sensor[i].pId.length;j++){relate=document.getElementById(_this.curStore.sensor[i].pId[j]);if(relate)relate.setAttribute('data-sensor',sensor.id);}}}}}else{_this.initConfigTool();}},initConfigTool:function(){this.configTool=new ConfigTool(_this);this.configTool.init();},searchRoom:function(id){if(id=='new'){for(var i=0;i<roomAll.length;i++){if(typeof roomAll[i]['_id']=='undefined'){return roomAll[i];}}}else{for(var i=0;i<roomAll.length;i++){if(roomAll[i]['_id']==id){return roomAll[i];}}}},searchDevice:function(type,id){for(var i=0;i<_this.curStore[type].length;i++){if(_this.curStore[type][i]['_id']==id){return _this.curStore[type][i];}}
return;},close:function(){}};return ConfigScreen;})();var ConfigTool=(function(){var _this;function ConfigTool(screen){_this=this;this.screen=screen;this.curStore=undefined;this.mapOffset=undefined;this.tempEvent=undefined;this.toolStatus=undefined;this.eventStatus=undefined;this.mouseUpTime=undefined;this.dictAttr=undefined;this.delete=[{id:[],type:'groups'},{id:[],type:'things'}];this.map={offsetX:0,offsetY:0,imgX:0,imgY:0,mapX:0,mapY:0}}
ConfigTool.prototype={init:function(){_this.tempEvent=[];_this.toolStatus='init';_this.eventStatus='init';_this.curStore=_this.screen.curStore;_this.initOffsetSum();_this.initJqSvg();_this.initToolSel();_this.initMapImport();_this.initDirectAndScale();_this.initAddSpace();_this.initEleMoveAndClick();_this.initAddController();_this.initAddSensor();_this.initRelate();_this.initUserRole();_this.initSaveDetail();_this.initDelete();},initOffsetSum:function(){function getOffsetSum(ele){var top=0,left=0;while(ele){top+=ele.offsetTop;left+=ele.offsetLeft;ele=ele.offsetParent;}
return{top:top,left:left}}
var $containerMap=$('#containerMap');var $divMap=$('#divConfigMapInfo');this.mapOffset=getOffsetSum($containerMap[0]);$divMap.off('resize').on('resize',function(){_this.mapOffset=getOffsetSum($containerMap[0]);})},initEventJudge:function(){var $containerMap=$('#containerMap');$containerMap.off('mousedown')},initToolSel:function(){var $btnConfigTool=$('.btnConfigTool');$btnConfigTool.off('click.manager').on('click.manager',function(e){removeToolSel(e);$(e.currentTarget).addClass('selected');$('.divMapTool').css('display','none');});var $containerMap=$('#containerMap');$containerMap.off('contextmenu').on('contextmenu',function(e){if(_this.toolStatus=='addSpaceStart'){$('.spaceAdding').remove();return false;}
removeToolSel(e);return false;});function removeToolSel(e){if(e.which!=3&&!$(e.target).hasClass('btnConfigTool'))return;_this.toolStatus='init';_this.eventStatus='init';$('.btnConfigTool.selected').removeClass('selected');for(var i=0;i<_this.tempEvent.length;i++){$containerMap.off(_this.tempEvent[i]);}
$('.divMapTool').css('display','');$('.main').removeClassEx('main');$('.relate').removeClassEx('relate');$containerMap.on('contextmenu',function(e){if(_this.toolStatus=='addSpaceStart'){$('.spaceAdding').remove();return false;}
removeToolSel(e);return false;});}},initMapImport:function(){var $inputMap=$('#inputMap');var $imageMap=$('#imageMap');$('#btnMapImport').off('click.tool').on('click.tool',function(e){_this.toolStatus='importMap';e.stopPropagation();$inputMap.trigger('click');});var files,fileType=/image*/,fileName,formData=new FormData();$inputMap.off('change').on('change',function(e){files=e.target.files;if(!files)return;if(!files[0].type.match(fileType)){return;}
for(var i=0,len=files.length;i<len;i++){fileName=_this.screen.curStore.room._id+'.'+files[i].name.split('.')[1];formData.append('file_list[]',files[i]);formData.append('name_list[]',fileName);}
formData.append('path','custom/appTemperature/maps');$.ajax({url:'/oss/uploadtocustom',type:'post',data:formData,cache:false,contentType:false,processData:false,success:function(result){if(result.success){$imageMap[0].src=_this.screen.curStore.room.params.map.img='http://images.rnbtech.com.hk/'+'custom/appTemperature/maps/'+fileName;_this.screen.curStore.room.params.map.height=$imageMap.height();_this.screen.curStore.room.params.map.width=$imageMap.width();}}})})},initDirectAndScale:function(){var $divDirection=$('#divDirectionTool');var directionStatus='end';var directionCenter,evPos,startAngle,moveAngle,endAngle;endAngle=0;$divDirection.off('mousedown').on('mousedown',function(e){e.preventDefault();if(directionStatus!='end')return;if(isNaN(endAngle))endAngle=0;directionCenter={x:$divDirection[0].offsetLeft+$divDirection.width()/2,y:$divDirection[0].offsetTop+$divDirection.height()/2};evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};startAngle=360*Math.atan2(-(evPos.y-directionCenter.y),(evPos.x-directionCenter.x))/(2*Math.PI);directionStatus='start';console.log('startAngle: '+startAngle);});$divDirection.off('mousemove').on('mousemove',function(e){e.preventDefault();if(directionStatus!='start'&&directionStatus!='move')return;evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};moveAngle=360*Math.atan2(-(evPos.y-directionCenter.y),(evPos.x-directionCenter.x))/(2*Math.PI);$divDirection.css('transform','rotate('+(endAngle+startAngle-moveAngle)+'deg)');console.log('moveAngle: '+moveAngle);console.log('endAngle: '+endAngle);console.log(endAngle+startAngle-moveAngle);directionStatus='move';});$divDirection.off('mouseup').on('mouseup',function(e){e.preventDefault();if(directionStatus!='move')return;endAngle+=startAngle-moveAngle;_this.screen.curStore.room.params.map.orientation=endAngle;directionStatus='end';});$divDirection.off('mouseleave').on('mouseleave',function(e){e.preventDefault();endAngle+=startAngle-moveAngle;directionStatus='end';});var $inputScale=$('#inputScale');var scale;$inputScale.off('input').on('input',function(e){scale=Math.pow(10,$(e.currentTarget).val());$inputScale.prev().text(scale);_this.screen.curStore.room.params.map.scale=scale;})},initAddSpace:function(){var $containerMap=$('#containerMap');var svgWall=document.getElementById('ctnSvgWall');var xStart,yStart,xEnd,yEnd,height,width,evPos;var pathAttr='';var $mapTool=$('.divMapTool');var wallPath,pathNum,line,arrPath,node,status,div,id,size;this.tempEvent.push('click.temp','mousemove.temp');$('#btnAddSpace').off('click.tool').on('click.tool',function(e){pathNum=0;_this.toolStatus='addSpaceEnd';$mapTool.css('display','none');status='end';arrPath=[];$containerMap.off('click.temp').on('click.temp',function(e){e.preventDefault();if(e.which!=1&&div){$(div).remove();return;};if($(e.target).attr('class')&&$(e.target).attr('class').indexOf('divMapEle')>-1)return;if(status!='end'&&status!='move')return;evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};if(_this.pathClose(arrPath,evPos)){status='end';$containerMap.css('cursor','default');arrPath[2*pathNum]='L'+arrPath[0].slice(1);arrPath[2*pathNum+1]=arrPath[1];if(arrPath.length>=8){pathAttr=arrPath.join(' ');pathAttr+=' '+'Z';wallPath.setAttribute('d',pathAttr);size=wallPath.getBoundingClientRect();_this.screen.curStore.space.push({'_id':id,'name':'','_idProj':_this.screen.curStore.room['_idProj'],'arrP':{},'pId':_this.screen.curStore.room['_id'],'prefix':'','projId':_this.screen.curStore.room['projId'],'type':'GroupSpace','weight':0,'params':{'path':pathAttr,'width':size.width,'height':size.height,'x':size.left-_this.mapOffset.left,'y':size.top-_this.mapOffset.top},baseType:'groups'});div.setAttribute('class','divSpace divMapEle');}else{$(div).remove();}
_this.toolStatus='addSpaceEnd';pathNum=0;div=null;return;}
xStart=evPos.x;yStart=evPos.y;if(pathNum==0){id=ObjectId();$containerMap.css('cursor','crosshair');pathAttr='';arrPath=[];wallPath=document.createElementNS('http://www.w3.org/2000/svg','path');wallPath.className.baseVal='pathSpace pathWall divMapEle';div=document.createElementNS('http://www.w3.org/2000/svg','g');div.className.baseVal='divSpace divMapEle spaceAdding';div.id=id;div.setAttribute('data-sensor','');div.appendChild(wallPath);svgWall.appendChild(div);pathAttr='M'+xStart+' '+yStart;_this.toolStatus='addSpaceStart';}
line='L'+xStart+' '+yStart;node=document.createElementNS('http://www.w3.org/2000/svg','circle');node.className.baseVal='divMapEle divCorner';node.setAttribute('cx',evPos.x);node.setAttribute('cy',evPos.y);node.setAttribute('r',5);if(pathNum==0){node.className.baseVal+=' startWallNode';}
div.appendChild(node);pathAttr+=' '+line;arrPath=pathAttr.split(' ');wallPath.setAttribute('d',pathAttr);console.log(pathAttr);status='start';pathNum++;});$containerMap.off('mousemove.temp').on('mousemove.temp',function(e){e.preventDefault();if(status!='start'&&status!='move')return;evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};if(e.ctrlKey&&_this.pathClose(arrPath,evPos,true)){line='L'+arrPath[0].slice(1)+' '+arrPath[1]+' ';arrPath[2*pathNum]='L'+evPos.x;arrPath[2*pathNum+1]=evPos.y;}else{line='L'+xStart+' '+yStart;arrPath[2*pathNum]='L'+evPos.x;arrPath[2*pathNum+1]=evPos.y;}
pathAttr=arrPath.join(' ');wallPath.setAttribute('d',pathAttr);console.log(pathAttr);$containerMap.css('cursor','crosshair');status='move';});})},initEleMoveAndClick:function(){var $containerMap=$('#containerMap');var $mapTool=$('.divMapTool');var spaceStatus='end';var xStart,yStart,evPos,initPos,$target,type,size,initD,initArrD,arrD;var spaceH,spaceW,spaceLeft,spaceTop;var targetData;$containerMap.off('mousedown.general').on('mousedown.general',function(e){if(spaceStatus!='end')return;targetData=null;if(!($(e.target).attr('class')&&$(e.target).attr('class').indexOf('divMapEle')>-1)){$('.divMapEle.selected').removeClassEx('selected');return;}
if(_this.toolStatus=='addSpaceStart')return;$target=$(e.target);type='';size=null;initD='';initArrD=[];if($target[0].tagName=='path'&&$target[0].className.baseVal.indexOf('pathWall')>-1){type='space'}else if($target[0].tagName=='circle'&&$target[0].className.baseVal.indexOf('divCorner')>-1){type='corner'}
if(type=='space'){size=$target[0].getBoundingClientRect();initPos={x:size.left,y:size.top,h:size.height,w:size.width};initD=$target[0].getAttribute('d');initArrD=initD.split(' ')}else if(type=='corner'){initPos={x:parseInt($target[0].getAttribute('cx')),y:parseInt($target[0].getAttribute('cy'))};initD=$target[0].parentNode.firstChild.getAttribute('d');initArrD=initD.split(' ')}else{initPos={x:$(e.target)[0].offsetLeft,y:$(e.target)[0].offsetTop};}
evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};xStart=evPos.x;yStart=evPos.y;spaceStatus='start';if(type=='space'){targetData=_this.searchDevice('space',$target[0].parentNode.id);}else if(type=='corner'){targetData=_this.searchDevice('space',$target[0].parentNode.id);}else if($target[0].dataset.type){targetData=_this.searchDevice($target[0].dataset.type,$target[0].id)}});$containerMap.off('mousemove.general').on('mousemove.general',function(e){if(spaceStatus!='start'&&spaceStatus!='move')return;_this.eventStatus='moveSpace';$('.divMapEle.selected').removeClassEx('selected');$target.addClass('selected');$mapTool.css('display','none');evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};if(type=='space'){arrD=initD.split(' ');for(var i=0;i<initArrD.length-1;i++){if(initArrD[i][0]=='M'||initArrD[i][0]=='L'){arrD[i]=initArrD[i][0]+(parseInt(initArrD[i].slice(1))+evPos.x-xStart);}else{arrD[i]=parseInt(initArrD[i])+evPos.y-yStart;}}
$target[0].setAttribute('d',arrD.join(' '));var arrNode=$target.parent().find('circle');for(var i=0;i<arrNode.length;i++){arrNode[i].setAttribute('cx',arrD[2*i].slice(1));arrNode[i].setAttribute('cy',arrD[2*i+1])}
$target.parent().addClassEx('selected')}else if(type=='corner'){var path=$target.parent()[0].firstChild;var index=$target.parent().children().index($target)-1;$target[0].setAttribute('cx',initPos.x+evPos.x-xStart);$target[0].setAttribute('cy',initPos.y+evPos.y-yStart);arrD=initD.split(' ');arrD[2*index]=initArrD[2*index][0]+(parseInt(initArrD[2*index].slice(1))+evPos.x-xStart);arrD[2*index+1]=parseInt(initArrD[2*index+1])+evPos.y-yStart;if($target.hasClassEx('startWallNode')){arrD[arrD.length-3]=initArrD[arrD.length-3][0]+(parseInt(initArrD[2*index].slice(1))+evPos.x-xStart);arrD[arrD.length-2]=parseInt(initArrD[arrD.length-2])+evPos.y-yStart;}
path.setAttribute('d',arrD.join(' '));$target.parent().addClassEx('selected')}
else{$target.css('cursor','default');$target.css({left:initPos.x+evPos.x-xStart,top:initPos.y+evPos.y-yStart});if(targetData){_this.setRelateLine($target[0].dataset.type,$target[0].id,initPos.x+evPos.x-xStart+$target.width()/2,initPos.y+evPos.y-yStart+$target.height()/2);}}
spaceStatus='move';});$containerMap.off('mouseup.general').on('mouseup.general',function(e){if(_this.toolStatus!='addSensor'&&_this.toolStatus!='addController'){if(spaceStatus=='start'){if(!_this.mouseUpTime){if(type=='space'||type=='corner'){if($target.parent().hasClassEx('selected')){$target.parent().removeClassEx('selected');}else{$('.divMapEle.selected').removeClassEx('selected');$target.parent().addClassEx('selected');}}else{if($target.hasClass('selected')){$target.removeClass('selected');}else{$('.divMapEle.selected').removeClassEx('selected');$target.addClass('selected');}}
_this.mouseUpTime=new Date();}else{if(new Date()-_this.mouseUpTime<300){_this.showDeviceModal($target);}else{if(type=='space'||type=='corner'){if($target.parent().hasClassEx('selected')){$target.parent().removeClassEx('selected');}else{$('.divMapEle.selected').removeClassEx('selected');$target.parent().addClassEx('selected');}}else{if($target.hasClass('selected')){$target.removeClass('selected');}else{$('.divMapEle.selected').removeClassEx('selected');$target.addClass('selected');}}}
_this.mouseUpTime=new Date();}}else if((spaceStatus=='move')){$mapTool.css('display','');if($target.hasClass('divSpace')){targetData.params.x=initPos.x+evPos.x-xStart;targetData.params.y=initPos.y+evPos.y-yStart;}else if(type=='space'){size=$target[0].getBoundingClientRect();targetData.params.x=initPos.x+evPos.x-xStart+$target.width()/2-_this.mapOffset.left;targetData.params.y=initPos.y+evPos.y-yStart+$target.height()/2-_this.mapOffset.top;targetData.params.path=$target[0].getAttribute('d');}else if(type=='corner'){size=$target[0].parentNode.firstChild.getBoundingClientRect();targetData.params.x=size.left-_this.mapOffset.left;targetData.params.y=size.top-_this.mapOffset.top;targetData.params.height=size.height;targetData.params.width=size.width;targetData.params.path=$target[0].parentNode.firstChild.getAttribute('d');}else if($target.hasClass('divController')||$target.hasClass('divSensor')){targetData.params.gps[0]=initPos.x+evPos.x-xStart+$target.width()/2;targetData.params.gps[1]=initPos.y+evPos.y-yStart+$target.height()/2;}else if($target.hasClass('divCorner')||$target.hasClass('wall')){for(var i=0;i<_this.screen.curStore.space.length;i++){if(_this.screen.curStore.space[i]['_id']==$target.parent().attr('id')){_this.screen.curStore.space[i].params.x=spaceLeft;_this.screen.curStore.space[i].params.y=spaceTop;_this.screen.curStore.space[i].params.width=spaceW;_this.screen.curStore.space[i].params.height=spaceH;break;}}}}}
spaceStatus='end';});},initAddOuterWall:function(){var $containerMap=$('#containerMap');var svgWall=document.getElementById('ctnSvgWall');var xStart,yStart,xEnd,yEnd,height,width,evPos;var pathAttr='';var $mapTool=$('.divMapTool');var wallPath,pathNum,line,arrPath,node,status,div;this.tempEvent.push('click.temp','mousemove.temp');$('#btnAddWall').off('click.tool').on('click.tool',function(e){pathNum=0;_this.toolStatus='addouterWall';$mapTool.css('display','none');status='end';arrPath=[];$containerMap.off('click.temp').on('click.temp',function(e){e.preventDefault();if(e.which!=1)return;if($(e.target).hasClass('divMapEle'))return;if(status!='end'&&status!='move')return;evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};if(_this.pathClose(arrPath,evPos)){status='end';$containerMap.css('cursor','default');arrPath[2*pathNum]='L'+arrPath[0].slice(1);arrPath[2*pathNum+1]=arrPath[1];pathAttr=arrPath.join(' ');pathNum=0;pathAttr+=' '+'Z';wallPath.setAttribute('d',pathAttr);return;}
$containerMap.css('cursor','crosshair');xStart=evPos.x;yStart=evPos.y;if(pathNum==0){pathAttr='';arrPath=[];wallPath=document.createElementNS('http://www.w3.org/2000/svg','path');wallPath.className.baseVal='pathOuterWall pathWall';div=document.createElementNS('http://www.w3.org/2000/svg','g');div.className.baseVal='divSpace';div.appendChild(wallPath);svgWall.appendChild(div);pathAttr='M'+xStart+' '+yStart;}
line='L'+xStart+' '+yStart;node=document.createElementNS('http://www.w3.org/2000/svg','circle');node.className.baseVal='wallNode';node.setAttribute('cx',evPos.x);node.setAttribute('cy',evPos.y);node.setAttribute('r',5);if(pathNum==0){node.className.baseVal+=' startWallNode';}
div.appendChild(node);pathAttr+=' '+line;arrPath=pathAttr.split(' ');wallPath.setAttribute('d',pathAttr);status='start';pathNum++;});$containerMap.off('mousemove.temp').on('mousemove.temp',function(e){e.preventDefault();if(status!='start'&&status!='move')return;evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};if(e.ctrlKey&&_this.pathClose(arrPath,evPos,true)){line='L'+arrPath[0].slice(1)+' '+arrPath[1]+' ';arrPath[2*pathNum]='L'+evPos.x;arrPath[2*pathNum+1]=evPos.y;}else{line='L'+xStart+' '+yStart;arrPath[2*pathNum]='L'+evPos.x;arrPath[2*pathNum+1]=evPos.y;}
pathAttr=arrPath.join(' ');wallPath.setAttribute('d',pathAttr);console.log(pathAttr);$containerMap.css('cursor','crosshair');status='move';});})},pathClose:function(arrPath,cur,mode){var min=30;var max=80;var judge=mode?min:max;if(arrPath.length<2)return;if(Math.abs(arrPath[0].slice(1)-cur.x)<judge&&Math.abs(arrPath[1]-cur.y)<judge){return true}
return false;},getPathSize:function(arrPath){},initAddController:function(){var strController=new StringBuilder();strController.append('<div class="divController divMapEle glyphicon glyphicon-cog" data-sensor="" data-type="controller" data-relate="sensor"></div>');var $containerMap=$('#containerMap');var $mapTool=$('.divMapTool');var evPos,$divController;this.tempEvent.push('click.temp');$('#btnAddController').on('click.tool',function(e){_this.toolStatus='addController';$mapTool.css('display','none');$containerMap.off('click.temp').on('click.temp',function(e){if(_this.eventStatus=='moveSpace'){_this.eventStatus='init';return;}
var id=ObjectId();evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};$divController=$(strController.toString());$containerMap.append($divController);$divController.css({left:evPos.x-$divController.width()/2,top:evPos.y-$divController.height()/2});$('.divMapEle.selected').removeClassEx('selected');$divController.addClass('selected');$divController.attr('id',id);_this.screen.curStore.controller.push({'_id':id,'arrP':[],'name':"",'pId':_this.screen.curStore.room['_id']?_this.screen.curStore.room['_id']:'','path':"",'prefix':"",'projId':_this.screen.curStore.room['projId'],'type':"ControllerFCU",'params':{'gatewayId':'','type':0,'gps':[evPos.x,evPos.y],'mac':'','address':''},baseType:'things'})})})},initAddSensor:function(){var strSensor=new StringBuilder();strSensor.append('<div class="divSensor divMapEle glyphicon glyphicon-eye-open" data-space="" data-controller="" data-type="sensor" data-relate="space controller"></div>');var $containerMap=$('#containerMap');var $mapTool=$('.divMapTool');var evPos,$divSensor;this.tempEvent.push('click.temp');$('#btnAddSensor').off('click.tool').on('click.tool',function(e){_this.toolStatus='addSensor';$mapTool.css('display','none');$containerMap.off('click.temp').on('click.temp',function(e){if(_this.eventStatus=='moveSpace'){_this.eventStatus='init';return;}
var id=ObjectId();evPos={x:e.pageX-_this.mapOffset.left,y:e.pageY-_this.mapOffset.top};$divSensor=$(strSensor.toString());$containerMap.append($divSensor);$divSensor.css({left:evPos.x-$divSensor.width()/2,top:evPos.y-$divSensor.height()/2});$('.divMapEle.selected').removeClassEx('selected');$divSensor.addClass('selected');$divSensor.attr('id',id);var spaceRelate;if($(e.target)[0].tagName=='path'&&$(e.target).hasClassEx('pathSpace')){$divSensor[0].dataset.space=$(e.target).parent().attr('id');var dataSensor=$(e.target).parent()[0].getAttribute('data-sensor');if(dataSensor==null)dataSensor='';$(e.target).parent()[0].setAttribute('data-sensor',dataSensor+=' '+id);_this.screen.curStore.sensor.push({'_id':id,'arrP':[],'name':"",'pId':[$(e.target).parent().attr('id')],'path':"",'prefix':"",'projId':_this.screen.curStore.room['projId'],'type':"SensorTemp",'params':{'gatewayId':'','endpoint':0,'cId':'','gps':[evPos.x,evPos.y],'mac':'','address':''},baseType:'things'})}else{_this.screen.curStore.sensor.push({'_id':id,'arrP':[],'name':"",'pId':[_this.screen.curStore.room['_id']],'path':"",'prefix':"",'projId':_this.screen.curStore.room['projId'],'type':"SensorTemp",'params':{'gatewayId':'','endpoint':0,'cId':'','gps':[evPos.x,evPos.y],'mac':'','address':''},baseType:'things'})}})})},initDelete:function(){$(document).off('keyup.general').on('keyup.general',function(e){if(e.keyCode!=46||e.target.tagName!='BODY')return;var $target=$('.divMapEle.selected');var del;if($target.length==0)return;if($target.hasClassEx('divSpace')){$target[0].dataset={type:'space',relate:'space',sensor:$target[0].getAttribute('data-sensor')}}
for(var i=0;i<_this.screen.curStore[$target[0].dataset.type].length;i++){if($target[0].id==_this.screen.curStore[$target[0].dataset.type][i]['_id']){del=_this.screen.curStore[$target[0].dataset.type].splice(i,1)[0];if($target[0].dataset.type=='space'){_this.delete[0].id.push(del['_id']);}else{_this.delete[1].id.push(del['_id']);_this.delRelateLine($target[0].dataset.type,del['_id'])}
break;}}
_this.delRelateSensor($target);$target.remove();});},showDeviceModal:function($tar){var $modal=$('#modalConfigDeviceInfo');var $modalContent=$('#divConfigDeviceInfo');var $iptName=$('#iptDeviceName');var $iptPrefix=$('#iptDevicePrefix');var $target;if($tar.hasClassEx('pathSpace')){$target=$tar.parent()}else{$target=$tar}
var id=$target[0].id;if($target.hasClassEx('divSpace')){for(var i=0;i<_this.screen.curStore.space.length;i++){if(_this.screen.curStore.space[i]['_id']==id){$iptName.val(_this.screen.curStore.space[i].name);$iptPrefix.val(_this.screen.curStore.space[i].prefix);$modal.modal('show');_this.saveDeviceModal(_this.screen.curStore.space[i]);break;}}}else if($target.hasClassEx('divSensor')){for(var i=0;i<_this.screen.curStore.sensor.length;i++){if(_this.screen.curStore.sensor[i]['_id']==id){$iptName.val(_this.screen.curStore.sensor[i].name);$iptPrefix.val(_this.screen.curStore.sensor[i].prefix);_this.showDevicePt('SensorTemp',_this.screen.curStore.sensor[i]);_this.saveDeviceModal(_this.screen.curStore.sensor[i]);$modal.modal('show');break;}}}else if($target.hasClassEx('divController')){for(var i=0;i<_this.screen.curStore.controller.length;i++){if(_this.screen.curStore.controller[i]['_id']==id){$iptName.val(_this.screen.curStore.controller[i].name);$iptPrefix.val(_this.screen.curStore.controller[i].prefix);_this.showDevicePt('ControllerFCU',_this.screen.curStore.controller[i]);$modal.modal('show');_this.saveDeviceModal(_this.screen.curStore.controller[i]);break;}}}},showDevicePt:function(device,tarData){var _this=this;var $iptGrpDevicePt=$('#iptGrpDevicePt').html('');var divPt,iptPt,ipPtLabel;var attr=_this.screen.roomTree.dictClass.things[device].attrs;for(var ele in attr){divPt=document.createElement('div');divPt.className='checkBox';divPt.dataset.attr=ele;ipPtLabel=document.createElement('label');ipPtLabel.textContent=attr[ele].name;iptPt=document.createElement('input');iptPt.setAttribute('type','checkbox');iptPt.className='iptAttrCheck';if(tarData.arrP[ele]){iptPt.checked=true;}else{iptPt.checked=false;}
iptPt.dataset.attr=ele;divPt.appendChild(ipPtLabel);divPt.appendChild(iptPt);$iptGrpDevicePt.append(divPt);}},saveDeviceModal:function(data){var $modal=$('#modalConfigDeviceInfo');var $iptName=$('#iptDeviceName');var $iptPrefix=$('#iptDevicePrefix');$('#btnDeviceInfoConfirm').off('click').on('click',function(){var $iptPtCheck=$('#iptGrpDevicePt input:checked');var $iptPt=$('#iptGrpDevicePt input');for(var i=0;i<$iptPt.length;i++){data.arrP[$iptPt[i].dataset.attr]=null;}
data.name=$iptName.val();data.prefix=$iptPrefix.val();if($iptPtCheck.length>0&&data.prefix!=''){data.arrP={};WebAPI.get("/point_tool/searchCloudPoint/"+_this.screen.curStore.room.projId+"/"+data.prefix+"/").done(function(result){var rs=result.data["pointTable"];for(var i=0;i<$iptPtCheck.length;i++){for(var j=0;j<rs.length;j++){if(data.prefix+$iptPtCheck[i].dataset.attr===rs[j]["value"]){data.arrP[$iptPtCheck[i].dataset.attr]=rs[j]["_id"];}}}});}
$modal.modal('hide');});},initRelate:function(){var $containerMap=$('#containerMap');var arrSpaceId,arrSensorId,arrCtrId,relate;var isRelate=false;var $divMapEle;var $main;this.tempEvent.push('click.temp');$('#btnRelate').on('click.tool',function(e){isRelate=false;$containerMap.off('click.temp').on('click.temp',function(e){$divMapEle=$('.divMapEle');var $target=$(e.target);if($target[0].tagName=='path'&&$target.hasClassEx('pathSpace')){$target=$target.parent();$target[0].dataset={type:'space',relate:'sensor',sensor:$target[0].getAttribute('data-sensor')}}
if($target.hasClassEx('main')){$divMapEle.removeClassEx('relate');$target.removeClassEx('main');isRelate=false;}else if($target.hasClassEx('relate')){_this.setRelateData($target,'del');$target.removeClassEx('relate');}else if(!isRelate){if($target.hasClassEx('divSensor')){arrSpaceId=_this.searchDevice('sensor',$target[0].id).pId;for(var i=0;i<arrSpaceId.length;i++){relate=document.getElementById(arrSpaceId[i]);if(relate)$(relate).addClassEx('relate');}
arrCtrId=_this.searchDevice('sensor',$target[0].id).params.cId;relate=document.getElementById(arrCtrId);if(relate)$(relate).addClassEx('relate');$target.addClassEx('main');isRelate=true;}else if($target.hasClassEx('divController')){arrSensorId=$target[0].dataset.sensor;relate=document.getElementById(arrSensorId);if(relate)$(relate).addClassEx('relate');$target.addClass('main');isRelate=true;}else if($target.hasClassEx('divSpace')){arrSensorId=$target[0].dataset.sensor;relate=document.getElementById(arrSensorId);if(relate)$(relate).addClassEx('relate');$target.addClassEx('main');isRelate=true;}}else{$main=$('.main');if($main.hasClassEx('divSpace')){$main[0].dataset={type:'space',relate:'sensor',sensor:$main[0].getAttribute('data-sensor')}}
if($target.hasClassEx('divSpace')){$target[0].dataset={type:'space',relate:'sensor',sensor:$target[0].getAttribute('data-sensor')}}
if($main[0].dataset.type!=$target[0].dataset.type){if($main[0].dataset.relate.indexOf($target[0].dataset.type)>-1){if($main[0].dataset.type!='controller'){if($target[0].dataset.type=='controller'){$('.divController.relate').removeClassEx('relate');}else{$('.divSpace.relate').removeClassEx('relate');}}
_this.setRelateData($target,'add');$target.addClassEx('relate');}}}})})},setRelateData:function($target,mode){var $main=$('.main');var sensorData,ctrData;if($main.hasClassEx('divSpace')){$main[0].dataset={type:'space',relate:'sensor',sensor:$main[0].getAttribute('data-sensor')}}
if(mode=='add'){$main[0].dataset[$target[0].dataset.type].replace($target[0].id,'');$target[0].dataset[$main[0].dataset.type].replace($main[0].id,'');if($main[0].dataset.type=='sensor'){if($target[0].dataset.type=='space'){_this.searchDevice('sensor',$main[0].id).pId=[$target[0].id];}else{sensorData=_this.searchDevice('sensor',$main[0].id);sensorData.params.cId=$target[0].id;ctrData=_this.searchDevice('controller',$target[0].id);_this.addRelateLine(sensorData,ctrData);}}else if($main[0].dataset.type=='space'){_this.searchDevice('sensor',$target[0].id).pId=[$main[0].id];}else if($main[0].dataset.type=='controller'){sensorData=_this.searchDevice('sensor',$target[0].id);sensorData.params.cId=$main[0].id;ctrData=_this.searchDevice('controller',$main[0].id);_this.addRelateLine(sensorData,ctrData);}}else{$main[0].dataset[$target[0].dataset.type]+=' '+$target[0].id;$target[0].dataset[$main[0].dataset.type]+=' '+$main[0].id;if($main[0].dataset.type=='sensor'){if($target[0].dataset.type=='space'){_this.searchDevice('sensor',$main[0].id).pId=[];}else{sensorData=_this.searchDevice('sensor',$main[0].id);sensorData.params.cId='';ctrData=_this.searchDevice('controller',$target[0].id);_this.delRelateLine('sensor',$main[0].id);}}else if($main[0].dataset.type=='space'){_this.searchDevice('sensor',$target[0].id).pId=[];}else if($main[0].dataset.type=='controller'){sensorData=_this.searchDevice('sensor',$target[0].id);sensorData.params.cId='';ctrData=_this.searchDevice('controller',$main[0].id);_this.delRelateLine('sensor',$target[0].id);}}},searchDevice:function(type,id){for(var i=0;i<_this.screen.curStore[type].length;i++){if(_this.screen.curStore[type][i]['_id']==id){return _this.screen.curStore[type][i];}}
return;},initSaveDetail:function(){$('#btnDetailSave').off('click').on('click',function(){var postData=_this.screen.curStore;var ajaxNum=0;postData.space.forEach(function(val){val.baseType='groups'});var postGroup=[postData.room].concat(postData.space);WebAPI.post('/iot/setIotInfo',postGroup).done(function(result){console.log(result.status);ajaxNum++;if(ajaxNum==2){alert('保存成功');WebAPI.get('/appTemperature/room/update/'+_this.curStore.room['_id'])}});postData.sensor.forEach(function(val){val.baseType='things'});postData.controller.forEach(function(val){val.baseType='things'});var postThing=postData.sensor.concat(postData.controller);WebAPI.post('/iot/setIotInfo',postThing).done(function(result){console.log(result.status);ajaxNum++;if(ajaxNum==2){alert('保存成功');WebAPI.get('/appTemperature/room/update/'+_this.curStore.room['_id'])}});if(_this.delete[0].id.length>0||_this.delete[1].id.length>0){WebAPI.post('/iot/delIotInfo',{itemList:_this.delete}).done(function(result){console.log(result.status);_this.delete[0].id=[];_this.delete[1].id=[];});}});},setRelateLine:function(type,id,x,y){var relateLine=$('.relateLine[data-'+type+'="'+id+'"]');if(type=='sensor'){relateLine.attr({'x1':x,'y1':y})}else{relateLine.attr({'x2':x,'y2':y})}},addRelateLine:function(sensor,ctr){var ctnSvg=document.getElementById('ctnSvg');var relateLine;relateLine=document.createElementNS('http://www.w3.org/2000/svg','line');relateLine.className.baseVal='relateLine';relateLine.setAttribute('x1',sensor.params.gps[0]);relateLine.setAttribute('y1',sensor.params.gps[1]);relateLine.setAttribute('x2',ctr.params.gps[0]);relateLine.setAttribute('y2',ctr.params.gps[1]);relateLine.setAttribute('data-sensor',sensor['_id']);relateLine.setAttribute('data-controller',ctr['_id']);ctnSvg.appendChild(relateLine);},delRelateLine:function(type,id){var relateLine=$('.relateLine[data-'+type+'="'+id+'"]');relateLine.remove();},delRelateSensor:function($target){if($target[0].dataset.type=='space'){for(var i=0;i<_this.curStore.sensor.length;i++){if(_this.curStore.sensor[i].pId[0]==$target[0].id){_this.curStore.sensor[i].pId[0]=_this.curStore.room['_id'];break;}}}else if($target[0].dataset.type=='controller'){for(var i=0;i<_this.curStore.sensor.length;i++){if(_this.curStore.sensor[i].params.cId==$target[0].id){_this.curStore.sensor[i].params.cId='';}}}},initUserRole:function(){var modalContent=document.getElementById('divUserRoleInfo');var $modal=$('#modalUserRoleInfo');$('#btnUserRole').off('click.tool').on('click.tool',function(e){modalContent.innerHTML='';if(_this.curStore&&_this.curStore.room){WebAPI.get('/appTemperature/room/getUserList/'+_this.curStore.room['_id']).done(function(result){var list=result.list;if(list.length==0)return;var user,name,photo,select,del;for(var i=0;i<list.length;i++){user=document.createElement('div');user.className='divUserRole';user.dataset.userId=list[i].userId;photo=document.createElement('img');photo.className='imgPhoto';photo.src='http://images.rnbtech.com.hk'+list[i].img;name=document.createElement('label');name.className='spUserName';name.textContent=list[i].name;if(list[i].grade=='30'){select=document.createElement('span');select.className='selUserRole';select.innerHTML='创建者';select.value=list[i].grade;}else{select=document.createElement('select');select.className='selUserRole';select.innerHTML='<option value="0">游客</option>\
                                    <option value="10">管理员</option>\
                                    <option value="20">物业</option>';select.value=list[i].grade;}
del=document.createElement('span');del.className='btnUserRemove glyphicon glyphicon-remove';user.appendChild(photo);user.appendChild(name);user.appendChild(select);user.appendChild(del);modalContent.appendChild(user);}
$modal.modal('show');});$(modalContent).off('click').on('click','.btnUserRemove',function(e){var roomId=_this.curStore.room['_id'];var userId=$(e.currentTarget).parent()[0].dataset.userId;Spinner.spin(ElScreenContainer);WebAPI.get('/appTemperature/room/removeUser/'+userId+'/'+roomId).done(function(){$(e.currentTarget).parent().remove();alert('用户关系删除成功！')}).always(function(){Spinner.stop();})});$(modalContent).off('change').on('change','.selUserRole',function(e){var postData={roomId:_this.curStore.room['_id'],userId:$(e.currentTarget).parent()[0].dataset.userId,grade:$(e.currentTarget).val()};Spinner.spin(ElScreenContainer);WebAPI.post('/appTemperature/room/setUserGrade',postData).done(function(){alert('用户权限更改成功！')}).always(function(){Spinner.stop();})})}else{alert('请选择房间！')}});},initJqSvg:function(){String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,'');};$.fn.extend({hasClassEx:function(arg){if(this[0]instanceof SVGElement){return this[0].getAttribute('class').indexOf(arg)>-1}else{return this.hasClass(arg)}},addClassEx:function(arg){if(this[0]instanceof SVGElement){var className;for(var i=0;i<this.length;i++){className=this[i].getAttribute('class');if(className.indexOf(arg)>-1)continue;if(className.length==0){this[i].setAttribute('class',arg)}else{this[i].setAttribute('class',className+' '+arg)}}
return this;}else{return this.addClass(arg)}},removeClassEx:function(arg){if(this[0]instanceof SVGElement){var className;for(var i=0;i<this.length;i++){className=this[i].getAttribute('class');this[i].setAttribute('class',className.replace(arg,'').trim());}
return this;}else{return this.removeClass(arg)}}})},offsetAdjust:function(target,x,y){}};return ConfigTool;})();