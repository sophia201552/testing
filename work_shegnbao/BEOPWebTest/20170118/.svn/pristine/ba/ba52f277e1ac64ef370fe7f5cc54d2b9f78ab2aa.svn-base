var ScreenManager=(function(){function ScreenManager(){}
ScreenManager.screenFlag='page';ScreenManager.root='#page=IndexScreen';ScreenManager.paneRoot="#page=PaneProjectSelector";ScreenManager.isListening=false;ScreenManager.setProjectSelector=function(ProjectSelector){if(typeof ProjectSelector==='function'){ScreenManager.projectSelector=new ProjectSelector();}};ScreenManager.Init=function(){I18n.fillArea($(".navbar"));};ScreenManager.show=function(){if(arguments.length===0){return;}
var screenClass=arguments[0];if(typeof screenClass!=='function'){return;}
if(ScreenManager.isListening){ScreenManager.applyGoTo.apply(null,arguments);}else{ScreenManager.applyScreen.apply(null,arguments);}};ScreenManager.applyGoTo=function(){var screenClass=arguments[0];if(!screenClass.name){alert(I18n.resource.common.NOT_FOUND_PAGE);return false;}
var paramObj={page:screenClass.name},paramList=ScreenManager._getFunctionParams(screenClass);for(var m=0,n=paramList.length;m<n;m++){if(typeof arguments[m+1]!=typeof undefined){paramObj[paramList[m]]=arguments[m+1];}}
ScreenManager.goTo(paramObj);};ScreenManager.applyScreen=function(){var screenClass=arguments[0];if(!screenClass){alert('Can\'t find the page.');return;}
if(ScreenCurrent){window.onresize=null;try{if(ScreenCurrent.close&&ScreenCurrent.close()===false){return;}}catch(e){console.warn(ScreenCurrent.constructor.name+' close 方法报错:'+e);}}
var screenObj=Object.create(screenClass.prototype);ScreenCurrent=(screenClass.apply(screenObj,Array.prototype.slice.call(arguments,1))||screenObj);if(ScreenCurrent.onresize)window.onresize=ScreenCurrent.onresize;ScreenCurrent.show();};ScreenManager._getFunctionParams=function(func){var STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg,ARGUMENT_NAMES=/([^\s,]+)/g,fnStr,result;fnStr=func.toString().replace(STRIP_COMMENTS,'');result=fnStr.slice(fnStr.indexOf('(')+1,fnStr.indexOf(')')).match(ARGUMENT_NAMES);if(result===null){result=[];}
return result;};ScreenManager._getHashParamsMap=function(){var list,map={};list=location.hash.substr(1).split('&');for(var m=0;m<list.length;m++){var item=list[m].split('=');map[item[0]]=_unserializeParams(item[1]);}
return map;};ScreenManager.getPageId=function(){var hashMap=ScreenManager._getHashParamsMap();var params;if(typeof hashMap.id!==typeof undefined){return hashMap.id;}
if(hashMap.reportId){return hashMap.reportId;}
if(typeof hashMap.options==='string'){params={};try{params=JSON.parse(window.decodeURIComponent(hashMap.options));}catch(e){}
return params.id;}
if(typeof hashMap.options==='object'&&hashMap.options){return hashMap.options.id;}};ScreenManager.loadProjectMenu=function(project,page_id){ScreenManager.projectSelector.initProject(project['id'],page_id);};ScreenManager.loadUserPanel=function(){$("#right-nav").show();};ScreenManager.screenChange=function(e){var paramsMap=ScreenManager._getHashParamsMap(),project;if(typeof paramsMap.projectId!==typeof undefined){AppConfig.projectId=parseInt(paramsMap.projectId);project=BEOPUtil.getProjectFromAppConfig(AppConfig.projectId);if(!project){alert.danger(I18n.resource.error.noPermission);return false;}
AppConfig.projectTimeFormat=project.time_format||0;}
var promise=$.Deferred();if(I18n&&I18n.resource){promise.resolve();}else{InitI18nResource().always(function(rs){I18n=new Internationalization(null,rs);promise.resolve();});}
promise.always(function(){var screen,currentPage,screenParamsNameList=[],screenParamsValueList=[];if(AppConfig.afterLogin){$('#navHeader').fadeIn();$('#indexMain').css({top:'53px'});}
if(project){AppConfig.projectEnName=project['name_en'];AppConfig.projectName=project['name_en'];if(location.hash!=ScreenManager.paneRoot&&!AppConfig.navItems){ScreenManager.loadProjectMenu(project,paramsMap.id);}else{ScreenManager.projectSelector.setMenuActive();}}
ScreenManager.loadUserPanel();currentPage=paramsMap[ScreenManager.screenFlag];if(currentPage){if(currentPage.indexOf('.')>0){screen=namespace(currentPage)}else{if(currentPage==='EnergyScreen_M'){currentPage='EnergyScreen';}
screen=window[currentPage]||namespace('observer.screens')[currentPage];}}else{console.error('无法识别的location hash! hash is '+location.hash);return true;}
if(screen&&typeof screen==='function'){screenParamsNameList=ScreenManager._getFunctionParams(screen);for(var m=0;m<screenParamsNameList.length;m++){var paramName=screenParamsNameList[m];if(typeof paramsMap[paramName]!=='undefined'){screenParamsValueList[m]=paramsMap[paramName];}else{screenParamsValueList[m]=undefined;}}
ScreenManager.applyScreen.apply(null,[screen].concat(screenParamsValueList));I18n.fillArea($('#navPane'));return false;}else{return true;}});};ScreenManager.goTo=function(pageInfo){var hashFlag='#',hashList=[];if(!pageInfo){return false;}
if(AppConfig.projectId){pageInfo['projectId']=AppConfig.projectId;}
if(pageInfo[ScreenManager.screenFlag]){hashList.push(ScreenManager.screenFlag+'='+pageInfo[ScreenManager.screenFlag]);}
for(var param in pageInfo){if(pageInfo.hasOwnProperty(param)){if(param!==ScreenManager.screenFlag){hashList.push(param+'='+_serializeParams(pageInfo[param]));}}}
if(location.hash===hashFlag+hashList.join('&')){Spinner&&Spinner.stop();}else{location.hash=hashFlag+hashList.join('&');}};ScreenManager.listen=function(){if("onhashchange"in window&&(!document.documentMode||document.documentMode>=8)){ScreenManager.isListening=true;window.onhashchange=ScreenManager.screenChange;ScreenManager.detectAnchorHash();if(location.hash===''){if(AppConfig.afterLogin){window.addEventListener('load',function(){location.hash=ScreenManager.paneRoot;ScreenManager.projectSelector.show();},false);}else{location.hash=ScreenManager.root;}}else{if(location.hash==ScreenManager.root){if(AppConfig.afterLogin){location.hash=ScreenManager.paneRoot;}else{ScreenManager.screenChange();}}
if(AppConfig.afterLogin){window.addEventListener('load',function(){ScreenManager.screenChange();ScreenManager.projectSelector.init();},false)}else{location.hash=ScreenManager.root;}}}else{console.error('This browser can\'t support onhashchange event.')}};ScreenManager.detectAnchorHash=function(){var isValidHash=function(hash){if(typeof hash===typeof undefined||hash.startsWith('http')||hash.startsWith('https')||hash.startsWith('blob')){return true;}else if(hash==='/factory'||hash==='/point_tool/editor'){return true;}else{return hash.indexOf('=')!=-1;}};$(document).on('click.anchorHash','a',function(ev){var $this=$(this),hash=$this.attr('href'),isManagedHash=$this.attr('nothash');if(typeof isManagedHash!==typeof undefined&&isManagedHash!==false){return true;}
if(!isValidHash(hash)){ev.preventDefault();var dom=document.getElementById(hash.substr(1));if(dom){dom.scrollIntoView();}}
return true;})};if(typeof AppConfig!=typeof undefined){ScreenManager.listen();try{ScreenManager.setProjectSelector(PaneProjectSelector);}catch(e){}}
function _serializeParams(params){return window.encodeURIComponent(JSON.stringify(params));}
function _unserializeParams(params){try{params=JSON.parse(window.decodeURIComponent(params));}catch(e){}
return params;}
return ScreenManager;})();﻿
var beop=beop||{};beop.constant={project_img_path:'/static/images/project_img/',project_default_img:'default.jpg',BEOP_IMG_HOST:'http://images.rnbtech.com.hk',OSS_PROJECT_IMG_PATH:'/custom/project_img/'};var ObjectId=function(){var timestamp=new Date().valueOf();var userId=('000'+((window.AppConfig&&window.AppConfig.userId)||'000')).slice(-3);var hex8=('00000000'+Math.floor(Math.random()*0xFFFFFFFF).toString(16)).slice(-8);return timestamp+userId+hex8;};(function(exports){exports.namespace=function(path){var obj=window;path=path.split('.');path.forEach(function(p,i){p=p.trim();if(i===0&&p==='window')return;obj=obj[p]=obj[p]||{};});return obj;};}(window));(function(exports){exports.Mixin=function(){var prototype={};var methods;for(var i=0,len=arguments.length;i<len;i++){methods=arguments[i];for(var m in methods){prototype[m]=methods[m];}}
return prototype;};}(window));(function(){var ENUM_LEVEL={LOG:1,INFO:2,DEBUG:3,WARN:4,ERROR:5,EXCEPTION:6};window.Log={level:ENUM_LEVEL.WARN,log:function(){if(this.level>ENUM_LEVEL.LOG)return;Log._out('log',arguments);},info:function(){if(this.level>ENUM_LEVEL.INFO)return;Log._out('info',arguments);},debug:function(){if(this.level>ENUM_LEVEL.DEBUG)return;Log._out('debug',arguments);},warn:function(){if(this.level>ENUM_LEVEL.WARN)return;Log._out('warn',arguments);},error:function(){if(this.level>ENUM_LEVEL.ERROR)return;Log._out('error',arguments);},exception:function(message,exception){if(this.level>ENUM_LEVEL.EXCEPTION)return;if(exception){Log.error('Exception: ',message,exception.stack||exception);}else{Log.error('Exception: ',message);}},_out:function(type,args){console[type].apply(console,args)}};}());if(!Array.toMap){Array.toMap=function(arr,key){var map={};arr.forEach(function(row,i){map[row[key]]=row;});return map;};}
var FullScreenManager=(function(){var manager=Object.create({init:function(){var _this=this;$(document).off('webkitfullscreenchange');$(document).on('webkitfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('mozfullscreenchange');$(document).on('mozfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('msfullscreenchange');$(document).on('msfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});if(typeof onError==='function'){$(document).off('webkitfullscreenerror');$(document).on('webkitfullscreenerror',this.onFullScreenError);$(document).off('mozfullscreenerror');$(document).on('mozfullscreenerror',this.onFullScreenError);$(document).off('msfullscreenerror');$(document).on('msfullscreenerror',this.onFullScreenError);}},onFullScreenEnter:function(){},onFullScreenOut:function(){},onFullScreenError:function(){},toggle:function(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!document.msFullscreenElement){if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}}});manager.init();return manager;}());function StringBuilder(){this.data=Array("");}
StringBuilder.prototype.append=function(){this.data.push(arguments[0]);return this;};StringBuilder.prototype.toString=function(){return this.data.join("");};StringBuilder.prototype.getLength=function(){return this.data.length;};if(!String.prototype.format){String.prototype.format=function(){if(arguments[0]===undefined){return'';}
if(arguments[0].constructor===Array){var args=arguments[0];}else{var args=arguments;}
return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
if(!String.prototype.formatEL){String.prototype.formatEL=function(o,defaultVal){var str=this.toString();if(!str||!o)return'';for(var p in o){if(o.hasOwnProperty(p)){str=str.replace(new RegExp('{'+p+'}','g'),o[p]);}}
if(typeof defaultVal!=='undefined'){str=str.replace(/{[^{}]*?}/g,defaultVal);}
return str;};}
String.prototype.toDate=function(){var str=this;if(str.indexOf('-')>-1)
str=str.replace('-','/').replace('-','/');return new Date(str);};if(!String.prototype.startsWith){String.prototype.startsWith=function(word){return new RegExp('^'+word).test(this);}}
Number.prototype.toDate=function(){return new Date(this);};function Alert(targetElement,type,msg){this.element=targetElement;this.str=new StringBuilder();this.str.append('<div style="display:none;" class="alert beop-alert alert-').append(type).append(' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<div class="alert-msg">'+msg+'</div>').append('</div>');this.$alert=$(this.str.toString());}
Alert.danger=function(targetElement,msg){return new Alert(targetElement,Alert.type.danger,msg);};Alert.warning=function(targetElement,msg){return new Alert(targetElement,Alert.type.warning,msg);};Alert.success=function(targetElement,msg){return new Alert(targetElement,Alert.type.success,msg);};Alert.info=function(targetElement,msg){return new Alert(targetElement,Alert.type.info,msg);};Alert.closeAll=function(){$('.beop-alert').remove();};Alert.type={danger:'danger',warning:'warning',success:'success',info:'info'};Alert.prototype.show=function(duration){Alert.closeAll();if(duration){var _this=this;setTimeout(function(){_this.close();},duration);}
$(this.element).append(this.$alert);this.$alert.slideDown(500);return this;};Alert.prototype.close=function(){var _this=this;this.$alert.slideUp(500,function(){_this.$alert.remove();_this=null;});};Alert.prototype.setMessage=function(msg){if(!msg){return false}
this.$alert.find('.alert-msg').text(msg);};Alert.prototype.setStyle=function(style){if(style&&typeof style!=='string'){this.$alert.css(style);}
return this;};Alert.prototype.showAtTop=function(duration){this.setStyle({position:'absolute',top:0,left:0,right:0,margin:'auto',width:'30%',textAlign:'center',zIndex:10000});if(!duration){duration=2000;}
this.show(duration);};function showDialog(url){return WebAPI.get(url).done(function(resultHtml){$("#dialogContent").html(resultHtml);$('#dialogModal').modal({});});}
function clone(obj){if(obj==null||typeof(obj)!='object')
return obj;var temp=obj.constructor();for(var key in obj){if(obj.hasOwnProperty(key)){temp[key]=clone(obj[key]);}}
return temp;}
Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var week={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
if(/(E+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,((RegExp.$1.length>1)?(RegExp.$1.length>2?"/u661f/u671f":"/u5468"):"")+week[this.getDay()+""]);}
for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)));}}
return fmt;};Date.prototype.timeFormat=function(format,type,language,option){var date=this;if(format&&(typeof format=='string'||typeof format=='object')){if(typeof format=='object'&&(!format.separators||!format.parts)){format='yyyy-mm-dd hh:ii:ss';}}else{format='yyyy-mm-dd hh:ii:ss';}
if(arguments.length>=2){var paramArr=(function(arrayish){return[].slice.call(arrayish);})(arguments);paramArr.shift();type=language=option=null;paramArr.forEach(function(it,i){if(typeof it=='string'){language=it;}else if(typeof it=='number'){type=it;}else if(typeof it=='object'){option=it;}});}
var isReturnNull=false;if(option){for(var k in option){if(k=='isReturnNull'){isReturnNull=option[k];}}}
if(date=='Invalid Date'){console.warn("Invalid date.");if(isReturnNull){return'';}else{return date.toString();}}
var DATES={en:{"days":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"daysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],"daysMin":["Su","Mo","Tu","We","Th","Fr","Sa","Su"],"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"meridiem":["am","pm"]}};language=language?(DATES[language]?language:'en'):'en';var formatObj=(function(formatStr){if(typeof formatStr=='object'){return formatStr;}
if(type){formatStr=timeFormatChange(formatStr,type);}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};})(format);var val={yy:date.getFullYear().toString().substring(2),yyyy:date.getFullYear(),m:date.getMonth()+1,M:DATES[language].monthsShort[date.getMonth()],MM:DATES[language].months[date.getMonth()],d:date.getDate(),D:DATES[language].daysShort[date.getDay()],DD:DATES[language].days[date.getDay()],p:(DATES[language].meridiem.length==2?DATES[language].meridiem[date.getHours()<12?0:1]:''),h:date.getHours(),i:date.getMinutes(),s:date.getSeconds()};if(DATES[language].meridiem.length==2){val.H=(val.h%12==0?12:val.h%12);}
else{val.H=val.h;}
val.HH=(val.H<10?'0':'')+val.H;val.P=val.p.toUpperCase();val.hh=(val.h<10?'0':'')+val.h;val.ii=(val.i<10?'0':'')+val.i;val.ss=(val.s<10?'0':'')+val.s;val.dd=(val.d<10?'0':'')+val.d;val.mm=(val.m<10?'0':'')+val.m;var finTime='';for(var i=0,len=formatObj.separators.length;i<len;i++){finTime+=formatObj.separators[i]+(formatObj.parts[i]?val[formatObj.parts[i]]:'');}
return finTime;};var DateUtil=(function(){var dateLocale={month:{en:{month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],month_names_short:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']},zh:{month_names:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],month_names_short:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']}}};function getWeekNumber(d){d=new Date(+d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7);return[d.getFullYear(),weekNo];}
function getLastWeekNumberOf(y,w){w-=1;if(w===0){y=y-1;w=52;}
return[y,w];}
function getNextWeekNumberOf(y,w){w+=1;if(w===53){y+=1;w=1;}
return[y,w];}
function isLeapYear(y){if(Object.prototype.toString.call(y)==='[object Date]'){y=y.getFullYear();}
return((y%4===0)&&(y%100!==0))||(y%400===0);}
function daysInMonth(dt){var m=dt.getMonth();if(m===1){return isLeapYear(dt)?29:28;}
return[31,28,31,30,31,30,31,31,30,31,30,31][m];}
function getFirstDayOfWeek(year,week){var d=new Date(year,0,1),offset=d.getTimezoneOffset();d.setDate(d.getDate()+4-(d.getDay()||7));d.setTime(d.getTime()+7*24*60*60*1000*(week+(year==d.getFullYear()?-1:0)));d.setTime(d.getTime()
+(d.getTimezoneOffset()-offset)*60*1000);d.setDate(d.getDate()-3);return d;}
function getDateRangeOnWeekNumber(year,week){if(!year||!week){return;}
var firstDay=getFirstDayOfWeek(year,week),lastDay=new Date(firstDay);lastDay.setDate(firstDay.getDate()+6);return[firstDay,lastDay];}
function getMonthName(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names:dateLocale.month['en'].month_names;return monthList[index];}
function getMonthNameShort(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names_short:dateLocale.month['en'].month_names_short;return monthList[index];}
function getLastMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===1){return 12;}else{return currentMonth-1;}}
function getNextMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===12){return 1;}else{return currentMonth+1;}}
function getRelativeDateInfo(date1,date2){var now=new Date();var lang=I18n.type;var value1,value2,ts,info;if(!date1&&!date2)return'';value1=(date1||now).valueOf();value2=(date2||now).valueOf();ts=Math.floor(Math.abs(value1-value2)/1000);switch(true){case ts<60:info=ts+(ts===1?' second':' seconds');break;case ts<3600:ts=Math.floor(ts/60);info=ts+(ts===1?' minute':' minutes');break;case ts<86400:ts=Math.floor(ts/(3600));info=ts+(ts===1?' hour':' hours');break;case ts<31536000:ts=Math.floor(ts/(86400));info=ts+(ts===1?' day':' days');break;default:ts=Math.floor(ts/(31536000));info=ts+(ts===1?' year':' years');break;}
info+=value1>value2?' ago':' later';if(lang==='zh'){info=info.replace(/\s(seconds?|minutes?|hours?|days?|years?)\s(ago|later)$/,function($0,$1,$2){var rs='';if($1.indexOf('second')>-1)rs+='秒';if($1.indexOf('minute')>-1)rs+='分钟';if($1.indexOf('hour')>-1)rs+='小时';if($1.indexOf('day')>-1)rs+='天';if($1.indexOf('year')>-1)rs+='年';if($2==='ago')rs+='前';if($2==='later')rs+='后';return rs;});}
return info;}
return{getWeekNumber:getWeekNumber,isLeapYear:isLeapYear,daysInMonth:daysInMonth,getLastWeekNumberOf:getLastWeekNumberOf,getNextWeekNumberOf:getNextWeekNumberOf,getDateRangeOnWeekNumber:getDateRangeOnWeekNumber,getFirstDayOfWeek:getFirstDayOfWeek,getMonthName:getMonthName,getMonthNameShort:getMonthNameShort,getLastMonth:getLastMonth,getNextMonth:getNextMonth,getRelativeDateInfo:getRelativeDateInfo,DATA_FORMAT:{FULL_DATETIME:'yyyy-mm-dd hh:ii:ss',FULL_DATETIME_CHANGE:'yyyy-MM-dd HH:mm:ss',FULL_DATETIME_ALL_SEC_CHANGE:'yyyy-MM-dd 00:00:00',FULL_DATETIME_ZERO_SEC_CHANGE:'yyyy-MM-dd HH:mm:00',FULL_DATETIME_NO_SEC_CHANGE:'yyyy-MM-dd HH:mm',FULL_DATETIME_ZERO_SEC:'yyyy-mm-dd hh:ii:00',FULL_DATETIME_HH_00_00:'yyyy-mm-dd hh:00:00',FULL_DATETIME_00_00_00:'yyyy-mm-dd 00:00:00',FULL_DATETIME_NO_SEC:'yyyy-mm-dd hh:ii',FULL_DATETIME_HH_00:'yyyy-mm-dd hh:00',FULL_DATETIME_00_00:'yyyy-mm-dd 00:00',FULL_DATE:'yyyy-mm-dd',TIME:'hh:ii:ss',TIME_HOUR_MINUTE:'hh:ii',TIME_ZERO_SEC:'hh:ii:00'}}})();var StringUtil=(function(){var HTML_ENTITIES={'&':'&amp;','>':'&gt;','<':'&lt;','"':'&quot;',"'":'&#39;','`':'&#x60;'},HTML_ENTITIES_INVERT=invert(HTML_ENTITIES);function invert(obj){var result={},keys=Object.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i];}
return result;}
function padLeft(oldStr,padNum,padStr){if(!padStr){return oldStr;}
return new Array(padNum-String(oldStr).length+1).join(padStr)+oldStr;}
function htmlEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES[character];});}
function htmlUnEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES_INVERT).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES_INVERT[character];});}
var getI18nProjectName=function(project){if(!I18n||!project){return'';}
var result='';switch(I18n.type){case'en':{result=project.name_english;break;}
case'zh':{result=project.name_cn;break;}
default:{result=project.name_english;}}
return result||'';};return{padLeft:padLeft,htmlEscape:htmlEscape,htmlUnEscape:htmlUnEscape,getI18nProjectName:getI18nProjectName}})();var BEOPUtil=(function(){var jsType={function:typeof $.noop,number:typeof 0,string:typeof'',undefined:typeof undefined};var projectImgPath=beop.constant.project_img_path;var setRelativePosition=function($obj,$target,topOffset,leftOffset){$target.css({"left":$obj.offset().left+$obj.width()+(leftOffset||5),"top":$obj.offset().top+(topOffset||10)});};var projectDefaultImgPath=projectImgPath+beop.constant.project_default_img;var getProjectImgPath=function(project){if(project){return project.pic?projectImgPath+project.pic:projectDefaultImgPath;}};var getProjectFromAppConfig=function(projectId){for(var m=0,len=AppConfig.projectList.length;m<len;m++){if(AppConfig.projectList[m].id==projectId){return AppConfig.projectList[m];}}};function getFunctionName(func){if(!func||typeof func!=jsType.function){return'';}
var ret=func.toString();ret=ret.substr('function '.length);ret=ret.substr(0,ret.indexOf('('));return ret;}
function isUndefined(obj){return typeof obj===jsType.undefined;}
function getCookie(name){var value="; "+document.cookie;var parts=value.split("; "+name+"=");if(parts.length==2)return parts.pop().split(";").shift();}
function logicContentHandle(content){if(content){content=content.replace(/\t/g,'    ')}
return content;}
function copyToClipboard(text,valueContainer){var valueContainer=valueContainer?valueContainer:document.body;if(window.clipboardData&&window.clipboardData.setData){return clipboardData.setData("Text",text);}else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var textarea=document.createElement("textarea");textarea.textContent=text;textarea.style.position="fixed";valueContainer.appendChild(textarea);textarea.select();try{return document.execCommand("copy");}catch(ex){console.warn("Copy to clipboard failed.",ex);return false;}finally{valueContainer.removeChild(textarea);}}}
var projectImgType={logo:'logo.png',pdfCover:'pdf_cover.jpg'};function getProjectImgByType(projectId,name,extension){var img='';if(projectId){img+=projectId+'_';}
img+=name;if(extension){img+='.'+extension;}
return beop.constant.BEOP_IMG_HOST+beop.constant.OSS_PROJECT_IMG_PATH+img;}
function getProjectById(id){if(!id||!AppConfig.projectList){return null;}
for(var i=0;i<AppConfig.projectList.length;i++){var project=AppConfig.projectList[i];if(project.id==id){return project;}}
return null;}
return{setRelativePosition:setRelativePosition,getProjectImgPath:getProjectImgPath,getFunctionName:getFunctionName,isUndefined:isUndefined,getCookie:getCookie,getProjectFromAppConfig:getProjectFromAppConfig,logicContentHandle:logicContentHandle,copyToClipboard:copyToClipboard,getProjectImgByType:getProjectImgByType,getProjectById:getProjectById,projectImgType:projectImgType}})();(function(){var beop_tmpl_cache={};this.beopTmpl=function tmpl(str,data,htmlStr){var fn=!/\W/.test(str)?beop_tmpl_cache[str]=beop_tmpl_cache[str]||tmpl(htmlStr?htmlStr:document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split(/<!/).join("\t").replace(/((^|!>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)!>/g,"',$1,'").split("\t").join("');").split(/!>/).join("p.push('").split("\r").join("\\'")
+"');}return p.join('');");return data?fn(data):fn;};})();var SidebarMenuEffect=(function(){function SidebarMenuEffect(){}
SidebarMenuEffect.prototype.init=function(center,left,right){var _this=this;this.$paneCt=$(center);this.$leftBtn=$(center).find('#leftCt');this.$rightBtn=$(center).find('#rightCt');var container=document.getElementById('st-container'),buttons=Array.prototype.slice.call(document.querySelectorAll('.sideTrans')),refresh=function(){var leftCol=0,rightCol=0,centerCol=0;var leftArrow='<span class="glyphicon glyphicon-chevron-left"></span>';var rightArrow='<span class="glyphicon glyphicon-chevron-right"></span>';if(_this.$leftBtn.length>0){if(container.className.indexOf('st-effect-7')>0){var prev=_this.$paneCt.prev('div')[0];if(prev&&prev.className.indexOf('col-')>-1){leftCol=parseInt(prev.classList[0].split('-')[2]);}else{leftCol=0;}
_this.$leftBtn.removeClass('leftCtClose').addClass('leftCtOpen').html(leftArrow);}else{leftCol=0;_this.$leftBtn.removeClass('leftCtOpen').addClass('leftCtClose').html(rightArrow);}}
if(_this.$rightBtn.length>0){if(container.className.indexOf('st-effect-1')>0){var next=_this.$paneCt.next('div')[0];if(next&&next.className.indexOf('col-')>-1){rightCol=parseInt(next.classList[0].split('-')[2]);}else{rightCol=0;}
_this.$rightBtn.removeClass('rightCtClose').addClass('rightCtOpen').html(rightArrow);}else{rightCol=0;_this.$rightBtn.removeClass('rightCtOpen').addClass('rightCtClose').html(leftArrow);}}
centerCol=12-leftCol-rightCol;_this.$paneCt.removeClass().addClass('col-sm-'+centerCol+' st-content');};buttons.forEach(function(el,i){var effect=el.getAttribute('data-effect');el.addEventListener('click',function(ev){var target=ev.target.getAttribute('data-effect')!=null?ev.target.getAttribute('data-effect'):ev.target.parentNode.getAttribute('data-effect');var stCtClass=document.getElementById('st-container').className;if(stCtClass.indexOf(target)<0){ev.stopPropagation();ev.preventDefault();container.classList.add(effect);setTimeout(function(){if($(container.children[0]).children('div').length==3){container.classList.add('st-menu-open');}
refresh();},250);}else{container.classList.remove(target);refresh();}});});};return SidebarMenuEffect;})();(function(window){{var unknown='-';var screenSize='';if(screen.width){var width=(screen.width)?screen.width:'';var height=(screen.height)?screen.height:'';screenSize+=''+width+" x "+height;}
var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var browser=navigator.appName;var version=''+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if((verOffset=nAgt.indexOf('Opera'))!=-1){browser='Opera';version=nAgt.substring(verOffset+6);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('MSIE'))!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(verOffset+5);}
else if((verOffset=nAgt.indexOf('Chrome'))!=-1){browser='Chrome';version=nAgt.substring(verOffset+7);}
else if((verOffset=nAgt.indexOf('Safari'))!=-1){browser='Safari';version=nAgt.substring(verOffset+7);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('Firefox'))!=-1){browser='Firefox';version=nAgt.substring(verOffset+8);}
else if(nAgt.indexOf('Trident/')!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(nAgt.indexOf('rv:')+3);}
else if((nameOffset=nAgt.lastIndexOf(' ')+1)<(verOffset=nAgt.lastIndexOf('/'))){browser=nAgt.substring(nameOffset,verOffset);version=nAgt.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName;}}
if((ix=version.indexOf(';'))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(' '))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(')'))!=-1)version=version.substring(0,ix);majorVersion=parseInt(''+version,10);if(isNaN(majorVersion)){version=''+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10);}
var mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);var cookieEnabled=(navigator.cookieEnabled)?true:false;if(typeof navigator.cookieEnabled=='undefined'&&!cookieEnabled){document.cookie='testcookie';cookieEnabled=(document.cookie.indexOf('testcookie')!=-1)?true:false;}
var os=unknown;var clientStrings=[{s:'Windows 3.11',r:/Win16/},{s:'Windows 95',r:/(Windows 95|Win95|Windows_95)/},{s:'Windows ME',r:/(Win 9x 4.90|Windows ME)/},{s:'Windows 98',r:/(Windows 98|Win98)/},{s:'Windows CE',r:/Windows CE/},{s:'Windows 2000',r:/(Windows NT 5.0|Windows 2000)/},{s:'Windows XP',r:/(Windows NT 5.1|Windows XP)/},{s:'Windows Server 2003',r:/Windows NT 5.2/},{s:'Windows Vista',r:/Windows NT 6.0/},{s:'Windows 7',r:/(Windows 7|Windows NT 6.1)/},{s:'Windows 8.1',r:/(Windows 8.1|Windows NT 6.3)/},{s:'Windows 8',r:/(Windows 8|Windows NT 6.2)/},{s:'Windows NT 4.0',r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:'Windows ME',r:/Windows ME/},{s:'Android',r:/Android/},{s:'Open BSD',r:/OpenBSD/},{s:'Sun OS',r:/SunOS/},{s:'Linux',r:/(Linux|X11)/},{s:'iOS',r:/(iPhone|iPad|iPod)/},{s:'Mac OS X',r:/Mac OS X/},{s:'Mac OS',r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:'QNX',r:/QNX/},{s:'UNIX',r:/UNIX/},{s:'BeOS',r:/BeOS/},{s:'OS/2',r:/OS\/2/},{s:'Search Bot',r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var id in clientStrings){var cs=clientStrings[id];if(cs.r.test(nAgt)){os=cs.s;break;}}
var osVersion=unknown;if(/Windows/.test(os)){osVersion=/Windows (.*)/.exec(os)[1];os='Windows';}
switch(os){case'Mac OS X':osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];break;case'Android':osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1];break;case'iOS':osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);osVersion=osVersion[1]+'.'+osVersion[2]+'.'+(osVersion[3]|0);break;}}
window.jscd={screen:screenSize,browser:browser,browserVersion:version,mobile:mobile,os:os,osVersion:osVersion,cookies:cookieEnabled};}(this));var getUrlParams=function(){var search=window.location.search.substring(1);var kvArr=search.split('&');var rs={};kvArr.forEach(function(kv){var arr=kv.split('=');if(typeof arr[1]!=='undefined'){rs[arr[0]]=arr[1];}});return rs;};$.fn.serializeObject=function(){var obj={};this.serializeArray().map(function(item){if(/\[\]$/.test(item.name)){if(obj[item.name]){obj[item.name].push(item.value);}else{obj[item.name]=[item.value];}}else{obj[item.name]=item.value;}});return obj;};function kIntSeparate(num,n){var number=num.toFixed(n?n:0);var source=String(number).split(".");source[0]=source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)','ig'),"$1,");return source.join(".");}
function timeFormatChange(format,type){var lastStr='';var formatObj=(function(formatStr){if(!formatStr||typeof formatStr=='object'){return;}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){return;}
return{separators:separators,parts:parts};})(format);if(formatObj){format='';for(var i=0,len=formatObj.separators.length-1;i<len;i++){format+=formatObj.separators[i]+formatObj.parts[i];}
lastStr=formatObj.separators[len];}
var formatArr=['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'];var formatChangeArr=[['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'],['M d, yyyy hh:ii:ss','M d, yyyy hh:ii','M d, yyyy hh','M d, yyyy','M, yyyy','M d hh:ii:ss','M d hh:ii','M d hh','M d'],['dd/mm/yyyy hh:ii:ss','dd/mm/yyyy hh:ii','dd/mm/yyyy hh','dd/mm/yyyy','mm/yyyy','dd/mm hh:ii:ss','dd/mm hh:ii','dd/mm hh','dd/mm']];if(formatArr.findIndex){var index=formatArr.findIndex(function(v){return v===format;});}else{for(var i=0;i<formatArr.length;i++){if(formatArr[i]===format){var index=i;break;}}}
type=Number(type);type&&(type>=formatChangeArr.length)&&(type=formatChangeArr.length-1);if(index==-1){console.log('format is not defined');return format+lastStr;}else{if(type===0){return formatChangeArr[0][index]+lastStr;}
return formatChangeArr[type||AppConfig.projectTimeFormat||0][index]+lastStr;}}
function timeFormat(time,format,language,option){var date,arr,arr2;var sort=function(year,month,day,time){year=year==undefined?'2001':year;month=month==undefined?'01':month;day=day==undefined?'01':day;time=time==undefined?'':(' '+time);return new Date(year+'/'+month+'/'+day+time);}
if(time instanceof Date){date=time;}else if(typeof(time)=='string'){if(/^\d{1,2}-\d{1,2}/.test(time)){arr=time.split(' ');arr2=arr[0].split('-');time=arr2[1]+'-'+arr2[0]+(arr2[2]==undefined?'':('-'+arr2[2]))+(arr[1]==undefined?'':(' '+arr[1]));}
time=time.replace(/-/g,"/");arr=time.split(' ');arr2=arr[0].split('/');if(/^\d{4}/.test(time)){date=sort(arr2[0],arr2[1],arr2[2],arr[1]);}else if(/^\d{1,2}\/\d{4}/.test(time)){date=sort(arr2[1],arr2[0],'01',arr[1]);}else if(/^\d{1,2}\/\d{1,2}/.test(time)){date=sort(arr2[2],arr2[1],arr2[0],arr[1]);}else{date=new Date(time);}}else{date=new Date(time);}
return date.timeFormat(format,language,option);}
(function(exports){var MINITE_1=60000;var MINITE_5=300000;var HOUR_1=3600000;var DAY_1=86400000;var DAY_365=31536000000;function _formatTimeStr(str,format){var arr=str.split(' ');var date=arr[0].split('-');var time=arr[1].split(':');return format.replace('yyyy',date[0]).replace('MM',date[1]).replace('dd',date[2]).replace('HH',time[0]).replace('mm',time[1]).replace('ss',time[2]);}
function _explainPattern(timeShaft){var startTime=new Date(timeShaft[0]);var endTime=new Date(timeShaft[timeShaft.length-1]);var timeRange=endTime.valueOf()-startTime.valueOf();var timeInterval=timeRange/(timeShaft.length-1);var pattern='MM-dd HH:mm';if(timeInterval<=MINITE_5){if(timeRange<=HOUR_1){pattern='HH:mm';}else if(timeRange<=DAY_1){pattern='HH:mm';}}
else if(timeInterval<=HOUR_1){if(timeRange<=DAY_1){pattern='HH:mm';}else{pattern='MM-dd HH:mm';}}
else if(timeInterval<=DAY_1){if(timeRange<=DAY_365){pattern='MM-dd';}else{pattern='yyyy-MM-dd';}}
else{pattern='yyyy-MM';}
return pattern;}
function _explain(timeShaft){pattern=getPattern(timeShaft);if(pattern){timeShaft=timeShaft.map(function(row){return _formatTimeStr(row,pattern);});}
return timeShaft;}
function _valid(params){var flag=Object.prototype.toString.call(params)==='[object Array]';return flag&&/^[\d-]{10} [\d:]{8}$/.test(params[0]);}
var _getTimePattern=function(timeShaft){if(!_valid(timeShaft)){return;}
if(timeShaft.length<=1){return;}
return _explainPattern(timeShaft);};var formatTimeShaft=exports.formatTimeShaft=function(timeShaft){if(!_valid(timeShaft)){console.warn('function arguments is not a valid time shaft array!');return timeShaft;}
if(timeShaft.length<=1){return timeShaft;}
return _explain(timeShaft);};function _formatTimeStrByAppConfig(data){var formatArr,formatStr,regularArr,language,formatObj;switch(AppConfig.projectTimeFormat||0){case 0:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';break;case 1:formatArr=['M d, yyyy','M d hh:ii','M, yyyy','M, yyyy','M d'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;case 2:formatArr=['dd/mm/yyyy','dd/mm hh:ii','mm/yyyy','mm/yyyy','dd/mm'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;default:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';}
for(var i=0,len=regularArr.length;i<len;i++){if(regularArr[i].test(data)){formatStr=formatArr[i];break;}}
if(formatStr){formatObj=(function _parseFormat(formatStr){var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};})(formatStr);return{formatStr:formatStr,language:language,formatObj:formatObj};}else{return;}}
if(window.echarts){echarts.registerPreprocessor(function(option){var pattern;var formatInfo,firstValue;if(option.formatTime===false){pattern=_getTimePattern(option.xAxis[0].data);echarts.formatTimePattern=pattern;return;}
if(option.xAxis&&option.xAxis.length){option.xAxis.forEach(function(row){if(row.data&&row.data.length){pattern=_getTimePattern(row.data);formatInfo=_formatTimeStrByAppConfig(row.data[0]);if(pattern){row.data=row.data.map(function(row){return row.substr(0,16);});firstValue=_formatTimeStr(row.data[0],pattern);formatInfo=_formatTimeStrByAppConfig(firstValue);if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}else{row.data=row.data.map(function(it,i){return _formatTimeStr(it,pattern);});}}else if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}}});}});}}(window));var generateTimeOption=function(option){var timeConfig=clone(option);(!timeConfig.timeStart)&&(timeConfig.timeStart=timeConfig.startTime);(!timeConfig.timeEnd)&&(timeConfig.timeEnd=timeConfig.endTime);(!timeConfig.timeFormat)&&(timeConfig.timeFormat=timeConfig.format);var recentTime={};var now=new Date();if(typeof option=='string'){recentTime=generateRecentTime(option)}else if(option&&option.timeRecent){if(typeof option.timeRecent=='string'){recentTime=generateRecentTime(option.timeRecent)}else if(option.timeRecent.hasOwnProperty('unit')&&option.timeRecent.hasOwnProperty('val')){recentTime=generateRecentTimeCustom(option.timeRecent)}}
if(recentTime&&Object.keys(recentTime).length>0){timeConfig.timeStart=recentTime.timeStart;timeConfig.timeEnd=recentTime.timeEnd;if(recentTime.format){timeConfig.timeFormat=recentTime.format;}
switch(timeConfig.timeFormat){case'h1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-dd HH:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-dd HH:00:00');break;case'd1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-dd 00:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-dd 00:00:00');break;case'M1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-01 00:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-01 00:00:00');break;}}
timeConfig.startTime=timeConfig.timeStart;timeConfig.endTime=timeConfig.timeEnd;timeConfig.format=timeConfig.timeFormat;return timeConfig;function generateRecentTime(time){var startTime,endTime,format;switch(time){case'today':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-86400000).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'threeDay':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-259200000).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'yesterday':endTime=new Date(new Date().setDate(now.getDate()-1)).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(new Date().setDate(now.getDate()-2)).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'thisWeek':endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(now-604800000).format('yyyy-MM-dd HH:mm:ss');format='d1';break;case'lastWeek':endTime=new Date(now-(now.getDay()+1)*86400000).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-(now.getDay()+7)*86400000).format('yyyy-MM-dd HH:mm:ss');format='d1';break;case'thisYear':endTime=new Date(now-(now.getDay()+1)*86400000).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-(now.getDay()+7)*86400000).format('yyyy-MM-dd HH:mm:ss');format='M1';break;}
return{timeStart:startTime,timeEnd:endTime,format:format}}
function generateRecentTimeCustom(time){var startTime,endTime,format;switch(time.unit){case'hour':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-3600000*time.val).format('yyyy-MM-dd HH:mm:ss');break;case'day':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-86400000*time.val).format('yyyy-MM-dd HH:00:00');break;case'month':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-2592000000*time.val).format('yyyy-MM-dd HH:00:00');break;}
return{timeStart:startTime,timeEnd:endTime}}};﻿var WebAPI=(function(){var siteId;switch(window.location.hostname){case'beop.rnbtech.com.hk':siteId='b79c068f77198848e22fe79758836e53';break;case'beop6.rnbtech.com.hk':siteId='f1f6b2b9e6b64592c0b4cb5e9b8bd79e';break;case'beopdemo.rnbtech.com.hk':siteId='ac0df98f274d9a5980a571297248d80b';break;default:break;}
(function(){if(siteId){var hm=document.createElement("script");hm.src="//hm.baidu.com/hm.js?"+siteId;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);}})();var mockList={'/static/mock/analysis_workspace_saveLayout.json':/\/analysis\/workspace\/saveLayout\/\d+\/[01]/i,'/static/mock/analysis_template_get.json':/\/analysis\/template\/get\/\d+/i};function mock(url){var match=null;for(var i in mockList){match=url.match(mockList[i]);if(match!==null)return i;}
return url;}
function requestFailHandle(result){if(result&&result.status==401){alert(i18n_resource.error.noPermission);}}
function WebAPI(){}
WebAPI.isMock=false;$.ajaxSetup({converters:{"text json":true},dataFilter:function(result,type){var data=result;if(type==='script'){return data;}else if(typeof data==='string'){if(/^\s*</.test(data)){return data;}
try{data=JSON.parse(result);}catch(e){console.log('request error: '+e+', the data is :'+data);return data;}}
if(data){if(data.error){switch(data.error){case'token_invalid':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');if(typeof LoginValidate!='undefined'){var validate=new LoginValidate();validate.show();return;}
confirm(i18n_resource.error.token[data.msg]+'. '+i18n_resource.error.relogin+'.',function(){if(AppConfig.isMobile){location.reload();}else{location.href='/';}});break;}
case'historyData':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');alert(data.msg);return{};}
default:break;}}
if(data.code==403){console.log(this.url+' ('+data.msg+'")');alert(I18n.resource.error.noPermission);return{};}}
return data;}});WebAPI.post=function(url,data,isMock){var mockUrl;isMock=isMock===undefined?WebAPI.isMock:isMock;if(isMock){mockUrl=mock(url);if(url!==mockUrl)return this.get(mockUrl,false);}
if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1)}}
return $.ajax({url:url,type:'POST',data:JSON.stringify(data),contentType:'application/json'}).fail(requestFailHandle);};WebAPI.get=function(url,isMock){isMock=isMock===undefined?WebAPI.isMock:isMock;url=isMock?mock(url):url;if(window._hmt&&url.indexOf('.html')>0)window._hmt.push(['_trackPageview',url]);if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1)}}
return $.ajax({url:url,type:'Get',contentType:'application/json'}).fail(requestFailHandle);};WebAPI.getHistoryDS=function(callback){};WebAPI.getHistory=function(callback){};return WebAPI;})();(function(){'use strict';var indexedDB=indexedDB||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(!indexedDB){return;}
function _initStorage(options){var _this=this;this._dbInfo=$.extend({db:null},options);var promise=$.Deferred();(function(){var _this=this;var dbInfo=this._dbInfo;var openreq=indexedDB.open(dbInfo.name,dbInfo.version);openreq.onerror=function(){promise.reject(openreq.error);};openreq.onsuccess=function(){dbInfo.db=openreq.result;promise.resolve();};openreq.onupgradeneeded=function(){var names=openreq.result.objectStoreNames;var length,key;var indexOf=([]).indexOf;if(indexOf.call(names,'cache')>-1){openreq.result.deleteObjectStore('cache');}
if(indexOf.call(names,'datasource')>-1){openreq.result.deleteObjectStore('datasource');}
if(indexOf.call(names,'thumbnail')>-1){openreq.result.deleteObjectStore('thumbnail');}
if(indexOf.call(names,'buffer')===-1){openreq.result.createObjectStore('buffer');}
openreq.result.createObjectStore('datasource');openreq.result.createObjectStore('thumbnail');for(var i=0,len=localStorage.length;i<len;i++){key=localStorage.key(i);if(key.indexOf('workSpacePicStorageEnable')===0){localStorage.removeItem(key);}}};}).call(this);}
function length(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.count();req.onsuccess=function(){promise.resolve(req.result);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.get(key);req.onsuccess=function(){var value=req.result;value=value===undefined?null:value;promise.resolve(value);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var result={};var promise=this.iterate(function(key,value,i){if(keyList.indexOf(key)>-1){result[key]=value;}}).then(function(){return result;},function(){console.warn('getItemList error!');});excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.put(value,key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();try{(function(){var _this=this;var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var result={};kvList.forEach(function(kv,i){var key=kv.key,value=kv.value;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
store.put(value,key);});transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=transaction.error;promise.reject(err);};}).call(this);}catch(e){console.warn('setItemList error!');promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.delete(key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;var request;if(!cursor){promise.resolve();return;}
if(keyList.indexOf(cursor.key)>-1){cursor.delete();}
cursor.continue();};req.onerror=function(err){promise.reject(err);};}).call(this);}catch(e){promise.reject();}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.clear();transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var advanced=false;req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(null);return;}
if(n===0){promise.resolve(cursor.key);}else{if(!advanced){advanced=true;cursor.advance(n);}else{promise.resolve(cursor.key);}}};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var keys=[];var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(keys);return;}
keys.push(cursor.key);cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var index=0;req.onsuccess=function(){var cursor=req.result;var result;if(!cursor){promise.resolve();return;}
result=iterator(cursor.key,cursor.value,index++);if(result===false){promise.resolve();return;}
cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var indexDBWrapper={_driver:'indexedDBWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.indexedDB=indexDBWrapper;}).call(this);(function($){'use strict';var localStorage;try{if(!this.localStorage||!('setItem'in this.localStorage)){return;}
localStorage=this.localStorage;}catch(e){return;}
function _initStorage(options){this._dbInfo=$.extend({},options);this._dbInfo.keyPrefix=this._dbInfo.name+'/';}
function length(callback){var _this=this;var promise=this.keys().then(function(keys){return keys.length;});excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var result;result=localStorage.getItem(this._dbInfo.keyPrefix+key);try{result=JSON.parse(result);}catch(e){}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var _this=this;var promise=$.Deferred();(function(){var result={};keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
result[key]=localStorage.getItem(_this._dbInfo.keyPrefix+key);try{result[key]=JSON.parse(result[key]);}catch(e){}});promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var _this=this;var result;try{try{value=JSON.stringify(value);}catch(e){}
result=localStorage.setItem(_this._dbInfo.keyPrefix+key,value);promise.resolve(result);}catch(e){result=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}
promise.reject(e);}}).call(this);excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();(function(){var _this=this;var result={};kvList.forEach(function(kv,i){var value;if(typeof kv.key!=='string'){console.warn('The key is not a string!');kv.key=String(kv.key);}
try{try{value=JSON.stringify(kv.value);}catch(e){value=kv.value;}
result[kv.key]=localStorage.setItem(_this._dbInfo.keyPrefix+kv.key,value);}catch(e){console.warn('occur error when set data into storage [key: "'+kv.key+'", value: "'+kv.value+'"]');result[kv.key]=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}}});promise.resolve();}).call(this);excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){localStorage.removeItem(this._dbInfo.keyPrefix+key);promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var _this=this;keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
localStorage.removeItem(_this._dbInfo.keyPrefix+key);});promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){localStorage.removeItem(key);}}
promise.resolve();}).call(this);}catch(e){proimse.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();(function(){var result;result=localStorage.key(n);if(result){result=result.substring(_this._dbInfo.keyPrefix.length);}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();(function(){var keyPrefix=this._dbInfo.keyPrefix;var length=localStorage.length;var keys=[],key;for(var i=0;i<length;i++){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){keys.push(key.substring(keyPrefix.length));}}
promise.resolve(keys);}).call(this);excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key,value;var result;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){value=localStorage.getItem(key);try{value=JSON.parse(value);}catch(e){}
result=iterator(key.substring(keyPrefix.length),value,i);}
if(result===false){break;}}
promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var localStorageWrapper={_driver:'localStorageWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.localStorage=localStorageWrapper;}).call(this,jQuery);(function($){function BaseCache(options){this.options=$.extend({},DEFAULTS,options);this.storage=Object.create(Beop.cache.drivers[this.options.driver]);this.init();}
BaseCache.prototype.init=function(){this.storage._initStorage(this.options);};BaseCache.prototype.length=function(){return this.storage.length();};BaseCache.prototype.key=function(n,callback){return this.storage.key(n,callback);};BaseCache.prototype.keys=function(callback){return this.storage.keys(callback);};BaseCache.prototype.getItem=function(key,callback){return this.storage.getItem(key,callback);};BaseCache.prototype.getItemList=function(keyList,callback){return this.storage.getItemList(keyList,callback);};BaseCache.prototype.setItem=function(key,value,callback){return this.storage.setItem(key,value,callback);};BaseCache.prototype.setItemList=function(kvList,callback){return this.storage.setItemList(kvList,callback);};BaseCache.prototype.removeItem=function(key,callback){return this.storage.removeItem(key,callback);};BaseCache.prototype.removeItemList=function(keyList,callback){return this.storage.removeItemList(keyList,callback);};BaseCache.prototype.clear=function(callback){return this.storage.clear(callback);};BaseCache.prototype.iterate=function(iterator,callback){return this.storage.iterate(iterator,callback);};var DEFAULTS={dbType:'localStorage',name:'beopcache',version:3};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.BaseCache=BaseCache;}).call(this,jQuery);var EventAdapter=(function(){var eventData,eventStatus;function EventAdapter($){}
EventAdapter.on=function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<3||arguments.length>5){console.log('EventAdapter.on arguments.length error');return;}
if(typeof arguments[0]!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}}
if(typeof arguments[1]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[1];}
if(typeof arguments[2]=='function'){eventFunction=arguments[2];eventSelector=null;eventHmt=arguments[3]}else if(typeof arguments[2]=='string'){if(arguments[3]&&typeof arguments[3]=='function'){eventSelector=arguments[2];eventFunction=arguments[3];eventHmt=arguments[4]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':eventTarget.on('touchstart',eventSelector,function(e){mobileDragStart.call(this,e,eventTarget,finalFunction)});break;case'dragover':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragOver.call(this,e,eventTarget,finalFunction)});break;case'dragleave':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragLeave.call(this,e,eventTarget,finalFunction)});break;case'drop':$(document).on('touchend.drop',eventSelector,function(e){mobileDrop.call(this,e,eventTarget,finalFunction)});break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;};EventAdapter.off=function(){if((arguments.length>3||arguments.length<1)||(arguments[0]&&typeof arguments[1]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}
if(arguments.length==1){eventTarget.off();return eventTarget;}
if(typeof arguments[1]=='string'){eventType=arguments[1]}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[2]=='string'){eventSelector=arguments[2];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;};$.fn.extend({'eventOn':function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<2||arguments.length>4){console.log('EventAdapter.on arguments.length error');return;}
if(typeof this!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(this instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=this;}}
if(typeof arguments[0]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[0];}
if(typeof arguments[1]=='function'){eventFunction=arguments[1];eventSelector=null;eventHmt=arguments[2]}else if(typeof arguments[1]=='string'){if(arguments[2]&&typeof arguments[2]=='function'){eventSelector=arguments[1];eventFunction=arguments[2];eventHmt=arguments[3]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':mobileDragStart(eventTarget,eventSelector,finalFunction);break;case'dragover':mobileDragOver(eventTarget,eventSelector,finalFunction);break;case'dragleave':mobileDragLeave(eventTarget,eventSelector,finalFunction);break;case'drop':mobileDrop(eventTarget,eventSelector,finalFunction);break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;},'eventOff':function(){if((arguments.length>2)||(arguments[0]&&typeof arguments[0]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(this instanceof jQuery)){eventTarget=jQuery(this);}else{eventTarget=this;}
if(arguments.length==0){eventTarget.off();return eventTarget;}
if(typeof arguments[0]=='string'){eventType=arguments[0];}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[1]=='string'){eventSelector=arguments[1];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector,mobileDragStart);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;}});EventAdapter.setData=function(date){if(date==undefined)return;eventData=date;};EventAdapter.getData=function(){return eventData;};document.addEventListener('drop',function(){eventData=null;},false);document.addEventListener('touchend',function(){eventData=null;},false);EventAdapter.clearEvent=function(){$(document).off('touchmove.copy');$(document).off('touchmove.drag');$(document).off('touchend.drop');};EventAdapter.analyse=function(e,eventType,hmtInfo){var mainInfo='',initArrTag,finalArrTag,tag,unitTag;var target=$(e.currentTarget);if(hmtInfo instanceof Array&&hmtInfo[0]){mainInfo=judgeWay(hmtInfo[0]);initArrTag=hmtInfo.filter(function(ele,index){return index>0&&ele!='';});finalArrTag=[];for(var i=0;i<initArrTag.length;i++){unitTag=judgeWay(initArrTag[i]);if(unitTag=='')continue;finalArrTag.push(unitTag)}
tag=finalArrTag.join('-');}else{if(hmtInfo!=undefined){mainInfo=judgeWay(hmtInfo);}else{mainInfo=getInfo(target);}
mainInfo=mainInfo?mainInfo:'';tag=mainInfo;}
_hmt.push(['_trackEvent',mainInfo.substr(0,30),eventType,'user-'+(AppConfig.userId?AppConfig.userId:0)+'/project-'+(AppConfig.projectId?AppConfig.projectId:0)]);function getInfo(tar){if(tar.length==0)return;var tarInfo;if(tar.attr('id')){tarInfo=tar.attr('id');}else if(tar.attr('i18n')){tarInfo=tar.attr('i18n');}else if(tar.attr('title')){tarInfo=tar.attr('title');}else{tarInfo=tar[0].innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30);}
return tarInfo;}
function judgeWay(arg){if(typeof arg=='undefined'){return'';}
if(arg instanceof Function){return arg.call(this,e)}else if(typeof arg=='string'){if(arg=='text'){return e.currentTarget.innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30)}else{return $(e.currentTarget).attr(arg)?$(e.currentTarget).attr(arg):arg;}}else if(typeof arg=='number'){return arg;}}};var mobileDragStart=function(e,target,eventFunction){var originalTarget=$(e.target).closest('[draggable="true"]')[0];var ev=e.type=='touchstart'?e.originalEvent.touches[0]:e,startPos={left:$(originalTarget).css('left'),top:$(originalTarget).css('top'),zIndex:$(originalTarget).css('z-index')},disX=originalTarget.offsetWidth/2,disY=originalTarget.offsetHeight/2;var $copyTarget=$(originalTarget).clone();$copyTarget.data('startPos',startPos);$copyTarget.css('z-index',10000);$copyTarget.css('position','absolute');$copyTarget.css('opacity','0.5');$copyTarget.css('pointer-events','none');var $container=$('body');$container.append($copyTarget);var sPos=$(originalTarget)[0].getBoundingClientRect();$copyTarget.css('left',sPos.left-$container[0].offsetLeft+'px');$copyTarget.css('top',sPos.top-$container[0].offsetTop+'px');$copyTarget[0].cssText=originalTarget.cssText;$copyTarget.css('width',originalTarget.offsetWidth);$copyTarget.css('height',originalTarget.offsetHeight);eventStatus='dragStart';eventFunction.call(this,ev);$(document).off('touchend.copy').on('touchend.copy',function(e){$copyTarget.remove();eventStatus='dragEnd';});$(document).on('touchmove.copy',function(e){eventStatus='dragMove';var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var $parent=$copyTarget.offsetParent();$parent=$parent.is(':root')?$(window):$parent;var targetLeft=ev.pageX-disX;var targetTop=ev.pageY-disY;$copyTarget.css({left:targetLeft+'px',top:targetTop+'px','z-index':10000});})};var mobileDragOver=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn'&&eventStatus!='dragMoveOut')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveIn';eventFunction.call(this,e);break;}}};var mobileDragLeave=function(e,target,eventFunction){if(eventStatus!='dragMoveIn')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(!((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY))){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveOut';eventFunction.call(this,e);}}};var mobileDragEnd=function(e,target,eventFunction){eventFunction.call(this,e);};var mobileDrop=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn')return;var ev=e.type=='touchend'?e.originalEvent.changedTouches[0]:e;var eventTarget=target;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventFunction.call(this,e);break;}}};return EventAdapter;})(jQuery);﻿
var Internationalization=(function(){function Internationalization(lang,resource){this.type=lang||localStorage["language"];this.resource=resource||{};}
Internationalization.prototype={getResource:function(){return this.resource;},fillPage:function(){this.fill2($('[i18n]'));},fillArea:function(element){this.fill2(element.find('[i18n]'));try{Permission.check(element);}catch(e){console.log('check permission failed:'+e);}},fillAreaAttribute:function(element,attributeName){this.fill(element.find('[i18n]['+attributeName+']'),attributeName);},fill:function(arrElement,attributeName){for(var i=0,arrPath,text,len=arrElement.length;i<len;i++){arrPath=arrElement[i].attributes["i18n"].value.split('.');text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
if(!attributeName){arrElement[i].innerHTML=text;}
else{arrElement[i].setAttribute(attributeName,text);}}},getI18nValue:function(i18nKey){if(!i18nKey){return'';}
var arrPath=i18nKey.split('.');var text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
return text;},fill2:function(arrElement){for(var i=0,len=arrElement.length;i<len;i++){var i18nValue=arrElement[i].attributes["i18n"];var items=i18nValue.value.split(';'),item,attrMap;for(var j=0;j<items.length;j++){item=items[j];if(!item){continue;}
if(item.indexOf('=')===-1){i18nValue=this.getI18nValue(item);arrElement[i].innerHTML=i18nValue;}else{attrMap=item.split('=');if(!attrMap[0]){continue;}
arrElement[i].setAttribute(attrMap[0],this.getI18nValue(attrMap[1]));}}}},findContent:function(strPath){var arrPath=strPath.split('.');var text=this.resource;for(var i=0,len=arrPath.length;i<len;i++){text=text&&text[arrPath[i]];}
return text;}};return Internationalization;})();function InitI18nResource(strLanguage,isForce,filePath){if(!strLanguage){strLanguage=localStorage["isUserSelectedLanguage"]||navigator.language.split('-')[0];}
if(isForce){localStorage["isUserSelectedLanguage"]=strLanguage;}else if(localStorage["isUserSelectedLanguage"]){strLanguage=localStorage["isUserSelectedLanguage"];}
filePath=filePath||'/static/views/js/i18n/';return $.ajax({async:false,url:filePath+strLanguage+".js",dataType:"script"}).then(function(){localStorage["language"]=strLanguage;return i18n_resource;},function(){return $.ajax({async:false,url:filePath+"en.js",dataType:'script'}).then(function(){localStorage["language"]="en";return i18n_resource;},function(){console.warn('i18n files loading failed!');return{};});});}
var ElScreenContainer=document.getElementById('indexMain');var SpinnerContainer=document.getElementById('divSpinner');var AlertContainer=document.getElementById('divAlert');var ScreenCurrent=undefined;var ScreenPrevious=undefined;var Spinner=new LoadingSpinner({color:'#00FFFF'});var AppConfig={userId:undefined,account:undefined,isMobile:true,version:'1.1.6',projectId:145,gpsTime:5000};var userAll=undefined;var pathAll=undefined;var missionAll=undefined;var pointAll=undefined;var curSet=undefined;var I18n=undefined;var BomConfig=BomConfig||{};var router;var dataManager=undefined;var appConfigManager=(function(){var DEFAULT_CONFIG={gps:0};function get(){var options=window.localStorage.getItem('appConfig');if(options===null){set(DEFAULT_CONFIG);return DEFAULT_CONFIG;}
try{options=JSON.parse(options);}catch(e){}
return options;}
function set(options){window.localStorage.setItem('appConfig',JSON.stringify(options));}
return{get:get,set:set}}());$(document).ready(function(){if(navigator.userAgent.match(/iP(ad|hone|od)|Android/i))AppConfig.isMobile=true;var config={frequency:70,initialValue:2,ThreadValue:2,isStatic:true};steps=new Steps(config);InitI18nResource(navigator.language.split('-')[0],null,'static/views/js/i18n/').always(function(rs){new UpdateHelper('patrol','0.2',function(){I18n=new Internationalization(null,rs);dataManager=new DataManager();Init();})});});var steps;document.addEventListener('deviceready',onDeviceReady,false);function onDeviceReady(){AppConfig.device=device;AppConfig.language=navigator.language.split('-')[0]?navigator.language.split('-')[0]:'zh';document.addEventListener("backbutton",router.back,false);var config={frequency:70,initialValue:2,ThreadValue:2,isStatic:true};steps=new Steps(config);AppConfig.host='http://beop.rnbtech.com.hk';AppConfig.language='zh';document.addEventListener("volumeupbutton",function(){infoBox.confirm('清除缓存将会清除一切巡更日志以及缓存文件，如确定，之后请重进App。',function(){localStorage.clear();if(typeof dataManager=='undefined')return;if(dataManager.file.enable){dataManager.file.write([{type:'userAll',data:[]},{type:'pathAll',data:[]},{type:'pointAll',data:[]},{type:'missionAll',data:[]},{type:'patrolLog',data:[]}],function(store){dataManager.patrolLog=[];callback();});}else{dataManager.patrolLog=[];callback();}})},false);document.addEventListener("volumedownbutton",function(){if(!curSet||$.isEmptyObject(curSet)||!curSet.log)return;var postData={time:new Date(),type:'temp',patrol:curSet};WebAPI.post('/patrol/log/saveOperateLog',postData).done(function(){window.plugins.toast.show('临时操作日志上传成','short','bottom');})},false);InitI18nResource('zh',null,'static/views/js/i18n/').always(function(rs){new UpdateHelper('patrol.anbao',AppConfig.version,function(){I18n=new Internationalization(null,rs);dataManager=new DataManager();dataManager.getPatrolLogFromFile(Init);})});}
var IndexScreen=(function(){function IndexScreen(){}
IndexScreen.prototype={show:function(){var _this=this;if(localStorage.getItem('beopHost')){AppConfig.host=localStorage.getItem('beopHost')}else{AppConfig.host='http://beop.rnbtech.com.hk'}
_this.initNav();_this.init();},close:function(){document.onkeydown=false;},init:function(){var _this=this;CssAdapter.adapter();try{curSet=JSON.parse(localStorage.getItem('curSet'));if(!curSet)curSet={};}catch(e){curSet={}}
router.empty().to({typeClass:UserSelScreen,data:{}})},initNav:function(){$('#btnBack').off('tap').on('tap',function(e){router.back();});}};return IndexScreen;})();function Init(){ScreenManager.show(IndexScreen);}
﻿var UpdateHelper=(function(){function UpdateHelper(name,version,callback){this.curVersion=version;this.callback=callback;this.name=name;this.$modal=undefined;this.init();}
UpdateHelper.prototype={modalTpl:'\
        <div id="ctnUpdateHelper" style="position: fixed;z-index: 1004;\
        background: white;border-radius: 0.5rem;border: 1px solid #ccc;\
        top: 20%;width: 24rem;left: calc(50% - 12rem);padding: 1rem;">\
            <div id="divHelperDesc" style="margin-bottom: 2rem;font-size: 1.6rem;"></div>\
            <div id="divHelperCurVer" style="text-align: right;font-size: 1rem;color: #969696;"></div>\
            <div id="divHelperLastVer" style="text-align: right;font-size: 1rem;color: #969696;"></div>\
            <div id="divHelperTime" style="margin-bottom: 0.6rem;text-align: right;font-size: 1rem;color: #969696;"></div>\
            <div id="divHelperFooter" class="clearfix" style="text-align: right;padding-top: 1rem;">\
                <button id="btnUpdateIgnore" class="btn btn-default zepto-ev col-xs-4" style="padding: 6px 12px;border-radius:0;border-top-left-radius: 4px;border-bottom-left-radius: 4px;"><%Ignore%></button>\
                <button id="btnUpdateCancel" class="btn btn-default zepto-ev col-xs-4" style="padding: 6px 12px;border-radius:0;"><%Cancel%></button>\
                <button id="btnUpdateOk" class="btn btn-primary zepto-ev col-xs-4" style="padding: 6px 12px;border-radius:0;border-top-right-radius: 4px;border-bottom-right-radius: 4px;"><%Upgrade%></button>\
            </div>\
        </div>\
        <div class="backdrop zepto-ev" style="position: fixed;top: 0;left: 0;right: 0;bottom: 0;\
        background-color: rgba(100,100,100,0.3);z-index: 1003;"></div>',init:function(){var _this=this;var ignoreVersion=localStorage.getItem('ignoreVersion');try{if(ignoreVersion)ignoreVersion=JSON.parse(ignoreVersion);}catch(e){ignoreVersion=undefined;}
WebAPI.get('/appCommon/getVersion/'+this.name+'/'+this.curVersion).done(function(result){if(!result||result.isLast||!result.version)return;_this.judgeWhetherNeedToUpdate(result,ignoreVersion);}).always(function(){_this.callback();});},getLastVersion:function(){WebAPI.get('/appCommon/getVersion/'+this.name+'/'+this.curVersion).done(function(result){if(!result||result.isLast||!result.version){infoBox.alert(AppConfig.language=='zh'?'已经是最新版本':'This is the latest version.');return;}
infoBox.confirm(AppConfig.language=='zh'?'检查到有新版本，是否更新？':'A new version exists，need upgrade？',function(){if(result.url.indexOf('http')>-1){window.open(result.url);}else{window.open('http://'+result.url);}})}).always(function(){});},judgeWhetherNeedToUpdate:function(result,dictIgnore){var name=this.name;if(dictIgnore&&dictIgnore[this.name]){if(dictIgnore[name].version==result.version&&dictIgnore[name].name==name)return;}
if(result>this.curVersion){this.showUpdateModel(result,dictIgnore);}},showUpdateModel:function(result,dictIgnore){var html=this.modalTpl;var strUpgradeTime,strCurVer,strLastVer;if(AppConfig&&AppConfig.language=='zh'){html=html.replace(/<%Upgrade%>/g,'更新');html=html.replace(/<%Cancel%>/g,'取消');html=html.replace(/<%Ignore%>/g,'忽略');strUpgradeTime='更新时间：';strCurVer='当前版本：';strLastVer='最新版本：'}else{html=html.replace(/<%Upgrade%>/g,'Upgrade');html=html.replace(/<%Cancel%>/g,'Cancel');html=html.replace(/<%Ignore%>/g,'Ignore');strUpgradeTime='Upgrade Time:';strCurVer='Current Version:';strLastVer='Last Version:'}
this.$modal=$(html);this.$modal.find('#divHelperDesc').html(result.detail);this.$modal.find('#divHelperTime').text(strUpgradeTime+new Date(result.time.replace(/-/g,'/')).format('yyyy-MM-dd'));this.$modal.find('#divHelperCurVer').text(strCurVer+this.curVersion);this.$modal.find('#divHelperLastVer').text(strLastVer+result.version);this.$modal.appendTo('body');this.attachEvent(result,dictIgnore);},attachEvent:function(result,dictIgnore){var _this=this;this.$modal.find('#btnUpdateOk').off('tap').on('tap',function(){if(result.url.indexOf('http')>-1){window.open(result.url);}else{window.open('http://'+result.url);}
_this.close();});this.$modal.find('#btnUpdateCancel').off('tap').on('tap',function(){_this.close();});this.$modal.find('#btnUpdateIgnore').off('tap').on('tap',function(){var ignoreVersion={name:_this.name,version:result.version};if(!dictIgnore)dictIgnore={};dictIgnore[_this.name]=ignoreVersion;localStorage.setItem('ignoreVersion',JSON.stringify(dictIgnore));_this.close();});this.$modal[2]&&$(this.$modal[2]).off('tap').on('tap',function(){_this.close();})},close:function(){this.$modal.remove();this.$modal=null;}};return UpdateHelper;})();var DataManager=(function(){var _this;function DataManager(){_this=this;_this.file=new FileStorage('BeopPatrol');_this.patrolLog=[];_this.callback=undefined;}
DataManager.prototype={update:function(callback,isForceFile){SpinnerControl.show();if(navigator.connection){if(navigator.connection.type=='none'){_this.updateFromFile(callback);}else{_this.updateFromNet(callback);}}else{_this.updateFromNet(callback);}},getPatrolLogFromFile:function(callback){if(_this.file.enable){_this.file.read(['patrolLog'],function(store){if(store.patrolLog.status=='success')_this.patrolLog=store.patrolLog.result;callback();});}else{callback();}},clearPage:function(){_this.callback=undefined;_this.page=undefined;},attachNetworkEvent:function(func){if(typeof func=='function'){_this.callback=func;}
document.addEventListener("online",_this.updateWrap,false);},updateWrap:function(){console.log('online success');window.plugins.toast.show('网络已连接','short','bottom');_this.update(_this.callback);},removeNetworkEvent:function(){_this.callback=undefined;document.removeEventListener("online",_this.updateWrap,false);},updateFromFile:function(callback){if(curSet&&curSet.path&&curSet.path.path&&curSet.ptCompleteIndex>=curSet.path.path.length){_this.file.read(['userAll','missionAll','pointAll','pathAll'],function(store){(store.userAll.status=='success')&&(userAll=store.userAll.result);(store.pathAll.status=='success')&&(pathAll=store.pathAll.result);(store.missionAll.status=='success')&&(missionAll=store.missionAll.result);(store.pointAll.status=='success')&&(pointAll=store.pointAll.result);_this.patrolLog.push(curSet.log);_this.file.write([{type:'patrolLog',data:_this.patrolLog}],function(store){if(store.patrolLog&&store.patrolLog.status=='success'){curSet={};localStorage.removeItem('curSet');console.log('记录缓存成功');window.plugins&&window.plugins.toast.show('记录缓存成功','short','bottom');}else{console.log('记录缓存失败');window.plugins&&window.plugins.toast.show('记录缓存失败，请于联网状态下及时上传。','short','bottom');}
SpinnerControl.hide();callback();})});}else{_this.file.read(['userAll','missionAll','pointAll','pathAll'],function(store){(store.userAll.status=='success')&&(userAll=store.userAll.result);(store.pathAll.status=='success')&&(pathAll=store.pathAll.result);(store.missionAll.status=='success')&&(missionAll=store.missionAll.result);(store.pointAll.status=='success')&&(pointAll=store.pointAll.result);SpinnerControl.hide();callback();});}},saveUpdateLog:function(success,log,callback){var _this=this;if(!_this.file.enable)return;_this.file.read([{type:'updateLog'}],function(store){var newLog,updateLog;if(store&&store.updateLog.status=='success'){updateLog=store.updateLog.result;}
if(updateLog instanceof Array){newLog=updateLog.filter(function(val){return(val.time&&(new Date()-new Date(val.time))<259200000)});}else{newLog=[];}
newLog.push({time:new Date(),type:log.type,patrol:log.patrol,isSuccess:success,info:log.info});_this.file.write([{data:newLog,type:'updateLog'}],callback);})},updateFromNet:function(callback){if(curSet&&curSet.log&&curSet.ptCompleteIndex>=curSet.path.path.length){if(!(_this.patrolLog instanceof Array)){_this.patrolLog=[];}
_this.patrolLog.push(curSet.log)}
if(!curSet)curSet={};if(!(_this.patrolLog&&_this.patrolLog.length>0)){$.when(WebAPI.get('/patrol/executor/getList/'+AppConfig.projectId),WebAPI.get('/patrol/path/getAll/'+AppConfig.projectId),WebAPI.get('/patrol/mission/get/'+AppConfig.projectId+'/'+PatrolSchedule.getMonday(new Date())+'/'+PatrolSchedule.getSunday(new Date())),WebAPI.get('/patrol/point/getList/'+AppConfig.projectId)).done(function(userAjax,pathAjax,missionAjax,pointAjax){userAll=userAjax[0].data;pathAll=pathAjax[0].data;missionAll=missionAjax[0].data;pointAll=pointAjax[0].data;if(_this.file.enable){_this.file.write([{type:'userAll',data:userAll},{type:'pathAll',data:pathAll},{type:'missionAll',data:missionAll},{type:'pointAll',data:pointAll}],function(store){(store.userAll.status=='success')&&console.log('人员信息缓存成功');(store.pathAll.status=='success')&&console.log('路径信息缓存成功');(store.missionAll.status=='success')&&console.log('排班信息缓存成功');(store.pointAll.status=='success')&&console.log('点位信息缓存成功');callback();});}else{callback();}
if(window.plugins){window.plugins.toast.show('数据同步成功','short','bottom');}}).fail(function(userAjax,pathAjax,missionAjax,pointAjax){_this.updateFromFile(callback);window.plugins.toast.show('数据同步失败','short','bottom');}).always(function(){SpinnerControl.hide();})}else{$.when(WebAPI.get('/patrol/executor/getList/'+AppConfig.projectId),WebAPI.get('/patrol/path/getAll/'+AppConfig.projectId),WebAPI.get('/patrol/mission/get/'+AppConfig.projectId+'/'+PatrolSchedule.getMonday(new Date())+'/'+PatrolSchedule.getSunday(new Date())),WebAPI.get('/patrol/point/getList/'+AppConfig.projectId),WebAPI.post('/patrol/log/saveMulti',_this.patrolLog)).done(function(userAjax,pathAjax,missionAjax,pointAjax,patrolLogAjax){userAll=userAjax[0].data;pathAll=pathAjax[0].data;missionAll=missionAjax[0].data;pointAll=pointAjax[0].data;if(_this.file.enable){_this.file.write([{type:'userAll',data:userAll},{type:'pathAll',data:pathAll},{type:'missionAll',data:missionAll},{type:'pointAll',data:pointAll}],function(store){(store.userAll.status=='success')&&console.log('人员信息缓存成功');(store.pathAll.status=='success')&&console.log('路径信息缓存成功');(store.missionAll.status=='success')&&console.log('排班信息缓存成功');(store.pointAll.status=='success')&&console.log('点位信息缓存成功');if(patrolLogAjax[1]=='success'&&_this.checkLog(patrolLogAjax[0].data)){_this.saveUpdateLog(true,{patrol:[].concat(_this.patrolLog),type:'net',info:'上传数据成功'});if(window.plugins){window.plugins.toast.show('上传数据成功','short','bottom');}
curSet={};localStorage.removeItem('curSet');_this.patrolLog=[];_this.file.write([{type:'patrolLog',data:[]}]);callback();}else{_this.saveUpdateLog(false,{patrol:[].concat(_this.patrolLog),type:'net',info:'上传数据失败'});_this.file.write([{type:'patrolLog',data:_this.patrolLog}],function(store){if(store.patrolLog&&store.patrolLog.status=='success'){curSet={};localStorage.removeItem('curSet');console.log('记录缓存成功');window.plugins&&window.plugins.toast.show('记录缓存成功','short','bottom');}else{console.log('记录缓存失败');window.plugins&&window.plugins.toast.show('记录缓存失败，请于联网状态下及时上传。','short','bottom');}
SpinnerControl.hide();callback();});if(window.plugins){window.plugins.toast.show('上传数据失败','short','bottom');}}});}else{if(patrolLogAjax[1]=='success'&&_this.checkLog(patrolLogAjax[0].data)){_this.saveUpdateLog(true,{patrol:[].concat(_this.patrolLog),curSet:$.extend(true,{},curSet)});if(window.plugins){window.plugins.toast.show('上传数据成功','short','bottom');}
curSet={};localStorage.removeItem('curSet');_this.file.write([{type:'patrolLog',data:[]}]);}else{_this.saveUpdateLog(false);if(window.plugins){window.plugins.toast.show('上传数据失败','short','bottom');}}
callback();}}).fail(function(){window.plugins.toast.show('上传数据失败','short','bottom');_this.updateFromFile(callback)}).always(function(){SpinnerControl.hide();})}},checkLog:function(arrLog){if(arrLog instanceof Array&&arrLog.length>0){for(var i=0;i<arrLog.length;i++){if(!arrLog[i])return false;}
return true;}else{return false;}}};return DataManager})();var PatrolSchedule=(function(){function getMonday(date){var monday=date;if(monday.getDay()===0){monday=monday.setDate(monday.getDate()-6);}else{monday=monday.setDate(monday.getDate()+1-monday.getDay());}
return new Date(monday).format('yyyy-MM-dd');}
function getSunday(date){var sunday=date;if(sunday.getDay()===0){sunday=date;}else{sunday=sunday.setDate(sunday.getDate()+7-sunday.getDay());}
return new Date(sunday).format('yyyy-MM-dd');}
return{getMonday:getMonday,getSunday:getSunday};})();var LogScreen=(function(){function LogScreen(){this.store=[];}
LogScreen.navOptions={top:'<span id="spClearCache" class = "zepto-ev topNavLeft topTool">\
            <span id="btnClearCache" class = "glyphicon glyphicon-trash" style="margin-right: 5px;top:0"></span>\
            <span>清除缓存</span>\
        </span>\
        <span id="btnUpdate" class="topNavRight zepto-ev glyphicon glyphicon-refresh"></span>',bottom:false,backDisable:false};LogScreen.prototype={show:function(){var _this=this;WebAPI.get('/static/app/PatrolApp/views/screen/logScreen.html').done(function(html){ElScreenContainer.innerHTML=html;_this.initNav();dataManager.file.read([{type:'updateLog'}],function(store){if(store.updateLog&&store.updateLog.status=='success'){_this.store=store.updateLog.result.reverse();_this.init();}});});},init:function(){this.initFilter();this.initLog();},initFilter:function(){},initLog:function(){this.logCtn=document.getElementById('ctnLog');this.logCtn.innerHTML='';var itemDom;for(var i=0;i<this.store.length;i++){itemDom=this.createLogItem(this.store[i]);if(!itemDom)continue;this.logCtn.appendChild(itemDom);}},createLogItem:function(log){if(!log)log={};var item=document.createElement('div');item.className='divLogItem';var spTime=document.createElement('span');spTime.className='spTime';if(log.time)spTime.textContent=new Date(log.time).format('yyyy-MM-dd HH:mm:ss');item.appendChild(spTime);var spInfo=document.createElement('span');spInfo.className='spInfo';if(log.info)spInfo.textContent=log.info;item.appendChild(spInfo);if(!(log.patrol&&log.patrol instanceof Array&&log.patrol.length>0))return;var patrol;for(var i=0;i<log.patrol.length;i++){patrol=this.createLogItemDetail(log.patrol[i]);if(patrol)item.appendChild(patrol);}
if(log.success===true)item.className+=' success';if(log.success===false)item.className+=' fail';return item;},createLogItemDetail:function(detail){var dom=document.createElement('div');dom.className='divPatrol';var spUser=document.createElement('span');spUser.className='spUser';if(detail.userName)spUser.textContent='执行者：'+detail.userName;dom.appendChild(spUser);var spPath=document.createElement('span');spPath.className='spPath';if(detail.pathName)spPath.textContent='路线：'+detail.pathName;dom.appendChild(spPath);var spRelateTime=document.createElement('span');spRelateTime.className='spRelateTime';dom.appendChild(spRelateTime);var spPlanTime=document.createElement('span');spPlanTime.className='spPlanTime';if(detail.planDate)spPlanTime.textContent='计划时间：'+detail.planDate;spRelateTime.appendChild(spPlanTime);var spStartTime=document.createElement('span');spStartTime.className='spStartTime';if(detail.startTime)spStartTime.textContent='执行时间：'+new Date(detail.startTime).format('yyyy-MM-dd HH:mm:ss');spRelateTime.appendChild(spStartTime);var spEndTime=document.createElement('span');spEndTime.className='spEndTime';if(detail.endTime)spEndTime.textContent='~'+new Date(detail.endTime).format('yyyy-MM-dd HH:mm:ss');spRelateTime.appendChild(spEndTime);var spStatus=document.createElement('span');spStatus.className='spStatus';if(detail.path)spStatus.textContent='节点完成情况：'+this.getMissionStatus(detail.path);dom.appendChild(spStatus);var spVersion=document.createElement('span');spVersion.className='spVersion';if(detail.version)spVersion.textContent='版本：'+detail.version;dom.appendChild(spVersion);return dom;},getMissionStatus:function(point){if(!(point instanceof Array))return'路径结构错误';for(var i=0;i<point.length;i++){if(point[i].error==2){return'部分完成'}}
return'全部完成'},initNav:function(){var _this=this;$('#spClearCache').off('tap').on('tap',function(){infoBox.confirm('清除缓存将会清除一切巡更日志以及缓存文件，如确定，之后请重进App。',function(){_this.clearCache(Init);});});$('#btnUpdate').off('tap').on('tap',function(){if(!_this.store)return;WebAPI.post('/patrol/log/saveOperateLog',_this.store).done(function(){window.plugins.toast.show('操作日志上传成功','short','bottom');})})},clearCache:function(callback){localStorage.clear();if(dataManager.file.enable){dataManager.file.write([{type:'userAll',data:[]},{type:'pathAll',data:[]},{type:'pointAll',data:[]},{type:'missionAll',data:[]},{type:'patrolLog',data:[]},{type:'updateLog',data:[]}],function(store){dataManager.patrolLog=[];callback();});}else{dataManager.patrolLog=[];callback();}},};return LogScreen;})();var UserSelScreen=(function(){var _this;function UserSelScreen(data){_this=this;_this.userDiv={};}
UserSelScreen.navOptions={top:'<span id="spClearCache" class = "zepto-ev topNavLeft topTool">\
        <span id="btnClearCache" class = "glyphicon glyphicon-file" style="margin-right: 5px;top:0"></span>\
        <span class = "version">'+AppConfig.version+'</span>\
        </span>\
        <span class="topNavInput spSearch"><input class="iptSearch" id="iptUserSearch"></span>\
        <span id="btnUpdate" class="topNavRight zepto-ev glyphicon glyphicon-refresh"></span>',bottom:false,backDisable:true,module:'project'};UserSelScreen.prototype={show:function(){$.ajax({url:'static/app/PatrolApp/views/screen/userSelScreen.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;dataManager.update(_this.init);dataManager.attachNetworkEvent(_this.init);})},init:function(){_this.initNav();if(!curSet)curSet={};if(typeof userAll!='undefined'){_this.initUserData(userAll);_this.initTopTool();_this.initUserList();}else{WebAPI.get('/patrol/executor/getList/'+AppConfig.projectId).done(function(result){userAll=result.data;_this.initUserData(result.data);_this.initTopTool();_this.initUserList();})}},initNav:function(){$('#btnUpdate').off('tap').on('tap',function(){dataManager.update(_this.init);});$('#spClearCache').off('tap').on('tap',function(){router.to({typeClass:LogScreen})});$('#iptUserSearch').off('input propertychange').on('input propertychange',function(e){var target=$(e.currentTarget).val();var $divUser=$('.divUser ');if(target){$divUser.hide();for(var i=0;i<$divUser.length;i++){if($divUser[i].innerText.toLowerCase().indexOf(target.toLowerCase())>-1){$divUser.eq(i).show();}}}else{$divUser.show();}});},initUserData:function(arrUser){_this.userDiv={};for(var i=0;i<arrUser.length;i++){if(typeof _this.userDiv[arrUser[i].department]=='undefined'){_this.userDiv[arrUser[i].department]=[];}
_this.userDiv[arrUser[i].department].push(arrUser[i])}},initTopTool:function(){var $btnToolGrp=$('#ulBtnDepart').html('');var $userList=$('#ctnUserList').html('');var btn;btn=document.createElement('li');btn.className='liBtnDepart zepto-ev selected';btn.setAttribute('depart','all');btn.textContent='全部';$btnToolGrp.prepend(btn);for(var depart in _this.userDiv){btn=document.createElement('li');btn.className='liBtnDepart zepto-ev';btn.setAttribute('depart',depart);btn.textContent=depart;$btnToolGrp.append(btn);}
$btnToolGrp.off('tap').on('tap','.liBtnDepart',function(e){$btnToolGrp.find('>div').removeClass('selected');$(e.currentTarget).addClass('selected');var depart=e.currentTarget.getAttribute('depart');if(depart=='all'){$userList.find('>div').show();}else{$userList.find('>div').hide();$userList.find('[depart="'+depart+'"]').show();}})},initUserList:function(){var $userList=$('#ctnUserList').html('');var strUser;var $user;for(var depart in _this.userDiv){for(var i=0;i<_this.userDiv[depart].length;i++){strUser='\
                    <div class="divUser zepto-ev row" id="'+_this.userDiv[depart][i]['_id']+'" depart="'+_this.userDiv[depart][i].department+'">\
                        <div class="divUserName col-xs-6">'+_this.userDiv[depart][i].name+'\
                        </div>\
                        <div class="divUserDepart col-xs-6">'+_this.userDiv[depart][i].department+'\
                        </div>\
                    ';$userList.append(strUser);}}
$userList.off('tap').on('tap','.divUser',function(e){for(var i=0;i<_this.userDiv[e.currentTarget.getAttribute('depart')].length;i++){if(e.currentTarget.id==_this.userDiv[e.currentTarget.getAttribute('depart')][i]['_id']){curSet.user=_this.userDiv[e.currentTarget.getAttribute('depart')][i];break;}}
router.to({typeClass:PathSelScreen})});_this.initJump()},initJump:function(){if(curSet.log){$('#ctnJump').show();}
$('#btnJump').off('touchstart').on('touchstart',function(){if(curSet.ptCompleteIndex+1>=curSet.path.path.length){router.to({typeClass:MissionResultScreen})}else{router.to({typeClass:PointScreen})}});$('#btnCancel').off('touchstart').on('touchstart',function(){localStorage.removeItem('curSet');curSet={};$('#ctnJump').hide();})},clearCache:function(callback){localStorage.clear();if(dataManager.file.enable){dataManager.file.write([{type:'userAll',data:[]},{type:'pathAll',data:[]},{type:'pointAll',data:[]},{type:'missionAll',data:[]},{type:'patrolLog',data:[]}],function(store){dataManager.patrolLog=[];callback();});}else{dataManager.patrolLog=[];callback();}},close:function(){dataManager.removeNetworkEvent();dataManager.clearPage();}};return UserSelScreen;})();var PathSelScreen=(function(){var _this;function PathSelScreen(data){_this=this;this.completeLog={};}
PathSelScreen.navOptions={top:'<span class="topNavTitle">选择路径</span>',bottom:false,backDisable:false,module:'project'};PathSelScreen.prototype={show:function(){$.ajax({url:'static/app/PatrolApp/views/screen/pathSelScreen.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;_this.initCompleteLog();_this.init();_this.attachEvent();})},init:function(){if(typeof pathAll=='undefined'||$.isEmptyObject(pathAll)){WebAPI.get('/patrol/path/getAll/'+AppConfig.projectId).done(function(result){pathAll=result.data;_this.getPoint();});}else{_this.getPoint();}},attachEvent:function(){var _this=this;var $pathList=$('#ctnPathList');var $pathRecList=$('#ctnPathRecList');var $recommend,$target,$planInDivRec;var pathId,recommendText='';$pathList.off('click').on('click','.divPlan',function(e){$target=$(e.currentTarget);if($target.hasClass('disabled')){window.plugins&&window.plugins.toast.show('该任务已过期','short','center');return;}
pathId=$target.parentsUntil('#ctnPathList','.divPath')[0].dataset.id;if($target.hasClass('complete')){window.plugins&&window.plugins.toast.show('该任务已完成','short','center');return;}
if($target.hasClass('recommend')){_this.startPlan(pathId,$target[0].dataset.status,$target[0].dataset.mission,$target[0].dataset.time);}else{$planInDivRec=$pathRecList.find('#rec_'+pathId);if($planInDivRec.length>0){$recommend=$planInDivRec.find('.recommend');recommendText='推荐';}else{$recommend=$target.siblings('.recommend');}
if($recommend.length>0){if($recommend[0].dataset.status==2){recommendText='延误';}
window.plugins&&window.plugins.toast.show('请优先完成该路线'+$recommend.find('.spPlanTime').text()+recommendText+'的任务','short','center');return;}
_this.startPlan(pathId,$target[0].dataset.status,$target[0].dataset.mission,$target[0].dataset.time);}});$pathRecList.off('click').on('click','.divPlan',function(e){$target=$(e.currentTarget);pathId=$target.parentsUntil('#ctnPathList','.divPath')[0].dataset.id;if($target.hasClass('recommend')){_this.startPlan(pathId,$target[0].dataset.status,$target[0].dataset.mission,$target[0].dataset.time);}else{$recommend=$target.siblings('.recommend');if($recommend.length>0){window.plugins&&window.plugins.toast.show('请优先完成该路线'+$recommend.find('.spPlanTime').text()+'的推荐任务','short','center');return;}
_this.startPlan(pathId,$target[0].dataset.status,$target[0].dataset.mission,$target[0].dataset.time);}})},startPlan:function(pathId,status,missionId,planTime){for(var i=0;i<pathAll.length;i++){if(pathAll[i]['_id']==pathId){curSet.path=pathAll[i];}}
curSet.ptCompleteIndex=-1;curSet.ptIndex=0;if(status){curSet.missionState=status;}
curSet.missionId=missionId;curSet.planTime=planTime;curSet.log={};curSet.log.startTime=new Date().format('yyyy-MM-dd HH:mm:ss');curSet.log.planDate=new Date(planTime).format('yyyy-MM-dd HH:mm:ss');curSet.log.planTime=new Date(planTime).format('HH:mm');curSet.log.missionId=curSet.missionId;curSet.log.executorId=curSet.user['_id'];curSet.log.pathId=curSet.path['_id'];curSet.log.path=[];curSet.log.projId=AppConfig.projectId;curSet.log.pathName=curSet.path.name;curSet.log.userName=curSet.user.name;curSet.log.version=AppConfig.version;for(var i=0;i<curSet.path.path.length;i++){curSet.log.path[i]={'_id':curSet.path.path[i]['_id'],'time':'','name':curSet.path.path[i]['name'],'msg':'','error':2,'arrPic':[],'gps':[]};}
router.to({typeClass:PointScreen})},getMission:function(){if(typeof missionAll=='undefined'||$.isEmptyObject(missionAll)){WebAPI.get('/patrol/mission/get/'+AppConfig.projectId).done(function(result){missionAll=result.data;_this.initMission();});}else{_this.initMission();}},getPoint:function(){if(typeof pointAll=='undefined'||$.isEmptyObject(pointAll)){WebAPI.get('/patrol/point/getList/'+AppConfig.projectId).done(function(result){pointAll=result.data;_this.getMission();});}else{_this.getMission();}},initCompleteLog:function(){this.completeLog=JSON.parse(localStorage.getItem('completeLog'));if(!this.completeLog)this.completeLog={};if($.isEmptyObject(this.completeLog))return;var now=new Date();var arrPath=Object.keys(this.completeLog);arrPath.forEach(function(pathId){var arrPlan=_this.completeLog[pathId];for(var i=arrPlan.length-1;i>=0;i--){if((now-new Date(arrPlan[i]))>604800000){_this.completeLog[pathId]=_this.completeLog[pathId].slice(i+1);break;}}
if(_this.completeLog[pathId].length==0)delete _this.completeLog[pathId];})},initMission:function(){var arrPathId;for(var i=0;i<missionAll.length;i++){arrPathId=Object.keys(missionAll[i]['option']);for(var j=0;j<arrPathId.length;j++){this.initPath(arrPathId[j],missionAll[i]['option'][arrPathId[j]],missionAll[i])}}},initPath:function(pathId,planInfo,missionInfo){var pathListDom=document.getElementById('ctnPathList');var pathDom,pathInfo,planDom;pathDom=document.getElementById(pathId);if(!pathDom){pathDom=document.createElement('div');pathDom.className='divPath';pathDom.id=pathId;pathDom.dataset.id=pathId;pathInfo=this.getPathInfoById(pathId);if(!pathInfo)return false;var label=document.createElement('label');label.textContent=pathInfo.name;pathDom.appendChild(label);planDom=this.initPlan(planInfo,pathInfo,missionInfo);if(!planDom)return false;pathDom.appendChild(planDom);pathListDom.appendChild(pathDom)}else{pathInfo=this.getPathInfoById(pathId);if(!pathInfo)return false;planDom=this.initPlan(planInfo,pathInfo,missionInfo);if(!planDom)return false;pathDom.appendChild(planDom);}},getPathInfoById:function(id){for(var i=0;i<pathAll.length;i++){if(pathAll[i]['_id']==id){return pathAll[i]}}
return false;},initPlan:function(planInfo,pathInfo,missionInfo){var ctnPlan=document.createElement('div');ctnPlan.className='ctnPlan';var divPlan,planStatus;var arrPlanTime=Object.keys(planInfo);var arrPlanStatus=[];for(var i=0;i<missionInfo.interval;i++){for(var j=0;j<arrPlanTime.length;j++){if(!planInfo[arrPlanTime[j]])continue;if(!planInfo[arrPlanTime[j]][i]||planInfo[arrPlanTime[j]][i]!=curSet.user['_id'])continue;planStatus=this.getPlanStatus(arrPlanTime[j],i,pathInfo,missionInfo,ctnPlan);if(planStatus.status<0)continue;arrPlanStatus.push(planStatus.status);divPlan=this.createPlanDom(arrPlanTime[j],planStatus,arrPlanStatus);divPlan.dataset.mission=missionInfo['_id'];divPlan.dataset.time=planStatus.planTime;if(planStatus.status==0){this.insertRecPlan(pathInfo,divPlan);}else{ctnPlan.appendChild(divPlan);}}}
if(arrPlanStatus.indexOf(0)>=0){$('#rec_'+pathInfo['_id']).find('.divPlan').first().addClass('recommend')}else{if(arrPlanStatus.indexOf(1)<0){var lastIndexOfDelay=arrPlanStatus.lastIndexOf(2);if(lastIndexOfDelay>=0){$(ctnPlan.children[lastIndexOfDelay]).removeClass('disabled').addClass('recommend').find('.spStatusText').text('（延误）')}}else{var firstIndexAhead=arrPlanStatus.indexOf(3);if(firstIndexAhead>=0){$(ctnPlan.children[firstIndexAhead]).addClass('recommend');}}}
if(!ctnPlan.hasChildNodes())return false;return ctnPlan;},createPlanDom:function(time,status){var divPlan=document.createElement('div');divPlan.className='divPlan';divPlan.dataset.status=status.status;var spTime=document.createElement('span');spTime.className='spPlanTime';if(status.interval=='1d'){spTime.textContent=time;}else if(status.interval=='1w'){spTime.textContent=status.startTime+' ~ '+status.endTime;}else if(status.interval=='nextD'){spTime.textContent=status.startTime+' ~ '+status.endTime;}
divPlan.appendChild(spTime);if(status.status==1){divPlan.className+=' complete';var spComplete=document.createElement('span');spComplete.className='spStatusIcon glyphicon glyphicon-ok';divPlan.appendChild(spComplete);}else if(status.status==2){var spStatusText=document.createElement('span');spStatusText.className='spStatusText';spStatusText.textContent='（未完成）';divPlan.className+=' disabled';divPlan.appendChild(spStatusText);}
return divPlan;},insertRecPlan:function(pathInfo,planDom){var pathRecList=document.getElementById('ctnPathRecList');$(pathRecList).addClass('active');var pathRecDom=document.getElementById('rec_'+pathInfo['_id']);var ctnPlan;if(!pathRecDom){pathRecDom=document.createElement('div');pathRecDom.className='divPath divRecPath';pathRecDom.id='rec_'+pathInfo['_id'];pathRecDom.dataset.id=pathInfo['_id'];var label=document.createElement('label');label.textContent=pathInfo.name;ctnPlan=document.createElement('div');ctnPlan.className='ctnPlan';pathRecDom.appendChild(label);pathRecDom.appendChild(ctnPlan);pathRecList.appendChild(pathRecDom);ctnPlan.appendChild(planDom);}else{var earlyPlan;ctnPlan=pathRecDom.querySelector('.ctnPlan');for(var i=0;i<ctnPlan.children.length;i++){if(new Date(planDom.dataset.time)<new Date(ctnPlan.children[i].dataset.time)){earlyPlan=ctnPlan.children[i];break;}}
ctnPlan.insertBefore(planDom,earlyPlan)}},getPlanStatus:function(time,index,pathInfo,missionInfo){var planTime=new Date(new Date(missionInfo.startTime).getTime()+index*86400000).format('yyyy-MM-dd '+time);var planTimeInDate=new Date(planTime);var timeRange=pathInfo.timeRange.split(' ');var beforeTime=parseFloat(timeRange[0]);var afterTime=parseFloat(timeRange[1]);isNaN(beforeTime)&&(beforeTime=-60);isNaN(afterTime)&&(afterTime=60);var status={};var startTime=new Date(planTimeInDate.getTime()+beforeTime*60000);var endTime=new Date(planTimeInDate.getTime()+afterTime*60000);var interval=(planTimeInDate-new Date())/60000;if(afterTime-beforeTime<1440&&(startTime.format('yyyy-MM-dd')!=new Date().format('yyyy-MM-dd')&&endTime.format('yyyy-MM-dd')!=new Date().format('yyyy-MM-dd'))){status={interval:'1d',status:-1,planTime:planTimeInDate};return status;}
if(this.completeLog[pathInfo['_id']]&&this.completeLog[pathInfo['_id']].indexOf(planTime)>=0){status.status=1;}else{if(interval<beforeTime){status.status=2}else if(interval>afterTime){status.status=3;}else{status.status=0;}}
if(afterTime-beforeTime>=1440){status.interval='1w';status.startTime=startTime.format('yyyy-MM-dd HH:mm');status.endTime=endTime.format('yyyy-MM-dd HH:mm');}else{if(startTime.format('yyyy-MM-dd')!=new Date().format('yyyy-MM-dd')&&endTime.format('yyyy-MM-dd')==new Date().format('yyyy-MM-dd')){status.startTime=startTime.format('yyyy-MM-dd HH:mm');status.endTime=endTime.format('yyyy-MM-dd HH:mm');status.interval='nextD';}else{status.interval='1d';}}
status.planTime=planTime;return status;},searchUserById:function(userId){for(var i=0;i<userAll.length;i++){if(userAll[i]['_id']==userId)return userAll[i].name;}},close:function(){}};return PathSelScreen;})();var MissionSelScreen=(function(){var _this;function MissionSelScreen(data){_this=this;_this.opt=data?data:{};_this.mission=undefined;}
MissionSelScreen.navOptions={top:'<span class="topNavTitle">选择任务</span>',bottom:false,backDisable:false,module:'project'};MissionSelScreen.prototype={show:function(){$.ajax({url:'static/app/PatrolApp/views/screen/missionSelScreen.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;_this.init();})},init:function(){WebAPI.post('/patrol/mission/get/'+AppConfig.projectId).done(function(result){_this.mission=result.data;_this.initMissionList();});},initMissionList:function(){var $missionList=$('#ctnMissionList');var pathMission=_this.mission.data[_this.opt.path['_id']];var mission,time,executor;var now=new Date();if(pathMission){for(var plan in pathMission){mission=document.createElement('div');mission.className='divMission zepto-ev';mission.id=pathMission[plan];time=document.createElement('span');time.className='spTime';time.textContent='该任务每'+_this.mission.interval+'天执行一次，每次预定从'+plan+'开始';mission.appendChild(time);executor=document.createElement('span');executor.className='spExecutor';executor.textContent='该任务由';for(var i=0;i<pathMission[plan].length;i++){executor.textContent+=' '+_this.searchUserById(pathMission[plan][i])+' ';}
executor.textContent+='执行';mission.appendChild(executor);$missionList.append(mission);}}else{mission=document.createElement('div');mission.textContent='当前线路上没有您需要完成的任务，请重新选择';$missionList.append(mission)}
$missionList.on('tap','.divMission',function(e){_this.opt.ptIndex=0;router.to({typeClass:PointScreen,data:_this.opt})})},searchUserById:function(userId){for(var i=0;i<_this.opt.user.length;i++){if(_this.opt.user[i]['_id']==userId)return _this.opt.user[i].name;}},close:function(){}};return MissionSelScreen;})();var PointScreen=(function(){var _this;function PointScreen(data){_this=this;_this.opt=data?data:{};_this.isDel=false;_this.gpsOpt={timeout:AppConfig.gpsTime};_this.curSet={};}
PointScreen.navOptions={top:'<span class="topNavTitle">检查节点中</span>\
        <span id="btnPhoto" class="topNavRight zepto-ev glyphicon glyphicon-earphone"></span>\
        <span id="btnPtList" class="topNavRight zepto-ev glyphicon glyphicon-th-list"></span>',bottom:false,backDisable:true,module:'project'};PointScreen.prototype={show:function(){$.ajax({url:'static/app/PatrolApp/views/screen/pointScreen.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;_this.init();})},init:function(){localStorage.setItem('curSet',JSON.stringify(curSet));_this.initNav();_this.initContent();_this.initPoint();_this.initScan();_this.initSkip();_this.initJudge();steps.start();},initContent:function(){if(typeof _this.opt.ptIndex!='undefined'&&_this.opt.ptIndex!='null')curSet.ptIndex=_this.opt.ptIndex;if(!(curSet.path&&curSet.path.path[curSet.ptIndex])){curSet.ptCompleteIndex=curSet.path.path.length-1;router.to({typeClass:MissionResultScreen});return}
var isFind=false;for(var i=0;i<pointAll.length;i++){if(pointAll[i]['_id']==curSet.path.path[curSet.ptIndex]['_id']){curSet.point=$.extend({},pointAll[i]);isFind=true;break;}}
if(!isFind){_this.isDel=true;var id=ObjectId();curSet.point={'_id':id,'content':'该节点已删除','isDel':true};}},initPoint:function(){var $ctnPoint=$('#boxPoint');var guideLine,statusTip,point,content;if(curSet.path.path[curSet.ptIndex-1]){guideLine=document.createElement('span');guideLine.className='spGuideLine';var prePoint=document.createElement('div');prePoint.className='divPtTip divPrePt';if(!curSet.path.path[curSet.ptIndex-1].name){prePoint.textContent='该节点已删除';}else{prePoint.textContent='上一节点：'+curSet.path.path[curSet.ptIndex-1].name;statusTip=document.createElement('span');switch(curSet.path.path[curSet.ptIndex-1].error){case 0:statusTip.className='glyphicon glyphicon-ok spStatusTip';prePoint.className+=' statusOk';break;case 1:statusTip.className='glyphicon glyphicon-remove spStatusTip';prePoint.className+=' statusErr';break;case 2:statusTip.className='glyphicon glyphicon-forward spStatusTip';prePoint.className+=' statusSkip';break;}
prePoint.appendChild(statusTip);}
$ctnPoint.append(prePoint);$ctnPoint.append(guideLine);}
point=document.createElement('div');if(_this.isDel){point.textContent='该节点已删除！';$ctnPoint.append(point);content=document.createElement('div');content.className='divContent';content.textContent='请跳过该节点！';$ctnPoint.append(content);}else{point.textContent='请到'+curSet.path.path[curSet.ptIndex].name;$ctnPoint.append(point);content=document.createElement('div');content.className='divContent';content.textContent='要求：'+curSet.point.content;$ctnPoint.append(content);}
if(curSet.path.path[curSet.ptIndex+1]){guideLine=document.createElement('span');guideLine.className='spGuideLine';$ctnPoint.append(guideLine);var nextPoint=document.createElement('div');nextPoint.className='divPtTip divNextPt';if(!curSet.path.path[curSet.ptIndex+1].name){nextPoint.textContent='该节点已删除！';}else{nextPoint.textContent='下一节点：'+curSet.path.path[curSet.ptIndex+1].name;}
$ctnPoint.append(nextPoint);}},initScan:function(){if(curSet.path.path[curSet.ptIndex].isScannad==true){$('#ctnScan').hide();$('#ctnJudge').show();return;}
if(_this.isDel){$('#btnBarCode').hide();return}
$('#btnBarCode').on('tap',function(){if(typeof cordova!='undefined'){cordova.plugins.barcodeScanner.scan(function(result){console.log("We got a barcode\n"+"Result: "+result.text+"\n"+"Format: "+result.format+"\n"+"Cancelled: "+result.cancelled);if(curSet.point.codeQR==result.text){curSet.path.path[curSet.ptIndex].isScannad=true;localStorage.setItem('curSet',JSON.stringify(curSet));window.plugins.toast.show('二维码校对成功','short','center');}else{window.plugins.toast.show('二维码校对失败，请重新扫描','short','center');return;}
$('#ctnScan').hide();$('#ctnJudge').show();},function(error){console.log("Scanning failed: "+error);});}else{curSet.path.path[curSet.ptIndex].isScannad=true;localStorage.setItem('curSet',JSON.stringify(curSet));$('#ctnScan').hide();$('#ctnJudge').show();}})},initSkip:function(){$('#btnSkip').on('tap',function(){router.to({typeClass:PointInfoScreen,data:{state:2}});});},initJudge:function(){var _this=this;$('#btnPtRight').on('tap',function(){router.to({typeClass:PointInfoScreen,data:{state:0}})});$('#btnPtError').on('tap',function(){router.to({typeClass:PointInfoScreen,data:{state:1}})});},initNav:function(){$('#btnPtList').off('touchstart').on('touchstart',function(){router.to({typeClass:MissionResultScreen,data:{isToggle:true}})})},close:function(){}};return PointScreen})();var PointInfoScreen=(function(){var _this;function PointInfoScreen(data){_this=this;_this.opt=data?data:{};_this.gpsOpt={timeout:AppConfig.gpsTime};_this.curSet={};}
PointInfoScreen.navOptions={top:'<span class="topNavTitle">上传信息</span>\
        <span id="btnSure" class="topNavRight zepto-ev">确认</span>\
        <span id="btnPtList" class="topNavRight zepto-ev glyphicon glyphicon-th-list"></span>',bottom:false,backDisable:false,module:'project'};PointInfoScreen.prototype={show:function(){$.ajax({url:'static/app/PatrolApp/views/screen/pointInfoScreen.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;_this.init();})},init:function(){_this.initHis();_this.initNav();_this.initPhoto();_this.initPhotoEdit();_this.initComment();_this.initSure();},initHis:function(){if(curSet.log.path[curSet.ptIndex].msg){$('#iptComment').val(curSet.log.path[curSet.ptIndex].msg);}
for(var i=0;i<curSet.log.path[curSet.ptIndex].arrPic.length;i++){var divPhoto=document.createElement('div');var imgPhoto=document.createElement('img');imgPhoto.src=curSet.log.path[curSet.ptIndex].arrPic[i];imgPhoto.className="imgPhoto zepto-ev";divPhoto.className="divPhoto col-xs-4";divPhoto.appendChild(imgPhoto);$('#btnPhoto').before(divPhoto)}},initPhoto:function(){$('#btnPhoto').on('tap',function(e){if(navigator&&navigator.camera){var cameraOpt={destinationType:Camera.DestinationType.DATA_URL,targetHeight:$(window).height(),targetWidth:$(window).width(),quality:50};navigator.camera.getPicture(function(imgData){console.log('camera Success');var divPhoto=document.createElement('div');var imgPhoto=document.createElement('img');imgPhoto.src='data:image/jpeg;base64,'+imgData;imgPhoto.className="imgPhoto zepto-ev";divPhoto.className="divPhoto col-xs-4";divPhoto.appendChild(imgPhoto);$(e.currentTarget).before(divPhoto)},function(){console.log('camera Error')},cameraOpt)}else{var divPhoto=document.createElement('div');var imgPhoto=document.createElement('img');imgPhoto.className="imgPhoto zepto-ev";divPhoto.className="divPhoto col-xs-4";divPhoto.appendChild(imgPhoto);$(e.currentTarget).before(divPhoto)}})},initPhotoEdit:function(){$('#ctnPhoto').on('tap','img',function(e){$(e.currentTarget).parent().remove();})},getPhoto:function(){var $img=$('.divPhoto img');var arrImg=[];for(var i=0;i<$img.length;i++){arrImg.push($img[i].src)}
return arrImg;},initComment:function(){},initSure:function(){var _this=this;$('#btnSure').on('tap',function(){_this.curSet={ptIndex:curSet.ptIndex,path:curSet.path,planTime:curSet.planTime};if(navigator.geolocation){navigator.geolocation.getCurrentPosition(onGpsSuccess,onGpsFail,_this.gpsOpt);}else{onGpsSuccess();}
_this.savePtLog(_this.opt.state);});function onGpsSuccess(pos){if(!pos)pos={};_this.saveGpsInfo(pos.coords);}
function onGpsFail(){_this.saveGpsInfo();}},saveGpsInfo:function(pos){var _this=this;if(!(curSet&&curSet.path&&curSet.path._id==_this.curSet.path._id&&curSet.planTime==_this.curSet.planTime))return;if(pos){curSet.log.path[_this.curSet.ptIndex].gps=[pos.longitude,pos.latitude];}else{curSet.log.path[_this.curSet.ptIndex].gps=[];}},savePtLog:function(state){if(curSet.point.isDel){curSet.log.path[curSet.ptIndex]={'_id':curSet.point['_id'],'time':new Date().format('yyyy-MM-dd HH:mm:ss'),'name':'已删除','msg':'','error':-1,'arrPic':[],'isDel':true,'step':steps.show()};}else{curSet.log.path[curSet.ptIndex]={'_id':curSet.point['_id'],'time':new Date().format('yyyy-MM-dd HH:mm:ss'),'name':curSet.point['name'],'msg':$('#iptComment').val(),'error':state,'arrPic':_this.getPhoto(),'step':steps.show()};}
if(curSet.ptIndex==curSet.ptCompleteIndex+1){curSet.ptCompleteIndex++;}
curSet.path.path[curSet.ptIndex].isChecked=true;curSet.ptIndex=curSet.ptCompleteIndex+1;while(curSet.path.path[curSet.ptIndex]&&curSet.path.path[curSet.ptIndex].isChecked){curSet.ptCompleteIndex=curSet.ptIndex;curSet.ptIndex++;}
if(curSet.ptCompleteIndex+1==curSet.path.path.length){router.to({typeClass:MissionResultScreen})}else{router.to({typeClass:PointScreen})}
SpinnerControl.hide();},initNav:function(){$('#btnPtList').off('touchstart').on('touchstart',function(){router.to({typeClass:MissionResultScreen,data:{isToggle:true}})})},close:function(){}};return PointInfoScreen})();var MissionResultScreen=(function(){var _this;function MissionResultScreen(data){_this=this;_this.opt=data?data:{};}
MissionResultScreen.navOptions={top:'<span id="btnToggleBack" class="topNavLeft topTool zepto-ev">\
        <span>\
                    <svg style="width:24px;height:24px;" version="1.1" id="图形" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#ecf0f1" d="M137.728 509.12 598.656 48.128 564.032 13.44 65.472 512 564.032 1010.56 601.6 972.992Z"></path>\
                    </svg>\
                </span>\
        </span>\
        <span class="topNavTitle"></span>\
        <span class="topNavInput spSearch"><input class="iptSearch" id="iptPtSearch"></span>\
        <div id="btnHomePage" class="topNavRight zepto-ev"><span class="glyphicon glyphicon-home"></span></div>\
        <span id="btnSure" class="topNavRight zepto-ev"></span>',bottom:false,backDisable:true,module:'project'};MissionResultScreen.prototype={show:function(){$.ajax({url:'static/app/PatrolApp/views/screen/missionResultScreen.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;_this.init();})},init:function(){if(_this.opt.isToggle){$('#bntSure').hide();$('#btnToggleBack').css('display','-webkit-inline-flex');$('#btnHomePage').css('display','-webkit-inline-flex');_this.initResult();_this.initToggle();_this.initNav();}else{$('#btnSure').text('确认');_this.initResult();_this.initToggle();_this.initSure();localStorage.setItem('curSet',JSON.stringify(curSet));}},initResult:function(){var ctn=document.getElementById('ctnMissionResult');var point,status,info;var guideLine;for(var i=0;i<curSet.path.path.length;i++){point=document.createElement('div');point.id=curSet.path.path[i]['_id'];point.className='divPoint zepto-ev';info=document.createElement('span');info.className='spPtName';if(!curSet.path.path[i].name||curSet.path.path[i].name=='已删除'){info.textContent='该节点已删除';if(i!=0){guideLine=document.createElement('span');guideLine.className='spGuideLine';ctn.appendChild(guideLine);}
point.appendChild(info);}else{info.textContent=(i+1)+'.'+curSet.path.path[i].name;status=document.createElement('span');status.className='spPtStatus';if(curSet.path&&curSet.path.path[i]&&curSet.log.path[i]){switch(curSet.log.path[i].error){case 0:status.textContent='设备正常';status.className+=' statusOk';break;case 1:status.textContent='设备异常';status.className+=' statusErr';break;case 2:default:status.textContent='未检查';status.className+=' statusSkip';break;}}else{status.textContent='未检查';status.className+=' statusSkip';}
if(i!=0){guideLine=document.createElement('span');guideLine.className='spGuideLine';ctn.appendChild(guideLine);}
point.appendChild(info);point.appendChild(status);}
ctn.appendChild(point);}},initToggle:function(){var $divPoint=$('.divPoint');$('#ctnMissionResult').off('tap').on('tap','.divPoint',function(e){var index=$divPoint.index($(e.currentTarget));router.to({typeClass:PointScreen,data:{ptIndex:index}})})},initSure:function(){$('#btnSure').on('tap',function(){curSet.log.endTime=new Date().format('yyyy-MM-dd HH:mm:ss');if(navigator.geolocation){SpinnerControl.show();if(dataManager.file.enable){dataManager.saveUpdateLog(true,{patrol:[$.extend(true,{},curSet.log)],type:'confirm',info:'巡更日志保存确认'},function(){navigator.geolocation.getCurrentPosition(onGpsSuccess,onGpsFail,{timeout:AppConfig.gpsTime});});}else{navigator.geolocation.getCurrentPosition(onGpsSuccess,onGpsFail,{timeout:AppConfig.gpsTime});}}else{onGpsSuccess();}});function onGpsSuccess(pos){for(var i=0;i<curSet.log.path.length;i++){if(curSet.log.path[i].error==2){curSet.log.state=0;break;}}
if(pos){curSet.log.gps=[pos.coords.longitude,pos.coords.latitude];}else{curSet.log.gps=[];}
if(navigator.connection){if(navigator.connection.type=='none'){curSet.log.isOnline=0;}else{curSet.log.isOnline=1;}}else{curSet.log.isOnline=1;}
curSet.ptCompleteIndex=curSet.path.path.length;localStorage.setItem('curSet',JSON.stringify(curSet));_this.setCompleteLog();router.to({typeClass:UserSelScreen});SpinnerControl.hide();}
function onGpsFail(){onGpsSuccess();}},setCompleteLog:function(){var completeLog=JSON.parse(localStorage.getItem('completeLog'));if(!completeLog)completeLog={};if(!$.isEmptyObject(completeLog)){var now=new Date();var arrPath=Object.keys(completeLog);arrPath.forEach(function(pathId){var arrPlan=completeLog[pathId];for(var i=arrPlan.length-1;i>=0;i--){if((now-new Date(arrPlan[i]))>604800000){completeLog[pathId]=completeLog[pathId].slice(i+1);break;}}
if(completeLog[pathId].length==0)delete completeLog[pathId];});}
var completePath=completeLog[curSet.path['_id']];if(completePath instanceof Array){completePath.push(curSet.planTime)}else{completePath=[curSet.planTime]}
completeLog[curSet.path['_id']]=completePath;localStorage.setItem('completeLog',JSON.stringify(completeLog))},initNav:function(){$('#btnToggleBack').off('tap').on('tap',function(){router.to({typeClass:PointScreen,data:{ptIndex:curSet.ptIndex}})});$('#btnHomePage').off('touchstart').on('touchstart',function(){$('#ctnJump').show();$('#btnJump').off('touchstart').on('touchstart',function(){localStorage.removeItem('curSet');curSet={};router.to({typeClass:UserSelScreen})});$('#btnCancel').off('touchstart').on('touchstart',function(){$('#ctnJump').hide();});});$('.iptSearch').off('input propertychange').on('input propertychange',function(e){$('#ulProjectList').html('');var target=$(e.currentTarget).val();var $divPt=$('.divPoint');var $guideLine=$('.spGuideLine');if(target){$divPt.hide();$guideLine.hide();for(var i=0;i<$divPt.length;i++){if($divPt[i].innerText.toLowerCase().indexOf(target.toLowerCase())>-1){$divPt.eq(i).show();}}}else{$divPt.show();$guideLine.show();}});},close:function(){}};return MissionResultScreen})();var AdminConfigure=(function(){var _this;function AdminConfigure(){_this=this;}
AdminConfigure.navOptions={top:'<span class="topNavTitle">配置</span>',bottom:true,backDisable:true,module:'project'};AdminConfigure.prototype={show:function(){$.ajax({url:'static/app/PatrolApp/views/screen/adminConfigure.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;_this.init();})},init:function(){_this.initBtnToggle();},initBtnToggle:function(){$('.btnToggle').on('tap',function(e){if($(e.currentTarget).hasClass('off')){$(e.currentTarget).removeClass('off').addClass('on')}else{$(e.currentTarget).removeClass('on').addClass('off')}})}};return AdminConfigure;})();