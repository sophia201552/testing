var ScreenManager=(function(){function ScreenManager(){}
ScreenManager.screenFlag='page';ScreenManager.root='#page=IndexScreen';ScreenManager.paneRoot="#page=PaneProjectSelector";ScreenManager.isListening=false;ScreenManager.setProjectSelector=function(ProjectSelector){if(typeof ProjectSelector==='function'){ScreenManager.projectSelector=new ProjectSelector();}};ScreenManager.Init=function(){I18n.fillArea($(".navbar"));};ScreenManager.show=function(){if(arguments.length===0){return;}
var screenClass=arguments[0];if(typeof screenClass!=='function'){return;}
if(ScreenManager.isListening){ScreenManager.applyGoTo.apply(null,arguments);}else{ScreenManager.applyScreen.apply(null,arguments);}};ScreenManager.applyGoTo=function(){var screenClass=arguments[0];if(!screenClass.name){alert(I18n.resource.common.NOT_FOUND_PAGE);return false;}
var paramObj={page:screenClass.name},paramList=ScreenManager._getFunctionParams(screenClass);for(var m=0,n=paramList.length;m<n;m++){if(typeof arguments[m+1]!=typeof undefined){paramObj[paramList[m]]=arguments[m+1];}}
ScreenManager.goTo(paramObj);};ScreenManager.applyScreen=function(){var screenClass=arguments[0];if(!screenClass){alert('Can\'t find the page.');return;}
if(ScreenCurrent){window.onresize=null;try{if(ScreenCurrent.close&&ScreenCurrent.close()===false){return;}}catch(e){console.warn(ScreenCurrent.constructor.name+' close 方法报错:'+e);}}
var screenObj=Object.create(screenClass.prototype);ScreenCurrent=(screenClass.apply(screenObj,Array.prototype.slice.call(arguments,1))||screenObj);if(ScreenCurrent.onresize)window.onresize=ScreenCurrent.onresize;ScreenCurrent.show();};ScreenManager._getFunctionParams=function(func){var STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg,ARGUMENT_NAMES=/([^\s,]+)/g,fnStr,result;fnStr=func.toString().replace(STRIP_COMMENTS,'');result=fnStr.slice(fnStr.indexOf('(')+1,fnStr.indexOf(')')).match(ARGUMENT_NAMES);if(result===null){result=[];}
return result;};ScreenManager._getHashParamsMap=function(){var list,map={};list=location.hash.substr(1).split('&');for(var m=0;m<list.length;m++){var item=list[m].split('=');map[item[0]]=_unserializeParams(item[1]);}
return map;};ScreenManager.getPageId=function(){var hashMap=ScreenManager._getHashParamsMap();var params;if(typeof hashMap.id!==typeof undefined){return hashMap.id;}
if(hashMap.reportId){return hashMap.reportId;}
if(typeof hashMap.options==='string'){params={};try{params=JSON.parse(window.decodeURIComponent(hashMap.options));}catch(e){}
return params.id;}
if(typeof hashMap.options==='object'&&hashMap.options){return hashMap.options.id;}};ScreenManager.loadProjectMenu=function(project,page_id){ScreenManager.projectSelector.initProject(project['id'],page_id);};ScreenManager.loadUserPanel=function(){$("#right-nav").show();};ScreenManager.screenChange=function(e){var paramsMap=ScreenManager._getHashParamsMap(),project;if(typeof paramsMap.projectId!==typeof undefined){AppConfig.projectId=parseInt(paramsMap.projectId);project=BEOPUtil.getProjectFromAppConfig(AppConfig.projectId);if(!project){alert.danger(I18n.resource.error.noPermission);return false;}
AppConfig.projectTimeFormat=project.time_format||0;}
var promise=$.Deferred();if(I18n&&I18n.resource){promise.resolve();}else{InitI18nResource().always(function(rs){I18n=new Internationalization(null,rs);promise.resolve();});}
promise.always(function(){var screen,currentPage,screenParamsNameList=[],screenParamsValueList=[];if(AppConfig.afterLogin){$('#navHeader').fadeIn();$('#indexMain').css({top:'53px'});}
if(project){AppConfig.projectEnName=project['name_en'];AppConfig.projectName=project['name_en'];if(location.hash!=ScreenManager.paneRoot&&!AppConfig.navItems){ScreenManager.loadProjectMenu(project,paramsMap.id);}else{ScreenManager.projectSelector.setMenuActive();}}
ScreenManager.loadUserPanel();currentPage=paramsMap[ScreenManager.screenFlag];if(currentPage){if(currentPage.indexOf('.')>0){screen=namespace(currentPage)}else{if(currentPage==='EnergyScreen_M'){currentPage='EnergyScreen';}
screen=window[currentPage]||namespace('observer.screens')[currentPage];}}else{console.error('无法识别的location hash! hash is '+location.hash);return true;}
if(screen&&typeof screen==='function'){screenParamsNameList=ScreenManager._getFunctionParams(screen);for(var m=0;m<screenParamsNameList.length;m++){var paramName=screenParamsNameList[m];if(typeof paramsMap[paramName]!=='undefined'){screenParamsValueList[m]=paramsMap[paramName];}else{screenParamsValueList[m]=undefined;}}
ScreenManager.applyScreen.apply(null,[screen].concat(screenParamsValueList));I18n.fillArea($('#navPane'));return false;}else{return true;}});};ScreenManager.goTo=function(pageInfo){var hashFlag='#',hashList=[];if(!pageInfo){return false;}
if(AppConfig.projectId){pageInfo['projectId']=AppConfig.projectId;}
if(pageInfo[ScreenManager.screenFlag]){hashList.push(ScreenManager.screenFlag+'='+pageInfo[ScreenManager.screenFlag]);}
for(var param in pageInfo){if(pageInfo.hasOwnProperty(param)){if(param!==ScreenManager.screenFlag){hashList.push(param+'='+_serializeParams(pageInfo[param]));}}}
if(location.hash===hashFlag+hashList.join('&')){Spinner&&Spinner.stop();}else{location.hash=hashFlag+hashList.join('&');}};ScreenManager.listen=function(){if("onhashchange"in window&&(!document.documentMode||document.documentMode>=8)){ScreenManager.isListening=true;window.onhashchange=ScreenManager.screenChange;ScreenManager.detectAnchorHash();if(location.hash===''){if(AppConfig.afterLogin){window.addEventListener('load',function(){location.hash=ScreenManager.paneRoot;ScreenManager.projectSelector.show();},false);}else{location.hash=ScreenManager.root;}}else{if(location.hash==ScreenManager.root){if(AppConfig.afterLogin){location.hash=ScreenManager.paneRoot;}else{ScreenManager.screenChange();}}
if(AppConfig.afterLogin){window.addEventListener('load',function(){ScreenManager.screenChange();ScreenManager.projectSelector.init();},false)}else{location.hash=ScreenManager.root;}}}else{console.error('This browser can\'t support onhashchange event.')}};ScreenManager.detectAnchorHash=function(){var isValidHash=function(hash){if(typeof hash===typeof undefined||hash.startsWith('http')||hash.startsWith('https')||hash.startsWith('blob')){return true;}else if(hash==='/factory'||hash==='/point_tool/editor'){return true;}else{return hash.indexOf('=')!=-1;}};$(document).on('click.anchorHash','a',function(ev){var $this=$(this),hash=$this.attr('href'),isManagedHash=$this.attr('nothash');if(typeof isManagedHash!==typeof undefined&&isManagedHash!==false){return true;}
if(!isValidHash(hash)){ev.preventDefault();var dom=document.getElementById(hash.substr(1));if(dom){dom.scrollIntoView();}}
return true;})};if(typeof AppConfig!=typeof undefined){ScreenManager.listen();try{ScreenManager.setProjectSelector(PaneProjectSelector);}catch(e){}}
function _serializeParams(params){return window.encodeURIComponent(JSON.stringify(params));}
function _unserializeParams(params){try{params=JSON.parse(window.decodeURIComponent(params));}catch(e){}
return params;}
return ScreenManager;})();﻿
var beop=beop||{};beop.constant={project_img_path:'/static/images/project_img/',project_default_img:'default.jpg',BEOP_IMG_HOST:'http://images.rnbtech.com.hk',OSS_PROJECT_IMG_PATH:'/custom/project_img/'};var ObjectId=function(){var timestamp=new Date().valueOf();var userId=('000'+((window.AppConfig&&window.AppConfig.userId)||'000')).slice(-3);var hex8=('00000000'+Math.floor(Math.random()*0xFFFFFFFF).toString(16)).slice(-8);return timestamp+userId+hex8;};(function(exports){exports.namespace=function(path){var obj=window;path=path.split('.');path.forEach(function(p,i){p=p.trim();if(i===0&&p==='window')return;obj=obj[p]=obj[p]||{};});return obj;};}(window));(function(exports){exports.Mixin=function(){var prototype={};var methods;for(var i=0,len=arguments.length;i<len;i++){methods=arguments[i];for(var m in methods){prototype[m]=methods[m];}}
return prototype;};}(window));(function(){var ENUM_LEVEL={LOG:1,INFO:2,DEBUG:3,WARN:4,ERROR:5,EXCEPTION:6};window.Log={level:ENUM_LEVEL.WARN,log:function(){if(this.level>ENUM_LEVEL.LOG)return;Log._out('log',arguments);},info:function(){if(this.level>ENUM_LEVEL.INFO)return;Log._out('info',arguments);},debug:function(){if(this.level>ENUM_LEVEL.DEBUG)return;Log._out('debug',arguments);},warn:function(){if(this.level>ENUM_LEVEL.WARN)return;Log._out('warn',arguments);},error:function(){if(this.level>ENUM_LEVEL.ERROR)return;Log._out('error',arguments);},exception:function(message,exception){if(this.level>ENUM_LEVEL.EXCEPTION)return;if(exception){Log.error('Exception: ',message,exception.stack||exception);}else{Log.error('Exception: ',message);}},_out:function(type,args){console[type].apply(console,args)}};}());if(!Array.toMap){Array.toMap=function(arr,key){var map={};arr.forEach(function(row,i){map[row[key]]=row;});return map;};}
var FullScreenManager=(function(){var manager=Object.create({init:function(){var _this=this;$(document).off('webkitfullscreenchange');$(document).on('webkitfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('mozfullscreenchange');$(document).on('mozfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('msfullscreenchange');$(document).on('msfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});if(typeof onError==='function'){$(document).off('webkitfullscreenerror');$(document).on('webkitfullscreenerror',this.onFullScreenError);$(document).off('mozfullscreenerror');$(document).on('mozfullscreenerror',this.onFullScreenError);$(document).off('msfullscreenerror');$(document).on('msfullscreenerror',this.onFullScreenError);}},onFullScreenEnter:function(){},onFullScreenOut:function(){},onFullScreenError:function(){},toggle:function(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!document.msFullscreenElement){if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}}});manager.init();return manager;}());function StringBuilder(){this.data=Array("");}
StringBuilder.prototype.append=function(){this.data.push(arguments[0]);return this;};StringBuilder.prototype.toString=function(){return this.data.join("");};StringBuilder.prototype.getLength=function(){return this.data.length;};if(!String.prototype.format){String.prototype.format=function(){if(arguments[0]===undefined){return'';}
if(arguments[0].constructor===Array){var args=arguments[0];}else{var args=arguments;}
return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
if(!String.prototype.formatEL){String.prototype.formatEL=function(o,defaultVal){var str=this.toString();if(!str||!o)return'';for(var p in o){if(o.hasOwnProperty(p)){str=str.replace(new RegExp('{'+p+'}','g'),o[p]);}}
if(typeof defaultVal!=='undefined'){str=str.replace(/{[^{}]*?}/g,defaultVal);}
return str;};}
String.prototype.toDate=function(){var str=this;if(str.indexOf('-')>-1)
str=str.replace('-','/').replace('-','/');return new Date(str);};if(!String.prototype.startsWith){String.prototype.startsWith=function(word){return new RegExp('^'+word).test(this);}}
Number.prototype.toDate=function(){return new Date(this);};function Alert(targetElement,type,msg){this.element=targetElement;this.str=new StringBuilder();this.str.append('<div style="display:none;" class="alert beop-alert alert-').append(type).append(' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<div class="alert-msg">'+msg+'</div>').append('</div>');this.$alert=$(this.str.toString());}
Alert.danger=function(targetElement,msg){return new Alert(targetElement,Alert.type.danger,msg);};Alert.warning=function(targetElement,msg){return new Alert(targetElement,Alert.type.warning,msg);};Alert.success=function(targetElement,msg){return new Alert(targetElement,Alert.type.success,msg);};Alert.info=function(targetElement,msg){return new Alert(targetElement,Alert.type.info,msg);};Alert.closeAll=function(){$('.beop-alert').remove();};Alert.type={danger:'danger',warning:'warning',success:'success',info:'info'};Alert.prototype.show=function(duration){Alert.closeAll();if(duration){var _this=this;setTimeout(function(){_this.close();},duration);}
$(this.element).append(this.$alert);this.$alert.slideDown(500);return this;};Alert.prototype.close=function(){var _this=this;this.$alert.slideUp(500,function(){_this.$alert.remove();_this=null;});};Alert.prototype.setMessage=function(msg){if(!msg){return false}
this.$alert.find('.alert-msg').text(msg);};Alert.prototype.setStyle=function(style){if(style&&typeof style!=='string'){this.$alert.css(style);}
return this;};Alert.prototype.showAtTop=function(duration){this.setStyle({position:'absolute',top:0,left:0,right:0,margin:'auto',width:'30%',textAlign:'center',zIndex:10000});if(!duration){duration=2000;}
this.show(duration);};function showDialog(url){return WebAPI.get(url).done(function(resultHtml){$("#dialogContent").html(resultHtml);$('#dialogModal').modal({});});}
function clone(obj){if(obj==null||typeof(obj)!='object')
return obj;var temp=obj.constructor();for(var key in obj){if(obj.hasOwnProperty(key)){temp[key]=clone(obj[key]);}}
return temp;}
Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var week={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
if(/(E+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,((RegExp.$1.length>1)?(RegExp.$1.length>2?"/u661f/u671f":"/u5468"):"")+week[this.getDay()+""]);}
for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)));}}
return fmt;};Date.prototype.timeFormat=function(format,type,language,option){var date=this;if(format&&(typeof format=='string'||typeof format=='object')){if(typeof format=='object'&&(!format.separators||!format.parts)){format='yyyy-mm-dd hh:ii:ss';}}else{format='yyyy-mm-dd hh:ii:ss';}
if(arguments.length>=2){var paramArr=(function(arrayish){return[].slice.call(arrayish);})(arguments);paramArr.shift();type=language=option=null;paramArr.forEach(function(it,i){if(typeof it=='string'){language=it;}else if(typeof it=='number'){type=it;}else if(typeof it=='object'){option=it;}});}
var isReturnNull=false;if(option){for(var k in option){if(k=='isReturnNull'){isReturnNull=option[k];}}}
if(date=='Invalid Date'){console.warn("Invalid date.");if(isReturnNull){return'';}else{return date.toString();}}
var DATES={en:{"days":["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],"daysShort":["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sun"],"daysMin":["Su","Mo","Tu","We","Th","Fr","Sa","Su"],"months":["January","February","March","April","May","June","July","August","September","October","November","December"],"monthsShort":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"meridiem":["am","pm"]}};language=language?(DATES[language]?language:'en'):'en';var formatObj=(function(formatStr){if(typeof formatStr=='object'){return formatStr;}
if(type){formatStr=timeFormatChange(formatStr,type);}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};})(format);var val={yy:date.getFullYear().toString().substring(2),yyyy:date.getFullYear(),m:date.getMonth()+1,M:DATES[language].monthsShort[date.getMonth()],MM:DATES[language].months[date.getMonth()],d:date.getDate(),D:DATES[language].daysShort[date.getDay()],DD:DATES[language].days[date.getDay()],p:(DATES[language].meridiem.length==2?DATES[language].meridiem[date.getHours()<12?0:1]:''),h:date.getHours(),i:date.getMinutes(),s:date.getSeconds()};if(DATES[language].meridiem.length==2){val.H=(val.h%12==0?12:val.h%12);}
else{val.H=val.h;}
val.HH=(val.H<10?'0':'')+val.H;val.P=val.p.toUpperCase();val.hh=(val.h<10?'0':'')+val.h;val.ii=(val.i<10?'0':'')+val.i;val.ss=(val.s<10?'0':'')+val.s;val.dd=(val.d<10?'0':'')+val.d;val.mm=(val.m<10?'0':'')+val.m;var finTime='';for(var i=0,len=formatObj.separators.length;i<len;i++){finTime+=formatObj.separators[i]+(formatObj.parts[i]?val[formatObj.parts[i]]:'');}
return finTime;};var DateUtil=(function(){var dateLocale={month:{en:{month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],month_names_short:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']},zh:{month_names:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],month_names_short:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']}}};function getWeekNumber(d){d=new Date(+d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7);return[d.getFullYear(),weekNo];}
function getLastWeekNumberOf(y,w){w-=1;if(w===0){y=y-1;w=52;}
return[y,w];}
function getNextWeekNumberOf(y,w){w+=1;if(w===53){y+=1;w=1;}
return[y,w];}
function isLeapYear(y){if(Object.prototype.toString.call(y)==='[object Date]'){y=y.getFullYear();}
return((y%4===0)&&(y%100!==0))||(y%400===0);}
function daysInMonth(dt){var m=dt.getMonth();if(m===1){return isLeapYear(dt)?29:28;}
return[31,28,31,30,31,30,31,31,30,31,30,31][m];}
function getFirstDayOfWeek(year,week){var d=new Date(year,0,1),offset=d.getTimezoneOffset();d.setDate(d.getDate()+4-(d.getDay()||7));d.setTime(d.getTime()+7*24*60*60*1000*(week+(year==d.getFullYear()?-1:0)));d.setTime(d.getTime()
+(d.getTimezoneOffset()-offset)*60*1000);d.setDate(d.getDate()-3);return d;}
function getDateRangeOnWeekNumber(year,week){if(!year||!week){return;}
var firstDay=getFirstDayOfWeek(year,week),lastDay=new Date(firstDay);lastDay.setDate(firstDay.getDate()+6);return[firstDay,lastDay];}
function getMonthName(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names:dateLocale.month['en'].month_names;return monthList[index];}
function getMonthNameShort(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names_short:dateLocale.month['en'].month_names_short;return monthList[index];}
function getLastMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===1){return 12;}else{return currentMonth-1;}}
function getNextMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===12){return 1;}else{return currentMonth+1;}}
function getRelativeDateInfo(date1,date2){var now=new Date();var lang=I18n.type;var value1,value2,ts,info;if(!date1&&!date2)return'';value1=(date1||now).valueOf();value2=(date2||now).valueOf();ts=Math.floor(Math.abs(value1-value2)/1000);switch(true){case ts<60:info=ts+(ts===1?' second':' seconds');break;case ts<3600:ts=Math.floor(ts/60);info=ts+(ts===1?' minute':' minutes');break;case ts<86400:ts=Math.floor(ts/(3600));info=ts+(ts===1?' hour':' hours');break;case ts<31536000:ts=Math.floor(ts/(86400));info=ts+(ts===1?' day':' days');break;default:ts=Math.floor(ts/(31536000));info=ts+(ts===1?' year':' years');break;}
info+=value1>value2?' ago':' later';if(lang==='zh'){info=info.replace(/\s(seconds?|minutes?|hours?|days?|years?)\s(ago|later)$/,function($0,$1,$2){var rs='';if($1.indexOf('second')>-1)rs+='秒';if($1.indexOf('minute')>-1)rs+='分钟';if($1.indexOf('hour')>-1)rs+='小时';if($1.indexOf('day')>-1)rs+='天';if($1.indexOf('year')>-1)rs+='年';if($2==='ago')rs+='前';if($2==='later')rs+='后';return rs;});}
return info;}
return{getWeekNumber:getWeekNumber,isLeapYear:isLeapYear,daysInMonth:daysInMonth,getLastWeekNumberOf:getLastWeekNumberOf,getNextWeekNumberOf:getNextWeekNumberOf,getDateRangeOnWeekNumber:getDateRangeOnWeekNumber,getFirstDayOfWeek:getFirstDayOfWeek,getMonthName:getMonthName,getMonthNameShort:getMonthNameShort,getLastMonth:getLastMonth,getNextMonth:getNextMonth,getRelativeDateInfo:getRelativeDateInfo,DATA_FORMAT:{FULL_DATETIME:'yyyy-mm-dd hh:ii:ss',FULL_DATETIME_CHANGE:'yyyy-MM-dd HH:mm:ss',FULL_DATETIME_ALL_SEC_CHANGE:'yyyy-MM-dd 00:00:00',FULL_DATETIME_ZERO_SEC_CHANGE:'yyyy-MM-dd HH:mm:00',FULL_DATETIME_NO_SEC_CHANGE:'yyyy-MM-dd HH:mm',FULL_DATETIME_ZERO_SEC:'yyyy-mm-dd hh:ii:00',FULL_DATETIME_HH_00_00:'yyyy-mm-dd hh:00:00',FULL_DATETIME_00_00_00:'yyyy-mm-dd 00:00:00',FULL_DATETIME_NO_SEC:'yyyy-mm-dd hh:ii',FULL_DATETIME_HH_00:'yyyy-mm-dd hh:00',FULL_DATETIME_00_00:'yyyy-mm-dd 00:00',FULL_DATE:'yyyy-mm-dd',TIME:'hh:ii:ss',TIME_HOUR_MINUTE:'hh:ii',TIME_ZERO_SEC:'hh:ii:00'}}})();var StringUtil=(function(){var HTML_ENTITIES={'&':'&amp;','>':'&gt;','<':'&lt;','"':'&quot;',"'":'&#39;','`':'&#x60;'},HTML_ENTITIES_INVERT=invert(HTML_ENTITIES);function invert(obj){var result={},keys=Object.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i];}
return result;}
function padLeft(oldStr,padNum,padStr){if(!padStr){return oldStr;}
return new Array(padNum-String(oldStr).length+1).join(padStr)+oldStr;}
function htmlEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES[character];});}
function htmlUnEscape(text){if(!text){return text;}
var source='(?:'+Object.keys(HTML_ENTITIES_INVERT).join('|')+')',replaceRegexp=new RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES_INVERT[character];});}
var getI18nProjectName=function(project){if(!I18n||!project){return'';}
var result='';switch(I18n.type){case'en':{result=project.name_english;break;}
case'zh':{result=project.name_cn;break;}
default:{result=project.name_english;}}
return result||'';};return{padLeft:padLeft,htmlEscape:htmlEscape,htmlUnEscape:htmlUnEscape,getI18nProjectName:getI18nProjectName}})();var BEOPUtil=(function(){var jsType={function:typeof $.noop,number:typeof 0,string:typeof'',undefined:typeof undefined};var projectImgPath=beop.constant.project_img_path;var setRelativePosition=function($obj,$target,topOffset,leftOffset){$target.css({"left":$obj.offset().left+$obj.width()+(leftOffset||5),"top":$obj.offset().top+(topOffset||10)});};var projectDefaultImgPath=projectImgPath+beop.constant.project_default_img;var getProjectImgPath=function(project){if(project){return project.pic?projectImgPath+project.pic:projectDefaultImgPath;}};var getProjectFromAppConfig=function(projectId){for(var m=0,len=AppConfig.projectList.length;m<len;m++){if(AppConfig.projectList[m].id==projectId){return AppConfig.projectList[m];}}};function getFunctionName(func){if(!func||typeof func!=jsType.function){return'';}
var ret=func.toString();ret=ret.substr('function '.length);ret=ret.substr(0,ret.indexOf('('));return ret;}
function isUndefined(obj){return typeof obj===jsType.undefined;}
function getCookie(name){var value="; "+document.cookie;var parts=value.split("; "+name+"=");if(parts.length==2)return parts.pop().split(";").shift();}
function logicContentHandle(content){if(content){content=content.replace(/\t/g,'    ')}
return content;}
function copyToClipboard(text,valueContainer){var valueContainer=valueContainer?valueContainer:document.body;if(window.clipboardData&&window.clipboardData.setData){return clipboardData.setData("Text",text);}else if(document.queryCommandSupported&&document.queryCommandSupported("copy")){var textarea=document.createElement("textarea");textarea.textContent=text;textarea.style.position="fixed";valueContainer.appendChild(textarea);textarea.select();try{return document.execCommand("copy");}catch(ex){console.warn("Copy to clipboard failed.",ex);return false;}finally{valueContainer.removeChild(textarea);}}}
var projectImgType={logo:'logo.png',pdfCover:'pdf_cover.jpg'};function getProjectImgByType(projectId,name,extension){var img='';if(projectId){img+=projectId+'_';}
img+=name;if(extension){img+='.'+extension;}
return beop.constant.BEOP_IMG_HOST+beop.constant.OSS_PROJECT_IMG_PATH+img;}
function getProjectById(id){if(!id||!AppConfig.projectList){return null;}
for(var i=0;i<AppConfig.projectList.length;i++){var project=AppConfig.projectList[i];if(project.id==id){return project;}}
return null;}
return{setRelativePosition:setRelativePosition,getProjectImgPath:getProjectImgPath,getFunctionName:getFunctionName,isUndefined:isUndefined,getCookie:getCookie,getProjectFromAppConfig:getProjectFromAppConfig,logicContentHandle:logicContentHandle,copyToClipboard:copyToClipboard,getProjectImgByType:getProjectImgByType,getProjectById:getProjectById,projectImgType:projectImgType}})();(function(){var beop_tmpl_cache={};this.beopTmpl=function tmpl(str,data,htmlStr){var fn=!/\W/.test(str)?beop_tmpl_cache[str]=beop_tmpl_cache[str]||tmpl(htmlStr?htmlStr:document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split(/<!/).join("\t").replace(/((^|!>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)!>/g,"',$1,'").split("\t").join("');").split(/!>/).join("p.push('").split("\r").join("\\'")
+"');}return p.join('');");return data?fn(data):fn;};})();var SidebarMenuEffect=(function(){function SidebarMenuEffect(){}
SidebarMenuEffect.prototype.init=function(center,left,right){var _this=this;this.$paneCt=$(center);this.$leftBtn=$(center).find('#leftCt');this.$rightBtn=$(center).find('#rightCt');var container=document.getElementById('st-container'),buttons=Array.prototype.slice.call(document.querySelectorAll('.sideTrans')),refresh=function(){var leftCol=0,rightCol=0,centerCol=0;var leftArrow='<span class="glyphicon glyphicon-chevron-left"></span>';var rightArrow='<span class="glyphicon glyphicon-chevron-right"></span>';if(_this.$leftBtn.length>0){if(container.className.indexOf('st-effect-7')>0){var prev=_this.$paneCt.prev('div')[0];if(prev&&prev.className.indexOf('col-')>-1){leftCol=parseInt(prev.classList[0].split('-')[2]);}else{leftCol=0;}
_this.$leftBtn.removeClass('leftCtClose').addClass('leftCtOpen').html(leftArrow);}else{leftCol=0;_this.$leftBtn.removeClass('leftCtOpen').addClass('leftCtClose').html(rightArrow);}}
if(_this.$rightBtn.length>0){if(container.className.indexOf('st-effect-1')>0){var next=_this.$paneCt.next('div')[0];if(next&&next.className.indexOf('col-')>-1){rightCol=parseInt(next.classList[0].split('-')[2]);}else{rightCol=0;}
_this.$rightBtn.removeClass('rightCtClose').addClass('rightCtOpen').html(rightArrow);}else{rightCol=0;_this.$rightBtn.removeClass('rightCtOpen').addClass('rightCtClose').html(leftArrow);}}
centerCol=12-leftCol-rightCol;_this.$paneCt.removeClass().addClass('col-sm-'+centerCol+' st-content');};buttons.forEach(function(el,i){var effect=el.getAttribute('data-effect');el.addEventListener('click',function(ev){var target=ev.target.getAttribute('data-effect')!=null?ev.target.getAttribute('data-effect'):ev.target.parentNode.getAttribute('data-effect');var stCtClass=document.getElementById('st-container').className;if(stCtClass.indexOf(target)<0){ev.stopPropagation();ev.preventDefault();container.classList.add(effect);setTimeout(function(){if($(container.children[0]).children('div').length==3){container.classList.add('st-menu-open');}
refresh();},250);}else{container.classList.remove(target);refresh();}});});};return SidebarMenuEffect;})();(function(window){{var unknown='-';var screenSize='';if(screen.width){var width=(screen.width)?screen.width:'';var height=(screen.height)?screen.height:'';screenSize+=''+width+" x "+height;}
var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var browser=navigator.appName;var version=''+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if((verOffset=nAgt.indexOf('Opera'))!=-1){browser='Opera';version=nAgt.substring(verOffset+6);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('MSIE'))!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(verOffset+5);}
else if((verOffset=nAgt.indexOf('Chrome'))!=-1){browser='Chrome';version=nAgt.substring(verOffset+7);}
else if((verOffset=nAgt.indexOf('Safari'))!=-1){browser='Safari';version=nAgt.substring(verOffset+7);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('Firefox'))!=-1){browser='Firefox';version=nAgt.substring(verOffset+8);}
else if(nAgt.indexOf('Trident/')!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(nAgt.indexOf('rv:')+3);}
else if((nameOffset=nAgt.lastIndexOf(' ')+1)<(verOffset=nAgt.lastIndexOf('/'))){browser=nAgt.substring(nameOffset,verOffset);version=nAgt.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName;}}
if((ix=version.indexOf(';'))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(' '))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(')'))!=-1)version=version.substring(0,ix);majorVersion=parseInt(''+version,10);if(isNaN(majorVersion)){version=''+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10);}
var mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);var cookieEnabled=(navigator.cookieEnabled)?true:false;if(typeof navigator.cookieEnabled=='undefined'&&!cookieEnabled){document.cookie='testcookie';cookieEnabled=(document.cookie.indexOf('testcookie')!=-1)?true:false;}
var os=unknown;var clientStrings=[{s:'Windows 3.11',r:/Win16/},{s:'Windows 95',r:/(Windows 95|Win95|Windows_95)/},{s:'Windows ME',r:/(Win 9x 4.90|Windows ME)/},{s:'Windows 98',r:/(Windows 98|Win98)/},{s:'Windows CE',r:/Windows CE/},{s:'Windows 2000',r:/(Windows NT 5.0|Windows 2000)/},{s:'Windows XP',r:/(Windows NT 5.1|Windows XP)/},{s:'Windows Server 2003',r:/Windows NT 5.2/},{s:'Windows Vista',r:/Windows NT 6.0/},{s:'Windows 7',r:/(Windows 7|Windows NT 6.1)/},{s:'Windows 8.1',r:/(Windows 8.1|Windows NT 6.3)/},{s:'Windows 8',r:/(Windows 8|Windows NT 6.2)/},{s:'Windows NT 4.0',r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:'Windows ME',r:/Windows ME/},{s:'Android',r:/Android/},{s:'Open BSD',r:/OpenBSD/},{s:'Sun OS',r:/SunOS/},{s:'Linux',r:/(Linux|X11)/},{s:'iOS',r:/(iPhone|iPad|iPod)/},{s:'Mac OS X',r:/Mac OS X/},{s:'Mac OS',r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:'QNX',r:/QNX/},{s:'UNIX',r:/UNIX/},{s:'BeOS',r:/BeOS/},{s:'OS/2',r:/OS\/2/},{s:'Search Bot',r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var id in clientStrings){var cs=clientStrings[id];if(cs.r.test(nAgt)){os=cs.s;break;}}
var osVersion=unknown;if(/Windows/.test(os)){osVersion=/Windows (.*)/.exec(os)[1];os='Windows';}
switch(os){case'Mac OS X':osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];break;case'Android':osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1];break;case'iOS':osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);osVersion=osVersion[1]+'.'+osVersion[2]+'.'+(osVersion[3]|0);break;}}
window.jscd={screen:screenSize,browser:browser,browserVersion:version,mobile:mobile,os:os,osVersion:osVersion,cookies:cookieEnabled};}(this));var getUrlParams=function(){var search=window.location.search.substring(1);var kvArr=search.split('&');var rs={};kvArr.forEach(function(kv){var arr=kv.split('=');if(typeof arr[1]!=='undefined'){rs[arr[0]]=arr[1];}});return rs;};$.fn.serializeObject=function(){var obj={};this.serializeArray().map(function(item){if(/\[\]$/.test(item.name)){if(obj[item.name]){obj[item.name].push(item.value);}else{obj[item.name]=[item.value];}}else{obj[item.name]=item.value;}});return obj;};function kIntSeparate(num,n){var number=num.toFixed(n?n:0);var source=String(number).split(".");source[0]=source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)','ig'),"$1,");return source.join(".");}
function timeFormatChange(format,type){var lastStr='';var formatObj=(function(formatStr){if(!formatStr||typeof formatStr=='object'){return;}
var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){return;}
return{separators:separators,parts:parts};})(format);if(formatObj){format='';for(var i=0,len=formatObj.separators.length-1;i<len;i++){format+=formatObj.separators[i]+formatObj.parts[i];}
lastStr=formatObj.separators[len];}
var formatArr=['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'];var formatChangeArr=[['yyyy-mm-dd hh:ii:ss','yyyy-mm-dd hh:ii','yyyy-mm-dd hh','yyyy-mm-dd','yyyy-mm','mm-dd hh:ii:ss','mm-dd hh:ii','mm-dd hh','mm-dd'],['M d, yyyy hh:ii:ss','M d, yyyy hh:ii','M d, yyyy hh','M d, yyyy','M, yyyy','M d hh:ii:ss','M d hh:ii','M d hh','M d'],['dd/mm/yyyy hh:ii:ss','dd/mm/yyyy hh:ii','dd/mm/yyyy hh','dd/mm/yyyy','mm/yyyy','dd/mm hh:ii:ss','dd/mm hh:ii','dd/mm hh','dd/mm']];if(formatArr.findIndex){var index=formatArr.findIndex(function(v){return v===format;});}else{for(var i=0;i<formatArr.length;i++){if(formatArr[i]===format){var index=i;break;}}}
type=Number(type);type&&(type>=formatChangeArr.length)&&(type=formatChangeArr.length-1);if(index==-1){console.log('format is not defined');return format+lastStr;}else{if(type===0){return formatChangeArr[0][index]+lastStr;}
return formatChangeArr[type||AppConfig.projectTimeFormat||0][index]+lastStr;}}
function timeFormat(time,format,language,option){var date,arr,arr2;var sort=function(year,month,day,time){year=year==undefined?'2001':year;month=month==undefined?'01':month;day=day==undefined?'01':day;time=time==undefined?'':(' '+time);return new Date(year+'/'+month+'/'+day+time);}
if(time instanceof Date){date=time;}else if(typeof(time)=='string'){if(/^\d{1,2}-\d{1,2}/.test(time)){arr=time.split(' ');arr2=arr[0].split('-');time=arr2[1]+'-'+arr2[0]+(arr2[2]==undefined?'':('-'+arr2[2]))+(arr[1]==undefined?'':(' '+arr[1]));}
time=time.replace(/-/g,"/");arr=time.split(' ');arr2=arr[0].split('/');if(/^\d{4}/.test(time)){date=sort(arr2[0],arr2[1],arr2[2],arr[1]);}else if(/^\d{1,2}\/\d{4}/.test(time)){date=sort(arr2[1],arr2[0],'01',arr[1]);}else if(/^\d{1,2}\/\d{1,2}/.test(time)){date=sort(arr2[2],arr2[1],arr2[0],arr[1]);}else{date=new Date(time);}}else{date=new Date(time);}
return date.timeFormat(format,language,option);}
(function(exports){var MINITE_1=60000;var MINITE_5=300000;var HOUR_1=3600000;var DAY_1=86400000;var DAY_365=31536000000;function _formatTimeStr(str,format){var arr=str.split(' ');var date=arr[0].split('-');var time=arr[1].split(':');return format.replace('yyyy',date[0]).replace('MM',date[1]).replace('dd',date[2]).replace('HH',time[0]).replace('mm',time[1]).replace('ss',time[2]);}
function _explainPattern(timeShaft){var startTime=new Date(timeShaft[0]);var endTime=new Date(timeShaft[timeShaft.length-1]);var timeRange=endTime.valueOf()-startTime.valueOf();var timeInterval=timeRange/(timeShaft.length-1);var pattern='MM-dd HH:mm';if(timeInterval<=MINITE_5){if(timeRange<=HOUR_1){pattern='HH:mm';}else if(timeRange<=DAY_1){pattern='HH:mm';}}
else if(timeInterval<=HOUR_1){if(timeRange<=DAY_1){pattern='HH:mm';}else{pattern='MM-dd HH:mm';}}
else if(timeInterval<=DAY_1){if(timeRange<=DAY_365){pattern='MM-dd';}else{pattern='yyyy-MM-dd';}}
else{pattern='yyyy-MM';}
return pattern;}
function _explain(timeShaft){pattern=getPattern(timeShaft);if(pattern){timeShaft=timeShaft.map(function(row){return _formatTimeStr(row,pattern);});}
return timeShaft;}
function _valid(params){var flag=Object.prototype.toString.call(params)==='[object Array]';return flag&&/^[\d-]{10} [\d:]{8}$/.test(params[0]);}
var _getTimePattern=function(timeShaft){if(!_valid(timeShaft)){return;}
if(timeShaft.length<=1){return;}
return _explainPattern(timeShaft);};var formatTimeShaft=exports.formatTimeShaft=function(timeShaft){if(!_valid(timeShaft)){console.warn('function arguments is not a valid time shaft array!');return timeShaft;}
if(timeShaft.length<=1){return timeShaft;}
return _explain(timeShaft);};function _formatTimeStrByAppConfig(data){var formatArr,formatStr,regularArr,language,formatObj;switch(AppConfig.projectTimeFormat||0){case 0:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';break;case 1:formatArr=['M d, yyyy','M d hh:ii','M, yyyy','M, yyyy','M d'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;case 2:formatArr=['dd/mm/yyyy','dd/mm hh:ii','mm/yyyy','mm/yyyy','dd/mm'];regularArr=[/^[\d-]{10}$/,/^[\d-]{5} [\d:]{5}$/,/^[\d-]{7}$/,/^[\d-]{6}$/,/^[\d-]{5}$/];language='en';break;default:formatArr=['yyyy-mm-dd'];regularArr=[/^[\d-]{10}$/];language='en';}
for(var i=0,len=regularArr.length;i<len;i++){if(regularArr[i].test(data)){formatStr=formatArr[i];break;}}
if(formatStr){formatObj=(function _parseFormat(formatStr){var reg=/hh?|HH?|p|P|ii?|ss?|dd?|DD?|mm?|MM?|yy(?:yy)?/g;var separators=formatStr.replace(reg,'\0').split('\0');var parts=formatStr.match(reg);if(!separators||!separators.length||!parts||parts.length==0){throw new Error("Invalid date format.");}
return{separators:separators,parts:parts};})(formatStr);return{formatStr:formatStr,language:language,formatObj:formatObj};}else{return;}}
if(window.echarts){echarts.registerPreprocessor(function(option){var pattern;var formatInfo,firstValue;if(option.formatTime===false){pattern=_getTimePattern(option.xAxis[0].data);echarts.formatTimePattern=pattern;return;}
if(option.xAxis&&option.xAxis.length){option.xAxis.forEach(function(row){if(row.data&&row.data.length){pattern=_getTimePattern(row.data);formatInfo=_formatTimeStrByAppConfig(row.data[0]);if(pattern){row.data=row.data.map(function(row){return row.substr(0,16);});firstValue=_formatTimeStr(row.data[0],pattern);formatInfo=_formatTimeStrByAppConfig(firstValue);if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}else{row.data=row.data.map(function(it,i){return _formatTimeStr(it,pattern);});}}else if(formatInfo){row.data=row.data.map(function(it,i){return timeFormat(it,formatInfo.formatObj,formatInfo.language);});}}});}});}}(window));var generateTimeOption=function(option){var timeConfig=clone(option);(!timeConfig.timeStart)&&(timeConfig.timeStart=timeConfig.startTime);(!timeConfig.timeEnd)&&(timeConfig.timeEnd=timeConfig.endTime);(!timeConfig.timeFormat)&&(timeConfig.timeFormat=timeConfig.format);var recentTime={};var now=new Date();if(typeof option=='string'){recentTime=generateRecentTime(option)}else if(option&&option.timeRecent){if(typeof option.timeRecent=='string'){recentTime=generateRecentTime(option.timeRecent)}else if(option.timeRecent.hasOwnProperty('unit')&&option.timeRecent.hasOwnProperty('val')){recentTime=generateRecentTimeCustom(option.timeRecent)}}
if(recentTime&&Object.keys(recentTime).length>0){timeConfig.timeStart=recentTime.timeStart;timeConfig.timeEnd=recentTime.timeEnd;if(recentTime.format){timeConfig.timeFormat=recentTime.format;}
switch(timeConfig.timeFormat){case'h1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-dd HH:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-dd HH:00:00');break;case'd1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-dd 00:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-dd 00:00:00');break;case'M1':timeConfig.timeEnd=new Date(recentTime.timeEnd).format('yyyy-MM-01 00:00:00');timeConfig.timeStart=new Date(recentTime.timeStart).format('yyyy-MM-01 00:00:00');break;}}
timeConfig.startTime=timeConfig.timeStart;timeConfig.endTime=timeConfig.timeEnd;timeConfig.format=timeConfig.timeFormat;return timeConfig;function generateRecentTime(time){var startTime,endTime,format;switch(time){case'today':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-86400000).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'threeDay':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-259200000).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'yesterday':endTime=new Date(new Date().setDate(now.getDate()-1)).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(new Date().setDate(now.getDate()-2)).format('yyyy-MM-dd HH:mm:ss');format='h1';break;case'thisWeek':endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(now-604800000).format('yyyy-MM-dd HH:mm:ss');format='d1';break;case'lastWeek':endTime=new Date(now-(now.getDay()+1)*86400000).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-(now.getDay()+7)*86400000).format('yyyy-MM-dd HH:mm:ss');format='d1';break;case'thisYear':endTime=new Date(now-(now.getDay()+1)*86400000).format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-(now.getDay()+7)*86400000).format('yyyy-MM-dd HH:mm:ss');format='M1';break;}
return{timeStart:startTime,timeEnd:endTime,format:format}}
function generateRecentTimeCustom(time){var startTime,endTime,format;switch(time.unit){case'hour':endTime=now.format('yyyy-MM-dd HH:mm:ss');startTime=new Date(now-3600000*time.val).format('yyyy-MM-dd HH:mm:ss');break;case'day':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-86400000*time.val).format('yyyy-MM-dd HH:00:00');break;case'month':endTime=now.format('yyyy-MM-dd HH:00:00');startTime=new Date(now-2592000000*time.val).format('yyyy-MM-dd HH:00:00');break;}
return{timeStart:startTime,timeEnd:endTime}}};﻿
var HitModel=(function(){function HitModel(canvas){this.list={};this.scaleX=1;this.scaleY=1;this.scaleBoxX=undefined;this.scaleBoxY=undefined;this.rectLeft=undefined;this.rectTop=undefined;this.currentId=undefined;this.canvas=canvas;this.setScale(canvas);}
HitModel.prototype={add:function(id,type,x,y,width,height){if(!this.list[type])this.list[type]={};this.list[type][id]={startX:x,startY:y,endX:x+width,endY:y+height};},clear:function(){this.list={};},remove:function(type,id){if(arguments.length===1){if(this.list[type]){this.list[type]=null;}}else if(arguments.length>1){if(this.list[type]&&this.list[type][id]){this.list[type][id]=null;}}},isHit:function(x,y,hitModel){if(!(x&&y))return false;if(hitModel.startX>x||x>hitModel.endX)return false;if(hitModel.startY>y||y>hitModel.endY)return false;return true;},firstHitId:function(_x,_y,_type){var obj=this.convertToCanvasPosition(_x,_y);if(_type){for(var key in this.list[_type]){if(this.isHit(obj.x,obj.y,this.list[_type][key])){return{id:key,type:_type};}}}else{for(var type in this.list){for(var key in this.list[type]){if(this.isHit(obj.x,obj.y,this.list[type][key])){return{id:key,type:type};}}}}
return null;},setScale:function(canvas){var rect=canvas.getBoundingClientRect();this.scaleBoxX=canvas.width/rect.width;this.scaleBoxY=canvas.height/rect.height;this.rectLeft=rect.left*this.scaleBoxX;this.rectTop=rect.top*this.scaleBoxY;},convertToCanvasPosition:function(x,y){var rect=this.canvas.getBoundingClientRect();return{x:(x-rect.left-this.canvas.scrollLeft)*this.scaleX,y:(y-rect.top-this.canvas.scrollTop)*this.scaleY}}}
return HitModel;})();StringTools={};StringTools.wordWrap=function(context,x,y,width,text,options){var strs=new Array();var str="";for(var i=0;i<text.length;i++){str+=text[i];if(context.measureText(str).width>width-8){strs.push(str);str="";}}
strs.push(str);var size=context.font.split("px")[0];size=size.split(' ');size=size[size.length-1];var heigth=parseInt(size)*4/3;for(var i=0;i<strs.length;i++){context.fillText(strs[i],x,y+heigth*i);}};StringTools.getRealStringLength=function(str){var length=0;for(i=0;i<str.length;i++){if((str.charCodeAt(i)&0xff00)!=0){length++;}
length++;}
return length;}
var CanvasGeometry=(function(){function CanvasGeometry(){};CanvasGeometry.fillRadiusRect=function(ctx,x,y,width,height,radius){ctx.beginPath();ctx.moveTo(x+radius,y);ctx.arcTo(x+width,y,x+width,y+height,radius);ctx.arcTo(x+width,y+height,x,y+height,radius);ctx.arcTo(x,y+height,x,y,radius);ctx.arcTo(x,y,x+width,y,radius);ctx.closePath();};return CanvasGeometry;})();﻿var WebAPI=(function(){var siteId;switch(window.location.hostname){case'beop.rnbtech.com.hk':siteId='b79c068f77198848e22fe79758836e53';break;case'beop6.rnbtech.com.hk':siteId='f1f6b2b9e6b64592c0b4cb5e9b8bd79e';break;case'beopdemo.rnbtech.com.hk':siteId='ac0df98f274d9a5980a571297248d80b';break;default:break;}
(function(){if(siteId){var hm=document.createElement("script");hm.src="//hm.baidu.com/hm.js?"+siteId;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);}})();var mockList={'/static/mock/analysis_workspace_saveLayout.json':/\/analysis\/workspace\/saveLayout\/\d+\/[01]/i,'/static/mock/analysis_template_get.json':/\/analysis\/template\/get\/\d+/i};function mock(url){var match=null;for(var i in mockList){match=url.match(mockList[i]);if(match!==null)return i;}
return url;}
function requestFailHandle(result){if(result&&result.status==401){alert(i18n_resource.error.noPermission);}}
function WebAPI(){}
WebAPI.isMock=false;$.ajaxSetup({converters:{"text json":true},dataFilter:function(result,type){var data=result;if(type==='script'){return data;}else if(typeof data==='string'){if(/^\s*</.test(data)){return data;}
try{data=JSON.parse(result);}catch(e){console.log('request error: '+e+', the data is :'+data);return data;}}
if(data){if(data.error){switch(data.error){case'token_invalid':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');if(typeof LoginValidate!='undefined'){var validate=new LoginValidate();validate.show();return;}
confirm(i18n_resource.error.token[data.msg]+'. '+i18n_resource.error.relogin+'.',function(){if(AppConfig.isMobile){location.reload();}else{location.href='/';}});break;}
case'historyData':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');alert(data.msg);return{};}
default:break;}}
if(data.code==403){console.log(this.url+' ('+data.msg+'")');alert(I18n.resource.error.noPermission);return{};}}
return data;}});WebAPI.post=function(url,data,isMock){var mockUrl;isMock=isMock===undefined?WebAPI.isMock:isMock;if(isMock){mockUrl=mock(url);if(url!==mockUrl)return this.get(mockUrl,false);}
if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1)}}
return $.ajax({url:url,type:'POST',data:JSON.stringify(data),contentType:'application/json'}).fail(requestFailHandle);};WebAPI.get=function(url,isMock){isMock=isMock===undefined?WebAPI.isMock:isMock;url=isMock?mock(url):url;if(window._hmt&&url.indexOf('.html')>0)window._hmt.push(['_trackPageview',url]);if(typeof cordova!='undefined'&&AppConfig.host){if(url.indexOf('.html')==-1){url=AppConfig.host+url;}else if(url[0]=='/'){url=url.slice(1)}}
return $.ajax({url:url,type:'Get',contentType:'application/json'}).fail(requestFailHandle);};WebAPI.getHistoryDS=function(callback){};WebAPI.getHistory=function(callback){};return WebAPI;})();(function(){'use strict';var indexedDB=indexedDB||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(!indexedDB){return;}
function _initStorage(options){var _this=this;this._dbInfo=$.extend({db:null},options);var promise=$.Deferred();(function(){var _this=this;var dbInfo=this._dbInfo;var openreq=indexedDB.open(dbInfo.name,dbInfo.version);openreq.onerror=function(){promise.reject(openreq.error);};openreq.onsuccess=function(){dbInfo.db=openreq.result;promise.resolve();};openreq.onupgradeneeded=function(){var names=openreq.result.objectStoreNames;var length,key;var indexOf=([]).indexOf;if(indexOf.call(names,'cache')>-1){openreq.result.deleteObjectStore('cache');}
if(indexOf.call(names,'datasource')>-1){openreq.result.deleteObjectStore('datasource');}
if(indexOf.call(names,'thumbnail')>-1){openreq.result.deleteObjectStore('thumbnail');}
if(indexOf.call(names,'buffer')===-1){openreq.result.createObjectStore('buffer');}
openreq.result.createObjectStore('datasource');openreq.result.createObjectStore('thumbnail');for(var i=0,len=localStorage.length;i<len;i++){key=localStorage.key(i);if(key.indexOf('workSpacePicStorageEnable')===0){localStorage.removeItem(key);}}};}).call(this);}
function length(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.count();req.onsuccess=function(){promise.resolve(req.result);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.get(key);req.onsuccess=function(){var value=req.result;value=value===undefined?null:value;promise.resolve(value);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var result={};var promise=this.iterate(function(key,value,i){if(keyList.indexOf(key)>-1){result[key]=value;}}).then(function(){return result;},function(){console.warn('getItemList error!');});excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.put(value,key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();try{(function(){var _this=this;var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var result={};kvList.forEach(function(kv,i){var key=kv.key,value=kv.value;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
store.put(value,key);});transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=transaction.error;promise.reject(err);};}).call(this);}catch(e){console.warn('setItemList error!');promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.delete(key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;var request;if(!cursor){promise.resolve();return;}
if(keyList.indexOf(cursor.key)>-1){cursor.delete();}
cursor.continue();};req.onerror=function(err){promise.reject(err);};}).call(this);}catch(e){promise.reject();}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.clear();transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var advanced=false;req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(null);return;}
if(n===0){promise.resolve(cursor.key);}else{if(!advanced){advanced=true;cursor.advance(n);}else{promise.resolve(cursor.key);}}};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var keys=[];var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(keys);return;}
keys.push(cursor.key);cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var index=0;req.onsuccess=function(){var cursor=req.result;var result;if(!cursor){promise.resolve();return;}
result=iterator(cursor.key,cursor.value,index++);if(result===false){promise.resolve();return;}
cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var indexDBWrapper={_driver:'indexedDBWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.indexedDB=indexDBWrapper;}).call(this);(function($){'use strict';var localStorage;try{if(!this.localStorage||!('setItem'in this.localStorage)){return;}
localStorage=this.localStorage;}catch(e){return;}
function _initStorage(options){this._dbInfo=$.extend({},options);this._dbInfo.keyPrefix=this._dbInfo.name+'/';}
function length(callback){var _this=this;var promise=this.keys().then(function(keys){return keys.length;});excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var result;result=localStorage.getItem(this._dbInfo.keyPrefix+key);try{result=JSON.parse(result);}catch(e){}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var _this=this;var promise=$.Deferred();(function(){var result={};keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
result[key]=localStorage.getItem(_this._dbInfo.keyPrefix+key);try{result[key]=JSON.parse(result[key]);}catch(e){}});promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var _this=this;var result;try{try{value=JSON.stringify(value);}catch(e){}
result=localStorage.setItem(_this._dbInfo.keyPrefix+key,value);promise.resolve(result);}catch(e){result=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}
promise.reject(e);}}).call(this);excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();(function(){var _this=this;var result={};kvList.forEach(function(kv,i){var value;if(typeof kv.key!=='string'){console.warn('The key is not a string!');kv.key=String(kv.key);}
try{try{value=JSON.stringify(kv.value);}catch(e){value=kv.value;}
result[kv.key]=localStorage.setItem(_this._dbInfo.keyPrefix+kv.key,value);}catch(e){console.warn('occur error when set data into storage [key: "'+kv.key+'", value: "'+kv.value+'"]');result[kv.key]=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}}});promise.resolve();}).call(this);excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){localStorage.removeItem(this._dbInfo.keyPrefix+key);promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var _this=this;keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
localStorage.removeItem(_this._dbInfo.keyPrefix+key);});promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){localStorage.removeItem(key);}}
promise.resolve();}).call(this);}catch(e){proimse.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();(function(){var result;result=localStorage.key(n);if(result){result=result.substring(_this._dbInfo.keyPrefix.length);}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();(function(){var keyPrefix=this._dbInfo.keyPrefix;var length=localStorage.length;var keys=[],key;for(var i=0;i<length;i++){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){keys.push(key.substring(keyPrefix.length));}}
promise.resolve(keys);}).call(this);excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key,value;var result;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){value=localStorage.getItem(key);try{value=JSON.parse(value);}catch(e){}
result=iterator(key.substring(keyPrefix.length),value,i);}
if(result===false){break;}}
promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var localStorageWrapper={_driver:'localStorageWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.localStorage=localStorageWrapper;}).call(this,jQuery);(function($){function BaseCache(options){this.options=$.extend({},DEFAULTS,options);this.storage=Object.create(Beop.cache.drivers[this.options.driver]);this.init();}
BaseCache.prototype.init=function(){this.storage._initStorage(this.options);};BaseCache.prototype.length=function(){return this.storage.length();};BaseCache.prototype.key=function(n,callback){return this.storage.key(n,callback);};BaseCache.prototype.keys=function(callback){return this.storage.keys(callback);};BaseCache.prototype.getItem=function(key,callback){return this.storage.getItem(key,callback);};BaseCache.prototype.getItemList=function(keyList,callback){return this.storage.getItemList(keyList,callback);};BaseCache.prototype.setItem=function(key,value,callback){return this.storage.setItem(key,value,callback);};BaseCache.prototype.setItemList=function(kvList,callback){return this.storage.setItemList(kvList,callback);};BaseCache.prototype.removeItem=function(key,callback){return this.storage.removeItem(key,callback);};BaseCache.prototype.removeItemList=function(keyList,callback){return this.storage.removeItemList(keyList,callback);};BaseCache.prototype.clear=function(callback){return this.storage.clear(callback);};BaseCache.prototype.iterate=function(iterator,callback){return this.storage.iterate(iterator,callback);};var DEFAULTS={dbType:'localStorage',name:'beopcache',version:3};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.BaseCache=BaseCache;}).call(this,jQuery);var EventAdapter=(function(){var eventData,eventStatus;function EventAdapter($){}
EventAdapter.on=function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<3||arguments.length>5){console.log('EventAdapter.on arguments.length error');return;}
if(typeof arguments[0]!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}}
if(typeof arguments[1]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[1];}
if(typeof arguments[2]=='function'){eventFunction=arguments[2];eventSelector=null;eventHmt=arguments[3]}else if(typeof arguments[2]=='string'){if(arguments[3]&&typeof arguments[3]=='function'){eventSelector=arguments[2];eventFunction=arguments[3];eventHmt=arguments[4]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':eventTarget.on('touchstart',eventSelector,function(e){mobileDragStart.call(this,e,eventTarget,finalFunction)});break;case'dragover':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragOver.call(this,e,eventTarget,finalFunction)});break;case'dragleave':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragLeave.call(this,e,eventTarget,finalFunction)});break;case'drop':$(document).on('touchend.drop',eventSelector,function(e){mobileDrop.call(this,e,eventTarget,finalFunction)});break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;};EventAdapter.off=function(){if((arguments.length>3||arguments.length<1)||(arguments[0]&&typeof arguments[1]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}
if(arguments.length==1){eventTarget.off();return eventTarget;}
if(typeof arguments[1]=='string'){eventType=arguments[1]}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[2]=='string'){eventSelector=arguments[2];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;};$.fn.extend({'eventOn':function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<2||arguments.length>4){console.log('EventAdapter.on arguments.length error');return;}
if(typeof this!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(this instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=this;}}
if(typeof arguments[0]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[0];}
if(typeof arguments[1]=='function'){eventFunction=arguments[1];eventSelector=null;eventHmt=arguments[2]}else if(typeof arguments[1]=='string'){if(arguments[2]&&typeof arguments[2]=='function'){eventSelector=arguments[1];eventFunction=arguments[2];eventHmt=arguments[3]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':mobileDragStart(eventTarget,eventSelector,finalFunction);break;case'dragover':mobileDragOver(eventTarget,eventSelector,finalFunction);break;case'dragleave':mobileDragLeave(eventTarget,eventSelector,finalFunction);break;case'drop':mobileDrop(eventTarget,eventSelector,finalFunction);break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;},'eventOff':function(){if((arguments.length>2)||(arguments[0]&&typeof arguments[0]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(this instanceof jQuery)){eventTarget=jQuery(this);}else{eventTarget=this;}
if(arguments.length==0){eventTarget.off();return eventTarget;}
if(typeof arguments[0]=='string'){eventType=arguments[0];}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[1]=='string'){eventSelector=arguments[1];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector,mobileDragStart);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;}});EventAdapter.setData=function(date){if(date==undefined)return;eventData=date;};EventAdapter.getData=function(){return eventData;};document.addEventListener('drop',function(){eventData=null;},false);document.addEventListener('touchend',function(){eventData=null;},false);EventAdapter.clearEvent=function(){$(document).off('touchmove.copy');$(document).off('touchmove.drag');$(document).off('touchend.drop');};EventAdapter.analyse=function(e,eventType,hmtInfo){var mainInfo='',initArrTag,finalArrTag,tag,unitTag;var target=$(e.currentTarget);if(hmtInfo instanceof Array&&hmtInfo[0]){mainInfo=judgeWay(hmtInfo[0]);initArrTag=hmtInfo.filter(function(ele,index){return index>0&&ele!='';});finalArrTag=[];for(var i=0;i<initArrTag.length;i++){unitTag=judgeWay(initArrTag[i]);if(unitTag=='')continue;finalArrTag.push(unitTag)}
tag=finalArrTag.join('-');}else{if(hmtInfo!=undefined){mainInfo=judgeWay(hmtInfo);}else{mainInfo=getInfo(target);}
mainInfo=mainInfo?mainInfo:'';tag=mainInfo;}
_hmt.push(['_trackEvent',mainInfo.substr(0,30),eventType,'user-'+(AppConfig.userId?AppConfig.userId:0)+'/project-'+(AppConfig.projectId?AppConfig.projectId:0)]);function getInfo(tar){if(tar.length==0)return;var tarInfo;if(tar.attr('id')){tarInfo=tar.attr('id');}else if(tar.attr('i18n')){tarInfo=tar.attr('i18n');}else if(tar.attr('title')){tarInfo=tar.attr('title');}else{tarInfo=tar[0].innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30);}
return tarInfo;}
function judgeWay(arg){if(typeof arg=='undefined'){return'';}
if(arg instanceof Function){return arg.call(this,e)}else if(typeof arg=='string'){if(arg=='text'){return e.currentTarget.innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30)}else{return $(e.currentTarget).attr(arg)?$(e.currentTarget).attr(arg):arg;}}else if(typeof arg=='number'){return arg;}}};var mobileDragStart=function(e,target,eventFunction){var originalTarget=$(e.target).closest('[draggable="true"]')[0];var ev=e.type=='touchstart'?e.originalEvent.touches[0]:e,startPos={left:$(originalTarget).css('left'),top:$(originalTarget).css('top'),zIndex:$(originalTarget).css('z-index')},disX=originalTarget.offsetWidth/2,disY=originalTarget.offsetHeight/2;var $copyTarget=$(originalTarget).clone();$copyTarget.data('startPos',startPos);$copyTarget.css('z-index',10000);$copyTarget.css('position','absolute');$copyTarget.css('opacity','0.5');$copyTarget.css('pointer-events','none');var $container=$('body');$container.append($copyTarget);var sPos=$(originalTarget)[0].getBoundingClientRect();$copyTarget.css('left',sPos.left-$container[0].offsetLeft+'px');$copyTarget.css('top',sPos.top-$container[0].offsetTop+'px');$copyTarget[0].cssText=originalTarget.cssText;$copyTarget.css('width',originalTarget.offsetWidth);$copyTarget.css('height',originalTarget.offsetHeight);eventStatus='dragStart';eventFunction.call(this,ev);$(document).off('touchend.copy').on('touchend.copy',function(e){$copyTarget.remove();eventStatus='dragEnd';});$(document).on('touchmove.copy',function(e){eventStatus='dragMove';var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var $parent=$copyTarget.offsetParent();$parent=$parent.is(':root')?$(window):$parent;var targetLeft=ev.pageX-disX;var targetTop=ev.pageY-disY;$copyTarget.css({left:targetLeft+'px',top:targetTop+'px','z-index':10000});})};var mobileDragOver=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn'&&eventStatus!='dragMoveOut')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveIn';eventFunction.call(this,e);break;}}};var mobileDragLeave=function(e,target,eventFunction){if(eventStatus!='dragMoveIn')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(!((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY))){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveOut';eventFunction.call(this,e);}}};var mobileDragEnd=function(e,target,eventFunction){eventFunction.call(this,e);};var mobileDrop=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn')return;var ev=e.type=='touchend'?e.originalEvent.changedTouches[0]:e;var eventTarget=target;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventFunction.call(this,e);break;}}};return EventAdapter;})(jQuery);﻿
var Internationalization=(function(){function Internationalization(lang,resource){this.type=lang||localStorage["language"];this.resource=resource||{};}
Internationalization.prototype={getResource:function(){return this.resource;},fillPage:function(){this.fill2($('[i18n]'));},fillArea:function(element){this.fill2(element.find('[i18n]'));try{Permission.check(element);}catch(e){console.log('check permission failed:'+e);}},fillAreaAttribute:function(element,attributeName){this.fill(element.find('[i18n]['+attributeName+']'),attributeName);},fill:function(arrElement,attributeName){for(var i=0,arrPath,text,len=arrElement.length;i<len;i++){arrPath=arrElement[i].attributes["i18n"].value.split('.');text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
if(!attributeName){arrElement[i].innerHTML=text;}
else{arrElement[i].setAttribute(attributeName,text);}}},getI18nValue:function(i18nKey){if(!i18nKey){return'';}
var arrPath=i18nKey.split('.');var text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
return text;},fill2:function(arrElement){for(var i=0,len=arrElement.length;i<len;i++){var i18nValue=arrElement[i].attributes["i18n"];var items=i18nValue.value.split(';'),item,attrMap;for(var j=0;j<items.length;j++){item=items[j];if(!item){continue;}
if(item.indexOf('=')===-1){i18nValue=this.getI18nValue(item);arrElement[i].innerHTML=i18nValue;}else{attrMap=item.split('=');if(!attrMap[0]){continue;}
arrElement[i].setAttribute(attrMap[0],this.getI18nValue(attrMap[1]));}}}},findContent:function(strPath){var arrPath=strPath.split('.');var text=this.resource;for(var i=0,len=arrPath.length;i<len;i++){text=text&&text[arrPath[i]];}
return text;}};return Internationalization;})();function InitI18nResource(strLanguage,isForce,filePath){if(!strLanguage){strLanguage=localStorage["isUserSelectedLanguage"]||navigator.language.split('-')[0];}
if(isForce){localStorage["isUserSelectedLanguage"]=strLanguage;}else if(localStorage["isUserSelectedLanguage"]){strLanguage=localStorage["isUserSelectedLanguage"];}
filePath=filePath||'/static/views/js/i18n/';return $.ajax({async:false,url:filePath+strLanguage+".js",dataType:"script"}).then(function(){localStorage["language"]=strLanguage;return i18n_resource;},function(){return $.ajax({async:false,url:filePath+"en.js",dataType:'script'}).then(function(){localStorage["language"]="en";return i18n_resource;},function(){console.warn('i18n files loading failed!');return{};});});}
﻿
var ReportScreen=(function(){var getThisWeekReportNum=function(){var weekNum=DateUtil.getWeekNumber(new Date());return DateUtil.getLastWeekNumberOf(weekNum[0],weekNum[1]);};function ReportScreen(reportId,reportType,reportFolder,reportDate,reportText){this.$reportNavigation=null;this.reportStringId=reportId;this.reportType=reportType;this.lastReportType=reportType;this.reportFolder=reportFolder;this.reportText=reportText;this.dateList=[];this.pdfMap=[];this.datePickerInstance=null;if(reportDate){if(this.reportType==this.reportTypeMap.monthly){if(new Date().getMonth()==new Date(reportDate+'-15').getMonth()){var date=new Date();date.setMonth(date.getMonth()-1,1);reportDate=date.format('yyyy-MM');}
this.reportDate=new Date(reportDate+'-15').format('yyyy-MM');}else if(this.reportType==this.reportTypeMap.weekly){if(this.iso8601Week(new Date())==this.iso8601Week(new Date(reportDate))){reportDate=new Date(new Date()-7*24*60*60*1000).format('yyyy-MM-dd');}
this.reportDate=reportDate.format('yyyy-MM-dd');}else if(this.reportType!=this.reportTypeMap.monthly){this.reportDate=reportDate;}}else if(this.reportType==this.reportTypeMap.daily){var date=new Date();date.setDate(date.getDate()-1);this.reportDate=date.format('yyyy-MM-dd');}else if(this.reportType==this.reportTypeMap.monthly){var date=new Date();date.setMonth(date.getMonth()-1,1);this.reportDate=date.format('yyyy-MM');}else{this.reportDate=new Date(new Date()-7*24*60*60*1000).format('yyyy-MM-dd');}
this.reportName='';this.week=null;this.getMonthFirst=true;this.currentTR=null;this.currentDatePicker=null;this.currentYear=null;this.currentGoToday=false;this.dateTimePickerInline=false;this.i18nEcharts=I18n.resource.echarts;}
ReportScreen.prototype={displayWeek:getThisWeekReportNum(),reportTypeMap:{daily:'0',monthly:'1',weekly:'2'},baseChartOption:{title:{x:'center',textStyle:{fontSize:15}},tooltip:{trigger:'axis'},toolbox:{show:true,feature:{mark:{show:true},dataView:{show:true,readOnly:true},restore:{show:true},saveAsImage:{show:true}},showTitle:false},animation:false},chartYOffsetSetting:{legend:{y:40}},chartType:{pie:'pie',line:'line',scatter:'scatter',bar:'bar',area:'area',table:'table'},chartList:{},show:function(){this.init();},close:function(){this.unregisterChartResize();this.disposeChart();this.chartList={};$(window).off('resize');},disposeChart:function(){for(var chartId in this.chartList){this.chartList[chartId].dispose();}},init:function(){var _this=this;setTimeout(function(){if(_this.reportDate){_this.getReport.apply(_this,_this.reportDate.split('-'));}else{_this.getReport();}},50);this.chartList={};this.registerExportPDFEvent();this.registerExportWordEvent();},pieOptionToContent:function(opt){var html='';var series=$.extend(true,[],opt.series);for(var m=0,ml=series.length;m<ml;m++){series[m].data.sort(function(a,b){return a.name.localeCompare(b.name);});var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+series[m].name+'</p>';html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';for(var n=0,nl=series[m].data.length;n<nl;n++){html+='<tr>'+'<td>'+series[m].data[n].name+'</td>';for(var j=0,jl=series[m].data[n].value.length;j<jl;j++){html+='<td>'+series[m].data[n].value[j]+'</td>'}
html+='</tr>'}
html+='</tbody></table>';}
return html;},optionToContent:function(opt){var axisData=opt.xAxis&&opt.xAxis[0].data,series=opt.series;var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+opt.title.text+'</p>';var html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';if(BEOPUtil.isUndefined(axisData)){html+='<tr>';for(var i=0,l=series.length;i<l;i++){html+='<td colspan="2">'+series[i].name+'</td>';}
html+='</tr>';var longestSeriesData=[],longestLength=0;for(var j=0,sl=series.length;j<sl;j++){if(series[j].data.length>longestLength){longestSeriesData=series[j].data;longestLength=longestSeriesData.length;}}
for(var i=0,il=longestSeriesData.length;i<il;i++){html+='<tr>';for(var m=0,ml=series.length;m<ml;m++){if(!BEOPUtil.isUndefined(series[m].data[i])){for(var n=0,nl=series[m].data[i].length;n<nl;n++){html+='<td>'+series[m].data[i][n]+'</td>';}}}
html+='</tr>';}}else{html+='<tr><td>'+opt.xAxis[0].name+'</td>';for(var i=0,l=series.length;i<l;i++){html+='<td>'+series[i].name+'</td>';}
html+='</tr>';for(var i=0,l=axisData.length;i<l;i++){html+='<tr>'+'<td>'+axisData[i]+'</td>';for(var j=0,sl=series.length;j<sl;j++){html+='<td>'+series[j].data[i]+'</td>';}
html+='</tr>';}}
html+='</tbody></table>';return html;},registerChartResize:function(){var _this=this;this.unregisterChartResize();$(window).on('resize.beop.report.echarts',function(){for(var m in _this.chartList){_this.chartList[m].resize();}});},unregisterChartResize:function(){$(window).off('resize.beop.report.echarts');},uploadChart:function(key,chart_base64){return WebAPI.post('/report/uploadChart/',{key:key,chart:chart_base64})},downloadFile:function(href,filename){var a=$("<a id='test' download='"+filename+"' target='_self'' href='"+href+"'></a>")[0];try{try{a.click();}catch(ex){var evObj=document.createEvent('MouseEvents');evObj.initEvent('click',true,true,window);a.dispatchEvent(evObj);}}catch(ex){alert('download failed.Please contact the administrator.');return false;}},requestWordDownload:function(){var report=[],$report=$('.step-play-list').clone(),_this=this,uploadPromises=[];$report.find('.step-item-container').each(function(index,chapterContainer){var $chapterContainer=$(chapterContainer);var chapter={title:$chapterContainer.find('.page-header').text().replace('\s+',''),unit:[]};$chapterContainer.find('.report-unit').each(function(index,unitContainer){var $unitContainer=$(unitContainer);var $children=$unitContainer.children();var unit={title:$unitContainer.find('.well').text().replace(/\s{4,}/g,'\n'),content:[]};$children.each(function(index,child){var $child=$(child);if($child.hasClass('canvas-container')){var chartId=$child.attr('_echarts_instance_');var chartInstance=echarts.getInstanceById(chartId);if(chartInstance){uploadPromises.push(_this.uploadChart(chartId,chartInstance.getDataURL()));unit.content.push({type:'chart',value:chartId})}}else if($child.hasClass('summary')){var summaryHtml=$child.text().replace(/\s{4,}/g,'\n');summaryHtml.split('<br>').forEach(function(summaryItem){if(summaryItem&&summaryItem.trim()){unit.content.push({type:'summary',value:summaryItem.trim()})}});}else if($child.hasClass('table')){var header=[],rows=[];$child.find('thead th').each(function(index,th){header.push($(th).text());});$child.find('tbody tr').each(function(index,tr){var row=[];$(tr).find('td').each(function(index,td){row.push($(td).text());});rows.push(row);});unit.content.push({type:'table',header:header,rows:rows})}});chapter.unit.push(unit);});report.push(chapter);});Spinner.spin(ElScreenContainer);$.when.apply(null,uploadPromises).then(function(){WebAPI.post('/report/exportWord/',{report:report,projectName:AppConfig.projectName,name:_this.reportText+'_'+_this.reportDate,folder:_this.reportFolder,version:_this.reportDate}).done(function(result){if(result.success){_this.downloadFile(result.data,_this.reportText+'_'+timeFormat(_this.reportDate,timeFormatChange('yyyy-mm-dd'))+'.docx');}else{alert('The server is busy. please try again later');}}).always(function(){Spinner.stop();});}).fail(function(){Spinner.stop();});},registerExportWordEvent:function(){$(ElScreenContainer).eventOff('click.report.exportWord','#exportWord').eventOn('click.report.exportWord','#exportWord',this.requestWordDownload.bind(this),'报表Word下载-传统模式');},registerExportPDFEvent:function(){var _this=this;$(ElScreenContainer).eventOff('click.report.exportPDF','#exportPDF').eventOn('click.report.exportPDF','#exportPDF',function(){var chart=null,$this=$(this),$report=$('.step-play-list').clone(),reportFolderName=$this.attr('reportFolderName'),version=$this.attr('version'),pdfName=AppConfig.projectShowName+'.'+_this.getReportName()+'.'+(_this.reportTypeMap.weekly?version:timeFormat(version,timeFormatChange('yyyy-mm-dd')))+'.pdf',uploadPromises=[];if(_this.pdfMap[version]){_this.downloadFile(_this.pdfMap[version],pdfName);}else{Spinner.spin(ElScreenContainer);for(var chartId in _this.chartList){chart=_this.chartList[chartId];if(chart){var imageKey=AppConfig.projectId+reportFolderName+version+chartId;uploadPromises.push(_this.uploadChart(imageKey,_this.chartList[chartId].getDataURL()));$report.find('[chart-id='+chartId+']').replaceWith('<img class="chartImage" img-src="'+'/static/projectReports/reports/'+imageKey+'.png"/>');}}
$('.canvas-container',$report).each(function(index,item){$(item).prev('.summary').addBack().wrapAll('<div class="pageHeaderWrapper"></div>');});var pdfTemplatePromise=WebAPI.get('/static/views/share/reportWrap/pdfTemplate.html');var coverPagePromise=WebAPI.get('/static/views/share/reportWrap/coverPage.html');$.when.apply(null,uploadPromises).done(function(){$.when(pdfTemplatePromise,coverPagePromise).done(function(template,result){WebAPI.get("/project/getinfo/"+AppConfig.projectId).done(function(rs){var projectInfo=rs.projectinfo;var reportDateArr=$("#beopReport").find(' .input-append input').val().split('-');result=result[0].formatEL({projectImg:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.pdfCover),title:$("#reportNavList").find('.active').text(),logo:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.logo),date:_this.getReportType()==_this.reportTypeMap.weekly?reportDateArr[0]+' week '+reportDateArr[1]:timeFormat($("#beopReport").find(' .input-append input').val(),timeFormatChange('yyyy-mm-dd')),projName:localStorage.getItem("language")==="zh"?projectInfo.name_cn:projectInfo.name_english});template=template[0].formatEL({projectImg:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.pdfCover),title:_this.getReportName(),encoding:'UTF-8',projName:AppConfig.projectShowName,entitiesHtml:$report.attr('id','reportWrap').html(),date:timeFormat(version,timeFormatChange('yyyy-mm-dd')),logo:BEOPUtil.getProjectImgByType(AppConfig.projectId,BEOPUtil.projectImgType.logo),footerLeft:i18n_resource.report.reportWrap.GENERATED_BY_BEOP,footerRight:localStorage.getItem("language")==="zh"?"第 [page] 页 共[topage]页":"Page [page] of [topage]"});WebAPI.post('/report/getReportPDF',{html:template,cover:result,skin:'default',folder:reportFolderName,version:version,projectName:AppConfig.projectName,projectShowName:AppConfig.projectShowName,projectId:AppConfig.projectId,reportName:_this.getReportName()}).done(function(result){if(result.success){_this.downloadFile(result.data.createdPDF,pdfName);_this.pdfMap=result.data.pdfMap;}}).always(function(){Spinner.stop();});});});}).fail(function(){Spinner.stop();});}},'报表PDF下载-传统模式')},getReportFolder:function(){return this.reportFolder;},getReportType:function(){return this.reportType;},getReportName:function(){if(!this.reportStringId){return'';}
if(!this.reportName){for(var i=0;i<AppConfig.navItems.length;i++){var navItem=AppConfig.navItems[i];if(navItem.id===this.reportStringId){this.reportName=navItem.text;}}}
return this.reportName;},initReportList:function(){if(!AppConfig.navItems){return false;}
$('#reportNavList').remove();var reportItem,reportItemList,$reportItemBtn,_this=this,$listGroup=$('<ul id="reportNavList" class="list-group reportList" style="width:110px;overflow-y: auto;height: 90%;overflow-x: hidden;top: 74px"></ul>');reportItemList=AppConfig.navItems.filter(function(item){return item.type==='ReportScreen';});for(var i=0;i<reportItemList.length;i++){reportItem=reportItemList[i];$reportItemBtn=$('<li class="list-group-item ellipsis" id="'+reportItem.id+'" title="'+reportItem.text+'" report_type="'+reportItem.reportType+'">'+'<span class="mr5 iconfont icon-report'+reportItem.reportType+'"></span>'+reportItem.text+'</li>');$reportItemBtn.eventOn('click',(function(reportItem){return function(){if(reportItem.reportType==_this.reportTypeMap.monthly){if(new Date().getMonth()==_this.reportDate.substring(5,7)){var date=new Date();date.setMonth(date.getMonth()-1,1);_this.reportDate=date.format('yyyy-MM');}else{_this.reportDate=_this.reportDate.substring(0,7);}}else if((reportItem.reportType==_this.reportTypeMap.daily&&_this.lastReportType==_this.reportTypeMap.monthly)||(reportItem.reportType==_this.reportTypeMap.daily&&_this.lastReportType==_this.reportTypeMap.weekly)){var thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);_this.reportDate=thisDay.format('yyyy-MM-dd');}else if(reportItem.reportType==_this.reportTypeMap.weekly&&_this.lastReportType==_this.reportTypeMap.monthly){var thisDay=new Date();thisDay.setDate(thisDay.getDate()-7);_this.reportDate=thisDay.format('yyyy-MM-dd');}
ScreenManager.goTo({page:'ReportScreen',reportId:reportItem.id,reportType:reportItem.reportType,reportFolder:reportItem.reportFolder,reportDate:_this.reportDate,reportText:reportItem.text});};})(reportItem),'报表切换-'+reportItem.text);$listGroup.append($reportItemBtn);}
$('#indexMain').append($listGroup);$("#"+_this.reportStringId).addClass("active");var $stepContainer=$("#indexMain .step-container");var $reportNavList=$("#reportNavList");var navLeftPosi=function(){$reportNavList.css({left:parseInt($stepContainer.offset().left)-parseInt($reportNavList.width())+'px'});$(".reportNavigation").css({left:parseInt($stepContainer.offset().left)+parseInt($stepContainer.width())+40+'px',top:"92px"});};$stepContainer.css("margin-left","13%");navLeftPosi();$(window).resize(function(){navLeftPosi();});},getReportMsg:function(){var _this=this;var report_type,reportDate,i18n=I18n.resource.observer.reportScreen;$("#reportLoading").remove();if(this.reportType=='0'){report_type=i18n.DAILY;reportDate=timeFormat(this.reportDate,timeFormatChange('yyyy-mm-dd'));}else if(this.reportType=='1'){report_type=i18n.MONTHLY;reportDate=timeFormat(this.reportDate,timeFormatChange('yyyy-mm'));}else{report_type=i18n.WEEKLY;reportDate=''}
var reportLoadingHtml='<div id="reportLoading">'+'<div id="reportLoadingModal"></div>'+'<div class="report-loading-img-box">'+'<div id="reportLoadingText"><div><span> '+i18n.LOADING+' </span><span class="report-type-text">'+_this.reportText+' </span></div>'+'<div><span>'+reportDate+'</span> <span>'+report_type+'</span></div>'+'</div>'+'</div>'+'</div>';$("body").append(reportLoadingHtml);},reportMsgDestroy:function(){var _this=this;this.$reportLoadingDtd=$.Deferred();setTimeout(function(){$("#reportLoading").remove();_this.$reportLoadingDtd.resolve();},1000);return _this.$reportLoadingDtd;},getReport:function(year,month,day){var _this=this,version,thisDay;_this.getReportMsg();$(".step-container").empty();var reportFolderName=this.getReportFolder();if(this.getReportType()==this.reportTypeMap.daily){if(!month||!year||!day){thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);version=thisDay.format('yyyy-MM-dd');year=thisDay.getFullYear();month=thisDay.getMonth()+1;day=thisDay.getDate();}else{version=year+"-"+StringUtil.padLeft(month,2,'0')+"-"+StringUtil.padLeft(day,2,'0');}}
else if(this.getReportType()==this.reportTypeMap.monthly){if(!month||!year){thisDay=new Date();thisDay.setMonth(thisDay.getMonth()-1);year=thisDay.getFullYear();month=thisDay.getMonth()+1;}
version=year+'-'+StringUtil.padLeft(month,2,'0');}else{if(!year){thisDay=new Date();year=thisDay.getFullYear();}
if(!day){day=new Date().getDate();}
if(!month){month=thisDay.getMonth()-1;if(month<=0){year=year-1;month=_this.iso8601Week(new Date(year,12));}else{month=_this.iso8601Week(thisDay);if(month<=0){month=1}}
version=year+'-'+month+'-w';}else{month=_this.iso8601Week(new Date(year+'-'+month+'-'+day));_this.week=month;}
version=year+'-'+month+'-w';}
var getReportFailed=function(){WebAPI.get('/static/projectReports/emptyReport.html').done(function(resultHtml){_this.reportMsgDestroy().done(function(){if($('#reportFailCon').length===0){I18n.fillArea($(ElScreenContainer).html(resultHtml));}
if(day){day=day<10?day.length==2?day:'0'+day:day;}
_this.initDatePicker(year,month,day);_this.initReportList();});}).fail(function(){_this.reportMsgDestroy();}).always(function(){Spinner.stop();})};return WebAPI.get("/report/getReport/"+AppConfig.projectName+"/"+reportFolderName+'/'+version).done(function(resultHtml){_this.reportMsgDestroy().done(function(){$(ElScreenContainer).html(resultHtml);_this.renderCharts($('#beopReport .report-unit'));_this.$reportNavigation=$('.reportNavigation');_this.initDatePicker(year,month,day);_this.$reportNavigation.affix({offset:{top:100}});$('.step-container').scrollspy({target:'.reportNavigation'});_this.$reportNavigation.find('.active').removeClass('active');if(Permission.hasPermission('DReport')){var $pdfContent='<a id="exportPDF" class="report_file_download exportPDF pa" permission="DReport"><span class="add-on"><img class="report_file_img" src="/static/images/pdf_download.png"　alt="PDF Dowload" /></span><span class="report_file_text" i18n="observer.reportScreen.PDF_DOWNLOAD"></span></a>';_this.$reportNavigation.prepend($pdfContent);var $exportPDF=$('#exportPDF');if(!$exportPDF.length){$('#beopReport').append($exportPDF);}
$exportPDF.attr('reportFolderName',reportFolderName).attr('version',version);var $wordContent='<a id="exportWord" class="report_file_download exportWord pa" permission="DReport"><span class="add-on"><img class="report_file_img" src="/static/images/word_download.png"　alt="Word Dowload" /></span><span class="report_file_text" i18n="observer.reportScreen.WORD_DOWNLOAD"></span></a>';_this.$reportNavigation.prepend($wordContent);var $exportWord=$('#exportWord');if(!$exportWord.length){$('#beopReport').append($exportWord);}
$exportWord.attr('reportFolderName',reportFolderName).attr('version',version);}
_this.initReportList();_this.changeDatepickerStyle();I18n.fillArea($(ElScreenContainer));});}).fail(function(){getReportFailed();}).always(function(){WebAPI.get("/report/getReportList/"+AppConfig.projectName+"/"+reportFolderName+'/'+version).done(function(result){if(result.success){_this.dateList=$.unique(result.data.htmlReport);_this.pdfMap=result.data.pdfReportMap;}});Spinner.stop();});},changeDatepickerStyle:function(){var $reportNavigation=$(".reportNavigation");$reportNavigation.find(".add-on").addClass("input-group-addon");$reportNavigation.find(".icon-calendar").attr("class","glyphicon glyphicon-calendar");},addActiveWeeksStyle:function(){var $con=this.datePickerInstance.picker,yearMonth=this.datePickerInstance.viewDate.format('yyyy-MM').split('-'),year=yearMonth[0],i,timeList;this.filterDateList('week');for(i=0;i<this.dateList.length;i++){timeList=this.dateList[i].split('-');if(timeList[0]==year){$con.find('.datetimepicker-days table tbody td.ui-week-col').each(function(){if($(this).text()==timeList[1]){$(this).parent().addClass('hasReport');}});}}},addActiveDaysStyle:function(){var $con=this.datePickerInstance.picker;var yearMonth=this.datePickerInstance.viewDate.format('yyyy-MM').split("-");var year=yearMonth[0];var month=yearMonth[1];this.filterDateList('day');for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList[0]==year&&timeList[1]==month){$con.find(".day:not('.old,.new')").eq(Number(timeList[2])-1).addClass("hasReport");}}},addActiveMonthsStyle:function(){var $con=this.datePickerInstance.picker;var year=this.datePickerInstance.viewDate.format('yyyy').split("-");this.filterDateList('month');for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList[0]==year){$con.find(".month").eq(Number(timeList[1])-1).addClass("hasReport");}}},filterDateList:function(val){var dayList=[];var monthList=[];var weekList=[];for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList.length==3&&this.getReportType()==this.reportTypeMap.weekly){weekList.push(this.dateList[i]);}
else if(timeList.length>2){dayList.push(this.dateList[i]);}else{monthList.push(this.dateList[i]);}}
if(val=="day"){this.dateList=dayList;}else if(val=='month'){this.dateList=monthList;}else{this.dateList=weekList;}},triggerDateStyle:function(val){var _this=this;setTimeout(function(){if(val=="day"){_this.addActiveDaysStyle();}else if(val=="month"){_this.addActiveMonthsStyle();}else if(val=='weekly'){_this.addActiveWeeksStyle();$('.datetimepicker .datetimepicker-days table tbody').find('tr').find('td:first').each(function(){$this=$(this);if($this.text()==_this.week){$this.parent().addClass('active');$this.parent().siblings().removeClass('active');}});}},50);},iso8601Week:function(date){var addOneDayDate=new Date(new Date(date).getTime()+24*60*60*1000);var time,checkDate=new Date(addOneDayDate.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},renderCharts:function($chartContainer){var echartForI18Option={};var _this=this;if(this.i18nEcharts){echartForI18Option={toolbox:{feature:{mark:{show:true,title:{mark:this.i18nEcharts.MARK,markUndo:this.i18nEcharts.MARKUNDO,markClear:this.i18nEcharts.MARKCLEAR}},dataZoom:{title:{dataZoom:this.i18nEcharts.DATAZOOM,dataZoomReset:this.i18nEcharts.DATAZOOMRESET}},dataView:{title:this.i18nEcharts.DATAVIEW,lang:[this.i18nEcharts.DATAVIEW,this.i18nEcharts.CLOSE,this.i18nEcharts.REFRESH],show:true,readOnly:true},magicType:{title:{line:this.i18nEcharts.LINE,bar:this.i18nEcharts.BAR,stack:this.i18nEcharts.STACK,tiled:this.i18nEcharts.TILED,force:this.i18nEcharts.FORCE,chord:this.i18nEcharts.CHORD,pie:this.i18nEcharts.PIE,funnel:this.i18nEcharts.FUNNEL}},restore:{show:true,title:this.i18nEcharts.REDUCTION},saveAsImage:{show:true,title:this.i18nEcharts.SAVE_AS_PICTURE,lang:[this.i18nEcharts.SAVE]}}}};}
if(jscd.mobile){window.addEventListener('load',function(){$('canvas').off().remove();ReportScreen=null;for(var m=0;m<_this.chartList.length;m++){_this.chartList[m].clear();_this.chartList[m].dispose();}
_this.chartList={};$('.canvas-container').off();$('.step-container').off();$(".form_datetime").off();},false);var extraOptionsForMobile={toolbox:{show:false},title:{textStyle:{fontSize:15,fontFamily:'Microsoft Yahei',fontWeight:'500',color:'white'}},grid:{x:40,y:2,x2:40,y2:40},xAxis:{axisLine:{lineStyle:{color:'white'}},splitLine:{show:false},axisLabel:{textStyle:{fontSize:2,color:'white'},interval:40,rotate:'90'},axisTick:{show:false},nameGap:10,nameTextStyle:{fontSize:2,color:'white'}},yAxis:{axisLabel:{textStyle:{fontSize:2,color:'white'}},axisLine:{show:false},axisTick:{show:false},splitLine:{},nameLocation:'middle',nameGap:30,nameTextStyle:{fontSize:2,color:'white'}},legend:{textStyle:{fontSize:2,color:'white'}},renderAsImage:'jpeg'};this.baseChartOption=$.extend(true,this.baseChartOption,extraOptionsForMobile,echartForI18Option);}else{this.baseChartOption=$.extend(true,this.baseChartOption,echartForI18Option);}
$chartContainer.find('.chart-param').each(function(){_this.initCharts($(this))})},scrollInitEcharts:function($chartContainer){var offsets=[],_this=this;var scrollTop,i,activeClass="scrollActive";$chartContainer.each(function(){var top=$(this).offset().top-$(window).height();offsets.push(top>0?top:0);});_this.initCharts($chartContainer.eq(0).find('.chart-param'));$chartContainer.eq(0).addClass(activeClass);var activate=function(targetIndex){[].slice.call($chartContainer).forEach(function(item,index){if(index==targetIndex){var $item=$(item);if(!$item.hasClass(activeClass)){$item.addClass(activeClass);$item.find('.chart-param').each(function(){_this.initCharts($(this));});if(jscd.mobile){setTimeout(function(){for(var key in _this.chartList){if(_this.chartList.hasOwnProperty(key)){if(_this.chartList[key]){_this.chartList[key]=null;}}}
$('canvas').off().remove();},5000);}}}});};document.querySelector('.step-container').addEventListener('scroll',function(){scrollTop=$(this).scrollTop()+300;for(i=offsets.length;i--;){if(scrollTop>=offsets[i]&&(offsets[i+1]===undefined||scrollTop<offsets[i+1])){activate(i);return;}}})},initDatePicker:function(year,month,day){var now=new Date();year=!year?now.getFullYear():year;var monthNameShort=!month?DateUtil.getMonthNameShort(DateUtil.getLastMonth()-1):DateUtil.getMonthNameShort(month-1);var monthName=!month?DateUtil.getMonthName(DateUtil.getLastMonth()-1):DateUtil.getMonthName(month-1);day=!day?now.getDate():day;var $datePick=$(".form_datetime");if(this.dateTimePickerInline==true){$datePick.empty();}
var _this=this;var dateDisplay,timeFormatStr;$datePick.datetimepicker('remove').off();if(this.getReportType()==this.reportTypeMap.daily){timeFormatStr=timeFormatChange('yyyy-mm-dd');$datePick.datetimepicker({format:timeFormatStr,minView:"month",startView:"month",todayBtn:true,inline:true,startDate:"2010-01-01 00:00",sideBySide:true,autoclose:true,forceParse:false,endDate:new Date(),initialDate:new Date(monthNameShort+' '+day+','+year)});if(!_this.dateTimePickerInline){$datePick.find('input').val(timeFormat(monthNameShort+' '+day+','+year,timeFormatStr));}
$datePick.on('changeDate',function(ev){try{ScreenManager.goTo({page:'ReportScreen',reportId:_this.reportStringId,reportType:_this.reportType,reportFolder:_this.reportFolder,reportDate:ev.date.toISOString().substring(0,10),reportText:_this.reportText});}catch(e){return false;}}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('day');}).on('show',function(ev){var dayFormat=ev.date.toISOString().substring(8,10);dateDisplay=DateUtil.getMonthNameShort(ev.date.getMonth())+' '+dayFormat+', '+ev.date.getFullYear();if(!_this.dateTimePickerInline){$datePick.find('input').val(timeFormat(dateDisplay,timeFormatStr));}
_this.addActiveDaysStyle();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('day');});});this.dateTimePickerInline==true?updateDaily():'';function updateDaily(){setTimeout(function(){_this.triggerDateStyle('day');$datePick.datetimepicker('update',new Date(year,Number(month)-1,day));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('day');});},0)}}else if(this.getReportType()==this.reportTypeMap.monthly){timeFormatStr=timeFormatChange('yyyy-mm');$datePick.datetimepicker({format:timeFormatStr,minView:"year",startView:"year",todayBtn:true,inline:true,startDate:"2010-01-01 00:00",sideBySide:true,autoclose:true,endDate:new Date(new Date().setMonth(new Date().getMonth()-1)),monthAbbreviation:true,forceParse:false,initialDate:new Date(monthNameShort+','+year)});if(!_this.dateTimePickerInline){$datePick.find('input').val(timeFormat(monthNameShort+','+year,timeFormatStr));}
$datePick.on('changeDate',function(ev){try{ScreenManager.goTo({page:'ReportScreen',reportId:_this.reportStringId,reportType:_this.reportType,reportFolder:_this.reportFolder,reportDate:ev.date.toISOString().substring(0,7),reportText:_this.reportText});}catch(e){return false;}}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('month');}).on('show',function(ev){dateDisplay=DateUtil.getMonthNameShort(ev.date.getMonth())+','+ev.date.getFullYear();_this.addActiveMonthsStyle();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('month');});});this.dateTimePickerInline==true?updateMonthly():'';function updateMonthly(){setTimeout(function(){_this.triggerDateStyle('month');$datePick.datetimepicker('update',new Date(year,Number(month)-1))
_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('month');});},0)}}else if(this.getReportType()==this.reportTypeMap.weekly){var week;if(this.week!=null){week=this.week;}else if(this.getMonthFirst){if(month){week=month}else{var date=new Date();week=this.iso8601Week(new Date(date.getFullYear(),date.getMonth()-1));}}else{week=this.iso8601Week(new Date(year,['January','February','March','April','May','June','July','August','September','October','November','December'].indexOf(monthName)));}
this.getMonthFirst=false;if(this.currentYear){year=this.currentYear;}
if(!_this.dateTimePickerInline){$datePick.find('input').val(year+'-'+week+'-week');}
$datePick.datetimepicker({format:'yyyy-mm-dd hh:ii',todayBtn:true,autoclose:true,showWeek:true,inline:true,startDate:"2010-01-01 00:00",sideBySide:true,minView:2,endDate:new Date()});$datePick.data('date',this.reportDate);$datePick.on('changeYear changeMonth',function(ev){_this.triggerDateStyle('weekly');}).on('show',function(ev){_this.addActiveWeeksStyle();if(_this.currentTR!==null&&_this.currentTR!==undefined&&_this.currentTR!=='undefined'){if(_this.currentDatePicker){if(!_this.currentGoToday){$datePick.datetimepicker('update',new Date(_this.currentDatePicker).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();$('.datetimepicker:last .datetimepicker-days table tbody tr').eq(_this.currentTR).addClass('active');}else{var weekNow=_this.iso8601Week(new Date());$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});_this.currentGoToday=false;}
_this.addActiveWeeksStyle();}}else{$('.datetimepicker .datetimepicker-days table tbody').find('tr').find('td:first').each(function(){$this=$(this);if($this.text()==_this.week){$this.parent().addClass('active');$this.parent().siblings().removeClass('active');}});}
dateDisplay=DateUtil.getMonthName(ev.date.getMonth())+','+ev.date.getFullYear();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('weekly');});}).on('changeDay',function(date){try{var reportDate=new Date(date.date);ScreenManager.goTo({page:'ReportScreen',reportId:_this.reportStringId,reportType:_this.reportType,reportFolder:_this.reportFolder,reportDate:reportDate.format('yyyy-MM-dd'),reportText:_this.reportText});}catch(e){return false;}}).on('goToToday',function(date){_this.currentGoToday=false;try{ScreenManager.goTo({page:'ReportScreen',reportId:_this.reportStringId,reportType:_this.reportType,reportFolder:_this.reportFolder,reportDate:date.date.format('yyyy-MM-dd'),reportText:_this.reportText});}catch(e){return false;}});this.dateTimePickerInline==true?updateWeekly():'';function updateWeekly(){setTimeout(function(){_this.triggerDateStyle('weekly');$datePick.datetimepicker('update',new Date(year,Number(month)-1));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('weekly');});_this.addActiveWeeksStyle();if(_this.currentTR!==null&&_this.currentTR!==undefined&&_this.currentTR!=='undefined'){if(_this.currentDatePicker){if(!_this.currentGoToday){$datePick.datetimepicker('update',new Date(_this.currentDatePicker).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();$('.datetimepicker:last .datetimepicker-days table tbody tr').eq(_this.currentTR).addClass('active');}else{var weekNow=_this.iso8601Week(new Date());$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});_this.currentGoToday=false;}
_this.addActiveWeeksStyle();}}else{if(_this.firstOpen){$datePick.datetimepicker('update',new Date(year,date.getMonth()-1).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();}else{var weekNow=_this.iso8601Week(new Date());$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});}}},0)}}
this.datePickerInstance=$datePick.data('datetimepicker');},generateChartId:function(){return new Date().getTime();},initCharts:function($canvasChart){var chartOpts=this.getChartParam($canvasChart);if(!chartOpts){return;}
var chartDom=$canvasChart.parent()[0],chartId=this.generateChartId(),chartInstance;$(chartDom).attr('chart-id',chartId);switch(chartOpts.type){case this.chartType.line:chartInstance=this.initChartLine(chartDom,chartOpts);break;case this.chartType.pie:chartInstance=this.initChartPie(chartDom,chartOpts);break;case this.chartType.bar:chartInstance=this.initChartBar(chartDom,chartOpts);break;case this.chartType.scatter:chartInstance=this.initChartScatter(chartDom,chartOpts);break;case this.chartType.area:chartInstance=this.initChartArea(chartDom,chartOpts);break;case this.chartType.table:chartInstance=this.initChartTable(chartDom,chartOpts);break;default:console.log('生成图像错误:没有类型'+chartOpts.type);break;}
if(chartOpts.theme){chartInstance.setTheme(chartOpts.theme);}
if(chartInstance){chartInstance.on("magictypechanged",function(event){if(event.currentType=='line'){this.setOption({tooltip:{axisPointer:{type:'line'}}})}else if(event.currentType=='bar'){this.setOption({tooltip:{axisPointer:{type:'shadow'}}})}});this.chartList[chartId]=chartInstance;this.registerChartResize();}},getChartParam:function($chartParam){try{var unitString=$chartParam.html();if(!unitString){return null;}
unitString=unitString.replace(/"/g,"\\\"").replace(/'/g,"\"");return JSON.parse(unitString);}catch(e){console.error(e);return null;}},getChartSeriesData:function(type,x,yData,y){var result=[];switch(type){case this.chartType.bar:case this.chartType.line:case this.chartType.scatter:case this.chartType.area:{result=yData;break;}
case this.chartType.pie:{for(var i=0;i<y.length;i++){result.push({name:y[i].name,value:y[i].value})}
break;}
default:{result=yData;}}
return result;},getChartOptsFromParam:function(chartParam,type){var y=chartParam.chartItems.y,x=chartParam.chartItems.x,series=[],legend=[],chartSeriesData=[],yItem,seriesItem,result,yAxis=[],_this=this;if(x&&x.length&&/(\d{4}-)?\d{2}-\d{2}/.test(x[0])){if(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(x[0])){x=x.map(function(item){return timeFormat(item,timeFormatChange('yyyy-mm-dd hh:ii'));})}else if(/^\d{4}-\d{2}-\d{2}&/.test(x[0])){x=x.map(function(item){return timeFormat(item,timeFormatChange('yyyy-mm-dd'));})}else if(/\d{2}-\d{2}/.test(x[0])){x=x.map(function(item){return timeFormat(item,timeFormatChange('mm-dd'));})}}
if(type===this.chartType.pie){legend=x;seriesItem={};seriesItem.name=chartParam.title;seriesItem.data=this.getChartSeriesData(type,x,null,y);seriesItem.type=type;seriesItem.selectedMode='single';if(jscd.mobile){seriesItem.radius=[0,'65%'];seriesItem.center=['50%','50%'];seriesItem.labelLine={normal:{length:10,length2:10},emphasis:{length:10,length2:10}}}
series.push(seriesItem);}else{if(!$.isArray(y)){var temp=[];for(var key in y){var obj={name:key,value:y[key],yAxisIndex:0};temp.push(obj);}
y=temp;}
for(var m=0,noMaxNoMinchartSeriesData=[],length=y.length;m<length;m++){yItem=y[m];seriesItem={};seriesItem.yAxisIndex=Number(yItem.yAxisIndex)||0;seriesItem.name=yItem.name;chartSeriesData=this.getChartSeriesData(type,x,yItem.value,yItem);if((chartParam.yMax&&chartParam.yMax.length)||(chartParam.yMin&&chartParam.yMin.length)){noMaxNoMinchartSeriesData=[];for(var i=0,chartDataPush,iLen=chartSeriesData.length;i<iLen;i++){chartParam.yMax.length?chartDataPush=Math.min(chartParam.yMax,chartSeriesData[i]):'';chartParam.yMin.length?(chartDataPush=chartParam.yMax.length?Math.max(chartParam.yMin,chartDataPush):Math.max(chartParam.yMin,chartSeriesData[i])):'';noMaxNoMinchartSeriesData.push(chartDataPush);}
seriesItem.data=noMaxNoMinchartSeriesData;}else{seriesItem.data=chartSeriesData;}
if(yItem.stack){seriesItem.stack=yItem.yAxisIndex+yItem.stack;}
if(type===this.chartType.area){seriesItem.type=this.chartType.line;seriesItem.stack=I18n.resource.observer.widgets.TOTAL_AMOUNT;seriesItem.itemStyle={normal:{areaStyle:{type:'default'}}};}else{if(yItem.type){seriesItem.type=yItem.type;}else{seriesItem.type=type;}}
if(yItem.otherOptions){$.extend(seriesItem,yItem.otherOptions);}
seriesItem._name=yItem.name;series.push(seriesItem);legend.push(yItem.name);}
var optForYAxis
if(!$.isArray(chartParam.Options.y)){optForYAxis={name:chartParam.Options.y,type:'value',scale:true};if(jscd.mobile){optForYAxis=$.extend(true,{},optForYAxis,this.baseChartOption.yAxis)}
yAxis.push(optForYAxis)}else{for(var i=0;i<chartParam.Options.y.length;i++){optForYAxis={name:chartParam.Options.y[i],type:'value',scale:true};if(jscd.mobile){optForYAxis=$.extend(true,{},optForYAxis,this.baseChartOption.yAxis)}
var yAxisItem=optForYAxis;if(!BEOPUtil.isUndefined(chartParam.yMax)&&chartParam.yMax.length){yAxisItem.max=+chartParam.yMax[i];yAxisItem.scale=false;}
if(!BEOPUtil.isUndefined(chartParam.yMin)&&chartParam.yMin.length){yAxisItem.min=+chartParam.yMin[i];yAxisItem.scale=false;}
yAxis.push(yAxisItem);}}}
if(yAxis&&yAxis.length==1){yAxis=yAxis[0];}else{if(jscd.mobile){yAxis.slice(1).forEach(function(axis){if(!axis.splitLine)axis.splitLine={};axis.splitLine.show=false;})}}
var sortedLegend=legend;if(chartParam.chartItems&&chartParam.chartItems.yOrder&&chartParam.chartItems.yOrder.length){sortedLegend=chartParam.chartItems.yOrder;}else{sortedLegend=this._sortLegend(legend);}
result={title:{text:chartParam.title},noDataLoadingOption:{text:I18n.resource.observer.reportScreen.TITLE_NO_DATA,effect:'whirling'},legend:{data:sortedLegend,padding:[-10,5,0,10],itemHeight:10},series:series.sort(function(a,b){return _this._sortFunction(a._name,b._name);}),xAxis:[{scale:true,name:chartParam.Options.x}],yAxis:yAxis};if(x&&x.length>0){result.xAxis[0].data=x;result.xAxis[0].type='category';}else{result.xAxis[0].type='value';}
if(result.xAxis&&result.xAxis.length==1){result.xAxis=result.xAxis[0];}
if(type===this.chartType.pie){delete result.xAxis;delete result.yAxis;}
if(chartParam.commonChartOptions){var convertTheFunction=function(obj){for(var prop in obj){if(obj.hasOwnProperty(prop)){if(typeof obj[prop]==='string'&&obj[prop].indexOf('function(')!=-1){obj[prop]=eval(obj[prop]);}else if($.isPlainObject(obj[prop])){convertTheFunction(obj[prop]);}}}};try{convertTheFunction(chartParam.commonChartOptions);$.extend(result,chartParam.commonChartOptions);}catch(e){}}
return result;},_sortFunction:function(a,b){var ax=[],bx=[];a.replace(/(\d+)|(\D+)/g,function(_,$1,$2){ax.push([$1||Infinity,$2||""])});b.replace(/(\d+)|(\D+)/g,function(_,$1,$2){bx.push([$1||Infinity,$2||""])});while(ax.length&&bx.length){var an=ax.shift();var bn=bx.shift();var nn=(an[0]-bn[0])||an[1].localeCompare(bn[1]);if(nn)return nn;}
return ax.length-bx.length;},_sortLegend:function(legend){if(!legend){return[];}
legend.sort(this._sortFunction);var ret=[],splitNum;if(legend.length>15){splitNum=Math.ceil(legend.length/3);}else{splitNum=5;}
for(var i=0,j=legend.length;i<j;i++){ret.push(legend[i]);if((i+1)%splitNum===0){ret.push('');}}
return ret;},initChartLine:function(chartDom,chartParam){var _this=this;var x=chartParam.chartItems,y=chartParam.chartItems.y,tooltipRenturnData;var defaultOption={toolbox:{feature:{magicType:{show:true,type:['line','bar','stack','tiled']},dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};if((chartParam.yMax&&chartParam.yMax.length)||(chartParam.yMax&&chartParam.yMax.length)){defaultOption.tooltip={formatter:function(params){var tooltipReturnData='';tooltipReturnData+=x.x[params[0].dataIndex]+'<br/>';for(var i=0;i<params.length;i++){for(var j=0;j<y.length;j++){if(y[j].name==params[i].seriesName){tooltipReturnData+='<div style="display:inline-block;width:10px;width:10px;margin-right:4px;height:10px;border-radius:5px;background-color:'+params[i].color+'"></div>'+params[i].seriesName+' :'+y[j].value[params[i].dataIndex]+'<br />';break;}}}
return tooltipReturnData;}}}
var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.line));if(jscd.mobile){if(option.xAxis&&option.xAxis[0]){for(var i=0,xLabel;i<option.xAxis[0].data.length;i++){xLabel=option.xAxis[0].data[i].split(' ');if(xLabel.length==2){option.xAxis[0].data[i]=xLabel[1].substring(0,5)}else if(xLabel.length==1){if(xLabel[0].split('-').length==1){option.xAxis[0].data[i]=xLabel[0].substring(0,5)}else if(xLabel[0].split('-').length>2){option.xAxis[0].data[i]=xLabel[0].substring(5)}}}}
if(option.xAxis&&option.xAxis.data){for(var i=0,xLabel;i<option.xAxis.data.length;i++){xLabel=option.xAxis.data[i].split(' ');if(xLabel.length==2){option.xAxis.data[i]=xLabel[1].substring(0,5)}else if(xLabel.length==1){if(xLabel[0].split('-').length==1){option.xAxis.data[i]=xLabel[0].substring(0,5)}else if(xLabel[0].split('-').length>2){option.xAxis.data[i]=xLabel[0].substring(5)}}}}
if(option.yAxis instanceof Array&&option.yAxis.length>1){option.xAxis.nameTextStyle.color='transparent';}
if(option.yAxis&&option.yAxis.length==1){delete option.yAxis.scale;}
if(option.xAxis.data instanceof Array)option.xAxis.axisLabel.interval=parseInt(option.xAxis.data.length/8)}
var instance=echarts.init(chartDom);instance.setOption(option);return instance;},initChartPie:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.pieOptionToContent}}},legend:{orient:'vertical',x:'left',y:40,show:false}};var option=$.extend(true,defaultOption,this.getChartOptsFromParam(chartParam,this.chartType.pie),this.baseChartOption);if(jscd.mobile){delete option.xAxis;delete option.yAxis;}
var instance=echarts.init(chartDom);instance.setOption(option);return instance;},initChartBar:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{magicType:{show:true,type:['line','bar','stack','tiled']},dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.bar));if(jscd.mobile){if(option.xAxis&&option.xAxis[0]){for(var i=0,xLabel;i<option.xAxis[0].data.length;i++){xLabel=option.xAxis[0].data[i].split(' ');if(xLabel.length==2){option.xAxis[0].data[i]=xLabel[1].substring(0,5)}else if(xLabel.length==1){if(xLabel[0].split('-').length==1){option.xAxis[0].data[i]=xLabel[0].substring(0,5)}else if(xLabel[0].split('-').length>2){option.xAxis[0].data[i]=xLabel[0].substring(5)}}}}
if(option.xAxis&&option.xAxis.data){for(var i=0,xLabel;i<option.xAxis.data.length;i++){xLabel=option.xAxis.data[i].split(' ');if(xLabel.length==2){option.xAxis.data[i]=xLabel[1].substring(0,5)}else if(xLabel.length==1){if(xLabel[0].split('-').length==1){option.xAxis.data[i]=xLabel[0].substring(0,5)}else if(xLabel[0].split('-').length>2){option.xAxis.data[i]=xLabel[0].substring(5)}}}}
if(option.yAxis instanceof Array&&option.yAxis.length>1){option.xAxis.nameTextStyle.color='transparent';}
if(option.yAxis&&option.yAxis.length==1){delete option.yAxis.scale;}
if(option.xAxis.data instanceof Array)option.xAxis.axisLabel.interval=parseInt(option.xAxis.data.length/8)}
var instance=echarts.init(chartDom);instance.setOption(option);return instance;},initChartScatter:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.scatter));if(jscd.mobile){if(option.xAxis&&option.xAxis[0]){for(var i=0,xLabel;i<option.xAxis[0].data.length;i++){xLabel=option.xAxis[0].data[i].split(' ');if(xLabel.length==2){option.xAxis[0].data[i]=xLabel[1].substring(0,5)}else if(xLabel.length==1){if(xLabel[0].split('-').length==1){option.xAxis[0].data[i]=xLabel[0].substring(0,5)}else if(xLabel[0].split('-').length>2){option.xAxis[0].data[i]=xLabel[0].substring(5)}}}}
if(option.xAxis&&option.xAxis.data){for(var i=0,xLabel;i<option.xAxis.data.length;i++){xLabel=option.xAxis.data[i].split(' ');if(xLabel.length==2){option.xAxis.data[i]=xLabel[1].substring(0,5)}else if(xLabel.length==1){if(xLabel[0].split('-').length==1){option.xAxis.data[i]=xLabel[0].substring(0,5)}else if(xLabel[0].split('-').length>2){option.xAxis.data[i]=xLabel[0].substring(5)}}}}
if(option.yAxis instanceof Array&&option.yAxis.length>1){option.xAxis.nameTextStyle.color='transparent';}
if(option.yAxis&&option.yAxis.length==1){delete option.yAxis.scale;}
if(option.xAxis.data instanceof Array)option.xAxis.axisLabel.interval=parseInt(option.xAxis.data.length/8)}
var instance=echarts.init(chartDom);var optsSeries=option.series;Array.isArray(optsSeries)&&typeof option.grid==='object'&&(option.grid.top=(Math.floor((isNaN(optsSeries.length)?15:optsSeries.length)/5))*40);instance.setOption(option);return instance;},initChartArea:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.area));if(jscd.mobile){if(option.xAxis&&option.xAxis[0]){for(var i=0,xLabel;i<option.xAxis[0].data.length;i++){xLabel=option.xAxis[0].data[i].split(' ');if(xLabel.length==2){option.xAxis[0].data[i]=xLabel[1].substring(0,5)}else if(xLabel.length==1){if(xLabel[0].split('-').length==1){option.xAxis[0].data[i]=xLabel[0].substring(0,5)}else if(xLabel[0].split('-').length>2){option.xAxis[0].data[i]=xLabel[0].substring(5)}}}}
if(option.xAxis&&option.xAxis.data){for(var i=0,xLabel;i<option.xAxis.data.length;i++){xLabel=option.xAxis.data[i].split(' ');if(xLabel.length==2){option.xAxis.data[i]=xLabel[1].substring(0,5)}else if(xLabel.length==1){if(xLabel[0].split('-').length==1){option.xAxis.data[i]=xLabel[0].substring(0,5)}else if(xLabel[0].split('-').length>2){option.xAxis.data[i]=xLabel[0].substring(5)}}}}
if(option.yAxis instanceof Array&&option.yAxis.length>1){option.xAxis.nameTextStyle.color='transparent';}
if(option.yAxis&&option.yAxis.length==1){delete option.yAxis.scale;}
if(option.xAxis.data instanceof Array)option.xAxis.axisLabel.interval=parseInt(option.xAxis.data.length/8)}
var instance=echarts.init(chartDom);instance.setOption(option);return instance;},initChartTable:function(chartDom,chartParam){if(chartParam&&chartParam.chartItems&&chartDom){chartParam.chartItems.title=chartParam.title?chartParam.title:'';chartParam.chartItems.firstColumn=chartParam.Options&&chartParam.Options.x?chartParam.Options.x:'';var $tableContainer=$(beopTmpl('tmpl_table',chartParam.chartItems));if($tableContainer.find('thead th').length>5){$tableContainer.filter('table').attr('style','width:90%');}
$(chartDom).replaceWith($tableContainer);}}};return ReportScreen;})();(function(){var _this;var Spinner=new LoadingSpinner({color:'#00FFFF'});function EnergyScreen(options,container){_this=this;this.options=options;this.windowCtn=(function(container){if(typeof container==='string'){return document.querySelector('#'+container);}else if(container instanceof HTMLElement){return container;}else{return null;}}(container));this.dataSourcePanelCtn=null;this.modulePanelCtn=null;this.container=null;this.$pageNav=null;this.store={};this.listEntity=[];this.arrEntityOrder=[];this.mapRefresh={};this.popRefresh={};this.requestPoints=[];this.dictPopToEntity={};this.paneDatasource=null;this.workerUpdate=null;}
EnergyScreen.prototype.htmlUrl='/static/app/WebFactory/views/energyScreen.html';EnergyScreen.prototype.show=function(){var _this=this;return WebAPI.get(this.htmlUrl).then(function(html){_this.windowCtn.innerHTML='';_this.initLayout(html);return _this.init();});};EnergyScreen.prototype.getPageData=function(){Spinner.spin(this.windowCtn);var material;if($('#hidPageInfo').length>0){material=JSON.parse($('#hidPageInfo').val()).material;}
if(material===1){return WebAPI.post("/factory/material/getByIds",{'ids':[this.options.id]}).always(function(e){Spinner.stop();});}else{return WebAPI.get("/spring/get/"+this.options.id+'/'+AppConfig.isFactory).always(function(e){Spinner.stop();});}};EnergyScreen.prototype.init=function(){var promise=this.getPageData();AppConfig.datasource=new DataSource(_this);return promise.done(function(rs){var material;if($('#hidPageInfo').length>0){material=JSON.parse($('#hidPageInfo').val()).material;}
if(material===1){rs[0].content.layout=[[rs[0].content.layout]];this.store=rs[0].content;}else{this.store=rs;}
this.initIoc();this.initModuleLayout();this.initWorkerForUpdating();this.attachEvents();}.bind(this));};EnergyScreen.prototype.attachEvents=function(){};EnergyScreen.prototype.initIoc=function(){this.factoryIoC=new FactoryIoC('dashboard');};EnergyScreen.prototype.initLayout=function(html){this.initLayoutDOM(html);};EnergyScreen.prototype.initLayoutDOM=function(html){var divMain,stCt;divMain=document.createElement('div');divMain.className='indexContent st-pusher';divMain.innerHTML=html;stCt=$('<div id="st-container" class="st-container">')[0];stCt.appendChild(divMain);this.windowCtn.appendChild(stCt);this.container=divMain.querySelector('#paneCenter');this.$container=$(_this.container);};EnergyScreen.prototype.initWorkerForUpdating=function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);this.workerUpdate.postMessage({pointList:this.requestPoints,type:"datasourceRealtime"});};EnergyScreen.prototype.initModuleLayout=function(){if(this.options.isForMobile)this.$container.addClass('forMobile');if(!(this.store&&this.store.layout))return;for(var i=0,item;i<this.store.layout.length;i++){for(var j=0;j<this.store.layout[i].length;j++){item=this.store.layout[i][j];var modelClass,entity;if(item.modal.type&&(item.modal.type!='ModalNone'||item.isNotRender==true)){modelClass=this.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender)continue;entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);if(item.modal.type=='ModalAppButton'){entity.render();continue;}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(this.requestPoints.indexOf(point)<0){this.requestPoints.push(point);}}}
entity.render();}else if(item.modal.type=='ModalNone'){modelClass=this.factoryIoC.getModel(item.modal.type);entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);entity.render();}}}
var $springCtn=$('#paneCenter').children('.springContainer');if($springCtn.length==1&&parseFloat($springCtn[0].style.height)>=parseFloat("99%")&&parseFloat($springCtn[0].style.width)>=parseFloat("99%")){$springCtn.children('.panel-default').css({border:'none',left:0,top:0,width:'100%',height:'100%'});}};EnergyScreen.prototype.refreshData=function(e){var _this=this.self?this.self:this;if(!e.data.error&&e.data.dsItemList){var point;for(var i=0,iLen=e.data.dsItemList.length;i<iLen;i++){point=e.data.dsItemList[i];_this.mapRefresh[point.dsItemId]=point;if(_this.dictPopToEntity[point.dsItemId]){_this.popRefresh[point.dsItemId]=point;}}
var entity,arrUpdataData;for(var key in _this.listEntity){entity=_this.listEntity[key];if(entity.entity.modal.type=="ModalNone"||entity.entity.modal.type=="ModalMix")continue;arrUpdataData=[];if(entity.entity.modal&&entity.entity.modal.points){for(var i=0,iLen=entity.entity.modal.points.length;i<iLen;i++){var point=entity.entity.modal.points[i];if(!point)continue;if(entity.entity.modal.points.indexOf(point)!=i)continue;if(_this.mapRefresh[point]!=undefined)
arrUpdataData.push(_this.mapRefresh[point]);}
if(entity.entity.modal.type=="ModalAppGauge"){arrUpdataData.push({'guageTitle':entity.entity.modal.option.guageTitle,'guageFulTitle':entity.entity.modal.option.guageFulTitle,'guageFixed':entity.entity.modal.option.guageFixed,'guageUnit':entity.entity.modal.option.guageUnit,'timeLocal':entity.entity.modal.option.timeLocal,'guageDirect':entity.entity.modal.option.guageDirect,'guageBgColor':entity.entity.modal.option.guageBgColor,'transDataDot':entity.entity.modal.option.transDataDot});}
entity.update(arrUpdataData);}}}else{}},EnergyScreen.prototype.close=function(){$('.datetimepicker').remove();this.listEntity.forEach(function(row){row.close();});if(this.workerUpdate){this.workerUpdate.terminate();this.workerUpdate=null;}
if(this.windowCtn){this.windowCtn.innerHTML='';this.windowCtn=null;}
this.store=null;this.listEntity=null;this.arrEntityOrder=null;this.dsInfolist=null;this.mapRefresh=null;this.requestPoints=null;this.dictPopToEntity=null;};namespace('observer.screens').EnergyScreen=EnergyScreen;})();(function(){function HTMLParser(htmlString){var div=document.createElement('div');div.innerHTML=htmlString;return div.firstChild;}
if(window.$){$.extend({deepClone:function(obj){var type=$.type(obj);if(type==='object'){return $.extend(true,{},obj);}
else if(type==='array'){return $.extend(true,[],obj);}
else{return obj;}}});}
if(!String.prototype.toHexString){String.prototype.toHexString=function(){return this.split('').map(function(row){return'\\'+row.charCodeAt(0).toString(16);}).join('');};}
if(!Array.toMap){Array.toMap=function(arr,key){var map={};arr.forEach(function(row,i){map[row[key]]=row;});return map;};}
if(echarts){echarts.config=echarts.config||{color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500']};}
window.HTMLParser=HTMLParser;}());(function(exports){var Events={addEventListener:function(events,fn,context){var _this=this;var e=this.__info||(this.__info={});events=events.split(' ');events.forEach(function(event){var evt;event='event:'+event;evt=e[event]||(e[event]=[]);evt.push(fn,context);});},on:function(events,fn,context){return this.addEventListener(events,fn,context);},once:function(event,fn,context){var _this=this;this.addEventListener(event,function ofn(){_this.removeEventListener(event,ofn);fn.apply(context,arguments);},context);},removeEventListener:function(events,fn){var e=this.__info;var rs=null;if(e){events=events.split(' ');events.forEach(function(event){var i;event=e['event:'+event];if(event){i=event.indexOf(fn);if(i>-1){rs=event.splice(i,2)[0]||null;}}});}
return rs;},removeAllListeners:function(event){var e=this.__info;if(e){delete e['event:'+event];}},listeners:function(event){var e=this.__info;if(e){return e['event:'+event]||[];}
return[];},emit:function(event){var e=this.__info;if(e){e=e['event:'+event];if(e&&e.length){for(var i=0,len=e.length;i<len;i+=2){try{e[i].apply(e[i+1],arguments);}catch(_){Log.exception('emit',_);}}
return true;}}
return false;}};exports.Events=Events;}(window));(function(exports){function Model(values){this._values=values||{};this.initialize(this._values);}
Model.prototype=Object.create(Events);void function(){this.constructor=Model;this.initialize=function(o){for(var p in o){if(o.hasOwnProperty(p)){this.property(p);}}};this.property=function(name,value){if(!(name in this)){this[name]=this._makeProperty(name);}
return arguments.length===1?this[name]():this[name](value);};this.removeProperty=function(name){var arr,obj,p,lp;if(!(name in this)){return false;}
delete this[name];arr=name.split('.');lp=arr.pop();obj=this._values;while(p=arr.shift())obj=obj[p];delete obj[lp];for(var p in this){if(!this.hasOwnProperty(p)||p.indexOf(name)!==0)continue;delete this[p];}
return true;};this.emit=function(event){Events.emit.apply(this,arguments);};this.delayUpdate=function(fn){var pending=false;var propsPathArr=[];if(this.hasOwnProperty('emit')){try{fn.call(this);}catch(e){Log.error(e);}
return;}
try{this.emit=function(event){if(event==='update'){pending=true;}else{this.__proto__.emit.apply(this,arguments);}};propsPathArr=fn.call(this);}finally{delete this.emit;if(pending){this.emit('update',propsPathArr.join(','));}}};this.update=function(props){var _this=this;this.delayUpdate(function(){var propsPathArr=[];for(var prop in props){if(!(prop in this)){throw new Error('没有找到这个属性：'+prop);}
_this[prop](props[prop]);propsPathArr.push('update.'+prop);}
return propsPathArr;});};this.serialize=function(){return this._values;};this._makeProperty=function(prop){var body='var ov = this._values.{p};if(arguments.length && (v !== ov || Object.prototype.toString.call(v) === "[object Object]") ) {this._values.{p}=v; this.emit("update.{p}"); this.emit("update", \'update.{p}\'); } return ov;'
return new Function('v',body.replace(/\{p\}/g,prop));};}.call(Model.prototype);Model.prototype.compose=function(){var models=Array.prototype.slice.apply(arguments).concat(this);return{updateAsReplace:function(customEventName,fn){if(typeof fn!=='function'){return;}
customEventName=customEventName||'customEvent';models.forEach(function(model){model.emit=function(){};});fn.call(this);models.forEach(function(model){delete model.emit;});this.emit(customEventName,models);}.bind(this),update:function(customEventName,fn){if(typeof fn!=='function'){return;}
customEventName=customEventName||'customEvent';fn.call(this);this.emit(customEventName,models);}.bind(this)};};exports.Model=Model;}(window));(function(exports,Model){var class2type={};['Boolean','Number','String','Array','Function','Object','Date','RegExp','Error'].forEach(function(type){class2type['[object '+type+']']=type.toLowerCase();});function getType(o){if(o==null){return o+'';}
var type=Object.prototype.toString.call(o);return class2type[type]||'object';}
function NestedModel(){Model.apply(this,arguments);}
NestedModel.prototype=Object.create(Model.prototype);void function(){this.constructor=NestedModel;this.initialize=function(o,path,k){var keys,currentPath;path=path||[];currentPath=path.slice(0);if(typeof k!=='undefined'){currentPath.push(k);}
if(currentPath.length>0){this.property(currentPath.join('.'));}
if(getType(o)==='object'){keys=Object.keys(o);keys.forEach(function(p){this.initialize(o[p],currentPath,p);},this);}};this._makeProperty=function(prop){var body='var o = this._values, isObj = Object.prototype.toString.call(v) === \'[object Object]\', arr = \'{p}\'.split(\'.\'), n = arr.splice(arr.length-1, 1)[0], path = arr.length ? arr.slice(0) : [], row, ov; while(row = arr.shift()) { o = o[row]; }; ov = o[n]; if(arguments.length && (v !== ov || isObj )) {o[n]=v; if(isObj){this.initialize(v,path,n)};this.emit("update.{p}"); this.emit("update", \'update.{p}\'); } return ov;';return new Function('v',body.replace(/\{p\}/g,prop));};}.call(NestedModel.prototype);exports.NestedModel=NestedModel;}(window,window.Model));(function(exports){function ModelSet(models){this.models=models||[];}
ModelSet.prototype=Object.create(Model.prototype);void function(){this.constructor=ModelSet;this.length=function(){return this.models.length;};this.get=function(index){return this.models[index];};this.forEach=function(fn,ctx){return this.models.forEach(fn,ctx);};this.indexOf=function(model){return this.models.indexOf(model);};this.findByProperty=function(name,value){var models=this.models;for(var i=0,len=models.length;i<len;i++){if(models[i][name]()===value){return models[i];}}
return null;};this.findListByProperty=function(name,value){var models=this.models;var rs;rs=models.filter(function(row){if(row[name]()===value){return true;}
return false;});return rs;};this.insertAt=function(idx,model){var count;if(idx<0){idx+=this.models.length+1;}
if(Array.isArray(model)){this.models.splice.apply(this.models,[idx,0].concat(model));count=model.length;}else{this.models.splice(idx,0,model);count=1;model=[model];}
this.emit('insert',{index:idx,count:count,models:model});return count;};this.emit=function(evt){Model.prototype.emit.apply(this,arguments);};this.prepend=function(model){return this.insertAt(0,model);};this.append=function(model){return this.insertAt(-1,model);};this.remove=function(model){var fidx=-1;var count=0;var total=0;var removed=[];if(Array.isArray(model)){model.forEach(function(m){var idx=this.indexOf(m);if(idx===-1)return;total++;if(fidx===-1){fidx=idx;count++;}else if(idx===fidx+count){count++;}else{removed=removed.concat(this.models.splice(fidx,count));fidx=idx<fidx?idx:idx-count;count=1;}},this);if(count){removed=removed.concat(this.models.splice(fidx,count));this.emit('remove',{count:count,models:removed});}}else{var idx=this.indexOf(model);if(idx!==-1){this.models.splice(idx,1);this.emit('remove',{count:1,models:[model]});total=1;}}
return total;};this.removeAll=function(){var len=this.models.length;var removed;if(len){removed=this.models.splice(0,len);this.emit('remove',{count:len,models:removed});return true;}else{return false;}};this.move=function(from,to){var len=this.models.length;var moved=null;while(from<0){from+=len;}
while(to<0){from+=len;}
if(to>=len){while((len++)<=to){this.models.push(undefined);}}
moved=this.models.splice(from,1);this.models.splice(to,0,moved[0]);this.emit('move',{from:from,to:to,models:moved});return true;};this.serialize=function(){var ms=[];this.forEach(function(row){ms.push(row.serialize());});return ms;};this.toMap=function(key,returnModelFormat){var map={};for(var i=0,len=this.models.length;i<len;i++){map[this.models[i][key]()]=returnModelFormat?this.models[i]:this.models[i].serialize();}
return map;};}.call(ModelSet.prototype);exports.ModelSet=ModelSet;}(window));var ElScreenContainer=document.getElementById('indexMain');var SpinnerContainer=document.getElementById('divSpinner');var AlertContainer=document.getElementById('divAlert');var ScreenCurrent=undefined;var ScreenPrevious=undefined;var Spinner=new LoadingSpinner({color:'#00FFFF'});var AppConfig={userId:undefined,account:undefined,isMobile:true,chartTheme:theme.Burgeen};var ProjectConfig={projectId:undefined,projectIndex:undefined,projectList:undefined,projectInfo:undefined,dashboardList:undefined,summaryList:undefined,summaryDetail:undefined,summaryId:undefined,summaryIndex:undefined,reportList:undefined,refreshTime:undefined,refreshInterval:7200000};var WkConfig={defaultSize:20,wkList:[],refreshTime:undefined,refreshInterval:1800000};var I18n=undefined;var BomConfig=BomConfig||{};var Push;var router;$(document).ready(function(){if(navigator.userAgent.match(/iP(ad|hone|od)|Android/i))AppConfig.isMobile=true;AppConfig.language=localStorage.getItem('language');if(!AppConfig.language||(AppConfig.language!='zh'&&AppConfig.language!='en'))AppConfig.language=navigator.language.split('-')[0];if(!AppConfig.language||(AppConfig.language!='zh'&&AppConfig.language!='en'))AppConfig.language='zh';AppConfig.version='1.2.2';VersionManage=new UpdateHelper('dashboard',AppConfig.version,function(){InitI18nResource(AppConfig.language,true).always(function(rs){Push=new PushWidget();I18n=new Internationalization(null,rs);Init();});});});document.addEventListener('deviceready',onDeviceReady,false);function onDeviceReady(){if(navigator.userAgent.match(/iP(ad|hone|od)|Android/i))AppConfig.isMobile=true;AppConfig.device=device;document.addEventListener("backbutton",router.back,false);AppConfig.language=localStorage.getItem('language');AppConfig.host='http://beop.rnbtech.com.hk';if(!AppConfig.language||(AppConfig.language!='zh'&&AppConfig.language!='en'))AppConfig.language=navigator.language.split('-')[0];if(!AppConfig.language||(AppConfig.language!='zh'&&AppConfig.language!='en'))AppConfig.language='zh';AppConfig.version='1.2.2';VersionManage=new UpdateHelper('dashboard',AppConfig.version,function(){InitI18nResource(AppConfig.language,true).always(function(rs){I18n=new Internationalization(null,rs);Init();});});Push=new PushWidget();Push.init();Push.onOpenNotification(function(){Push.resetServiceBadge();Push.resetLocalBadge();});Push.onReceiveNotification(function(){Push.resetServiceBadge();Push.resetLocalBadge();});Push.onSetAliasAndTags(function(result){if(result&&result.alias){console.log('set alias:'+result.alias)}});Push.onReceiveMessage(function(){if(Push.getPushInfo().receiveMsg.message){var msg,report=[],workflow=[];try{workflow=JSON.parse(localStorage.getItem('pushWk'));if(!(workflow instanceof Array)){workflow=[]}}catch(e){workflow=[]}
try{msg=JSON.parse(Push.getPushInfo().receiveMsg.message);msg.forEach(function(item){if(item.type=='message'){report.push(item)}else if(item.type=='workflow'){workflow.push(item)}});}catch(e){report=[];workflow=[];}
if(report instanceof Array&&report.length>0){$('#btnMessage .messageNum').text(report.length).show();localStorage.setItem('pushMsg',JSON.stringify(report));if(ScreenCurrent instanceof MessageIndex){ScreenCurrent.initMessagePush(report);}else if(ScreenCurrent instanceof MessagePush){ScreenCurrent.messageDate=report;ScreenCurrent.show()}}
if(workflow instanceof Array&&workflow.length>0){if(ScreenCurrent instanceof WorkflowList){ScreenCurrent.show();}else{$('#btnWorkFlow .messageNum').text(workflow.length).show();localStorage.setItem('pushWk',JSON.stringify(workflow));}}}});}
var IndexScreen=(function(){function IndexScreen(){}
IndexScreen.prototype={show:function(){Push.setAlias();var _this=this;if(localStorage.getItem('beopHost')){AppConfig.host=localStorage.getItem('beopHost')}else{AppConfig.host='http://beop.rnbtech.com.hk'}
if(localStorage.getItem('userInfo')){_this.initNav();_this.login(true);}else{$.ajax({url:'static/app/dashboard/views/admin/login.html'}).done(function(resultHTML){$('#indexMain').html(resultHTML);_this.init();});}
if(!BomConfig.height){BomConfig.height=$(window).height()+'px';}},close:function(){document.onkeydown=false;},init:function(){var _this=this;_this.initNav();_this.initLogin();_this.initLanguage();},initLogin:function(){this.restorePwd();this.initHost();var _this=this;$("#btnLogin").off('tap').on('tap',function(e){_this.login();});$(document).on("keydown","#divLogin input",function(event){var e=event||window.event||arguments.callee.caller.arguments[0];if(e&&e.keyCode==13){_this.login();}});},initLanguage:function(){I18n.fillArea($('#divAppDashboardLanguage'));I18n.fillArea($('#divLoginInfo'));$("#selectLanguage a").off('click').click(function(e){InitI18nResource(e.currentTarget.attributes.value.value,true).always(function(rs){AppConfig.language=e.currentTarget.attributes.value.value;localStorage.setItem('language',AppConfig.language);I18n=new Internationalization(null,rs);Init();});e.preventDefault();});},login:function(isRestorePwd){var _this=this;var msg;var pushInfo;SpinnerControl.show();var loginFail=function(msg){$('.alert').remove();window.plugins&&window.plugins.toast.show(msg,'short','center');console.log(msg);Spinner.stop();};if(isRestorePwd){var userName=JSON.parse(localStorage.userInfo).name,password=JSON.parse(localStorage.userInfo).pwd;}else{var $btnLogin=$('#btnLogin');var userName=$("#userName").val(),password=$("#password").val();if(!(userName&&password)){loginFail(I18n.resource.appDashboard.core.LOGIN_ERR_1);return;}}
WebAPI.post("/login/1",{name:userName,pwd:password,agent:jscd?jscd:{}}).then(function(login_result){try{var after_login=function(){CssAdapter.adapter();if(login_result.status!=undefined&&login_result.status==true){if(AppConfig.device&&AppConfig.device.platform){_hmt.push(['_trackEvent','mobile-login','login',AppConfig.device.platform]);}
if(login_result.projects&&login_result.projects.length>0){Push.setAlias(login_result.id);_this.rememberPwd(isRestorePwd);AppConfig.userId=login_result.id;AppConfig.account=$("#userName").val();AppConfig.userProfile=login_result.userProfile;AppConfig.userOfRole=login_result.userProfile.userOfRole;ProjectConfig.projectList=login_result.projects;if(localStorage.getItem('pushMsg')){try{msg=JSON.parse(localStorage.getItem('pushMsg'));msg=msg.filter(function(item){return item.type=='message'});}catch(e){msg=null;}
if(msg instanceof Array&&msg.length>0){$('#btnMessage .messageNum').text(msg.length).show();}}
var msgWk;if(localStorage.getItem('pushWk')){try{msgWk=JSON.parse(localStorage.getItem('pushWk'));}catch(e){msgWk=null;}
if(msgWk instanceof Array&&msgWk.length>0){$('#btnWorkFlow .messageNum').text(msgWk.length).show();}}
if(!localStorage.getItem('defaultProjectId')){pushInfo=Push.getPushInfo().openNote.extras;if(pushInfo&&pushInfo.message){try{msg=JSON.parse(pushInfo.message);msg=msg.filter(function(item){return item.type=='message'});}catch(e){msg=null;}
if(msg instanceof Array&&msg.length>0){localStorage.setItem('pushMsg',pushInfo.message);router.empty().to({typeClass:MessagePush,data:msg});return;}
try{msg=JSON.parse(pushInfo.message);msg=msg.filter(function(item){return item.type=='workflow'});}catch(e){msg=null;}
if(msg instanceof Array&&msg.length>0){router.to({typeClass:WorkflowDetail,data:{id:msg[0].id}});return;}}
switch(localStorage.getItem('module')){case'project':router.empty().to({typeClass:ProjectList,data:{}});break;case'report':router.empty().to({typeClass:ReportIndex,data:{}});break;case'workflow':router.empty().to({typeClass:WorkflowIndex,data:{}});break;default:router.empty().to({typeClass:ProjectList,data:{}});break;}}else{var hasDefault=false;for(var i=0;i<ProjectConfig.projectList.length;i++){if(ProjectConfig.projectList[i].id==localStorage.getItem('defaultProjectId')){hasDefault=true;ProjectConfig.projectId=ProjectConfig.projectList[i].id;AppConfig.projectId=ProjectConfig.projectId;ProjectConfig.projectInfo=ProjectConfig.projectList[i];ProjectConfig.projectIndex=i;break;}}
if(!hasDefault&&ProjectConfig.projectList[0]){ProjectConfig.projectId=ProjectConfig.projectList[0].id;AppConfig.projectId=ProjectConfig.projectId;ProjectConfig.projectInfo=ProjectConfig.projectList[0];ProjectConfig.projectIndex=0;}
pushInfo=Push.getPushInfo().openNote.extras;if(pushInfo&&pushInfo.message){try{msg=JSON.parse(pushInfo.message);msg=msg.filter(function(item){return item.type=='message'});}catch(e){msg=null;}
if(msg instanceof Array&&msg.length>0){localStorage.setItem('pushMsg',pushInfo.message);router.empty().to({typeClass:MessagePush,data:msg});return;}
try{msg=JSON.parse(pushInfo.message);msg=msg.filter(function(item){return item.type=='workflow'});}catch(e){msg=null;}
if(msg instanceof Array&&msg.length>0){router.to({typeClass:WorkflowDetail,data:{id:msg[0].id}});return;}}
switch(localStorage.getItem('module')){case'project':router.empty().to({typeClass:ProjectSummary,data:{}});break;case'report':router.empty().to({typeClass:ReportIndex,data:{}});break;case'workflow':router.empty().to({typeClass:WorkflowIndex,data:{}});break;default:router.empty().to({typeClass:ProjectSummary,data:{}});break;}}}else{loginFail(I18n.resource.appDashboard.core.LOGIN_ERR_2);if(isRestorePwd){localStorage.removeItem('userInfo');}}}else{loginFail(I18n.resource.appDashboard.core.LOGIN_ERR_1);if(isRestorePwd){localStorage.removeItem('userInfo');}}}}catch(e){loginFail(I18n.resource.appDashboard.core.LOGIN_ERR_3);if(isRestorePwd){localStorage.removeItem('userInfo');}
return false;}
after_login();}).fail(function(){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.core.NET_INFO_1,'short','bottom');console.log(I18n.resource.appDashboard.core.NET_INFO_1);if($('#btnLogin').length>0)return;$.ajax({url:'static/app/dashboard/views/admin/login.html'}).done(function(resultHTML){$('#indexMain').html(resultHTML);try{$("#userName").val(JSON.parse(localStorage.userInfo).name);$("#password").val(JSON.parse(localStorage.userInfo).pwd);}catch(e){}
_this.init();});}).always(function(){SpinnerControl.hide();})},rememberPwd:function(isRestorePwd){if(!isRestorePwd){localStorage["userInfo"]=JSON.stringify({name:$("#userName").val(),pwd:$("#password").val()});}},restorePwd:function(){if(localStorage["userInfo"]){var data=JSON.parse(localStorage["userInfo"]);if(data.pwd&&data.pwd!=""){$("#userName").val(data.name);$("#password").val(data.pwd);}}},initHost:function(){$('#ImgLogin img').on('doubleTap',function(){var divSetHost=$('#divHostSet');var $divHostShow=$('.divHostShow');$divHostShow.text(AppConfig.host);divSetHost.show();divSetHost.find('li').not(':last').on('tap',function(e){localStorage.setItem('beopHost',$(e.target).attr('value'));AppConfig.host=$(e.target).attr('value');$divHostShow.text($(e.target).attr('value'));});divSetHost.find('input').on('change',function(e){localStorage.setItem('beopHost','http://'+$(e.target).val());AppConfig.host='http://'+$(e.target).val();$divHostShow.text('http://'+$(e.target).val());})})},initNav:function(){$('#btnBack').off('tap').on('tap',function(e){var ifrm=document.getElementById('iframeSon');if(ifrm===null){router.back();}else{var $=ifrm.contentWindow.$;var $sonBack=$(ifrm.contentWindow.document.querySelector(".back"));var $project=$(ifrm.contentWindow.document.querySelector(".projectInfo"));if($project.length===1){router.back();}else{$sonBack.trigger("tap");}}});$('#btnProject').off('tap').on('tap',function(e){if(ProjectConfig.projectId){router.to({typeClass:ProjectSummary});}else{router.to({typeClass:ProjectList});}
e.preventDefault();});$('#btnReport').off('tap').on('tap',function(e){router.to({typeClass:ReportIndex});e.preventDefault();});$('#btnWorkFlow').off('tap').on('tap',function(e){router.to({typeClass:WorkflowIndex});e.preventDefault();});}};return IndexScreen;})();function Init(){var projectInfo=JSON.parse(localStorage.getItem('defaultProject'));if(!(projectInfo&&projectInfo.arrDp)){ScreenManager.show(IndexScreen);I18n.fillArea($("#navBottom"));navigator.splashscreen&&navigator.splashscreen.hide();return;}else{var pageNum=projectInfo.arrDp;}
var advertise=document.createElement('div');advertise.className='advPage';advertise.innerHTML='<span class="skipOver">跳过</span>';var advBar=document.createElement('div');advBar.className='advBar';if(pageNum>1){advertise.appendChild(advBar);}
var img;for(var i=0;i<pageNum;i++){img=document.createElement('img');img.className='advImg';img.setAttribute('alt','');img.src='http://images.rnbtech.com.hk/static/images/project_dp/'+projectInfo.name_en+'_'+(i+1)+'.jpg';if(i==0){advBar.innerHTML+='<span class="advSpan cur"></span>'}else{advBar.innerHTML+='<span class="advSpan"></span>'}
advertise.appendChild(img);}
var $advImg=$(advertise).find('img');var loadDeferred=$.Deferred();var isLoad=0,isEnd=0;$advImg.load(function(){isLoad++;isEnd++;if(isLoad==$advImg.length&&isEnd==$advImg.length){loadDeferred.resolve();}});$advImg.error(function(){loadDeferred.reject();});loadDeferred.done(function(){$(document.body).append(advertise);navigator.splashscreen&&navigator.splashscreen.hide();var len=$advImg.length;var $advSpan=$('.advSpan');var index=0;var timer=setInterval(function(){tabImg();},3000);$('.skipOver').off('click').click(function(){skipPage();});$('.advPage').on('touchend',function(e){e.preventDefault();tabImg();});function skipPage(){clearInterval(timer);ScreenManager.show(IndexScreen);$('.advPage').remove();}
function tabImg(){if(index<len-1){index++;$advImg.css({'transform':'translateX('+(-100*index)+'%)','WebkitTransform':'translateX('+(-100*index)+'%)'});$advSpan.removeClass('cur');$advSpan.eq(index).addClass(' cur');}else{skipPage();}}
I18n.fillArea($("#navBottom"));}).fail(function(){navigator.splashscreen&&navigator.splashscreen.hide();ScreenManager.show(IndexScreen);I18n.fillArea($("#navBottom"));})}
var beop=window.beop||{};beop.baseMap=beop.baseMap||{};(function(window,$,nsBaseMap){var CONSTS={AMap:{name:'高德地图',url:location.protocol+'//webapi.amap.com/maps',params:{key:'9cc89c68a4bd6f3f5f65589f85ad7685',v:'1.3'}},GLoader:{name:'Google Loader',url:'https://www.google.com/jsapi'},GMap:{name:'Google Map',url:'http://maps.googleapis.com/maps/api/js',params:{key:'AIzaSyAzzOzAmrGov5GLacve9w8_Q8dS-xBYCgc',sensor:'false',libraries:'geometry,places'}}};var defaults={mapContainer:'mapContainer',defaultLng:'121.6283679',defaultLat:'31.2114943',markerImgPath:'http://images.rnbtech.com.hk/static/images/map_marker_online.png'};var util={inherits:function(clazz,base){var clazzPrototype=clazz.prototype;var F=function(){};F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;},loadJS:function(url,callback){var done=false;var script=document.createElement('script');script.type='text/javascript';script.language='javascript';script.src=url;script.onload=script.onreadystatechange=function(){if(!done&&(!script.readyState||script.readyState=='loaded'||script.readyState=='complete')){done=true;script.onload=script.onreadystatechange=null;typeof callback==='function'&&callback.call(script);}}
document.getElementsByTagName("head")[0].appendChild(script);},runJS:function(url,callback){this.loadJS(url,function(){document.getElementsByTagName('head')[0].removeChild(this);typeof callback==='function'&&callback();});}};function PaneMapSearch(map,iptSch,paneSchRes){this.map=map;this.$iptSch=$(iptSch);this.$paneSchRes=$(paneSchRes);this.$liSets=[];this.rs=null;this.rsCount=0;this.showLimits=5;this.curSelect=-1;this.isPaneShow=false;this.bindEvents();this.$iptSch.parent('div').show();}
PaneMapSearch.prototype.bindEvents=function(){var _this=this;this.$iptSch.keyup(function(e){var kc=e.keyCode;switch(kc){case 38:_this.prev();e.preventDefault();break;case 40:_this.next();e.preventDefault();break;case 13:_this.doSearch();break;default:_this.autoComplete();break;}});this.$paneSchRes.on('click','a',function(e){var $this=$(this);var index=$this.attr('data-sort')||0;_this.to(index);_this.doSearch();e.preventDefault();});};PaneMapSearch.prototype.showPane=function(){this.$paneSchRes.show();this.isPaneShow=true;};PaneMapSearch.prototype.hidePane=function(){this.$paneSchRes.hide();this.isPaneShow=false;};PaneMapSearch.prototype.prev=function(){this.to(this.curSelect-1);};PaneMapSearch.prototype.next=function(){this.to(this.curSelect+1);};PaneMapSearch.prototype.to=function(index){if(!this.isPaneShow){this.showPane();return;}
index=Math.min(Math.max(0,index),this.rsCount-1);if(index===this.curSelect)return;this.curSelect=index;this.$liSets.removeClass('on');this.$liSets.eq(index).addClass('on');this.$iptSch.val(this.rs[index].name);};PaneMapSearch.prototype.doSearch=function(){var _this=this;var keywords=this.$iptSch.val().trim();var options;if(keywords==='')return;_this.hidePane();if(this.curSelect>-1){options={pageSize:1,city:this.rs[this.curSelect].adcode}}
this.map.placeSearch(keywords,options,function(rs){if(rs.status!==0)return;rs=rs.data;if(_this.curSelect<0){_this.map.setCenter(rs[0].lng,rs[0].lat);_this.map.setZoom(15);}else{_this.map.trigger('click',{lnglat:rs[0]});}});};PaneMapSearch.prototype.autoComplete=function(){var _this=this;var keywords=this.$iptSch.val().trim();keywords=keywords.replace(/[\\\?\.\+\^\$]/g,'');if(keywords==='')return;this.map.search(keywords,function(rs){if(rs.status!==0)return;rs=rs.data;var arrHtml=[];_this.rsCount=Math.min(rs.length,_this.showLimits);_this.rs=rs;_this.curSelect=-1;if(_this.rsCount<=0){_this.hidePane();return;}
for(var i=0;i<_this.rsCount;i++){arrHtml.push('<li><a data-sort="'+i+'" href="javascript:;"><span class="rs-name">'+
rs[i].name.replace(new RegExp(keywords.replace(/([\(\)])/g,'\\$1')),'<span class="keywords">'+keywords+'</span>')+'</span><span class="rs-district">'+
rs[i].district+'</span</a></li>');};_this.$paneSchRes.html(arrHtml.join(''));_this.showPane();_this.$liSets=_this.$paneSchRes.children('li');});};PaneMapSearch.prototype.destroy=function(){this.$iptSch.unbind();this.$paneSchRes.off();};var BaseMap=function(options){this.options=$.extend({},defaults,options);this.markers=[];};BaseMap.load=function(type,callback){var _this=this;var url=CONSTS[type].url;var params=CONSTS[type].params;var p=[];for(var i in params){if(params.hasOwnProperty(i)){p.push(i+'='+params[i]);}}
if(p.length)url=url+'?';util.runJS(url+p.join('&'),function(){window.console&&console.log('load JS: '+url+' success!');typeof callback&&callback.call(_this);});};var GDMap=function(options){BaseMap.call(this,options);this.markers=[];this.controls=[];this.zoom=15;this.init();};GDMap.load=function(options,callback){if(typeof options==='function'){callback=options;options=null;}
if(!GDMap.isLoaded()){BaseMap.load('AMap',function(){callback(new GDMap(options));});}else{callback(new GDMap(options));}};GDMap.isLoaded=function(){return window.AMap&&window.AMap.Map;};GDMap.prototype.init=function(){this.map=new AMap.Map(this.options.mapContainer,{resizeEnable:true,view:new AMap.View2D({zoom:this.zoom})});};GDMap.prototype.setCenter=function(lng,lat){return this.map.setCenter(this.getPoint(lng,lat));};GDMap.prototype.setZoom=function(level){return this.map.setZoom(level);};GDMap.prototype.getPoint=function(lng,lat){return new AMap.LngLat(lng,lat);};GDMap.prototype.addMarker=function(lng,lat){var marker;lng=lng||this.options.defaultLng;lat=lat||this.options.defaultLat;marker=new AMap.Marker({map:this.map,icon:this.options.markerImgPath,position:this.getPoint(lng,lat)});marker&&this.markers.push(marker);return marker;};GDMap.prototype.removeMarker=function(marker){var removed;for(var i=this.markers.length-1;i>=0;i--){if(this.markers[i]===marker){removed=this.markers.splice(i,1);removed.setMap(null);}};};GDMap.prototype.removeAllMarkers=function(){for(var i=this.markers.length-1;i>=0;i--){this.markers[i].setMap(null);}
this.markers.length=0;};GDMap.prototype.addListener=function(eventName,handler){AMap.event.addListener(this.map,eventName,handler);};GDMap.prototype.trigger=function(eventName,args){AMap.event.trigger(this.map,eventName,args);};GDMap.prototype.getAddress=function(lng,lat,callback){var _this=this;var geocoder;var format=[],statusCode=-1;AMap.service(["AMap.Geocoder"],function(){var geocoder=new AMap.Geocoder();geocoder.getAddress(_this.getPoint(lng,lat),function(status,rs){var geoinfo=rs.regeocode;if(status==='complete'&&rs.info==='OK'){format.push({name:geoinfo.formattedAddress,components:{city:geoinfo.addressComponent.city,province:geoinfo.addressComponent.province}});statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.getLocation=function(addr,callback){var _this=this;var format=[],statusCode=-1;AMap.service(["AMap.Geocoder"],function(){var geocoder=new AMap.Geocoder();geocoder.getLocation(addr,function(status,rs){var point;if(status==='complete'&&rs.info==='OK'){for(var i=0,len=rs.geocodes.length;i<len;i+=1){point=rs.geocodes[i].location;format.push({lng:point.lng,lat:point.lat});}
statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.search=function(keywords,callback){var format=[],statusCode=-1;AMap.service(['AMap.Autocomplete'],function(){var auto=new AMap.Autocomplete();if(keywords.length>0){auto.search(keywords,function(status,result){if(status==='complete'&&result.info==='OK'){for(var i=0,len=result.tips.length;i<len;i++){format.push({name:result.tips[i].name,district:result.tips[i].district,adcode:result.tips[i].adcode});};statusCode=0;typeof callback==='function'&&callback({status:statusCode,data:format});}});}});};GDMap.prototype.placeSearch=function(keywords,options,callback){var pSearch;if(typeof options==='function'){callback=options;options=null;}
AMap.service(['AMap.PlaceSearch'],function(){pSearch=new AMap.PlaceSearch(options);pSearch.search(keywords,function(status,rs){var format=[],statusCode=-1;var row;if(status==='complete'&&rs.info==='OK'){for(var i=0,len=rs.poiList.pois.length;i<len;i++){row=rs.poiList.pois[i];format.push({lng:row.location.getLng(),lat:row.location.getLat(),address:row.address});}
statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.setFitView=function(){this.map.setFitView();};GDMap.prototype.addSearchBox=function(iptSch,mapSchPane){this.controls.push(new PaneMapSearch(this,iptSch,mapSchPane));};GDMap.prototype.destroy=function(){for(var i=this.controls.length-1;i>=0;i--){if(typeof this.controls[i].destroy!=='function'){console.warn('one map UI control not destroy!');continue;}
this.controls[i].destroy();};this.map.destroy();};var GoogleMap=function(options){BaseMap.call(this,options);this.markers=[];this.controls=[];this.zoom=16;this.init();};GoogleMap.load=function(options,callback){if(typeof options==='function'){callback=options;options=null;}
if(!GoogleMap.isLoaded()){BaseMap.load('GLoader',function(){var params=CONSTS['GMap'].params;var p=[];for(var i in params){if(params.hasOwnProperty(i)){p.push(i+'='+params[i]);}}
google.load('maps',3,{other_params:p.join('&'),callback:function(){callback(new GoogleMap(options));}});});}else{callback(new GoogleMap(options));}};GoogleMap.isLoaded=function(){return window.google&&window.google.maps;};GoogleMap.prototype.init=function(){this.map=new google.maps.Map($('#'+this.options.mapContainer)[0],{zoom:this.zoom,disableDefaultUI:true,center:this.getPoint(this.options.defaultLng,this.options.defaultLat)});};GoogleMap.prototype.setCenter=function(lng,lat){return this.map.setCenter(this.getPoint(lng,lat));};GoogleMap.prototype.setZoom=function(level){return this.map.setZoom(level);};GoogleMap.prototype.getPoint=function(lng,lat){return new google.maps.LatLng(lat,lng);};GoogleMap.prototype.addMarker=function(lng,lat){var marker;lng=lng||this.options.defaultLng;lat=lat||this.options.defaultLat;marker=new google.maps.Marker({map:this.map,icon:this.options.markerImgPath,position:this.getPoint(lng,lat)});marker&&this.markers.push(marker);return marker;};GoogleMap.prototype.removeMarker=function(marker){var removed;for(var i=this.markers.length-1;i>=0;i--){if(this.markers[i]===marker){removed=this.markers.splice(i,1);removed.setMap(null);}};};GoogleMap.prototype.removeAllMarkers=function(){for(var i=this.markers.length-1;i>=0;i--){this.markers[i].setMap(null);}
this.markers.length=0;};GoogleMap.prototype.addListener=function(eventName,handler){var _this=this;return google.maps.event.addListener(this.map,eventName,function(e){_this.formatEventResult(e);handler.call(this,e);});};GoogleMap.prototype.removeAllListener=function(){google.maps.event.clearInstanceListeners(this.map);};GoogleMap.prototype.trigger=function(eventName,args){args.latLng=args.lnglat;return google.maps.event.trigger(this.map,eventName,args);};GoogleMap.prototype.formatEventResult=function(rs){if(rs.latLng){rs.lnglat={lng:rs.latLng.lng(),lat:rs.latLng.lat()};}};GoogleMap.prototype.getAddress=function(lng,lat,callback){var _this=this;var geocoder=new google.maps.Geocoder();var format=[],statusCode=-1;geocoder.geocode({latLng:this.getPoint(lng,lat)},function(rs,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0,len=rs.length;i<len;i++){format.push({name:rs[0].formatted_address,components:_this._formatAddressComponents(rs[i].address_components)});};statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});};GoogleMap.prototype.getLocation=function(addr,callback){var geocoder=new google.maps.Geocoder();var format=[],statusCode=-1;geocoder.geocode({address:addr},function(rs,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0,len=rs.length;i<len;i++){format.push({name:rs[i].formatted_address,lng:rs[i].geometry.location.lng(),lat:rs[i].geometry.location.lat()});};statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});};GoogleMap.prototype.search=function(keywords,callback){};GoogleMap.prototype.setFitView=function(){if(this.markers.length<=0)return;this.map.panTo(this.markers[0].getPosition());};GoogleMap.prototype.addSearchBox=function(iptSch){var _this=this;var input=document.getElementById('btnGoogleSch');var searchBox;this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);searchBox=new google.maps.places.SearchBox((input));google.maps.event.addListener(searchBox,'places_changed',function(){var places=searchBox.getPlaces();if(places.length<=0)return;_this.trigger('click',{latLng:places[0].geometry.location});});input.style.display='';};GoogleMap.prototype.destroy=function(){for(var i=this.controls.length-1;i>=0;i--){if(typeof this.controls[i].destroy!=='function'){console.warn('one map UI control does not destroy!');continue;}
this.controls[i].destroy();};this.removeAllMarkers();this.removeAllListener();};GoogleMap.prototype._formatAddressComponents=function(addressComponents,type){var format={};for(var i=addressComponents.length-1;i>=0;i--){switch(addressComponents[i].types[0]){case'administrative_area_level_1':format.province=addressComponents[i].long_name;break;case'locality':format.city=addressComponents[i].long_name;break;}}
return format;};nsBaseMap.load=function(callback){if(I18n.type.indexOf('zh')>-1){GDMap.load(callback);}else{GoogleMap.load(callback);}};}(window,jQuery,beop.baseMap,undefined));var beop;(function(beop){var configMap={AmapKey:'9cc89c68a4bd6f3f5f65589f85ad7685',AmapUrl:location.protocol+'//webapi.amap.com/maps',AmapVersion:'1.3',GmapKey:'AIzaSyAzzOzAmrGov5GLacve9w8_Q8dS-xBYCgc',GmapUrl:'https://maps.googleapis.com/maps/api/js',GmapVersion:'3.0',mapContainer:'map-canvas',project_img_path:'http://images.rnbtech.com.hk/static/images/project_img/',mapLoadCallBack:'mapLoadCallBack',defaultLatlng:'31.2114943,121.6283679',projectStatus:{online:'Online',offline:'Offline'},online_img_path:'http://images.rnbtech.com.hk/static/images/map_marker_online.png',offline_img_path:'http://images.rnbtech.com.hk/static/images/map_marker_offline.png',neighbouringRadius:80000,loadMapTimeout:3000};function inherits(clazz,base){var clazzPrototype=clazz.prototype;function F(){}
F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;}
function buildSrc(url,opts){if(!url){return null}
if(!opts){return url}
var paramArr=[];for(var prop in opts){if(opts[prop]){paramArr.push(prop+'='+opts[prop]);}}
return url+'?'+paramArr.join('&');}
function getProject(id){for(var n=0,len=ProjectConfig.projectList.length;n<len;n++){var item=ProjectConfig.projectList[n];if(item.id==id){return item;}}}
function BeopMap(){this.url='';this.key='';this.container=configMap.mapContainer;this.map=null;this.zoom=5;this.markers={};this.infoWindows={};this.$projectInfo=$('#divProjectInfo');this.projectIndex=undefined;}
BeopMap.prototype.init=function(){};BeopMap.prototype.initPaneProject=function(){var _this=this;_this.initSingleProject(ProjectConfig.projectInfo);var swipeEnable=true;this.$projectInfo.off('touchstart').on('touchstart','.iconHide',function(e){e.stopPropagation();$('.iconHide').css('display','none');$('.iconShow').css('display','inline-block');_this.$projectInfo.animate({opacity:0.25,bottom:'-30%'},500,function(){});}).on('touchstart','.iconShow',function(e){e.stopPropagation();$('.iconHide').css('display','inline-block');$('.iconShow').css('display','none');_this.$projectInfo.animate({opacity:1,bottom:0},500,function(){});});this.$projectInfo.off('swipeDown').on('swipeDown',function(){$('.iconHide').css('display','none');$('.iconShow').css('display','inline-block');_this.$projectInfo.animate({opacity:0.25,bottom:'-30%'},500,function(){});});this.$projectInfo.off('swipeUp').on('swipeUp',function(){$('.iconHide').css('display','inline-block');$('.iconShow').css('display','none');_this.$projectInfo.animate({opacity:1,bottom:0},500,function(){});});this.$projectInfo.off('swipeLeft').on('swipeLeft',function(){var length=$('.divDetail').length;if(_this.projectIndex>=length-1||!swipeEnable)return;_this.projectIndex+=1;swipeEnable=false;_this.$projectInfo.animate({left:(-100*_this.projectIndex)+'%'},500,function(){swipeEnable=true;});});this.$projectInfo.off('swipeRight').on('swipeRight',function(){var length=$('.divDetail').length;if(_this.projectIndex<=0||!swipeEnable)return;_this.projectIndex-=1;swipeEnable=false;_this.$projectInfo.animate({left:(-100*_this.projectIndex)+'%'},500,function(){swipeEnable=true;});});};BeopMap.prototype.loadMapScriptFailed=function(msg){console.log(this.mapName+I18n.resource.core.beopMap.LOADED_FAILED);if(msg){console.log(msg);}};BeopMap.prototype.loadScript=function(opts){if(!opts){opts={};}
$.extend(opts,{key:this.key});var src=buildSrc(this.url,opts),_this=this;$.ajax({url:src,dataType:"script",success:function(){if(_this instanceof GoogleMap){isMapAsyncLoadSuccess=true;}
if(typeof isMapAsyncLoadSuccess=='undefined'&&_this instanceof GaodeMap){isMapAsyncLoadSuccess=false;return false;}
if(isMapAsyncLoadSuccess){console.log(_this.mapName+I18n.resource.core.beopMap.LOADED_SUCCESSFUL+'.');}else{_this.loadMapScriptFailed('');}},error:function(jqXHR,errorText){_this.loadMapScriptFailed(errorText);},timeout:configMap.loadMapTimeout});};BeopMap.prototype.clickMarker=function(marker){if(!marker){return;}
this.trigger(marker,'click');};BeopMap.prototype.getInfoWindowContent=function(project){var info=[];info.push("<div style=\"padding:0px 0px 0px 4px;\"><b>"+StringUtil.getI18nProjectName(project)+"</b>");if(project.online){info.push(I18n.resource.admin.projectSelector.PROJECT_STATUS+" : "+project.online);}
if(project.lastReceivedTime){info.push(I18n.resource.admin.projectSelector.PROJECT_LAST_RECEIVED_TIME+" : "+project.lastReceivedTime);}
info.push("</div'>");return info.join('<br/>')};BeopMap.prototype.getMarkerImagePath=function(isOnline){return isOnline?configMap.online_img_path:configMap.offline_img_path;};BeopMap.prototype.expandNearbyProject=function(){if(this.$nearbyProjects.find('.media').length===0){return;}
this.$nearbyProjects.slideDown(500);};BeopMap.prototype.addMarkers=function(markerCollection){var item,marker,infoWindow,isOnline;if(!markerCollection||!markerCollection.length){return false}
var _this=this;for(var m=0;m<markerCollection.length;m++){item=markerCollection[m];isOnline=item.online&&item.online===configMap.projectStatus.online?true:false;marker=this.addMarker(item.id,item.latlng,isOnline);if(!marker){continue;}
infoWindow=this.addInfoWindow(item.id,this.getInfoWindowContent(item));_this.addMarkerClick(marker,(function(item){return function(){_this.initSingleProject(item);}})(item));}};BeopMap.prototype.renderNearbyProjects=function(projectList){var $projectsContainer=this.$nearbyProjects.find('.projects-section');$projectsContainer.empty();for(var m=0,len=projectList.length;m<len;m++){$projectsContainer.append(this.createProjectItemOfCard(projectList[m]));}};BeopMap.prototype.createProjectItemOfCard=function(project){var projectName=StringUtil.getI18nProjectName(project);var divMedia=$('<div class="media wobble-horizontal"><a class="pull-left"><img class="media-object" src="'+BEOPUtil.getProjectImgPath(project)+'" style="width: 48px; height: 48px;"></a></div>')
divMedia.attr('id',project.id+"-"+project.name_en+"-"+project.level);divMedia.attr('title',projectName);var divMediaBody=$('<div class="media-body"></div>').append($('<h4 class="media-heading"></h4>').text(projectName));divMedia.append(divMediaBody);return divMedia;};BeopMap.prototype.expandProjectPanel=function(callback){this.$projectDetailCard.slideDown("normal",callback?callback.bind(this):$.noop);};BeopMap.prototype.collapseProjectPanel=function(callback){this.$projectDetailCard.slideUp("normal",callback?callback.bind(this):$.noop);};BeopMap.prototype.addToVersionHistory=function(){var versionHistory=window.localStorage.getItem('versionHistory'),$controlBtn;if(!versionHistory){$controlBtn=this.createVersionHistory('获取最新版本失败，请重新登录');}else{$controlBtn=this.createVersionHistory(versionHistory);}
this.addControl($controlBtn,function(){ScreenManager.goTo({page:'VersionHistory'});})};BeopMap.prototype.createVersionHistory=function(text){var versionHistoryUI;versionHistoryUI=$('<div class="map-beop-version-history" title="beop版本历史记录"><a href="#page=VersionHistory"> beop version: '+text+' </a></div>');return versionHistoryUI;};BeopMap.prototype.loadProjectPanel=function(project){if(!project){return false;}
var name=StringUtil.getI18nProjectName(project);this.$projectDetailCard.attr('project-id',project.id).find('.project-img').attr('src',BEOPUtil.getProjectImgPath(project)).attr('alt',name).end().find('.name').text(name);if(!project.address){this.$projectDetailCard.find('.address').hide();}else{this.$projectDetailCard.find('.address').show().find('address').text(project.address);}};BeopMap.prototype.initSingleProject=function(project){var _this=this;this.projectIndex=0;this.$projectInfo.children().not(':first-child').remove();this.$projectInfo.css('left',0);var nearbyProjectList=_this.getNearbyProjects(project.id,configMap.neighbouringRadius);var divWidth=100/(nearbyProjectList.length+1);var $projectName=$('.projectName');var $main=$('.mainDetail');$projectName.html(project.name_cn);$main.find('.iconSelect').remove();if(ProjectConfig.projectId==project.id){$main.append('<span class="iconSelect"></span>');}
$main.attr('project-to',project.id);$main.css({'background-image':'url(http://images.rnbtech.com.hk/static/images/project_img/'+project.pic+')','width':divWidth+'%'});_this.openInfoWindow(_this.infoWindows[project.id],_this.markers[project.id]);var strNearby;for(var i=0;i<nearbyProjectList.length;i++){strNearby=new StringBuilder();strNearby.append('<div class="divDetail nearbyDetail zepto-ev" project-to="'+nearbyProjectList[i].id+'"style="width:'+divWidth+'%;background-image:url(http://images.rnbtech.com.hk/static/images/project_img/'+nearbyProjectList[i].pic+')">');strNearby.append('<div class="divInfo"><span class="projectName">'+nearbyProjectList[i].name_cn+'</span>');strNearby.append('<span class="iconShow glyphicon glyphicon-chevron-up"></span>');strNearby.append('<span class="iconHide glyphicon glyphicon-remove"></span></div>');strNearby.append('</div>');this.$projectInfo.append(strNearby.toString());}
var $divDetail=$('.divDetail');this.$projectInfo.css('width',(100*(nearbyProjectList.length+1))+'%');$divDetail.off('tap').on('tap',function(e){if($(e.gesture.target).hasClass('glyphicon'))return;var id=$(e.currentTarget).attr('project-to');for(var i=0;i<ProjectConfig.projectList.length;i++){if(ProjectConfig.projectList[i].id==id){ProjectConfig.projectInfo=ProjectConfig.projectList[i];router.to({typeClass:ProjectSummary,data:{index:i}});break;}}});};BeopMap.prototype.setFitView=function(){};BeopMap.prototype.getNearbyProjects=function(centerProjectId,radius){var centerProjectMarker=this.markers[centerProjectId],centerProjectLnglat=this.getMarkerPosition(centerProjectMarker),nearbyList=[];for(var projectId in this.markers){if((projectId+'')===(centerProjectId+'')){continue;}
var marker=this.markers[projectId],markLnglat=this.getMarkerPosition(marker);if(this.computeDistanceBetween(centerProjectLnglat,markLnglat)<=radius){nearbyList.push(getProject(projectId));}}
return nearbyList;};function GaodeMap(){BeopMap.call(this);this.url=configMap.AmapUrl;this.key=configMap.AmapKey;this.mapName=I18n.resource.core.beopMap.AMAP;}
GaodeMap.prototype.init=function(){BeopMap.prototype.init.call(this);if(this.map){this.map.destroy&&this.map.destroy();}
this.map=new AMap.Map(this.container,{view:new AMap.View2D({zoom:this.zoom,scrollWheel:false})});};GaodeMap.prototype.getLatLng=function(lat,lng){return new AMap.LngLat(lng,lat);};GaodeMap.prototype.isMapLoaded=function(){try{if(AMap&&AMap.Map){return true;}}catch(e){return false;}};GaodeMap.prototype.addControl=function($controlUI,callback){var _this=this;var controlDiv=function(){};controlDiv.prototype={addTo:function(map,dom){dom.appendChild(this._getHtmlDom(map));},_getHtmlDom:function(map){this.map=map;$controlUI.click(function(){callback.call(_this);});this.container=$controlUI[0];return $controlUI[0];}};this.map.addControl(new controlDiv(this.map));};GaodeMap.prototype.load=function(){if(this.isMapLoaded()){mapLoadCallBack();}else{this.loadScript({v:configMap.AmapVersion,callback:configMap.mapLoadCallBack});}};GaodeMap.prototype.trigger=function(instance,eventName,var_args){AMap.event.trigger(instance,eventName,var_args)};GaodeMap.prototype.openInfoWindow=function(infoWindow,marker){infoWindow.open(this.map,marker.getPosition());};GaodeMap.prototype.addMarker=function(identifier,lnglat,isOnline,opts){if(!identifier||!lnglat){return null;}
if(!lnglat){lnglat=configMap.defaultLatlng;}
if(typeof lnglat==='string'){var temp=lnglat.split(',');lnglat={'lat':+temp[0],'lng':+temp[1]};}
var defaultOpts={map:this.map,position:this.getLatLng(lnglat.lat,lnglat.lng),offset:new AMap.Pixel(-8,-8),content:'<div class="map-marker" data-id="'+identifier+'"></div>',extData:{id:identifier}};if(opts){$.extend(defaultOpts,opts);}
var marker=new AMap.Marker(defaultOpts);this.markers[identifier]=marker;return marker;};GaodeMap.prototype.removeMarker=function(identifier){if(!identifier){return false}
var marker=this.markers[identifier];if(!marker){return false;}
marker.setMap(null);return true;};GaodeMap.prototype.addInfoWindow=function(id,content){var infoWindow=new AMap.InfoWindow({offset:new AMap.Pixel(0,0),content:content});this.infoWindows[id]=infoWindow;return infoWindow;};GaodeMap.prototype.addMarkerClick=function(marker,eventFunc){var _this=this;AMap.event.addListener(marker,'click',function(){eventFunc.call(_this);});};GaodeMap.prototype.setFitView=function(){this.map.setFitView();};GaodeMap.prototype.computeDistanceBetween=function(from,to){if(!from||!to){return}
return from.distance(to);};GaodeMap.prototype.getMarkerPosition=function(marker){if(!marker){return}
return marker.getPosition();};GaodeMap.prototype.closeAllInfoWindow=function(){};inherits(GaodeMap,BeopMap);function GoogleMap(){BeopMap.call(this);this.url=configMap.GmapUrl;this.key=configMap.GmapKey;this.zoom=4;this.mapName='google'+I18n.resource.core.beopMap.MAP;}
GoogleMap.prototype.init=function(){BeopMap.prototype.init.call(this);this.map=new google.maps.Map($('#'+this.container)[0],{zoom:this.zoom,disableDefaultUI:true});GMarker=function(latlng,map,args){this.latlng=latlng;this.args=args;this.setMap(map);}
GMarker.prototype=new google.maps.OverlayView();GMarker.prototype.draw=function(){var self=this;var div=this.div;if(!div){div=this.div=document.createElement('div');div.className='map-marker';div.style.position='absolute';if(typeof(self.args.id)!=='undefined'){div.dataset.id=self.args.id;}
google.maps.event.addDomListener(div,"click",function(event){google.maps.event.trigger(self,"click");});var panes=this.getPanes();panes.overlayImage.appendChild(div);}
var point=this.getProjection().fromLatLngToDivPixel(this.latlng);if(point){div.style.left=(point.x-8)+'px';div.style.top=(point.y-8)+'px';}};GMarker.prototype.onRemove=function(){if(this.div){this.div.parentNode.removeChild(this.div);this.div=null;}};GMarker.prototype.getPosition=function(){return this.latlng;};GMarker.prototype.getExtData=function(){return this.args;};GMarker.prototype.show=function(){this.div.style.display='';};GMarker.prototype.hide=function(){this.div.style.display='none';};};GoogleMap.prototype.isMapLoaded=function(){try{if(google&&google.maps){return true;}}catch(e){return false;}};GoogleMap.prototype.load=function(){if(this.isMapLoaded()){mapLoadCallBack();}else{this.loadScript({callback:configMap.mapLoadCallBack,sensor:false,libraries:'geometry,places',language:'en'});}};GoogleMap.prototype.getLatLng=function(lat,lng){return new google.maps.LatLng(lat,lng);};GoogleMap.prototype.openInfoWindow=function(infoWindow,marker){infoWindow.open(this.map,marker);};GoogleMap.prototype.addMarker=function(identifier,lnglat,isOnline,opts){if(!identifier||!lnglat){return null;}
if(typeof lnglat==='string'){var temp=lnglat.split(',');lnglat={'lat':+temp[0],'lng':+temp[1]};}
if(opts){$.extend(defaultOpts,opts);}
var marker=new GMarker(this.getLatLng(lnglat.lat,lnglat.lng),this.map,{id:identifier});this.markers[identifier]=marker;return marker;};GoogleMap.prototype.addInfoWindow=function(id,content){var infoWindow=new google.maps.InfoWindow({content:content,pixelOffset:new google.maps.Size(0,0)});this.infoWindows[id]=infoWindow;return infoWindow;};GoogleMap.prototype.addControl=function($controlUI,callback){var _this=this,controlUIDom=$controlUI[0];this.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlUIDom);google.maps.event.addDomListener(controlUIDom,'click',function(){callback.call(_this);});};GoogleMap.prototype.closeAllInfoWindow=function(){for(var m=0,len=this.infoWindows.length;m<len;m++){this.infoWindows[m].close();}};GoogleMap.prototype.addMarkerClick=function(marker,eventFunc){var _this=this;google.maps.event.addListener(marker,'click',function(){_this.closeAllInfoWindow();eventFunc.call(_this);});};GoogleMap.prototype.setFitView=function(){var bounds=new google.maps.LatLngBounds();for(var project in this.markers){bounds.extend(this.markers[project].getPosition());}
this.map.fitBounds(bounds);};GoogleMap.prototype.computeDistanceBetween=function(from,to){if(!from||!to){return}
return google.maps.geometry.spherical.computeDistanceBetween(from,to);};GoogleMap.prototype.getMarkerPosition=function(marker){if(!marker){return}
return marker.getPosition();};GoogleMap.prototype.trigger=function(instance,eventName,var_args){google.maps.event.trigger(instance,eventName,var_args);};inherits(GoogleMap,BeopMap);var GMarker=null;beop.getMapInstance=function(){var isGoogleAvailable=localStorage.getItem('isGoogleAvailable');if(typeof isGoogleAvailable!==typeof undefined&&isGoogleAvailable!=='error'){return isGoogleAvailable==='true'?new GoogleMap():new GaodeMap();}
if(I18n.type==='zh'){return new GaodeMap();}else{return new GoogleMap();}};beop.GaodeMap=GaodeMap;beop.GoogleMap=GoogleMap;})(beop||(beop={}));var isMapAsyncLoadSuccess=undefined;function mapLoadCallBack(){var mapIns=beop.getMapInstance();mapIns.init();mapIns.addMarkers(ProjectConfig.projectList);mapIns.initPaneProject();mapIns.setFitView();isMapAsyncLoadSuccess=true;mapIns.customCtrls=mapIns.customCtrls||{};}
var SelectPage=(function(){var _this;function SelectPage(data){_this=this;_this.ctn=data.ctn;_this.type=data.type;_this.mode=data.mode?data.mode:'radio';_this.teamId=data.teamId;_this.list=undefined;_this.screen=data.screen;_this.callback=data.callback;_this.selectList=data.selectList;_this.$ctnSel=undefined;_this.$ctnResult=undefined;_this.$ctnTopNav=undefined;}
SelectPage.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/core/selectPage.html'}).done(function(resultHTML){_this.ctn.innerHTML=resultHTML;$(_this.ctn).show();$('#ctnSubSelMain').css({'height':'-webkit-calc('+BomConfig.height+' - '+BomConfig.topHeight+' - '+BomConfig.statusHeight+')','top':BomConfig.statusHeight});_this.$ctnSel=$('#ctnSubSelContent').css('height','-webkit-calc(100% - '+BomConfig.bottomHeight+')');_this.$ctnResult=$('#ctnSubSelRs').css('height',BomConfig.bottomHeight);_this.$ctnTopNav=$('#ctnSubSelTopNav').css('top',BomConfig.statusHeight);_this.init();$('#navTop').hide();$('#navBottom').hide();$('#topBlank').hide();$('#bottomBlank').hide();$(ElScreenContainer).css('height','-webkit-calc('+BomConfig.height+' - '+BomConfig.statusHeight+')')})},setCallback:function(func){_this.callback=func},setList:function(list){_this.list=list},init:function(){var url;if(_this.teamId){url='/workflow/v2/group/user_team_dialog_list/'+AppConfig.userId+'/'+_this.teamId;}else{url='/workflow/v2/group/user_team_dialog_list/'+AppConfig.userId;}
_this.initTopNav();if(this.list instanceof Array&&this.list.length>0){switch(_this.type){case'user':_this.initUserList();break;default:break;}
_this.initSelToggle();_this.initCallback();_this.initResult();_this.initSearch();}else{Spinner.spin($('#ctnSubSelMain')[0]);WebAPI.get(url).done(function(resultData){_this.list=resultData.data;switch(_this.type){case'user':_this.initUserList();break;default:break;}
_this.initSelToggle();_this.initCallback();_this.initResult();_this.initSearch();}).always(function(){Spinner.stop()});}},initTopNav:function(){_this.$ctnTopNav.css('height',BomConfig.topHeight);var btnSure=document.createElement('span');btnSure.textContent='确认';btnSure.id='btnTopSure';btnSure.className='topNavRight zepto-ev';_this.$ctnTopNav.append(btnSure);$('#btnSubBack').on('tap',function(){_this.close();});document.removeEventListener("backbutton",router.back,false);document.addEventListener("backbutton",_this.close,false)},initUserList:function(){var divUser,spTitle,img,spSelClk;for(var i=0;i<_this.list.length;i++){divUser=document.createElement('div');divUser.className='divUser divSelUnit zepto-ev';divUser.id=_this.list[i].id;img=document.createElement('img');img.className="imgSel";img.src=_this.list[i].userpic;spTitle=document.createElement('span');spTitle.className='spTitle';spTitle.textContent=_this.list[i].userfullname;spSelClk=document.createElement('span');spSelClk.className='glyphicon glyphicon-ok-sign spSelClk';divUser.appendChild(img);divUser.appendChild(document.createElement('br'));divUser.appendChild(spTitle);divUser.appendChild(spSelClk);_this.$ctnSel.append(divUser);}
if(_this.selectList){var dom;for(var i=0;i<_this.selectList.length;i++){if(_this.selectList[i].id==undefined){dom=document.getElementById(_this.selectList[i]);}else{dom=document.getElementById(_this.selectList[i].id);}
dom&&(dom.className+=' selected');}}},getInfoById:function(id){for(var i=0;i<this.list.length;i++){if(this.list[i].id==id)return this.list[i]}
return false;},initSelToggle:function(){if(_this.selectList){var info;for(var i=0;i<_this.selectList.length;i++){if(_this.selectList[i].id&&_this.selectList[i].userfullname){info=_this.selectList[i]}else{info=this.getInfoById(_this.selectList[i])}
info&&_this.insertResult(info);}}
_this.$ctnSel.on('tap','.divSelUnit',function(e){var index;if($(e.currentTarget).hasClass('selected')){$(e.currentTarget).removeClass('selected');_this.removeResult(e.currentTarget.id);}else{if(_this.mode=='radio'){_this.$ctnSel.find('.selected').removeClass('selected');}
$(e.currentTarget).addClass('selected');_this.removeResult(e.currentTarget.id);index=_this.getUserById(e.currentTarget.id);if(index)_this.insertResult(index);}})},getUserById:function(id){for(var i=0;i<this.list.length;i++){if(this.list[i].id==id){return this.list[i];}}},initSearch:function(){var spSearch=document.createElement('span');spSearch.id='spTopSearch';var label=document.createElement('label');label.style.display='none';var iptSearch=document.createElement('input');iptSearch.setAttribute('type','text');iptSearch.id='iptTopSearch';spSearch.appendChild(label);spSearch.appendChild(iptSearch);_this.$ctnTopNav.append(spSearch);var $divSelUnit=$('.divSelUnit ');$(iptSearch).on('input propertychange',function(e){if(e.target.value==''){$divSelUnit.show()}else{$divSelUnit.hide();for(var i=0;i<$divSelUnit.length;i++){if($divSelUnit.eq(i).find('.spTitle').text().indexOf(e.target.value)>=0){$divSelUnit.eq(i).show();}}}})},initCallback:function(){$('#btnTopSure').on('tap',function(){var result=[];var $divSelect=_this.$ctnResult.find('.divSelTip');var index;for(var i=0;i<$divSelect.length;i++){index=_this.getUserById($divSelect[i].id.split('_')[1]);if(index)result.push(index)}
if(_this.callback instanceof Function){_this.callback.call(_this.screen,result)}
_this.close();})},initResult:function(){_this.$ctnResult.on('tap','.divSelTip',function(e){$('#'+e.currentTarget.dataset.id).removeClass('selected');$(e.currentTarget).remove();})},insertResult:function(user){var text,id;switch(_this.type){case'user':text=user.userfullname;id=user.id;break;default:break;}
var divTip=document.createElement('div');divTip.textContent=text;divTip.id='divTip_'+id;divTip.className='divSelTip zepto-ev';divTip.dataset.id=id;_this.$ctnResult.append(divTip);},removeResult:function(id){if(_this.mode=='radio'){$('.divSelTip').remove();}else{$('#divTip_'+id).remove();}},close:function(){_this.ctn.innerHTML='';$(_this.ctn).hide();$('#navTop').show();$('#navBottom').show();$('#topBlank').show();$('#bottomBlank').show();$(ElScreenContainer).css('height',BomConfig.mainHeight);document.addEventListener("backbutton",router.back,false)}};return SelectPage;})();var ProjectSummary=(function(){var _this;function ProjectSummary(option){_this=this;this.isFromProjLs=false;if(option){if(option.id){ProjectConfig.projectId=option.id;for(var i=0;i<ProjectConfig.projectList.length;i++){if(ProjectConfig.projectList[i].id==option.id){ProjectConfig.projectInfo=ProjectConfig.projectList[i];ProjectConfig.projectIndex=i;break;}}}
if(option.index>-1){ProjectConfig.projectId=ProjectConfig.projectList[option.index].id;ProjectConfig.projectInfo=ProjectConfig.projectList[option.index];ProjectConfig.projectIndex=option.index;}
this.isFromProjLs=option.isFromProjLs?option.isFromProjLs:false;}}
ProjectSummary.navOptions={top:'<span id="btnProjectMap" class="" aria-hidden="true" style="display:inline-flex;"><i class="iconfont">&#xe7e6;</i></span>'+'<div class="topNavTitle"><span id="dashboardName" style="display:none;"></span><span id="projName" style="display:block;"></span></span></div>'+'<span id="btnAdminConfig"><i class="iconfont">&#xe7e3;</i></span>',bottom:true,backDisable:true,module:'project'};ProjectSummary.prototype={show:function(){localStorage.setItem('defaultProject',JSON.stringify(ProjectConfig.projectInfo));$('.navTool .selected').removeClass('selected');$('#btnProject').addClass('selected');_this.init();_this.initNav();localStorage.setItem('defaultProjectId',ProjectConfig.projectId);localStorage.setItem('module','project');},init:function(){if(ProjectConfig.dashboardList&&ProjectConfig.dashboardList[0]&&!_this.isFromProjLs){ScreenManager.show(ProjectDashboard,{screen:_this,menuId:ProjectConfig.dashboardList[0].id,name:ProjectConfig.dashboardList[0].text,isIndex:true})}else{SpinnerControl.show();WebAPI.get("/get_plant_pagedetails/"+ProjectConfig.projectId+"/"+AppConfig.userId).done(function(resultData){if(resultData.navItems&&resultData.navItems.length>0){ProjectConfig.dashboardList=resultData.navItems.filter(function(ele){return ele.type==="EnergyScreen_M"});if(ProjectConfig.dashboardList.length==0){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.DASHBOARD_ERR,'short','center');SpinnerControl.hide();router.to({typeClass:ProjectList});return;}
$('#btnProjectMap').css({display:'inline-flex'});$('#btnAdminConfig').html('<img src="http://images.rnbtech.com.hk'+AppConfig.userProfile.picture+'">');ProjectConfig.dashboardId=ProjectConfig.dashboardList[0].id;ScreenManager.show(ProjectDashboard,{screen:_this,menuId:ProjectConfig.dashboardList[0].id,name:ProjectConfig.dashboardList[0].text,isIndex:true})}else{window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.DASHBOARD_ERR,'short','center');SpinnerControl.hide();}}).fail(function(){SpinnerControl.hide();});}},initNav:function(){$('#btnProjectMap').off('touchstart').on('touchstart',function(){router.to({typeClass:ProjectList,data:{}})});},close:function(){}};return ProjectSummary;})();var ProjectReport=(function(){var _this;function ProjectReport(data){_this=this;for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i].id==data.reportId){this.reportDetail=ProjectConfig.reportList[i];break;}}
this.initReportDate=data.reportDate?data.reportDate:new Date();this.reportDate=this.getReportVersion(this.reportDetail.reportType,this.initReportDate);}
ProjectReport.navOptions={top:'<div id="reportSelect" class="topNavTitle dropdown"></div>'+'<div id="btnWeChat" class="topNavRight glyphicon glyphicon-share-alt"></div>',bottom:true,backDisable:false,module:'report'};ProjectReport.prototype={reportTypeMap:{daily:'0',monthly:'1',weekly:'2'},show:function(){var _this=this;$.ajax({url:'static/app/dashboard/views/project/projectReport.html'}).done(function(resultHTML){var $reportSelect=$('#reportSelect');var strReportSelect=new StringBuilder();strReportSelect.append('<button class="btn btn-default dropdown-toggle" type="button" id="ulReportSelect" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">');strReportSelect.append('  <span>'+_this.reportDetail.text+'</span>');strReportSelect.append('</button>');strReportSelect.append('<ul class="dropdown-menu" aria-labelledby="ulReportSelect">');for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i].id==_this.reportDetail.id)continue;if(ProjectConfig.reportList[i].type=='ReportScreen'){strReportSelect.append('  <li class="zepto-ev" data-src="traditional" report-to="'+ProjectConfig.reportList[i].id+'">'+ProjectConfig.reportList[i].text+'</li>');}else{strReportSelect.append('  <li class="zepto-ev" data-src="factory" report-to="'+ProjectConfig.reportList[i].reportId+'">'+ProjectConfig.reportList[i].reportName+'</li>');}}
strReportSelect.append('</ul>');$reportSelect.html(strReportSelect.toString());$reportSelect.find('li').off('tap').on('tap',function(e){var id=$(e.currentTarget).attr('report-to');if(e.currentTarget.dataset.src=='factory'){router.to({typeClass:ProjectFactoryReport,data:{reportId:id,reportDate:_this.initReportDate}})}else{router.to({typeClass:ProjectReport,data:{reportId:id,reportDate:_this.initReportDate}})}});$(ElScreenContainer).html(resultHTML);_this.init();})},init:function(){var _this=this;var $container=$('#containerReport');SpinnerControl.show();var tempDiv,styleFile,version;if(_this.reportDetail.reportType==_this.reportTypeMap.weekly){version=this.getWeekVersion();}else{version=_this.reportDate;}
$container[0].innerHTML='';WebAPI.get('/report/getReport/'+ProjectConfig.projectInfo.name_en+'/'+_this.reportDetail.reportFolder+'/'+version).done(function(result){tempDiv=document.createElement('div');tempDiv.innerHTML=result;styleFile=tempDiv.querySelector('link');tempDiv.querySelector('#beopReport').removeChild(styleFile);$container.html(tempDiv.innerHTML);var $reportUnit=$('#beopReport .report-unit');$reportUnit.find('.canvas-container').css({height:'300px',width:($(ElScreenContainer).width()-30)+'px'});_this.reportScreen=new ReportScreen();_this.reportScreen.renderCharts($reportUnit);var $table=$('table');for(var i=0;i<$table.length;i++){$table.eq(i).removeClass('table-striped');$table[i].outerHTML='<div class="tableContainer">'+$table[i].outerHTML+'</div>'}}).always(function(){SpinnerControl.hide();}).fail(function(){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.REPORT_AVAILABLE,'long','center')});_this.initReportSelect();},initReportSelect:function(){var _this=this;if(!this.reportDate)return;var strDate=this.reportDate.replace(/-/g,'/');if(strDate.split('/').length<3)strDate+='/01';var date=new Date(strDate);$('#reportYear').html(date.getFullYear()+I18n.resource.appDashboard.project.REPORTYEAR);$('#reportMonth').html((date.getMonth()+1)+'<small>'+I18n.resource.appDashboard.project.REPORTMONTH+'</small>');if(this.reportDetail.reportType!==this.reportTypeMap.monthly){$('#reportDay').html((date.getDate())+'<small>'+I18n.resource.appDashboard.project.REPORTDAY+'</small>');}
$('#divReportTime').off('tap').on('tap',function(){if(typeof datePicker=='undefined')return;datePicker.show({date:date?date:new Date(),mode:'date',todayText:AppConfig.language=='zh'?'当前日期':'Current Date',okText:AppConfig.language=='zh'?'确定':'Done',cancelText:AppConfig.language=='zh'?'取消':'Cancel',allowFutureDates:false,doneButtonLabel:AppConfig.language=='zh'?'确定':'Done',cancelButtonLabel:AppConfig.language=='zh'?'取消':'Cancel'},setDate,function(){})});function setDate(date){if(!date)return;_this.initReportDate=date;if(_this.reportDetail.reportType==_this.reportTypeMap.daily){if(+new Date(date.format('yyyy/MM/dd 00:00:00'))>=+new Date(new Date().format('yyyy/MM/dd 00:00:00'))){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.DAILYREPORT_LOST,'long','center');}}else if(_this.reportDetail.reportType==_this.reportTypeMap.monthly){if(+new Date(date.format('yyyy/MM/01'))>=+new Date(new Date().format('yyyy/MM/01'))){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.MONTHREPORT_LOST,'long','center')}}else{if(_this.iso8601Week(date)>=_this.iso8601Week(new Date())){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.WEEKREPORT_LOST,'long','center')}}
_this.reportDate=_this.getReportVersion(_this.reportDetail.reportType,date);_this.init();}},getReportVersion:function(reportInfo,reportDate){var thisDay,version;var reportType=reportInfo;var year,month,day;if(reportDate instanceof Date){thisDay=reportDate;}else{thisDay=new Date();}
if(reportType===this.reportTypeMap.daily||reportType=='day'){if(+new Date(thisDay.format('yyyy/MM/dd 00:00:00'))>=+new Date(new Date().format('yyyy/MM/dd 00:00:00'))){thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);}
version=thisDay.format('yyyy-MM-dd');}
else if(reportType===this.reportTypeMap.monthly||reportType=='month'){if(+new Date(thisDay.format('yyyy/MM/01'))>=+new Date(new Date().format('yyyy/MM/01'))){thisDay=new Date();thisDay.setMonth(thisDay.getMonth()-1);}
year=thisDay.getFullYear();month=thisDay.getMonth()+1;version=year+'-'+StringUtil.padLeft(month,2,'0');}else{var thisWeek=this.iso8601Week(thisDay);if(this.iso8601Week(new Date())<=thisWeek){thisWeek=this.iso8601Week(new Date())-1;thisDay=new Date();thisDay=new Date(thisDay-7*24*60*60*1000);}
year=thisDay.getFullYear();version=DateUtil.getFirstDayOfWeek(year,thisWeek).format('yyyy-MM-dd');}
return version;},getWeekVersion:function(){var thisDay=this.initReportDate;var thisWeek=this.iso8601Week(thisDay);if(this.iso8601Week(new Date())<=thisWeek){thisWeek=this.iso8601Week(new Date())-1;thisDay=new Date();thisDay=new Date(thisDay-7*24*60*60*1000);}
return thisDay.getFullYear()+'-'+thisWeek+'-w';},iso8601Week:function(date){var addOneDayDate=new Date(date);var time,checkDate=new Date(addOneDayDate.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},close:function(){}};return ProjectReport;})();var ProjectFactoryReport=(function(){var _this;function ProjectFactoryReport(data){_this=this;for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i].reportId==data.reportId){this.reportDetail=ProjectConfig.reportList[i];break;}}
this.initReportDate=data.reportDate?data.reportDate:new Date();this.reportDate=this.getReportVersion(this.reportDetail.period,this.initReportDate);}
ProjectFactoryReport.navOptions={top:'<div id="reportSelect" class="topNavTitle dropdown"></div>'+'<div id="btnWeChat" class="topNavRight glyphicon glyphicon-share-alt"></div>',bottom:true,backDisable:false,module:'report'};ProjectFactoryReport.prototype={reportTypeMap:{daily:'0',monthly:'1',weekly:'2'},show:function(){var _this=this;$.ajax({url:'static/app/dashboard/views/project/projectReport.html'}).done(function(resultHTML){var $reportSelect=$('#reportSelect');var strReportSelect=new StringBuilder();strReportSelect.append('<button class="btn btn-default dropdown-toggle" type="button" id="ulReportSelect" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">');strReportSelect.append('  <span>'+_this.reportDetail.reportName+'</span>');strReportSelect.append('</button>');strReportSelect.append('<ul class="dropdown-menu" aria-labelledby="ulReportSelect">');for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i].reportId==_this.reportDetail.reportId)continue;if(ProjectConfig.reportList[i].type=='ReportScreen'){strReportSelect.append('  <li class="zepto-ev" data-src="traditional" report-to="'+ProjectConfig.reportList[i].id+'">'+ProjectConfig.reportList[i].text+'</li>');}else{strReportSelect.append('  <li class="zepto-ev" data-src="factory" report-to="'+ProjectConfig.reportList[i].reportId+'">'+ProjectConfig.reportList[i].reportName+'</li>');}}
strReportSelect.append('</ul>');$reportSelect.html(strReportSelect.toString());$reportSelect.find('li').off('tap').on('tap',function(e){var id=$(e.currentTarget).attr('report-to');if(e.currentTarget.dataset.src=='factory'){router.to({typeClass:ProjectFactoryReport,data:{reportId:id,reportDate:_this.initReportDate}})}else{router.to({typeClass:ProjectReport,data:{reportId:id,reportDate:_this.initReportDate}})}});$(ElScreenContainer).html(resultHTML);_this.init();})},init:function(){SpinnerControl.show();this.initFactoryReport();_this.initReportSelect();},initFactoryReport:function(){var _this=this;api.report.renderReport(document.getElementById('containerReport'),this.reportDetail.reportId,{date:this.reportDate,onlySummary:false}).always(function(){$('#containerReport').addClass('isFactory');SpinnerControl.hide();});},initReportSelect:function(){var _this=this;if(!this.reportDate)return;var strDate=this.reportDate.replace(/-/g,'/');if(strDate.split('/').length<3)strDate+='/01';var date=new Date(strDate);$('#reportYear').html(date.getFullYear()+I18n.resource.appDashboard.project.REPORTYEAR);$('#reportMonth').html((date.getMonth()+1)+'<small>'+I18n.resource.appDashboard.project.REPORTMONTH+'</small>');if(this.reportDetail.period!='month'){$('#reportDay').html((date.getDate())+'<small>'+I18n.resource.appDashboard.project.REPORTDAY+'</small>');}
$('#divReportTime').off('tap').on('tap',function(){if(typeof datePicker=='undefined')return;datePicker.show({date:date?date:new Date(),mode:'date',todayText:AppConfig.language=='zh'?'当前日期':'Current Date',okText:AppConfig.language=='zh'?'确定':'Done',cancelText:AppConfig.language=='zh'?'取消':'Cancel',allowFutureDates:false,doneButtonLabel:AppConfig.language=='zh'?'确定':'Done',cancelButtonLabel:AppConfig.language=='zh'?'取消':'Cancel'},setDate,function(){})});function setDate(date){if(!date)return;_this.initReportDate=date;if(_this.reportDetail.period=='day'){if(+new Date(date.format('yyyy/MM/dd 00:00:00'))>=+new Date(new Date().format('yyyy/MM/dd 00:00:00'))){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.DAILYREPORT_LOST,'long','center')}}else if(_this.reportDetail.period=='month'){if(+new Date(date.format('yyyy/MM/01'))>=+new Date(new Date().format('yyyy/MM/01'))){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.MONTHREPORT_LOST,'long','center')}}else{if(_this.iso8601Week(date)>=_this.iso8601Week(new Date())){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.project.WEEKREPORT_LOST,'long','center')}}
_this.reportDate=_this.getReportVersion(_this.reportDetail.period,date);_this.init();}},getReportVersion:function(reportInfo,reportDate){var thisDay,version;var reportType=reportInfo;var year,month,day;if(reportDate instanceof Date){thisDay=reportDate;}else{thisDay=new Date();}
if(reportType===this.reportTypeMap.daily||reportType=='day'){if(+new Date(thisDay.format('yyyy/MM/dd 00:00:00'))>=+new Date(new Date().format('yyyy/MM/dd 00:00:00'))){thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);}
version=thisDay.format('yyyy-MM-dd');}
else if(reportType===this.reportTypeMap.monthly||reportType=='month'){if(+new Date(thisDay.format('yyyy/MM/01'))>=+new Date(new Date().format('yyyy/MM/01'))){thisDay=new Date();thisDay.setMonth(thisDay.getMonth()-1);}
year=thisDay.getFullYear();month=thisDay.getMonth()+1;version=year+'-'+StringUtil.padLeft(month,2,'0');}else{var thisWeek=this.iso8601Week(thisDay);if(this.iso8601Week(new Date())<=thisWeek){thisWeek=this.iso8601Week(new Date())-1;thisDay=new Date();thisDay=new Date(thisDay-7*24*60*60*1000);}
year=thisDay.getFullYear();version=DateUtil.getFirstDayOfWeek(year,thisWeek).format('yyyy-MM-dd');}
return version;},iso8601Week:function(date){var addOneDayDate=new Date(date);var time,checkDate=new Date(addOneDayDate.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},close:function(){}};return ProjectFactoryReport;})();var ProjectList=(function(){var _this;function ProjectList(){_this=this;this.priority=undefined;this.priorityTar=undefined;this.hasItemSel=false;}
ProjectList.navOptions={top:'<span id="btnProjectMap" class="topNavLeft topTool zepto-ev" aria-hidden="true"><i class="iconfont">&#xe7e6;</i></span>\
        <div class="topNavTitle" i18n="appDashboard.project.PROJECT_LIST"></div>\
        <span id="btnAdminConfig" class=""><i class="iconfont">&#xe7e3;</i></span>',bottom:true,backDisable:true,module:'project'};ProjectList.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/project/projectList.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);$('.navTool .selected').removeClass('selected');$('#btnProject').addClass('selected');var $adminConfig=$('#btnAdminConfig');$adminConfig[0].innerHTML='<img src="http://images.rnbtech.com.hk'+AppConfig.userProfile.picture+'">';$adminConfig[0].innerHTML='<img src="http://images.rnbtech.com.hk'+AppConfig.userProfile.picture+'">';$adminConfig.off('touchstart').on('touchstart',function(e){var adminConfigNew=new AdminConfigNew();adminConfigNew.show();});_this.init();I18n.fillArea($('#navTop'));});},init:function(){_this.priority=JSON.parse(localStorage.getItem('projPriority'));if(!_this.priority){_this.priority={};for(var i=0;i<ProjectConfig.projectList.length;i++){_this.priority[ProjectConfig.projectList[i].id]=i}
localStorage.setItem('projPriority',JSON.stringify(_this.priority));}
_this.initTopNav();_this.initProjectList();_this.initPriority();_this.initProjectDisplay();},initProjectList:function(arg){var arrProject=arg?arg:ProjectConfig.projectList;arrProject=_this.sortProjByPriority(arrProject);var $ulProjectList=$('#ulProjectList');var strLiProject=new StringBuilder();var language=localStorage.getItem('language');for(var i=0,status='';i<arrProject.length;++i){strLiProject=new StringBuilder();arrProject[i].online?status='online':status='offline grayFillter';strLiProject.append('<div class="liProject zepto-ev '+status+'" id="proj_'+arrProject[i].id+'"projId='+arrProject[i].id+' priority="'+arrProject[i].priority+'">');strLiProject.append('   <div class="projectIcon"><img src="http://images.rnbtech.com.hk/static/images/project_img/'+arrProject[i].pic+'"></div>');strLiProject.append('   <div class="projectInfo">');if(language=='en'){strLiProject.append('   <div class="projectName title">'+arrProject[i].name_english);}else if(language='zh'){strLiProject.append('   <div class="projectName title">'+arrProject[i].name_cn);}else{if(navigator&&navigator.language&&navigator.language.split('-')[0]=='en'){strLiProject.append('   <div class="projectName title">'+arrProject[i].name_english);}else{strLiProject.append('   <div class="projectName title">'+arrProject[i].name_cn);}}
strLiProject.append('</div>');if(arrProject[i].online&&arrProject[i].lastReceivedTime){strLiProject.append('   <div class="projectStatus online">'+DateUtil.getRelativeDateInfo(new Date(),new Date(arrProject[i].lastReceivedTime.replace(/-/g,'/')))+'</div>');}else{strLiProject.append('   <div class="projectStatus offlineStatus"><i class="iconfont">&#xe7e9;</i></div>');}
strLiProject.append('   </div>');strLiProject.append('</div>');if(arrProject[i].id==ProjectConfig.projectId){var $temp=$(strLiProject.toString());$temp.attr('id','projSel').removeClass('grayFillter').addClass('selected');$ulProjectList.append($temp);_this.hasItemSel=true;}else{$ulProjectList.append(strLiProject.toString());}}},initProjectDisplay:function(){$('.liProject').off('tap').on('tap',function(e){ProjectConfig.projectId=$(e.currentTarget).attr('projId');AppConfig.projectId=ProjectConfig.projectId;_this.initPriority();for(var i=0;i<ProjectConfig.projectList.length;i++){if(ProjectConfig.projectId==ProjectConfig.projectList[i].id){ProjectConfig.projectInfo=ProjectConfig.projectList[i];ProjectConfig.projectIndex=i;}}
router.to({typeClass:ProjectSummary,data:{isFromProjLs:true}})})},initPriority:function(){var initPriority=_this.priority[ProjectConfig.projectId];for(var ele in _this.priority){if(_this.priority[ele]<initPriority){_this.priority[ele]+=1}}
_this.priority[ProjectConfig.projectId]=0;localStorage.setItem('projPriority',JSON.stringify(_this.priority));},sortProjByPriority:function(arrProj){var arr=[];var priority;var extra=0;for(var i=0;i<arrProj.length;i++){priority=_this.priority[arrProj[i].id];if(priority==undefined){priority=arrProj.length+extra;extra+=1;}
arr[priority]=arrProj[i];arr[priority].priority=_this.priority[arrProj[i].id]}
arr=arr.filter(function(ele){return ele!=undefined;});return arr;},initTopNav:function(){var language=localStorage.getItem('language');if(language=='en'){var serarchText='Search';}else if(language=='zh'){var serarchText='搜索';}
$('.iptSearch').attr('placeholder',serarchText);$('#btnProjectMap').off('touchstart').on('touchstart',function(){router.to({typeClass:ProjectMap,data:{}})});$('.iptSearch').off('input propertychange').on('input propertychange',function(e){$('#ulProjectList').html('');var target=$(e.currentTarget).val();var arrResult=[];for(var i=0;i<ProjectConfig.projectList.length;i++){var arrName=[ProjectConfig.projectList[i].id,ProjectConfig.projectList[i].name_cn,ProjectConfig.projectList[i].name_en,ProjectConfig.projectList[i].name_english];if(new RegExp(target,'i').test(arrName.join())){arrResult.push(ProjectConfig.projectList[i])}}
_this.initProjectList(arrResult);_this.initProjectDisplay();});$('#btnBack').off('tap').on('tap',function(){router.to({typeClass:ProjectSummary,data:{}})});},close:function(){$('#btnBack').off('tap').on('tap',function(){router.back()});}};return ProjectList;})();var ProjectMap=(function(){var _this;function ProjectMap(){_this=this;}
ProjectMap.navOptions={top:'<div class="topNavInput" ><input id="projectSearch" type="text"></div>'+'<span id="btnProjectList" class="topNavRight topTool zepto-ev"><span id="iconProjectList" class="btnIcon"></span></span>',bottom:true,backDisable:false,module:'project'};ProjectMap.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/project/projectMap.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);var map=new beop.getMapInstance();map.load();_this.init()})},init:function(){_this.initTopNav();},initTopNav:function(){$('#btnProjectList').off('touchstart').on('touchstart',function(e){router.to({typeClass:ProjectList,data:{}})});},close:function(){}};return ProjectMap;})();var ProjectDashboard=(function(){var _this;function ProjectDashboard(data){_this=this;if(data){if(data.screen)this.screen=data.screen;if(data.menuId)this.menuId=data.menuId;}
this.isIndex=!!(data.isIndex);this.store=undefined;this.factoryIoc=undefined;this.container=undefined;this.requestPoints=[];this.mapRefresh={};this.popRefresh={};this.dictPopToEntity={};if(data&&data.name){this.dashboardName=data.name;}
AppConfig.datasource=undefined;}
ProjectDashboard.navOptions={top:'<span id="btnProjectMap" class="topNavLeft topTool" aria-hidden="true"><i class="iconfont">&#xe7e6;</i></span>'+'<div class="topNavTitle"><span id="dashboardName" class="topNavTitle"></span><span id="projName" class="topTip"></span></div>'+'<span id="btnAdminConfig" class=""><i class="iconfont">&#xe7e3;</i></span>',bottom:true,backDisable:false,module:'project'};ProjectDashboard.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/project/projectDashboard.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;_this.container=document.getElementById('ctn-dashboard');$('#btnAdminConfig').html('<img src="http://images.rnbtech.com.hk'+AppConfig.userProfile.picture+'">');if(_this.dashboardName)document.getElementById('dashboardName').innerHTML=_this.dashboardName;var language=localStorage.getItem('language');if(language=='en'){document.getElementById('projName').innerHTML=ProjectConfig.projectInfo.name_english;}else if(language='zh'){document.getElementById('projName').innerHTML=ProjectConfig.projectInfo.name_cn;}else{if(navigator&&navigator.language&&navigator.language.split('-')[0]=='en'){document.getElementById('projName').innerHTML=ProjectConfig.projectInfo.name_english;}else{document.getElementById('projName').innerHTML=ProjectConfig.projectInfo.name_cn;}}
_this.init();});},init:function(){_this.initTopNav();_this.initIoc();SpinnerControl.show();WebAPI.get('/spring/get/'+this.menuId+'/'+ProjectConfig.projectId).done(function(resultData){_this.store=resultData;AppConfig.datasource=new DataSource(_this);_this.initLayout();_this.initWorkerForUpdating();}).always(function(){SpinnerControl.hide();})},initIoc:function(){this.factoryIoC=new FactoryIoC('dashboard');this.factoryIoCAnalysis=new FactoryIoC('analysis');},initLayout:function(){this.listEntity={};this.arrEntityOrder=[];if(!(this.store&&this.store.layout))return;for(var i=0,item;i<this.store.layout.length;i++){for(var j=0;j<this.store.layout[i].length;j++){item=this.store.layout[i][j];var modelClass,entity;if(item.modal.type&&(item.modal.type!='ModalNone'||item.isNotRender==true)){modelClass=this.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender)continue;entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);if(item.modal.interval&&item.modal.interval>=0&&item.modal.points){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(this.requestPoints.indexOf(point)<0){this.requestPoints.push(point);}}}
if(item.modal.popId){if(!this.dictPopToEntity[item.modal.popId])this.dictPopToEntity[item.modal.popId]=[];this.dictPopToEntity[item.modal.popId].push(item.id);if(this.requestPoints.indexOf(item.modal.popId)<0){this.requestPoints.push(item.modal.popId);}}
entity.render();}else if(item.modal.type=='ModalNone'){modelClass=this.factoryIoC.getModel(item.modal.type);entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);entity.render();}}}
var $springCtn=$('#paneCenter').children('.springContainer');if($springCtn.length==1&&parseFloat($springCtn[0].style.height)>=parseFloat("99%")&&parseFloat($springCtn[0].style.width)>=parseFloat("99%")){$springCtn.children('.panel-default').css({border:'none'});}},initWorkerForUpdating:function(){this.workerUpdate=new Worker("static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);this.workerUpdate.postMessage({pointList:this.requestPoints,type:"datasourceRealtime"});},refreshData:function(e){var _this=this.self?this.self:this;if(!e.data.error&&e.data.dsItemList){var point;for(var i=0,iLen=e.data.dsItemList.length;i<iLen;i++){point=e.data.dsItemList[i];_this.mapRefresh[point.dsItemId]=point;if(_this.dictPopToEntity[point.dsItemId]){_this.popRefresh[point.dsItemId]=point;}}
var entity,arrUpdataData;for(var key in _this.listEntity){entity=_this.listEntity[key];if(entity.entity.modal.type=="ModalNone"||entity.entity.modal.type=="ModalMix")continue;arrUpdataData=[];if(entity.entity.modal&&entity.entity.modal.points){for(var i=0,iLen=entity.entity.modal.points.length;i<iLen;i++){var point=entity.entity.modal.points[i];if(!point)continue;if(entity.entity.modal.points.indexOf(point)!=i)continue;if(_this.mapRefresh[point]!=undefined)
arrUpdataData.push(_this.mapRefresh[point]);}
if(entity.entity.modal.type=="ModalAppGauge"){arrUpdataData.push({'dataTitle':entity.entity.modal.option.gaugeTitle,'guageTitle':entity.entity.modal.option.guageTitle,'guageFixed':entity.entity.modal.option.guageFixed,'guageUnit':entity.entity.modal.option.guageUnit,'guageMax':entity.entity.modal.option.guageMax});}
entity.entity.modal.popId&&entity.renderPop(_this.popRefresh[entity.entity.modal.popId]);entity.update(arrUpdataData);}}}else{}},initTopNav:function(){$('#btnProjectMap').off('touchstart').on('touchstart',function(){if(_this.isIndex){router.to({typeClass:ProjectList,data:{}})}else{router.back();}});$('#btnAdminConfig').off('touchstart').on('touchstart',function(e){var adminConfigNew=new AdminConfigNew();adminConfigNew.show();});},close:function(){if(_this.workerUpdate){_this.workerUpdate.terminate();_this.workerUpdate=null;}}};return ProjectDashboard;})();var FactoryIoC=(function(){function FactoryIoC(strType){this.listClass=[];this.init(strType);};FactoryIoC.prototype={init:function(strType){switch(strType){case'analysis':this.initAnalysisModule();break;case'dashboard':this.initDashboardModule();break;case'report':this.initReportModule();break;default:break;}},add:function(entityClass){this.listClass.push(entityClass);},getModel:function(strModelName){for(var i=0,len=this.listClass.length;i<len;i++){if(strModelName.toLowerCase()==this.listClass[i].name.toLowerCase()){return this.listClass[i];}}
return null;},getList:function(){return this.listClass;},initAnalysisModule:function(){this.add(AnlzTendency);this.add(AnlzSpectrum);this.add(AnlzScatter);this.add(AnlzHistoryCompare);this.add(AnlzHistoryCompare_Line);this.add(AnlzStack);this.add(AnlzPieRealtime);this.add(AnlzEnergy);this.add(AnlzCluster);this.add(AnlzCluster_AHU);this.add(AnlzCluster_Chiller);},initDashboardModule:function(){this.add(ModalNone);this.add(ModalAnalysis);this.add(ModalHistoryChart);this.add(ModalHistoryChartNormal);this.add(ModalHistoryChartEnergyConsume);this.add(ModalHistoryChartYearOnYearLine);this.add(ModalHistoryChartYearOnYearBar);this.add(ModalHistoryDataAnalyze);this.add(ModalChart);this.add(ModalRealtimePieEnegBrkd);this.add(ModalRealtimeLineOutdoor);this.add(ModalRealtimeBarSub);this.add(ModalRealtimeGauge);this.add(ModalRealtimeBarEnegBrkd);this.add(ModalMultiple);this.add(ModalKPIChart);this.add(ModalObserver);this.add(ModalPredictPointLine);this.add(ModalNote);this.add(ModalRank);this.add(ModalRankNormal);this.add(ModalMix);this.add(ModalHtml);this.add(ModalChartCustom);this.add(ModalPointKPI);this.add(ModalReportChapter);(typeof ModalReportFactory!="undefined")&&this.add(ModalReportFactory);this.add(ModalInteract);this.add(ModalMonitor);this.add(ModalAppChart);this.add(ModalAppGauge);this.add(ModalAppButton);this.add(ModalAppHistory);this.add(ModalHistoryDataAnalyze);this.add(ModalKPIStruct);this.add(ModalAppBlind);this.add(ModalAppDiagRanking);this.add(ModalAPPMonthHistory);this.add(ModalAppKPICollect);this.add(ModalAppPie);this.add(ModalDiagnosisPanelHtml);this.add(ModalRealtimeWeather);this.add(ModalDataMonitorList);this.add(ModalKpiOverview);this.add(ModalDiagnosisStruct);this.add(ModalCumulantChart);this.add(ModalColdHotAreaSummary);this.add(ModalEquipmentPerfectRate);this.add(ModalWorkOrderStatistics);this.add(ModalPriorityHandlingFaultList);this.add(ModalEnergyTrendAnalysis);},initReportModule:function(){var ns=namespace('factory.report.components');this.add(ns.Summary);this.add(ns.ChapterContainer);this.add(ns.Text);this.add(ns.Html);this.add(ns.Chart);this.add(ns.Block);this.add(ns.DiagnosisBlock);this.add(ns.Table);},}
return FactoryIoC;})();var DataSource=(function(){var _this;function DataSource(parent,opt){_this=this;this.m_parent=parent;this.m_newPointList=[];this.m_allPointList=[];this.m_allGroupList=[];this.m_arrProjIdColorMap={};this.m_dataSourceId;this.m_lang=I18n.resource.dataSource;this.m_selectItemId=0;this.m_selectGroupId=0;this.m_groupIconOpen='/static/images/dataSource/group_head_sel.png';this.m_groupIconClose='/static/images/dataSource/group_head_normal.png';this.m_cfgPanel;this.m_unassigned='unassigned';this.m_langFlag=('zh'==localStorage['language'])?0:1;this.$dsNavContain=undefined;this.m_curPageNum=1;this.m_arrCloudTableInfo=[];this.disableIot=opt&&opt.disableIot?true:false;this.treeObj=undefined;this.iotFilter=undefined;this.iotOpt={};}
DataSource.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);I18n.fillArea($('#divAnlsDatasourcePane'));I18n.fillArea($('#divEnergyAnlsPane'));_this.loadDataSourceRecord();_this.initContain();_this.initElement();Spinner.stop();},close:function(){this.m_newPointList=null;this.m_allPointList=null;},initContain:function(){this.initTreeNavStyle();},initTreeNavStyle:function(){WebAPI.get('/static/views/observer/dataSource.html').done(function(resultHtml){_this.$dsNavContain=$(resultHtml);I18n.fillArea(_this.$dsNavContain);var $pageMine=_this.$dsNavContain.find('#pageMine');var $pageCloud=_this.$dsNavContain.find('#pageCloud');var $pageIot=_this.$dsNavContain.find('#pageIot');AppConfig.isFactory&&_this.$dsNavContain.find('#liMine').css('display','none').attr('class','');_this.$dsNavContain.find('#liMine').click(function(e){$('#liMine').attr('class','active');$('#liCloud').attr('class','');$('#liIot').attr('class','');$pageMine.show();$pageCloud.hide();$pageIot.hide();_this.currentObj='mine';});_this.$dsNavContain.find('#liCloud').click(function(e){if(_this.m_arrCloudTableInfo.length<=0){_this.initDsCloud();}
$('#liMine').attr('class','');$('#liCloud').attr('class','active');$('#liIot').attr('class','');$pageMine.hide();$pageIot.hide();$pageCloud.show();_this.currentObj='cloud';});if(_this.disableIot){_this.$dsNavContain.find('#liIot').remove();}else{_this.$dsNavContain.find('#liIot').click(function(e){$('#liMine').attr('class','');$('#liCloud').attr('class','');$('#liIot').attr('class','active');$pageMine.hide();$pageIot.html('').show();$pageCloud.hide();_this.initIotFilter();_this.currentObj='iot';});_this.initIotFilter();}
_this.initDsMine();$('#dataSrcContain').empty();$('#dataSrcContain').append(_this.$dsNavContain);AppConfig.isFactory&&$('#liCloud').click();var addGroup=$('<div id="dataSrcAddGroup"><input type="text" id="inputAddGroup" placeholder="+ Add group" ></div>');$pageMine.append(addGroup);$('#inputAddGroup').attr('placeholder',I18n.resource.dataSource.ADD_GROUP);$pageMine.keyup(function(e){if(13==e.keyCode){_this.addNewGroup();}});var inputAdd=addGroup.find('#inputAddGroup');inputAdd.attr('placeholder',_this.m_lang.ADD_GROUP);inputAdd.blur(function(e){_this.addNewGroup();});}).always(function(e){});},initIotFilter:function(){var $ctn=_this.$dsNavContain.find('#pageIot');_this.iotFilter=new HierFilter($ctn);_this.iotFilter.init();_this.iotOpt=$.extend(true,{},{base:{divideByProject:true},tree:{show:true,event:{click:[{act:onNodeClick,tar:['groups','projects']},{act:ontThingClick,tar:'things'},{act:function(){console.log('click things')},tar:'things'}],},drag:{dragstart:[{act:onAttrDragStart,tar:'attrs'},{act:onThingsDragStart,tar:'things'}],dragend:[{act:onAttrDragEnd,tar:'attrs'},]}}},_this.iotOpt);_this.iotFilter.setOption(_this.iotOpt);function onNodeClick(event,treeId,treeNode){if(_this.iotFilter.setDefault===true){if(!treeNode.children||treeNode.children.length==0)return;var node=treeNode.children[0];_this.iotFilter.tree.selectNode(node);_this.iotFilter.tree.setting.callback.onClick({target:document.getElementById(node.tId)},node['_id'],node);_this.iotFilter.setDefault=false}}
function ontThingClick(event,treeId,treeNode){var attrs=_this.iotFilter.dictClass['things'][treeNode.type].attrs;var arrNode=[];var node;for(var pt in treeNode.arrP){if(!attrs[pt])continue;node={'_id':treeNode.arrP[pt],'name':attrs[pt].name,'attrType':pt,'baseType':'attrs'};arrNode.push(node)}
if(!treeNode.children||treeNode.children.length==0){_this.iotFilter.tree.addNodes(treeNode,arrNode,true);}}
function onThingsDragStart(event,treeNode){EventAdapter.setData({'dsItemId':treeNode['_id'],'dsNode':treeNode});$('.templatePara').css('display','block');}
function onAttrDragStart(event,treeNode){EventAdapter.setData({'dsItemId':treeNode['_id'],'dsNode':treeNode});$('.templatePara').css('display','block');}
function onAttrDragEnd(){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');}
function onNodeDblClick(event,treeId,treeNode,widget){}},initDsMine:function(){var $inputSearch=_this.$dsNavContain.find('#inputDsMineSearch');$inputSearch.keyup(function(e){var searchVal=$(this).val().trim();if(13==e.keyCode&&searchVal){WebAPI.get('/analysis/datasource/searchDsItemInfo/'+AppConfig.userId+'/'+searchVal).done(function(result){var treeMine=_this.$dsNavContain.find('#treeMine');var zSetting={async:{enable:false},view:{addDiyDom:addDiyDom,addHoverDom:addHoverDom,removeHoverDom:removeHoverDom,selectedMulti:false,nameIsHTML:true},edit:{enable:true,drag:{isCopy:false,isMove:false}},data:{simpleData:{enable:true}},callback:{beforeRename:zTreeBeforeRename,beforeRemove:zTreeBeforeRemove}};function addDiyDom(treeId,treeNode){var $itemLeaf=$('#'+treeNode.tId);$itemLeaf.attr('ptid',treeNode.id);$itemLeaf.attr('draggable',true);EventAdapter.on($itemLeaf,'dragstart',function(e){$('.templatePara').css('display','block');var tar=$(e.target);var dragSrcId=tar.attr('ptid');EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($itemLeaf,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemLeaf,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});if(!treeNode.isParent){if(0==treeNode.type){var prjName=_this.getProjectNameFromId(treeNode.projId,_this.m_langFlag);_this.initToolTips($itemLeaf,treeNode.name,prjName,treeNode.value,treeNode.note);}else if(1==treeNode.type){var showName=_this.getShowNameFromFormula(treeNode.value);_this.initFormulaToolTips($itemLeaf,treeNode.name,showName,treeNode.note);}}}
function addHoverDom(treeId,treeNode){if(!treeNode.isParent){_this.setHoverColor(treeNode);}}
function removeHoverDom(treeId,treeNode){if(!treeNode.isParent){_this.removeHoverColor(treeNode);}}
function zTreeBeforeRename(treeId,treeNode,newName,isCancel){_this.zTreeBeforeRenameFunc(treeNode,newName);}
function zTreeBeforeRemove(treeId,treeNode){_this.zTreeBeforeRemoveFunc(treeNode);}
var zNodes=_this.generateSearchTree(result,searchVal);_this.treeObj=$.fn.zTree.init(treeMine,zSetting,zNodes);$('#dataSrcAddGroup').hide();});}
if(!searchVal){_this.initDsMineTree();$('#dataSrcAddGroup').show();}});_this.$dsNavContain.find('#spanDsMineSearch').click(function(e){$inputSearch.val('');_this.initDsMineTree();$('#dataSrcAddGroup').show();});_this.initDsMineTree();$('#dataSrcAddGroup').show();},initDsMineTree:function(){var zSetting={async:{enable:true,type:'get',url:function(treeId,treeNode){return'/analysis/datasource/getDsItemInfo/'+AppConfig.userId+'/'+(typeof treeNode==='undefined'?'null':treeNode.id);},dataFilter:dsItemfilter},view:{addDiyDom:addDiyDom,addHoverDom:addHoverDom,removeHoverDom:removeHoverDom,selectedMulti:false},edit:{enable:true,renameTitle:I18n.resource.dataSource.RENAME,removeTitle:I18n.resource.dataSource.REMOVE,drag:{isCopy:false,isMove:false}},data:{keep:{leaf:true,parent:true},simpleData:{enable:true}},callback:{beforeRename:zTreeBeforeRename,beforeRemove:zTreeBeforeRemove,onAsyncSuccess:zTreeOnAsyncSuccess,onAsyncError:zTreeOnAsyncError,beforeEditName:zTreeBeforEditName}};function zTreeBeforEditName(treeId,treeNode){if(treeNode.note&&treeNode.note!==''&&treeNode.name.indexOf(treeNode.note)>=0){treeNode.name=treeNode.name.split('(')[1].split(')')[0];}}
function dsItemfilter(treeId,parentNode,responseData){Spinner.spin(_this.$dsNavContain[8]);return _this.generateTreeEx(responseData);}
function addDiyDom(treeId,treeNode){if(treeNode.num){var aObj=_this.$dsNavContain.find("#"+treeNode.tId+"_switch");var $badge=$('<span class="badge treeBadge">'+treeNode.num+'</span>');aObj.next('a').after($badge);}
var $itemLeaf=_this.$dsNavContain.find('#'+treeNode.tId);$itemLeaf.attr('ptid',treeNode.id);$itemLeaf.attr('draggable',true);EventAdapter.on($itemLeaf,'dragstart',function(e){$('.templatePara').css('display','block');var tar=$(e.target);var dragSrcId=tar.attr('ptid');EventAdapter.setData({'dsItemId':dragSrcId});_this.stopBubble(e);});EventAdapter.on($itemLeaf,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemLeaf,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});EventAdapter.on($itemLeaf,'drop',function(e){var tar=$(e.target);var dstTLi=tar.closest('li');var dstId=dstTLi.eq(0).attr('id');var dstNode=_this.treeObj.getNodeByTId(dstId);var srcId=EventAdapter.getData().dsItemId;var srcJq=$('li[ptid$='+srcId+']');var srcTId=srcJq.eq(0).attr('id');var srcNode=_this.treeObj.getNodeByTId(srcTId);var dstParentId=dstNode.pId;var dstParentJq=$('li[ptid$='+dstParentId+']');var dstParentTId=dstParentJq.eq(0).attr('id');var dstParentNode=_this.treeObj.getNodeByTId(dstParentTId);var srcParentId=srcNode.pId;var srcParentJq=$('li[ptid$='+srcParentId+']');var srcParentTId=srcParentJq.eq(0).attr('id');var srcParentNode=_this.treeObj.getNodeByTId(srcParentTId);var postData={};var arrSrc=[];var arrDst=[];var srcParId=srcNode.pId;var dstParId=dstNode.pId;var saveType=0;if(srcNode.isParent&&!dstNode.isParent){return;}else if(!srcNode.isParent&&!dstNode.isParent){if(_this.treeObj.moveNode(dstNode,srcNode,'next',true)){if(srcParId==dstParId){$.each((dstParentNode.children),function(i,n){arrDst.push(n.id);});postData[dstParentId]=arrDst;}else{$.each((srcParentNode.children),function(i,n){arrSrc.push(n.id);});$.each((dstParentNode.children),function(i,n){arrDst.push(n.id);});var nSrcIdx=srcParentNode.getIndex();var nDstIdx=dstParentNode.getIndex();if(nDstIdx<nSrcIdx){postData[dstParId]=arrDst;postData[srcParId]=arrSrc;}else{postData[srcParId]=arrSrc;postData[dstParId]=arrDst;}}}}else if(!srcNode.isParent&&dstNode.isParent){if(_this.treeObj.moveNode(dstNode,srcNode,'inner',true)){if(srcParentNode.children){$.each((srcParentNode.children),function(i,n){arrSrc.push(n.id);});}
$.each((dstNode.children),function(i,n){arrDst.push(n.id);});var nSrcIdx=srcParentNode.getIndex();var nDstIdx=dstNode.getIndex();if(nDstIdx<nSrcIdx){postData[dstNode.id]=arrDst;postData[srcParId]=arrSrc;}else{postData[srcParId]=arrSrc;postData[dstNode.id]=arrDst;}}}else if(srcNode.isParent&&dstNode.isParent){saveType=1;var nSrcIdx=srcNode.getIndex();var nDstIdx=dstNode.getIndex();if(_this.treeObj.moveNode(dstNode,srcNode,'next',true)){var liGroup=$('#treeMine').children('li');if(liGroup&&liGroup.length>0){postData.groupIdList=[];$.each(liGroup,function(i,n){postData.groupIdList.push($(n).attr('ptid'));});}}}
if(0==saveType){WebAPI.post('/analysis/datasource/saveLayout/'+AppConfig.userId,postData).done(function(data){if(data.success){}}).always(function(){});}else if(1==saveType){WebAPI.post('/datasource/saveDataSourceGroupLayout/'+AppConfig.userId,postData).done(function(data){if('successful'==data.error){}}).always(function(){});}
_this.stopBubble(e);});if(treeNode.id==sessionStorage.getItem('dsOpenGroupId')){sessionStorage.removeItem('dsOpenGroupId');if(treeNode.isParent&&_this.treeObj){_this.treeObj.expandNode(treeNode,true,false,true);}}
if(!treeNode.isParent){if(0==treeNode.type){var prjName=_this.getProjectNameFromId(treeNode.projId,_this.m_langFlag);_this.initToolTips($itemLeaf,treeNode.name,prjName,treeNode.value,treeNode.note);}else if(1==treeNode.type){var showName=_this.getShowNameFromFormula(treeNode.value);_this.initFormulaToolTips($itemLeaf,treeNode.name,showName,treeNode.note);}}}
function addHoverDom(treeId,treeNode){if(treeNode.isParent){var sObj=$("#"+treeNode.tId+"_span");if(treeNode.editNameFlag||$("#addBtn_"+treeNode.tId).length>0){return;}
if(0==$("#addBtnFormula_"+treeNode.tId).length){var addStr="<span class='iconfont' id='addBtnFormula_"+treeNode.tId+"' title='add group' onfocus='this.blur();' style='margin-left:4px'>&#xe63e;</span>";sObj.after(addStr);var btnGroup=$("#addBtnFormula_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_FORMULA);if(btnGroup)btnGroup.bind("click",function(){if(_this.m_cfgPanel){$(_this.m_cfgPanel.container).remove();}
var addInterface=$('#addPointPanelContain');if(!addInterface||addInterface.length>0){return;}
_this.m_selectGroupId=treeNode.id;WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).always(function(e){});return false;});}
if(0==$("#addBtnPage_"+treeNode.tId).length){var addStr="<span class='glyphicon glyphicon-plus-sign button' id='addBtnPage_"+treeNode.tId+"' title='add point' onfocus='this.blur();' style='margin-left:4px;top:2px'></span>";sObj.after(addStr);var btnGroup=$("#addBtnPage_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_POINT);if(btnGroup)btnGroup.bind("click",function(){var parentNodes=_this.treeObj.getNodesByParam('id',treeNode.id,null);if(parentNodes.length>0){if(!parentNodes[0].zAsync){_this.treeObj.expandNode(parentNodes[0],true,false,true);}}
if(_this.m_cfgPanel){$(_this.m_cfgPanel.container).remove();}
var addInterface=$('#addPointPanelContain');if(!addInterface||addInterface.length>0){return;}
_this.m_selectGroupId=treeNode.id;WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).always(function(e){});return false;});}
if(0==$("#addBtnGroup_"+treeNode.tId).length){var addStr="<span class='glyphicon glyphicon-object-align-bottom button' aria-hidden='true' id='addBtnGroup_"+treeNode.tId+"' title='add group' onfocus='this.blur();' style='margin-left:20px;top:2px'></span>";sObj.after(addStr);var btnGroup=$("#addBtnGroup_"+treeNode.tId);if(btnGroup)btnGroup.attr('title',I18n.resource.dataSource.ADD_POINT_GROUP);if(btnGroup)btnGroup.bind("click",function(){var newName='new group';var postData={'groupId':'','name':newName,'parent':(treeNode.id).toString(),'userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){if('successful'!=result.error){return;}
var groupId=result.groupId;if(groupId){if(_this.treeObj){if(treeNode.zAsync){_this.treeObj.addNodes(treeNode,{id:result.groupId,pId:result.parentId,name:result.groupName,isParent:true});}else{_this.treeObj.expandNode(treeNode,true,false,true);}}}}).always(function(e){});return false;});}}else{_this.setHoverColor(treeNode);}};function removeHoverDom(treeId,treeNode){$("#addBtnGroup_"+treeNode.tId).unbind().remove();$("#addBtnPage_"+treeNode.tId).unbind().remove();$("#addBtnFormula_"+treeNode.tId).unbind().remove();if(!treeNode.isParent){_this.removeHoverColor(treeNode);}};function zTreeBeforeRename(treeId,treeNode,newName,isCancel){_this.zTreeBeforeRenameFunc(treeNode,newName);}
function zTreeBeforeRemove(treeId,treeNode){confirm(I18n.resource.dataSource.DELETE_GROUP_INFO,function(){_this.zTreeBeforeRemoveFunc(treeNode);_this.treeObj.removeNode(treeNode);});return false;}
function zTreeOnAsyncSuccess(event,treeId,treeNode,msg){Spinner.stop();};function zTreeOnAsyncError(event,treeId,treeNode,XMLHttpRequest,textStatus,errorThrown){Spinner.stop();};$(document).ready(function(){var treeMine=_this.$dsNavContain.find('#treeMine');var arrInit=_this.generateTreeEx(_this.m_parent.store.group);_this.treeObj=$.fn.zTree.init(treeMine,zSetting,arrInit);});},zTreeBeforeRenameFunc:function(treeNode,newName){if(treeNode.isParent){var postData={'groupId':treeNode.id,'name':newName,'parent':Boolean(treeNode.pId)?(treeNode.pId).toString():'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){if('successful'!=result.error){return false;}}).always(function(e){return true;});}else{var treeNodeNote=treeNode.note?treeNode.note:'';newName=(treeNodeNote!=='')?(treeNodeNote+'('+newName+')'):newName;var postData={itemList:[{id:treeNode.id,type:0,projId:treeNode.projId,alias:newName,note:treeNode.note,value:treeNode.value,groupId:treeNode.pId}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.itemIdList.length>0){return true;}
return false;}).error(function(e){return false;}).always(function(e){treeNode.name=newName;$('#treeMine').find('li[ptid='+treeNode.id+']').find('a span').eq(1).text(newName);});}},zTreeBeforeRemoveFunc:function(treeNode){if(treeNode.isParent){WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+treeNode.id).done(function(result){if(('successful'!=result.error)){return false}}).always(function(e){return true;});}else{var $itemLeaf=_this.$dsNavContain.find('#'+treeNode.tId);if($itemLeaf&&$itemLeaf.length>0){$itemLeaf.tooltip('destroy');}
WebAPI.get('/analysis/datasource/removeSingle/'+treeNode.id).done(function(data){if(!data.success){return false;}else{var parentId=treeNode.pId;var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num-=1;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge')
if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}
break;}}
return true;}}).always(function(){});}},generateTreeEx:function(arr){var result=[];if(!arr){return result;}
var params;var unassigned;for(var i=0,len=arr.length;i<len;i++){var item=arr[i];if(item){var itemNode=item.note?item.note:'';var itemAlias=item.alias?item.alias:'';var itemName=itemAlias;if(itemNode!==''&&itemAlias!==''){if(itemAlias.indexOf(itemNode)<0){itemName=itemNode+' ('+itemAlias+')'}}
params={id:item.id,pId:item.parentId,isParent:item.isParent,name:itemName,value:item.value,note:item.note,projId:item.projId,num:item.num,type:item.type}
if(!item.isParent){var leafIcon=(1==item.type)?'ptFormula':'ptNormal';params['iconSkin']=leafIcon;}
if('unassigned'==item.alias){unassigned=params;}else{result.push(params);}}}
if(unassigned){result.push(unassigned);}
return result;},generateSearchTree:function(arr,searchText){var result=[];var params;for(var id in arr){params={id:id,pId:null,isParent:true,name:arr[id].groupName,value:id,note:'',projId:'',type:0,open:true};result.push(params);if(arr[id].dsList){for(var i=0,len=arr[id].dsList.length;i<len;i++){var item=arr[id].dsList[i];var keyWordName=item.alias;searchText.replace(/[^\w\d\s\u4e00-\u9fa5]/g,' ').split(/\s/g).forEach(function(search_item){if(search_item){keyWordName=keyWordName.replace(new RegExp("("+search_item+")(?![^<]*>|[^<>]*</)","gi"),'<span class="keyword">$1</span>');}});params={id:item.id,pId:id,isParent:false,name:keyWordName,value:item.value,note:item.note,projId:item.projId,type:item.type,iconSkin:(1==item.type)?'ptFormula':'ptNormal'};result.push(params);}}}
return result;},setHoverColor:function(treeNode){var $row=$('#'+treeNode.tId);if($row&&$row.length>0){$row.css('background-color','#FFE6B0');var $name=$('#'+treeNode.tId+'_span');if($name&&$name.length>0){$name.css('color','#000');}
$row.find('.edit').css('color','#000');$row.find('.remove').css('color','#000');}},removeHoverColor:function(treeNode){var $row=$('#'+treeNode.tId);if($row&&$row.length>0){$row.css('background-color','');var $name=$('#'+treeNode.tId+'_span');if($name&&$name.length>0){$name.css('color','');}
$row.find('.edit').css('color','');$row.find('.remove').css('color','');}},initDsCloud:function(){var $selPrjName=_this.$dsNavContain.find('#selectPrjName');$selPrjName.empty();var opt;var prjId=AppConfig.project&&AppConfig.project.bindId?AppConfig.project.bindId:AppConfig.projectId;var nSize=AppConfig.projectList.length;var data=AppConfig.projectList.map(function(v,i){if(0==_this.m_langFlag){return{id:v.id,text:v.name_cn}}else{return{id:v.id,text:v.name_english}}});$selPrjName.select2({data:data}).off('change.myChange').on('change.myChange',function(e){var prjId=$('#selectPrjName').find('option:selected').val();_this.initDsCloudTable(prjId,1,50);}).val(prjId).trigger('change');var $inputSearch=_this.$dsNavContain.find('#inputDsCloudSearch');$inputSearch.keyup(function(e){var searchVal=$(e.currentTarget).val();if(13==e.keyCode){var prjId=_this.$dsNavContain.find('#selectPrjName').val();if(!prjId){return false;}
var size=50;WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:1,pageSize:size,searchText:searchVal}).done(function(result){if(result.success&&result.data){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');$tableBody.empty();_this.setCloudTable(result.data.pointTable);var ptTotal=result.data.pointTotal;var allPageNum=Math.ceil(ptTotal/size);_this.setCloudNav(allPageNum);_this.initCurPageNum(1);}}).always(function(e){});}
if(''==searchVal){_this.initDsCloudFunc();}});_this.$dsNavContain.find('#spanDsCloudSearch').click(function(e){$inputSearch.val('');_this.initDsCloudFunc();});},initCurPageNum:function(page){this.m_curPageNum=page;},initDsCloudTable:function(prjId,page,size){if(!prjId){return false;}
Spinner.spin(_this.$dsNavContain[8]);WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:page,pageSize:size}).done(function(result){if(result.success&&result.data){_this.m_arrCloudTableInfo=result.data.pointTable;_this.setCloudTable(_this.m_arrCloudTableInfo);var ptTotal=result.data.pointTotal;var allPageNum=Math.ceil(ptTotal/size);_this.setCloudNav(allPageNum);_this.initCurPageNum(page);}}).always(function(e){Spinner.stop();});},initDsCloudFunc:function(){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');$tableBody.empty();var prjId=_this.$dsNavContain.find('#selectPrjName').val();_this.initDsCloudTable(prjId,1,50);},setCurrentPage:function(curPageNum,size){curPageNum=parseInt(curPageNum,10);var prjId=_this.$dsNavContain.find('#selectPrjName').val();if(!prjId){return false;}
Spinner.spin(_this.$dsNavContain[8]);WebAPI.post('/point_tool/getCloudPointTable/',{projectId:parseInt(prjId),currentPage:curPageNum,pageSize:size,searchText:_this.$dsNavContain.find('#inputDsCloudSearch').val()}).done(function(result){if(result.success&&result.data){var ptTotal=result.data.pointTotal?result.data.pointTotal:0;var allPageNum=Math.ceil(ptTotal/size);_this.initCurPageNum(curPageNum);var liPageNum=$('#navPageNum').find('.pageNum');if(curPageNum<=3){liPageNum.eq(0).attr('value','1');liPageNum.eq(1).attr('value','2');liPageNum.eq(2).attr('value','3');liPageNum.eq(3).attr('value','4');liPageNum.eq(4).attr('value','5');liPageNum.eq(0).text('1');liPageNum.eq(1).text('2');liPageNum.eq(2).text('3');liPageNum.eq(3).text('4');liPageNum.eq(4).text('5');}else if(curPageNum>=allPageNum-2){liPageNum.eq(0).attr('value',allPageNum-4);liPageNum.eq(1).attr('value',allPageNum-3);liPageNum.eq(2).attr('value',allPageNum-2);liPageNum.eq(3).attr('value',allPageNum-1);liPageNum.eq(4).attr('value',allPageNum);liPageNum.eq(0).text(allPageNum-4);liPageNum.eq(1).text(allPageNum-3);liPageNum.eq(2).text(allPageNum-2);liPageNum.eq(3).text(allPageNum-1);liPageNum.eq(4).text(allPageNum);}else{liPageNum.eq(0).attr('value',curPageNum-2);liPageNum.eq(1).attr('value',curPageNum-1);liPageNum.eq(2).attr('value',curPageNum);liPageNum.eq(3).attr('value',curPageNum+1);liPageNum.eq(4).attr('value',curPageNum+2);liPageNum.eq(0).text(curPageNum-2);liPageNum.eq(1).text(curPageNum-1);liPageNum.eq(2).text(curPageNum);liPageNum.eq(3).text(curPageNum+1);liPageNum.eq(4).text(curPageNum+2);}
for(var i=0,len=liPageNum.length;i<len;i++){var item=liPageNum.eq(i);if(item.attr('value')==curPageNum){item.closest('li').attr('class','active');}else{item.closest('li').removeAttr('class');}}
_this.setCloudTable(result.data.pointTable);}}).always(function(e){Spinner.stop();});},setCloudTable:function(ptTable,searchText){var $tableBody=_this.$dsNavContain.find('#tableDsCloud tbody');if($tableBody){$tableBody.empty();for(var i=0,len=ptTable.length;i<len;i++){var $itemTr=$('<tr ptId="'+ptTable[i]._id+'" draggable="true" title="'+ptTable[i].value+' : '+ptTable[i].alias+' "></tr>');var $itemTd=$('<td>');var $itemTdName=$('<span class="tabColName" data-value="'+ptTable[i].value+'">'+ptTable[i].value+'</span>');var $itemTdDesc=$('<span class="tabColDesc"> -- '+ptTable[i].alias+'</span>');var $itemTdIcon=$('<span class="btnFav glyphicon glyphicon-plus-sign" aria-hidden="true"></span>');$itemTdIcon.off().click(function(e){var $row=$(e.currentTarget).closest('tr');var ptId=$row.attr('ptId');for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){if(ptId==_this.m_arrCloudTableInfo[i]._id){_this.insertIntoMineTable(_this.m_arrCloudTableInfo[i]);break;}}});$itemTd.append($itemTdName);$itemTdDesc.append($itemTdIcon);$itemTd.append($itemTdDesc);$itemTr.append($itemTd);var start=null;EventAdapter.on($itemTr,'click',function(e){e=e||event;var $this=$(this);var $tableDsCloud=$('#tableDsCloud');var trArr=$tableDsCloud.find('tr');if(e.ctrlKey){if(!e.shiftKey){if($this.hasClass('activeTr')){$this.removeClass('activeTr');}else{$this.addClass('activeTr');}
start=this;}else{var startIndex=$(start).index(),lastIndex=$this.index();var selTr=trArr.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);if($(start).hasClass('activeTr')){selTr.addClass('activeTr');}else{selTr.removeClass('activeTr');}}}else if(e.shiftKey){if($('.activeTr').length!==0){var startIndex=$(start).index(),lastIndex=$this.index();var selTr=trArr.slice(Math.min(startIndex,lastIndex),Math.max(startIndex,lastIndex)+1);selTr.addClass('activeTr');trArr.not(selTr).removeClass('activeTr');}else{$this.addClass('activeTr');}}else{trArr.removeClass('activeTr');$this.addClass('activeTr');start=this;}});EventAdapter.on($itemTr,'dragstart',function(e){$('.templatePara').css('display','block');var tar=($('.activeTr').length>1)?$('.activeTr'):$(e.target);var targetId=$(e.target).attr('ptid');var dragSrcId=undefined,isDragMore=false,dragId=[];if($('.activeTr').length>1){tar.each(function(i,item){var itemId=$(item).attr('ptid');if(itemId===targetId){isDragMore=true;}
dragId.push(itemId);});if(isDragMore){dragSrcId=dragId;}else{dragSrcId=targetId;}}else{dragSrcId=tar.attr('ptid');}
EventAdapter.setData({'dsItemId':dragSrcId});e.originalEvent.dataTransfer.setData('dsItemId',dragSrcId);});EventAdapter.on($itemTr,'dragover',function(e){e.preventDefault();});EventAdapter.on($itemTr,'dragend',function(e){$('.templatePara').css('display','none');var $template=$('#anlsPane').find('.anlsTemplate');$template.attr('class','anlsTemplate');});$tableBody.append($itemTr);}}},setCloudNav:function(allPageNum){var ul=$('<ul class="pagination">\
                <li><a class="pageFlag" value="First"><span aria-hidden="true">&laquo;</span></a></li>\
                <li><a class="pageFlag" value="Previous"><span aria-hidden="true">&lsaquo;</span></a></li>\
            </ul>');if(allPageNum>5){ul.append('<li class="active"><a class="pageFlag pageNum" value="1">1</a></li>\
                    <li><a class="pageFlag pageNum" value="2">2</a></li>\
                    <li><a class="pageFlag pageNum" value="3">3</a></li>\
                    <li><a class="pageFlag pageNum" value="4">4</a></li>\
                    <li><a class="pageFlag pageNum" value="5">5</a></li>');}else{for(var i=0;i<allPageNum;i++){var numTmp=i+1;if(0==i){ul.append('<li class="active"><a class="pageFlag pageNum" value="'+numTmp+'">'+numTmp+'</a></li>');}else{ul.append('<li><a class="pageFlag pageNum" value="'+numTmp+'">'+numTmp+'</a></li>');}}}
ul.append('<li><a class="pageFlag" value="Next"><span aria-hidden="true">&rsaquo;</span></a></li>\
                        <li><a class="pageFlag" value="Last"><span aria-hidden="true">&raquo;</span></a></li>');var pageFlag=ul.find('.pageFlag');pageFlag.click(function(e){var value=$(e.currentTarget).attr('value');if('First'==value){if(_this.m_curPageNum!=1){_this.setCurrentPage(1,50);}}else if('Previous'==value){if(_this.m_curPageNum>1){_this.setCurrentPage(_this.m_curPageNum-1,50);}}else if('Next'==value){if(_this.m_curPageNum<allPageNum){_this.setCurrentPage(_this.m_curPageNum+1,50);}}else if('Last'==value){if(_this.m_curPageNum!=allPageNum){_this.setCurrentPage(allPageNum,50);}}else{if(_this.m_curPageNum!=value){_this.setCurrentPage(value,50);}}});var $navPage=_this.$dsNavContain.find('#navPageNum');$navPage.empty();$navPage.append(ul);},insertIntoMineTable:function(newNode){var nodeParent=_this.treeObj.getNodesByParam('name','unassigned',null);if(nodeParent.length>0){var postData={itemList:[{type:0,projId:newNode.projId,alias:newNode.value,value:newNode.value,groupId:nodeParent[0].id}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.itemIdList.length>0){var item=data.itemIdList[0];var obj={id:item.id,pId:item.groupId,name:item.alias,isParent:false,value:item.value,note:item.note}
_this.treeObj.addNodes(nodeParent[0],-1,obj);}}).always(function(e){});}},initElement:function(){var _this=this;var len=AppConfig.projectList.length;var item;if(!(_this.m_parent.arrColor instanceof Array))return;var nColorSize=_this.m_parent.arrColor.length;for(var i=0;i<len;i++){item=AppConfig.projectList[i];_this.m_arrProjIdColorMap[item.id]=_this.m_parent.arrColor[i-parseInt(i/nColorSize)*nColorSize];}
EventAdapter.on($('#data_source_add'),'click',function(e){if(0==_this.m_selectGroupId){alert(_this.m_lang.NO_SELECT_GROUP);return;}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});EventAdapter.on($('#data_source_formula_add'),'click',function(e){if(0==_this.m_selectGroupId){alert(_this.m_lang.NO_SELECT_GROUP);return;}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});EventAdapter.on($('#divAnlsDatasourcePane'),'click',function(e){_this.clearSelect();},false);$('#inputDsSearch').keyup(function(e){var searchVal=$(e.currentTarget).val();if(13==e.keyCode){$('#dataSrcPanel').empty();searchVal=searchVal.toLowerCase();_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,searchVal);$('#dataSrcAddGroup').hide();}
if(''==searchVal){$('#dataSrcPanel').empty();_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,'');_this.colapseGroupsDefault();$('#dataSrcAddGroup').show();}});},insertIntoDataList:function(customName,ptName,ptDesc,prjName,iconColor,itemId,baseNode,bIsAppend,bIsSelected){var _this=this;var div;if(bIsSelected){div=$('<div draggable="true" class="dsItem grow dsSelected" style="height:34px"></div>');}else{div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');}
div.attr('id',itemId);div.click(function(e){_this.clearSelect();var target=$(e.currentTarget);if('dsItem grow'==target.attr('class')){target.attr('class','dsItem grow dsSelected');}else{target.attr('class','dsItem grow');}
_this.stopBubble(e);});var icon=$('<div class="dsMark"></div>');icon.css('background-color',iconColor);div.append(icon);var custName=$('<div class="dsValue" style="height:36px;">'+customName+'</div>');div.append(custName);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
_this.m_selectItemId=$(e.currentTarget).closest('.dsItem').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){confirm(_this.m_lang.REMOVE_CONFIRM_TIPS,function(){var div=$(e.currentTarget).closest('.dsItem');var dataSrcItemId=div.attr('id');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=data.deleteModal;var len=arr.length;if(len>0){var delMod;var arrDelTitle=[];for(var i=0;i<len;i++){delMod=$('#'+arr[i]);arrDelTitle.push(delMod.find('.newDivPageTitle').val());delMod.remove();}
var delTitle=_this.m_lang.WORKSPACE+':';for(var i=0,len=arrDelTitle.length;i<len;i++){delTitle+=arrDelTitle[i]+' ';}
delTitle+=_this.m_lang.REMOVE_RESULT;alert(delTitle);}}});});});div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>');var ctlPrjName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.PROJECT_NAME+': '+prjName+'</label></div>');ctlPrjName.click(function(e){_this.stopBubble(e);});divChange.append(ctlPrjName);var ctlPtName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.POINT_NAME+': '+ptName+'</label></div>');ctlPtName.click(function(e){_this.stopBubble(e);});divChange.append(ctlPtName);var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find('label').text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find('input');ctlInput.attr('value',customName);ctlInput.attr('placeholder',_this.m_lang.CUSTOM_NAME);inputCustName.click(function(e){_this.stopBubble(e);});divChange.append(inputCustName);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find('label').text(_this.m_lang.POINT_DESC);ctlInput=inputDesc.find('input');ctlInput.attr('value',ptDesc);ctlInput.attr('placeholder',_this.m_lang.POINT_DESC);inputDesc.click(function(e){_this.stopBubble(e);});divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE);btnOk.click(function(e){var temp=$(e.currentTarget).closest('.dsDivChange').find('input');var strName=$(temp[0]).val();var strDesc=$(temp[1]).val();var prjId,ptName,item;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){prjId=item.prjId;ptName=item.ptName;break;}}
var postData={itemList:[{id:itemId,type:0,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:''}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){var id=(data.itemIdList)[0].id;for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName;_this.m_allPointList[i].ptDesc=strDesc;break;}}
_this.setToolTipsCustomName(div,strName);_this.setToolTipsDesc(div,strDesc);_this.calUpdateDataSources();$('#'+id).find('.dsValue').text(strName);}).error(function(e){});});divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL);btnCancel.click(function(e){});divChange.append(btnCancel);div.append(divChange);if(bIsAppend){baseNode.append(div);}else{baseNode.after(div);}},initToolTips:function(parent,customName,projectName,pointName,pointDesc){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="customName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="projectName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.PROJECT_NAME).append('</span>: ').append(projectName).append('</p> ');show.append('        <p class="pointName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_NAME).append('</span>: ').append(pointName).append('</p> ');show.append('        <p class="pointDesc tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(pointDesc).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'left',title:_this.m_lang.PARAM,template:show.toString(),trigger:'hover'};parent.tooltip(options);},setToolTipsAll:function(row,userName,customName,projectName,pointName,pointDesc){var tip=row.data('bs.tooltip').$tip;userName=': '+userName;customName=': '+customName;projectName=': '+projectName;pointName=': '+pointName;pointDesc=': '+pointDesc;tip.find('.userName').text(this.m_lang.USER_NAME+userName);tip.find('.customName').text(this.m_lang.CUSTOM_NAME+customName);tip.find('.projectName').text(this.m_lang.PROJECT_NAME+projectName);tip.find('.pointName').text(this.m_lang.POINT_NAME+pointName);tip.find('.pointDesc').text(this.m_lang.POINT_DESC+pointDesc);},setToolTipsCustomName:function(row,customName){var tip=row.data('bs.tooltip').$tip;tip.find('.customName').text(this.m_lang.CUSTOM_NAME+': '+customName);},setToolTipsDesc:function(row,ptDesc){var tip=row.data('bs.tooltip').$tip;tip.find('.pointDesc').text(this.m_lang.POINT_DESC+': '+ptDesc);},renderTabel:function(){var _this=this;var len=_this.m_newPointList.length;if(len<=0){return;}
var div=$('#dataSrcPanel');var rowBaseNum=div.find('.dsItem').length;var rowCount;var item;var eachItem;var postData;len=_this.m_newPointList.length;if(len>0){postData={itemList:[]};var arrOld=[];var bIsExist=false;var parentId=_this.m_newPointList[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){arrOld=parentNodes[0].children;}
for(var i=0;i<len;i++){item=_this.m_newPointList[i];eachItem={type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId}
var bFlag=false;for(var j=0;j<arrOld.length;j++){if(item.prjId==arrOld[j].projId&&item.ptName==arrOld[j].value){bIsExist=true;bFlag=true;break;}}
if(!bFlag){postData.itemList.push(eachItem);}}
if(bIsExist){alert(I18n.resource.dataSource.ALREADY_EXIST);}
var projName=_this.m_newPointList[0].prjName;var iconColor=_this.m_newPointList[0].iconColor;if(postData.itemList.length>0){WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.datasourceId){_this.m_dataSourceId=data.datasourceId;}
var list=data.itemIdList;var nAddlen=postData.itemList.length;for(var i=0;i<nAddlen;i++){if(postData.itemList[i].alias==list[i].alias){postData.itemList[i].itemId=list[i].id;}}
if(_this.treeObj){var parentId=_this.m_newPointList[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){if(parentNodes[0].zAsync){var arrNodes=[];for(var i=0;i<postData.itemList.length;i++){var item=postData.itemList[i];var itemNode=item.note?item.note:'';var itemAlias=item.alias?item.alias:'';var itemName=itemAlias;if(itemNode!==''&&itemAlias!==''){if(itemAlias.indexOf(itemNode)<0){itemName=itemNode+' ('+itemAlias+')'}}
arrNodes.push({id:item.itemId,pId:item.groupId,isParent:false,name:itemName,value:item.value,projId:item.projId,note:item.note,type:0,iconSkin:'ptNormal'});}
_this.treeObj.addNodes(parentNodes[0],arrNodes);}else{_this.treeObj.expandNode(parentNodes[0],true,false,true);}
var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num+=nAddlen;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge')
if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}
break;}}}}
_this.m_allPointList=_this.m_allPointList.concat(_this.m_newPointList);_this.calUpdateDataSources();}).error(function(){}).always(function(){});}}},modifyTable:function(){var _this=this;var item;var eachItem;var postData;var len=_this.m_newPointList.length;if(len>0){postData={itemList:[]};item=_this.m_newPointList[0];eachItem={id:item.itemId,type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.datasourceId){_this.m_dataSourceId=data.datasourceId;}
for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(item.itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].prjId=item.prjId;_this.m_allPointList[i].prjName=_this.m_newPointList[0].prjName;_this.m_allPointList[i].customName=item.customName;_this.m_allPointList[i].ptName=item.ptName;_this.m_allPointList[i].ptDesc=item.ptDesc;break;}}
var divItem=$('#'+item.itemId);divItem.find('.showName').text(item.customName);_this.setToolTipsAll(divItem,item.userName,item.customName,item.prjName,item.ptName,item.ptDesc);_this.calUpdateDataSources();Beop.cache.ds.remove(item.itemId);}).error(function(){}).always(function(){});}},initDrag:function(){var _this=this;_this.dragOperateSrc($('#dataSrcPanel').get(0));_this.dragOperateCfg($('.springConfigMask').parent().get(0));},dragOperateSrc:function(tableList){if(undefined==tableList){return;}
var _this=this;EventAdapter.on($(tableList),'dragstart',function(e){var tar=$(e.target);var className=tar.attr('class');if(!className){e.preventDefault();return;}
if(tar.children('input').length>0){e.preventDefault();}
if(-1!=className.indexOf('nav nav-list tree-group')){var dragSrcId=tar.attr('id');EventAdapter.setData({'dsGroupId':dragSrcId});}else if(-1!=className.indexOf('treeRow ui-draggable')){var dragSrcId=tar.attr('id');EventAdapter.setData({'dsItemId':dragSrcId});}else{return;}
$('.templatePara').css('display','block');});EventAdapter.on($(tableList),'dragover',function(e){e.preventDefault();});EventAdapter.on($(tableList),'drop',function(e){var tarItem=$(e.target);var tarId=0;var dstGroupId=0;var srcGroupId=0;var rowClass=tarItem.attr('class');if(!rowClass){return;}
var dragType=-1;var draggedID=0;if(-1!=rowClass.indexOf('nav nav-list tree-group')||-1!=rowClass.indexOf('dsTreeHeader')){tarId=tarItem.closest('.nav').attr('id');draggedID=EventAdapter.getData().dsGroupId;if(Boolean(draggedID)){dragType=0;}else{draggedID=EventAdapter.getData().dsItemId;if(Boolean(draggedID)){dragType=2;tarId=tarItem.closest('.nav').attr('id');dstGroupId=tarId;srcGroupId=$('#'+draggedID).closest('.nav').attr('id');}}}else if(-1!=rowClass.indexOf('showName')||-1!=rowClass.indexOf('treeRow ui-draggable')){dragType=1;draggedID=EventAdapter.getData().dsItemId;tarId=tarItem.closest('.treeRow').attr('id');dstGroupId=tarItem.closest('.nav').attr('id');srcGroupId=$('#'+draggedID).closest('.nav').attr('id');}else{return;}
if(draggedID==tarId||!draggedID){return;}
if(0===dragType){var item,groupName;for(var i=0,len=_this.m_allGroupList.length;i<len;i++){item=_this.m_allGroupList[i];if(draggedID==item.id){groupName=item.name;break;}}
$('#'+draggedID).remove();_this.insertTreeGroup(draggedID,groupName,1,$('#'+tarId));for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(draggedID==item.groupId){if(item.itemType==0){_this.insertTreeItem($('#'+draggedID),item.itemId,item.iconColor,item.customName,0,'',true);}else{_this.insertTreeItem($('#'+draggedID),item.itemId,item.iconColor,item.customName,0,'',false);}
var prjName=_this.getProjectNameFromId(item.prjId,_this.m_langFlag);_this.initToolTips($('#'+item.itemId),item.customName,prjName,item.ptName,item.ptDesc);}}
var dstGroup,srcGroup;var arrDst=[],arrSrc=[];dstGroup=$('#'+tarId).find('.rows').find('.treeRow');srcGroup=$('#'+draggedID).find('.rows').find('.treeRow');$.each(dstGroup,function(i,n){arrDst.push(n.id);});$.each(srcGroup,function(i,n){arrSrc.push(n.id);});var postData={};postData[tarId]=arrDst;postData[draggedID]=arrSrc;WebAPI.post('/datasource/saveDataSourceGroupLayout/'+AppConfig.userId,postData).done(function(data){if('successful'==data.error){}}).error(function(){}).always(function(){});}else if(1===dragType||2===dragType){var itemType=0;var iconColor='';var custName='';var projId=0;var pointName='';var pointDesc='';for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(draggedID==_this.m_allPointList[i].itemId){_this.m_allPointList[i].groupId=dstGroupId;itemType=_this.m_allPointList[i].itemType;iconColor=_this.m_allPointList[i].iconColor;custName=_this.m_allPointList[i].customName;projId=_this.m_allPointList[i].prjId;pointName=_this.m_allPointList[i].ptName;pointDesc=_this.m_allPointList[i].ptDesc;break;}}
var selItem=$('#'+draggedID);selItem.tooltip('destroy');selItem.remove();if(itemType==0){_this.insertTreeItem($('#'+dstGroupId),draggedID,iconColor,custName,dragType,$('#'+tarId),true);}else{_this.insertTreeItem($('#'+dstGroupId),draggedID,iconColor,custName,dragType,$('#'+tarId),false);}
if(0==itemType){var prjName=_this.getProjectNameFromId(projId,_this.m_langFlag);_this.initToolTips($('#'+draggedID),custName,prjName,showName,pointDesc);}else if(1==itemType){var showName=_this.getShowNameFromFormula(pointName);_this.initFormulaToolTips($('#'+draggedID),custName,showName,pointDesc);}else{return;}
var postData={};if(dstGroupId==srcGroupId){var srcGroup,arrSrc=[];srcGroup=$('#'+srcGroupId).find('.rows').find('.treeRow');$.each(srcGroup,function(i,n){arrSrc.push(n.id);});postData[srcGroupId]=arrSrc;}else{var dstGroup,srcGroup;var arrDst=[],arrSrc=[];dstGroup=$('#'+dstGroupId).find('.rows').find('.treeRow');srcGroup=$('#'+srcGroupId).find('.rows').find('.treeRow');$.each(dstGroup,function(i,n){arrDst.push(n.id);});$.each(srcGroup,function(i,n){arrSrc.push(n.id);});var dstGroupCnt=0,srcGroupCnt=0;var groups=$('#dataSrcPanel .nav');$.each(groups,function(i,n){if(n.id==dstGroupId){dstGroupCnt=i;}
if(n.id==srcGroupId){srcGroupCnt=i;}});if(dstGroupCnt<srcGroupCnt){postData[dstGroupId]=arrDst;postData[srcGroupId]=arrSrc;}else{postData[dstGroupId]=arrDst;postData[srcGroupId]=arrSrc;}}
WebAPI.post('/analysis/datasource/saveLayout/'+AppConfig.userId,postData).done(function(data){if(data.success){}}).error(function(){}).always(function(){});}});},dragOperateCfg:function(divItem){if(undefined==divItem){return;}
var _this=this;EventAdapter.on($(divItem),'dragstart',function(e){var target=$(e.target);var className=target.attr('class');if('dsItem grow'!=className&&'dsItem grow dsSelected'!=className){return;}
var dragSrcId=target.attr('id');EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($(divItem),'dragover',function(e){e.preventDefault();});EventAdapter.on($(divItem),'drop',function(e){var target=$(e.target);});},saveCurrentRecords:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.post('/delete_data_source_records_by_userid',{userId:AppConfig.userId}).done(function(result){if(result!=0){Spinner.stop();return;}
var newPtList=[];var id;var len=_this.m_allPointList.length;var newRow;var item;$('#dataSrcPanel .dsItem').each(function(){id=$(this).attr('id');for(var i=0;i<len;i++){item=_this.m_allPointList[i];if(id==item.itemId){newRow={'itemId':id,'userId':item.userId,'userName':item.userName,'customName':item.customName,'prjId':item.prjId,'prjName':item.prjName,'ptName':item.ptName,'ptDesc':item.ptDesc,'iconColor':item.iconColor,'itemId':item.itemId}
newPtList.push(newRow);break;}}});_this.m_allPointList=newPtList;var row;var data=[];var len=_this.m_allPointList.length;for(var i=0;i<len;i++){item=_this.m_allPointList[i];row={'userId':item.userId,'customName':item.customName,'projectId':item.prjId,'pointName':item.ptName,'pointDesc':item.ptDesc,'iconColor':item.iconColor}
data.push(row);}
WebAPI.post('/save_data_source_record',{sourceList:data}).done(function(result){if(0==result){}}).error(function(result){alert(I18n.resource.observer.widgets.DATABASE_OPERATION_FAILED+'！');return;});}).error(function(result){alert(I18n.resource.observer.widgets.FAIL_BEFORE_EXECUTING+'！');return;}).always(function(){Spinner.stop();});},loadDataSourceRecord:function(){var _this=this;var groupInfo=_this.m_parent.store.group;if(!groupInfo){return;}
_this.m_allGroupList=[];_this.m_allPointList=[];var itemDefault=null;for(var m=0,n=groupInfo.length;m<n;m++){var groupId=groupInfo[m].groupId;var groupName=groupInfo[m].groupName;var groupIsDefault=(Boolean(groupInfo[m].isDefault))?true:false;var data=groupInfo[m].datasourceList;var groupItem={'id':groupId,'name':groupName,'isDefault':groupIsDefault};if(groupIsDefault){itemDefault=groupItem;}else{_this.m_allGroupList.push(groupItem);}
if(data){var len=data.length;var item;for(var i=0;i<len;i++){item={userId:AppConfig.userId,userName:AppConfig.account,customName:data[i].alias,prjId:data[i].projId,prjName:_this.getProjectNameFromId(data[i].projId),ptName:data[i].value,ptDesc:data[i].note,iconColor:_this.m_arrProjIdColorMap[data[i].projId],itemId:data[i].id,itemType:data[i].type,itemValue:data[i].value,groupId:groupId,groupName:groupName}
if(item.itemType==1){item.iconColor='#000000';}
_this.m_allPointList.push(item);}}}
if(itemDefault){_this.m_allGroupList.push(itemDefault);}},colapseGroupsDefault:function(){var treeAllHead=$('.dsTreeHeader .dsGroupName');var item,row;for(var i=0,len=treeAllHead.length;i<len;i++){item=treeAllHead.eq(i);row=item.closest('.tree-group').find('.rows');if(!row||row.length<=0){continue;}
if(item.text()==this.m_unassigned){row.css('display','block');}else{row.css('display','none');}}},colapseGroups:function(openGroupId){if(!openGroupId){return;}
var treeAllRow=$('#dataSrcPanel .tree-group');var item,row;for(var i=0,len=treeAllRow.length;i<len;i++){item=treeAllRow.eq(i);row=item.find('.rows');if(!row||row.length<=0){continue;}
if(item.attr('id')==openGroupId){row.css('display','block');}else{row.css('display','none');}}
sessionStorage.removeItem('dsOpenGroupId');},getProjectNameFromId:function(id,langFlag){var name;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(id==item.id){if(0==langFlag){name=item.name_cn;}else{name=item.name_en;}
break;}}
return name;},getProjectIdFromName:function(projectName){var id;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(projectName==item.name_cn){id=item.id;break;}}
return id;},calUpdateDataSources:function(){return;var _this=this;var updateData=[];for(var i=0,len=_this.m_allGroupList.length;i<len;i++){var groupItem={'groupId':_this.m_allGroupList[i].id,'groupName':_this.m_allGroupList[i].name,'parentId':'','datasourceList':''};var dsList=[];for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){var curItem=_this.m_allPointList[j];if(groupItem.groupId==curItem.groupId){var pushItem={'id':curItem.itemId,'type':curItem.itemType,'projId':curItem.prjId,'alias':curItem.customName,'note':curItem.ptDesc,'value':curItem.ptName,'groupId':curItem.groupId};dsList.push(pushItem);}}
groupItem.datasourceList=dsList;updateData.push(groupItem);}
this.m_parent.updateDataSources(updateData);},renderFormula:function(_customName,_formulaVal,_formulaDesc){var _this=this;var postData={itemList:[]};var prjId=0;var eachItem={type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var item;var arrNewFormula=[];for(var i=0,len=list.length;i<len;i++){item={'itemId':list[i].id,'itemType':1,'customName':list[i].alias,'itemValue':list[i].value,'ptName':list[i].value,'prjId':prjId,'iconColor':'#000000','ptDesc':_formulaDesc,'groupId':list[i].groupId};arrNewFormula.push(item);}
if(_this.treeObj){var parentId=arrNewFormula[0].groupId;var parentNodes=_this.treeObj.getNodesByParam('id',parentId,null);if(parentNodes.length>0){if(parentNodes[0].zAsync){var arrNodes=[];for(var i=0;i<len;i++){arrNodes.push({id:arrNewFormula[i].itemId,pId:arrNewFormula[i].groupId,isParent:false,name:arrNewFormula[i].customName,value:arrNewFormula[i].itemValue,projId:arrNewFormula[i].prjId,note:arrNewFormula[i].ptDesc,type:1,iconSkin:'ptFormula'});}
_this.treeObj.addNodes(parentNodes[0],arrNodes);}else{_this.treeObj.expandNode(parentNodes[0],true,false,true);}
var arrGroup=_this.m_parent.store.group;for(var i=0;i<arrGroup.length;i++){if(arrGroup[i].id==parentId){arrGroup[i].num+=1;var $nodeParent=$("li[ptid='"+parentId+"']");if($nodeParent&&$nodeParent.length>0){var $spanBadge=$nodeParent.find('.treeBadge')
if($spanBadge&&$spanBadge.length>0){$spanBadge.text(arrGroup[i].num.toString());}}
break;}}}}
_this.calUpdateDataSources();});},modifyFormula:function(_customName,_formulaVal,_formulaDesc){var _this=this;var postData={itemList:[]};var itemId=_this.m_selectItemId;var prjId=Number(AppConfig.projectId);var eachItem={id:itemId,type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;if(list.length>0){var showName=list[0].value;var arr=showName.split('<%');var arrId=[];var arrItem=[];for(var j=0,len2=arr.length;j<len2;j++){var id=arr[j].split('%>')[0];if(''!=id){arrId.push(id);}}
arrItem=_this.getDSItemById(arrId);for(var j=0,len2=arr.length;j<len2;j++){var id=arr[j].split('%>')[0];if(''==id){continue;}
for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var retVal=arrItem[m];if(null==retVal){continue;}
showName=showName.replace(id,retVal.value);break;}}}
showName=showName.replace(/<%/g,'');showName=showName.replace(/%>/g,'');for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=list[0].alias;_this.m_allPointList[i].ptName=list[0].value;_this.m_allPointList[i].ptDesc=list[0].note;break;}}
var divFormula=$('#'+itemId);divFormula.find('.showName').text(list[0].alias);_this.setFormulaToolTipsAll(divFormula,list[0].alias,showName,list[0].note);_this.calUpdateDataSources();Beop.cache.ds.remove(itemId);}});},insertFormula:function(itemId,customName,iconColor,formula,desc){var _this=this;var div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');div.attr('id',itemId);div.click(function(e){_this.clearSelect();var tar=$(e.currentTarget);if('dsItem grow'==tar.attr('class')){tar.attr('class','dsItem grow dsSelected');}else{tar.attr('class','dsItem grow');}
_this.stopBubble(e);});var icon=$('<div class="dsMark"></div>');icon.css('background-color',iconColor);div.append(icon);var name=$('<div class="dsValue" style="height:36px"></div>');name.text(customName);div.append(name);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){var show=$(e.currentTarget).prevAll('.dsValue');show.css('display','none');var target=$(e.currentTarget).nextAll('.dsDivChange');target.attr('class','dsDivChange show');div.css('height','240px');div.css('width','100%');var item;var strName='';var strFormula='';var strDesc='';for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){strName=item.customName;strFormula=item.ptName;strDesc=item.ptDesc;break;}}
var temp=target.find('input');if(temp.length==2){$(temp[0]).val(strName);$(temp[1]).val(strDesc);}
_this.stopBubble(e);}).error(function(e){});div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){confirm(_this.m_lang.REMOVE_CONFIRM,function(){var div=$(e.currentTarget).closest('.dsItem');var dataSrcItemId=div.attr('id');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();}});});});div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>');var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find('label').text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find('input');ctlInput.attr('value',customName);ctlInput.attr('placeholder',_this.m_lang.CUSTOM_NAME);inputCustName.click(function(e){_this.stopBubble(e);});divChange.append(inputCustName);var ctlFormula=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.FORMULA_NAME+': </label></div>');var showFormula=$('<span>'+formula+'</span>');showFormula.appendTo(ctlFormula.find('label')).mathquill();ctlFormula.click(function(e){_this.stopBubble(e);});divChange.append(ctlFormula);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find('label').text(_this.m_lang.POINT_DESC);ctlInput=inputDesc.find('input');ctlInput.attr('value',desc);ctlInput.attr('placeholder',_this.m_lang.POINT_DESC);inputDesc.click(function(e){_this.stopBubble(e);});divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE);btnOk.click(function(e){var temp=$(e.currentTarget).closest('.dsDivChange').find('input');var strName=$(temp[0]).val();var strDesc=$(temp[1]).val();var prjId,ptName,item;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){prjId=item.prjId;ptName=item.ptName;break;}}
var postData={itemList:[{id:itemId,type:1,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:''}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(0==data.itemIdList.length){return;}
var id=(data.itemIdList)[0].id;for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName;_this.m_allPointList[i].ptDesc=strDesc;break;}}
_this.setToolTipsCustomName(div,strName);_this.setToolTipsDesc(div,strDesc);_this.calUpdateDataSources();$('#'+id).find('.dsValue').text(strName);}).error(function(e){});});divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL);btnCancel.click(function(e){});divChange.append(btnCancel);div.append(divChange);$('#dataSrcPanel').append(div);},initFormulaToolTips:function(parent,customName,formula,desc){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:400px;">');show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="customName tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="formula tipStyle" style="word-break:normal;"><span class="tipTitleStyle">').append(_this.m_lang.FORMULA_NAME).append('</span>: ').append('</p>');show.append('        <p class="pointDesc tipStyle"><span class="tipTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(desc).append('</p>');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var showFormula=$('<span>'+formula+'</span>');var showObj=$(show.toString());showFormula.appendTo(showObj.find('.formula')).mathquill();var options={placement:'left',title:_this.m_lang.PARAM,template:showObj};parent.tooltip(options);},setFormulaToolTipsAll:function(row,customName,formulaVal,formulaDesc){var tip=row.data('bs.tooltip').$tip;tip.find('.customName').html('<span style="font-weight:bold">'+this.m_lang.CUSTOM_NAME+'</span>: '+customName);tip.find('.pointDesc').html('<span style="font-weight:bold">'+this.m_lang.POINT_DESC+'</span>: '+formulaDesc);var showFormula=$('<span>'+formulaVal+'</span>');var dst=tip.find('.formula').html('<span style="font-weight:bold">'+this.m_lang.FORMULA_NAME+'</span>: ');showFormula.appendTo(dst).mathquill();},checkRepeatWithCustomName:function(_name){var _this=this;var bRet=false;var grids=$('#dataSrcPanel .dsItem .dsValue');$.each(grids,function(i,n){if(_name==$(n).text()){bRet=true;return false;}});return bRet;},stopBubble:function(e){if(e&&e.stopPropagation){e.stopPropagation();}else{window.event.cancelBubble=true;}},clearSelect:function(e){var itemList=$('#dataSrcPanel .dsItem');itemList.attr('class','dsItem grow');itemList.css('height','34px');itemList.css('width','33%');var panel=$('#dataSrcPanel');panel.find('.dsDivChange').attr('class','dsDivChange');panel.find('.dsValue').css('display','inline');},insertTreeGroup:function(groupId,groupName,type,baseGroup){var _this=this;var divContain=$('#dataSrcPanel');var $ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true">');var $liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon open"></span></li>');var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);if(groupName!=_this.m_unassigned){var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true"></span>');EventAdapter.on(btnRemove,'click',function(e){var div=$(e.currentTarget).closest('.nav');WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(_this.m_lang.REMOVE_CONFIRM);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
var groupId=div.attr('id');div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+groupId).done(function(data){if(('successful'==data.error)){var len=_this.m_allGroupList.length;for(var i=0;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1);div.remove();break;}}
_this.calUpdateDataSources();}}).fail(function(e){});});res.modal('show');}).always(function(e){});}).error(function(e){});$liHd.append(btnRemove);}
var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add"></span>');EventAdapter.on(btnAddDs,'click',function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add" /></span>');EventAdapter.on(btnAddFormula,'click',function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_hover.png');img.css('width','23px');img.css('height','20px');}).error(function(e){});btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_normal.png');img.css('width','21px');img.css('height','19px');}).error(function(e){});$liHd.append(btnAddFormula);if(groupName!=_this.m_unassigned){var spanEdit=$('<span class="glyphicon glyphicon-pencil panel-heading-btn grow dsEditGroupName" aria-hidden="true"></span>');EventAdapter.on(spanEdit,'click',function(e){var tar=$(e.currentTarget);var groupName=tar.siblings('.dsGroupName');groupName.hide();var input=tar.siblings('.inputEditGroup');input.val(groupName.text());input.show();input.select();tar.siblings('.btn').show();_this.stopBubble(e);});$liHd.append(spanEdit);var inputEdit=$('<input type="text" value="'+groupName+'" class="inputEditGroup">');inputEdit.hide();EventAdapter.on(inputEdit,'click',function(e){_this.stopBubble(e);});inputEdit.keyup(function(e){if(13==e.keyCode){var tar=$(e.currentTarget);tar.siblings('button').click();}
_this.stopBubble(e);});$liHd.append(inputEdit);var btnEdit=$('<button class="btn btn-default btn-sm" type="submit">Change</button>');btnEdit.hide();EventAdapter.on(btnEdit,'click',function(e){var tar=$(e.currentTarget);tar.hide();var input=tar.siblings('.inputEditGroup');var newName=input.val();input.hide();var groupName=tar.siblings('.dsGroupName');var oldName=groupName.text();groupName.show();if(oldName!=newName&&''!=newName){var postData={'groupId':groupId,'name':newName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if(undefined==data){return;}
if('successful'==data.error){for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList[i].name=data.groupName;break;}}
spanName.text(data.groupName);}}).fail(function(e){});}
_this.stopBubble(e);});$liHd.append(btnEdit);}
EventAdapter.on($liHd,'click',function(e){divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');divContain.find('.dsEditGroupName').css('display','none');var curTarHead=$(e.currentTarget);curTarHead.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarHead.closest('.tree-group').get(0).id;$(this).next('.rows').slideToggle();var icon=$(this).find('.dsTreeHeaderIcon');var imgPath=icon.attr('src');if(icon.hasClass('open')){icon.removeClass('open');curTarHead.find('.dsGroupName').css('font-weight','400');curTarHead.find('.dsTreeBtnFormula').css('display','none');curTarHead.find('.dsTreeBtnAdd').css('display','none');curTarHead.find('.dsTreeBtnDel').css('display','none');curTarHead.find('.dsEditGroupName').css('display','none');}else{icon.addClass('open');curTarHead.find('.dsGroupName').css('font-weight','700');curTarHead.find('.dsTreeBtnFormula').css('display','inline');curTarHead.find('.dsTreeBtnAdd').css('display','inline');curTarHead.find('.dsTreeBtnDel').css('display','inline');curTarHead.find('.dsEditGroupName').css('display','inline');}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow);if(0===type){divContain.append($ul);}else if(1===type){if(''!=baseGroup){baseGroup.after($ul);}}else if(2===type){if(''!=baseGroup){baseGroup.before($ul);}}},insertTreeItem:function(divParentGroup,itemId,iconColor,itemName,insertType,baseItem,bIsPoint){var _this=this;var div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true"> ');var icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css('background-color',iconColor);div.append(icon);var divShowName=$('<span class="showName">'+itemName+'</span>');EventAdapter.on(divShowName,'click',function(e){var oldCustName=$(e.currentTarget).text();var input=$('<input type="text" value="'+oldCustName+'" style="width:300px;position: absolute;top: 4px">');input.blur(function(e){var newCustName=$(e.currentTarget).val();if(oldCustName!=newCustName){var item,type,prjId,ptName,ptDesc,groupId,postData;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){type=item.itemType;prjId=item.prjId;ptName=item.ptName;ptDesc=item.ptDesc;groupId=item.groupId;break;}}
postData={itemList:[]};var eachItem={id:itemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var dstId,dstCustomName;for(var i=0,len=list.length;i<len;i++){dstId=list[i].id;dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break;}}
divShowName.text(dstCustomName);_this.setToolTipsCustomName(divShowName.closest('.treeRow'),dstCustomName);}
_this.calUpdateDataSources();});}
input.remove();divShowName.css('display','inline');});input.keyup(function(e){if(13==e.keyCode){input.blur();}
_this.stopBubble(e);});divShowName.after(input);divShowName.css('display','none');input.select();});div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');EventAdapter.on(btnRemove,'click',function(e){var promise=$.Deferred();var div=$(e.currentTarget).closest('.treeRow');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;if(typeof _this.m_parent.doSync==='function'){_this.m_parent.doSync().done(function(){promise.resolve();});}else{promise.resolve();}
promise.done(function(){WebAPI.get('/analysis/checkDatasourceBeforeDelete/'+dataSrcItemId+'/'+AppConfig.userId).done(function(chkData){var nWorkSpLen=chkData.workspaceInfo.length;var nDashBoLen=chkData.dashboardInfo.length;if(nWorkSpLen>0||nDashBoLen>0){var show=_this.m_lang.REMOVE_CONFIRM_TIPS;var name;for(var i=0;i<nWorkSpLen;i++){if(0==i){show+='workspace: ';}
name=chkData.workspaceInfo[i].modalName;name=Boolean(name)?name:'Untitled';show+=name+',';}
for(var j=0;j<nDashBoLen;j++){if(0==j){show+='dashboard: ';}
show+=chkData.dashboardInfo[j].modalType+',';}
show+=_this.m_lang.REMOVE_CONFIRM;WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(show);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});});res.modal('show');}).always(function(e){});}else{if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});}}).fail(function(e){});});}).error(function(e){});div.append(btnRemove);if(bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on(btnCfg,'click',function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}else{var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on(btnCfg,'click',function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}
EventAdapter.on(div,'click',function(e){var divContain=$('#dataSrcPanel');divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');var curTarItem=$(e.currentTarget);curTarItem.find('.dsTreeBtnCfg').css('display','inline');curTarItem.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarItem.closest('.tree-group').get(0).id;});if(0===insertType){divParentGroup.find('.rows').append(div);}else if(1===insertType){if(''!=baseItem){baseItem.after(div);}}else if(2===insertType){var lyRow=divParentGroup.find('.rows').find('.treeRow');if(0==lyRow.length){divParentGroup.find('.rows').append(div);}else{lyRow.eq(0).before(div);}}},insertTreeAllGroupItem:function(groupList,pointList,searchPointName){var _this=this;var divContain=$('#dataSrcPanel');var groupId,groupName,bIsDefault;for(var i=0,len=groupList.length;i<len;i++){groupId=groupList[i].id;groupName=groupList[i].name;bIsDefault=groupList[i].isDefault;var $ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true" dropable="true" isDefault="'+bIsDefault+'">');var $liHd;if(groupName==this.m_unassigned){$liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon open"></span></li>');}else{$liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon"></span></li>');}
var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);if(groupName!=_this.m_unassigned){var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true" style="display:none"></span>');EventAdapter.on($(btnRemove),'click',function(e){var div=$(e.currentTarget).closest('.nav');WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(_this.m_lang.REMOVE_CONFIRM);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
var groupId=div.attr('id');div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+groupId).done(function(data){if(('successful'==data.error)){var len=_this.m_allGroupList.length;for(var i=0;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1);div.remove();break;}}
_this.calUpdateDataSources();}}).fail(function(e){});});res.modal('show');}).always(function(e){});});$liHd.append(btnRemove);}
var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add" style="display:none"></span>');if(groupName==this.m_unassigned){btnAddDs.css('display','inline');}
EventAdapter.on($(btnAddDs),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add"  style="display:none"/></span>');if(groupName==this.m_unassigned){btnAddFormula.children('img').css('display','inline');}
EventAdapter.on($(btnAddFormula),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_hover.png');img.css('width','23px');img.css('height','20px');}).error(function(e){});btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_normal.png');img.css('width','21px');img.css('height','19px');}).error(function(e){});$liHd.append(btnAddFormula);if(groupName!=_this.m_unassigned){var spanEdit=$('<span class="glyphicon glyphicon-pencil panel-heading-btn grow dsEditGroupName" aria-hidden="true" style="display:none"></span>');EventAdapter.on($(spanEdit),'click',function(e){var tar=$(e.currentTarget);var groupName=tar.siblings('.dsGroupName');groupName.hide();var input=tar.siblings('.inputEditGroup');input.val(groupName.text());input.show();input.select();tar.siblings('.btn').show();_this.stopBubble(e);});$liHd.append(spanEdit);var inputEdit=$('<input type="text" value="'+groupName+'" class="inputEditGroup">');inputEdit.hide();EventAdapter.on($(inputEdit),'click',function(e){_this.stopBubble(e);});inputEdit.keyup(function(e){if(13==e.keyCode){var tar=$(e.currentTarget);tar.siblings('button').click();}
_this.stopBubble(e);});$liHd.append(inputEdit);var btnEdit=$('<button class="btn btn-primary btn-sm" type="submit">Change</button>');btnEdit.hide();EventAdapter.on($(btnEdit),'click',function(e){var tar=$(e.currentTarget);tar.hide();var input=tar.siblings('.inputEditGroup');var newName=input.val();input.hide();var groupName=tar.siblings('.dsGroupName');var oldName=groupName.text();groupName.show();if(oldName!=newName&&''!=newName){var ulNav=tar.closest('.nav');var groupId=ulNav.attr('id');var postData={'groupId':groupId,'name':newName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if(undefined==data){return;}
if('successful'==data.error){for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList[i].name=data.groupName;break;}}
var spanName=ulNav.find('.dsGroupName');if(Boolean(spanName)){spanName.text(data.groupName);}}}).fail(function(e){});}
_this.stopBubble(e);});$liHd.append(btnEdit);}
EventAdapter.on($($liHd),'click',function(e){divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');divContain.find('.dsEditGroupName').css('display','none');var curTarHead=$(e.currentTarget);curTarHead.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarHead.closest('.tree-group').get(0).id;$(this).next('.rows').slideToggle();var icon=$(this).find('.dsTreeHeaderIcon');if(icon.hasClass('open')){icon.removeClass('open');curTarHead.find('.dsGroupName').removeClass('selected');curTarHead.find('.dsTreeBtnFormula').css('display','none');curTarHead.find('.dsTreeBtnAdd').css('display','none');curTarHead.find('.dsTreeBtnDel').css('display','none');curTarHead.find('.dsEditGroupName').css('display','none');}else{icon.addClass('open');curTarHead.find('.dsGroupName').addClass('selected');curTarHead.find('.dsTreeBtnFormula').css('display','inline-block');curTarHead.find('.dsTreeBtnAdd').css('display','inline');curTarHead.find('.dsTreeBtnDel').css('display','inline');curTarHead.find('.dsEditGroupName').css('display','inline');}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');if(groupName==_this.m_unassigned){divLiRow.css('display','block');}else{divLiRow.css('display','none');}
$ul.append(divLiRow);var itemId,iconColor,itemName,itemPtName;var bHasSearched=false;for(var j=0,len2=pointList.length;j<len2;j++){if(groupId==pointList[j].groupId){itemId=pointList[j].itemId;iconColor=pointList[j].iconColor;itemName=pointList[j].customName;itemPtName=pointList[j].ptName;if(''!=searchPointName){var custNameLower=itemName.toLowerCase();var ptNameLower=itemPtName.toLowerCase();if(-1==custNameLower.indexOf(searchPointName)&&-1==ptNameLower.indexOf(searchPointName)){continue;}else{bHasSearched=true;}}
var div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true" dropable="true"> ');var icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css('background-color',iconColor);div.append(icon);var divShowName=$('<span class="showName">'+itemName+'</span>');EventAdapter.on($(divShowName),'click',function(e){var divCurShowName=$(e.currentTarget);var oldCustName=divCurShowName.text();var selItemId=divCurShowName.closest('.treeRow').attr('id');var input=$('<input type="text" value="'+oldCustName+'" style="width:300px;position: absolute;top: 4px;background-color:#465b85">');input.blur(function(e){var $tar=$(e.currentTarget);var newCustName=$tar.val();if(''==newCustName){$tar.select();alert(I18n.resource.dataSource.CUSTOM_NOT_NULL);return;}
if(oldCustName!=newCustName){var item,type,prjId,ptName,ptDesc,groupId,postData;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(selItemId==item.itemId){type=item.itemType;prjId=item.prjId;ptName=item.ptName;ptDesc=item.ptDesc;groupId=item.groupId;break;}}
postData={itemList:[]};var eachItem={id:selItemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(data){if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var dstId,dstCustomName;for(var i=0,len=list.length;i<len;i++){dstId=list[i].id;dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break;}}
divCurShowName.text(dstCustomName);_this.setToolTipsCustomName(divCurShowName.closest('.treeRow'),dstCustomName);}
_this.calUpdateDataSources();});}
input.remove();divCurShowName.css('display','inline');});input.keyup(function(e){if(13==e.keyCode){input.blur();}
_this.stopBubble(e);});divCurShowName.after(input);divCurShowName.css('display','none');input.select();});div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');EventAdapter.on($(btnRemove),'click',function(e){var promise=$.Deferred();var div=$(e.currentTarget).closest('.treeRow');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;if(typeof _this.m_parent.doSync==='function'){_this.m_parent.doSync().done(function(){promise.resolve();});}else{promise.resolve();}
Spinner.spin(div[0]);promise.done(function(){WebAPI.get('/analysis/checkDatasourceBeforeDelete/'+dataSrcItemId+'/'+AppConfig.userId).done(function(chkData){var nWorkSpLen=chkData.workspaceInfo.length;var nDashBoLen=chkData.dashboardInfo.length;if(nWorkSpLen>0||nDashBoLen>0){var show=_this.m_lang.REMOVE_CONFIRM_TIPS;var name;for(var i=0;i<nWorkSpLen;i++){if(0==i){show+='workspace: ';}
name=chkData.workspaceInfo[i].modalName;name=Boolean(name)?name:'Untitled';show+=name+',';}
for(var j=0;j<nDashBoLen;j++){if(0==j){show+='dashboard: ';}
show+=chkData.dashboardInfo[j].modalType+',';}
show+=_this.m_lang.REMOVE_CONFIRM;WebAPI.get('/static/views/observer/widgets/modalFrame.html').done(function(result){var res=$(result);res.find('#modalFrmBody').text(show);var btnSure=res.find('#btnSure');btnSure.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});});res.modal('show');}).always(function(e){});}else{div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(data){if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});}}).fail(function(e){}).always(function(e){Spinner.stop();});});});div.append(btnRemove);var bIsPoint=(0==pointList[j].itemType)?true:false;if(bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on($(btnCfg),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}else{var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on($(btnCfg),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}
EventAdapter.on($(div),'click',function(e){var divContain=$('#dataSrcPanel');divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');var curTarItem=$(e.currentTarget);curTarItem.find('.dsTreeBtnCfg').css('display','inline');curTarItem.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarItem.closest('.tree-group').get(0).id;});$ul.find('.rows').append(div);if(bIsPoint){var prjName=_this.getProjectNameFromId(pointList[j].prjId,_this.m_langFlag);_this.initToolTips(div,pointList[j].customName,prjName,pointList[j].ptName,pointList[j].ptDesc);}else{var showName=_this.getShowNameFromFormula(pointList[j].ptName);_this.initFormulaToolTips(div,pointList[j].customName,showName,pointList[j].ptDesc);}}}
if(''==searchPointName){divContain.append($ul);}else{if(bHasSearched){divContain.append($ul);}}}},getDSItemById:function(datasourceItemId){var _this=this;var ret=[];var postData=[];var bIsArray=Object.prototype.toString.call(datasourceItemId)==='[object Array]';if(!bIsArray){if(this.m_parent.store.dsInfoList){var itemInfo;for(var i=0,len=this.m_parent.store.dsInfoList.length;i<len;i++){itemInfo=this.m_parent.store.dsInfoList[i];if(datasourceItemId==itemInfo.id){return itemInfo;}}}
for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){var item=_this.m_arrCloudTableInfo[i];if(datasourceItemId==item._id){return{id:item._id,groupId:'',alias:item.alias,projId:item.projId,type:0,value:item.value}}}}else{var copyArr=datasourceItemId.slice();if(this.m_parent.store.dsInfoList){var itemInfo;for(var j=0;j<datasourceItemId.length;j++){for(var i=0,len=this.m_parent.store.dsInfoList.length;i<len;i++){itemInfo=this.m_parent.store.dsInfoList[i];if(datasourceItemId[j]==itemInfo.id){ret.push(itemInfo);break;}}}
if(ret.length>0){return ret;}}
for(var j=0;j<datasourceItemId.length;j++){for(var i=0,len=_this.m_arrCloudTableInfo.length;i<len;i++){var item=_this.m_arrCloudTableInfo[i];if(datasourceItemId[j]==item._id){var index=copyArr.indexOf(item._id);if(index>-1){copyArr.splice(index,1)}
ret.push({id:item._id,groupId:'',alias:!!(item.alias)?item.alias:item.value,projId:item.projId,type:0,value:item.value});}}}
if(ret.length==datasourceItemId.length){return ret;}else{datasourceItemId=copyArr;}}
if(!bIsArray){postData.push(datasourceItemId);}else{postData=datasourceItemId;}
var dsRet=$.ajax({type:'POST',url:'/analysis/datasource/getDsItemsById',data:JSON.stringify(postData),contentType:'application/json',async:false}).responseText;if(dsRet){var temp=JSON.parse(dsRet);if(!bIsArray){ret=temp[0];if(!ret){ret={alias:undefined,groupId:undefined,id:undefined,note:undefined,projId:undefined,type:undefined,value:undefined}}}else{if(temp instanceof Array){temp.map(function(i){if(!i.alias){i.alias=i.value}});}
ret=ret.concat(temp);}
return ret;}
return{};},getDSItemData:function(target,arrDSItemIds){var _this=this.m_parent;var timeConfig;if(_this.curModal.timeRecent){timeConfig=generateTimeOption(_this.curModal)}else{timeConfig=_this.curModal;}
var tmStart=timeConfig.startTime.toDate();var tmEnd=timeConfig.endTime.toDate();var tmFmt=timeConfig.format;var key;var preloadIds=[];var row=null,arrId;var ids=arrDSItemIds.concat();var postData={dsItemIds:ids,timeStart:tmStart.format('yyyy-MM-dd HH:mm:ss'),timeEnd:tmEnd.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt};var promise=$.Deferred();Beop.cache.ds.getBatch(ids,tmFmt,tmStart,tmEnd).done(function(rs){promise.resolve(rs);}).fail(function(e){console.warn(e);promise.reject();});promise.always(function(rs){var idsNotFound,cacheData;if(rs){idsNotFound=rs.idsNotFound;cacheData=rs.data;if(idsNotFound.length>0){postData.dsItemIds=idsNotFound;}else{target.spinnerStop();target.renderModal(cacheData);return;}}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(data){if(data.error&&data.error.length>0){target.errAlert(data.error);target.spinnerStop();return;}
Beop.cache.ds.set(data,tmFmt,tmStart,tmEnd).done(function(){if(cacheData&&cacheData!==null){data={list:data.list.concat(cacheData.list),timeShaft:(data.timeShaft.length>0)?data.timeShaft:cacheData.timeShaft};}}).fail(function(e){console.warn(e);}).always(function(){target.renderModal(data);});}).error(function(e){_this.paneCenter.spinnerStop();_this.alertNoData();});});},getDSItemDataMulti:function(target,arrDSItemIds){var _this=this.m_parent;_this.curModal.arrComparePeriodLabel=[];var tmStart=_this.curModal.startTime;tmStart=tmStart.length<=10?tmStart+' 00:00:00':tmStart;var tmEnd=_this.curModal.endTime;tmEnd=tmEnd.length<=10?tmEnd+' 00:00:00':tmEnd;var tmFmt=_this.curModal.format;var comparePeriod=_this.curModal.comparePeriod;var period1,period2,time;var startDate=new Date(tmStart);var endDate=new Date(tmEnd);var compareDateI18n=I18n.resource.analysis.historyCompare;if(comparePeriod=='hour'){time=3600000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1)+'-'+startDate.getDate()+' '+startDate.getHours()+':00');_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1)+'-'+endDate.getDate()+' '+endDate.getHours()+':00');}
if(comparePeriod=='day'){time=86400000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1)+'-'+startDate.getDate());_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1)+'-'+endDate.getDate());}
if(comparePeriod=='week'){time=604800000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(compareDateI18n.YEAR_WEEK.replace('<%year%>',startDate.getFullYear()).replace('<%week%>',getWeekNumber(tmStart)));_this.curModal.arrComparePeriodLabel.push(compareDateI18n.YEAR_WEEK.replace('<%year%>',endDate.getFullYear()).replace('<%week%>',getWeekNumber(tmEnd)));}
if(comparePeriod=='month'){period1=getCurrentMonthLastDay(tmStart);period2=getCurrentMonthLastDay(tmEnd);function getCurrentMonthLastDay(date){var current=date.toDate();var currentMonth=current.getMonth();var nextMonth=++currentMonth;var nextMonthDayOne=new Date(current.getFullYear(),nextMonth,1);return new Date(nextMonthDayOne.getTime());}
_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1));_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1));}
var postData=[{dsItemIds:arrDSItemIds,timeStart:tmStart.format('yyyy-MM-dd HH:mm:ss'),timeEnd:period1.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt},{dsItemIds:arrDSItemIds,timeStart:tmEnd.format('yyyy-MM-dd HH:mm:ss'),timeEnd:period2.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt}];WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(data){if(data.error&&data.error.length>0){target.errAlert(data.error);target.spinnerStop();return;}
target.renderModal(data);}).error(function(e){_this.paneCenter.spinnerStop();_this.alertNoData();});function isLeapYear(year){return(year%400==0)||(year%4==0&&year%100!=0);}
function getMonthDays(year,month){return[31,null,31,30,31,30,31,31,30,31,30,31][month]||(isLeapYear(year)?29:28);}
function getWeekNumber(date){var now=date.toDate(),year=now.getFullYear(),month=now.getMonth(),days=now.getDate();for(var i=0;i<month;i++){days+=getMonthDays(year,i);}
var yearFirstDay=new Date(year,0,1).getDay()||7;var week=null;if(yearFirstDay==1){week=Math.ceil(days/yearFirstDay);}else{days-=(7-yearFirstDay+1);week=Math.ceil(days/7)+1;}
return week;}},getShowNameFromFormula:function(formula){var _this=this;var inputStr=formula;var nStart=inputStr.indexOf('<%');var nEnd=inputStr.indexOf('%>');if(-1==nStart||-1==nEnd){return inputStr;}
var id=inputStr.substring(nStart+2,nEnd);if(''==id){return _this.getShowNameFromFormula(inputStr);}
var retVal=_this.getDSItemById(id);if(null==retVal){return _this.getShowNameFromFormula(inputStr);}
inputStr=inputStr.replace('<%'+id+'%>',retVal.value);return _this.getShowNameFromFormula(inputStr);},addNewGroup:function(){var groupName=$('#inputAddGroup').val();if(''==groupName){return;}
var _this=this;var postData={'groupId':'','name':groupName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(data){if('successful'!=data.error){return;}
var groupId=data.groupId;if(groupId){if(_this.treeObj){var nodeUnassigned=_this.treeObj.getNodesByParam('name','unassigned',null);var index=-1;if(nodeUnassigned.length>0){index=_this.treeObj.getNodeIndex(nodeUnassigned[0]);}
_this.treeObj.addNodes(null,index,{id:data.groupId,pId:data.parentId,name:data.groupName,isParent:true});}}
$('#inputAddGroup').val('');$('#inputAddGroup').blur();}).fail(function(result){}).always(function(e){});}}
return DataSource;})();var SharpViewScreen=(function($,window,undefined){var _this=null;var showMode={TILE:'Tile',LINEAR:'Linear'};var layoutClasses={'Tile':TileLayout,'Linear':LinearLayout};function SharpViewScreen(sliders,store){_this=this;this.options=SharpViewScreen.DEFAULTS;this.cur=null;this.total=sliders.length;this.sliderList=sliders;this.slidersStatus={};this.layoutHandler=null;this.store=store;this.factoryIoC=new FactoryIoC('analysis');this.curModal=null;this.datasource=new DataSource(this);this.dataSourceConflict=AppConfig.datasource;AppConfig.datasource=this.datasource;this.saveModalJudge=$.Deferred();this.$stage=null;this.$sliders=null;}
SharpViewScreen.prototype={constructor:SharpViewScreen,show:function(){WebAPI.get('/static/views/observer/sharpViewScreen.html').done(function(resultHtml){$('<div class="sharpview-wrap sharpview" id="sharpViewWrap">').appendTo('body').html(resultHtml);_this.init();});},init:function(){var arrHtml=[];this.$stage=$('#sharpViewStage');for(var i=0,len=this.sliderList.length;i<len;i++){arrHtml.push(this.options.itemTmpl.format(i));}
this.$stage.html(arrHtml.join(''));this.$sliders=this.$stage.children('*');this.layout(showMode.LINEAR);},onresize:function(){if(ScreenCurrent.paneCenter&&ScreenCurrent.paneCenter.chart){ScreenCurrent.paneCenter.chart.resize();}},layout:function(mode){var _this=this;var options={};mode=mode||showMode.TILE;if(this.layoutHandler)this.layoutHandler.destroy();switch(mode){case showMode.TILE:break;case showMode.LINEAR:options.onFlipStart=function(e){var pos=e.pos;if(pos===_this.cur)return;};options.onFlipEnd=function(e){var pos=e.pos;_this.cur=pos;_this.renderSlider();};break;}
this.layoutHandler=new layoutClasses[mode](this.$stage,this.$sliders,options);this.layoutHandler.layout();},renderSlider:function(container){this.renderModal(this.cur);this.renderModal(Math.min(this.total-1,Math.max(this.cur-1,0)));this.renderModal(Math.min(this.total-1,Math.max(this.cur+1,0)));},renderModal:function(index){var container=this.$sliders.eq(index).children('div')[0];var modal=this.sliderList[index];var modalId=modal.id;this.curModal=modal.option;if(this.slidersStatus[modalId]==='loaded')return;if(this.curModal.type){var modalClass=this.factoryIoC.getModel(this.curModal.type);this.slidersStatus[modalId]='loaded';new modalClass(container,this.curModal,this).show();}else{this.alertNoData();}},updateModal:function(){},showConfigMode:function(){},setModalOption:function(){},spinnerStop:function(){},saveModal:function(){},alertNoData:function(){},destroy:function(){$('#sharpViewWrap').remove();this.layoutHandler.destroy();AppConfig.datasource=this.dataSourceConflict;}}
SharpViewScreen.DEFAULTS={itemTmpl:'<div class="play-slider-ctn" data-index="{0}"><div style="padding: 20px;z-index: 100;position: absolute;left:0;top:0;right:0;bottom:0;overflow-x: hidden;overflow-y: auto;">This page has no data.</div></div>'};function Layout($stage,$sliders){this.$stage=$stage;this.$sliders=$sliders;this.curPos=null;this.total=null;}
Layout.prototype={constructor:Layout,layout:function(){this.total=this.$sliders.length;this._layout.apply(this,arguments);},destroy:function(){this._destroy();}}
function TileLayout($stage,$sliders){Layout.apply(this,arguments);this.name='Tile';}
TileLayout.prototype=Object.create(Layout.prototype);TileLayout.prototype.constructor=TileLayout;TileLayout.prototype._layout=function(){var per;for(var i=0;i<this.total;i++){per=(i-1)*105;this.$sliders.eq(i).css({'transform':'translateZ(-2500px) translate('+per+'%, 0%)'});}};function LinearLayout($stage,$sliders,options){Layout.apply(this,arguments);this.options=$.extend({},LinearLayout.DEFAULTS,options);this.name='linear';}
LinearLayout.prototype=Object.create(Layout.prototype);LinearLayout.prototype.constructor=LinearLayout;LinearLayout.prototype._layout=function(startPos){var per;this.$stage.addClass(this.options.animateCls);this.attachEvents();this.to(startPos||0);};LinearLayout.prototype.to=function(pos){var _this=this;var direction=pos<this.curPos?'left':'right';var pos=pos===undefined?0:Math.min(Math.max(pos,0),this.total-1);if(pos===this.curPos){this.doBoundAnimation(direction);return;}
this.curPos=pos;typeof _this.options.onFlipStart==='function'&&_this.options.onFlipStart({pos:pos});this.$sliders.each(function(i){if(i<pos)$(this).removeClass().addClass('past');if(i>pos)$(this).removeClass().addClass('future');});window.setTimeout((function(pos){return function(){_this.$sliders.eq(pos).removeClass().addClass('present');}}(pos)),50);this.$sliders.off().on('transitionend',function(e){e=e.originalEvent;if(e.target.className!=='present')return;if(e.propertyName==='transform'){typeof _this.options.onFlipEnd==='function'&&_this.options.onFlipEnd({pos:pos});}});};LinearLayout.prototype.prev=function(){this.to(this.curPos-1);};LinearLayout.prototype.next=function(){this.to(this.curPos+1);};LinearLayout.prototype.doBoundAnimation=function(direction){direction=direction||'left';$slider=this.$sliders.eq(this.curPos);if(direction==='left'){$slider.addClass('bound-left');}else{$slider.addClass('bound-right');}
if(this.curPos===0);else $slider.addClass('bound-right');};LinearLayout.prototype.attachEvents=function(){var _this=this;$(window).on('keydown.sharpview',function(e){switch(e.keyCode){case 37:_this.prev();break;case 38:break;case 39:_this.next();break;case 40:break;}});$(window).on('keyup.sharpview',function(e){switch(e.keyCode){case 37:_this.$sliders.eq(_this.curPos).removeClass('bound-left');break;case 38:break;case 39:_this.$sliders.eq(_this.curPos).removeClass('bound-right');break;case 40:break;}});};LinearLayout.prototype.detachEvents=function(){$(window).off('keydown.sharpview');$(window).off('keyup.sharpview');};LinearLayout.prototype._destroy=function(){this.detachEvents();};LinearLayout.DEFAULTS={animateCls:'linear-1'};var Parallex={step:1000,rateBg1:1,rateBg2:0.5,rateBg3:0.2,direction:1,flowLeft:function(){this.direction=-1;this.flow();},flowRight:function(){this.direction=1;this.flow();},flow:function(){var posBg1=parseFloat(this.$bg1.css('background-position-x'));var posBg2=parseFloat(this.$bg2.css('background-position-x'));var posBg3=parseFloat(this.$bg3.css('background-position-x'));this.changeTransition('.5s','cubic-bezier(0.26,.86,.44,.985)');if(this.direction>0){this.$bg1.css('background-position-x',(posBg1+this.step*this.rateBg1)+'px');this.$bg2.css('background-position-x',(posBg2+this.step*this.rateBg2)+'px');this.$bg3.css('background-position-x',(posBg3+this.step*this.rateBg3)+'px');}
else{this.$bg1.css('background-position-x',(posBg1-this.step*this.rateBg1)+'px');this.$bg2.css('background-position-x',(posBg2-this.step*this.rateBg2)+'px');this.$bg3.css('background-position-x',(posBg3-this.step*this.rateBg3)+'px');}},changeTransition:function(duration,TimingFn){this.$bg1.css({'transition-duration':duration,'transition-timing-function':TimingFn});this.$bg2.css({'transition-duration':duration,'transition-timing-function':TimingFn});this.$bg3.css({'transition-duration':duration,'transition-timing-function':TimingFn});},init:function(){var _this=this;this.$bg1=$('#bg1');this.$bg2=$('#bg2');this.$bg3=$('#bg3');this.$bg1.off().on('transitionend',function(e){var distance=1500;var posBg1=parseFloat(_this.$bg1.css('background-position-x'));var posBg2=parseFloat(_this.$bg2.css('background-position-x'));var posBg3=parseFloat(_this.$bg3.css('background-position-x'));e=e.originalEvent;_this.changeTransition('30s','linear');if(e.propertyName==='background-position-x'){if(_this.direction>0){_this.$bg1.css('background-position-x',(posBg1+distance*_this.rateBg1)+'px');_this.$bg2.css('background-position-x',(posBg2+distance*_this.rateBg2)+'px');_this.$bg3.css('background-position-x',(posBg3+distance*_this.rateBg3)+'px');}else{_this.$bg1.css('background-position-x',(posBg1-distance*_this.rateBg1)+'px');_this.$bg2.css('background-position-x',(posBg2-distance*_this.rateBg2)+'px');_this.$bg3.css('background-position-x',(posBg3-distance*_this.rateBg3)+'px');}}});}}
return SharpViewScreen;}(jQuery,window));﻿
var DrawGraph=(function(){var _this;function DrawGraph(screenPre,graph,container,color){_this=this;this.container=container;this.color=color;this.screenPre=screenPre;this.graph=graph;this.svgW=undefined;this.svgH=undefined;}
DrawGraph.prototype={show:function(){},render:function(){},createBoard:function(){var $svgGraph=$('.svgGraph');var $boxWOrH;if($svgGraph.length===0){$svgGraph=$('<svg class="svgGraph" style="position:absolute;z-index:149;">\
                        <defs><marker id="arrowHead" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="red"/></marker>\
                        </defs>\
                        <path id="arrow-line" marker-end="url(#arrowHead)" stroke-width="4" fill="none" stroke="red" d=""/>\
                        <ellipse style="fill:rgba(0,0,0,0);stroke-width:2px;" orient="auto" class="circle" orient="auto"/>\
                        <rect style="fill:rgba(0,0,0,0);stroke-width:2px;" class="rect" orient="auto"/>\
                        </svg>');_this.$svgBox.append($svgGraph);}
if(_this.screenPre.curModal.type==='AnlzTendency'){$boxWOrH=$('#anlsPaneContain .panel-body .containerChi');}else{$boxWOrH=$('#anlsPaneContain .panel-body');}
this.svgW=$boxWOrH.width();this.svgH=$boxWOrH.height();$svgGraph[0].setAttribute("viewBox","0 0 "+this.svgW+" "+this.svgH);$svgGraph[0].setAttribute("width",this.svgW);$svgGraph[0].setAttribute("height",this.svgH);return $svgGraph;},deleteGraph:function(){if($('.deleteGraph').length===0){return;}
$('.deleteGraph').hover(function(e){$(this).css('cursor','pointer');},function(){$(this).css('cursor','');});$('.deleteGraph').off('click').click(function(){$(this).parent('.svgCopyBox').remove();var index=_this.getGraphListIndex($(this).parent('.svgCopyBox').children('.svgGraphCopy').attr('id'));if(index!=undefined){_this.screenPre.curModal.graphList.splice(index,1);_this.screenPre.saveModal();_this.screenPre.saveModalJudge.resolveWith(_this.screenPre,[_this.screenPre,1,_this.chart,$('#divWSPane .selected'),_this.screenPre.curModal,false]);}});},graphHover:function($svgCopyBox){$svgCopyBox.hover(function(){_this.deleteGraph();$(this).children('.deleteGraph').show();$(this).css({'cursor':'move'}).addClass('svgCopyBoxTem');},function(){$(this).removeClass('svgCopyBoxTem');$(this).children('.deleteGraph').hide();$(this).css('border','none');});},graphDrag:function(graphDraw){var $target=$('#'+graphDraw.id);if($target.length===0){return;}
var svgGraphCopy=$target[0];var disX=0,disY=0;svgGraphCopy.onmousedown=function(e){var svgCopyBox=svgGraphCopy.parentNode;var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=e.clientX+scrollLeft-svgCopyBox.offsetLeft;disY=e.clientY+scrollTop-svgCopyBox.offsetTop;this.onmousemove=function(e){var ol=e.clientX+scrollLeft;var ot=e.clientY+scrollTop;var l=ol-disX;var t=ot-disY;svgCopyBox.style.left=l+"px";svgCopyBox.style.top=t+"px";var isTop=svgCopyBox.offsetTop<0;var isLeft=svgCopyBox.offsetLeft<0;var isRight=svgCopyBox.offsetParent.offsetWidth-svgCopyBox.offsetLeft<svgCopyBox.offsetWidth;var isBottom=svgCopyBox.offsetParent.offsetHeight-svgCopyBox.offsetTop<svgCopyBox.offsetHeight;if(isTop){svgCopyBox.style.top='0px';}
if(isLeft){svgCopyBox.style.left='0px';}
if(isRight){svgCopyBox.style.left=svgCopyBox.parentNode.offsetWidth-svgCopyBox.offsetWidth+'px';}
if(isBottom){svgCopyBox.style.top=svgCopyBox.parentNode.offsetHeight-svgCopyBox.offsetHeight+'px';}}
this.onmouseup=function(e){this.onmousemove=null;this.onmouseup=null;var graph={id:graphDraw.id,downX:svgCopyBox.offsetLeft/_this.$svgBox.width(),downY:svgCopyBox.offsetTop/_this.$svgBox.height(),upX:svgCopyBox.offsetLeft/_this.$svgBox.width()+graphDraw.upX-graphDraw.downX,upY:svgCopyBox.offsetTop/_this.$svgBox.height()+graphDraw.upY-graphDraw.downY}
_this.saveGraph(graph);}}},getGraphListIndex:function(id){for(var i=0;i<_this.screenPre.curModal.graphList.length;i++){if(_this.screenPre.curModal.graphList[i].id==id){return i;}}},saveGraph:function(graph){var isSave=false;var index=_this.getGraphListIndex(graph.id);if(index==undefined){_this.screenPre.curModal.graphList.push(graph);doSave();}else{var graph_old=_this.screenPre.curModal.graphList[index];if(graph.downX&&graph.downX!=graph_old.downX){isSave=true}
if(!isSave&&graph.downY&&graph.downY!=graph_old.downY){isSave=true}
if(!isSave&&graph.upX&&graph.upX!=graph_old.upX){isSave=true}
if(!isSave&&graph.upY&&graph.upY!=graph_old.upY){isSave=true}
if(isSave){_this.screenPre.curModal.graphList[index].downX=graph.downX;_this.screenPre.curModal.graphList[index].downY=graph.downY;_this.screenPre.curModal.graphList[index].upX=graph.upX;_this.screenPre.curModal.graphList[index].upY=graph.upY;doSave();}}
function doSave(){_this.screenPre.saveModal();_this.screenPre.saveModalJudge.resolveWith(_this.screenPre,[_this.screenPre,1,_this.chart,$('#divWSPane .selected'),_this.screenPre.curModal,false]);}}}
return DrawGraph;})();var DrawArrow=(function(){var _this;function DrawArrow(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.screenPre=screenPre;this.graph=graph;this.container=container;if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
this.$svgBox=$(this.container).find('.svgBox');this.$parentContainer=$(this.container);if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=null;this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
_this=this;}
DrawArrow.prototype=new DrawGraph();DrawArrow.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawArrow.prototype.showArrow=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;var xDiffer=Math.abs(upX-downX);var yDiffer=Math.abs(upY-downY);if(xDiffer<20){xDiffer=20}
if(yDiffer<20){yDiffer=20}
if(upX>=downX&&upY<downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgBoxW)+'%;top:'+(upY*100/svgBoxH-0.6)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy"  id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line2" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M0 , '+yDiffer+'L'+Math.abs(upX-downX-8)+',8"/>'+'</svg>');}
else if(upX>downX&&upY>=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgBoxW)+'%;top:'+(downY*100/svgBoxH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M0 ,0 '+'L'+Math.abs(upX-downX-8)+','+Math.abs(upY-downY-8)+'"/>'+'</svg>');}
else if(upX<=downX&&upY<=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(upX*100/svgBoxW)+'%;top:'+((upY)*100/svgBoxH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" id="new Date().getTime()" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow">'+'<defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M '+xDiffer+','+yDiffer+'L8,8"/>'+'</svg>');}
else if(upX<downX&&upY>=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(upX*100/svgBoxW)+'%;top:'+(downY*100/svgBoxH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" type="arrow" >\
                            <defs><marker id="marker_'+graphDraw.id+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+graphDraw.color+'"/></marker></defs>\
                            <path class="arrow-line1" marker-end="url(#marker_'+graphDraw.id+')" stroke-width="4" stroke="'+graphDraw.color+'" d="M'+xDiffer+' ,0 '+' L8,'+Math.abs(upY-downY-8)+'"/>\
                            </svg>');}
$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawArrow.prototype.render=function(graph){var $box_arrow=_this.showArrow(graph);this.$svgBox.append($box_arrow);};DrawArrow.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function rotate(angle){var arrowLine=$('#arrow-line')[0];arrowLine.setAttribute("transform","rotate("+angle+")");}
function lineTo(start,end){var arrowLine=$('#arrow-line')[0];var arrowHeadP=$('#arrowHead path')[0];arrowLine.setAttribute('d','M'+start.join(',')+' L'+end.join(','));arrowLine.setAttribute("stroke",_this.color);arrowHeadP.setAttribute('fill',_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;lineTo([downX,downY],[curX,curY]);}
$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return;}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'arrow',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()};$svgCopyBox=_this.showArrow(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);$('.svgGraph').remove();_this.saveGraph(graphDraw);$('#graphBox').hide();$('.graphActive').click();$('.svgGraph').remove();}}};return DrawArrow;})();var DrawCircle=(function(){var _this;function DrawCircle(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.graph=graph;this.container=container;this.screenPre=screenPre;this.$svgBox=$(this.container).find('.svgBox');;this.$parentContainer=$(this.container).parent();if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
_this=this;}
DrawCircle.prototype=new DrawGraph();DrawCircle.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawCircle.prototype.showCircle=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(Math.abs(upX-downX)+8)+'px;height:'+(Math.abs(upY-downY)+8)+'px;position:absolute;left:'+(downX*100/svgBoxW)+'%;top:'+(downY*100/svgBoxH)+'%;z-index:149;padding:2px;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+Math.abs(upX-downX)+' '+Math.abs(upY-downY)+'" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'" type="circle">'+'<ellipse style="fill:rgba(0,0,0,0);stroke-width:3px;stroke:'+graphDraw.color+'" orient="auto" cx="'+Math.abs(upX-downX)/2+'" cy="'+Math.abs(upY-downY)/2+'" rx="'+Math.abs(upX-downX-4)/2+'" ry="'+Math.abs(upY-downY-4)/2+'" x="0" y="0"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawCircle.prototype.render=function(graph){var $box_cicle=_this.showCircle(graph);this.$svgBox.append($box_cicle);};DrawCircle.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function circleTo(start,end){var circle=$('.circle')[0];circle.setAttribute("cx",start[0]+Math.abs(end[0]-start[0])/2);circle.setAttribute("cy",start[1]+Math.abs(end[1]-start[1])/2);circle.setAttribute("rx",Math.abs(end[0]-start[0])/2);circle.setAttribute("ry",Math.abs(end[1]-start[1])/2);circle.setAttribute("stroke",_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;circleTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'circle',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()}
$svgCopyBox=_this.showCircle(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);_this.saveGraph(graphDraw);$('#graphBox').hide();$('.svgGraph').remove();}}};return DrawCircle;})();var DrawRect=(function(){var _this;function DrawRect(screenPre,graph,container,color){DrawGraph.call(this,screenPre,graph,container,color);this.graph=graph;this.container=container;this.screenPre=screenPre;this.$svgBox=$(this.container).find('.svgBox');;this.$parentContainer=$(this.container).parent();if(!this.$svgBox||$('.svgBox').length===0||$(this.container).find('.svgBox').length===0){this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);}
if(!this.color||this.color==''){this.color='red';}else{this.color=color;}
_this=this;}
DrawRect.prototype=new DrawGraph();DrawRect.prototype.show=function(){this.render(this.graph);_this.graphHover($('#'+this.graph.id).parent('.svgCopyBox'));_this.graphDrag(this.graph);};DrawRect.prototype.showRect=function(graphDraw){var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');var svgBoxW=_this.$svgBox.width();var svgBoxH=_this.$svgBox.height();var downX=graphDraw.downX*svgBoxW;var downY=graphDraw.downY*svgBoxH;var upX=graphDraw.upX*svgBoxW;var upY=graphDraw.upY*svgBoxH;$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(Math.abs(upX-downX)+8)+'px;height:'+(Math.abs(upY-downY)+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgBoxW)+'%;top:'+(downY*100/svgBoxH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph deleteGraphTem"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+graphDraw.id+'" viewBox="0 0 '+Math.abs(upX-downX)+' '+Math.abs(upY-downY)+'" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'" type="rect">'+'<rect style="fill:rgba(0,0,0,0);stroke-width:4px;stroke:'+graphDraw.color+'" orient="auto" width="'+Math.abs(upX-downX)+'" height="'+Math.abs(upY-downY)+'"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);return $svgCopyBox;};DrawRect.prototype.render=function(graph){var $box_rect=_this.showRect(graph);this.$svgBox.append($box_rect);};DrawRect.prototype.drawing=function(){var $svgGraph=this.createBoard();var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox');function rectTo(start,end){var rect=$('.rect')[0];rect.setAttribute('width',Math.abs(end[0]-start[0]));rect.setAttribute('height',Math.abs(end[1]-start[1]));rect.setAttribute('x',start[0]);rect.setAttribute('y',start[1]);rect.setAttribute('stroke',_this.color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;rectTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();var graphDraw={chartName:_this.screenPre.curModal.type,type:'rect',color:_this.color,id:newGraphId,downX:downX/_this.$svgBox.width(),downY:downY/_this.$svgBox.height(),upX:e.offsetX/_this.$svgBox.width(),upY:e.offsetY/_this.$svgBox.height()};$svgCopyBox=_this.showRect(graphDraw);_this.$svgBox.append($svgCopyBox);_this.graphHover($('#'+newGraphId).parent('.svgCopyBox'));_this.graphDrag(graphDraw);_this.saveGraph(graphDraw);$('#graphBox').hide();$('.svgGraph').remove();}}};return DrawRect;})();var AnlzBase=(function(){var _this;function AnlzBase(container,option,screen){_this=this;this.container=container;this.options=option;this.screen=screen;this.paneChart=undefined;this.paneNotes=undefined;this.chart=undefined;this.noteCount=0;this.chartAnimationDuration=500;this.spinnerRender=new LoadingSpinner({color:'#00FFFF'});this.noteDefaultWidth=440;this.noteDefaultHeight=220;this.dockArea=[];this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;}
AnlzBase.prototype={show:function(){this.initTools();this.container.innerHTML='';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.noteList){this.screen.curModal.noteList=[];}else{_this.initNotes();}
$divBackgroundContainer=$('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">');if(!this.paneChart){this.paneChart=$('<div style="width: 100%; height: 100%;">')[0];$(this.container).append($divBackgroundContainer).append(this.paneChart);}
else{$(this.container).append($divBackgroundContainer);}
_this.spinnerRender.spin(this.container.parentElement);if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;var containerChilBox;if(_this.screen.curModal.type==='AnlzTendency'){containerChilBox=$(_this.container).find('.containerChi')[0];}else{containerChilBox=_this.container;}
for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],containerChilBox,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],containerChilBox,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],containerChilBox,'');}
graph.show();}}
this.init();},renderModal:function(data){_this=this;_this.spinnerRender.stop();try{_this.render(data);}catch(e){console.warn(e);}
setTimeout(function(){_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);_this.spinnerRender.stop();},_this.chartAnimationDuration);},spinnerStop:function(){Spinner.stop();_this.spinnerRender.stop();},close:function(){this.spinnerRender.stop();this.screen=null;this.options=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;},init:function(){},errAlert:function(err){var $dataAlert=$('#dataAlert');switch(err){case'no data history':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE6+"</strong>").show().close();break;case'time':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE7+"</strong>").show().close();break;case'invalid time string':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE8+"</strong>").show().close();break;default:new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE9+"</strong>").show().close();break;}},initDock:function(){var arrHtml=[],previewerHtml=[];var $paneDock=$('.pane-dock',this.$parentContainer);if($paneDock.length){this.$paneDock=$paneDock;this.$dockManager=$('.dock-manager',$paneDock);this.$dockPreviewer=$('.dock-previewer-manager',$paneDock);return;}
arrHtml.push('<div class="dock-wheel dock-wheel-fill-icon" data-type="fill"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-fill" data-type="fill" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-top-icon" data-type="top"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-top" data-type="top" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-right-icon" data-type="right"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-right" data-type="right" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-down-icon" data-type="bottom"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-down" data-type="bottom" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-left-icon" data-type="left"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-left" data-type="left" style="display:none;"></div>');this.$paneDock=$('<div class="pane-dock" style="position: absolute; left: 0; top: 0; width:100%; height:100%;">');this.$dockManager=$('<div class="dock-manager" style="position: absolute;left: 0; top: 0; width:100%; height:100%;">');this.$dockPreviewer=$('<div class="dock-previewer-manager" style="position: absolute; left:0; top:0; width:100%;height:100%;">');this.$dockManager[0].innerHTML=arrHtml.join('');this.$dockPreviewer[0].innerHTML=previewerHtml.join('');this.$paneDock[0].appendChild(this.$dockManager[0]);this.$paneDock[0].appendChild(this.$dockPreviewer[0]);this.$parentContainer[0].appendChild(this.$paneDock[0]);},resetDock:function(){this.$parentContainer.children('.dock-window-ctn').remove();this.$parentContainer.children('.dock-note-toolbar').remove();this.$paneDock.remove();$(this.container).css({'top':0,'left':0,'bottom':0,'right':0});},initTools:function(){var _this=this;var $noteHideShow=$('#btnNoteHideOrShow');var $graphsBox=$('#graphBox');$('.itemTools .glyphicon-log-out').off('click').on('click',function(){if(!_this.screen)return;_this.screen.refreshPaneCenter(new window.analysis.panels.AnalysisTemplate(_this.screen));$('.divPage.selected').removeClass('selected');$('.itemTools .glyphicon-cog').off('click');$('#rightCt').trigger('click');});$('.itemTools .glyphicon-cog').eventOff('click').eventOn('click',function(){var optionTemplate=_this.screen.factoryIoC.getModel(_this.screen.curModal.type).prototype.optionTemplate;var data=[];for(var i=0;i<_this.screen.curModal.itemDS.length;i++){data.push({});data[i].dsType=_this.screen.curModal.itemDS[i].type;data[i].dsId=_this.screen.curModal.itemDS[i].arrId;data[i].dsName=[];var arrId=_this.screen.curModal.itemDS[i].arrId;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);for(var j=0;j<arrId.length;j++){var id=arrId[j];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){data[i].dsName.push(arrItem[m].alias);break;}}}}
var option={modeUsable:optionTemplate.chartConfig,allDataNeed:(optionTemplate.templateParams.paraAnlysMode=='all'),rowDataType:optionTemplate.templateParams.paraName,dataTypeMaxNum:optionTemplate.templateParams.dataTypeMaxNum,templateType:_this.screen.curModal.type,dsChartCog:_this.screen.curModal.dsChartCog,optionPara:{mode:_this.screen.curModal.mode,startTime:_this.screen.curModal.startTime,endTime:_this.screen.curModal.endTime,interval:_this.screen.curModal.format,timeRecent:_this.screen.curModal.timeRecent,dataItem:data}};_this.screen.modalConfig.showModalInit(false,option)},'数据分析配置');$('.itemTools .glyphicon-edit').eventOff('click').eventOn('click',function(){_this.createNote();$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$('.divNote').show();},'数据分析插入便签');$('#btnDownLoadExcel_a').eventOff('click').eventOn('click',function(){var xAxisList=_this.options.xAxisData;var str='坐标轴';var dataListArr=[];var dictDataList=_this.options.dataList?_this.options.dataList:{};if(dictDataList){for(var item in dictDataList){var itemL=dictDataList[item];if(itemL.length>1&&Object.prototype.toString.call(itemL[0])==='[object Array]'){for(var m=0,lens=itemL.length;m<lens;m++){dataListArr.push(itemL[m]);}}else{dataListArr.push(itemL);}
str+=','+item;}
if(xAxisList&&xAxisList.length!==0){for(var i=0,len=xAxisList.length;i<len;i++){str+='\n'+xAxisList[i];for(var j=0,lens=dataListArr.length;j<lens;j++){str+=','+dataListArr[j][i];}}}else{for(var n=0;n<1;n++){str+='\n';for(var p=0,length=dataListArr.length;p<length;p++){str+=','+dataListArr[p][n];}}}}else{str='无数据';}
$(this).attr('download',_this.screen.path[_this.screen.path.length-1].title+'.csv');str="\ufeff"+str;var blob=new Blob([str],{type:'text/csv;charset=utf-8'});var csvUrl=URL.createObjectURL(blob);document.getElementById("btnDownLoadExcel_a").href=csvUrl;},'数据分析下载数据');$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$noteHideShow.off('click').click(function(){if($noteHideShow.hasClass('glyphicon-eye-close')){$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$('.divNote').show();}else if($noteHideShow.hasClass('glyphicon-eye-open')){$noteHideShow.removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');$('.divNote').hide();}});if($graphsBox.length===0){$graphsBox=$('<ul id="graphBox" style="top:36px;left:auto;right:18px;width:118px;float:right;padding:5px 10px;position:absolute;z-index:150;border:1px solid #DDDDDE;border-radius:5px;background:#fff;display:none;">'+'<li style="width:98px;margin:0 auto;list-style:none;" class="graphSel"><span class="glyphicon glyphicon-arrow-right firstSpan" value="arrow" style="font-size:18px;color:#B6B4B4;margin-right:15px;display:inline-block!important;" id="arrowActive"></span>'+'<span class="icon-check-empty" id="rectActive" value="rect" style="width:16px;height:16px;border:2px solid #B6B4B4;margin-right:15px;display:inline-block!important;"></span>'+'<span class="icon-circle-blank" id="circleActive" value="circle" style="width:18px;height:18px;border:2px solid #B6B4B4;border-radius:9px;display:inline-block!important;"></span></li>'+'<li class="colorTotal" style="width:98px;margin:10px auto 0px;list-style:none;display:none;"><div style="width:24px;height:24px;border:1px solid #BDBEBF;float:left;margin-right:10px;">'+'<span class="colorSelect" style="display:block;width:20px;height:20px;margin:1px;background:red;"></span></div>'+'<div class="colorList" style="float:left;width:60px;margin-top:-5px;">'+'<span style="display:inline-block;width:11px;height:11px;background:#000;margin-right:3px;line-height:11px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;background:#7ab900;margin-right:3px;line-height:11px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#007acc;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ecede5;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ff2525;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#fcd209;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ff5500;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#a6b16c;font-size:11px;"></span></div>'+'<br style="clear:both;"></li>'+'</ul>');$('#anlsPaneContain').append($graphsBox);}
$('#anlsPaneContain').css('position','relative');$('#graphSelsect').off('click').click(function(){if($graphsBox.is(':hidden')){$graphsBox.show();}else{$graphsBox.hide();}});$('#btnDataFilter').off('click').click(function(){new DataCalcFilterContain(_this).show();});$('#anlsPaneContain .colorList span').hover(function(){$(this).css({'border-width':'1px','border-style':'solid','border-color':'#ddddde','border-radius':'5px'});},function(){$(this).css({'border':'none','border-radius':'0px'});});$('#anlsPaneContain .colorList span').off('click').click(function(){var graphType=$('.graphActive').attr('value');$('#anlsPaneContain .colorSelect').css('background-color',$(this).css('background-color'));var color=$('#anlsPaneContain .colorSelect').css('background-color');$('.svgGraph').remove();drawGraph(graphType,color);});$('#anlsPaneContain .graphSel span').off('click').click(function(){var color=$('#anlsPaneContain .colorSelect').css('background-color');var $graphSel=$(this);var graphType=$graphSel.attr('value');if(!$graphSel.hasClass('graphActive')){if($graphSel.hasClass('firstSpan')){$graphSel.css('color','#000');}else{$graphSel.css('border','2px solid #000');}
$graphSel.siblings().css('color','#B6B4B4');$graphSel.siblings().removeClass('graphActive');$graphSel.addClass('graphActive');}else{if($graphSel.hasClass('firstSpan')){$graphSel.css('color','#B6B4B4');}else{$graphSel.css('border','2px solid #B6B4B4');}
$graphSel.removeClass('graphActive');}
if($('#anlsPaneContain .graphSel span').hasClass('graphActive')){$('#anlsPaneContain .colorTotal').show();}else{$('#anlsPaneContain .colorTotal').hide();}
drawGraph(graphType,color);});function drawGraph(graphType,color){var drawGraph=undefined;var containerChilBox;if(_this.screen.curModal.type==='AnlzTendency'){containerChilBox=$(_this.container).find('.containerChi')[0];}else{containerChilBox=_this.container;}
if(graphType=='arrow'){drawGraph=new DrawArrow(_this.screen,{},containerChilBox,color);}else if(graphType=='rect'){drawGraph=new DrawRect(_this.screen,{},containerChilBox,color);}else if(graphType=='circle'){drawGraph=new DrawCircle(_this.screen,{},containerChilBox,color);}
drawGraph.drawing();}},createNote:function(note){var origZIndex;var notePos=getDivNotePos();var dockTriggerIndex=null;var $divNote=$('<div class="divNote">').click(function(){if($('.divNote').length>1){_this.curtNote=$divNote[0];if(this.style.zIndex<_this.getNoteMaxZIndex()){this.style.zIndex=_this.getNoteMaxZIndex()+1;origZIndex=this.style.zIndex;}}}).hover(function(e){if(this.style.zIndex<_this.getNoteMaxZIndex()){origZIndex=getComputedStyle(this).zIndex;this.style.zIndex=_this.getNoteMaxZIndex()+1;}}).attr('id',note?note.id:(new Date()).valueOf()).css({zIndex:_this.getNoteMaxZIndex()+1,left:note?note.x:'auto',right:note?'auto':notePos.x+'px',top:note?note.y:notePos.y,width:note?note.width:this.noteDefaultWidth+'px',height:note?note.height:this.noteDefaultHeight+'px',backgroundColor:note?note.bgColor:''}).mousedown(_this.doDown).mouseup(_this.doUp);var $divDrag=$('<div class="divDrag">').appendTo($divNote);var $divTitle=$('<div class="title">').appendTo($divDrag);$divDrag[0].draggable=true;setDrag($divDrag[0]);var disX=0;var disY=0;function setDrag(obj){obj.onmouseover=function(){obj.style.cursor="move";}
obj.onmousedown=function(event){var realDragObj=obj.parentNode;var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=event.clientX+scrollLeft-realDragObj.offsetLeft;disY=event.clientY+scrollTop-realDragObj.offsetTop;_this.showDockWheel();document.onmousemove=function(event){var ol=event.clientX+scrollLeft;var ot=event.clientY+scrollTop;var l=ol-disX;var t=ot-disY;realDragObj.style.left=l+"px";realDragObj.style.top=t+"px";var isTop=realDragObj.offsetTop<0
var isLeft=realDragObj.offsetLeft<0;var isRight=realDragObj.offsetParent.offsetWidth-realDragObj.offsetLeft<realDragObj.offsetWidth;var isBottom=realDragObj.offsetParent.offsetHeight-realDragObj.offsetTop<realDragObj.offsetHeight;if(isTop){realDragObj.style.top='0px';}
if(isLeft){realDragObj.style.left='0px';}
if(isRight){realDragObj.style.left=realDragObj.parentNode.offsetWidth-realDragObj.offsetWidth+'px';}
if(isBottom){realDragObj.style.top=realDragObj.parentNode.offsetHeight-realDragObj.offsetHeight+'px';}
var area;if(dockTriggerIndex!==null){area=_this.dockArea[dockTriggerIndex];if(ol>area.left&&ol<area.right&&ot>area.top&&ot<area.bottom){}else{dockTriggerIndex=null;area.$ele.removeClass('on');_this.hideDockPreviewer();}
return;}
for(var i=0,len=_this.dockArea.length;i<len;i++){area=_this.dockArea[i];if(ol>area.left&&ol<area.right&&ot>area.top&&ot<area.bottom){dockTriggerIndex=i;area.$ele.addClass('on');_this.showDockPreviewer(area.$ele[0].dataset.type);return;}}}
document.onmouseup=function(){var area=_this.dockArea[dockTriggerIndex];document.onmousemove=null;document.onmouseup=null;var note={id:realDragObj.id,x:((realDragObj.offsetLeft/realDragObj.offsetParent.offsetWidth)*100).toFixed(2)+'%',y:((realDragObj.offsetTop/realDragObj.offsetParent.offsetHeight)*100).toFixed(2)+'%'};_this.hideDockPreviewer();_this.hideDockWheel();if(dockTriggerIndex!==null){_this.saveDockNoteLayout(note.id,area.$ele[0].dataset.type);note.x='10%';note.y='10%';_this.saveDockLayout();return false;}
_this.saveNote(note);}
return false;}}
var $divPin=$('<div class="glyphicon pinIcon grow">&times;</div>').appendTo($divTitle);$divPin.mousedown(function(e){_this.removeNote(this);e.stopPropagation();});var $divText=$('<div class="divText gray-scrollbar">').appendTo($divDrag);if(_this.isShareMode!==1){+function(){var timer=null,mousePos=null;$divText.off('mousedown').mousedown(function(e){mousePos={x:e.clientX,y:e.clientY};});$divText.off('mouseup').mouseup(function(e){if(timer!==null){return;}
timer=window.setTimeout(function(){timer=null;},500);if(Math.abs(mousePos.x-e.clientX)<10&&Math.abs(mousePos.y-e.clientY)<10){showEditor();}
mousePos=null;});}.call(this);function showEditor(e){var $modalConfig;WebAPI.get('/static/views/observer/widgets/modalUEditor.html').done(function(resultHTML){$('.divNote').hide();$('.dock-layout').hide();$('.svgBox').hide();$(_this.container).append(resultHTML);$modalConfig=$('#modalUEditor');$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$('.divNote').show();$('.dock-layout').show();$('#modalUEditorContainer').remove();$('#edui_fixedlayer').remove();$('#anlsPane').css({overflowX:'hidden',overflowY:'auto'})
$('.svgBox').show();UE.delEditor('ueditor');});$modalConfig.off('show.bs.modal').on('show.bs.modal',function(){$('#anlsPane').css({overflow:'visible'})
UE.getEditor('ueditor',{lang:(I18n.type=='zh'?'zh-cn':'en')}).ready(function(){UE.insertPic(this);$(document.querySelector('iframe')).addClass('gray-scrollbar')
var bodyEditor=document.querySelector('iframe').contentWindow.document.querySelector('body');note&&note.bgColor&&(bodyEditor.style.backgroundColor=note.bgColor);bodyEditor.innerHTML=note?note.text:'';});});$modalConfig.off('shown.bs.modal').on('shown.bs.modal',function(){});$modalConfig.modal('show');$(_this.container).find('#saveNote').off('click').on('click',function(){var body=$('iframe','.edui-editor-iframeholder')[0].contentWindow.document.querySelector('body');var content=body.innerHTML;var newNote={id:$divNote[0].id};if(note){newNote.text=content;newNote.bgColor=body.style.backgroundColor;}else{newNote.text=content;newNote.bgColor=body.style.backgroundColor;newNote.height=_this.noteDefaultHeight+'px';newNote.width=_this.noteDefaultWidth+'px';$divNote[0].style.right='';$divNote[0].style.left=($divNote.parent().width()-_this.noteDefaultWidth)+'px';}
_this.saveNote(newNote);$divText.html(content);$divNote.css({backgroundColor:newNote.bgColor})
$modalConfig.modal('hide');if(note){note.text=content;note.bgColor=newNote.bgColor;}else{note=newNote;}})});}}
$divText.html(note?note.text:'');note&&note.bgColor&&$divNote.css({backgroundColor:note.bgColor});$(this.paneNotes).append($divNote);$(document).on('click','#st-container',_this.doClick);$(document).on('mousemove','#st-container',_this.doMove);function getDivNotePos(){var pos={}
var $lastNote=$('.divNote:nth-last-child(1)');if($lastNote[0]){if($lastNote[0].offsetLeft<100){pos.x=0;pos.y=$lastNote[0].offsetTop+$lastNote[0].offsetHeight+20;_this.noteCount=0;}else{++_this.noteCount;pos.x=_this.noteCount*130;pos.y=$lastNote[0].offsetTop;}}else{pos.x=0;pos.y=0;}
return pos;}},removeNote:function(obj){confirm(i18n_resource.analysis.workspace.CONFIRM_NOTE_DELETE,function(){var $divNote=$(obj).closest('.divNote');$divNote.remove();var index=_this.getNoteListIndex($divNote.attr('id'));if(index!=undefined){_this.screen.curModal.noteList.splice(index,1);_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);}});},initNotes:function(){var _this=this;var notes=this.screen.curModal.noteList;var layout=this.screen.curModal.layout||{};if(!notes.length)return;notes.forEach(function(row){var dockPosition=null;for(var t in layout){if(!layout.hasOwnProperty(t)){continue;}
if(!layout[t]||!layout[t].length){continue;}
if(layout[t].indexOf(row.id)>-1){dockPosition=t;break;}}
if(!!dockPosition){_this.createDockNote(row,dockPosition);}else{_this.createNote(row);}});_this.layoutDockNotes();},hideNotes:function(){},showNotes:function(){},getNoteMaxZIndex:function(){var divNoteList=$('.divNote');var maxZIndex=102;for(var i=0;i<divNoteList.length;i++){var zIndex=parseInt(getComputedStyle(divNoteList[i]).zIndex);if(zIndex>maxZIndex){maxZIndex=zIndex;}}
return maxZIndex;},getNoteListIndex:function(id){for(var i=0;i<_this.screen.curModal.noteList.length;i++){if(_this.screen.curModal.noteList[i].id==id){return i;}}},showDockWheel:function(){var _this=this;var $dockFill=this.$dockManager.children('.dock-wheel-fill-icon');var $dockTop=this.$dockManager.children('.dock-wheel-top-icon');var $dockRight=this.$dockManager.children('.dock-wheel-right-icon');var $dockDown=this.$dockManager.children('.dock-wheel-down-icon');var $dockLeft=this.$dockManager.children('.dock-wheel-left-icon');var offset;this.$parentContainer.addClass('on');[$dockFill,$dockTop,$dockRight,$dockDown,$dockLeft].forEach(function($dock,i){offset=$dock.offset();_this.dockArea.push({'left':offset.left,'top':offset.top,'right':offset.left+$dock.width(),'bottom':offset.top+$dock.height(),'$ele':$dock});});},hideDockWheel:function(){this.$parentContainer.removeClass('on');this.$dockManager.children().removeClass('on');},showDockPreviewer:function(type){this.$dockPreviewer.show();this.$dockPreviewer.children('[data-type="'+type+'"]').show();},hideDockPreviewer:function(){this.$dockPreviewer.children().hide();this.$dockPreviewer.hide();},saveDockNoteLayout:function(noteId,direction){var layout=this.screen.curModal.layout;var notes=this.screen.curModal.noteList;var note;if(['top','right','bottom','left'].indexOf(direction)===-1)return;if(!layout){layout=this.screen.curModal.layout={};}
layout[direction]=layout[direction]||[];if(layout[direction].indexOf(noteId)>-1)return;layout[direction].push(noteId);$('#'+noteId).remove();note=notes.filter(function(row,i){return row.id===noteId;});if(note&&note.length){this.createDockNote(note[0],direction);this.layoutDockNotes();_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},createDockNote:function(note,direction){var _this=this;var $ctn=this.$parentContainer.children('.dock-window-ctn');var $divNote=$('<div class="dock-note" style="background-color: '+note.bgColor+'">'+'<div class="dock-note-resizer" data-direction="'+direction+'"></div>'+'<button type="button" class="close editor"><span aria-hidden="true">'+I18n.resource.analysis.workspace.EDIT_NOTE+'</span></button>'+'<button type="button" class="close cancel"><span aria-hidden="true">'+I18n.resource.analysis.workspace.CANCEL_FIX+'</span></button>'+'<div class="dock-note-ct gray-scrollbar" data-id="'+note.id+'"></div>'+'<button id="saveDockNote" type="button" class="" style="display:none;position:absolute;bottom:5px;right:5px;z-index: 9999;color: #333;border-radius: 4px;box-shadow: 0px 3px 8px 2px #ccc;border: 1px solid #ccc;">Save</button>'+'</div>');var $divNoteCt=$divNote.children('.dock-note-ct');var $noteResizer=$divNote.children('.dock-note-resizer');var $layoutCtn,$layoutCtnWrap;var $layoutContainer;if($ctn.length===0){$ctn=$('<div class="dock-window-ctn">');this.$parentContainer.append($ctn[0]);}
if(['top','bottom'].indexOf(direction)>-1){$layoutContainer=$ctn;$divNoteCt.height(note.height);}
if(['left','right'].indexOf(direction)>-1){$layoutCtnWrap=$ctn.children('.dock-layout-wrap');if($layoutCtnWrap.length===0){$layoutCtnWrap=$('<div class="dock-layout-wrap">');$ctn.append($layoutCtnWrap);}
$layoutContainer=$layoutCtnWrap;$divNoteCt.width(note.width);}
$layoutCtn=$layoutContainer.children('.dock-layout-'+direction);if($layoutCtn.length===0){$layoutCtn=$('<div class="dock-layout dock-layout-'+direction+'" data-direction="'+direction+'">');$layoutContainer.append($layoutCtn);}
$divNoteCt.html(note.text);$layoutCtn.append($divNote);$divNote.children('.cancel').off().click(function(){var $this=$(this);var $curNote=$this.closest('.dock-note');var $curNoteCt=$curNote.children('.dock-note-ct');var id=$curNoteCt[0].dataset.id;var index=_this.getNoteListIndex(id);var note=_this.screen.curModal.noteList[index];var arr=_this.screen.curModal.layout[direction];for(var i=0,len=arr.length;i<len;i++){if(arr[i]===id){arr.splice(i,1);break;}}
_this.createNote({id:id,text:$curNoteCt.html(),x:note.x,y:note.y,width:note.width,height:note.height,bgColor:note.bgColor});$curNote.remove();_this.layoutDockNotes('top');_this.saveDockLayout();});$divNote.children('.editor').off().click(function(e){$(document).click();var realHeight=getComputedStyle($divNoteCt[0]).height;var height=realHeight<'100px'?'100px':realHeight;var width=getComputedStyle($divNoteCt[0]).width;var $saveDockNote=$('#saveDockNote');$divNoteCt.hide();$('.divNote').hide();$('.svgBox').hide();$divNote.append('<div style="width: '+width+';height: '+height+';"><script id="ueditor" type="text/plain" style="height:calc(100% - 20px);"></script></div>');UE.delEditor('ueditor');UE.getEditor('ueditor',{lang:(I18n.type=='zh'?'zh-cn':'en')}).ready(function(){UE.insertPic(this);$saveDockNote.show();var iframe=document.querySelector('iframe');var iframeHtml=iframe.contentWindow.document.querySelector('html');var bodyEditor=iframe.contentWindow.document.querySelector('body');$(iframe).addClass('gray-scrollbar');$(iframeHtml).css({overflowX:'hidden'});note&&note.bgColor&&(bodyEditor.style.backgroundColor=note.bgColor);$('.edui-editor-iframeholder').css({height:parseInt(height.split('px')[0])-$('.edui-editor-toolbarbox').height()});bodyEditor.innerHTML=note?note.text:'';$saveDockNote.off('click').on('click',function(){Spinner.spin($('.dock-layout')[0]);$divNoteCt[0].innerHTML=bodyEditor.innerHTML;var newNote={id:$divNoteCt.attr('data-id'),text:$divNoteCt[0].innerHTML,bgColor:bodyEditor.style.backgroundColor}
_this.saveNote(newNote);note.text=$divNoteCt[0].innerHTML;note.bgColor=bodyEditor.style.backgroundColor;$(this).hide();var timer=setTimeout(function(){UE.delEditor('ueditor');$('#ueditor').parent().remove();$divNoteCt.show();$('.divNote').show();$('.svgBox').show();clearTimeout(timer);Spinner.stop();},500);});});});$noteResizer.off('mousedown').mousedown(function(e){$(document).click();var $resizer=$(this);var $note=$resizer.closest('.dock-note');var $noteCt=$note.children('.dock-note-ct');var $wrap=_this.$parentContainer.find('.dock-layout-wrap');var $container=$(_this.container);var direction=$resizer[0].dataset.direction;var downX,downY;var downWidth=$noteCt.width();var downHeight=$noteCt.height();var ctnPos={left:parseFloat($container.css('left'))||0,right:parseFloat($container.css('right'))||0,top:parseFloat($container.css('top'))||0,bottom:parseFloat($container.css('bottom'))||0}
downX=e.pageX;downY=e.pageY;$(document).mousemove(function(e){var moveX=e.pageX;var moveY=e.pageY;var delta;if(direction==='left'){delta=moveX-downX;$noteCt.width(downWidth+delta);}else if(direction==='right'){delta=downX-moveX;$noteCt.width(downWidth+delta);}else if(direction==='top'){delta=moveY-downY;$noteCt.height(downHeight+delta);$wrap.css('top',ctnPos.top+delta);}else if(direction==='bottom'){delta=downY-moveY;$noteCt.height(downHeight+delta);$wrap.css('bottom',ctnPos.bottom+delta);}});$(document).mouseup(function(e){var $this=$(this);var id=$noteCt[0].dataset.id;var params={id:id};var moveX=e.pageX;var moveY=e.pageY;var delta;if(direction==='left'){delta=moveX-downX;$noteCt.width(downWidth+delta);$container.css('left',ctnPos.left+delta);}else if(direction==='right'){delta=downX-moveX;$noteCt.width(downWidth+delta);$container.css('right',ctnPos.right+delta);}else if(direction==='top'){delta=moveY-downY;$noteCt.height(downHeight+delta);$wrap.css('top',ctnPos.top+delta);$container.css('top',ctnPos.top+delta);}else if(direction==='bottom'){delta=downY-moveY;$noteCt.height(downHeight+delta);$wrap.css('bottom',ctnPos.bottom+delta);$container.css('bottom',ctnPos.bottom+delta);}
if(direction==='left'||direction==='right'){params['width']=$note.width();}else{params['height']=$note.height();}
_this.saveNote(params);_this.screen.onresize();$this.off('mousemove');$this.off('mouseup');});e.stopPropagation();});},layoutDockNotes:function(){var _this=this;var $ctn=this.$parentContainer.children('.dock-window-ctn');var $layoutCtnWrap=$ctn.children('.dock-layout-wrap');var $container=$(this.container);$ctn.find('.dock-layout').each(function(i,dom){var $this=$(this);var direction=$this[0].dataset.direction;var $notes=$this.children('.dock-note');var sum=0;if($notes.length===0){$this.remove();}
if(['left','right'].indexOf(direction)>-1){$notes.each(function(i,dom){var $this=$(this);var width=$this.outerWidth();sum+=width;});}
if(['top','bottom'].indexOf(direction)>-1){$notes.each(function(i,dom){var $this=$(this);var height=$this.outerHeight();sum+=height;});$layoutCtnWrap.css(direction,sum);}
$container.css(direction,sum);});_this.screen.onresize();},saveDockLayout:function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);},resizeObject:function(){this.el=null;this.dir="";this.grabx=null;this.graby=null;this.width=null;this.height=null;this.left=null;this.top=null;},getDirection:function(el){var xPos,yPos,offset,dir;dir="";xPos=window.event.offsetX;yPos=window.event.offsetY;offset=8;if(yPos<offset)dir+="n";else if(yPos>el.offsetHeight-offset)dir+="s";if(xPos<offset)dir+="w";else if(xPos>el.offsetWidth-offset)dir+="e";return dir;},doDown:function(){if(this.style.cursor.indexOf('-resize')>-1){$('.divTextEditor').blur();var el=_this.getReal(event.srcElement,"className","divNote");if(el==null){_this.theobject=null;return;}
if(el.className&&el.className.indexOf('divNote')<0)return;_this.dir=_this.getDirection(el);if(_this.dir=="")return;_this.leftObject=new _this.resizeObject();_this.leftObject.el=el;_this.leftObject.dir=_this.dir;_this.leftObject.grabx=window.event.clientX;_this.leftObject.graby=window.event.clientY;_this.leftObject.width=el.offsetWidth;_this.leftObject.height=el.offsetHeight;_this.leftObject.left=el.offsetLeft;_this.leftObject.top=el.offsetTop;window.event.returnValue=false;window.event.cancelBubble=true;}},doUp:function(e){if(e.target.classList.contains('pinIcon'))return;if(_this.leftObject!=null){var note={id:_this.leftObject.el.id,width:_this.leftObject.el.style.width,height:_this.leftObject.el.style.height}
_this.saveNote(note);_this.leftObject=null;}},doMove:function(e){var el,str,xMin,yMin;xMin=_this.noteDefaultWidth/4;yMin=_this.noteDefaultHeight/5;el=event.srcElement;if(!el)return;if(el.className&&typeof(el.className)=='string'&&el.className.indexOf("divNote")>-1){str=_this.getDirection(el);if(str=="")str="default";else str+="-resize";el.style.cursor=str;}
if(_this.leftObject!=null){if(_this.dir.indexOf("e")!=-1)
_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width+window.event.clientX-_this.leftObject.grabx)+"px";if(_this.dir.indexOf("s")!=-1)
_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height+window.event.clientY-_this.leftObject.graby)+"px";if(_this.dir.indexOf("w")!=-1){_this.leftObject.el.style.left=Math.min(_this.leftObject.left+window.event.clientX-_this.leftObject.grabx,_this.leftObject.left+_this.leftObject.width-xMin)+"px";_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width-window.event.clientX+_this.leftObject.grabx)+"px";}
if(_this.dir.indexOf("n")!=-1){_this.leftObject.el.style.top=Math.min(_this.leftObject.top+window.event.clientY-_this.leftObject.graby,_this.leftObject.top+_this.leftObject.height-yMin)+"px";_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height-window.event.clientY+_this.leftObject.graby)+"px";}
window.event.returnValue=false;window.event.cancelBubble=true;}},doClick:function(e){if(!_this.screen||!_this.screen.curModal)return;if(_this.curtNote){if(e.target.classList.contains('pinIcon'))return;if(e.target==_this.curtNote||$(e.target).closest('.divNote')[0]==_this.curtNote){_this.curtNote.style.zIndex=_this.getNoteMaxZIndex()+1;}else{var $thisEditor=$(_this.curtNote).find('.divTextEditor');$(_this.curtNote).find('.btn-toolbar').slideUp('1000',function(){$thisEditor.hide();$(_this.curtNote).find('.divText').html($thisEditor.html()).show();_this.curtNote.style.minWidth='';_this.curtNote.style.minHeight='';});$thisEditor.removeClass('editing');var id=$(_this.curtNote).attr('id');var index=_this.getNoteListIndex(id);var note={id:id,text:$(_this.curtNote).find('.divTextEditor').html(),width:$(_this.curtNote).css('width'),height:$(_this.curtNote).css('height')}
_this.saveNote(note)}}},getReal:function(el,type,value){var temp=el;while((temp!=null)&&(temp.tagName!="BODY")){if(eval("temp."+type)==value){el=temp;return el;}
temp=temp.parentElement;}
return el;},saveNote:function(note){var id=note.id;var isSave=false
if(_this.screen.curModal.noteList==undefined)return;var index=_this.getNoteListIndex(id);if(index==undefined){if(!note.text||$.trim(note.text.length)==0)return;var $divNote=$('#'+id);var note={id:id,x:((parseInt(getComputedStyle($divNote[0]).left.split('px')[0])/$divNote.parent().width())*100).toFixed(2)+'%',y:((parseInt(getComputedStyle($divNote[0]).top.split('px')[0])/$divNote.parent().height())*100).toFixed(2)+'%',width:note.width,height:note.height,text:note.text,bgColor:note.bgColor}
_this.screen.curModal.noteList.push(note);doSave();}else{var note_old=_this.screen.curModal.noteList[index];if(note.x&&note.x!=note_old.x){isSave=true}
if(!isSave&&note.y&&note.y!=note_old.y){isSave=true}
if(!isSave&&note.width&&note.width!=note_old.width){isSave=true}
if(!isSave&&note.height&&note.height!=note_old.height){isSave=true}
if(!isSave&&note.text&&note.text!=note_old.text){isSave=true}
if(isSave){_this.screen.curModal.noteList[index]={id:id,x:note.x?note.x:note_old.x,y:note.y?note.y:note_old.y,width:note.width?note.width:note_old.width,height:note.height?note.height:note_old.height,text:note.text?note.text:note_old.text,bgColor:note.bgColor?note.bgColor:note_old.bgColor}
doSave();}}
function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},initPointAlias:function(arrPointsAlias){var lastRepeatIndex=-1;var tempAlias;var repeatNum=0;var tempIndex;for(var i=0;i<arrPointsAlias.length;++i){lastRepeatIndex=arrPointsAlias.lastIndexOf(arrPointsAlias[i]);if(lastRepeatIndex>i){repeatNum=1;tempAlias=arrPointsAlias[i];arrPointsAlias[i]=tempAlias+'_No1';tempIndex=i;for(var j=tempIndex+1;j<lastRepeatIndex+1;++j){repeatNum+=1;tempIndex=arrPointsAlias.indexOf(tempAlias);if(tempIndex==-1)break;arrPointsAlias[tempIndex]=tempAlias+'_No'+repeatNum;}}}
return arrPointsAlias;}};return AnlzBase;})();﻿var AnlzChart=(function(){function AnlzChart(containerId,entityParams){}
AnlzChart.prototype.renderModal=function(){this.container.innerHTML=template;},AnlzChart.prototype.updateModal=function(name,value){},AnlzChart.prototype.showConfigMode=function(){}
return AnlzChart;})();var AnlzPieRealtime=(function(){var _this;function AnlzPieRealtime(container,option,screen){AnlzBase.call(this,container,option,screen);_this=this;this.paneChart=undefined;this.chart=undefined;this.dictLegend={};this.postData={};this.interv=undefined;this.options.dataList={};}
AnlzPieRealtime.prototype=new AnlzBase();AnlzPieRealtime.prototype.optionTemplate={imgName:'anlsPieRealtime.png',imgIndex:5,imgColor:'211,97,78',templateName:'analysis.modalType.PIE_REAL_TIME',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['realTime']};AnlzPieRealtime.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.dictLegend=null;clearInterval(_this.interv);this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzPieRealtime.prototype.init=function(){_this.postData={dsItemIds:_this.options.itemDS[0].arrId};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',_this.postData).done(function(result){if(result&&result.dsItemList){var rslt=result.dsItemList;if(rslt.error&&rslt.error.length>0){alert(rslt.error);_this.spinnerStop();return;}
_this.renderModal(rslt);}}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});_this.interv=setInterval(function(){_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',_this.postData).done(function(result){var data=result.dsItemList;if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
if(data&&data!=''){var arrData=[];var arrId=[];var arrItem=[];for(var i=0;i<data.length;i++){arrId.push(data[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,item;i<data.length;i++){item=data[i];for(var m=0;m<arrItem.length;m++){if(item.dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;arrData.push({value:parseFloat(item.data),name:itemName});break;}}}
var series=[{type:'pie',radius:'55%',center:['50%','60%'],data:arrData}];_this.chart&&_this.chart.getOption().series.push(series);}
_this.spinnerStop();}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});},60000);};AnlzPieRealtime.prototype.render=function(data){var arrLabel=[],arrData=[];var arrId=[];var arrItem=[];for(var i=0;i<data.length;i++){arrId.push(data[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,item;i<data.length;i++){item=data[i];for(var m=0;m<arrItem.length;m++){if(item.dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;arrLabel.push(itemName);arrData.push({value:parseFloat(item.data),name:itemName});this.options.dataList[itemName]=this.options.dataList[itemName]?this.options.dataList[itemName]:[];this.options.dataList[itemName].push(parseFloat(item.data));break;}}}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:'',x:'center'},tooltip:{trigger:'item',formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:'vertical',x:'left',data:arrLabel},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:true,series:[{type:'pie',center:['50%','60%'],data:arrData}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzPieRealtime;})();﻿var AnlzHistoryCompare=(function(){var _this;function AnlzHistoryCompare(container,option,screen){AnlzBase.call(this,container,option,screen);_this=this;this.curIndex=1;if(this.options){this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}}
AnlzHistoryCompare.prototype=new AnlzBase();AnlzHistoryCompare.prototype.optionTemplate={imgName:'anlsHistory.png',imgIndex:3,imgColor:'65,131,189',templateName:'analysis.modalType.HISTORY_COMPARE',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easyCompareAnalyz','compareSensor','compareMeter']};AnlzHistoryCompare.prototype.show=function(){this.container.innerHTML='';this.initTools();this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});var temp;this.paneChart=document.createElement('div');temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='100% ';this.container.appendChild(this.paneChart);temp=null;_this.spinnerRender.spin(this.container.parentElement);this.init();};AnlzHistoryCompare.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.dictLegend=null;this.curIndex=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzHistoryCompare.prototype.init=function(){AppConfig.datasource.getDSItemDataMulti(this,this.options.itemDS[0].arrId);};AnlzHistoryCompare.prototype.render=function(data){this.chart?this.refreshChart(data):this.initChart(data);};AnlzHistoryCompare.prototype.initChart=function(data){this.createSeries(data);var i18nEcharts=I18n.resource.echarts;var option={title:{text:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{x:'right',data:this.arrLegendData},toolbox:{show:false,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,grid:{x:60,x2:20,y:60,borderColor:'#eee'},xAxis:[{type:'category',data:this.options.arrComparePeriodLabel}],yAxis:[{type:'value'}],series:this.arrSeries};this.options.xAxisData=this.options.arrComparePeriodLabel;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);var _this=this;};AnlzHistoryCompare.prototype.refreshChart=function(data){var arrData=[],item=data.list[0];if(this.dictLegend[item.dsItemId])return;var tempOption=this.chart.getOption();var arrTemp=tempOption.series;arrTemp.push(this.createSeries(item.data));this.chart.setOption(tempOption);arrTemp=null;this.options.itemDS[0].arrId.push(item.dsItemId);var _this=this;this.screen.saveModal();};AnlzHistoryCompare.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],calcResult=[],arrId=[];var mode=this.options.mode;if(mode=='easyCompareAnalyz'||mode=='compareSensor'){for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];var dsItemIdName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;calcResult[i][j]=0;if(i==0){arrId.push(point.dsItemId);arrLegendData.push(dsItemIdName);}
for(var k=0;k<point.data.length;k++){calcResult[i][j]+=parseFloat(point.data[k])}
calcResult[i][j]=calcResult[i][j]/point.data.length;this.options.dataList[dsItemIdName]=this.options.dataList[dsItemIdName]?this.options.dataList[dsItemIdName]:[];this.options.dataList[dsItemIdName].push(calcResult[i][j]);}}}else if(mode=='compareMeter'){for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];if(i==0){arrLegendData.push(AppConfig.datasource.getDSItemById(point.dsItemId).alias);}
calcResult[i][j]=point.data[point.data.length-1]-point.data[0];this.options.dataList[dsItemIdName]=this.options.dataList[dsItemIdName]?this.options.dataList[dsItemIdName]:[];this.options.dataList[dsItemIdName].push(calcResult[i][j]);}}}
arrLegendData=_this.initPointAlias(arrLegendData);var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(data[0].list[0].dsItemId);for(var i=0;i<data[0].list.length;i++){var seriesData=[];for(var j=0;j<data.length;j++){seriesData.push(calcResult[j][i])}
var color=echarts.config.color[this.curIndex++];var series={name:arrLegendData[i],type:'bar',data:seriesData,itemStyle:{normal:{lineStyle:{color:color},barBorderRadius:[5,5,5,5]}}}
arrSeries.push(series);}
this.arrSeries=arrSeries;this.arrLegendData=arrLegendData;};return AnlzHistoryCompare;})();var AnlzHistoryCompare_Line=(function(){var _this;function AnlzHistoryCompare_Line(container,option,screen){_this=this;AnlzHistoryCompare.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzHistoryCompare_Line.prototype=new AnlzHistoryCompare();AnlzHistoryCompare_Line.prototype.optionTemplate={imgName:'anlsHistory.png',imgIndex:3,imgColor:'65,131,189',templateName:'analysis.modalType.HISTORY_COMPARE_LINE',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easyCompareAnalyz','compareSensor','compareMeter']};AnlzHistoryCompare_Line.prototype.initChart=function(data){this.createSeries(data);var xAxis=[];for(var i=0;i<data[0].timeShaft.length;++i){xAxis.push('Day'+new Date(data[0].timeShaft[i]).getDate()+' '+new Date(data[0].timeShaft[i]).format("HH:mm:ss"));}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'},formatter:function(params){var strToolTip='',date;var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(_this.options.itemDS[0].arrId);for(var i=0;i<params.length;i++){if(i%2==0){for(var m=0;m<arrItem.length;m++){if(_this.options.itemDS[0].arrId[i/2]==arrItem[m].id){strToolTip+=arrItem[m].alias+'<br/>';strToolTip+=data[0].timeShaft[params[i].dataIndex]+'<br/>Value: '+params[i].value+'<br/>'
break;}}}else{strToolTip+=data[1].timeShaft[params[i].dataIndex]+'<br/>Value: '+params[i].value+'<br/>'}}
return strToolTip;}},legend:{x:'right',data:this.arrLegendData},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:false,grid:{x:60,x2:20,y:60,borderColor:'#eee'},dataZoom:{show:false},xAxis:[{type:'category',data:xAxis,splitLine:{show:false}}],yAxis:[{type:'value',scale:true}],series:this.arrSeries};this.options.xAxisData=xAxis;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);var _this=this;};AnlzHistoryCompare_Line.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],pointData=[],arrId=[];var mode=this.options.mode;if(mode=='easyCompareAnalyz'||mode=='compareSensor'){for(var i=0;i<data.length;i++){var item=data[i];pointData[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];var pointName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;pointData[i][j]=[];if(i==0){arrId.push(point.dsItemId);arrLegendData.push(this.options.arrComparePeriodLabel[0]+':'+pointName);arrLegendData.push(this.options.arrComparePeriodLabel[1]+':'+pointName);}
for(var k=0;k<point.data.length;k++){pointData[i][j].push(parseFloat(point.data[k]));}
this.options.dataList[pointName]=this.options.dataList[pointName]?this.options.dataList[pointName]:[];this.options.dataList[pointName].push(pointData[i][j]);}}}else if(mode=='compareMeter'){for(var i=0;i<data.length;i++){pointData[i]=[];var item=data[i];for(var j=0;j<item.list.length;j++){pointData[i][j]=[];var point=item.list[j];var pointName=AppConfig.datasource.getDSItemById(point.dsItemId).alias;if(i==0){arrLegendData.push(this.options.arrComparePeriodLabel[0]+':'+pointName);arrLegendData.push(this.options.arrComparePeriodLabel[1]+':'+pointName);}
for(var k=0;k<point.data.length;k++){pointData[i][j].push(parseFloat(point.data[k]));}
this.options.dataList[pointName]=this.options.dataList[pointName]?this.options.dataList[pointName]:[];this.options.dataList[pointName].push(pointData[i][j]+'\n');}}}
if(arrLegendData[0]==arrLegendData[1]){arrLegendData[0]+='_No1';arrLegendData[1]+='_No2';}
var index=0;for(var i=0;i<data[0].list.length;i++){var seriesData=[];for(var j=0;j<data.length;j++){seriesData=pointData[j][i];var color=echarts.config.color[this.curIndex++];var series={name:arrLegendData[index],type:'line',data:seriesData,itemStyle:{normal:{barBorderRadius:[5,5,5,5]}}};arrSeries.push(series);index=index+1;}}
this.arrSeries=arrSeries;this.arrLegendData=arrLegendData;};return AnlzHistoryCompare_Line;})();﻿var AnlzScatter=(function(){function AnlzScatter(container,option,screen){AnlzBase.call(this,container,option,screen);this.animation=true;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzScatter.prototype=new AnlzBase();AnlzScatter.prototype.optionTemplate={imgName:'anlsScatter.png',imgIndex:2,imgColor:'211,97,78',templateName:'analysis.modalType.SCATTER',templateParams:{paraName:['X','Y'],paraAnlysMode:'all',dataTypeMaxNum:[1,5]},chartConfig:['easy','fixed','recent']};AnlzScatter.prototype.init=function(){var _this=this;var arrIds=[];arrIds.push(this.options.itemDS[0].arrId[0]);arrIds=arrIds.concat(this.options.itemDS[1].arrId);var timeConfig;if(this.options.timeRecent){timeConfig=generateTimeOption(this.options)}else{timeConfig=this.options}
var postData={dsItemIds:arrIds,timeStart:new Date(timeConfig.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(timeConfig.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeConfig.format};WebAPI.post('/analysis/startWorkspaceDataGenScatterChart',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});};AnlzScatter.prototype.render=function(data){var arrXAxis=data.list[0].data,arrData=[],arrLegend=[],arrSeries=[];var arrId=[];var arrItem=[];var dataListBack={};for(var i=1;i<data.list.length;i++){arrId.push(data.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<data.list.length;i++){if(i===0){this.options.xAxisData=data.list[i].data;}else{arrData.push([]);for(var m=0;m<arrItem.length;m++){if(data.list[i].dsItemId==arrItem[m].id){arrLegend.push(arrItem[m].alias);this.options.dataList[arrItem[m].alias]=data.list[i].data;break;}}}}
for(var dictItems in this.options.dataList){var dictYItem=this.options.dataList[dictItems];dataListBack[dictItems]=[];for(var n=0,len=dictYItem.length;n<len;n++){dataListBack[dictItems].push('('+this.options.xAxisData[n]+'、'+dictYItem[n]+')');}}
this.options.dataList=dataListBack;for(var i=0,valueX;i<arrXAxis.length;i++){valueX=data.list[0].data[i];for(var j=0,jLen=data.list.length-1;j<jLen;j++){arrData[j].push([valueX,data.list[j+1].data[i]]);}}
for(var i=0;i<arrData.length;i++){arrSeries.push({name:arrLegend[i],type:'scatter',data:arrData[i],markLine:{data:[{type:'average',name:I18n.resource.observer.analysis.AVERAGE}]}});}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:'X: '+AppConfig.datasource.getDSItemById(data.list[0].dsItemId).alias,subtext:'Scatter'},tooltip:{trigger:'axis',showDelay:0,axisPointer:{show:true,type:'cross',lineStyle:{type:'dashed',width:1}}},legend:{data:arrLegend},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},xAxis:[{type:'value',scale:true}],yAxis:[{type:'value',scale:true}],series:arrSeries,animation:this.animation,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzScatter;})();﻿var AnlzSpectrum=(function(){function AnlzSpectrum(container,option,screen){AnlzBase.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzSpectrum.prototype=new AnlzBase();AnlzSpectrum.prototype.optionTemplate={imgName:'anlsSpectrum.png',imgIndex:1,imgColor:'148,193,142',templateName:'analysis.modalType.SPECTRUM',templateParams:{paraName:['X'],paraAnlysMode:'all',dataTypeMaxNum:[1]},chartConfig:['easy','fixed','recent']};AnlzSpectrum.prototype.init=function(){var _this=this;var timeConfig;if(this.options.timeRecent){timeConfig=generateTimeOption(this.options)}else{timeConfig=this.options}
var postData={dsItemIds:[this.options.itemDS[0].arrId[0]],timeStart:new Date(timeConfig.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(timeConfig.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeConfig.format};WebAPI.post('/analysis/startWorkspaceDataGenPattern',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});};AnlzSpectrum.prototype.render=function(data){var arrLabel=[],arrData=[];for(var i=0,item;i<data.list.length;i++){item=data.list[i];arrLabel.push(item.data);arrData.push(item.pattern);}
var i18nEcharts=I18n.resource.echarts;var name=AppConfig.datasource.getDSItemById(this.options.itemDS[0].arrId[0]).alias;var option={title:{text:name,subtext:'Spectrum'},tooltip:{trigger:'axis'},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:true,xAxis:[{type:'category',boundaryGap:true,data:arrLabel}],yAxis:[{type:'value'}],series:[{type:'bar',data:arrData,itemStyle:{normal:{color:'#5bc0de',barBorderRadius:[5,5,0,0]}},markLine:{data:[{type:'average',name:I18n.resource.observer.analysis.AVERAGE}]}}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.options.xAxisData=arrLabel;this.options.dataList[name]=arrData;this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};return AnlzSpectrum;})();﻿var AnlzTendency=(function(){var _this;function AnlzTendency(container,option,screen){AnlzBase.call(this,container,option,screen);this.paneLegend=undefined;this.dictLegend={};this.dictTooltip={};this.curIndex=0;this.legendType={NORMAL:0,Prediction:1,Regression:2};this.screen=screen;this.animation=true;this.timeType=!option?'h1':option.format;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};if(this.options.chartOption){this.modifyData=this.options.chartOption;if(!this.modifyData.chartName){this.modifyData.chartName='';}
if(!this.modifyData.xUnit){this.modifyData.xUnit='';}
if(!this.modifyData.yUnit){this.modifyData.yUnit='';}
if(!this.modifyData.yMark){this.modifyData.yMark='';}
if(!this.modifyData.yMax){this.modifyData.yMax='';}
if(this.modifyData.yMin||this.modifyData.yMin==0){this.modifyData.yMin=this.modifyData.yMin;}else{this.modifyData.yMin='';}}else{this.modifyData={};}
if(!this.options.dictShowData){this.options.dictShowData={}}
this.dictShowData=this.options.dictShowData;for(var key in this.dictShowData){for(var i=0,len=this.dictShowData[key].length;i<len;i++){this.dictShowData[key][i]=this.fillData(this.dictShowData[key][i]);}}
if(!this.options.dictShowFlag){this.options.dictShowFlag={};}
this.dictShowFlag=this.options.dictShowFlag;_this=this;}
AnlzTendency.prototype=new AnlzBase();AnlzTendency.prototype.optionTemplate={imgName:'anlsTendency.png',imgIndex:0,imgColor:'65,131,189',templateName:'analysis.modalType.TENDENCY',templateParams:{paraName:['X','X2'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent']};AnlzTendency.prototype.show=function(){this.container.innerHTML='';this.initTools();this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();$('#chartModify').hide();$('#btnDataFilter').hide();if(this.container.id==='anlsPane'&&!$(this.container).hasClass('panel-readonly')){$('#chartModify').show();$('#btnDataFilter').show();}
_this.modifyEcharts();$('#modifyChart .row').hide();if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});var temp,wrap;this.paneChart=document.createElement('div');this.paneChart.className='divPaneChart';temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='calc(100% - 170px)';this.paneLegend=document.createElement('div');this.paneLegend.className='divHover';temp=this.paneLegend.style;temp.marginTop='10px';temp.padding='10px';temp.cssFloat='left';temp.width='100%';temp.height='160px';temp.position='relative';this.container.appendChild(this.paneChart);this.container.appendChild(this.paneLegend);if(this.isShareMode===1)$(this.container).addClass('read-mode');temp=null;_this.spinnerRender.spin(this.container.parentElement);this.init();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;var containerChilBox='<div class="containerChi" style=""></div>';$(this.container).prepend(containerChilBox);$('.containerChi').css({width:'100%',height:'calc(100% - 210px)',position:'absolute',top:'20px',left:0});for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],$(this.container).find('.containerChi'),'');}
graph.show();}}};AnlzTendency.prototype.modifyEcharts=function(){var _this=this;var $modifyLayer=$('.modifyLayer');if($modifyLayer.length===0){$modifyLayer=$('<div class="modal fade modifyLayer" style="position:absolute;z-index:151;"><div class="modal-dialog" style="width:65%;"><div class="modal-content">'+'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">'+I18n.resource.modalConfig.editChart.TITLE+'</h4></div>'+'<div class="modal-body">'+'<div width="100%" style="margin-top:20px;"><div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.CHART_NAME+':</span><input type="text" id="changeEchName" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.X_AXIS_UNIT+':</span><input type="text" id="addXUnit" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_UNIT+':</span><input type="text" id="addYUnit" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_SCALE+':</span><input type="text" id="changeYMark" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_MAX+':</span><input type="text" id="changeYMax" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 40px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_MIN+':</span><input type="text" id="changeYMin" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div></div>'+'<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="modifyBtn">'+I18n.resource.modalConfig.editChart.BTN_CONFIRM+'</button></div>'+'</div></div></div>');$(_this.container).parents('#anlsPaneContain').append($modifyLayer);}
$('#chartModify').off('click').click(function(){_this.modifyEcharts();if($modifyLayer.is(':hidden')){$modifyLayer.modal('show');$('#changeEchName')[0].value=_this.modifyData.chartName?_this.modifyData.chartName:'';$('#addXUnit')[0].value=_this.modifyData.xUnit?_this.modifyData.xUnit:'';$('#addYUnit')[0].value=_this.modifyData.yUnit?_this.modifyData.yUnit:'';$('#changeYMark')[0].value=_this.modifyData.yMark?_this.modifyData.yMark:'';$('#changeYMax')[0].value=_this.modifyData.yMax?_this.modifyData.yMax:'';$('#changeYMin')[0].value=(_this.modifyData.yMin===0||_this.modifyData.yMin)?_this.modifyData.yMin:'';}else{$modifyLayer.modal('hide');}});$('#modifyBtn').off('click').click(function(){if($('#addYUnit').val()==null||$('#addYUnit').val()==0||$('#addYUnit').val()==undefined){_this.modifyData.yUnit='';}else{_this.modifyData.yUnit=$('#addYUnit').val();}
if($('#addXUnit').val()==null||$('#addXUnit').val()==0||$('#addXUnit').val()==undefined){_this.modifyData.xUnit='';}else{_this.modifyData.xUnit=$('#addXUnit').val();}
if($('#changeEchName').val()==null||$('#changeEchName').val()==0||$('#changeEchName').val()==undefined){_this.modifyData.chartName='';}else{_this.modifyData.chartName=$('#changeEchName').val();}
if($('#changeYMark').val()==null||$('#changeYMark').val()==0||$('#changeYMark').val()==undefined){_this.modifyData.yMark=null;}else{if(isNaN($('#changeYMark').val())){_this.modifyData.yMark=null;}else{_this.modifyData.yMark=parseInt($('#changeYMark').val());}}
if($('#changeYMax').val()==null||$('#changeYMax').val()==0||$('#changeYMax').val()==undefined){_this.modifyData.yMax=null;}else{if(isNaN($('#changeYMax').val())){_this.modifyData.yMax=null;}else{_this.modifyData.yMax=parseInt($('#changeYMax').val());}}
if($('#changeYMin').val()==null||$('#changeYMin').val()==undefined){_this.modifyData.yMin=null;}else{if(isNaN($('#changeYMin').val())){_this.modifyData.yMin=null;}else{_this.modifyData.yMin=parseInt($('#changeYMin').val());}}
if(parseInt(_this.yMin)>=parseInt(_this.yMax)){_this.modifyData.yMin=0;_this.modifyData.yMax=100;}
_this.saveChartModify();$('.divPage.selected').trigger('click');});},AnlzTendency.prototype.saveChartModify=function(){_this.options.chartOption={chartName:_this.modifyData.chartName?_this.modifyData.chartName:null,xUnit:_this.modifyData.xUnit?_this.modifyData.xUnit:null,yUnit:_this.modifyData.yUnit?_this.modifyData.yUnit:null,yMark:_this.modifyData.yMark?parseInt(_this.modifyData.yMark):null,yMax:_this.modifyData.yMax?parseInt(_this.modifyData.yMax):null,yMin:(_this.modifyData.yMin||_this.modifyData.yMin===0)?parseInt(_this.modifyData.yMin):null}
doSave();function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,false]);}},AnlzTendency.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.dropMaskLayer=null;this.paneLegend=null;this.paneChart=null;this.chart=null;this.dictLegend=null;this.curIndex=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();$('#chartModify').hide();$('#btnDataFilter').hide();$('#modifyChart .row').hide();this.chartName=null;this.xUnit=null;this.yUnit=null;this.yMark=null;this.yMax=null;this.yMin=null;this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzTendency.prototype.init=function(){var _this=this;var itemDSLength=this.options.itemDS?this.options.itemDS.length:0;var arrIdList=[];if(itemDSLength){for(var j=0;j<itemDSLength;j++){var arrDsId=this.options.itemDS[j].arrId;if(arrDsId){for(var i=0,len=arrDsId.length;i<len;i++){var bFind=false;for(var key in this.dictShowFlag){if(key==arrDsId[i]){bFind=true;break;}}
if(!bFind){this.dictShowFlag[arrDsId[i]]=true;}}}}}
arrIdList=arrIdList.concat(this.options.itemDS[0].arrId);arrIdList=this.options.itemDS[1]?arrIdList.concat(this.options.itemDS[1].arrId):arrIdList;AppConfig.datasource.getDSItemData(this,arrIdList);this.paneLegend.ondragenter=function(e){var $ele=$(_this.paneLegend);if($ele.hasClass('dis'))return;$ele.addClass('dragHover');e.stopPropagation();e.preventDefault();};this.paneLegend.ondragleave=function(e){$(_this.paneLegend).removeClass('dragHover');e.stopPropagation();e.preventDefault();};this.paneLegend.ondragover=function(e){e.preventDefault();};this.paneLegend.ondrop=function(e){_this.spinnerRender.spin(_this.container.parentElement);var dsItemId=EventAdapter.getData().dsItemId;var $ele=$(_this.paneLegend);$ele.removeClass('dragHover dis');if(dsItemId){if(Object.prototype.toString.call(dsItemId)==='[object Array]'){var len=dsItemId.length;for(var i=0,len=dsItemId.length;i<len;i++){if($ele.find('[id="lg_'+dsItemId[i]+'"]').length>0){dsItemId.splice(i,1);len=len-1;i=i-1;}}
if(dsItemId.length<1){_this.spinnerStop();}else{AppConfig.datasource.getDSItemData(_this,dsItemId);}}else{if($ele.find('[id="lg_'+dsItemId+'"]').length>0){_this.spinnerStop();return;}
AppConfig.datasource.getDSItemData(_this,[dsItemId]);}}else _this.spinnerStop();}};AnlzTendency.prototype.render=function(data){if(data){this.chart?this.refreshChart(data):this.initChart(data);}
this.spinnerRender.stop();};AnlzTendency.prototype.initChart=function(data){var arrSeries=[],legend=[];var series,item,i,option;for(i=0;i<data.list.length;i++){item=data.list[i];series=this.createSeries(item.dsItemId,item.data);arrSeries.push(series);}
this.showFilterCharts(arrSeries);for(i=0;i<arrSeries.length;i++){legend.push(arrSeries[i].name);}
this.resetShowData(data,0);for(var key in this.dictShowFlag){for(var j=0,lenJ=arrSeries.length;j<lenJ;j++){if(key==arrSeries[j].id){if(!this.dictShowFlag[key]){arrSeries[j].data=[];}
break;}}}
var itemDsList=this.options.itemDS;if(itemDsList[0].arrId&&itemDsList.length>1){if(itemDsList[0].arrId.length>0&&itemDsList[1].arrId.length>0){for(var n=0,len=itemDsList.length;n<len;n++){var item=itemDsList[n];if(item){if(item.type==='X2'){var itemOneArrId=item.arrId;for(var p=0,lenP=itemOneArrId.length;p<lenP;p++){for(var m=0,lenJ=arrSeries.length;m<lenJ;m++){if(itemOneArrId[p]===arrSeries[m].id){arrSeries[m].yAxisIndex=1;}}}}else if(item.type==='X'){continue;}}}}}
option=this.initOption(arrSeries,data.timeShaft);if(this.isShareMode===1)option.legend={data:legend};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(option);};AnlzTendency.prototype.initOption=function(series,timeSHaft){var i18nEcharts=I18n.resource.echarts;var option={formatTime:false,tooltip:{trigger:'axis'},grid:{x:60,x2:60,y:60,y2:70,borderColor:'#eee'},toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:true,dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,data:timeSHaft,axisLabel:{formatter:function(d){return new Date(d).format(echarts.formatTimePattern);}}}],yAxis:[{type:'value',scale:true,axisLabel:{formatter:function(value){var ret;if(value<1000){ret=value;}
else if(value<1000000){ret=value/1000+'k';}
else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0.8}}}],series:series,animation:this.animation,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};if(this.modifyData&&this.modifyData.chartName){option.title={text:this.modifyData.chartName};}
if(this.modifyData&&this.modifyData.xUnit){option.xAxis[0].name=this.modifyData.xUnit;option.xAxis[0].nameLocation='start';}
if(this.modifyData&&this.modifyData.yUnit){option.yAxis[0].name=this.modifyData.yUnit;}
if(this.modifyData&&this.modifyData.yMax){option.yAxis[0].max=this.modifyData.yMax;}
if(this.modifyData&&this.modifyData.yMin!==null&&this.modifyData.yMin!==''){option.yAxis[0].min=this.modifyData.yMin;}
if(this.modifyData&&this.modifyData.yMark){option.yAxis[0].splitNumber=(this.modifyData.yMax-this.modifyData.yMin)/this.modifyData.yMark;}
this.options.xAxisData=option.xAxis[0].data;var itemDsList=this.options.itemDS;if(itemDsList.length>1){if(itemDsList[0].arrId.length>0&&itemDsList[1].arrId.length>0){var yAxisTwo={type:'value',scale:true,axisLabel:{formatter:function(value){var ret;if(value<1000){ret=value;}
else if(value<1000000){ret=value/1000+'k';}
else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0}}}
option.yAxis.push(yAxisTwo);}else{var isRight=0;for(var i=0;i<itemDsList.length;i++){var item=itemDsList[i]
if(item.type==='X2'&&item.arrId.length>0){isRight+=1;}else if(item.type==='X'&&item.arrId.length<=0){isRight+=1;}}
if(isRight===2){option.yAxis[0].position='right';}}}
return option;};AnlzTendency.prototype.refreshChart=function(data){for(var i=0,len=data.list.length;i<len;i++){var item=data.list[i];if(this.dictLegend[item.dsItemId])return;this.resetShowData(data,0);this.dictShowFlag[item.dsItemId]=true;var tempOption=this.chart.getOption();if(tempOption.xAxis[0].data.length===0&&data.timeShaft.length>0){tempOption.xAxis[0].data=data.timeShaft;this.timeShift=data.timeShaft;}
var arrTemp=tempOption.series;arrTemp.push(this.createSeries(item.dsItemId,item.data));this.chart.setOption(tempOption);arrTemp=null;this.options.itemDS[0].arrId.push(item.dsItemId);var _this=this;this.screen.saveModal();}};AnlzTendency.prototype.createSeries=function(id,data,type){if(!type)type=this.legendType.NORMAL;var name,len;if(type==this.legendType.NORMAL){name=AppConfig.datasource.getDSItemById(id).alias;}
else{name=id.split('_');name=AppConfig.datasource.getDSItemById(name[0]).alias+'_'+id[1];}
this.options.dataList[name]=data;len=echarts.config.color.length;var color=echarts.config.color[this.curIndex%len];this.curIndex++;var div=this.renderLegend(id,name,type,color);var tipInf=this.getStatisticsInfo(data);if(Boolean(tipInf)){this.initTendencyTips($(div),tipInf.max,tipInf.min,tipInf.avg,tipInf.sum);}
return{id:id,name:name,type:'line',symbol:'none',data:data,itemStyle:{normal:{color:color}}}};AnlzTendency.prototype.refreshChartFilter=function(data,condition,series){var item=data.list[0];if(this.dictLegend[item.dsItemId])return;var newFilterId=item.dsItemId+'_filter';var bFilterFind=false;for(var i=0,len=series.length;i<len;i++){if(newFilterId==series[i].id){bFilterFind=true;break;}}
if(bFilterFind){series[i].data=item.data;var $div=$('#lg_'+newFilterId);var tipTmp=$div.data('bs.tooltip');if(!tipTmp){return;}
var tip=tipTmp.$tip;if(tip){var tipInf=this.getStatisticsInfo(item.data);tip.find('.filterMax').text(I18n.resource.observer.widgets.MAXIMUM+': '+tipInf.max);tip.find('.filterMin').text(I18n.resource.observer.widgets.MINIMUM+': '+tipInf.min);tip.find('.filterAvg').text(I18n.resource.observer.widgets.AVERAGE+': '+tipInf.avg);tip.find('.filterSum').text(I18n.resource.observer.widgets.TOTAL_AMOUNT+': '+tipInf.sum);tip.find('.filterCondition').text(I18n.resource.observer.widgets.FILTER_FORMULA+': '+condition);}
var appendId=item.dsItemId+'_append';var arrAppend=[];for(var i=0,len=series.length;i<len;i++){if(appendId==series[i].id){arrAppend.push(i);}}
if(arrAppend.length>0){for(var j=0,len2=arrAppend.length;j<len2;j++){series.splice(arrAppend[j],1);}}}
else{series.unshift(this.createSeriesFilter(item.dsItemId,item.data,newFilterId,condition));}
this.spinnerRender.stop();};AnlzTendency.prototype.createSeriesFilter=function(id,data,newId,condition){var name,len;name=AppConfig.datasource.getDSItemById(id).alias+'_filter';len=echarts.config.color.length;var color=echarts.config.color[this.curIndex%len];this.curIndex++;var div=this.renderLegend(newId,name,0,color);var tipInf=this.getStatisticsInfo(data);if(Boolean(tipInf)){this.initTendencyTipsFilter($(div),tipInf.max,tipInf.min,tipInf.avg,tipInf.sum,condition);}
return{id:newId,name:name,type:'line',symbol:'none',data:data,itemStyle:{normal:{lineStyle:{color:color}}}}};AnlzTendency.prototype.removeSeries=function(id){var _this=this;delete this.dictLegend[id];$('#lg_'+id).remove();var option=this.chart.getOption();var arrSeries=option.series;for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].id==id){arrSeries.splice(i,1);break;}}
var arrIds=this.options.itemDS[0].arrId;for(var i=0;i<arrIds.length;i++){if(arrIds[i]==id){arrIds.splice(i,1);}}
this.options.itemDS[0].arrId=arrIds;var nIdx=id.indexOf('_filter');if(-1!=nIdx){var origId=id.substr(0,nIdx);var arrFilter=this.options.arrFilter;if(arrFilter){for(var i=0,len=arrFilter.length;i<len;i++){if(origId==arrFilter[i].pointId){arrFilter.splice(i,1);break;}}}}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,option.xAxis[0].data));window.setTimeout(function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,true]);},500);};AnlzTendency.prototype.getDataById=function(id){var arrSeries=this.chart.getOption().series;for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].id==id){return arrSeries[i].data;}}};AnlzTendency.prototype.renderLegend=function(id,name,type,color){var _this=this;var name=name;var div=document.createElement("div");var closeBtn='<button type="button" class="close"><span>&times;</span></button>';var btnShow;if(this.dictShowFlag[id]){btnShow='<span class="glyphicon glyphicon-eye-open btnShow" aria-hidden="true"></span>';}
else{btnShow='<span class="glyphicon glyphicon-eye-close btnShow" aria-hidden="true"></span>';}
div.id='lg_'+id;div.dataset.id=id;div.className="divLegend";div.draggable=true;div.style.backgroundColor=color;div.setAttribute('ty',type);switch(type){case this.legendType.Regression:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split('_Regression_')[0]+"_Regression</div>"+btnShow+closeBtn;this.initGeneralRegressorTooltip(id,div);};break;case this.legendType.Prediction:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split('_Prediction_')[0]+"_Prediction</div>"+btnShow+closeBtn;this.initGeneralPredictorTooltip(id,div);};break;default:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-stats' style='margin-right: 10px;'></span>"+name+'</div>'+btnShow+closeBtn;};break}
div.getElementsByClassName('close')[0].onclick=function(e){var $ele=$(e.currentTarget).parent();var id=$ele[0].dataset.id;if($('.divLegend').length>1){var option=_this.chart.getOption();if(option){var arrSeries=option.series;if(arrSeries){var cnt=0;for(var key in _this.options.dataList)cnt++;if(cnt<=1){alert('The only parameters can\'t be removed');return;}}}
var doct=$ele.eq(0).find('.divTxtWrap').text();delete _this.options.dataList[doct];$ele.tooltip('destroy');_this.removeSeries(id);var cnt=id.indexOf('_filter');if(-1!=cnt){var preId=id.substr(0,cnt);if(preId){_this.removeSeries(preId+'_append');}}}else{alert('The only parameters can\'t be removed');}
e.stopPropagation();};div.getElementsByClassName('btnShow')[0].onclick=function(e){var $ele=$(e.currentTarget).parent();var id=$ele[0].dataset.id;_this.switchSeries(id);e.stopPropagation();};div.ondragstart=function(e){$(_this.paneLegend).addClass('dis');e.dataTransfer.effectAllowed="move";e.dataTransfer.setData("id",e.currentTarget.dataset.id);e.dataTransfer.setData("source","legend");};div.ondragenter=function(e){e.preventDefault();e.stopPropagation();};div.ondragover=function(e){e.preventDefault();e.stopPropagation();};div.ondrop=function(e){var srcId=e.dataTransfer.getData('id');var toId=e.currentTarget.dataset.id;$(_this.paneLegend).removeClass('dis');e.stopPropagation();if(srcId===''||srcId===toId)return;var source=e.dataTransfer.getData("source");if(source&&source=="legend"){if(e.currentTarget.getAttribute('ty')==_this.legendType.Regression)
generatePredictor(e,srcId,toId);else
generateRegressor(e,srcId,toId);}
function generateRegressor(e,sourceId,targetId){var data={source:[_this.getDataById(sourceId).map(function(row,i){return row+'';})],target:_this.getDataById(targetId).map(function(row,i){return row+'';}),sourceNames:sourceId,targetName:targetId};_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/generalRegressor',data).done(function(data){var id=targetId+"_Regression_"+(+new Date());var tempOption=_this.chart.getOption();var arrTemp=tempOption.series;data.SourceId=sourceId;data.TargetId=targetId;_this.dictTooltip[id]=data;arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Regression));_this.chart.setOption(tempOption);arrTemp=null;_this.spinnerRender.stop();}).error(function(result){_this.spinnerRender.stop();});}
function generatePredictor(e,sourceId,targetId){var arrCoefficient=_this.dictTooltip[e.currentTarget.dataset.id].Coefficients;for(var i=0;i<arrCoefficient.length;i++)arrCoefficient[i]=arrCoefficient[i].toString();var data={source:[_this.getDataById(sourceId).map(function(row,i){return row+'';})],Coefficients:arrCoefficient};_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/generalPredictor',data).done(function(data){var id=targetId.split('_')[0]+"_Prediction_"+(+new Date());var tempOption=_this.chart.getOption();var arrTemp=tempOption.series;if(data.PredicatedResults){arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Prediction));_this.chart.setOption(tempOption);}
_this.spinnerRender.stop();}).error(function(result){_this.spinnerRender.stop();});}}
this.paneLegend.appendChild(div);return div;};AnlzTendency.prototype.initGeneralRegressorTooltip=function(id,element){var data=this.dictTooltip[id];var arrId=[];arrId.push(data.SourceId);arrId.push(data.TargetId);var arrItem=[];arrItem=AppConfig.datasource.getDSItemById(arrId);var srcAlias,tarAlias;for(var m=0;m<arrItem.length;m++){if(data.SourceId==arrItem[m].id){srcAlias=arrItem[m].alias;}
if(data.TargetId==arrItem[m].id){tarAlias=arrItem[m].alias;}}
var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip" style="position: fixed;">');sb.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">RSquared: ').append(data.RSquared).append('</p> ');sb.append('        <p>Formula: </p><p style="margin-left: 20px; white-space:nowrap;">').append(data.Formula).append('</p> ');sb.append('        <p style="margin-left: 20px; white-space:nowrap;">x: ').append(srcAlias).append('</p>');sb.append('        <p style="margin-left: 20px; white-space:nowrap;">y: ').append(tarAlias).append('</p>');sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={placement:'top',title:'GeneralRegressor',template:sb.toString()};$(element).tooltip(options);};AnlzTendency.prototype.initGeneralPredictorTooltip=function(id,element){var data=this.dictTooltip[id];var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip" style="position: fixed;">');sb.append('    <div class="tooltipTitle tooltip-inner">GeneralPredictor</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">Source: ').append(AppConfig.datasource.getDSItemById(id.split('_')[0]).alias).append('</p> ');sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={placement:'top',title:'GeneralPredictor',template:sb.toString()};$(element).tooltip(options);};AnlzTendency.prototype.initTendencyTips=function(parent,max,min,avg,sum){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">Statistics</div>');show.append('    <div class="tooltipContent">');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MAXIMUM).append('</span>: ').append(max).append('</p>');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MINIMUM).append('</span>: ').append(min).append('</p> ');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.AVERAGE).append('</span>: ').append(avg).append('</p> ');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.TOTAL_AMOUNT).append('</span>: ').append(sum).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'top',title:I18n.resource.observer.widgets.PARAMETER,template:show.toString()};parent.tooltip(options);};AnlzTendency.prototype.initTendencyTipsFilter=function(parent,max,min,avg,sum,condition){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">Statistics</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="filterMax" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MAXIMUM).append('</span>: ').append(max).append('</p>');show.append('        <p class="filterMin" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MINIMUM).append('</span>: ').append(min).append('</p> ');show.append('        <p class="filterAvg" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.AVERAGE).append('</span>: ').append(avg).append('</p> ');show.append('        <p class="filterSum" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.TOTAL_AMOUNT).append('</span>: ').append(sum).append('</p> ');show.append('        <p class="filterCondition" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.FILTER_FORMULA).append('</span>: ').append(condition).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'top',title:I18n.resource.observer.widgets.PARAMETER,template:show.toString()};parent.tooltip(options);};AnlzTendency.prototype.getStatisticsInfo=function(data){if(!data||data.length<=0){return{'max':0,'min':0,'avg':0,'sum':0};}
var max=0;var min=0;for(var i=0,len=data.length;i<len;i++){if(data[i]){max=data[i];min=data[i];break;}}
var avg=0;var sum=0;var flag=2;var len=data.length;var lenAct=len;if('h1'==this.timeType||'d1'==this.timeType||'M1'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
sum+=data[i];}}
else if('m5'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
if(0==i%12){sum+=data[i];}}}
else if('m1'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
if(0==i%60){sum+=data[i];}}}
else{return null;}
avg=sum/lenAct;return{'max':max,'min':min,'avg':avg.toFixed(flag),'sum':sum.toFixed(flag)};};AnlzTendency.prototype.showFilterCharts=function(series){if(!series){series=this.chart.getOption().series;}
if(this.options.arrFilter){for(var i=0,len=this.options.arrFilter.length;i<len;i++){var item=this.options.arrFilter[i];for(var j=0,len2=item.appendData.length;j<len2;j++){if(!item.appendData[j]){item.appendData[j]=undefined;}}
for(var k=0,len3=item.filterDrawObj.list[0].data.length;k<len3;k++){if(!item.filterDrawObj.list[0].data[k]){item.filterDrawObj.list[0].data[k]=undefined;}}
if(item.filterDrawObj){this.refreshChartFilter(item.filterDrawObj,item.filterCondition,series);}
if(0==item.showType){this.removeAppendCharts(item,series);}
else{this.setAppendCharts(item,series);}}}};AnlzTendency.prototype.setAppendCharts=function(itemFilter,series){var colorShow;var id=itemFilter.pointId;var idLen=id.length;var bFind=false;for(var i=0,len=series.length;i<len;i++){var tempLen=series[i].id.length;var tempEx=(tempLen>idLen)?(series[i].id.substr(idLen,tempLen-idLen)):('');if(series[i].id.substr(0,idLen)==id&&'_filter'==tempEx){bFind=true;break;}}
if(bFind){var itemAppend={id:itemFilter.pointId+'_append',name:'',type:'line',symbol:'none',data:itemFilter.appendData,smooth:false,itemStyle:{normal:{lineStyle:{width:3,type:'dotted'}}}}
series.push(itemAppend);}};AnlzTendency.prototype.removeAppendCharts=function(itemFilter,series){var id=itemFilter.pointId;var idLen=id.length;var bFind=false;for(var i=0,len=series.length;i<len;i++){var tempLen=series[i].id.length;var tempEx=(tempLen>idLen)?(series[i].id.substr(idLen,tempLen-idLen)):('');if(series[i].id.substr(0,idLen)==id&&'_append'==tempEx){bFind=true;series.splice(i,1);break;}}};AnlzTendency.prototype.switchSeries=function(id){var option=this.chart.getOption();if(!option){return;}
var arrSeries=option.series;if(!arrSeries){return;}
var cnt=0;var flag=false;for(var i=0;i<arrSeries.length;i++){if(-1!=arrSeries[i].id.indexOf('_append')){continue;}
if(arrSeries[i].data.length>0){cnt++;}
if(arrSeries[i].id==id&&arrSeries[i].data.length>0){flag=true;}}
if(cnt<=1&&flag){alert('The only parameters can\'t be removed');return;}
var spanPic=$('#lg_'+id).children('.btnShow');if(spanPic){var bIsExist=false;for(var key in this.dictShowFlag){if(id==key){bIsExist=true;break;}}
if(!bIsExist){return;}
var bIsShow=!this.dictShowFlag[id];this.dictShowFlag[id]=bIsShow;if(bIsShow){spanPic.attr('class','glyphicon glyphicon-eye-open btnShow');}
else{spanPic.attr('class','glyphicon glyphicon-eye-close btnShow');}
for(var i=0,len=arrSeries.length;i<len;i++){if(arrSeries[i].id==id){if(bIsShow){arrSeries[i].data=this.dictShowData[id];}
else{arrSeries[i].data=[];}
break;}}
var appendId='';var nIdx=id.indexOf('_filter');if(-1!=nIdx){appendId=id.substr(0,nIdx)+'_append';for(var i=0,len=arrSeries.length;i<len;i++){if(arrSeries[i].id==appendId){if(bIsShow){arrSeries[i].data=this.dictShowData[appendId];}
else{arrSeries[i].data=[];}
break;}}}}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,option.xAxis[0].data));window.setTimeout(function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.options,true]);},500);};AnlzTendency.prototype.setTendencyOption=function(series){if(!series){series=this.chart.getOption().series;}
var opt=this.chart.getOption();opt.series=series;this.chart.clear();this.chart.setOption(opt);};AnlzTendency.prototype.resetIcon=function(arrCloseId){if(!arrCloseId){return;}
var legend=$('.divHover').find('.divLegend');if(legend){for(var i=0,lenI=legend.length;i<lenI;i++){var bFind=false;for(var j=0,lenJ=arrCloseId.length;j<lenJ;j++){if('lg_'+arrCloseId[j]==legend[i].id){bFind=true;break;}}
if(bFind){var icon=legend.eq(i).children('.btnShow');if(icon){icon.attr('class','glyphicon glyphicon-eye-close btnShow');}}}}};AnlzTendency.prototype.resetShowData=function(data,nFlag){if(!data){return;}
var list=data.list;if(list){var nLenTime=data.timeShaft.length;if(0==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId]=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId][j]=this.fillData(list[i].data[j]);}}}
else if(1==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId+'_filter']=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId+'_filter'][j]=this.fillData(list[i].data[j]);}}}
else if(2==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId+'_append']=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId+'_append'][j]=this.fillData(list[i].data[j]);}}}}};AnlzTendency.prototype.fillData=function(data){if(!data&&0!=data){data=undefined;}
return data;};AnlzTendency.prototype.getExistDsData=function(arrSrc){var arrPoints=AppConfig.datasource.m_allPointList;if(arrPoints.length<=0){return arrSrc;}
var arrRet=[];if(!arrSrc||arrSrc.length<=0||!arrPoints||arrPoints.length<=0){return arrRet;}
for(var i=0,len=arrSrc.length;i<len;i++){for(var j=0,len2=arrPoints.length;j<len2;j++){if(arrSrc[i]==arrPoints[j].itemId){arrRet.push(arrSrc[i]);break;}}}
return arrRet;};return AnlzTendency;})();﻿var AnlzStack=(function(){var _this;function AnlzStack(container,option,screen){AnlzBase.call(this,container,option,screen);this.screen=screen;_this=this;this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzStack.prototype=new AnlzBase();AnlzStack.prototype.optionTemplate={imgName:'anlsStack.png',imgIndex:4,imgColor:'148,193,142',templateName:'analysis.modalType.STACK',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzStack.prototype.show=function(){this.initTools();this.container.innerHTML='';var temp;this.paneChart=document.createElement('div');temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='100%';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
this.container.appendChild(this.paneChart);this.spinnerRender.spin(this.container.parentElement);this.init();if(!this.options.noteList){this.options.noteList=[];}else{_this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});};AnlzStack.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzStack.prototype.init=function(){var _this=this;AppConfig.datasource.getDSItemData(this,this.options.itemDS[0].arrId);};AnlzStack.prototype.render=function(data){this.initChart(data);var _this=this;};AnlzStack.prototype.initChart=function(data){var arrSeries=[];var arrLengend=[];this.options.xAxisData=data.timeShaft;for(var i=0;i<data.list.length;i++){var item=data.list[i];arrSeries.push(this.createSeries(item.dsItemId,item.data));arrLengend.push(arrSeries[i].name);this.options.dataList[arrSeries[i].name]=item.data;}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme);this.chart.setOption(this.initOption(arrSeries,arrLengend,data.timeShaft));};AnlzStack.prototype.initOption=function(series,arrLengend,timeSHaft){var i18nEcharts=I18n.resource.echarts;return{tooltip:{trigger:'axis'},legend:{data:arrLengend},grid:{x:60,x2:20,y:60,borderColor:'#eee'},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar','stack','tiled'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR,stack:i18nEcharts.STACK,tiled:i18nEcharts.TILED}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:true,dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,data:timeSHaft}],yAxis:[{type:'value',scale:true}],series:series,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};};AnlzStack.prototype.createSeries=function(id,data,type){return{id:id,name:AppConfig.datasource.getDSItemById(id).alias,type:'line',smooth:true,itemStyle:{normal:{areaStyle:{type:'default'}}},symbol:'none',stack:I18n.resource.observer.analysis.TOTAL_AMOUNT,data:data}};return AnlzStack;})();﻿var AnlzCluster=(function(){function AnlzCluster(container,option,screen){AnlzBase.call(this,container,option,screen);this.m_panelTrend=undefined;this.m_panelScatter=undefined;}
AnlzCluster.prototype=new AnlzBase();AnlzCluster.prototype.optionTemplate={imgName:'anlsPattern.png',imgIndex:6,imgColor:'65,131,189',templateName:'analysis.modalType.CLUSTER',templateParams:{paraName:['X'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:''};AnlzCluster.prototype.show=function(){var _this=this;this.initTools();this.container.innerHTML='';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{var graphList=this.screen.curModal.graphList;var graph=undefined;for(var i=0;i<graphList.length;i++){if(graphList[i].type=='arrow'){graph=new DrawArrow(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='rect'){graph=new DrawRect(_this.screen,graphList[i],this.container,'');}else if(graphList[i].type=='circle'){graph=new DrawCircle(_this.screen,graphList[i],this.container,'');}
graph.show();}}
if(!this.options.noteList){this.options.noteList=[];}else{this.initNotes(this.options.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});$(this.container).append($('<div style="width: 100%; height: 450px;">\
                <ul class="nav nav-tabs" role="tablist" id="myTab">\
                    <li role="presentation" class="active">\
                        <a id="aTendency" href="#tabTendency" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TREND_DISTRIBUTE"></span></a>\
                    </li>\
                    <li role="presentation">\
                        <a id="aScatter" href="#tabScatter" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TYPE_POINT"></span></a>\
                    </li>\
                </ul>\
                <div class="tab-content">\
                    <div role="tabpanel" class="tab-pane fade in active" id="tabTendency" style="height: 400px;"></div>\
                    <div role="tabpanel" class="tab-pane fade" id="tabScatter" style="height: 400px;"></div>\
                </div>\
             </div>\
             <div class="panel panel-default" style="position: absolute; height: calc(100% - 450px); top: 450px; left: 0; right: 0;">\
                 <div class="panel-heading"><span i18n="analysis.paneConfig.TYPICAL_CONDITION"></span></div>\
                 <div class="panel-body" style="padding: 0; height: calc(100% - 40px); overflow-y: auto;">\
                     <table class="table" id="tableGroup" style="overflow-x: auto;"></table>\
                 </div>\
             </div>'));I18n.fillArea($(this.container));_this.spinnerRender.spin(this.container.parentElement);this.init();}
AnlzCluster.prototype.close=function(){this.spinnerRender.stop();this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();$('#graphBox').hide();}
AnlzCluster.prototype.init=function(){var _this=this;var arrIds=[];var arrType=[];var arrDSItems=this.options.itemDS;for(var i=0;i<arrDSItems.length;i++){var arrTemp=arrDSItems[i].arrId;if(arrTemp&&arrTemp.length>0){arrIds=arrIds.concat(arrTemp);arrType.push(this.optionTemplate.templateParams.paraName[i]);}}
var timeConfig;if(this.options.timeRecent){timeConfig=generateTimeOption(this.options)}else{timeConfig=this.options}
var postData={dsItemIds:arrIds,timeStart:new Date(timeConfig.startTime).format('yyyy-MM-dd HH:mm:ss'),timeEnd:new Date(timeConfig.endTime).format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeConfig.format,pointType:arrType,systemType:this.optionTemplate.type};WebAPI.post('/analysis/startWorkspaceDataGenCluster',postData).done(function(data){if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});},AnlzCluster.prototype.render=function(data){var _this=this;this.initTable(data);this.initTendency(data);$('#aScatter').on('shown.bs.tab',function(e){if($("#tabScatter div").length==0){_this.initScatter(data);}});_this.spinnerStop();$('#btnDownLoadExcel').hide();};AnlzCluster.prototype.initTable=function(data){var table=$("#tableGroup");table.html("");$('#btnDownLoadExcel').hide();var tbody=document.createElement("tbody");var tr,td,divLegend,details;if(!data.dataAnalysisResult.Pattern)return;for(var i=0;i<data.dataAnalysisResult.Pattern.length;i++){details=data.dataAnalysisResult.Pattern[i].Diagnosis;tr=document.createElement("tr");td=document.createElement("td");td.rowSpan=details?details.length:1;divLegend=document.createElement("span");divLegend.textContent="Group "+data.dataAnalysisResult.Pattern[i].name;divLegend.className='label label-warning';divLegend.style.padding='3px';divLegend.style.backgroundColor=echarts.config.color[i];td.appendChild(divLegend);tr.appendChild(td);td=document.createElement('td');if(details)td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[0].name+'</span>'+details[0].detail;tr.appendChild(td);tbody.appendChild(tr);if(details&&details.length>1){for(var j=1;j<details.length;j++){tr=document.createElement("tr");td=document.createElement("td");td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[j].name+'</span>'+details[j].detail;tr.appendChild(td);tbody.appendChild(tr);}}}
$("#tableGroup").append(tbody);};AnlzCluster.prototype.initTendency=function(data){var arrSeries=new Array();var arrLegend=new Array();for(var i=0;i<data.dataAnalysisResult.Pattern.length;i++){var item=data.dataAnalysisResult.Pattern[i]
arrLegend.push(item.name);arrSeries.push({name:item.name,type:'line',stack:'总量',itemStyle:{normal:{areaStyle:{type:'default'}}},data:item.TrendValue});}
var i18nEcharts=I18n.resource.echarts;var option={tooltip:{trigger:'axis'},legend:{data:arrLegend},toolbox:{show:true,feature:{magicType:{show:true,type:['line','bar','stack','tiled'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR,stack:i18nEcharts.STACK,tiled:i18nEcharts.TILED}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,xAxis:[{type:'category',boundaryGap:false,data:data.dataAnalysisResult.Pattern[0].TrendLabel}],yAxis:[{min:0,max:100,type:'value'}],series:arrSeries,animationDuration:this.chartAnimationDuration};this.m_panelTrend=echarts.init(document.getElementById("tabTendency"),AppConfig.chartTheme);this.m_panelTrend.setOption(option);this.chart=this.m_panelTrend;};AnlzCluster.prototype.initScatter=function(data){var series=new Array();var seriesNames=new Array();for(var i=0,item,name,arrData,len=data.dataAnalysisResult.ScatterChart.length;i<len;i++){item=data.dataAnalysisResult.ScatterChart[i];name=item.name[0];arrData=new Array();for(var j=0,itemPoint;j<item.data.length;j++){itemPoint=item.data[j];arrData.push(itemPoint.split(','));}
seriesNames.push(name);series.push({name:name,type:'scatter',symbolSize:5,data:arrData});}
var i18nEcharts=I18n.resource.echarts;var option={title:{},tooltip:{trigger:'item',formatter:function(params){return params.seriesName+'<br/>'
+params.value[0]+', '+params.value[1];}},toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},legend:{data:seriesNames},xAxis:[{type:'value',scale:true}],yAxis:[{type:'value',scale:true}],animation:true,series:series,animationDuration:this.chartAnimationDuration};var myChart=echarts.init(document.getElementById("tabScatter"),AppConfig.chartTheme);myChart.setOption(option);};return AnlzCluster;})();var AnlzCluster_AHU=(function(){function AnlzCluster_AHU(container,option,screen){AnlzCluster.call(this,container,option,screen);}
AnlzCluster_AHU.prototype=new AnlzCluster();AnlzCluster_AHU.prototype.optionTemplate={imgName:'anlsClusterAhu.png',imgIndex:7,imgColor:'148,193,142',templateName:'analysis.modalType.CLUSTER_AHU',templateParams:{paraName:['MATemp','SATemp','RACO2','OATemp','RATemp','RATempSetting','SATempSetting','RACO2Setting','HWTemp','CWTemp','OperationMode','OADamperRatio','HCDamperRatio','CCDamperRatio','SAStaticPressure','SAStaticPressureSetting','FanVSDFrequency','CWRetrunTemp'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:'AHU'};return AnlzCluster_AHU;})();var AnlzCluster_Chiller=(function(){function AnlzCluster_Chiller(container,option,screen){AnlzCluster.call(this,container,option,screen);}
AnlzCluster_Chiller.prototype=new AnlzCluster();AnlzCluster_Chiller.prototype.optionTemplate={imgName:'anlsClusterChiller.png',imgIndex:8,imgColor:'211,97,78',templateName:'analysis.modalType.CLUSTER_CHILLER',templateParams:{paraName:['OADryTemp','OAWetBulbTemp','AmperRatio','ChwSupplyTemp','ChwReturnTemp','CwReturnTemp','CwSupplyTemp','EvpTemp','CondTemp'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:'Chiller'};return AnlzCluster_Chiller;})();﻿var AnlzEnergy=(function(){function AnlzEnergy(container,option,screen){AnlzBase.call(this,container,option,screen);this.options.xAxisData=this.options.xAxisData?this.options.xAxisData:[];this.options.dataList={};}
AnlzEnergy.prototype=new AnlzBase();AnlzEnergy.prototype.optionTemplate={imgName:'anlsEnergy.png',imgIndex:9,imgColor:'65,131,189',templateName:'analysis.modalType.ENERGY',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzEnergy.prototype.init=function(){AppConfig.datasource.getDSItemData(this,this.options.itemDS[0].arrId);};AnlzEnergy.prototype.getDefaultOption=function(){var i18nEcharts=I18n.resource.echarts;return{tooltip:{trigger:'axis'},toolbox:{show:true,feature:{dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE,backgroundColor:(AppConfig.chartTheme==theme.Dark?'#192234':'#fafbfc')}}},calculable:false,dataZoom:{show:false},grid:{"x":70,"x2":10,"y2":24},xAxis:[{type:'category',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}]};}
AnlzEnergy.prototype.render=function(dataSrc){var _this=this;if(undefined==dataSrc||dataSrc.length<=0||undefined==dataSrc.timeShaft||dataSrc.timeShaft.length<=0){_this.screen.saveModalJudge.rejectWith(_this.screen,[_this.screen]);alert('No data')
return;}
var xAxis;var arrXAxis=[];var len=dataSrc.timeShaft.length;for(var i=0;i<len;i++){arrXAxis.push(dataSrc.timeShaft[i]);}
xAxis=[{type:'category',data:arrXAxis}]
this.options.xAxisData=arrXAxis;var dataName=[];var arrSeries=[];var showColor;len=dataSrc.list.length;var arrId=[];var arrItem=[];for(var i=0;i<len;i++){arrId.push(dataSrc.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<len;i++){showColor=echarts.config.color[i];for(var m=0;m<arrItem.length;m++){if(dataSrc.list[i].dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;dataName.push(itemName);var arrData=[];var len2=dataSrc.list[i].data.length;var defVal;for(var j=1;j<len2;j++){defVal=dataSrc.list[i].data[j]-dataSrc.list[i].data[j-1];arrData.push(parseFloat(defVal.toFixed(1)));}
this.options.dataList[itemName]=arrData;arrSeries.push({name:dataName[i],type:'bar',data:arrData,markPoint:{data:[{type:'max',name:'最大值'},{type:'min',name:'最小值'}]},itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,5,5]},emphasis:{color:showColor,barBorderRadius:[5,5,5,5]}}});break;}}}
dataOption={title:{text:'',subtext:''},legend:{data:dataName},dataZoom:{show:false},grid:{"x":70,"x2":10,"y2":24},xAxis:xAxis,series:arrSeries};_this.chart=echarts.init(_this.paneChart,AppConfig.chartTheme);_this.chart.setOption($.extend(true,{},_this.getDefaultOption(),dataOption));}
return AnlzEnergy;})();(function($){function ModalDBHistory(){this.options=undefined;this.modal=null;this.refChart=null;this.$wrap=null;this.showOptions={};}
ModalDBHistory.prototype.show=function(){var _this=this;var domPanelContent=document.getElementById('paneCenter');if(!this.modal)return;this.options=getDefaultOption();if(this.$wrap){this.$wrap.appendTo(document.body);this.initCustomShow();return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalDBHistory.html').done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-db-history-wrap" id="modalDBHistoryWrap">').appendTo(document.body).html(html);_this.$modal=_this.$wrap.children('.modal');I18n.fillArea(_this.$wrap);_this.init();_this.initCustomShow();});};ModalDBHistory.prototype.displayCustomShow=function(options){if(!options)return;this.$selMode.val(options.mode);this.$selMode.trigger('change');if(options.mode==='fast'){this.$selTimerange.val(options.timeRange);}else{this.$selInterval.val(options.timeFmt);this.$selInterval.trigger('change');this.$iptTimeStart.val(options.startTimeStr);this.$iptTimeEnd.val(options.endTimeStr);}
this.$modal.modal('show');};ModalDBHistory.prototype.initCustomShow=function(){var showOptions=this.showOptions;var now;if(this.modal.type==="ModalMultiple"){now=new Date();showOptions.mode='custom';showOptions.timeFmt='h1';showOptions.startTimeStr=function(){return new Date(now.valueOf()-360000000).format('yyyy-MM-dd HH:00');}.call(this);showOptions.endTimeStr=function(){return now.format('yyyy-MM-dd HH:00');}.call(this);}else{showOptions=this.showOptions={mode:'fast',timeRange:'day'};}
this.displayCustomShow(showOptions);};ModalDBHistory.prototype.getOptionsByType=function(data){var options=[];if(this.modal.type==='ModalMultiple'){options=function(){var series=[];var legend=[];var typeMap={};var paraType=this.modal.option.paraType||[];var usedDsNameMap={};paraType.forEach(function(row){if(!row.arrId||!row.arrId.length)return;row.arrId.forEach(function(dsId){if(typeMap[dsId]===undefined){typeMap[dsId]=[row.type];}else{typeMap[dsId].push(row.type);}});});var arrId=[];var arrItem=[];data.list.forEach(function(row){var dsId=row.dsItemId;if(dsId){arrId.push(dsId);}});arrItem=AppConfig.datasource.getDSItemById(arrId);data.list.forEach(function(row){var type=typeMap[row.dsItemId].shift();var dsId=row.dsItemId;var name;for(var i=0,len=arrItem.length;i<len;i++){if(dsId==arrItem[i].id){name=arrItem[i].alias;usedDsNameMap[dsId]=usedDsNameMap[dsId]||0;usedDsNameMap[dsId]+=1;if(usedDsNameMap[dsId]>1){name=name+'_'+usedDsNameMap[dsId];}
legend.push(name);switch(type){case'line':series.push({name:name,type:'line',symbol:'none',data:row.data,yAxisIndex:1,z:4});break;case'bar':series.push({name:name,type:'bar',symbol:'none',data:row.data,yAxisIndex:0});break;case'area':series.push({name:name,type:'line',itemStyle:{normal:{areaStyle:{type:'default'}}},symbol:'none',data:row.data,yAxisIndex:0,z:3});break;case'cumulativeBar':series.push({name:name,type:'bar',stack:'realtime total',symbol:'none',data:row.data,yAxisIndex:0});break;default:break;}
break;}}});return{series:series,legend:{data:legend},yAxis:[{type:'value',scale:false,splitArea:{show:false}},{type:'value',scale:false,splitArea:{show:false}}]};}.call(this);}else{options=function(){var series=[];var legend=[];var usedDsNameMap={};data.list=data.list.filter(function(row,i){if((!row.data||!row.data.length)&&this.modal.type==='ModalNote'){return false;}
var dsId=row.dsItemId;var name=AppConfig.datasource.getDSItemById(dsId).alias||dsId;usedDsNameMap[dsId]=usedDsNameMap[dsId]||0;usedDsNameMap[dsId]+=1;if(usedDsNameMap[dsId]>1){name=name+'_'+usedDsNameMap[dsId];}
series.push({name:name,symbol:'none',type:'line',markLine:{data:[{type:'average',name:'average'}]},data:row.data});legend.push(name);return true;},this);return{series:series,legend:{data:legend}};}.call(this);}
if(this.refChart){try{options.color=this.refChart.getOption().color||[];}catch(e){}}
return options;};ModalDBHistory.prototype.init=function(){this.$chartContainer=$('.chart-container',this.$modal);this.$btnSearch=$('.btn-search',this.$modal);this.$selMode=$('.sel-mode',this.$modal);this.$selTimerange=$('.sel-timerange',this.$modal);this.$selInterval=$('.sel-interval',this.$modal);this.$iptTimeStart=$('.ipt-timestart',this.$modal);this.$iptTimeEnd=$('.ipt-timeend',this.$modal);this.$groupFast=$('[data-group="fast"]',this.$modal);this.$groupCustom=$('[data-group="custom"]',this.$modal);this.initValidator();this.attachEvents();};ModalDBHistory.prototype.initValidator=function(){var _this=this;this.validator=new Validator({elements:[{name:'endTime',selector:this.$iptTimeEnd,rules:[{valid:function(val){var startTimeVal=_this.$iptTimeStart.val();if(val<=startTimeVal){this.fail();}else{this.success();}},msg:'the end time should later than start time.'}]}],icon:false});};ModalDBHistory.prototype.initTimePlugin=function(fmt){var now=new Date();var formatStr;if(!fmt){formatStr=timeFormatChange('yyyy-mm-dd hh:ii');fmt={format:formatStr,showFormat:formatStr,minView:'hour',startView:'month',startTime:new Date(now.valueOf()-60*60*24*1000)};}else{this.$iptTimeStart.datetimepicker('remove').val('');this.$iptTimeEnd.datetimepicker('remove').val('');}
this.$iptTimeStart.datetimepicker({format:fmt.format,minView:fmt.minView,startView:fmt.startView,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:new Date(),initialDate:new Date(fmt.startTime)});this.$iptTimeStart.val(timeFormat(fmt.startTime,fmt.showFormat));this.$iptTimeEnd.datetimepicker({format:fmt.format,minView:fmt.minView,startView:fmt.startView,autoclose:true,todayBtn:true,forceParse:false,startDate:"2010-01-01 00:00",endDate:new Date(),initialDate:now});this.$iptTimeEnd.val(now.timeFormat(fmt.showFormat));};ModalDBHistory.prototype.initChart=function(){if(!this.chart){this.chart=echarts.init(this.$chartContainer[0],'macarons');}};ModalDBHistory.prototype.setOptions=function(options){this.options=options;};ModalDBHistory.prototype.setModal=function(modal,chart){this.modal=modal;this.refChart=chart;};ModalDBHistory.prototype.attachEvents=function(){var _this=this;this.$selMode.off('change').on('change',function(e){var mode=$(this).val();if(mode==='fast'){_this.$selTimerange.val('hour');_this.$groupFast.show();_this.$groupCustom.hide();}else{_this.$groupFast.hide();_this.$groupCustom.show();_this.$selInterval.trigger('change');}
_this.showOptions.mode=mode;});this.$selInterval.off('change').on('change',function(e){var interval=$(this).val();var fmt={};var now=new Date(),nowTick=now.valueOf();var formatStr;fmt.endTime=now;switch(interval){case'm1':formatStr=timeFormatChange("yyyy-mm-dd hh:ii");fmt.startTime=new Date(nowTick-60000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='hour';fmt.startView='month';break;case'm5':formatStr=timeFormatChange("yyyy-mm-dd hh:ii");fmt.startTime=new Date(nowTick-300000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='hour';fmt.startView='month';break;case'h1':formatStr=timeFormatChange("yyyy-mm-dd hh");fmt.startTime=new Date(nowTick-3600000);fmt.format=formatStr+":00";fmt.showFormat=formatStr+":00";fmt.minView='day';fmt.startView='month';break;case'd1':formatStr=timeFormatChange("yyyy-mm-dd");fmt.startTime=new Date(nowTick-86400000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='month';fmt.startView='month';break;case'M1':formatStr=timeFormatChange("yyyy-mm");fmt.startTime=new Date(nowTick-2592000000);fmt.format=formatStr;fmt.showFormat=formatStr;fmt.minView='year';fmt.startView='year';break;}
_this.initTimePlugin(fmt);});this.$btnSearch.off('click').on('click',function(e){var startTime,endTime,timeFmt;var rangeTick;if(_this.showOptions.mode==='fast'){switch(_this.$selTimerange.val()){case'hour':rangeTick=3600000;timeFmt='m5';break;case'day':rangeTick=86400000;timeFmt='h1';break;case'week':rangeTick=604800000;timeFmt='h1';break;case'month':rangeTick=2592000000;timeFmt='d1';break;case'quarter':rangeTick=7776000000;timeFmt='d1';break;default:break;}
endTime=new Date();startTime=new Date(endTime.valueOf()-rangeTick);_this.updateChart(startTime,endTime,timeFmt);}else{startTime=timeFormat(_this.$iptTimeStart.val()).toDate();endTime=timeFormat(_this.$iptTimeEnd.val()).toDate();timeFmt=_this.$selInterval.val();_this.updateChart(startTime,endTime,timeFmt);}
e.stopPropagation();});this.$modal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.reset();_this.$wrap.detach();e.preventDefault();e.stopPropagation();});this.$modal.off('shown.bs.modal').on('shown.bs.modal',function(e){_this.initChart();_this.$btnSearch.trigger('click');});};ModalDBHistory.prototype.updateChart=function(start,end,timeFmt){var _this=this;var startTick,endTick;var points=this.modal.points;if(!points||!points.length){this.chart.getOption().series=[];return;}
this.chart.showLoading({text:'Loading',effect:'spin',textStyle:{fontSize:20}});return WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:points,timeStart:start.format('yyyy-MM-dd HH:mm:ss'),timeEnd:end.format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeFmt}).then(function(rs){var seriesData=[];var timeShaft=rs.timeShaft;var list=rs.list;var optionsFromType;if(!rs.timeShaft||!rs.timeShaft.length){_this.chart.setOption({xAxis:{data:[]},yAxis:{}},true);return;}
optionsFromType=_this.getOptionsByType(rs);_this.options.chartOptions.xAxis=[{boundaryGap:false,type:'category',data:timeShaft}];_this.options.chartOptions=$.extend(false,_this.options.chartOptions,optionsFromType);_this.chart.setOption(_this.options.chartOptions,true);},function(){_this.chart.setOption({series:[]},true);}).always(function(){_this.chart.hideLoading();});};ModalDBHistory.prototype.reset=function(){if(!!this.chart){this.chart.clear();this.chart.dispose();this.chart=null;}};ModalDBHistory.prototype.close=function(){this.$wrap.remove();this.$wrap=null;};function getDefaultOption(){var i18nEcharts=I18n.resource.echarts;return{chartOptions:{toolbox:{show:true,feature:{dataZoom:{show:true,title:{zoom:i18nEcharts.DATAZOOM,back:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},tooltip:{trigger:'axis'},dataZoom:{show:true},grid:{y:50,y2:80},yAxis:[{type:'value',boundaryGap:[0.1,0.1]}],series:[]}};}
this.ModalDBHistory=ModalDBHistory;}).call(this,jQuery);var ModalBase=(function(){function ModalBase(parent,entity,_funcRender,_funcUpdate,_funcConfigMode,configModalOpt,replacedElementId){if(!parent)return;this.screen=parent;this.entity=entity;this.wikis={};this.container=undefined;this.chart=undefined;this.spinner=undefined;this.subEntity=undefined;this.executeRender=_funcRender;this.executeConfigMode=_funcConfigMode;this.executeUpdate=_funcUpdate;this.hasEdit=false;this.spanRange={};if(this.configModalOptDefault)this.configModalOpt=$.extend(true,{},this.configModalOptDefault,configModalOpt);this.initContainer(replacedElementId);!AppConfig.datasource&&(AppConfig.datasource={getDSItemById:DataSource.prototype.getDSItemById.bind({m_parent:{store:{dsInfoList:[]}},m_arrCloudTableInfo:[]})})};ModalBase.prototype={UNIT_WIDTH:100/12,UNIT_HEIGHT:100/6,initContainer:function(replacedElementId){var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass='';if((!divParent)||replacedElementId){isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}
else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
$(divParent).addClass('springContainer');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){this.spanRange={minWidth:1,maxWidth:3,minHeight:1,maxHeight:6,yScale:4/3,xScale:4};}else{this.spanRange={minWidth:this.optionTemplate.minWidth,maxWidth:this.optionTemplate.maxWidth,minHeight:this.optionTemplate.minHeight,maxHeight:this.optionTemplate.maxHeight,yScale:1,xScale:1};}
if(AppConfig.isMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){var height=100;$(divParent).addClass('forMobile');$(divParent).addClass('widget'+this.optionTemplate.type);if((this.optionTemplate.scroll===false||this.entity.scroll===false)&&!(this.screen.options&&this.screen.options.isConfig||this.screen.isConfigMode)){divParent.className+=' noScroll';}else{height=this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale;height>100&&(height=100);divParent.style.height=height+'%';}
divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale+'%';if(this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale>100){divParent.style.width='100%';}
if(this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale>100){divParent.style.height='100%';}}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(['ModalNote','ModalMix'].indexOf(this.entity.modal.type)>-1){scrollClass=' gray-scrollbar scrollY'}
if(this.entity.modal.title&&this.entity.modal.title!=''&&(!this.entity.isNotRender)){divParent.innerHTML='<div class="panel panel-default">\
                    <div class="panel-heading springHead">\
                        <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                    </div>\
                    <div class="panel-body springContent'+scrollClass+'" style="position: relative;"></div>\
                </div>';}else{divParent.innerHTML='<div class="panel panel-default">\
                    <span class="springSeHead fontTemp6">'+(this.entity.modal.title?this.entity.modal.title:'')+'</span>\
                    <div class="panel-body springContent'+scrollClass+'" style="position: relative;height:100%;"></div>\
                </div>';}
if(AppConfig.isMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){divParent.children[0].classList.add('transparent');}
if(!(this instanceof ModalAnalysis)){var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];var lkHistory;if('ModalInteract'==this.entity.modal.type){var aInterCfg;aInterCfg=document.createElement('a');aInterCfg.className='springLinkBtn';aInterCfg.title='Config time parameter';aInterCfg.href='javascript:;';aInterCfg.innerHTML='<span class="glyphicon glyphicon-cog"></span>';divBtnCtn.appendChild(aInterCfg);aInterCfg.onclick=function(){new ModalInteractCfgPanel(_this).show();}}
_hmt.push(['_trackEvent','Dashboard加入数据源','click','user-'+AppConfig.userId+'/project-'+(AppConfig.projectId?AppConfig.projectId:0)]);if(['ModalHistoryChart','ModalHistoryChartNormal','ModalHistoryChartEnergyConsume','ModalHistoryCharYearOntYearLine','ModalHistoryCharYearOntYearBar'].indexOf(this.entity.modal.type)>-1){_hmt.push(['_trackEvent','Dashboard历史曲线-'+I18n.resource.toolBox.modal[this.optionTemplate.name.split('.').splice(-1)],'create','user-'+AppConfig.userId+'/project-'+(AppConfig.projectId?AppConfig.projectId:0)]);}
if(this.entity.modal.points&&this.entity.modal.points.length>0){var lkJump;lkJump=document.createElement('a');lkJump.className='springLinkBtn';lkJump.title='Add to datasource';lkJump.href='javascript:;';lkJump.innerHTML='<span class="glyphicon glyphicon-export"></span>';divBtnCtn.appendChild(lkJump);lkJump.onclick=function(){new ModalAppendPointToDs(true,_this.entity.modal.points,null).show();}}
if(['ModalHtml','ModalMix','ModalObserver','ModalRank','ModalRankNormal','ModalNone','ModalInteract'].indexOf(this.entity.modal.type)>-1||!this.entity.modal.points||!this.entity.modal.points.length){}else{lkHistory=document.createElement('a');lkHistory.className='springLinkBtn';lkHistory.title='Show History';lkHistory.href='javascript:;';lkHistory.innerHTML='<span class="glyphicon glyphicon-stats"></span>';divBtnCtn.appendChild(lkHistory);this.attachLkHistoryEvents(lkHistory);}
var link=this.entity.modal.link;var _this=this;if(link&&AppConfig.menu[link]){var linkBtn=document.createElement('a');linkBtn.className='springLinkBtn';linkBtn.innerHTML='<span class="glyphicon glyphicon-link"></span>';linkBtn.setAttribute('pageid',link);linkBtn.title='Link to '+AppConfig.menu[link];divBtnCtn.appendChild(linkBtn);linkBtn.onclick=function(e){var $ev=$('#ulPages [pageid="'+link+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');}}
domPanel.appendChild(divBtnCtn);}
this.container=divParent.getElementsByClassName('springContent')[0];if(this.entity.modal.type!=='ModalMix'&&this.entity.modal.type!=='ModalAppBlind'&&this.entity.modal.type!=='ModalAppPie'){this.spinner=new LoadingSpinner({color:'#00FFFF'});this.spinner.spin(this.container);}
return this;},initToolTips:function(parent){var _this=this;if(!parent)return;var descTip=new StringBuilder();descTip.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');descTip.append('    <div class="tooltipTitle tooltip-inner" style="display:none">GeneralRegressor</div>');descTip.append('    <div class="tooltipContent" style="border:1px solid black">');descTip.append('        <p class="containerDesc" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.entity.modal.desc).append('</span> ').append('</p>');descTip.append('    </div>');descTip.append('    <div class="tooltip-arrow"></div>');descTip.append('</div>');var options={placement:'bottom',title:_this.entity.modal.title,template:descTip.toString()};if(_this.entity.modal.desc&&_this.entity.modal.desc!=''){$(parent).tooltip(options);}},render:function(){try{this.executeRender();}catch(e){console.warn(e);}
if(this.chart){this.chart.on('resize',function(param){this.resize();});}},update:function(options){var modal,dsChartConfig,accuracy;var num,specialCond;if((!options)||options.length==0)return;modal=this.entity.modal;dsChartConfig=modal.dsChartCog&&modal.dsChartCog.length?modal.dsChartCog[0]:{};accuracy=dsChartConfig.accuracy;if(accuracy!==''&&!isNaN(accuracy)){specialCond=['',null,undefined];options=options.map(function(row,i){if(specialCond.indexOf(row.data)>-1||isNaN(row.data)){return row;}else{num=+row.data;row.data=num.toFixed(accuracy);return row;}});}
try{this.executeUpdate(options);}catch(e){console.warn(e);}},configure:function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e,callback){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();var oldIndex=_this.screen.arrEntityOrder.indexOf(_this.entity.id);if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
_this.screen.isScreenChange=true;callback&&callback(true);var entity=new ModalNone(_this.screen,{id:_this.entity.id,spanC:_this.entity.spanC,spanR:_this.entity.spanR,modal:{type:"ModalNone"}},_this.entity.id);_this.screen.arrEntityOrder.splice(oldIndex,0,entity.entity.id);_this.screen.listEntity[entity.entity.id]=entity;entity.render();entity.configure();entity.hasEdit=true;_this=null;})};divMask.appendChild(btnRemove);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;(this.entity.spanR>this.optionTemplate.maxHeight)&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);if(!(this instanceof ModalAnalysis)){var $divLink=$('<div class="divResize chartLink">');var $labelLink=$('<label>').text(I18n.resource.dashboard.show.LINK_TO);var chartLink=document.createElement('select');chartLink.className='form-control';chartLink.options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,''));for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);if(this.entity.modal.link==i){option.selected='selected';}
chartLink.options.add(option);}
chartLink.onchange=function(){_this.entity.modal.link=chartLink.value;_this.screen.isScreenChange=true;};$divLink.append($labelLink).append($(chartLink));divMask.appendChild($divLink[0]);}
var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();if(this.entity.isNotRender){var parentId=undefined,subChartIds;if(this.screen.entity&&this.screen.entity.id){parentId=this.screen.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'){if(!entity.modal.option)break;if(entity.modal.option.arrItem.length>0&&entity.modal.option.arrItem[0].subChartIds.length>0){var opts=entity.modal.option.arrItem;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}}
if(parentId){var $chartsCt=$(document.getElementById('divContainer_'+parentId)).find('.chartsCt');if(this.container.parentNode.parentNode.parentNode.className.indexOf('chartsCt')>=0)return;if($chartsCt&&$chartsCt.length>0){$chartsCt[0].appendChild(this.container.parentNode.parentNode);}}}
function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();if(!$sourceParent[0].classList.contains('chartsCt')&&$targetParent[0].classList.contains('chartsCt')){_this.screen.insertChartIntoMix(sourceId,$(e.target).closest('.chartsCt')[0])}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}
_this.screen.isScreenChange=true;}
var type=this.entity.modal.type;if(type==='ModalColdHotAreaSummary'||type==='ModalEquipmentPerfectRate'||type==='ModalWorkOrderStatistics'||type==='ModalPriorityHandlingFaultList'||type==='ModalEnergyTrendAnalysis'){Spinner.stop();return;}
this.executeConfigMode();},modalInit:function(){var _this=this;var dataItem=[],option;var dataTypeUnit;var type=false;if(_this.entity.modal.points!=undefined){if(_this.entity.modal.option&&_this.entity.modal.option.paraType){for(var i=0;i<_this.entity.modal.option.paraType.length;i++){dataTypeUnit={dsId:[],dsType:'',dsName:[]};dataTypeUnit.type=_this.entity.modal.option.paraType[i].type;var arrId=[];var arrItem=[];for(var j=0;j<_this.entity.modal.option.paraType[i].arrId.length;j++){arrId.push(_this.entity.modal.option.paraType[i].arrId[j]);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var j=0;j<_this.entity.modal.option.paraType[i].arrId.length;j++){var id=_this.entity.modal.option.paraType[i].arrId[j];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){dataTypeUnit.dsId.push(id);dataTypeUnit.dsName.push(arrItem[m].alias);break;}}}
dataItem.push(dataTypeUnit);}}else{dataTypeUnit={dsId:[],dsType:'',dsName:[]};var arrId=[];var arrItem=[];for(var i=0;i<_this.entity.modal.points.length;i++){arrId.push(_this.entity.modal.points[i]);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<_this.entity.modal.points.length;i++){var id=_this.entity.modal.points[i];for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){dataTypeUnit.dsId.push(id);dataTypeUnit.dsName.push(arrItem[m].alias===""?arrItem[m].value:arrItem[m].alias);break;}}}
dataItem.push(dataTypeUnit);}}
if(_this.optionTemplate.mode==='custom'){_this.showConfigModal&&_this.showConfigModal();return;}
if(_this.optionTemplate.mode==='noConfigModal'){return;}
if(['ModalReportChapter','ModalReportFactory','ModalMix'].indexOf(_this.optionTemplate.type)>-1){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalMonitor'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalAppButton'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalAppKPICollect'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalReportFactory'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalDiagnosisPanelHtml'){return;}
var tempOptionPara;_this.entity.modal.option?tempOptionPara=_this.entity.modal.option:tempOptionPara={};tempOptionPara.dataItem=dataItem;option={modeUsable:_this.optionTemplate.mode,allDataNeed:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraAnlysMode:true,rowDataType:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraName:[I18n.resource.analysis.paneConfig.DATA_TYPE_DEFAULT],rowDataTypeShowName:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraShowName:undefined,dataTypeMaxNum:[_this.optionTemplate.maxNum],templateType:_this.optionTemplate.type,dsChartCog:_this.entity.modal.dsChartCog?_this.entity.modal.dsChartCog:null,optionPara:tempOptionPara};if(dataItem.length==0){type=true;}
if(_this.screen.screen){_this.screen.screen.modalConfigPane.showModalInit(type,option,_this);}else{if(!_this.screen.modalConfigPane){_this.screen.initModalConfigPane();}
_this.screen.modalConfigPane.showModalInit(type,option,_this);}
_this.screen.isScreenChange=true;},showConfigModal:function(){this.toggleDataSource(true);this.initConfigModalOpt();this.configModalOpt.event=this.configModalOpt.event||{};var _this=this;this.configModalOpt.event.afterHide=function(){_this.hideConfigModal();};var ctn;try{var ctn=this.screen.container.querySelector('.cfgModal');}catch(e){var ctn=this.screen.shape.parentNode.parentNode.querySelector('.cfgModal')}
if(!ctn){if(this.screen.shape&&this.screen.shape.parentNode.parentNode){ctn=this.screen.shape.parentNode.parentNode;}else if(this.screen.screen){ctn=this.screen.screen.container;}else{ctn=this.screen.container;}}
this.configModal=new ConfigModal(this.configModalOpt,ctn,this);this.configModal.init();this.configModal.show();},hideConfigModal:function(){this.toggleDataSource(false);},initConfigModalOpt:function(){var _this=this;this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.render();}},setModalOption:function(option){},divResizeByToolInit:function(){var _this=this;var $divContainer=$('#divContainer_'+_this.entity.id);$divContainer.find('#heightResize').mousedown(function(e){$('.springConfigMask').attr('draggable','false');$('.springContent').attr('draggable','false');$(e.target).mousemove(function(e){$(e.target).closest('.springContainer').css('height',$(e.target).val()*_this.UNIT_HEIGHT*_this.spanRange.yScale+'%');_this.entity.spanR=Number($(e.target).val());$(e.target).next().text($(e.target).val()+' /'+_this.spanRange.maxHeight);if(_this.screen.screen){_this.screen.screen.setEntity(_this.entity);}else{_this.screen.setEntity(_this.entity);}});}).mouseup(function(e){$('.springConfigMask').attr('draggable','true');$('.springContent').attr('draggable','true');$(e.target).off('mousemove');if(_this.chart)_this.chart.resize();_this.screen.isScreenChange=true;_this.hasEdit=true;});$divContainer.find('#widthResize').mousedown(function(e){$('.springConfigMask').attr('draggable','false');$('.springContent').attr('draggable','false');$(e.target).mousemove(function(e){$(e.target).closest('.springContainer').css('width',$(e.target).val()*_this.UNIT_WIDTH*_this.spanRange.xScale+'%');_this.entity.spanC=Number($(e.target).val());$(e.target).next().text($(e.target).val()+' /'+_this.spanRange.maxWidth);if(_this.screen.screen){_this.screen.screen.setEntity(_this.entity);}else{_this.screen.setEntity(_this.entity);}});}).mouseup(function(e){$('.springConfigMask').attr('draggable','true');$('.springContent').attr('draggable','true');$(e.target).off('mousemove');if(_this.chart)_this.chart.resize();_this.screen.isScreenChange=true;_this.hasEdit=true;});$divContainer.find('.rangeVal').click(function(e){e.stopPropagation();var valueCurrent=Number($(e.target).prev().val());var valuePre=$(e.target).prev().val();var valueMax=Number($(e.target).prevAll('.inputResize').attr('max'));var valueMin=Number($(e.target).prevAll('.inputResize').attr('min'));$(e.target).nextAll('.rangeChange').css('display','inline-block').focus().off('blur').blur(function(e){valueCurrent=Number($(e.target).val());if(valueCurrent<=valueMax&&valueCurrent>=valueMin){$(e.target).prevAll('.inputResize').val(valueCurrent.toString());if($(e.target).prevAll('.inputResize').attr('id')=='widthResize'){$(e.target).closest('.springContainer').css('width',$(e.target).val()*_this.UNIT_WIDTH*_this.spanRange.xScale+'%');_this.entity.spanC=Number($(e.target).val());_this.screen.setEntity(_this.entity);$(e.target).prev().text($(e.target).val()+' /'+_this.spanRange.maxWidth);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{$(e.target).closest('.springContainer').css('height',$(e.target).val()*_this.UNIT_HEIGHT*_this.spanRange.yScale+'%');_this.entity.spanR=Number($(e.target).val());_this.screen.setEntity(_this.entity);$(e.target).prev().text($(e.target).val()+' /'+_this.spanRange.maxHeight);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
$(e.target).css('display','none');}else if(valueCurrent>valueMax){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR1+"</strong>").show().close();$(e.target).val(valuePre).css('display','none');}else if(valueCurrent<valueMin){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR2+"</strong>").show().close();$(e.target).val(valuePre).css('display','none');}else{if($(e.target).val()!=""){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR3+"</strong>").show().close();}
$(e.target).val(valuePre).css('display','none');}
_this.hasEdit&&(_this.screen.isScreenChange=true);})});},divResizeByMouseInit:function(){var _this=this;var $widthResize;var $heightResize;var divContainer=$('#divContainer_'+_this.entity.id).get(0);var resizeOnRight=document.createElement('div');resizeOnRight.className='resizeOnRight';divContainer.appendChild(resizeOnRight);var resizeOnBottom=document.createElement('div');resizeOnBottom.className='resizeOnBottom';divContainer.appendChild(resizeOnBottom);var resizeOnCorner=document.createElement('div');resizeOnCorner.className='resizeOnCorner';divContainer.appendChild(resizeOnCorner);var mouseStart={};var divStart={};var rightStart={};var bottomStart={};var w,h,tempSpanR,tempSpanC;resizeOnRight.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$widthResize=$(e.target).parent().find('#widthResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;rightStart.x=resizeOnRight.offsetLeft;doResizeOnRight(e);if(resizeOnRight.setCapture){resizeOnRight.onmousemove=doResizeOnRight;resizeOnRight.onmouseup=stopResizeOnRight;resizeOnRight.setCapture();}else{document.addEventListener("mousemove",doResizeOnRight,false);document.addEventListener("mouseup",stopResizeOnRight,false);}};function doResizeOnRight(e){var oEvent=e||event;var l=oEvent.clientX-mouseStart.x+rightStart.x;w=l+resizeOnCorner.offsetWidth;if(w<resizeOnCorner.offsetWidth){w=resizeOnCorner.offsetWidth;}
else if(w>document.documentElement.clientWidth-divContainer.offsetLeft){w=document.documentElement.clientWidth-divContainer.offsetLeft-2;}
divContainer.style.width=w+"px";}
function stopResizeOnRight(e){if(resizeOnRight.releaseCapture){tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";_this.entity.spanC=tempSpanC;resizeOnRight.onmousemove=null;resizeOnRight.onmouseup=null;resizeOnRight.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";_this.entity.spanC=tempSpanC;document.removeEventListener("mousemove",doResizeOnRight,false);document.removeEventListener("mouseup",stopResizeOnRight,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;$(e.target).prev().children(':last-child').attr('draggable',true);var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}}
resizeOnBottom.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$heightResize=$(e.target).parent().find('#heightResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;bottomStart.y=resizeOnBottom.offsetTop;doResizeOnBottom(e);if(resizeOnBottom.setCapture){resizeOnBottom.onmousemove=doResizeOnBottom;resizeOnBottom.onmouseup=stopResizeOnBottom;resizeOnBottom.setCapture();}else{document.addEventListener("mousemove",doResizeOnBottom,false);document.addEventListener("mouseup",stopResizeOnBottom,false);}};function doResizeOnBottom(e){var oEvent=e||event;var t=oEvent.clientY-mouseStart.y+bottomStart.y;h=t+resizeOnCorner.offsetHeight;if(h<resizeOnCorner.offsetHeight){h=resizeOnCorner.offsetHeight;}else if(h>document.documentElement.clientHeight-divContainer.offsetTop){h=document.documentElement.clientHeight-divContainer.offsetTop-2;}
divContainer.style.height=h+"px";}
function stopResizeOnBottom(e){if(resizeOnBottom.releaseCapture){tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanR=tempSpanR;resizeOnBottom.onmousemove=null;resizeOnBottom.onmouseup=null;resizeOnBottom.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanR=tempSpanR;document.removeEventListener("mousemove",doResizeOnBottom,false);document.removeEventListener("mouseup",stopResizeOnBottom,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;$(e.target).prev().children(':last-child').attr('draggable',true);var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}}
resizeOnCorner.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$widthResize=$(e.target).parent().find('#widthResize');$heightResize=$(e.target).parent().find('#heightResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;divStart.x=resizeOnCorner.offsetLeft;divStart.y=resizeOnCorner.offsetTop;doResizeOnCorner(e);if(resizeOnCorner.setCapture){resizeOnCorner.onmousemove=doResizeOnCorner;resizeOnCorner.onmouseup=stopResizeOnCorner;resizeOnCorner.setCapture();}else{document.addEventListener("mousemove",doResizeOnCorner,false);document.addEventListener("mouseup",stopResizeOnCorner,false);}};function doResizeOnCorner(e){var oEvent=e||event;var l=oEvent.clientX-mouseStart.x+divStart.x;var t=oEvent.clientY-mouseStart.y+divStart.y;w=l+resizeOnCorner.offsetWidth;h=t+resizeOnCorner.offsetHeight;if(w<resizeOnCorner.offsetWidth){w=resizeOnCorner.offsetWidth;}
else if(w>document.documentElement.clientWidth-divContainer.offsetLeft){w=document.documentElement.clientWidth-divContainer.offsetLeft-2;}
if(h<resizeOnCorner.offsetHeight){h=resizeOnCorner.offsetHeight;}else if(h>document.documentElement.clientHeight-divContainer.offsetTop){h=document.documentElement.clientHeight-divContainer.offsetTop-2;}
divContainer.style.width=w+"px";divContainer.style.height=h+"px";}
function stopResizeOnCorner(e){if(resizeOnCorner.releaseCapture){tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$widthResize.val(tempSpanC.toString()).get(0).setAttribute('value',tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());$heightResize.val(tempSpanR.toString()).get(0).setAttribute('value',tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanC=tempSpanC;_this.entity.spanR=tempSpanR;resizeOnCorner.onmousemove=null;resizeOnCorner.onmouseup=null;resizeOnCorner.releaseCapture();if(_this.chart)_this.chart.resize();_this.hasEdit=true;}else{tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /'+_this.spanRange.maxWidth);$widthResize.next().next().val(tempSpanC.toString());$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /'+_this.spanRange.maxHeight);$heightResize.next().next().val(tempSpanR.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH*_this.spanRange.xScale+"%";divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT*_this.spanRange.yScale+"%";_this.entity.spanC=tempSpanC;_this.entity.spanR=tempSpanR;document.removeEventListener("mousemove",doResizeOnCorner,false);document.removeEventListener("mouseup",stopResizeOnCorner,false);if(_this.chart)_this.chart.resize();_this.hasEdit=true;}
_this.screen.isScreenChange=true;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}
$(e.target).prev().children(':last-child').attr('draggable',true);}
function rangeJudge(){if(tempSpanC>_this.spanRange.maxWidth){tempSpanC=_this.spanRange.maxWidth}else if(tempSpanC<_this.spanRange.minWidth){tempSpanC=_this.spanRange.minWidth}
if(tempSpanR>_this.spanRange.maxHeight){tempSpanR=_this.spanRange.maxHeight}else if(tempSpanR<_this.spanRange.minHeight){tempSpanR=_this.spanRange.minHeight}}},attachLkHistoryEvents:function(domItem){var _this=this;domItem.onclick=function(e){_this.modalDBHistory.setModal(_this.entity.modal,_this.chart);_this.modalDBHistory.show();e.preventDefault();e.stopPropagation();};},modalDBHistory:new ModalDBHistory(),initPointAlias:function(arrPoints){var arrPointsAlias=[];var lastRepeatIndex=-1;var tempAlias;var repeatNum=0;var tempIndex;var arrId=[];var arrItem=[];for(var i=0;i<arrPoints.length;++i){arrId.push(arrPoints[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0;i<arrPoints.length;++i){for(var m=0;m<arrItem.length;m++){if(arrPoints[i].dsItemId==arrItem[m].id){arrPointsAlias.push(arrItem[m].alias);break;}}}
for(var i=0;i<arrPoints.length;++i){lastRepeatIndex=arrPointsAlias.lastIndexOf(arrPointsAlias[i]);if(lastRepeatIndex>i){repeatNum=1;tempAlias=arrPointsAlias[i];arrPointsAlias[i]=tempAlias+'_No1';tempIndex=i;for(var j=tempIndex+1;j<lastRepeatIndex+1;j++){repeatNum+=1;tempIndex=arrPointsAlias.indexOf(tempAlias);if(tempIndex==-1)break;arrPointsAlias[tempIndex]=tempAlias+'_No'+repeatNum;}}}
return arrPointsAlias;},close:function(){if(this.chart){this.chart.dispose();}
this.container=null;this.entity=null;this.executeConfigMode=null;this.executeRender=null;this.executeUpdate=null;this.screen=null;this.isConfigMode=null;this.reportScreen=null;typeof this._close==='function'&&this._close();},renderPop:function(pop){if(!pop)return;var $target=$('#divContainer_'+this.entity.id).find('.panel');var $panePop=$target.find('.panePop');var tpl='<div class="divMove"><span>{popMsg}</span></div>\
                <span class="glyphicon glyphicon-remove-circle btnClosePop" title="Close"></span>';if(!$panePop[0]){$panePop=$('<div class="panel-body panePop"></div>');$target.append($panePop);}
$panePop.html(tpl.formatEL({popMsg:pop.data}));var spanWidth=$panePop.find('span').width();var $divMove=$panePop.find('.divMove');if(spanWidth>$divMove.width()){var $marquee=$('<marquee direction="left" onmouseover="this.stop()" onmouseout="this.start()" scrollAmount="3" style="height: 40px; width: calc(100% - 28px);"></marquee>');$marquee.html($panePop.find('span').html());$marquee.appendTo($panePop);$divMove.remove();}
$panePop.find('.btnClosePop').off().click(function(){$panePop.hide();});},toggleDataSource:function(bool){if(AppConfig.isFactory)return;var colCount=$('#paneContent')[0].classList.contains('col-sm-10');var ele=null;if(bool&&colCount){ele=document.getElementById('rightCt');ele&&ele.click();}
if(!bool&&!colCount){ele=document.getElementById('rightCt');ele&&ele.click();}},getSiblingChart:function(){var arrChartId=Object.keys(this.screen.listEntity);var arrChart=[];for(var i=0;i<arrChartId.length;i++){if(arrChartId[i]==this.entity.id)continue;arrChart.push({id:arrChartId[i],title:this.screen.listEntity[arrChartId[i]].entity.modal.title,name:this.screen.listEntity[arrChartId[i]].entity.modal.title})}
return arrChart;},initSubEntity:function(ctn,entity,cls){var id=+new Date();ctn.id='divContainer_'+id;entity.id=id;if(!cls)cls=ModalHtml;this.subEntity=new cls(this,entity);},updateSubEntity:function(){this.subEntity.render()}};return ModalBase;})();﻿var ModalNone=(function(){function ModalNone(screen,entityParams,replacedElementId){ModalBase.call(this,screen,entityParams,this.renderModal,null,null,null,replacedElementId);}
ModalNone.prototype=new ModalBase();ModalNone.prototype.optionTemplate={name:'',mode:['realTime'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalNone'};ModalNone.prototype.renderModal=function(){I18n.fillArea($('#coalSaveName').parent());$(this.container).parent().css('visibility','hidden');this.spinner.stop();},ModalNone.prototype.configure=function(){this.spinner.stop();var _this=this;$(_this.container).parent().css('visibility','');var divAdd=document.createElement('span');divAdd.className='springConfigTips';divAdd.innerHTML='Drag data meta from left panel';this.container.appendChild(divAdd);var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this=null;};this.container.appendChild(btnRemove);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;(this.entity.spanR>this.optionTemplate.maxHeight)&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';this.container.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';this.container.appendChild(btnWidthResize);this.divResizeByMouseInit();this.divResizeByToolInit();if(this.entity.isNotRender&&this.screen.entity){$(document.getElementById('divContainer_'+this.screen.entity.id)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}
if(this.entity.isNotRender){var parentId=undefined,subChartIds;if(this.screen.entity&&this.screen.entity.id){parentId=this.screen.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}
if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
var divParent=$(this.container).closest('.springContainer')[0];var divContent=$(divParent).find('.springContent')[0];divContent.draggable='true';divContent.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divContent.ondragover=function(e){e.preventDefault();};divContent.ondragleave=function(e){e.preventDefault();};divParent.ondrop=function(e){e.stopPropagation();if(e.dataTransfer.getData("type")&&e.dataTransfer.getData("title")){if(_this.screen.screen){var entity=_this.entity;if(_this.screen.entity.modal.type==='ModalAppBlind'){if(e.dataTransfer.getData("type")=='ModalMix'){alert('百叶窗内不能拖入组合图');return;}if(e.dataTransfer.getData("type")=="ModalPointKPI"){alert('百叶窗内不能拖入KPI尊享版');return false;}
if(e.dataTransfer.getData("type")=="ModalReportFactory"){alert('百叶窗内不能拖入报表章节');return false;}
if(e.dataTransfer.getData("type")=="ModalAppBlind"){alert('百叶窗内不能拖入百叶窗');return false;}else{_this.screen.screen.rebornEntity(entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"));}}else{if(e.dataTransfer.getData("type")=='ModalMix'){alert(I18n.resource.toolBox.modal.MSG_MIX_NOT_ALLOW_TO_MIX);return;}
if(e.dataTransfer.getData("type")=="ModalPointKPI"){alert(I18n.resource.toolBox.modal.MSG_KPI_NOT_ALLOW_TO_MIX);return false;}else{_this.screen.screen.rebornEntity(entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"));}}}else{_this.screen.rebornEntity(_this.entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"),_this.hasEdit);}}else if(e.dataTransfer.getData("id")){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');if(_this.screen&&_this.screen.replaceEntity){_this.screen.replaceEntity(e.dataTransfer.getData("id"),targetId);}}}};return ModalNone;})();﻿var ModalAnalysis=(function(){var _this=undefined;function ModalAnalysis(screen,entityParams){entityParams.spanR=6;entityParams.spanC=12;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.spinner.stop();this.container=$('<div style="padding: 20px;position: absolute;left:0;top:0;right:0;bottom:0; z-index: 102; overflow-y: auto;"></div>').appendTo(this.container)[0];_this=this;this.curModal=this.entity.modal.option.option;this.entityAnalysis=undefined;this.saveModalJudge=$.Deferred();}
ModalAnalysis.prototype=new ModalBase();ModalAnalysis.prototype.optionTemplate={name:'toolBox.modal.TRANSIT',parent:2,mode:['realTimeWithoutRange'],maxNum:1,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalAnalysis'};ModalAnalysis.prototype.renderModal=function(){var modalClass=this.screen.factoryIoCAnalysis.getModel(this.entity.modal.option.type);this.screen.curModal=this.curModal;this.entityAnalysis=new modalClass(this.container,this.curModal,this);this.entityAnalysis.isShareMode=1;this.entityAnalysis.paneChart=null;this.entityAnalysis.chartAnimationDuration=500;this.entityAnalysis.animation=false;this.entityAnalysis.show();};ModalAnalysis.prototype.onresize=function(){if(this.entityAnalysis.chart)this.entityAnalysis.chart.resize();};ModalAnalysis.prototype.updateModal=function(points){};ModalAnalysis.prototype.showConfigMode=function(){};ModalAnalysis.prototype.setModalOption=function(option){};ModalAnalysis.prototype.alertNoData=function(){};ModalAnalysis.prototype.spinnerStop=function(){};ModalAnalysis.prototype.saveModal=function(){};return ModalAnalysis;})();var ModalConfig=(function($,undefined){var arrForEach=Array.prototype.forEach;function ModalConfig(options){this.options=$.extend({},this.DEFAULTS,options);this.$wrap=null;};ModalConfig.prototype={constructor:ModalConfig,show:function(){var _this=this;var htmlUrl=this.options.htmlUrl;var matches=htmlUrl.match(/\/?(\w+)(?:\.html)/);var id,domPanelContent,$ele;var promise=$.Deferred();if(!matches||matches[1]===undefined){console.error('the url of config modal is illigal: '+htmlUrl);return false;}
id=matches[1]+'Wrap';domPanelContent=document.getElementById(this.options.container||'paneContent');if(($ele=$('#'+id)).length>0){if(!$.contains(domPanelContent,$ele[0])){domPanelContent.appendChild($ele[0]);}
promise.resolve();}else{Spinner.spin(domPanelContent);WebAPI.get(htmlUrl).then(function(html){var rs;Spinner.stop();_this.$wrap=$('<div class="modal-config-wrap" id="'+id+'">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this._attachEvents();return _this.init();}).always(function(){promise.resolve();});}
return promise.done(function(){_this.$modal.modal('show');});},_setField:function(type,$ele,value){var itemMap,name;var _this=this;switch(type){case'dropdown':itemMap=$ele.data('dropdown-items');if(!itemMap){$ele.data('dropdown-items',itemMap=(function(){var rs={};$ele.siblings('ul').find('a').each(function(i,item){var $item=$(item);var value=$item.attr('data-value');var text=$item.text();if(!rs[value])rs[value]=text;});return rs;}()));}
$ele.attr('data-value',value).children('span').eq(0).text(itemMap[value]);break;case'input':case'textarea':value=value||'';$ele.val(value);break;case'droparea':if(!value||value.trim()===''){$ele.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');}
else{name=AppConfig.datasource.getDSItemById(value).alias;$ele.attr({'data-value':value,'title':name}).html('<span>'+name+'</span>');}
break;case'select':$ele.val(value);break;default:break;}},_attachEvents:function(){var _this=this;var $modal;$('.dropdown-menu',this.$wrap).off('click.selected').on('click.selected','a',function(e){var $this=$(this);var $btn=$this.parents('.dropdown-wrap').children('button');var value=$this.attr('data-value');var text=$this.text();$btn.attr('data-value',value);$btn.children('span').eq(0).text(text);e.preventDefault();});$modal=$('.modal',this.$wrap);$modal.off('show.bs.modal').on('show.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.recoverForm(_this.options.modalIns.entity.modal);if(!$rightCt.hasClass('rightCtOpen'))$rightCt.click();});$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.reset();if($rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$wrap.off('dragover').on('dragover','.drop-area',function(e){e.preventDefault();});this.$wrap.off('dragenter').on('dragenter','.drop-area',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});this.$wrap.off('dragleave').on('dragleave','.drop-area',function(e){$(e.target).removeClass('on');e.stopPropagation();});this.$wrap.off('drop').on('drop','.drop-area',function(e){_this.onDropActionPerformed(e);});},onDropActionPerformed:function(e){var _this=this;var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');_this._setField('droparea',$target,itemId);e.stopPropagation();},setOptions:function(options){this.options=$.extend({},this.options,options);}};return ModalConfig;}(jQuery));﻿var ModalChart=(function(){function ModalChart(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.dicPeriod={'30s':30000,'m1':60000,'m5':300000,'10m':600000,'30m':1800000,'h1':3600000,'d1':86400000,'M1':2592000000}}
ModalChart.prototype=new ModalBase();ModalChart.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART',parent:0,mode:['realTime'],maxNum:10,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalChart'};ModalChart.prototype.optionDefault={color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500'],title:{textStyle:{fontWeight:'normal',color:'#008acd'}},legend:{textStyle:{fontFamily:"Microsoft YaHei",fontSize:10},top:'10',left:'center'},dataRange:{itemWidth:15,color:['#5ab1ef','#e0ffff']},toolbox:{x:'right',y:'center',feature:{mark:{show:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}},color:['#1e90ff','#1e90ff','#1e90ff','#1e90ff'],effectiveColor:'#ff4500'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{color:'#008acd'},crossStyle:{color:'#008acd'},shadowStyle:{color:'rgba(200,200,200,0.2)'}}},dataZoom:{dataBackgroundColor:'#efefff',fillerColor:'rgba(182,162,222,0.2)',handleColor:'#008acd'},grid:(function(isMobile){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:50,top:40}
if(isMobile){grid.x=40;}
return grid;}(AppConfig.isMobile)),categoryAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitLine:{lineStyle:{color:['#eee']}}},valueAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']}},splitLine:{lineStyle:{color:['#eee']}}},polar:{axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{lineStyle:{color:'#008acd'},controlStyle:{normal:{color:'#008acd'},emphasis:{color:'#008acd'}},symbol:'emptyCircle',symbolSize:3},bar:{itemStyle:{normal:{barBorderRadius:5},emphasis:{barBorderRadius:5}},barMaxWidth:80},line:{smooth:true,symbol:'none',symbolSize:3},k:{itemStyle:{normal:{color:'#d87a80',color0:'#2ec7c9',lineStyle:{color:'#d87a80',color0:'#2ec7c9'}}}},scatter:{symbol:'circle',symbolSize:4},radar:{symbol:'emptyCircle',symbolSize:3},map:{itemStyle:{normal:{areaStyle:{color:'#ddd'},label:{textStyle:{color:'#d87a80'}}},emphasis:{areaStyle:{color:'#fe994e'}}}},force:{itemStyle:{normal:{linkStyle:{color:'#1e90ff'}}}},chord:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}},emphasis:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}}}},gauge:{axisLine:{lineStyle:{color:[[0.2,'#2ec7c9'],[0.8,'#5ab1ef'],[1,'#d87a80']],width:10}},axisTick:{splitNumber:10,length:15,lineStyle:{color:'auto'}},splitLine:{length:22,lineStyle:{color:'auto'}},pointer:{width:5}},textStyle:{fontFamily:'微软雅黑, Arial, Verdana, sans-serif'}};ModalChart.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption(this.options);},ModalChart.prototype.updateModal=function(pointName,pointValue){},ModalChart.prototype.showConfigMode=function(){},ModalChart.prototype.dsChartCog=function(cog,option){if(!cog)return;if(cog[0].upper)option.yAxis[0].max=cog[0].upper;if(cog[0].lower)option.yAxis[0].min=cog[0].lower;if(cog[0].unit)option.yAxis[0].name=cog[0].unit;if(cog[0].markLine){if(!option.series[0].markLine){option.series[0].markLine={};option.series[0].markLine.data=new Array();}
for(var i in cog[0].markLine){var markLine=cog[0].markLine[i];if(!markLine.value)continue;var arr=[{name:markLine.name,xAxis:-1,yAxis:markLine.value},{name:markLine.name,xAxis:option.series[0].data.length,yAxis:markLine.value}];option.series[0].markLine.data.push(arr);}}}
ModalChart.prototype.coordinate=function(timeShaft){var arr=[],timeFormat=this.entity.modal.option.timeFormat,format;switch(timeFormat){case'm5':format='HH:mm';break;case'h1':format='HH:00';break;case'd1':format='yyyy-MM-dd';break;case'M1':format='yyyy-MM';break;default:format='yyyy-MM-dd HH:mm';break;}
for(var i=0,l=timeShaft.length;i<l;i++){arr.push(timeShaft[i].toDate().format(format));}
return[{data:arr}];},ModalChart.prototype.resize=function(){this.chart&&this.chart.resize();}
ModalChart.prototype.getData=function(params){var startTime,endTime,timeFormat,unit,postData={},arrPoint;var now=new Date();if(params&&params.dsItemIds){arrPoint=params.dsItemIds;}else{arrPoint=this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points;}
if(params&&params.timeFormat){timeFormat=params.timeFormat;}else{timeFormat=this.entity.modal.option.format;}
if(!params||!params.startTime||!params.endTime){if(this.entity.modal.option.mode==0){switch(this.entity.modal.option.recentTime){case'today':startTime=new Date(now.getTime()-86400000+3600000).format('yyyy-MM-dd HH:00:00');endTime=now.format('yyyy-MM-dd HH:00:00');break;case'threeDay':startTime=new Date(now.getTime()-86400000*3+3600000).format('yyyy-MM-dd HH:00:00');endTime=now.format('yyyy-MM-dd HH:00:00');break;case'yesterday':endTime=now;endTime.setHours(0);endTime.setMinutes(0);endTime.setSeconds(0);startTime=new Date(endTime.getTime()-86400000+3600000).format('yyyy-MM-dd HH:00:00');endTime=endTime.format('yyyy-MM-dd HH:00:00');break;case'thisWeek':endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(endTime);startTime.setDate(startTime.getDate()-6);startTime=startTime.format('yyyy-MM-dd 00:00:00');break;case'lastWeek':endTime=new Date(now.getTime()-now.getDay()*86400000).format('yyyy-MM-dd 00:00:00');;startTime=new Date(now.getTime()-(now.getDay()+6)*86400000).format('yyyy-MM-dd 00:00:00');;break;case'thisYear':endTime=now.format('yyyy-MM-01 00:00:00');startTime=now;startTime.setMonth(startTime.getMonth()-12);startTime=startTime.format('yyyy-MM-01 00:00:00');break;}}else if(this.entity.modal.option.mode==1){if(this.entity.modal.option.startTime&&this.entity.modal.option.endTime){startTime=new Date(this.entity.modal.option.startTime).format('yyyy-MM-dd HH:mm:ss');endTime=new Date(this.entity.modal.option.endTime).format('yyyy-MM-dd HH:mm:ss');}else{alert('请配置开始时间/结束时间');return;}}else if(this.entity.modal.option.mode==2){if(this.entity.modal.option.unit==='hour'){unit=3600000;endTime=new Date();if(timeFormat==='h1'){endTime.setMinutes(0);endTime.setSeconds(0);}
startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+1000).format('yyyy-MM-dd HH:mm:ss');}else if(this.entity.modal.option.unit==='day'){unit=86400000;endTime=new Date();endTime.setMinutes(0);endTime.setSeconds(0);if(timeFormat==='h1'){startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+3600000).format('yyyy-MM-dd HH:mm:ss');}else if(timeFormat==='d1'){startTime=new Date(endTime.getTime()-unit*parseInt(this.entity.modal.option.val)+1000).format('yyyy-MM-dd HH:mm:ss');}}else if(this.entity.modal.option.unit==='month'){unit=2592000000;if(timeFormat==='d1'){endTime=now.format('yyyy-MM-dd 00:00:00');startTime=new Date(now.getTime()-86400000*30).format('yyyy-MM-dd 00:00:00');}else if(timeFormat==='M1'){alert('开发中');return;}}
endTime=endTime.format('yyyy-MM-dd HH:mm:ss');}}else{startTime=params.startTime;endTime=params.endTime;}
if(!arrPoint||arrPoint.length===0){postData.errorMsg='Data source is error';}
if(!startTime||!endTime){postData.errorMsg='Start time or end time is error';}
if(!timeFormat){postData.errorMsg='timeFormat is error';}
if(postData.errorMsg){alert(postData.errorMsg);return;}
postData.dsItemIds=arrPoint;postData.timeStart=startTime;postData.timeEnd=endTime;postData.timeFormat=timeFormat;return WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData);}
return ModalChart;})();var ModalRealtimePie=(function(){function ModalRealtimePie(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalRealtimePie.prototype=new ModalBase();ModalRealtimePie.prototype.optionTemplate={name:'',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};ModalRealtimePie.prototype.optionDefault={tooltip:{trigger:'item',formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:'vertical',x:'left',y:'center'},toolbox:{show:false,feature:{mark:{show:true},dataView:{show:true,readOnly:false},magicType:{show:true,type:['pie','funnel'],option:{funnel:{x:'25%',width:'50%',funnelAlign:'center',max:1548}}},restore:{show:true},saveAsImage:{show:true}}},calculable:true,color:['#E2583A','#FD9F08','#FEC500','#1D74A9','#04A0D6','#689C0F','#109d83'],series:[{type:'pie',radius:['50%','70%'],center:['50%','50%'],labelLine:{normal:{show:true,length:6,length2:60,lineStyle:{width:[2]}}},itemStyle:{normal:{label:{show:true,formatter:'{d}%'},labelLine:{show:true}},emphasis:{label:{show:true,position:'center',textStyle:{fontSize:'20',fontWeight:'bold'}}}}}]};ModalRealtimePie.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},ModalRealtimePie.prototype.updateModal=function(points){},ModalRealtimePie.prototype.showConfigMode=function(){},ModalRealtimePie.prototype.dealWithData=function(points,len){var arr=[];var arrLegend=this.initPointAlias(points);var arrSeries=[];for(var i=0;i<points.length;i++){var seriesData={value:tofixed(points[i].data),name:arrLegend[i]};arrSeries.push(seriesData);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimePie.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePie;})();var ModalRealtimeLine=(function(){function ModalRealtimeLine(screen,entityParams){if(!entityParams)return;ModalChart.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalRealtimeLine.prototype=new ModalChart();ModalRealtimeLine.prototype.optionTemplate={name:'',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};ModalRealtimeLine.prototype.optionDefault=$.extend(true,{},{grid:ModalChart.prototype.optionDefault.grid,legend:ModalChart.prototype.optionDefault.legend},{tooltip:{trigger:'axis'},legend:{data:[],orient:'horizontal'},toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']}}},calculable:(function(){if(AppConfig.isMobile){return false;}else{return true;}}()),color:['#E2583A','#FEC500','#04A0D6','#FD9F08','#1D74A9','#689C0F','#109d83'],xAxis:[{type:'category',boundaryGap:false,splitLine:{show:false},splitArea:{show:false},axisTick:{show:false}}],yAxis:[{type:'value',scale:true,splitLine:{show:(function(){if(AppConfig.isMobile){return false;}else{return true;}}())},splitArea:{show:false},axisLabel:{formatter:function(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],series:[{type:'line',symbol:'none',smooth:true}],animation:true});ModalRealtimeLine.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},ModalRealtimeLine.prototype.updateModal=function(points){},ModalRealtimeLine.prototype.showConfigMode=function(){},ModalRealtimeLine.prototype.dealWithData=function(points,dsChartCog){var arr=[],arrLegend=[],arrSeries=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);}
arrLegend=this.initPointAlias(points.list);for(var i=0;i<points.list.length;i++){var dataList=[];for(var j in points.list[i].data){if(typeof(points.list[i].data[j])==='number'){dataList.push(points.list[i].data[j].toFixed(accuracy));}}
var series={name:arrLegend[i],type:this.entity.modal.option.showType?this.entity.modal.option.showType:'line',symbol:'none',smooth:true,data:dataList,z:3,itemStyle:{normal:{label:{show:false,position:'top',formatter:'{b}\n{c}'},barBorderRadius:[5,5,0,0]}}}
arrSeries.push(series);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimeLine.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimeLine;})();var modalRealtimeBar=(function(){function modalRealtimeBar(screen,entityParams){if(!entityParams)return;ModalChart.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};modalRealtimeBar.prototype=new ModalChart();modalRealtimeBar.prototype.optionTemplate={parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};modalRealtimeBar.prototype.optionDefault=$.extend(true,{},{grid:ModalChart.prototype.optionDefault.grid,legend:ModalChart.prototype.optionDefault.legend},{tooltip:{trigger:'item'},calculable:(function(){if(AppConfig.isMobile){return false;}else{return true;}}()),xAxis:[{type:'category',show:true,splitLine:{show:false},splitArea:{show:false},axisTick:{show:false}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:(function(){if(AppConfig.isMobile){return false;}else{return true;}}())},axisLabel:{formatter:function(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true});modalRealtimeBar.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption($.extend(true,{},this.optionDefault,this.option));},modalRealtimeBar.prototype.updateModal=function(points){},modalRealtimeBar.prototype.showConfigMode=function(){},modalRealtimeBar.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return modalRealtimeBar;})();var ModalRealtimeBarEnegBrkd=(function(){function ModalRealtimeBarEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;modalRealtimeBar.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimeBarEnegBrkd.prototype=new modalRealtimeBar();ModalRealtimeBarEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_BAR_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeBarEnegBrkd',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalRealtimeBarEnegBrkd.prototype.renderModal=function(){},ModalRealtimeBarEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){this.lastRenderTime=now;var _this=this;var dsChartCog=this.entity.modal.dsChartCog;var entityItem=dealWithData(points,dsChartCog);var optionDefault={tooltip:{trigger:'item'},toolbox:{show:false},calculable:true,xAxis:[{type:'category',show:true}],yAxis:[{type:'value',show:true}],series:[{type:'bar',itemStyle:{normal:{color:function(params){var colorList=['#C1232B','#B5C334','#FCCE10','#E87C25','#27727B','#FE8463','#9BCA63','#FAD860','#F3A43B','#60C0DD','#D7504B','#C6E579','#F4E001','#F0805A','#26C0C0'];return colorList[params.dataIndex]},label:{show:true,position:'top',formatter:'{c}'}}},barMaxWidth:80}]};var entityData={xAxis:[{data:entityItem[0]}],series:[{data:entityItem[1],markPoint:{data:entityItem[2]}}]};this.dsChartCog(dsChartCog,entityData);!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption($.extend(true,{},this.optionDefault,optionDefault,entityData));}
function dealWithData(points,dsChartCog){var arr=[],arrXAxis=[],arrData=[],arrMpData=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);};arrXAxis=_this.initPointAlias(points);for(var i=0,temp;i<points.length;i++){temp=points[i];arrData.push(tofixed(temp.data,accuracy));arrMpData.push({xAxis:i,value:tofixed(temp.data,accuracy),name:arrXAxis[i],symbol:'none'})}
arr.push(arrXAxis);arr.push(arrData);arr.push(arrMpData);return arr;}},ModalRealtimeBarEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimeBarEnegBrkd;})();var ModalRealtimeBarSub=(function(){function ModalRealtimeBarSub(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;modalRealtimeBar.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalRealtimeBarSub.prototype=new modalRealtimeBar();ModalRealtimeBarSub.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_BAR',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeBarSub',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalRealtimeBarSub.prototype.renderModal=function(){},ModalRealtimeBarSub.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date();_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime);_this.optionDefault.animation=false;}
if(!this.entity.modal.option)this.entity.modal.option={};if(!this.entity.modal.option.timeFormat){this.entity.modal.option.timeFormat='h1';}
if(this.entity.modal.option.timeFormat==='m1'||this.entity.modal.option.timeFormat==='m5'||this.entity.modal.option.timeFormat==='h1'){var startTime=new Date(endTime-86400000);}else if(this.entity.modal.option.timeFormat==='d1'){var startTime=new Date(endTime-2592000000);}else if(this.entity.modal.option.timeFormat==='M1'){var startTime=new Date(endTime-31536000000);}
this.lastRenderTime=now;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime.format('yyyy-MM-dd HH:mm:ss'),timeEnd:endTime.format('yyyy-MM-dd HH:mm:ss'),timeFormat:_this.entity.modal.option.timeFormat}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10},xAxis:_this.coordinate(dataSrc.timeShaft),yAxis:[{}],toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']}}},series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,entityData));}).error(function(e){}).always(function(e){});}},ModalRealtimeBarSub.prototype.dealWithData=function(points,dsChartCog){var arr=[],arrLegend=[],arrSeries=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);}
arrLegend=this.initPointAlias(points.list);for(var i=0;i<points.list.length;i++){var key=points.list[i].dsItemId,dataList=[];for(var j in points.list[i].data){dataList.push(points.list[i].data[j].toFixed(accuracy));}
var series={name:arrLegend[i],type:'bar',symbol:'none',smooth:true,data:dataList,itemStyle:{normal:{label:{show:false,position:'top',formatter:'{b}\n{c}'},barBorderRadius:[5,5,0,0]}}}
arrSeries.push(series);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimeBarSub.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeBarSub.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalRealtimeBarSub;})();var ModalRealtimePieEnegBrkd=(function(){function ModalRealtimePieEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimePie.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimePieEnegBrkd.prototype=new ModalRealtimePie();ModalRealtimePieEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_PIE_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimePieEnegBrkd',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalRealtimePieEnegBrkd.prototype.renderModal=function(){}
ModalRealtimePieEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){this.lastRenderTime=now;var entityItem=this.dealWithData(points,4);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10,top:20},series:[{data:entityItem[1]}]};this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},this.optionDefault,entityData));}},ModalRealtimePieEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePieEnegBrkd;})();var ModalRealtimeLineOutdoor=(function(){function ModalRealtimeLineOutdoor(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalRealtimeLineOutdoor.prototype=new ModalRealtimeLine();ModalRealtimeLineOutdoor.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_LINE_OUTDOOR',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeLineOutdoor',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}},ModalRealtimeLineOutdoor.prototype.renderModal=function(){this.updateModal();}
ModalRealtimeLineOutdoor.prototype.updateModal=function(points){var pointNameList=[];if(this.screen.store){if(this.screen.store.model){if(this.screen.store.model.option().bg==="whiteBg"){this.optionDefault.tooltip={trigger:'axis',backgroundColor:'rgba(0,0,0,0.7)',textStyle:{color:"#ffffff"}}}else{this.optionDefault.tooltip={trigger:'axis',backgroundColor:'rgba(255,255,255,0.9)',textStyle:{color:"#000000"}}}}}
if(!points&&this.entity.modal.points){if(this.entity.modal.points[0]instanceof Array){pointNameList=this.entity.modal.points[0];}else{pointNameList=this.entity.modal.points;}}else{points&&points.length>0&&(pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points));}
if(pointNameList.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var endTime,startTime;if(!_this.m_bIsGoBackTrace){endTime=new Date();_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime);_this.optionDefault.animation=false;}
if(!this.entity.modal.option)this.entity.modal.option={};if(!this.entity.modal.option.timeFormat){this.entity.modal.option.timeFormat='h1';}
if(this.entity.modal.option.timeFormat==='m1'||this.entity.modal.option.timeFormat==='m5'||this.entity.modal.option.timeFormat==='h1'){startTime=new Date(endTime-86400000);}else if(this.entity.modal.option.timeFormat==='d1'){startTime=new Date(endTime-2592000000);}else if(this.entity.modal.option.timeFormat==='M1'){startTime=new Date(endTime-31536000000);}
this.lastRenderTime=now;this.getData({dsItemIds:pointNameList,timeFormat:this.entity.modal.option.timeFormat}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0],icon:'circle',itemWidth:22,itemHeight:10},xAxis:_this.coordinate(dataSrc.timeShaft),yAxis:[{}],series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,entityData));}).error(function(e){}).always(function(e){});}},ModalRealtimeLineOutdoor.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeLineOutdoor.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};ModalRealtimeLineOutdoor.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={});var _this=this;var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,timeFormat:this.entity.modal.option.format,timeRecent:this.entity.modal.option.recentTime,timeStart:this.entity.modal.option.startTime,timeEnd:this.entity.modal.option.endTime}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:function(data){!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.mode=data.mode;_this.entity.modal.option.format=data.timeFormat;if(data.mode==='1'){_this.entity.modal.option.startTime=data.timeStart;_this.entity.modal.option.endTime=data.timeEnd;}else if(data.mode==='2'){_this.entity.modal.option.unit=data.timeRecent.unit;_this.entity.modal.option.val=data.timeRecent.val;}
_this.entity.modal.option.recentTime=data.timeRecent;_this.entity.modal.option.showType=data.selChartType.val;_this.entity.modal.points=data.points[0];_this.lastRenderTime=null;_this.setModalOption();_this.updateModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalRealtimeLineOutdoor;})();var ModalRealtimeGauge=(function(){function ModalRealtimeGauge(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalRealtimeGauge.prototype=new ModalBase();ModalRealtimeGauge.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_GAUGE',parent:0,mode:['gauge'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeGauge',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalRealtimeGauge.prototype.optionDefault={tooltip:{formatter:"{c}"},animation:true,animationDuration:1000,animationDurationUpdate:1000,series:[{name:'PUE',type:'gauge',splitNumber:8,radius:'100%',axisLine:{show:true,lineStyle:{width:6}},axisTick:{show:true,splitNumber:5,length:10,lineStyle:{width:1,type:'solid',color:'auto'}},axisLabel:{textStyle:{color:'auto'},formatter:function(v){return v.toFixed(0);}},splitLine:{show:true,length:15,lineStyle:{color:'auto',width:3}},pointer:{width:5},detail:{formatter:'{value}',textStyle:{fontSize:12}}}]};ModalRealtimeGauge.prototype.renderModal=function(){},ModalRealtimeGauge.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var scaleList=[];for(var i=0;i<_this.entityOption.scaleList.length;i++){scaleList.push(_this.entityOption.scaleList[i]);}
var colorList=['#1abc9c','#3598db','#e84c3d'];if(scaleList[scaleList.length-1]<scaleList[0]){scaleList.reverse();colorList=['#e84c3d','#3598db','#1abc9c'];}
this.optionDefault.series[0].max=scaleList[scaleList.length-1];this.optionDefault.series[0].min=scaleList[0];this.optionDefault.series[0].data=[{value:parseFloat(points[0].data).toFixed(2)}];this.optionDefault.series[0].axisLine.lineStyle.color=function(option){var arr=[],colorIndex=0;for(var i=0;i<option.length;i++){if(i==0){continue;}
arr.push([((option[i]-option[0])/(_this.optionDefault.series[0].max-_this.optionDefault.series[0].min)).toFixed(3),colorList[colorIndex]]);colorIndex++;}
return arr;}(scaleList);!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption(this.optionDefault);},ModalRealtimeGauge.prototype.showConfigMode=function(){},ModalRealtimeGauge.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.scaleList=option.scaleList;this.entity.modal.interval=5;};return ModalRealtimeGauge;})();function tofixed(str,accuracy){if(!accuracy)accuracy=2;return parseFloat(str).toFixed(accuracy);}
var ModalHistoryChart=(function(){function ModalHistoryChart(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalHistoryChart.prototype=new ModalChart();ModalHistoryChart.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChart'};ModalHistoryChart.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:true},grid:(function(){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:40,top:40}
if(AppConfig.isMobile){grid.x=40;}
return grid;}()),xAxis:[{type:'time',splitLine:{show:false},axisLine:{show:true,lineStyle:{color:'#72647a'}}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:true,lineStyle:{color:'#72647a'}},axisLine:{show:true,lineStyle:{color:'#72647a'}},axisLabel:{formatter:function(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true};ModalHistoryChart.prototype.renderModal=function(){!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var _this=this;if(!_this.m_bIsGoBackTrace){_this.optionDefault.animation=true;}
this.getData().done(function(dataSrc){if(_this.screen.store){if(_this.screen.store.model){if(_this.screen.store.model.option().bg==="whiteBg"){_this.optionDefault.tooltip={trigger:'axis',backgroundColor:'rgba(0,0,0,0.7)',textStyle:{color:"#ffffff"}}}else{_this.optionDefault.tooltip={trigger:'axis',backgroundColor:'rgba(255,255,255,0.9)',textStyle:{color:"#000000"}}}}}
if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var option=_this.initOption(dataSrc);if(undefined==option||undefined==option.series[0].data||0==option.series[0].data.length){return;}
if(AppConfig.isMobile){if(option.xAxis){option.xAxis[0].axisLabel={textStyle:{color:'#e2dfe4'}};}else{option.xAxis=[{axisLabel:{textStyle:{color:'#e2dfe4'}}}]}
option.axisLabel={textStyle:{color:'#e2dfe4'}};var yAxisList=option.yAxis;if(yAxisList){for(var i=0;i<yAxisList.length;i++){yAxisList[i].axisLabel={textStyle:{color:'#e2dfe4'}};}}else{option.yAxis=[{axisLabel:{textStyle:{color:'#e2dfe4'}}}]}}
var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChart.prototype.updateModal=function(options){},ModalHistoryChart.prototype.showConfigMode=function(){},ModalHistoryChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;}
ModalHistoryChart.prototype.resize=function(){this.chart&&this.chart.resize();}
return ModalHistoryChart;})();var ModalHistoryChartNormal=(function(){var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];var m_colorLen=m_color.length;function ModalHistoryChartNormal(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartNormal.prototype=new ModalHistoryChart();ModalHistoryChartNormal.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ENERGY_LINE',parent:1,mode:['easyHistorySelect'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartNormal',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}}
ModalHistoryChartNormal.prototype.initOption=function(dataSrc){if(!dataSrc||!dataSrc.list[0].data){return;}
var xLen=dataSrc.timeShaft.length;var xAxis,format;var arrXAxis=[];if('month'==this.entity.modal.option.timeType||this.entity.modal.option.format==='d1'){format="MM-dd"}
else if('week'==this.entity.modal.option.timeType){format="yyyy-MM-dd";}
else if('day'==this.entity.modal.option.timeType||this.entity.modal.option.format==='h1'){format="MM-dd HH:00";}else if(this.entity.modal.option.format==='m5'){format="MM-dd HH:mm";}else if(this.entity.modal.option.format==='M1'){format="yyyy-MM";}
for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format(format));}
xAxis=[{type:'category',axisLine:{show:true,lineStyle:{color:'#4E5D77'}},data:arrXAxis}]
var dataName=this.initPointAlias(dataSrc.list);var arrSeries=[];var showColor='#1abd9b';for(var i=0;i<dataSrc.list.length;i++){if(dataSrc.list.length>1){showColor=m_color[i%m_colorLen];}
arrSeries.push({name:dataName[i],type:this.entity.modal.option.showType,data:dataSrc.list[i].data,itemStyle:{normal:{},emphasis:{}}});}
var dataOption={title:{text:'',subtext:''},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},dataZoom:{show:false},xAxis:xAxis,yAxis:{axisLine:{show:false}},series:arrSeries};if(AppConfig.isMobile){dataOption.itemStyle={normal:{color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(248,187,146,0.8)'},{offset:1,color:'rgba(190,101,201,0.8)'}],false),barBorderRadius:0}};}
return dataOption;};ModalHistoryChartNormal.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType=option.showType;this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartNormal.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={});var _this=this;var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,format:this.entity.modal.option.format,recentTime:this.entity.modal.option.recentTime,val:this.entity.modal.option.val,unit:this.entity.modal.option.unit,startTime:this.entity.modal.option.startTime,endTime:this.entity.modal.option.endTime}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:function(data){!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.mode=data.mode;_this.entity.modal.option.format=data.format;if(data.mode==='1'){_this.entity.modal.option.startTime=data.startTime;_this.entity.modal.option.endTime=data.endTime;}else if(data.mode==='2'){_this.entity.modal.option.unit=data.unit;_this.entity.modal.option.val=data.val;}
_this.entity.modal.option.showType=data.selChartType.val;_this.entity.modal.option.recentTime=data.recentTime;_this.entity.modal.points=data.points[0];_this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalHistoryChartNormal;})();var ModalHistoryChartEnergyConsume=(function(){function ModalHistoryChartEnergyConsume(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartEnergyConsume.prototype=new ModalHistoryChart();ModalHistoryChartEnergyConsume.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ENERGY_BAR',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartEnergyConsume',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}}
ModalHistoryChartEnergyConsume.prototype.initOption=function(dataSrc){if(!dataSrc||!dataSrc.list||!dataSrc.list[0]){return;}
var xLen=dataSrc.timeShaft.length;var xAxis,format;var arrXAxis=[];if('month'==this.entity.modal.option.timeType||this.entity.modal.option.format==='d1'){format="MM-dd"}
else if('week'==this.entity.modal.option.timeType){format="yyyy-MM-dd";}
else if('day'==this.entity.modal.option.timeType||this.entity.modal.option.format==='h1'){format="MM-dd HH:00";}else if(this.entity.modal.option.format==='m5'){format="MM-dd HH:mm";}else if(this.entity.modal.option.format==='M1'){format="yyyy-MM";}
for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format(format));}
xAxis=[{type:'category',data:arrXAxis}]
var dataName=this.initPointAlias(dataSrc.list);var arrSeries=[];for(var i=0;i<dataSrc.list.length;i++){if(dataSrc.list.length>1){}
var arrData=[];var hisLen=dataSrc.list[0].data.length;var defVal;var fixNum=0;for(var j=1;j<hisLen;j++){var preVal=dataSrc.list[0].data[j-1];if(0==preVal){arrData.push(0);continue;}
defVal=dataSrc.list[0].data[j]-preVal;if(defVal<100){fixNum=2;}
else{fixNum=0;}
arrData.push(parseFloat(defVal.toFixed(fixNum)));}
arrSeries.push({name:dataName[i],type:this.entity.modal.option.showType,data:arrData,itemStyle:{normal:{barBorderRadius:[5,5,5,5]},emphasis:{barBorderRadius:[5,5,5,5]}}});i++;}
var dataOption={title:{text:'',subtext:''},legend:{show:true,data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},dataZoom:{show:false},xAxis:xAxis,series:arrSeries};return dataOption;};ModalHistoryChartEnergyConsume.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='bar';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartEnergyConsume.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={})
var _this=this;var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:this.entity.modal.option.mode,format:this.entity.modal.option.format,recentTime:this.entity.modal.option.recentTime,val:this.entity.modal.option.val,unit:this.entity.modal.option.unit,startTime:this.entity.modal.option.startTime,endTime:this.entity.modal.option.endTime}},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:function(data){!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.mode=data.mode;_this.entity.modal.option.format=data.format;if(data.mode==='1'){_this.entity.modal.option.startTime=data.startTime;_this.entity.modal.option.endTime=data.endTime;}else if(data.mode==='2'){_this.entity.modal.option.unit=data.unit;_this.entity.modal.option.val=data.val;}
_this.entity.modal.option.recentTime=data.recentTime;_this.entity.modal.option.showType='bar';_this.entity.modal.points=data.points[0];_this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();};return ModalHistoryChartEnergyConsume;})();var ModalHistoryChartYearOnYearLine=(function(){var _this;function ModalHistoryChartYearOnYearLine(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigModal=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigModal);this.option=entityParams.option;this.spinner&&this.spinner.spin(this.container);this.store={};this.pointAlias=this.entity.modal.points?AppConfig.datasource.getDSItemById(this.entity.modal.points[0]).alias:'';this.m_bIsGoBackTrace=false;this.m_traceData=undefined;_this=this;!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartYearOnYearLine.prototype=new ModalHistoryChart();ModalHistoryChartYearOnYearLine.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_YEAR_LINE',parent:1,mode:['easyCompareToggle'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartYearOnYearLine',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalHistoryChartYearOnYearLine.prototype.optionDefault={tooltip:{trigger:'axis',formatter:function(params){var tar0=params[0];var tar1=params[1];var pointAlias=_this.pointAlias;return pointAlias+' : '+tar0.name+'<br/>'+tar0.seriesName+' : '+tar0.value+'<br/>'
+tar1.seriesName+' : '+tar1.value;}},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:false},color:['#E2583A','#FD9F08','#FEC500','#1D74A9','#04A0D6','#689C0F','#109d83'],xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChartYearOnYearLine.prototype.renderModal=function(){var _this=this;!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var hourMilSec=3600000;var dayMilSec=86400000;var startDate=new Date();var endDate=new Date();var tmFlag=new Date();var timeType=_this.entity.modal.option.format?_this.entity.modal.option.format:'h1';if('hour'==_this.entity.modal.option.timeType||'m5'===timeType){startDate.setTime(endDate.getTime()-hourMilSec);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(endDate.getTime());tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}else if('day'==_this.entity.modal.option.timeType||'h1'==timeType){startDate.setTime(endDate.getTime()-dayMilSec);startDate.setHours(0);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(endDate.getTime());tmFlag.setHours(0);tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else{return;}
var curDate,startTime,endTime;if(!_this.m_bIsGoBackTrace){startTime=startDate.format('yyyy-MM-dd 00:00:00');endTime=endDate.format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('hour'==_this.entity.modal.option.timeType){timeType='m5';startDate.setTime(curDate.getTime()-hourMilSec);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(curDate.getTime());tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(curDate.getTime()-dayMilSec);startDate.setHours(0);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(curDate.getTime());tmFlag.setHours(0);tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else{return;}
startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=curDate.format('yyyy-MM-dd HH:mm:ss');}
if(_this.screen.store){if(_this.screen.store.model){if(_this.screen.store.model.option().bg==="whiteBg"){_this.optionDefault.tooltip={trigger:'axis',backgroundColor:'rgba(0,0,0,0.7)',textStyle:{color:"#ffffff"}}}else{_this.optionDefault.tooltip={trigger:'axis',backgroundColor:'rgba(255,255,255,0.9)',textStyle:{color:"#000000"}}}}}
this.getData({startTime:startTime,endTime:endTime,timeFormat:timeType}).done(function(dataSrc){if(!dataSrc||!dataSrc.list||!dataSrc.list[0]||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var arrXAxis=[];var flagCount=0;var len=dataSrc.timeShaft.length;tmFlag=tmFlag.format('yyyy-MM-dd HH:mm:ss');for(flagCount=0;flagCount<len;flagCount++){if(dataSrc.timeShaft[flagCount]>=tmFlag){break;}}
_this.store.timeShaft=dataSrc.timeShaft.slice(0,flagCount);_this.store.deadline=dataSrc.timeShaft[flagCount-1].toDate().valueOf();var fixNum=0;var setVal;var dataName=[];var arrSeries=[];for(var k=0,lenK=Math.min(flagCount,dataSrc.timeShaft.length);k<lenK;k++){arrXAxis.push(dataSrc.timeShaft[k].toDate().format("HH:mm"));}
var chartType=_this.entity.modal.option.showType?_this.entity.modal.option.showType:'line';var currentCount=0;for(var n=0;n<dataSrc.list.length;n++){var key=dataSrc.list[n].dsItemId;var dataSrc1=[];var dataSrc2=[];var eachName=[];if(1==dataSrc.list.length){dataName.push(I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(I18n.resource.dataSource.TIME_TODAY);eachName.push(I18n.resource.dataSource.TIME_YESTERDAY);eachName.push(I18n.resource.dataSource.TIME_TODAY);}
else{dataName.push(key+'_'+I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(key+'_'+I18n.resource.dataSource.TIME_TODAY);eachName.push(key+'_'+I18n.resource.dataSource.TIME_YESTERDAY);eachName.push(key+'_'+I18n.resource.dataSource.TIME_TODAY);}
for(var j=0,len=dataSrc.list[n].data.length;j<len;j++){setVal=dataSrc.list[n].data[j];if(setVal<100){fixNum=2;}
else{fixNum=0;}
setVal=parseFloat(setVal.toFixed(fixNum));if(j<flagCount){dataSrc1.push(setVal);}
else{dataSrc2.push(setVal);}}
var showColor;var showData;var showMark;for(var i=0;i<2;i++){if(0==i){if(0==currentCount){showColor='#1abd9b';}
else{showColor=echarts.config.color[currentCount*2];}
showData=dataSrc1;showMark={data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.MAXIMUM},{type:'min',name:I18n.resource.dashboard.modalHistoryChart.MINIMUM}]}}
else if(1==i){if(0==currentCount){showColor='#e74a37';}
else{showColor=echarts.config.color[currentCount*2+1];}
showData=dataSrc2;var lastCntX=dataSrc2.length-1;var lastCntY=Number(dataSrc2[lastCntX]);showMark={symbol:'emptyCircle',symbolSize:10,effect:{show:true,shadowBlur:0},itemStyle:{normal:{label:{show:false}},emphasis:{label:{position:'top'}}},data:[{name:'',value:lastCntY,xAxis:lastCntX,yAxis:lastCntY}]}}
arrSeries.push({name:eachName[i],type:chartType,data:showData,itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,0,0]},emphasis:{color:showColor,barBorderRadius:[5,5,0,0]}},symbolSize:3});if(i===1){arrSeries[1].symbol='rect';var blingDot=$.extend(true,{},arrSeries[1]);var seriesOne=arrSeries[1];seriesOne.type='effectScatter';seriesOne.symbolSize=10;seriesOne.symbol='circle'
seriesOne.rippleEffect={brushType:'stroke'};seriesOne.itemStyle.normal.shadowBlur=10;var blingDotData=$.extend(true,{},showData);for(var p=0,lens=showData.length;p<lens;p++){if(p<lens-1){showData[p]='-';}}
var blingDotDataArr=[];for(var item in blingDotData){blingDotDataArr.push(blingDotData[item]);}
blingDot.data=showData;arrSeries[1]=blingDot;arrSeries[1].data=blingDotDataArr;arrSeries.push(seriesOne);}
showColor='';}
currentCount++;}
var xAxis=[{type:'category',boundaryGap:false,data:arrXAxis}]
var option={title:{text:'',subtext:''},dataZoom:{show:false},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},xAxis:xAxis,series:arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=option.series[i].data[j].toFixed(n);}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChartYearOnYearLine.prototype.updateModal=function(options){var _this=this;var modalOptions=this.entity.modal.option;var lastIndex,lastTick,nowTick;if(undefined===options||options.length<1||undefined===options[0]){return;}
lastIndex=this.chart.getOption().series[1].data.length-1;lastTick=this.store.timeShaft[lastIndex].toDate().valueOf();nowTick=new Date().valueOf();if(lastTick===undefined)return;if('hour'===modalOptions.timeType){lastTick+=3600000;refreshInterval=300000;}
if('day'===modalOptions.timeType){lastTick+=86400000;refreshInterval=3600000;}
else{return;}
if(nowTick<lastTick+refreshInterval)return;var opt=_this.chart.getOption();for(var i=0,len=options.length;i<len;i++){if(options[i].data!==null){opt.series[1].data.push(options[i].data);}}
_this.chart.setOption(opt);var dataSeries=_this.chart.getOption().series;if(dataSeries.length<2){return;}
var temp=dataSeries[1].data;var lastCntX=temp.length-1;var lastCntY=Number(temp[lastCntX]);var showMark={symbol:'emptyCircle',symbolSize:10,effect:{show:true,shadowBlur:0},itemStyle:{normal:{label:{show:false}},emphasis:{label:{position:'top'}}},data:[{name:'',value:lastCntY,xAxis:lastCntX,yAxis:lastCntY}]}
_this.chart.addMarkPoint(1,showMark);},ModalHistoryChartYearOnYearLine.prototype.showConfigMode=function(){},ModalHistoryChartYearOnYearLine.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType=option.showType?option.showType:'line';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartYearOnYearLine.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={});var _this=this;var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:'0',format:'h1',recentTime:'yesterday'}},{"type":'option',"widget":[{id:'selChartType',type:'select',name:'图表类型',opt:{option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]},data:{val:this.entity.modal.option.showType}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:function(data){!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.mode=0;_this.entity.modal.option.format='h1';_this.entity.modal.option.showType=data.selChartType.val;_this.entity.modal.option.recentTime='yesterday';_this.entity.modal.points=data.points[0];_this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.modalBody.querySelector('.divMode select').disabled=true;this.configModal.modalBody.querySelector('.divRecentTime select').disabled=true;this.configModal.show();};return ModalHistoryChartYearOnYearLine;})();var ModalHistoryChartYearOnYearBar=(function(){var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];function ModalHistoryChartYearOnYearBar(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigModal=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigModal);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;this.option=entityParams.option;this.spinner&&this.spinner.spin(this.container);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.mode&&(this.entity.modal.option.mode=0);!this.entity.modal.option.recentTime&&(this.entity.modal.option.recentTime='today');!this.entity.modal.option.format&&(this.entity.modal.option.format='h1');};ModalHistoryChartYearOnYearBar.prototype=new ModalHistoryChart();ModalHistoryChartYearOnYearBar.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_YEAR_BAR',parent:1,mode:['easyCompare'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartYearOnYearBar',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalHistoryChartYearOnYearBar.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:false},xAxis:[{type:'category',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChartYearOnYearBar.prototype.renderModal=function(){var _this=this;!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));var dayMilSec=86400000;var startDate=new Date();var endDate=new Date();var startDateZero=new Date();var endDateZero=new Date();var timeType=_this.entity.modal.option.format?_this.entity.modal.option.format:'h1';if('day'==_this.entity.modal.option.timeType||'h1'==timeType){startDate.setTime(endDate.getTime()-dayMilSec);startDateZero.setTime(startDate.getTime());startDateZero.setHours(0);startDateZero.setMinutes(0);startDateZero.setSeconds(0);endDateZero.setTime(endDate.getTime());endDateZero.setHours(0);endDateZero.setMinutes(0);endDateZero.setSeconds(0);}
else{return;}
var curDate;if(!_this.m_bIsGoBackTrace){_this.optionDefault.animation=true;}
else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(curDate.getTime()-dayMilSec);startDateZero.setTime(startDate.getTime());startDateZero.setHours(0);startDateZero.setMinutes(0);startDateZero.setSeconds(0);endDateZero.setTime(curDate.getTime());endDateZero.setHours(0);endDateZero.setMinutes(0);endDateZero.setSeconds(0);}
else{return;}}
if(_this.screen.store){if(_this.screen.store.model){if(_this.screen.store.model.option().bg==="whiteBg"){_this.optionDefault.tooltip={trigger:'axis',backgroundColor:'rgba(0,0,0,0.7)',textStyle:{color:"#ffffff"}}}else{_this.optionDefault.tooltip={trigger:'axis',backgroundColor:'rgba(255,255,255,0.9)',textStyle:{color:"#000000"}}}}}
this.getData({startTime:startDateZero.format('yyyy-MM-dd HH:mm:ss'),endTime:endDate.format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeType}).done(function(dataSrc){if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var flag1,flag2;var len=dataSrc.timeShaft.length;for(var i=0;i<len;i++){if(dataSrc.timeShaft[i].toDate()>=startDate){flag1=i;break;}}
for(var i=0;i<len;i++){if(dataSrc.timeShaft[i].toDate()>=endDateZero){flag2=i;break;}}
var arrVal1=[];var arrVal2=[];var val1=0;var val2=0;var fixNum1=0;var fixNum2=0;var preVal=0;for(var i=0;i<dataSrc.list.length;i++){for(var j=0,len=dataSrc.list[i].data.length;j<len;j++){if(j==flag1){preVal=dataSrc.list[i].data[0];if(0==preVal){val1=0;}
else{val1=dataSrc.list[i].data[j]-preVal;}}
else if(j==flag2){preVal=dataSrc.list[i].data[j];if(0==preVal){val2=0;}
else{val2=dataSrc.list[i].data[len-1]-preVal;}}}
if(val1<100){fixNum1=2;}
else{fixNum1=0;}
if(val2<100){fixNum2=2;}
else{fixNum2=0;}
arrVal1.push(parseFloat(val1.toFixed(fixNum1)));arrVal2.push(parseFloat(val2.toFixed(fixNum2)));break;}
var tmFlag=new Date();var arrXAxis=[];tmFlag=tmFlag.format('yyyy-MM-dd HH:mm:ss');for(var flagCount=0;flagCount<len;flagCount++){if(dataSrc.timeShaft[flagCount]>=tmFlag){break;}}
for(var k=0,lenK=Math.min(flagCount,dataSrc.timeShaft.length);k<lenK;k++){arrXAxis.push(dataSrc.timeShaft[k].toDate().format("HH:mm"));}
var xAxis=[{type:'category',boundaryGap:true,data:arrXAxis}];var chartType=_this.entity.modal.option.showType?_this.entity.modal.option.showType:'bar';var dataName=[];dataName.push(I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(I18n.resource.dataSource.TIME_TODAY);var arrSeries=[{name:dataName[0],type:chartType,data:arrVal1,itemStyle:{normal:{color:m_color[2],barBorderRadius:[5,5,0,0]},emphasis:{color:m_color[2],barBorderRadius:[5,5,0,0]}},markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.EnergyConsumption}]}},{name:dataName[1],type:chartType,data:arrVal2,itemStyle:{normal:{color:m_color[1],barBorderRadius:[5,5,0,0]},emphasis:{color:m_color[1],barBorderRadius:[5,5,0,0]}},markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.EnergyConsumption}]}},];var option={title:{text:'',subtext:''},dataZoom:{show:false},legend:{data:dataName,icon:'circle',itemWidth:20,itemHeight:10,left:'center',top:'10'},xAxis:xAxis,series:arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=option.series[i].data[j].toFixed(n);}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner&&_this.spinner.stop();});},ModalHistoryChartYearOnYearBar.prototype.updateModal=function(options){},ModalHistoryChartYearOnYearBar.prototype.showConfigMode=function(){},ModalHistoryChartYearOnYearBar.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='bar';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartYearOnYearBar.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={});var _this=this;var configModalOpt={"header":{"needBtnClose":true,"title":"配置"},"area":[{module:'timeConfig',data:{mode:'0',format:'h1',recentTime:'yesterday'}},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]},],result:{func:function(data){!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.mode=0;_this.entity.modal.option.format='h1';_this.entity.modal.option.recentTime='yesterday';_this.entity.modal.points=data.points[0];_this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.modalBody.querySelector('.divMode select').disabled=true;this.configModal.modalBody.querySelector('.divRecentTime select').disabled=true;this.configModal.show();};return ModalHistoryChartYearOnYearBar;})();var ModalHistoryDataAnalyze=(function(){function ModalHistoryDataAnalyze(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.store=[];!AppConfig.datasource&&(AppConfig.datasource={getDSItemById:DataSource.prototype.getDSItemById.bind({m_parent:{store:{dsInfoList:[]}},m_arrCloudTableInfo:[]})})}
ModalHistoryDataAnalyze.prototype=new ModalHistoryChart();ModalHistoryDataAnalyze.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ANALYSE',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryDataAnalyze',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalHistoryDataAnalyze.prototype.renderModal=function(){this.container.innerHTML='\
        <div class="ctnTimeConfig"><div class="divTimeConfig clearfix"></div>\
            <!--<div class="divDataConfig"></div>-->\
            <div class="btnTimeConfigGrp">\
            <div class="divConfigConfirm btn btn-primary" i18n="dashboard.modalHistoryDataAnalyze.DATE_CONFIRM">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DATE_CONFIRM+'</div>\
            <div class="divConfigCancel btn btn-default" i18n="dashboard.modalHistoryDataAnalyze.DATE_CANCEL">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DATE_CANCEL+'</div>\
            </div>\
        </div>\
        <div class="btnShowTimeConfig glyphicon glyphicon-cog"></div>\
        <div class="dragTip" i18n="dashboard.modalHistoryDataAnalyze.DRAG_TIP_FOR_CHART">'+I18n.resource.dashboard.modalHistoryDataAnalyze.DRAG_TIP_FOR_CHART+'</div>\
        <div class="divHistoryChart"></div>\
        ';this.container.parentNode.className+=' widgetHistoryAnalyze forDashboard';this.ctnTimeConfig=this.container.querySelector('.ctnTimeConfig');this.divTimeConfig=this.container.querySelector('.divTimeConfig');this.ctnChart=this.container.querySelector('.divHistoryChart');this.createTimeConfig();this.attachEvent();I18n.fillArea($(this.container));};ModalHistoryDataAnalyze.prototype.createTimeConfig=function(){var mode=document.createElement('div');mode.className='divTimeMode';mode.innerHTML='\
        <label i18n="modalConfig.option.LABEL_MODE">'+I18n.resource.modalConfig.option.LABEL_MODE+'</label>\
        <select class="form-control iptTimeMode">\
            <option value="0" i18n="modalConfig.option.MODE_CURRENT">'+I18n.resource.modalConfig.option.MODE_CURRENT+'</option>\
            <option value="1" i18n="modalConfig.option.MODE_RECENT">'+I18n.resource.modalConfig.option.MODE_RECENT+'</option>\
            <option value="2" i18n="modalConfig.option.MODE_FIXED">'+I18n.resource.modalConfig.option.MODE_FIXED+'</option>\
        </select>';this.divTimeConfig.appendChild(mode);this.createTimeRange(0);I18n.fillArea($(this.ctnTimeConfig));};ModalHistoryDataAnalyze.prototype.createTimeRange=function(mode){$(this.divTimeConfig).find('.divTimeInterval').remove();$(this.divTimeConfig).find('.divTimeRange').remove();var divTimeRange=document.createElement('div');divTimeRange.className='divTimeRange form-group';switch(mode){case 0:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <select class="form-control selRecentTimeRange">\
                    <option value="today" i18n="modalConfig.option.PERIOD_DROP_DOWN_TODAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_TODAY+'</option>\
                    <option value="threeDay"  i18n="modalConfig.option.PERIOD_DROP_DOWN_THREE_DAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THREE_DAY+'</option>\
                    <option value="yesterday" selected=""  i18n="modalConfig.option.PERIOD_DROP_DOWN_YESTERDAY">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_YESTERDAY+'</option>\
                    <option value="thisWeek" i18n="modalConfig.option.PERIOD_DROP_DOWN_THIS_WEEK">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THIS_WEEK+'</option>\
                    <option value="lastWeek" i18n="modalConfig.option.PERIOD_DROP_DOWN_LAST_WEEK">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_LAST_WEEK+'</option>\
                    <option value="thisYear" i18n="modalConfig.option.PERIOD_DROP_DOWN_THIS_YEAR">'+I18n.resource.modalConfig.option.PERIOD_DROP_DOWN_THIS_YEAR+'</option>\
                </select>\
                ';break;case 1:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <div class="input-group" style="width:100%">\
                    <input class="iptRecentTimeVal form-control" style="width:60%">\
                    <select class="selRecentTimeUnit form-control" style="width:40%">\
                        <option value="minute" i18n="modalConfig.option.PERIOD_UNIT_MIN">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MIN+'</option>\
                        <option value="hour" i18n="modalConfig.option.PERIOD_UNIT_HOUR">'+I18n.resource.modalConfig.option.PERIOD_UNIT_HOUR+'</option>\
                        <option value="day" i18n="modalConfig.option.PERIOD_UNIT_DAY">'+I18n.resource.modalConfig.option.PERIOD_UNIT_DAY+'</option>\
                        <option value="month" i18n="modalConfig.option.PERIOD_UNIT_MON">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MON+'</option>\
                    </select>\
                </div>\
                ';this.divTimeConfig.insertBefore(this.createTimeInterval('minute'),divTimeRange);var _this=this;$(divTimeRange).find('.selRecentTimeUnit').off('change').on('change',function(e){$(_this.divTimeConfig).find('.divTimeInterval').remove();_this.divTimeConfig.insertBefore(_this.createTimeInterval(e.currentTarget.value),e.currentTarget.parentNode.parentNode);I18n.fillArea($(_this.ctnTimeConfig));});break;case 2:this.divTimeConfig.appendChild(divTimeRange);divTimeRange.innerHTML='\
                <label i18n="modalConfig.option.LABEL_TIME_RANGE">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                <div class="input-group">\
                    <input class="form-control form_datetime iptStartTime" size="16" type="text" data-format="yyyy-mm-dd hh:ii" datetimepicker>\
                    <span class="input-group-addon" i18n="modalConfig.option.TIP_RANGE_TO">${I18n.resource.modalConfig.option.TIP_RANGE_TO}</span>\
                    <input class="form-control form_datetime iptEndTime" size="16" type="text" data-format="yyyy-mm-dd hh:ii" datetimepicker>\
                </div>\
                ';this.divTimeConfig.insertBefore(this.createTimeInterval(),divTimeRange);break;default:break;I18n.fillArea($(this.ctnTimeConfig));}};ModalHistoryDataAnalyze.prototype.setFixedRangeInterval=function(interval){var iptStartTime=this.divTimeConfig.querySelector('.iptStartTime');var iptEndTime=this.divTimeConfig.querySelector('.iptEndTime');var format='yyyy-MM-dd HH:mm';var datePikerFormat='yyyy-mm-dd hh:ii';$(iptStartTime).attr('value',new Date().format(format)).datetimepicker({todayBtn:'linked',endTime:new Date(),format:datePikerFormat,autoclose:true,initialDate:new Date().format(format)});$(iptEndTime).attr('value',new Date().format(format)).datetimepicker({todayBtn:'linked',endTime:new Date(),format:datePikerFormat,autoclose:true,initialDate:new Date().format(format)});};ModalHistoryDataAnalyze.prototype.getTimeConfig=function(){var mode=this.divTimeConfig.querySelector('.iptTimeMode').value;var dateTimeRange=this.divTimeConfig.querySelector('.divTimeRange');var dateInterval=$(this.divTimeConfig).find('.divTimeInterval>select')[0];var startTime,endTime,interval,range;var now=new Date();if(mode==0){var timeRangeVal=dateTimeRange.querySelector('.selRecentTimeRange').value;switch(timeRangeVal){case'today':startTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='h1';break;case'threeDay':startTime=new Date(now.getTime()-259200000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='h1';break;case'yesterday':startTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd 00:00:00');endTime=new Date(now.getTime()-86400000).format('yyyy-MM-dd 23:59:59');interval='h1';break;case'thisWeek':startTime=new Date(now.getTime()-604800000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='d1';break;case'lastWeek':var weekVal=DateUtil.getWeekNumber(now);var dateRange=DateUtil.getDateRangeOnWeekNumber(weekVal[0],weekVal[1]-1);startTime=new Date(dateRange[0].getTime()-604800000).format('yyyy-MM-dd 00:00:00');endTime=new Date(dateRange[1].getTime()-604800000).format('yyyy-MM-dd 23:59:59');interval='d1';break;case'thisYear':startTime=new Date(now.getTime()-31536000000).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');interval='M1';break;}}else if(mode==1){var dateTimeUnit=dateTimeRange.querySelector('.selRecentTimeUnit').value;var unitTime=0;var dataTimeVal=parseInt(dateTimeRange.querySelector('.iptRecentTimeVal').value);if(isNaN(dataTimeVal))return;switch(dateTimeUnit){case'minute':unitTime=60000;break;case'hour':unitTime=3600000;break;case'day':unitTime=86400000;break;case'month':unitTime=2592000000;break;}
interval=dateInterval.value;startTime=new Date(now.getTime()-unitTime*dataTimeVal).format('yyyy-MM-dd HH:mm:ss');endTime=now.format('yyyy-MM-dd HH:mm:ss');}else if(mode==2){interval=dateInterval.value;startTime=new Date(dateTimeRange.querySelector('.iptStartTime').value).format('yyyy-MM-dd HH:mm:ss');endTime=new Date(dateTimeRange.querySelector('.iptEndTime').value).format('yyyy-MM-dd HH:mm:ss');}
return{startTime:startTime,endTime:endTime,interval:interval}};ModalHistoryDataAnalyze.prototype.createTimeInterval=function(unit){var interval=document.createElement('div');interval.className='divTimeInterval';switch(unit){case'minute':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="m1" i18n="modalConfig.option.INTERVAL_MIN1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                </select>\
                ';break;case'hour':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                </select>\
                ';break;case'day':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                </select>\
                ';break;case'month':interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                <select class="form-control">\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                    <option value="M1" i18n="modalConfig.option.INTERVAL_MON1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                </select>\
                ';break;default:interval.innerHTML='\
                <label i18n="modalConfig.option.LABEL_INTERVAL">${I18n.resource.modalConfig.option.LABEL_INTERVAL}</label>\
                <select class="form-control">\
                    <option value="m1" i18n="modalConfig.option.INTERVAL_MIN1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                    <option value="m5" i18n="modalConfig.option.INTERVAL_MIN5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                    <option value="h1" i18n="modalConfig.option.INTERVAL_HOUR1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                    <option value="d1" i18n="modalConfig.option.INTERVAL_DAY1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                    <option value="M1" i18n="modalConfig.option.INTERVAL_MON1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                </select>\
                ';this.setFixedRangeInterval('m1');var _this=this;interval.getElementsByTagName('select')[0].onchange=function(e){_this.setFixedRangeInterval(e.currentTarget.value)};break;}
I18n.fillArea($(this.ctnTimeConfig));return interval;};ModalHistoryDataAnalyze.prototype.chartPreSet=function(){var _this=this;$(this.container).find('.dragTip').hide();var timeConfig=this.getTimeConfig();this.getData({startTime:timeConfig.startTime,endTime:timeConfig.endTime,timeFormat:timeConfig.interval,dsItemIds:_this.store.map(function(pt){return pt.id})}).done(function(dataSrc){_this.renderChart(dataSrc,timeConfig.interval);});};ModalHistoryDataAnalyze.prototype.renderChart=function(data,interval){var formatDate='';var formatTime='';switch(interval){case'm1':formatTime='HH:mm';break;case'm5':formatTime='HH:mm';break;case'h1':formatTime='HH:mm';break;case'd1':formatDate='MM-dd';break;case'M1':formatDate='yyyy-MM-dd';formatTime='';break;}
var timeInit=data.timeShaft;var timeShaft=[].concat(data.timeShaft);for(var i=0;i<timeShaft.length;i++){if(formatDate&&formatTime){timeShaft[i]=new Date(timeShaft[i]).format(formatDate)+'\n\r'+new Date(timeShaft[i]).format(formatTime);}else if(formatDate){timeShaft[i]=new Date(timeShaft[i]).format(formatDate);}else{timeShaft[i]=new Date(timeShaft[i]).format(formatTime);}}
var dsName='';var legend=[];var series=[];for(var i=0;i<data.list.length;i++){if(data.list[i].data.length==0)continue;dsName=AppConfig.datasource.getDSItemById(data.list[i].dsItemId).alias;this.store[i].name=dsName;legend.push(dsName);series.push({name:dsName,data:data.list[i].data,type:'line',itemStyle:{normal:{color:AppConfig.chartTheme.color[i%7]}}})}
var option={title:{show:false,left:'center',text:I18n.resource.dashboard.modalHistoryDataAnalyze.HISTORY_DATA,textStyle:{color:'#fff'}},legend:{data:legend,padding:2,textStyle:{color:'#fff',fontSize:8,fontWeight:'lighter'},formatter:function(opt){var str='';if(opt.length>10){str=opt.slice(0,5)+'...'+opt.slice(opt.length-5)}else{str=opt;}
return str;},orient:'horizontal',left:'center',top:'10'},grid:{x:45,y:25,x2:25,y2:25},toolbox:{},tooltip:{trigger:'axis',formatter:function(data){var strTip='';strTip+=new Date(timeInit[data[0].dataIndex]).format('yyyy-MM-dd HH:mm')+'</br>';for(var i=0;i<data.length;i++){strTip+=data[i].seriesName+' : '+data[i].data;if(i!=(data.length-1)){strTip+='</br>';}}
return strTip;}},xAxis:{type:'category',boundaryGap:false,data:timeShaft,axisLine:{lineStyle:{color:'#fff'}}},yAxis:{type:'value',scale:true,axisLabel:{formatter:function(value){var ret;if(value<1000){ret=value;}
else if(value<1000000){ret=value/1000+'k';}
else{ret=value/1000000+'M';}
return ret;}},splitLine:{lineStyle:{opacity:0.8}},axisLine:{lineStyle:{color:'#fff'}}},series:series};var _this=this;var hisChart=echarts.init(this.ctnChart,AppConfig.chartTheme);hisChart.setOption(option);hisChart.on('legendselectchanged',function(params){for(var i=0;i<_this.store.length;i++){if(_this.store[i].name==params.name){_this.store.splice(i,1);series.splice(i,1);legend.splice(i,1);hisChart.setOption(option);break;}}});};ModalHistoryDataAnalyze.prototype.attachEvent=function(){var _this=this;$(this.divTimeConfig).find('.divTimeMode>select').off('change').on('change',function(e){_this.createTimeRange(parseInt(e.currentTarget.value))});var $btnShowTimeConfig=$(this.container.querySelector('.btnShowTimeConfig'));$(_this.ctnTimeConfig).hide();$(this.container).find('.divConfigCancel').off('click').on('click',function(e){$(_this.ctnTimeConfig).hide();$btnShowTimeConfig.show();});$(this.container).find('.divConfigConfirm').off('click').on('click',function(e){$(_this.ctnTimeConfig).hide();$btnShowTimeConfig.show();_this.chartPreSet();});$(this.divTimeConfig).find('.divTimeMode>select').off('change').on('change',function(e){_this.createTimeRange(parseInt(e.currentTarget.value))});$('#paneCenter').off('dragstart').on('dragstart','[data-h5-draggable-node]',function(e){EventAdapter.setData({dsItemId:e.currentTarget.dataset.dsId})});var $ctnChart=$(this.ctnChart);$ctnChart.off('dragover').on('dragover',function(e){e.preventDefault();});$ctnChart.off('dragleave').on('dragleave',function(e){e.preventDefault();});$ctnChart.off('drop').on('drop',function(e){e.preventDefault();var id=EventAdapter.getData().dsItemId;for(var i=0;i<this.store.length;i++){if(this.store[i].id==id){(typeof infoBox!='undefined')&&infoBox.alert(I18n.resource.dashboard.modalHistoryDataAnalyze.POINT_EXIST_TIP);return;}}
this.store.push({id:id});this.chartPreSet();});$btnShowTimeConfig.off('click').on('click',function(){$(_this.ctnTimeConfig).show();$btnShowTimeConfig.hide();});};ModalHistoryDataAnalyze.prototype.showConfigMode=function(){};return ModalHistoryDataAnalyze})();﻿
var ModalCarbonFootprint=(function(){function ModalCarbonFootprint(containerId,entityParams){ModalBase.call(this,containerId,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.isFirstTime=true;this.widthRuler=undefined;this.$elMask=undefined;this.elPaneValue=undefined;this.elPaneTitle=undefined;this.maxValue=undefined;};ModalCarbonFootprint.prototype=new ModalBase();ModalCarbonFootprint.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CARBON_FOOTPRINT',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:3,minWidth:4,maxHeight:6,maxWidth:12,type:'ModalCarbonFootprint'};ModalCarbonFootprint.prototype.renderModal=function(){if(this.isFirstTime)this.init();},ModalCarbonFootprint.prototype.init=function(){var _this=this;WebAPI.get('/static/scripts/spring/entities/modalCarbonFootprint.html').done(function(resultHTML){_this.container.innerHTML=resultHTML;_this.initStandard();_this.isFirstTime=false;I18n.fillArea($('.divCFTitle').parent());});},ModalCarbonFootprint.prototype.initStandard=function(){$divMain=$(this.container);this.widthRuler=$divMain.find('.cfProcessScale').width();this.$elMask=$divMain.find('.cfProcessMask');this.elPaneValue=document.getElementById('cfFootprintDashboardCurrent');this.elPaneTitle=document.getElementById('divCFTitle');var unitValue=this.entity.modal.option.valueStandard/4;this.maxValue=unitValue*5;var tdScaleNums=this.container.getElementsByClassName('cfProcessScaleNum');for(var i=0,len=tdScaleNums.length;i<len;i++){tdScaleNums[i].textContent=parseInt(unitValue*i).toString();}
$divMain.find('.cfLegendBarWarning').animate({width:this.widthRuler*0.2+'px'},1000);document.getElementById('cfFootprintDashboardStandard').textContent=this.entity.modal.option.valueStandard;},ModalCarbonFootprint.prototype.updateModal=function(points){var value=parseFloat(points[0].data).toFixed(1).toString();this.elPaneValue.textContent=value;this.elPaneTitle.textContent=value;this.$elMask.animate({width:this.widthRuler-value*this.widthRuler/this.maxValue+'px'},1000);},ModalCarbonFootprint.prototype.showConfigMode=function(){};ModalCarbonFootprint.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.valueStandard=3500;};return ModalCarbonFootprint;})();var ModalAppChart=(function(){function ModalAppChart(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.dicPeriod={'30s':30000,'m1':60000,'m5':300000,'10m':600000,'30m':1800000,'h1':3600000,'d1':86400000,'M1':2592000000}}
ModalAppChart.prototype=new ModalBase();ModalAppChart.prototype.optionTemplate={name:'toolBox.modal.APP_CHART',parent:3,mode:['realTime'],maxNum:10,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalAppChart'};ModalAppChart.prototype.optionDefault={color:['#E2583A','#FD9F08','#1D74A9','#04A0D6','#689C0F','#109d83','#FEC500'],title:{textStyle:{fontWeight:'normal',color:'#008acd'}},legend:{textStyle:{fontFamily:"Microsoft YaHei",fontSize:10}},dataRange:{itemWidth:15,color:['#5ab1ef','#e0ffff']},toolbox:{x:'right',y:'center',feature:{mark:{show:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}},color:['#1e90ff','#1e90ff','#1e90ff','#1e90ff'],effectiveColor:'#ff4500'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{color:'#008acd'},crossStyle:{color:'#008acd'},shadowStyle:{color:'rgba(200,200,200,0.2)'}}},dataZoom:{dataBackgroundColor:'#efefff',fillerColor:'rgba(182,162,222,0.2)',handleColor:'#008acd'},grid:(function(isMobile){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:50,top:40}
if(isMobile){grid.x=40;}
return grid;}(AppConfig.isMobile)),categoryAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitLine:{lineStyle:{color:['#eee']}}},valueAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']}},splitLine:{lineStyle:{color:['#eee']}}},polar:{axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{lineStyle:{color:'#008acd'},controlStyle:{normal:{color:'#008acd'},emphasis:{color:'#008acd'}},symbol:'emptyCircle',symbolSize:3},bar:{itemStyle:{normal:{barBorderRadius:5},emphasis:{barBorderRadius:5}},barMaxWidth:80},line:{smooth:true,symbol:'none',symbolSize:3},k:{itemStyle:{normal:{color:'#d87a80',color0:'#2ec7c9',lineStyle:{color:'#d87a80',color0:'#2ec7c9'}}}},scatter:{symbol:'circle',symbolSize:4},radar:{symbol:'emptyCircle',symbolSize:3},map:{itemStyle:{normal:{areaStyle:{color:'#ddd'},label:{textStyle:{color:'#d87a80'}}},emphasis:{areaStyle:{color:'#fe994e'}}}},force:{itemStyle:{normal:{linkStyle:{color:'#1e90ff'}}}},chord:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}},emphasis:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}}}},gauge:{axisLine:{lineStyle:{color:[[0.2,'#2ec7c9'],[0.8,'#5ab1ef'],[1,'#d87a80']],width:10}},axisTick:{splitNumber:10,length:15,lineStyle:{color:'auto'}},splitLine:{length:22,lineStyle:{color:'auto'}},pointer:{width:5}},textStyle:{fontFamily:'微软雅黑, Arial, Verdana, sans-serif'}};ModalAppChart.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme);this.chart.setOption(this.options);},ModalAppChart.prototype.updateModal=function(pointName,pointValue){},ModalAppChart.prototype.showConfigMode=function(){},ModalAppChart.prototype.dsChartCog=function(cog,option){if(!cog)return;if(cog[0].upper)option.yAxis[0].max=cog[0].upper;if(cog[0].lower)option.yAxis[0].min=cog[0].lower;if(cog[0].unit)option.yAxis[0].name=cog[0].unit;if(cog[0].markLine){if(!option.series[0].markLine){option.series[0].markLine={};option.series[0].markLine.data=new Array();}
for(var i in cog[0].markLine){var markLine=cog[0].markLine[i];if(!markLine.value)continue;var arr=[{name:markLine.name,xAxis:-1,yAxis:markLine.value},{name:markLine.name,xAxis:option.series[0].data.length,yAxis:markLine.value}];option.series[0].markLine.data.push(arr);}}}
ModalAppChart.prototype.coordinate=function(e){var arr=[];var endTime=new Date().valueOf();if(e=='m1'){var startTime=endTime-21600000;var interval=60000;while(startTime<=endTime){arr.push(new Date(startTime).format('HH:mm'));startTime+=interval;}}else if(e=='m5'){var startTime=endTime-86100000;var interval=300000;while(startTime<=endTime){arr.push(new Date(startTime-startTime%300000).format('HH:mm'));startTime+=interval;}}else if(e=='h1'){var startTime=endTime-82800000;var interval=3600000;while(startTime<=endTime){arr.push(new Date(startTime).format('HH:00'));startTime+=interval;}}else if(e=='d1'){var startTime=endTime-2592000000;var interval=86400000;while(startTime<=endTime){arr.push(new Date(startTime).format('yyyy-MM-dd'));startTime+=interval;}}else if(e=='M1'){var fullYear=new Date().getFullYear()-1;var month=new Date().getMonth()+1;var interval=1;for(var i=0;i<12;i++){var startTime=fullYear+'-'+month;arr.push(startTime);month=month%12+interval;if(month===1){fullYear+=1;}}}
return[{data:arr}];}
return ModalAppChart;})();var ModalAppGauge=(function(){function ModalAppGauge(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppGauge.prototype=new ModalBase();ModalAppGauge.prototype.optionTemplate={name:'toolBox.modal.APP_GAUGE_CHART',parent:3,mode:['appGauge'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppGauge',tooltip:{'imgPC':true,'imgMobile':true,'isSpecData':false,'desc':''}};ModalAppGauge.prototype.optionDefault={tooltip:{formatter:"{a} <br/>{b} : {c}"},backgroundColor:'#2f91e8',animation:true,animationDuration:1000,animationDurationUpdate:1000,toolbox:{show:false},title:{show:true,text:'项目实时评估得分',textStyle:{fontWeight:'100',fontFamily:'Microsoft Yahei',fontSize:16,color:'#fff'},x:'center'},series:[{type:'gauge',splitNumber:4,center:['50%','55%'],radius:'75%',startAngle:-270,endAngle:89.9999,axisLine:{show:false,lineStyle:{width:13,opacity:0}},axisTick:{splitNumber:20,length:12,lineStyle:{color:'auto',width:2}},axisLabel:{show:true,textStyle:{color:'#eee'}},splitLine:{show:true,length:12,lineStyle:{width:2,color:'auto'}},pointer:{show:false},itemStyle:{normal:{opacity:0}},title:{show:true,textStyle:{fontWeight:'bolder',color:'white'},offsetCenter:[0,'-40%']},detail:{formatter:'{value}',offsetCenter:['0%','-5%'],textStyle:{color:'#fff',fontSize:36}}}]};ModalAppGauge.prototype.renderPercentPlane=function(points){if(points.length<1)return;var c=document.getElementById('gaugeTop'),d=document.getElementById('gaugeBottom'),circleLength,rotDegree,ctx=c.getContext('2d'),ctd=d.getContext('2d'),containerWidth=$(this.container).width(),containerHeight=$(this.container).height(),circleRadius=containerWidth<containerHeight?containerWidth:containerHeight,dw=d.width=cw=c.width=containerWidth,dh=d.height=ch=c.height=containerHeight,data=points[0].data,guageOption={'guageTitle':points[1].guageTitle?points[1].guageTitle:'','guageFixed':points[1].guageFixed?points[1].guageFixed:0,'guageUnit':points[1].guageUnit?points[1].guageUnit:'','guageMax':points[1].guageMax?points[1].guageMax:''},optionData={startData:0,totalTime:200,},animFrame=null,dToR=function(degrees){return degrees*(Math.PI/180);},minRadiusValue=(parseInt(circleRadius/3)+20)<(parseInt(circleRadius/2))?(parseInt(circleRadius/3)+20):(parseInt(circleRadius/2)),circle={x:(cw/2),y:parseInt(circleRadius/3)+50,radius:minRadiusValue,speed:parseInt(data/(optionData.totalTime/16.7)),rotation:0,angleEnd:360,hue:200,blur:10};(function(){var lastTime=0;var vendors=['ms','moz','webkit','o'];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+'RequestAnimationFrame'];window.cancelAnimationFrame=window[vendors[x]+'CancelAnimationFrame']||window[vendors[x]+'CancelRequestAnimationFrame'];}
if(!window.requestAnimationFrame)window.requestAnimationFrame=function(callback,element){var currTime=new Date().getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall);},timeToCall);lastTime=currTime+timeToCall;return id;};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(id){clearTimeout(id);};}());function setOption(){if(data>100){if(guageOption.guageUnit=='%'&&guageOption.guageMax!=''){data=parseFloat(data/guageOption.guageMax).toFixed(guageOption.guageFixed);}else if(guageOption.guageUnit=='%'&&guageOption.guageMax==''){}else if(guageOption.guageUnit!='%'&&guageOption.guageMax!=''){}
else{data=100;}}
rotDegree=data*3.6;!data&&(data=0);circleLength=120;data<=25&&(circleLength=90);data<=15&&(circleLength=50);data<=8&&(circleLength=25);data<=2&&(circleLength=1);};function updateCircle(){circle.rotation<circle.angleEnd?circle.rotation+=circle.speed:circle.rotation=0;};function renderStaticCanvas(){var fontSize=15;ctd.shadowColor='rgba(240, 240, 240, 0.3)';ctd.shadowBlur=2;ctd.shadowoffsetx=5;ctd.shadowoffsety=5;ctd.beginPath();ctd.arc(circle.x,circle.y,circle.radius,0,Math.PI*2,true);ctd.lineWidth=4;ctd.strokeStyle='rgba(240, 240, 240, 0.3)';ctd.stroke();var titleWidth=Math.sqrt(circle.radius*circle.radius-70*70)*2;ctd.font='20px 微软雅黑';ctd.fillStyle='#9ea0ba';ctd.textBaseline='middle';ctd.textAlign='center';if(titleWidth&&ctd.measureText(guageOption.guageTitle).width<titleWidth){ctd.fillText(guageOption.guageTitle,circle.x-5,circle.y+40);}else{StringTools.wordWrap(ctd,circle.x,circle.y+40,titleWidth,guageOption.guageTitle,null);}};function renderProgressBar(){ctd.clearRect(0,0,cw,ch);renderStaticCanvas();ctd.beginPath();ctd.shadowBlur=2;ctd.shadowoffsetx=5;ctd.shadowoffsety=5;ctd.lineWidth=4;ctd.strokeStyle='rgba(222,222,222,0.8)';ctd.lineCap="round";ctd.arc(circle.x,circle.y,circle.radius,-90*Math.PI/180,-(optionData.startData+90)*Math.PI/180,true);ctd.stroke();};function renderPercentCircle(){renderText();if(optionData.startData<=rotDegree){animFrame=window.requestAnimationFrame(renderPercentCircle);renderProgressBar();optionData.startData+=circle.speed;clear();updateCircle();renderText();renderCircle();for(var i=0;i<circleLength;i+=1){renderCircleFlare(i,circleLength);}}
else{window.cancelAnimationFrame(animFrame);}};function renderText(){var percentText=optionData.startData>rotDegree?parseInt(data)+guageOption.guageUnit:parseInt(optionData.startData/3.6)+guageOption.guageUnit;ctx.shadowColor='rgba(0, 0, 0, 0.6)';ctx.shadowOffsetX=5;ctx.shadowOffsetY=4;ctx.shadowBlur=8;ctx.font=parseInt(circle.radius*1/2)+'px 微软雅黑';ctx.fillStyle='#fff';ctx.textBaseline='middle';ctx.textAlign='center';var textWidth=ctx.measureText(percentText).width+20;ctx.clearRect(circle.x-textWidth/2,circle.y-55,textWidth,110);ctx.fillText(percentText,circle.x,circle.y-10);};function renderRefreshText(){var refreshTime=new Date().format('yyyy-MM-dd HH:mm');ctd.clearRect(0,0,100,30);ctd.font='10px 微软雅黑';ctd.fillStyle='rgba(255,255,255,0.6)';ctd.fillText(refreshTime,5,15);};function renderCircleFlare(i,circleLength){var count=1-parseFloat(i/circleLength);ctx.save();ctx.translate(circle.x,circle.y);ctx.rotate(-dToR(circle.rotation+180-i));ctx.scale(1,1);ctx.beginPath();ctx.arc(0,circle.radius,10*count,0,Math.PI*2,false);ctx.closePath();ctx.shadowColor='rgba(255, 255, 255, 0)';var gradient3=ctx.createRadialGradient(0,circle.radius,0,0,circle.radius,12);gradient3.addColorStop(0,'rgba(255, 255, 255, '+parseFloat(0.06*count)+')');gradient3.addColorStop(1,'rgba(255, 255, 255, 0)');ctx.fillStyle=gradient3;ctx.fill();ctx.restore();};function renderCircle(){ctx.save();ctx.translate(circle.x,circle.y);ctx.rotate(-dToR(circle.rotation+180));ctx.scale(1,1);ctx.beginPath();ctx.arc(0,circle.radius,10,0,Math.PI*2,false);ctx.closePath();ctx.shadowColor='rgba(255, 255, 255, 0)';var gradient4=ctx.createRadialGradient(0,circle.radius,0,0,circle.radius,12);gradient4.addColorStop(0,'rgba(255, 255, 255, '+0.08+')');gradient4.addColorStop(1,'rgba(255, 255, 255, 0)');ctx.fillStyle=gradient4;ctx.fill();ctx.restore();};clear=function(){ctx.globalCompositeOperation='destination-out';ctx.fillStyle='rgba(255, 255, 255, 0.2)';ctx.fillRect(0,0,cw,ch);ctx.globalCompositeOperation='lighter';};setOption();renderPercentCircle();ctd.shadowColor='rgba(222,222,222,0.3)';ctd.shadowBlur=3;ctd.shadowoffsetx=5;ctd.shadowoffsety=5;ctx.shadowColor='hsla('+circle.hue+', 80%, 60%, 1)';ctx.lineCap='round';this.spinner.stop();}
ModalAppGauge.prototype.renderModal=function(){var canvasModal='<canvas id="gaugeTop"></canvas><canvas id="gaugeBottom"></canvas>';$(this.container).append(canvasModal);$('#gaugeTop',this.container).css({'display':'block','position':'absolute','top':'0','left':'0','zIndex':'11'});$('#gaugeBottom',this.container).css({'display':'block','position':'absolute','top':'0','left':'0','zIndex':'10','background':'rgba(0,0,0,0)'});},ModalAppGauge.prototype.updateModal=function(points){if(!AppConfig.isMobile){if(points.length<1)return;var _this=this;var dataSeries;if(parseFloat(points[0].data)>100){this.optionDefault.series[0].max=parseFloat(points[0].data).toFixed(0);this.optionDefault.series[0].formatter=function(v){switch(v+''){case(parseFloat(points[0].data)/4).toFixed(0):return(parseFloat(points[0].data)/4).toFixed(0);case(parseFloat(points[0].data)/2).toFixed(0):return(parseFloat(points[0].data)/2).toFixed(0);case(parseFloat(points[0].data)*3/4).toFixed(0):return(parseFloat(points[0].data)*3/4).toFixed(0);case parseFloat(points[0].data).toFixed(0):return parseFloat(points[0].data).toFixed(0);default:return'';}}}else{this.optionDefault.series[0].max=100;this.optionDefault.series[0].formatter=function(v){switch(v+''){case'25':return'25';case'50':return'50';case'75':return'75';case'0':return'0';default:return'';}}}
if(points[1]){if(points[1].guageTitle){this.optionDefault.title.text=points[1].guageTitle;}
var guageFulTitle=points[1].guageFulTitle?points[1].guageFulTitle:'';if(points[1].guageFixed===0||points[1].guageFixed){dataSeries=parseFloat(points[0].data).toFixed(points[1].guageFixed);}else{dataSeries=parseFloat(points[0].data).toFixed(2);}
if(parseFloat(points[0].data)>100){this.optionDefault.series[0].max=parseFloat(points[0].data).toFixed(0);this.optionDefault.series[0].formatter=function(v){switch(v+''){case(parseFloat(points[0].data)/4).toFixed(0):return(parseFloat(points[0].data)/4).toFixed(0);case(parseFloat(points[0].data)/2).toFixed(0):return(parseFloat(points[0].data)/2).toFixed(0);case(parseFloat(points[0].data)*3/4).toFixed(0):return(parseFloat(points[0].data)*3/4).toFixed(0);case parseFloat(points[0].data).toFixed(0):return parseFloat(points[0].data).toFixed(0);default:return'';}}}else{this.optionDefault.series[0].max=100;this.optionDefault.series[0].formatter=function(v){switch(v+''){case'25':return'25';case'50':return'50';case'75':return'75';case'0':return'0';default:return'';}}}
if(points[1].guageUnit){this.optionDefault.series[0].detail.formatter='{value}'+points[1].guageUnit;}
var guageDirect=points[1].guageDirect?points[1].guageDirect:'';if(guageDirect==='antiClockwise'){this.optionDefault.series[0].startAngle=-270;this.optionDefault.series[0].endAngle=89.9999;}else{this.optionDefault.series[0].startAngle=90;this.optionDefault.series[0].endAngle=-269.9999;}
if(points[1].guageBgColor){this.optionDefault.backgroundColor=points[1].guageBgColor;}
if(points[1].transDataDot){var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};var currentRGB=points[1].guageBgColor.colorRgb();var rgb=currentRGB.split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var finalRGB='rgba('+r+','+g+','+b+','+points[1].transDataDot+')';this.optionDefault.backgroundColor=finalRGB;}}
this.optionDefault.series[0].data=[{value:dataSeries,name:guageFulTitle}];this.optionDefault.series[0].axisLine.lineStyle.color=function(){var arrColor=['tomato','#f7ba49','#11fff1','#89dd4b'];var seriesDataInt=parseInt(dataSeries);var numCount=dataSeries.toString().length;var numCount1=numCount-2<=0?1:(numCount-2);var numFinally=Math.pow(10,numCount1);var kpiColor;if(seriesDataInt>100){kpiColor='#89dd4b';}else{kpiColor=arrColor[Math.floor(Math.abs(seriesDataInt-1)/25)];}
return[[seriesDataInt/100,kpiColor],[1,'#87a8c5']];}();!this.chart&&(this.chart=echarts.init(this.container,AppConfig.chartTheme));this.chart.setOption(this.optionDefault);var spanTime='<span class="spanTime" style="position:absolute;color:#fff">'+new Date().format('yyyy-MM-dd')+'</span>'
$(this.container).find('.spanTime').empty().remove();$(this.container).append(spanTime);var timeLocal=points[1].timeLocal?points[1].timeLocal:'leftTop';if(timeLocal){var $spanTimeDom=$(this.container).find('.spanTime');if(timeLocal==='leftTop'){$spanTimeDom.css({'top':'10px','left':'10px'});}else if(timeLocal==='rightTop'){$spanTimeDom.css({'top':'10px','right':'10px'});}else if(timeLocal==='leftBottom'){$spanTimeDom.css({'bottom':'10px','left':'10px'});}else{$spanTimeDom.css({'bottom':'10px','right':'10px'});}}}else{this.renderPercentPlane(points);}},ModalAppGauge.prototype.showConfigMode=function(){},ModalAppGauge.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.guageTitle=option.guageTitle;this.entity.modal.option.guageFulTitle=option.guageFulTitle;this.entity.modal.option.guageFixed=option.guageFixed;this.entity.modal.option.guageUnit=option.guageUnit;this.entity.modal.option.guageMax=option.guageMax;this.entity.modal.option.timeLocal=option.timeLocal;this.entity.modal.option.guageDirect=option.guageDirect;this.entity.modal.option.guageBgColor=option.guageBgColor;this.entity.modal.option.transDataDot=option.transDataDot;this.entity.modal.interval=5;};return ModalAppGauge;})();var ModalAppButton=(function(){var _this;function ModalAppButton(screen,entityParams,_renderModal,_updateModal,_showConfigMode){_this=this;if(!screen)return;this.screen=screen;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppButton.prototype=new ModalBase();ModalAppButton.prototype.optionTemplate={name:'toolBox.modal.APP_BUTTON',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:1.5,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppButton',tooltip:{'imgPC':false,'imgMobile':true,'isSpecData':false,'desc':''}};ModalAppButton.prototype.show=function(){this.init();};ModalAppButton.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalAppButton.prototype.configure=function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();var oldIndex=_this.screen.arrEntityOrder.indexOf(_this.entity.id);if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
_this.screen.isScreenChange=true;var entity=new ModalNone(_this.screen,{id:_this.entity.id,spanC:_this.entity.spanC,spanR:_this.entity.spanR,modal:{type:"ModalNone"}},_this.entity.id);_this.screen.arrEntityOrder.splice(oldIndex,0,entity.entity.id);_this.screen.listEntity[entity.entity.id]=entity;entity.render();entity.configure();entity.hasEdit=true;_this=null;})};divMask.appendChild(btnRemove);if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
var btnHeightResize=document.createElement('div');var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};_this.entity.modal.interval='300000';this.container.parentNode.appendChild(divMask);if(this.entity.isNotRender&&this.screen.listEntity){var parentId=undefined,subChartIds;if(this.entity&&this.entity.id){parentId=this.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}
if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
this.divResizeByToolInit();this.executeConfigMode();};ModalAppButton.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();var divAppButton,divIcon,divDetail,spName,spValue,spUnit;var $springContentCur=$(this.container);$springContentCur.css("overflow","auto");var appButtonArr=_this.entity.modal.option.appButton;var len=appButtonArr.length;var staticColor=['#5A95F7','#FBDE54','#89D164','#89D164','#5A95F7','#23D29C'];for(var i=0;i<len;i++){divAppButton=document.createElement('div');divAppButton.className='divAppButton';if(appButtonArr[i].link!==''){divAppButton.setAttribute('data-link-to',appButtonArr[i].link);}
if(appButtonArr[i].linkType!==''){divAppButton.setAttribute('data-type',appButtonArr[i].linkType);}
$(divAppButton).on('tap',function(){var triggerId=$(this).attr('data-link-to');var dataType=$(this).attr('data-type');var linkName=$(this).find('.divMonitorInfo .spName').text();if(!triggerId)return;if(!AppConfig.isMobile){ScreenManager.show(EnergyScreen,triggerId);}else{var isIndex=dataType=='EnergyScreen_M';router.to({typeClass:ProjectDashboard,data:{menuId:triggerId,isIndex:isIndex,name:linkName}})}});switch(len){case 1:divAppButton.className+=' divAppButtonOne col-xs-6 zepto-ev';break;case 2:divAppButton.className+=' divAppButtonTwo col-xs-6 zepto-ev';break;case 3:divAppButton.className+=' divAppButtonThree col-xs-4 zepto-ev';break;case 4:divAppButton.className+=' divAppButtonFour col-xs-6 zepto-ev';break;case 5:divAppButton.className+=' divAppButtonFive col-xs-4 zepto-ev';break;case 6:divAppButton.className+=' divAppButtonSix col-xs-4 zepto-ev';break;default:divAppButton.className+=' divAppButtonSix col-xs-4 zepto-ev';break;}
divIcon=document.createElement('div');var curType=appButtonArr[i].iconType?appButtonArr[i].iconType:'bootIcon';if(curType==='image'){divIcon.className='divIcon glyphicon';var imgDom=appButtonArr[i].icon.split('@*')[1];if(AppConfig.isMobile){$(divIcon).html(imgDom);}else{imgDom=appButtonArr[i].icon.split('@*')[1].split('=')[0]+'='+appButtonArr[i].icon.split('@*')[1].split('=')[1].replace(/(.{1})/,'"/');$(divIcon).html(imgDom);}}else if(curType==='svg'){divIcon.className='divIcon glyphicon';$(divIcon).html(appButtonArr[i].icon.split('@*')[1]);}else{divIcon.className='divIcon '+appButtonArr[i].icon;}
if(appButtonArr[i].icon)divIcon.style.color=appButtonArr[i].iconColor;divDetail=document.createElement('div');divDetail.className='divMonitorInfo';spName=document.createElement('span');spName.className='spName';spName.textContent=appButtonArr[i].name;if(appButtonArr[i].backColor==""){divIcon.style.background='transparent'}else{divIcon.style.background=appButtonArr[i].backColor;}
divDetail.appendChild(spName);divAppButton.appendChild(divIcon);divAppButton.appendChild(divDetail);_this.container.appendChild(divAppButton);}
$(_this.container).addClass('backOperate');if($springContentCur.height()<200){$springContentCur.find('.divIcon').addClass('divIconLittle');$springContentCur.find('.divMonitorInfo').addClass('divMonitorInfoLit');}else{$springContentCur.find('.divIcon').removeClass('divIconLittle');$springContentCur.find('.divMonitorInfo').removeClass('divMonitorInfoLit');}};ModalAppButton.prototype.showConfigMode=function(){};ModalAppButton.prototype.showConfigModal=function(){_this.tempOpt=$.extend(true,{},this.entity.modal);var configModalTpl='\
                <div id="ModalAppButtonConfig" class="modal fade"  role="dialog" aria-labelledby="ttlNodeTool">\
                    <div class="modal-dialog">\
                        <div class="modal-content">\
                            <div class="modal-header">\
                                <span id="btnMonitorAdd" class="glyphicon glyphicon-plus-sign btnMonitorAdd grow"></span>\
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                                <h4 class="modal-title" id="ttlNodeTool">Diagnosis Edit</h4>\
                            </div>\
                            <div class="modal-body gray-scrollbar" id="ctnMonitor">\
                            </div>\
                            <div class="modal-footer">\
                                <input type ="color">\
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
                                <button type="button" class="btn btnSure btn-primary">Save</button>\
                            </div>\
                        </div>\
                    </div>\
                </div>';_this.$configModal=$('#ModalAppButtonConfig');if(_this.$configModal.length==0)_this.$configModal=$(configModalTpl);_this.$configModal.appendTo($(_this.container).parentsUntil('.springContainer').parent().parent());var $ctnMonitor=_this.$configModal.find('#ctnMonitor').html('');var btnAdd=_this.$configModal.find('#btnMonitorAdd')[0];btnAdd.title='Monitor Type Add';btnAdd.onclick=function(){$ctnMonitor.append(_this.createDivMonitor());_this.attachMonitorEvent();};if(this.entity.modal.option&&this.entity.modal.option.appButton&&this.entity.modal.option.appButton.length>0){for(var i=0;i<this.entity.modal.option.appButton.length;i++){if(this.entity.modal.option.appButton[i].entityId===this.entity.id){$ctnMonitor[0].appendChild(_this.createDivMonitor(this.entity.modal.option.appButton[i]));}}}else{$ctnMonitor[0].appendChild(_this.createDivMonitor());}
_this.$configModal.modal('show');_this.$configModal.find('.btnSure').off('click').on('click',function(){if(_this.tempOpt.option.appButton&&_this.tempOpt.option.appButton.length>0){var appButtonArr=_this.tempOpt.option.appButton;for(var i=0;i<appButtonArr.length;i++){if(!appButtonArr[i].entityId){appButtonArr[i].entityId=_this.entity.id;}}}
_this.entity.modal=$.extend(true,{},_this.tempOpt);_this.$configModal.modal('hide');});_this.attachMonitorEvent();};ModalAppButton.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalAppButton.prototype.close=function(){_this.entity=null;this.entity=null;}
ModalAppButton.prototype.createDivMonitor=function(opt){var divMonitor=document.createElement('div');divMonitor.className='divMonitor';var $divMonitor=$(divMonitor);divMonitor.innerHTML='\
            <div class="divIcon"></div>\
            <div class="divMonitorInfo">\
                <div class="divName">\
                    <label>name:</label>\
                    <span class="spName"></span>\
                    <input class="iptName form-control" ></input>\
                </div>\
                <div class="divLink">\
                    <label>link:</label>\
                    <select class="form-control linkList"></select>\
                </div>\
            </div>\
            <div class="divMonitorDel glyphicon glyphicon-remove-circle"></div>';var $linkList=$divMonitor.find('select.linkList');$linkList[0].options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,''));if(AppConfig.menu.length>0){for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);if(opt&&opt.link&&opt.link==i){option.selected='selected';}
$linkList[0].options.add(option);}}else{if(_this.screen.facScreen){var pageDataMenus=_this.screen.facScreen.pagePanel.getPageList();for(var i=0;i<pageDataMenus.length;i++){var option=new Option(pageDataMenus[i].text,pageDataMenus[i]._id);$(option).attr('data-type',pageDataMenus[i].type);if(opt&&opt.link&&opt.link==pageDataMenus[i]._id){option.selected='selected';}
$linkList[0].options.add(option);}}}
$linkList[0].onchange=function(){var index=$('#ctnMonitor').children().index($divMonitor);_this.tempOpt.option.appButton[index].link=$linkList[0].value;_this.tempOpt.option.appButton[index].linkType=$(this).find('option:selected').attr('data-type');};if(opt&&opt.icon){var curType=opt.iconType?opt.iconType:'bootIcon';if(curType==='image'||curType==='svg'){$divMonitor.find('.divIcon').addClass('glyphicon');$divMonitor.find('.divIcon').html(opt.icon.split('@*')[1]);}else{$divMonitor.find('.divIcon').addClass(opt.icon);}
if(opt.iconColor)$divMonitor.find('.divIcon').css({'color':opt.iconColor,'box-shadow':'0 0 15px '+opt.iconColor})}else{$divMonitor.find('.divIcon').addClass('glyphicon glyphicon-plus').css('color','black');}
if(opt&&opt.name){$divMonitor.find('.spName').show().text(opt.name);$divMonitor.find('.iptName').hide().val(opt.name)}else{$divMonitor.find('.spName').hide();$divMonitor.find('.iptName').show();}
if(opt&&opt.backColor){$divMonitor.css('background',opt.backColor);}
if(!opt){if(!_this.tempOpt.option){_this.tempOpt.option={};}
if(!_this.tempOpt.option.appButton){_this.tempOpt.option.appButton=[];}
_this.tempOpt.option.appButton.push({icon:'glyphicon glyphicon-plus',iconColor:'#000000',name:'',link:'',backColor:'',linkType:''})}
return divMonitor};ModalAppButton.prototype.attachMonitorEvent=function(){var $ctnMonitor=_this.$configModal.find('#ctnMonitor');var $iptColor;var indexDivMonitor;$ctnMonitor.find(".divMonitor").off('click').on('click',function(){var currentBg=$(this).css('background');$ctnMonitor.find(".divMonitor").css("border","1px dotted");indexDivMonitor=$ctnMonitor.find(".divMonitor").index($(this));$(this).css("border","1px solid black");})
$(".modal-footer").find("input").off("change").on("change",function(){var colorVal=$(this).val();var rgb=colorVal.colorRgb().split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var hsl=rgbToHsl(r,g,b);var hslEndL=hsl[2]+0.05;var rgbStartColor=hslToRgb(hsl[0],hsl[1],hsl[2]);var rgbEndColor=hslToRgb(hsl[0],hsl[1],hslEndL);var backColor='-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(rgb('+rgbStartColor[0]+','+rgbStartColor[1]+','+rgbStartColor[2]+')), to(rgb('+rgbEndColor[0]+','+rgbEndColor[1]+','+rgbEndColor[2]+'))';if(indexDivMonitor!==0){if(!indexDivMonitor)return;}
_this.tempOpt.option.appButton[indexDivMonitor].backColor=colorVal;$ctnMonitor.find(".divMonitor").eq(indexDivMonitor).css("background",colorVal);})
var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return[h,s,l];}
function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var hue2rgb=function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
$(".divMonitor").on('click','.divIcon',function(e){e.stopPropagation();$('#ctnMonitor .divMonitor.selected').removeClass('selected');var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').addClass('selected');var index=$ctnMonitor.children().index($divMonitor);var currentEntityId=_this.entity.id;var thisEntity=_this.tempOpt.option.appButton[index];new ModalIconManage().show(thisEntity,currentEntityId,callback);function callback(icon,color,iconType){if(iconType==='svg'||iconType==='image'){$divMonitor.find('.divIcon').eq(0).html(icon.split('@*')[1]);$divMonitor.find('.divIcon').eq(0).attr('class','divIcon glyphicon');}else{$divMonitor.find('.divIcon').eq(0).html('');$divMonitor.find('.divIcon')[0].className='divIcon '+icon;$divMonitor.find('.divIcon').css({'color':color,'box-shadow':'0 0 15px '+color});}}});$(".divMonitor").on('click','.divMonitorDel',function(e){var index=$ctnMonitor.children().index($(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor'));$ctnMonitor.children().eq(index).remove();_this.tempOpt.option.appButton.splice(index,1);_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}});$(".divMonitor").on('click','.spName',function(e){$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptName').show().focus();});$ctnMonitor.off('blur').on('blur','input',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();if($(e.currentTarget).hasClass('iptName')){_this.tempOpt.option.appButton[index].name=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spName').text(value).show();}
_this.tempOpt.option.appButton[index].entityId=_this.entity.id;});$ctnMonitor.find('.linkList').off('change').on('change',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();_this.tempOpt.option.appButton[index].entityId=_this.entity.id;if($(e.currentTarget).hasClass('linkList')){_this.tempOpt.option.appButton[index].link=value;if(!value)return;}})};return ModalAppButton;})();var ModalAppHistory=(function(){function ModalAppHistory(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.attachEvent();this.echarShowName=[];this.echarShowData=[];this.echarShowTime=undefined;this.dataInfo=[];};ModalAppHistory.prototype=new ModalBase();ModalAppHistory.prototype.showConfigMode=function(){},ModalAppHistory.prototype.updateModal=function(points){},ModalAppHistory.prototype.optionTemplate={name:'toolBox.modal.APP_HISTORY_QUERY',parent:3,mode:['appGauge'],maxNum:1,title:'',minHeight:4,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppHistory',scroll:false,tooltip:{'imgPC':false,'imgMobile':true,'isSpecData':false,'desc':''}};ModalAppHistory.prototype.echarsShow=function(data,time){var option={tooltip:{trigger:'axis',axisPointer:{type:'shadow'},position:function(point,params,dom){return[50,point[1]];}},toolbox:{show:true,feature:{magicType:{type:['line','bar','stack','tiled']},},top:15,showTitle:true},grid:{left:'3%',right:'4%',bottom:'3%',top:50,containLabel:true},axisLabel:{formatter:function(value){if(value>=1000||value<=-1000){return value/1000+'k';}else{return value;}}},xAxis:[{type:'category',axisTick:{alignWithLabel:true},data:time}],yAxis:[{type:'value'}],series:data}
if(this.chart){this.chart.clear();}
var $chartContainer=$(this.container).find("#chartBox");var pWidth=$(this.container).width();$chartContainer.css('width',pWidth+'px');!this.chart&&(this.chart=echarts.init($chartContainer[0],AppConfig.chartTheme));this.chart.setOption(option);this.spinner&&this.spinner.stop();};ModalAppHistory.prototype.layoutStyle=function(points){var _this=this;var $chartBox=$('<div id="chartBox" style="height:235px;"></div>');$chartBox.appendTo(this.container);var btnCtn='<div class="switchBtnCtn">\
                            <div class="switch">\
                                <div class="circle"></div>\
                            </div>\
                            <button type="button" class="btn btn-default configBtn" i18n="toolBox.APP_HISTORY_QUERY.CONFIG_BTN"></button>\
                        </div>';$(btnCtn).appendTo(this.container);var $middlePointers=$('<div class="middlePointers gray-scrollbar"><div class="listDataBox"></div></div>');$middlePointers.appendTo(this.container);var $bottomBox=$('<div class="bottomBox" style="display:none;"></div>');$bottomBox.appendTo(this.container);var content='<div id="bottomPoints">\
                    </div>\
                    <div id="bottomAppHistory">\
                        <div class="bottomAppHistoryTitle" i18n="toolBox.APP_HISTORY_QUERY.TITLE"></div>\
                        <span class="glyphicon glyphicon-remove closeBtn"></span>\
                        <div class="bottomAppHistoryContent">\
                            <div class="clearfix hisCommenBox">\
                                <div class="col-xs-4 hisCommen" i18n="toolBox.APP_HISTORY_QUERY.PERIOD">采样周期</div>\
                                <select class="col-xs-6 hisCommen" id="timePeriod" value="h1">\
                                    <option value="m5" i18n="toolBox.APP_HISTORY_QUERY.MINUTE">5分钟</option>\
                                    <option value="h1" i18n="toolBox.APP_HISTORY_QUERY.HOUR">1小时</option>\
                                    <option value="d1" i18n="toolBox.APP_HISTORY_QUERY.DAY">1天</option>\
                                    <option value="M1" i18n="toolBox.APP_HISTORY_QUERY.MONTH">1月</option>\
                                </select>\
                            </div>\
                            <div class="clearfix hisCommenBox">\
                                <div class="col-xs-4 hisCommen" i18n="toolBox.APP_HISTORY_QUERY.START_TIME">开始时间</div>\
                                <div class="input-append date col-xs-8">\
                                    <input id="datetimepickerStarts" class="form_datetime hisCommen" data-date="12-02-2012" type="text" readonly />\
                                    <span class="add-on"><i class="icon-th"></i></span>\
                                </div>\
                            </div>\
                            <div class="clearfix hisCommenBox">\
                                <div class="col-xs-4 hisCommen" i18n="toolBox.APP_HISTORY_QUERY.END_TIME">结束时间</div>\
                                <div class="input-append date col-xs-8">\
                                    <input id="datetimepickerEnds" class="form_datetime hisCommen" data-date="12-02-2012" type="text" readonly />\
                                    <span class="add-on"><i class="icon-th"></i></span>\
                                </div>\
                            </div>\
                            <div class="text-center">\
                                <button class="btnQuery" id="btnQuery"><span i18n="toolBox.APP_HISTORY_QUERY.SEARCH">查询</span></button>\
                            </div>\
                        </div>\
                    </div>';$(_this.container).find(".bottomBox").html(content);var nowDate=new Date();var endTime=nowDate.timeFormat(timeFormatChange('yyyy-mm-dd hh:00'));var startTime=nowDate.timeFormat(timeFormatChange("yyyy-mm-dd"))+' 00:00';var $datetimepickerStart=$(_this.container).find('#datetimepickerStarts');var $datetimepickerEnd=$(_this.container).find('#datetimepickerEnds');$datetimepickerStart.val(startTime);$datetimepickerEnd.val(endTime);$datetimepickerStart.datetimepicker({format:'yyyy-mm-dd hh:00',pickerPosition:'bottom-right',pickerReferer:'input',startView:2,minView:2,autoclose:true,forceParse:false});$datetimepickerEnd.datetimepicker({format:'yyyy-mm-dd hh:00',pickerPosition:'bottom-right',pickerReferer:'input',startView:2,minView:2,autoclose:true,forceParse:false});WebAPI.post('/analysis/datasource/getDsItemsById',points).done(function(result){for(var j=0,jLength=result.length;j<jLength;j++){var name=result[j].alias===''?result[j].value:result[j].alias;var singlePointer='<div class="singleContent activeSingle row" data-id='+result[j].id+'>\
                                        <div class="singleTitle col-xs-12">'+name+'</div>\
                                        <i class="iconfont icon-xuanze"></i>\
                                    </div>';$(singlePointer).appendTo($(_this.container).find(".listDataBox"));var obj={id:result[j].id,name:name}
_this.echarShowName.push(obj);}
var $allSingleContent=$(_this.container).find(".singleContent");})};ModalAppHistory.prototype.renderChart=function(id,startTime,endTime,tPeriod){var _this=this;var todayEndTime=new Date().format('yyyy-MM-dd HH:00:00');var todayStartTime=new Date().format("yyyy-MM-dd 00:00:00");var id=id===undefined?this.entity.modal.points:id;var startTime=startTime===undefined?todayStartTime:startTime;var endTime=endTime===undefined?todayEndTime:endTime;var tPeriod=tPeriod===undefined?'h1':tPeriod;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:id,timeStart:startTime,timeEnd:endTime,timeFormat:tPeriod}).done(function(dataSrc){var dataArr=dataSrc.list;var time=dataSrc.timeShaft;var datas=[];for(var i=0,length=dataArr.length;i<length;i++){for(var j=0,jLength=_this.echarShowName.length;j<jLength;j++){if(dataArr[i].dsItemId===_this.echarShowName[j].id){var obj={name:_this.echarShowName[j].name,type:'bar',data:dataArr[i].data,itemStyle:{normal:{barBorderRadius:[5,5,0,0]}}}
var info={id:_this.echarShowName[j].id,name:_this.echarShowName[j].name}
_this.echarShowData.push(obj);datas.push(obj);_this.dataInfo.push(info);}}}
_this.echarShowTime=time;_this.echarsShow(datas,_this.echarShowTime);})};ModalAppHistory.prototype.renderModal=function(){var idsArr=this.entity.modal.points;this.layoutStyle(idsArr);I18n.fillArea($('.springContent'));this.renderChart(idsArr);};ModalAppHistory.prototype.attachEvent=function(){var _this=this;$(this.container).off('click').on("click","#btnQuery",function(){var tPeriod=$(_this.container).find("#timePeriod").val();var startTime=$(_this.container).find("#datetimepickerStarts").val().toDate().timeFormat('yyyy-mm-dd hh:ii:ss');var endTime=$(_this.container).find("#datetimepickerEnds").val().toDate().timeFormat('yyyy-mm-dd hh:ii:ss');var idArr=[];$(_this.container).find('.singleContent.activeSingle').each(function(){idArr.push($(this).attr('data-id'));})
_this.renderChart(idArr,startTime,endTime,tPeriod);$(_this.container).find('.bottomBox').hide();})
$(this.container).off('click.singleContent').on("click.singleContent",".singleContent",function(){var activeId=$(this).attr('data-id');var data=[],time=[];if($(this).hasClass('activeSingle')){$(this).removeClass('activeSingle');}else{$(this).addClass('activeSingle');}
if($(_this.container).find('.singleContent.activeSingle').length!==0){$(_this.container).find('.circle').css('margin-left','0px');$(_this.container).find('.circle').closest('.switch').css('background','#5a96f9');}else{$(_this.container).find('.circle').css('margin-left','25px');$(_this.container).find('.circle').closest('.switch').css('background','#cccccc');}
$(_this.container).find('.singleContent.activeSingle').each(function(){var id=$(this).attr('data-id');_this.echarShowName
for(var i=0,length=_this.dataInfo.length;i<length;i++){if(id===_this.dataInfo[i].id){data.push(_this.echarShowData[i]);}}})
_this.echarsShow(data,_this.echarShowTime);});$(this.container).off('click.configBtn').on("click.configBtn",".configBtn",function(){$(_this.container).find('.bottomBox').show();});$(this.container).off('click.closeBtn').on("click.closeBtn",".closeBtn",function(){$(_this.container).find('.bottomBox').hide();});$(this.container).off('click.circle').on('click.circle','.circle',function(){if($(this).css('margin-left')==='0px'){$(this).css('margin-left','25px');$(this).closest('.switch').css('background','#cccccc');$(_this.container).find('.singleContent').removeClass('activeSingle');_this.echarsShow([],_this.echarShowTime);}else{$(this).css('margin-left','0px');$(this).closest('.switch').css('background','#5a96f9');$(_this.container).find('.singleContent').addClass('activeSingle');_this.echarsShow(_this.echarShowData,_this.echarShowTime);}})};return ModalAppHistory;})();var ModalAppDiagRanking=(function(){function ModalAppDiagRanking(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalAppDiagRanking.prototype=new ModalBase();ModalAppDiagRanking.prototype.optionTemplate={name:'toolBox.modal.APP_DIAGNOSTIC_RANKING',parent:3,mode:['appDiagRanking'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppDiagRanking',scroll:false,tooltip:{'imgPC':true,'imgMobile':true,'isSpecData':true,'desc':'#DiagStatics'}};ModalAppDiagRanking.prototype.updateModal=function(points){},ModalAppDiagRanking.prototype.renderModal=function(){var _this=this;var dsItemIds=this.entity.modal.points;var diagType=this.entity.modal.option.diagType?this.entity.modal.option.diagType:'fault';var rankName;if(diagType==='equipment'){rankName=I18n.resource.modalConfig.modalApp.EQUIPMENT_NAME;}else if(diagType==='zone'){rankName=I18n.resource.modalConfig.modalApp.ZONE_NAME;}else{rankName=I18n.resource.modalConfig.modalApp.FAULT_NAME;}
WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:dsItemIds}).done(function(result){if($(_this.container).find(".alertError")||$(_this.container).find(".diagRanking")){$(_this.container).find(".alertError").remove();$(_this.container).find(".diagRanking").remove();}
var dataArr=result.dsItemList;if(result.dsItemList[0].data.indexOf('MonthRankList')!==-1){var data=JSON.parse(result.dsItemList[0].data).MonthRankList;var str='<div class=" diagnosisBg gray-scrollbar scrollY"><table class="diagRanking" data-type="'+diagType+'">\
                        <thead class="bgColorTemp2 diagnosisThead">\
                            <tr>\
                                <th width="15%" title="'+I18n.resource.modalConfig.modalApp.RANKING+'">'+I18n.resource.modalConfig.modalApp.RANKING+'</th>\
                                <th title="'+rankName+'">'+rankName+'</th>\
                                <th title="'+I18n.resource.modalConfig.modalApp.MOTH_TIME+'">'+I18n.resource.modalConfig.modalApp.TIMES+'</th>\
                                '+(function(){if(data[0].energy!==undefined){return'<th title="'+I18n.resource.modalConfig.modalApp.ENERGY_SAVEING+'">'+I18n.resource.modalConfig.modalApp.ENERGY_SAVEING+'</th>';}else{return'';}})()
+'</tr>\
                        </thead>\
                        <tbody>\
                        </tbody>\
                    </table><div>';$(_this.container).append($(str));for(var j=0,jLength=data.length;j<jLength;j++){var sonContent='<tr class="diagnosisTr borderColorTemp3 diagnosisStyle">\
                                    <td>'+(j+1)+'</td>\
                                    <td class="disgnosisName">'+data[j].name+'</td>\
                                    <td>'+data[j].count+'</td>\
                                    '+(function(){if(data[j].energy!==undefined){return'<td>'+data[j].energy+'</td>';}else{return'';}})()
+'</tr>';$(_this.container).find(".diagRanking").find("tbody").append($(sonContent));}
_this.spinner&&_this.spinner.stop();function initDefaultDate(n,timeUnit){var curr_date=new Date();if(timeUnit==='d'){curr_date.setDate(curr_date.getDate()+n);}else if(timeUnit==='M'){curr_date.setMonth(curr_date.getMonth()+n);}else if(timeUnit==='y'){curr_date.setFullYear(curr_date.getFullYear()+n);}
var strYear=curr_date.getFullYear();var strMonth=curr_date.getMonth()+1;var strDay=curr_date.getDate();var strHours=curr_date.getHours();var strMinutes=curr_date.getMinutes();var datastr=strYear+'-'+formatNumber(strMonth)+'-'
+formatNumber(strDay)+' '+formatNumber(strHours)+':'+formatNumber(strMinutes);return datastr;}
function formatNumber(value){return(value<10?'0':'')+value;}
$(_this.container).find('.diagnosisTr').off('click').click(function(){var faultName=$(this).find('.disgnosisName').text().trim();var diagType=$(this).parents('table.diagRanking').attr('data-type');var faultInfos={};var postData={value:faultName,type:diagType,startTime:initDefaultDate(-1,'M')+':00',endTime:new Date().format('yyyy-MM-dd HH:mm:ss'),projId:AppConfig.projectId}
if($(_this.container).parents('.indexContent').length===0){Spinner.spin($(_this.container)[0]);var containerScreen=$(_this.container).closest('.html-layer');}else{Spinner.spin($(_this.container).parents('.indexContent')[0]);var containerScreen=$(_this.container).parents('.indexContent');}
WebAPI.post('/diagnosis/getFaultDetails',postData).done(function(faultDetail){var faultDetailData=faultDetail.data;faultInfos['faultName']=faultName;faultInfos['faultDetailData']=faultDetailData;faultInfos['containerScreen']=containerScreen;faultInfos['diagType']=diagType;new DiagnosisInfo().show(faultInfos);})});}else{var alertError='<div class="alertError" style="width:40%;height:12%;position:absolute;top:0;left:0;right:0;bottom:0;margin:auto;z-index:1200;background:#eee;color:#aaa;border-radius:6px;padding:10px;">所填数据点的格式不符合该控件所需的数据格式</div></div>'
$(_this.container).append($(alertError))}})};ModalAppDiagRanking.prototype.showConfigMode=function(){},ModalAppDiagRanking.prototype.setModalOption=function(option){this.entity.modal.option.diagType=option.diagType;};return ModalAppDiagRanking;})()
var ModalAPPMonthHistory=(function(){function ModalAPPMonthHistory(screen,entityParams,_renderModal){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;ModalBase.call(this,screen,entityParams,renderModal);this.entityOption=entityParams.modal.option;this.dsItems=undefined;this.layout();this.attachEvent();};ModalAPPMonthHistory.prototype=new ModalBase();ModalAPPMonthHistory.prototype.optionTemplate={name:'toolBox.modal.APP_MONTH_HISTORY_QUERY',parent:3,mode:['appMonthHistory'],maxNum:1,title:'',minHeight:2.5,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAPPMonthHistory',tooltip:{'imgPC':false,'imgMobile':true,'isSpecData':false,'desc':''}};ModalAPPMonthHistory.prototype.optionDefault={title:{left:'center',textStyle:{color:'#000000'}},tooltip:{trigger:'axis',axisPointer:{type:'shadow'},backgroundColor:'rgba(0,0,0,0.6)',textStyle:{color:'#ffffff'}},legend:{data:[]},grid:{left:'3%',right:'4%',bottom:'4%',containLabel:true},xAxis:[{type:'category',axisTick:{alignWithLabel:true},data:['Mon','Tue','Wed','Thu','Fri','Sat','Sun']}],yAxis:[{type:'value'}],series:[]};ModalAPPMonthHistory.prototype.layout=function(){var showMonth='<div id="topMonthShow" style="height:9%">\
                            <div class="col-xs-4 leftButton">\
                                <span class="glyphicon glyphicon-arrow-left"></span>\
                            </div>\
                            <div class="col-xs-4 month">\
                            </div>\
                            <div class="col-xs-4 rightButton">\
                                <span class="glyphicon glyphicon-arrow-right"></span>\
                            </div>\
                        </div>';var chartContainer='<div id="chartContainer" style="height:91%"></div>';$(this.container).append(showMonth);$(this.container).append(chartContainer);};ModalAPPMonthHistory.prototype.getDsItemsById=function(){var ids=this.entity.modal.points;var _this=this;WebAPI.post('/analysis/datasource/getDsItemsById',ids).done(function(result){_this.dsItems=result;});;};ModalAPPMonthHistory.prototype.renderModal=function(start,end,month){this.getDsItemsById();var nowYear=Number(new Date().format("yyyy"));var nowMonth=Number(new Date().format('yyyy-MM-dd').split("-")[1]);var showYear,showMonth,startTime,endTime;if(1<nowMonth&&nowMonth<=10){showYear=nowYear;showMonth='0'+(nowMonth-1);}else if(10<nowMonth&&nowMonth<=12){showYear=nowYear;showMonth=nowMonth-1;}else if(nowMonth===1){showYear=nowYear-1;showMonth=12;}
startTime=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(startTime));endTime=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");var topMonth=month===undefined?showMonth:month;$(this.container).find(".month").html(topMonth+" 月");var id=this.entity.modal.points;var tPeriod='d1';var timeStart=start===undefined?startTime:start;var timeEnd=end===undefined?endTime:end;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:id,timeStart:timeStart,timeEnd:timeEnd,timeFormat:tPeriod}).done(function(result){this.optionDefault.xAxis[0].data=[];this.optionDefault.series=[];this.optionDefault.title.text=[];this.optionDefault.legend.data=[];var dataList=result.list;var timeData=result.timeShaft;var timeArr=[];var datas=[];var ids=[];var obj={name:'1',type:'bar',data:[]}
for(var i=0,length=dataList.length;i<length;i++){datas.push(dataList[i].data);ids.push(dataList[i].dsItemId);}
for(var j=0,jLength=datas.length;j<jLength;j++){for(var k=0,kLength=this.dsItems.length;k<kLength;k++){if(this.dsItems[k].id===ids[j]){obj.data=datas[j];obj.name=this.dsItems[k].alias;this.optionDefault.series.push(obj);this.optionDefault.title.text=this.dsItems[k].alias;this.optionDefault.legend.data.push(this.dsItems[k].alias);}}}
for(var t=0,tLength=timeData.length;t<tLength;t++){timeArr.push(timeData[t].split(" ")[0].split("-")[2])}
this.optionDefault.xAxis[0].data=timeArr;var $chartContainer=$(this.container).find("#chartContainer");!this.chart&&(this.chart=echarts.init($chartContainer[0],AppConfig.chartTheme));this.chart.setOption(this.optionDefault);this.spinner&&this.spinner.stop();}.bind(this))};ModalAPPMonthHistory.prototype.attachEvent=function(){var _this=this;var leftCount=0,rightCount=0;var nowYear=Number(new Date().format("yyyy"));var current;$(this.container).find(".leftButton").click(function(){leftCount=leftCount+1;if(leftCount===1){current=Number($(_this.container).find(".month").html().split(" ")[0]);}
var value=(leftCount-current)/12;var yearNums,showYear,showMonth;if(value>0){yearNums=parseInt(value)+1;}else if(value===0){yearNums=1;}else{yearNums=0;}
showYear=nowYear-yearNums;var showCurrentMonth=Number($(_this.container).find(".month").html().split(" ")[0]);if(1<showCurrentMonth&&showCurrentMonth<=10){showMonth='0'+(showCurrentMonth-1);}else if(10<showCurrentMonth&&showCurrentMonth<=12){showMonth=showCurrentMonth-1;}else if(showCurrentMonth===1){showMonth=12;}
$(_this.container).find(".month").html(showMonth);timeStart=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(timeStart));timeEnd=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");_this.renderModal(timeStart,timeEnd,showMonth);})
$(this.container).find(".rightButton").click(function(){rightCount=rightCount+1;if(rightCount===1){current=Number($(_this.container).find(".month").html().split(" ")[0]);}
var value=(rightCount-(12-current))/12;var yearNums,showYear,showMonth;if(value>0){yearNums=parseInt(value)+1;}else if(value===0){yearNums=1;}else{yearNums=0;}
showYear=nowYear-yearNums;var showCurrentMonth=Number($(_this.container).find(".month").html().split(" ")[0]);if(showCurrentMonth>=1&&showCurrentMonth<9){showMonth='0'+(showCurrentMonth+1);}else if(showCurrentMonth>=9){showMonth=showCurrentMonth+1;}else if(showCurrentMonth===12){showMonth='01';}
$(_this.container).find(".month").html(showMonth);timeStart=new Date().format(showYear+"-"+showMonth+"-01 00:00:00");var days=DateUtil.daysInMonth(new Date(timeStart));timeEnd=new Date().format(showYear+"-"+showMonth+"-"+days+" 23:59:59");_this.renderModal(timeStart,timeEnd,showMonth);})};return ModalAPPMonthHistory;})()
var ModalAppBlind=(function(){function ModalAppBlind(screen,entityParams){if(!screen)return;if(!entityParams)return;this.screen=screen;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.tempOpt=undefined;};ModalAppBlind.prototype=new ModalBase();ModalAppBlind.prototype.optionTemplate={name:'toolBox.modal.APP_BLIND',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:3,type:'ModalAppBlind',scroll:false,tooltip:{'imgPC':false,'imgMobile':true,'isSpecData':false,'desc':''}};ModalAppBlind.prototype.show=function(){this.init();}
ModalAppBlind.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';}
ModalAppBlind.prototype.renderModal=function(){var _this=this;if(this.entity.modal.option&&this.entity.modal.option instanceof Array){var arrItem=this.entity.modal.option;this.entity.modal.option={};this.entity.modal.option.arrItem=arrItem;}
var blindOpt=undefined;_this.entity.modal.option&&(blindOpt=_this.entity.modal.option.arrItem);if(!blindOpt||blindOpt.length===0)return;var $currentContainer=$(_this.container);var blindDivBox='<div id="blindDivBox" class="gray-scrollbar"></div>';$currentContainer.append(blindDivBox);var $blindDivBox=$currentContainer.find('#blindDivBox');function unique(arr){var result=[],isRepeated;for(var i=0,len=arr.length;i<len;i++){isRepeated=false;for(var j=0,len1=result.length;j<len1;j++){if(arr[i].id===result[j].id){isRepeated=true;break;}}
if(!isRepeated){result.push(arr[i]);}}
return result;}
for(var m=0;m<blindOpt.length;m++){var isExist=false;var classNameFlag;if(m%2===0){classNameFlag='blindContainerOdd';}else{classNameFlag='blindContainerEven';}
for(var i=0,item;i<_this.screen.store.layout.length;i++){$currentContainer.css({'display':'flex','overflow-y':'hidden','flex-flow':'wrap'});var currentLayout=_this.screen.store.layout[i];currentLayout=unique(currentLayout);for(var j=0;j<currentLayout.length;j++){item=currentLayout[j];if(blindOpt[m].subChartIds[0].id!=item.id)continue;isExist=true;var modelClass,entity;var blindContainerSin='<div class="blindContainerSin '+classNameFlag+'">\
                                        <div class="blindConTitle bgColorTemp1 borderColorTemp1 blindConTitleCover" style="border-radius:0"><!--<span class="glyphicon glyphicon-align-justify" style="color:#ca2929;padding-right:10px;"></span>-->'+blindOpt[m].blindTitle+'<span class="iconfont icon-xiala rotArrow" style="display:block;float:right;margin-right:10px;font-size: 12px;"></span></div>\
                                        <div class="blindConContent gray-scrollbar blindConContentCover" style="width:100%;overflow-y:auto"></div>\
                                    </div>';$blindDivBox.append(blindContainerSin);$currentContainer.find('.blindConTitle').off('click').click(function(){var $this=$(this);if($this.siblings('.blindConContent').hasClass('showSibling'))return;$currentContainer.find('.blindConContent').removeClass('showSibling').hide();$currentContainer.find('.rotArrow').removeClass('rotArrowCur');$this.find('.rotArrow').addClass('rotArrowCur');$this.siblings('.blindConContent').addClass('showSibling').show().css({maxHeight:$blindDivBox.parent().height()-$('.blindContainerSin',$currentContainer).length*$('.blindContainerSin',$currentContainer).height()});});if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalAppBlind'){item.scroll=false;entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){entity.container.style.overflowY="auto";entity.render();var $currentBlindCon=$blindDivBox.find('.blindContainerSin').eq(m).children('.blindConContent');$currentBlindCon.height($currentContainer.children('.springContainer').height());$currentBlindCon.append($currentContainer.children('.springContainer'));continue;}
if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
if(entity.optionTemplate.scroll!==false){if(AppConfig.isMobile){entity.container.style.height=ElScreenContainer.offsetHeight*entity.entity.spanR*2/9+'px';}else{entity.container.style.height=$blindDivBox.height()*entity.entity.spanR/6+'px';}}
entity.container.style.width=$(entity.container).parent().parent('.springContainer').width()+'px';entity.container.style.overflowY="auto";entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);entity.render();_this.screen.isForReport&&entity.configure();}
var $currentBlindCon=$blindDivBox.find('.blindContainerSin').eq(m).children('.blindConContent');if(entity.optionTemplate.scroll!==false){if(!AppConfig.isMobile){$currentBlindCon.height($currentContainer.children('.springContainer').height());}}
$currentBlindCon.append($currentContainer.children('.springContainer'));}}}
$currentContainer.find('#blindDivBox').find('.blindContainerSin:first-child .rotArrow').addClass('rotArrowCur');$currentContainer.find('#blindDivBox').find('.blindContainerSin').find('.blindConContent').hide();$currentContainer.find('#blindDivBox').find('.blindContainerSin:first-child').find('.blindConContent').addClass('showSibling').show();Spinner&&Spinner.stop();}
ModalAppBlind.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
ModalAppBlind.prototype.configureModalNone=function($chartsCt,opt){var spanC=12,spanR=3;if(!this.container.classList.contains('chartsCt')){this.container=this.container.parentElement.getElementsByClassName('chartsCt')[0];}
var entity=new ModalNone(this,{id:(+new Date()).toString(),spanC:spanC,spanR:spanR,modal:{type:"ModalNone"},isNotRender:true});this.screen.arrEntityOrder.push(entity.entity.id);this.screen.listEntity[entity.entity.id]=entity;opt.subChartIds=new Array();opt.subChartIds.push({id:entity.entity.id});entity.render();entity.configure();this.entity.modal=this.tempOpt;}
ModalAppBlind.prototype.showConfigMode=function(){}
ModalAppBlind.prototype.configure=function(){var _this=this;if(this.spinner)this.spinner.stop();if(this.chart)this.chart.clear();this.divResizeByMouseInit();if(this.entity.modal.option&&this.entity.modal.option instanceof Array){var arrItem=this.entity.modal.option;this.entity.modal.option={};this.entity.modal.option.arrItem=arrItem;}
var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();_this.tempOpt=_this.tempOpt?_this.tempOpt:_this.entity.modal;if(_this.tempOpt.option&&_this.tempOpt.option.arrItem&&_this.tempOpt.option.arrItem.length>0){for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(_this.tempOpt.option.arrItem[i].subChartIds.length===0)continue;if(_this.tempOpt.option.arrItem[i].subChartIds[0].id===_this.screen.arrEntityOrder[j]){_this.screen.removeEntity(_this.screen.arrEntityOrder[j]);}}}
_this.tempOpt.option=[];}
var oldIndex=_this.screen.arrEntityOrder.indexOf(_this.entity.id);_this.screen.removeEntity(_this.entity.id);var entity=new ModalNone(_this.screen,{id:_this.entity.id,spanC:_this.entity.spanC,spanR:_this.entity.spanR,modal:{type:"ModalNone"}},_this.entity.id);_this.screen.arrEntityOrder.splice(oldIndex,0,entity.entity.id);_this.screen.listEntity[entity.entity.id]=entity;entity.render();entity.configure();entity.hasEdit=true;})};divMask.appendChild(btnRemove);var btnInstall=document.createElement('span');btnInstall.className='glyphicon glyphicon-cog springBlindConfigInstallBtn grow';btnInstall.title='config';btnInstall.onclick=function(e){_this.showConfigModal();}
divMask.appendChild(btnInstall);var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /3</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $chartCt=$('<div class="divResize chartsCt gray-scrollbar">');divMask.appendChild($chartCt[0]);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};this.showConfigMode();}
ModalAppBlind.prototype.attBlindEvent=function(){var _this=this;$('.blindNameEnter').off('blur').blur(function(){var $this=$(this);var currentTitle=$this.val().trim();if(currentTitle==='')return;var $currentBlind=$this.parents('.divBlind');$this.hide();$this.siblings('.blindNameShow').text(currentTitle).css('display','inline-block');var index=$('.divBlind').index($currentBlind);_this.tempOpt.option.arrItem[index].blindTitle=currentTitle;});$('.blindNameShow').off('click').click(function(){var $this=$(this);var currentTitle=$this.text();$this.hide();$this.siblings('.blindNameEnter').val(currentTitle).css('display','inline-block').focus();});$('.deleteBlind').off('click').click(function(){var $this=$(this);var $parents=$this.parents('.divBlind');var parentId=$parents.attr('data-id');for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){var currentOpt;if(_this.tempOpt.option.arrItem[i].domDataId.toString()===parentId){currentOpt=_this.tempOpt.option.arrItem[i];if(currentOpt&&currentOpt.subChartIds.length!==0){for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(currentOpt.subChartIds[0].id===_this.screen.arrEntityOrder[j]){var isNotModalNone=false;if($('#divContainer_'+_this.screen.arrEntityOrder[j]).length>0&&$('#divContainer_'+_this.screen.arrEntityOrder[j]).find('.divTitleAndType').length>0){isNotModalNone=true;}
if(!isNotModalNone){if(_this.chart)_this.chart.clear();_this.tempOpt.option.arrItem.splice(i,1);$parents.empty().remove();i=i-1;}
var num=i;$('#divContainer_'+_this.screen.arrEntityOrder[j]).find('span.springConfigRemoveBtn').trigger('click',callback);function callback(isDelete){if(isDelete){if(_this.chart)_this.chart.clear();_this.tempOpt.option.arrItem.splice(num,1);$parents.empty().remove();}}}}}else{_this.tempOpt.option.arrItem.splice(i,1);$parents.empty().remove();i=i-1;}}}
_this.entity.modal.option=_this.tempOpt.option;});}
ModalAppBlind.prototype.createDivBlind=function(opt){var divBlind=document.createElement('div');divBlind.className='divBlind';if(opt&&opt.domDataId){divBlind.setAttribute('data-id',opt.domDataId);}else{var nowValue=new Date().valueOf();divBlind.setAttribute('data-id',nowValue);}
var $divBlind=$(divBlind);divBlind.innerHTML='<label class="blindName">标题：</label>\
            <span class="blindNameShow"></span>\
            <input type="text" class="blindNameEnter"/>\
            <span class="deleteBlind glyphicon glyphicon-remove-circle"></span>\
            ';if(opt&&opt.blindTitle){$divBlind.find('.blindNameShow').text(opt.blindTitle).css('display','inline-block');$divBlind.find('.blindNameEnter').hide();}
if(!opt){if(!this.tempOpt.option){this.tempOpt.option={};this.tempOpt.option.arrItem=[];}else if(this.tempOpt.option instanceof Array){var arrItem=this.tempOpt.option;this.tempOpt.option={};this.tempOpt.option.arrItem=arrItem;}
this.tempOpt.option.arrItem.push({id:'',domDataId:nowValue,title:'',blindTitle:'',modalType:'',subChartIds:[]})};return divBlind;}
ModalAppBlind.prototype.showConfigModal=function(){var _this=this;var $blindChartShow=$('#blindChartShow');$blindChartShow.empty().remove();if($blindChartShow.length===0){$blindChartShow=$('<div class="modal fade" id="blindChartShow"></div>');}
$('#paneContent').append($blindChartShow);var blindChartCon='<div class="modal-dialog"><div class="modal-content">'+'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">APP百叶窗</h4><span class="glyphicon glyphicon-plus-sign blindAddBtn grow" style=""></span></div>'+'<div class="modal-body gray-scrollbar">'+'</div>'+'<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="btnBlindListShow">确定</button></div>'+'</div></div>';$blindChartShow.append(blindChartCon);_this.tempOpt=_this.tempOpt?_this.tempOpt:$.extend(true,{},_this.entity.modal);$blindChartShow.find('.modal-body').html('<div class="row" style="margin:15px 0;">\
                        <div class="col-xs-3">背景颜色</div>\
                        <div class="col-xs-2">\
                        <select id="selBgColor">\
                        <option value="transparent">无</option>\
                        <option value="#ffffff">白</option>\
                        <option value="#000000">黑</option>\
                        <option value="#337ab7">蓝</option>\
                        <option value="#5cb85c">绿</option>\
                        <option value="custom">自定义</option>\
                        </select>\
                        </div>\
                        <div class="col-xs-2"><input type="input" id="iptBgColor" placeholder="#ffffff" style="width:60px;display:none;"/></div>\
                        <div class="col-xs-2"><input type="color" class="" id="bgColorView" style="display:none;"/></div>\
                        </div>');if(!_this.tempOpt.option||!_this.tempOpt.option.arrItem||_this.tempOpt.option.arrItem.length===0){$blindChartShow.find('.modal-body').append(_this.createDivBlind());}else{for(var i=0;i<_this.tempOpt.option.arrItem.length;i++){var item=_this.tempOpt.option.arrItem[i];var isExist=false;for(var j in _this.screen.listEntity){if(item.subChartIds.length===0){continue;}
if(item.subChartIds[0].id===j){isExist=true;break;}}
if(!isExist){_this.tempOpt.option.arrItem.splice(i,1);i=i-1;}else{$blindChartShow.find('.modal-body').append(_this.createDivBlind(_this.tempOpt.option.arrItem[i]));}}}
$blindChartShow.modal('show');$blindChartShow.find('.blindAddBtn').off('click').click(function(e){$blindChartShow.find('.modal-body').append(_this.createDivBlind());_this.attBlindEvent();});_this.attBlindEvent();var $iptBgColor=$('#iptBgColor',$blindChartShow);var $bgColorView=$('#bgColorView',$blindChartShow);var $selBgColor=$('#selBgColor',$blindChartShow);$('#btnBlindListShow').off('click').click(function(){var opts=_this.tempOpt.option.arrItem;if(opts){var $chartsCt=_this.container.classList.contains('chartsCt')?$(_this.container):$(_this.container).siblings().find('.chartsCt');if(opts[0].subChartIds.length===0){$chartsCt.children().empty().remove();for(var i=0;i<opts.length;i++){_this.configureModalNone($chartsCt,opts[i]);}}else{var $containerChartsCt=$(_this.container);if(_this.screen.arrEntityOrder.length===1){_this.tempOpt.option=[];return;}
for(var i=0;i<opts.length;i++){var isExist=false;var currentOption=$containerChartsCt.children('.springContainer').length>0?$containerChartsCt.children('.springContainer'):$containerChartsCt.siblings('.springConfigMask').find('.chartsCt').find('.springContainer');for(var j=0;j<currentOption.length;j++){var currentId=currentOption[j].id.split('_')[1];if(opts[i].subChartIds.length!==0){if(currentId===opts[i].subChartIds[0].id){isExist=true;continue;}}}
if(!isExist){_this.configureModalNone($chartsCt,opts[i]);}}}
_this.entity.modal.option.bgColor=$iptBgColor.val();}});_this.entity.modal.option&&setShow(_this.entity.modal.option.bgColor);$selBgColor.off('change').on('change',function(e){setShow(this.value,e);});$iptBgColor.off('input').on('input',function(){$bgColorView.val(this.value);});$blindChartShow.children('.modal').modal();function setShow(selected,event){if(selected==='transparent'){$bgColorView.hide();}else{$bgColorView.val(selected);$bgColorView.show();}
if(selected==='custom'){$iptBgColor.show();$iptBgColor.val('').focus();}else{$iptBgColor.hide();$iptBgColor.val(selected);}
if(!event){$selBgColor.val(selected);if(!$selBgColor.val()){$selBgColor.val('custom');$iptBgColor.val(selected).show().focus();}}}}
return ModalAppBlind;})()
var ModalAppPie=(function(){function ModalAppPie(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;this.screen=screen;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalAppPie.prototype=new ModalBase();ModalAppPie.prototype.optionTemplate={name:'toolBox.modal.APP_PIE',parent:3,mode:['appGauge'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppPie',tooltip:{'imgPC':true,'imgMobile':true,'isSpecData':true,'desc':'#EnergyStruct'}};ModalAppPie.prototype.show=function(){this.init();};ModalAppPie.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalAppPie.prototype.renderModal=function(){this.entity.modal.interval=5;var $appPieTotalBox=$(this.container).find('.appPieTotalBox');if($appPieTotalBox.length>0)return;var appPieTotalBox='<div class="appPieTotalBox"><div class="appPieTextShow">\
                <div class="appPieTotalBoxTitle"><span>能耗统计</span></div>\
                <div class="leftAppChartLegend divAppChartTip row">\
                </div>\
                <div class="divAppEnergyLabel">\
                    <div class="ctnRealVal">\
                        <div class="divRealVal">\
                            <span class="spLabelName">今日能耗：</span></br>\
                            <span class="spRealVal spTodayEnergy"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">昨日能耗：</span></br>\
                            <span class="spRealVal spYestEnergy"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">今日费用：</span></br>\
                            <span class="spRealVal spAppTodayCost"></span>\
                        </div>\
                        <div class="divRealVal">\
                            <span class="spLabelName">昨日费用：</span></br>\
                            <span class="spRealVal spAppYestCost"></span>\
                        </div>\
                    </div>\
                    <div class="ctnPercentage">\
                        <div class="divPercentage">\
                            <span class="spPercentVal spTodayEnergyPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spYestEnergyPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spAppTodayCostPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                        <div class="divPercentage">\
                            <span class="spPercentVal spAppYestCostPercent">\
                            </span>\
                            <span class="spPercentIcon">\
                            </span>\
                        </div>\
                    </div>\
                </div>\
            </div>\
            <div class="divAppChart " id="divEnergyChart">\
                <div class="divAppChildChart divAppItemEnergy"></div>\
                <div class="divAppChildChart divAppTotalEnergy"></div>\
            </div>\
            </div>';$(this.container).append(appPieTotalBox);$(this.container).find('.divAppItemEnergy').css({width:$(this.container).width()*0.6,height:$(this.container).height()});$(this.container).find('.divAppTotalEnergy').css({width:$(this.container).width()*0.37,height:$(this.container).height()});};ModalAppPie.prototype.updateModal=function(point){var $currentContainer=$(this.container);$currentContainer.find('.panel-default').css('background-color','#fff')
var data=JSON.parse(point[0].data);var nameList=[];var pointList=[];var spIconColor=['#6dbef3','#008ae2','#028f68','#00a045','#6cc332','#eeed00'];var colorJ=0;var $leftAppChartLegend=$currentContainer.find('.leftAppChartLegend');$leftAppChartLegend.children().empty().remove();var projectId=data.EnergyList[0].projectId;if(!projectId){if(AppConfig.project&&AppConfig.project.bindId){projectId=AppConfig.project.bindId;}else{projectId=AppConfig.projectId;}}
for(var i=0;i<data.EnergyList[0].children.length;i++){var item=data.EnergyList[0].children[i];nameList.push(item.name);pointList.push('@'+projectId+'|'+item.accumEnergyPoint);var singleLegendDiv='<div class="spAppChartLegend col-xs-6">\
                                <span class="spIcon" style="background-color:'+spIconColor[colorJ]+'"></span>\
                                <span class="spName">\
                                </span>\
                            </div>'
$leftAppChartLegend.append(singleLegendDiv);if(colorJ===spIconColor.length-1)colorJ=0;$currentContainer.find('.appPieTotalBox').find('.spAppChartLegend').eq(i).find('.spName').text(item.name);colorJ++;}
var accumPostData={dsItemIds:pointList,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'m5',timeStart:new Date().format('yyyy-MM-dd')+' 00:00:00'}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',accumPostData).done(function(result){if(result&&result.list&&result.list.length!==0){var dataArr=[];for(var i=0;i<result.list.length;i++){if(result.list[i].data&&result.list[i].data.length>0){dataArr.push({value:(result.list[i].data[result.list[i].data.length-1]-result.list[i].data[0]).toFixed(2),name:nameList[i]});}else{dataArr.push({value:0,name:nameList[i]});}}
var $divAppItemEnergy=$currentContainer.find('.divAppItemEnergy');var leftOption={color:['#6dbef3','#008ae2','#028f68','#00a045','#6cc332','#eeed00'],tooltip:{trigger:'item'},calculable:false,legend:{show:false,data:nameList},toolbox:{show:false},series:[{name:'能耗(kWh)',type:'pie',radius:['40%','60%'],clockWise:false,center:['48%','33%'],label:{normal:{textStyle:{color:'#fff'}}},labelLine:{normal:{length:3,length2:3}},itemStyle:{normal:{borderColor:'transparent',shadowBlur:40,shadowColor:'rgba(51, 51, 51, 0.5)',label:{show:true,formatter:function(params){return params.percent.toFixed(1)+'%'},textStyle:{color:'#dbeafe',fontFamily:'Microsoft Yahei'}},labelLine:{show:true,length:0}}},data:dataArr}]}
var chart=echarts.init($divAppItemEnergy[0]);chart.setOption(leftOption);}});var dsItemIds=[];dsItemIds.push('@'+projectId+'|'+data.EnergyList[0].accumCostPoint);dsItemIds.push('@'+projectId+'|'+data.EnergyList[0].accumEnergyPoint);var postData={dsItemIds:dsItemIds,timeEnd:new Date().format('yyyy-MM-dd HH:mm:ss'),timeFormat:'m5',timeStart:new Date().format('yyyy-MM-dd')+' 00:00:00'}
var yestodayEnergy,yestodayCost,todayEnergy,todayCost,todayEnergyEnd,todayCostEnd;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(resultData){if(resultData.list.length>0){var todayEnergyDataAll=resultData.list[1].data;var todayCostDataAll=resultData.list[0].data;if(point.length===2){todayEnergyEnd=point[1].data;todayCostEnd=point[1].data;}else if(point.length===3){todayEnergyEnd=point[2].data;todayCostEnd=point[1].data;}else{todayEnergyEnd=todayEnergyDataAll[todayEnergyDataAll.length-1];todayCostEnd=todayCostDataAll[todayCostDataAll.length-1];}
if(todayEnergyDataAll.length!==0){todayEnergy=todayEnergyEnd-todayEnergyDataAll[0];}else{todayEnergy=0;}
if(todayCostDataAll.length!==0){todayCost=todayCostEnd-todayCostDataAll[0];}else{todayCost=0;}}
var $divAppEnergyLabel=$currentContainer.find('.divAppEnergyLabel');$divAppEnergyLabel.find('.spTodayEnergy').text(kIntSeparate(todayEnergy)+' kwh');$divAppEnergyLabel.find('.spAppTodayCost').text('￥ '+kIntSeparate(todayCost));var postDataYes={dsItemIds:dsItemIds,timeEnd:new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd')+' 23:59:59',timeFormat:'m5',timeStart:new Date(new Date().valueOf()-86400000).format('yyyy-MM-dd')+' 00:00:00'}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postDataYes).done(function(resultDataYes){if(resultDataYes.list.length>0){var yestodayEnergyDataAll=resultDataYes.list[1].data;var yestodayCostDataAll=resultDataYes.list[0].data;if(yestodayEnergyDataAll.length!==0){yestodayEnergy=yestodayEnergyDataAll[yestodayEnergyDataAll.length-1]-yestodayEnergyDataAll[0];}else{yestodayEnergy=0;}
if(yestodayCostDataAll.length!==0){yestodayCost=yestodayCostDataAll[yestodayCostDataAll.length-1]-yestodayCostDataAll[0];}else{yestodayCost=0;}
$divAppEnergyLabel.find('.spYestEnergy').text(kIntSeparate(yestodayEnergy)+' kwh');$divAppEnergyLabel.find('.spAppYestCost').text('￥ '+kIntSeparate(yestodayCost));$divAppEnergyLabel.find('.spTodayEnergyPercent').text((todayEnergy*100/(todayEnergy+yestodayEnergy)).toFixed(0)+'%');$divAppEnergyLabel.find('.spYestEnergyPercent').text((yestodayEnergy*100/(todayEnergy+yestodayEnergy)).toFixed(0)+'%');$divAppEnergyLabel.find('.spAppTodayCostPercent').text((todayCost*100/(todayCost+yestodayCost)).toFixed(0)+'%');$divAppEnergyLabel.find('.spAppYestCostPercent').text((yestodayCost*100/(todayCost+yestodayCost)).toFixed(0)+'%');var labelTop={normal:{color:'#6aa7fd',label:{show:false,position:'center',formatter:'{b}',textStyle:{baseline:'bottom'}},labelLine:{show:false}}};var labelFromatter={normal:{label:{show:false,formatter:function(params){return 100-params.value+'%'},textStyle:{baseline:'top'}}}};var labelBottom={normal:{color:'white',label:{show:false,position:'center'},labelLine:{show:false}},emphasis:{color:'rgba(0,0,0,0)'}};var borderItemStyle={normal:{color:'#6aa7fd',label:{show:false},labelLine:{show:false}}};var radius=[0,'16%'];var borderRadius=['17%','21%'];var rightOption={legend:{show:false,data:['今日能耗','昨日能耗','今日费用','昨日费用']},title:{text:'The App World',show:false},toolbox:{show:false},series:[{type:'pie',center:['75%','15%'],radius:radius,x:'0%',itemStyle:labelFromatter,data:[{name:'other',value:yestodayEnergy,itemStyle:labelBottom},{name:'今日能耗',value:todayEnergy,itemStyle:labelTop}]},{type:'pie',center:['75%','15%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','35%'],radius:radius,x:'20%',itemStyle:labelFromatter,data:[{name:'other',value:todayEnergy,itemStyle:labelBottom},{name:'昨日能耗',value:yestodayEnergy,itemStyle:labelTop}]},{type:'pie',center:['75%','35%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','55%'],radius:radius,x:'40%',itemStyle:labelFromatter,data:[{name:'other',value:yestodayCost,itemStyle:labelBottom},{name:'今日费用',value:todayCost,itemStyle:labelTop}]},{type:'pie',center:['75%','55%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]},{type:'pie',center:['75%','75%'],radius:radius,x:'60%',itemStyle:labelFromatter,data:[{name:'other',value:todayCost,itemStyle:labelBottom},{name:'昨日费用',value:yestodayCost,itemStyle:labelTop}]},{type:'pie',center:['75%','75%'],radius:borderRadius,x:'0%',itemStyle:labelFromatter,data:[{name:'border',value:1,itemStyle:borderItemStyle}]}]};var $divAppTotalEnergy=$currentContainer.find('.divAppTotalEnergy');var chart=echarts.init($divAppTotalEnergy[0]);chart.setOption(rightOption);}}).always(function(){this.spinner&&this.spinner.stop();})})};ModalAppPie.prototype.showConfigMode=function(){}
return ModalAppPie;})()
function tofixed(str,accuracy){if(!accuracy)accuracy=2;return parseFloat(str).toFixed(accuracy);}
var ModalKPIStruct=(function(){function ModalKPIStruct(screen,entityParams){this.$configModal=undefined;this.$modal=undefined;this.tempOpt=undefined;this.subEntity=undefined;this.isInit=false;this.store={};if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalKPIStruct.prototype=new ModalBase();ModalKPIStruct.prototype.optionTemplate={name:'toolBox.modal.KPI_STRUCT',parent:3,mode:'custom',maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalKPIStruct',scroll:false,tooltip:{'imgPC':true,'imgMobile':true,'isSpecData':true,'desc':'#KPIStruct'}};ModalKPIStruct.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"type":'option',"widget":[{id:'needDetail',type:'checkbox',name:'是否显示细节'}]},{"module":"dsDrag","data":[{type:'point',name:'KPI分项统计来源',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalKPIStruct.prototype.show=function(){this.init();};ModalKPIStruct.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.needDetail)this.configModalOpt.area[0].widget[0].data=this.entity.modal.option.needDetail;if(this.entity.modal.option.structPoint)this.configModalOpt.area[1].data[0].data=this.entity.modal.option.structPoint;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();}};ModalKPIStruct.prototype.getRealTimePoint=function(list,arr){var _this=this;if(!arr)arr=[];list.forEach(function(item){if(item.point){arr.push(_this.entity.modal.option.prefix+item.point);}
if(item.pointRoot){arr.push(_this.entity.modal.option.prefix+item.pointRoot+'_va');arr.push(_this.entity.modal.option.prefix+item.pointRoot+'_st');arr.push(_this.entity.modal.option.prefix+item.pointRoot+'_state');}
if(item.children instanceof Array&&item.children.length>0){_this.getRealTimePoint(item.children,arr)}});return arr;};ModalKPIStruct.prototype.init=function(){};ModalKPIStruct.prototype.renderModal=function(e){$(this.container).addClass('widgetKPIItemEval');var _this=this;if(AppConfig.isMobile){this.container.innerHTML='<div class="divKPIIndex gray-scrollbar"></div>';}else{this.container.innerHTML='<div class="divKPIIndex gray-scrollbar"></div><div class="divKPIDetail"></div>';if(this.entity.modal.option.needDetail){_this.renderDetailContainer();$(_this.container).addClass('showSubContainer');}}
this.indexSpinner=new LoadingSpinner({color:'#00FFFF'});this.indexSpinner.spin(this.container.querySelector('.divKPIIndex'));_this.attachEvent();};ModalKPIStruct.prototype.renderDetailContainer=function(){var containerDetail=this.container.querySelector('.divKPIDetail');var item={modal:{type:'ModalHtml',interval:60000,option:{html:this.setSubEntityHTML()},points:[],title:''},spanC:9,spanR:6};this.initSubEntity(containerDetail,item)};ModalKPIStruct.prototype.setSubEntityHTML=function(){var html='\
        <style>\
            .divChart{position:relative}\
            .divChart_1_1 {\n\
                display:block;\n\
                height:70%;\n\
            }\n\
            .divChart_2_1,.divChart_2_2,.divChart_2_3 {\n\
                display:inline-block;\n\
                height:30%;\n\
                width:33.33%;\n\
                float:left;\n\
            }\n\
        </style>\n\
        <div class="divChart divChart_1_1" data-default-chart="line"></div>\n\
        <div class="divChart divChart_2_1" data-default-chart="gauge"></div>\n\
        <div class="divChart divChart_2_2" data-default-chart="gauge"></div>\n\
        <div class="divChart divChart_2_3" data-default-chart="gauge"></div>\n\
        <script>\n\
            var _this = this;\n\
            var defaultChartOpt = {\n\
                title:{textStyle:{color:"#eee"}},\n\
                legend:{textStyle:{color:"#eee"}},\n\
                tooltip : {\n\
                    trigger: "axis"\n\
                },\n\
                xAxis:{\n\
                    type:"category",\n\
                    axisLine:{show:false,lineStyle:{color:"#eee"}},\n\
                    axisLabel:{textStyle:{color:"#eee"}},\n\
                    axisTick:{show:false}\n\
                },\n\
                yAxis:{\n\
                    type:"value",\n\
                    axisLine:{show:false,lineStyle:{color:"#eee"}},\n\
                    axisLabel:{textStyle:{color:"#eee"}},\n\
                    splitLine:{show:false},\n\
                    axisTick:{show:false}\n\
                }\n\
            };\n\
            var realTimeData = {};\n\
            var promiseRealtime;\n\
            //debugger;\n\
            this.onRenderComplete = function(){\n\
                promiseRealtime = $.Deferred();\n\
                getRealTimeData();\n\
                initChart(_this._wrapContainer.querySelector(".divChart_1_1"),_this.widgetModal.focusDetail["chart-1-1"]);\n\
                initChart(_this._wrapContainer.querySelector(".divChart_2_1"),_this.widgetModal.focusDetail["chart-2-1"]);\n\
                initChart(_this._wrapContainer.querySelector(".divChart_2_2"),_this.widgetModal.focusDetail["chart-2-2"]);\n\
                initChart(_this._wrapContainer.querySelector(".divChart_2_3"),_this.widgetModal.focusDetail["chart-2-3"]);\n\
            }\n\
            function getRealTimeData(){\n\
                var points = [].concat(\n\
                    _this.widgetModal.focusDetail["chart-2-1"].point,\n\
                    _this.widgetModal.focusDetail["chart-2-2"].point,\n\
                    _this.widgetModal.focusDetail["chart-2-3"].point\n\
                )\n\
                if(points.length == 0){promiseRealtime.reject();return;}\
                WebAPI.post("/analysis/startWorkspaceDataGenPieChart", {\n\
                    dsItemIds: points\n\
                }).done(function(result){\n\
                    if(!(result.dsItemList instanceof Array))return\n\
                    result.dsItemList.forEach(function(pt){realTimeData[pt.dsItemId] = pt.data})\n\
                    promiseRealtime.resolve();\n\
                }).fail(function(){promiseRealtime.reject()})\n\
            }\n\
            function initChart(container,option){\n\
                var type = container.dataset.defaultChart;\n\
                if(option.type){\n\
                    type = option.type;\n\
                }\n\
                var chartOption = {}\n\
                switch(type){\n\
                    case "line":\n\
                        chartOption = initLineChart(container,option);\n\
                        break;\n\
                    case "bar":\n\
                        chartOption = initBarChart(container,option);\n\
                        break;\n\
                    case "gauge":\n\
                        chartOption = initGaugeChart(container,option);\n\
                        break;\n\
                    default:\n\
                        return;\n\
                }\n\
            }\n\
            function initLineChart(container,option){\n\
                if(!(option.point instanceof Array && option.point.length > 0))return\n\
                var spinner = new LoadingSpinner({ color: "#00FFFF" })\n\
                spinner.spin(container)\n\
                var opt = {}\n\
                var series = [];\n\
                var timeShaft,startTime,endTime,interval\n\
                var now = new Date();\n\
                switch(option.time){\n\
                    case "today":\n\
                        startTime = new Date(now - 86400000).format("yyyy-MM-dd HH:00:00");\n\
                        endTime = now.format("yyyy-MM-dd HH:00:00");\n\
                        interval = "h1";\n\
                        break;\n\
                    case "today":\n\
                        startTime = new Date(now - 86400000).format("yyyy-MM-dd HH:00:00");\n\
                        endTime = now.format("yyyy-MM-dd HH:00:00");\n\
                        interval = "h1";\n\
                        break;\n\
                    case "today":\n\
                        startTime = new Date(now - 86400000).format("yyyy-MM-dd HH:00:00");\n\
                        endTime = now.format("yyyy-MM-dd HH:00:00");\n\
                        interval = "h1";\n\
                        break;\n\
                    default:\n\
                        startTime = new Date(now - 86400000).format("yyyy-MM-dd HH:00:00");\n\
                        endTime = now.format("yyyy-MM-dd HH:00:00");\n\
                        interval = "h1";\n\
                        break;\n\
                };\n\
                WebAPI.post("/analysis/startWorkspaceDataGenHistogram", {\n\
                    dsItemIds: option.point.map(function(pt){return pt.point}),\n\
                    timeStart: startTime,\n\
                    timeEnd: endTime,\n\
                    timeFormat: interval\n\
                }).done(function(result){\n\
                    if(!(result.list && (result.list instanceof Array)))return;\n\
                    for (var i = 0; i < result.list.length;i++){\n\
                        series.push({\n\
                            type:"line",\n\
                            data:result.list[i].data,\n\
                            name:option.point[i].name\n\
                        })\n\
                    }\n\
                    opt = {\n\
                        title:{text:option.name?option.name:""},\n\
                        legend:{data:option.point.map(function(pt){return pt.name})},\n\
                        xAxis:{\n\
                            data:result.timeShaft\n\
                        },\n\
                        series:series\n\
                    }\n\
                    var chart = echarts.init(container);\n\
                    chart.setOption($.extend(true,{},defaultChartOpt,opt));\n\
                }).always(function(){spinner.stop()})\n\
            }\n\
            function initBarChart(container,option){\n\
                if(!(option.point instanceof Array && option.point.length > 0))return\n\
                var spinner = new LoadingSpinner({ color: "#00FFFF" })\n\
                spinner.spin(container)\n\
                var opt = {}\n\
                var series = [];\n\
                var timeShaft,startTime,endTime,interval\n\
                var now = new Date();\n\
                switch(option.time){\n\
                    case "today":\n\
                        startTime = new Date(now - 86400000).format("yyyy-MM-dd HH:00:00");\n\
                        endTime = now.format("yyyy-MM-dd HH:00:00");\n\
                        interval = "h1";\n\
                        break;\n\
                    case "today":\n\
                        startTime = new Date(now - 86400000).format("yyyy-MM-dd HH:00:00");\n\
                        endTime = now.format("yyyy-MM-dd HH:00:00");\n\
                        interval = "h1";\n\
                        break;\n\
                    case "today":\n\
                        startTime = new Date(now - 86400000).format("yyyy-MM-dd HH:00:00");\n\
                        endTime = now.format("yyyy-MM-dd HH:00:00");\n\
                        interval = "h1";\n\
                        break;\n\
                    default:\n\
                        startTime = new Date(now - 86400000).format("yyyy-MM-dd HH:00:00");\n\
                        endTime = now.format("yyyy-MM-dd HH:00:00");\n\
                        interval = "h1";\n\
                        break;\n\
                };\n\
                WebAPI.post("/analysis/startWorkspaceDataGenHistogram", {\n\
                    dsItemIds: option.point.map(function(pt){return pt.point}),\n\
                    timeStart: startTime,\n\
                    timeEnd: endTime,\n\
                    timeFormat: interval\n\
                }).done(function(result){\n\
                    if(!(result.list && (result.list instanceof Array)))return;\n\
                    for (var i = 0; i < result.list.length;i++){\n\
                        series.push({\n\
                            type:"bar",\n\
                            data:result.list[i].data,\n\
                            name:option.point[i].name\n\
                        })\n\
                    }\n\
                    opt = {\n\
                        title:{text:option.name?option.name:""},\n\
                        legend:{data:option.point.map(function(pt){return pt.name})},\n\
                        xAxis:{\n\
                            data:result.timeShaft\n\
                        },\n\
                        series:series\n\
                    }\n\
                    var chart = echarts.init(container);\n\
                    chart.setOption($.extend(true,{},defaultChartOpt,opt));\n\
                }).always(function(){spinner.stop()})\n\
            }\n\
            function initGaugeChart(container,option){\n\
                if(!(option.point instanceof Array && option.point.length > 0))return\n\
                var spinner = new LoadingSpinner({ color: "#00FFFF" })\n\
                spinner.spin(container)\n\
                var opt = {}\n\
                var series = [];\n\
                var timeShaft,startTime,endTime,interval\n\
                promiseRealtime.done(function(){\n\
                    if(typeof realTimeData[option.point[0]] == null)return;\n\
                    series=[{\n\
                        type:"gauge",\n\
                        data:realTimeData[option.point[0]],\n\
                        radius:"100%",\n\
                        center:["50%","75%"],\n\
                        max:option.max?option.max:10,\n\
                        name:option.point[0],\n\
                        startAngle:"180",\n\
                        endAngle:"0",\n\
                        axisLine:{lineStyle:{width:10,color:[[1, "#4488bb"]]}},\
                        splitLine:{length:15},\n\
                        detail:{offsetCenter:[0,"20%"]}\n\
                    }]\n\
                    opt = {\n\
                        title:{text:option.name?option.name:""},\n\
                        legend:{show:false,data:[option.point[0]]},\n\
                        xAxis:"",\n\
                        yAxis:"",\n\
                        series:series\n\
                    }\n\
                    var chart = echarts.init(container);\n\
                    chart.setOption($.extend(true,{},defaultChartOpt,opt));\n\
                }).always(function(){spinner.stop()})\n\
            }\n\
        </script>';return html};ModalKPIStruct.prototype.attachEvent=function(){var _this=this;var clickEvent=AppConfig.isMobile?'tap':'click';$(this.container).off(clickEvent).on(clickEvent,'.divStructTtl',function(e){$(e.currentTarget).parent().toggleClass('focus');});$(this.container).on(clickEvent,'.divStructItem',function(e){var $target=$(e.currentTarget);$target.siblings().removeClass('focus');$target.toggleClass('focus');if($target.children('.pointDetail').length==0||!$target.hasClass('focus'))return;_this.subEntity&&_this.refreshSubEntity($target)});};ModalKPIStruct.prototype.refreshSubEntity=function($target){if(!this.store.KPIList)return;var parents=$target.parentsUntil('.divKPIIndex','.divStructCtn');var childIndex=$target[0].dataset.itemChildIndex;var arrPoint=[];var store=this.store.KPIList[parents[0].dataset.itemIndex];var level=1;while(level!=parents.length){store=store.children[parents[level].dataset.itemIndex];level++;}
store=store.children[childIndex].param;var _this=this;Object.keys(store).forEach(function(chart){arrPoint=arrPoint.concat(store[chart].point)});this.subEntity.entity.modal.points=arrPoint.map(function(point){return(_this.entity.modal.option.prefix+point.id)});var clone=$.extend(true,{},store);Object.keys(clone).forEach(function(key){if(clone[key].point instanceof Array){clone[key].point.forEach(function(pt,index,self){if(typeof pt=='string'){self[index]=_this.entity.modal.option.prefix+pt;}else{pt.point=_this.entity.modal.option.prefix+pt.point;}})}});this.subEntity.entity.modal.focusDetail=clone;this.updateSubEntity();};ModalKPIStruct.prototype.initPointMap=function(points){var _this=this;var $dom;points.forEach(function(point){_this.initPointDetail(point.dsItemId,point.data)})};ModalKPIStruct.prototype.initPointDetail=function(id,data){var $dom=$('[data-point="'+id+'"]');if($dom.length==0)return;if($dom.hasClass('spItemKPIRs')){var status='';switch(parseInt(data)){case 0:status='success';break;case 1:status='danger';break;case 5:status='default';break;default:status='none';break;}
$dom.removeClass('success danger default none').addClass(status);}else{if(isNaN(Number(data))){$dom.text(data);}else{var arrPt=id.split('_');if(arrPt[arrPt.length-1]=='Score'){$dom.text(parseFloat(data).toFixed(2)+'%');}else{$dom.text(parseFloat(data).toFixed(2));}}}};ModalKPIStruct.prototype.initStruct=function(parent,index,container){var _this=this;var struct=parent[index];var itemName;if(!parent){itemName=struct.name;}else{itemName=parent.name+'-'+struct.name}
var structDom=this.container.querySelector('[data-item="'+struct.name+'"]');var kpiIndexDom=this.container.querySelector('.divKPIIndex');if(!structDom){structDom=document.createElement('div');structDom.className='divStructCtn focus divStructCtnCover';structDom.dataset.item=struct.name;structDom.dataset.itemIndex=index;var defaultSvg='<svg version="1.1" id="图形" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                    <path class="svgpath" data-index="path_0" fill="#272636" d="M1002.496 414.208c-5.44-28.672-22.592-47.04-43.456-46.528l-4.352 0c-71.808 0-130.24-58.432-130.24-130.24 0-23.68 11.264-49.6 11.328-49.792 11.072-24.96 2.56-55.616-19.84-71.232l-1.216-0.832-125.248-69.568-1.28-0.576c-7.424-3.2-15.552-4.864-24.192-4.864-17.856 0-35.328 7.104-46.784 19.008-15.296 15.808-63.488 56.768-102.4 56.768-39.296 0-87.808-41.792-103.168-57.856-11.52-12.16-29.12-19.392-47.168-19.392-8.448 0-16.448 1.6-23.744 4.672L339.2 44.224 209.536 115.456l-1.28 0.896C185.792 131.968 177.216 162.56 188.288 187.52c0.128 0.256 11.328 26.24 11.328 49.856 0 71.808-58.432 130.24-130.24 130.24L65.024 367.616c-20.928-0.512-38.08 17.92-43.456 46.528C21.12 416.448 11.072 470.144 11.072 512.384c0 42.304 10.048 95.936 10.496 98.176 5.376 28.288 22.08 46.592 42.688 46.592 0.256 0 0.512 0 0.768 0l4.352 0c71.808 0 130.24 58.432 130.24 130.24 0 23.68-11.264 49.6-11.328 49.792-11.072 24.96-2.56 55.616 19.776 71.232l1.216 0.832 122.88 68.736 1.28 0.576c7.424 3.264 15.488 4.928 24.128 4.928 18.048 0 35.648-7.424 47.04-19.84 14.4-15.68 64.576-60.352 104.704-60.352 40.448 0 89.792 44.416 105.408 61.504 11.456 12.608 29.184 20.16 47.36 20.16l0 0 0 0c8.448 0 16.384-1.6 23.68-4.736l1.344-0.576 127.36-70.4 1.28-0.896c22.4-15.616 30.976-46.272 19.904-71.168-0.128-0.256-11.328-26.24-11.328-49.856 0-71.808 58.432-130.24 130.24-130.24l4.352 0c20.928 0.448 38.08-17.92 43.456-46.528 0.448-2.24 10.496-55.936 10.496-98.176C1012.928 470.144 1002.88 416.448 1002.496 414.208L1002.496 414.208zM509.824 685.248c-95.68 0-173.504-77.824-173.504-173.504 0-95.68 77.824-173.504 173.504-173.504 95.68 0 173.504 77.824 173.504 173.504C683.264 607.424 605.44 685.248 509.824 685.248L509.824 685.248zM509.824 685.248"></path>\
                    <path class="svgpath" data-index="path_1" fill="#272636" d="M509.824 397.248 509.824 397.248c-63.104 0-114.496 51.328-114.496 114.496 0 63.104 51.328 114.496 114.496 114.496 63.104 0 114.496-51.328 114.496-114.496C624.256 448.64 572.928 397.248 509.824 397.248L509.824 397.248zM509.824 397.248"></path>\
                </svg>';var structTtl=document.createElement('div');structTtl.className='divStructTtl divStructCover';if(container)structTtl.className+=' forSubIndex';structTtl.innerHTML='\
            <!--<span class="spStructIcon">'+defaultSvg+'</span>-->\
            <span class="spStructName spStructNameCover">'+struct.name+'</span>\
            <span class="spStructValue spStructValueCover">综合达标率：<span class="spStructPt" data-point="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'">Loading</span></span>\
            <!--<span class="pointDetail" data-detail="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'">Loading</span>-->';var structBody=document.createElement('div');structBody.className='divStructBody divStuctBodyCover';var structItemTtl=this.createStructItemTtl();if((struct.children instanceof Array)&&struct.children.length>0){struct.children.forEach(function(item,index){if(item.children instanceof Array&&item.children.length>0){_this.initStruct(struct.children,index,structBody);}else{structBody.appendChild(_this.createStructItem(item,index));}})}
var firstItem=$(structBody).find('>.divStructItem')[0];if(firstItem)structBody.insertBefore(structItemTtl,firstItem);structDom.appendChild(structTtl);structDom.appendChild(structBody);if(!container){kpiIndexDom.appendChild(structDom);}else{container.appendChild(structDom);}}else{var structBody=$(structDom).children('.structBody')[0];if((struct.children instanceof Array)&&struct.children.length>0){struct.children.forEach(function(item,index){if(item.children instanceof Array&&item.children.length>0){_this.initStruct(struct.children,index,structBody);}})}}};ModalKPIStruct.prototype.createStructItemTtl=function(){var structItemTtl=document.createElement('div');structItemTtl.className='divStructItemTtl clearfix divStructItemTtlCover';structItemTtl.innerHTML='\
            <span class="spStructItemTtl spStructItemTtlCover">考核项</span>\
            <span class="spStructItemTtl">当前值</span>\
            <span class="spStructItemTtl">标准</span>\
            <span class="spStructItemTtl">考核结果</span>\
            ';return structItemTtl};ModalKPIStruct.prototype.createPointDetail=function(item){var structDetail=document.createElement('tr');structDetail.className='rowPointDetail';if(item.desc){structDetail.innerHTML='<td class="divPointDetail" colspan="5"><span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">'+item.desc+'</span></td>'}else{structDetail.innerHTML='<td class="divPointDetail" colspan="5"><span class="pointDetail" data-detail="'+(item.point?this.entity.modal.option.prefix+item.point:'')+'">'+I18n.resource.dashboard.modalKPIStruct.NO_DATA_TEMP+'</span></td>';}
return structDetail;};ModalKPIStruct.prototype.createStructItem=function(item,index){var _this=this;var structItem=document.createElement('div');structItem.dataset.itemChildIndex=index;structItem.className='divStructItem divStructItemCover';var name=document.createElement('span');name.className='spItemInfo spItemInfoCover';name.dataset.type='name';name.innerHTML=item.name?item.name:'';structItem.appendChild(name);var info,itemAttr=['va','st'];itemAttr.forEach(function(attr){info=document.createElement('span');info.className='spItemInfo';info.dataset.type=attr;info.dataset.point=_this.entity.modal.option.prefix+item.pointRoot+'_'+attr;structItem.appendChild(info);});var resultInfo=document.createElement('span');resultInfo.className='spItemInfo spItemKPIRs';resultInfo.dataset.point=_this.entity.modal.option.prefix+item.pointRoot+'_state';resultInfo.innerHTML='\
                <span class="label label-success">达&nbsp;&nbsp;&nbsp;标</span>\
                <span class="label label-danger">不达标</span>\
                <span class="label label-default">未开启</span>\
                <span class="label label-none">无数据</span>';structItem.appendChild(resultInfo);if(item.desc){var detail=document.createElement('span');detail.className='pointDetail';detail.innerHTML=item.desc;structItem.appendChild(detail);}
return structItem;};ModalKPIStruct.prototype.setPointItem=function(dom,item){var itemDom=document.createElement('span');itemDom.className='spItemInfo';itemDom.dataset.type=item;itemDom.dataset.point=this.entity.modal.option.prefix+item;dom.appendChild(itemDom);};ModalKPIStruct.prototype.updateModal=function(points){if(!(points[0]&&points[0].data))return;var structList;var _this=this;try{structList=JSON.parse(points[0].data).KPIList;}catch(e){return;}
this.store.KPIList=structList;structList.forEach(function(struct,index,self){_this.initStruct(self,index);});if(!this.isInit)this.afterInitStruct();this.isInit=true;var arrPoint=this.getRealTimePoint(structList);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:arrPoint}).done(function(result){if(!result.dsItemList)return;_this.initPointMap(result.dsItemList);}).always(function(){_this.indexSpinner.stop();});};ModalKPIStruct.prototype.afterInitStruct=function(){var $ptDetail=$('.pointDetail');if($ptDetail.length>0){$ptDetail.eq(0).parent().addClass('focus');this.subEntity&&this.refreshSubEntity($ptDetail.eq(0).parent())}};ModalKPIStruct.prototype.showConfigMode=function(){};ModalKPIStruct.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];var projectId=1;if(AppConfig.project&&AppConfig.project.bindId){projectId=AppConfig.project.bindId;}else{projectId=AppConfig.projectId}
this.entity.modal.option.prefix='@'+projectId+'|';};return ModalKPIStruct;})();var ModalEnergySaveRate=(function(){function ModalEnergySaveRate(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalEnergySaveRate.prototype=new ModalBase();ModalEnergySaveRate.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_ENERGY_SAVE_RATE',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalEnergySaveRate'};ModalEnergySaveRate.prototype.renderModal=function(){var _this=this;WebAPI.get('/static/scripts/spring/entities/modalEnergySaveRate.html').done(function(resultHtml){_this.container.innerHTML=resultHtml;I18n.fillArea($('#energySaveName').parent());});},ModalEnergySaveRate.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+'%';$('#energySavePerVal').text(show);$('#progressItem').css('width',show);},ModalEnergySaveRate.prototype.showConfigMode=function(){var _this=this;},ModalEnergySaveRate.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalEnergySaveRate;})();var ModalCoalSaveTotal=(function(){function ModalCoalSaveTotal(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalCoalSaveTotal.prototype=new ModalBase();ModalCoalSaveTotal.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_COAL_SAVE_TOTAL',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalCoalSaveTotal'};ModalCoalSaveTotal.prototype.renderModal=function(){this.container.innerHTML=template;I18n.fillArea($('#coalSaveName').parent());},ModalCoalSaveTotal.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+' Ton';$('#coalSaveVal').text(show);},ModalCoalSaveTotal.prototype.showConfigMode=function(){var _this=this;},ModalCoalSaveTotal.prototype.setModalOption=function(option){this.entity.modal.interval=5;};var template='<style type="text/css">\
        .frameCtl {position: relative;height: 100%;}\
        .imgBackground {position: absolute;width: 100%;height: 100%;right: 0;bottom: 0;top: 0;left: 0;z-index: -1;}\
        #coalSaveVal {position: absolute;left: 60px;top: 40px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
        #coalSaveName {position: absolute;left: 60px;top: 80px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
    </style>\
    <div class="frameCtl">\
        <img src="/static/images/spring/entities/modalCoalSaveTotal.png" class="imgBackground" alt="Background image">\
        <div id="coalSaveVal"> Ton</div>\
        <div id="coalSaveName" i18n="dashboard.carbonFootprint.STANDARD_COAL_SAVING"></div>\
    </div>';return ModalCoalSaveTotal;})();var ModalCo2SaveTotal=(function(){function ModalCo2SaveTotal(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalCo2SaveTotal.prototype=new ModalBase();ModalCo2SaveTotal.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CO2_SAVE_TOTAL',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalCo2SaveTotal'};ModalCo2SaveTotal.prototype.renderModal=function(){this.container.innerHTML=template;I18n.fillArea($('#co2Name').parent());},ModalCo2SaveTotal.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+' Ton';$('#co2SaveVal').text(show);},ModalCo2SaveTotal.prototype.showConfigMode=function(){var _this=this;};ModalCo2SaveTotal.prototype.setModalOption=function(option){this.entity.modal.interval=5;};var template='<style type="text/css">\
        .frameCtl {position: relative;height: 100%;}\
        .imgBackground {position: absolute;width: 100%;height: 100%;right: 0;bottom: 0;top: 0;left: 0;z-index: -1;}\
        #co2SaveVal {position: absolute;left: 60px;top: 40px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
        #co2Name {position: absolute;left: 60px;top: 80px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
    </style>\
    <div class="frameCtl">\
        <img src="/static/images/spring/entities/modalCo2SaveTotal.png" class="imgBackground" alt="Background image">\
        <div id="co2SaveVal"></div>\
        <div id="co2Name" i18n="dashboard.carbonFootprint.CO2_SAVING"></div>\
    </div>';return ModalCo2SaveTotal;})();var ModalKPIConfig=(function($,window,undefined){var _this;function ModalKPIConfig(options){_this=this;this.options=$.extend({},DEFAULTS,options);this.$wrap=null;}
ModalKPIConfig.prototype.show=function(){var domPanelContent=document.getElementById('paneContent');if($('#modalKPIConfigWrap').length>0){this.$modal.modal('show');return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalKPIConfig.html').done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-kpi-config-wrap" id="modalKPIConfigWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this.init();_this.$modal.modal('show');});};ModalKPIConfig.prototype.init=function(){this.$formWrap=$("#formWrap",this.$wrap);this.$btnClose=$('.close',this.$wrap);this.$btnWarnMode=$('#btnWarnMode',this.$formWrap);this.$ulWarnMode=$('#ulWarnMode',this.$formWrap);this.$btnWarnTimeMode=$('#btnWarnTimeMode',this.$formWrap);this.$ulWarnTimeMode=$('#ulWarnTimeMode',this.$formWrap);this.$btnPreWarnMode=$('#btnPreWarnMode',this.$formWrap);this.$ulPreWarnMode=$('#ulPreWarnMode',this.$formWrap);this.$btnPreWarnTimeMode=$('#btnPreWarnTimeMode',this.$formWrap);this.$ulPreWarnTimeMode=$('#ulPreWarnTimeMode',this.$formWrap);this.$btnDataCycleMode=$('#btnDataCycleMode',this.$formWrap);this.$ulDataCycleMode=$('#ulDataCycleMode',this.$formWrap);this.$btnStartMonth=$('#btnStartMonth',this.$formWrap);this.$ulStartMonth=$('#ulStartMonth',this.$formWrap);this.$btnHistoryValUsage=$('#btnHistoryValUsage',this.$formWrap);this.$btnPreHistoryValUsage=$('#btnPreHistoryValUsage',this.$formWrap);this.$fgWarnRange=$('#fgWarnRange',this.$formWrap);this.$fgWarnTime=$('#fgWarnTime',this.$formWrap);this.$fgWarnTimeRange=$('#fgWarnTimeRange',this.$formWrap);this.$fgPreWarnRange=$('#fgPreWarnRange',this.$formWrap);this.$fgPreWarnTime=$('#fgPreWarnTime',this.$formWrap);this.$fgPreWarnTimeRange=$('#fgPreWarnTimeRange',this.$formWrap);this.$fgiStartMonth=$('#fgiStartMonth',this.$formWrap);this.$iptChartName=$('#iptChartName',this.$formWrap);this.$iptChartLowerLimit=$('#iptChartLowerLimit',this.$formWrap);this.$iptChartUpperLimit=$('#iptChartUpperLimit',this.$formWrap);this.$divTargetPoint=$('#divTargetPoint',this.$formWrap);this.$divReferencePoint=$('#divReferencePoint',this.$formWrap);this.$btnCondition=$('#btnCondition',this.$formWrap);this.$iptConditionVal=$('#iptConditionVal',this.$formWrap);this.$btnIsShowRC=$('#btnIsShowRC',this.$formWrap);this.$iptLowerWarnVal=$('#iptLowerWarnVal',this.$formWrap);this.$iptUpperWarnVal=$('#iptUpperWarnVal',this.$formWrap);this.$iptPreGreaterThan=$('#iptPreGreaterThan',this.$formWrap);this.$iptPreLessThan=$('#iptPreLessThan',this.$formWrap);this.$iptWarnTimeRangeStart=$('#iptWarnTimeRangeStart',this.$formWrap);this.$iptPreWarnTimeRangeStart=$('#iptPreWarnTimeRangeStart',this.$formWrap);this.$dropArea=$('.drop-area',this.$formWrap);this.$btnSubmit=$('#btnSubmit',this.$wrap);this.attachEvents();this.initValidator();$(".datetime").datetimepicker('remove');$(".datetime").datetime({pickerPosition:'top-right'});};ModalKPIConfig.prototype.initValidator=function(){};ModalKPIConfig.prototype.displayField=function(animArr,doAnim){var $animWrap=animArr[0].$ele.parent('.optional');var actionGroup={$show:$(),$hide:$()};var showLen,curShowLen=$animWrap.children('.on').length;var $all;if(doAnim===undefined)doAnim=true;for(var i=0,len=animArr.length;i<len;i++){actionGroup['$'+animArr[i].action]=actionGroup['$'+animArr[i].action].add(animArr[i].$ele);}
showLen=actionGroup.$show.length;if(!doAnim){actionGroup.$hide.removeClass('on').css('display','none');actionGroup.$show.addClass('on').css('display','');$animWrap.height(49*showLen);return;}
$all=actionGroup.$hide.add(actionGroup.$show).filter('.on');$all.filter('.on').eq(0).one('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'){$all.css('display','none');if(showLen!==curShowLen){$animWrap.height(49*showLen);$animWrap.off('transitionend').on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='height'){actionGroup.$show.css('display','');window.setTimeout(function(){actionGroup.$show.addClass('on');},0);}
e.stopPropagation();});}else{actionGroup.$show.css('display','');window.setTimeout(function(){actionGroup.$show.addClass('on');},0);}}
e.stopPropagation();});$all.removeClass('on');};ModalKPIConfig.prototype.reset=function(name){var animArr=[];name=typeof name==='string'?[name]:name;if(!name){this.$iptChartName.val('');this.$iptChartLowerLimit.val('');this.$iptChartUpperLimit.val('');this.$divTargetPoint.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');this.$divReferencePoint.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');this.$btnCondition.attr('data-value',0).children('span').eq(0).text('Equal To (=)');this.$iptConditionVal.val('');this.$btnWarnMode.attr('data-value',0).children('span').eq(0).text('From User Input');this.$btnHistoryValUsage.attr('data-value',0).children('span').eq(0).text('Use As Lower Limit');this.$iptWarnTimeRangeStart.val('');this.$iptLowerWarnVal.val('');this.$iptUpperWarnVal.val('');this.$btnPreWarnMode.attr('data-value',0).children('span').eq(0).text('From User Input');this.$iptPreGreaterThan.val('');this.$iptPreLessThan.val('');animArr=[];animArr.push({$ele:this.$fgWarnRange,action:'show'});animArr.push({$ele:this.$fgWarnTime,action:'hide'});animArr.push({$ele:this.$fgWarnTimeRange,action:'hide'});this.displayField(animArr,false);animArr=[];animArr.push({$ele:this.$fgPreWarnRange,action:'show'});animArr.push({$ele:this.$fgPreWarnTime,action:'hide'});animArr.push({$ele:this.$fgPreWarnTimeRange,action:'hide'});this.displayField(animArr,false);}
if(!name||name.indexOf('warn-time')>-1){this.$btnWarnTimeMode.attr('data-value',0);this.$btnWarnTimeMode.children('span').eq(0).text('From User Input');this.$btnHistoryValUsage.attr('data-value',0);this.$btnHistoryValUsage.children('span').eq(0).text('Use As Lower Limit');}
if(!name||name.indexOf('start-month')>-1){this.$btnStartMonth.attr('data-value','');this.$btnStartMonth.children('span').eq(0).text('Start Month');}
if(!name||name.indexOf('pre-warn-time')>-1){this.$btnPreWarnTimeMode.attr('data-value',0);this.$btnPreWarnTimeMode.children('span').eq(0).text('From User Input');}};ModalKPIConfig.prototype.recoverForm=function(form){var name,animArr=[],animArr2=[];var _this=this;if(!form)return;this.$iptChartName.val(form.chartName);this.$iptChartLowerLimit.val(form.chartLowerLimit);this.$iptChartUpperLimit.val(form.chartUpperLimit);name=AppConfig.datasource.getDSItemById(form.targetPointId).alias;this.$divTargetPoint.attr({'data-value':form.targetPointId,'title':name}).html('<span>'+name+'</span>');name=AppConfig.datasource.getDSItemById(form.referencePointId).alias;if(name){this.$divReferencePoint.attr({'data-value':form.referencePointId,'title':name}).html('<span>'+name+'</span>');}
this.$btnCondition.attr('data-value',form.referenceCondition).children('span').eq(0).text(form.referenceConditionName);this.$iptConditionVal.val(form.referenceConditionVal);this.$btnDataCycleMode.attr('data-value',form.dataCycleMode).children('span').eq(0).text(form.dataCycleModeName);this.$btnWarnMode.attr('data-value',form.warnMode).children('span').eq(0).text(form.warnModeName);this.$btnWarnTimeMode.attr('data-value',form.warnTimeMode).children('span').eq(0).text(form.warnTimeModeName);this.$btnHistoryValUsage.attr('data-value',form.historyValUsage).children('span').eq(0).text(form.historyValUsageName);this.$iptWarnTimeRangeStart.val(form.warnTimeRangeStart);if(form.warnMode===1){animArr.push({$ele:this.$fgWarnRange,action:'hide'});animArr.push({$ele:this.$fgWarnTime,action:'show'});if(form.warnTimeMode===0){animArr.push({$ele:this.$fgWarnTimeRange,action:'show'});}else{animArr.push({$ele:this.$fgWarnTimeRange,action:'hide'});}
window.setTimeout(function(){_this.displayField(animArr);},1200);}
this.$iptLowerWarnVal.val(form.warnLowerLimit);this.$iptUpperWarnVal.val(form.warnUpperLimit);this.$btnPreWarnMode.attr('data-value',form.preWarnMode).children('span').eq(0).text(form.preWarnModeName);this.$iptPreGreaterThan.val(form.preGreaterThan);this.$iptPreLessThan.val(form.preLessThan);this.$btnPreWarnTimeMode.attr('data-value',form.preWarnTimeMode).children('span').eq(0).text(form.preWarnTimeModeName);this.$btnPreHistoryValUsage.attr('data-value',form.preHistoryValUsage).children('span').eq(0).text(form.preHistoryValUsageName);this.$iptPreWarnTimeRangeStart.val(form.preWarnTimeRangeStart);if(form.preWarnMode===1){animArr2.push({$ele:this.$fgPreWarnRange,action:'hide'});animArr2.push({$ele:this.$fgPreWarnTime,action:'show'});if(form.preWarnTimeMode===0){animArr2.push({$ele:this.$fgPreWarnTimeRange,action:'show'});}else{animArr2.push({$ele:this.$fgPreWarnTimeRange,action:'hide'});}
window.setTimeout(function(){_this.displayField(animArr2);},1200);}};ModalKPIConfig.prototype.setOptions=function(options){this.options=$.extend({},this.options,options);};ModalKPIConfig.prototype.attachEvents=function(){$('.dropdown-menu',this.$wrap).off('click.selected').on('click.selected','a',function(e){var $this=$(this);var $btn=$this.parents('.dropdown-wrap').children('button');var value=$this.attr('data-value');var text=$this.text();$btn.attr('data-value',value);$btn.children('span').eq(0).text(text);e.preventDefault();});this.$modal.off('show.bs.modal').on('show.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.recoverForm(_this.options.modalIns.entity.modal.option);if(!$rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.reset();if($rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$ulWarnMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnWarnMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnWarnMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgWarnRange,action:'show'});animArr.push({$ele:_this.$fgWarnTime,action:'hide'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'hide'});}else{_this.reset(['warn-time']);animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'show'});}
_this.displayField(animArr);});this.$ulWarnTimeMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnWarnTimeMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnWarnTimeMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'show'});}else{animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'hide'});}
_this.displayField(animArr);});this.$ulPreWarnMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnPreWarnMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnPreWarnMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgPreWarnRange,action:'show'});animArr.push({$ele:_this.$fgPreWarnTime,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'hide'});}else{_this.reset('pre-warn-time');animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'show'});}
_this.displayField(animArr);});this.$ulPreWarnTimeMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnPreWarnTimeMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnPreWarnTimeMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'show'});}else{animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'hide'});}
_this.displayField(animArr);});this.$ulDataCycleMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnDataCycleMode.attr('data-value'));var lastMonth,lastMonth2,nowMonth,lang,arrHtml=[];var liTmpl='<li><a href="javascript:;" data-value="{0}">{1}</a></li>';if(value===lastValue)return;_this.$btnDataCycleMode.attr('data-value',value);if(value===0)_this.$fgiStartMonth.removeClass('on');else{lang=I18n.type
nowMonth=DateUtil.getNextMonth(new Date().getMonth());lastMonth=DateUtil.getLastMonth(nowMonth);lastMonth2=DateUtil.getLastMonth(lastMonth);arrHtml.push(liTmpl.format(lastMonth2,DateUtil.getMonthNameShort(lastMonth2-1,lang)));arrHtml.push(liTmpl.format(lastMonth,DateUtil.getMonthNameShort(lastMonth-1,lang)));arrHtml.push(liTmpl.format(nowMonth,DateUtil.getMonthNameShort(nowMonth-1,lang)));_this.$ulStartMonth.html(arrHtml.join(''));_this.reset('start-month');_this.$fgiStartMonth.addClass('on');}});this.$dropArea.off('dragover').on('dragover',function(e){e.preventDefault();});this.$dropArea.off('dragenter').on('dragenter',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});this.$dropArea.off('dragleave').on('dragleave',function(e){$(e.target).removeClass('on');e.stopPropagation();});this.$dropArea.off('drop').on('drop',function(e){var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');name=AppConfig.datasource.getDSItemById(itemId).alias;$target.attr({'data-value':itemId,'title':name});$target.html('<span>'+name+'</span>');e.stopPropagation();});this.$btnSubmit.off().click(function(){var form={};form.chartName=_this.$iptChartName.val();form.chartLowerLimit=parseFloat(_this.$iptChartLowerLimit.val());form.chartUpperLimit=parseFloat(_this.$iptChartUpperLimit.val());form.targetPointId=_this.$divTargetPoint.attr('data-value');form.referencePointId=_this.$divReferencePoint.attr('data-value');form.referenceCondition=parseInt(_this.$btnCondition.attr('data-value'));form.referenceConditionName=_this.$btnCondition.children('span').eq(0).text();form.referenceConditionVal=parseFloat(_this.$iptConditionVal.val());form.dataCycleMode=parseInt(_this.$btnDataCycleMode.attr('data-value'));form.dataCycleModeName=_this.$btnDataCycleMode.children('span').eq(0).text();form.btnStartMonth=_this.$btnStartMonth.attr('data-value');form.warnMode=parseInt(_this.$btnWarnMode.attr('data-value'));form.warnModeName=_this.$btnWarnMode.children('span').eq(0).text();form.isShowRC=parseInt(_this.$btnIsShowRC.attr('data-value'));form.isShowRCName=_this.$btnIsShowRC.children('span').eq(0).text();form.warnLowerLimit=parseFloat(_this.$iptLowerWarnVal.val());form.warnUpperLimit=parseFloat(_this.$iptUpperWarnVal.val());form.warnTimeMode=parseInt(_this.$btnWarnTimeMode.attr('data-value'));form.warnTimeModeName=_this.$btnWarnTimeMode.children('span').eq(0).text();form.historyValUsage=parseInt(_this.$btnHistoryValUsage.attr('data-value'));form.historyValUsageName=_this.$btnHistoryValUsage.children('span').eq(0).text();form.warnTimeRangeStart=_this.$iptWarnTimeRangeStart.val();form.preWarnMode=parseInt(_this.$btnPreWarnMode.attr('data-value'));form.preWarnModeName=_this.$btnPreWarnMode.children('span').eq(0).text();form.preGreaterThan=parseFloat(_this.$iptPreGreaterThan.val());form.preLessThan=parseFloat(_this.$iptPreLessThan.val());form.preWarnTimeMode=parseInt(_this.$btnPreWarnTimeMode.attr('data-value'));form.preWarnTimeModeName=_this.$btnPreWarnTimeMode.children('span').eq(0).text();form.preHistoryValUsage=parseInt(_this.$btnPreHistoryValUsage.attr('data-value'));form.preHistoryValUsageName=_this.$btnPreHistoryValUsage.children('span').eq(0).text();form.preWarnTimeRangeStart=_this.$iptPreWarnTimeRangeStart.val();_this.options.onSubmit.call(_this.options.modalIns,form);_this.$btnClose.trigger('click');});};ModalKPIConfig.prototype.detachEvents=function(){};ModalKPIConfig.prototype.destroy=function(){this.detachEvents();this.$wrap.remove();};var DEFAULTS={};return ModalKPIConfig;}(jQuery,window));var ModalKPIChart=(function($){var PRECISION=2;function ModalKPIChart(screen,entityParams){ModalBase.call(this,screen,entityParams,this._render,null,this._showConfig);this.options=$.extend(true,{},DEFAULTS);this.historyChartOptions=$.extend(true,{},HISTORY_CHART_DEFAULTS);this.startline=null;this.endline=null;this.targetPointData=null;this.referencePointData=null;this.refreshTimesInOneHour=1;this.period=null;this.indicators={};this.samplingPeriod={format:'h1',value2ms:3600000};this.historyChart=null;this.$lkUpdateTime=null;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;}
ModalKPIChart.prototype=Object.create(ModalBase.prototype);ModalKPIChart.prototype.constructor=ModalKPIChart;ModalKPIChart.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_KPI_CHART',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalKPIChart',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalKPIChart.prototype.init=function(){var $panel=$(this.container).closest('.panel');this.$lkUpdateTime=$('<div class="lk-update-time" title="Last Update Time"><span class="glyphicon glyphicon-time"></span><span>updating...</span></div>').appendTo($panel);};ModalKPIChart.prototype._render=function(){var _this=this;var option=this.entity.modal.option;var min=option.chartLowerLimit||0;var max=option.chartUpperLimit||100;var warnMode=option.warnMode;var warnLower=option.warnLowerLimit;var warnUpper=option.warnUpperLimit;var preWarnMode=option.preWarnMode;var preWarnLower=warnLower+option.preGreaterThan;var preWarnUpper=warnUpper-option.preLessThan;var historyValUsage=option.historyValUsage;var targetPointId=option.targetPointId;var referencePointId=option.referencePointId;var dataCycleMode=option.dataCycleMode;var period=this.period=this.getTimePeriod();var postData;var ids=referencePointId?[targetPointId,referencePointId]:[targetPointId];postData=[{dsItemIds:ids,timeStart:period.nowStart,timeEnd:period.nowEnd,timeFormat:this.samplingPeriod.format}];if(warnMode===1){postData.push({dsItemIds:ids,timeStart:period.refStart,timeEnd:period.refEnd,timeFormat:this.samplingPeriod.format});}
this.init();this.options.series[0].data[0].value=min;this.options.series[0].min=min;this.options.series[0].max=max;this.historyChartOptions.yAxis[0].min=min;this.historyChartOptions.yAxis[0].max=max;this.options.tooltip.formatter=function(p){return p.seriesName+': <strong>'+p.value+'</strong><br/>From: '+
_this.store.timeShaft[0]+'<br/>To: '+_this.store.timeShaft[_this.store.timeShaft.length-1];};this.spinner.spin(this.container);WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(rs){var axisColor=_this.options.series[0].axisLine.lineStyle.color;var range=max-min;var maxIndex;_this.store={list:{},timeShaft:rs[0].timeShaft};for(var i=0,len=rs[0].list.length;i<len;i++){_this.store.list[rs[0].list[i].dsItemId]=rs[0].list[i].data;}
if(rs[1]!==undefined){_this.store2={list:{},timeShaft:rs[1].timeShaft};for(i=0,len=rs[1].list.length;i<len;i++){_this.store2.list[rs[1].list[i].dsItemId]=rs[1].list[i].data;}}
_this.filterPointData();_this.initIndicators();_this.setTimeParams();maxIndex=_this.store.fullTimeShaft.length-1;if(warnMode===0){if(warnLower!==undefined&&(warnLower-min)>0){axisColor.push([(warnLower-min)/range,'#ff4500']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Warn Line',value:warnLower,xAxis:0,yAxis:warnLower,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:warnLower}]);}
if(preWarnLower!==undefined&&(preWarnLower-min)>0){axisColor.push([(preWarnLower-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:preWarnLower,xAxis:0,yAxis:preWarnLower,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnLower}]);}
if(preWarnUpper!==undefined&&(preWarnUpper-min)>0){axisColor.push([(preWarnUpper-min)/range,'lightgreen']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:preWarnUpper,xAxis:0,yAxis:preWarnUpper,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:maxIndex,yAxis:preWarnUpper}]);}
if(warnUpper!==undefined&&(warnUpper-min)>0){axisColor.push([(warnUpper-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Warn Line',value:warnUpper,xAxis:0,yAxis:warnUpper,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:maxIndex,yAxis:warnUpper}]);}
axisColor.push([1,'#ff4500']);}
else{if(historyValUsage===0){axisColor.push([(_this.indicators.average2-min)/range,'#ff4500']);if(preWarnMode===0){preWarnLower=_this.indicators.average2+option.preGreaterThan;if(preWarnLower!==undefined&&(preWarnLower-min)>0){axisColor.push([(preWarnLower-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:preWarnLower.toFixed(PRECISION),xAxis:0,yAxis:preWarnLower,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnLower}]);}}else if(preWarnMode===1&&_this.indicators.preWarnValue>_this.indicators.average2){axisColor.push([(_this.indicators.preWarnValue-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:_this.indicators.preWarnValue.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.preWarnValue,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.preWarnValue}]);}
axisColor.push([1,'lightgreen']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Warn Line',value:_this.indicators.average2.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.average2,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.average2}]);}
else{if(preWarnMode===0){preWarnUpper=_this.indicators.average2-option.preLessThan;if(preWarnUpper!==undefined&&(preWarnUpper-min)>0){axisColor.push([(preWarnUpper-min)/range,'lightgreen']);axisColor.push([(_this.indicators.average2-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:preWarnUpper.toFixed(PRECISION),xAxis:0,yAxis:preWarnUpper,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnUpper}]);}}else if(preWarnMode===1&&_this.indicators.preWarnValue<_this.indicators.average2){axisColor.push([(_this.indicators.preWarnValue-min)/range,'lightgreen']);axisColor.push([(_this.indicators.average2-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:_this.indicators.preWarnValue.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.preWarnValue,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.preWarnValue}]);}else{axisColor.push([(_this.indicators.average2-min)/range,'lightgreen']);}
axisColor.push([1,'#ff4500']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Warn Line',value:_this.indicators.average2.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.average2,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.average2}]);}}
_this.fitContainer();_this.chart=echarts.init(_this.container,AppConfig.chartTheme);_this.chart.clear();_this.chart.setOption(_this.options);_this.reloadChart();}).always(function(){_this.spinner.stop();});};ModalKPIChart.prototype.filterPointData=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var cond=option.referenceCondition;var condVal=option.referenceConditionVal;var tPoints=null,rPoints=null;if(!option.referencePointId)return;tPoints=this.store.list[option.targetPointId];rPoints=this.store.list[option.referencePointId];if(tPoints.length!==rPoints.length)return;for(var i=0,len=rPoints.length;i<len;i++){tPoints[i]=parseFloat(tPoints[i]);rPoints[i]=parseFloat(rPoints[i]);if(!this.isPointRuled(rPoints[i],condVal,cond)){tPoints[i]='-';}}
if(warnMode===1){tPoints=this.store2.list[option.targetPointId];rPoints=this.store2.list[option.referencePointId];if(tPoints.length!==rPoints.length)return;for(var i=0,len=rPoints.length;i<len;i++){tPoints[i]=parseFloat(tPoints[i]);rPoints[i]=parseFloat(rPoints[i]);if(!this.isPointRuled(rPoints[i],condVal,cond)){tPoints[i]='-';}}}};ModalKPIChart.prototype.isPointRuled=function(pointVal,condVal,cond){if(condVal===null)return true;switch(cond){case 0:return pointVal===condVal;case 1:return pointVal<condVal;case 2:return pointVal>condVal;default:return true;}};ModalKPIChart.prototype.setAnimation=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var historyValUsage=option.historyValUsage;var warnLower=option.warnLowerLimit;var warnUpper=option.warnUpperLimit;var preWarnLower=warnLower+option.preGreaterThan;var preWarnUpper=warnUpper-option.preLessThan;var $parent=$(this.container).parents('.panel');var curVal=this.indicators.average;$parent.removeClass('warn-anim pre-warn-anim');if(warnMode===1){if((historyValUsage===0&&curVal<this.indicators.average2)||(historyValUsage===1&&curVal>this.indicators.average2)){$parent.addClass('warn-anim');}}else{switch(true){case curVal<preWarnLower:$parent.addClass('pre-warn-anim');break;case curVal<warnLower:$parent.addClass('warn-anim');break;case curVal<preWarnUpper:break;case curVal<warnUpper:$parent.addClass('pre-warn-anim');break;default:$parent.addClass('warn-anim');break;}}};ModalKPIChart.prototype.update=function(rs){var option=this.entity.modal.option;var targetPointId=option.targetPointId;var referencePointId=option.referencePointId;var targetPointData,referencePointData;var lastTick,nowTick;if(!this.store)return;lastTick=this.store.timeShaft[this.store.timeShaft.length-1];lastTick=lastTick.toDate().valueOf()+60000;nowTick=new Date().valueOf();if(nowTick<lastTick){return;}
for(var i=0,len=rs.length;i<len;i++){if(targetPointId===rs[i].dsItemId){targetPointData=parseFloat(rs[i].data);}
if(referencePointId===rs[i].dsItemId){referencePointData=parseFloat(rs[i].data);}}
if(isNaN(targetPointData))return;this.appendData(targetPointData,referencePointData);this.reloadChart();};ModalKPIChart.prototype.reloadChart=function(){this.options.series[0].data[0].value=this.indicators.average.toFixed(PRECISION);var opt=this.chart.getOption();opt.series=this.options.series;this.chart.setOption(opt);this.setAnimation();this.$lkUpdateTime.children('span').eq(1).text(new Date().format('HH:mm'));};ModalKPIChart.prototype._showConfig=function(){};ModalKPIChart.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalKPIChart.prototype.setOptions=function(options){this.options=$.extend({},this.opitons,options);};ModalKPIChart.prototype.destroy=function(){};ModalKPIChart.prototype.saveConfig=function(form){this.entity.modal.title=form.chartName;this.entity.modal.points=[form.targetPointId];if(form.referencePointId)this.entity.modal.points.push(form.referencePointId);this.entity.modal.option=form;this.entity.modal.interval=60000;};ModalKPIChart.prototype.configModal=new ModalKPIConfig({onSubmit:function(form){this.saveConfig(form);}});ModalKPIChart.prototype.getTimePeriod=function(){var now;var period={};var option=this.entity.modal.option;var warnMode=option.warnMode;var historyValUsage=option.historyValUsage;var warnStart=option.warnTimeRangeStart;var warnTimeMode=option.warnTimeMode;var startDate=option.warnTimeRangeStart;var circleMode=option.dataCycleMode;var startMonth;if(!this.m_bIsGoBackTrace){now=new Date();this.DEFAULTS=true;this.HISTORY_CHART_DEFAULTS=true;}
else{now=this.m_traceData.currentTime;this.DEFAULTS=false;this.HISTORY_CHART_DEFAULTS=false;}
if(circleMode===0){period.nowStart=now.format('yyyy-MM-01 00:00:00');period.nowEnd=now.format('yyyy-MM-dd HH:mm:ss');if(warnMode===0)return period;if(warnTimeMode===0){period.refStart=warnStart.toDate().format('yyyy-MM');period.refEnd=period.refStart+'-'+DateUtil.daysInMonth(period.refStart.toDate())+' 23:59:59';period.refStart+='-01 00:00:00';}else{period.refStart=(now.format('yyyy')-1)+now.format('-MM');period.refEnd=period.refStart+'-'+DateUtil.daysInMonth(period.refStart.toDate())+' 23:59:59';period.refStart+='-01 00:00:00';}
period.lag=period.nowStart.toDate().valueOf()-period.refStart.toDate().valueOf();}
else{}
return period;};ModalKPIChart.prototype.initIndicators=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var preWarnMode=option.preWarnMode;var dsId=option.targetPointId;var data=this.store.list[dsId];var average=0,sum=0;var list1,list2;for(var i=0,len=data.length;i<len;i++){if(isNaN(data[i]))continue;average+=data[i]*1;};if(isNaN(average))this.indicators.average=this.entity.modal.option.chartLowerLimit;else this.indicators.average=average/len;if(warnMode===1){average=0;data=this.store2.list[dsId];for(var i=0,len=data.length;i<len;i++){if(isNaN(parseFloat(data[i])))continue;average+=data[i]*1;};if(isNaN(average))this.indicators.average2=this.entity.modal.option.chartLowerLimit;else this.indicators.average2=average/len;}
if(preWarnMode===1){this.setPreWarnValue();}};ModalKPIChart.prototype.setPreWarnValue=function(){var option=this.entity.modal.option;var targetPointId=option.targetPointId;var warnMode=option.warnMode;var preHistoryValUsage=option.preHistoryValUsage;var list1=this.store.list[targetPointId];var list2=this.store2.list[targetPointId];var average=0;var sum=0;var validNum=0;for(var i=0,len1=list1.length,len2=list2.length;i<len2;i++){if(i>=len1){if(isNaN(list2[i]))continue;sum+=list2[i];}else{if(isNaN(list1[i]))continue;sum+=list1[i];}
validNum+=1;}
if(warnMode===1){this.indicators.preWarnValue=this.indicators.average+this.indicators.average2-sum/validNum;}else{if(preHistoryValUsage===0){this.indicators.preWarnValue=this.indicators.average+option.warnLowerLimit-sum/validNum;}else{this.indicators.preWarnValue=this.indicators.average+option.warnUpperLimit-sum/validNum;}}};ModalKPIChart.prototype.appendData=function(tValue,rValue){var lastTick=this.store.timeShaft[this.store.timeShaft.length-1];var option=this.entity.modal.option;var preWarnMode=option.preWarnMode;var targetPointId=option.targetPointId;var targetPointList=this.store.list[targetPointId];var cond=option.referenceCondition;var condVal=option.referenceConditionVal;var len=this.store.list[targetPointId].length;var nowStr=new Date().format('yyyy-MM-dd HH:00:00')
var lastValue,newLastValue;var timeStamp;if(isNaN(rValue)||this.isPointRuled(rValue,condVal,cond)){tValue=tValue.toFixed(3)*1;if(lastTick!==nowStr){timeStamp=lastTick.toDate().valueOf();if((nowStr.toDate().valueOf()-timeStamp)>3600000){this.store.timeShaft.push(new Date(timeStamp+3600000).format('yyyy-MM-dd HH:00:00'));}
this.store.timeShaft.push(nowStr);this.refreshTimesInOneHour=0;this.indicators.average=(this.indicators.average*len+tValue)/(len+1);targetPointList.push(tValue);}else{lastValue=targetPointList[targetPointList.length-1]
newLastValue=(lastValue*this.refreshTimesInOneHour+tValue)/(this.refreshTimesInOneHour+1);targetPointList[targetPointList.length-1]=newLastValue.toFixed(3)*1;this.indicators.average=(this.indicators.average*len-lastValue+newLastValue)/len;this.refreshTimesInOneHour+=1;}
if(preWarnMode===1){this.setPreWarnValue();}}};ModalKPIChart.prototype.setTimeParams=function(){if(this.store.timeShaft.length==0)return;var lastTick=this.store.timeShaft[this.store.timeShaft.length-1].toDate().valueOf();var option=this.entity.modal.option;var tick=lastTick+this.samplingPeriod.value2ms;var now=new Date();this.store.fullTimeShaft=this.store.timeShaft.concat();if(option.dataCycleMode===0){this.store.deadline=now.format('yyyy-MM-'+DateUtil.daysInMonth(now)+' 23:55:00').toDate();while(tick<=this.store.deadline){tick+=this.samplingPeriod.value2ms;this.store.fullTimeShaft.push(tick.toDate().format('yyyy-MM-dd HH:mm:ss'));}}
else{}};ModalKPIChart.prototype.fitContainer=function(){var row=this.entity.spanR;var column=this.entity.spanC;if(Math.min(row,column)<3){this.options.series[0].splitLine.length=15;this.options.series[0].axisLine.lineStyle.width=6;this.options.series[0].axisTick.length=12;this.options.series[0].pointer.width=4;this.options.series[0].detail.textStyle.fontSize=16;}};ModalKPIChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this._render();this.m_bIsGoBackTrace=false;};var DEFAULTS={tooltip:{},visualMap:{show:false},series:[{name:'KPI Indicator',type:'gauge',precision:2,splitNumber:10,axisTick:{show:true,splitNumber:5,length:20,lineStyle:{color:'auto',width:1,type:'solid'}},axisLine:{show:true,lineStyle:{color:[],width:1}},axisLabel:{textStyle:{color:'#a2adbc'}},splitLine:{show:true,length:30,lineStyle:{color:'auto',width:2,type:'solid'}},pointer:{length:'80%',width:4},detail:{offsetCenter:['0','-30%'],textStyle:{color:'#ccc',fontSize:20}},data:[{name:''}]}],animation:true};var HISTORY_CHART_DEFAULTS={title:{text:'History Data'},legend:{data:['Target Point']},tooltip:{trigger:'axis'},dataZoom:{show:false,realtime:true,start:0,end:100},grid:{y2:80},xAxis:[{type:'category'}],yAxis:[{type:'value'}],series:[{name:'Target Point',type:'line',symbolSize:0,markLine:{precision:3,symbol:'none',data:[]},markPoint:{symbol:'emptyCircle',effect:{show:true,shadowBlur:0},data:[]}}],animation:true};return ModalKPIChart;}(jQuery));var ModalObserverConfig=(function($,window,undefined){var _this;function ModalObserverConfig(options){_this=this;this.options=$.extend({},DEFAULTS,options);this.$wrap=null;}
ModalObserverConfig.prototype.show=function(){var domPanelContent=document.getElementById('paneContent');if($('#modalObserverConfigWrap').length>0){this.$modal.modal('show');return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalObserverConfig.html').done(function(html){_this.$wrap=$('<div class="modal-observer-config-wrap" id="modalObserverConfigWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');WebAPI.get("/get_s3db_pages/"+AppConfig.projectId+"/"+AppConfig.userId).done(function(result){_this.init(result.pages);_this.$modal.modal('show');}).always(function(msg){Spinner.stop();});});};ModalObserverConfig.prototype.init=function(data){this.$formWrap=$('#obFormWrap','#modalObserverConfigWrap');this.$btnClose=$('.close','#modalObserverConfigWrap');this.$sltObserverId=$('#sltObserverId','#obFormWrap');this.$btnSubmit=$('#btnObSubmit','#modalObserverConfigWrap');var sb=new StringBuilder();for(var i=0,item,len=data.length;i<len;i++){item=data[i];sb.append('<option value="').append(item.id).append('">').append(item.name+' (width: '+item.width+', height: '+item.height+')</option>');}
this.$sltObserverId.html(sb.toString());this.attachEvents();};ModalObserverConfig.prototype.attachEvents=function(){this.$btnSubmit.off().click(function(e){var form={};form.id=_this.$sltObserverId.val().trim();_this.options.onSubmit.call(_this.options.modalIns,form);_this.$btnClose.trigger('click');e.preventDefault();});};ModalObserverConfig.prototype.setOptions=function(options){this.options=$.extend({},this.options,options);};var DEFAULTS={};return ModalObserverConfig;}(jQuery,window));var ModalObserver=(function ModalObserver($,window,undefined){function ModalObserver(screen,entityParams){ModalBase.call(this,screen,entityParams,this._render,null,this._showConfig);this.options=$.extend(true,{},DEFAULTS);this.obScreen=null;};ModalObserver.prototype=Object.create(ModalBase.prototype);ModalObserver.prototype.constructor=ModalObserver;ModalObserver.prototype.optionTemplate={name:'toolBox.modal.OBSERVER',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalObserver',tooltip:{'imgPC':false,'imgMobile':false,'desc':''}};ModalObserver.prototype._render=function(){var options=this.entity.modal.option;var id=options.id||'200000360';this.obScreen=new ObserverScreen(id);this.container=$(this.container).html('<div class="divMain" style="width: 100%; height: 100%;">\
                <div class="div-canvas-ctn" style="padding: 0; margin: 0 auto; height: 100%; width: 100%;">\
                    <canvas class="canvas-ctn" style="width: 100%; height: 100%;">浏览器不支持</canvas>\
                </div>\
                <div id="divObserverTools" style="height: 0"></div>\
            </div>')[0];this.obScreen.isInDashBoard=true;this.obScreen.show(this.container);};ModalObserver.prototype._showConfig=function(){};ModalObserver.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalObserver.prototype.saveConfig=function(form){this.entity.modal.option=form;this.entity.modal.points=[];};ModalObserver.prototype.configModal=new ModalObserverConfig({onSubmit:function(form){this.saveConfig(form);}});ModalObserver.prototype._close=function(){if(this.obScreen)this.obScreen.close();};var DEFAULTS={};return ModalObserver;}(jQuery,window));var ModalMultiple=(function(){function ModalMultiple(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalMultiple.prototype=new ModalRealtimeLine();ModalMultiple.prototype.optionTemplate={name:'toolBox.modal.MULTIPLE',parent:0,mode:['multiple'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMultiple',modelParams:{paraName:['line','bar','area','cumulativeBar'],paraShowName:{'line':'Line Chart Parameters','bar':"Bar Chart Parameters",'area':"Area Chart Parameters",'cumulativeBar':"Cumulative Bar Chart Parameters"},paraAnlysMode:'part'},tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalMultiple.prototype.renderModal=function(){};ModalMultiple.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var now=new Date();if(!this.lastRenderTime||now.getTime()-this.lastRenderTime>this.dicPeriod[_this.entity.modal.option.timeFormat]){var pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime).format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
var startTime=endTime.split(' ')[0]+' 00:00:00';this.lastRenderTime=now;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(dataSrc){if(dataSrc==undefined||dataSrc.length<=0){return;}
var entityItem=_this.dealWithData(dataSrc,2);var option={tooltip:{extraCssText:'text-align: left;'},legend:(function(){if(AppConfig.isMobile){return{data:entityItem.arrLegend,top:25}}else{return{data:entityItem.arrLegend}}})(),grid:(function(){if(AppConfig.isMobile){return{x2:40,top:80}}else{return{x2:50}}}()),xAxis:[{data:['00:00','01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00'],boundaryGap:true}],yAxis:[{type:'value',scale:false,splitArea:{show:false}},{type:'value',scale:false,splitArea:{show:false},splitLine:{show:false}}],series:entityItem.arrSeries};if(option.series instanceof Array){var lastType=-1;option.series.forEach(function(item){if(lastType==-1){lastType=item.yAxisIndex}else{if(item.yAxisIndex!=lastType){lastType='multi'}}});if(lastType!='multi'){option.series.forEach(function(item,index,self){self[index].yAxisIndex=0});option.yAxis=[option.yAxis[0]]}}
if(AppConfig.isMobile){option.legend={data:entityItem.arrLegend,itemWidth:15,itemHeight:10,textStyle:{fontSize:12}};option.xAxis[0].axisLabel={textStyle:{color:'#e2dfe4'}};var yAxisList=option.yAxis;for(var i=0;i<yAxisList.length;i++){yAxisList[i].axisLabel={textStyle:{color:'#e2dfe4'}};}}
if(_this.entity.modal.dsChartCog){var ptIndex=0;var tempChartMax,tempChartMin;var targetAxis;tempChartMax=null;tempChartMin=null;for(var m=0;m<4;++m){if(!_this.entity.modal.option.paraType[m].arrId.length)continue
if(lastType=='multi'&&(m==1)){targetAxis=option.yAxis[1]}else{targetAxis=option.yAxis[0]}
if(_this.entity.modal.dsChartCog[m].upper!=''){if(tempChartMax==null||tempChartMax<Number(_this.entity.modal.dsChartCog[m].upper)){tempChartMax=Number(_this.entity.modal.dsChartCog[m].upper);}}
if(_this.entity.modal.dsChartCog[m].lower!=''){if(tempChartMin==null||tempChartMin>Number(_this.entity.modal.dsChartCog[m].lower)){tempChartMin=Number(_this.entity.modal.dsChartCog[m].lower);}}
if(_this.entity.modal.dsChartCog[m].unit!=''){targetAxis.name=_this.entity.modal.dsChartCog[m].unit;}
if(_this.entity.modal.dsChartCog[m].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[m].accuracy);for(var i=0;i<_this.entity.modal.option.paraType[m].arrId.length;i++){for(var j=0;j<option.series[ptIndex].data.length;j++){option.series[ptIndex].data[j]=Number(option.series[ptIndex].data[j]).toFixed(n);}
ptIndex+=1;}}
if(tempChartMax!=null&&targetAxis){targetAxis.max=Number(tempChartMax);}
if(tempChartMin!=null&&targetAxis){targetAxis.min=Number(tempChartMin);}}
var tempMarkLine;var seriesNum=0;for(var l=0;l<4;l++){for(var index=0;index<_this.entity.modal.option.paraType[l].arrId.length;++index){for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[l].markLine[k].value){if(!option.series[seriesNum].markLine){option.series[seriesNum].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[l].markLine[k].name,value:_this.entity.modal.dsChartCog[l].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[l].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[l].markLine[k].value)}];option.series[seriesNum].markLine.data.push(tempMarkLine);}}
seriesNum++;}}}
!_this.chart&&(_this.chart=echarts.init(_this.container,AppConfig.chartTheme));_this.chart.clear();_this.chart.setOption($.extend(true,{},_this.optionDefault,option));}).error(function(e){}).always(function(e){});}};ModalMultiple.prototype.dealWithData=function(points){if(points.error){this.container.innerHTML='<div id="dataAlert" ></div>';new Alert($("#dataAlert"),"danger","<strong>"+points.error+"</strong>").show();return;}
var arr={arrLegend:{},arrSeries:{}};arr.arrLegend=[];arr.arrSeries=[];var arrTempPoints=[];var dataType=this.entity.modal.option.paraType;for(var i=0;i<dataType.length;++i){for(var j=0;j<dataType[i].arrId.length;++j)
arrTempPoints.push({dsItemId:dataType[i].arrId[j]})}
var arrPointAlias=this.initPointAlias(arrTempPoints);var tempNum=0;for(var i=0;i<dataType.length;i++){switch(dataType[i].type){case'bar':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){if(!AppConfig.isMobile){var series={name:arrPointAlias[tempNum],type:'bar',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};}else{var series={name:arrPointAlias[tempNum],type:'bar',symbol:'none',barGap:0.1,barCategoryGap:0.01,itemStyle:{normal:{shadowBlur:40,shadowColor:'rgba(0, 0, 0, 0.5)',areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};}
arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'line':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'line',symbol:'none',smooth:true,data:points.list[k].data,yAxisIndex:1,z:3}
arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'area':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'line',symbol:'none',itemStyle:{normal:{}},smooth:true,data:points.list[k].data,yAxisIndex:0,z:3};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'cumulativeBar':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){if(!AppConfig.isMobile){var series={name:arrPointAlias[tempNum],type:'bar',stack:'实时累计图',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};}else{var series={name:arrPointAlias[tempNum],type:'bar',stack:'实时累计图',barGap:0.1,barCategoryGap:0.01,symbol:'none',itemStyle:{normal:{shadowBlur:40,shadowColor:'rgba(0, 0, 0, 0.5)',areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};}
arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;}}
return arr;}
ModalMultiple.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.interval=5;this.entity.modal.option.paraType=option.paraType};ModalMultiple.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalMultiple;})();var ModalPredictPointLineConfig=(function($,window,undefined){var _this;function ModalPredictPointLineConfig(options){_this=this;ModalConfig.call(this,options);}
ModalPredictPointLineConfig.prototype=Object.create(ModalConfig.prototype);ModalPredictPointLineConfig.prototype.constructor=ModalPredictPointLineConfig;ModalPredictPointLineConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalPredictPointLineConfig.html'};ModalPredictPointLineConfig.prototype.init=function(){this.$formWrap=$('.form-wrap',this.$wrap);this.$iptChartYaxisMin=$('.ipt-chart-y-axis-min',this.$formWrap);this.$iptChartYaxisMax=$('.ipt-chart-y-axis-max',this.$formWrap);this.$iptChartValUnits=$('.ipt-chart-val-units',this.$formWrap);this.$iptChartValPrecision=$('.ipt-chart-val-precision',this.$formWrap);this.$btnOptionMode=$('.btn-option-mode',this.$formWrap);this.$btnTimeMode=$('.btn-time-mode',this.$formWrap);this.$btnPredictMode=$('.btn-predict-mode',this.$formWrap);this.$divTargetPoint=$('.div-target-point',this.$formWrap);this.$divPredictPoint=$('.div-predict-point',this.$formWrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$dropArea=$('.drop-area',this.$formWrap);this.attachEvents();};ModalPredictPointLineConfig.prototype.recoverForm=function(modal){var name,form,dsChartConfig;if(!modal)return;form=modal.option;dsChartConfig=(modal.dsChartCog&&modal.dsChartCog.length)?modal.dsChartCog[0]:{};if(!form)return;this._setField('input',this.$iptChartYaxisMin,dsChartConfig.lower);this._setField('input',this.$iptChartYaxisMax,dsChartConfig.upper);this._setField('input',this.$iptChartValUnits,dsChartConfig.unit);this._setField('input',this.$iptChartValPrecision,dsChartConfig.accuracy);this._setField('droparea',this.$divTargetPoint,form.targetPointId);this._setField('droparea',this.$divPredictPoint,form.predictPointId);this._setField('dropdown',this.$btnOptionMode,form.optionsMode);this._setField('dropdown',this.$btnTimeMode,form.timeMode);this._setField('dropdown',this.$btnPredictMode,form.predictMode);};ModalPredictPointLineConfig.prototype.reset=function(){this._setField('input',this.$iptChartYaxisMin);this._setField('input',this.$iptChartYaxisMax);this._setField('input',this.$iptChartValUnits);this._setField('input',this.$iptChartValPrecision);this._setField('droparea',this.$divTargetPoint);this._setField('droparea',this.$divPredictPoint);this._setField('dropdown',this.$btnOptionMode);this._setField('dropdown',this.$btnTimeMode);this._setField('dropdown',this.$btnPredictMode);};ModalPredictPointLineConfig.prototype.attachEvents=function(){this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var dsChartConfig={},form={};var val;val=parseFloat(_this.$iptChartYaxisMin.val());dsChartConfig.lower=!isNaN(val)?val:'';val=parseFloat(_this.$iptChartYaxisMax.val());dsChartConfig.upper=!isNaN(val)?val:'';val=parseInt(_this.$iptChartValPrecision.val());dsChartConfig.accuracy=!isNaN(val)?val:'';dsChartConfig.unit=_this.$iptChartValUnits.val();form.optionMode=parseInt(_this.$btnOptionMode.attr('data-value'));form.timeMode=parseInt(_this.$btnTimeMode.attr('data-value'));form.predictMode=parseInt(_this.$btnPredictMode.attr('data-value'));form.targetPointId=_this.$divTargetPoint.attr('data-value');form.predictPointId=_this.$divPredictPoint.attr('data-value');modal.dsChartCog=[dsChartConfig];modal.option=form;modal.points=form.predictMode===0?[form.targetPointId,form.predictPointId]:[form.targetPointId];modal.interval=60000;_this.$modal.modal('hide');e.preventDefault();});};return ModalPredictPointLineConfig;}(jQuery,window));var ModalPredictPointLine=(function($,window,undefined){function ModalPredictPointLine(screen,entityParams,_renderModal,_updateModal,_showConfigMode){var _this=this;if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.chart=null;this.chartOptions=$.extend(true,{},this.optionDefault,DEFAULTS_CHARTS_OPTIONS);this.period=null;this.firstload=$.Deferred();this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalPredictPointLine.prototype=Object.create(ModalRealtimeLine.prototype);ModalPredictPointLine.prototype.constructor=ModalPredictPointLine;ModalPredictPointLine.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_PREDICT_POINT_LINE',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalPredictPointLine',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalPredictPointLine.prototype.renderModal=function(){var _this=this;var modal=this.entity.modal;var dsChartOption=(modal.dsChartCog&&modal.dsChartCog.length)?modal.dsChartCog[0]:{};var option=modal.option;var chartYaxisMin=dsChartOption.lower;var chartYaxisMax=dsChartOption.upper;var chartValUnits=dsChartOption.unit;var chartValPrecision=dsChartOption.accuracy;var timeMode=option.timeMode;var targetPointId=this.entity.modal.points[0];var predictPointId=option.predictPointId;var predictMode=option.predictMode;var period=this.period=this.getPeriod(timeMode);var params=[];var dsName=[];if(predictMode===undefined)predictMode=option.predictMode=0;params.push({dsItemIds:[targetPointId],timeStart:period.startTime,timeEnd:period.endTime,timeFormat:period.tmFmt});dsName=AppConfig.datasource.getDSItemById(targetPointId).alias||targetPointId;this.chartOptions.legend.data=[dsName];this.chartOptions.series[0].name=dsName;if(predictMode===1&&period.endTime<period.rangeEndTime){params.push({dsItemIds:[predictPointId],timeStart:period.endTime,timeEnd:period.rangeEndTime,timeFormat:period.tmFmt});this.chartOptions.legend.data.push('Predict Line');}
if(chartYaxisMin!=='')this.chartOptions.yAxis[0].min=chartYaxisMin;if(chartYaxisMax!=='')this.chartOptions.yAxis[0].max=chartYaxisMax;this.chartOptions.yAxis[0].name=chartValUnits;if(chartValPrecision==='')chartValPrecision=2;WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',params).done(function(rsList){var predictData;var i,t,leni,lent;for(i=0,leni=rsList.length;i<leni;i++){rsList[i].list[0].data=rsList[i].list[0].data.map(function(row,i){return row.toFixed(chartValPrecision);});}
_this.chartOptions.xAxis[0].data=_this.period.timeShaft;predictData=rsList[0].list[0].data;predictData[0]=rsList[0].list[0].data[rsList[0].list[0].data.length-1];predictData=predictData.concat(new Array(_this.period.timeShaft.length-predictData.length+1).join('-').split(''));_this.chartOptions.series[0].data=predictData;if(_this.chart){_this.chart.clear();_this.chart=null;}
_this.chart=echarts.init(_this.container,AppConfig.chartTheme);if(predictMode===1&&rsList[1]){_this.chartOptions.legend.data.push()
predictData=rsList[1].list[0].data;predictData[0]=rsList[0].list[0].data[rsList[0].list[0].data.length-1];predictData=new Array(_this.period.timeShaft.length-predictData.length+1).join('-').split('').concat(predictData);_this.chartOptions.series.push({type:'line',name:'Predict Line',symbol:'none',itemStyle:{normal:{lineStyle:{type:'dotted'},color:'#6495ed',label:{position:'right'}}},data:predictData});_this.chart.clear();_this.chart.setOption(_this.chartOptions);return;}
_this.firstload.done(function(points){_this.updateModal(points,true);});});};ModalPredictPointLine.prototype.updateModal=function(points,force){if(this.firstload.state()==='pending')return this.firstload.resolve(points);if(!points||points.length===0)return;var _this=this;var data=this.chartOptions.series[0].data,predictData;var timeShaft=this.chartOptions.xAxis[0].data;var modal=this.entity.modal;var predictMode=modal.option.predictMode;var pointVal,predictPointVal;var pointId=modal.points[0],predictPointId=modal.points[1];var timeInterval=this.period.tmInterval;var dataLen=data.indexOf('-')-1,timeLen=timeShaft.length;var lastTickVal=timeShaft[dataLen].toDate().valueOf();var nowTick=new Date().valueOf();var row,i,len;force=force===undefined?false:force;if((nowTick-lastTickVal)<this.period.tmInterval&&!force)return;for(i=0,len=points.length;i<len;i++){row=points[i];if(row.dsItemId===pointId){pointVal=parseFloat(row.data);}
if(row.dsItemId===predictPointId){predictPointVal=parseFloat(row.data);}}
if(pointVal!==undefined&&!force){pointVal=Math.round(pointVal*1000)/1000
data.push(pointVal);}
if(predictMode===1){if(!this.chartOptions.series[1])return;predictData=this.chartOptions.series[1].data;if(predictData[predictData.length-1]==='-'){this.chartOptions.series.pop();}
else{predictData.splice(predictData.lastIndexOf('-')+1,1,'-');}
if(predictData[predictData.length-1]!=='-'){predictData.splice(predictData.lastIndexOf('-')+1,1,pointVal);}}
else if(predictPointVal!==undefined){dataLen=data.indexOf('-')-1;if(dataLen===timeLen){timeShaft.push(new Date(lastTickVal+timeInterval).format('yyyy-MM-dd HH:00:00'));}
this.chartOptions.series[0].markPoint.data=[{name:'Predict Value',value:predictPointVal,xAxis:dataLen+1,yAxis:predictPointVal}];lastVal=data[data.indexOf('-')-1];var seriesRepeat=$.extend(true,{},this.chartOptions.series[0]);var seriesOne=this.chartOptions.series[0];seriesRepeat.data[dataLen+1]=predictPointVal;for(var i=0;i<=dataLen;i++){seriesRepeat.data[i]='-';}
seriesRepeat['lineStyle']={normal:{color:'#81a9f0',type:'dotted'}};seriesRepeat.type='effectScatter';seriesRepeat.markLine.data=[[{xAxis:dataLen,yAxis:lastVal},{xAxis:dataLen+1,yAxis:predictPointVal}]];seriesRepeat.markLine.label.normal.show=false;seriesRepeat.showEffectOn='render';seriesRepeat.rippleEffect={brushType:'stroke'};seriesRepeat.itemStyle={normal:{color:'#6898ed',shadowBlur:10,shadowColor:'#333'}};seriesRepeat.symbol='circle'
seriesRepeat.symbolSize=10;seriesOne['lineStyle']={normal:{color:'#e84c3d'}};this.chartOptions.series.push(seriesRepeat);}
this.chart.setOption(this.chartOptions);};ModalPredictPointLine.prototype.getPeriod=function(timeMode){var _this=this;var now,tmFmt,tmInterval,tick,endTick;var start,end;var timeShaft=[];if(!this.m_bIsGoBackTrace){now=new Date();_this.optionDefault.animation=true;}
else{now=this.m_traceData.currentTime;_this.optionDefault.animation=false;}
switch(timeMode){case 0:tmFmt='h1';tmInterval=3600000;start=now.format('yyyy-MM-dd')+' 00:00:00';end=now.format('yyyy-MM-dd HH:00:00');endTick=end.toDate().valueOf();deadlineTick=Math.max(start.toDate().valueOf()+86400000,endTick+28800000);break;case 1:default:tmFmt='d1';tmInterval=86400000;start=now.format('yyyy-MM')+'-01 00:00:00';end=now.format('yyyy-MM-dd 00:00:00');endTick=end.toDate().valueOf();if(this.entity.modal.option.predictMode===1){deadlineTick=now.valueOf()+604800000;}else{deadlineTick=Math.max(start.toDate().valueOf()+DateUtil.daysInMonth(now)*86400000,endTick+604800000);}
break;case 2:tmFmt='h1';tmInterval=3600000;start=new Date(now.valueOf()-((now.getDay()+6)%7)*86400000).format('yyyy-MM-dd 00:00:00');end=now.format('yyyy-MM-dd HH:00:00');endTick=end.toDate().valueOf();deadlineTick=Math.max(start.toDate().valueOf()+604800000,endTick+144000000);break;};tick=start.toDate().valueOf();while(tick<deadlineTick){timeShaft.push(tick.toDate().format('yyyy-MM-dd HH:00:00'));tick+=tmInterval;};return{startTime:start,endTime:end,rangeStartTime:start,rangeEndTime:timeShaft[timeShaft.length-1],tmFmt:tmFmt,tmInterval:tmInterval,timeShaft:timeShaft,deadlineTick:deadlineTick}};ModalPredictPointLine.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalPredictPointLine.prototype.setOptions=function(options){this.options=$.extend({},this.opitons,options);};ModalPredictPointLine.prototype.setModalOption=function(option){};ModalPredictPointLine.prototype.configModal=new ModalPredictPointLineConfig();ModalPredictPointLine.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;};var DEFAULTS_CHARTS_OPTIONS={tooltip:{formatter:function(p){var arrHtml=[p[0].name];p.forEach(function(row){if(row.value==='-')return;arrHtml.push(row.seriesName+': '+row.value);});return arrHtml.join('<br/>');}},series:[{markPoint:{symbol:'emptyCircle',symbolSize:5,effect:{show:true,shadowBlur:0},itemStyle:{normal:{color:'#6495ed',label:{position:'top'}}},data:[]},markLine:{symbol:'circle',symbolSize:1.5,itemStyle:{normal:{lineStyle:{type:'dotted'},color:'#6495ed',label:{position:'right'}}},label:{normal:{show:true}},tooltip:{show:false},data:[]}}],toolbox:{show:false}};return ModalPredictPointLine;}(jQuery,window));var ModalNote=(function(){function ModalNote(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalNote.prototype=new ModalBase();ModalNote.prototype.optionTemplate={name:'toolBox.modal.NOTE',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalNote',tooltip:{'imgPC':false,'imgMobile':false,'isSpecData':false,'desc':''}};ModalNote.prototype.show=function(){this.init();}
ModalNote.prototype.init=function(){}
ModalNote.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();if(!this.entity.modal.modalText)return;var temp=this.entity.modal.modalText;temp=temp.replace(/&lt;%\S+\.*\S+%&gt;/g,'--');this.container.style.padding='8px';this.container.innerHTML=temp;}
ModalNote.prototype.showConfigMode=function(){}
ModalNote.prototype.updateModal=function(points){var arrId=[];for(var i=0;i<points.length;i++){var data=points[i].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}else if(['Null','null','undefined'].indexOf(data)>-1){data='--'}
var $target=$('#divContainer_'+this.entity.id).find('#'+points[i].dsItemId);var textUrl=this.entity.modal.modalTextUrl?this.entity.modal.modalTextUrl:undefined;var index=$target.closest('.springContent').find('.pointValue').index($target);$target.html(data);arrId.push('');if(textUrl&&textUrl.length>0){for(var j=0;j<textUrl[index].ptTextUrl.length;++j){if(textUrl[index].ptTextUrl[j].value==parseInt(data)){arrId[index]=textUrl[index].ptTextUrl[j].url;if(arrId[index]!=''){$target.css({'cursor':'pointer','text-decoration':'underline'});if(textUrl[index].ptTextUrl[j].name&&textUrl[index].ptTextUrl[j].name!=''){$target.html(textUrl[index].ptTextUrl[j].name);}}
break;}}}}
var _this=this;arrId.forEach(function(value,index){if(arrId[index]=='')return;var $target=$('#ulPages').find('[pageId="'+arrId[index]+'"]');var ScreenType;for(var i=0;i<AppConfig.navItems.length;i++){if(AppConfig.navItems[i].id==arrId[index]){ScreenType=AppConfig.navItems[i].type;break;}}
if(!ScreenType){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){ScreenManager.show(ScreenType,arrId[index]);})}else{if(ScreenType=='ReportScreen'){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){var $ev=$('#ulPages [pageid="'+arrId[index]+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');})}else if(ScreenType=='EnergyScreen'){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){ScreenManager.show(EnergyScreen,arrId[index]);})}}})}
ModalNote.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
return ModalNote;})();var ModalRankConfig=(function($,window,undefined){function ModalRankConfig(options){ModalConfig.call(this,options);}
ModalRankConfig.prototype=Object.create(ModalConfig.prototype);ModalRankConfig.prototype.constructor=ModalRankConfig;ModalRankConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalRank.html'};ModalRankConfig.prototype.init=function(){this.$dropArea=$('.drop-area',this.$wrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$rankPointList=$('#rankPointList',this.$wrap);this.$radioRankAsc=$('#radioRankAsc',this.$wrap);this.$radioRankDesc=$('#radioRankDesc',this.$wrap);this.attachEvents();};ModalRankConfig.prototype.recoverForm=function(modal){this._setField('input',this.$rankPointList,modal.points);if(0==modal.desc||null==modal.desc){this.$radioRankAsc.prop('checked',true);this.$radioRankDesc.prop('checked',false);}
else{this.$radioRankAsc.prop('checked',false);this.$radioRankDesc.prop('checked',true);}};ModalRankConfig.prototype.reset=function(){this._setField('input',this.$rankPointList);};ModalRankConfig.prototype.attachEvents=function(){var _this=this;_this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var ptList=_this.$rankPointList.val();modal.points=ptList.split(',');var radioVal=0;if($('#radioRankAsc')[0].checked){radioVal=0;}
else{radioVal=1;}
modal.desc=radioVal;_this.$modal.modal('hide');e.preventDefault();});};return ModalRankConfig;}(jQuery,window));var ModalRank=(function(){function ModalRank(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalRank.prototype=new ModalBase();ModalRank.prototype.optionTemplate={name:'toolBox.modal.WHIRLWIND_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRank'};ModalRank.prototype.show=function(){this.init();}
ModalRank.prototype.init=function(){}
ModalRank.prototype.renderModal=function(e){var _this=this;var arrPrjId=[];for(var i=0,len=AppConfig.projectList.length;i<len;i++){arrPrjId.push(AppConfig.projectList[i].id);}
var arrRankPt=_this.modal.points;var rankDesc=_this.modal.desc;var postData={'projectIds':arrPrjId,'points':arrRankPt,'desc':rankDesc};var showlist={list:[]};var descFlag=0;if(AppConfig.benchMark!=undefined){for(var i=0,len=arrRankPt.length;i<len;i++){for(var j=0,len2=AppConfig.benchMark.length;j<len2;j++){for(var k=0,len3=AppConfig.benchMark[j].points.length;k<len3;k++){if(arrRankPt[i]==AppConfig.benchMark[j].points[k]){showlist.list=AppConfig.benchMark[j].list;descFlag=AppConfig.benchMark[j].desc;break;}}}}}
if(showlist.list.length>0){var flag=true;if(rankDesc!=descFlag){flag=false;}
_this.drawRankChart(showlist,arrRankPt.length,flag);}
else{WebAPI.post('/benchmark/getListByPointsAndProjectIds',postData).done(function(result){_this.drawRankChart(result,arrRankPt.length,true);}).always(function(e){});}
_this.spinner.stop();}
ModalRank.prototype.updateModal=function(){}
ModalRank.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();}
ModalRank.prototype._showConfig=function(){};ModalRank.prototype.setModalOption=function(option){}
ModalRank.prototype.drawRankChart=function(dataSrc,ptLen,sortFlag){var _this=this;var showValue=[];var yAxis=[];var prjId,prjName,ptVal;var curPrjId=AppConfig.projectId;if(sortFlag){for(var i=dataSrc.list.length-1;i>=0;i--){ptVal=dataSrc.list[i].value;if(-1==ptVal){continue;}
prjId=dataSrc.list[i].projectId;if(prjId==curPrjId){showValue.push({value:ptVal,itemStyle:{normal:{color:'#ff6347'}}});}
else{showValue.push(ptVal);}
var findName=false;for(var j=0,len2=AppConfig.projectList.length;j<len2;j++){if(prjId==AppConfig.projectList[j].id){findName=true;break;}}
if(1==ptLen){if(0==_this.m_langFlag){yAxis.push(AppConfig.projectList[j].name_cn);}
else{yAxis.push(AppConfig.projectList[j].name_english);}}
else{if(findName){if(0==_this.m_langFlag){prjName=AppConfig.projectList[j].name_cn;}
else{prjName=AppConfig.projectList[j].name_english;}
yAxis.push(prjName+'-'+dataSrc.list[i].name);}
else{yAxis.push(dataSrc.list[i].name);}}}}
else{for(var i=0,len=dataSrc.list.length;i<len;i++){ptVal=dataSrc.list[i].value;if(-1==ptVal){continue;}
prjId=dataSrc.list[i].projectId;if(prjId==curPrjId){showValue.push({value:ptVal,itemStyle:{normal:{color:'#ff6347'}}});}
else{showValue.push(ptVal);}
var findName=false;for(var j=0,len2=AppConfig.projectList.length;j<len2;j++){if(prjId==AppConfig.projectList[j].id){findName=true;break;}}
if(1==ptLen){if(0==_this.m_langFlag){yAxis.push(AppConfig.projectList[j].name_cn);}
else{yAxis.push(AppConfig.projectList[j].name_english);}}
else{if(findName){if(0==_this.m_langFlag){prjName=AppConfig.projectList[j].name_cn;}
else{prjName=AppConfig.projectList[j].name_english;}
yAxis.push(prjName+'-'+dataSrc.list[i].name);}
else{yAxis.push(dataSrc.list[i].name);}}}}
var chartOption={title:{subtext:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:['value'],show:false},calculable:false,grid:{x:100,y:10,x2:20,y2:60},xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},axisLabel:{show:true,rotate:45},data:yAxis}],series:[{name:'value',type:'bar',data:showValue,itemStyle:{normal:{label:{show:true,position:'inside'},barBorderRadius:[0,5,5,0]},emphasis:{barBorderRadius:[0,5,5,0]}}}]};_this.chart.setOption(chartOption);}
ModalRank.prototype.configModal=new ModalRankConfig();return ModalRank;})();var ModalRankNormal=(function(){function ModalRankNormal(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalRankNormal.prototype=new ModalBase();ModalRankNormal.prototype.optionTemplate={name:'toolBox.modal.RANK_CHART',parent:0,mode:['modalRankNormal'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRankNormal',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalRankNormal.prototype.show=function(){this.init();}
ModalRankNormal.prototype.init=function(){}
ModalRankNormal.prototype.renderModal=function(e){var _this=this;var arrPoint=_this.modal.points;var postData={'dataSourceId':0,'dsItemIds':arrPoint};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(data){_this.drawRankChart(data.dsItemList);}).always(function(e){_this.spinner.stop();});}
ModalRankNormal.prototype.updateModal=function(){}
ModalRankNormal.prototype.showConfigModal=function(){}
ModalRankNormal.prototype._showConfig=function(){}
ModalRankNormal.prototype.setModalOption=function(option){}
ModalRankNormal.prototype.drawRankChart=function(dataSrc){var _this=this;var yAxis=[];var showValue=[];var arrId=[];var arrItem=[];for(var i=dataSrc.length-1;i>=0;i--){arrId.push(dataSrc[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=arrItem.length;i<len;i++){var item=arrItem[i];yAxis.push(item.alias);for(var j=0,len2=dataSrc.length;j<len2;j++){if(item.id==dataSrc[j].dsItemId){showValue.push(parseInt(dataSrc[j].data));break;}}}
for(var i=dataSrc.length-1;i>=0;i--){for(var m=0;m<arrItem.length;m++){if(dataSrc[i].dsItemId==arrItem[m].id){var itemName=arrItem[m].alias;yAxis.push(itemName);showValue.push(parseInt(dataSrc[i].data));break;}}}
var chartOption={title:{subtext:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:[],show:false},calculable:false,grid:{x:100,y:10,x2:20,y2:40},xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},axisLabel:{show:true,rotate:45},data:yAxis}],series:[{name:'value',type:'bar',data:showValue,itemStyle:{normal:{label:{show:true,position:'inside'},barBorderRadius:[0,5,5,0]},emphasis:{barBorderRadius:[0,5,5,0]}}}]};_this.chart.setOption(chartOption);}
return ModalRankNormal;})();var ModalMix=(function(){function ModalMix(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.subChartIds&&(this.entity.modal.option.subChartIds=[]);!this.entity.modal.option.displayInterval&&(this.entity.modal.option.displayInterval=20);};ModalMix.prototype=new ModalBase();ModalMix.prototype.optionTemplate={name:'toolBox.modal.MIX',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMix',tooltip:{'imgPC':true,'imgMobile':true,'isSpecData':false,'desc':''}};ModalMix.prototype.show=function(){this.init();}
ModalMix.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';}
ModalMix.prototype.initContainer=function(replacedElementId){var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass=' gray-scrollbar scrollY';if((!divParent)||replacedElementId){isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
$(divParent).addClass('springContainer');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){this.spanRange={minWidth:1,maxWidth:3,minHeight:1,maxHeight:4.5,yScale:4/3,xScale:4};}else{this.spanRange={minWidth:this.optionTemplate.minWidth,maxWidth:this.optionTemplate.maxWidth,minHeight:this.optionTemplate.minHeight,maxHeight:this.optionTemplate.maxHeight,yScale:1,xScale:1};}
if(AppConfig.isMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){var height=100;height=this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale;height>100&&(height=100);divParent.style.height=height+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale+'%';if(this.UNIT_WIDTH*this.entity.spanC*this.spanRange.xScale>100){divParent.style.width='100%';}
if(this.UNIT_HEIGHT*this.entity.spanR*this.spanRange.yScale>100){divParent.style.height='100%';}}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.title&&this.entity.modal.title!=''&&(!this.entity.isNotRender)){divParent.innerHTML='<div class="panel panel-default">\
                <div class="panel-heading springHead">\
                    <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                </div>\
                <div class="panel-body springContent'+scrollClass+'" style="position: relative;"></div>\
            </div>';}else{divParent.innerHTML='<div class="panel panel-default">\
                <span class="springSeHead fontTemp6">'+(this.entity.modal.title?this.entity.modal.title:'')+'</span>\
                <div class="panel-body springContent'+scrollClass+'" style="position: relative;height:100%;"></div>\
            </div>';}
if(AppConfig.isMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){divParent.children[0].classList.add('transparent');}
if(!(this instanceof ModalAnalysis)){var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];if(this.entity.modal.points&&this.entity.modal.points.length>0){var lkJump;lkJump=document.createElement('a');lkJump.className='springLinkBtn';lkJump.title='Add to datasource';lkJump.href='javascript:;';lkJump.innerHTML='<span class="glyphicon glyphicon-export"></span>';divBtnCtn.appendChild(lkJump);lkJump.onclick=function(){new ModalAppendPointToDs(true,_this.entity.modal.points,null).show();}}
var link=this.entity.modal.link;var _this=this;if(link&&AppConfig.menu[link]){var linkBtn=document.createElement('a');linkBtn.className='springLinkBtn';linkBtn.innerHTML='<span class="glyphicon glyphicon-link"></span>';linkBtn.setAttribute('pageid',link);linkBtn.title='Link to '+AppConfig.menu[link];divBtnCtn.appendChild(linkBtn);linkBtn.onclick=function(e){var $ev=$('#ulPages [pageid="'+link+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');}}
domPanel.appendChild(divBtnCtn);}
this.container=divParent.getElementsByClassName('springContent')[0];return this;}
ModalMix.prototype.renderModal=function(e){var _this=this;var $sliderCont;var $sliderDiv=$('.sliderDiv');if(_this.entity.modal.option.displaySlider&&!_this.entity.modal.option.displayInterval){_this.entity.modal.option.displayInterval=5;}
var displaySlider=_this.entity.modal.option.displayInterval;var carouselTime=new Date();this.container.classList.add('modalMix');if(displaySlider&&displaySlider!='0'){$sliderDiv=$('\
                                <div id="carousel_'+carouselTime.getTime()+'" class="carousel slide sliderDiv" data-ride="carousel">'+'<ol class="carousel-indicators" style="bottom:-6px;">'+'</ol><div class="carousel-inner" role="listbox">'+'</div>'+'<a class="left carousel-control" href="#carousel_'+carouselTime.getTime()+'" role="button" data-slide="prev">'+'<span class="glyphicon glyphicon-chevron-left" aria-hidden="true" style="transform: scale(1,1.3)"></span><span class="sr-only">Previous</span></a>'+'<a class="right carousel-control" href="#carousel_'+carouselTime.getTime()+'" role="button" data-slide="next">'+'<span class="glyphicon glyphicon-chevron-right" aria-hidden="true" style="transform: scale(1,1.3)"></span><span class="sr-only">Next</span></a>'+'</div>');$(_this.container).append($sliderDiv);if(AppConfig.isMobile){$(_this.container).append('<style>.carousel-indicators .active{background-color: rgb(242,199,83);border: none;width: 12px;height: 3px;border-radius: 0;}.carousel-indicators li{background-color: rgba(228, 228, 228,0.5);border-width: 0;width: 12px;height: 3px;margin:1.5px!important;}</style>');$('.carousel-control',_this.container).addClass('hidden');this.attachEventSlider();}}
if(!this.entity.modal.option||!this.entity.modal.option.subChartIds)return;var index=0;this.entity.modal.option.subChartIds.forEach(function(obj){for(var i=0,item;i<_this.screen.store.layout.length;i++){if(displaySlider&&displaySlider!='0'){$(_this.container).css({'display':'block','overflow-y':'hidden'});for(var z=0;z<_this.screen.store.layout[i].length;z++){item=_this.screen.store.layout[i][z];if(obj.id!=item.id)continue;var modelClass,entity;_this.screen.store.layout[i][z].spanC=12;var $sliderIner=$('<div class="item sliderIner"><div class="carousel-caption" style="height:100%;width:100%;right:0;left:0;padding-bottom:0;bottom:0px;padding-top:0px;"></div></div>');var $sliderDot=$('<li data-target="#carousel_'+carouselTime.getTime()+'" data-slide-to="'+index+'" style="border-color:#aaa;margin:1.5px 3px;"></li>')
if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalMix'){entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){if(entity){$(entity.container).height($(_this.container).height()-30);$(entity.container).width($(_this.container).width());}
entity.render();$sliderCont=$(_this.container).children('.springContainer');$sliderIner.children('.carousel-caption').append($sliderCont);$sliderIner.height($(_this.container).height());$sliderDiv.children('.carousel-inner').append($sliderIner);$sliderDiv.children('.carousel-indicators').append($sliderDot);++index;continue;}
if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
if(entity){if(AppConfig.isMobile||(_this.screen.options&&_this.screen.options.isForMobile)){$(entity.container).height($(_this.container).height()-40);}else{if(entity.entity.modal.title!==''){$(entity.container).height($(_this.container).height()-60);}else{$(entity.container).height($(_this.container).height()-30);}}
$(entity.container).width($(_this.container).width());}
entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);if(entity){$(entity.container).height($(_this.container).height()-30);$(entity.container).width($(_this.container).width());}
entity.render();_this.screen.isForReport&&entity.configure();}
$sliderCont=$(_this.container).children('.springContainer');$sliderIner.children('.carousel-caption').append($sliderCont);$sliderIner.height($(_this.container).height()-6);$sliderDiv.children('.carousel-inner').append($sliderIner);$sliderDiv.children('.carousel-indicators').append($sliderDot);++index;}}else{$(_this.container).css({'display':'flex','overflow-y':'auto','flex-flow':'wrap'});for(var j=0;j<_this.screen.store.layout[i].length;j++){item=_this.screen.store.layout[i][j];if(obj.id!=item.id)continue;var modelClass,entity;if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalMix'){entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if(item.modal.type==='ModalAppButton'){entity.render();continue;}
if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);entity.render();_this.screen.isForReport&&entity.configure();}}}}});if(displaySlider){if($(_this.container).find('.item:first')){$(_this.container).find('.item:first').addClass('active');}
if($(_this.container).find('.carousel-indicators').children(':first')){$(_this.container).find('.carousel-indicators').children(':first').addClass('active');}
$(_this.container).find('.sliderDiv').carousel({interval:this.entity.modal.option.displayInterval*1000});}
if(this.entity.modal.option.bgColor){this.container.style.backgroundColor=this.entity.modal.option.bgColor;$(this.container).find('.panel.panel-default').css('cssText','background-color:transparent !important')}}
ModalMix.prototype.showConfigMode=function(){}
ModalMix.prototype.updateModal=function(points){for(var i in points){var data=points[i].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
$('#'+points[i].dsItemId).html(data);}}
ModalMix.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
ModalMix.prototype.configure=function(){if(this.spinner)this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();if(_this.entity.modal.option.subChartIds.length>0){var subChartsIdsMix=_this.entity.modal.option.subChartIds;for(var i=0;i<subChartsIdsMix.length;i++){var item=subChartsIdsMix[i];for(var j=0;j<_this.screen.arrEntityOrder.length;j++){if(item.id===_this.screen.arrEntityOrder[j]){_this.screen.removeEntity(_this.screen.arrEntityOrder[j]);}}}
_this.entity.modal.option.subChartIds=[];}
var oldIndex=_this.screen.arrEntityOrder.indexOf(_this.entity.id);_this.screen.removeEntity(_this.entity.id);var entity=new ModalNone(_this.screen,{id:_this.entity.id,spanC:_this.entity.spanC,spanR:_this.entity.spanR,modal:{type:"ModalNone"}},_this.entity.id);_this.screen.arrEntityOrder.splice(oldIndex,0,entity.entity.id);_this.screen.listEntity[entity.entity.id]=entity;entity.render();entity.configure();entity.hasEdit=true;_this=null;})};divMask.appendChild(btnRemove);var btnAdd=document.createElement('span');btnAdd.className='glyphicon glyphicon-plus-sign springConfigAddBtn grow';btnAdd.title='Add';btnAdd.onclick=function(e){var spanC=6,spanR=6;var $chartsCt=_this.container.classList.contains('chartsCt')?$(_this.container):$(_this.container).siblings().find('.chartsCt');if($chartsCt.children().length>0){var lastDiv=$chartsCt.children()[$chartsCt.children().length-1];spanR=Number(lastDiv.querySelector('#heightResize').value);spanC=Number(lastDiv.querySelector('#widthResize').value);}
if(!_this.container.classList.contains('chartsCt')){_this.container=_this.container.parentElement.getElementsByClassName('chartsCt')[0];}
var entity=new ModalNone(_this,{id:(+new Date()).toString(),spanC:spanC,spanR:spanR,modal:{type:"ModalNone"},isNotRender:true});_this.screen.arrEntityOrder.push(entity.entity.id);_this.screen.listEntity[entity.entity.id]=entity;if(!_this.entity.modal.option){_this.entity.modal.option={};_this.entity.modal.option.subChartIds=new Array();}
_this.entity.modal.option.subChartIds.push({id:entity.entity.id});entity.render();entity.configure();};divMask.appendChild(btnAdd);var btnInstall=document.createElement('span');btnInstall.className='glyphicon glyphicon-cog springConfigInstallBtn grow';btnInstall.title='config';btnInstall.onclick=function(e){_this.showConfigModal();}
divMask.appendChild(btnInstall);var btnHeightResize=document.createElement('div');if(AppConfig.isMobile||this.screen.isForMobile||(this.screen.options&&this.screen.options.isForMobile)){this.entity.spanC=this.optionTemplate.maxWidth=this.optionTemplate.minWidth=3;this.optionTemplate.maxHeight=4.5;(this.entity.spanR>this.optionTemplate.maxHeight)&&(this.entity.spanR=this.optionTemplate.maxHeight);}
var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $chartCt=$('<div class="divResize chartsCt gray-scrollbar">');divMask.appendChild($chartCt[0]);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent,$chartsCt;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();$chartsCt=e.target.classList.contains('chartsCt')?$(e.target):$(e.target).closest('.chartsCt');if(!$sourceParent[0].classList.contains('chartsCt')&&($targetParent[0].classList.contains('chartsCt')||$chartsCt.length==1)){if($targetParent[0].classList.contains('chartsCt')){_this.insertChartIntoMix(sourceId,$targetParent[0])}else if($chartsCt.length==1){_this.insertChartIntoMix(sourceId,$chartsCt[0])}}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}}
this.executeConfigMode();},ModalMix.prototype.insertChartIntoMix=function(sourceId,container){if(sourceId){if(this.screen.listEntity[sourceId].entity.modal.type=='ModalMix'){alert(I18n.resource.toolBox.modal.MSG_MIX_NOT_ALLOW_TO_MIX);return false;}
var modelClass,item,entity=this.screen.listEntity[sourceId].entity;$('#divContainer_'+sourceId).remove();entity.isNotRender=true;if(!this.entity.modal.option){this.entity.modal.option={};}
if(!this.entity.modal.option.subChartIds){this.entity.modal.option.subChartIds=[];}
modelClass=this.screen.factoryIoC.getModel(entity.modal.type);this.screen.container=container;if(container.children.length>0){var lastDiv=container.children[container.children.length-1];entity.spanC=Math.round(parseInt(lastDiv.style.width.split('%')[0])/10)*12/10;entity.spanR=Math.round(parseInt(lastDiv.style.height.split('%')[0])/10)*6/10;}else{entity.spanC=6;entity.spanR=6;}
item=new modelClass(this.screen,entity);item.configure()
this.entity.modal.option.subChartIds.push({id:entity.id});}}
ModalMix.prototype.showConfigModal=function(){var _this=this;var $mixChartShow=$('#mixChartShow');if($mixChartShow.length===0){$mixChartShow=$('\
                            <style>.mixChartShow .row{margin-top: 15px;margin-bottom: 15px;}</style>\
                            <div id="mixChartShow" class="mixChartShow"><div class="modal fade"  style="position:absolute;"><div class="modal-dialog"><div class="modal-content">\
                            <div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                            <h4 class="modal-title">组合图显示模式</h4></div>\
                            <div class="modal-body">\
                            <div class="row">\
                            <div class="col-xs-3">组合图轮播</div>\
                            <div class="col-xs-6"><input type="number" id="iptInterval" placeholder="时间间隔" style="width:100px"/>s(0或者不填写表示不轮播)</div>\
                            </div>\
                            <div class="row">\
                            <div class="col-xs-3">背景颜色</div>\
                            <div class="col-xs-2">\
                            <select id="selBgColor">\
                            <option value="transparent">无</option>\
                            <option value="#ffffff">白</option>\
                            <option value="#000000">黑</option>\
                            <option value="#337ab7">蓝</option>\
                            <option value="#5cb85c">绿</option>\
                            <option value="custom">自定义</option>\
                            </select>\
                            </div>\
                            <div class="col-xs-2"><input type="input" id="iptBgColor" placeholder="#ffffff" style="width:60px"/></div>\
                            <div class="col-xs-2"><input type="color" class="" id="bgColorView"/></div>\
                            </div>\
                            <div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="btnSaveConfig">确定</button></div>\
                            </div></div></div></div>');}
var $paneContent=$('#paneContent');var $konvajsContent=$('.konvajs-content');if($paneContent.length===1){$paneContent.append($mixChartShow);}else if($konvajsContent.length===1){$konvajsContent.append($mixChartShow);}
var $iptBgColor=$('#iptBgColor',$mixChartShow);var $bgColorView=$('#bgColorView',$mixChartShow);var $selBgColor=$('#selBgColor',$mixChartShow);var $iptInterval=$('#iptInterval',$mixChartShow);$iptInterval.val(_this.entity.modal.option.displayInterval?_this.entity.modal.option.displayInterval:20);setShow(_this.entity.modal.option.bgColor?_this.entity.modal.option.bgColor:'transparent');$selBgColor.off('change').on('change',function(e){setShow(this.value,e);});$iptBgColor.off('input').on('input',function(){$bgColorView.val(this.value);});$bgColorView.off('change').on('change',function(e){$iptBgColor.val(this.value);});$('#btnSaveConfig',$mixChartShow).off('click').click(function(){_this.entity.modal.option.displayInterval=$iptInterval.val();_this.entity.modal.option.bgColor=$iptBgColor.val();});$mixChartShow.children('.modal').modal();function setShow(selected,event){if(selected==='transparent'){$bgColorView.hide();}else{$bgColorView.val(selected);$bgColorView.show();}
if(selected==='custom'){$iptBgColor.show();$iptBgColor.val('').focus();}else{$iptBgColor.hide();$iptBgColor.val(selected);}
if(!event){$selBgColor.val(selected);if(!$selBgColor.val()){$selBgColor.val('custom');$iptBgColor.val(selected).show().focus();}}}}
ModalMix.prototype.attachEventSlider=function(){var startPos,isScrolling,endPos,_this=this;this.container.addEventListener('touchstart',function(e){e.preventDefault();var touch=event.targetTouches[0];startPos={x:touch.pageX,y:touch.pageY,time:+new Date};isScrolling=0;_this.container.addEventListener('touchmove',move,false);_this.container.addEventListener('touchend',end,false);},false);function move(){if(event.targetTouches.length>1||event.scale&&event.scale!==1)return;var touch=event.targetTouches[0];endPos={x:touch.pageX-startPos.x,y:touch.pageY-startPos.y};isScrolling=Math.abs(endPos.x)<Math.abs(endPos.y)?1:0;if(isScrolling===1){event.preventDefault();}}
function end(){var duration=+new Date-startPos.time;var i=0;if(Number(duration)>10){if(isScrolling===1){if(endPos.y<-10){i=1;}else if(endPos.y>10){i=3;}}else if(isScrolling===0){if(endPos.x>10){i=2;}else if(endPos.x<-10){i=4;}}
callback(i);startPos=endPos=null;return false;}
_this.container.removeEventListener('touchmove',this,false);_this.container.removeEventListener('touchend',this,false);}
function callback(direction){switch(direction){case 1:break;case 2:$('.left.carousel-control',_this.container).click();break;case 3:break;case 4:$('.right.carousel-control',_this.container).click()
break;default:break;};}}
return ModalMix;})();var ModalMonitor=(function(){var _this;function ModalMonitor(screen,entityParams){_this=this;_this.$configModal=undefined;_this.$modal=undefined;_this.tempOpt=undefined;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalMonitor.prototype=new ModalBase();ModalMonitor.prototype.optionTemplate={name:'toolBox.modal.Monitor',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,scroll:false,type:'ModalMonitor',tooltip:{'imgPC':false,'imgMobile':true,'isSpecData':false,'desc':''}};ModalMonitor.prototype.show=function(){this.init();};ModalMonitor.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';};ModalMonitor.prototype.configure=function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){confirm('Are you sure you want to delete it ?',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this.screen.isScreenChange=true;_this=null;})};divMask.appendChild(btnRemove);if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
var btnHeightResize=document.createElement('div');var maxHeight=this.spanRange.maxHeight;var maxWidth=this.spanRange.maxWidth;var minHeight=this.spanRange.minHeight;var minWidth=this.spanRange.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /'+_this.spanRange.maxHeight+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /'+_this.spanRange.maxWidth+'</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};_this.entity.modal.interval='300000';this.container.parentNode.appendChild(divMask);if(this.entity.isNotRender&&this.screen.entity){$(document.getElementById('divContainer_'+this.screen.entity.id)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}
if(this.entity.isNotRender&&this.screen.listEntity){var parentId=undefined,subChartIds;if(this.entity&&this.entity.id){parentId=this.entity.id;}
if(this.screen.store&&this.screen.store.layout[0]){for(var i=0,len=this.screen.store.layout[0].length,entity;i<len;i++){entity=this.screen.store.layout[0][i];if(entity.modal.type=='ModalMix'&&entity.modal.option.subChartIds&&entity.modal.option.subChartIds.length>0){subChartIds=entity.modal.option.subChartIds;for(var j=0,l=subChartIds.length;j<l;j++){if(subChartIds[j].id==this.entity.id){parentId=entity.id;break;}}}
if(entity.modal.type=='ModalAppBlind'&&entity.modal.option&&entity.modal.option.length>0&&entity.modal.option[0].subChartIds.length>0){var opts=entity.modal.option;for(var m=0;m<opts.length;m++){if(opts[m].subChartIds[0].id===this.entity.id){parentId=entity.id;break;}}}}}
if(parentId){$(document.getElementById('divContainer_'+parentId)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}}
this.divResizeByToolInit();this.executeConfigMode();};ModalMonitor.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();var divMonitor,divIcon,divDetail,spName,spValue,spUnit;var isSemi=false;$(_this.container).addClass('clearfix');$(".springContent").css("overflow","auto");for(var i=0;i<_this.entity.modal.option.length;i++){divMonitor=document.createElement('div');divMonitor.className='divMonitor';isSemi=false;(_this.entity.modal.option[i].col=='1')&&(isSemi=true);isSemi&&(divMonitor.className+=' semiCol');divMonitor.setAttribute("type",_this.entity.modal.option[i].type);divIcon=document.createElement('div');divIcon.className='divIcon';divIcon.innerHTML='<span class="'+_this.entity.modal.option[i].icon+'"></span>';if(_this.entity.modal.option[i].icon){divIcon.style.color=_this.entity.modal.option[i].iconColor;if(isSemi){divIcon.querySelector('span').style.border='2px solid '+_this.entity.modal.option[i].iconColor;}}
divDetail=document.createElement('div');divDetail.className='divMonitorInfo';divValue=document.createElement('div');divValue.className='divValue';spName=document.createElement('span');spName.className='spName';spName.textContent=_this.entity.modal.option[i].name;spValue=document.createElement('span');spValue.dataset.dsId=_this.entity.modal.option[i].dsId;spValue.className='spValue';spUnit=document.createElement('span');spUnit.className='spUnit';spUnit.textContent=_this.entity.modal.option[i].unit;divValue.appendChild(spUnit);divValue.appendChild(spValue);if(_this.entity.modal.option[i].backColor==""){}else{divMonitor.style.background=_this.entity.modal.option[i].backColor;}
if(!isSemi){spUnit.className+=' spUnitCover';spValue.className+=' spValueCover';spName.className+=' spNameCover';divIcon.className='divIconCover';divDetail.className+=' divMonitorInfoCover'
divMonitor.className+=' divMonitorCover';divDetail.appendChild(divIcon);divDetail.appendChild(spName);divDetail.appendChild(divValue);}else{divDetail.appendChild(spValue);divDetail.appendChild(spUnit);divDetail.appendChild(spName);divMonitor.appendChild(divIcon);}
divMonitor.appendChild(divDetail);if(!isSemi){if(AppConfig.isMobile){divMonitor.style.height='3.5rem';}else{divMonitor.style.height=100/Math.ceil(_this.entity.spanR)+'%';}}
_this.container.appendChild(divMonitor);}};ModalMonitor.prototype.showConfigMode=function(){};ModalMonitor.prototype.showConfigModal=function(){_this.tempOpt=$.extend(true,{},_this.entity.modal);var configModalTpl='\
                <div id="modalMonitorConfig" class="modal fade"  role="dialog" aria-labelledby="ttlNodeTool">\
                    <div class="modal-dialog">\
                        <div class="modal-content">\
                            <div class="modal-header">\
                                <span id="btnMonitorAdd" class="glyphicon glyphicon-plus-sign btnMonitorAdd grow"></span>\
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
                                <h4 class="modal-title" id="ttlNodeTool">Diagnosis Edit</h4>\
                            </div>\
                            <div class="modal-body gray-scrollbar" id="ctnMonitor">\
                            </div>\
                            <div class="modal-footer">\
                                <input type ="color">\
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
                                <button type="button" class="btn btnSure btn-primary">Save</button>\
                            </div>\
                        </div>\
                    </div>\
                </div>';_this.$configModal=$('#modalMonitorConfig');if(_this.$configModal.length==0){_this.$configModal=$(configModalTpl);}else{_this.$configModal.modal('show');return;}
_this.$configModal.appendTo($(_this.container).parentsUntil('.springContainer').parent().parent());var $ctnMonitor=_this.$configModal.find('#ctnMonitor').html('');var btnAdd=_this.$configModal.find('#btnMonitorAdd')[0];btnAdd.title='Monitor Type Add';btnAdd.onclick=function(){$ctnMonitor.append(_this.createDivMonitor())};if(_this.entity.modal.option&&_this.entity.modal.option.length>0){for(var i=0;i<_this.entity.modal.option.length;i++){$ctnMonitor[0].appendChild(_this.createDivMonitor(_this.entity.modal.option[i]));}}else{$ctnMonitor[0].appendChild(_this.createDivMonitor());}
_this.$configModal.modal('show');_this.$configModal.find('.btnSure').off('click').on('click',function(){_this.entity.modal=$.extend(true,{},_this.tempOpt);_this.$configModal.modal('hide');});_this.attachMonitorEvent();};ModalMonitor.prototype.updateModal=function(points){this.spinner&&this.spinner.stop();var MonitorInfoS=$(_this.container).find('.divMonitor');var arrSpVal=$(_this.container).find('.spValue');for(var i=0;i<arrSpVal.length;i++){for(var j in points){var data=points[j].data;if(!isNaN(data)){var decmialPoint=_this.entity.modal.option[i].dpoint?_this.entity.modal.option[i].dpoint:0;data=parseFloat(data).toFixed(decmialPoint);}
if(points[j].dsItemId==arrSpVal[i].dataset.dsId){if(MonitorInfoS[i].getAttribute("type")=="数值型"){arrSpVal[i].textContent=data;}else{if(!data==""||!data==0){arrSpVal[i].textContent=data;}else{$(MonitorInfoS[i]).css("background","-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(#D31212), to(#FC1B1B))");arrSpVal[i].textContent=data;}}
break;}}}};ModalMonitor.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalMonitor.prototype.createDivMonitor=function(opt){var divMonitor=document.createElement('div');divMonitor.className='divMonitor';var $divMonitor=$(divMonitor);divMonitor.innerHTML='\
            <div class="divIcon"></div>\
            <div class="divMonitorInfo">\
                <div class="divName">\
                    <label>name:</label>\
                    <span class="spName"></span>\
                    <input class="iptName form-control" ></input>\
                </div>\
                <div class="divValue">\
                    <label>value:</label>\
                    <span class="spValueTip glyphicon glyphicon-plus"></span>\
                    <span class="spValue"></span>\
                </div>\
                <div class="divUnit">\
                    <label>unit:</label>\
                    <span class="spUnit"></span>\
                    <input class="iptUnit form-control"></input>\
                </div>\
                <div class="divType">\
                    <label>type:</label>\
                    <span class="spTypeShow"></span>\
                    <select class="spType">\
                        <option>数值型</option>\
                        <option>报警型</option>\
                    </select>\
                </div>\
                <div class="divCol">\
                    <label>col:</label>\
                    <select class="iptCol form-control" value="1">\
                        <option value="0">一行</option>\
                        <option value="1">半行</option>\
                    </select>\
                </div>\
                <div class="divPoint">\
                    <label>decimal:</label>\
                    <span class="spPoint"></span>\
                    <input class="iptPoint form-control"></input>\
                </div>\
            </div>\
            <div class="divMonitorDel glyphicon glyphicon-remove-circle"></div>';if(opt&&opt.icon){$divMonitor.find('.divIcon').addClass(opt.icon);if(opt.iconColor)$divMonitor.find('.divIcon').css({'color':opt.iconColor,'box-shadow':'0 0 15px '+opt.iconColor})}else{$divMonitor.find('.divIcon').addClass('glyphicon glyphicon-plus').css('color','#f6c700');}
if(opt&&opt.name){$divMonitor.find('.spName').show().text(opt.name);$divMonitor.find('.iptName').hide().val(opt.name)}else{$divMonitor.find('.spName').hide();$divMonitor.find('.iptName').show();}
if(opt&&opt.dsId){$divMonitor.find('.spValue').show().text(AppConfig.datasource.getDSItemById(opt.dsId).alias)[0]
$divMonitor.find('.divValue')[0].dataset.dsId=opt.dsId;$divMonitor.find('.spValueTip').hide()}else{$divMonitor.find('.spValue').hide();$divMonitor.find('.spValueTip').show()}
if(opt&&opt.unit){$divMonitor.find('.spUnit').show().text(opt.unit);$divMonitor.find('.iptUnit').hide().val(opt.unit)}else{$divMonitor.find('.spUnit').hide();$divMonitor.find('.iptUnit').show();}
if(opt&&opt.type){$divMonitor.find('.spTypeShow').show().text(opt.type);$divMonitor.find('.spType').hide();}else{$divMonitor.find('.spTypeShow').hide();$divMonitor.find('.spType').show();}
if(opt&&opt.col){$divMonitor.find('.iptCol').val(opt.col);}
if(opt&&opt.backColor){$divMonitor.css("background",opt.backColor);}else{$divMonitor.css("background","#fff");}
if(opt&&opt.dpoint){$divMonitor.find('.spPoint').show().text(opt.dpoint);$divMonitor.find('.iptPoint').hide().val(opt.dpoint)}else{$divMonitor.find('.spPoint').hide();$divMonitor.find('.iptPoint').show();}
if(!opt){if(!_this.tempOpt.option){_this.tempOpt.option=[];}
_this.tempOpt.option.push({icon:'glyphicon glyphicon-plus',iconColor:'#f6c700',name:'',unit:'',dsId:'',type:'',backColor:'',col:'6',dpoint:''})}
return divMonitor};ModalMonitor.prototype.attachMonitorEvent=function(){var $ctnMonitor=_this.$configModal.find('#ctnMonitor');var $iptColor;var indexDivMonitor;$ctnMonitor.off('click').on('click','.divMonitor',function(){$ctnMonitor.find(".divMonitor").css("border","1px dotted");indexDivMonitor=$ctnMonitor.find(".divMonitor").index($(this));$(this).css("border","1px solid black");})
$(".modal-footer").find("input").off("change").on("change",function(){var colorVal=$(this).val();var rgb=colorVal.colorRgb().split("(")[1].split(")")[0];var r=rgb.split(",")[0];var g=rgb.split(",")[1];var b=rgb.split(",")[2];var hsl=rgbToHsl(r,g,b);var hslEndL=hsl[2]+0.05;var rgbStartColor=hslToRgb(hsl[0],hsl[1],hsl[2]);var rgbEndColor=hslToRgb(hsl[0],hsl[1],hslEndL);var backColor='-webkit-gradient(radial, 184 -25, 161, 220 -257, 465, from(rgb('+rgbStartColor[0]+','+rgbStartColor[1]+','+rgbStartColor[2]+')), to(rgb('+rgbEndColor[0]+','+rgbEndColor[1]+','+rgbEndColor[2]+'))';_this.tempOpt.option[indexDivMonitor].backColor=backColor;$ctnMonitor.find(".divMonitor").eq(indexDivMonitor).css("background",backColor);})
var reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;String.prototype.colorRgb=function(){var sColor=this.toLowerCase();if(sColor&&reg.test(sColor)){if(sColor.length===4){var sColorNew="#";for(var i=1;i<4;i+=1){sColorNew+=sColor.slice(i,i+1).concat(sColor.slice(i,i+1));}
sColor=sColorNew;}
var sColorChange=[];for(var i=1;i<7;i+=2){sColorChange.push(parseInt("0x"+sColor.slice(i,i+2)));}
return"RGB("+sColorChange.join(",")+")";}else{return sColor;}};function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;var max=Math.max(r,g,b),min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return[h,s,l];}
function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var hue2rgb=function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];}
$ctnMonitor.on('click','.divIcon',function(e){e.stopPropagation();$('#ctnMonitor .divMonitor.selected').removeClass('selected');var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').addClass('selected');var index=$ctnMonitor.children().index($divMonitor);if(_this.$modal){_this.$modal.modal('show');$iptColor=_this.$modal.find('#iptColorSel');if(_this.tempOpt.option[index].iconColor){$iptColor.val(_this.tempOpt.option[index].iconColor);}
if(_this.tempOpt.option[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option[index].icon.split(' ')[1]).parent().addClass('selected');}}else{WebAPI.get('static/scripts/spring/entities/modalMonitor.html').done(function(resultHTML){_this.$modal=$(resultHTML);$iptColor=_this.$modal.find('#iptColorSel');_this.$modal.modal('show');if(_this.tempOpt.option[index].iconColor){_this.$modal.find('#iptColorSel').val(_this.tempOpt.option[index].iconColor);}
if(_this.tempOpt.option[index].icon){_this.$modal.find('.bs-glyphicons-list .'+_this.tempOpt.option[index].icon.split(' ')[1]).parent().addClass('selected');}
_this.$modal.find('.bs-glyphicons-list>li').click(function(e){if($(e.currentTarget).hasClass('selected'))return;$('.bs-glyphicons-list>li.selected').removeClass('selected');$(e.currentTarget).addClass('selected');});_this.$modal.find('.btnSure').click(function(e){var $divMonitor=$('#ctnMonitor .divMonitor.selected');var index=$ctnMonitor.children().index($divMonitor);var icon=$('.bs-glyphicons-list>li.selected>.glyphicon-class').text();_this.tempOpt.option[index].icon=icon;_this.tempOpt.option[index].iconColor=$iptColor.val();$divMonitor.find('.divIcon')[0].className='divIcon '+icon;$divMonitor.find('.divIcon').css({'color':$iptColor.val(),'box-shadow':'0 0 15px '+$iptColor.val()});_this.$modal.modal('hide');})})}});$ctnMonitor.on('click','.divMonitorDel',function(e){e.stopPropagation();var index=$ctnMonitor.children().index($(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor'));$ctnMonitor.children().eq(index).remove();_this.tempOpt.option.splice(index,1);_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}});$ctnMonitor.on('click','.spName',function(e){e.stopPropagation();$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptName').show().focus();});$ctnMonitor.on('click','.spUnit',function(e){e.stopPropagation();$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptUnit').show().focus();});$ctnMonitor.on('click','.spPoint',function(e){e.stopPropagation();$(e.currentTarget).hide();$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor').find('.iptPoint').show().focus();});$ctnMonitor.off('blur').on('blur','input',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var value=$(e.currentTarget).val();if($(e.currentTarget).hasClass('iptName')){_this.tempOpt.option[index].name=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spName').text(value).show();}else if($(e.currentTarget).hasClass('iptUnit')){_this.tempOpt.option[index].unit=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spUnit').text(value).show();}else if($(e.currentTarget).hasClass('iptPoint')){_this.tempOpt.option[index].dpoint=value;if(!value)return;$(e.currentTarget).hide();$divMonitor.find('.spPoint').text(value).show();}});$ctnMonitor.off('blur').on('blur','select',function(e){var $divMonitor=$(e.currentTarget).parentsUntil('.ctnMonitor','.divMonitor');var index=$ctnMonitor.children().index($divMonitor);var type=this.value;if($(e.currentTarget).hasClass('iptCol')){if(!type)return;_this.tempOpt.option[index].col=type;}else{_this.tempOpt.option[index].type=type;$(this).hide();$divMonitor.find(".spTypeShow").show().html(type);}});$ctnMonitor.on('click','.spTypeShow',function(e){var $divMonitor=$(this).parentsUntil('.ctnMonitor','.divMonitor');$(this).hide();$divMonitor.find(".spType").show();});$ctnMonitor[0].ondragenter=function(e){e.preventDefault();};$ctnMonitor[0].ondragover=function(e){e.preventDefault();};$ctnMonitor[0].ondragleave=function(e){e.preventDefault();};$ctnMonitor[0].ondrop=function(e){e.preventDefault();var dsItemId=EventAdapter.getData().dsItemId;if(!dsItemId)return;var $divValue=$(e.target).parentsUntil('.ctnMonitor','.divValue');if($divValue.length>0){var index=$ctnMonitor.children().index($divValue.parentsUntil('.ctnMonitor','.divMonitor'));_this.tempOpt.option[index].dsId=dsItemId;$divValue[0].dataset.dsId=dsItemId;$divValue.find('.spValue').text(AppConfig.datasource.getDSItemById(dsItemId).alias).show();$divValue.find('.spValueTip').hide();_this.tempOpt.points=[];for(var i=0;i<$ctnMonitor.find('.divValue').length;i++){_this.tempOpt.points.push($ctnMonitor.find('.divValue')[i].dataset.dsId);}}};};return ModalMonitor;})();(function(){var tags={};var TOOLBOX=['DataSource','LinkTo'];var PATTERN_STR='<('+TOOLBOX.join('|')+').*?(/|'+TOOLBOX.join('|')+')>';window.__spring_html_modal={};function runScript(content){var done=false;var script=document.createElement("script");var head=document.getElementsByTagName("head")[0];script.type="text\/javascript";script.text=content;head.appendChild(script);head.removeChild(script);}
tags.Base=(function(){function Base(modal){this.$textarea=modal.$textarea;this.$modalCt=modal.$modalCt;this.$toolBtn=null;this.init();}
Base.prototype.init=function(){throw new Error('init 方法未被实现，不可直接调用');};Base.prototype.render=function($container){throw new Error('render 方法未被实现，不可直接调用');};return Base;}());tags.DataSource=(function(){var _this;function DataSource(modal){_this=this;tags.Base.call(this,modal);}
DataSource.prototype=Object.create(tags.Base.prototype);DataSource.prototype.constructor=DataSource;DataSource.prototype.insertTpl='<DataSource data-id="{id}"{linkTo}/>';DataSource.prototype.init=function(){var arrHtml=[];this.$toolBtn=$('<button type="button" class="btn btn-default" data-toggle="collapse" data-target="#panelDataSourceConfig" aria-expanded="false">\
                DataSource\
                </button>');this.$toolConfig=$('#panelDataSourceConfig',this.$modalCt);};DataSource.prototype.render=function($btnCtn){$btnCtn.append(this.$toolBtn);this.attachEvents();};DataSource.prototype.attachEvents=function(){};DataSource.save=function(dataset,modal){var id;if(!dataset)return;id=dataset.id;if(id&&modal.points.indexOf(id)===-1)modal.points.push(id);};DataSource.getStaticRender=function(dom){var dataset=dom.dataset;var menuId=dataset.linkTo;var $ele;if(menuId){$ele=$('<a href="javascript:;" data-is="DataSource" data-id="'+dataset.id+'">Loading</a>');$ele.click(function(e){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');});return $ele;}
else return $('<span data-is="DataSource" data-id="'+dataset.id+'">Loading</span>');};DataSource.getRealTimeRender=function($ele,map){var dataset=$ele[0].dataset;if(isNaN(map[dataset.id])){$ele.html(map[dataset.id]);}else{$ele.html(parseFloat(map[dataset.id]));}};return DataSource;}());tags.LinkTo=(function(){var _this;function LinkTo(modal){_this=this;tags.Base.call(this,modal);}
LinkTo.prototype=Object.create(tags.Base.prototype);LinkTo.prototype.constructor=LinkTo;LinkTo.prototype.insertTpl='<LinkTo data-id="{id}" ></LinkTo>';LinkTo.prototype.init=function(){var arrHtml=[];this.$toolBtn=$('<button type="button" class="btn btn-default" data-parent="#collapseList" data-toggle="collapse" data-target="#panelLinkToConfig" aria-expanded="false">LinkTo</button>');this.$toolConfig=$('#panelLinkToConfig',this.$modalCt);};LinkTo.prototype.render=function($btnCtn){$btnCtn.append(this.$toolBtn);this.attachEvents();};LinkTo.prototype.attachEvents=function(){};LinkTo.save=function(dataset,modal){};LinkTo.getStaticRender=function(dom,doc){var dataset=dom.dataset;var menuId=dataset.id;doc=doc||window.document;$ele=$('<a href="javascript:;">'+(dom.innerHTML||'Link To')+'</a>',doc);$ele.click(function(){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev.length>0){if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');}});return $ele;};return LinkTo;}());var ModalHtmlConfig=(function(){var _this;var gMenusHtml;function ModalHtmlConfig(options){_this=this;ModalConfig.call(this,options);this.toolbox=[];}
ModalHtmlConfig.prototype=Object.create(ModalConfig.prototype);ModalHtmlConfig.prototype.constructor=ModalHtmlConfig;ModalHtmlConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalHtmlConfig.html'};ModalHtmlConfig.prototype.init=function(){this.$modal=$('.modal',this.$wrap);this.$modalCt=$('.modal-content',this.$wrap);this.$formWrap=$('.form-wrap',this.$wrap);this.$dsGroupList=$('.form-horizontal','#panelDataSourceConfig');this.$linkGroupList=$('.form-horizontal','#panelLinkToConfig');this.$textarea=$('.form-textarea',this.$formWrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$toolboxCtn=$('.toolbox-ctn',this.$formWrap);this.$btnResizeFull=$('.btn-resize-full',this.$wrap);this.$btnResizeSmall=$('.btn-resize-small',this.$wrap);this.attachEvents();this.initToolbox();};ModalHtmlConfig.prototype.initToolbox=function(){var $toolboxGroup=$('<div class="btn-group" role="group">').appendTo(this.$toolboxCtn);TOOLBOX.forEach(function(row){var labelClass=tags[row];var labelIns;if(typeof labelClass!=='function'){console.warn(I18n.resource.dashboard.modalJumpPages.NO_LABLE+row);return;}
labelIns=new labelClass(_this);labelIns.render($toolboxGroup);});var $tools=$('.btn',$toolboxGroup);$toolboxGroup.on('click','.btn',function(){$(this).toggleClass('btn-primary');});};ModalHtmlConfig.prototype.recoverForm=function(form){var _this=this;var options;if(!form||!form.option){this.addDsFormGroup();return;}
options=form.option;var arrId=[];form.points.forEach(function(row){arrId.push(row);});var arrItem=AppConfig.datasource.getDSItemById(arrId);form.points.forEach(function(row){for(var m=0;m<arrItem.length;m++){if(row==arrItem[m].id){var $ele=_this.addDsFormGroup({id:row,cls:' dropped',value:row,name:arrItem[m].alias||'未找到名称',display:'inline'});break;}}});this.addDsFormGroup();this._setField('textarea',this.$textarea,options.html);};ModalHtmlConfig.prototype.reset=function(){this.$dsGroupList.empty();this._setField('textarea',this.$textarea);};ModalHtmlConfig.prototype.addDsFormGroup=function(data){if(data===undefined){data={id:I18n.resource.dashboard.modalJumpPages.PARAM_INTRO,cls:'',value:'',name:'<span class="glyphicon glyphicon-plus"></span>'}}
return $('<div class="form-group{cls}">\
                <label class="col-md-2 control-label" for="">Point</label>\
                <div class="col-md-4">\
                    <div class="label-area div-ds-id">{id}</div>\
                </div>\
                <div class="col-md-4">\
                    <div class="drop-area div-ds-point" data-value="{value}">\
                        {name}\
                    </div>\
                </div>\
                <div class="col-md-2">\
                    <div class="opt-icon-area">\
                        <span class="glyphicon glyphicon-remove"></span>\
                    </div>\
                </div>\
            </div>'.formatEL(data)).appendTo(_this.$dsGroupList);};ModalHtmlConfig.prototype.initLinkFormGroup=function(){var arrHtml=[];for(var i in AppConfig.menu){if(!AppConfig.menu.hasOwnProperty(i))continue;arrHtml.push('<div class="form-group">\
                    <label class="col-md-2 control-label" for="">Link</label>\
                    <div class="col-md-4">\
                        <div class="label-area">{id}</div>\
                    </div>\
                    <div class="col-md-4"><div class="label-area">{name}</div></div>\
                </div>'.formatEL({id:i,name:AppConfig.menu[i]}));}
return this.$linkGroupList.html(arrHtml.join(''));};ModalHtmlConfig.prototype.onDropActionPerformed=function(e){$(e.target).removeClass('on');var itemId=EventAdapter.getData().dsItemId;var isNotShowMsg=true;if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){addPointDrag(itemId[i]);}}else{addPointDrag(itemId);}
if(isNotShowMsg){alert(I18n.resource.dashboard.modalJumpPages.DATA_EXIST);return false;}
function addPointDrag(itemId){var $target=$('.drop-area[data-value=""]');_this._setField('droparea',$target,itemId);var dsId=$target[0].dataset.value;var $formGroup=$target.closest('.form-group');if(_this.$dsGroupList.find('[data-value="'+dsId+'"]').length>1){_this._setField('droparea',$formGroup.find('.drop-area'));}else{$formGroup.addClass('dropped');$formGroup.find('.label-area').text(dsId);isNotShowMsg=false;_this.addDsFormGroup();}}
e.stopPropagation();};ModalHtmlConfig.prototype.attachEvents=function(){var _this=this;this.$modal.on('show.bs.modal',function(){_this.initLinkFormGroup();});this.$wrap.on('click','.opt-icon-area',function(e){$(this).closest('.form-group').remove();});this.$btnResizeFull.off().click(function(){var height=_this.$modal.height();_this.$modal.addClass('maxium-screen');_this.$textarea.height(height-208);});this.$btnResizeSmall.off().click(function(){_this.$modal.removeClass('maxium-screen');_this.$textarea.height('auto');});this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var form={};var html;var toolboxStr,pattern,match;html=form.html=_this.$textarea.val();modal.points=[];_this.$dsGroupList.find('.dropped .drop-area').each(function(){modal.points.push($(this)[0].dataset.value);});toolboxStr=TOOLBOX.join('|');pattern=new RegExp(PATTERN_STR,'ig');while((match=pattern.exec(html))!==null){try{var dom=$(match[0])[0];}catch(e){continue;}
tags[match[1]].save(dom.dataset,modal);}
pattern=new RegExp('<%([^,<>%]+).*?%>','mg');while((match=pattern.exec(html))!==null){if(modal.points.indexOf(match[1])===-1){modal.points.push(match[1]);}}
modal.option=form;modal.dsChartCog=[{accuracy:2}];modal.interval=60000;_this.$modal.modal('hide');modalIns.preview();e.preventDefault();});this.$textarea[0].addEventListener("dragover",function(event){event.preventDefault();});this.$textarea[0].addEventListener("drop",function(event){event.preventDefault();var itemId=EventAdapter.getData().dsItemId;if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){dotIsExist(itemId[i]);}}else{dotIsExist(itemId);}
function dotIsExist(itemId){var dropAreaList=$('.drop-area',_this.$wrap);var lens=dropAreaList.length;var isExist=false;for(var j=0;j<lens;j++){if(dropAreaList.eq(j).attr('data-value')===itemId){isExist=true;}}
if(!isExist){var text='<%'+itemId+'%>';insertText(event.target,text);}else{return false;}}
_this.$wrap.find('.drop-area[data-value=""]').trigger('drop',true);});function insertText(obj,str){if(typeof obj.selectionStart==='number'&&typeof obj.selectionEnd==='number'){var startPos=obj.selectionStart,endPos=obj.selectionEnd,cursorPos=startPos,tmpStr=obj.value;obj.value=tmpStr.substring(0,startPos)+str+tmpStr.substring(endPos,tmpStr.length);cursorPos+=str.length;obj.selectionStart=obj.selectionEnd=cursorPos;}else{obj.value+=str;}}};return ModalHtmlConfig;}());this.ModalHtml=(function(ToolTipMixin){function ModalHtml(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.promise=$.Deferred();this.firstUpdateData=null;this.lastUpdateTimeTick=null;this.customTags={};this.initCustomVaribles();}
ModalHtml.prototype=Object.create(ModalBase.prototype);ModalHtml.prototype.constructor=ModalHtml;ModalHtml.prototype=Mixin(ModalHtml.prototype,ToolTipMixin);ModalHtml.prototype.optionTemplate={name:'toolBox.modal.MODAL_HTML',parent:0,mode:'custom',maxNum:10,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,defaultHeight:4.5,defaultWidth:3,type:'ModalHtml',tooltip:{'imgPC':false,'imgMobile':false,'isSpecData':false,'desc':''}};ModalHtml.prototype.initCustomVaribles=function(){var container=this.container;var screen;window.__spring_html_modal[this.entity.id]=this.customVaribles={};this.customVaribles.widgetModal=this.entity.modal;this.customVaribles._wrapContainer=document.querySelector('#divContainer_'+this.entity.id);this.customVaribles.dataMap={};var arrParams=window.location.hash.split('&');if(arrParams&&arrParams.length>0){for(var i=0;i<arrParams.length;i++){if(arrParams[i].indexOf('response=')>-1){this.customVaribles.dataParams=arrParams[i];}}}
this.customVaribles.linkTo=function(menuId,ctnSelector,linkType,linkName,linkParams){var $ev,ctn;if(!ctnSelector&&!linkType){$ev=$('#ulPages [pageid="'+menuId+'"]');if($ev.length>0){if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
if(linkParams){$ev.trigger('click',[{response:linkParams}]);}else{$ev.trigger('click');}
return;}}
if(ctnSelector){ctn=document.querySelector(ctnSelector);if(!ctn)return;ctn.innerHTML='';if(screen){screen.close();screen=null;}}
linkType=linkType||'EnergyScreen';switch(linkType){case'EnergyScreen_M':case'EnergyScreen':if(!ctn){if(!AppConfig.isMobile){ScreenManager.show(EnergyScreen,menuId);}else{var isIndex=linkType=='EnergyScreen_M';router.to({typeClass:ProjectDashboard,data:{menuId:menuId,isIndex:isIndex,name:linkName}})}}else{screen=new EnergyScreen();screen.id=menuId;screen.container=ctn;screen.isForBencMark=true;screen.init();}
break;case'ObserverScreen':if(!ctn){ScreenManager.goTo({page:linkType,id:menuId});}else{screen=new ObserverScreen(menuId);ctn.innerHTML='<div class="divMain" style="width: 100%; height: 100%;">\
                                    <div class="div-canvas-ctn" style="padding: 0; margin: 0 auto; height: 100%; width: 100%;">\
                                        <canvas class="canvas-ctn" style="width: 100%; height: 100%;">浏览器不支持</canvas>\
                                    </div>\
                                    <div id="divObserverTools" style="height: 0"></div>\
                                </div>';screen.isInDashBoard=true;screen.show(ctn);}
break;case'FacReportScreen':if(!ctn){ScreenManager.goTo({page:'observer.screens.FacReportScreen',options:{id:menuId},container:'indexMain'});}
break;case'FacReportWrapScreen':if(!ctn){if(AppConfig.isMobile){router.to({typeClass:MessageFactoryReport,data:{}})}else{ScreenManager.goTo({page:'observer.screens.FacReportWrapScreen',options:{id:menuId},container:'indexMain',response:linkParams});}}
break;case'DiagnosisScreen':if(!ctn){ScreenManager.goTo({page:linkType,options:{defaultMenuId:menuId}});}
break;default:return;}};};ModalHtml.prototype.initCustomTags=function(doc){var _this=this;doc=doc||document;TOOLBOX.forEach(function(row,i){var $tagEle=$(row,doc);var thisTags=[];var staticHtmlRender;if(!$tagEle.length)return;if(typeof(staticHtmlRender=tags[row].getStaticRender)!=='function')return;([]).forEach.call($tagEle,function(rowt,t){var $rs=staticHtmlRender(rowt);if(!$rs)return;thisTags.push($rs);$(rowt).replaceWith($rs);});if(thisTags.length)_this.customTags[row]=thisTags;});};ModalHtml.prototype.initCustomAttrs=function(){var _this=this;var $container=$(this.container);$container.on('click','[data-link-to]',function(e){var linkType=this.dataset['linkType'];var ctnSelector=this.dataset['linkTarget'];var menuId=this.dataset['linkTo'];var linkName=this.dataset['linkName'];var linkParams=this.dataset['linkParams'];try{linkParams=JSON.parse(linkParams);}catch(e){}
_this.customVaribles.linkTo(menuId,ctnSelector,linkType,linkName,linkParams);e.preventDefault();});};ModalHtml.prototype._parseOptionStr=function(optionStr){var arr=optionStr.split(',');var opt={};arr.forEach(function(kv){var kvArr=kv.split('=');if(kvArr.length===1){opt[kv]='true';}else{opt[kvArr[0]]=kvArr[1];}});return opt;};ModalHtml.prototype._formatNumber=function(num,options){var rs='';var toString=Object.prototype.toString;var decimalPortion;var numstr,isNegative;if(isNaN(num))return num;num=parseFloat(num);isNegative=num<0;num=Math.abs(num);if(!isNaN(options.p)){options.p=parseInt(options.p);num=num.toFixed(options.p);}
decimalPortion=(num+'').split('.')[1]||'';num=parseInt(num);if(options.ts==='true'){numstr=num+'';while(numstr.length>3){rs=','+numstr.substr(-3,3)+rs;numstr=numstr.substr(0,numstr.length-3);}
rs=numstr+rs;}else{rs=num+'';}
rs=decimalPortion===''?rs:(rs+'.'+decimalPortion);if(parseFloat(rs)===0){return rs;}
return(isNegative?'-':'')+rs;};ModalHtml.prototype._formatNode=function(node,options,params){var domWrap;if(options.draggable&&!node.parentNode.dataset.h5DraggableNode){domWrap=document.createElement('span');domWrap.draggable='true';domWrap.dataset.h5DraggableNode='true';domWrap.dataset.dsId=params.dsId||'';node.parentNode.insertBefore(domWrap,node);domWrap.appendChild(node);}};ModalHtml.prototype.setToolTip=function(node,params){var domWrap;if(node.parentNode.dataset.h5DraggableNode==='true'){domWrap=node.parentNode;}else{domWrap=document.createElement('span');domWrap.dataset.dsId=params.dsId||'';domWrap.dataset.h5DraggableNode='true';node.parentNode.insertBefore(domWrap,node);domWrap.appendChild(node);}
this.initTooltip({shape:domWrap,ds:params.dsId,container:this.screen.container,clickable:AppConfig.isFactory===0});};ModalHtml.prototype.buildDsBinding=function(){var _this=this;var dataMap=this.customVaribles.dataMap={};var $container=$(this.container);var ds=dataMap;var textNodeMap={},attrNodeMap={};var dsNameList=this.entity.modal.points;var $textNodes=$container.find('.text-node-placeholder');var $attrNodes=$container.find('[data-inner-ds-info]');dsNameList.forEach(function(name){var $nodes;if(($nodes=$textNodes.filter('[data-name^="'+name+'"]')).length){$nodes.each(function(){var nodeDataName=$(this).attr('data-name');if(nodeDataName.split(',')[0]!==name)return;var text=document.createTextNode('');if(!textNodeMap[name]){textNodeMap[name]=[{name:this.getAttribute('data-name'),node:text}];}else{textNodeMap[name].push({name:this.getAttribute('data-name'),node:text});}
this.parentNode.replaceChild(text,this);});}else{textNodeMap[name]=[];}
if(($nodes=$attrNodes.filter('[data-inner-ds-info*="'+name+'"]')).length){$nodes.each(function(){var $this=$(this);var attr=$this.data('ds.attr');var info=$this.data('ds.info');if(attr===undefined){$this.data('ds.attr',(attr=this.getAttribute('data-inner-ds-attr')));}
if(info===undefined){info=window.decodeURIComponent(this.getAttribute('data-inner-ds-info'));$this.data('ds.info',(info=JSON.parse(info)));}
if(!attrNodeMap[name]){attrNodeMap[name]=[{node:this.getAttributeNode(attr),info:info}]}else{attrNodeMap[name].push({node:this.getAttributeNode(attr),info:info});}});}else{attrNodeMap[name]=[];}
if(!ds.__observerProps)ds.__observerProps={};if(!ds.__observerProps.hasOwnProperty(name)){ds.__observerProps[name]=null;Object.defineProperty(ds,name,{get:function(){return this.__observerProps[name];},set:function(value){if(value===this.__observerProps[name])return;this.__observerProps[name]=value;textNodeMap[name].forEach(function(row){var content=row.name;var node=row.node;var idx=content.indexOf(',');var options;if(idx>-1){options=_this._parseOptionStr(content.substr(idx+1));node.data=_this._formatNumber(value,options);_this._formatNode(node,options,{dsId:content.substr(0,idx)});}else{node.data=isNaN(value)?_this._decodeHtml(value):parseFloat(value).toString();}
if(!isNaN(value)&&!AppConfig.isMobile){_this.setToolTip(node,{dsId:idx>-1?content.substr(0,idx):content});}});attrNodeMap[name].forEach(function(row){var info=row.info;var str='';info.forEach(function(row){var idx;if(row.type===TextTemplateParser.types.text){str+=row.value;}else if(row.type===TextTemplateParser.types.binding){if(row.value.indexOf(name)>-1){idx=row.value.indexOf(',');if(idx>-1){row.content=_this._formatNumber(value,_this._parseOptionStr(row.value.substr(idx+1)));}else{row.content=isNaN(value)?value:parseFloat(value).toString();}}
str+=row.content;}});row.node.value=str;});}});}});$attrNodes.each(function(){this.removeAttribute('data-inner-ds-info');this.removeAttribute('data-inner-ds-attr');});};ModalHtml.prototype._decodeHtml=function(html){var txt=document.createElement("textarea");txt.innerHTML=html;return txt.value;};ModalHtml.prototype.renderModal=function(){var _this=this;var options=this.entity.modal.option;var info;var parser=TextTemplateParser;if(!options){$(this.container).html('');this.spinner.stop();return;}
info=this.getFormatHtml(options.html);info.html=info.html.replace(/([\w-]+?)="([^"]*<%[^<>]+?%>[^"]*)"/mg,function($0,$1,$2){var tokens=parser.parse($2,['<%','%>']);var infoStr;tokens.forEach(function(row){if(row.type===parser.types.binding){row.content='';}});infoStr=window.encodeURIComponent(JSON.stringify(tokens));return $1+'="" data-inner-ds-info="'+infoStr+'" data-inner-ds-attr="'+$1+'"';});info.html=info.html.replace(/<%(.+?)%>/mg,function($0,$1){return'<span class="text-node-placeholder" data-name="'+$1+'">'+$1+'</span>';});$(this.container).html(info.html);runScript(info.scriptContent);_this.initCustomTags();_this.initCustomAttrs();_this.buildDsBinding();if(typeof _this.customVaribles.onRenderComplete==='function'){_this.customVaribles.onRenderComplete.call(null);}
_this.promise.done(function(data){if(!data)return;_this.updateModal(data);});_this.promise.resolve(_this.firstUpdateData);_this.spinner.stop();};ModalHtml.prototype.updateModal=function(data){var _this=this;var modal,updateInterval,options,now;var thisTags;var dataMap=this.customVaribles.dataMap;var customEventHandlers;if(this.promise.state()==='pending'){this.firstUpdateData=data;return;}
modal=this.entity.modal;updateInterval=modal.interval;options=this.entity.options;nowTick=new Date().valueOf();data.forEach(function(row){dataMap[row.dsItemId]=row.data;});for(var tagName in this.customTags){if(!this.customTags.hasOwnProperty(tagName))continue;thisTags=this.customTags[tagName];thisTags.forEach(function($row,i){var handler=tags[tagName].getRealTimeRender;if(typeof handler!=='function')return;handler($row,dataMap);});}
if(typeof this.customVaribles.onUpdateComplete==='function'){this.customVaribles.onUpdateComplete.call(null,dataMap);}};ModalHtml.prototype.showConfigMode=function(){};ModalHtml.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalHtml.prototype.configModal=new ModalHtmlConfig();ModalHtml.prototype.getFormatHtml=function(html){var _this=this;var patternScript=/(<script\b[^>]*>)([\s\S]*?)(<\/script>)/img;var scriptContent=[];var wrapTpl='(function() { |code| }).call(window.__spring_html_modal[\''+_this.entity.id+'\'])';var formatHtml=html.replace(patternScript,function($0,$1,$2,$3){if($2.trim()!=='')scriptContent.push($2);return'';});return{scriptContent:wrapTpl.replace('|code|',scriptContent.join(';\n')),html:formatHtml};};ModalHtml.prototype.preview=function(){};ModalHtml.prototype.close=function(){this.container.innerHTML='';};return ModalHtml;}(namespace('mixins.TooltipMixin')));var TextTemplateParser=(function(){function TextTemplateParser(){}
TextTemplateParser.types={text:0,binding:1};TextTemplateParser.parse=function(template,delimiters){var index,lastIndex,lastToken,length,substring,tokens,value;tokens=[];length=template.length;index=lastIndex=0;while(lastIndex<length){index=template.indexOf(delimiters[0],lastIndex);if(index<0){tokens.push({type:this.types.text,value:template.slice(lastIndex)});break;}else{if(index>0&&lastIndex<index){tokens.push({type:this.types.text,value:template.slice(lastIndex,index)});}
lastIndex=index+delimiters[0].length;index=template.indexOf(delimiters[1],lastIndex);if(index<0){substring=template.slice(lastIndex-delimiters[0].length);lastToken=tokens[tokens.length-1];if((lastToken!==undefined?lastToken.type:void 0)===this.types.text){lastToken.value+=substring;}else{tokens.push({type:this.types.text,value:substring});}
break;}
value=template.slice(lastIndex,index).trim();tokens.push({type:this.types.binding,value:value});lastIndex=index+delimiters[1].length;}}
return tokens;};return TextTemplateParser;}());}).call(this);var ModalChartCustomConfig=(function($,window,undefined){function ModalChartCustomConfig(options){ModalConfig.call(this,options);this.m_bIsRealTime=true;this.m_bIsHisFixCycle=true;}
ModalChartCustomConfig.prototype=Object.create(ModalConfig.prototype);ModalChartCustomConfig.prototype.constructor=ModalChartCustomConfig;ModalChartCustomConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalChartCustom.html'};ModalChartCustomConfig.prototype.init=function(){var _this=this;_this.$btnSubmit=$('#btnSubmit',_this.$wrap);_this.$editor=$('#editor',_this.$wrap);_this.$selectMode=$('#inputMode',_this.$wrap);_this.$selRealInterval=$('#selRealInterval',_this.$wrap);_this.$tmStart=$('#timeStart',_this.$wrap);_this.$tmEnd=$('#timeEnd',_this.$wrap);_this.$tmGroup=$('#rangeSel',_this.$wrap);_this.$divRealtmCycle=$('#divRealTimeCycle',_this.$wrap);_this.$selectHisCycleMode=$('#hisCycleMode',_this.$wrap);_this.$selectHisInterval=$('#selHisInterval',_this.$wrap);_this.$divHisTmRange=$('#historyTmRange',_this.$wrap);_this.$divHisTmCycle=$('#historyTmCycle',_this.$wrap);_this.$inputPeriodVal=$('#inputPeriodValue',_this.$wrap);_this.$selPeriUnit=$('#inputPeriodUnit',_this.$wrap);var modal=_this.options.modalIns.entity.modal;EventAdapter.on($(_this.$editor[0]),'drop',function(e){e.preventDefault();this.focus();var itemId=EventAdapter.getData().dsItemId;if(Boolean(itemId)){if(Object.prototype.toString.call(itemId)==='[object Array]'){var len=itemId.length;for(var i=0;i<len;i++){var itemName=AppConfig.datasource.getDSItemById(itemId[i]).alias;dropTextInter(itemId[i],itemName);}}else{var itemName=AppConfig.datasource.getDSItemById(itemId).alias;dropTextInter(itemId,itemName);}
function dropTextInter(itemId,itemName){var spanCtl=$('<span id="'+itemId+'" title="'+itemName+'" class="pointValue"></span>');spanCtl.text('"<%'+itemName+'%>"');var sel,range;if(window.getSelection){sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var insertDiv=$('<div>');insertDiv.append('&nbsp;');insertDiv.append(spanCtl);insertDiv.append('&nbsp;');var el=insertDiv[0];var frag=document.createDocumentFragment(),node,lastNode;while((node=el.firstChild)){lastNode=frag.appendChild(node);}
range.insertNode(frag);if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range);}}}
_this.$editor.append('&nbsp;');}}});EventAdapter.on($(_this.$editor[0]),'dragover',function(e){e.preventDefault();});if(Boolean(modal.option)){if(!modal.option.isRealTime){_this.m_bIsRealTime=false;_this.$selectMode.val('history');_this.$tmGroup.css('display','block');_this.$divRealtmCycle.css('display','none');}
else{_this.m_bIsRealTime=true;_this.$selectMode.val('realTime');_this.$tmGroup.css('display','none');_this.$divRealtmCycle.css('display','block');}
if(!modal.option.isHisFixCycle){_this.m_bIsHisFixCycle=false;_this.$selectHisCycleMode.val('recent');_this.$divHisTmRange.css('display','none');_this.$divHisTmCycle.css('display','block');}
else{_this.m_bIsHisFixCycle=true;_this.$selectHisCycleMode.val('fixed');_this.$divHisTmRange.css('display','block');_this.$divHisTmCycle.css('display','none');}
switch(modal.interval){case'm1':case'm5':case'h1':case'd1':case'M1':_this.$selRealInterval.val(modal.interval);_this.$selectHisInterval.val(modal.interval);break;default:_this.$selRealInterval.val('h1');_this.$selectHisInterval.val('h1');break;}
_this.$tmStart.val(modal.option.timeStart);_this.$tmEnd.val(modal.option.timeEnd);_this.$inputPeriodVal.val(modal.option.timeCycleValue);if(!modal.option.timeCycleUnit){_this.$selPeriUnit.val(modal.option.timeCycleUnit);}
else{_this.$selPeriUnit.val('hour');}}
else{_this.$selectMode.val('realTime');_this.$tmGroup.css('display','none');}
_this.$selectMode.change(function(e){var flag=$(e.currentTarget).val();if('history'==flag){_this.$tmGroup.css('display','block');_this.m_bIsRealTime=false;_this.$divRealtmCycle.css('display','none');}
else{_this.m_bIsRealTime=true;_this.$tmGroup.css('display','none');_this.$divRealtmCycle.css('display','block');}});_this.$selectHisCycleMode.change(function(e){var $opt=_this.$selectHisInterval.children('option');var flag=$(e.currentTarget).val();if('fixed'==flag){_this.m_bIsHisFixCycle=true;$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$divHisTmRange.css('display','block');_this.$divHisTmCycle.css('display','none');}
else{_this.m_bIsHisFixCycle=false;_this.$selPeriUnit.change();_this.$divHisTmRange.css('display','none');_this.$divHisTmCycle.css('display','block');}});_this.$selPeriUnit.change(function(e){var $opt=_this.$selectHisInterval.children('option');$opt.eq(0).css('display','none');var flag=$(e.currentTarget).val();switch(flag){case'hour':$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','none');$opt.eq(4).css('display','none');_this.$selectHisInterval.val('m5');break;case'day':$opt.eq(1).css('display','none');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','none');_this.$selectHisInterval.val('h1');break;case'month':$opt.eq(1).css('display','none');$opt.eq(2).css('display','none');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$selectHisInterval.val('d1');break;default:break;}});if(!_this.m_bIsHisFixCycle){_this.$selPeriUnit.change();}
$(".form_datetime").datetimepicker('remove');$(".form_datetime").datetime();_this.attachEvents();I18n.fillArea($('#modalCustom'));};ModalChartCustomConfig.prototype.recoverForm=function(modal){if(Boolean(modal.modalText)){this.$editor.html(modal.modalText);}};ModalChartCustomConfig.prototype.reset=function(){};ModalChartCustomConfig.prototype.attachEvents=function(){var _this=this;_this.$btnSubmit.off().click(function(e){var modal=_this.options.modalIns.entity.modal;var customOption=$('#modalCustom').find('#editor');modal.modalText=customOption.html();modal.modalTextUrl=customOption.text();modal.option=new Object();modal.option.list=[];modal.points=[];var arraySpan=customOption.find('.pointValue');for(var i=0,len=arraySpan.length;i<len;i++){modal.option.list.push({dsItemId:arraySpan[i].id,name:arraySpan[i].title,data:0});modal.points.push(arraySpan[i].id);}
modal.interval=_this.m_bIsRealTime?_this.$selRealInterval.val():_this.$selectHisInterval.val();modal.option.isRealTime=_this.m_bIsRealTime;modal.option.isHisFixCycle=_this.m_bIsHisFixCycle;if(_this.m_bIsHisFixCycle){modal.option.timeStart=_this.$tmStart.val();modal.option.timeEnd=_this.$tmEnd.val();}
else{var tmStart=new Date();var tmEnd=new Date();var periodVal=parseInt(_this.$inputPeriodVal.val());var periodUnit=_this.$selPeriUnit.val();switch(periodUnit){case'hour':var time=tmEnd.getTime()-3600000*periodVal;tmStart.setTime(time);break;case'day':var time=tmEnd.getTime()-86400000*periodVal;tmStart.setTime(time);break;case'month':var month=tmEnd.getMonth();if(0==month){tmStart.setFullYear(tmEnd.getFullYear()-1);tmStart.setMonth(11);}
else{tmStart.setMonth(month-1);}
break;default:break;}
modal.option.timeStart=tmStart.format('yyyy-MM-dd HH:mm:ss');modal.option.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:ss');modal.option.timeCycleValue=_this.$inputPeriodVal.val();modal.option.timeCycleUnit=_this.$selPeriUnit.val();}
_this.$modal.modal('hide');e.preventDefault();});};return ModalChartCustomConfig;}(jQuery,window));var ModalChartCustom=(function(){function ModalChartCustom(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalChartCustom.prototype=new ModalBase();ModalChartCustom.prototype.optionTemplate={name:'toolBox.modal.CUSTOM_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalChartCustom',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalChartCustom.prototype.show=function(){this.init();}
ModalChartCustom.prototype.init=function(){}
ModalChartCustom.prototype.renderModal=function(e){var _this=this;var optList=_this.modal.option.list;if(!optList){_this.spinner.stop();return;}
var len=optList.length;if(len>0){if(_this.modal.option.isRealTime){var postData={'dataSourceId':0,'dsItemIds':_this.modal.points};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(res){var data=res.dsItemList;if(!data){return;}
if(data.length>0){for(var i=0,len=data.length;i<len;i++){for(var j=0,len2=optList.length;j<len2;j++){if(optList[j].dsItemId==data[i].dsItemId){optList[j].data=parseFloat(parseFloat(data[i].data).toFixed(2));break;}}}
_this.updateModal(data);}}).always(function(e){_this.spinner.stop();});}
else{WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:_this.modal.points,timeStart:new Date(_this.modal.option.timeStart).format('yyyy-MM-dd HH:mm:00'),timeEnd:new Date(_this.modal.option.timeEnd).format('yyyy-MM-dd HH:mm:00'),timeFormat:'m5'}).done(function(dataSrc){if(!dataSrc||dataSrc.timeShaft.length<=0){return;}
_this.updateHistoryChart(dataSrc.list,dataSrc.timeShaft);}).error(function(e){}).always(function(e){_this.spinner.stop();});}}
else{try{var showOption=eval('({'+_this.modal.modalTextUrl+'})');_this.drawChart(showOption);_this.spinner.stop();}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.updateModal=function(src){if(this.modal.option.isRealTime){this.updateRealTimeChart(src);}}
ModalChartCustom.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();}
ModalChartCustom.prototype._showConfig=function(){}
ModalChartCustom.prototype.setModalOption=function(option){}
ModalChartCustom.prototype.drawChart=function(chartOption){this.chart.setOption(chartOption);}
ModalChartCustom.prototype.close=function(){}
ModalChartCustom.prototype.updateRealTimeChart=function(src){var _this=this;if(!src){return;}
if(src.length>0){var optList=_this.modal.option.list;for(var m=0,lenM=optList.length;m<lenM;m++){for(var n=0,lenN=src.length;n<lenN;n++){if(optList[m].dsItemId==src[n].dsItemId){optList[m].data=src[n].data;break;}}}
var showOption=_this.modal.modalTextUrl;var arr=showOption.split('<%');for(var j=1,len2=arr.length;j<len2;j++){var name=arr[j].split('%>')[0];if(''==name){continue;}
var data=-1;for(var k=0,len3=optList.length;k<len3;k++){if(optList[k].name==name){data=optList[k].data;break;}}
if(-1!=data&&Boolean(data)){if('object'==typeof(data)){var temp;for(var p=0,lenP=data.length;p<lenP;p++){temp+=data[p]+',';}
showOption=showOption.replace(name,temp);}
else{showOption=showOption.replace(name,data);}}}
showOption=showOption.replace(/"<%/g,'');showOption=showOption.replace(/%>"/g,'');try{showOption=eval('({'+showOption+'})');_this.drawChart(showOption);}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.updateHistoryChart=function(list,timeShaft){var _this=this;if(!list){return;}
if(list.length>0){var infoList=[];var arrId=[];for(var i=0,len=list.length;i<len;i++){arrId.push(list[i].dsItemId);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=list.length;i<len;i++){var id=list[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var itemName=arrItem[m].alias;var item={id:id,name:itemName,data:list[i].data};infoList.push(item);break;}}}
var showOption=_this.modal.modalTextUrl;var arr=showOption.split('<%');for(var j=1,len2=arr.length;j<len2;j++){var name=arr[j].split('%>')[0];if(''==name){continue;}
var data;for(var k=0,len3=infoList.length;k<len3;k++){if(infoList[k].name==name){data=infoList[k].data;break;}}
if(Boolean(data)){if('object'==typeof(data)){var temp='';for(var p=0,lenP=data.length-1;p<lenP;p++){temp+=data[p]+',';}
temp+=data[lenP-1];showOption=showOption.replace(name,temp);}
else{showOption=showOption.replace(name,data);}}}
showOption=showOption.replace(/"<%/g,'');showOption=showOption.replace(/%>"/g,'');try{showOption=eval('({'+showOption+'})');if(!showOption.xAxis||0==showOption.xAxis.length){var arrAxis=[{type:'category',boundaryGap:false,data:timeShaft}];showOption.xAxis=arrAxis;}
else if(!showOption.xAxis[0].data||0==showOption.xAxis[0].data.length){showOption.xAxis[0].data=timeShaft;}
_this.drawChart(showOption);}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.configModal=new ModalChartCustomConfig();return ModalChartCustom;})();var ModalPointKPI=(function(){function ModalPointKPI(screen,entityParams){if(!entityParams)return;this.isConfigMode=false;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalPointKPI.prototype=new ModalBase();ModalPointKPI.prototype.optionTemplate={name:'toolBox.modal.POINT_KPI',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalPointKPI'};ModalPointKPI.prototype.show=function(){this.init();}
ModalPointKPI.prototype.init=function(){this.pointKPIWiki=undefined;}
ModalPointKPI.prototype.renderModal=function(e){var _this=this,tempHtml='',level=1,rootId;this.spinner&&this.spinner.stop();if(!(this.entity.modal.option&&this.entity.modal.option.kpiList))return
this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});$(this.container).append(tempHtml);function traverseTree(tree){new PointKPIItem(tree,_this,0);rootId=tree.id;traverse(tree,0);}
function traverse(node,i){var children=node.list;node.pointPassData=[];node.show=true;if(children!=null&&children.length>0){if(node.parentId==rootId){level=2;}
new PointKPIItem(children[i],_this,level);if(i==children.length-1){for(var j=0;j<children.length;j++){j==0&&level++;traverse(children[j],0);}}else{traverse(node,i+1);}}}}
ModalPointKPI.prototype.showConfigMode=function(){}
ModalPointKPI.prototype.updateModal=function(points){}
ModalPointKPI.prototype.configure=function(){var _this=this;this.spinner&&this.spinner.stop();this.isConfigMode=true;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};var $btnRemove=$('<span class="glyphicon glyphicon-remove-circle springConfigRemoveBtn"></span>');var $btnAdd=$('<span class="glyphicon glyphicon-remove-circle springConfigRemoveBtn addTree" style="transform: rotateZ(45deg);color: #333;right: 50px !important;"></span>');divMask.appendChild($btnAdd[0]);divMask.appendChild($btnRemove[0]);this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer&&(divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');if(sourceId==targetId)return;$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();if(!$sourceParent[0].classList.contains('chartsCt')&&$targetParent[0].classList.contains('chartsCt')){_this.screen.insertChartIntoMix(sourceId,$(e.target).closest('.chartsCt')[0])}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}
_this.screen.isScreenChange=true;})
var $select='<div class="form-group" style="position: absolute;top: 5px;left: 5px;">\
            <label for="inputEmail3" class="col-sm-2 control-label" style="height: 34px;line-height: 34px;">Cycle</label>\
            <div class="col-sm-8" style="display:inline-block;">\
                <select id="selectCycle" class="form-control" style="width: 100px;padding: 0;"> \
                    <option value="month">'+I18n.resource.dashboard.modalPointKPI.MONTH+'</option> \
                    <option value="season">'+I18n.resource.dashboard.modalPointKPI.QUARTER+'</option> \
                    </select>\
            </div>\
            </div>';$(this.container).append($select);var $selectCycle=$(this.container).find('#selectCycle');if(_this.entity.modal.option&&_this.entity.modal.option.dateCycle&&_this.entity.modal.option.dateCycle=='season'){$selectCycle.find('option:nth-of-type(2)')[0].selected='selected';}else{$selectCycle.find('option:nth-of-type(1)')[0].selected='selected';}
$selectCycle[0].onchange=function(){_this.entity.modal.option.dateCycle=$selectCycle[0].value;}
var $chartCt=$('<div class="divResize chartsCt gray-scrollbar" style="overflow:auto;">');$chartCt.append($(this.container));divMask.appendChild($chartCt[0]);if($('.level_2').width()>($chartCt.width()-320)){$('.domTree',$chartCt).width($('.level_2').width()+40);}
if($(this.container).find('.domTree').length==1){$btnAdd.attr('title','Already exists a root').addClass('btnDisabled');}
this.executeConfigMode();$btnRemove.off('click').on('click',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this=null;});$btnAdd.off('click').on('click',function(){if($(_this.container).find('.domTree').length==0){new PointKPIItem({parentId:''},_this,0);$('#divContainer_'+_this.entity.id).find('.addTree').attr('title','Already exists a root').addClass('btnDisabled');_this.screen.isScreenChange=true;}});}
ModalPointKPI.prototype.initContainer=function(replacedElementId){var _this=this;var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass=' gray-scrollbar';if((!divParent)||replacedElementId){isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}
else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
divParent.className='springContainer';if(AppConfig.isMobile){divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR*2+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*2+'%';}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.title&&this.entity.modal.title!=''&&(!this.entity.isNotRender)){divParent.innerHTML='<div class="panel panel-default">\
                <div class="panel-heading springHead">\
                    <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                </div>\
                <div class="panel-body springContent'+scrollClass+'" style="overflow:auto;"></div>\
            </div>';}else{divParent.innerHTML='<div class="panel panel-default" style="background: none;">\
                <div class="panel-body springContent'+scrollClass+'" style="height:100%;overflow:auto;"></div>\
            </div>';}
if(AppConfig.isMobile||(this.screen.options&&this.screen.options.isForMobile)||(this.screen.screen&&this.screen.screen.options&&this.screen.screen.options.isForMobile)){divParent.children[0].classList.add('transparent');}
var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];var lkHistory=document.createElement('a');lkHistory.className='springLinkBtn';lkHistory.title='Show History';lkHistory.href='javascript:;';lkHistory.innerHTML='<span class="glyphicon glyphicon-stats"></span>';divBtnCtn.appendChild(lkHistory);lkHistory.onclick=function(){var dataTree=_this.entity.modal.option.kpiList[0];var dateCycle=!_this.entity.modal.option.dateCycle?'month':_this.entity.modal.option.dateCycle;if(Boolean(dataTree)){new ModalPointKpiGrid(dataTree,dateCycle).show();}};domPanel.appendChild(divBtnCtn);this.initToolTips(divParent.getElementsByClassName('springHead'));this.container=divParent.getElementsByClassName('springContent')[0];}
ModalPointKPI.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
return ModalPointKPI;})();var PointKPIItem=(function(){function PointKPIItem(item,entity,i){this.parentArgt=entity;this.entity=entity.entity;this.container=entity.container;this.kpiItem={id:!item.id?new Date().getTime():item.id,parentId:!item.parentId?'':item.parentId,name:!item.name?'Unaming':item.name,pointKPI:!item.pointKPI?'':item.pointKPI,pointGrade:!item.pointGrade?'':item.pointGrade,pointPass:!item.pointPass?'':item.pointPass,rule:!item.rule?'':item.rule,weight:!item.weight?'':item.weight,wikiId:!item.wikiId?'':item.wikiId,list:!item.list?[]:item.list};if(i===0&&!item.id&&item.parentId==''){!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.kpiList&&(this.entity.modal.option.kpiList=[]);this.entity.modal.option.kpiList.push(this.kpiItem);}
this.addItemDom(this.kpiItem,i)
this.attachEventsItem(this.kpiItem);}
PointKPIItem.prototype.addItem=function(id){var _this=this;var level=1;var pointKPIItem;this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(id==node.id){pointKPIItem=new PointKPIItem({parentId:id},_this.parentArgt,level);node.list.push(pointKPIItem.kpiItem);return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){j==0&&level++;traverse(children[j],0);}}else{traverse(node,i+1);}}}}
var btn_tpl='\
            <div class="btnGroup">\
                <span class="glyphicon glyphicon-remove-circle btnAddItem" style="transform: rotateZ(45deg);"></span>\
                <span class="glyphicon glyphicon-cog btnConfigItem"></span>\
                <span class="glyphicon glyphicon-info-sign btnConfigWiki"></span>\
                <span class="glyphicon glyphicon-remove-circle btnRemoveItem"></span>\
                <span class="glyphicon glyphicon-info-sign btnViewWiki{isShow}" wikiId="{wikiId}"></span>\
            </div>';PointKPIItem.prototype.tpl={treeWrap:'<div class="domTree"></div>',level_1_Tpl:'\
            <div class="totalLevel">\
                <div class="itemWrap" id="kpi_{id}">\
                    <div class="hrLine"></div>\
                    <span class="pointName">{name}</span>\
                    <span class="glyphicon glyphicon-pencil"></span>\
                    <div class="circle {bgColor}">\
                        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                        <span>{pointPassVal}</span>\
                    </div>'+btn_tpl+'</div>\
            </div>',level_2_Ctn:'\
            <div class="level_2">\
                <div class="hrLine1"></div>\
                <ul></ul>\
            </div>',level_2_Tpl:'<li class="level_3" parentId="{parentId}" id="item_{id}">\
            	<div class="thirdCon1">\
                	<div class="itemWrap" id="kpi_{id}">\
                	    <div class="circle {bgColor}">\
                	        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                	        <span>{pointPassVal}</span>\
                	    </div>\
                	    <span class="pointName">{name}</span><span class="glyphicon glyphicon-pencil"></span><br class="clear"><div class="hrLine2"></div>'+btn_tpl+'</div>\
                </div>\
                <ul class="childLevel">\
                </ul>\
            </li>',level_3_Tpl:'<li parentId="{parentId}" id="item_{id}">\
                <div class="hrLine3"></div>\
                <div class="itemWrap" id="kpi_{id}">\
                    <div class="smCircle {bgColor}">\
                        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                        <span>{pointPassVal}</span>\
                    </div>\
                    <span class="pointName">{name}</span>\
                    <span class="glyphicon glyphicon-pencil"></span><br class="clear">\
                    <div class="hrLine4"></div>'+btn_tpl+'</div>\
                <ul class="childLevel">\
                </ul>\
            </li>'}
PointKPIItem.prototype.addItemDom=function(kpiItem,i){var kpiItemForEl={id:kpiItem.id,parentId:kpiItem.parentId,name:kpiItem.name,isShow:kpiItem.wikiId!=''?' showWiki':'',pointPassVal:kpiItem.pointPass!=''?I18n.resource.dashboard.modalPointKPI.UNPASS:I18n.resource.dashboard.modalPointKPI.PASS,bgColor:kpiItem.pointPass!=''?'unpass':'pass'}
var $domTree=$(this.container).children('.domTree'),$level_2_ul,$level_3_ul;$domTree&&($level_2_ul=$domTree.find('.level_2>ul'));$level_2_ul&&($level_3_ul=$level_2_ul.find('#item_'+kpiItem.parentId+' > .childLevel'));if(kpiItem.parentId==''){$(this.container).append(this.tpl.treeWrap);$domTree=$(this.container).children('.domTree');$domTree.html(this.tpl.level_1_Tpl.formatEL(kpiItemForEl));}else if(i==1&&$domTree){if($level_2_ul.length==0){$domTree.append(this.tpl.level_2_Ctn);$level_2_ul=$domTree.find('.level_2>ul');}
if($domTree.parent().width()-$level_2_ul.width()<270){$domTree.width($domTree.width()+255);}
$level_2_ul.append(this.tpl.level_2_Tpl.formatEL(kpiItemForEl))}else if($level_2_ul){$level_3_ul.append(this.tpl.level_3_Tpl.formatEL(kpiItemForEl));if($level_3_ul.find('.itemWrap').width()<140){$level_3_ul.find('.btnAddItem').hide();}}}
PointKPIItem.prototype.removeItem=function(id){var _this=this;this.entity.modal.option.kpiList.forEach(function(kpiItem,index){if(kpiItem.id==id&&kpiItem.parentId==''){_this.entity.modal.option.kpiList.splice(index,1);$('#kpi_'+id).closest('.domTree').remove();$('#divContainer_'+_this.entity.id).find('.addTree').removeClass('btnDisabled').attr('title','');}else{traverseTree(kpiItem);}});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(children!=null&&children.length>0){if(id==children[i].id){node.list.splice(i,1);$('#kpi_'+id).closest('li').remove();return;}else{if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}}
PointKPIItem.prototype.showConfigModal=function(){var _this=this,$modalConfig=$('#modalConfig');var tempHtml='\
            <div class="modal-body" id="pointKPI">\
                <div class="form-horizontal">\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divKPI">KPI</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divKPI">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divGrade">Grade</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divGrade">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divIsPass">Is pass</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divIsPass">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divDashboard">Config dashboard</label>\
                        <div class="col-md-4">\
                            <button type="button" id="btnDashboard" class="btn btn-default">Config</button>\
                        </div>\
                    </div>\
                </div>\
            </div>';$modalConfig.off('show.bs.modal').on('show.bs.modal',function(e){var pointKPIAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointKPI).alias;var pointGradeAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointGrade).alias;var pointPassAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointPass).alias;$modalConfig.find('.modal-body').hide();$modalConfig.find('.modal-footer').before(tempHtml);$modalConfig.find('#divKPI').attr('data-value',_this.kpiItem.pointKPI).attr('title',pointKPIAlias).html(pointKPIAlias);$modalConfig.find('#divGrade').attr('data-value',_this.kpiItem.pointGrade).attr('title',pointKPIAlias).html(pointGradeAlias);$modalConfig.find('#divIsPass').attr('data-value',_this.kpiItem.pointPass).attr('title',pointKPIAlias).html(pointPassAlias);if(pointPassAlias){$modalConfig.find('#startConfig').removeClass('disabled');}
_this.parentArgt.screen.modalConfigPane.toggleDataSource(true);_this.attachEventsConfig($modalConfig)});$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$modalConfig.find('#pointKPI').remove();_this.parentArgt.screen.modalConfigPane.toggleDataSource(false);});$modalConfig.modal('show');}
PointKPIItem.prototype.viewDetail=function(){var $dialog=$('#dialogModal');var energyScreen=new EnergyScreen();var $dialogContent=$dialog.find('#dialogContent').css({height:'90%',width:'90%',margin:'auto',marginTop:'2.5%',backgroundColor:'#fff'});$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$dialogContent.removeAttr('style').html('');energyScreen.workerUpdate&&energyScreen.workerUpdate.terminate();}).modal({});energyScreen.id=this.kpiItem.id+'_'+AppConfig.userId;energyScreen.container=$dialogContent[0];energyScreen.isForBencMark=true;energyScreen.init();}
PointKPIItem.prototype.attachEventsItem=function(kpiItem){var $kpiWrap=$('#kpi_'+kpiItem.id),_this=this;$('.btnAddItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.addItem(_this.kpiItem.id);_this.parentArgt.screen.isScreenChange=true;});$('.btnRemoveItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.removeItem(_this.kpiItem.id);var $domTree=$('.domTree');if($(this).closest('.thirdCon1').length==1&&$domTree.width()-$('.level_2').width()>260){$domTree.width($domTree.width()-255);}
_this.parentArgt.screen.isScreenChange=true;});$('.btnConfigItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.showConfigModal();});$('.btnConfigWiki',$kpiWrap).off().on('click',function(e){e.stopPropagation();if(_this.kpiItem.wikiId){_this.showWikiEditModal();}else{_this.showWikiSearchModal();}});$('.btnViewWiki',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.viewWikiInfoModal();});$('.glyphicon-pencil',$kpiWrap).off().on('click',function(e){e.stopPropagation();if(_this.parentArgt.isConfigMode==true){_this.editPointKPIName();}});$kpiWrap.off().on('click',function(e){e.stopPropagation();if(_this.parentArgt.isConfigMode==false){_this.viewDetail(_this.kpiItem.id);}});}
PointKPIItem.prototype.attachEventsConfig=function($modalConfig){var _this=this;var $dropArea=$modalConfig.find('.drop-area');var $btnConfig=$modalConfig.find('#startConfig');var $btnDashboard=$modalConfig.find('#btnDashboard');$dropArea.off('dragover').on('dragover',function(e){e.preventDefault();});$dropArea.off('dragenter').on('dragenter',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});$dropArea.off('dragleave').on('dragleave',function(e){$(e.target).removeClass('on');e.stopPropagation();});$dropArea.off('drop').on('drop',function(e){var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');name=AppConfig.datasource.getDSItemById(itemId).alias;$target.attr({'data-value':itemId,'title':name});$target.html('<span>'+name+'</span>');e.stopPropagation();if($target.attr('id')=='divIsPass'){$btnConfig.removeClass('disabled');}
_this.parentArgt.screen.isScreenChange=true;});$btnConfig.off().on('click',function(){var KPI=$('#divKPI').attr('data-value');var grade=$('#divGrade').attr('data-value');var pass=$('#divIsPass').attr('data-value');_this.kpiItem.pointKPI=!KPI?'':KPI;_this.kpiItem.pointGrade=!grade?'':grade;_this.kpiItem.pointPass=!pass?'':pass;_this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.kpiItem.id){node.pointKPI=_this.kpiItem.pointKPI;node.pointGrade=_this.kpiItem.pointGrade;node.pointPass=_this.kpiItem.pointPass;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}
$('#modalConfig').modal('hide');});$btnDashboard.off('click').on('click',function(){ScreenManager.show(EnergyScreen,_this.kpiItem.id+'_'+AppConfig.userId);});}
PointKPIItem.prototype.showWikiSearchModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.showWikiSearch();}
PointKPIItem.prototype.showWikiEditModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.getWikiById();}
PointKPIItem.prototype.viewWikiInfoModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.viewWikiInfo(this.kpiItem.wikiId);}
PointKPIItem.prototype.editPointKPIName=function(){var _this=this,$divKPI=$('#kpi_'+this.kpiItem.id),$input=$divKPI.find('.pointNameInput'),$springConfigMask;if($input.length==0){var $input=$('<input type="text" class="form-control pointNameInput"/>').val(_this.kpiItem.name);var $spanName=$('.pointName','#kpi_'+this.kpiItem.id).hide().after($input);$springConfigMask=$divKPI.closest('.springConfigMask[draggable="true"]').attr('draggable',false);$input.blur(function(){savePointName(this);}).keyup(function(e){if(e.keyCode==13){savePointName(this);}});}else{savePointName($input[0]);}
function savePointName(divInput){_this.kpiItem.name=$(divInput).val();$(divInput).remove();$spanName.html(_this.kpiItem.name).show();$springConfigMask.attr('draggable',true);_this.parentArgt.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});_this.parentArgt.screen.isScreenChange=true;function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.kpiItem.id){node.name=_this.kpiItem.name;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}}
return PointKPIItem;})();var ModalPointKpiGrid=(function(){var _this;function ModalPointKpiGrid(data,dateCycle){if(Boolean(data)){this.m_kpiDataTree=data;this.m_dateCycle=dateCycle;this.m_selectYear=0;this.m_htmlPage;this.m_htmlTreeTemp;this.m_htmlGridTemp;this.m_bIsCurrentYear=false;this.m_nCurrentSeason=0;this.m_nCurrentMonth=0;this.m_strGood='达标';this.m_strBad='未达标';this.m_strCurrentGood='当前达标';this.m_strCurrentBad='当前超标';this.m_strCurrentWarn='警戒';this.m_nStartYear=0;this.m_nEndYear=0;_this=this;}}
ModalPointKpiGrid.prototype=new ModalPointKpiGrid();ModalPointKpiGrid.prototype.show=function(){this.init();}
ModalPointKpiGrid.prototype.init=function(){WebAPI.get('/static/views/observer/widgets/modalPointKpiGrid.html').done(function(resultHtml){_this.m_htmlPage=$(resultHtml);var timeControl=_this.m_htmlPage.find('#timeSelect');var tmNow=new Date();var tmStart=new Date();tmStart.setFullYear(tmNow.getFullYear()-10);_this.m_nStartYear=tmStart.getFullYear();_this.m_nEndYear=tmNow.getFullYear();timeControl.val(tmNow.format('yyyy'));timeControl.datetimepicker({format:'yyyy',startView:'decade',minView:'decade',autoclose:true,todayBtn:false,pickerPosition:'bottom-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){_this.m_selectYear=timeControl.val();var tmNow=new Date();var nCurYear=tmNow.getFullYear();if(nCurYear==_this.m_selectYear){_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;}
else{_this.m_bIsCurrentYear=false;}
_this.postDataShow(false);});var yearPre=_this.m_htmlPage.find('#btnYearPre');if(Boolean(yearPre)){yearPre.click(function(e){var year=parseInt(timeControl.val());if(year<=_this.m_nStartYear){year=_this.m_nStartYear;return;}
else{year-=1;}
timeControl.val(year);_this.timeSetting(timeControl.val());_this.postDataShow(false);});}
var yearNext=_this.m_htmlPage.find('#btnYearNext');if(Boolean(yearNext)){yearNext.click(function(e){var year=parseInt(timeControl.val());if(year>=_this.m_nEndYear){year=_this.m_nEndYear;return;}
else{year+=1;}
timeControl.val(year);_this.timeSetting(timeControl.val());_this.postDataShow(false);});}
var tmNow=new Date();_this.m_selectYear=tmNow.getFullYear();_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;_this.postDataShow(true);}).always(function(){});}
ModalPointKpiGrid.prototype.postDataShow=function(bIsFirst){var ptPassArray=[];ptPassArray=_this.recursiveTreeGetPointPassId(_this.m_kpiDataTree);var tmStart=new Date();tmStart.setMonth(0);tmStart.setDate(1);tmStart.setHours(0);tmStart.setMinutes(0);tmStart.setSeconds(0);var tmEnd=new Date();if(!bIsFirst&&tmStart.getFullYear()!=_this.m_selectYear){tmStart.setFullYear(_this.m_selectYear);tmEnd.setFullYear(_this.m_selectYear);tmEnd.setMonth(11);tmEnd.setDate(31);tmEnd.setHours(23);tmEnd.setMinutes(59);tmEnd.setSeconds(59);}
var postData={};postData.dataSourceId='';postData.dsItemIds=ptPassArray;postData.timeStart=tmStart.format('yyyy-MM-dd hh:mm:ss');postData.timeEnd=tmEnd.format('yyyy-MM-dd hh:mm:ss');postData.timeFormat='M1';if(bIsFirst){Spinner.spin($('#paneCenter')[0]);}
else{Spinner.spin(_this.m_htmlPage[2]);}
var tree=_this.m_htmlPage.find('#treeCtl');tree.html('');var table=_this.m_htmlPage.find('#tableCtl');table.html('');WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(res){if(!res||!res.list){return;}
for(var i=0,len=res.list.length;i<len;i++){_this.recursiveTreeSetPointPassData(_this.m_kpiDataTree,res.list[i].dsItemId,res.list[i].data);}
var divContain=$('<div style="cursor:pointer"></div>');divContain.append('<ul class="kpiGridHeader" style="height:32px;margin-bottom:0px"></ul>');tree.append(divContain);var head=$('<thead class="kpiGridHeader"></thead>');var headTr=$('<tr></tr>');if('season'==_this.m_dateCycle){for(var i=0;i<4;i++){var headTh=$('<th colspan="3" class="colSeason">'+(i+1)+'季度</th>');headTr.append(headTh);}
head.append(headTr);}
else if('month'==_this.m_dateCycle){headTr=$('<tr></tr>');for(var i=0;i<12;i++){var headTh=$('<th class="colMonth">'+(i+1)+'月</th>');headTr.append(headTh);}
head.append(headTr);}
table.append(head);_this.showControlInfo();if(bIsFirst){_this.m_htmlPage.modal('show');}}).always(function(){Spinner.stop();});}
ModalPointKpiGrid.prototype.showControlInfo=function(){_this.m_htmlTreeTemp=$('<div style="cursor:pointer"></div>');_this.m_htmlGridTemp=$('<tbody class="kpiGridBody"></tbody>');_this.recursiveTreeSetting(_this.m_kpiDataTree);_this.m_htmlPage.find('#treeCtl').append(_this.m_htmlTreeTemp);_this.m_htmlPage.find('#tableCtl').append(_this.m_htmlGridTemp);}
ModalPointKpiGrid.prototype.recursiveTreeSetting=function(item){var parentNode;if(''==item.parentId){parentNode=_this.m_htmlTreeTemp;}
else{parentNode=_this.m_htmlTreeTemp.find('#tree_'+item.parentId).find('.rows').eq(0);}
if(parentNode.length>0){var bLeaf=(0==item.list.length)?true:false;_this.insertTreeCtrl(item.id,item.name,parentNode,bLeaf);}
var nLen=item.pointPassData.length;if(nLen<12){for(var i=nLen,len=12-nLen;i<12;i++){item.pointPassData.push(-1);}}
nLen=12;var gridTr1=$('<tr class="kpiGridRow" id="grid1_'+item.id+'"></tr>');var gridTd1='';var nLen=item.pointPassData.length;var bIsCurrent=false;var strShow;if('season'==_this.m_dateCycle){var arrSeason=[item.pointPassData[0],item.pointPassData[3],item.pointPassData[6],item.pointPassData[9]];for(var i=0;i<4;i++){if(_this.m_bIsCurrentYear&&i==_this.m_nCurrentSeason){bIsCurrent=true;}
else{bIsCurrent=false;}
if(-1==arrSeason[i]){gridTd1+='<td colspan=3></td>';}
else if(Boolean(arrSeason[i])){strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=3 class="kpiGridGood">'+strShow+'</td>';}
else{strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=3 class="kpiGridBad">'+strShow+'</td>';}}}
else if('month'==_this.m_dateCycle){for(var i=0;i<nLen;i++){if(_this.m_bIsCurrentYear&&i==_this.m_nCurrentMonth){bIsCurrent=true;}
else{bIsCurrent=false;}
if(-1==item.pointPassData[i]){gridTd1+='<td colspan=1></td>';}
else if(Boolean(item.pointPassData[i])){strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=1 class="kpiGridGood">'+strShow+'</td>';}
else{strShow=bIsCurrent?_this.m_strCurrentBad:_this.m_strBad;gridTd1+='<td colspan=1 class="kpiGridBad">'+strShow+'</td>';}}}
gridTr1.append($(gridTd1));_this.m_htmlGridTemp.append(gridTr1);var nChildNum=item.list.length;if(0==nChildNum){}
else{for(var i=0;i<nChildNum;i++){arguments.callee(item.list[i]);}}}
ModalPointKpiGrid.prototype.recursiveTreeSetShow=function(item,nFindId,bIsShow){if(nFindId==item.id){for(var i=0,len=item.list.length;i<len;i++){item.list[i].show=bIsShow;}
return;}
else{for(var i=0,len=item.list.length;i<len;i++){arguments.callee(item.list[i],nFindId,bIsShow);}}}
ModalPointKpiGrid.prototype.recursiveTreeGetShow=function(item){var arr=[];var nLen=item.list.length;if(nLen>0){if(item.show){arr.push(item.id);for(var i=0;i<nLen;i++){var temp=arguments.callee(item.list[i]);arr=arr.concat(temp);}}}
else{if(item.show){return[item.id];}}
return arr;}
ModalPointKpiGrid.prototype.recursiveTreeGetPointPassId=function(item){var arr=[];var nLen=item.list.length;if(nLen>0){if(item.show){arr.push(item.pointPass);for(var i=0;i<nLen;i++){var temp=arguments.callee(item.list[i]);arr=arr.concat(temp);}}}
else{if(item.show){return[item.pointPass];}}
return arr;}
ModalPointKpiGrid.prototype.recursiveTreeSetPointPassData=function(item,nPtPassId,ptPassData){if(nPtPassId==item.pointPass){item.pointPassData=ptPassData;return;}
else{for(var i=0,len=item.list.length;i<len;i++){arguments.callee(item.list[i],nPtPassId,ptPassData);}}}
ModalPointKpiGrid.prototype.insertTreeCtrl=function(groupId,groupName,parentNode,bIsLeaf){var $ul=$('<ul class="nav nav-list kpiTreeGroup" id="tree_'+groupId+'">');var $liHd;if(bIsLeaf){$liHd=$('<li class="kpiTreeHeader"><span style="margin-left:40px"></span></li>');}
else{$liHd=$('<li class="kpiTreeHeader"><img src="/static/images/dataSource/group_head_sel.png" alt="png" class="dsTreeHeaderIcon"></li>');}
var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);$liHd.click(function(e){var tar=$(e.currentTarget);if(Boolean(tar)){var treeItemId=tar.closest('.kpiTreeGroup')[0].id;var num=treeItemId.substring(5);var bindRow=tar.next('.rows');if(Boolean(bindRow)){var bIsShow=true;var showFlag=bindRow.eq(0).css('display');if('block'==showFlag){bIsShow=false;}
else{bIsShow=true;}
_this.recursiveTreeSetShow(_this.m_kpiDataTree,num,bIsShow);var arr=_this.recursiveTreeGetShow(_this.m_kpiDataTree);var arrGrid=[];for(var k=0,len3=arr.length;k<len3;k++){arrGrid.push('grid1_'+arr[k]);arrGrid.push('grid2_'+arr[k]);}
var body=_this.m_htmlPage.find('#tableCtl tbody tr');for(var i=0,len=body.length;i<len;i++){var trFind=false;for(var j=0,len2=arrGrid.length;j<len2;j++){if(body[i].id==arrGrid[j]){trFind=true;break;}}
if(!trFind){$(body[i]).css('display','none');}
else{$(body[i]).css('display','');}}
bindRow.slideToggle();}}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow);parentNode.append($ul);}
ModalPointKpiGrid.prototype.timeSetting=function(selYear){_this.m_selectYear=selYear;var tmNow=new Date();var nCurYear=tmNow.getFullYear();if(nCurYear==_this.m_selectYear){_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;}
else{_this.m_bIsCurrentYear=false;}}
return ModalPointKpiGrid;})();var ModalReportChapter=(function(){function ModalReportChapter(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalReportChapter.prototype=new ModalBase();ModalReportChapter.prototype.optionTemplate={name:'toolBox.modal.REPORT_CHAPTER',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalReportChapter',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalReportChapter.prototype.show=function(){this.init();}
ModalReportChapter.prototype.init=function(){}
ModalReportChapter.prototype.renderModal=function(e){var _this=this;var postData={projectId:AppConfig.projectId,menuId:this.entity.modal.option.menuId,chapter:this.entity.modal.option.chapter,unit:this.entity.modal.option.unit};WebAPI.post('/report/getReportHtml/',postData).done(function(result){if(result.success){_this.spinner&&_this.spinner.stop();_this.container.innerHTML=result.data;_this.reportScreen=new ReportScreen();_this.reportScreen.renderCharts($('#beopReport .report-unit'))}else{alert(result.msg);}}).always(function(){_this.spinner&&_this.spinner.stop();});}
ModalReportChapter.prototype.showConfigMode=function(){}
ModalReportChapter.prototype.updateModal=function(points){}
ModalReportChapter.prototype.setModalOption=function(option){}
ModalReportChapter.prototype.modalDialog='\
        <div class="modal-content">\
            <div class="modal-header">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>\
                <h4 class="modal-title" id="">Config</h4>\
            </div>\
            <div class="modal-body">\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Type</label>\
                    </div>\
                    <div class="col-xs-4">\
                        <select id="typeList" class="form-control type"></select>\
                    </div>\
                </div>\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Chapter</label>\
                    </div>\
                    <div class="col-xs-4" id="chapterList">\
                    </div>\
                </div>\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Section</label>\
                    </div>\
                    <div class="col-xs-4" id="unitList">\
                    </div>\
                </div>\
            </div>\
            <div class="modal-footer">\
                <div id="configAlert"></div>\
                <button type="button" class="btn btn-primary" id="confirm">Confirm</button>\
            </div>\
        </div>';ModalReportChapter.prototype.showConfigModal=function(){var _this=this;var $dialogModal=$('#dialogModal');var $dialogContent=$dialogModal.find('#dialogContent').html(this.modalDialog);var $modalBody=$dialogContent.find('.modal-body');var $confirm=$dialogContent.find('#confirm');$dialogModal.modal('show');Spinner.spin($dialogContent.find('.modal-content')[0]);WebAPI.get('/report/getReportMenu/'+AppConfig.projectId).done(function(result){var $typeList=$modalBody.find('#typeList').empty();var $chapterList=$modalBody.find('#chapterList').empty();var $unitList=$modalBody.find('#unitList').empty();var typeTemp='',$firstUnitSelect,$firstChapterSelect;if(result.data&&result.data.length>0){for(var i=0;i<result.data.length;i++){var type=result.data[i];typeTemp+=('<option value="'+type._id+'" id="'+i+'">'+type.text+'</option>');var $selectChapter=$('<select id="chapter_'+i+'" class="form-control chapter" style="display: none;"></select>');if(type.structure&&type.structure.data&&type.structure.data.length>0){$selectChapter.append('<option value="all" class="type">All Chapter</option>')
for(var j=0;j<type.structure.data.length;j++){var chapter=type.structure.data[j];$selectChapter.append('<option value="'+chapter.name+'" id="'+j+'" parentId="'+i+'">'+chapter.name+'</option>');var $selectUnit=$('<select id="unit_'+i+'_'+j+'" class="form-control unit" style="display: none;"></select>');if(chapter.units&&chapter.units.length>0){$selectUnit.append('<option value="all">All Section</option>');for(var k=0;k<chapter.units.length;k++){var unit=chapter.units[k];$selectUnit.append('<option value="'+unit.unitName+'" id="'+k+'" parentId="'+j+'">'+unit.unitName+'</option>');}}else{$selectUnit.append('<option value="no">No Section</option>');}
$unitList.append($selectUnit);}}else{$selectChapter.append('<option value="no" class="type">No Chapter</option>')}
$chapterList.append($selectChapter);}}else{typeTemp+='<option value="no" class="type">No type</option>';}
$typeList.html(typeTemp);$firstChapterSelect=$chapterList.find('select:eq(0)').show();$firstUnitSelect=$unitList.find('select:eq(0)').show();if($firstChapterSelect.length==0){$chapterList.append('<select class="form-control chapter no"><option value="no" class="type">No Section</option></select>');}
if($firstUnitSelect.length==0){$unitList.append('<select class="form-control unit no"><option value="no" class="type">No Section</option></select>');}
if(_this.entity.modal.option&&result.data&&result.data.length>0){var $selectedChapter=undefined;var $selectedUnit=undefined;var $typeOption=undefined;var $chapterOption=undefined;if(_this.entity.modal.option.menuId){$typeList.val(_this.entity.modal.option.menuId);$typeOption=$typeList.find('option[value="'+_this.entity.modal.option.menuId+'"]');}
if(_this.entity.modal.option.chapter!=undefined){$chapterList.children().hide();$selectedChapter=$chapterList.find('#chapter_'+$typeOption.attr('id'));$selectedChapter.show()
if(_this.entity.modal.option.chapter!=''){$selectedChapter.val(_this.entity.modal.option.chapter);$chapterOption=$selectedChapter.find('option[value="'+_this.entity.modal.option.chapter+'"]');}}
if(_this.entity.modal.option.unit!=undefined&&$chapterOption!=undefined&&$chapterOption.length>0){$unitList.children().hide();$selectedUnit=$unitList.find('#unit_'+$chapterOption.attr('parentId')+'_'+$chapterOption.attr('id'));$selectedUnit.show()
if(_this.entity.modal.option.unit!=''){$selectedUnit.val(_this.entity.modal.option.unit)}}}
$modalBody.off('change').on('change','select',function(){$modalBody.find('select.no').remove();if($(this).hasClass('type')){var typeId=$(this).find('option[value="'+this.value+'"]')[0].id;var $chapterSelect=$('#chapter_'+typeId);$chapterList.children().hide();$chapterSelect.show();var chapterId=$chapterSelect.find('option[value="'+$chapterSelect[0].value+'"]').attr('id');$unitList.children().hide();if(chapterId){var $unitSelect=$('#unit_'+typeId+'_'+chapterId);$unitSelect.show();}else if($chapterSelect[0].value=='all'){$unitList.append('<select class="form-control unit no"><option value="all">All Section</option></select>');}else{$unitList.append('<select class="form-control unit no"><option value="no" class="type">No Section</option></select>');}}
if($(this).hasClass('chapter')){var $typeList=$('#typeList');var typeId=$typeList.find('option[value="'+$typeList[0].value+'"]')[0].id;var $chapterSelect=$('#chapter_'+typeId);var chapterId=$chapterSelect.find('option[value="'+this.value+'"]').attr('id');$unitList.children().hide();if(chapterId){var $unitSelect=$('#unit_'+typeId+'_'+chapterId);$unitSelect.show();}else if($chapterSelect[0].value=='all'){$unitList.append('<select class="form-control unit no"><option value="all">All Section</option></select>');}else{$unitList.append('<select class="form-control unit no"><option value="no">No Section</option></select>');}}});$dialogModal.off('shown.bs.modal').on('shown.bs.modal',function(){});$dialogModal.off('hidden.bs.modal').on('hidden.bs.modal',function(){$dialogContent.empty();});$confirm.off('click').on('click',function(){var chapterVal=$chapterList.find('select:not(:hidden)')[0].value;var unitVal=$unitList.find('select:not(:hidden)')[0].value;var menuId=$typeList[0].value;!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.menuId=menuId=='no'?'':menuId;_this.entity.modal.option.chapter=(chapterVal=='no'||chapterVal=='all')?'':chapterVal;_this.entity.modal.option.unit=(unitVal=='no'||unitVal=='all')?'':unitVal;$dialogModal.modal('hide');if(_this.entity.modal.option.menuId&&_this.entity.modal.option.menuId!=''){_this.screen.isScreenChange=true;}});}).fail(function(){}).always(function(){Spinner.stop();});};return ModalReportChapter;})();var ModalInteractConfig=(function($,window,undefined){var _this;function ModalInteractConfig(options){_this=this;ModalConfig.call(_this,options);}
ModalInteractConfig.prototype=Object.create(ModalConfig.prototype);ModalInteractConfig.prototype.constructor=ModalInteractConfig;ModalInteractConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalInteract.html'};ModalInteractConfig.prototype.init=function(){this.$contain=$('#modalInteract',this.$wrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$divCfgData=$('.divConfigData',this.$wrap);this.$divDataGrid=$('#divDataGrid',this.$wrap);this.$divDataTip=$('.dataDragTip',this.$wrap);I18n.fillArea(this.$contain);this.attachEvents();};ModalInteractConfig.prototype.recoverForm=function(modal){var item=_this.$divDataGrid.children('.item');if(item.length>0){item.remove();}
if(modal.points){var dictPtStat=modal.option.dictPtStatus;if(dictPtStat){var num=1;for(var id in dictPtStat){this.insertItem(id,dictPtStat[id].unit,num,dictPtStat[id].name,dictPtStat[id].projName);num++;}}}};ModalInteractConfig.prototype.reset=function(){};ModalInteractConfig.prototype.attachEvents=function(){this.$divCfgData.on('dragover',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');});this.$divCfgData.on('dragleave',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');});this.$divCfgData.on('drop',function(e,arg){$('.addData').removeClass('addData');var dragItemId=EventAdapter.getData().dsItemId;if(!dragItemId){return;}
var item=_this.$divDataGrid.find('.divDsGridItem');var len=item.length;if(Object.prototype.toString.call(dragItemId)==='[object Array]'){var lens=dragItemId.length;for(var j=0;j<lens;j++){var isExist=false;for(var i=0;i<len;i++){if(dragItemId[j]==item.eq(i).attr('dsid')){dragItemId.splice(j,1);lens=lens-1;j=j-1;isExist=true;continue;}}
if(!isExist){dotAdd(dragItemId[j],'array');}}
if(lens<1){return;}}else{var bFind=false;for(var i=0;i<len;i++){if(dragItemId==item.eq(i).attr('dsid')){bFind=true;break;}}
if(bFind){return;}
dotAdd(dragItemId);}
function dotAdd(dragItemId,isArray){if(len>=20){return;}
if(dragItemId){var item=AppConfig.datasource.getDSItemById(dragItemId);if(item&&item.alias){var parent=_this.options.modalIns;var prjName;if(parent){var temp=parent.getProjectNameFromId(item.projId,parent.m_langFlag);if(0==parent.m_langFlag){prjName='项目名：'+temp;}
else{prjName='Project Name:'+temp;}}
_this.insertItem(dragItemId,'',len+1,item.alias,prjName);len=_this.$divDataGrid.find('.divDsGridItem').length;}}}});this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;modal.points=[];if(!modal.option){modal.option={}
modal.option.dictPtStatus={};}
if(modal.option){modal.option.dictPtStatus={};}
var arrGrid=_this.$divDataGrid.find('.grow');for(var i=0,len=arrGrid.length;i<len;i++){var item=arrGrid.eq(i);var id=item.attr('dsid');var name=item.find('input').val();var proName=item.find('.contentDS').attr('title');modal.points.push(id);modal.option.dictPtStatus[id]={show:((0==i)?true:false),count:i,unit:'',name:name,projName:proName};}
if(!modal.option.timeMode){var tmEnd=new Date();tmEnd.setHours(23);tmEnd.setMinutes(59);var tmStart=new Date();tmStart.setTime(tmEnd.getTime()-172800000);tmStart.setHours(0);tmStart.setMinutes(0);modal.option.timeMode='recent';modal.option.interval='h1';modal.option.timeStart=tmStart.format('yyyy-MM-dd HH:mm:00');modal.option.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:00');modal.option.periodVal=3;modal.option.periodUnit='day';modal.interval=3;}
_this.$modal.modal('hide');e.preventDefault();});};ModalInteractConfig.prototype.insertItem=function(id,unit,num,name,projName){if(name==undefined){name=AppConfig.datasource.getDSItemById(id).alias;}
if(!projName){projName='';}
var $item=$('<div class="col-lg-3 col-xs-4 divDsGrid item">\
            <span class="divDsGridNum">'+num+'</span>\
            <span class="divDsGridItem grow" dsid="'+id+'">\
                <span class="contentDS" title="'+projName+'">'+name+'</span>\
                <input type="text" value="'+name+'" style="display:none">\
                <span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true"></span>\
            </span></div>');$item.click(function(e){var $tar=$(e.currentTarget);var $name=$tar.find('.contentDS');var $input=$tar.find('input');$name.hide();$input.show();$input.focus();$input.select();$input.keyup(function(e){if(13==e.keyCode){var newVal=$input.val();$name.text(newVal);$input.blur();}});$input.blur(function(e){$input.val($name.text());$name.show();$input.hide();});})
_this.$divDataTip.before($item);_this.$divDataGrid.find('.btnRemoveDS').last().click(function(e){var $dsGrid=$(e.currentTarget).closest('.divDsGrid');if($dsGrid){$dsGrid.remove();}
var gridNum=_this.$divDataGrid.find('.divDsGridNum');if(gridNum){for(var i=0;i<gridNum.length;i++){gridNum.eq(i).text(i+1);}}});_this.$divDataGrid.find('.contentDS').last().dblclick(function(e){var $spanTar=$(e.currentTarget);var name=$spanTar.text();var $inputName=$spanTar.next('input');$inputName.keydown(function(e){if(13==e.keyCode){var $inputTar=$(e.currentTarget);var newName=$inputTar.val();$inputTar.hide();$spanTar.text(newName);$spanTar.show();}});$inputName.blur(function(e){var $inputTar=$(e.currentTarget);var newName=$inputTar.val();$inputTar.hide();$spanTar.text(newName);$spanTar.show();});$spanTar.hide();$inputName.show();$inputName.focus();$inputName.select();});};ModalInteractConfig.prototype.destroy=function(){this.detachEvents();this.$wrap.remove();};return ModalInteractConfig;}(jQuery,window));var ModalInteract=(function(){var _this;var g_dictChart={};function ModalInteract(screen,entityParams){_this=this;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.modalId=entityParams.id;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.m_lang=I18n.resource.dataSource;this.screen=screen;this.init();this.arrColor=echarts.config.color;this.timeFlag=undefined;this.arrModal=screen.store.layout[0];g_dictChart[this.modalId]={chart:this.chart,contain:this.container};this.spinner.spin(this.container);};ModalInteract.prototype=new ModalBase();ModalInteract.prototype.optionTemplate={name:'toolBox.modal.INTERACT_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:3,minWidth:9,maxHeight:12,maxWidth:12,type:'ModalInteract',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalInteract.prototype.defaultOptions={title:{text:''},tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},dataZoom:{show:true},yAxis:[{type:'value',axisLabel:{textStyle:{color:'#777'}},splitLine:{show:true,lineStyle:{color:'#777',width:1,type:'dashed'}}}],animation:false,grid:[{bottom:70}]};ModalInteract.prototype.init=function(){var containWidth=$(this.container).width();var containHeight=$(this.container).height();var $divLeftPart=$('<div style="display:inline-block;height:100%"></div>');$divLeftPart.css('width',containWidth-220+'px');var $divChartCtrl=$('<div id="chartShow"></div>');$divChartCtrl.css('height',containHeight-10+'px');$divLeftPart.append($divChartCtrl);var $divDataCtrl=$('<div id="dataList" style="display:inline-block;position:absolute;top:10px;right:0;width:220px;height:100%;overflow-y:auto"><div class="form-group"></div></div>');if(this.modal.points&&this.modal.option.dictPtStatus){var arrId=[]
for(var id in this.modal.option.dictPtStatus){arrId.push(id);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var id in this.modal.option.dictPtStatus){for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var name=this.modal.option.dictPtStatus[id].name;var unit=this.modal.option.dictPtStatus[id].unit;this.insertInteractData($divDataCtrl,id,name,unit);var target=$divDataCtrl.find('.form-inline').last();if(0==arrItem[m].type){}
else if(1==arrItem[m].type){var showFormula=AppConfig.datasource.getShowNameFromFormula(arrItem[m].value);this.setFormulaToolTips(target,name,showFormula,arrItem[m].note);}
break;}}}}
$(this.container).empty();$(this.container).append($divLeftPart);$(this.container).append($divDataCtrl);}
ModalInteract.prototype.renderModal=function(e){this.drawCharts();this.spinner.stop();}
ModalInteract.prototype.updateModal=function(e){var dsId=e[0].dsItemId;var modeName;for(var i=0;i<_this.arrModal.length;i++){var arrPt=_this.arrModal[i].modal.points;for(var j=0;j<arrPt.length;j++){if(dsId==arrPt[j]){modeName=_this.arrModal[i].modal.option.timeMode;break;}}
if(modeName){break;}}
if('recent'==modeName){var newOption=_this.chart.getOption();var newSeries=newOption.series;var arrId=[];for(var i=0,len=e.length;i<len;i++){arrId.push(e[i].dsItemId);}
var arrItem=AppConfig.datasource.getDSItemById(arrId);for(var i=0,len=e.length;i<len;i++){var id=e[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var name=arrItem[m].alias;var bFind=false;var j=0;for(var len2=newSeries.length;j<len2;j++){if(name==newSeries[j].name){bFind=true;break;}}
if(bFind){var flag=false;for(var k=0;k<newSeries[j].data.length;k++){if(undefined==newSeries[j].data[k]){newSeries[j].data[k]=e[i].data;flag=true;break;}}
if(!flag){newSeries[j].data.push(e[i].data);}}
break;}}}
_this.chart.setOption(newOption);_this.chart.refresh();}
var spanReal=$('#dataList').find('.frontCtrl');if(spanReal){for(var j=0,len2=e.length;j<len2;j++){var id=e[j].dsItemId;for(var k=0,len3=spanReal.length;k<len3;k++){if(id==spanReal.eq(k).attr('pId')){spanReal.eq(k).find('.interactRealVal').text(e[j].data);break;}}}}}
ModalInteract.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();}
ModalInteract.prototype._showConfig=function(){};ModalInteract.prototype.setModalOption=function(option){}
ModalInteract.prototype.drawCharts=function(parmOption,parmChart,parmContain){if(!parmOption){parmOption=_this.modal.option;}
if(!parmChart){parmChart=_this.chart;}
if(!parmContain){parmContain=_this.container;}
if(parmOption){var arrPoints=[];for(var itemId in parmOption.dictPtStatus){if(parmOption.dictPtStatus[itemId].show){arrPoints.push(itemId);}}
if(0==arrPoints.length){parmChart.clear();_this.setDataListColor();return;}
if('recent'==parmOption.timeMode){var tmEnd=new Date();tmEnd.setHours(23);tmEnd.setMinutes(59);var tmTemp=tmEnd.getTime()-86400000*(parmOption.periodVal-1);var tmStart=new Date();tmStart.setTime(tmTemp);tmStart.setHours(0);tmStart.setMinutes(0);parmOption.timeStart=tmStart.format('yyyy-MM-dd HH:mm:00');parmOption.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:00');}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:arrPoints,timeStart:new Date(parmOption.timeStart).format('yyyy-MM-dd HH:mm:00'),timeEnd:new Date(parmOption.timeEnd).format('yyyy-MM-dd HH:mm:00'),timeFormat:parmOption.interval}).done(function(result){if(result.timeShaft.length<=0){parmChart=echarts.init($(parmContain,AppConfig.chartTheme).find('#chartShow')[0]).clear();return;}
var arrName=[];var series=[];var arrId=[];var arrItem=[];for(var i=0,len=result.list.length;i<len;i++){arrId.push(result.list[i].dsItemId);}
arrItem=AppConfig.datasource.getDSItemById(arrId);var cntNow=(new Date()).getTime();var dictLastData={};for(var i=0,len=result.list.length;i<len;i++){var id=result.list[i].dsItemId;for(var m=0;m<arrItem.length;m++){if(id==arrItem[m].id){var showData=[];var lastData;var flag=false;if('recent'==parmOption.timeMode){var n=0;for(;n<result.timeShaft.length;n++){if(Date.parse(result.timeShaft[n])>cntNow){if(!flag){lastData=result.list[i].data[n];flag=true;}
showData.push(undefined);}
else{showData.push(result.list[i].data[n]);}}
dictLastData[id]=lastData;}
else{showData=result.list[i].data;}
var name=arrItem[m].alias;arrName.push(name);var count=parmOption.dictPtStatus[id].count;var color=_this.arrColor[count];series.push({name:name,type:'line',data:showData,itemStyle:{normal:{color:color}}});break;}}}
var options={legend:{show:false,data:arrName},xAxis:[{type:'category',boundaryGap:false,data:result.timeShaft,axisLabel:{textStyle:{color:'#777'}},splitLine:{show:true,lineStyle:{color:'#777',width:1,type:'dashed'}}}],series:series}
var drawOptions={}
jQuery.extend(drawOptions,ModalInteract.prototype.defaultOptions,options);parmChart=echarts.init($(parmContain).find('#chartShow')[0],AppConfig.chartTheme);parmChart.setOption(drawOptions);_this.chart=parmChart;_this.setDataListColor(parmContain);if('recent'==parmOption.timeMode){var spanReal=$(parmContain).find('.frontCtrl');if(spanReal){for(var p=0;p<spanReal.length;p++){var $item=spanReal.eq(p);var id=$item.attr('pid');$item.find('.interactRealVal').text(dictLastData[id]);}}}
else{var spanReal=$(parmContain).find('.frontCtrl');if(spanReal){for(var p=0;p<spanReal.length;p++){var $item=spanReal.eq(p);var id=$item.attr('pid');$item.find('.interactRealVal').text('');}}}});}}
ModalInteract.prototype.drawChartsEx=function(parmOption,modalId){_this.drawCharts(parmOption,g_dictChart[modalId].chart,g_dictChart[modalId].contain);}
ModalInteract.prototype.insertInteractData=function($divDst,ptId,ptName,ptUnit){$divDst.append('\
            <form class="form-inline">\
                <span class="form-control frontCtrl interactDsFrame" pId="'+ptId+'" style="cursor:pointer;width:200px;border-radius: 0em 0em 0em 0em;margin-right: -4px;border-width: 0;color: #ccc;border-bottom:1px solid #465b85;">\
                    <span class="interactSpanDsName" style="display:inline-block;width:100px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;vertical-align: bottom;">'+ptName+'</span>\
                    <span class="interactRealVal" style="display:inline-block;width:70px;overflow: hidden;text-overflow:ellipsis;white-space:nowrap;vertical-align:bottom;"></span>\
                </span>\
            </form>\
        ');var $front=$divDst.find('.frontCtrl');$front.off().click(function(e){if(_this.modal.option&&_this.modal.option.dictPtStatus){var $tar=$(e.currentTarget);var id=$tar.attr('pId');var $contain=$tar.closest('.springContainer');var modalId;if($contain){var temp=$contain.attr('id');modalId=temp.split('_')[1];for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(modalId==item.id){item.modal.option.dictPtStatus[id].show=!item.modal.option.dictPtStatus[id].show;break;}}}
_this.screen.saveLayoutOnly();_this.drawCharts(item.modal.option,g_dictChart[modalId].chart,g_dictChart[modalId].contain);}})}
ModalInteract.prototype.initInteractTime=function($divDst){$divDst.append('\
            <form class="form-inline" style="margin-top: 3px;font-family:Microsoft YaHei;font-size:14px">\
                <div class="form-group" style="width:140px">\
                    <label for="selMode" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_MODE+'</label>\
                    <select class="form-control" id="selMode" style="background-color:#f4f6f8;border:1px solid #465b85;color:#646464;width:inherit">\
                        <option value="fixed">'+I18n.resource.modalConfig.option.MODE_FIXED+'</option>\
                        <option value="recent">'+I18n.resource.modalConfig.option.MODE_RECENT+'</option>\
                    </select>\
                </div>\
                <div class="form-group" style="width:120px">\
                    <label for="selInterval" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_INTERVAL+'</label>\
                    <select class="form-control" id="selInterval" style="background-color:#f4f6f8;border:1px solid #465b85;color:#646464;width:inherit">\
                        <option value="m1">'+I18n.resource.modalConfig.option.INTERVAL_MIN1+'</option>\
                        <option value="m5">'+I18n.resource.modalConfig.option.INTERVAL_MIN5+'</option>\
                        <option value="h1">'+I18n.resource.modalConfig.option.INTERVAL_HOUR1+'</option>\
                        <option value="d1">'+I18n.resource.modalConfig.option.INTERVAL_DAY1+'</option>\
                        <option value="M1">'+I18n.resource.modalConfig.option.INTERVAL_MON1+'</option>\
                    </select>\
                </div>\
                <div class="form-group" id="divTmRange" style="width:380px">\
                    <label for="divRange" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_TIME_RANGE+'</label>\
                    <div id="divRange" style="display:inline">\
                        <input class="form-control" type="text" id="tmStart" style="width:165px;cursor:pointer;text-align:center" readonly>\
                        <span class="input-group-addon" style="display: inline;padding-top:6px;padding-bottom:7px;text-align:center;border:1px solid rgb(39, 51, 75);color:#646464;margin-right:-6px;background-color:#f4f6f8;">'+I18n.resource.modalConfig.option.TIP_RANGE_TO+'</span>\
                        <input class="form-control" type="text" id="tmEnd" style="width:165px;cursor:pointer;text-align:center" readonly>\
                    </div>\
                </div>\
                <div class="form-group" id="divTmLast" style="width:340px;display:none">\
                    <label for="divLast" style="display:block;color:#fafcfd">'+I18n.resource.modalConfig.option.LABEL_PERIOD+'</label>\
                    <div id="divLast">\
                        <input class="form-control" type="text" id="inputPeriodValue" style="width:165px;background-color:#f4f6f8;border:1px solid #27334b;border-radius:0.5em 0 0 0.5em;margin-right:-5px;color:#646464">\
                        <select class="form-control" id="selPeriodUnit" style="width:165px;background-color:#f4f6f8;border:1px solid #27334b;border-radius:0 0.5em 0.5em 0;color:#646464">\
                            <option value="hour">'+I18n.resource.modalConfig.option.PERIOD_UNIT_HOUR+'</option>\
                            <option value="day">'+I18n.resource.modalConfig.option.PERIOD_UNIT_DAY+'</option>\
                            <option value="month">'+I18n.resource.modalConfig.option.PERIOD_UNIT_MON+'</option>\
                        </select>\
                    </div>\
                </div>\
                <button class="btn" type="button" id="btnOk" modalId="'+_this.modalId+'" style="width:70px;vertical-align:bottom;color:#f4f6f8;background-color:#288add;">'+I18n.resource.observer.widgets.YES+'</button>\
            </form>\
        ');var $selMode=$divDst.find('#selMode');var $selInter=$divDst.find('#selInterval');var $divTmRange=$divDst.find('#divTmRange');var $divTmLast=$divDst.find('#divTmLast');$selMode.change(function(e){var $opt=$selInter.children('option');var flag=$(e.currentTarget).val();switch(flag){case'fixed':$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');$divTmRange.css('display','inline-block');$divTmLast.css('display','none');break;case'recent':$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','none');$divTmRange.css('display','none');$divTmLast.css('display','inline-block');break;default:break;}});var tmNow=new Date();var tmStart=new Date();tmStart.setFullYear(tmNow.getFullYear()-10);var $inputStart=$divDst.find('#tmStart');$inputStart.val(tmNow.format('yyyy-MM-dd HH:mm:00'));$inputStart.css('background-color','#f4f6f8');$inputStart.css('border','1px solid #27334b');$inputStart.css('color','#646464');$inputStart.css('border-radius','0.5em 0 0 0.5em');$inputStart.css('margin-right','-5px');$inputStart.datetimepicker({format:'yyyy-mm-dd hh:mm:00',startView:'month',minView:'hour',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){});var $inputEnd=$divDst.find('#tmEnd');$inputEnd.val(tmNow.format('yyyy-MM-dd HH:mm:00'));$inputEnd.css('background-color','#f4f6f8');$inputEnd.css('border','1px solid #27334b');$inputEnd.css('color','#646464');$inputEnd.css('border-radius','0 0.5em 0.5em 0');$inputEnd.datetimepicker({format:'yyyy-mm-dd hh:mm:00',startView:'month',minView:'hour',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){});var $inputPerVal=$divDst.find('#inputPeriodValue');var $selPerUnit=$divDst.find('#selPeriodUnit');var $btnOk=$divDst.find('#btnOk');$btnOk.off().click(function(e){var tmMode=$selMode.val();var strStart,strEnd;if('fixed'==tmMode){strStart=$inputStart.val();strEnd=$inputEnd.val();}
else if('recent'==tmMode){var tmStart=new Date();var periodVal=parseInt($inputPerVal.val());if(!periodVal){alert('Please input time !');return;}
var periodUnit=$selPerUnit.val();switch(periodUnit){case'hour':var time=tmNow.getTime()-3600000*periodVal;tmStart.setTime(time);break;case'day':var time=tmNow.getTime()-86400000*periodVal;tmStart.setTime(time);break;case'month':var month=tmNow.getMonth();if(0==month){tmStart.setFullYear(tmNow.getFullYear()-1);tmStart.setMonth(11);}
else{tmStart.setMonth(month-1);}
break;default:break;}
strStart=tmStart.format('yyyy-MM-dd HH:mm:00');strEnd=tmNow.format('yyyy-MM-dd HH:mm:00');}
else{alert('Please select mode !');return;}
var modalId=$(e.currentTarget).attr('modalId');if(modalId){for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(item){if(modalId==item.id){if(!item.modal.option){item.modal.option={};item.modal.option.dictPtStatus={};}
item.modal.option.timeMode=tmMode;item.modal.option.interval=$selInter.val();item.modal.option.timeStart=strStart;item.modal.option.timeEnd=strEnd;item.modal.option.periodVal=periodVal;item.modal.option.periodUnit=periodUnit;if('recent'==tmMode){item.interval=1000;}
else{item.interval=null;}
break;}}}}
_this.screen.saveLayoutOnly();_this.drawCharts(item.modal.option,g_dictChart[modalId].chart,g_dictChart[modalId].contain);});if(_this.modal.option){$selMode.val(_this.modal.option.timeMode);$selInter.val(_this.modal.option.interval);$inputStart.val(_this.modal.option.timeStart);$inputEnd.val(_this.modal.option.timeEnd);$inputPerVal.val(_this.modal.option.periodVal);$selPerUnit.val(_this.modal.option.periodUnit);if('recent'==_this.modal.option.timeMode){$selMode.change();}}}
ModalInteract.prototype.setDataListColor=function(contain){var dataListName;if(!contain){dataListName=$('#dataList').find('.frontCtrl');}
else{dataListName=$(contain).find('.frontCtrl');}
if(dataListName){for(var j=0,len=dataListName.length;j<len;j++){var $item=dataListName.eq(j);var id=$item.attr('pId');var $contain=$item.closest('.springContainer');var modalId;if($contain){var temp=$contain.attr('id');modalId=temp.split('_')[1];for(var i=0;i<_this.arrModal.length;i++){var item=_this.arrModal[i];if(modalId==item.id){var count=item.modal.option.dictPtStatus[id].count;var bShow=item.modal.option.dictPtStatus[id].show;var $spanDsName=$item.find('.interactSpanDsName');if($spanDsName){if(bShow){$spanDsName.css('color',_this.arrColor[count]);}
else{$spanDsName.css('color','');}}
break;}}}}}}
ModalInteract.prototype.setToolTips=function(target,customName,projectName,pointName,pointDesc){var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px">');show.append('    <div class="tooltipContent interactTipsBackground">');show.append('        <p class="customName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="projectName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.PROJECT_NAME).append('</span>: ').append(projectName).append('</p> ');show.append('        <p class="pointName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_NAME).append('</span>: ').append(pointName).append('</p> ');show.append('        <p class="pointDesc interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(pointDesc).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'left',title:_this.m_lang.PARAM,template:show.toString()};target.tooltip(options);}
ModalInteract.prototype.setFormulaToolTips=function(target,customName,formula,desc){var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:400px;">');show.append('    <div class="tooltipContent interactTipsBackground">');show.append('        <p class="customName interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="formula interactTipsStyle" style="word-break:normal;"><span class="interactTipsTitleStyle">').append(_this.m_lang.FORMULA_NAME).append('</span>: ').append('</p>');show.append('        <p class="pointDesc interactTipsStyle"><span class="interactTipsTitleStyle">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(desc).append('</p>');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var showFormula=$('<span>'+formula+'</span>');var showObj=$(show.toString());showFormula.appendTo(showObj.find('.formula')).mathquill();var options={placement:'left',title:_this.m_lang.PARAM,template:showObj};target.tooltip(options);}
ModalInteract.prototype.getProjectNameFromId=function(id,langFlag){var name;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(id==item.id){if(0==langFlag){name=item.name_cn;}
else{name=item.name_en;}
break;}}
return name;}
ModalInteract.prototype.configModal=new ModalInteractConfig();return ModalInteract;})();var ModalMobile=(function(){function ModalMobile(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalMobile.prototype=new ModalChart();ModalMobile.prototype.optionTemplate={name:'toolBox.modal.MOBILE_CHART',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMobile'};ModalMobile.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:true},grid:(function(){var grid={borderWidth:0,borderColor:'#eee',left:50,bottom:40,right:40,top:40}
if(AppConfig.isMobile){grid.x=40;}
return grid;}()),xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false},splitLine:{show:(function(){if(AppConfig.isMobile){return false;}else{return true;}}())},axisLabel:{formatter:function(value){if(AppConfig.isMobile&&value/1000>=1){return value/1000+'k';}else{return value;}}}}],animation:true};ModalMobile.prototype.renderModal=function(){},ModalMobile.prototype.updateModal=function(options){},ModalMobile.prototype.showConfigMode=function(){},ModalMobile.prototype.goBackTrace=function(data){}
return ModalMobile;})();var ModalAppKPICollect=(function(){function ModalAppKPICollect(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalAppKPICollect.prototype=new ModalBase();ModalAppKPICollect.prototype.optionTemplate={name:'toolBox.modal.APP_KPI_COLLECT',parent:3,mode:'custom',maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalAppKPICollect',scroll:true,tooltip:{'imgPC':false,'imgMobile':true,'isSpecData':false,'desc':''}};ModalAppKPICollect.prototype.configModalOptDefault={header:{'title':'配置','needBtnClose':true},area:[{'module':'multiDataConfig','data':{'variable':[],'param':[{'type':'name','name':'数据标题'},{'type':'data','name':'数据点位'},{'type':'unit','name':'数据单位'},{'type':'scale','name':'小数点位'}]}}],result:{}};ModalAppKPICollect.prototype.renderModal=function(){this.spinner.stop();var _this=this;var divAppKPi=document.createElement('div');var divKpiList=document.createElement('div');divAppKPi.className='appKpi';divKpiList.className='divKPIList';this.container.appendChild(divAppKPi);divAppKPi.appendChild(divKpiList);divKpiList.innerHTML='';var optTitle=_this.entity.modal.option.title;if(optTitle){if(optTitle.text||optTitle.data){divKpiList.innerHTML='\
				<div class="divSingleType divListTitle">\
	                <div class="divTypeTitle ">'+_this.entity.modal.option.title.text+'</div>\
	                <div class="divKPIListRight">\
						<div class="divTypeVal divKPINow" data-pt="'+_this.entity.modal.option.title.data+'" data-scale="'+_this.entity.modal.option.title.scale+'"></div>\
	               		<div class="divTypeUnit divKPIUnit">'+(_this.entity.modal.option.title.unit?_this.entity.modal.option.title.unit:'')+'</div>\
	                </div>\
	            </div>';}}
for(var i=0;i<_this.entity.modal.option.param.length;i++){divKpiList.innerHTML+='\
	        	<div class="divSingleType">\
	                <div class="divTypeTitle ">'+_this.entity.modal.option.param[i].name+'</div>\
	                <div class="divKPIListRight">\
						<div class="divTypeVal" data-scale="'+_this.entity.modal.option.param[i].scale+'" data-pt="'+_this.entity.modal.option.param[i].data+'"></div>\
	               		<div class="divTypeUnit ">'+_this.entity.modal.option.param[i].unit+'</div>\
	                </div>\
	            </div>\
			';}
this.container.appendChild(divAppKPi);};ModalAppKPICollect.prototype.updateModal=function(points){var data;for(var i=0;i<points.length;i++){var dom=this.container.querySelector('[data-pt="'+points[i].dsItemId+'"]');if(dom){if(!isNaN(Number(points[i].data))){if(dom.dataset.scale&&!isNaN(parseInt(dom.dataset.scale))){if(parseInt(dom.dataset.scale)>10){data=parseFloat(points[i].data).toFixed(10);}else{data=parseFloat(points[i].data).toFixed(parseInt(dom.dataset.scale));}}else{data=parseFloat(points[i].data).toFixed(2);}}else{data='No Data';}
dom.innerText=data;}}};ModalAppKPICollect.prototype.showConfigMode=function(){};ModalAppKPICollect.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option)this.configModalOpt.area[0].data.variable=[this.entity.modal.option];this.configModalOpt.result.func=function(option){_this.setModalOption(option);}};ModalAppKPICollect.prototype.setModalOption=function(option){this.entity.modal.points=[];this.entity.modal.option={};for(var i=0;i<option.dataInfoList.length;i++){option.dataInfoList[i].title.data&&this.entity.modal.points.push(option.dataInfoList[i].title.data);this.entity.modal.option=option.dataInfoList[i];for(var j=0;j<option.dataInfoList[i].param.length;j++){if(option.dataInfoList[i].param[j].data)this.entity.modal.points.push(option.dataInfoList[i].param[j].data);}}
this.entity.modal.interval=5;};ModalAppKPICollect.prototype.goBackTrace=function(data){};return ModalAppKPICollect;})();var ModalDataMonitorList=(function(){function ModalDataMonitorList(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalDataMonitorList.prototype=new ModalBase();ModalDataMonitorList.prototype.optionTemplate={name:'toolBox.modal.DATA_MONITOR_LIST',parent:0,mode:['dataMonitorList'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDataMonitorList',scroll:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':true,'desc':'#Proj_ParaQueyInfo'}};ModalDataMonitorList.prototype.configModalOpt={};ModalDataMonitorList.prototype.initLeftMonitorList=function(monitorList,data){var _this=this;var _value;var listLeft=document.createElement('div');listLeft.className='monitorListLeft gray-scrollbar';var listLeftContentGroup=document.createElement('div');listLeftContentGroup.className='listLeftContentGroup';for(var i=0;i<monitorList.content.length;i++){var item=monitorList.content[i];var listLeftContent=document.createElement('div');listLeftContent.className='panel panel-default';var listLeftTitle=document.createElement('div');listLeftTitle.className='listLeftTitle';var listLeftContentList=document.createElement('div');listLeftContentList.className='listLeftContentList';listLeftTitle.innerHTML+='\
                    <div class="panel-title">\
                        <table class="table table-hover">\
                            <tbody>\
                                <tr class="kpi-tr-index show-detail">\
                                    <td>'+item.system+'</td>\
                                </tr>\
                            </tbody>\
                        </table>\
                    </div>\
                    ';listLeftContentList.innerHTML='\
                <table>\
                    <tbody>\
                        <tr>\
                            <td>参数</td>\
                            <td>当前值</td>\
                            <td>选择</td>\
                        </tr>\
                    </tbody>\
                </table>\
                ';listLeftContent.appendChild(listLeftTitle);for(var j=0;j<item.parameter.length;j++){for(var m=0;m<data.length;m++){if(item.parameter[j].point!=data[m].name){continue;}else{_value=data[m].value;}};listLeftContentList.innerHTML+='\
                    <div id="para-collapse" class="">\
                        <div class="bodyPn borderColorTemp4">\
                            <table class="table table-hover">\
                                <tbody>\
                                    <tr class="kpi-tr-index show-detail">\
                                        <td>'+item.parameter[j].legend+'</td>\
                                        <td>'+Number(_value).toFixed(1)+'</td>\
                                        <td>\
                                            <form>\
                                                <input type="checkbox" id="selectedCheckbox" value="'+item.parameter[i].point+'" name="'+item.parameter[j].legend+'">\
                                            </form>\
                                       </td>\
                                    </tr>\
                                </tbody>\
                            </table>\
                        </div>\
                    </div>\
                ';listLeftContent.appendChild(listLeftContentList);};listLeftContentGroup.appendChild(listLeftContent);};listLeft.appendChild(listLeftContentGroup);this.container.appendChild(listLeft);this.attachEvent();if($._data($('#selectedCheckbox')[0],"events")&&$._data($('.table tr'),"events")){$('.monitorListLeft').css("width","24%");}else{$('.monitorListLeft').css("width","100%");}};ModalDataMonitorList.prototype.renderModal=function(){this.spinner.stop();var _this=this;var _pId=393;var postData=this.entity.modal.points;WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:postData}).done(function(result){if($(_this.container).find(".alertErrorInfo")){$(_this.container).find(".alertErrorInfo").remove();}
if(!(result.dsItemList[0]&&result.dsItemList[0].data))return;if(result.dsItemList[0].data.indexOf('content')!==-1){var monitorList=JSON.parse(result.dsItemList[0].data);var pArr=[];for(var i=0;i<monitorList.content.length;i++){var arr=monitorList.content[i].parameter;for(var j=0;j<arr.length;j++){pArr.push(arr[j].point);}}
var opt1={pointList:pArr,proj:_pId}
console.log(opt1);WebAPI.post('/get_realtimedata',opt1).done(function(data){console.log(data);_this.initLeftMonitorList(monitorList,data);})}else{var alertErrorInfo=document.createElement('div');alertErrorInfo.className='alertErrorInfo';alertErrorInfo.innerHTML='所拖入数据点的格式不符合该控件所需的数据格式,数据点格式参考上海来福士的Proj_ParaQueyInfo';_this.container.appendChild(alertErrorInfo);}});};ModalDataMonitorList.prototype.updateModal=function(points){var _this=this;};ModalDataMonitorList.prototype.attachEvent=function(){$('.listLeftTitle').on('click',function(e){var index=$(".listLeftTitle").index($(this));$('.listLeftContentList').eq(index).toggle('slow');})}
ModalDataMonitorList.prototype.showConfigMode=function(){};ModalDataMonitorList.prototype.initConfigModalOpt=function(){};ModalDataMonitorList.prototype.setModalOption=function(option){};return ModalDataMonitorList;})();﻿var ModalDiagnosisPanel=(function(){var _this=undefined;function ModalDiagnosisPanel(dom){this.ElScreenContainer=window.ElScreenContainer||$('body')[0];this.parent=dom||this.ElScreenContainer;this.dictZone=undefined;this.dictEquipment=undefined;this.dictObserverText=undefined;this.arrLastNotice=[];this.workerUpdate=undefined;this.tabelModelData=undefined;this.tableModelUpdate=undefined;this.floorCount=0;this.dialog=undefined;this.langCfg=I18n.resource.diagnosis.config;this.noticeId=0;this.faId=0;this.faUserId=0;this.obScreen=undefined;this.$obContainer=undefined;this.urgentCount=0;this.criticalCount=0;this.result=undefined;_this=this;}
ModalDiagnosisPanel.prototype={show:function(){Spinner.spin(this.ElScreenContainer);WebAPI.get("/static/views/observer/widgets/modalDiagnosisPanel.html").done(function(resultHtml){$(_this.parent).html(resultHtml);I18n.fillArea($(_this.parent));_this.init();}).always(function(){Spinner.stop();});},optionTemplate:{name:'toolBox.modal.DIAGNOSIS_PANEL',parent:0,mode:[''],maxNum:1,title:'',minHeight:2,minWidth:4,maxHeight:6,maxWidth:12,type:'ModalDiagnosisPanel'},initStructData:function(data){var item,arr;this.dictZone=new Object();this.dictEquipment=new Object();this.buildings=[];arr=data.equipments;for(var i=0,len=arr.length;i<len;i++){item=arr[i];item.faultIds=new Array();this.dictEquipment[item.id]=item;}
arr=data.zones;this.floorCount=arr.length;var index=-1,tempBuildingId=undefined;for(var i=0,len=arr.length;i<len;i++){item=arr[i];var equipments=[];for(var j=0;j<data.equipments.length;j++){if(data.equipments[j].zoneId==item.id){equipments.push({equipmentId:data.equipments[j].id,equipmentName:data.equipments[j].name})}}
this.dictZone[item.id]=item;if(tempBuildingId!=item.buildingId){tempBuildingId=item.buildingId;index++;var building={buildId:item.buildingId,buildName:item.buildingName,subBuilds:[{subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}]}
this.buildings.push(building)}else{var subBuilding={subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}
this.buildings[index].subBuilds.push(subBuilding);}}},close:function(){this.dictZone=null;this.dictEquipment=null;this.dictObserverText=null;this.tabelModelData=null;this.arrLastNotice=null;this.floorCount=null;if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;if(this.tableModelUpdate)this.tableModelUpdate.terminate();this.tableModelUpdate=null;if(this.dialog)this.dialog.close();if(this.obScreen)this.obScreen.close();if(ToolCurrent)ToolCurrent.close();},onresize:function(){ScreenCurrent.obScreen.resize();},init:function(){this.$obContainer=$('#obContainer');this.dictObserverText={};WebAPI.get('/diagnosis/getStruct/'+AppConfig.projectId).done(function(result){_this.initStructData(result);_this.initPaneNav();_this.result=result;$('.subBuildingBtn','#paneIcon').eq(0).trigger('click');$('.div-nav-row','#paneIcon').eq(0).children('span:first').trigger('click');});function tabelModelClose(){$('#panelIconNew').hide();if(_this.tableModelUpdate)_this.tableModelUpdate.terminate();_this.tableModelUpdate=null;}
$("#btnNoticeHistory").off().click(function(e){ScreenModal=new DiagnosisLogHistory(_this);ScreenModal.setIsModal(true);ScreenModal.show();});var $flootCt=$('#floorCt');var $floorPB=$flootCt.find('.showCont');var $floorPH=$flootCt.find('.panel-default');$flootCt.find('.panel-heading').off('click').click(function(){$floorPH.hide();$floorPB.show();});$floorPB.off('click').click(function(){$(this).hide();$floorPH.show();});},initWorkerForUpdating:function(){if(this.workerUpdate){this.workerUpdate.terminate();}
Spinner.spin(this.parent);this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);this.workerUpdate.postMessage({projectId:AppConfig.projectId,type:"diagnosisScreen",zoneId:AppConfig.zoneId});},initObScreen:function(){this.obScreen.isInDiagnosis=true;this.obScreen.diagScreen=this;},resetFloor:function(){this.refreshData({data:{notice:this.arrLastNotice}},true);},clearNullArr:function(arr){for(var i=0,len=arr.length;i<len;i++){if(arr[i]==""||typeof(arr[i])=="undefined"){arr.splice(i,1);len--;i--;}}
return arr;},gradientColors:function(colorArr,$gradientDom,valueCurrent,max,min){var valueMark=(max-min)/(colorArr.length-1);var regexp=/[0-9]{0,3}/g;for(var i=0;i<colorArr.length-1;i++){var colorMaxValue=min+(i+1)*valueMark;if(valueCurrent>colorMaxValue)continue;var colorSelPre=colorArr[i];var colorSelTo=colorArr[i+1];var colorValPreArr=[];colorValPreArr=colorSelPre.match(regexp);_this.clearNullArr(colorValPreArr);var colorValToArr=[];colorValToArr=colorSelTo.match(regexp);_this.clearNullArr(colorValToArr);var colorMinValue=min+i*valueMark;if(i==colorArr.length-2){colorMaxValue=max;}
if(valueCurrent<=colorMaxValue){$gradientDom.css('background','rgb('+(parseInt((parseInt(colorValToArr[0]-colorValPreArr[0])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[0]))+','+(parseInt((parseInt(colorValToArr[1]-colorValPreArr[1])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[1]))+','+(parseInt((parseInt(colorValToArr[2]-colorValPreArr[2])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[2]))+')');i=colorArr.length-1;}}},refreshData:function(e,isOnlyRenderDictFault){if(!e.data||$.isEmptyObject(e.data)||e.data.error){Spinner.stop();}
_this=this.self?this.self:this;if(e.data.notice&&e.data.notice[0]){_this.arrLastNotice=e.data.notice;var existedIds=[];for(var i in _this.arrLastNotice){existedIds.push(_this.arrLastNotice[i].id);}
if($.inArray(e.data.notice[0].id,existedIds)<0){Array.prototype.push.apply(e.data.notice,_this.arrLastNotice);_this.arrLastNotice=e.data.notice;}
for(var key in _this.dictEquipment){_this.dictEquipment[key].faultIds=new Array();}
try{var dictFaultHighestGrade={};for(var i=0;i<e.data.notice.length;i++){var faultId=e.data.notice[i].faultId,equipmentId=e.data.notice[i].equipmentId;var grade;var eq=_this.dictEquipment[equipmentId];eq.faultIds.push(faultId);grade=dictFaultHighestGrade[eq.modalTextId];if(!grade||e.data.notice[i].grade>grade)
dictFaultHighestGrade[eq.modalTextId]=e.data.notice[i].grade;}
for(var key in dictFaultHighestGrade){if(_this.dictObserverText[key])
_this.dictObserverText[key].updateDiagnosisGrade(dictFaultHighestGrade[key]);}}catch(e){console.log(e)}}else{$('#spinnerLoadingNotice').remove();}
$('#spinnerLoadingNotice').remove();$('#btnWarningLog').fadeIn();$('#navigation').fadeIn();$('#diagnosisLogCt').slideDown();Spinner.stop();if(isOnlyRenderDictFault)return;$('.badge.warningCount','#paneIcon').empty();$('.badge.alertCount','#paneIcon').empty();if(e.data.count&&e.data.count instanceof Array){e.data.count.forEach(function(obj){for(var i in obj){var warningCount=parseInt(obj[i].warning);var alertCount=parseInt(obj[i].alert);var $targetWarning=$('#navFloor-'+i).next('.warningCount');var $targetAlert=$('#navFloor-'+i).siblings('.alertCount');if(warningCount>0){$targetWarning.html(warningCount);}else{$targetWarning.html('');}
if(alertCount>0){$targetAlert.html(alertCount);}else{$targetAlert.html('');}}});}
_this.statisticFaultCount();_this.renderPaneNoticeGroup();},initPaneNav:function(){var pane=document.createElement('div');var div,zoneItem,itemI,itemJ;var zoneItemList=[];var $buildingBox,$subBuilding=$('.subBuilding'),$subBuildingList,countHtml;var $dropdownBtn=$('#dropdownBtn');for(var zoneId in this.dictZone){zoneItem=this.dictZone[zoneId];zoneItemList.push(zoneItem);}
var paneIcon=document.getElementById('paneIcon');paneIcon.innerHTML="";paneIcon.appendChild(pane);for(var i=0;i<zoneItemList.length;i++){countHtml='';var isSameBuild=false;itemI=zoneItemList[i];for(var j=0;j<zoneItemList.length;j++){itemJ=zoneItemList[j];if(itemI.buildingId==itemJ.buildingId){isSameBuild=true;break;}}
if(isSameBuild){$buildingBox=$('.div-nav-box'+itemI.buildingId);if($buildingBox.length===0){$buildingBox=$('<div class="div-nav-box'+itemI.buildingId+'"><span id="building_'+itemI.buildingId+'" class="grow subBuildingBtn"></span><span class="badge warningCount"></span><span class="badge alertCount"></span></div>');$buildingBox.find('#building_'+itemI.buildingId).html(itemI.buildingName);$subBuildingList=$('<div class="subBuildingList" id="subList_'+itemI.buildingId+'"></div>');$buildingBox.append($subBuildingList);$(pane).append($buildingBox);}
if(itemI.count&&itemI.count>0){countHtml='<span class="badge warningCount">'+itemI.count+'</span><span class="badge alertCount"></span>';}else{countHtml='<span class="badge warningCount"></span><span class="badge alertCount"></span>';}
var $subBuildings=$('#subList_'+itemI.buildingId).children('.subBuilding');var countArry=[];for(var k=0;k<$subBuildings.length;k++){countArry.push(parseInt($subBuildings.eq(k).attr('count')));}
if((countArry.length===0)||(itemI.count>countArry[countArry.length-1])){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$('#subList_'+itemI.buildingId).append($subBuilding);}else{for(var q=0;q<countArry.length;q++){if(itemI.count<countArry[q]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$($subBuildings[q]).before($subBuilding);break;}else if(itemI.count===countArry[q]){if(countArry[q]===countArry[countArry.length-1]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$('#subList_'+itemI.buildingId).append($subBuilding);break;}else{for(var p=q;p<countArry.length;p++){if(itemI.count<countArry[p]){$subBuilding=$('<div class="div-nav-row subBuilding" count="'+itemI.count+'"><span class="div-row-icon-badge grow subBuildingItem" pageId="'+itemI.pageId+'" id="navFloor-'+itemI.id+'"></span>'+countHtml+'</div>');$subBuilding.find('.subBuildingItem').html(itemI.subBuildingName);$($subBuildings[p]).before($subBuilding);break;}}
break;}}}}
$dropdownBtn.off('click').on('click',function(){$(this).siblings('.dropdownList').toggleClass('hidden');});$subBuilding.find('.subBuildingItem').off('click').click(function(){var $this=$(this);var id=$this.attr('pageId');AppConfig.zoneId=this.id.split('-')[1];$('.subBuildingItem.selected').removeClass('selected');$this.addClass('selected');$dropdownBtn.html($this.text()+'<span class="caret"></span>');_this.arrLastNotice.length=0;_this.initWorkerForUpdating();$this.closest('.dropdownList').addClass('hidden');});}}
this.statisticFaultCount();$('.subBuildingBtn').off('click').click(function(){$(this).toggleClass('selected');var $subBuildListCur=$(this).siblings('.subBuildingList');if($subBuildListCur.is(':visible')){$subBuildListCur.hide();}else{$subBuildListCur.show();}});},statisticFaultCount:function(){var allCount=0;$('[class ^="div-nav-box"]').each(function(){var warningCount=0,alertCount=0;$(this).children('.subBuildingList').find('.warningCount').not(':empty').each(function(){var text=$(this).text();if(Number(text).toString()!='NaN'){warningCount+=parseInt(text);}});if(warningCount>0){$(this).children('.warningCount').html(warningCount);}else{$(this).children('.warningCount').html('');}
$(this).children('.subBuildingList').find('.alertCount').not(':empty').each(function(){var text=$(this).text();if(Number(text).toString()!='NaN'){alertCount+=parseInt(text);}});if(alertCount>0){$(this).children('.alertCount').html(alertCount);}else{$(this).children('.alertCount').html('');}
allCount+=(warningCount+alertCount);});$('#logWrap #toolBar #btnWarningLog .badge').html(allCount);},createWorkflowOrder:function(notice){var wiInstance;var momentTime=notice.time.toDate();var back=function(){wiInstance=null;};var insertCallback=function(taskModelInfo){var taskTitle=(taskModelInfo&&taskModelInfo.fields)?taskModelInfo.fields.title:'';Alert.success(ElScreenContainer,I18n.resource.workflow.main.THE_WORK_ORDER+' '+taskTitle+' '+I18n.resource.workflow.main.IS_CREATED_SUCCESSFULLY).showAtTop(2000);var $faultCount=$('#btnWarningLog .badge');var faultCount=(function(txt){if(parseInt(txt).toString()!="NaN"){return parseInt(txt);}
return 0;}($faultCount.text()));if(faultCount>0){var count=faultCount-1;count=count>0?count:'';$faultCount.text(count);$('[noticeid="'+notice.id+'"]').remove();if(notice.grade===1){var $warningCount=$('#navFloor-'+AppConfig.zoneId).next('.warningCount');$warningCount.text($warningCount.text()-1);}else if(notice.grade===2){var $alertCount=$('#navFloor-'+AppConfig.zoneId).siblings('.alertCount');$alertCount.text($alertCount.text()-1);}}};var str=notice.description;var arr=notice.detail?notice.detail.split(','):[];var matchRt=str.match(/\{\d\}/g);if(matchRt&&matchRt instanceof Array){matchRt.forEach(function(val,index){str=str.replace(val,arr[index]?arr[index]:'')});}
wiInstance=new WorkflowInsert({noticeId:notice.id,title:notice.name,detail:notice.description,dueDate:new Date(+new Date()+172800000).format('yyyy-MM-dd'),critical:notice.grade,projectId:Number(notice.project),chartPointList:notice.points,chartQueryCircle:'m5',description:str,name:notice.name,time:new Date(momentTime).format('yyyy-MM-dd HH:mm:ss'),chartStartTime:new Date(new Date(momentTime).getTime()-12*60*60*1000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(new Date(momentTime).getTime()+12*60*60*1000).format('yyyy-MM-dd HH:mm:ss')});wiInstance.show().submitSuccess(function(taskModelInfo,uploadFiles){insertCallback(taskModelInfo);this.close();back();}).cancel(function(){back();}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.workflow.main.CREATE_WORKFLOW_FAILED).showAtTop(2000);});return true;},renderPaneNoticeGroup:function(){var _this=this;var urgentCount=0,criticalCount=0,className;this.insertLogGroup();var item,parent;for(var i=0,len=_this.arrLastNotice.length;i<len;i++){item=_this.arrLastNotice[i];var grade=item.grade;if(1==grade){className='adNormal';criticalCount++;}
else if(2==grade){className='faultPro';urgentCount++;}
else{continue;}
_this.insertLogItem(item,i,className);}
_this.criticalCount=_this.arrLastNotice.length;var $btnErr=$('#abNomalP');if($btnErr&&$btnErr.length>0){$btnErr.change();}},insertLogGroup:function(){var $abNomalP=$('#abNomalP');var $faultP=$('#faultP');var $divPaneNoticeItem=$('#divPaneNoticeItem');$divPaneNoticeItem.children().remove();$abNomalP.on('change',function(){var $adNormalOne=$divPaneNoticeItem.find('.adNormal');var $faultProOne=$divPaneNoticeItem.find('.faultPro');if(($abNomalP.is(':checked')&&$faultP.is(':checked'))||((!$abNomalP.is(':checked'))&&(!$faultP.is(':checked')))){$adNormalOne.show();$faultProOne.show();}else if($abNomalP.is(':checked')&&(!$faultP.is(':checked'))){$adNormalOne.show();$faultProOne.hide();}else if((!$abNomalP.is(':checked'))&&$faultP.is(':checked')){$adNormalOne.hide();$faultProOne.show();}});$faultP.on('change',function(){var $adNormalTwo=$divPaneNoticeItem.find('.adNormal');var $faultProTwo=$divPaneNoticeItem.find('.faultPro');if(($abNomalP.is(':checked')&&$faultP.is(':checked'))||((!$abNomalP.is(':checked'))&&(!$faultP.is(':checked')))){$adNormalTwo.show();$faultProTwo.show();}else if($abNomalP.is(':checked')&&(!$faultP.is(':checked'))){$adNormalTwo.show();$faultProTwo.hide();}else if((!$abNomalP.is(':checked'))&&$faultP.is(':checked')){$adNormalTwo.hide();$faultProTwo.show();}});},insertLogItem:function(item,itemNum,className){var divParent=$('#divPaneNoticeItem');var _this=this;var divNotice,equipment,zone,sb,span,textId,spanFirst;equipment=this.dictEquipment[item.equipmentId];textId=equipment.modalTextId;zone=this.dictZone[equipment.zoneId];divNotice=document.createElement('div');divNotice.id='divLog-'+itemNum;divNotice.setAttribute('path',zone.id+'-'+equipment.id);divNotice.setAttribute('faultid',item.faultId);divNotice.setAttribute('noticeId',item.id);if(textId!==null)divNotice.setAttribute('data-modaltextid',textId);divNotice.className='div-pane-log';$(divNotice).addClass(className);var parent=$(divNotice);var $spWrap=$('<div style="white-space: nowrap;">');spanFirst=$('<span>');switch(item.grade){case 0:break;case 1:spanFirst.addClass('badge wrongTag').html(_this.langCfg.LEVEL_SET.CRITICAL);break;case 2:spanFirst.addClass('badge dangerTag').html(_this.langCfg.LEVEL_SET.URGENT);break;default:break;}
$spWrap.append(spanFirst);span=$('<span>').addClass('badge grow span-hover-pointer').attr('title','Equipment name').attr('equipment',equipment.pageId).text(equipment.name);span.click(function(e){});$spWrap.append(span);$('<span>').addClass('badge grow span-hover-pointer').attr({'pageId':zone.pageId,'title':'Zone ID','data-zoneId':zone.id}).text(zone.subBuildingName).click(function(e){}).appendTo($spWrap);$('<span>').attr({'title':'Triggering time','data-time':item.time}).text(timeFormat(item.time,timeFormatChange('mm-dd hh:ii'))).addClass('dateTime').appendTo($spWrap);if(item.orderId&&item.orderId!=0&&item.orderId!=''){}else{$('<span>').addClass('createWorkflowSpan glyphicon glyphicon-share grow span-hover-pointer span-btn').attr('title','Create workflow order').click(function(e){_this.createWorkflowOrder(item);}).appendTo($spWrap);}
$('<span class="feedbackSpan glyphicon glyphicon-comment grow span-hover-pointer span-btn" title="feedback">').eventOn('click',function(e){var itemEquipmentId=item.equipmentId;var diagnosisLength=_this.result.equipments.length;for(var i=0;i<diagnosisLength;i++){if(itemEquipmentId==_this.result.equipments[i].id){var currentEquipmentName=_this.result.equipments[i].name;break;}}
var detailPrefix=I18n.resource.workflow.main.ORDER_EQUIPMENT_NAME+currentEquipmentName+"\n"+
I18n.resource.workflow.main.ORDER_FAULT_INFO+item.description+"\n"+
I18n.resource.workflow.main.ORDER_FEEDBACK_MSG;new WorkflowFeedBack({faultId:item.faultId,title:I18n.resource.workflow.main.FEEDBACK_TITLE+item.name,description:item.description,detailPrefix:detailPrefix,dueDate:new Date((new Date().getTime()+2592000000)).format('yyyy-MM-dd HH:mm:ss'),critical:item.grade,projectId:Number(item.project),chartPointList:item.points,chartQueryCircle:'m5',chartStartTime:new Date(new Date(item.time.toDate()).getTime()-43200000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(new Date(item.time.toDate()).getTime()+43200000).format('yyyy-MM-dd HH:mm:ss')}).show();},'诊断日志反馈').appendTo($spWrap);parent.append($spWrap);$('<p>').addClass('pFaultName').css({'font-weight':'bold','padding':'0 8px 0 0'}).text(item.name).appendTo(parent);var strDesc=item.description;if(item.detail){var arr=item.detail.toString().split(',');for(var j=0;j<arr.length;j++){strDesc=strDesc.replace('{'+j.toString()+'}','<span class="variable"> '+arr[j]+' </span>');}}
$('<p>').html(strDesc).appendTo(parent);divParent.append(parent);},};return ModalDiagnosisPanel;})();var ModalDiagnosisPanelHtml=(function(){function ModalDiagnosisPanelHtml(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.screen=screen;this.entity=entityParams;}
ModalDiagnosisPanelHtml.prototype=Object.create(ModalHtml.prototype);ModalDiagnosisPanelHtml.prototype.constructor=ModalDiagnosisPanelHtml;ModalDiagnosisPanelHtml.prototype.optionTemplate={name:'toolBox.modal.DIAGNOSIS_PANEL',parent:0,mode:[''],maxNum:1,title:'',minHeight:4,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDiagnosisPanelHtml',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};return ModalDiagnosisPanelHtml;})();var ModalDiagnosisStruct=(function(){function ModalDiagnosisStruct(screen,entityParams){this.$configModal=undefined;this.$modal=undefined;this.tempOpt=undefined;this.store={};this.subEntity=undefined;if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalDiagnosisStruct.prototype=new ModalBase();ModalDiagnosisStruct.prototype.optionTemplate={name:'toolBox.modal.DIAGNOSIS_SUMMARY',parent:3,mode:'custom',maxNum:10,title:'',defaultHeight:4.5,defaultWidth:3,minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalDiagnosisStruct',scroll:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':true,'desc':'#DiagSummary'}};ModalDiagnosisStruct.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"type":'option',"widget":[{id:'needDetail',type:'checkbox',name:'是否显示细节'}]},{"module":"dsDrag","data":[{type:'point',name:'KPI分项统计来源',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalDiagnosisStruct.prototype.show=function(){this.init();};ModalDiagnosisStruct.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.needDetail)this.configModalOpt.area[0].widget[0].data=this.entity.modal.option.needDetail;if(this.entity.modal.option.structPoint)this.configModalOpt.area[1].data[0].data=this.entity.modal.option.structPoint;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();}};ModalDiagnosisStruct.prototype.getRealTimePoint=function(list,arr){var _this=this;if(!arr)arr=[];list.forEach(function(item){if(item.point){arr.push(_this.entity.modal.option.prefix+item.point);}
if(item.children instanceof Array&&item.children.length>0){_this.getRealTimePoint(item.children,arr)}});return arr;};ModalDiagnosisStruct.prototype.init=function(){};ModalDiagnosisStruct.prototype.renderModal=function(e){$(this.container).addClass('widgetKPIItemEval');this.container.innerHTML='<div class="divKPIIndex diagnosisCtn"></div><div class="divKPIDetail"></div>';if(this.entity.modal.option.needDetail){this.renderDetailContainer();$(this.container).addClass('showSubContainer');}
this.attachEvent();};ModalDiagnosisStruct.prototype.renderDetailContainer=function(){var containerDetail=this.container.querySelector('.divKPIDetail');var item={modal:{type:'ModalHtml',interval:60000,option:{html:'<div>开发中</div>'},points:[],title:''},spanC:9,spanR:6};this.initSubEntity(containerDetail,item)};ModalDiagnosisStruct.prototype.attachEvent=function(){var _this=this;var clickEvent=AppConfig.isMobile?'tap':'click';$(this.container).off(clickEvent).on(clickEvent,'.divStructTtl',function(e){$(e.currentTarget).parent().toggleClass('focus');});$(this.container).on(clickEvent,'.divStructItem',function(e){var $target=$(e.currentTarget);if($target.hasClass('focus')){$target.removeClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().removeClass('focus')}else{$(_this.container).find('.rowPointDetail.focus').removeClass('focus');$(_this.container).find('.divStructItem.focus').removeClass('focus');$target.addClass('focus');$target.next().hasClass('rowPointDetail')&&$target.next().addClass('focus');_this.refreshSubEntity($target);}});};ModalDiagnosisStruct.prototype.refreshSubEntity=function($target){var arrPoint=[],strPoint;try{arrPoint=$target.data('bindPoints');strPoint=arrPoint.map(function(point){return point.pointname}).toString();}catch(e){strPoint='数据格式不符合'}
var _this=this;this.subEntity.entity.modal.points=arrPoint.map(function(point){return(_this.entity.modal.option.prefix+point.point)});this.subEntity.entity.modal.option.html='<div>'+strPoint+'</div><script>this.onUpdateComplete=function(data){console.log(data)}</script>';this.updateSubEntity();};ModalDiagnosisStruct.prototype.updateSubEntity=function($target){this.subEntity.render();};ModalDiagnosisStruct.prototype.initPointMap=function(points){var _this=this;var $dom;points.forEach(function(point){_this.initPointDetail(point.dsItemId,point.data)})};ModalDiagnosisStruct.prototype.initPointDetail=function(id,strData){var $dom=$('[data-point="'+id+'"]');if($dom.length==0)return;var data;if(!isNaN(Number(strData))){data={score:Number(strData)}}else{try{data=JSON.parse(strData)}catch(e){$dom.text('No Data');$('.pointDetail[data-detail="'+id+'"]').text('No Data');return;}}
var status='';if(parseFloat(data.score)>=60){status='success';$dom.text(parseFloat(data.score)+'%');}else if(parseInt(data.score)>=0){status='danger';$dom.text(parseFloat(data.score)+'%');}else{status='default';$dom.text('--');}
$dom.removeClass('success danger default').addClass(status);var $detail=$('.pointDetail[data-detail="'+id+'"]');if($detail.length>0){$detail.removeClass('success danger default').addClass(status);$detail.text(data.detail);}
if($dom.hasClass('spItemInfo')){$dom.next().removeClass('success danger default').addClass(status)}};ModalDiagnosisStruct.prototype.initStruct=function(struct){var _this=this;var structDom=this.container.querySelector('[data-item="'+struct.name+'"]');if(!structDom){structDom=document.createElement('div');structDom.className='divStructCtn focus';structDom.dataset.item=struct.name;var structTtl=document.createElement('div');structTtl.className='divStructTtl';structTtl.innerHTML='\
            <span class="spStructIcon glyphicon glyphicon-dashboard"></span>\
            <span class="spStructName">'+struct.name+'</span>\
            <!--<span class="pointDetail" data-detail="'+(struct.point?_this.entity.modal.option.prefix+struct.point:'')+'"></span>-->';var structBody=document.createElement('div');structBody.className='divStuctBody';if((struct.items instanceof Array)&&struct.items.length>0){struct.items.forEach(function(item,index){structBody.appendChild(_this.createStructItem(item));})}
structDom.appendChild(structTtl);structDom.appendChild(structBody);this.container.querySelector('.diagnosisCtn').appendChild(structDom);}};ModalDiagnosisStruct.prototype.createStructItem=function(item){var structItem=document.createElement('div');structItem.className='divStructItem';structItem.innerHTML='\
            <span class="spItemInfo">'+(item.name?item.name:'')+'</span>\
            <span class="spItemInfo">'+(item.result?item.result:'')+'</span>\
            <span class="spItemInfo spItemKPIRs">'+(item.description?item.description:'')+'</span>';$(structItem).data('bindPoints',item.bindPoints);return structItem;};ModalDiagnosisStruct.prototype.updateModal=function(points){this.spinner.stop();if(!(points[0]&&points[0].dsItemId))return;var structList;var _this=this;try{structList=JSON.parse(points[0].data).content;}catch(e){return;}
structList.forEach(function(struct){_this.initStruct(struct);});this.store.structList=structList;};ModalDiagnosisStruct.prototype.showConfigMode=function(){};ModalDiagnosisStruct.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];this.entity.modal.option.prefix='@'+AppConfig.project.bindId+'|';};return ModalDiagnosisStruct;})();﻿var ModalRealtimeWeather=(function(){var weatherImgs={yin:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.291,34.467C70.5,26.344,61.767,21.32,52.311,21.32c-12.728,0-23.524,8.832-26.105,21.158  c-6.569,2.188-11.324,8.382-11.324,15.676c0,9.111,7.414,16.525,16.526,16.525c3.289,0,6.415-0.945,9.119-2.745  c3.647,1.8,7.688,2.745,11.785,2.745c4.251,0,8.451-1.029,12.205-2.966c3.149,1.939,6.733,2.966,10.492,2.966  c11.089,0,20.11-9.021,20.11-20.109C95.118,43.577,86.249,34.621,75.291,34.467z M75.007,69.104c-3.247,0-6.315-1.046-8.877-3.023  c-1.219-0.941-2.969-0.716-3.91,0.503c-0.018,0.021-0.027,0.047-0.045,0.07c-3.019,1.6-6.42,2.45-9.865,2.45  c-3.653,0-7.255-0.947-10.41-2.74c-0.795-0.451-1.713-0.461-2.488-0.123c-0.447,0.072-0.883,0.245-1.263,0.542  c-1.94,1.519-4.271,2.32-6.744,2.32c-6.038,0-10.95-4.911-10.95-10.949s4.912-10.951,10.95-10.951c3.048,0,5.979,1.285,8.048,3.521  c1.044,1.132,2.809,1.201,3.938,0.157c1.131-1.045,1.202-2.809,0.157-3.938c-2.941-3.187-7.042-5.088-11.354-5.296  C34.91,32.951,42.94,26.893,52.31,26.893c6.688,0,12.931,3.178,16.885,8.443c-2.639,0.797-5.108,2.118-7.232,3.93  c-1.171,0.999-1.311,2.761-0.313,3.932c1,1.172,2.762,1.31,3.932,0.31c2.624-2.239,5.973-3.472,9.428-3.472  c8.014,0,14.535,6.52,14.535,14.534C89.542,62.584,83.021,69.104,75.007,69.104z"/>\
                </g>\
                </svg>',dayu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.293,23.69c-4.791-8.123-13.525-13.147-22.981-13.147c-12.726,0-23.525,8.832-26.107,21.159   c-6.568,2.188-11.323,8.381-11.323,15.675c0,9.112,7.414,16.526,16.525,16.526c3.289,0,6.415-0.945,9.119-2.744   c3.648,1.797,7.689,2.744,11.786,2.744c4.25,0,8.452-1.029,12.206-2.966c3.149,1.938,6.732,2.966,10.492,2.966   c11.088,0,20.108-9.021,20.108-20.11C95.118,32.798,86.251,23.841,75.293,23.69z M75.01,58.326c-3.246,0-6.315-1.045-8.877-3.023   c-1.22-0.941-2.971-0.717-3.91,0.503c-0.019,0.021-0.027,0.047-0.043,0.069c-3.021,1.601-6.422,2.451-9.867,2.451   c-3.656,0-7.256-0.947-10.411-2.74c-0.794-0.453-1.713-0.461-2.491-0.123c-0.444,0.074-0.879,0.244-1.26,0.543   c-1.938,1.52-4.271,2.32-6.743,2.32c-6.038,0-10.951-4.912-10.951-10.95c0-6.038,4.913-10.951,10.951-10.951   c3.045,0,5.979,1.285,8.047,3.523c1.047,1.131,2.81,1.202,3.939,0.156c1.131-1.045,1.201-2.81,0.156-3.938   c-2.942-3.185-7.043-5.086-11.354-5.294c2.718-8.697,10.748-14.755,20.117-14.755c6.69,0,12.929,3.177,16.885,8.443   c-2.64,0.797-5.109,2.118-7.233,3.93c-1.17,0.999-1.311,2.76-0.312,3.931c0.999,1.172,2.759,1.311,3.931,0.311   c2.624-2.239,5.973-3.472,9.43-3.472c8.014,0,14.533,6.52,14.533,14.534C89.544,51.806,83.023,58.326,75.01,58.326z"/>\
                    <path d="M44.751,79.875c0,3.084-2.5,5.582-5.583,5.582s-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S44.751,76.791,44.751,79.875z"/>\
                    <path d="M59.557,79.875c0,3.084-2.5,5.582-5.582,5.582c-3.084,0-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S59.557,76.791,59.557,79.875z"/>\
                    <path d="M74.362,79.875c0,3.084-2.499,5.582-5.583,5.582c-3.083,0-5.583-2.498-5.583-5.582   s5.583-11.408,5.583-11.408S74.362,76.791,74.362,79.875z"/>\
                </g>\
                </svg>',baoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.292,23.756c-4.791-8.123-13.524-13.146-22.98-13.146c-12.729,0-23.527,8.832-26.107,21.159   c-6.569,2.187-11.324,8.381-11.324,15.675c0,9.112,7.414,16.526,16.526,16.526c3.29,0,6.416-0.946,9.118-2.745   c3.648,1.799,7.69,2.745,11.787,2.745c4.25,0,8.452-1.03,12.206-2.967c3.148,1.939,6.731,2.967,10.492,2.967   c11.088,0,20.109-9.021,20.109-20.11C95.119,32.865,86.25,23.909,75.292,23.756z M75.008,58.394c-3.246,0-6.316-1.046-8.878-3.024   c-1.219-0.94-2.969-0.716-3.909,0.503c-0.019,0.021-0.027,0.047-0.045,0.07c-3.02,1.6-6.421,2.451-9.865,2.451   c-3.655,0-7.256-0.948-10.412-2.741c-0.795-0.451-1.713-0.461-2.49-0.122c-0.445,0.074-0.881,0.244-1.261,0.542   c-1.94,1.519-4.271,2.321-6.743,2.321c-6.038,0-10.951-4.912-10.951-10.95s4.913-10.951,10.951-10.951   c3.046,0,5.979,1.285,8.047,3.522c1.044,1.132,2.808,1.2,3.938,0.156c1.132-1.045,1.202-2.809,0.157-3.938   c-2.94-3.187-7.042-5.087-11.354-5.295c2.717-8.697,10.748-14.755,20.118-14.755c6.688,0,12.928,3.177,16.884,8.442   c-2.641,0.797-5.11,2.118-7.234,3.931c-1.171,0.999-1.31,2.76-0.313,3.931c1,1.172,2.762,1.31,3.932,0.31   c2.623-2.238,5.973-3.472,9.428-3.472c8.016,0,14.535,6.521,14.535,14.534C89.543,51.872,83.021,58.394,75.008,58.394z"/>\
                    <path d="M30.448,85.391c-0.531,0-1.067-0.149-1.543-0.47c-1.281-0.854-1.628-2.584-0.773-3.864l9.026-13.539   c0.854-1.28,2.584-1.629,3.865-0.772c1.281,0.854,1.627,2.584,0.773,3.865L32.77,84.151C32.232,84.955,31.348,85.391,30.448,85.391   z"/>\
                    <path d="M45.313,85.391c-0.53,0-1.067-0.149-1.543-0.47c-1.281-0.854-1.627-2.584-0.772-3.864l9.026-13.539   c0.854-1.28,2.585-1.629,3.865-0.772c1.281,0.854,1.627,2.584,0.773,3.865l-9.026,13.541   C47.099,84.955,46.214,85.391,45.313,85.391z"/>\
                    <path d="M60.182,85.391c-0.53,0-1.067-0.149-1.543-0.47c-1.283-0.854-1.627-2.584-0.772-3.864l9.024-13.539   c0.854-1.28,2.586-1.629,3.867-0.772c1.279,0.854,1.627,2.584,0.772,3.865l-9.027,13.541   C61.967,84.955,61.083,85.391,60.182,85.391z"/>\
                </g>\
                </svg>',duoyun:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <g>\
                            <path d="M59.271,34.332c-4.592-8.123-12.961-13.146-22.021-13.146c-12.197,0-22.546,8.832-25.019,21.159    C5.936,44.531,1.379,50.726,1.379,58.02c0,9.111,7.104,16.525,15.836,16.525c3.152,0,6.148-0.945,8.739-2.745    c3.495,1.8,7.368,2.745,11.295,2.745c4.074,0,8.098-1.029,11.696-2.966c3.017,1.939,6.451,2.966,10.053,2.966    c10.627,0,19.271-9.021,19.271-20.109C78.271,43.441,69.772,34.485,59.271,34.332z M58.998,68.97    c-3.109,0-6.051-1.047-8.506-3.024c-1.168-0.94-2.845-0.715-3.747,0.503c-0.017,0.021-0.025,0.047-0.042,0.07    c-2.893,1.601-6.153,2.452-9.453,2.452c-3.504,0-6.953-0.948-9.977-2.741c-0.759-0.45-1.639-0.46-2.384-0.123    c-0.428,0.074-0.846,0.244-1.211,0.542c-1.86,1.519-4.096,2.321-6.463,2.321c-5.787,0-10.494-4.912-10.494-10.95    s4.707-10.951,10.494-10.951c2.92,0,5.729,1.285,7.711,3.521c1.003,1.134,2.692,1.202,3.775,0.157    c1.084-1.045,1.15-2.809,0.147-3.938c-2.817-3.187-6.749-5.087-10.88-5.295c2.604-8.697,10.3-14.755,19.277-14.755    c6.411,0,12.39,3.177,16.181,8.442c-2.528,0.797-4.897,2.118-6.934,3.93c-1.121,0.999-1.254,2.761-0.296,3.932    c0.959,1.171,2.645,1.31,3.767,0.31c2.514-2.238,5.722-3.472,9.033-3.472c7.682,0,13.93,6.52,13.93,14.534    C72.928,62.448,66.68,68.97,58.998,68.97z"/>\
                            <g>\
                                <path d="M93.438,42.01c-3.744-6.411-10.431-10.365-17.66-10.365c-3.071,0-6.082,0.715-8.819,2.063     c1.803,1.117,3.451,2.482,4.896,4.05c1.271-0.351,2.588-0.537,3.923-0.537c4.587,0,8.882,2.146,11.767,5.744     c-1.765,0.665-3.414,1.654-4.861,2.941c-1.121,1-1.254,2.759-0.297,3.931c0.957,1.17,2.644,1.312,3.767,0.313     c1.874-1.67,4.269-2.59,6.735-2.59c5.729,0,10.388,4.861,10.388,10.839c0,5.977-4.659,10.84-10.388,10.84     c-2.319,0-4.514-0.78-6.344-2.256c-1.148-0.927-2.791-0.718-3.701,0.452c-2.168,1.176-4.6,1.804-7.064,1.804     c-0.736,0-1.473-0.063-2.195-0.17c-1.275,1.733-2.77,3.286-4.441,4.603c2.129,0.752,4.373,1.145,6.638,1.145     c3.188,0,6.343-0.781,9.181-2.25c2.396,1.469,5.099,2.25,7.93,2.25c8.675,0,15.73-7.365,15.73-16.416     C108.619,49.538,101.856,42.316,93.438,42.01z"/>\
                            </g>\
                        </g>\
                        <path d="M59.271,34.332c-4.592-8.123-12.961-13.146-22.021-13.146c-12.197,0-22.546,8.832-25.019,21.159   C5.936,44.531,1.379,50.726,1.379,58.02c0,9.111,7.104,16.525,15.836,16.525c3.152,0,6.148-0.945,8.739-2.745   c3.495,1.8,7.368,2.745,11.295,2.745c4.074,0,8.098-1.029,11.696-2.966c3.017,1.939,6.451,2.966,10.053,2.966   c10.627,0,19.271-9.021,19.271-20.109C78.271,43.441,69.772,34.485,59.271,34.332z M58.998,68.97c-3.109,0-6.051-1.047-8.506-3.024   c-1.168-0.94-2.845-0.715-3.747,0.503c-0.017,0.021-0.025,0.047-0.042,0.07c-2.893,1.601-6.153,2.452-9.453,2.452   c-3.504,0-6.953-0.948-9.977-2.741c-0.759-0.45-1.639-0.46-2.384-0.123c-0.428,0.074-0.846,0.244-1.211,0.542   c-1.86,1.519-4.096,2.321-6.463,2.321c-5.787,0-10.494-4.912-10.494-10.95s4.707-10.951,10.494-10.951   c2.92,0,5.729,1.285,7.711,3.521c1.003,1.134,2.692,1.202,3.775,0.157c1.084-1.045,1.15-2.809,0.147-3.938   c-2.817-3.187-6.749-5.087-10.88-5.295c2.604-8.697,10.3-14.755,19.277-14.755c6.411,0,12.39,3.177,16.181,8.442   c-2.528,0.797-4.897,2.118-6.934,3.93c-1.121,0.999-1.254,2.761-0.296,3.932c0.959,1.171,2.645,1.31,3.767,0.31   c2.514-2.238,5.722-3.472,9.033-3.472c7.682,0,13.93,6.52,13.93,14.534C72.928,62.448,66.68,68.97,58.998,68.97z"/>\
                    </g>\
                    </svg>',xiaoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.293,23.69c-4.791-8.123-13.523-13.147-22.98-13.147c-12.727,0-23.526,8.831-26.107,21.159   c-6.567,2.188-11.323,8.382-11.323,15.675c0,9.112,7.414,16.526,16.525,16.526c3.289,0,6.415-0.945,9.119-2.744   c3.647,1.799,7.688,2.744,11.786,2.744c4.25,0,8.451-1.029,12.205-2.966c3.147,1.938,6.731,2.966,10.492,2.966   c11.09,0,20.108-9.021,20.108-20.11C95.118,32.798,86.25,23.842,75.293,23.69z M75.009,58.326c-3.246,0-6.316-1.047-8.877-3.023   c-1.22-0.941-2.971-0.717-3.91,0.501c-0.02,0.021-0.027,0.048-0.045,0.069c-2.15,1.142-4.495,1.896-6.912,2.238l-6.184-0.043   c-2.521-0.39-4.963-1.224-7.183-2.482c-0.795-0.453-1.716-0.463-2.493-0.121c-0.443,0.074-0.877,0.244-1.256,0.539   c-1.942,1.52-4.274,2.322-6.745,2.322c-6.038,0-10.951-4.912-10.951-10.951c0-6.038,4.913-10.951,10.951-10.951   c3.046,0,5.979,1.285,8.048,3.523c1.044,1.13,2.811,1.2,3.939,0.156c1.129-1.044,1.2-2.81,0.155-3.938   c-2.941-3.185-7.043-5.086-11.354-5.294c2.716-8.697,10.747-14.755,20.116-14.755c6.689,0,12.929,3.177,16.885,8.443   c-2.639,0.797-5.107,2.118-7.232,3.93c-1.173,1-1.313,2.76-0.313,3.931c0.997,1.17,2.758,1.312,3.93,0.313   c2.625-2.24,5.975-3.473,9.431-3.473c8.015,0,14.534,6.519,14.534,14.534C89.544,51.808,83.024,58.326,75.009,58.326z"/>\
                    <path d="M59.558,79.875c0,3.084-2.5,5.582-5.583,5.582s-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S59.558,76.791,59.558,79.875z"/>\
                </g>\
                </svg>',qing_duoyun:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <g>\
                        <g>\
                            <path d="M90.923,16.534c1.333,0.771,1.79,2.479,1.021,3.811l-3.938,6.816c-0.77,1.334-2.475,1.791-3.809,1.021     c-1.332-0.771-1.79-2.477-1.02-3.811l3.938-6.814C87.885,16.225,89.588,15.768,90.923,16.534z"/>\
                        </g>\
                        <g>\
                            <path d="M103.951,29.564c0.771,1.334,0.313,3.039-1.021,3.809l-6.818,3.938c-1.332,0.771-3.039,0.313-3.809-1.02     c-0.77-1.336-0.314-3.039,1.02-3.811l6.818-3.938C101.477,27.773,103.18,28.232,103.951,29.564z"/>\
                        </g>\
                        <g>\
                            <path d="M108.721,47.36c0,1.541-1.25,2.787-2.787,2.787h-7.873c-1.541,0.002-2.789-1.248-2.789-2.787     c0-1.541,1.248-2.785,2.789-2.787l7.873,0.002C107.471,44.575,108.719,45.819,108.721,47.36z"/>\
                        </g>\
                        <g>\
                            <path d="M103.951,65.157c-0.77,1.334-2.475,1.789-3.809,1.021l-6.817-3.938c-1.333-0.77-1.79-2.475-1.021-3.807     c0.771-1.336,2.475-1.791,3.809-1.021l6.818,3.938C104.266,62.118,104.721,63.823,103.951,65.157z"/>\
                        </g>\
                        <path d="M62.053,28.184c-1.332,0.77-3.037,0.313-3.808-1.021l-3.937-6.818c-0.771-1.332-0.314-3.035,1.02-3.809    c1.333-0.77,3.038-0.313,3.807,1.021l3.938,6.814C63.844,25.708,63.387,27.413,62.053,28.184z"/>\
                        <g>\
                            <path d="M73.126,25.215c-1.541,0-2.788-1.247-2.788-2.787v-7.873c0-1.539,1.247-2.787,2.788-2.787     c1.54,0,2.787,1.248,2.787,2.787v7.873C75.913,23.969,74.666,25.215,73.126,25.215z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M61.691,44.021c-4.791-8.123-13.524-13.15-22.981-13.15c-12.727,0-23.525,8.83-26.105,21.16    C6.035,54.22,1.279,60.412,1.279,67.707c0,9.111,7.414,16.525,16.526,16.525c3.29,0,6.415-0.947,9.118-2.746    c3.648,1.799,7.691,2.746,11.787,2.746c4.251,0,8.451-1.031,12.205-2.965c3.15,1.938,6.732,2.965,10.493,2.965    c11.088,0,20.108-9.021,20.108-20.109C81.518,53.127,72.648,44.172,61.691,44.021z M61.406,78.654    c-3.247,0-6.317-1.045-8.879-3.025c-1.217-0.939-2.969-0.715-3.909,0.505c-0.017,0.022-0.027,0.048-0.046,0.067    c-3.02,1.604-6.42,2.453-9.864,2.453c-3.655,0-7.255-0.945-10.411-2.742c-0.792-0.449-1.71-0.457-2.485-0.121    c-0.447,0.074-0.884,0.244-1.266,0.541c-1.939,1.521-4.271,2.322-6.742,2.322c-6.038,0-10.951-4.912-10.951-10.949    c0-6.039,4.913-10.951,10.951-10.951c3.047,0,5.979,1.283,8.048,3.523c1.045,1.131,2.809,1.201,3.938,0.156    s1.201-2.809,0.156-3.939c-2.942-3.186-7.042-5.086-11.354-5.295c2.719-8.697,10.748-14.754,20.117-14.754    c6.688,0,12.929,3.176,16.884,8.441c-2.638,0.799-5.109,2.117-7.232,3.932c-1.17,0.998-1.312,2.76-0.312,3.93    s2.761,1.311,3.931,0.313c2.625-2.24,5.973-3.475,9.429-3.475c8.014,0,14.534,6.521,14.534,14.535    C75.941,72.134,69.421,78.654,61.406,78.654z"/>\
                        <g>\
                            <path d="M91.902,47.586c0-10.354-8.422-18.775-18.775-18.775c-5.336,0.002-10.3,2.225-13.822,6.068     c1.295,1.174,2.498,2.453,3.584,3.846c2.557-2.959,6.254-4.684,10.238-4.686c7.469,0,13.544,6.076,13.544,13.547     c0,3.023-0.987,5.854-2.702,8.139c0.727,1.932,1.217,3.977,1.42,6.1C89.443,58.344,91.902,53.208,91.902,47.586z"/>\
                            <g>\
                                <path d="M91.943,74.377l-3.938-6.816c-0.55-0.951-1.574-1.445-2.604-1.379c-0.172,2.033-0.6,3.998-1.25,5.855      l2.961,5.126c0.77,1.334,2.475,1.791,3.808,1.021C92.256,77.414,92.713,75.711,91.943,74.377z"/>\
                            </g>\
                        </g>\
                    </g>\
                    <path d="M61.691,44.021c-4.791-8.123-13.524-13.15-22.981-13.15c-12.727,0-23.525,8.83-26.105,21.16   C6.035,54.22,1.279,60.412,1.279,67.707c0,9.111,7.414,16.525,16.526,16.525c3.29,0,6.415-0.947,9.118-2.746   c3.648,1.799,7.691,2.746,11.787,2.746c4.251,0,8.451-1.031,12.205-2.965c3.15,1.938,6.732,2.965,10.493,2.965   c11.088,0,20.108-9.021,20.108-20.109C81.518,53.127,72.648,44.172,61.691,44.021z M61.406,78.654   c-3.247,0-6.317-1.045-8.879-3.025c-1.217-0.939-2.969-0.715-3.909,0.505c-0.017,0.022-0.027,0.048-0.046,0.067   c-3.02,1.604-6.42,2.453-9.864,2.453c-3.655,0-7.255-0.945-10.411-2.742c-0.792-0.449-1.71-0.457-2.485-0.121   c-0.447,0.074-0.884,0.244-1.266,0.541c-1.939,1.521-4.271,2.322-6.742,2.322c-6.038,0-10.951-4.912-10.951-10.949   c0-6.039,4.913-10.951,10.951-10.951c3.047,0,5.979,1.283,8.048,3.523c1.045,1.131,2.809,1.201,3.938,0.156   s1.201-2.809,0.156-3.939c-2.942-3.186-7.042-5.086-11.354-5.295c2.719-8.697,10.748-14.754,20.117-14.754   c6.688,0,12.929,3.176,16.884,8.441c-2.638,0.799-5.109,2.117-7.232,3.932c-1.17,0.998-1.312,2.76-0.312,3.93   s2.761,1.311,3.931,0.313c2.625-2.24,5.973-3.475,9.429-3.475c8.014,0,14.534,6.521,14.534,14.535   C75.941,72.134,69.421,78.654,61.406,78.654z"/>\
                </g>\
                </svg>',qing:'<svg style="fill: #eee;"  x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
				<g>\
					<path d="M54.999,67c-10.354,0-18.776-8.424-18.776-18.774c0-10.354,8.425-18.776,18.776-18.776   c10.354,0,18.775,8.424,18.775,18.776C73.776,58.576,65.354,67,54.999,67z M54.999,34.681c-7.469,0-13.545,6.076-13.545,13.545   c0,7.47,6.076,13.545,13.545,13.545c7.468,0,13.545-6.075,13.545-13.545C68.544,40.756,62.468,34.681,54.999,34.681z"/>\
					<g>\
						<g>\
							<path d="M43.927,67.176c1.333,0.771,1.79,2.479,1.021,3.811l-3.938,6.816c-0.769,1.332-2.476,1.791-3.808,1.023     c-1.334-0.773-1.791-2.479-1.021-3.813l3.938-6.818C40.889,66.865,42.594,66.408,43.927,67.176z"/>\
							<path d="M72.796,17.174c1.333,0.771,1.79,2.476,1.021,3.81l-3.938,6.815c-0.771,1.334-2.476,1.791-3.808,1.022     c-1.334-0.77-1.791-2.475-1.021-3.809l3.938-6.818C69.758,16.861,71.462,16.404,72.796,17.174z"/>\
						</g>\
						<g>\
							<path d="M35.821,59.07c0.771,1.334,0.313,3.039-1.021,3.811l-6.817,3.936c-1.334,0.77-3.039,0.313-3.81-1.02     c-0.771-1.334-0.313-3.036,1.021-3.809l6.816-3.938C33.346,57.281,35.052,57.738,35.821,59.07z"/>\
							<path d="M85.825,30.204c0.77,1.334,0.313,3.039-1.021,3.807l-6.816,3.938c-1.334,0.77-3.039,0.313-3.811-1.021     c-0.77-1.336-0.313-3.039,1.021-3.809l6.816-3.938C83.351,28.413,85.054,28.87,85.825,30.204z"/>\
						</g>\
						<g>\
							<path d="M32.854,48c0,1.539-1.246,2.785-2.787,2.785h-7.873c-1.539,0-2.787-1.248-2.787-2.785     c0-1.541,1.246-2.787,2.787-2.787l7.873-0.002C31.608,45.211,32.854,46.459,32.854,48z"/>\
							<path d="M90.593,48c0,1.539-1.248,2.785-2.788,2.785h-7.872c-1.541,0.002-2.787-1.248-2.787-2.785     c0-1.541,1.246-2.787,2.787-2.789l7.872,0.002C89.345,45.213,90.593,46.459,90.593,48z"/>\
						</g>\
						<g>\
							<path d="M35.821,36.926c-0.771,1.336-2.475,1.791-3.809,1.021l-6.816-3.938c-1.334-0.768-1.791-2.473-1.021-3.807     c0.771-1.334,2.477-1.791,3.809-1.021l6.817,3.938C36.134,33.89,36.591,35.595,35.821,36.926z"/>\
							<path d="M85.825,65.797c-0.771,1.334-2.475,1.789-3.811,1.02l-6.816-3.936c-1.332-0.77-1.791-2.477-1.021-3.809     c0.771-1.334,2.476-1.791,3.81-1.021l6.817,3.937C86.137,62.758,86.594,64.463,85.825,65.797z"/>\
						</g>\
						<g>\
							<path d="M43.927,28.822c-1.334,0.769-3.038,0.312-3.809-1.021l-3.938-6.817c-0.77-1.334-0.313-3.037,1.021-3.808     c1.332-0.771,3.037-0.313,3.808,1.021l3.938,6.818C45.717,26.349,45.26,28.054,43.927,28.822z"/>\
							<path d="M72.796,78.824c-1.333,0.771-3.038,0.313-3.809-1.021l-3.938-6.815c-0.77-1.334-0.313-3.039,1.021-3.809     c1.332-0.77,3.037-0.313,3.808,1.021l3.938,6.816C74.586,76.35,74.129,78.053,72.796,78.824z"/>\
						</g>\
						<g>\
							<path d="M54.999,25.854c-1.54,0-2.788-1.248-2.788-2.787v-7.873c0-1.538,1.248-2.786,2.788-2.786     c1.539,0,2.787,1.248,2.787,2.786v7.873C57.788,24.607,56.54,25.854,54.999,25.854z"/>\
							<path d="M54.999,83.592c-1.54,0-2.788-1.246-2.788-2.787v-7.871c0-1.541,1.248-2.789,2.788-2.789     c1.539,0,2.787,1.248,2.787,2.789v7.871C57.788,82.346,56.54,83.592,54.999,83.592z"/>\
						</g>\
					</g>\
				</g>\
			</svg>',duoyun_zhenyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                        <g>\
                            <g>\
                                <g>\
                                    <g>\
                                        <path d="M90.924,5.36c1.334,0.771,1.791,2.476,1.021,3.81l-3.938,6.817c-0.77,1.334-2.475,1.791-3.809,1.021      c-1.332-0.771-1.789-2.476-1.021-3.81l3.939-6.815C87.885,5.049,89.59,4.592,90.924,5.36z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M103.953,18.39c0.77,1.334,0.313,3.039-1.021,3.807l-6.818,3.938c-1.332,0.771-3.037,0.313-3.809-1.021      c-0.77-1.334-0.313-3.039,1.021-3.809l6.818-3.938C101.477,16.599,103.18,17.056,103.953,18.39z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M108.721,36.187c0,1.541-1.248,2.787-2.787,2.787h-7.873c-1.543,0-2.787-1.248-2.787-2.787      c0-1.541,1.244-2.787,2.785-2.787h7.873C107.473,33.399,108.719,34.646,108.721,36.187z"/>\
                                    </g>\
                                    <g>\
                                        <path d="M103.953,53.983c-0.771,1.334-2.477,1.789-3.811,1.021l-6.816-3.937      c-1.334-0.771-1.791-2.476-1.021-3.808c0.771-1.336,2.477-1.79,3.809-1.021l6.816,3.938      C104.264,50.944,104.721,52.649,103.953,53.983z"/>\
                                    </g>\
                                    <path d="M62.053,17.008c-1.332,0.771-3.037,0.313-3.807-1.021l-3.938-6.818c-0.77-1.334-0.313-3.037,1.021-3.808     c1.332-0.771,3.037-0.313,3.807,1.021l3.939,6.815C63.844,14.534,63.387,16.239,62.053,17.008z"/>\
                                    <g>\
                                        <path d="M73.127,14.041c-1.539,0-2.787-1.247-2.787-2.788V3.38c0-1.539,1.248-2.786,2.787-2.786      c1.541,0,2.789,1.247,2.789,2.786v7.873C75.916,12.794,74.668,14.041,73.127,14.041z"/>\
                                    </g>\
                                </g>\
                                <g>\
                                    <path d="M61.691,32.845c-4.791-8.121-13.523-13.148-22.98-13.148c-12.729,0-23.527,8.83-26.107,21.16     C6.035,43.043,1.279,49.235,1.279,56.532c0,9.111,7.414,16.523,16.525,16.523c3.291,0,6.416-0.945,9.121-2.742     c3.646,1.797,7.689,2.742,11.785,2.742c4.252,0,8.453-1.031,12.207-2.966c3.148,1.938,6.73,2.966,10.492,2.966     c11.088,0,20.107-9.021,20.107-20.109C81.516,41.952,72.65,32.998,61.691,32.845z M61.408,67.48     c-3.246,0-6.316-1.045-8.879-3.025c-1.219-0.939-2.971-0.716-3.91,0.505c-0.018,0.021-0.027,0.047-0.043,0.067     c-3.02,1.604-6.422,2.453-9.867,2.453c-3.654,0-7.254-0.947-10.41-2.742c-0.793-0.449-1.711-0.459-2.488-0.121     c-0.445,0.074-0.883,0.244-1.264,0.541c-1.939,1.521-4.271,2.322-6.744,2.322c-6.039,0-10.951-4.912-10.951-10.949     c0-6.041,4.914-10.953,10.951-10.953c3.047,0,5.98,1.285,8.047,3.523c1.045,1.133,2.811,1.203,3.941,0.155     c1.131-1.043,1.199-2.808,0.154-3.938c-2.939-3.187-7.043-5.088-11.354-5.295c2.717-8.697,10.748-14.756,20.115-14.756     c6.689,0,12.93,3.178,16.885,8.442c-2.639,0.799-5.109,2.116-7.234,3.931c-1.172,1-1.311,2.76-0.311,3.932     c1,1.17,2.76,1.31,3.93,0.312c2.623-2.239,5.973-3.474,9.43-3.474c8.014,0,14.533,6.521,14.533,14.533S69.422,67.48,61.408,67.48     z"/>\
                                    <g>\
                                        <path d="M91.904,36.411c0-10.354-8.424-18.773-18.777-18.773c-5.336,0-10.301,2.225-13.822,6.068      c1.295,1.173,2.498,2.453,3.584,3.846c2.557-2.96,6.254-4.684,10.238-4.686c7.469,0,13.547,6.076,13.547,13.545      c0,3.025-0.99,5.854-2.705,8.141c0.727,1.932,1.217,3.977,1.42,6.098C89.445,47.166,91.904,42.034,91.904,36.411z"/>\
                                        <g>\
                                            <path d="M91.945,63.203l-3.939-6.819c-0.549-0.948-1.574-1.442-2.604-1.377c-0.174,2.034-0.6,3.998-1.248,5.856       l2.959,5.125c0.771,1.336,2.477,1.791,3.809,1.021C92.258,66.24,92.715,64.537,91.945,63.203z"/>\
                                        </g>\
                                    </g>\
                                </g>\
                                <path d="M61.691,32.845c-4.791-8.121-13.523-13.148-22.98-13.148c-12.729,0-23.527,8.83-26.107,21.16    C6.035,43.043,1.279,49.235,1.279,56.532c0,9.111,7.414,16.523,16.525,16.523c3.291,0,6.416-0.945,9.121-2.742    c3.646,1.797,7.689,2.742,11.785,2.742c4.252,0,8.453-1.031,12.207-2.966c3.148,1.938,6.73,2.966,10.492,2.966    c11.088,0,20.107-9.021,20.107-20.109C81.516,41.952,72.65,32.998,61.691,32.845z M61.408,67.48c-3.246,0-6.316-1.045-8.879-3.025    c-1.219-0.939-2.971-0.716-3.91,0.505c-0.018,0.021-0.027,0.047-0.043,0.067c-3.02,1.604-6.422,2.453-9.867,2.453    c-3.654,0-7.254-0.947-10.41-2.742c-0.793-0.449-1.711-0.459-2.488-0.121c-0.445,0.074-0.883,0.244-1.264,0.541    c-1.939,1.521-4.271,2.322-6.744,2.322c-6.039,0-10.951-4.912-10.951-10.949c0-6.041,4.914-10.953,10.951-10.953    c3.047,0,5.98,1.285,8.047,3.523c1.045,1.133,2.811,1.203,3.941,0.155c1.131-1.043,1.199-2.808,0.154-3.938    c-2.939-3.187-7.043-5.088-11.354-5.295c2.717-8.697,10.748-14.756,20.115-14.756c6.689,0,12.93,3.178,16.885,8.442    c-2.639,0.799-5.109,2.116-7.234,3.931c-1.172,1-1.311,2.76-0.311,3.932c1,1.17,2.76,1.31,3.93,0.312    c2.623-2.239,5.973-3.474,9.43-3.474c8.014,0,14.533,6.521,14.533,14.533S69.422,67.48,61.408,67.48z"/>\
                            </g>\
                            <path d="M39.525,89.822c0,3.086-2.5,5.584-5.582,5.584c-3.084,0-5.584-2.498-5.584-5.584   c0-3.082,5.584-11.406,5.584-11.406S39.525,86.74,39.525,89.822z"/>\
                            <path d="M54.332,89.822c0,3.086-2.5,5.584-5.582,5.584c-3.084,0-5.584-2.498-5.584-5.584   c0-3.082,5.584-11.406,5.584-11.406S54.332,86.74,54.332,89.822z"/>\
                        </g>\
                        </svg>',dalei:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <g>\
                        <path d="M75.294,27.418c-4.791-8.121-13.525-13.146-22.98-13.146c-12.729,0-23.527,8.83-26.107,21.16    c-6.57,2.187-11.324,8.379-11.324,15.674c0,9.11,7.414,16.524,16.525,16.524c3.291,0,6.416-0.945,9.119-2.744    c0.365,0.181,0.738,0.347,1.111,0.508c0.352-0.805,1.945-5.232,1.945-5.232c-0.57-0.261-1.137-0.537-1.682-0.849    c-0.795-0.449-1.51-0.694-2.453-0.248c-0.445,0.073-0.918,0.37-1.301,0.67c-1.938,1.519-4.271,2.319-6.742,2.319    c-6.037,0-10.949-4.912-10.949-10.948c0-6.039,4.912-10.951,10.949-10.951c3.047,0,5.979,1.283,8.047,3.523    c1.047,1.131,2.811,1.201,3.939,0.156s1.199-2.808,0.156-3.938c-2.943-3.187-7.045-5.088-11.354-5.293    c2.717-8.699,10.746-14.756,20.115-14.756c6.689,0,12.93,3.176,16.887,8.441c-2.641,0.801-5.109,2.118-7.234,3.934    c-1.172,0.998-1.311,2.758-0.311,3.928c0.996,1.172,2.758,1.312,3.93,0.312c2.623-2.24,5.973-3.474,9.43-3.474    c8.014,0,14.535,6.521,14.535,14.535c0,8.015-6.521,14.532-14.535,14.532c-2.246,0-4.402-0.51-6.369-1.475    c-0.469,1.172-2.086,5.172-2.086,5.172c2.625,1.228,5.48,1.879,8.455,1.879c11.088,0,20.107-9.021,20.107-20.108    C95.118,36.528,86.251,27.571,75.294,27.418z"/>\
                    </g>\
                    <path d="M56.185,45.789c0.055-0.529-0.09-0.57-0.32-0.093l-9.371,19.437c-0.23,0.479,0.016,0.871,0.545,0.871h6.012   c0.529,0,0.936,0.432,0.896,0.961l-1,14.333c-0.035,0.529,0.129,0.576,0.367,0.103l10.475-20.774c0.24-0.476,0-0.869-0.529-0.881   l-7.525-0.149c-0.527-0.011-0.92-0.451-0.863-0.979L56.185,45.789z"/>\
                </g>\
                </svg>',dalei_baoyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                        <g>\
                            <g>\
                                <g>\
                                    <path d="M75.293,20.978C70.502,12.855,61.768,7.832,52.311,7.832c-12.727,0-23.523,8.83-26.104,21.159     c-6.57,2.187-11.326,8.38-11.326,15.675c0,9.11,7.414,16.524,16.525,16.524c3.289,0,6.416-0.944,9.119-2.744     c0.365,0.181,0.738,0.345,1.111,0.509c0.35-0.806,1.947-5.234,1.947-5.234c-0.572-0.26-1.137-0.535-1.684-0.848     c-0.795-0.449-1.508-0.695-2.453-0.248c-0.445,0.073-0.918,0.373-1.301,0.668c-1.938,1.52-4.27,2.319-6.742,2.319     c-6.037,0-10.949-4.909-10.949-10.946c0-6.039,4.912-10.953,10.949-10.953c3.047,0,5.979,1.285,8.049,3.524     c1.047,1.132,2.809,1.201,3.938,0.156s1.201-2.809,0.156-3.938c-2.939-3.187-7.043-5.089-11.354-5.295     c2.719-8.697,10.748-14.755,20.115-14.755c6.691,0,12.932,3.175,16.887,8.441c-2.641,0.799-5.109,2.119-7.234,3.932     c-1.17,1-1.311,2.759-0.311,3.929c1,1.174,2.76,1.311,3.932,0.313c2.623-2.24,5.971-3.473,9.426-3.473     c8.016,0,14.535,6.521,14.535,14.535c0,8.012-6.521,14.53-14.535,14.53c-2.244,0-4.4-0.511-6.367-1.476     c-0.471,1.174-2.086,5.174-2.086,5.174c2.625,1.229,5.482,1.88,8.453,1.88c11.09,0,20.111-9.021,20.111-20.108     C95.119,30.088,86.252,21.131,75.293,20.978z"/>\
                                </g>\
                                <path d="M56.182,39.349c0.055-0.529-0.09-0.57-0.32-0.092L46.49,58.693c-0.229,0.479,0.018,0.869,0.547,0.869    h6.012c0.531,0,0.936,0.435,0.896,0.961l-1,14.332c-0.035,0.529,0.129,0.576,0.365,0.104l10.479-20.774    c0.236-0.476,0-0.869-0.529-0.881l-7.525-0.15c-0.529-0.01-0.92-0.45-0.865-0.979L56.182,39.349z"/>\
                            </g>\
                            <path d="M69.432,88.168c-0.484,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.965-3.821l5.5-9.219   c0.787-1.322,2.502-1.753,3.82-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.502,9.219C71.307,87.68,70.383,88.168,69.432,88.168z   "/>\
                            <path d="M40.76,88.168c-0.486,0-0.98-0.127-1.426-0.396c-1.322-0.786-1.756-2.495-0.967-3.821l5.5-9.219   c0.789-1.322,2.502-1.753,3.822-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.502,9.219C42.635,87.68,41.709,88.168,40.76,88.168z   "/>\
                            <path d="M26.424,88.168c-0.486,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.967-3.821l5.502-9.219   c0.789-1.322,2.502-1.753,3.82-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.5,9.219C28.299,87.68,27.375,88.168,26.424,88.168z"/>\
                            <path d="M55.096,88.168c-0.486,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.967-3.821l5.5-9.219   c0.789-1.322,2.504-1.753,3.822-0.968c1.322,0.793,1.754,2.502,0.967,3.824l-5.502,9.219C56.971,87.68,56.047,88.168,55.096,88.168   z"/>\
                        </g>\
                        </svg>',daxue:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M75.294,18.086C70.503,9.963,61.771,4.94,52.313,4.94c-12.729,0-23.525,8.828-26.107,21.158   c-6.568,2.187-11.324,8.381-11.324,15.676c0,9.11,7.414,16.524,16.525,16.524c3.291,0,6.416-0.946,9.119-2.745   c3.648,1.797,7.689,2.745,11.787,2.745c4.25,0,8.451-1.032,12.205-2.967c3.146,1.938,6.73,2.967,10.492,2.967   c11.088,0,20.107-9.022,20.107-20.11C95.12,27.196,86.251,18.237,75.294,18.086z M75.011,52.721c-3.248,0-6.316-1.048-8.877-3.022   c-1.219-0.941-2.971-0.716-3.91,0.5c-0.02,0.022-0.027,0.049-0.045,0.073c-3.021,1.599-6.42,2.449-9.865,2.449   c-3.654,0-7.254-0.944-10.41-2.742c-0.795-0.45-1.715-0.461-2.492-0.123c-0.445,0.074-0.881,0.248-1.26,0.546   c-1.939,1.518-4.271,2.319-6.744,2.319c-6.037,0-10.951-4.912-10.951-10.946c0-6.041,4.914-10.955,10.951-10.955   c3.047,0,5.98,1.284,8.047,3.526c1.045,1.129,2.809,1.198,3.939,0.153c1.129-1.045,1.201-2.812,0.156-3.938   c-2.941-3.185-7.043-5.088-11.355-5.295c2.717-8.696,10.748-14.754,20.117-14.754c6.689,0,12.93,3.176,16.885,8.44   c-2.639,0.799-5.111,2.119-7.234,3.932c-1.172,1-1.311,2.763-0.311,3.932c1,1.17,2.76,1.313,3.93,0.313   c2.623-2.241,5.973-3.477,9.428-3.477c8.016,0,14.533,6.521,14.533,14.536C89.544,46.204,83.026,52.721,75.011,52.721z"/>\
                    <g>\
                        <g>\
                            <path d="M45.401,65.618c0.529,0.918,0.217,2.09-0.701,2.621l-10.115,5.84c-0.918,0.528-2.09,0.215-2.617-0.703     c-0.529-0.918-0.217-2.088,0.699-2.619l10.117-5.84C43.7,64.387,44.872,64.702,45.401,65.618z"/>\
                        </g>\
                        <g>\
                            <path d="M45.401,73.375c-0.529,0.918-1.701,1.232-2.619,0.703l-10.115-5.84c-0.918-0.531-1.229-1.703-0.701-2.621     c0.529-0.916,1.701-1.229,2.617-0.701l10.117,5.84C45.616,71.288,45.931,72.457,45.401,73.375z"/>\
                        </g>\
                        <g>\
                            <path d="M38.683,77.255c-1.059,0-1.916-0.856-1.916-1.92v-11.68c0-1.059,0.857-1.918,1.916-1.918     s1.918,0.859,1.918,1.918v11.68C40.601,76.398,39.741,77.255,38.683,77.255z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M76.196,65.618c0.529,0.918,0.215,2.09-0.701,2.621l-10.115,5.84c-0.918,0.528-2.09,0.215-2.619-0.701     c-0.529-0.92-0.215-2.09,0.701-2.621l10.115-5.84C74.495,64.387,75.667,64.702,76.196,65.618z"/>\
                        </g>\
                        <g>\
                            <path d="M76.196,73.375c-0.529,0.918-1.701,1.232-2.617,0.703l-10.117-5.84c-0.916-0.531-1.23-1.703-0.701-2.621     c0.529-0.916,1.701-1.229,2.619-0.701l10.115,5.84C76.411,71.288,76.726,72.457,76.196,73.375z"/>\
                        </g>\
                        <g>\
                            <path d="M69.479,77.255c-1.061,0-1.916-0.856-1.916-1.92v-11.68c0-1.059,0.855-1.918,1.916-1.918     c1.059,0,1.916,0.859,1.916,1.918v11.68C71.396,76.398,70.538,77.255,69.479,77.255z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M60.798,79.425c0.529,0.916,0.217,2.089-0.701,2.615l-10.115,5.842c-0.916,0.527-2.088,0.218-2.619-0.7     c-0.529-0.916-0.215-2.091,0.703-2.619l10.115-5.839C59.097,78.192,60.269,78.505,60.798,79.425z"/>\
                        </g>\
                        <g>\
                            <path d="M60.798,87.182c-0.527,0.918-1.701,1.229-2.617,0.7l-10.115-5.84c-0.918-0.528-1.232-1.701-0.703-2.617     c0.531-0.919,1.703-1.233,2.619-0.702l10.117,5.839C61.013,85.091,61.327,86.266,60.798,87.182z"/>\
                        </g>\
                        <g>\
                            <path d="M54.079,91.06c-1.059,0-1.916-0.857-1.916-1.916V77.462c0-1.059,0.857-1.916,1.916-1.916     c1.061,0,1.918,0.857,1.918,1.916v11.682C55.997,90.202,55.138,91.06,54.079,91.06z"/>\
                        </g>\
                    </g>\
                </g>\
                </svg>',yujiaxue:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <path d="M60.281,85.717c0,3.082-2.5,5.582-5.582,5.582c-3.084,0-5.584-2.5-5.584-5.582s5.584-11.406,5.584-11.406   S60.281,82.635,60.281,85.717z"/>\
                        <path d="M75.291,17.851C70.5,9.728,61.766,4.701,52.311,4.701c-12.727,0-23.525,8.832-26.107,21.16   c-6.568,2.187-11.322,8.381-11.322,15.674c0,9.115,7.414,16.525,16.525,16.525c3.289,0,6.414-0.944,9.117-2.74   c3.648,1.796,7.691,2.74,11.787,2.74c4.252,0,8.451-1.028,12.205-2.964c3.15,1.939,6.734,2.964,10.494,2.964   c11.088,0,20.109-9.021,20.109-20.107C95.117,26.961,86.248,18.004,75.291,17.851z M75.006,52.488   c-3.246,0-6.316-1.048-8.877-3.025c-1.219-0.94-2.969-0.717-3.91,0.5c-0.018,0.022-0.029,0.049-0.045,0.074   c-3.02,1.598-6.42,2.451-9.865,2.451c-3.656,0-7.256-0.949-10.412-2.742c-0.795-0.453-1.713-0.463-2.492-0.123   c-0.441,0.074-0.879,0.246-1.258,0.543c-1.939,1.521-4.27,2.322-6.744,2.322c-6.037,0-10.951-4.913-10.951-10.954   c0-6.037,4.914-10.948,10.951-10.948c3.047,0,5.98,1.284,8.049,3.522c1.043,1.131,2.809,1.201,3.939,0.156   c1.131-1.045,1.201-2.81,0.158-3.938c-2.941-3.184-7.043-5.086-11.355-5.297c2.717-8.694,10.746-14.752,20.117-14.752   c6.689,0,12.928,3.176,16.883,8.441c-2.639,0.799-5.109,2.119-7.232,3.932c-1.17,1.002-1.311,2.76-0.311,3.928   c1,1.175,2.76,1.313,3.93,0.313c2.623-2.24,5.971-3.473,9.428-3.473c8.014,0,14.535,6.521,14.535,14.534   C89.543,45.969,83.021,52.488,75.006,52.488z"/>\
                        <g>\
                            <g>\
                                <path d="M45.396,65.385c0.531,0.916,0.215,2.088-0.701,2.617L34.58,73.844c-0.918,0.529-2.09,0.213-2.619-0.7     c-0.529-0.918-0.215-2.091,0.701-2.621l10.115-5.838C43.695,64.154,44.869,64.469,45.396,65.385z"/>\
                            </g>\
                            <g>\
                                <path d="M45.396,73.142c-0.529,0.913-1.701,1.229-2.619,0.7L32.662,68c-0.916-0.529-1.23-1.701-0.701-2.617     s1.701-1.229,2.617-0.701l10.117,5.839C45.611,71.053,45.928,72.223,45.396,73.142z"/>\
                            </g>\
                            <g>\
                                <path d="M38.68,77.021c-1.061,0-1.918-0.858-1.918-1.918V63.42c0-1.057,0.857-1.918,1.918-1.918     c1.059,0,1.916,0.861,1.916,1.918v11.683C40.596,76.162,39.738,77.021,38.68,77.021z"/>\
                            </g>\
                        </g>\
                        <g>\
                            <g>\
                                <path d="M76.191,65.383c0.531,0.918,0.217,2.09-0.699,2.619l-10.117,5.842c-0.918,0.529-2.09,0.213-2.619-0.7     c-0.529-0.918-0.215-2.091,0.701-2.621l10.117-5.838C74.492,64.154,75.666,64.469,76.191,65.383z"/>\
                            </g>\
                            <g>\
                                <path d="M76.193,73.142c-0.529,0.913-1.701,1.229-2.617,0.7L63.459,68c-0.918-0.529-1.23-1.701-0.703-2.617     c0.529-0.916,1.701-1.229,2.619-0.701l10.117,5.839C76.408,71.053,76.723,72.223,76.193,73.142z"/>\
                            </g>\
                            <g>\
                                <path d="M69.475,77.021c-1.061,0-1.916-0.858-1.916-1.918V63.42c0-1.057,0.855-1.918,1.916-1.918     s1.918,0.861,1.918,1.918v11.683C71.393,76.162,70.535,77.021,69.475,77.021z"/>\
                            </g>\
                        </g>\
                    </g>\
                    </svg>',leizhenyu:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M44.017,83.052c0,3.084-2.5,5.582-5.582,5.582c-3.084,0-5.582-2.498-5.582-5.582   c0-3.085,5.582-11.407,5.582-11.407S44.017,79.967,44.017,83.052z"/>\
                    <path d="M61.212,83.052c0,3.084-2.5,5.582-5.584,5.582c-3.082,0-5.582-2.498-5.582-5.582   c0-3.085,5.582-11.407,5.582-11.407S61.212,79.967,61.212,83.052z"/>\
                    <path d="M78.733,83.052c0,3.084-2.498,5.582-5.58,5.582c-3.084,0-5.584-2.498-5.584-5.582   c0-3.085,5.584-11.407,5.584-11.407S78.733,79.967,78.733,83.052z"/>\
                    <g>\
                        <g>\
                            <path d="M48.616,38.884c0.053-0.528-0.09-0.569-0.32-0.091l-9.371,19.436c-0.23,0.479,0.016,0.869,0.545,0.869     h6.012c0.531,0,0.936,0.435,0.896,0.963l-1,14.336c-0.035,0.528,0.129,0.573,0.367,0.102l10.477-20.775     c0.238-0.474,0-0.869-0.529-0.881l-7.523-0.15c-0.529-0.011-0.92-0.449-0.865-0.979L48.616,38.884z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M48.616,38.884c0.053-0.528-0.09-0.569-0.32-0.091l-9.371,19.436c-0.23,0.479,0.016,0.869,0.545,0.869    h6.012c0.531,0,0.936,0.435,0.896,0.963l-1,14.336c-0.035,0.528,0.129,0.573,0.367,0.102l10.477-20.775    c0.238-0.474,0-0.869-0.529-0.881l-7.523-0.15c-0.529-0.011-0.92-0.449-0.865-0.979L48.616,38.884z"/>\
                    </g>\
                    <g>\
                        <g>\
                            <path d="M68.927,38.884c0.055-0.528-0.092-0.569-0.32-0.091l-9.373,19.436c-0.23,0.479,0.016,0.869,0.545,0.869     h6.012c0.531,0,0.936,0.435,0.898,0.963l-1,14.336c-0.037,0.528,0.127,0.573,0.367,0.102L76.53,53.723     c0.238-0.474,0-0.869-0.531-0.881l-7.523-0.15c-0.531-0.011-0.92-0.449-0.865-0.979L68.927,38.884z"/>\
                        </g>\
                        <g>\
                            <path d="M95.118,40.618c0-10.994-8.869-19.951-19.826-20.104c-4.791-8.123-13.523-13.148-22.98-13.148     c-12.727,0-23.523,8.834-26.105,21.157c-6.57,2.189-11.324,8.386-11.324,15.679c0,9.11,7.414,16.521,16.523,16.521     c1.021,0,2.023-0.098,3.008-0.273c-0.52-1.365-0.461-2.908,0.207-4.295l0.863-1.793c-1.283,0.514-2.654,0.788-4.078,0.788     c-6.039,0-10.949-4.911-10.949-10.948c0-6.041,4.91-10.953,10.949-10.953c3.045,0,5.98,1.285,8.049,3.524     c1.043,1.132,2.809,1.199,3.938,0.154c1.131-1.045,1.201-2.807,0.156-3.938c-2.941-3.184-7.043-5.086-11.354-5.293     c2.717-8.699,10.746-14.754,20.117-14.754c6.689,0,12.928,3.176,16.885,8.442c-2.641,0.797-5.111,2.115-7.236,3.928     c-1.17,1.002-1.309,2.761-0.309,3.933c1,1.17,2.76,1.311,3.93,0.311c2.623-2.242,5.973-3.475,9.428-3.475     c8.016,0,14.533,6.521,14.533,14.537c0,5.723-3.336,10.674-8.156,13.041c-0.041,0.752-0.23,1.506-0.588,2.213l-2.289,4.543     C87.935,58.754,95.118,50.512,95.118,40.618z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path d="M68.927,38.884c0.055-0.528-0.092-0.569-0.32-0.091l-9.373,19.436c-0.23,0.479,0.016,0.869,0.545,0.869    h6.012c0.531,0,0.936,0.435,0.898,0.963l-1,14.336c-0.037,0.528,0.127,0.573,0.367,0.102L76.53,53.723    c0.238-0.474,0-0.869-0.531-0.881l-7.523-0.15c-0.531-0.011-0.92-0.449-0.865-0.979L68.927,38.884z"/>\
                    </g>\
                </g>\
                </svg>',ye_yin:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path d="M77.502,43.357c-5.789-9.226-3.951-21.271,3.67-29.865c-2.723,0.771-5.41,1.939-7.963,3.545   C65.748,21.723,61.068,29,59.826,36.529c-4.893-4.662-11.439-7.381-18.389-7.381c-12.727,0-23.525,8.832-26.105,21.161   C8.764,52.496,4.008,58.689,4.008,65.982c0,9.109,7.414,16.525,16.525,16.525c3.287,0,6.416-0.949,9.117-2.744   c3.648,1.793,7.691,2.744,11.787,2.744c4.252,0,8.451-1.031,12.205-2.967c3.15,1.938,6.734,2.967,10.492,2.967   c10.787,0,19.611-8.535,20.088-19.205c5.082-0.135,10.33-1.639,15.113-4.643c2.555-1.604,4.775-3.51,6.656-5.631   C94.941,56.162,83.291,52.578,77.502,43.357z M64.137,76.932c-3.246,0-6.314-1.047-8.877-3.021c-1.219-0.943-2.969-0.717-3.91,0.5   c-0.018,0.021-0.025,0.049-0.043,0.068c-3.02,1.604-6.422,2.453-9.867,2.453c-3.654,0-7.256-0.945-10.41-2.74   c-0.795-0.451-1.713-0.459-2.488-0.123c-0.445,0.072-0.881,0.248-1.262,0.545c-1.941,1.518-4.273,2.318-6.744,2.318   c-6.037,0-10.949-4.91-10.949-10.949c0-6.037,4.912-10.949,10.949-10.949c3.047,0,5.979,1.283,8.049,3.521   c1.045,1.129,2.809,1.201,3.938,0.156s1.201-2.809,0.156-3.939c-2.943-3.184-7.045-5.086-11.354-5.297   c2.717-8.693,10.746-14.754,20.115-14.754c6.691,0,12.93,3.177,16.887,8.441c-2.639,0.799-5.109,2.117-7.234,3.932   c-1.17,1-1.313,2.758-0.313,3.93c0.998,1.172,2.758,1.311,3.932,0.313c2.625-2.24,5.973-3.475,9.428-3.475   c8.016,0,14.535,6.521,14.535,14.534C78.672,70.412,72.15,76.932,64.137,76.932z"/>\
                    <polygon points="91.719,25.223 95.803,23.078 95.021,27.626 98.326,30.843 93.762,31.509 91.719,35.648    89.676,31.509 85.109,30.843 88.412,27.626 87.635,23.078  "/>\
                    <polygon points="52.994,19.479 55.869,17.97 55.32,21.171 57.648,23.441 54.432,23.908 52.994,26.824    51.555,23.908 48.338,23.441 50.664,21.171 50.117,17.97  "/>\
                </g>\
                </svg>',ye_qing:'<svg style="fill: #eee;" x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <polygon points="64.13,36.086 68.216,33.936 67.435,38.487 70.739,41.709 66.173,42.369 64.13,46.507    62.087,42.369 57.522,41.709 60.825,38.487 60.046,33.936  "/>\
                        <polygon points="68.909,51.216 71.786,49.707 71.237,52.91 73.565,55.179 70.347,55.645 68.909,58.559    67.472,55.645 64.253,55.179 66.581,52.91 66.032,49.707  "/>\
                        <g>\
                            <path d="M61.856,77.953c-0.002,0-0.002,0-0.002,0c-11.102-0.002-21.279-5.582-27.236-14.936    c-4.629-7.266-6.15-15.896-4.283-24.311c1.865-8.414,6.896-15.594,14.162-20.224c0.977-0.623,2.24-0.575,3.17,0.119    c0.928,0.697,1.328,1.896,1.004,3.011c-0.043,0.15-4.369,15.786,4.723,29.371c8.965,13.393,24.672,16.801,24.828,16.83    c1.109,0.23,1.973,1.111,2.176,2.229c0.203,1.115-0.285,2.246-1.242,2.854C73.962,76.203,67.981,77.953,61.856,77.953z     M42.101,27.705c-3.113,3.405-5.299,7.582-6.324,12.209c-1.543,6.959-0.285,14.102,3.545,20.109    c4.926,7.734,13.35,12.352,22.533,12.352c0,0,0,0,0.002,0c2.838,0,5.639-0.453,8.309-1.332    c-6.154-2.521-15.107-7.549-21.402-16.953C42.384,44.563,41.64,34.421,42.101,27.705z"/>\
                        </g>\
                    </g>\
                    </svg>'};function ModalRealtimeWeather(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimeWeather.prototype=Object.create(ModalBase.prototype);ModalRealtimeWeather.prototype.constructor=ModalRealtimeWeather;ModalRealtimeWeather.prototype.optionTemplate={name:'toolBox.modal.REALTIME_WEATHER',parent:0,mode:['realTimeWeather'],maxNum:0,title:'',minHeight:1,minWidth:2,maxHeight:3,maxWidth:6,type:'ModalRealtimeWeather',tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':true,'desc':'#ShowOutdoor_Weather'}};ModalRealtimeWeather.prototype.modalInit=function(){!this.entity.modal.option&&(this.entity.modal.option={});var _this=this;var configModalOpt={area:[{type:'option',widget:[{type:'select',opt:{option:[{val:'degreesCelsius',name:'摄氏度'},{val:'degreesFahrenheit',name:'华氏度'}],data:{val:this.entity.modal.option?this.entity.modal.option.tempUnit:'degreesCelsius'}}}]},{data:[{type:'point',name:'数据点位',data:this.entity.modal.points?(this.entity.modal.points[0]instanceof Array?this.entity.modal.points[0]:this.entity.modal.points):[]}],module:"dsDrag",style:".divDsWorkspace .spVarLabel {font-size: 14px; }.divDsWorkspace .btnChartCog {}",},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:true}},{type:'cancel'}]}],header:{needBtnClose:true,title:"配置"},result:{func:function(data){!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.points=data.points[0];_this.entity.modal.option.tempUnit=data.select.val;_this.entity.modal.interval=5;_this.renderModal();}}};this.configModal=new ConfigModal(configModalOpt,this.screen.container?this.screen.container:this.screen.page.painterCtn);this.configModal.init();this.configModal.show();}
ModalRealtimeWeather.prototype.setModalOption=function(option){this.entity.modal.option.tempUnit=(option&&option.tempUnit)?option.tempUnit:'degreesCelsius';this.entity.modal.interval=5;};ModalRealtimeWeather.prototype.updateModal=function(result){console.log(result)
if(!result||!result[0]||!result[0].data)return;var tempDare=JSON.parse(result[0].data);this.renderWeatherStatus(tempDare);};ModalRealtimeWeather.prototype.renderModal=function(){var _this=this;var options=this.entity.modal.option;var weatherImg=weatherImgs['qing'];var html='<style>\
                        #weatherWrap{\
                            width: 100%;\
                            height: 100%;\
                            animation: appear 500ms ease-out forwards;\
                        }\
                        @keyframes appear{\
			                0% {\
			                    -webkit-transform: scale(0);\
			                    transform: scale(0);\
			                }\
			                50% {\
			                    -webkit-transform: scale(1.05);\
			                    transform: scale(1.05);\
			                }\
\
			                75% {\
			                    -webkit-transform: scale(0.95);\
			                    transform: scale(0.95);\
			                }\
			                100% {\
			                    -webkit-transform: scale(1);\
			                    transform: scale(1);\
			                }\
                        }\
                        #imgWrap{\
                            width: 50%;\
                            height: 100%;\
                            float: left;\
                        }\
                        #imgWrap svg{\
                            fill: #eee;\
                            float: right;\
                            width: 80%;\
                            height: 80%;\
                        }\
                        #tempWrap{\
                            width: 50%;\
                            height: 100%;\
                            float: left;\
                        }\
                        #tempWrap>div{\
                            height: 50%;\
                            width: 100%;\
                            padding-left: 10%;\
                            font-weight: bolder;\
                            text-align: left;\
                        }\
                        #tempWrap>div>div{\
                            height: 50%;\
                            width: 100%;\
                            padding-left: 10%;\
                            font-weight: bolder;\
                            text-align: left;\
                        }\
                    </style>\
                    <div id="weatherWrap">\
                        <div id="imgWrap">\
                                '+weatherImg+'\
                        </div>\
	                    <div id="tempWrap">\
		                    <div id="temp"></div>\
		                    <div id="humidity"></div>\
	                    </div>\
                    </div>';this.container.innerHTML=html;this.resize();};ModalRealtimeWeather.prototype.resize=function(){var $container=$(this.container);var height=$('#tempWrap',$container).height(),width=$('#tempWrap',$container).width();var svgHeight,svgWidth;svgHeight=svgWidth=Math.min(height,width)*0.8;$container.find('#imgWrap').siblings('#tempWrap').find('#temp').css({'line-height':height*0.75+'px','font-size':height/8}).siblings('#humidity').css({'line-height':height/4+'px','font-size':height/8});$('svg',$container).css({'height':svgHeight+'px','width':svgWidth+'px','margin-top':(height-svgHeight)/2+'px'});}
ModalRealtimeWeather.prototype.renderWeatherStatus=function(rslt){if(rslt&&rslt.tmp){var temp=rslt.tmp,humidity=rslt.hum,weather=rslt.cond.txt.replace(' ',''),weatherImg,weatherType;switch(weather)
{case'阴':case'Overcast':weatherType='yin';break;case'大雨':case'HeavyRain':weatherType='dayu';break;case'暴雨':case'Storm':weatherType='baoyu';break;case'多云':case'Cloudy':weatherType='duoyun';break;case'小雨':case'LightRain':weatherType='xiaoyu';break;case'晴转多云':case'PartlyCloudy':weatherType='qing_duoyun';break;case'晴':case'Sunny':weatherType='qing';break;case'阵雨':case'ShowerRain':weatherType='duoyun_zhenyu';break;case'打雷':case'Thundershower':weatherType='dalei';break;case'打雷暴雨':case'HeavyThunderstorm':weatherType='dalei_baoyu';break;case'大雪':case'HeavySnow':weatherType='daxue';break;case'雨夹雪':case'Sleet':weatherType='yujiaxue';break;case'雷阵雨':case'Thundershower':weatherType='leizhenyu';break;default:weatherType='qing';}
weatherImg=weatherImgs[weatherType];$(this.container).find('#imgWrap').html(weatherImg).siblings('#tempWrap').find('#temp').html(temp+(this.entity.modal.option.tempUnit=='degreesFahrenheit'?'℉':'℃')).siblings('#humidity').html(humidity+'%');this.resize();}};ModalRealtimeWeather.prototype.showConfigMode=function(){};return ModalRealtimeWeather;})();var ModalKpiOverview=(function(){function ModalKpiOverview(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.lastFiveMinutes=undefined;this.option=undefined;};ModalKpiOverview.prototype=new ModalBase();ModalKpiOverview.prototype.optionTemplate={name:'toolBox.modal.KPI_OVERVIEW',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:6,maxHeight:6,maxWidth:12,type:'ModalKpiOverview',scroll:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalKpiOverview.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"module":"dsDrag","data":[{type:'point',name:'KPI总览',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],result:{}};ModalKpiOverview.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){if(this.entity.modal.option.structPoint)this.configModalOpt.area[0].data[0].data=_this.entity.modal.points;}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();_this.renderModal();}};ModalKpiOverview.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.option={structPoint:option.points[0],needDetail:option.needDetail};this.entity.modal.points=option.points[0];};ModalKpiOverview.prototype.updateModal=function(points){this.getDsItemsById(points);};ModalKpiOverview.prototype.renderModal=function(){var _this=this;var dsItemIds=_this.entity.modal.points;if(dsItemIds!==undefined){WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:dsItemIds}).done(function(result){_this.getDsItemsById(result.dsItemList);})}};ModalKpiOverview.prototype.getDsItemsById=function(data){var _this=this;var remarks=[],ids=[],scores=[];for(var i=0,length=data.length;i<length;i++){ids.push(data[i].dsItemId);scores.push(Number(data[i].data).toFixed(2));}
WebAPI.post('/analysis/datasource/getDsItemsById',ids).done(function(result){for(var i=0,length=result.length;i<length;i++){var name=result[i].alias!==''?result[i].alias:result[i].value;remarks.push(name);}
_this.spinner&&_this.spinner.stop();if($(_this.container).html()===""||$(_this.container).find(".kpiInfoBox>div").length!==remarks.length){_this.firstRenderModal(remarks,scores,ids);}else{_this.laterRenderModal(remarks,scores,ids);}})};ModalKpiOverview.prototype.firstRenderModal=function(names,values,ids){var $container=$(this.container);$container.html("");var kpiOverviewCtn='<div class="kpiOverviewCtn"></div>';$container.html(kpiOverviewCtn);var colorClass,num=0,noIncluded=0;var topTitle='';var leftContainer='<div class="leftKpiOverview">\
                                <div class="circleContainer">\
                                    <canvas id="myCanvas" width="180px" height="180px"></canvas>\
                                    <div class="smallCircleContainer">\
                                        <div class="smallWhite"></div>\
                                    </div>\
                                    <span class="percentageNum">91%</span>\
                                </div>\
                            </div>';var rightContainer='<div class="rightKpiOverview gray-scrollbar container">\
                                <h3>KPI</h3>\
                                <div class="kpiInfoBox row"></div>\
                            </div>';$container.find(".kpiOverviewCtn").append($(leftContainer));$container.find(".kpiOverviewCtn").append($(rightContainer));$(rightContainer).html(topTitle);for(var i=0,length=names.length;i<length;i++){if(values[i]>=60){colorClass='passGreen';num+=1;}else{if(values[i]<0){noIncluded+=1;}
colorClass='noPassGreen';}
var str='<div class="col-xs-6">\
                            <div class="kpiInfo '+colorClass+'" data-id="'+ids[i]+'">\
                                <div>\
                                    <span title="'+names[i]+'">'+names[i]+' </span>\
                                    <span title="'+values[i]+'"> '+values[i]+'</span>\
                                    <span></span>\
                                </div>\
                            </div>\
                        </div>';$(this.container).find(".kpiInfoBox").append($(str));}
this.resize();var option=this.option;var c=$container.find("#myCanvas")[0];var ctx=c.getContext("2d");ctx.beginPath();var gradient=ctx.createLinearGradient(0,0,170,0);gradient.addColorStop("0","#63b15b");gradient.addColorStop("1.0","#f1b23e");ctx.strokeStyle=gradient;ctx.lineWidth=option.divWidth*9/180;ctx.arc(option.divWidth/2,option.divWidth/2,option.divWidth/2-ctx.lineWidth/2,0,2*Math.PI);ctx.stroke();var percentage=(num/(names.length-noIncluded)*100).toFixed(0);$container.find(".percentageNum").html(percentage+'%');option.r=option.divWidth/2-(option.divWidth*8/180)/2;this.smallCircle(Number(percentage),option);};ModalKpiOverview.prototype.resize=function(){var option={};var $container=$(this.container);var height=$(this.container).height(),width=$(this.container).width();var leftHeight,leftWidth;leftHeight=leftWidth=Math.min(height,width)*0.6;$('.leftKpiOverview',$container).css({'height':leftHeight+'px','width':leftWidth+'px','margin-top':'-'+leftHeight/2+'px'});$('.percentageNum',$container).css("fontSize",leftWidth/4+'px');$('#myCanvas',$container).attr("width",leftWidth+'px');$('#myCanvas',$container).attr("height",leftHeight+'px');var smallBoxWidth=leftWidth*16/180;$('.smallCircleContainer',$container).css({'height':smallBoxWidth+'px','width':smallBoxWidth+'px'});$('.rightKpiOverview',$container).css({'height':leftHeight+'px','width':'calc(100% - '+(leftWidth+20)+'px)','margin-top':'-'+leftHeight/2+'px'});$('.rightKpiOverview h3',$container).css({'fontSize':leftWidth*24/180+'px'})
$('.rightKpiOverview .kpiInfo>div span',$container).css({'fontSize':leftWidth*12/180+'px'})
$('.rightKpiOverview .kpiInfo:before',$container).css({'width':leftWidth*12/180+'px','height':leftWidth*12/180+'px'})
option.divWidth=leftWidth;option.smallBoxWidth=smallBoxWidth;this.option=option;if($container.html()!==""&&window.location.href.indexOf("preview/page")===-1){var percentage=$container.find(".percentageNum").html().split("%")[0];var c=$container.find("#myCanvas")[0];var ctx=c.getContext("2d");ctx.beginPath();var gradient=ctx.createLinearGradient(0,0,170,0);gradient.addColorStop("0","#63b15b");gradient.addColorStop("1.0","#f1b23e");ctx.strokeStyle=gradient;ctx.lineWidth=option.divWidth*9/180;ctx.arc(option.divWidth/2,option.divWidth/2,option.divWidth/2-ctx.lineWidth/2,0,2*Math.PI);ctx.stroke();option.r=option.divWidth/2-(option.divWidth*8/180)/2;this.smallCircle(Number(percentage),option);}};ModalKpiOverview.prototype.smallCircle=function(percentage,option){var $container=$(this.container);var deg=percentage/100*360;var top,left;var param=Math.PI/180;if(0<percentage&&percentage<25){deg=deg-270;y=Math.sin(deg*param)*option.r;x=Math.cos(deg*param)*option.r;top=option.divWidth/2-y;left=option.divWidth/2-x;}else if(25<=percentage&&percentage<50){if(percentage===25){top=option.divWidth/2;left=option.divWidth-(option.divWidth*9/180)/2;}else{deg=deg-180;x=Math.sin(deg*param)*option.r;y=Math.cos(deg*param)*option.r;top=option.divWidth/2+y;left=option.divWidth/2-x;}}else if(50<=percentage&&percentage<75){if(percentage===50){top=option.divWidth-(option.divWidth*9/180)/2;left=option.divWidth/2;}else{deg=deg-90;y=Math.sin(deg*param)*option.r;x=Math.cos(deg*param)*option.r;top=option.divWidth/2+y;left=option.divWidth/2+x;}}else if(75<=percentage&&percentage<100){if(percentage===75){top=option.divWidth/2;left=(option.divWidth*9/180)/2;}else{deg=deg;x=Math.sin(deg*param)*option.r;y=Math.cos(deg*param)*option.r;top=option.divWidth/2-y;left=option.divWidth/2+x;}}else if(percentage===0||percentage===100){top=(option.divWidth*9/180)/2;left=option.divWidth/2;}
$container.find(".smallCircleContainer").css({'top':(top-option.smallBoxWidth/2)+'px','left':(left-option.smallBoxWidth/2)+'px'});};ModalKpiOverview.prototype.laterRenderModal=function(names,values,ids){var colorClass,fontColor,num=0,noIncluded=0;$(this.container).find(".kpiInfoBox>div").each(function(){var $kpiInfo=$(this).find(".kpiInfo");var $infos=$(this).find(".kpiInfo span");for(var i=0,length=ids.length;i<length;i++){if(ids[i]===$kpiInfo.attr("data-id")){if(values[i]>=60){colorClass='passGreen';num+=1;}else{if(values[i]<0){noIncluded+=1;}
colorClass='noPassGreen';}
$kpiInfo.removeClass().addClass("kpiInfo "+colorClass);var value=Number($infos.eq(1).html());var arrowClass;if(values[i]>value){arrowClass="glyphicon glyphicon-arrow-up";fontColor="#63b15b";}else if(values[i]<value){arrowClass="glyphicon glyphicon-arrow-down";fontColor="#f1b23e";}else if(values[i]==value){arrowClass="";}
$kpiInfo.find("span").eq(2).removeClass().addClass(arrowClass).css("color",fontColor);$infos.eq(1).html(values[i]);}}})
var percentage=(num/(names.length-noIncluded)*100).toFixed(0);$(this.container).find(".percentageNum").html(percentage+'%');this.smallCircle(Number(percentage),this.option)};ModalKpiOverview.prototype.attachEvent=function(){};ModalKpiOverview.prototype.showConfigMode=function(){};return ModalKpiOverview;})()
var ModalCumulantChart=(function(){function ModalCumulantChart(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalCumulantChart.prototype=new ModalBase();ModalCumulantChart.prototype.optionTemplate={name:'toolBox.modal.CUMULANT_CHART',parent:0,mode:'custom',maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalCumulantChart',scroll:true,needRefresh:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalCumulantChart.prototype.configModalOptDefault={"header":{"needBtnClose":true,"title":"配置"},"area":[{"module":'timeConfig',},{'type':'option',widget:[{type:'select',name:'图表类型',id:'chartType',opt:{attr:{class:'form-inline'},option:[{val:'bar',name:'柱图'},{val:'line',name:'折线图'}]}},{type:'checkbox',name:'启用堆叠',id:'isStack',opt:{}}]},{"module":"dsDrag","data":[{type:'point',name:'数据点位',data:[],forChart:false}]},{'type':'footer',"widget":[{type:'confirm',opt:{needClose:false}},{type:'cancel'}]}],"result":{}};ModalCumulantChart.prototype.initConfigModalOpt=function(){var _this=this;if(this.entity.modal.option){this.configModalOpt.area[2].data[0].data=this.entity.modal.option.dsItemIds;this.configModalOpt.area[1].widget[0].data={val:this.entity.modal.option.chartType};this.configModalOpt.area[1].widget[1].data=this.entity.modal.option.isStack;(this.entity.modal.option.timeStart&&this.entity.modal.option.timeEnd)&&(this.configModalOpt.area[0].data={mode:'1',timeStart:this.entity.modal.option.timeStart,timeEnd:this.entity.modal.option.timeEnd,interval:this.entity.modal.option.timeFormat});if(typeof this.entity.modal.option.timeRecent=='string'){this.configModalOpt.area[0].data={mode:'0',timeRecent:this.entity.modal.option.timeRecent,interval:this.entity.modal.option.timeFormat}}else if(typeof this.entity.modal.option.timeRecent=='object'&&this.entity.modal.option.timeRecent.hasOwnProperty('val')&&this.entity.modal.option.timeRecent.hasOwnProperty('unit')){this.configModalOpt.area[0].data={mode:'2',timeRecent:this.entity.modal.option.timeRecent,interval:this.entity.modal.option.timeFormat}}}
this.configModalOpt.result.func=function(option){_this.setModalOption(option);_this.configModal.hide();}};ModalCumulantChart.prototype.optionDefault={};ModalCumulantChart.prototype.renderModal=function(){var timeConfig=generateTimeOption(this.entity.modal.option);var postData={timeStart:timeConfig.timeStart,timeEnd:timeConfig.timeEnd,timeFormat:timeConfig.timeFormat,dsItemIds:timeConfig.dsItemIds};var _this=this;WebAPI.post('/analysis/startWorkspaceDataGenHistogram/increment',postData).done(function(result){var arrLegend=_this.entity.modal.option.dsItemIds.map(function(point){var point=AppConfig.datasource.getDSItemById(point);return(point.alias?point.alias:point.value);});var arrSeries=[];for(var i=0;i<result.list.length;i++){arrSeries.push({name:arrLegend[i],type:_this.entity.modal.option.chartType,areaStyle:{normal:{}},stack:_this.entity.modal.option.isStack,data:result.list[i].data.map(function(data){var val=parseFloat(data);if(!(isNaN(val))&&val>0){return val.toFixed(2);}else{return 0}})});}
var opt={text:'历史累积量折线图',legend:{data:arrLegend,top:10},grid:{left:40,right:20,top:35},tooltip:{trigger:'axis'},toolbox:{showTitle:true,feature:{magicType:{type:['line','bar','stack','tiled']}}},xAxis:{data:result.timeShaft.slice(0,result.timeShaft.length-1),type:'category',axisLabel:{formatter:function(value,index){var date=new Date(value.replace(/-/g,'/'));var texts;if(index===0){texts=date.format('yyyy-MM-dd')+'\n'+date.format('HH:mm:ss');}else{var preDate=new Date(result.timeShaft[index-1]);if(preDate.format('yyyy-MM-dd')==date.format('yyyy-MM-dd')){texts=date.format('HH:mm:ss')}else{texts=date.format('yyyy-MM-dd')+'\n'+date.format('HH:mm:ss');}}
return texts;}}},yAxis:[{type:'value'}],series:arrSeries};if(AppConfig.isMobile){opt.legend={data:arrLegend,top:10,itemWidth:15,itemHeight:10,textStyle:{fontSize:12}};}
var chart=echarts.init(_this.container,AppConfig.chartTheme);chart.setOption(opt);_this.spinner.stop();})};ModalCumulantChart.prototype.updateModal=function(points){};ModalCumulantChart.prototype.showConfigMode=function(){};ModalCumulantChart.prototype.setModalOption=function(option){this.entity.modal.interval=5;this.entity.modal.points=[];this.entity.modal.option={mode:option.mode,timeStart:option.timeStart,timeEnd:option.timeEnd,timeFormat:option.interval,dsItemIds:option.points[0],isStack:option.isStack?1:0,chartType:option.chartType.val,timeRecent:option.timeRecent};};ModalCumulantChart.prototype.goBackTrace=function(data){};return ModalCumulantChart;})();var ModalIconManage=(function(){var _this;function ModalIconManage(currentDataList,currentId){_this=this;}
ModalIconManage.prototype=new ModalIconManage();ModalIconManage.prototype.show=function(currentDataList,currentId,callback){var $iptColor;_this.currentDataList=currentDataList;_this.currentId=currentId;if(_this.$modal){_this.$modal.modal('show');$iptColor=_this.$modal.find('#iptColorSel');if(_this.currentDataList.iconColor){$iptColor.val(_this.currentDataList.iconColor);}
var nowIcon=_this.currentDataList.icon;var currentIconType=_this.currentDataList.iconType?_this.currentDataList.iconType:'bootIcon';if(nowIcon){if(currentIconType==='svg'||currentIconType==='image'){_this.$modal.find('.bs-glyphicons-list .'+currentIcon.split('@*')[0]).parent().addClass('selected');}else{_this.$modal.find('.bs-glyphicons-list .'+currentIcon.split(' ')[1]).parent().addClass('selected');}}}else{WebAPI.get('static/scripts/spring/entities/modalMonitor.html').done(function(resultHTML){_this.$modal=$(resultHTML);$iptColor=_this.$modal.find('#iptColorSel');_this.$modal.modal('show');if(_this.currentDataList.iconColor){$iptColor.val(_this.currentDataList.iconColor);}
var currentIcon=_this.currentDataList.icon;var currentIconType=_this.currentDataList.iconType?_this.currentDataList.iconType:'bootIcon';if(currentIcon){if(currentIconType==='svg'||currentIconType==='image'){_this.$modal.find('.bs-glyphicons-list .'+currentIcon.split('@*')[0]).parent().addClass('selected');}else{_this.$modal.find('.bs-glyphicons-list .'+currentIcon.split(' ')[1]).parent().addClass('selected');}}
_this.$modal.find('.bs-glyphicons-list>li').click(function(e){if($(e.currentTarget).hasClass('selected'))return;$('.bs-glyphicons-list>li.selected').removeClass('selected');$(e.currentTarget).addClass('selected');});_this.$modal.find('.btnSure').click(function(e){e.stopPropagation();var $glyphiconClass=$('.bs-glyphicons-list>li.selected>.glyphicon-class');var icon=$glyphiconClass.html();var iconType=$glyphiconClass.attr('type');if(iconType==='svg'||iconType==='image'){_this.currentDataList.icon=$('.bs-glyphicons-list>li.selected>span:first').attr('class')+'@*'+icon;}else{_this.currentDataList.icon=icon;}
_this.currentDataList.iconType=iconType
_this.currentDataList.iconColor=$iptColor.val();_this.currentDataList.entityId=_this.currentId;_this.$modal.modal('hide');if(callback&&Object.prototype.toString.call(callback)==='[object Function]'){callback(_this.currentDataList.icon,_this.currentDataList.iconColor,_this.currentDataList.iconType);}
return _this.currentDataList;})})}};return ModalIconManage;})();var ModalColdHotAreaSummary=(function(){function ModalColdHotAreaSummary(screen,entityParams,_renderModal){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;ModalBase.call(this,screen,entityParams,renderModal);this.lastFiveMinutes=undefined;this.option=undefined;};ModalColdHotAreaSummary.prototype=new ModalBase();ModalColdHotAreaSummary.prototype.optionTemplate={name:'toolBox.modal.COLD_HOT_AREA_SUMMARY',parent:0,mode:'noConfigModal',maxNum:1,title:'',minHeight:3,minWidth:3,maxHeight:2,maxWidth:4,type:'ModalColdHotAreaSummary',scroll:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalColdHotAreaSummary.prototype.renderModal=function(){$(this.container).attr('title',I18n.resource.toolBox.modal.COLD_HOT_AREA_SUMMARY);var _this=this;if($(this.container).find('.dashboardCtn').length!==0){$(this.container).find('.dashboardCtn').html($(this.layoutPage()));}else{$(this.container).html($(this.layoutPage()));}
I18n.fillArea($(this.container));if(AppConfig.project===undefined){var projectId=AppConfig.projectId;}else{var projectId=AppConfig.project.bindId;}
var points=['@'+projectId+'|AllRoom_UnderCool_svr','@'+projectId+'|UnderCoolLimit_svr','@'+projectId+'|OverHeatLimit_svr','@'+projectId+'|AllRoom_OverHeat_svr']
var option={dsItemIds:points}
WebAPI.post('/analysis/startWorkspaceDataGenPieChart',option).done(function(result){var itemList=result.dsItemList;for(var i=0;i<itemList.length;i++){var data=itemList[i].data;var point=itemList[i].dsItemId.split('|')[1];if(point==="UnderCoolLimit_svr"){$(_this.container).find(".minT").text(data+'℃');}else if(point==="OverHeatLimit_svr"){$(_this.container).find(".maxT").text(data+"℃");}else if(point==="AllRoom_UnderCool_svr"){$(_this.container).find(".coldT").text(data);}else if(point==="AllRoom_OverHeat_svr"){$(_this.container).find(".overHeatT").text(data);}}})
this.attatchEvents();};ModalColdHotAreaSummary.prototype.layoutPage=function(){return('<div class="coldHotAreaSummary row">\
                <div class="line"></div>\
                <div class="col-xs-6">\
                    <div class="situation">\
                        <span class="iconfont icon-weibiaoti--3" style="color:rgb(68,123,229)"></span>\
                        <span style="font-size:1.2em;" i18n="toolBox.COLD_HOT_AREA_SUMMARY.OVER_COLD"></span>\
                    </div>\
                    <div class="temperatureBg bgblue">\
                        <span class="realTp coldT"></span>\
                    </div>\
                    <div class="static">\
                        <span i18n="toolBox.COLD_HOT_AREA_SUMMARY.STANDARD"></span>\
                        <span class="minT"></span>\
                    </div>\
                </div>\
                <div class="col-xs-6">\
                    <div class="situation">\
                        <span class="iconfont icon-weibiaoti--1" style="color:rgb(228,175,0);"></span>\
                        <span style="font-size:1.2em;" i18n="toolBox.COLD_HOT_AREA_SUMMARY.OVER_HOT"></span>\
                    </div>\
                    <div class="temperatureBg bgyellow">\
                      <span class="realTp overHeatT"></span>\
                    </div>\
                    <div class="static">\
                      <span i18n="toolBox.COLD_HOT_AREA_SUMMARY.STANDARD"></span>\
                      <span class="maxT"></span>\
                    </div>\
                </div>\
          </div>');};ModalColdHotAreaSummary.prototype.attatchEvents=function(points){$(this.container).off('click').on('click',function(){if(AppConfig.isFactory===0){ScreenManager.goTo({page:'observer.screens.PageScreen',options:{id:'14840418452285112d218620'},container:'indexMain'});}})};return ModalColdHotAreaSummary;})()
var ModalEquipmentPerfectRate=(function(){function ModalEquipmentPerfectRate(screen,entityParams,_renderModal){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;ModalBase.call(this,screen,entityParams,renderModal);};ModalEquipmentPerfectRate.prototype=new ModalBase();ModalEquipmentPerfectRate.prototype.optionTemplate={name:'toolBox.modal.EQUIPMENT_PERFECT_RATE',parent:0,mode:'noConfigModal',maxNum:1,title:'',minHeight:2,minWidth:4,maxHeight:3,maxWidth:6,type:'ModalEquipmentPerfectRate',scroll:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalEquipmentPerfectRate.prototype.resize=function(){var width=$(this.container).width();var circleWidth=width*0.33*0.5*0.85;$(this.container).find('.circleCtn').css({width:circleWidth+'px',height:circleWidth+'px'});}
ModalEquipmentPerfectRate.prototype.renderModal=function(){$(this.container).attr('title',I18n.resource.toolBox.modal.EQUIPMENT_PERFECT_RATE);var _this=this;var equipmentIntactRate='<div class="equipmentIntactRate gray-scrollbar"></div>';if($(this.container).find('.dashboardCtn').length!==0){$(this.container).find('.dashboardCtn').html($(equipmentIntactRate));}else{$(this.container).html($(equipmentIntactRate));}
if(AppConfig.project===undefined){var projectId=AppConfig.projectId;}else{var projectId=AppConfig.project.bindId;}
WebAPI.get('/appDashboard/EquipmentIntactRate/pandect/'+projectId+'/'+I18n.type).done(function(result){var dataList=result.data;if(dataList.length===0){$(_this.container).find('.equipmentIntactRate').html("<div class='noData' i18n='toolBox.modal_public.NO_DATA'></div>");}else{var colorArr=['#fac824','#e6c322','#d2be20','#bebe1e','#aab41c','#94bb1a','#80b918','#6eb716','#5fb615','#50af12','#50af12'];for(var i=0,len=dataList.length;i<len;i++){var num=Number(dataList[i].IntactRate.split("%")[0]).toFixed(0);var topPercent=100-num;var goodNum=dataList[i].GoodNum;var totalNum=dataList[i].TotalNum;var faultNum=totalNum-goodNum;if(I18n.type==='zh'){var title='本项目共有'+dataList[i].SubSystemName+' '+totalNum+' 个&#10;BeOP本月为本项目累计检测出 '+faultNum+' 个故障';}else{var title=totalNum+' '+dataList[i].SubSystemName+' total.&#10; BeOP detected '+faultNum+' faults in this month.';}
var str='<div class="divCtn col-xs-4" data-toggle="tooltip" data-placement="bottom" title="'+title+'">\
                                <div class="pBar">\
                                <div class="circleCtn">\
                                  <div class="circleBorder"></div>\
                                  <div class="circleBg" style="background:'+colorArr[parseInt(num/10)]+';"></div>\
                                  <span class="perNum">'+num+'</span>\
                                </div>\
                              </div>\
                              <div class="name" title="'+dataList[i].SubSystemName+'">\
                                <span data-link-to="1480510791302405326379ab">'+dataList[i].SubSystemName+'</span>\
                              </div>\
                              </div>';$(str).appendTo($(_this.container).find('.equipmentIntactRate'));$(".circleBg").eq(i).animate({top:topPercent+'%'},2000);}}
I18n.fillArea($(_this.container));_this.attatchEvents();_this.resize();})};ModalEquipmentPerfectRate.prototype.attatchEvents=function(points){$(this.container).off('click').on('click',function(){if(AppConfig.isFactory===0){ScreenManager.goTo({page:'observer.screens.PageScreen',options:{id:'148404189964451192095bee'},container:'indexMain'});}})};return ModalEquipmentPerfectRate;})()
var ModalWorkOrderStatistics=(function(){function ModalWorkOrderStatistics(screen,entityParams,_renderModal){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;ModalBase.call(this,screen,entityParams,renderModal);};ModalWorkOrderStatistics.prototype=new ModalBase();ModalWorkOrderStatistics.prototype.optionTemplate={name:'toolBox.modal.WORK_ORDER_STATISTICS',parent:0,mode:'noConfigModal',maxNum:1,title:'',minHeight:3,minWidth:3,maxHeight:2,maxWidth:4,type:'ModalWorkOrderStatistics',scroll:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalWorkOrderStatistics.prototype.renderModal=function(){$(this.container).attr('title',I18n.resource.toolBox.modal.WORK_ORDER_STATISTICS);var _this=this;if($(this.container).find('.dashboardCtn').length!==0){$(this.container).find('.dashboardCtn').html(_this.layoutPage());}else{$(this.container).html(_this.layoutPage());}
I18n.fillArea($(this.container));var $workOrderStatistics=$(this.container).find(".workOrderStatistics");if(AppConfig.project===undefined){var projectId=AppConfig.projectId;}else{var projectId=AppConfig.project.bindId;}
WebAPI.get('/Dashboard/workOrderStatistics/'+projectId).done(function(result){function isEmptyObject(e){var t;for(t in e)
return!1;return!0}
if(isEmptyObject(result.data)){var newOrder=I18n.resource.toolBox.modal_public.NO_DATA;var averSendTime=I18n.resource.toolBox.modal_public.NO_DATA;var percentage=0;}else{var data=result.data;var newOrderAll=0,finishOrder=0,responseTime=0;var timesNum=0;for(var k in data){var item=data[k];for(var i in item){if(k==='FinishingOrder'){finishOrder+=item[i];}else if(k==='NewOrder'){newOrderAll+=item[i];}else{responseTime+=item[i];timesNum++;}}}
var newOrder=newOrderAll;var averSendTime=31+'min';var percentage=newOrder===0?0:(finishOrder/newOrder*100).toFixed(0);}
$workOrderStatistics.find('.newOrderNum').html(newOrder);$workOrderStatistics.find('.averSendTime').html(averSendTime);$workOrderStatistics.find('.percentageDetail').html(percentage+'%');$workOrderStatistics.find('.percentageBar').css('width',percentage+'%');if(Number(percentage)===100){$workOrderStatistics.find('.percentageBar').css('border-radius','.5em');}})
this.attatchEvents();};ModalWorkOrderStatistics.prototype.layoutPage=function(){return('<div class="workOrderStatistics">\
                    <div>\
                      <div class="billInfo">\
                        <span class="name" i18n="toolBox.WORK_ORDER_STATISTICS.NEW_WORK"></span>\
                      </div>\
                      <div class="state">\
                        <span class="newOrderNum">loading</span>\
                      </div>\
                    </div>\
                    <div>\
                      <div class="billInfo">\
                        <span class="name" i18n="toolBox.WORK_ORDER_STATISTICS.REPONSE_TIME"></span>\
                      </div>\
                      <div class="state">\
                        <span class="averSendTime">loading</span>\
                      </div>\
                    </div>\
                    <div class="completionRate">\
                      <div class="billInfo">\
                        <span class="name" i18n="toolBox.WORK_ORDER_STATISTICS.COMPLETE"></span>\
                      </div>\
                      <div class="percentageCtn">\
                        <div class="progressBar">\
                          <div class="percentageBar barThree">\
                            <span class="percentageDetail">loading</span>\
                          </div>\
                        </div>\
                      </div>\
                    </div>\
                </div>');};ModalWorkOrderStatistics.prototype.attatchEvents=function(points){$(this.container).off('click').on('click',function(){if(AppConfig.isFactory===0){ScreenManager.goTo({page:'observer.screens.PageScreen',options:{id:'148404186778151121ad8982'},container:'indexMain'});}})};return ModalWorkOrderStatistics;})()
var ModalPriorityHandlingFaultList=(function(){function ModalPriorityHandlingFaultList(screen,entityParams,_renderModal){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;ModalBase.call(this,screen,entityParams,renderModal);this.lastFiveMinutes=undefined;this.option=undefined;};ModalPriorityHandlingFaultList.prototype=new ModalBase();ModalPriorityHandlingFaultList.prototype.optionTemplate={name:'toolBox.modal.PRIORITY_HAADLING_FAULT_LIST',parent:0,mode:'noConfigModal',maxNum:1,title:'',minHeight:2,minWidth:4,maxHeight:3,maxWidth:6,type:'ModalPriorityHandlingFaultList',scroll:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalPriorityHandlingFaultList.prototype.renderModal=function(){$(this.container).attr('title',I18n.resource.toolBox.modal.PRIORITY_HAADLING_FAULT_LIST);var _this=this;var priorityHandlingFaultList='<div class="priorityHandlingFaultList"></div>';if($(this.container).find('.dashboardCtn').length!==0){$(this.container).find('.dashboardCtn').html($(priorityHandlingFaultList));}else{$(this.container).html($(priorityHandlingFaultList));}
var store=[];if(AppConfig.project===undefined){var projectId=AppConfig.projectId;}else{var projectId=AppConfig.project.bindId;}
$.get('/diagnosis/notice/getTop5/'+projectId).done(function(rv){if(!rv.data)return;store=rv.data;if(store.length===0){$(_this.container).find('.priorityHandlingFaultList').html('<div style="width:100%;height:calc(100% - 30px);display:flex;justify-content: center;align-items: center;font-size:14px;" i18n="toolBox.modal_public.NO_FAULT"></div><div class="bottomDiv"><button class="showInfoBtn" i18n="toolBox.modal_public.DETAILS"></button></div>');}else{var html='<div class="faultList">';for(var i=0;i<rv.data.length;i++){var item=rv.data[i];if(I18n.type==='zh'){var InProcess='未处理';var Completed='已完成';}else{var InProcess='In Process';var Completed='Completed';}
var status=InProcess;if(item.Status!=1||item.CheckTime!=null)status=Completed;html+='<div data-index='+i+' class="rowList">\
                            <span style="width:20%;">'+item.Time.substr(5)+'</span>\
                            <span title="'+item.Fault+'" style="width:calc(50% - 85px);">'+item.Fault+'</span>\
                            <span title="'+item.Equipment+'" style="width:calc(50% - 85px)">'+item.Equipment+'</span>\
                            <span style="width:120px;">'+status+'</span>\
                            </div>';}
html+='</div><div class="bottomDiv"><button class="showInfoBtn" i18n="toolBox.modal_public.DETAILS"></button></div>';$(_this.container).find('.priorityHandlingFaultList').html(html);}
I18n.fillArea($(_this.container));$(_this.container).off('click.rowList').on('click.rowList','.rowList',function(e){var e=e||window.event;e.stopPropagation();var faultName=$(this).find('span').eq(1).text();var faultInfos={};var postData={value:faultName,type:'fault',startTime:new Date(new Date().valueOf()-86400000*7).format('yyyy-MM-dd ')+'00:00:00',endTime:new Date().format('yyyy-MM-dd HH:mm:ss'),projId:projectId}
Spinner.spin($(_this.container).find('.priorityHandlingFaultList')[0]);var containerScreen=$(_this.container).closest('#indexMain');WebAPI.post('/diagnosis/getFaultDetails',postData).done(function(faultDetail){var faultDetailData=faultDetail.data;faultInfos['faultName']=faultName;faultInfos['faultDetailData']=faultDetailData;faultInfos['containerScreen']=containerScreen;faultInfos['diagType']='fault';new DiagnosisInfo().show(faultInfos);})});})
this.attatchEvents();};ModalPriorityHandlingFaultList.prototype.attatchEvents=function(points){$(this.container).off('click.showInfoBtn').on('click.showInfoBtn','.showInfoBtn',function(e){var e=e||window.event;e.stopPropagation();if(AppConfig.isFactory===0){ScreenManager.goTo({page:'observer.screens.PageScreen',options:{id:'1484041883476511bc54d206'},container:'indexMain'});}})};return ModalPriorityHandlingFaultList;})()
var ModalEnergyTrendAnalysis=(function(){function ModalEnergyTrendAnalysis(screen,entityParams,_renderModal){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;ModalBase.call(this,screen,entityParams,renderModal);};ModalEnergyTrendAnalysis.prototype=new ModalBase();ModalEnergyTrendAnalysis.prototype.optionTemplate={name:'toolBox.modal.ENERGY_TREND_ANALYSIS',parent:0,mode:'noConfigModal',maxNum:1,title:'',minHeight:3,minWidth:3,maxHeight:2,maxWidth:4,type:'ModalEnergyTrendAnalysis',scroll:false,tooltip:{'imgPC':true,'imgMobile':false,'isSpecData':false,'desc':''}};ModalEnergyTrendAnalysis.prototype.resize=function(){this.chart&&this.chart.resize();};ModalEnergyTrendAnalysis.prototype.renderChartOption=function(data,time){var year=new Date().getFullYear()-1;var option={color:['rgb(23,171,227)'],tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},grid:{left:10,right:10,bottom:10,top:10,containLabel:true},axisLabel:{formatter:function(value){if(value>=1000000||value<=-1000){return value/1000000+'m';}else if(value>=1000||value<=-1000){return value/1000+'k';}else{return value;}},textStyle:{color:'#666666'}},xAxis:[{type:'category',axisTick:{alignWithLabel:true},data:time,axisTick:{show:false},axisLine:{lineStyle:{color:'#666666',}}}],yAxis:[{type:'value',axisLine:{show:false},axisTick:{show:false},splitLine:{lineStyle:{color:'#888888'}}}],series:{type:'bar',label:{normal:{show:true,position:'top',formatter:function(value){if(value.value>=1000000||value.value<=-1000000){return(value.value/1000000).toFixed(2)+'m';}else if(value.value>=1000||value.value<=-1000){return(value.value/1000).toFixed(2)+'k';}else{return value.value;}}},},name:year,data:data}}
var $chartContainer=$(this.container).find('.chartBox');this.chart=echarts.init($chartContainer[0]);this.chart.setOption(option);this.spinner&&this.spinner.stop();};ModalEnergyTrendAnalysis.prototype.renderModal=function(){var _this=this;var layoutInfo='<div class="energyAnalysis">\
							<div class="chartBox"></div>\
						</div>';if($(this.container).find('.dashboardCtn').length!==0){$(this.container).find('.dashboardCtn').html(layoutInfo);}else{$(this.container).html(layoutInfo);}
if(AppConfig.project===undefined){var projectId=AppConfig.projectId;}else{var projectId=AppConfig.project.bindId;}
var year=new Date().getFullYear()-1;var postData={dsItemIds:['@'+projectId+'|Accum_RealTimePower_svr'],timeStart:year+"-01-01 00:00:00",timeEnd:year+"-12-01 00:00:00",timeFormat:'d1'}
WebAPI.post("/analysis/startWorkspaceDataGenHistogram",postData).done(function(result){if(result.timeShaft===undefined){$(_this.container).find('.chartBox').html('<div class="noData">没有历史数据</div>');}else{var time=result.timeShaft;var data=result.list[0].data;var timeArr=[],dataArr=[];var arr=[];var renderData=[];for(var i=0,length=time.length;i<length;i++){var currentMonth=time[i].split('-')[1];if(i===0){arr.push(data[i]);}else{var lasttMonth=time[i-1].split('-')[1];if(lasttMonth===currentMonth){arr.push(data[i]);}else if(i===length-1){timeArr.push(new Date(time[i]).format("MM"));arr.push(data[i]);dataArr.push(arr);arr=[];}else{timeArr.push(new Date(time[i-1]).format("MM"));dataArr.push(arr);arr=[data[i]];}}}
for(var j=0,jLength=dataArr.length;j<jLength;j++){renderData.push(Number((dataArr[j][dataArr[j].length-1]-dataArr[j][0]).toFixed(1)));}
_this.renderChartOption(renderData,timeArr);}})
this.attatchEvents();};ModalEnergyTrendAnalysis.prototype.attatchEvents=function(points){$(this.container).off('click').on('click',function(){if(AppConfig.isFactory===0){ScreenManager.goTo({page:'observer.screens.PageScreen',options:{id:'1484041916218511e04b5c4e'},container:'indexMain'});}})};return ModalEnergyTrendAnalysis;})()
var ReportIndex=(function(){function ReportIndex(){this.tranditionalReportList=[];this.factoryReportList=[];this.factoryReportComplete=undefined;}
ReportIndex.navOptions={top:'<div class="topNavTitle" i18n="appDashboard.message.MY_REPORT">我的报表</div>\
        <span id="btnAdminConfig" class=""><i class="iconfont">&#xe7e3;</i></span>',bottom:true,backDisable:true,module:'report'};ReportIndex.prototype={reportTypeMap:{daily:'0',monthly:'1',weekly:'2'},show:function(){var _this=this;ElScreenContainer.innerHTML='';localStorage.setItem('module','report');WebAPI.get('static/app/dashboard/views/report/reportIndex.html').done(function(result){ElScreenContainer.innerHTML=result;var $adminConfig=$('#btnAdminConfig');$adminConfig[0].innerHTML='<img src="http://images.rnbtech.com.hk'+AppConfig.userProfile.picture+'">';$adminConfig.off('touchstart').on('touchstart',function(e){var adminConfigNew=new AdminConfigNew();adminConfigNew.show();});_this.init();});},init:function(){var _this=this;SpinnerControl.show();WebAPI.get("/get_plant_pagedetails/"+ProjectConfig.projectId+"/"+AppConfig.userId).done(function(result){if(result.navItems&&result.navItems.length>0){ProjectConfig.reportList=[];_this.factoryReportList=result.navItems.filter(function(item){return item.type==='FacReportWrapScreen';});_this.tranditionalReportList=result.navItems.filter(function(item){return item.type==='ReportScreen';});_this.factoryReportComplete=$.Deferred();ProjectConfig.reportList=[].concat(_this.tranditionalReportList);if(_this.factoryReportList.length>0||_this.tranditionalReportList.length>0){if(_this.factoryReportList.length>0){_this.initFactoryReportList();}else{_this.factoryReportComplete.resolve();}
if(_this.tranditionalReportList.length>0){_this.factoryReportComplete.done(function(){_this.initTraditionReportList();SpinnerControl.hide();});}else{SpinnerControl.hide();}
_this.attachEvent();}else{SpinnerControl.hide();window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.message.REPORT_ERR,'short','center');}}else{SpinnerControl.hide();window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.message.REPORT_ERR,'short','center');}}).fail(function(e){SpinnerControl.hide();window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.message.REPORT_ERR,'short','center');})},attachEvent:function(){var $item=$('.divReportItem');var _this=this,id;$(ElScreenContainer).off('tap').on('tap','.divReportItem',function(e){e.preventDefault();e.stopPropagation();id=e.currentTarget.id;if(e.currentTarget.dataset.src=='factory'){router.to({typeClass:ProjectFactoryReport,data:{reportId:id}});}else{router.to({typeClass:ProjectReport,data:{reportId:id}});}})},initFactoryReportList:function(){var container=document.getElementById('ctnFactoryReport');var _this=this;if(!(this.factoryReportList.length&&this.factoryReportList.length>0)){_this.factoryReportComplete.resolve();return;}
var reportPageId=this.factoryReportList[0].id;AppConfig.isFactory=0;WebAPI.get('/factory/reportWrap/'+AppConfig.isFactory+'/'+reportPageId).done(function(index){ProjectConfig.reportList=[].concat(index.list,_this.tranditionalReportList);for(var i=0;i<index.list.length;i++){ProjectConfig.reportList[i].pageId=index.pageId;var version=_this.getReportVersion(index.list[i].period);var reportName=index.list[i].reportName;var item=document.createElement('div');item.className='zepto-ev divReportItem media';item.id=index.list[i].reportId;item.dataset.src='factory';item.dataset.version=version;var icon=document.createElement('span');icon.className='spIcon iconfont icon-baobiao1 media-left';var infoCtn=document.createElement('div');infoCtn.className='infoCtn media-body media-body';var title=document.createElement('span');title.className='spTitle';title.textContent=reportName;var time=document.createElement('span');time.className='spTime';time.textContent=version;infoCtn.appendChild(title);infoCtn.appendChild(time);var entry=document.createElement('span');entry.className='spEntry glyphicon glyphicon-menu-right media-right';item.appendChild(icon);item.appendChild(infoCtn);item.appendChild(entry);container.appendChild(item);}
_this.factoryReportComplete.resolve();}).fail(function(){_this.factoryReportComplete.resolve();});},initTraditionReportList:function(){var _this=this;var container=document.getElementById('ctnTraditionalReport');_this.tranditionalReportList.forEach(function(val){var version=_this.getReportVersion(val.reportType);var reportFolder=val.reportFolder;var item=document.createElement('div');item.className='zepto-ev divReportItem';item.id=val.id;item.dataset.src='traditional';item.dataset.version=version;var icon=document.createElement('span');icon.className='spIcon iconfont icon-baobiao1';var title=document.createElement('span');title.className='spTitle';title.textContent=val.text;var time=document.createElement('span');time.className='spTime';time.textContent=version;var entry=document.createElement('span');entry.className='spEntry glyphicon glyphicon-menu-right';item.appendChild(icon);item.appendChild(title);item.appendChild(time);item.appendChild(entry);container.appendChild(item);})},getReportVersion:function(reportInfo,reportDate){var thisDay,version;var reportType=reportInfo;var year,month,day;if(reportDate instanceof Date){thisDay=reportDate;}else{thisDay=new Date();}
if(reportType===this.reportTypeMap.daily||reportType=='day'){if(+new Date(thisDay.format('yyyy/MM/dd 00:00:00'))>=+new Date(new Date().format('yyyy/MM/dd 00:00:00'))){thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);}
version=thisDay.format('yyyy-MM-dd');}
else if(reportType===this.reportTypeMap.monthly||reportType=='month'){if(+new Date(thisDay.format('yyyy/MM/01'))>=+new Date(new Date().format('yyyy/MM/01'))){thisDay=new Date();thisDay.setMonth(thisDay.getMonth()-1);}
year=thisDay.getFullYear();month=thisDay.getMonth()+1;version=year+'-'+StringUtil.padLeft(month,2,'0');}else{var thisWeek=this.iso8601Week(thisDay);if(this.iso8601Week(new Date())>=thisWeek){thisWeek=this.iso8601Week(new Date())-1;thisDay=new Date();thisDay=new Date(thisDay-7*24*60*60*1000);}
year=thisDay.getFullYear();version=DateUtil.getFirstDayOfWeek(year,thisWeek).format('yyyy-MM-dd');}
return version;},iso8601Week:function(date){var addOneDayDate=new Date(date);var time,checkDate=new Date(addOneDayDate.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},close:function(){$(ElScreenContainer).off('tap');}};return ReportIndex})();var MessageIndex=(function(){var _this=this;function MessageIndex(){_this=this;}
MessageIndex.navOptions={top:'<div class="topNavTitle" i18n="appDashboard.message.MESSAGE_CENTER"></div>',bottom:true,backDisable:true,module:'message'};MessageIndex.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/message/messageIndex.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.init();localStorage.setItem('module','message');I18n.fillArea($('#navTop'));I18n.fillArea($('#ulMessageDivide'));});},init:function(){_this.initWorkflow();_this.initReport();_this.initSchedule();_this.initAffairs();var msg;if(localStorage.getItem('pushMsg')){try{msg=JSON.parse(localStorage.getItem('pushMsg'));msg=msg.filter(function(item){return item.type=='message'});}catch(e){msg=null;}
if(msg instanceof Array&&msg.length>0){_this.initMessagePush(msg);}}
_this.initMessagePushEvent();},initWorkflow:function(){},initReport:function(){var $liReportMsg=$('#liReportMsg');WebAPI.get("/get_plant_pagedetails/"+ProjectConfig.projectId+"/"+AppConfig.userId).done(function(result){if(result.navItems&&result.navItems.length>0){ProjectConfig.reportList=result.navItems.filter(function(item){return item.type==='FacReportWrapScreen';});if(ProjectConfig.reportList.length==0){ProjectConfig.reportList=result.navItems.filter(function(item){return item.type==='ReportScreen';});}
$liReportMsg.find('.spinner').hide();$liReportMsg.find('.badge').html(ProjectConfig.reportList.length);$liReportMsg.off('tap').on('tap',function(){if(ProjectConfig.reportList.length>0){if(ProjectConfig.reportList[0].type=='FacReportWrapScreen'){ProjectConfig.reportPageId=ProjectConfig.reportList[0].id;router.to({typeClass:MessageFactoryReport})}else{router.to({typeClass:MessageReport})}}});}else{window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.message.REPORT_ERR,'short','center');}}).fail(function(e){$liReportMsg.find('.spinner').hide();$liReportMsg.find('.badge').html('0');window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.message.REPORT_ERR,'short','center');}).always(function(){Spinner.stop();});},initSchedule:function(){},initAffairs:function(){},initMessagePush:function(msg){var $liMsgPush=$('#liMsgPush');if(msg&&msg.length>0){$liMsgPush.find('.badge').text(msg.length).css('display','block');}else{window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.message.REPORT_ERR,'short','center');}
Spinner.stop();},initMessagePushEvent:function(){var msg;var $liMsgPush=$('#liMsgPush');$liMsgPush.off('tap').on('tap',function(){try{msg=JSON.parse(localStorage.getItem('pushMsg'));msg=msg.filter(function(item){return item.type=='message'});}catch(e){msg=[];}
router.to({typeClass:MessagePush,data:msg})});},close:function(){}};return MessageIndex;})();var MessageWorkflow=(function(){function MessageWorkflow(){}
return MessageWorkflow;})();var MessageReport=(function(){var _this=this;function MessageReport(reportDate){_this=this;this.reportDate=reportDate;}
MessageReport.navOptions={top:'<div class="topNavTitle" i18n="appDashboard.message.MY_REPORT"></div>',bottom:true,backDisable:false,module:'message'};MessageReport.prototype={reportTypeMap:{daily:'0',monthly:'1',weekly:'2'},reportSummaryShow:{'KPIReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'KPIMonthReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']},'report-unit-2':{'page-header':true,'report-unit-2-1':['well','summary','canvas-container']}},'CostReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'MonthPatternReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'CostMonthReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'DailyReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'RunReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'DiagnosisReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}}},reportIcon:{'KPI':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#272636" d="M938.88 83.392 540.992 83.392 540.992 39.68C540.992 23.68 528 10.688 512 10.688c-16 0-28.928 12.992-28.928 28.992l0 43.712L85.12 83.392c-36.288 0-65.664 29.376-65.664 65.664l0 540.864c0 36.288 29.376 65.664 65.664 65.664l397.952 0 0 33.024-179.84 136.32c-12.736 9.664-15.232 27.84-5.568 40.576 9.664 12.736 27.84 15.232 40.576 5.568l144.896-109.76 0 41.92c0 16 12.992 28.928 28.928 28.928 16 0 28.992-12.992 28.992-28.928l0-41.92 144.896 109.76c5.248 3.968 11.392 5.888 17.472 5.888 8.768 0 17.408-3.968 23.104-11.456 9.664-12.736 7.168-30.912-5.568-40.576l-179.84-136.32 0-33.024 397.952 0c36.288 0 65.664-29.376 65.664-65.664L1004.736 149.056C1004.608 112.768 975.168 83.392 938.88 83.392L938.88 83.392zM946.688 689.92c0 4.288-3.456 7.744-7.744 7.744L85.12 697.664c-4.288 0-7.744-3.456-7.744-7.744L77.376 149.056c0-4.288 3.456-7.744 7.744-7.744L938.88 141.312c4.288 0 7.744 3.456 7.744 7.744L946.624 689.92 946.688 689.92zM817.152 314.688 606.208 485.312 383.104 333.888C372.096 326.4 357.376 327.424 347.456 336.32L169.216 496.768C157.376 507.456 156.352 525.76 167.104 537.664 177.792 549.568 196.096 550.528 208 539.84l161.344-145.216 222.144 150.72c4.928 3.328 10.624 4.992 16.256 4.992 6.464 0 12.928-2.176 18.24-6.464l227.648-184.128c12.416-10.048 14.336-28.288 4.288-40.704C847.872 306.56 829.632 304.64 817.152 314.688L817.152 314.688zM817.152 314.688" />\
                    </svg>','Cost':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#272636" d="M271.232 591.232l562.88 0 0 51.584L271.232 642.816 271.232 591.232 271.232 591.232 271.232 591.232zM271.232 591.232" />\
                        <path class="svgpath" data-index="path_1" fill="#272636" d="M269.888 789.184l562.88 0 1.28 55.36L271.232 844.544 269.888 789.184 269.888 789.184 269.888 789.184zM269.888 789.184" />\
                        <path class="svgpath" data-index="path_2" fill="#272636" d="M573.824 388.672l260.288 0 0 52.48L573.824 441.152 573.824 388.672 573.824 388.672 573.824 388.672zM573.824 388.672" />\
                        <path class="svgpath" data-index="path_3" fill="#272636" d="M629.76 186.048l204.352 0 0 53.44L629.76 239.488 629.76 186.048 629.76 186.048 629.76 186.048zM629.76 186.048" />\
                        <path class="svgpath" data-index="path_4" fill="#272636" d="M881.088 1006.592 198.208 1006.592c-44.992 0-81.536-38.4-81.536-85.504L116.672 102.912c0-47.104 36.544-85.504 81.536-85.504l682.88 0c44.992 0 81.536 38.4 81.536 85.504l0 818.112C962.624 968.192 926.016 1006.592 881.088 1006.592L881.088 1006.592 881.088 1006.592zM187.648 69.184c-9.216 0-16.96 9.664-16.96 21.056L170.688 933.76c0 11.456 7.808 21.056 16.96 21.056l704 0c9.216 0 16.96-9.664 16.96-21.056L908.608 90.24c0-11.456-7.808-21.056-16.96-21.056L187.648 69.184 187.648 69.184 187.648 69.184zM187.648 69.184" />\
                        <path class="svgpath" data-index="path_5" fill="#272636" d="M490.688 334.848C498.112 347.52 501.888 362.24 501.888 379.2c0 25.92-7.744 47.552-23.168 64.832-15.488 17.28-37.76 27.52-66.944 30.592l0 44.416L374.592 519.04 374.592 474.816c-48.576-4.992-78.72-33.28-90.304-84.736L341.76 375.04c5.312 32.384 22.912 48.576 52.864 48.576 14.016 0 24.32-3.456 30.912-10.432 6.592-6.976 9.92-15.296 9.92-25.088 0-10.176-3.328-17.856-9.92-23.04C419.008 359.808 404.288 353.216 381.568 345.152c-20.416-7.104-36.416-14.08-47.936-21.056C322.176 317.184 312.832 307.52 305.664 295.04 298.432 282.56 294.912 267.968 294.912 251.456c0-21.696 6.464-41.344 19.2-58.688C326.976 175.36 347.072 164.736 374.592 160.832L374.592 126.592l37.184 0 0 34.304c41.536 4.992 68.48 28.48 80.768 70.528L441.216 252.416c-9.984-28.8-25.344-43.264-46.336-43.264-10.496 0-18.88 3.2-25.216 9.664-6.4 6.464-9.6 14.272-9.6 23.424 0 9.344 3.072 16.512 9.216 21.504 6.144 4.992 19.2 11.2 39.36 18.496 22.016 8.064 39.424 15.744 51.904 22.848C473.152 312.32 483.136 322.24 490.688 334.848L490.688 334.848 490.688 334.848zM490.688 334.848" />\
                    </svg>','Pattern':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                            <path class="svgpath" data-index="path_0" fill="#272636" d="M211.776 531.328l0 240.192L91.712 771.52 91.712 531.328 211.776 531.328M211.776 471.296 91.712 471.296c-33.088 0-60.032 26.944-60.032 60.032l0 240.192c0 33.152 26.944 60.032 60.032 60.032l120.064 0c33.088 0 60.032-26.944 60.032-60.032L271.808 531.328C271.808 498.24 244.928 471.296 211.776 471.296L211.776 471.296 211.776 471.296zM211.776 471.296" />\
                            <path class="svgpath" data-index="path_1" fill="#272636" d="M572.032 111.04l0 660.48L451.968 771.52 451.968 111.04 572.032 111.04M572.032 51.008 451.968 51.008c-33.088 0-60.032 26.944-60.032 60.032l0 660.48c0 33.152 26.944 60.032 60.032 60.032l120.064 0c33.088 0 60.032-26.944 60.032-60.032L632.064 111.04C632.064 77.952 605.184 51.008 572.032 51.008L572.032 51.008 572.032 51.008zM572.032 51.008" />\
                            <path class="svgpath" data-index="path_2" fill="#272636" d="M932.288 291.2 932.288 291.2 932.288 291.2l0 480.32 0 0-120.064 0 0 0L812.224 291.2l0 0L932.288 291.2M932.288 231.168l-120.064 0c-33.152 0-60.032 26.944-60.032 60.032l0 480.32c0 33.152 26.944 60.032 60.032 60.032l120.064 0c33.088 0 60.032-26.944 60.032-60.032L992.32 291.2C992.32 258.048 965.44 231.168 932.288 231.168L932.288 231.168 932.288 231.168zM932.288 231.168" />\
                            <path class="svgpath" data-index="path_3" fill="#272636" d="M962.304 951.68 61.696 951.68c-16.576 0-30.016-13.44-30.016-30.016 0-16.576 13.44-30.016 30.016-30.016l900.672 0c16.576 0 30.016 13.44 30.016 30.016C992.32 938.24 978.944 951.68 962.304 951.68L962.304 951.68zM962.304 951.68" />\
                        </svg>','Daily':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                            <path class="svgpath" data-index="path_0" fill="#272636" d="M880.128 1000.704 123.072 1000.704c-18.816 0-34.112-15.296-34.112-34.112L88.96 73.6c0-18.816 15.296-34.112 34.112-34.112l757.056 0c18.816 0 34.112 15.296 34.112 34.112l0 893.056C914.176 985.472 898.944 1000.704 880.128 1000.704L880.128 1000.704zM157.184 932.544l688.832 0L846.016 107.712 157.184 107.712 157.184 932.544 157.184 932.544zM157.184 932.544" />\
                            <path class="svgpath" data-index="path_1" fill="#272636" d="M743.296 278.08 259.904 278.08c-18.816 0-34.112-15.296-34.112-34.112 0-18.816 15.296-34.112 34.112-34.112l483.392 0c18.816 0 34.112 15.296 34.112 34.112C777.408 262.848 762.112 278.08 743.296 278.08L743.296 278.08zM743.296 278.08" />\
                            <path class="svgpath" data-index="path_2" fill="#272636" d="M604.8 484.352 260.224 484.352c-18.816 0-34.112-15.232-34.112-34.112 0-18.816 15.232-34.112 34.112-34.112L604.8 416.128c18.816 0 34.112 15.296 34.112 34.112C638.912 469.056 623.616 484.352 604.8 484.352L604.8 484.352zM604.8 484.352" />\
                            <path class="svgpath" data-index="path_3" fill="#272636" d="M536 654.912 260.224 654.912c-18.816 0-34.112-15.296-34.112-34.112 0-18.816 15.232-34.112 34.112-34.112l275.712 0c18.816 0 34.112 15.232 34.112 34.112C570.048 639.616 554.816 654.912 536 654.912L536 654.912zM536 654.912" />\
                            <path class="svgpath" data-index="path_4" fill="#272636" d="M535.616 828.096 259.904 828.096c-18.816 0-34.112-15.232-34.112-34.112 0-18.816 15.296-34.112 34.112-34.112l275.712 0c18.816 0 34.112 15.232 34.112 34.112C569.728 812.864 554.432 828.096 535.616 828.096L535.616 828.096zM535.616 828.096" />\
                            <path class="svgpath" data-index="path_5" fill="#272636" d="M707.648 415.168l68.672 0 0 68.288-68.672 0L707.648 415.168 707.648 415.168zM707.648 415.168" />\
                            <path class="svgpath" data-index="path_6" fill="#272636" d="M707.648 587.776l68.672 0 0 68.288-68.672 0L707.648 587.776 707.648 587.776zM707.648 587.776" />\
                            <path class="svgpath" data-index="path_7" fill="#272636" d="M707.648 758.784l68.672 0 0 68.288-68.672 0L707.648 758.784 707.648 758.784zM707.648 758.784" />\
                        </svg>','Run':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#272636" d="M179.456 123.136c0 0-66.432-2.176-66.432 68.608l0 746.112c0 0-3.264 64.256 67.52 69.632l678.464 0c0 0 72.96 4.032 69.76-68.032l0-748.8c0 0 5.44-63.872-68.608-68.224l-145.216 0 0 59.008 132.736 0c0 0 22.144-1.792 21.824 17.408l0 731.328c0 0 1.472 18.88-15.232 18.88L187.008 949.056c0 0-17.088 0.704-16.512-17.472L170.496 201.728c0 0-1.6-21.056 17.984-20.736l137.408 0L325.888 122.88 179.456 123.136 179.456 123.136 179.456 123.136zM179.456 123.136" />\
                        <path class="svgpath" data-index="path_1" fill="#272636" d="M378.88 556.16c0 8.832-6.528 16.064-14.656 16.064l-27.52 0c-8.128 0-14.72-7.232-14.72-16.064L321.984 275.712c0-8.896 6.592-16.128 14.72-16.128l27.52 0c8.128 0 14.656 7.232 14.656 16.128L378.88 556.16 378.88 556.16 378.88 556.16zM378.88 556.16" />\
                        <path class="svgpath" data-index="path_2" fill="#272636" d="M547.456 550.016c0 8.64-6.272 15.744-14.016 15.744l-26.24 0c-7.744 0-14.016-7.04-14.016-15.744L493.184 275.328c0-8.704 6.272-15.808 14.016-15.808l26.24 0c7.744 0 14.016 7.04 14.016 15.808L547.456 550.016 547.456 550.016 547.456 550.016zM547.456 550.016" />\
                        <path class="svgpath" data-index="path_3" fill="#272636" d="M716.16 553.28c0 8.64-6.272 15.744-14.016 15.744l-26.24 0c-7.744 0-14.016-7.04-14.016-15.744L661.888 278.592c0-8.704 6.272-15.808 14.016-15.808l26.24 0c7.744 0 14.016 7.04 14.016 15.808L716.16 553.28 716.16 553.28 716.16 553.28zM716.16 553.28" />\
                        <path class="svgpath" data-index="path_4" fill="#272636" d="M724.288 707.648c0 7.744-7.808 14.016-17.408 14.016L334.208 721.664c-9.6 0-17.408-6.272-17.408-14.016l0-26.176c0-7.744 7.808-13.952 17.408-13.952l372.672 0c9.6 0 17.408 6.272 17.408 13.952L724.288 707.648 724.288 707.648 724.288 707.648zM724.288 707.648" />\
                        <path class="svgpath" data-index="path_5" fill="#272636" d="M724.288 842.432c0 7.36-7.808 13.376-17.408 13.376L334.208 855.808c-9.6 0-17.408-5.952-17.408-13.376l0-25.088c0-7.36 7.808-13.376 17.408-13.376l372.672 0c9.6 0 17.408 5.952 17.408 13.376L724.288 842.432 724.288 842.432 724.288 842.432zM724.288 842.432" />\
                        <path class="svgpath" data-index="path_6" fill="#272636" d="M647.488 122.432 567.616 35.648C543.04 14.144 519.68 16.512 519.68 16.512 490.816 14.976 471.488 35.328 471.488 35.328L392.704 122.432 316.48 122.88l0 58.176 408.384 0.448-0.256-59.008L647.488 122.496 647.488 122.432 647.488 122.432zM462.272 122.432l47.36-55.488C520.192 53.76 530.944 66.368 530.944 66.368l45.888 56.064L462.272 122.432 462.272 122.432 462.272 122.432zM462.272 122.432" />\
                    </svg>','Diagnosis':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                            <path class="svgpath" data-index="path_0" fill="#272636" d="M316.864 681.728c41.984 0 75.968-32 75.968-71.424 0-14.336-4.544-27.776-12.352-38.912L462.208 443.52C464.384 443.712 466.56 443.84 468.864 443.84c2.24 0 4.416-0.128 6.656-0.32l81.664 127.872C549.312 582.592 544.768 595.968 544.768 610.304c0 39.424 34.048 71.424 75.968 71.424 41.984 0 75.968-32 75.968-71.424 0-14.912-4.864-28.736-13.184-40.192l134.784-221.632c1.664 0.128 3.392 0.192 4.992 0.192 41.984 0 75.968-31.936 75.968-71.36 0-39.424-34.048-71.424-75.968-71.424-41.92 0-75.968 32-75.968 71.424 0 14.976 4.864 28.736 13.248 40.192L625.792 539.136C624.128 539.008 622.464 538.944 620.8 538.944c-2.24 0-4.416 0.128-6.656 0.32L532.48 411.392c7.808-11.2 12.352-24.576 12.352-38.976 0-39.424-33.984-71.36-75.968-71.36-41.984 0-75.968 31.936-75.968 71.36 0 14.4 4.544 27.776 12.352 38.976L323.52 539.264C321.344 539.072 319.104 538.944 316.864 538.944c-41.92 0-75.968 31.936-75.968 71.36S274.944 681.728 316.864 681.728L316.864 681.728zM936.448 901.824 93.952 901.824 93.952 59.328c0-20.224-16.384-36.608-36.608-36.608-20.224 0-36.608 16.384-36.608 36.608l0 879.104c0 20.224 16.384 36.608 36.608 36.608l879.104 0c20.224 0 36.608-16.384 36.608-36.608C973.056 918.208 956.672 901.824 936.448 901.824L936.448 901.824zM936.448 901.824" />\
                        </svg> ','Month':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#272636" d="M246.912 727.04c26.56 20.544 56.512 30.848 89.984 30.848 26.752 0 47.872-6.528 63.488-19.648 15.616-13.12 23.424-30.72 23.424-52.736 0-49.088-35.136-73.664-105.472-73.664L286.016 611.84 286.016 571.2 316.8 571.2c62.272 0 93.44-23.04 93.44-69.184 0-42.624-23.808-63.872-71.424-63.872-27.2 0-52.864 9.216-76.928 27.584L261.888 419.392c25.408-14.72 55.04-22.08 88.96-22.08 33.088 0 59.648 8.64 79.68 25.92 20.032 17.28 30.08 39.744 30.08 67.264 0 50.752-25.92 83.456-77.696 97.984l0 1.024c28.032 3.008 50.24 12.928 66.496 29.696 16.256 16.768 24.448 37.696 24.448 62.784 0 34.944-12.544 63.04-37.696 84.416-25.152 21.376-58.624 32.064-100.352 32.064-36.736 0-66.432-6.848-88.96-20.544L246.912 727.04 246.912 727.04zM246.912 727.04" />\
                        <path class="svgpath" data-index="path_1" fill="#272636" d="M534.784 605.504c0-68.48 11.328-120.32 34.048-155.456s55.616-52.736 98.752-52.736c82.176 0 123.264 66.304 123.264 198.976 0 65.472-11.584 115.584-34.688 150.208-23.168 34.688-55.616 51.968-97.344 51.968-39.424 0-69.952-16.448-91.584-49.344C545.6 716.224 534.784 668.352 534.784 605.504L534.784 605.504zM584.896 603.264c0 103.04 26.112 154.624 78.4 154.624 51.456 0 77.184-52.352 77.184-157.12 0-108.416-25.216-162.624-75.648-162.624C611.584 438.144 584.896 493.184 584.896 603.264L584.896 603.264zM584.896 603.264" />\
                        <path class="svgpath" data-index="path_2" fill="#272636" d="M831.744 81.664c-17.92 0-32.512-14.656-32.512-32.512L799.232 42.496c0-17.92-14.656-32.512-32.512-32.512l-6.656 0c-17.92 0-32.512 14.656-32.512 32.512l0 6.656c0 17.92-14.656 32.512-32.512 32.512L329.344 81.664c-17.92 0-32.512-14.656-32.512-32.512L296.832 42.496c0-17.92-14.656-32.512-32.512-32.512L257.6 9.984c-17.92 0-32.512 14.656-32.512 32.512l0 6.656c0 17.92-14.656 32.512-32.512 32.512L42.432 81.664c-17.92 0-32.512 14.656-32.512 32.512l0 867.328c0 17.92 14.656 32.512 32.512 32.512l939.072 0c17.856 0 32.512-14.656 32.512-32.512L1014.016 114.176c0-17.856-14.656-32.512-32.512-32.512L831.744 81.664 831.744 81.664zM942.4 909.824c0 17.856-14.656 32.512-32.512 32.512L114.176 942.336c-17.92 0-32.512-14.656-32.512-32.512L81.664 185.92c0-17.92 14.656-32.512 32.512-32.512l78.4 0c17.92 0 32.512 14.656 32.512 32.512L225.088 227.2c0 17.92 14.656 32.512 32.512 32.512L264.32 259.712c17.92 0 32.512-14.656 32.512-32.512L296.832 185.92c0-17.92 14.656-32.512 32.512-32.512l365.568 0c17.92 0 32.512 14.656 32.512 32.512L727.424 227.2c0 17.92 14.656 32.512 32.512 32.512l6.656 0c17.92 0 32.512-14.656 32.512-32.512L799.104 185.92c0-17.92 14.656-32.512 32.512-32.512l78.08 0c17.92 0 32.512 14.656 32.512 32.512L942.4 909.824 942.4 909.824zM942.4 909.824" />\
                    </svg>'},reportSummaryTemplate:'\
        <div style="width: 100%; height: 100%; overflow-x: hidden; overflow-y: hidden;" id="beopReport">\
            <link rel="stylesheet" href="/static/projectReports/report.css"/>\
            <div class="step-container col-xs-12 col-md-8 col-md-offset-2 report-block scrollbar">\
                <div class="step-play-container">\
                    <div class="step-play-list">\
                    </div>\
                </div>\
            </div>\
        </div>',show:function(){$.ajax({url:'static/app/dashboard/views/message/messageReport.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.init();I18n.fillArea($('#navTop'));});},init:function(){_this.initReportList();},initReportList:function(){var $container=$('#containerMessageReport');var num=0;ProjectConfig.reportList.forEach(function(val,i){var version=_this.getReportVersion(val);var reportFolder=val.reportFolder;var reportSummaryIndex=_this.reportSummaryShow[reportFolder];var strPanelReport=new StringBuilder();var icon=_this.initReportIcon(reportFolder);strPanelReport.append('<div class="panel panel-primary panel'+reportFolder+'">');strPanelReport.append('    <div class="panel-heading" role="tab" id="reportTitle_'+i+'"> ');strPanelReport.append('        <div class="divIcon">');strPanelReport.append('<span class="spMainIcon">'+icon.main+'</span>');if(icon.add!=''){strPanelReport.append('<span class="spAddIcon">'+_this.initReportIcon(reportFolder).add+'</span>');}
strPanelReport.append('        </div>');strPanelReport.append('        <h4 class="panel-title">');strPanelReport.append('            <a class="aCollapse collapsed" role="button" data-toggle="collapse" data-parent="#containerMessageReport" href="#divReport_'+i+'" aria-expanded="false" aria-controls="divReport_'+i+'">');strPanelReport.append('                <span class="reportType">'+val.text+'</span>');strPanelReport.append('                <span class="reportTime">'+version+'</span>');strPanelReport.append('            </a>');strPanelReport.append('        </h4>');strPanelReport.append('    </div>');strPanelReport.append('    <div id="divReport_'+i+'" class="panel-collapse collapse div'+reportFolder+'" role="tabpanel" aria-labelledby="reportTitle_'+i+'">');strPanelReport.append('        <div class="panel-body" id="'+val.id+'">');strPanelReport.append('        </div>');strPanelReport.append('        <div class="btnDetail zepto-ev additionText" report-to="'+val.id+'">'+I18n.resource.appDashboard.message.MORE);strPanelReport.append('        </div>');strPanelReport.append('    </div>');strPanelReport.append('</div>');$container.append(strPanelReport.toString());SpinnerControl.show();WebAPI.get('/report/getReport/'+ProjectConfig.projectInfo.name_en+'/'+reportFolder+'/'+version).done(function(result){var tempDiv=document.createElement('div');tempDiv.innerHTML=result;var subUnit;var strReportContent=new StringBuilder();strReportContent.append('<div style="width: 100%; height: 100%; overflow-x: hidden; overflow-y: hidden;" id="beopReport">\
                                                <div class="step-container col-xs-12 col-md-8 col-md-offset-2 report-block scrollbar">\
                                                    <div class="step-play-container">\
                                                        <div class="step-play-list">');for(var k in reportSummaryIndex){strReportContent.append('               <div class="step-item-container" id="'+k+'">');for(var l in reportSummaryIndex[k]){if(l=='page-header'){strReportContent.append(tempDiv.querySelector('#'+k+'>.'+l).outerHTML);}else{strReportContent.append('<div class="report-unit" id="'+l+'">');for(var m=0;m<reportSummaryIndex[k][l].length;m++){subUnit=tempDiv.querySelector('#'+k+'>#'+l+'>.'+reportSummaryIndex[k][l][m]);if(!subUnit)continue;strReportContent.append(subUnit.outerHTML);}
strReportContent.append('</div>');}}
strReportContent.append('               </div>');}
strReportContent.append('           </div>');strReportContent.append('       </div>');strReportContent.append('   </div>');strReportContent.append('</div>');$('#'+val.id).append(strReportContent.toString()).append(tempDiv.querySelector('#tmpl_table'));if(num==ProjectConfig.reportList.length-1){var $reportUnit=$('#beopReport .report-unit');$reportUnit.find('.canvas-container').css({height:'300px',width:($(ElScreenContainer).width()-60)+'px'});_this.reportScreen=new ReportScreen();_this.reportScreen.renderCharts($reportUnit);var $table=$('table');for(var n=0;n<$table.length;n++){$table.eq(n).removeClass('table-striped');$table[n].outerHTML='<div class="tableContainer">'+$table[n].outerHTML+'</div>'}
_this.initReportDetail();}
num+=1;}).always(function(){SpinnerControl.hide();});})},initReportDetail:function(){var btnReportDetail=$('.panel-collapse .btnDetail');var strReportTime;btnReportDetail.off('tap').on('tap',function(e){e.preventDefault();e.stopPropagation();strReportTime=$(e.currentTarget).parentsUntil('#containerMessageReport','.panel').find('.reportTime').html();for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i].id==$(e.currentTarget).attr('report-to')){ProjectConfig.reportIndex=i;ProjectConfig.reportDetail=ProjectConfig.reportList[i];router.to({typeClass:ProjectReport,data:{}});break;}}})},getReportVersion:function(reportInfo){var thisDay,version;var reportType=reportInfo.reportType;var year,month,day;if(ProjectConfig.reportDate&&new Date(ProjectConfig.reportDate)!='Invalid Date'){thisDay=new Date(ProjectConfig.reportDate);}else{thisDay=new Date();}
if(reportType===this.reportTypeMap.daily){if(!month||!year||!day){if(thisDay.format('yyyy/MM/dd')==new Date().format('yyyy/MM/dd')){thisDay.setDate(thisDay.getDate()-1);}
version=thisDay.format('yyyy-MM-dd');year=thisDay.getFullYear();month=thisDay.getMonth()+1;day=thisDay.getDate();}else{version=year+"-"+StringUtil.padLeft(month,2,'0')+"-"+StringUtil.padLeft(day,2,'0');}}
else if(reportType===this.reportTypeMap.monthly){if(!month||!year){if(thisDay.format('yyyy/MM')==new Date().format('yyyy/MM')){thisDay.setMonth(thisDay.getMonth()-1);}
year=thisDay.getFullYear();month=thisDay.getMonth()+1;}
version=year+'-'+StringUtil.padLeft(month,2,'0');}else{year=thisDay.getFullYear();month=month?month:(_this.iso8601Week(new Date(year,thisDay.getMonth()-1)));version=year+'-'+month+'-w';}
return version;},initReportIcon:function(reportType){var icon={main:'',add:''};if(reportType.indexOf('KPI')>-1){icon.main=_this.reportIcon['KPI'];}else if(reportType.indexOf('Cost')>-1){icon.main=_this.reportIcon['Cost'];}else if(reportType.indexOf('Pattern')>-1){icon.main=_this.reportIcon['Pattern'];}else if(reportType.indexOf('Daily')>-1){icon.main=_this.reportIcon['Daily'];}else if(reportType.indexOf('Run')>-1){icon.main=_this.reportIcon['Run'];}else if(reportType.indexOf('Diagnosis')>-1){icon.main=_this.reportIcon['Diagnosis'];}
return icon},iso8601Week:function(date){var time,checkDate=new Date(date.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},close:function(){}};return MessageReport;})();var MessagePush=(function(){var _this=this;function MessagePush(messageDate){_this=this;this.messageDate=messageDate;}
MessagePush.navOptions={top:'<div class="topNavTitle" i18n="appDashboard.message.MESSAGE_CENTER"></div>',bottom:true,backDisable:false,module:'message'};MessagePush.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/message/messagePush.html'}).done(function(resultHTML){$('#btnMessage .messageNum').hide();$(ElScreenContainer).html(resultHTML);_this.init();I18n.fillArea($('#navTop'));});},init:function(){_this.initHistoryList();_this.initMessageList();_this.clearCache();_this.resetHistory();},initMessageList:function(){var str='<ul id="messagePushList">';for(var i=0,len=this.messageDate.length;i<len;i++){str+='<li class="'+(this.messageDate[i].isHistory?'isHistory':'isNew')+'">\
                            <span href="">\
                                <h3>'+this.messageDate[i].title+'</h3>\
                                <span class="time">'+this.messageDate[i].time+'</span>\
                                <p class="content">'+this.messageDate[i].content+'</p>\
                            </span>\
                            <span class="btnRemove glyphicon glyphicon-remove zepto-ev"</span>\
                        </li>'}
str+="</ul>";$(".containerMessagePush").html(str);},initHistoryList:function(){var his;try{his=JSON.parse(localStorage.getItem('reportHistory'));}catch(e){}
if(his instanceof Array&&his.length>0){this.messageDate=this.messageDate.concat(his);}},clearCache:function(){var msg;try{msg=JSON.parse(localStorage.getItem('pushMsg'));msg=msg.filter(function(item){return item.type!='message'});localStorage.setItem('pushMsg',JSON.stringify(msg));}catch(e){msg=null;localStorage.removeItem('pushMsg');}},resetHistory:function(){var index;var liPushList=$('#messagePushList').children('li');this.messageDate.forEach(function(val){val.isHistory=true;});localStorage.setItem('reportHistory',JSON.stringify(_this.messageDate));liPushList.find('.btnRemove').off('tap').on('tap',function(e){liPushList=$('#messagePushList').children('li');index=liPushList.index($(e.currentTarget).parent());$(e.currentTarget).parent().remove();_this.messageDate.splice(index,1);localStorage.setItem('reportHistory',JSON.stringify(_this.messageDate));})},close:function(){}};return MessagePush;})();var MessageFactoryReport=(function(){var _this=this;function MessageFactoryReport(reportDate){_this=this;this.reportDate=reportDate;}
MessageFactoryReport.navOptions={top:'<div class="topNavTitle" i18n="appDashboard.message.MY_REPORT"></div>',bottom:true,backDisable:false,module:'message'};MessageFactoryReport.prototype={reportTypeMap:{day:'0',month:'1',week:'2'},reportSummaryShow:{'KPIReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'KPIMonthReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']},'report-unit-2':{'page-header':true,'report-unit-2-1':['well','summary','canvas-container']}},'CostReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'MonthPatternReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'CostMonthReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'DailyReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'RunReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}},'DiagnosisReport':{'report-unit-1':{'page-header':true,'report-unit-1-1':['well','summary','canvas-container']}}},reportIcon:{'KPI':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#272636" d="M938.88 83.392 540.992 83.392 540.992 39.68C540.992 23.68 528 10.688 512 10.688c-16 0-28.928 12.992-28.928 28.992l0 43.712L85.12 83.392c-36.288 0-65.664 29.376-65.664 65.664l0 540.864c0 36.288 29.376 65.664 65.664 65.664l397.952 0 0 33.024-179.84 136.32c-12.736 9.664-15.232 27.84-5.568 40.576 9.664 12.736 27.84 15.232 40.576 5.568l144.896-109.76 0 41.92c0 16 12.992 28.928 28.928 28.928 16 0 28.992-12.992 28.992-28.928l0-41.92 144.896 109.76c5.248 3.968 11.392 5.888 17.472 5.888 8.768 0 17.408-3.968 23.104-11.456 9.664-12.736 7.168-30.912-5.568-40.576l-179.84-136.32 0-33.024 397.952 0c36.288 0 65.664-29.376 65.664-65.664L1004.736 149.056C1004.608 112.768 975.168 83.392 938.88 83.392L938.88 83.392zM946.688 689.92c0 4.288-3.456 7.744-7.744 7.744L85.12 697.664c-4.288 0-7.744-3.456-7.744-7.744L77.376 149.056c0-4.288 3.456-7.744 7.744-7.744L938.88 141.312c4.288 0 7.744 3.456 7.744 7.744L946.624 689.92 946.688 689.92zM817.152 314.688 606.208 485.312 383.104 333.888C372.096 326.4 357.376 327.424 347.456 336.32L169.216 496.768C157.376 507.456 156.352 525.76 167.104 537.664 177.792 549.568 196.096 550.528 208 539.84l161.344-145.216 222.144 150.72c4.928 3.328 10.624 4.992 16.256 4.992 6.464 0 12.928-2.176 18.24-6.464l227.648-184.128c12.416-10.048 14.336-28.288 4.288-40.704C847.872 306.56 829.632 304.64 817.152 314.688L817.152 314.688zM817.152 314.688" />\
                    </svg>','Cost':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#272636" d="M271.232 591.232l562.88 0 0 51.584L271.232 642.816 271.232 591.232 271.232 591.232 271.232 591.232zM271.232 591.232" />\
                        <path class="svgpath" data-index="path_1" fill="#272636" d="M269.888 789.184l562.88 0 1.28 55.36L271.232 844.544 269.888 789.184 269.888 789.184 269.888 789.184zM269.888 789.184" />\
                        <path class="svgpath" data-index="path_2" fill="#272636" d="M573.824 388.672l260.288 0 0 52.48L573.824 441.152 573.824 388.672 573.824 388.672 573.824 388.672zM573.824 388.672" />\
                        <path class="svgpath" data-index="path_3" fill="#272636" d="M629.76 186.048l204.352 0 0 53.44L629.76 239.488 629.76 186.048 629.76 186.048 629.76 186.048zM629.76 186.048" />\
                        <path class="svgpath" data-index="path_4" fill="#272636" d="M881.088 1006.592 198.208 1006.592c-44.992 0-81.536-38.4-81.536-85.504L116.672 102.912c0-47.104 36.544-85.504 81.536-85.504l682.88 0c44.992 0 81.536 38.4 81.536 85.504l0 818.112C962.624 968.192 926.016 1006.592 881.088 1006.592L881.088 1006.592 881.088 1006.592zM187.648 69.184c-9.216 0-16.96 9.664-16.96 21.056L170.688 933.76c0 11.456 7.808 21.056 16.96 21.056l704 0c9.216 0 16.96-9.664 16.96-21.056L908.608 90.24c0-11.456-7.808-21.056-16.96-21.056L187.648 69.184 187.648 69.184 187.648 69.184zM187.648 69.184" />\
                        <path class="svgpath" data-index="path_5" fill="#272636" d="M490.688 334.848C498.112 347.52 501.888 362.24 501.888 379.2c0 25.92-7.744 47.552-23.168 64.832-15.488 17.28-37.76 27.52-66.944 30.592l0 44.416L374.592 519.04 374.592 474.816c-48.576-4.992-78.72-33.28-90.304-84.736L341.76 375.04c5.312 32.384 22.912 48.576 52.864 48.576 14.016 0 24.32-3.456 30.912-10.432 6.592-6.976 9.92-15.296 9.92-25.088 0-10.176-3.328-17.856-9.92-23.04C419.008 359.808 404.288 353.216 381.568 345.152c-20.416-7.104-36.416-14.08-47.936-21.056C322.176 317.184 312.832 307.52 305.664 295.04 298.432 282.56 294.912 267.968 294.912 251.456c0-21.696 6.464-41.344 19.2-58.688C326.976 175.36 347.072 164.736 374.592 160.832L374.592 126.592l37.184 0 0 34.304c41.536 4.992 68.48 28.48 80.768 70.528L441.216 252.416c-9.984-28.8-25.344-43.264-46.336-43.264-10.496 0-18.88 3.2-25.216 9.664-6.4 6.464-9.6 14.272-9.6 23.424 0 9.344 3.072 16.512 9.216 21.504 6.144 4.992 19.2 11.2 39.36 18.496 22.016 8.064 39.424 15.744 51.904 22.848C473.152 312.32 483.136 322.24 490.688 334.848L490.688 334.848 490.688 334.848zM490.688 334.848" />\
                    </svg>','Pattern':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                            <path class="svgpath" data-index="path_0" fill="#272636" d="M211.776 531.328l0 240.192L91.712 771.52 91.712 531.328 211.776 531.328M211.776 471.296 91.712 471.296c-33.088 0-60.032 26.944-60.032 60.032l0 240.192c0 33.152 26.944 60.032 60.032 60.032l120.064 0c33.088 0 60.032-26.944 60.032-60.032L271.808 531.328C271.808 498.24 244.928 471.296 211.776 471.296L211.776 471.296 211.776 471.296zM211.776 471.296" />\
                            <path class="svgpath" data-index="path_1" fill="#272636" d="M572.032 111.04l0 660.48L451.968 771.52 451.968 111.04 572.032 111.04M572.032 51.008 451.968 51.008c-33.088 0-60.032 26.944-60.032 60.032l0 660.48c0 33.152 26.944 60.032 60.032 60.032l120.064 0c33.088 0 60.032-26.944 60.032-60.032L632.064 111.04C632.064 77.952 605.184 51.008 572.032 51.008L572.032 51.008 572.032 51.008zM572.032 51.008" />\
                            <path class="svgpath" data-index="path_2" fill="#272636" d="M932.288 291.2 932.288 291.2 932.288 291.2l0 480.32 0 0-120.064 0 0 0L812.224 291.2l0 0L932.288 291.2M932.288 231.168l-120.064 0c-33.152 0-60.032 26.944-60.032 60.032l0 480.32c0 33.152 26.944 60.032 60.032 60.032l120.064 0c33.088 0 60.032-26.944 60.032-60.032L992.32 291.2C992.32 258.048 965.44 231.168 932.288 231.168L932.288 231.168 932.288 231.168zM932.288 231.168" />\
                            <path class="svgpath" data-index="path_3" fill="#272636" d="M962.304 951.68 61.696 951.68c-16.576 0-30.016-13.44-30.016-30.016 0-16.576 13.44-30.016 30.016-30.016l900.672 0c16.576 0 30.016 13.44 30.016 30.016C992.32 938.24 978.944 951.68 962.304 951.68L962.304 951.68zM962.304 951.68" />\
                        </svg>','Daily':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                            <path class="svgpath" data-index="path_0" fill="#272636" d="M880.128 1000.704 123.072 1000.704c-18.816 0-34.112-15.296-34.112-34.112L88.96 73.6c0-18.816 15.296-34.112 34.112-34.112l757.056 0c18.816 0 34.112 15.296 34.112 34.112l0 893.056C914.176 985.472 898.944 1000.704 880.128 1000.704L880.128 1000.704zM157.184 932.544l688.832 0L846.016 107.712 157.184 107.712 157.184 932.544 157.184 932.544zM157.184 932.544" />\
                            <path class="svgpath" data-index="path_1" fill="#272636" d="M743.296 278.08 259.904 278.08c-18.816 0-34.112-15.296-34.112-34.112 0-18.816 15.296-34.112 34.112-34.112l483.392 0c18.816 0 34.112 15.296 34.112 34.112C777.408 262.848 762.112 278.08 743.296 278.08L743.296 278.08zM743.296 278.08" />\
                            <path class="svgpath" data-index="path_2" fill="#272636" d="M604.8 484.352 260.224 484.352c-18.816 0-34.112-15.232-34.112-34.112 0-18.816 15.232-34.112 34.112-34.112L604.8 416.128c18.816 0 34.112 15.296 34.112 34.112C638.912 469.056 623.616 484.352 604.8 484.352L604.8 484.352zM604.8 484.352" />\
                            <path class="svgpath" data-index="path_3" fill="#272636" d="M536 654.912 260.224 654.912c-18.816 0-34.112-15.296-34.112-34.112 0-18.816 15.232-34.112 34.112-34.112l275.712 0c18.816 0 34.112 15.232 34.112 34.112C570.048 639.616 554.816 654.912 536 654.912L536 654.912zM536 654.912" />\
                            <path class="svgpath" data-index="path_4" fill="#272636" d="M535.616 828.096 259.904 828.096c-18.816 0-34.112-15.232-34.112-34.112 0-18.816 15.296-34.112 34.112-34.112l275.712 0c18.816 0 34.112 15.232 34.112 34.112C569.728 812.864 554.432 828.096 535.616 828.096L535.616 828.096zM535.616 828.096" />\
                            <path class="svgpath" data-index="path_5" fill="#272636" d="M707.648 415.168l68.672 0 0 68.288-68.672 0L707.648 415.168 707.648 415.168zM707.648 415.168" />\
                            <path class="svgpath" data-index="path_6" fill="#272636" d="M707.648 587.776l68.672 0 0 68.288-68.672 0L707.648 587.776 707.648 587.776zM707.648 587.776" />\
                            <path class="svgpath" data-index="path_7" fill="#272636" d="M707.648 758.784l68.672 0 0 68.288-68.672 0L707.648 758.784 707.648 758.784zM707.648 758.784" />\
                        </svg>','Run':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#272636" d="M179.456 123.136c0 0-66.432-2.176-66.432 68.608l0 746.112c0 0-3.264 64.256 67.52 69.632l678.464 0c0 0 72.96 4.032 69.76-68.032l0-748.8c0 0 5.44-63.872-68.608-68.224l-145.216 0 0 59.008 132.736 0c0 0 22.144-1.792 21.824 17.408l0 731.328c0 0 1.472 18.88-15.232 18.88L187.008 949.056c0 0-17.088 0.704-16.512-17.472L170.496 201.728c0 0-1.6-21.056 17.984-20.736l137.408 0L325.888 122.88 179.456 123.136 179.456 123.136 179.456 123.136zM179.456 123.136" />\
                        <path class="svgpath" data-index="path_1" fill="#272636" d="M378.88 556.16c0 8.832-6.528 16.064-14.656 16.064l-27.52 0c-8.128 0-14.72-7.232-14.72-16.064L321.984 275.712c0-8.896 6.592-16.128 14.72-16.128l27.52 0c8.128 0 14.656 7.232 14.656 16.128L378.88 556.16 378.88 556.16 378.88 556.16zM378.88 556.16" />\
                        <path class="svgpath" data-index="path_2" fill="#272636" d="M547.456 550.016c0 8.64-6.272 15.744-14.016 15.744l-26.24 0c-7.744 0-14.016-7.04-14.016-15.744L493.184 275.328c0-8.704 6.272-15.808 14.016-15.808l26.24 0c7.744 0 14.016 7.04 14.016 15.808L547.456 550.016 547.456 550.016 547.456 550.016zM547.456 550.016" />\
                        <path class="svgpath" data-index="path_3" fill="#272636" d="M716.16 553.28c0 8.64-6.272 15.744-14.016 15.744l-26.24 0c-7.744 0-14.016-7.04-14.016-15.744L661.888 278.592c0-8.704 6.272-15.808 14.016-15.808l26.24 0c7.744 0 14.016 7.04 14.016 15.808L716.16 553.28 716.16 553.28 716.16 553.28zM716.16 553.28" />\
                        <path class="svgpath" data-index="path_4" fill="#272636" d="M724.288 707.648c0 7.744-7.808 14.016-17.408 14.016L334.208 721.664c-9.6 0-17.408-6.272-17.408-14.016l0-26.176c0-7.744 7.808-13.952 17.408-13.952l372.672 0c9.6 0 17.408 6.272 17.408 13.952L724.288 707.648 724.288 707.648 724.288 707.648zM724.288 707.648" />\
                        <path class="svgpath" data-index="path_5" fill="#272636" d="M724.288 842.432c0 7.36-7.808 13.376-17.408 13.376L334.208 855.808c-9.6 0-17.408-5.952-17.408-13.376l0-25.088c0-7.36 7.808-13.376 17.408-13.376l372.672 0c9.6 0 17.408 5.952 17.408 13.376L724.288 842.432 724.288 842.432 724.288 842.432zM724.288 842.432" />\
                        <path class="svgpath" data-index="path_6" fill="#272636" d="M647.488 122.432 567.616 35.648C543.04 14.144 519.68 16.512 519.68 16.512 490.816 14.976 471.488 35.328 471.488 35.328L392.704 122.432 316.48 122.88l0 58.176 408.384 0.448-0.256-59.008L647.488 122.496 647.488 122.432 647.488 122.432zM462.272 122.432l47.36-55.488C520.192 53.76 530.944 66.368 530.944 66.368l45.888 56.064L462.272 122.432 462.272 122.432 462.272 122.432zM462.272 122.432" />\
                    </svg>','Diagnosis':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                            <path class="svgpath" data-index="path_0" fill="#272636" d="M316.864 681.728c41.984 0 75.968-32 75.968-71.424 0-14.336-4.544-27.776-12.352-38.912L462.208 443.52C464.384 443.712 466.56 443.84 468.864 443.84c2.24 0 4.416-0.128 6.656-0.32l81.664 127.872C549.312 582.592 544.768 595.968 544.768 610.304c0 39.424 34.048 71.424 75.968 71.424 41.984 0 75.968-32 75.968-71.424 0-14.912-4.864-28.736-13.184-40.192l134.784-221.632c1.664 0.128 3.392 0.192 4.992 0.192 41.984 0 75.968-31.936 75.968-71.36 0-39.424-34.048-71.424-75.968-71.424-41.92 0-75.968 32-75.968 71.424 0 14.976 4.864 28.736 13.248 40.192L625.792 539.136C624.128 539.008 622.464 538.944 620.8 538.944c-2.24 0-4.416 0.128-6.656 0.32L532.48 411.392c7.808-11.2 12.352-24.576 12.352-38.976 0-39.424-33.984-71.36-75.968-71.36-41.984 0-75.968 31.936-75.968 71.36 0 14.4 4.544 27.776 12.352 38.976L323.52 539.264C321.344 539.072 319.104 538.944 316.864 538.944c-41.92 0-75.968 31.936-75.968 71.36S274.944 681.728 316.864 681.728L316.864 681.728zM936.448 901.824 93.952 901.824 93.952 59.328c0-20.224-16.384-36.608-36.608-36.608-20.224 0-36.608 16.384-36.608 36.608l0 879.104c0 20.224 16.384 36.608 36.608 36.608l879.104 0c20.224 0 36.608-16.384 36.608-36.608C973.056 918.208 956.672 901.824 936.448 901.824L936.448 901.824zM936.448 901.824" />\
                        </svg> ','Month':'<svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                        <path class="svgpath" data-index="path_0" fill="#272636" d="M246.912 727.04c26.56 20.544 56.512 30.848 89.984 30.848 26.752 0 47.872-6.528 63.488-19.648 15.616-13.12 23.424-30.72 23.424-52.736 0-49.088-35.136-73.664-105.472-73.664L286.016 611.84 286.016 571.2 316.8 571.2c62.272 0 93.44-23.04 93.44-69.184 0-42.624-23.808-63.872-71.424-63.872-27.2 0-52.864 9.216-76.928 27.584L261.888 419.392c25.408-14.72 55.04-22.08 88.96-22.08 33.088 0 59.648 8.64 79.68 25.92 20.032 17.28 30.08 39.744 30.08 67.264 0 50.752-25.92 83.456-77.696 97.984l0 1.024c28.032 3.008 50.24 12.928 66.496 29.696 16.256 16.768 24.448 37.696 24.448 62.784 0 34.944-12.544 63.04-37.696 84.416-25.152 21.376-58.624 32.064-100.352 32.064-36.736 0-66.432-6.848-88.96-20.544L246.912 727.04 246.912 727.04zM246.912 727.04" />\
                        <path class="svgpath" data-index="path_1" fill="#272636" d="M534.784 605.504c0-68.48 11.328-120.32 34.048-155.456s55.616-52.736 98.752-52.736c82.176 0 123.264 66.304 123.264 198.976 0 65.472-11.584 115.584-34.688 150.208-23.168 34.688-55.616 51.968-97.344 51.968-39.424 0-69.952-16.448-91.584-49.344C545.6 716.224 534.784 668.352 534.784 605.504L534.784 605.504zM584.896 603.264c0 103.04 26.112 154.624 78.4 154.624 51.456 0 77.184-52.352 77.184-157.12 0-108.416-25.216-162.624-75.648-162.624C611.584 438.144 584.896 493.184 584.896 603.264L584.896 603.264zM584.896 603.264" />\
                        <path class="svgpath" data-index="path_2" fill="#272636" d="M831.744 81.664c-17.92 0-32.512-14.656-32.512-32.512L799.232 42.496c0-17.92-14.656-32.512-32.512-32.512l-6.656 0c-17.92 0-32.512 14.656-32.512 32.512l0 6.656c0 17.92-14.656 32.512-32.512 32.512L329.344 81.664c-17.92 0-32.512-14.656-32.512-32.512L296.832 42.496c0-17.92-14.656-32.512-32.512-32.512L257.6 9.984c-17.92 0-32.512 14.656-32.512 32.512l0 6.656c0 17.92-14.656 32.512-32.512 32.512L42.432 81.664c-17.92 0-32.512 14.656-32.512 32.512l0 867.328c0 17.92 14.656 32.512 32.512 32.512l939.072 0c17.856 0 32.512-14.656 32.512-32.512L1014.016 114.176c0-17.856-14.656-32.512-32.512-32.512L831.744 81.664 831.744 81.664zM942.4 909.824c0 17.856-14.656 32.512-32.512 32.512L114.176 942.336c-17.92 0-32.512-14.656-32.512-32.512L81.664 185.92c0-17.92 14.656-32.512 32.512-32.512l78.4 0c17.92 0 32.512 14.656 32.512 32.512L225.088 227.2c0 17.92 14.656 32.512 32.512 32.512L264.32 259.712c17.92 0 32.512-14.656 32.512-32.512L296.832 185.92c0-17.92 14.656-32.512 32.512-32.512l365.568 0c17.92 0 32.512 14.656 32.512 32.512L727.424 227.2c0 17.92 14.656 32.512 32.512 32.512l6.656 0c17.92 0 32.512-14.656 32.512-32.512L799.104 185.92c0-17.92 14.656-32.512 32.512-32.512l78.08 0c17.92 0 32.512 14.656 32.512 32.512L942.4 909.824 942.4 909.824zM942.4 909.824" />\
                    </svg>'},reportSummaryTemplate:'\
        <div style="width: 100%; height: 100%; overflow-x: hidden; overflow-y: hidden;" id="beopReport">\
            <link rel="stylesheet" href="/static/projectReports/report.css"/>\
            <div class="step-container col-xs-12 col-md-8 col-md-offset-2 report-block scrollbar">\
                <div class="step-play-container">\
                    <div class="step-play-list">\
                    </div>\
                </div>\
            </div>\
        </div>',show:function(){$.ajax({url:'static/app/dashboard/views/message/messageReport.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.init();I18n.fillArea($('#navTop'));});},init:function(){_this.initReportList();},initReportList:function(){var $container=$('#containerMessageReport');var num=0;var divIndex=AppConfig.isFactory=0;WebAPI.get('/factory/reportWrap/'+AppConfig.isFactory+'/'+ProjectConfig.reportPageId).done(function(index){ProjectConfig.reportList=index.list;for(var i=0;i<index.list.length;i++){ProjectConfig.reportList[i].pageId=index.pageId;var version=_this.getReportVersion(index.list[i].period);var reportName=index.list[i].reportName;var strPanelReport=new StringBuilder();var icon=_this.initReportIcon(reportName);strPanelReport.append('<div class="panel panel-primary ">');strPanelReport.append('    <div class="panel-heading" role="tab" id="reportTitle_'+i+'"> ');strPanelReport.append('        <div class="divIcon">');strPanelReport.append('<span class="spMainIcon">'+icon.main+'</span>');if(icon.add!=''){strPanelReport.append('<span class="spAddIcon">'+_this.initReportIcon(reportName).add+'</span>');}
strPanelReport.append('        </div>');strPanelReport.append('        <h4 class="panel-title">');strPanelReport.append('            <a class="aCollapse collapsed" role="button" data-toggle="collapse" data-parent="#containerMessageReport" href="#'+index.list[i].reportId+'" aria-expanded="false" aria-controls="'+index.list[i].reportId+'">');strPanelReport.append('                <span class="reportType">'+reportName+'</span>');strPanelReport.append('                <span class="reportTime">'+version+'</span>');strPanelReport.append('            </a>');strPanelReport.append('        </h4>');strPanelReport.append('    </div>');strPanelReport.append('    <div id="'+index.list[i].reportId+'" class="panel-collapse collapse " role="tabpanel" aria-labelledby="reportTitle_'+i+'">');strPanelReport.append('        <div class="panel-body">');strPanelReport.append('        </div>');strPanelReport.append('        <div class="btnDetail zepto-ev additionText" report-to="'+index.list[i].reportId+'">'+I18n.resource.appDashboard.message.MORE);strPanelReport.append('        </div>');strPanelReport.append('    </div>');strPanelReport.append('</div>');$container.append(strPanelReport.toString());}
_this.initReportDetail();});this.initReportSummary();},initReportSummary:function(){var $container=$('#containerMessageReport');$container.on('show.bs.collapse',function(e){if($(e.target).find('.report-container-wrap').length>0)return;var spin=new LoadingSpinner({color:'#00FFFF'}).spin(e.target.querySelector('.panel-body'));api.report.renderReport(e.target.querySelector('.panel-body'),e.target.id,{onlySummary:true}).done(function(){spin.stop();});})},initReportDetail:function(){var btnReportDetail=$('.panel-collapse .btnDetail');var strReportTime;btnReportDetail.off('tap').on('tap',function(e){e.preventDefault();e.stopPropagation();strReportTime=$(e.currentTarget).parentsUntil('#containerMessageFactoryReport','.panel').find('.reportTime').html();for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i].reportId==$(e.currentTarget).attr('report-to')){ProjectConfig.reportIndex=i;ProjectConfig.reportDetail=ProjectConfig.reportList[i];router.to({typeClass:ProjectFactoryReport,data:{}});break;}}})},getReportVersion:function(reportPeriod){var thisDay,version;var reportType=reportPeriod;var year,month,day;if(ProjectConfig.reportDate&&new Date(ProjectConfig.reportDate)!='Invalid Date'){thisDay=new Date(ProjectConfig.reportDate);}else{thisDay=new Date();}
if(reportType==='day'){if(!month||!year||!day){if(thisDay.format('yyyy/MM/dd')==new Date().format('yyyy/MM/dd')){thisDay.setDate(thisDay.getDate()-1);}
version=thisDay.format('yyyy-MM-dd');year=thisDay.getFullYear();month=thisDay.getMonth()+1;day=thisDay.getDate();}else{version=year+"-"+StringUtil.padLeft(month,2,'0')+"-"+StringUtil.padLeft(day,2,'0');}}
else if(reportType==='month'){if(!month||!year){if(thisDay.format('yyyy/MM')==new Date().format('yyyy/MM')){thisDay.setMonth(thisDay.getMonth()-1);}
year=thisDay.getFullYear();month=thisDay.getMonth()+1;}
version=year+'-'+StringUtil.padLeft(month,2,'0');}else{year=thisDay.getFullYear();month=month?month:(_this.iso8601Week(new Date(year,thisDay.getMonth()-1)));version=year+'-'+month+'-w';}
return version;},iso8601Week:function(date){var time,checkDate=new Date(date.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},initReportIcon:function(reportType){var icon={main:'',add:''};if(reportType.indexOf('KPI')>-1){icon.main=_this.reportIcon['KPI'];}else if(reportType.indexOf('Cost')>-1){icon.main=_this.reportIcon['Cost'];}else if(reportType.indexOf('Pattern')>-1){icon.main=_this.reportIcon['Pattern'];}else if(reportType.indexOf('Daily')>-1){icon.main=_this.reportIcon['Daily'];}else if(reportType.indexOf('Run')>-1){icon.main=_this.reportIcon['Run'];}else if(reportType.indexOf('Diagnosis')>-1){icon.main=_this.reportIcon['Diagnosis'];}else{icon.main=_this.reportIcon['KPI'];}
return icon},close:function(){}};return MessageFactoryReport;})();var WorkflowList=(function(){var _this=this;function WorkflowList(){_this=this;if(!WkConfig.wkType){WkConfig.wkType='inProgress';}
_this.tempWkList=[].concat(WkConfig.wkList);_this.tempWkContainer=undefined;_this.sortType=true;}
WorkflowList.navOptions={top:'<div class="topNavTitle"></div>'+'<span id="btnWorkFlowAdd" class="topNavRight topTool zepto-ev"><span id="iconWorkFlowAdd" class="btnIcon"></span></span>',bottom:true,backDisable:true,module:'workflow'};WorkflowList.prototype={show:function(){localStorage.setItem('pushWk',[]);$('#btnWorkFlow .messageNum').text(0).hide();$.ajax({url:'static/app/dashboard/views/workflow/workflowList.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);$('.navTool .selected').removeClass('selected');$('#btnWorkFlow').addClass('selected');localStorage.setItem('module','workflow');_this.init();I18n.fillArea($('#navTop'));I18n.fillArea($('#divWorkflowTool'));});},init:function(){_this.initWorkflowTool();_this.initWkTypeSelect();if(!WkConfig.refreshTime||new Date()-WkConfig.refreshTime>WkConfig.refreshInterval||true){_this.initWorkflowList(WkConfig.wkType);WkConfig.refreshTime=new Date();}else{_this.initWorkflowList(WkConfig.wkType);}
_this.initGroupAndTag();_this.initSort();_this.initSearch();},initGroupAndTag:function(){$.when(WebAPI.get('/workflow/users/group/'+AppConfig.userId).done(function(resultData){WkConfig.groupList={joined:resultData.data.joined,created:resultData.data.created}}),WebAPI.get('/workflow/tag/user/'+AppConfig.userId).done(function(resultData){WkConfig.tagList=resultData.data;})).done(function(){_this.initAddWk();})},initWorkflowList:function(type,isExist){var $container=$('#divWkList');var $unit;var strWorkFlow;$container.html('');var url='';var record;var $navTopTitle=$('.topNavTitle');switch(type){case'inProgress':url='/workflow/transaction/working/'+AppConfig.userId+'/1/'+WkConfig.defaultSize;$navTopTitle.html(I18n.resource.appDashboard.workflow.IN_PROGRESS);break;case'created':url='/workflow/transaction/get_new_created/'+AppConfig.userId+'/1/'+WkConfig.defaultSize;$navTopTitle.html(I18n.resource.appDashboard.workflow.HAS_CREATED);break;case'doing':url='/workflow/transaction/get_started_trans/'+AppConfig.userId+'/1/'+WkConfig.defaultSize;$navTopTitle.html(I18n.resource.appDashboard.workflow.IN_DOING);break;case'waitVerifier':url='/workflow/transaction/get_wait_verify_trans/'+AppConfig.userId+'/1/'+WkConfig.defaultSize;$navTopTitle.html(I18n.resource.appDashboard.workflow.WAITING_VERIFIER);break;case'myVerifier':url='/workflow/transaction/waitMeToVerifier/'+AppConfig.userId+'/1/'+WkConfig.defaultSize;$navTopTitle.html(I18n.resource.appDashboard.workflow.MY_VERIFIER);break;case'createdByMe':url='/workflow/transaction/created_by/'+AppConfig.userId+'/1/'+WkConfig.defaultSize;$navTopTitle.html(I18n.resource.appDashboard.workflow.CREATED_BY_ME);break;case'completedByMe':url='/workflow/transaction/finished_by/'+AppConfig.userId+'/1/'+WkConfig.defaultSize;$navTopTitle.html(I18n.resource.appDashboard.workflow.COMPLETE_BY_ME);break;case'involvedByMe':url='/workflow/transaction/joined_by/'+AppConfig.userId+'/1/'+WkConfig.defaultSize;$navTopTitle.html(I18n.resource.appDashboard.workflow.INVOLVED_BY_ME);break;default:break;}
SpinnerControl.show();WebAPI.post(url).done(function(resultData){if(resultData.data&&resultData.data.records){record=resultData.data.records;WkConfig.wkList=record;_this.tempWkList=record;}else{return;}
if(isExist){for(var i=0;i<record.length;i++){strWorkFlow=new StringBuilder();strWorkFlow.append('<div class="liWkRecord zepto-ev" id="'+record[i].id+'">');strWorkFlow.append('<div class="divHead">');strWorkFlow.append('<div class="wkTitle title">'+record[i].title+'</div>');strWorkFlow.append('<div class="wkDate additionText">'+record[i].dueDate.toDate().format('yyyy-MM-dd')+'</div>');strWorkFlow.append('</div>');strWorkFlow.append('<div class="divDetail">');strWorkFlow.append('<div class="wkEmergency wkEmergency_'+record[i].critical+'">\
                            <svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                                <path class="svgpath" data-index="path_0" fill="#272636" d="M123.392 583.232l327.296 0-113.792 427.456 498.944-569.984L508.544 440.704l113.536-427.52L123.392 583.232zM123.392 583.232" />\
                            </svg>\
                        </div>');strWorkFlow.append('<div class="wkInfo text">'+record[i].detail+'</div>');if(record[i].creator_info){strWorkFlow.append('<div class="wkCreator additionText" i18n="appDashboard.workflow.CREATOR">'+I18n.resource.appDashboard.workflow.CREATOR+': '+record[i].creator_info.userfullname+'</div>');}
strWorkFlow.append('<div class="wkExecutor additionText" i18n="appDashboard.workflow.EXECUTOR">'+I18n.resource.appDashboard.workflow.EXECUTOR+': '+record[i].executorName+'</div>');strWorkFlow.append('<div class="wkDate additionText">'+record[i].dueDate.toDate().format('yyyy-MM-dd')+'</div>');strWorkFlow.append('<div class="wkGetStatus status_'+record[i].statusId+'">'+_this.initStatus(record[i].statusId)+'</div>');strWorkFlow.append('</div>');strWorkFlow.append('</div>');$unit=$(strWorkFlow.toString());$unit.find('.wkInfo').html(record[i].detail);$container.append($unit);}}else{for(var i=0;i<record.length;i++){strWorkFlow=new StringBuilder();strWorkFlow.append('<div class="liWkRecord zepto-ev" id="'+record[i].id+'">');strWorkFlow.append('<div class="divHead">');strWorkFlow.append('<div class="wkTitle title">'+record[i].title+'</div>');strWorkFlow.append('<div class="wkDate additionText">'+record[i].dueDate.toDate().format('yyyy-MM-dd')+'</div>');strWorkFlow.append('</div>');strWorkFlow.append('<div class="divDetail">');strWorkFlow.append('<div class="wkEmergency wkEmergency_'+record[i].critical+'">\
                            <svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                                <path class="svgpath" data-index="path_0" fill="#272636" d="M123.392 583.232l327.296 0-113.792 427.456 498.944-569.984L508.544 440.704l113.536-427.52L123.392 583.232zM123.392 583.232" />\
                            </svg>\
                        </div>');strWorkFlow.append('<div class="wkInfo text">'+record[i].detail+'</div>');if(record[i].creator_info){strWorkFlow.append('<div class="wkCreator additionText" i18n="appDashboard.workflow.CREATOR">'+I18n.resource.appDashboard.workflow.CREATOR+': '+record[i].creator_info.userfullname+'</div>');}
strWorkFlow.append('<div class="wkExecutor additionText" i18n="appDashboard.workflow.EXECUTOR">'+I18n.resource.appDashboard.workflow.EXECUTOR+': '+record[i].executorName+'</div>');strWorkFlow.append('<div class="wkGetStatus status_'+record[i].statusId+'" i18n="appDashboard.workflow.STATUS_'+record[i].statusId+'">'+_this.initStatus(record[i].statusId)+'</div>');strWorkFlow.append('</div>');strWorkFlow.append('</div>');$unit=$(strWorkFlow.toString());$unit.find('.wkInfo').html(record[i].detail);$container.append($unit);}}
_this.initWkDetail();}).always(function(){SpinnerControl.hide();});},initStatus:function(statusId){var strStatus;switch(statusId){case 0:strStatus=I18n.resource.appDashboard.workflow.STATUS_0;break;case 1:strStatus=I18n.resource.appDashboard.workflow.STATUS_1;break;case 2:strStatus=I18n.resource.appDashboard.workflow.STATUS_2;break;case 3:strStatus=I18n.resource.appDashboard.workflow.STATUS_3;break;case 4:strStatus=I18n.resource.appDashboard.workflow.STATUS_4;break;case 5:strStatus=I18n.resource.appDashboard.workflow.STATUS_5;break;case 6:strStatus=I18n.resource.appDashboard.workflow.STATUS_6;break;case 7:strStatus=I18n.resource.appDashboard.workflow.STATUS_7;break;default:strStatus='';break;}
return strStatus;},initDueDate:function(dueDate){},initWkTypeSelect:function(){var $workflowContainer=$('#containerWorkFlowList');var $backDrop=$('.backDrop');var $ulWkDropDown=$('.ulWkDropDown');var $wkTool=$('.wkTool');_this.sortType=true;$('.btnWkSelect').off('tap').on('tap',function(e){$('.btnWkSelect').removeClass('selected');$(e.currentTarget).addClass('selected');var $spanWkType=$('.topNavTitle');switch($(e.currentTarget).attr('id')){case'btnProgress':WkConfig.wkType='inProgress';$spanWkType.html(I18n.resource.appDashboard.workflow.IN_PROGRESS);break;case'btnCreated':WkConfig.wkType='created';$spanWkType.html(I18n.resource.appDashboard.workflow.HAS_CREATED);break;case'btnDoing':WkConfig.wkType='doing';$spanWkType.html(I18n.resource.appDashboard.workflow.IN_DOING);break;case'btnWaitVerifier':WkConfig.wkType='waitVerifier';$spanWkType.html(I18n.resource.appDashboard.workflow.WAITING_VERIFIER);break;case'btnMyVerifier':WkConfig.wkType='myVerifier';$spanWkType.html(I18n.resource.appDashboard.workflow.MY_VERIFIER);break;case'btnCreatedByMe':WkConfig.wkType='createdByMe';$spanWkType.html(I18n.resource.appDashboard.workflow.CREATED_BY_ME);break;case'btnFinishedByMe':WkConfig.wkType='completedByMe';$spanWkType.html(I18n.resource.appDashboard.workflow.COMPLETE_BY_ME);break;case'btnInvolvedByMe':WkConfig.wkType='involvedByMe';$spanWkType.html(I18n.resource.appDashboard.workflow.INVOLVED_BY_ME);break;default:break;}
$backDrop.hide();$workflowContainer.css('overflow','auto');$ulWkDropDown.hide();$wkTool.removeClass('on');_this.initWorkflowList(WkConfig.wkType);});},initWkDetail:function(){$('#divWkList').find('.liWkRecord').off('tap').on('tap',function(e){if(!WkConfig.groupList||!WkConfig.tagList){return;}
var wkId,wkDetail;wkId=$(e.currentTarget).attr('id');for(var i=0;i<_this.tempWkList.length;i++){if(_this.tempWkList[i].id==wkId){wkDetail=_this.tempWkList[i];_this.tempWkList[i].status=true;break;}}
router.to({typeClass:WorkflowDetail,data:{id:wkId,info:wkDetail}})});},initAddWk:function(){$('#btnWorkFlowAdd').off('tap').on('tap',function(){router.to({typeClass:WorkflowAdd})});},initWorkflowTool:function(){var $workflowContainer=$('#containerWorkFlowList');var $backDrop=$('.backDrop');var $ulWkDropDown=$('.ulWkDropDown');var $wkTool=$('.wkTool');$wkTool.off('tap').on('tap',function(e){$ulWkDropDown.hide();$wkTool.not($(e.currentTarget)).removeClass('on');if(!$(e.currentTarget).hasClass('on')){$(e.currentTarget).addClass('on');$(e.currentTarget).next().show();$backDrop.show();$workflowContainer.css('overflow','hidden');}else{$(e.currentTarget).removeClass('on');$(e.currentTarget).next().hide();$backDrop.hide();$workflowContainer.css('overflow','auto');}});$backDrop.off('tap').on('tap',function(e){$(e.currentTarget).hide();$ulWkDropDown.hide();$wkTool.removeClass('on');$workflowContainer.css('overflow','auto');})},initSort:function(){var $workflowContainer=$('#containerWorkFlowList');var $backDrop=$('.backDrop');var $ulWkDropDown=$('.ulWkDropDown');var $wkTool=$('.wkTool');$('#idSort').off('tap').on('tap',function(){sort('id');});$('#createTimeSort').off('tap').on('tap',function(){sort('createTime','date');});$('#deadlineSort').off('tap').on('tap',function(){sort('dueDate','date');});$('#emergencySort').off('tap').on('tap',function(){sort('critical');});$('#executorSort').off('tap').on('tap',function(){sort('executorId')});$('#teamSort').off('tap').on('tap',function(){sort('groupId')});$('#collectSort').off('tap').on('tap',function(){sort('star');});function sort(data,type){var $ctn=$('#divWkList');$ctn.html('');var newWkList=_this.tempWkList;var low=0,high=newWkList.length-1;var temp;if(type=='date'){if(_this.sortType){while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data].toDate()>newWkList[i+1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data].toDate()<newWkList[i-1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}else{while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data].toDate()<newWkList[i+1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data].toDate()>newWkList[i-1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}}else{if(_this.sortType){while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data]>newWkList[i+1][data]){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data]<newWkList[i-1][data]){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}else{while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data]<newWkList[i+1][data]){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data]>newWkList[i-1][data]){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}}
var strWorkFlow;var $unit;for(var i=0;i<newWkList.length;i++){strWorkFlow=new StringBuilder();strWorkFlow.append('<div class="liWkRecord zepto-ev" id="'+newWkList[i].id+'">');strWorkFlow.append('<div class="divHead">');strWorkFlow.append('<div class="wkTitle title">'+newWkList[i].title+'</div>');strWorkFlow.append('<div class="wkDate additionText">'+newWkList[i].dueDate.toDate().format('yyyy-MM-dd')+'</div>');strWorkFlow.append('</div>');strWorkFlow.append('<div class="divDetail">');strWorkFlow.append('<div class="wkEmergency wkEmergency_'+newWkList[i].critical+'">\
                        <svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                            <path class="svgpath" data-index="path_0" fill="#272636" d="M123.392 583.232l327.296 0-113.792 427.456 498.944-569.984L508.544 440.704l113.536-427.52L123.392 583.232zM123.392 583.232" />\
                        </svg>\
                    </div>');strWorkFlow.append('<div class="wkInfo text">'+newWkList[i].detail+'</div>');if(newWkList[i].creator_info){strWorkFlow.append('<div class="wkCreator additionText" i18n="appDashboard.workflow.CREATOR">'+I18n.resource.appDashboard.workflow.CREATOR+': '+newWkList[i].creator_info.userfullname+'</div>');}
strWorkFlow.append('<div class="wkExecutor additionText" i18n="appDashboard.workflow.EXECUTOR">'+I18n.resource.appDashboard.workflow.EXECUTOR+': '+newWkList[i].executorName+'</div>');strWorkFlow.append('<div class="wkGetStatus status_'+newWkList[i].statusId+'" i18n="appDashboard.workflow.STATUS_'+newWkList[i].statusId+'">'+_this.initStatus(newWkList[i].statusId)+'</div>');strWorkFlow.append('</div>');strWorkFlow.append('</div>');$unit=$(strWorkFlow.toString());$unit.find('.wkInfo').text(newWkList[i].detail);$ctn.append($unit);}
_this.sortType=!_this.sortType;_this.initWkDetail();$backDrop.hide();$workflowContainer.css('overflow','auto');$ulWkDropDown.hide();$wkTool.removeClass('on');}},initRefresh:function(){var $ctn=$('#outerContainer');var $ctnWk=$('#containerWorkFlowList');var startTime,evInit,evMove;$ctn.off('touchstart').on('touchstart',function(e){var evTouch=e.originalEvent.touches[0];if($ctnWk[0].scrollTop==0){e.preventDefault();evInit={x:evTouch.x,y:evTouch.y};}});$ctn.off('touchmove').on('touchmove',function(e){var evTouch=e.originalEvent.touches[0];evInit={x:evTouch.x,y:evTouch.y}});$ctn.off('touchend').on('touchend',function(e){var evTouch=e.originalEvent.changedToucher[0];evInit={x:evTouch.x,y:evTouch.y};console.log(e);})},initSearch:function(){$('#btnSearById').off('tap').on('tap',function(){var val=parseInt($('#iptSearById').val());if(!val){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.workflow.CHECK_CODE_FORMAT,'short','center');return;}
SpinnerControl.show();WebAPI.post('/workflow/transaction/'+val,{user_id:AppConfig.userId}).done(function(resultData){if(resultData.success&&resultData.data){router.to({typeClass:WorkflowDetail,data:{id:val,detail:resultData.data}})}else{window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.workflow.NO_WORKFLOW_INFO,'short','center');}}).fail(function(){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.workflow.NO_WORKFLOW_INFO,'short','center');}).always(function(){SpinnerControl.hide();});})},close:function(){}};return WorkflowList;})();var WorkflowIndex=(function(){var _this;function WorkflowIndex(){_this=this;this.pageNum=1;this.pageSize=19;this.filter='inProgress';this.store=[];this.container=undefined;}
WorkflowIndex.navOptions={top:'<span id="btnWorkFlowAdd" class="topNavLeft topTool zepto-ev iconfont icon-tianjia21"></span>'+'<div class="topNavTitle"></div>'+'<span id="btnAdminConfig" class=""><i class="iconfont">&#xe7e3;</i></span>',bottom:true,backDisable:true,module:'workflow'};WorkflowIndex.prototype={show:function(){localStorage.setItem('pushWk',[]);$('#btnWorkFlow .messageNum').text(0).hide();$.ajax({url:'static/app/dashboard/views/workflow/workflowList.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);localStorage.setItem('module','workflow');var $adminConfig=$('#btnAdminConfig');$adminConfig[0].innerHTML='<img src="http://images.rnbtech.com.hk'+AppConfig.userProfile.picture+'">';$adminConfig.off('touchstart').on('touchstart',function(e){var adminConfigNew=new AdminConfigNew();adminConfigNew.show();});_this.container=document.getElementById('divWkList');_this.init();I18n.fillArea($('#navTop'));I18n.fillArea($('#divWorkflowTool'));});},init:function(){_this.initWorkflowTool();_this.initAddWk();_this.initWkTypeDivide();_this.initWorkflowList();_this.initSort();_this.initSearch();_this.attachEvent();},initGroupAndTag:function(){$.when(WebAPI.get('/workflow/users/group/'+AppConfig.userId).done(function(resultData){WkConfig.groupList={joined:resultData.data.joined,created:resultData.data.created}}),WebAPI.get('/workflow/tag/user/'+AppConfig.userId).done(function(resultData){WkConfig.tagList=resultData.data;})).done(function(){_this.initAddWk();})},initWorkflowList:function(){this.container.innerHTML='';var $navTopTitle=$('.topNavTitle');var postData={};switch(this.filter){case'inProgress':postData={comment:true,pageNumber:this.pageNum,pageSize:this.pageSize,query:'{"executor":'+AppConfig.userId+',"status":{"$in":[0,1]},"_isDelete":{"$ne":true}}'};$navTopTitle.html(I18n.resource.appDashboard.workflow.IN_PROGRESS);break;case'createdByMe':postData={pageNumber:this.pageNum,pageSize:this.pageSize,query:'{"creator":'+AppConfig.userId+',"_isDelete":{"$ne":true}}'};$navTopTitle.html(I18n.resource.appDashboard.workflow.CREATED_BY_ME);break;case'completedByMe':postData={pageNumber:this.pageNum,pageSize:this.pageSize,query:'{"executor":'+AppConfig.userId+',"status":2,"_isDelete":{"$ne":true}}'};$navTopTitle.html(I18n.resource.appDashboard.workflow.COMPLETE_BY_ME);break;case'involvedByMe':postData={pageNumber:this.pageNum,pageSize:this.pageSize,query:'{"or":[{"process.nodes.members":'+AppConfig.userId+'},{"process.watchers":'+AppConfig.userId+'}],"_isDelete":{"$ne":true}}'};$navTopTitle.html(I18n.resource.appDashboard.workflow.INVOLVED_BY_ME);break;default:break;}
SpinnerControl.show();WebAPI.post('/workflow/task/filter',postData).done(function(resultData){if(resultData.data&&resultData.data.records){_this.store=resultData.data.records;}else{return;}
_this.store.forEach(function(item){_this.container.appendChild(_this.createIndexItem(item))});}).always(function(){SpinnerControl.hide();});},createIndexItem:function(item){var dom=document.createElement('div');dom.className='divWkItem zepto-ev';dom.id=item._id;var user_from=document.createElement('span');user_from.className='spUserFrom';try{user_from.innerHTML='<img src="http://images.rnbtech.com.hk/custom/user/portrait/user_'+item.process.nodes[item.node_index].members[0]+'.jpg">';}catch(e){user_from.innerHTML='<img src="http://images.rnbtech.com.hk/static/images/avatar/default/1.png">';}
var user_relate=document.createElement('span');user_relate.className='spUserRelate';if(item.watchers instanceof Array){for(var i=0;i<item.watchers.length;i++){user_relate.innerHTML+='<img src="http://images.rnbtech.com.hk/custom/user/portrait/user_'+item.watchers[i]+'.jpg">';}}
var user_create=document.createElement('span');user_create.className='spUserCreate';if(item.creatorInfo){user_create.innerHTML='<img src="http://images.rnbtech.com.hk/custom/user/portrait/user_'+item.creatorInfo.id+'.jpg">';}else{user_create.innerHTML='<img src="http://images.rnbtech.com.hk/static/images/avatar/default/1.png">';}
var userGroup=document.createElement('span');userGroup.className='spUserGrp';var title=document.createElement('span');title.className='spTitle';title.innerHTML=item.fields.title;var content=document.createElement('span');content.className='spContent';content.innerHTML=item.fields.detail;var status=document.createElement('span');status.className='spStatus';status.innerHTML=this.getStatusContent(item.process.nodes[item.node_index]?item.process.nodes[item.node_index].behaviour:null);var critical=document.createElement('span');critical.className='spCritical critical-'+item.fields.critical;critical.innerHTML=this.getCriticalContent(item.fields.critical);var divAddition=document.createElement('div');divAddition.className='divInfo';var dueDate=document.createElement('span');dueDate.className='spDueDate';dueDate.textContent=new Date(item.fields.dueDate).format('yyyy-MM-dd');var reply=document.createElement('span');reply.className='spReply';reply.innerHTML='<span class="spIcon iconfont icon-xinxi"></span><span class="spReplyNum">'+(item.comment&&(item.comment instanceof Array)?item.comment.length:0)+'</span>';dom.appendChild(user_from);dom.appendChild(title);dom.appendChild(content);userGroup.appendChild(user_create);userGroup.appendChild(user_relate);dom.appendChild(userGroup);divAddition.appendChild(reply);divAddition.appendChild(status);divAddition.appendChild(critical);divAddition.appendChild(dueDate);dom.appendChild(divAddition);return dom;},getCriticalContent:function(id){var strCritical;switch(parseInt(id)){case 0:strCritical=I18n.resource.appDashboard.workflow.NORMAL;break;case 1:strCritical=I18n.resource.appDashboard.workflow.SERIOUS;break;case 2:strCritical=I18n.resource.appDashboard.workflow.URGENT;break;default:strCritical='';break;}
return strCritical;},getStatusContent:function(id){if(id==null)return'';var strStatus;switch(parseInt(id)){case 0:strStatus=I18n.resource.appDashboard.workflow.STATUS_0;break;case 1:strStatus=I18n.resource.appDashboard.workflow.STATUS_1;break;case 2:strStatus=I18n.resource.appDashboard.workflow.STATUS_2;break;case 3:strStatus=I18n.resource.appDashboard.workflow.STATUS_3;break;default:strStatus='';break;}
return strStatus;},initWkTypeDivide:function(){var $workflowContainer=$('#containerWorkFlowList');var $backDrop=$('.backDrop');var $ulWkDropDown=$('.ulWkDropDown');var $wkTool=$('.wkTool');_this.sortType=true;$('.btnWkDivide').off('tap').on('tap',function(e){$('.btnWkDivide').removeClass('selected');$(e.currentTarget).addClass('selected');var $spanWkType=$('.topNavTitle');switch($(e.currentTarget).attr('id')){case'btnProgress':_this.filter='inProgress';$spanWkType.html(I18n.resource.appDashboard.workflow.IN_PROGRESS);break;case'btnCreatedByMe':_this.filter='createdByMe';$spanWkType.html(I18n.resource.appDashboard.workflow.CREATED_BY_ME);break;case'btnFinishedByMe':_this.filter='completedByMe';$spanWkType.html(I18n.resource.appDashboard.workflow.COMPLETE_BY_ME);break;case'btnInvolvedByMe':_this.filter='involvedByMe';$spanWkType.html(I18n.resource.appDashboard.workflow.INVOLVED_BY_ME);break;default:break;}
$backDrop.hide();$workflowContainer.css('overflow','auto');$ulWkDropDown.hide();$wkTool.removeClass('on');_this.initWorkflowList();});},attachEvent:function(){$(this.container).off('tap').on('tap','.divWkItem',function(e){router.to({typeClass:WorkflowDetail,data:{id:e.currentTarget.id}})});},initAddWk:function(){$('#btnWorkFlowAdd').off('tap').on('tap',function(){router.to({typeClass:WorkflowAdd})});},initWorkflowTool:function(){var $workflowContainer=$('#containerWorkFlowList');var $backDrop=$('.backDrop');var $ulWkDropDown=$('.ulWkDropDown');var $wkTool=$('.wkTool');$wkTool.off('tap').on('tap',function(e){$ulWkDropDown.hide();$wkTool.not($(e.currentTarget)).removeClass('on');if(!$(e.currentTarget).hasClass('on')){$(e.currentTarget).addClass('on');$(e.currentTarget).next().show();$backDrop.show();$workflowContainer.css('overflow','hidden');}else{$(e.currentTarget).removeClass('on');$(e.currentTarget).next().hide();$backDrop.hide();$workflowContainer.css('overflow','auto');}});$backDrop.off('tap').on('tap',function(e){$(e.currentTarget).hide();$ulWkDropDown.hide();$wkTool.removeClass('on');$workflowContainer.css('overflow','auto');})},initSort:function(){var $workflowContainer=$('#containerWorkFlowList');var $backDrop=$('.backDrop');var $ulWkDropDown=$('.ulWkDropDown');var $wkTool=$('.wkTool');$('#idSort').off('tap').on('tap',function(){sort('id');});$('#createTimeSort').off('tap').on('tap',function(){sort('createTime','date');});$('#deadlineSort').off('tap').on('tap',function(){sort('dueDate','date');});$('#emergencySort').off('tap').on('tap',function(){sort('critical');});$('#executorSort').off('tap').on('tap',function(){sort('executorId')});$('#teamSort').off('tap').on('tap',function(){sort('groupId')});$('#collectSort').off('tap').on('tap',function(){sort('star');});function sort(data,type){var $ctn=$('#divWkList');$ctn.html('');var newWkList=_this.store;var low=0,high=newWkList.length-1;var temp;if(type=='date'){if(_this.sortType){while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data].toDate()>newWkList[i+1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data].toDate()<newWkList[i-1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}else{while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data].toDate()<newWkList[i+1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data].toDate()>newWkList[i-1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}}else{if(_this.sortType){while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data]>newWkList[i+1][data]){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data]<newWkList[i-1][data]){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}else{while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data]<newWkList[i+1][data]){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data]>newWkList[i-1][data]){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}}
var strWorkFlow;var $unit;for(var i=0;i<newWkList.length;i++){strWorkFlow=new StringBuilder();strWorkFlow.append('<div class="liWkRecord zepto-ev" id="'+newWkList[i].id+'">');strWorkFlow.append('<div class="divHead">');strWorkFlow.append('<div class="wkTitle title">'+newWkList[i].title+'</div>');strWorkFlow.append('<div class="wkDate additionText">'+newWkList[i].dueDate.toDate().format('yyyy-MM-dd')+'</div>');strWorkFlow.append('</div>');strWorkFlow.append('<div class="divDetail">');strWorkFlow.append('<div class="wkEmergency wkEmergency_'+newWkList[i].critical+'">\
                        <svg x="0px" y="0px" width="1024px" height="1024px" viewBox="0 0 1024 1024" enable-background="new 0 0 1024 1024" xml:space="preserve">\
                            <path class="svgpath" data-index="path_0" fill="#272636" d="M123.392 583.232l327.296 0-113.792 427.456 498.944-569.984L508.544 440.704l113.536-427.52L123.392 583.232zM123.392 583.232" />\
                        </svg>\
                    </div>');strWorkFlow.append('<div class="wkInfo text">'+newWkList[i].detail+'</div>');if(newWkList[i].creator_info){strWorkFlow.append('<div class="wkCreator additionText" i18n="appDashboard.workflow.CREATOR">'+I18n.resource.appDashboard.workflow.CREATOR+': '+newWkList[i].creator_info.userfullname+'</div>');}
strWorkFlow.append('<div class="wkExecutor additionText" i18n="appDashboard.workflow.EXECUTOR">'+I18n.resource.appDashboard.workflow.EXECUTOR+': '+newWkList[i].executorName+'</div>');strWorkFlow.append('<div class="wkGetStatus status_'+newWkList[i].statusId+'" i18n="appDashboard.workflow.STATUS_'+newWkList[i].statusId+'">'+_this.initStatus(newWkList[i].statusId)+'</div>');strWorkFlow.append('</div>');strWorkFlow.append('</div>');$unit=$(strWorkFlow.toString());$unit.find('.wkInfo').text(newWkList[i].detail);$ctn.append($unit);}
_this.sortType=!_this.sortType;_this.initWkDetail();$backDrop.hide();$workflowContainer.css('overflow','auto');$ulWkDropDown.hide();$wkTool.removeClass('on');}},initRefresh:function(){var $ctn=$('#outerContainer');var $ctnWk=$('#containerWorkFlowList');var startTime,evInit,evMove;$ctn.off('touchstart').on('touchstart',function(e){var evTouch=e.originalEvent.touches[0];if($ctnWk[0].scrollTop==0){e.preventDefault();evInit={x:evTouch.x,y:evTouch.y};}});$ctn.off('touchmove').on('touchmove',function(e){var evTouch=e.originalEvent.touches[0];evInit={x:evTouch.x,y:evTouch.y}});$ctn.off('touchend').on('touchend',function(e){var evTouch=e.originalEvent.changedToucher[0];evInit={x:evTouch.x,y:evTouch.y};console.log(e);})},initSearch:function(){$('#btnSearById').off('tap').on('tap',function(){var val=parseInt($('#iptSearById').val());if(!val){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.workflow.CHECK_CODE_FORMAT,'short','center');return;}
SpinnerControl.show();WebAPI.post('/workflow/transaction/'+val,{user_id:AppConfig.userId}).done(function(resultData){if(resultData.success&&resultData.data){router.to({typeClass:WorkflowDetail,data:{id:val,detail:resultData.data}})}else{window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.workflow.NO_WORKFLOW_INFO,'short','center');}}).fail(function(){window.plugins&&window.plugins.toast.show(I18n.resource.appDashboard.workflow.NO_WORKFLOW_INFO,'short','center');}).always(function(){SpinnerControl.hide();});})},close:function(){}};return WorkflowIndex})();var WorkflowAdd=(function(){var _this;function WorkflowAdd(){_this=this;_this.$wrapBg=undefined;_this.teamId=undefined;_this.taskGrp=[];_this.tag=[];_this.curProcess={};_this.opt={attachMent:[],fields:{critical:0,detail:null,dueDate:new Date(+new Date()+86400000).format('yyyy-MM-dd'),process:null,taskGroup:null,template_id:null,title:null},processMember:{},tags:[],watchers:[]};_this.userPage=undefined;}
WorkflowAdd.navOptions={top:'<div class="topNavTitle" i18n="appDashboard.workflow.WORKFLOW_CREATE"></div>',bottom:true,backDisable:false,module:'workflow'};WorkflowAdd.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/workflow/workflowAdd.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.$wrapBg=$(document.getElementById('wrapBg'));_this.init();I18n.fillArea($('#navTop'));I18n.fillArea($('#wkAddInfo'));I18n.fillArea($('#workflowAddBtn'));I18n.fillArea($('#wkUserDialog'));});},init:function(){SpinnerControl.show();$.when(WebAPI.get('/workflow/taskGroup/'),WebAPI.get('/workflow/tags/')).done(function(taskGrp,tags){_this.taskGrp=taskGrp[0].data;_this.tag=tags[0].data;_this.initUserSelectPage();_this.initDeadline();_this.initCritical();_this.initWatcher();_this.initTeam();_this.initTag();_this.initCreate();_this.attachEvent();}).always(function(){SpinnerControl.hide()});},attachEvent:function(){var _this=this;$('.panelEdit').parent().not('.disableDefault').off('touchend').on('touchend',function(e){$(e.currentTarget).find('.panelEdit').addClass('focus');_this.$wrapBg.addClass('focus');});this.$wrapBg.off('tap').on('tap',function(){var panelForTag=$('#wkTag .panelEdit');if(panelForTag.hasClass('focus')){panelForTag.find('spItem').removeClass('selected');for(var i=0;i<_this.opt.tags.length;i++){panelForTag.find('data-value=["'+_this.opt.tags[i]+'"]').addClass('selected')}}
$('.panelEdit').removeClass('focus');_this.$wrapBg.removeClass('focus');})},initUserSelectPage:function(){this.userPage=new SelectPage({type:'user',mode:'radio',ctn:document.getElementById('ctnUserSel'),teamId:_this.opt.fields.taskGroup,screen:_this});},initDeadline:function(){var $ctn=$('#wkDeadline');var $content=$ctn.find('.spContent');$content.text(new Date(+new Date()+86400000).format('yyyy-MM-dd'));$content.off('tap').on('tap',function(){if(typeof datePicker=='undefined')return;datePicker.show({date:date?date:new Date(),minDate:new Date(),mode:'date',okText:AppConfig.language=='zh'?'确定':'Done',cancelText:AppConfig.language=='zh'?'取消':'Cancel',allowFutureDates:false,doneButtonLabel:AppConfig.language=='zh'?'确定':'Done',cancelButtonLabel:AppConfig.language=='zh'?'取消':'Cancel'},setDate,function(){});});function setDate(date){if(!date)return;var strDate=new(date).format('yyyy-MM-dd');$content.textContent=strDate;_this.opt.fields.dueDate=strDate;}},initCritical:function(){var $ctn=$('#wkCritical');var $content=$ctn.find('.spContent');var $list=$ctn.find('.panelEdit');$list.off('tap').on('tap','.spItem',function(e){var $target=$(e.currentTarget);$list.removeClass('focus');_this.$wrapBg.removeClass('focus');if($target.hasClass('selected'))return;$target.siblings().removeClass('selected');$target.addClass('selected');_this.opt.fields.critical=e.currentTarget.dataset.value;$content.text(e.currentTarget.textContent);$content.removeClass('critical-0 critical-1 critical-2').addClass('critical-'+_this.opt.fields.critical)})},initUploadImg:function(){var $inputWkImg=$('#inputWkImg');$('#spanWkImg').off('tap').on('tap',function(e){e.stopPropagation();$inputWkImg.trigger('click');});var file,fileType,reader,strDivWkImg;fileType=/image*/;$inputWkImg.off('change').on('change',function(e){file=e.currentTarget.files[0];if(!file.type.match(fileType)){return;}
reader=new FileReader();reader.readAsDataURL(file);reader.onload=function(e){strDivWkImg=new StringBuilder();strDivWkImg.append('<div class="divWkImg">');strDivWkImg.append('    <img class="imgWkImg" src=" + e.target.result + ">');strDivWkImg.append('    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>');strDivWkImg.append('</div>')};});$('wkImg').off('touchstart').on('touchstart','.imgWkImg',function(e){$(e.currentTarget).parent().remove();});},initWatcher:function(){var $ctn=$('#wkWatcher');var $content=$ctn.find('.spContent');$ctn.off('tap').on('tap',function(e){_this.userPage.list=null;_this.userPage.selectList=_this.opt.watchers;_this.userPage.mode='check';_this.userPage.teamId=null;_this.userPage.callback=function(result){$content.html('');if(result.length==0){$content.text(I18n.resource.appDashboard.workflow.NO_CHOICE);}else{$content.html(result.map(function(user){return'<span>'+user.userfullname+'</span>'}).join(''));}
_this.opt.watchers=result.map(function(user){return user.id})};_this.userPage.show();});},initTeam:function(){var $ctn=$('#wkTeam');var $content=$ctn.find('.spContent');var $list=$ctn.find('.panelEdit');var item;for(var i=0;i<this.taskGrp.length;i++){item=document.createElement('span');item.className='spItem zepto-ev';item.dataset.value=this.taskGrp[i]._id;item.textContent=this.taskGrp[i].name;$list.append(item)}
$list.off('tap').on('tap','.spItem',function(e){var $target=$(e.currentTarget);$list.removeClass('focus');_this.$wrapBg.removeClass('focus');if($target.hasClass('selected'))return;$target.siblings().removeClass('selected');$target.addClass('selected');_this.opt.fields.taskGroup=e.currentTarget.dataset.value;$content.text(e.currentTarget.textContent);_this.initProcess();});$list.find('.spItem').first().trigger('tap');},initTag:function(){var $ctn=$('#wkTag');var $content=$ctn.find('.spContent');var $list=$ctn.find('.panelEdit');var item;for(var i=0;i<this.tag.length;i++){item=document.createElement('span');item.className='spItem zepto-ev';item.dataset.value=this.tag[i].type;item.textContent=this.tag[i].name;$list.append(item)}
$list.off('tap').on('tap','.spItem',function(e){var $target=$(e.currentTarget);$target.toggleClass('selected');});$list.on('tap','.btnSure',function(){var $selTag=$list.find('.spItem.selected');var arrTagText=[];var arrTagValue=[];for(var i=0;i<$selTag.length;i++){arrTagText.push('<span>'+$selTag[i].textContent+'</span>');arrTagValue.push($selTag[i].textContent);}
_this.opt.tags=arrTagValue;if(_this.opt.tags.length==0){$content.html(I18n.resource.appDashboard.workflow.NO_CHOICE);}else{$content.html(arrTagText.join(''));}
$list.removeClass('focus');_this.$wrapBg.removeClass('focus');})},initCreate:function(){$('#btnAddWk').off('tap').on('tap',function(){if(!_this.opt.processMember){window.plugins&&window.plugins.toast.show('请选择流程！','short','center');return;}else{for(var i=0;i<_this.curProcess.nodes.length;i++){if(!(_this.opt.processMember[_this.curProcess.nodes[i]._id]instanceof Array&&_this.opt.processMember[_this.curProcess.nodes[i]._id].length>0)){window.plugins&&window.plugins.toast.show('部分节点人员未选择，请检查！','short','center');return;}}}
_this.opt.fields.detail=document.getElementById('inputWkDetail').value;_this.opt.fields.title=document.getElementById('inputWkTitle').value;var postData=_this.opt;SpinnerControl.show();WebAPI.post('/workflow/task/save/',postData).done(function(resultData){if(resultData.success){window.plugins&&window.plugins.toast.show('创建成功，为您跳转','short','center');router.to({typeClass:WorkflowDetail,data:{id:resultData.data}})}}).fail(function(){window.plugins&&window.plugins.toast.show('创建失败，请稍后再试','short','center');}).always(function(){SpinnerControl.hide();});});},initProcess:function(){if(!_this.opt.fields.taskGroup)return;var $ctn=$('#wkProcess');var $content=$ctn.find('.spContent');var $list=$ctn.find('.panelEdit');var curGrp=_this.taskGrp.filter(function(item){return item._id==_this.opt.fields.taskGroup})[0];var process=curGrp.process;var spItem;$list.html('<span class="panelTtl">流程</span>');$content.html('');for(var i=0;i<process.length;i++){spItem=document.createElement('span');spItem.className='spItem zepto-ev';spItem.dataset.value=process[i]._id;spItem.dataset.template=process[i].template._id;spItem.textContent=process[i].name?process[i].name:'默认流程';$list.append(spItem)}
if(process&&process.length>0){$list.off('tap').on('tap','.spItem',function(e){var $target=$(e.currentTarget);$list.removeClass('focus');_this.$wrapBg.removeClass('focus');if($target.hasClass('selected'))return;$target.siblings().removeClass('selected');$target.addClass('selected');_this.opt.fields.process=e.currentTarget.dataset.value;_this.opt.fields.template_id=e.currentTarget.dataset.template;_this.curProcess=process.filter(function(item){return item._id==_this.opt.fields.process})[0];_this.opt.processMember={};if(_this.curProcess){for(var i=0;i<_this.curProcess.nodes.length;i++){_this.opt.processMember[_this.curProcess.nodes[i]._id]=[]}}
$content.text(e.currentTarget.textContent);_this.initProcessUser();});$list.find('.spItem').first().trigger('tap')}else{$list.off('tap');_this.opt.fields.process='';_this.opt.fields.template_id='';$content.text(I18n.resource.appDashboard.workflow.NO_CHOICE);this.initProcessUser()}},initProcessUser:function(){if(!_this.opt.fields.taskGroup)return;var $ctn=$('#wkProcessUser');var $content=$ctn.find('.spContent');var curGrp=_this.taskGrp.filter(function(item){return item._id==_this.opt.fields.taskGroup})[0];var process=curGrp.process.filter(function(item){return item._id==_this.opt.fields.process})[0];$content.html('');$ctn.removeClass('focus');if(process){var nodes=process.nodes;var node;$ctn.addClass('focus');$content.append(this.createNodeDom());for(var i=0;i<nodes.length;i++){node=this.createNodeDom(nodes[i],i);$content.append(node);}
$ctn.off('tap').on('tap','.spProcessNode',function(e){var $target=$(e.currentTarget);var index=$target.parent().index()-1;if($target.parent().hasClass('creator'))return;_this.userPage.selectList=_this.opt.processMember[process.nodes[index]._id];_this.userPage.list=process.nodes[index].members;_this.userPage.mode='radio';_this.userPage.teamId=_this.opt.fields.taskGroup;_this.userPage.callback=function(result){if(result.length>0){$target[0].style.backgroundImage='url("'+result[0].userpic+'")';$target.children().html(result.map(function(user){return'<span>'+user.userfullname+'</span>'}).join(''));_this.opt.processMember[process.nodes[index]._id]=[result[0]]}else{$target[0].style.backgroundImage='url("http://images.rnbtech.com.hk/static/images/avatar/user/default_group.png")';$target.text('未选择');_this.opt.processMember[process.nodes[index]._id]=[]}
_this.opt.processMemeber={}};_this.userPage.show();});var finishNode=document.createElement('span');finishNode.className='completeNode';finishNode.textContent='完成';$content.append(finishNode);}},createNodeDom:function(node,index){var dom=document.createElement('div');dom.className='divProcessNode';if(!node){node={behaviour:'0',members:[{userfullname:AppConfig.userProfile.fullname,userpic:'http://images.rnbtech.com.hk/'+AppConfig.userProfile.picture}]};dom.className+=' creator';}
var process=document.createElement('span');process.className='spProcessNode zepto-ev';if(node.archType==4){process.style.backgroundImage='url("http://images.rnbtech.com.hk/static/images/avatar/user/default_group.png")';}else{process.style.backgroundImage='url("'+node.members[0].userpic+'")';}
var user=document.createElement('span');user.className='spProcessUser';if(index!=null&&node.members instanceof Array&&node.members.length==1){user.textContent=node.members[0].userfullname;_this.opt.processMember[node._id]=[node.members[0]]}else{if(node.archType==4){user.textContent='全体成员';}else if(node.archType==3&&node.archName){user.textContent=node.archName;}else{user.textContent=node.members[0].userfullname}}
var behavior=document.createElement('span');behavior.className='spBehavior';switch(parseInt(node.behaviour)){case 0:behavior.textContent='发起人';break;case 1:behavior.textContent='审核';break;case 2:behavior.textContent='执行';break;}
var guide=document.createElement('span');guide.className='spGuide';process.appendChild(user);dom.appendChild(process);dom.appendChild(behavior);dom.appendChild(guide);return dom;},close:function(){}};return WorkflowAdd;})();var WorkflowDetail=(function(){var _this=this;function WorkflowDetail(data){_this=this;_this.SelectPage=undefined;if(data&&data.id){_this.wkId=data.id;}
_this.store={};_this.container=undefined;}
WorkflowDetail.navOptions={top:'<div class="topNavTitle" i18n="appDashboard.workflow.WORKFLOW_DETAIL"></div>',bottom:true,backDisable:false,module:'workflow'};WorkflowDetail.prototype={show:function(){try{var storage=JSON.parse(localStorage.getItem('pushWk'));storage=storage.filter(function(item){return(item.id!=WkConfig.wkId);});localStorage.setItem('pushWk',storage);if(storage.length>0){$('#btnWorkFlow .messageNum').text(storage.length).show();}else{$('#btnWorkFlow .messageNum').text(0).hide();}}catch(e){localStorage.setItem('pushWk',[]);$('#btnWorkFlow .messageNum').text(0).hide();}
$.ajax({url:'static/app/dashboard/views/workflow/workflowDetail.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.container=document.getElementById('containerMain');_this.init();I18n.fillArea($('#navTop'));I18n.fillArea($('#divContent'));I18n.fillArea($('#wkEdit'));I18n.fillArea($('#wkUserDialog'));});},init:function(){SpinnerControl.show();WebAPI.get('/workflow/task/'+_this.wkId).done(function(resultData){_this.store=resultData.data;_this.initWkInfo();_this.initOperate();}).always(function(){SpinnerControl.hide();});WebAPI.get('/workflow/task/comment/get/'+_this.wkId).done(function(result){var comment=result.data&&result.data.comment;_this.initComment(comment);});},initWkInfo:function(){try{var store=this.store;var title=this.container.querySelector('.divTitle');title.innerHTML=store.fields.title;var content=this.container.querySelector('.divContent');content.innerHTML=store.fields.detail;var critical=this.container.querySelector('.spCritical');$(critical).addClass('critical-'+store.fields.critical);critical.innerHTML=this.getCriticalContent(store.fields.critical);var status=this.container.querySelector('.spStatus');$(status).addClass('status-'+store.status);status.innerHTML=this.getStatusContent(this.store.status);var createTime=this.container.querySelector('.divUserInfo .createTime');createTime.innerHTML=new Date(store.createTime).format('yyyy-MM-dd HH:mm');var dueTime=this.container.querySelector('.divDueTime>.spDetail');dueTime.innerHTML=new Date(store.fields.dueDate).format('yyyy-MM-dd');var executor=this.container.querySelector('.divExecutor>.spDetail');executor.innerHTML=this.store.executorInfo.userfullname;var creator=this.container.querySelector('#createrInfo img');creator.src='http://images.rnbtech.com.hk'+this.store.creatorInfo.userpic;var creator=this.container.querySelector('#createrInfo .userName');creator.innerHTML=this.store.creatorInfo.userfullname;var watcher=this.container.querySelector('.divWatcher>.divDetailContent');watcher.innerHTML='';var arr=this.store.watchersInfo;var spWatcher;if(!arr||arr.length==0){$(watcher).addClass('none');}else{for(var i=0;i<arr.length;i++){spWatcher=document.createElement('span');spWatcher.className='spDetail';spWatcher.innerHTML=arr[i].userfullname+'';watcher.appendChild(spWatcher);}}
var team=this.container.querySelector('.divTaskGrp>.spDetail');team.innerHTML=this.store.taskGroup.name;var tag=this.container.querySelector('.divTaskTag>.divDetailContent');tag.innerHTML='';arr=this.store.tags;var spTag;if(!arr||arr.length==0){$(tag).addClass('none')}else{for(var i=0;i<arr.length;i++){spTag=document.createElement('span');spTag.className='spDetail';spTag.innerHTML=arr[i];tag.appendChild(spTag);}}}catch(e){SpinnerControl.hide();console.log(e.toString());}},initComment:function(comment){if(!(comment instanceof Array))return;var dom=document.createElement('div');dom.className='ctnComment';comment.forEach(function(ele){var item=document.createElement('div');item.className='divComment divUserInfo';var photo=document.createElement('span');photo.className='spPhoto userPic';photo.innerHTML='<img src = "'+ele.userInfo.userpic+'"/>';var spanNmTm=document.createElement('span');var name=document.createElement('div');name.className='spName userName';name.innerHTML=ele.userInfo.userfullname;var content=document.createElement('div');content.className='spComment';content.innerHTML=ele.content;var time=document.createElement('div');time.className='spTime time';time.innerHTML=new Date(ele.time).format('yyyy-MM-dd HH:mm:ss');spanNmTm.appendChild(name);spanNmTm.appendChild(time);item.appendChild(photo);item.appendChild(spanNmTm);item.appendChild(content);dom.appendChild(item);});this.container.appendChild(dom)},initOperate:function(){if(this.store.node_index==undefined)return;if(this.store.executor!=AppConfig.userId)return;var process=this.store.process.nodes[this.store.node_index];var $btnOperateGrp=$('#btnWkOperateGrp');if(process.behaviour==2){$btnOperateGrp.html('<span data-operate="0" class="btnOperate iconfont icon-kaishi zepto-ev"></span>');}else if(process!=undefined){$btnOperateGrp.html('<span data-operate="1"class="btnOperate iconfont icon-queding zepto-ev"></span><span data-operate="2" class="zepto-ev btnOperate iconfont icon-cuowu1"></span>');}
$btnOperateGrp.off('tap').on('tap','.btnOperate',function(e){var operate=e.currentTarget.dataset.operate;var nodeNextId;try{nodeNextId=_this.store.process.nodes[_this.store.node_index+1].members[0].id;}catch(e){nodeNextId=''}
var postData,url,defaultCallback;defaultCallback=true;switch(parseInt(operate)){case 0:postData={nextUserId:nodeNextId,taskId:_this.wkId};url='/workflow/complete/';break;case 1:postData={nextUserId:nodeNextId,taskId:_this.wkId};url='/workflow/passTask/';break;case 2:postData={taskId:_this.wkId};defaultCallback=false;infoBox.confirm('一旦不通过，将会终止整个工单，是否继续',function(){WebAPI.post('/workflow/noPassTask/',postData).done(function(){window.plugins&&window.plugins.toast.show('操作成功','short','center');_this.init();}).fail(function(){window.plugins&&window.plugins.toast.show('操作失败','short','center');});});break;}
if(defaultCallback){WebAPI.post(url,postData).done(function(){window.plugins&&window.plugins.toast.show('操作成功','short','center');_this.init();}).fail(function(){window.plugins&&window.plugins.toast.show('操作失败','short','center');}).always(function(){});}})},getCriticalContent:function(id){var strCritical;switch(parseInt(id)){case 0:strCritical=I18n.resource.appDashboard.workflow.NORMAL;break;case 1:strCritical=I18n.resource.appDashboard.workflow.SERIOUS;break;case 2:strCritical=I18n.resource.appDashboard.workflow.URGENT;break;default:strCritical='';break;}
return strCritical;},getStatusContent:function(id){if(id==null)return;var strStatus;switch(parseInt(id)){case 0:strStatus=I18n.resource.appDashboard.workflow.STATUS_0;break;case 1:strStatus=I18n.resource.appDashboard.workflow.STATUS_1;break;case 2:strStatus=I18n.resource.appDashboard.workflow.STATUS_2;break;case 3:strStatus=I18n.resource.appDashboard.workflow.STATUS_3;break;default:strStatus='';break;}
return strStatus;},initProgress:function(){var $container=$('#wkProgress').html('');var strProgress,status;WebAPI.get('/workflow/transaction/get_progress/'+WkConfig.wkId).done(function(result){var progressList=result.data;for(var i=0;i<progressList.length;i++){strProgress=new StringBuilder();switch(progressList[i].op){case'start':status=I18n.resource.appDashboard.workflow.OP_START;break;case'pause':status=I18n.resource.appDashboard.workflow.OP_PAUSE;break;case'complete':status=I18n.resource.appDashboard.workflow.OP_COMPLETE;break;case'restart':status=I18n.resource.appDashboard.workflow.OP_RESTART;break;case'new':status=I18n.resource.appDashboard.workflow.OP_NEW;break;case'edit':status=I18n.resource.appDashboard.workflow.OP_EDIT;break;case'forward':status=I18n.resource.appDashboard.workflow.OP_FORWARD;if(progressList[i].detail){var detail=JSON.parse(progressList[i].detail);var subStr=I18n.resource.appDashboard.workflow.OP_FORWARD_SUB;if(detail.executor&&detail.executor.old&&detail.executor.new){subStr=subStr.replace('<%old%>','<span style="color:darkorange">'+detail.executor.old+'</span>');subStr=subStr.replace('<%new%>','<span style="color:darkorange">'+detail.executor.new+'</span>');}}
status+='</br>'+subStr;break;case'verified':status=I18n.resource.appDashboard.workflow.OP_VERIFY;break;case'not_pass':status=I18n.resource.appDashboard.workflow.OP_NOT_PASS;break;case'reply':status=I18n.resource.appDashboard.workflow.OP_REPLY;break;case'delete':status=I18n.resource.appDashboard.workflow.OP_DELETE;break;case'close':status=I18n.resource.appDashboard.workflow.OP_CLOSE;break;case'delete_reply':status=I18n.resource.appDashboard.workflow.OP_DELETE_REPLY;break;}
strProgress.append('<div class="divProgress">');strProgress.append('   <div class="progressPic"><img src="'+progressList[i].userpic+'"></div>');strProgress.append('   <div class="progressTime">'+progressList[i].opTime.toDate().format('yyyy-MM-dd')+'</div>');strProgress.append('   <div class="progressUser">'+progressList[i].userfullname+'</div>');strProgress.append('   <div class="progressStatus">'+status+'</div>');strProgress.append('</div>');$container.append(strProgress.toString());}});},close:function(){}};return WorkflowDetail;})();var AdminConfig=(function(){var _this;function AdminConfig(){_this=this;}
AdminConfig.navOptions={top:'<div class="topNavTitle" i18n="appDashboard.apply.APPLY_CONFIG"></div>',bottom:true,backDisable:true,module:'admin'};AdminConfig.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/admin/adminConfig.html'}).done(function(resultHTML){$(_this.container).html(resultHTML);_this.init();_this.initLang();_this.initLogout();_this.initAdmin();_this.initVersion();_this.initHost();_this.initNav();I18n.fillArea($('#navTop'));I18n.fillArea($('.divAdminConfig'));});},init:function(){_this.initToggle();},initToggle:function(){$('.btnToggle').off('tap').on('tap',function(e){if($(e.currentTarget).hasClass('btnOn')){$(e.currentTarget).removeClass('btnOn').addClass('btnOff');}else{$(e.currentTarget).removeClass('btnOff').addClass('btnOn');}});},initLang:function(){var lang=AppConfig.language?AppConfig.language:'zh';$('#spanLangShow').text(_this.setLangShow(lang));$('#btnLang').off('tap').on('tap',function(){var tapThis=this;AppConfig.language=('zh'==AppConfig.language)?'en':'zh';localStorage["language"]=AppConfig.language;InitI18nResource(AppConfig.language,true).always(function(rs){I18n=new Internationalization(null,rs);_this.setLangConfig(lang)});});},setLangConfig:function(lang){localStorage["language"]=AppConfig.language;localStorage["i18n"]=JSON.stringify(i18n_resource);I18n.fillArea($("#navBottom"));router.to({typeClass:AdminConfig});},setLangShow:function(flag){return('zh'==flag)?'中文':'English';},initHost:function(){$('#forHelp').off('longTap').on('longTap',function(){$('#setHost').parent().show();_this.setHost();})},setHost:function(){var $liHost=$('#setHost').find('li').not(':last');$liHost.on('tap',function(e){localStorage.clear('userInfo');localStorage.setItem('beopHost',$(e.target).attr('value'));router.empty().to({typeClass:IndexScreen})});$('.iptHost').on('change',function(e){localStorage.clear('userInfo');localStorage.setItem('beopHost','http://'+$(e.target).val());router.empty().to({typeClass:IndexScreen})});},initLogout:function(){$('#btnLogout').off('tap').on('tap',function(){infoBox.confirm(I18n.resource.appDashboard.apply.CONFIRM_LOGOUT,function(){localStorage.clear();AppConfig={isMobile:true};$('.messageNum').text(0).hide();Push.setAlias();router.empty().to({typeClass:IndexScreen})})});},initVersion:function(){var lastVersion=localStorage.getItem('ignoreVersion');$('#spanVersion').text(AppConfig.version);$('#checkVersion').off('tap').on('tap',function(){VersionManage.getLastVersion();});},initAdmin:function(){var $adminInfo=$('#divAdmin');$adminInfo.hide();var strAdmin=new StringBuilder();strAdmin.append('<div class="adminPhoto"><img src="http://images.rnbtech.com.hk/static/images/avatar/user/47150161.jpg"></div>');strAdmin.append('<div class="adminInfo">');strAdmin.append('     <div class="adminName">李华</div>');strAdmin.append('     <div class="adminDetail">项目负责人</div>');strAdmin.append('</div>');strAdmin.append('<div class="adminConnect">');strAdmin.append('     <span class="adminTel"><a href="tel:13501989945"><span class="glyphicon glyphicon-earphone" aria-hidden="true"></span></a></span>');strAdmin.append('     <span class="adminMessage"><a href="sms:13501989945"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span></a></span>');strAdmin.append('</div>');$adminInfo.append(strAdmin.toString())},close:function(){},initNav:function(){$('#btnBack').off('touchstart').on('touchstart',function(e){switch(localStorage.getItem('module')){case'project':router.empty().to({typeClass:ProjectList,data:{}});break;case'message':router.empty().to({typeClass:MessageIndex,data:{}});break;case'workflow':router.empty().to({typeClass:WorkflowList,data:{}});break;default:router.empty().to({typeClass:ProjectList,data:{}});break;}});}};return AdminConfig;})();var AdminConfigNew=(function(){var _this;function AdminConfigNew(){_this=this;}
AdminConfigNew.prototype={show:function(){if($('.adminConfig').length===0){var adminConfig='<div class="adminConfig configHide"></div><div class="adminConfigMask"></div>';$("body").append(adminConfig);}
this.init();$('.adminConfigMask').fadeIn(200);var timer=setTimeout(function(){$('.configHide').removeClass('configHide');timer=null;},160);},init:function(){var _this=this;$.ajax({url:'static/app/dashboard/views/admin/adminConfigNew.html'}).done(function(resultHTML){$(".adminConfig").html(resultHTML);var unserInfo='<div>\
                                    <div class="headPic">\
                                        <img src="http://images.rnbtech.com.hk'+AppConfig.userProfile.picture+'" width="100%" height="100%">\
                                    </div>\
                                </div>\
                                <span>'+AppConfig.userProfile.fullname+'</span>\
                                <span>'+AppConfig.userProfile.name+'</span>';$(".adminConfigContainer .userInfo").html(unserInfo);var configLis='<li class="messageCenter">\
                                    <span i18n="appDashboard.message.MESSAGE_CENTER"></span>\
                                </li>\
                                <li class="changeLanguage">\
                                    <span i18n="appDashboard.apply.LANG"></span>\
                                    <span class="activeInfo lang"></span>\
                                </li>\
                                <li>\
                                    <span i18n="appDashboard.apply.EDITION_CHECK"></span>\
                                    <span class="activeInfo">'+AppConfig.version+'</span>\
                                </li>';$(".config ul").append(configLis);_this.initLanguage();_this.initMessage();_this.initLogout();_this.attachEvent();I18n.fillArea($('#navTop'));I18n.fillArea($('.adminConfigContainer'));});},initLanguage:function(){var lang=AppConfig.language?AppConfig.language:'zh';$('.lang').text(_this.setLangShow(lang));$('.changeLanguage').off('touchstart').on('touchstart',function(){AppConfig.language=('zh'==AppConfig.language)?'en':'zh';localStorage["language"]=AppConfig.language;$('.lang').text(_this.setLangShow(AppConfig.language));InitI18nResource(AppConfig.language,true).always(function(rs){I18n=new Internationalization(null,rs);_this.setLangConfig(lang)});});},setLangConfig:function(lang){localStorage["language"]=AppConfig.language;localStorage["i18n"]=JSON.stringify(i18n_resource);I18n.fillArea($("#navBottom"));I18n.fillArea($("#navTop"));I18n.fillArea($('.adminConfigContainer'));var projectList=new ProjectList();projectList.show();},setLangShow:function(flag){return('zh'==flag)?'中文':'English';},initMessage:function(){$('.messageCenter').off('touchstart').on('touchstart',function(e){_this.close();var msg;try{msg=JSON.parse(localStorage.getItem('pushMsg'));msg=msg.filter(function(item){return item.type=='message'});}catch(e){msg=[];}
router.to({typeClass:MessagePush,data:msg})
e.preventDefault();e.stopPropagation();});},initLogout:function(){var _this=this;$('#btnLogout').off('touchstart').on('touchstart',function(e){infoBox.confirm(I18n.resource.appDashboard.apply.CONFIRM_LOGOUT,function(){localStorage.clear();AppConfig.isMobile=true;$('.messageNum').text(0).hide();Push.setAlias();router.empty().to({typeClass:IndexScreen})})
_this.close();e.preventDefault();e.stopPropagation();});},close:function(){$(".adminConfig").remove();$(".adminConfigMask").remove();},attachEvent:function(){$('.adminConfig .headPic, .adminConfigMask').on('touchstart',function(e){var adminConfig=$('.adminConfig');var adminConfigMask=$('.adminConfigMask');$(adminConfig).addClass('configHide');$(adminConfigMask).fadeOut(300);var timer=setTimeout(function(){$(adminConfig).remove();$(adminConfigMask).remove();timer=null;},400);e.preventDefault();e.stopPropagation();});}};return AdminConfigNew;})();