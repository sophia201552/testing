var dataEfficiency=[{delayedCount:434,groupName:"HK CR0",totalCount:442,unFinishedCount:435,userStatics:[{delayedCount:177,totalCount:177,unFinishedCount:177,userId:null,userName:null},{delayedCount:66,totalCount:88,unFinishedCount:22,userId:1,userName:"admin"},{delayedCount:22,totalCount:33,unFinishedCount:11,userId:null,userName:null}]},{delayedCount:333,groupName:"HK CR1",totalCount:350,unFinishedCount:55,userStatics:[{delayedCount:177,totalCount:177,unFinishedCount:177,userId:null,userName:null},{delayedCount:66,totalCount:88,unFinishedCount:22,userId:1,userName:"admin"}]},{delayedCount:222,groupName:"HK CR2",totalCount:155,unFinishedCount:55,userStatics:[{delayedCount:22,totalCount:33,unFinishedCount:11,userId:null,userName:null}]}],WorkflowEfficiency=function(){function WorkflowEfficiency(){this.listGroupStatics=void 0,this.listUserStatics=void 0,this.maxNum=10,this.i18=I18n.resource.workflow.efficiency}return WorkflowEfficiency.prototype={show:function(){var _this=this;$.get("/static/views/workflow/efficiency.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($("#workflow-efficiency"))})},close:function(){},init:function(){function getData(){_this.listGroupStatics={},_this.listUserStatics={},Spinner.spin($("#GroupStatics")[0]),WebAPI.post("/workflow_get_user_statics",{user_id:AppConfig.userId}).done(function(result){var data=dataEfficiency;_this.renderData(data),Spinner.stop()})}var _this=this;getData(),$(".workflow-efficiency-table-footer").click(function(){getData()}),$("#thisMonth,#cumulative,#lastMonth").click(function(){var $o=$(this),isClickFlag=($o.attr("id"),$o.hasClass("btn-success"));isClickFlag||($o.removeClass("btn-default").addClass("btn-success").css("cursor","default").siblings("button").removeClass("btn-success").addClass("btn-default").css("cursor","pointer"),_this.updateStaticsChart(0))}),$("#divGroupStatics").on("click",".isSeeChart",function(){var $o=$(this),$op=$o.parents(".recordCon"),$nextChart=$op.next(".divUserStatics"),hiddenFlag=$nextChart.is(":hidden");hiddenFlag?($o.text(_this.i18.HIDE),$nextChart.slideDown(300)):($o.text(_this.i18.VIEW),$nextChart.slideUp(300))})},getStaticsChartStr:function(staticsArr){for(var staticsStr="",staticsArrL=staticsArr.length,maxNum=this.maxNum,i=0;staticsArrL>i;i++){var staticsObj=staticsArr[i],userName=staticsObj.userName,total=staticsObj.totalCount,unfinished=staticsObj.unFinishedCount,finished=total-unfinished,finishedPercentage=(finished/maxNum*100).toFixed(1),unFinishedPercentage=(unfinished/maxNum*100).toFixed(1),finishedRate=(finished/total*100).toFixed(1);staticsStr+='<div class="col-xs-3" style="height:35px;text-indent:10px;">'+userName+'</div><div class="col-xs-6" style="height:35px;"><div> <div class="progress-bar progress-bar-success progress-bar-striped active" role="progressbar" aria-valuenow="" aria-valuemin="0" aria-valuemax="100" style="width: '+finishedPercentage+'%;min-width:20px;border-radius:4px 0 0 4px"><span style="float:left;margin-left:6px;">'+finished+'</span></div><div class="progress-bar progress-bar-danger progress-bar-striped active" style="width: '+unFinishedPercentage+'%;min-width:20px;max-width:95%;border-radius:0 4px 4px 0"><span>'+unfinished+'</span></div></div></div><div class="col-xs-2" style="height:35px;text-align:center;">'+finishedRate+"%</div>"}return staticsStr},updateStaticsChart:function(num){var _this=this;Spinner.spin($("#GroupStatics")[0]),WebAPI.post("/workflow_get_user_statics",{user_id:AppConfig.userId}).done(function(result){var data=dataEfficiency;if(0==num){{data.length}this.maxNum=data[0].userStatics[0].totalCount;var $staticsObj=(this.maxNum,$(".divUserStatics")),$staticsObjL=$staticsObj.length;for(i=0;i<$staticsObjL;i++){var $obj=$staticsObj.eq(i),dataObj=data[i],staticsArr=dataObj.userStatics,staticsStr=_this.getStaticsChartStr(staticsArr);$obj.html(staticsStr)}}else 1==num&&_this.renderData(data);Spinner.stop()})},renderData:function(data){var _this=this,dataL=data.length;divGroupStatics=$("#divGroupStatics"),divGroupStatics.children().remove();var tableHtml="";this.maxNum=data[0].userStatics[0].totalCount;for(var i=(this.maxNum,0);dataL>i;i++){var dataObj=data[i],staticsArr=dataObj.userStatics,groupName=dataObj.groupName,fTotal=parseFloat(dataObj.totalCount),fUnFished=parseFloat(dataObj.unFinishedCount),fDelayedPercentage=(fUnFished/fTotal*100).toFixed(1);tableHtml+='<div class="row" style="padding:5px;border-bottom:1px inset #ccc"><div class="recordCon" style="overflow:hidden;height: 37px;line-height: 36px;"><div class="col-xs-3">'+groupName+'</div><div class="col-xs-2">'+fTotal+'</div> <div class="col-xs-2">'+fUnFished+'</div> <div class="col-xs-2">'+(Number(fDelayedPercentage)?fDelayedPercentage+"%":"--")+'</div><div class="col-xs-2" style="text-align:center;"><button type="button" class="btn btn-primary isSeeChart" i18n="workflow.efficiency.VIEW"></button></div></div><div class="row divUserStatics" style="margin: 10px 0px 0px 0px; padding: 15px 5px 5px 5px; border-top: 1px dashed #ccc;display: none;">';var staticsChartStr=_this.getStaticsChartStr(staticsArr);tableHtml+=staticsChartStr+"</div></div>"}divGroupStatics.append(tableHtml),I18n.fillArea($("#workflow-efficiency"))}},WorkflowEfficiency}(),WorkflowTool=function(){function getStatusText(status){switch(status){case"new":return I18n.resource.workflow.main.NEW;case 1:return I18n.resource.workflow.main.ASSIGNED;case 2:return I18n.resource.workflow.main.DEALING;case 3:return I18n.resource.workflow.main.PAUSED;case 4:return I18n.resource.workflow.main.FINISHED;case 5:return I18n.resource.workflow.main.DELETED}}function updateBadge(count,list){var $badge=$("#paneWorkflow").find('li[screen="mine"]').find(".badge");count?$badge.text(count).data("new-tasks",list):$badge.text("").data("new-tasks","")}function updateNewTaskCount(){AppConfig.userId&&$.get("/workflow/new_task_count/"+AppConfig.userId).done(function(result){try{var r_obj=JSON.parse(result)}catch(e){return!1}var storageNewTask=localStorage.getItem("new_task_"+AppConfig.userId);if(storageNewTask){try{storageNewTask=JSON.parse(storageNewTask)}catch(e){return!1}for(var unreadList=[],n=0,len=r_obj.length;len>n;n++)-1===$.inArray(r_obj[n],storageNewTask)&&unreadList.push(r_obj[n]);updateBadge(unreadList.length,unreadList),localStorage.setItem("new_task_temp_"+AppConfig.userId,result)}else updateBadge(r_obj.length,r_obj)})}function getTemplate(template,selector){templateStorage=templateStorage||{};var promise;promise=templateStorage[template]?templateStorage[template]:templateStorage[template]=$.get(template);var dfd=$.Deferred();return promise.done(function(result){var $result=$(result),$template=$result.find(selector).children(),$return=$template.clone();I18n.fillArea($return),dfd.resolve($return)}),dfd}function getWorkflowTemplate(selector){return getTemplate("/static/views/workflow/template.html",selector)}function inherits(clazz,base){function F(){}var clazzPrototype=clazz.prototype;F.prototype=base.prototype,clazz.prototype=new F;for(var prop in clazzPrototype)clazz.prototype[prop]=clazzPrototype[prop];clazz.constructor=clazz}function getUserName(rawUserName){return rawUserName.indexOf("@")>0?rawUserName.substring(0,rawUserName.indexOf("@")):rawUserName}var templateStorage,pic_path="/static/images/workflow/";return{pic_path:pic_path,getStatusText:getStatusText,updateBadge:updateBadge,updateNewTaskCount:updateNewTaskCount,getWorkflowTemplate:getWorkflowTemplate,inherits:inherits,getUserName:getUserName}}(),WorkflowMain=function(){function render_template(group_info){WorkflowTool.getWorkflowTemplate("#wf-main-gd-block").done(function(template_inner){if(!template_inner)return!1;if(template_inner.find(".media-heading").text(group_info.name).attr("title",group_info.name),group_info.pic){var image=WorkflowTool.pic_path+group_info.pic;template_inner.find(".media-left").empty().append('<img class="wf-project-icon" src="'+image+'">')}template_inner.find(".media-body").append(group_info.description).attr("title",group_info.description),template_inner.find(".glyphicon-stats .icon-row-text").text(group_info.totalCount),template_inner.find(".glyphicon-ok-circle .icon-row-text").text(group_info.finishedCount),template_inner.find(".glyphicon-time .icon-row-text").text(group_info.delayedCount),template_inner.find(".gd").data("group",group_info),$(".gd-row").prepend(template_inner)})}function WorkflowMain(){}return WorkflowMain.prototype={show:function(){var _this=this;$.get("/static/views/workflow/main.html").done(function(resultHtml){$(ElScreenContainer).empty().html(resultHtml),_this.init(),I18n.fillArea($(ElScreenContainer))})},close:function(){},init:function(){Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/init",{user_id:AppConfig.userId}).done(function(result){if(result)try{var result_obj=JSON.parse(result),group_info=result_obj.group_info;group_info&&"string"==typeof group_info&&(group_info=[]);for(var n=0,nLen=group_info.length;nLen>n;n++)render_template(group_info[n])}catch(e){}}).always(function(){Spinner.stop()}),$("#workflow-main").on("click",".new-gd",function(){var $gd=$(this);if($gd.find(".media-body.edit").size()>0)return!1;$gd.find(".media-body").hide();var edit_media_body=$('<div class="media-body edit"><h3 class="media-heading"><textarea class="gd-edit-textarea title" placeholder="'+I18n.resource.workflow.main.ADD+' " maxlength="255"></textarea></h3><textarea class="gd-edit-textarea desc" placeholder="'+I18n.resource.workflow.main.ALARM_CONTENT+' " maxlength="255"></textarea></div>');edit_media_body.append('<div class="gd-operator-btns"><button type="button" class="pull-right btn btn-success edit-btn edit-btn-save"><span i18n="workflow.main.SAVE"></span></button><button type="button" class="pull-right btn btn-default edit-btn edit-btn-cancel"><span i18n="workflow.main.CANCEL"></span></button></div>'),$gd.find(".media").append(edit_media_body),I18n.fillArea($gd)}).on("click",".edit-btn-cancel",function(){var content_row=$(this).closest(".content-row");return content_row.find(".media-body.edit").remove().end().find(".media-body").show(),!1}).on("click",".edit-btn-save",function(){var media_body=$(this).closest(".media-body"),title=media_body.find(".title").val().trim(),desc=media_body.find(".desc").val().trim();if(!title){var alert=new Alert(".new-gd","danger",I18n.resource.workflow.main.NAME_NOT_NULL).show();return setTimeout(function(){alert.close()},2e3),!1}return Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/group/add/",{userId:AppConfig.userId,name:title,description:desc}).done(function(result){if(!result)return!1;try{var result_obj=JSON.parse(result)}catch(e){return!1}render_template({id:result_obj.id,name:title,description:desc,totalCount:0,finishedCount:0,delayedCount:0,pic:result_obj.pic});var content_row=media_body.closest(".content-row");return content_row.find(".media-body.edit").remove().end().find(".media-body").show(),!1}).always(function(){Spinner.stop()}),!1}).on("click",".gd:not(.new-gd)",function(){var group=$(this).data("group");ScreenCurrent.close(),ScreenCurrent=new workflowTransaction(group),ScreenCurrent.show()})}},WorkflowMain}();$(function(){function FetchMembers(){return _fetchMemberPromise||(_fetchMemberPromise=WebAPI.get("/getTransactionGroupUser")),_fetchMemberPromise}function FetchGroups(){return _fetchGroupPromise||(_fetchGroupPromise=WebAPI.get("/getTransactionGroup")),_fetchGroupPromise}var _fetchMemberPromise,_fetchGroupPromise;$(ElScreenContainer).on("click.filter-toggle",".member-filter-dialog-icon",function(ele){$(".filter-dialog-icon").siblings(".mini-dialog").removeClass("open");var $this=$(this),mini_dialog=$this.siblings(".mini-dialog");mini_dialog.toggleClass("open"),mini_dialog.hasClass("open")&&!mini_dialog.attr("done")&&(Spinner.spin(mini_dialog[0]),FetchMembers().done(function(result){try{result=JSON.parse(result)}catch(e){return}for(var group_section=mini_dialog.find(".groups").find(".content"),memeber_section=mini_dialog.find(".members"),gInd=0,gLen=result.length;gLen>gInd;gInd++){var group=result[gInd],members=group.mem;group_section.append('<a class="btn btn-info group-btn" data-id="'+group.id+'">'+group.nm+"</a>");for(var mInd=0,mLen=members.length;mLen>mInd;mInd++){var member=members[mInd];memeber_section.append('<a class="btn btn-info member-btn" data-id="'+member.id+'" data-group="'+group.id+'">'+member.nm+"</a>")}}mini_dialog.attr("done",!0)}).always(function(){Spinner.stop()}))}).on("click.filter-toggle",".group-filter-dialog-icon",function(ele){$(".filter-dialog-icon").siblings(".mini-dialog").removeClass("open");var $this=$(this),mini_dialog=$this.siblings(".mini-dialog");mini_dialog.toggleClass("open"),mini_dialog.hasClass("open")&&!mini_dialog.attr("done")&&(Spinner.spin(mini_dialog[0]),FetchGroups().done(function(result){try{result=JSON.parse(result)}catch(e){return}var groups=mini_dialog.find(".groups").find(".content");groups.append('<a class="btn btn-info task-btn">'+I18n.resource.workflow.main.ALL+"</a>");for(var n=0,nlen=result.length;nlen>n;n++){var item=result[n];groups.append('<a class="btn btn-info task-btn" data-id="'+item.id+'">'+item.nm+"</a>")}mini_dialog.attr("done",!0)}).always(function(){Spinner.stop()}))}).on("click.row-toggle",".row-toggle-icon",function(ele){var openIconClass="glyphicon-circle-arrow-down",closeIconClas="glyphicon-circle-arrow-up",$this=$(this),$toggle=$this.parent().siblings().filter(".toggle-enable").toggleClass("hidden");$toggle.hasClass("hidden")?$this.removeClass(openIconClass).addClass(closeIconClas):$this.removeClass(closeIconClas).addClass(openIconClass)}).on("click.group-btn",".group-btn",function(){var group_btn=$(this),id=group_btn.data("id"),mini_dialog=group_btn.closest(".mini-dialog");mini_dialog.find(".group-btn").removeClass("active"),group_btn.addClass("active"),mini_dialog.find(".members").children(".member-btn").addClass("disabled").filter("[data-group="+id+"]").removeClass("disabled")}).on("click.all-member","#all-member-btn",function(){$(this).closest(".mini-dialog").find(".group-btn").removeClass("active").end().find(".member-btn").removeClass("disabled")}).on("click.notice_filter",".member-btn",function(e){var $this=$(this),memberId=$this.data("id");$this.closest(".filter-body").find(".filter-result").text($this.text()),memberId||(memberId=-1),ScreenCurrent instanceof WorkflowReport?ScreenCurrent.updateSelUser(memberId):ScreenCurrent instanceof WorkflowNotice&&ScreenCurrent.updateNoticeContent(memberId)}).on("click.notice_filter",".task-btn",function(e){var $this=$(this),id=$this.data("id");$this.closest(".filter-body").find(".filter-result").text($this.text()),id||(id=-1),ScreenCurrent instanceof WorkflowReport?ScreenCurrent.updateSelPrj(id):ScreenCurrent instanceof WorkflowTeam&&ScreenCurrent.loadPage(id)})}),$(document).on("click.wf.mini-dialog",function(ent){var $target=$(ent.target);$target.hasClass("filter-dialog-icon")||$(ent.target).closest(".mini-dialog").length||$(".mini-dialog").is(":visible")&&$(".mini-dialog").removeClass("open")});var WorkflowMine=function(){function getStatusText(status){switch(I18n.fillArea($("span")),status){case 0:return I18n.resource.workflow.mine.TASK_STATUS_NEW;case 1:return I18n.resource.workflow.mine.TASK_STATUS_DISTRIBUTED;case 2:return I18n.resource.workflow.mine.TASK_STATUS_PROCESSING;case 3:return I18n.resource.workflow.mine.TASK_STATUS_PAUSED;case 4:return I18n.resource.workflow.mine.TASK_STATUS_COMPLETED}}function _GroupArray(prop,array){for(var group={},n=0,nlen=array.length;nlen>n;n++){var item=array[n],groupItem=group[item[prop]];groupItem?groupItem.push(item):group[item[prop]]=[item]}return group}function WorkflowMine(){this.i18=I18n.resource.workflow.urgencyLevel}var profilePromise,memberListPromise={};return WorkflowMine.prototype={show:function(){var _this=this;$.get("/static/views/workflow/mine.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($("#workflow-mine"))})},close:function(){},check_empty_tasks:function(){var new_tasks=$(".new-task-row .task-items"),urgent_tasks=$(".urgent-task-row .task-items"),pend_tasks=$(".pend-task-row .task-items");0===new_tasks.find(".task-item").length?new_tasks.find(".empty-message").show():new_tasks.find(".empty-message").hide(),0===urgent_tasks.find(".task-item").length?urgent_tasks.find(".empty-message").show():urgent_tasks.find(".empty-message").hide(),0===pend_tasks.find(".task-item").length?pend_tasks.find(".empty-message").show():pend_tasks.find(".empty-message").hide()},refresh_tasks:function(){var _this=this;return Spinner.spin($(".workflow-container")[0]),WorkflowTool.getWorkflowTemplate("#wf-mine-tasks").pipe(function(template){return $.get("/workflow/transaction/notCompleted/"+AppConfig.userId).done(function(result){try{var result_json=JSON.parse(result)}catch(e){return}for(var new_tasks=$(".new-task-row .task-items").find(".task-item").remove().end(),urgent_tasks=$(".urgent-task-row .task-items").find(".task-item").remove().end(),pend_tasks=$(".pend-task-row .task-items").find(".task-item").remove().end(),i18IcArr=[_this.i18.GENERAL,_this.i18.SERIOUS,_this.i18.URGENT],n=0,nlen=result_json.length;nlen>n;n++){var item=result_json[n],temp=template.clone();switch(temp.attr("task-id",item.id),temp.find(".task-title").text(item.title).attr("title",item.title),temp.find(".date").text(item.dueDate?new Date(item.dueDate).format("yyyy-MM-dd"):"").attr("title","deadline"),temp.find(".timer").children("span").removeClass().addClass("glyphicon ic"+item.critical).attr("title",i18IcArr[item.critical]),temp.find(".alert-type").text(item.groupNm).attr("title",item.groupNm),temp.find(".play-pause").addClass(2===item.statusId?"glyphicon-pause":"glyphicon-play"),temp.find(".status").html(getStatusText(item.statusId)),temp.data("task",item),item.priority){case 5:new_tasks.append(temp);break;case 6:urgent_tasks.append(temp);break;case 4:pend_tasks.append(temp)}}_this.check_empty_tasks();var currentNewTask=localStorage.getItem("new_task_temp_"+AppConfig.userId),newTask=$("#ulPages").find('li[screen="mine"]').find(".badge").data("new-tasks");if(newTask){var new_task_row=$(".new-task-row").find(".task-items");new_task_row.css({border:"1px dotted #666",backgroundColor:"antiquewhite"}),setTimeout(function(){new_task_row.css({border:"none",backgroundColor:"white"})},1e3)}localStorage.setItem("new_task_"+AppConfig.userId,currentNewTask),WorkflowTool.updateBadge(0)}).done(function(){}).always(function(){Spinner.stop()})})},refresh_categories:function(){var _this=this;return Spinner.spin($(".workflow-container")[0]),$.when(WorkflowTool.getWorkflowTemplate("#wf-mine-tasks"),WorkflowTool.getWorkflowTemplate("#wf-mine-tasks-complete")).done(function(tasks_template,completed_template){return WebAPI.get("/workflow/transaction/getAll/"+AppConfig.userId).done(function(result){if(!result)return!1;try{var result_obj=JSON.parse(result)}catch(e){return void console.error(e)}$(".categories-container").children().remove();var groupedResult=_GroupArray("groupName",result_obj),inner_template=completed_template.clone(),completedTaskItemTemplate=inner_template.find(".task-item"),uncompletedTaskItemTemplate=tasks_template.clone();inner_template.find(".task-item").remove();var i18IcArr=[_this.i18.GENERAL,_this.i18.SERIOUS,_this.i18.URGENT];for(var groupNm in groupedResult){var template=inner_template.clone(),groups=groupedResult[groupNm];template.find(".task-type").text(groupNm);for(var n=0,nlen=groups.length;nlen>n;n++){var group=groups[n];if(4===group.statusId){var taskItem=completedTaskItemTemplate.clone();taskItem.find(".task-title").text(group.title).attr("title",group.title),taskItem.find(".date").text(group.completeTime?new Date(group.completeTime).format("yyyy-MM-dd"):"").attr("title","resolved date"),taskItem.data("task",group)}else{var taskItem=uncompletedTaskItemTemplate.clone();taskItem.find(".task-title").text(group.title).attr("title",group.title),taskItem.find(".date").text(group.dueDate?new Date(group.dueDate).format("yyyy-MM-dd"):"").attr("title","deadline"),taskItem.find(".play-pause").addClass(2===group.statusId?"glyphicon-pause":"glyphicon-play"),taskItem.find(".status").html(getStatusText(group.statusId)),taskItem.data("task",group)}taskItem.find(".timer").children("span").removeClass().addClass("glyphicon ic"+group.critical).attr("title",i18IcArr[group.critical]),template.find(".task-items").append(taskItem)}$(".categories-container").append(template)}}).always(function(){Spinner.stop()})})},refresh_completed:function(){return Spinner.spin($(".workflow-container")[0]),WorkflowTool.getWorkflowTemplate("#wf-mine-tasks-complete").pipe(function(completed_template){return WebAPI.get("/workflow/transaction/completed/"+AppConfig.userId).done(function(result){if(!result)return!1;try{var result_obj=JSON.parse(result)}catch(e){return void console.error(e)}$(".completed-container").children().remove();var groupedResult=_GroupArray("groupName",result_obj),inner_completed_template=completed_template.clone(),taskItemTemplate=inner_completed_template.find(".task-item");inner_completed_template.find(".task-item").remove();for(var groupNm in groupedResult){var template=inner_completed_template.clone(),groups=groupedResult[groupNm];template.find(".task-type").text(groupNm);for(var n=0,nlen=groups.length;nlen>n;n++){var group=groups[n],taskItem=taskItemTemplate.clone();taskItem.find(".task-title").text(group.title).attr("title",group.title),taskItem.find(".date").text(group.completeTime?new Date(group.completeTime).format("yyyy-MM-dd"):"").attr("title","resolved date"),taskItem.data("task",group),template.find(".task-items").append(taskItem)}$(".completed-container").append(template)}}).always(function(){Spinner.stop()})})},refresh_starred:function(){var _this=this;return Spinner.spin($(".workflow-container")[0]),$.when(WorkflowTool.getWorkflowTemplate("#wf-mine-tasks"),WorkflowTool.getWorkflowTemplate("#wf-mine-tasks-complete")).done(function(tasks_template,completed_template){return WebAPI.get("/workflow/transaction/starred/"+AppConfig.userId).done(function(result){if(!result)return!1;try{var result_obj=JSON.parse(result)}catch(e){return void console.error(e)}$(".starreds-container").children().remove();var groupedResult=_GroupArray("groupName",result_obj),inner_template=completed_template.clone(),completedTaskItemTemplate=inner_template.find(".task-item"),uncompletedTaskItemTemplate=tasks_template.clone();inner_template.find(".task-item").remove();var i18IcArr=[_this.i18.GENERAL,_this.i18.SERIOUS,_this.i18.URGENT];for(var groupNm in groupedResult){var template=inner_template.clone(),groups=groupedResult[groupNm];template.find(".task-type").text(groupNm);for(var n=0,nlen=groups.length;nlen>n;n++){var group=groups[n];if(4===group.statusId){var taskItem=completedTaskItemTemplate.clone();taskItem.find(".task-title").text(group.title).attr("title",group.title),taskItem.find(".date").text(group.completeTime?new Date(group.completeTime).format("yyyy-MM-dd"):"").attr("title","resolved date"),taskItem.data("task",group)}else{var taskItem=uncompletedTaskItemTemplate.clone();taskItem.find(".task-title").text(group.title).attr("title",group.title),taskItem.find(".date").text(group.dueDate?new Date(group.dueDate).format("yyyy-MM-dd"):"").attr("title","deadline"),taskItem.find(".play-pause").addClass(2===group.statusId?"glyphicon-pause":"glyphicon-play"),taskItem.find(".status").html(getStatusText(group.statusId)),taskItem.data("task",group)}template.find(".timer").children("span").removeClass().addClass("glyphicon ic"+group.critical).attr("title",i18IcArr[group.critical]),template.find(".task-items").append(taskItem)}$(".starreds-container").append(template)}}).always(function(){Spinner.stop()})})},init:function(){profilePromise||(profilePromise=$.get("/workflow/profile/"+AppConfig.userId)),profilePromise.done(function(result){var jResult=JSON.parse(result);$(".mine-avatar-name").text(jResult.userfullname?jResult.userfullname:jResult.username),$(".mine-avatar-desc").text(jResult.useremail?jResult.useremail:"")}),$(".screen-row").hide(),$(".tasks").show(),this.refresh_tasks();var _this=this;$("#workflow-mine").on("click",".glyphicon-ok-sign",function(){var taskitem=$(this).closest(".task-item"),task=taskitem.data("task");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/complete/",{id:task.id,userId:AppConfig.userId}).done(function(result){"success"===result&&taskitem.remove()}).always(function(){Spinner.stop()})}).on("click",".glyphicon-pause",function(){var taskitem=$(this).closest(".task-item"),task=taskitem.data("task");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/pause/",{id:task.id,userId:AppConfig.userId}).done(function(result){"success"===result&&taskitem.find(".status").html(getStatusText(3)).end().find(".glyphicon-pause").removeClass("glyphicon-pause").addClass("glyphicon-play")}).always(function(){Spinner.stop()})}).on("click",".glyphicon-play",function(){var taskitem=$(this).closest(".task-item"),task=taskitem.data("task");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/start/",{id:task.id,userId:AppConfig.userId}).done(function(result){"success"===result&&taskitem.find(".status").html(getStatusText(2)).end().find(".glyphicon-play").removeClass("glyphicon-play").addClass("glyphicon-pause")}).always(function(){Spinner.stop()})}).on("click",".glyphicon-edit",function(){var ownId=AppConfig.userId,task=$(this).parents(".task-item"),task_body=(task.attr("task-id"),$(this).closest(".task-body")),groupid=task.data("task").groupId;if(task_body.hasClass("editing"))return!1;task_body.addClass("editing");var title_div=task_body.find(".task-title"),title=title_div.text();title_div.data("title",title),title_div.empty(),title_div.append('<textarea class="edit-textarea">'+title+"</textarea>");var memPromise=memberListPromise[groupid];memPromise||(memPromise=WebAPI.get("/workflow/getTransactionGroupMembers/"+groupid),memberListPromise[groupid]=memPromise),Spinner.spin(task[0]),memPromise.done(function(result){var btnObj='<button type="button" class="pull-right btn btn-success edit-btn edit-btn-save">保存</button><button type="button" class="pull-right btn btn-default edit-btn edit-btn-cancel">取消</button>';title_div.append(btnObj);for(var selectArr=JSON.parse(result),html='<select class="pull-right" style="width:120px;height:30px;position:relative;top:6px;left:-2px;"><option disabled>重新分配</option>',selectArrL=selectArr.length,i=0;selectArrL>i;i++){var selectObj=selectArr[i],selectId=selectObj.id,selectName=selectObj.name;html+=selectId!=ownId?'<option value="'+selectId+'">'+selectName+"</option>":'<option value="'+selectId+'" selected>'+selectName+"</option>"}html+="</select>",title_div.append(html)}).always(function(){Spinner.stop()})}).on("click","#ckeck_completed",function(){$(".screen-row").hide(),_this.refresh_completed().done(function(){$(".completed").show(),$(".member-nav").find("li.active").removeClass("active"),I18n.fillArea($("span"))})}).on("click",".btn-tasks",function(){$(".screen-row").hide();var $this=$(this);_this.refresh_tasks().done(function(){$(".tasks").show(),$this.closest(".member-nav").find("li.active").removeClass("active").end().end().closest("li").addClass("active"),I18n.fillArea($("span"))})}).on("click",".btn-starreds",function(){$(".screen-row").hide();var $this=$(this);_this.refresh_starred().done(function(){$(".starreds").show(),$this.closest(".member-nav").find("li.active").removeClass("active").end().end().closest("li").addClass("active"),I18n.fillArea($("span"))})}).on("click",".btn-cates",function(){$(".screen-row").hide();var $this=$(this);_this.refresh_categories().done(function(){$(".categories").show(),$this.closest(".member-nav").find("li.active").removeClass("active").end().end().closest("li").addClass("active"),I18n.fillArea($("span"))})}).on("click",".glyphicon-repeat",function(){var taskitem=$(this).closest(".task-item"),task=taskitem.data("task");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/restart/",{id:task.id,userId:AppConfig.userId}).done(function(result){"success"===result&&taskitem.remove()}).always(function(){Spinner.stop()})}).on("click",".edit-btn-cancel",function(e){var taskTitle_div=$(this).closest(".task-title"),title=taskTitle_div.data("title");taskTitle_div.children().remove().end().text(title),taskTitle_div.closest(".task-body").removeClass("editing"),e.stopPropagation()}).on("click",".edit-btn-save",function(e){Spinner.spin($(".workflow-container")[0]);var taskIdObj=$(this).parents(".task-item"),taskTitle_div=$(this).closest(".task-title"),title=$(this).siblings(".edit-textarea").val(),task_item=$(this).closest(".task-item"),taskData=task_item.data("task"),select=$(this).siblings("select"),selectVal=select.val(),data={title:title,transId:taskData.id,userId:AppConfig.userId,executorID:selectVal};WebAPI.post("/workflow/transaction/edit",data).done(function(result){"deassign"===result?taskIdObj.remove():"success"===result&&(taskTitle_div.children().remove().end().text(title),task_item.find(".task-body").removeClass("editing"))}).always(function(){Spinner.stop()}),e.stopPropagation()}).on("click",".task-title",function(){if($(this).closest(".task-body").hasClass("editing"))return!1;var id=$(this).closest(".task-item").data("task").id;new workflowNoticeDetail(id,I18n.resource.workflow.pageInfo.TITLE_WO_MY,$(ElScreenContainer).children().detach()).show()})}},WorkflowMine}(),WorkflowNotice=function(){function translate(text){if(!text)return"";if(text.indexOf("was renamed")>0)return text.replace("was renamed"," "+I18n.resource.workflow.notice.TASK_RENAME+" ");switch(text){case"edit":return I18n.resource.workflow.notice.TASK_EDIT;case"complete":return I18n.resource.workflow.notice.TASK_FINISH;case"restart":return I18n.resource.workflow.notice.TASK_RESTART;case"start":return I18n.resource.workflow.notice.TASK_START;case"pause":return I18n.resource.workflow.notice.TASK_PAUSE;case"reply":return I18n.resource.workflow.notice.TASK_REPLY;case"new":return I18n.resource.workflow.notice.TASK_CREATE;default:return text}}function render_template(notice){WorkflowTool.getWorkflowTemplate("#wf-notice-latest-info").done(function(template){template.find(".avatar-name").text(notice.userName),template.find(".info-date-row .date").text(notice.opTime),template.find(".latest-info-title").text(translate(notice.title)),template.find(".notice-item").text(translate(notice.detail)),template.find(".notice-item").attr("href","#/notice/"+notice.linkToTransactionId).attr("data-id",notice.linkToTransactionId),$("#operations").append(template)})}function WorkflowNotice(id){this.id=id}var rownumber=0,userID=AppConfig.userId;return WorkflowNotice.prototype={show:function(){var _this=this;$.get("/static/views/workflow/notice.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($("#notice-container"))})},close:function(){rownumber=0,userID=AppConfig.userId},init:function(){var _this=this;_this.clearNoticeContent(),$("#more").click(function(){rownumber+=1,Spinner.spin($(".workflow-container")[0]),WebAPI.get("/getTransactionOperationRecordByUserId/"+(userID?userID:AppConfig.userId)+"/"+rownumber).done(function(result){_this.initNoticeContent(JSON.parse(result))}).always(function(){Spinner.stop()})}),Spinner.spin($(".workflow-container")[0]),WebAPI.get("/getTransactionOperationRecordByUserId/"+(userID?userID:AppConfig.userId)+"/"+rownumber).done(function(result){_this.initNoticeContent(JSON.parse(result))}).always(function(){Spinner.stop()}),$("#notice-container").on("click",".notice-item",function(){try{if(Path&&!Path.version)return!0}catch(e){return ScreenCurrent.close(),ScreenCurrent=new workflowNoticeDetail($(this).data("id"),I18n.resource.workflow.notice.TITLE_WO_DYNAMIC),ScreenCurrent.show(),!1}})},initNoticeContent:function(notices){this.clearNoticeContent();var paneSelector=$("#operations");

notices&&notices.length?paneSelector.find(".latest-info-description").remove():paneSelector.append("<div class='latest-info-description'>"+I18n.resource.workflow.notice.NO_FOUND+"</div>");for(var i=0;i<notices.length;i++){var notice=notices[i];render_template(notice)}},clearNoticeContent:function(){$("#operations").html("")},updateNoticeContent:function(userid){var _this=this;userID=userid,rownumber=0,Spinner.spin($(".workflow-container")[0]),WebAPI.get("/getTransactionOperationRecordByUserId/"+userID+"/"+rownumber).done(function(result){_this.clearNoticeContent(),_this.initNoticeContent(JSON.parse(result))}).always(function(){Spinner.stop()})}},WorkflowNotice}(),workflowNoticeDetail=function(){function CurrentTime(){var now=new Date,year=now.getFullYear(),month=now.getMonth()+1,day=now.getDate(),hh=now.getHours(),mm=now.getMinutes(),ss=now.getSeconds(),clock=year+"-";return 10>month&&(clock+="0"),clock+=month+"-",10>day&&(clock+="0"),clock+=day+" ",10>hh&&(clock+="0"),clock+=hh+":",10>mm&&(clock+="0"),clock+=mm,clock+=":",10>ss&&(clock+="0"),clock+=ss}function render_template_reply(replyUser,replyContent,replyTime){WorkflowTool.getWorkflowTemplate("#wf-notice-detail-reply").done(function(template){template.find(".avatar-name").text(replyUser),template.find(".latest-info-description").html(replyContent),template.find(".reply-date").text(replyTime),$(".discussion-content").append(template)})}function workflowNoticeDetail(id,backTitle,backContent){this.id=id,this.backTitle=backTitle,this.backContent=backContent,this.idname_mapping}var colorList=["#660099","#0033FF","#33FF00","#FF3333","#FFD306","#FF00FF","#8FB7B7","#AFAF61"];return workflowNoticeDetail.prototype={show:function(){var _this=this;$.get("/static/views/workflow/notice_detail.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($(ElScreenContainer)),$("#notDetDeadline").attr("title",I18n.resource.workflow.notice.DEADLINE)})},close:function(){window.onresize=null},setBackTitle:function(title){$(".backTitle").text(title?title:I18n.resource.workflow.notice.BACK)},refreshPage:function(){Spinner.spin($(".workflow-container")[0]);var _this=this;WebAPI.get("/workflow/transaction/notice/"+AppConfig.userId+"/"+this.id).done(function(result){if(result)try{var result_obj=JSON.parse(result),detail_reply=result_obj.detail_reply,record_info=result_obj.list_record,idname_mapping=result_obj.list_idname_maping;_this.idname_mapping=idname_mapping;var notice_detail=$("#notice_detail");if(1===record_info.length){var record=record_info[0];$(".star",notice_detail).addClass(1===record.star?"icon-star":"icon-star-empty"),$(".notice",notice_detail).text(record.groupName),$(".content",notice_detail).text(record.title),$(".detail",notice_detail).text(record.detail),$(".opteration-msg",notice_detail).text(WorkflowTool.getStatusText(record.statusValue)),$(".due-date",notice_detail).text(record.due_date);var list_description=record.list_description,list_value=record.list_value;if(list_value&&0!==list_value.length){if(list_description.length==list_value.length){var arrXAxis;record.list_time.length>0&&(arrXAxis=record.list_time[0].split(","));for(var arrLegend=new Array,arrColor=new Array,arrSeriesTemp=new Array,i=0;i<list_value.length;i++)if(8>i){var item=list_value[i],color=colorList[i],itemName=list_description[i];arrLegend.push(itemName),arrColor.push(color);for(var arrDatas=new Array,strDatas=item.split(","),j=0;j<strDatas.length;++j)arrDatas.push(parseFloat(strDatas[j]).toFixed(1));arrSeriesTemp.push({name:itemName,type:"line",itemStyle:{normal:{lineStyle:{type:"solid"}}},data:arrDatas})}var option={title:{text:I18n.resource.workflow.notice.FAULT_CURVE,x:"left"},tooltip:{trigger:"axis",formatter:function(params){var strResult;if(params[0].name.length>0){strResult=params[0].name+"<br/>";for(var i=0;i<params.length;++i)strResult+=params[i].seriesName+" : "+params[i].value,i!=params.length-1&&(strResult+="<br/>")}return strResult}},legend:{data:list_description,x:"center"},toolbox:{show:!0},dataZoom:{show:!0,realtime:!0,start:0,end:100},xAxis:[{name:"",type:"category",boundaryGap:!1,axisLine:{onZero:!1},data:arrXAxis}],yAxis:[{name:"",type:"value"}],series:arrSeriesTemp},myChart=echarts.init($("#error_line",notice_detail).get(0));myChart.setOption(option),window.onresize=myChart.resize}}else $(".breakdown-row",notice_detail).hide()}else $(".notice",notice_detail).text("no title"),$(".content",notice_detail).text("no detail"),$(".opteration-msg",notice_detail).text("no statusValue"),$(".assign-time",notice_detail)[0].innerHTML="no assign time";for(var n=0,nLen=detail_reply.length;nLen>n;n++)for(var m=0;m<idname_mapping.length;++m)if(idname_mapping[m].userid==detail_reply[n].replyUserId){render_template_reply(idname_mapping[m].username,detail_reply[n].detail,detail_reply[n].replyTime);break}}catch(e){}}).always(function(){Spinner.stop()})},init:function(){this.refreshPage(),this.setBackTitle(this.backTitle);var _this=this;$("#notice_detail").on("click",".btn-reply",function(){var reply_content=$("#editor").html(),user_id=AppConfig.userId;Spinner.spin($(".workflow-container")[0]);for(var m=0;m<_this.idname_mapping.length;++m)if(_this.idname_mapping[m].userid==user_id){WebAPI.post("/workflow/transaction/insert_reply/",{ofTransactionId:_this.id,replyUserId:user_id,replyTime:CurrentTime(),detail:reply_content,replyToId:0}).done(function(result){if(!result)return!1;try{render_template_reply(_this.idname_mapping[m].username,reply_content,CurrentTime()),$("#editor").html("")}catch(e){return!1}}).always(function(){Spinner.stop()});break}}).on("click",".star",function(){Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/star/",{trans_id:_this.id,user_id:AppConfig.userId}).done(function(result){"success"===result&&$(".star").toggleClass("icon-star").toggleClass("icon-star-empty ")}).always(function(){Spinner.stop()})}).on("click","#backTo",function(){_this.backTitle?_this.backContent&&$(ElScreenContainer).empty().append(_this.backContent):(ScreenCurrent.close(),ScreenCurrent=new WorkflowNotice(this.id),ScreenCurrent.show())}),$("#editor").wysiwyg()}},workflowNoticeDetail}(),WorkflowReport=function(){function WorkflowReport(){this.projData=void 0,this.userData=void 0,this.selProj=-1,this.selUser=AppConfig.userId,this.showProj=5,this.showUser=5,this.nWeekBefore=0}function GetNthWeek(date){var onejan=new Date(date.getFullYear(),0,1);return Math.ceil(((date-onejan)/864e5+(7+onejan.getDay()-1)%7)/7)}return WorkflowReport.prototype={show:function(){var _this=this;$.get("/static/views/workflow/report.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($(ElScreenContainer))})},close:function(){},getData:function(){this.projData={},this.userData={},Spinner.spin($("#week-report")[0]);var _this=this;WebAPI.post("/workflow_get_week_report_statics",{projid:_this.selProj,userid:_this.selUser,weekbefore:_this.nWeekBefore}).done(function(result){var data=JSON.parse(result);_this.renderData(data),Spinner.stop()}).done(function(){I18n.fillArea($(ElScreenContainer))})},init:function(){var _this=this;this.getData(),$(".workflow-efficiency-table-footer").click(function(){_this.showProj*=2,_this.getData()}),$(".loading-more").click(function(){_this.showUser*=2,_this.getData()}),$(".last-week").click(function(){_this.nWeekBefore+=1,_this.getData()}),$(".next-week").click(function(){_this.nWeekBefore>0&&(_this.nWeekBefore-=1,_this.getData())})},renderData:function(data){var divFdate=$(".report-summary-row .sd-first-date"),divSdate=$(".report-summary-row .sd-second-date"),now=new Date,weekbefore_ms=7*this.nWeekBefore*864e5;now=new Date(Date.parse(now)-weekbefore_ms);var mili_sec=(7+now.getDay()-1)%7*864e5,begin=new Date(now-mili_sec);mili_sec=(7-now.getDay())%7*864e5;var end=new Date(Date.parse(now)+mili_sec);divSdate.text("zh"===I18n.type?I18n.resource.workflow.report.TITLE_TIME3.format(begin.getMonth()+1+I18n.resource.workflow.report.MONTH,begin.getDate(),end.getMonth()+1+I18n.resource.workflow.report.MONTH,end.getDate()):I18n.resource.workflow.report.TITLE_TIME3.format(DateUtil.getMonthName(begin.getMonth(),I18n.type),begin.getDate(),DateUtil.getMonthName(end.getMonth(),I18n.type),end.getDate()));var weeknow,nownow=new Date;weeknow=nownow.getFullYear()==begin.getFullYear()?begin:end;var year=weeknow.getFullYear(),weekth=GetNthWeek(weeknow).toString();divFdate.text(I18n.resource.workflow.report.TITLE_TIME2.format(year,weekth));var divPrj=$(".workflow-efficiency-table-body");divPrj.children().remove();for(var projdata=data.projdata,i=0;i<projdata.length&&i<this.showProj;i++){var item=projdata[i],done=parseInt(item[1]),undone=parseInt(item[2]),total=done+undone,percent=done/(done+undone)*100;if(percent=percent.toFixed(1),$.isArray(item[3]))var userList=item[3].join("  ");else var userList=item[3];divPrj.append($('<div class="row workflow-report-table-row"><div class="col-xs-3">'+item[0]+'</div><div class="col-xs-2">'+total+'</div> <div class="col-xs-2">'+undone+'</div><div class="col-xs-2">'+percent+'%</div> <div class="col-xs-3">'+userList+"</div></div>"))}var divMember=$(".workflow-report-memeber");divMember.children().remove();var userdata=data.user_data,transaction=data.transaction,numUser=0;for(var key in userdata){if(0!=userdata[key].done||0!=userdata[key].undone){numUser++;for(var name=userdata[key].name,done=userdata[key].done,undone=userdata[key].undone,total=undone+done,divList=$('<div class="col-md-10 col-md-offset-1" id = "week-report-member"><div class="row"><div class="description col-md-11"><div class="icon col-md-1" style="background: url(/static/images/login_feature_icons.jpg) no-repeat 0 0;"></div><div class="text">'+name+'</div><div class="text"><span i18n="workflow.report.ALL_DEAL_NUM"></span>：'+total+'</div><div class="text"><span i18n="workflow.report.FINISH_NUM"></span>：'+done+'</div><div class="text"><span i18n="workflow.report.UNFINISH"></span>：'+undone+"</div></div></div>"),doneList=userdata[key].donelist,i=0;i<doneList.length;i++){var item=transaction[doneList[i]];divList.append($('<div class="row item-row"><div class="col-md-12 content"><div class="col-md-3 name" title="'+item.title+'">'+item.title+'</div><div class="col-md-5 text item-text-color" title="'+item.detail+'">'+item.detail+'</div><div class="col-md-2 text item-text-color" title="resolved date">'+(item.complete_time?new Date(item.complete_time).format("yyyy-MM-dd").toLocaleString(I18n.type?I18n.type:"zh"):"")+'</div><div class="col-md-2 text item-text-color"><span i18n="workflow.report.FINISH"></span></div></div></div>'))}for(var undoneList=userdata[key].undonelist,i=0;i<undoneList.length;i++){var item=transaction[undoneList[i]];divList.append($('<div class="row item-row"><div class="col-md-12 content"><div class="col-md-3 name" title="'+item.title+'">'+item.title+'</div><div class="col-md-5 text item-text-color" title="'+item.detail+'">'+item.detail+'</div><div class="col-md-2 text item-text-color" title="deadline">'+(item.duedate?new Date(item.duedate).format("yyyy-MM-dd").toLocaleString(I18n.type?I18n.type:"zh"):"")+'</div><div class="col-md-2 text item-text-color"><span i18n="workflow.report.UNFINISH"></span></div></div></div>'))}divMember.append(divList)}if(numUser>=this.showUser)break}},updateSelUser:function(memberid){memberid||(memberid=-1),this.selUser=memberid,this.getData()},updateSelPrj:function(projid){projid||(projid=-1),this.selProj=projid,this.getData()}},WorkflowReport}(),WorkflowTeam=function(){function _GroupArray(prop,array){for(var group={},n=0,nlen=array.length;nlen>n;n++){var item=array[n],groupItem=group[item[prop]];groupItem?groupItem.push(item):group[item[prop]]=[item]}return group}function GourpResult(result){var ret=[],groupedByProjectId=_GroupArray("projectID",result);for(var groupId in groupedByProjectId){var project={},projects=groupedByProjectId[groupId];project.projectID=groupId,project.projectNm=projects[0]&&projects[0].groupNm,project.isAdmin=projects[0].isAdmin,project.roles=[];var groupedByRoleId=_GroupArray("roleID",projects);for(var roleId in groupedByRoleId){var member=groupedByRoleId[roleId],roleGroup={};roleGroup.roleID=roleId,roleGroup.roleNm=member[0]&&member[0].roleNm,roleGroup.members=member,project.roles.push(roleGroup)}ret.push(project)}return ret}function WorkflowTeam(){this.html=null,this.memberTemplate=null}return WorkflowTeam.prototype={show:function(){var _this=this;$.get("/static/views/workflow/team.html").done(function(resultHtml){_this.html=resultHtml,$(ElScreenContainer).html(_this.html),_this.init()})},loadPage:function(groupId){var _this=this;return $("#workflow-team").find(".dpt-row").not(".workflow-template").remove(),Spinner.spin($(".workflow-container")[0]),"undefined"==typeof groupId&&(groupId=-1),$.get("/workflow/team/"+AppConfig.userId+"/"+groupId).done(function(result){if(result){try{var result_obj=JSON.parse(result)}catch(e){console.error(e)}var groups=GourpResult(result_obj),_template=$(_this.html).find(".workflow-template").clone().removeClass("workflow-template"),_dpt_content_row=_template.find(".dpt-content-row");_this.memberTemplate=_dpt_content_row.find(".member"),_template.find(".memeber-container").children().remove(),_template.find(".dpt-content-row").remove();for(var m=0,mlen=groups.length;mlen>m;m++){var group=groups[m],template=_template.clone(),dpt_container=template.find(".dpt-container"),isAdmin=group.isAdmin;template.find(".dpt-nm").text(group.projectNm);for(var n=0,nlen=group.roles.length;nlen>n;n++){var role=group.roles[n],dpt_content_row=_dpt_content_row.clone();dpt_content_row.find(".role-nm").text(role.roleNm);for(var memeber_container=dpt_content_row.find(".memeber-container"),j=0,jlen=role.members.length;jlen>j;j++){var member=role.members[j];if(member.userID){var member_div=_this.memberTemplate.clone();member_div.find(".team-avatar-name").text(member.userFullNm),memeber_container.append(member_div),member_div.data("member",member)}}if(isAdmin){var mem_add=$('<div class="col-md-3 add-member"><img style="cursor:pointer;" src="./static/images/add_new_project.png"></img></div>');mem_add.data("roleID",role.roleID).data("projectID",group.projectID),memeber_container.append(mem_add)}dpt_container.append(dpt_content_row)}$("#workflow-team").append(template)}Spinner.stop()}})},close:function(){},init:function(){var _this=this;$("#team-assign-dialog").on("show.bs.modal",function(e){var dialog=$(this),members_section=dialog.find(".members").children().remove().end(),roleID=dialog.data("roleID"),projectID=dialog.data("projectID");Spinner.spin($("#team-assign-dialog")[0]),WebAPI.post("/workflow/team/getmember",{roleID:roleID,projectID:projectID}).done(function(result){var result=JSON.parse(result);0===result.length&&members_section.append("<h4>"+I18n.resource.workflow.team.TIP2+"</h4>"),members_section.append(beopTmpl("tmpl_selectMember",result));for(var resultL=result.length,media=$(".modal-content").find(".media"),i=0;resultL>i;i++){var oMedia=media.eq(i),oResult=result[i];oMedia.data("member",oResult)}Spinner.stop()})}).on("click",".media",function(){{var media=$(this);media.data("member")}media.toggleClass("member-selected")}).on("click",".save",function(){var selectedMembers={},dialog=$("#team-assign-dialog"),roleID=dialog.data("roleID"),projectID=dialog.data("projectID");return dialog.find(".member-selected").map(function(index,item){selectedMembers[$(item).data("member").userID]=$(item).data("member")}),0===Object.keys(selectedMembers).length?!1:(Spinner.spin($("#team-assign-dialog")[0]),void WebAPI.post("/workflow/team/addmember",{roleID:roleID,projectID:projectID,users:Object.keys(selectedMembers).join(",")}).done(function(result){if("success"===result){dialog.modal("hide");var memeber_container=dialog.data("container");for(var id in selectedMembers){var member=selectedMembers[id],member_div=_this.memberTemplate.clone();member_div.find(".team-avatar-name").text(member.username),memeber_container.find(".add-member").before(member_div),member_div.data("member",member)}}}))}),$("#workflow-team").on("mouseenter",".member",function(){var $this=$(this),member=$this.data("member");member.isAdmin&&$this.find(".operator").removeClass("hidden")}).on("mouseleave",".member",function(){$(this).find(".operator").addClass("hidden")}).on("click",".btn-del-member",function(){I18n.fillArea($("span"));var btn=$(this),member=btn.closest(".member").data("member");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/team/delete",{userID:member.userID,roleID:member.roleID,projectID:member.projectID}).done(function(result){if("success"===result)btn.closest(".member").remove();else if(result.indexOf("the last")){var alert=new Alert(btn.closest(".dpt-container"),"danger",I18n.resource.workflow.team.TIP1);alert.setStyle({position:"absolute",top:"50%",left:"30%",width:"40%"}).show(),setTimeout(function(){alert.close()},2e3)}}).always(function(){Spinner.stop()})}).on("click",".add-member img",function(){var btn=$(this).closest(".add-member"),roleID=btn.data("roleID"),projectID=btn.data("projectID");$("#team-assign-dialog").data("roleID",roleID).data("projectID",projectID).data("container",btn.closest(".memeber-container")).modal("show"),I18n.fillArea($("#workflow-team"))}),this.loadPage().done(function(){I18n.fillArea($("#workflow-team"))})}},WorkflowTeam}(),WorkflowInsert=function(){function WorkflowInsert(){this.$container={}}return WorkflowInsert.prototype={show:function(){var _this=this;$.get("/static/views/workflow/insert.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.$container=$("#workflow-insert"),_this.init()})},close:function(){},init:function(){$("#txtLogDateStart").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,startDate:new Date}),this.loadData(),this.attachEvents()},attachEvents:function(){var _this=this;this.$container.on("click","#workflow-insert-submit",function(){_this.submitCheck()&&($("#insert-errorInfo").hide(),WebAPI.post("/admin/updateUsersSetting",{selectGroup:$("#selectGroup").val(),selectOperator:$("#selectOperator").val(),Severity:$("#Severity").val(),txtLogDateStart:$("#txtLogDateStart").val(),title:$("#workflow-insert-title").val(),detail:$("#workflow-insert-detail").val()}).done(function(result){result.success&&getChart()}))}),this.$container.on("click","#workflow-insert-cancel",function(){})},submitCheck:function(){return""===$.trim($("#txtLogDateStart").val())?($("#insert-errorInfo").text("截止时间不能为空"),!1):""===$.trim($("#workflow-insert-title").val())?($("#insert-errorInfo").text("标题不能为空"),!1):""===$.trim($("#workflow-insert-detail").val())?($("#insert-errorInfo").text("详细信息不能为空"),!1):!0},loadData:function(){WebAPI.post("/admin/updateUsersSetting",{}).done(function(result){result.success&&($("#selectGroup").val(),$("#selectOperator").val(),$("#Severity").val(),$("#txtLogDateStart").val(),$("#workflow-insert-title").val(),$("#workflow-insert-detail").val())})},getChart:function(){}},WorkflowInsert}(),workflowTransaction=function(){function workflowTransaction(group){this.group=group}return workflowTransaction.prototype={show:function(){var _this=this;$.get("/static/views/workflow/transaction.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),$("#tipFaultTitle").attr("placeholder",I18n.resource.workflow.main.FAULT_TITLE),$("#tipFaultInfo").attr("placeholder",I18n.resource.workflow.main.FAULT_INFO),$("#iconSum").attr("title",I18n.resource.workflow.main.SUM),$("#iconFinish").attr("title",I18n.resource.workflow.main.FINISHED),$("#iconDelay").attr("title",I18n.resource.workflow.main.DELAY)})},refreshPage:function(){Spinner.spin($(".workflow-container")[0]),$.get("/workflow/group/"+AppConfig.userId+"/"+this.group.id).done(function(result){try{var result_obj=JSON.parse(result)}catch(e){return!1}var $workflow_transaction=$("#workflow-transaction").find(".mine-avatar-name").text(result_obj.name).end().find(".mine-avatar-desc").text(result_obj.description).end().find(".totalCount").text(result_obj.totalCount).end().find(".delayedCount").text(result_obj.delayedCount).end().find(".finishedCount").text(result_obj.finishedCount).end();if(result_obj.pic){var image=WorkflowTool.pic_path+result_obj.pic;$workflow_transaction.find(".top-section .media-left").empty().append('<img class="wf-project-icon" src="'+image+'">')}else $workflow_transaction.find(".top-section .media-left").empty().append('<div class="avatar-icon" style="background: url(/static/images/login_feature_icons.jpg) no-repeat -50px 0;"></div>');var trans=result_obj.transactions,$task_items=$(".task-items").empty(),i18=I18n.resource.workflow.urgencyLevel,i18IcArr=[i18.GENERAL,i18.SERIOUS,i18.URGENT];WorkflowTool.getWorkflowTemplate("#wf-transaction-task").done(function(temp){for(var n=0,nlen=trans.length;nlen>n;n++){var inner_temp=temp.clone(),item=trans[n];inner_temp.attr("task-id",item.id),inner_temp.find(".task-title").text(item.title).attr("title",item.title),inner_temp.find(".date").text(new Date(item.dueDate).format("yyyy-MM-dd")).attr("title","deadline"),inner_temp.find(".member").text(item.username?item.username:""),inner_temp.find(".timer").children("span").removeClass().addClass("glyphicon ic"+item.critical).attr("title",i18IcArr[item.critical]),inner_temp.find(".status").text(WorkflowTool.getStatusText(item.statusId)),inner_temp.data("task",item),$task_items.append(inner_temp)}}),result_obj.isAdmin&&0===$(".project-operator").size()&&WorkflowTool.getWorkflowTemplate("#wf-transaction-group-operator").done(function(group_operator_template){$(".nav-content").append(group_operator_template)})}).done(function(){I18n.fillArea($(ElScreenContainer))}).always(function(){Spinner.stop()})},close:function(){},init:function(){var that=this;this.refreshPage();var projectMembersPromise=$.get("/workflow/projectmember/"+this.group.id);$("#workflow-transaction").on("click",".add-btn",function(){var $this=$(this);projectMembersPromise.done(function(result){try{var result_obj=JSON.parse(result);if(!result_obj||0===result_obj.length){$(".success-alert").empty();var alert=new Alert(".success-alert","danger",I18n.resource.workflow.main.TIP1).show();return setTimeout(function(){alert.close()},2e3),!1}}catch(e){return!1}$this.hide().closest(".add-row").find(".add-section").show()})}).on("click",".edit-btn-cancel",function(){var add_row=$(this).closest(".add-row");add_row.find(".trans-edit-textarea").val("").end().find(".add-section").hide().end().find(".add-btn").show()}).on("show.bs.dropdown","#project-user",function(){var _this=this;projectMembersPromise.done(function(result){try{var result_obj=JSON.parse(result)}catch(e){return!1}var menu=$(_this).find(".dropdown-menu").empty();if(0===result_obj.length)return menu.append($('<li class="empty-member">'+I18n.resource.workflow.main.TIP2+"</li>")),!1;for(var n=0,nlen=result_obj.length;nlen>n;n++){var member=result_obj[n];menu.append($('<li class="member-item">'+member.username+"</li>").data("member",member))}})}).on("click","#project-critical ul li",function(){var $o=$(this),text=$o.text(),val=$o.attr("objval"),$obj=$("#project-critical").find(".selected-critical span");$obj.text(text),$("#project-critical").attr("objval",val)}).on("click",".member-item",function(){var $this=$(this),member=$this.data("member");$this.closest(".project-members").find(".selected-member").text(member.username).data("member",member)}).on("click",".complete-time",function(){var $this=$(this);$this.find(".time-picker").datetimepicker({minView:"month",autoclose:!0,todayBtn:!0,format:"yyyy-mm-dd",startDate:new Date})}).on("changeDate",".time-picker",function(e){var $this=$(this),date=$this.data("date");$this.closest(".complete-time").find(".selected-date").text(date).data("date",date),$this.dropdown("toggle")}).on("click",".add-section .edit-btn-save",function(){var $this=$(this),add_section=$this.closest(".add-section"),title=add_section.find(".trans-edit-textarea.trans-title").val();if(!title){$(".alert").empty();var alert=new Alert(".alert","danger",I18n.resource.workflow.main.NAME_NOT_NULL).show();return setTimeout(function(){alert.close()},2e3),!1}var detail=add_section.find(".trans-edit-textarea.trans-detail").val(),complete_time=add_section.find(".selected-date").data("date"),selected_member=add_section.find(".selected-member").data("member");if(!complete_time){$(".alert").empty();var alert=new Alert(".alert","danger",I18n.resource.workflow.main.FINISH_TIME_NOT_NULL).show();return setTimeout(function(){alert.close()},2e3),!1}if(!selected_member||void 0===selected_member.userId){$(".alert").empty();var alert=new Alert(".alert","danger",I18n.resource.workflow.main.PEOPLE_NOT_NULL).show();return setTimeout(function(){alert.close()},2e3),!1}var critical=$("#project-critical").attr("objval");if(""==critical){$(".alert").empty();var alert=new Alert(".alert","danger",I18n.resource.workflow.urgencyLevel.URGENCY_LEVEL_REQUIRED).show();return setTimeout(function(){alert.close()},2e3),!1}var data={userId:AppConfig.userId,dueDate:complete_time,title:title,detail:detail,groupId:that.group.id,executorId:selected_member.userId,critical:critical};Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/add/",data).done(function(result){$this.closest(".add-row").find(".selected-date").text(I18n.resource.workflow.main.FINISH_TIME).data("date","").end().find(".selected-member").text(I18n.resource.workflow.main.PEOPLE).data("member","").end().find(".trans-edit-textarea").val("").end().find(".add-section").hide().end().find(".add-btn").show(),$(".alert").empty();var alert=new Alert(".success-alert","success",I18n.resource.workflow.main.ADD_SUCCESS).show();setTimeout(function(){alert.close()},1e3),that.refreshPage(),$("#project-critical").attr("objval",""),$("#project-critical .selected-critical>span").text(I18n.resource.workflow.urgencyLevel.URGENCY_LEVEL)}).always(function(){Spinner.stop()})}).on("click","#backToMain",function(){ScreenCurrent.close(),ScreenCurrent=new WorkflowMain,ScreenCurrent.show()}).on("click",".task-title",function(){var id=$(this).closest(".task-item").data("task").id;new workflowNoticeDetail(id,I18n.resource.workflow.main.CREATE_TASK,$(ElScreenContainer).children().detach()).show()}).on("click","#del-project",function(){$(this).hide(),$("#workflow-transaction .delete-dialog").show()}).on("click","#del-project-cancel",function(){$(this).closest(".delete-dialog").hide(),$("#del-project").show()}).on("click","#del-project-OK",function(){Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/group/delete/",{id:that.group.id}).done(function(){ScreenCurrent.close(),ScreenCurrent=new WorkflowMain,ScreenCurrent.show()}).always(function(){Spinner.stop()})}).on("click","#edit-project",function(){var top_section=$(".top-section");if(top_section.find(".media").hasClass("editing"))return!1;top_section.find(".media").addClass("editing");var old_media_body=top_section.find(".media-body").detach(),new_media_body=$('<div class="media-body"></div>');new_media_body.append('<h3 class="media-heading"><textarea class="gd-edit-textarea title" maxlength="255">'+that.group.name+"</textarea></h3>").append('<textarea class="gd-edit-textarea desc" maxlength="255">'+that.group.description+"</textarea>").append('<button type="button" class="pull-right btn btn-success edit-btn edit-btn-save">'+I18n.resource.workflow.main.SAVE+"</button>").append('<button type="button" class="pull-right btn btn-default edit-btn edit-btn-cancel">'+I18n.resource.workflow.main.CANCEL+"</button>"),top_section.find(".media").append(new_media_body),new_media_body.find(".edit-btn-cancel").click(function(){top_section.find(".media").find(".media-body").remove().end().append(old_media_body).removeClass("editing")}),new_media_body.find(".edit-btn-save").click(function(){var media=$(this).closest(".media"),new_name=media.find(".title").val().trim(),new_desc=media.find(".desc").val().trim();if(!new_name){var error_dialog=$(".error-dialog").find("h4").text(I18n.resource.workflow.main.NAME_NOT_NULL).end().show();return setTimeout(function(){error_dialog.find("h4").text("").end().hide()},2e3),!1}return new_name===that.group.name&&new_desc===that.group.description?(media.find(".media-body").remove().end().append(old_media_body).removeClass("editing"),!1):(Spinner.spin($(".workflow-container")[0]),void WebAPI.post("/workflow/group/edit/",{id:that.group.id,name:new_name,desc:new_desc}).done(function(){that.group.name=new_name,that.group.description=new_desc,old_media_body.find(".media-heading").text(new_name).end().find(".mine-avatar-desc").text(new_desc),media.find(".media-body").remove().end().append(old_media_body),media.removeClass("editing")}).always(function(){Spinner.stop()}))})})}},workflowTransaction}();