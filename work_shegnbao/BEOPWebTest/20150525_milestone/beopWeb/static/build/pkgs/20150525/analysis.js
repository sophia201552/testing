var SharpViewScreen=function($,window,undefined){function SharpViewScreen(sliders,store){_this=this,this.options=SharpViewScreen.DEFAULTS,this.cur=null,this.total=sliders.length,this.sliderList=sliders,this.slidersStatus={},this.layoutHandler=null,this.store=store,this.factoryIoC=new FactoryIoC("analysis"),this.curModal=null,this.datasource=new DataSource(this),this.dataSourceConflict=AppConfig.datasource,AppConfig.datasource=this.datasource,this.saveModalJudge=$.Deferred(),this.$stage=null,this.$sliders=null}function Layout($stage,$sliders){this.$stage=$stage,this.$sliders=$sliders,this.curPos=null,this.total=null}function TileLayout($stage,$sliders){Layout.apply(this,arguments),this.name="Tile"}function LinearLayout($stage,$sliders,options){Layout.apply(this,arguments),this.options=$.extend({},LinearLayout.DEFAULTS,options),this.name="linear"}var _this=null,showMode={TILE:"Tile",LINEAR:"Linear"},layoutClasses={Tile:TileLayout,Linear:LinearLayout};SharpViewScreen.prototype={constructor:SharpViewScreen,show:function(){$.get("/static/views/observer/sharpViewScreen.html",function(html){$('<div class="sharpview-wrap sharpview" id="sharpViewWrap">').appendTo("body").html(html),_this.init()})},init:function(){var arrHtml=[];this.$stage=$("#sharpViewStage");for(var i=0,len=this.sliderList.length;len>i;i++)arrHtml.push(this.options.itemTmpl.format(i));this.$stage.html(arrHtml.join("")),this.$sliders=this.$stage.children("*"),Parallex.init(),this.layout(showMode.LINEAR)},layout:function(mode){var _this=this,options={};switch(mode=mode||showMode.TILE,this.layoutHandler&&this.layoutHandler.destroy(),mode){case showMode.TILE:break;case showMode.LINEAR:options.onFlipStart=function(e){var pos=e.pos;pos!==_this.cur&&(pos>_this.cur?Parallex.flowLeft():Parallex.flowRight())},options.onFlipEnd=function(e){var pos=e.pos;_this.cur=pos,_this.renderSlider()}}this.layoutHandler=new layoutClasses[mode](this.$stage,this.$sliders,options),this.layoutHandler.layout()},renderSlider:function(container){this.renderModal(this.cur),this.renderModal(Math.min(this.total-1,Math.max(this.cur-1,0))),this.renderModal(Math.min(this.total-1,Math.max(this.cur+1,0)))},renderModal:function(index){var container=this.$sliders.get(index),modalId=this.sliderList[index].id;if(this.curModal=this.sliderList[index].option,"loaded"!==this.slidersStatus[modalId]){var modalClass=this.factoryIoC.getModel(this.curModal.type);modalClass?(this.slidersStatus[modalId]="loaded",new modalClass(container,null,this).show()):this.alertNoData()}},updateModal:function(){},showConfigMode:function(){},setModalOption:function(){},spinnerStop:function(){},saveModal:function(){},alertNoData:function(){},destroy:function(){$("#sharpViewWrap").remove(),this.layoutHandler.destroy(),AppConfig.datasource=this.dataSourceConflict}},SharpViewScreen.DEFAULTS={itemTmpl:'<div data-index="{0}"></div>'},Layout.prototype={constructor:Layout,layout:function(){this.total=this.$sliders.length,this._layout.apply(this,arguments)},destroy:function(){this._destroy()}},TileLayout.prototype=Object.create(Layout.prototype),TileLayout.prototype.constructor=TileLayout,TileLayout.prototype._layout=function(){for(var per,i=0;i<this.total;i++)per=105*(i-1),this.$sliders.eq(i).css({transform:"translateZ(-2500px) translate("+per+"%, 0%)"})},LinearLayout.prototype=Object.create(Layout.prototype),LinearLayout.prototype.constructor=LinearLayout,LinearLayout.prototype._layout=function(startPos){this.$stage.addClass(this.options.animateCls),this.attachEvents(),this.to(startPos||0)},LinearLayout.prototype.to=function(pos){var _this=this,pos=pos===undefined?0:Math.min(Math.max(pos,0),this.total-1);return pos===this.curPos?void this.doBoundAnimation():(this.curPos=pos,"function"==typeof _this.options.onFlipStart&&_this.options.onFlipStart({pos:pos}),this.$sliders.each(function(i){pos>i&&$(this).removeClass().addClass("past"),i>pos&&$(this).removeClass().addClass("future")}),window.setTimeout(function(pos){return function(){_this.$sliders.eq(pos).removeClass().addClass("present")}}(pos),50),void this.$sliders.off().on("transitionend",function(e){e=e.originalEvent,"present"===e.target.className&&"transform"===e.propertyName&&"function"==typeof _this.options.onFlipEnd&&_this.options.onFlipEnd({pos:pos})}))},LinearLayout.prototype.prev=function(){this.to(this.curPos-1)},LinearLayout.prototype.next=function(){this.to(this.curPos+1)},LinearLayout.prototype.doBoundAnimation=function(){$slider=this.$sliders.eq(this.curPos),$slider.addClass(0===this.curPos?"bound-left":"bound-right")},LinearLayout.prototype.attachEvents=function(){var _this=this;$(window).on("keydown.sharpview",function(e){switch(e.keyCode){case 37:_this.prev();break;case 38:break;case 39:_this.next();break;case 40:}}),$(window).on("keyup.sharpview",function(e){switch(e.keyCode){case 37:_this.$sliders.eq(_this.curPos).removeClass("bound-left");break;case 38:break;case 39:_this.$sliders.eq(_this.curPos).removeClass("bound-right");break;case 40:}})},LinearLayout.prototype.detachEvents=function(){$(window).off("keydown.sharpview"),$(window).off("keyup.sharpview")},LinearLayout.prototype._destroy=function(){this.detachEvents()},LinearLayout.DEFAULTS={animateCls:"linear-1"};var Parallex={step:1e3,rateBg1:1,rateBg2:.5,rateBg3:.2,direction:1,flowLeft:function(){this.direction=-1,this.flow()},flowRight:function(){this.direction=1,this.flow()},flow:function(){var posBg1=parseFloat(this.$bg1.css("background-position-x")),posBg2=parseFloat(this.$bg2.css("background-position-x")),posBg3=parseFloat(this.$bg3.css("background-position-x"));this.changeTransition(".5s","cubic-bezier(0.26,.86,.44,.985)"),this.direction>0?(this.$bg1.css("background-position-x",posBg1+this.step*this.rateBg1+"px"),this.$bg2.css("background-position-x",posBg2+this.step*this.rateBg2+"px"),this.$bg3.css("background-position-x",posBg3+this.step*this.rateBg3+"px")):(this.$bg1.css("background-position-x",posBg1-this.step*this.rateBg1+"px"),this.$bg2.css("background-position-x",posBg2-this.step*this.rateBg2+"px"),this.$bg3.css("background-position-x",posBg3-this.step*this.rateBg3+"px"))},changeTransition:function(duration,TimingFn){this.$bg1.css({"transition-duration":duration,"transition-timing-function":TimingFn}),this.$bg2.css({"transition-duration":duration,"transition-timing-function":TimingFn}),this.$bg3.css({"transition-duration":duration,"transition-timing-function":TimingFn})},init:function(){var _this=this;this.$bg1=$("#bg1"),this.$bg2=$("#bg2"),this.$bg3=$("#bg3"),this.$bg1.off().on("transitionend",function(e){var distance=1500,posBg1=parseFloat(_this.$bg1.css("background-position-x")),posBg2=parseFloat(_this.$bg2.css("background-position-x")),posBg3=parseFloat(_this.$bg3.css("background-position-x"));e=e.originalEvent,_this.changeTransition("30s","linear"),"background-position-x"===e.propertyName&&(_this.direction>0?(_this.$bg1.css("background-position-x",posBg1+distance*_this.rateBg1+"px"),_this.$bg2.css("background-position-x",posBg2+distance*_this.rateBg2+"px"),_this.$bg3.css("background-position-x",posBg3+distance*_this.rateBg3+"px")):(_this.$bg1.css("background-position-x",posBg1-distance*_this.rateBg1+"px"),_this.$bg2.css("background-position-x",posBg2-distance*_this.rateBg2+"px"),_this.$bg3.css("background-position-x",posBg3-distance*_this.rateBg3+"px")))})}};return SharpViewScreen}(jQuery,window),AnlsWorkspace=function(){function AnlsWorkspace(screen){this.divWSPane=document.getElementById("divWSPane"),this.screen=screen,this.sharpViewScreen=null,this.workspace=this.screen.store.workspaces,_this=this}var _this,util={checkbox:{selectAll:function($eles){$eles.each(function(){var $this=$(this);$this.hasClass("checked")||$this.addClass("checked")})},selectInverse:function($eles){$eles.each(function(){var $this=$(this);$this[$this.hasClass("checked")?"removeClass":"addClass"]("checked")})},unSelectAll:function($eles){$eles.each(function(i){var $this=$(this);$this.hasClass("checked")&&$this.removeClass("checked")})},isAllChecked:function($eles){return $eles.not(".checked").length<=0}}},$wsPane=$("#wsPane");return AnlsWorkspace.prototype={show:function(){this.init()},close:function(){},init:function(){if($wsPane.html(""),_this.setToolsBtnStatus(),this.screen.store.workspaces&&this.screen.store.workspaces.length>0){var $ddlWorkspace=$(".dropdownWS"),$ddlWorkspaceUl=$ddlWorkspace.next("ul");for(var i in this.screen.store.workspaces){var temp=this.screen.store.workspaces[i],$li=$('<li role="presentation">'),$a=$('<a role="menuitem" tabindex="-1">').attr("project-id",temp.id).click(function(){_this.selectWorkspace(this)}).text(temp.name);$li.append($a),$ddlWorkspaceUl.append($li);var $divPageCt=$('<div class="divPageCt">').attr("id","divPageCt_"+temp.id).attr("ws-id",temp.id);if(0==i?($a.attr("selected","selected"),$ddlWorkspace.html($a.text()+'<span class="caret"></span>'),$divPageCt.show()):$divPageCt.hide(),temp.modalList&&temp.modalList.length>0)for(var j in temp.modalList){var tempData=temp.modalList[j],$divPage=$('<div class="divPage slider-item">').attr("id",tempData.id).attr("modal-id",tempData.id);$divPage.css(tempData.imagebin?{"background-image":"url("+tempData.imagebin+")"}:{"background-image":"url("+localStorage.getItem("img_"+tempData.id)+")"});var $input=_this.modalNameInput(),$modalNameSp=$('<div class="modalNameSp"></div>').text(tempData.name).click(function(e){var text=$(this).hide().text();$(this).next().text(text).show().focus(),e.stopPropagation()});$input.is(":hidden")?($modalNameSp.show(),$input.hide()):$modalNameSp.hide();var $divPageTitle=$('<h4 class="divPageTitle">').append($modalNameSp).append($input),$btnRemove=$('<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove" aria-hidden="true"></span>').click(function(e){_this.deleteDivPage(this),_this.synchronizeToSliderMatrix($wsPane),e.stopPropagation()}),$effectLayer=$('<div class="effect">'),$cbSlider=$('<span class="slider-cb-wrap"><i class="slider-cb"></i></span>').click(function(e){$(this).parents(".slider-item").toggleClass("checked"),e.stopPropagation()});$divPage.append($divPageTitle).append($btnRemove).append($effectLayer).append($cbSlider),$divPageCt.append($divPage),$divPage.click(function(e){var modalId,isSelected=$(this).hasClass("selected");isSelected||(_this.screen.paneCenter.spinnerStop&&_this.screen.paneCenter.spinnerStop(),$(".divPage").removeClass("selected"),$(this).addClass("selected"),modalId=$(this).attr("modal-id"),modalId?_this.screen.renderModalById(modalId):_this.screen.refreshPaneCenter(new AnalysisTemplate(_this.screen)),_this.setToolsBtnStatus($(this)))}),$divPageCt.append($divPage)}$(this.divWSPane).append($divPageCt)}}else 0==$(".dropdownWS").next("ul").children("li").length&&_this.workspaceAdd(0);_this.setSliderMarginTop(),$("#btnPageAdd").click(_this.pageAdd),$("#btnPageUp").click(_this.pageUp),$("#btnPageDown").click(_this.pageDown),$("#btnPageAll").click(function(){var pointPanel=$("#addPointPanelContain");pointPanel.length>0&&pointPanel.remove(),_this.viewSliderMatrix(),_this.toggleDataSource(!1)}),$("#btnWSAdd").click(_this.workspaceAdd),$("#btnWSDelete").click(_this.deleteWorkspace),$("#btnWSRename").click(_this.renameWorkspace),I18n.fillAreaAttribute($("#workspacePane"),"title"),I18n.fillAreaAttribute($("#divWSPane"),"placeholder")},setSliderMarginTop:function(){$(".modalNameSp").each(function(){this.style.marginTop=-this.offsetHeight/2+10+"px",this.style.marginLeft=-this.offsetWidth/2+"px"})},pageAdd:function(isExternalCall){var WSId=_this.getWorkspaceId();$("#divPageCt_"+WSId).find("#divPageTemp").length>0?alert("There has been a new page."):(_this.addSliderDom(isExternalCall),1==isExternalCall||_this.screen.refreshPaneCenter(new AnalysisTemplate(_this.screen)))},pageUp:function(){var $thisPage=$(".divPage.selected");$($thisPage).insertBefore($thisPage.prev(".divPage")),_this.saveLayout($thisPage),_this.setToolsBtnStatus($thisPage)},pageDown:function(){var $thisPage=$(".divPage.selected");$($thisPage).insertAfter($thisPage.next(".divPage")),_this.saveLayout($thisPage),_this.setToolsBtnStatus($thisPage)},saveLayout:function($thisPage){for(var $WS=$thisPage.closest(".divPageCt"),divPageList=$WS.children(".divPage"),modalList=[],i=0;i<divPageList.length;i++)modalList.push($(divPageList[i]).attr("modal-id"));WebAPI.post("/analysis/workspace/saveLayout/"+AppConfig.userId,{workspaceId:$WS.attr("ws-id"),modalList:modalList}).done(function(){}).error(function(){alert(I18n.resource.observer.analysis.SORT_FAILED)})},addSliderDom:function(isExternalCall){var wsPane=document.getElementById("wsPane"),$divPageCt=$(".divPageCt").not(":hidden");$(".divPage").removeClass("selected");var $divPage=$('<div class="divPage selected slider-item" style="background-image:url(\'/static/images/analysis/blank.jpg\')">').attr("id","divPageTemp"),$divPageTitle=$('<h4 class="divPageTitle">'),$input=_this.modalNameInput(),$modalNameSp=$('<div class="modalNameSp">New </div>').hide().click(function(e){var text=$(this).hide().text();$(this).next().text(text).show().focus(),e.stopPropagation()});$divPageTitle.append($modalNameSp).append($input);var $btnRemove=$('<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove" aria-hidden="true"></span>').click(function(){_this.deleteDivPage(this)}),$effectLayer=$('<div class="effect">'),$cbSlider=$('<span class="slider-cb-wrap"><i class="slider-cb"></i></span>').click(function(e){$(this).parents(".slider-item").toggleClass("checked"),e.stopPropagation()});$divPage.append($divPageTitle).append($btnRemove).append($effectLayer).append($cbSlider),$divPageCt.append($divPage),$divPage.click(function(e){var modalId,isSelected=$(this).hasClass("selected");isSelected||($(".divPage").removeClass("selected"),$(this).addClass("selected"),_this.setToolsBtnStatus($(this)),modalId=e.currentTarget.id,"divPageTemp"==modalId?1==isExternalCall||_this.screen.refreshPaneCenter(new AnalysisTemplate(_this.screen)):_this.screen.renderModalById(modalId))}),$input.focus(),I18n.fillAreaAttribute($("#divWSPane"),"placeholder"),_this.synchronizeToSliderMatrix($(wsPane))},deleteDivPage:function(obj){if(confirm(I18n.resource.analysis.workspace.CONFIRM_PAGE_DELETE)){var $thisDivPage=$(obj).closest(".divPage"),WSId=$(obj).closest(".divPageCt").attr("ws-id");WSId||(WSId=$(".divPageCt").not(":hidden").attr("ws-id"));var modalId=$(obj).closest(".divPage").attr("modal-id");modalId?(WebAPI.get("/analysis/modal/remove/"+AppConfig.userId+"/"+WSId+"/"+modalId).done(function(result){var thisClosest=$(obj).closest("#divWSPane").length>0?1:$(obj).closest("#wsPane").length>0?2:0;$thisDivPage.remove(),_this.screen.paneCenter.spinnerStop&&_this.screen.paneCenter.spinnerStop();var $wsPane=$("#anlsWSPaneContain");0==$wsPane.length||$wsPane.is(":hidden")?new AnalysisTemplate(_this.screen).show():_this.synchronize(thisClosest)}).always(function(e){Spinner.stop()}),localStorage.removeItem("img_"+modalId)):$('[id="divPageTemp"]').remove()}},initDrag:function(WSId){function domdrugstart(e){var target=getReal(e.srcElement,"className","divPage");target.classList.contains("divPage")&&(target.style.opacity="0.5",dragEl=this,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/html",this.innerHTML))}function domdrugenter(e){var target=getReal(e.srcElement,"className","divPage");target.classList.contains("divPage")&&target.classList.add("dragHover")}function domdrugover(e){return e.preventDefault&&e.preventDefault(),e.dataTransfer.dropEffect="move",!1}function domdrugleave(e){e.target.classList.remove("dragHover")}function domdrop(e){e.stopPropagation&&e.stopPropagation();var modalList=[];if(dragEl!=this){var newIndex=parseInt(this.index),locIndex=parseInt(dragEl.index),node=column.children[locIndex];column.insertBefore(node,column.children[newIndex]);for(var newColumns=document.querySelectorAll("#"+dragTarget+" .divPage"),i=0;i<newColumns.length;i++)newColumns[i].index=i,modalList.push(newColumns[i].id);WebAPI.post("/analysis/workspace/saveLayout/"+AppConfig.userId,{workspaceId:_this.getWorkspaceId(),modalList:modalList}).done(function(){for(var wsId=_this.getWorkspaceId(),newWsModalList=[],i=0,len=_this.screen.store.workspaces.length;len>i;i++)if(_this.screen.store.workspaces[i].id===wsId){for(var wsModalList=_this.screen.store.workspaces[i].modalList,j=0;j<modalList.length;j++)for(var k=0;k<wsModalList.length;k++)modalList[j]==wsModalList[k].id&&newWsModalList.push(wsModalList[k]);_this.screen.store.workspaces[i].modalList=newWsModalList}})}return!1}function domdrapend(e){[].forEach.call(columns,function(column){column.classList.remove("dragHover"),column.style.opacity="1"}),_this.synchronizeToSliderList()}function getReal(el,type,value){for(var temp=el;null!=temp&&"BODY"!=temp.tagName;){if(eval("temp."+type)==value)return el=temp;temp=temp.parentElement}return el}var columns,column,dragTarget;dragTarget=WSId?"divPageCt_"+WSId:"wsPane",columns=document.querySelectorAll("#"+dragTarget+" .divPage"),column=document.getElementById(dragTarget);for(var dragEl=null,i=0;i<columns.length;i++)columns[i].index=i,columns[i].draggable=!0,columns[i].style.cursor="move";[].forEach.call(columns,function(column){column.addEventListener("dragstart",domdrugstart,!1),column.addEventListener("dragenter",domdrugenter,!1),column.addEventListener("dragover",domdrugover,!1),column.addEventListener("dragleave",domdrugleave,!1),column.addEventListener("drop",domdrop,!1),column.addEventListener("dragend",domdrapend,!1)})},workspaceAdd:function(len){var WSName=void 0;WSName=0==len?I18n.resource.analysis.workspace.WORKSPACE_NAME:prompt(I18n.resource.analysis.workspace.PROMPT_WORKSPACE_NAME),WSName&&""!=WSName&&WebAPI.post("/analysis/modal/save/"+AppConfig.userId,{workspaceName:WSName,modal:{name:"New",type:"",note:"",imagebin:"",option:{}}}).done(function(result){var result=JSON.parse(result);if(result.workspaceId&&""!=result.workspaceId){var $dropdownUl=$(".dropdownWS").next("ul"),$li=$('<li role="presentation">'),$a=$('<a role="menuitem" tabindex="-1">').attr("project-id",result.workspaceId).click(function(){_this.selectWorkspace(this)}).text(WSName);$li.append($a),$dropdownUl.append($li);var $divPageCt=$('<div class="divPageCt">').attr("id","divPageCt_"+result.workspaceId).attr("ws-id",result.workspaceId);$("#divWSPane").append($divPageCt),_this.selectWorkspace($a),_this.addSliderDom(result)}})},selectWorkspace:function(obj){var $dropdownWS=$(".dropdownWS");$dropdownWS.html($(obj).text()+'<span class="caret"></span>');var thisPjctId=$(obj).attr("project-id");if($($(obj).parent()).siblings().children("a").removeAttr("selected"),$(obj).attr("selected","selected"),thisPjctId&&""!=thisPjctId){if($("#divPageCt_"+thisPjctId).show().siblings(".divPageCt").hide(),$(obj).closest("#anlsWSPaneContain").length>0){var proj=$("#ddlWorkspace").next("ul").find('a[project-id="'+thisPjctId+'"]');$($(proj).parent()).siblings().children("a").removeAttr("selected"),proj.attr("selected","selected")}}else $(".divPageCt").hide();$("#anlsWSPaneContain").is(":hidden")?($("#btnCancelWS").click(),new AnalysisTemplate(_this.screen).show()):_this.synchronize(1)},deleteWorkspace:function(){if(confirm(I18n.resource.analysis.workspace.CONFIRM_WORKSPACE_DELETE)){var WSId=_this.getWorkspaceId();WebAPI.get("/analysis/workspace/remove/"+WSId).success(function(){$('a[project-id="'+WSId+'"]').parent("li").remove(),$("#divPageCt_"+WSId).remove();var $firstWS=$("#ddlWorkspace").next("ul").children();if($firstWS.length>0){var $firstWSA=$($firstWS[0]).children();$firstWSA.attr("selected","selected").trigger("click"),$(".dropdownWS").html($firstWSA.text()+'<span class="caret"></span>')}else $(".dropdownWS").html('Workspace<span class="caret"></span>'),_this.workspaceAdd(0);_this.screen.refreshPaneCenter(new AnalysisTemplate(_this.screen))})}},renameWorkspace:function(){var $ddl=(_this.getWorkspaceId(),$("#ddlWorkspace")),$thisA=$ddl.next("ul").find('a[selected="selected"]'),orgName=$.trim($thisA.text()),WSName=prompt(I18n.resource.analysis.workspace.PROMPT_WORKSPACE_RENAME);WSName=$.trim(WSName),""!=WSName&&orgName!=WSName&&($thisA.text(WSName),$ddl.html(WSName+'<span class="caret"></span>'),_this.screen.saveModal(),_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,_this.chart]))},getWorkspaceId:function(){return $("#ddlWorkspace").next("ul").find('a[selected="selected"]').attr("project-id")},workspaceCancel:function(){$("#anlsWSPaneContain").fadeOut("fast"),$("#anlsPaneContain").fadeIn(1e3);$("#paneContent");_this.toggleDataSource(!0)},modalNameInput:function(value){function saveName(obj){function refresh(){var thisClosest=$(thisInput).closest("#divWSPane").length>0?1:$(thisInput).closest("#anlsWSPaneContain").length>0?2:0;$(thisInput).hide(),$modalNameSp.show().html($(thisInput).val()).css({"margin-top":$(thisInput)[0].style.marginTop,"margin-left":-$modalNameSp[0].offsetWidth/2}),_this.synchronize(thisClosest)}var thisInput=obj,$modalNameSp=$(thisInput).prev("div"),id=$(thisInput).closest(".divPage").attr("id");if($(obj).val()==valueTemp)return void refresh();if(!_this.screen.curModal.option&&0==$.trim($(obj).val()).length)return void refresh();var selectTemp=$(".selected");selectTemp.addClass("selectTemp");var inputVal=""!=$(thisInput).val()?$(thisInput).val():modalName&&""!=modalName?modalName:"New";id==selectTemp.closest(".divPage").attr("id")&&"divPageTemp"!=id&&($("#anlsPaneContain .panel-heading").get(0).childNodes[0].textContent=inputVal),$(".divPage").removeClass("selected"),$(obj).closest(".divPage").addClass("selected");for(var workspace,i=0;i<_this.screen.store.workspaces.length;i++){workspace=_this.screen.store.workspaces[i];for(var j=0;j<workspace.modalList.length;j++)workspace.modalList[j].id==id&&(_this.screen.curModal=workspace.modalList[j].option)}refresh(),"divPageTemp"!=id?(modalName=inputVal,$(thisInput).val(inputVal),_this.screen.saveModal(),_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,_this.chart])):(modalName=inputVal,$(thisInput).val(inputVal))}var valueTemp,modalName=value,$input=$('<textarea class="newDivPageTitle" value="" i18n="placeholder=analysis.workspace.INPUT_PLACEHOLDER_PAGE_NAME"/>').blur(function(){$(this).closest(".divPage").attr("draggable",!0),_this.screen.targetSlide=$(this).closest(".divPage"),saveName(this)}).keypress(function(e){13==e.keyCode&&(_this.screen.targetSlide=$(this).closest(".divPage"),saveName(this))}).focus(function(){$(this).closest(".divPage").attr("draggable",!1),$(this).select(),valueTemp=$(this).prev().text();var height=$(this).prev(".modalNameSp").height();this.style.height=height+6+"px",this.style.marginTop=-height/2+10+"px"}).bind("input propertychange",function(){var height;height=this.scrollHeight>150?150:this.scrollHeight,this.style.height=height+"px",this.style.marginTop=-height/2+10+"px"});return value?$input.val(value).hide():$input.show(),$input},replaceNewModal:function(workspaceId,modalId,data){var $divPage=$("#divPageTemp");$divPage.attr("id",modalId).attr("modal-id",modalId),this.screen.chartImageBin&&$(".divPage.selected").css({"background-image":"url("+this.screen.chartImageBin+")"}),data=JSON.parse(data);for(var workspace,newWSId=!0,i=0;i<this.screen.store.workspaces.length;i++)if(workspace=this.screen.store.workspaces[i],workspace.id==workspaceId){data.modal.id=modalId;for(var modalList=this.screen.store.workspaces[i].modalList,isModalIdExisted=!0,j=0;j<modalList.length;j++)if(modalList[j].id==modalId){this.screen.store.workspaces[i].modalList[j]=data.modal,isModalIdExisted=!1;break}isModalIdExisted&&this.screen.store.workspaces[i].modalList.push(data.modal),newWSId=!1;break}if(newWSId){data.modal.id=modalId;var obj={id:data.workspaceId,name:data.workspaceName,modalList:[data.modal]};this.screen.store.workspaces.push(obj)}},setToolsBtnStatus:function($thisPage){var $btnUp=$("#btnPageUp"),$btnDown=$("#btnPageDown");$thisPage?(0==$thisPage.next().length?$btnDown.addClass("disabled"):$btnDown.removeClass("disabled"),0==$thisPage.prev().length?$btnUp.addClass("disabled"):$btnUp.removeClass("disabled")):($btnDown.addClass("disabled"),$btnUp.addClass("disabled"))},viewSliderMatrix:function(){var $WSPaneCt=$("#anlsWSPaneContain"),$panelHead=$('<div class="panel-heading" style="height: 41px;">'),$panelBody=$('<div class="panel-body" id="wsPane" style="height: calc(100% - 95px); overflow-y: auto;">'),$panelFoot=$('<div class="modal-footer" style="height: 54px;">');if($WSPaneCt.length<1){$WSPaneCt=$('<div class="panel panel-default" id="anlsWSPaneContain">');var $dropdown=$('<div class="dropdown">'),$editWorkspace=$('<div class="dropdownWS" id="editWorkspace" data-toggle="dropdown" aria-expanded="true" style="float: left;">Workspace<span class="caret"></span></div>'),$dropdownUl=$('<ul class="dropdown-menu" role="menu" aria-labelledby="ddlWorkspace">'),$ftCancel=$('<span class="glyphicon glyphicon-log-out panel-heading-btn" id="btnCancelWS" title="Go Back"></span>').click(_this.workspaceCancel),$divToolbar=$('<div class="btn-toolbar" style="margin-right: 20px; float:right; display:inline-block;">'),$divBtnGroup1=$('<div class="btn-group btn-group-xs"></div>'),$divBtnGroup2=$('<div class="btn-group btn-group-xs"></div>'),$divBtnGroup3=$('<div class="btn-group btn-group-xs"></div>'),$btnSelectAll=$('<button type="button" class="btn btn-default" id="btnSelectAll">Select All</button>').click(function(){util.checkbox.selectAll($panelBody.find(".slider-item"))}),$btnSelectInverse=$('<button type="button" class="btn btn-default" id="btnSelectInverse">Select Inverse</button>').click(function(){$(this);util.checkbox.selectInverse($panelBody.find(".slider-item"))}),$btnExport=$('<button type="button" class="btn btn-default btn-xs">\r\n                    <span class="glyphicon glyphicon-share" aria-hidden="true"></span> Share\r\n                </button>').click(function(){var wsId,modalList,selectedIds=$.makeArray($panelBody.find(".slider-item.checked").map(function(){return $(this).attr("id")})),data=[];if(selectedIds.length<=0)return void alert("You should choose one slider at least!");wsId=_this.getWorkspaceId();for(var i=0,len=_this.screen.store.workspaces.length;len>i;i++)if(_this.screen.store.workspaces[i].id===wsId){modalList=_this.screen.store.workspaces[i].modalList;break}if(!modalList||!modalList.length)return!1;for(var item,arrPoints,i=0,len=modalList.length;len>i;i++)if(selectedIds.indexOf(modalList[i].id)>-1){item=modalList[i],item.imagebin="",arrPoints=[];for(var j=0;j<item.option.itemDS.length;j++)arrPoints=arrPoints.concat(item.option.itemDS[j].arrId);data.push({id:(+new Date).toString()+i.toString(),spanC:6,spanR:4,modal:{interval:0,option:item,title:item.name,points:arrPoints,type:"ModalAnalysis"}})}var strShare="SHARE"+AppConfig.userId.toString()+(+new Date).toString();postData={projectId:"",menuItemId:strShare,layout:[data]},ScreenManager.show(EnergyScreen,strShare,postData)});FullScreenManager.init(function(e){var wsId,sliders;if(e.isFullScreen){wsId=$("#ddlWorkspace + ul").find("a[selected]").attr("project-id");for(var i=0,len=_this.screen.store.workspaces.length;len>i;i++)if(_this.screen.store.workspaces[i].id===wsId){sliders=_this.screen.store.workspaces[i].modalList;break}if(!sliders||!sliders.length)return void alert("There is no slider!");_this.sharpViewScreen=new SharpViewScreen(sliders,_this.screen.store),_this.sharpViewScreen.show()}else $("html").removeClass("sharpview-mode"),_this.sharpViewScreen.destroy()});var $btnPlay=$('<button type="button" class="btn btn-default btn-xs">\r\n                    <span class="glyphicon glyphicon-play" aria-hidden="true"></span> Play\r\n                </button>').click(function(){$("html").addClass("sharpview-mode"),FullScreenManager.toggle()});$dropdown.append($editWorkspace).append($dropdownUl),$divToolbar.append($divBtnGroup3.append($btnPlay)).append($divBtnGroup1.append($btnSelectAll).append($btnSelectInverse)).append($divBtnGroup2.append($btnExport)),$panelHead.append($dropdown).append($ftCancel).append($divToolbar),$WSPaneCt.append($panelHead).append($panelBody).append($panelFoot),$("#paneContent").append($WSPaneCt)}else $("#wsPane").html("");var $ddlWS=$("#ddlWorkspace");$("#editWorkspace").html($ddlWS.html()).next("ul").html($ddlWS.next("ul").children().clone(!0)),$("#anlsPaneContain").hide(),$WSPaneCt.show();var $showDivPageCt=$(".divPageCt").not(":hidden");$("#wsPane").append($showDivPageCt.children().clone(!0)),_this.initDrag(),I18n.fillArea($("#anlsWSPaneContain"))},synchronizeToSliderMatrix:function($obj){$obj.length>0&&$obj.not(":hidden")&&_this.viewSliderMatrix()},synchronizeToSliderList:function(){var $targetDivPageCt=$(".divPageCt").not(":hidden"),configDivPageList=$("#wsPane").children(".divPage");configDivPageList&&configDivPageList.length>0&&(configDivPageList=configDivPageList.clone(!0),$targetDivPageCt.html(""),$targetDivPageCt.append(configDivPageList),$targetDivPageCt.find(".divPage").each(function(){this.draggable=!1}))},synchronize:function(thisClosest){1==thisClosest?_this.synchronizeToSliderMatrix($("#wsPane")):2!=thisClosest||$("#anlsWSPaneContain").is(":hidden")||_this.synchronizeToSliderList()},toggleDataSource:function(bool){var colCount=$("#paneContent").prop("class").indexOf("col-sm-10");bool&&colCount>-1&&document.getElementById("rightCt").click(),!bool&&0>colCount&&document.getElementById("rightCt").click()}},AnlsWorkspace}(),AnlzBase=function(){function AnlzBase(container,option,screen){_this=this,this.container=container,this.options=option,this.screen=screen,this.paneChart=void 0,this.paneNotes=void 0,this.chart=void 0,this.noteCount=0,this.chartAnimationDuration=500,this.spinnerRender=new LoadingSpinner({color:"#00FFFF"})}var _this;return AnlzBase.prototype={show:function(){this.initTools(),this.container.innerHTML="",this.paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">')[0],$(this.container).append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes)),this.screen.curModal.noteList?_this.initNotes(this.screen.curModal.noteList):this.screen.curModal.noteList=[],$divBackgroundContainer=$('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">'),this.paneChart?$(this.container).append($divBackgroundContainer):(this.paneChart=$('<div style="width: 100%; height: 100%;">')[0],$(this.container).append($divBackgroundContainer).append(this.paneChart)),_this.spinnerRender.spin(this.container),this.init()},renderModal:function(data){_this=this,_this.render(data),setTimeout(function(){_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,_this.chart]),_this.spinnerRender.stop()},_this.chartAnimationDuration)},spinnerStop:function(){Spinner.stop(),_this.spinnerRender.stop(),_this.screen.spinnerSave&&_this.screen.spinnerSave.stop&&_this.screen.spinnerSave.stop()},close:function(){},init:function(){},errAlert:function(err){var $dataAlert=$("#dataAlert");switch(err){case"no data history":new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE6+"</strong>").show().close();break;case"time":new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE7+"</strong>").show().close();break;case"invalid time string":new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE8+"</strong>").show().close();break;default:new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE9+"</strong>").show().close()}setTimeout(function(){_this.screen.refreshPaneCenter(new AnalysisTemplate(_this.screen))},500)},initTools:function(){var _this=this;$(".itemTools .glyphicon-cog").off("click").on("click",function(){for(var optionTemplate=_this.screen.factoryIoC.getModel(_this.screen.curModal.type).prototype.optionTemplate,data=[],i=0;i<_this.screen.curModal.itemDS.length;i++){data.push({}),data[i].dsType=_this.screen.curModal.itemDS[i].type,data[i].dsId=_this.screen.curModal.itemDS[i].arrId,data[i].dsName=[];for(var j=0;j<_this.screen.curModal.itemDS[i].arrId.length;j++)data[i].dsName.push(AppConfig.datasource.getDSItemById(_this.screen.curModal.itemDS[i].arrId[j]).alias);

}var option={};option={modeUsable:optionTemplate.chartConfig,allDataNeed:"all"==optionTemplate.templateParams.paraAnlysMode,rowDataType:optionTemplate.templateParams.paraName,dataTypeMaxNum:optionTemplate.templateParams.dataTypeMaxNum,templateType:_this.screen.curModal.type,optionPara:{mode:_this.screen.curModal.mode,startTime:_this.screen.curModal.startTime,endTime:_this.screen.curModal.endTime,interval:_this.screen.curModal.format,dataItem:data}},_this.screen.modalConfig.showModalInit(!1,option)}),$(".itemTools .glyphicon-bookmark").off("click").click(function(){_this.createNote()})},createNote:function(note){function getDivNotePos(){var pos={},$lastNote=$(".divNote:nth-last-child(1)");return $lastNote[0]?$lastNote[0].offsetLeft<100?(pos.x=0,pos.y=$lastNote[0].offsetTop+$lastNote[0].offsetHeight+20,_this.noteCount=0):(++_this.noteCount,pos.x=130*_this.noteCount,pos.y=$lastNote[0].offsetTop):(pos.x=0,pos.y=0),pos}function getDomPosOffsetWindow(el){for(var _x=0,_y=0;el&&!isNaN(el.offsetLeft)&&!isNaN(el.offsetTop);)_x+=el.offsetLeft-el.scrollLeft,_y+=el.offsetTop-el.scrollTop,el=el.offsetParent;return{top:_y,left:_x}}var origZIndex;this.noteDefaultWidth=440,this.noteDefaultHeight=220;var notePos=getDivNotePos(),$divNote=$('<div class="divNote">').click(function(){$(".divNote").length>1&&(_this.curtNote=$divNote[0],this.style.zIndex<_this.getNoteMaxZIndex()&&(this.style.zIndex=_this.getNoteMaxZIndex()+1,origZIndex=this.style.zIndex))}).hover(function(e){this.style.zIndex<_this.getNoteMaxZIndex()&&(origZIndex=getComputedStyle(this).zIndex,this.style.zIndex=_this.getNoteMaxZIndex()+1)}).attr("id",note?note.id:(new Date).valueOf()).css({zIndex:_this.getNoteMaxZIndex()+1,left:note?note.x:"auto",right:note?"auto":notePos.x+"px",top:note?note.y:notePos.y,width:note?note.width:this.noteDefaultWidth+"px",height:note?note.height:this.noteDefaultHeight+"px"}).mousedown(_this.doDown).mouseup(_this.doUp),$divTitle=$('<div class="title">').appendTo($divNote),panePos=getDomPosOffsetWindow(document.getElementById("paneContent"));$divTitle[0].draggable=!0,$divTitle[0].ondragstart=function(e){this.dragParent=$(this).closest(".divNote"),this.dragParent[0].style.width=getComputedStyle(this.dragParent[0]).width,this.lastOffset={x:e.offsetX,y:e.offsetY}},$divTitle[0].ondragend=function(e){if(this.dragParent){var note={id:this.dragParent.attr("id"),x:(this.dragParent.position().left/this.dragParent.offsetParent().width()*100).toFixed(2)+"%",y:(this.dragParent.position().top/this.dragParent.offsetParent().height()*100).toFixed(2)+"%"};_this.saveNote(note),this.dragParent=null}},$divTitle[0].ondrag=function(e){this.dragParent&&e.clientX>0&&this.dragParent.css({top:e.clientY-panePos.top-60,left:e.clientX-panePos.left-this.dragParent[0].offsetWidth,width:this.dragParent[0].style.width})};var $divPin=$('<div class="glyphicon glyphicon-pushpin pinIcon grow">').appendTo($divTitle);$divPin.click(function(){_this.removeNote(this)});var $divText=$('<div class="divText">').appendTo($divNote);if($divText.click(function(e){function saveText(obj,strTemp){if($.trim(obj.value)!=$.trim(strTemp)){var note={id:$(obj).closest(".divNote").attr("id"),text:obj.value};_this.saveNote(note)}}function getToolbar(){var btnHtml='<div class="btn-toolbar" data-role="editor-toolbar" data-target="#editor" style="display:none;"> \r\n                    <div class="btn-group"> \r\n                    <a class="btn dropdown-toggle" data-toggle="dropdown" title="" data-original-title="Font"><i class="icon-font"></i><b class="caret"></b></a> \r\n                      <ul class="dropdown-menu"> \r\n                      <li><a data-edit="fontName Serif" style="font-family:\'Serif\'">Serif</a></li><li><a data-edit="fontName Sans" style="font-family:\'Sans\'">Sans</a></li><li><a data-edit="fontName Arial" style="font-family:\'Arial\'">Arial</a></li><li><a data-edit="fontName Arial Black" style="font-family:\'Arial Black\'">Arial Black</a></li><li><a data-edit="fontName Courier" style="font-family:\'Courier\'">Courier</a></li><li><a data-edit="fontName Courier New" style="font-family:\'Courier New\'">Courier New</a></li><li><a data-edit="fontName Comic Sans MS" style="font-family:\'Comic Sans MS\'">Comic Sans MS</a></li><li><a data-edit="fontName Helvetica" style="font-family:\'Helvetica\'">Helvetica</a></li><li><a data-edit="fontName Impact" style="font-family:\'Impact\'">Impact</a></li><li><a data-edit="fontName Lucida Grande" style="font-family:\'Lucida Grande\'">Lucida Grande</a></li><li><a data-edit="fontName Lucida Sans" style="font-family:\'Lucida Sans\'">Lucida Sans</a></li><li><a data-edit="fontName Tahoma" style="font-family:\'Tahoma\'">Tahoma</a></li><li><a data-edit="fontName Times" style="font-family:\'Times\'">Times</a></li><li><a data-edit="fontName Times New Roman" style="font-family:\'Times New Roman\'">Times New Roman</a></li><li><a data-edit="fontName Verdana" style="font-family:\'Verdana\'">Verdana</a></li></ul> \r\n                    </div> \r\n                  <div class="btn-group"> \r\n                    <a class="btn dropdown-toggle" data-toggle="dropdown" title="" data-original-title="Font Size"><i class="icon-text-height"></i>&nbsp;<b class="caret"></b></a> \r\n                      <ul class="dropdown-menu"> \r\n                      <li><a data-edit="fontSize 5"><font size="5">Huge</font></a></li> \r\n                      <li><a data-edit="fontSize 3"><font size="3">Normal</font></a></li> \r\n                      <li><a data-edit="fontSize 1"><font size="1">Small</font></a></li> \r\n                      </ul> \r\n                  </div> \r\n                  <div class="btn-group"> \r\n                    <a class="btn" data-edit="bold" title="" data-original-title="Bold (Ctrl/Cmd+B)"><i class="icon-bold"></i></a>\r\n                    <a class="btn" data-edit="italic" title="" data-original-title="Italic (Ctrl/Cmd+I)"><i class="icon-italic"></i></a>\r\n                    <a class="btn" data-edit="strikethrough" title="" data-original-title="Strikethrough"><i class="icon-strikethrough"></i></a>\r\n                    <a class="btn" data-edit="underline" title="" data-original-title="Underline (Ctrl/Cmd+U)"><i class="icon-underline"></i></a>\r\n                  </div>\r\n                  <div class="btn-group">\r\n                    <a class="btn" data-edit="insertunorderedlist" title="" data-original-title="Bullet list"><i class="icon-list-ul"></i></a>\r\n                    <a class="btn" data-edit="insertorderedlist" title="" data-original-title="Number list"><i class="icon-list-ol"></i></a>\r\n                    <a class="btn" data-edit="outdent" title="" data-original-title="Reduce indent (Shift+Tab)"><i class="icon-indent-left"></i></a>\r\n                    <a class="btn" data-edit="indent" title="" data-original-title="Indent (Tab)"><i class="icon-indent-right"></i></a>\r\n                  </div>\r\n                  <div class="btn-group">\r\n                    <a class="btn btn-info" data-edit="justifyleft" title="" data-original-title="Align Left (Ctrl/Cmd+L)"><i class="icon-align-left"></i></a>\r\n                    <a class="btn" data-edit="justifycenter" title="" data-original-title="Center (Ctrl/Cmd+E)"><i class="icon-align-center"></i></a>\r\n                    <a class="btn" data-edit="justifyright" title="" data-original-title="Align Right (Ctrl/Cmd+R)"><i class="icon-align-right"></i></a>\r\n                    <a class="btn" data-edit="justifyfull" title="" data-original-title="Justify (Ctrl/Cmd+J)"><i class="icon-align-justify"></i></a>\r\n                  </div>\r\n                  <div class="btn-group">\r\n                      <a class="btn dropdown-toggle" data-toggle="dropdown" title="" data-original-title="Hyperlink"><i class="icon-link"></i></a>\r\n                        <div class="dropdown-menu input-append">\r\n                            <input class="span2" placeholder="URL" type="text" data-edit="createLink">\r\n                            <button class="btn" type="button">Add</button>\r\n                    </div>\r\n                    <a class="btn" data-edit="unlink" title="" data-original-title="Remove Hyperlink"><i class="icon-cut"></i></a>\r\n                  </div>\r\n                  <div class="btn-group">\r\n                    <a class="btn" title="" id="pictureBtn" data-original-title="Insert picture (or just drag &amp; drop)"><i class="icon-picture"></i></a>\r\n                    <input type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage" style="opacity: 0; position: absolute; top: 0px; left: 0px; width: 41px; height: 30px;">\r\n                  </div>\r\n                  <div class="btn-group">\r\n                    <a class="btn" data-edit="undo" title="" data-original-title="Undo (Ctrl/Cmd+Z)"><i class="icon-undo"></i></a>\r\n                    <a class="btn" data-edit="redo" title="" data-original-title="Redo (Ctrl/Cmd+Y)"><i class="icon-repeat"></i></a>\r\n                  </div>\r\n                  <input type="text" data-edit="inserttext" id="voiceBtn" x-webkit-speech="" style="display: none;">\r\n                </div>';return btnHtml}var thisDiv=this,strTemp=this.textContent;this.style.display="none";var $editor=$divNote.find(".divTextEditor");if(0==$editor.length){$divNote.append($(getToolbar()));var $divTextEditor=$('<div class="divTextEditor"/>').keydown(function(){13==event.keyCode&&saveText(this,strTemp)}).appendTo($divNote).focus(function(){$divNote.find(".btn-toolbar").slideDown("1000"),$divNote.find(".divTextEditor").addClass("editing"),_this.curtNote=$divNote[0],$divNote.find(".divTextEditor").show(),$(thisDiv).hide()}).wysiwyg();$divTextEditor.show().focus().html(note?note.text:"")}else $editor.show().focus()}),$divText.html(note?note.text:""),$(this.paneNotes).append($divNote),!note){var note={id:$divNote.attr("id"),x:($divNote.position().left/$divNote.offsetParent().width()*100).toFixed(2)+"%",y:($divNote.position().top/$divNote.offsetParent().height()*100).toFixed(2)+"%",height:this.noteDefaultHeight+"px",width:this.noteDefaultWidth+"px",text:$divNote.find(".divTextEditor").html()};_this.screen.curModal.noteList.push(note),_this.saveNote(note,!0)}document.onmousemove=_this.doMove,document.onclick=_this.doClick},removeNote:function(obj){if(confirm(i18n_resource.analysis.workspace.CONFIRM_NOTE_DELETE)){var $divNote=$(obj).closest(".divNote");$divNote.remove(),_this.screen.curModal.noteList.splice(_this.getNoteListIndex($divNote.attr("id")),1),_this.screen.saveModal(),_this.screen.saveModalJudge.resolve(_this.screen)}},initNotes:function(notes){if(notes.length>0)for(var i=0;i<notes.length;i++)_this.createNote(notes[i])},hideNotes:function(){},showNotes:function(){},getNoteMaxZIndex:function(){for(var divNoteList=$(".divNote"),maxZIndex=1,i=0;i<divNoteList.length;i++){var zIndex=parseInt(getComputedStyle(divNoteList[i]).zIndex);zIndex>maxZIndex&&(maxZIndex=zIndex)}return maxZIndex},getNoteListIndex:function(id){for(var i=0;i<_this.screen.curModal.noteList.length;i++)if(_this.screen.curModal.noteList[i].id==id)return i},resizeObject:function(){this.el=null,this.dir="",this.grabx=null,this.graby=null,this.width=null,this.height=null,this.left=null,this.top=null},getDirection:function(el){var xPos,yPos,offset,dir;return dir="",xPos=window.event.offsetX,yPos=window.event.offsetY,offset=8,offset>yPos?dir+="n":yPos>el.offsetHeight-offset&&(dir+="s"),offset>xPos?dir+="w":xPos>el.offsetWidth-offset&&(dir+="e"),dir},doDown:function(){if(this.style.cursor.indexOf("-resize")>-1){$(".divTextEditor").blur();var el=_this.getReal(event.srcElement,"className","divNote");if(null==el)return void(_this.theobject=null);if(el.className&&el.className.indexOf("divNote")<0)return;if(_this.dir=_this.getDirection(el),""==_this.dir)return;_this.leftObject=new _this.resizeObject,_this.leftObject.el=el,_this.leftObject.dir=_this.dir,_this.leftObject.grabx=window.event.clientX,_this.leftObject.graby=window.event.clientY,_this.leftObject.width=el.offsetWidth,_this.leftObject.height=el.offsetHeight,_this.leftObject.left=el.offsetLeft,_this.leftObject.top=el.offsetTop,window.event.returnValue=!1,window.event.cancelBubble=!0}},doUp:function(){if(null!=_this.leftObject){var note={id:_this.leftObject.el.id,width:_this.leftObject.el.style.width,height:_this.leftObject.el.style.height};_this.saveNote(note),_this.leftObject=null}},doMove:function(e){var el,str,xMin,yMin;xMin=_this.noteDefaultWidth,yMin=_this.noteDefaultHeight-60,el=_this.getReal(event.srcElement,"className","divNote"),el&&(el.className&&"string"==typeof el.className&&el.className.indexOf("divNote")>-1&&(str=_this.getDirection(el),""==str?str="default":str+="-resize",el.style.cursor=str),null!=_this.leftObject&&(-1!=_this.dir.indexOf("e")&&(_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width+window.event.clientX-_this.leftObject.grabx)+"px"),-1!=_this.dir.indexOf("s")&&(_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height+window.event.clientY-_this.leftObject.graby)+"px"),-1!=_this.dir.indexOf("w")&&(_this.leftObject.el.style.left=Math.min(_this.leftObject.left+window.event.clientX-_this.leftObject.grabx,_this.leftObject.left+_this.leftObject.width-xMin)+"px",_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width-window.event.clientX+_this.leftObject.grabx)+"px"),-1!=_this.dir.indexOf("n")&&(_this.leftObject.el.style.top=Math.min(_this.leftObject.top+window.event.clientY-_this.leftObject.graby,_this.leftObject.top+_this.leftObject.height-yMin)+"px",_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height-window.event.clientY+_this.leftObject.graby)+"px"),window.event.returnValue=!1,window.event.cancelBubble=!0))},doClick:function(e){if(_this.curtNote)if(e.target==_this.curtNote||$(e.target).closest(".divNote")[0]==_this.curtNote)_this.curtNote.style.zIndex=_this.getNoteMaxZIndex()+1;else{var $thisEditor=$(_this.curtNote).find(".divTextEditor");$(_this.curtNote).find(".btn-toolbar").slideUp("1000",function(){$thisEditor.hide(),$(_this.curtNote).find(".divText").html($thisEditor.html()).show()}),$thisEditor.removeClass("editing");var id=$(_this.curtNote).attr("id"),note=(_this.getNoteListIndex(id),{id:id,text:$(_this.curtNote).find(".divTextEditor").html(),width:$(_this.curtNote).css("width"),height:$(_this.curtNote).css("height")});_this.saveNote(note)}},getReal:function(el,type,value){for(var temp=el;null!=temp&&"BODY"!=temp.tagName;){if(eval("temp."+type)==value)return el=temp;temp=temp.parentElement}return el},saveNote:function(note,bool){var id=note.id,isSave=!1,index=_this.getNoteListIndex(id),note_old=_this.screen.curModal.noteList[index];note.x&&note.x!=note_old.x&&(isSave=!0),!isSave&&note.y&&note.y!=note_old.y&&(isSave=!0),!isSave&&note.width&&note.width!=note_old.width&&(isSave=!0),!isSave&&note.height&&note.height!=note_old.height&&(isSave=!0),!isSave&&note.text&&note.text!=note_old.text&&(isSave=!0),(isSave||bool)&&(_this.screen.curModal.noteList[index]={id:id,x:note.x?note.x:note_old.x,y:note.y?note.y:note_old.y,width:note.width?note.width:note_old.width,height:note.height?note.height:note_old.height,text:note.text?note.text:note_old.text},_this.screen.saveModal(),_this.screen.saveModalJudge.resolve(_this.screen))}},AnlzBase}(),AnlzChart=function(){function AnlzChart(containerId,entityParams){}return AnlzChart.prototype.renderModal=function(){this.container.innerHTML=template},AnlzChart.prototype.updateModal=function(name,value){},AnlzChart.prototype.showConfigMode=function(){},AnlzChart}(),AnlzPieRealtime=function(){function AnlzPieRealtime(container,option,screen){AnlzBase.call(this,container,option,screen),_this=this,this.paneChart=void 0,this.chart=void 0,this.dictLegend={},this.postData={},this.interv=void 0}var _this;return AnlzPieRealtime.prototype=new AnlzBase,AnlzPieRealtime.prototype.optionTemplate={imgName:"anlsPieRealtime.png",imgColor:"211,97,78",templateName:"analysis.modalType.PIE_REAL_TIME",templateParams:{paraName:["X"],paraAnlysMode:"all"},chartConfig:["realTime"]},AnlzPieRealtime.prototype.close=function(){this.container=null,this.options=null,this.screen=null,this.paneChart=null,this.chart=null,this.dictLegend=null,clearInterval(_this.interv)},AnlzPieRealtime.prototype.init=function(){_this.postData={dsItemIds:_this.screen.curModal.itemDS[0].arrId},WebAPI.post("/analysis/startWorkspaceDataGenPieChart",_this.postData).done(function(result){if(result&&""!=result){var rslt=JSON.parse(result);if(rslt.error&&rslt.error.length>0)return alert(rslt.error),void _this.spinnerStop();_this.renderModal(rslt)}}).error(function(e){_this.screen.alertNoData(),_this.spinnerStop()}),_this.interv=setInterval(function(){_this.spinnerRender.spin(this.container),WebAPI.post("/analysis/startWorkspaceDataGenPieChart",_this.postData).done(function(result){var data=JSON.parse(result);if(data.error&&data.error.length>0)return _this.errAlert(data.error),void _this.spinnerStop();if(data&&""!=data){for(var item,arrData=[],i=0;i<data.length;i++){item=data[i];var itemName=AppConfig.datasource.getDSItemById(item.dsItemId).alias;arrData.push({value:parseFloat(item.data),name:itemName})}var series=[{type:"pie",radius:"55%",center:["50%","60%"],data:arrData}];_this.chart.setSeries(series,!0)}}).error(function(e){_this.screen.alertNoData(),_this.spinnerStop()})},6e4)},AnlzPieRealtime.prototype.render=function(data){for(var item,arrLabel=[],arrData=[],i=0;i<data.length;i++){item=data[i];var itemName=AppConfig.datasource.getDSItemById(item.dsItemId).alias;arrLabel.push(itemName),arrData.push({value:parseFloat(item.data),name:itemName})}var option={title:{text:"",x:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",x:"left",data:arrLabel},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["pie","funnel"],option:{funnel:{x:"25%",width:"50%",funnelAlign:"left",max:1548}}},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,series:[{type:"pie",radius:"55%",center:["50%","60%"],data:arrData}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration};this.chart=echarts.init(this.paneChart).setOption(option)},AnlzPieRealtime}(),AnlzHistoryCompare=function(){function AnlzHistoryCompare(container,option,screen){AnlzBase.call(this,container,option,screen),_this=this,this.curIndex=1}var _this;return AnlzHistoryCompare.prototype=new AnlzBase,AnlzHistoryCompare.prototype.optionTemplate={imgName:"anlsHistory.png",imgColor:"65,131,189",templateName:"analysis.modalType.HISTORY_COMPARE",templateParams:{paraName:["X"],paraAnlysMode:"all"},chartConfig:["easyCompareAnalyz","compareSensor","compareMeter"]},AnlzHistoryCompare.prototype.show=function(){this.container.innerHTML="",this.initTools(),this.paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">')[0],$(this.container).append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes)),this.screen.curModal.noteList?this.initNotes(this.screen.curModal.noteList):this.screen.curModal.noteList=[],$(".itemTools .glyphicon-bookmark").off("click").click(function(){_this.createNote()});var temp;this.paneChart=document.createElement("div"),temp=this.paneChart.style,temp.cssFloat="left",temp.width="100%",temp.height="100% ",this.container.appendChild(this.paneChart),temp=null,_this.spinnerRender.spin(this.container),this.init()},AnlzHistoryCompare.prototype.close=function(){this.container=null,this.options=null,this.screen=null,this.paneChart=null,this.chart=null,this.dictLegend=null,this.curIndex=null},AnlzHistoryCompare.prototype.init=function(){AppConfig.datasource.getDSItemDataMulti(this,this.screen.curModal.itemDS[0].arrId)},AnlzHistoryCompare.prototype.render=function(data){this.chart?this.refreshChart(data):this.initChart(data)},AnlzHistoryCompare.prototype.initChart=function(data){this.createSeries(data);var option={title:{text:""},tooltip:{trigger:"axis",backgroundColor:"rgba(255,255,255,0.7)",axisPointer:{type:"shadow"}},legend:{x:"right",data:this.arrLegendData},toolbox:{show:!0,orient:"vertical",y:"center",feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,grid:{x:60,x2:20,y:60,borderColor:"#eee"},xAxis:[{type:"category",data:this.screen.curModal.arrComparePeriodLabel}],yAxis:[{type:"value"}],series:this.arrSeries};this.chart=echarts.init(this.paneChart).setOption(option)},AnlzHistoryCompare.prototype.initOption=function(series,timeSHaft){return{tooltip:{trigger:"axis"},grid:{x:60,x2:20,y:60,borderColor:"#eee"},toolbox:{show:!0,feature:{magicType:{show:!0,type:["line","bar"]},dataZoom:{show:!0},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,dataZoom:{show:!0,start:0,end:100},xAxis:[{type:"category",boundaryGap:!1,data:timeSHaft}],yAxis:[{type:"value",scale:!0}],series:series,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration}},AnlzHistoryCompare.prototype.refreshChart=function(data){var item=data.list[0];if(!this.dictLegend[item.dsItemId]){var arrTemp=this.chart.getSeries();arrTemp.push(this.createSeries(item.data)),this.chart.setSeries(arrTemp),arrTemp=null,this.screen.curModal.itemDS[0].arrId.push(item.dsItemId);this.screen.saveModal()}},AnlzHistoryCompare.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],calcResult=[],arrId=[],mode=this.screen.curModal.mode;if("easyCompareAnalyz"==mode||"compareSensor"==mode)for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];calcResult[i][j]=0,0==i&&(arrId.push(point.dsItemId),arrLegendData.push(AppConfig.datasource.getDSItemById(point.dsItemId).alias));for(var k=0;k<point.data.length;k++)calcResult[i][j]+=parseFloat(point.data[k])}}if("compareMeter"==this.screen.curModal.mode)for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];0==i&&arrLegendData.push(AppConfig.datasource.getDSItemById(point.dsItemId).alias),calcResult[i][j]=item.list[item.list.length-1]-item.list[0]}}for(var i=0;i<data[0].list.length;i++){for(var seriesData=[],j=(AppConfig.datasource.getDSItemById(data[0].list[i]).alias,0);j<data.length;j++)seriesData.push(calcResult[j][i]);var color=echarts.config.color[this.curIndex++],series={id:arrId[i],name:arrLegendData[i],type:"bar",data:seriesData,itemStyle:{normal:{lineStyle:{color:color}}}};arrSeries.push(series)}this.arrSeries=arrSeries,this.arrLegendData=arrLegendData},AnlzHistoryCompare}(),AnlzScatter=function(){function AnlzScatter(container,option,screen){AnlzBase.call(this,container,option,screen)}return AnlzScatter.prototype=new AnlzBase,AnlzScatter.prototype.optionTemplate={imgName:"anlsScatter.png",imgColor:"211,97,78",templateName:"analysis.modalType.SCATTER",templateParams:{paraName:["X","Y"],paraAnlysMode:"all",dataTypeMaxNum:[1,5]},chartConfig:["easy","fixed","recent"]},AnlzScatter.prototype.init=function(){var _this=this,arrIds=[];arrIds.push(this.screen.curModal.itemDS[0].arrId[0]),arrIds=arrIds.concat(this.screen.curModal.itemDS[1].arrId);var postData={dsItemIds:arrIds,timeStart:this.screen.curModal.startTime.format("yyyy-MM-dd HH:mm:ss"),timeEnd:this.screen.curModal.endTime.format("yyyy-MM-dd HH:mm:ss"),timeFormat:this.screen.curModal.format};WebAPI.post("/analysis/startWorkspaceDataGenScatterChart",postData).done(function(result){var data=JSON.parse(result);return data.error&&data.error.length>0?(_this.errAlert(data.error),void _this.spinnerStop()):void _this.renderModal(data)}).error(function(e){_this.screen.alertNoData(),_this.spinnerStop()})},AnlzScatter.prototype.render=function(data){for(var arrXAxis=data.list[0].data,arrData=[],arrLegend=[],arrSeries=[],i=1;i<data.list.length;i++)arrData.push([]),arrLegend.push(AppConfig.datasource.getDSItemById(data.list[i].dsItemId).alias);for(var valueX,i=0;i<arrXAxis.length;i++){valueX=data.list[0].data[i];for(var j=0,jLen=data.list.length-1;jLen>j;j++)arrData[j].push([valueX,data.list[j+1].data[i]])}for(var i=0;i<arrData.length;i++)arrSeries.push({name:arrLegend[i],type:"scatter",data:arrData[i],markLine:{data:[{type:"average",name:I18n.resource.observer.analysis.AVERAGE}]}});var option={title:{text:"X: "+AppConfig.datasource.getDSItemById(data.list[0].dsItemId).alias,subtext:"Scatter"},tooltip:{trigger:"axis",showDelay:0,axisPointer:{show:!0,type:"cross",lineStyle:{type:"dashed",width:1}}},legend:{data:arrLegend},toolbox:{show:!0,feature:{mark:{show:!0},dataZoom:{show:!0},dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},xAxis:[{type:"value",scale:!0}],yAxis:[{type:"value",scale:!0}],series:arrSeries,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration};this.chart=echarts.init(this.paneChart).setOption(option)},AnlzScatter}(),AnlzSpectrum=function(){function AnlzSpectrum(container,option,screen){AnlzBase.call(this,container,option,screen)}return AnlzSpectrum.prototype=new AnlzBase,AnlzSpectrum.prototype.optionTemplate={imgName:"anlsSpectrum.png",imgColor:"148,193,142",templateName:"analysis.modalType.SPECTRUM",templateParams:{paraName:["X"],paraAnlysMode:"all",dataTypeMaxNum:[1]},chartConfig:["easy","fixed","recent"]},AnlzSpectrum.prototype.init=function(){var _this=this,postData={dsItemIds:this.screen.curModal.itemDS[0].arrId,timeStart:this.screen.curModal.startTime.format("yyyy-MM-dd HH:mm:ss"),timeEnd:this.screen.curModal.endTime.format("yyyy-MM-dd HH:mm:ss"),timeFormat:this.screen.curModal.format};WebAPI.post("/analysis/startWorkspaceDataGenPattern",postData).done(function(result){var data=JSON.parse(result);return data.error&&data.error.length>0?(_this.errAlert(data.error),void _this.spinnerStop()):void _this.renderModal(data)}).error(function(e){_this.screen.alertNoData(),_this.spinnerStop()})},AnlzSpectrum.prototype.render=function(data){for(var item,arrLabel=[],arrData=[],i=0;i<data.list.length;i++)item=data.list[i],arrLabel.push(item.data),arrData.push(item.pattern);var option={title:{text:AppConfig.datasource.getDSItemById(this.screen.curModal.itemDS[0].arrId[0]).alias,subtext:"Spectrum"},tooltip:{trigger:"axis"},toolbox:{show:!0,feature:{mark:{show:!0},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,xAxis:[{type:"category",boundaryGap:!0,data:arrLabel}],yAxis:[{type:"value"}],series:[{type:"bar",data:arrData,itemStyle:{normal:{color:"#5bc0de",barBorderRadius:[5,5,0,0]}},markLine:{data:[{type:"average",name:I18n.resource.observer.analysis.AVERAGE}]}}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration};this.chart=echarts.init(this.paneChart).setOption(option)},AnlzSpectrum}(),AnlzTendency=function(){function AnlzTendency(container,option,screen){AnlzBase.call(this,container,option,screen),this.paneLegend=void 0,this.dictLegend={},this.dictTooltip={},this.curIndex=0,this.legendType={NORMAL:0,Prediction:1,Regression:2},this.screen=screen,_this=this}var _this;return AnlzTendency.prototype=new AnlzBase,AnlzTendency.prototype.optionTemplate={imgName:"anlsTendency.png",imgColor:"65,131,189",templateName:"analysis.modalType.TENDENCY",templateParams:{paraName:["X"],paraAnlysMode:"all"},chartConfig:["easy","fixed","recent"]},AnlzTendency.prototype.show=function(){this.container.innerHTML="",this.initTools(),this.paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">')[0],$(this.container).append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes)),this.screen.curModal.noteList?this.initNotes(this.screen.curModal.noteList):this.screen.curModal.noteList=[],$(".itemTools .glyphicon-bookmark").off("click").click(function(){_this.createNote()});var temp;this.paneChart=document.createElement("div"),temp=this.paneChart.style,temp.cssFloat="left",temp.width="100%",temp.height="calc(100% - 170px)",this.paneLegend=document.createElement("div"),this.paneLegend.className="divHover",temp=this.paneLegend.style,temp.marginTop="10px",temp.padding="10px",temp.cssFloat="left",temp.width="100%",temp.height="160px",temp.position="absolute",temp.bottom="0px",this.container.appendChild(this.paneChart),this.container.appendChild(this.paneLegend),temp=null,_this.spinnerRender.spin(this.container),this.init()},AnlzTendency.prototype.close=function(){this.container=null,this.options=null,this.screen=null,this.paneLegend=null,this.paneChart=null,this.chart=null,this.dictLegend=null,this.curIndex=null},AnlzTendency.prototype.init=function(){var _this=this;AppConfig.datasource.getDSItemData(this,this.screen.curModal.itemDS[0].arrId),this.paneLegend.ondragover=function(e){return e.currentTarget.classList.add("dragHover"),!1},this.paneLegend.ondragleave=function(e){return e.currentTarget.classList.remove("dragHover"),!1},this.paneLegend.ondrop=function(e){_this.spinnerRender.spin(_this.container);var $ele=$(e.currentTarget),dsItemId=e.dataTransfer.getData("dsItemId");if(e.currentTarget.classList.remove("dragHover"),dsItemId){if($ele.find('[id="'+dsItemId+'"]').length>0)return;AppConfig.datasource.getDSItemData(_this,[e.dataTransfer.getData("dsItemId")])}}},AnlzTendency.prototype.render=function(data){this.chart?this.refreshChart(data):this.initChart(data)},AnlzTendency.prototype.initChart=function(data){for(var arrSeries=[],i=0;i<data.list.length;i++){var item=data.list[i];arrSeries.push(this.createSeries(item.dsItemId,item.data))}this.chart=echarts.init(this.paneChart).setOption(this.initOption(arrSeries,data.timeShaft))},AnlzTendency.prototype.initOption=function(series,timeSHaft){return{tooltip:{trigger:"axis"},grid:{x:60,x2:20,y:60,borderColor:"#eee"},toolbox:{show:!0,feature:{magicType:{show:!0,type:["line","bar"]},dataZoom:{show:!0},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,dataZoom:{show:!0,start:0,end:100},xAxis:[{type:"category",boundaryGap:!1,data:timeSHaft}],yAxis:[{type:"value",scale:!0}],series:series,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration}},AnlzTendency.prototype.refreshChart=function(data){var item=data.list[0];if(!this.dictLegend[item.dsItemId]){var arrTemp=this.chart.getSeries();arrTemp.push(this.createSeries(item.dsItemId,item.data)),this.chart.setSeries(arrTemp),arrTemp=null,this.screen.curModal.itemDS[0].arrId.push(item.dsItemId);this.screen.saveModal()}},AnlzTendency.prototype.createSeries=function(id,data,type){type||(type=this.legendType.NORMAL);var name;type==this.legendType.NORMAL?name=AppConfig.datasource.getDSItemById(id).alias:(name=id.split("_"),name=AppConfig.datasource.getDSItemById(name[0]).alias+"_"+id[1]);var color=echarts.config.color[this.curIndex++];return this.renderLegend(id,name,type,color),{id:id,name:name,type:"line",symbol:"none",data:data,itemStyle:{normal:{lineStyle:{color:color}}}}},AnlzTendency.prototype.removeSeries=function(id){var _this=this;delete this.dictLegend[id],$("#"+id).remove();for(var option=this.chart.getOption(),arrSeries=option.series,i=0;i<arrSeries.length;i++)if(arrSeries[i].id==id){arrSeries.splice(i,1);break}for(var arrIds=this.screen.curModal.itemDS[0].arrId,i=0;i<arrIds.length;i++)arrIds[i]==id&&arrIds.splice(i,1);this.screen.curModal.itemDS[0].arrId=arrIds,this.chart=echarts.init(this.paneChart).setOption(this.initOption(arrSeries,option.xAxis[0].data)),window.setTimeout(function(){_this.screen.saveModal(),_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,_this.chart])},500)},AnlzTendency.prototype.getDataById=function(id){for(var arrSeries=this.chart.getSeries(),i=0;i<arrSeries.length;i++)if(arrSeries[i].id==id)return arrSeries[i].data},AnlzTendency.prototype.renderLegend=function(id,name,type,color){var _this=this,name=name,div=document.createElement("div"),closeBtn='<button type="button" class="close"><span>&times;</span></button>';switch(div.id=id,div.className="divLegend",
div.draggable=!0,div.style.backgroundColor=color,div.setAttribute("ty",type),type){case this.legendType.Regression:div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split("_Regression_")[0]+"_Regression</div>"+closeBtn,this.initGeneralRegressorTooltip(id,div);break;case this.legendType.Prediction:div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split("_Prediction_")[0]+"_Prediction</div>"+closeBtn,this.initGeneralPredictorTooltip(id,div);break;default:div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-stats' style='margin-right: 10px;'></span>"+name+"</div>"+closeBtn}div.getElementsByClassName("close")[0].onclick=function(e){var $ele=$(e.currentTarget).parent(),id=$ele[0].id;$(".divLegend").length>1?($ele.tooltip("destroy"),_this.removeSeries(id)):alert("The only parameters can't be removed"),e.stopPropagation()},div.ondragstart=function(e){e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("id",e.currentTarget.id),e.dataTransfer.setData("source","legend")},div.ondragover=function(e){return!1},div.ondrop=function(e){function generateRegressor(e,sourceId,targetId){var data={source:[_this.getDataById(sourceId)],target:_this.getDataById(targetId),sourceNames:sourceId,targetName:targetId};_this.spinnerRender.spin(_this.container),WebAPI.post("/analysis/generalRegressor",data).done(function(result){var id=targetId+"_Regression_"+ +new Date,data=JSON.parse(result),arrTemp=_this.chart.getSeries();data.SourceId=sourceId,data.TargetId=targetId,_this.dictTooltip[id]=data,arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Regression)),_this.chart.setSeries(arrTemp),arrTemp=null,_this.spinnerRender.stop()}).error(function(result){_this.spinnerRender.stop()})}function generatePredictor(e,sourceId,targetId){for(var arrCoefficient=_this.dictTooltip[e.currentTarget.id].Coefficients,i=0;i<arrCoefficient.length;i++)arrCoefficient[i]=arrCoefficient[i].toString();var data={source:[_this.getDataById(sourceId)],Coefficients:arrCoefficient};_this.spinnerRender.spin(_this.container),WebAPI.post("/analysis/generalPredictor",data).done(function(result){var id=targetId.split("_")[0]+"_Prediction_"+ +new Date,arrTemp=_this.chart.getSeries(),data=JSON.parse(result);data.PredicatedResults&&(arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Prediction)),_this.chart.setSeries(arrTemp)),_this.spinnerRender.stop()}).error(function(result){_this.spinnerRender.stop()})}var srcId=e.dataTransfer.getData("id"),toId=e.currentTarget.id;if(e.stopPropagation(),srcId!==toId){var source=e.dataTransfer.getData("source");source&&"legend"==source&&(e.currentTarget.getAttribute("ty")==_this.legendType.Regression?generatePredictor(e,srcId,toId):generateRegressor(e,srcId,toId))}},this.paneLegend.appendChild(div)},AnlzTendency.prototype.initGeneralRegressorTooltip=function(id,element){var data=this.dictTooltip[id],sb=new StringBuilder;sb.append('<div class="tooltip" role="tooltip">'),sb.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>'),sb.append('    <div class="tooltipContent">'),sb.append('        <p style="white-space:nowrap;">RSquared: ').append(data.RSquared).append("</p> "),sb.append('        <p>Formula: </p><p style="margin-left: 20px; white-space:nowrap;">').append(data.Formula).append("</p> "),sb.append('        <p style="margin-left: 20px; white-space:nowrap;">x: ').append(AppConfig.datasource.getDSItemById(data.SourceId).alias).append("</p>"),sb.append('        <p style="margin-left: 20px; white-space:nowrap;">y: ').append(AppConfig.datasource.getDSItemById(data.TargetId).alias).append("</p>"),sb.append("    </div>"),sb.append('    <div class="tooltip-arrow"></div>'),sb.append("</div>");var options={placement:"top",title:"GeneralRegressor",template:sb.toString()};$(element).tooltip(options)},AnlzTendency.prototype.initGeneralPredictorTooltip=function(id,element){var sb=(this.dictTooltip[id],new StringBuilder);sb.append('<div class="tooltip" role="tooltip">'),sb.append('    <div class="tooltipTitle tooltip-inner">GeneralPredictor</div>'),sb.append('    <div class="tooltipContent">'),sb.append('        <p style="white-space:nowrap;">Source: ').append(AppConfig.datasource.getDSItemById(id.split("_")[0]).alias).append("</p> "),sb.append("    </div>"),sb.append('    <div class="tooltip-arrow"></div>'),sb.append("</div>");var options={placement:"top",title:"GeneralPredictor",template:sb.toString()};$(element).tooltip(options)},AnlzTendency}(),AnlzStack=function(){function AnlzStack(container,option,screen){AnlzBase.call(this,container,option,screen),this.screen=screen,_this=this}var _this;return AnlzStack.prototype=new AnlzBase,AnlzStack.prototype.optionTemplate={imgName:"anlsStack.png",imgColor:"148,193,142",templateName:"analysis.modalType.STACK",templateParams:{paraName:["X"],paraAnlysMode:"all"},chartConfig:["easy","fixed","recent"]},AnlzStack.prototype.show=function(){this.container.innerHTML="";var temp;this.paneChart=document.createElement("div"),temp=this.paneChart.style,temp.cssFloat="left",temp.width="100%",temp.height="100%",this.container.appendChild(this.paneChart),this.init(),this.paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">')[0],$(this.container).append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes)),this.screen.curModal.noteList?_this.initNotes(this.screen.curModal.noteList):this.screen.curModal.noteList=[],$(".itemTools .glyphicon-bookmark").off("click").click(function(){_this.createNote()})},AnlzStack.prototype.close=function(){this.container=null,this.options=null,this.screen=null,this.paneChart=null,this.chart=null},AnlzStack.prototype.init=function(){AppConfig.datasource.getDSItemData(this,this.screen.curModal.itemDS[0].arrId)},AnlzStack.prototype.render=function(data){this.initChart(data)},AnlzStack.prototype.initChart=function(data){for(var arrSeries=[],arrLengend=[],i=0;i<data.list.length;i++){var item=data.list[i];arrSeries.push(this.createSeries(item.dsItemId,item.data)),arrLengend.push(arrSeries[i].name)}this.chart=echarts.init(this.paneChart).setOption(this.initOption(arrSeries,arrLengend,data.timeShaft))},AnlzStack.prototype.initOption=function(series,arrLengend,timeSHaft){return{tooltip:{trigger:"axis"},legend:{data:arrLengend},grid:{x:60,x2:20,y:60,borderColor:"#eee"},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar","stack","tiled"]},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,dataZoom:{show:!0,start:0,end:100},xAxis:[{type:"category",boundaryGap:!1,data:timeSHaft}],yAxis:[{type:"value",scale:!0}],series:series,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration}},AnlzStack.prototype.createSeries=function(id,data,type){return{id:id,name:AppConfig.datasource.getDSItemById(id).alias,type:"line",smooth:!0,itemStyle:{normal:{areaStyle:{type:"default"}}},symbol:"none",stack:I18n.resource.observer.analysis.TOTAL_AMOUNT,data:data}},AnlzStack}(),AnlzCluster=function(){function AnlzCluster(container,option,screen){AnlzBase.call(this,container,option,screen),this.m_panelTrend=void 0,this.m_panelScatter=void 0}return AnlzCluster.prototype=new AnlzBase,AnlzCluster.prototype.optionTemplate={imgName:"anlsPattern.png",imgColor:"65,131,189",templateName:"analysis.modalType.CLUSTER",templateParams:{paraName:["X"],paraAnlysMode:"part"},chartConfig:["easy","fixed","recent"],type:""},AnlzCluster.prototype.show=function(){var _this=this;this.initTools(),this.container.innerHTML="",this.paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">')[0],$(this.container).append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes)),this.screen.curModal.noteList?this.initNotes(this.screen.curModal.noteList):this.screen.curModal.noteList=[],$(".itemTools .glyphicon-bookmark").off("click").click(function(){_this.createNote()}),$(this.container).append($('<div style="width: 100%; height: 450px;">\r\n                <ul class="nav nav-tabs" role="tablist" id="myTab">\r\n                    <li role="presentation" class="active">\r\n                        <a id="aTendency" href="#tabTendency" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TREND_DISTRIBUTE"></span></a>\r\n                    </li>\r\n                    <li role="presentation">\r\n                        <a id="aScatter" href="#tabScatter" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TYPE_POINT"></span></a>\r\n                    </li>\r\n                </ul>\r\n                <div class="tab-content">\r\n                    <div role="tabpanel" class="tab-pane fade in active" id="tabTendency" style="height: 400px;"></div>\r\n                    <div role="tabpanel" class="tab-pane fade" id="tabScatter" style="height: 400px;"></div>\r\n                </div>\r\n             </div>\r\n             <div class="panel panel-default" style="height: calc(100% - 450px);">\r\n                 <div class="panel-heading"><span i18n="analysis.paneConfig.TYPICAL_CONDITION"></span></div>\r\n                 <div class="panel-body" style="padding: 0; height: calc(100% - 40px); overflow-y: auto;">\r\n                     <table class="table" id="tableGroup" style="overflow-x: auto;"></table>\r\n                 </div>\r\n             </div>')),I18n.fillArea($(this.container)),_this.spinnerRender.spin(this.container),this.init()},AnlzCluster.prototype.init=function(){for(var _this=this,arrIds=[],arrType=[],arrDSItems=this.screen.curModal.itemDS,i=0;i<arrDSItems.length;i++){var arrTemp=arrDSItems[i].arrId;arrTemp&&arrTemp.length>0&&(arrIds=arrIds.concat(arrTemp),arrType.push(this.optionTemplate.templateParams.paraName[i]))}var postData={dsItemIds:arrIds,timeStart:this.screen.curModal.startTime.format("yyyy-MM-dd HH:mm:ss"),timeEnd:this.screen.curModal.endTime.format("yyyy-MM-dd HH:mm:ss"),timeFormat:this.screen.curModal.format,pointType:arrType,systemType:this.optionTemplate.type};WebAPI.post("/analysis/startWorkspaceDataGenCluster",postData).done(function(result){var data=JSON.parse(result);return data.error&&data.error.length>0?(_this.errAlert(data.error),void _this.spinnerStop()):void _this.renderModal(data)}).error(function(e){_this.screen.alertNoData(),_this.spinnerStop()})},AnlzCluster.prototype.render=function(data){var _this=this;this.initTable(data),this.initTendency(data),$("#aScatter").on("shown.bs.tab",function(e){0==$("#tabScatter div").length&&_this.initScatter(data)}),_this.spinnerStop()},AnlzCluster.prototype.initTable=function(data){var table=$("#tableGroup");table.html("");for(var tr,td,divLegend,details,tbody=document.createElement("tbody"),i=0;i<data.dataAnalysisResult.Pattern.length;i++)if(details=data.dataAnalysisResult.Pattern[i].Diagnosis,tr=document.createElement("tr"),td=document.createElement("td"),td.rowSpan=details?details.length:1,divLegend=document.createElement("span"),divLegend.textContent="Group "+data.dataAnalysisResult.Pattern[i].name,divLegend.className="label label-warning",divLegend.style.padding="3px",divLegend.style.backgroundColor=echarts.config.color[i],td.appendChild(divLegend),tr.appendChild(td),td=document.createElement("td"),details&&(td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[0].name+"</span>"+details[0].detail),tr.appendChild(td),tbody.appendChild(tr),details&&details.length>1)for(var j=1;j<details.length;j++)tr=document.createElement("tr"),td=document.createElement("td"),td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[j].name+"</span>"+details[j].detail,tr.appendChild(td),tbody.appendChild(tr);$("#tableGroup").append(tbody)},AnlzCluster.prototype.initTendency=function(data){for(var arrSeries=new Array,arrLegend=new Array,i=0;i<data.dataAnalysisResult.Pattern.length;i++){var item=data.dataAnalysisResult.Pattern[i];arrLegend.push(item.name),arrSeries.push({name:item.name,type:"line",stack:"总量",itemStyle:{normal:{areaStyle:{type:"default"}}},data:item.TrendValue})}var option={tooltip:{trigger:"axis"},legend:{data:arrLegend},toolbox:{show:!0,feature:{magicType:{show:!0,type:["line","bar","stack","tiled"]},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,xAxis:[{type:"category",boundaryGap:!1,data:data.dataAnalysisResult.Pattern[0].TrendLabel}],yAxis:[{min:0,max:100,type:"value"}],series:arrSeries};this.m_panelTrend=echarts.init(document.getElementById("tabTendency")),this.m_panelTrend.setOption(option),this.chart=this.m_panelTrend},AnlzCluster.prototype.initScatter=function(data){for(var item,name,arrData,series=new Array,seriesNames=new Array,i=0,len=data.dataAnalysisResult.ScatterChart.length;len>i;i++){item=data.dataAnalysisResult.ScatterChart[i],name=item.name[0],arrData=new Array;for(var itemPoint,j=0;j<item.data.length;j++)itemPoint=item.data[j],arrData.push(itemPoint.split(","));seriesNames.push(name),series.push({name:name,type:"scatter",symbolSize:5,data:arrData})}var option={title:{},tooltip:{trigger:"item",formatter:function(params){return params.seriesName+"<br/>"+params.value[0]+", "+params.value[1]}},toolbox:{show:!0,feature:{dataZoom:{show:!0},restore:{show:!0},saveAsImage:{show:!0}}},legend:{data:seriesNames},xAxis:[{type:"value",scale:!0}],yAxis:[{type:"value",scale:!0}],animation:!0,series:series},myChart=echarts.init(document.getElementById("tabScatter"));myChart.setOption(option)},AnlzCluster}(),AnlzCluster_AHU=function(){function AnlzCluster_AHU(container,option,screen){AnlzCluster.call(this,container,option,screen)}return AnlzCluster_AHU.prototype=new AnlzCluster,AnlzCluster_AHU.prototype.optionTemplate={imgName:"anlsClusterAhu.png",imgColor:"148,193,142",templateName:"analysis.modalType.CLUSTER_AHU",templateParams:{paraName:["MATemp","SATemp","RACO2","OATemp","RATemp","RATempSetting","SATempSetting","RACO2Setting","HWTemp","CWTemp","OperationMode","OADamperRatio","HCDamperRatio","CCDamperRatio","SAStaticPressure","SAStaticPressureSetting","FanVSDFrequency","CWRetrunTemp"],paraAnlysMode:"part"},chartConfig:["easy","fixed","recent"],type:"AHU"},AnlzCluster_AHU}(),AnlzCluster_Chiller=function(){function AnlzCluster_Chiller(container,option,screen){AnlzCluster.call(this,container,option,screen)}return AnlzCluster_Chiller.prototype=new AnlzCluster,AnlzCluster_Chiller.prototype.optionTemplate={imgName:"anlsClusterChiller.png",imgColor:"211,97,78",templateName:"analysis.modalType.CLUSTER_CHILLER",templateParams:{paraName:["OADryTemp","OAWetBulbTemp","AmperRatio","ChwSupplyTemp","ChwReturnTemp","CwReturnTemp","CwSupplyTemp","EvpTemp","CondTemp"],paraAnlysMode:"part"},chartConfig:["easy","fixed","recent"],type:"Chiller"},AnlzCluster_Chiller}(),AnlzEnergy=function(){function AnlzEnergy(container,option,screen){AnlzBase.call(this,container,option,screen)}return AnlzEnergy.prototype=new AnlzBase,AnlzEnergy.prototype.optionTemplate={imgName:"anlsEnergy.png",imgColor:"65,131,189",templateName:"analysis.modalType.ENERGY",templateParams:{paraName:["X"],paraAnlysMode:"all"},chartConfig:["easy","fixed","recent"]},AnlzEnergy.prototype.init=function(){AppConfig.datasource.getDSItemData(this,this.screen.curModal.itemDS[0].arrId)},AnlzEnergy.prototype.optionDefault={tooltip:{trigger:"axis"},toolbox:{show:!1,feature:{dataView:{show:!1,readOnly:!0},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!1,dataZoom:{show:!1},grid:{x:70,x2:10,y2:24},xAxis:[{type:"category",splitLine:{show:!1}}],yAxis:[{type:"value",splitArea:{show:!1}}]},AnlzEnergy.prototype.render=function(dataSrc){var _this=this;if(void 0==dataSrc||dataSrc.length<=0||void 0==dataSrc.timeShaft||dataSrc.timeShaft.length<=0)return _this.screen.saveModalJudge.rejectWith(_this.screen,[_this.screen]),void alert("No data");for(var xAxis,arrXAxis=[],len=dataSrc.timeShaft.length,i=0;len>i;i++)arrXAxis.push(dataSrc.timeShaft[i]);xAxis=[{type:"category",data:arrXAxis}];var showColor,dataName=[],arrSeries=[];len=dataSrc.list.length;for(var i=0;len>i;i++){showColor=echarts.config.color[i];var itemName=AppConfig.datasource.getDSItemById(dataSrc.list[i].dsItemId).alias;dataName.push(itemName);for(var defVal,arrData=[],len2=dataSrc.list[i].data.length,j=1;len2>j;j++)defVal=dataSrc.list[i].data[j]-dataSrc.list[i].data[j-1],arrData.push(parseFloat(defVal.toFixed(1)));arrSeries.push({name:dataName[i],type:"bar",data:arrData,markPoint:{data:[{type:"max",name:"最大值"},{type:"min",name:"最小值"}]},itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,5,5]},emphasis:{color:showColor,barBorderRadius:[5,5,5,5]}}})}dataOption={title:{text:"",subtext:""},legend:{data:dataName},dataZoom:{show:!1},grid:{x:70,x2:10,y2:24},xAxis:xAxis,series:arrSeries},_this.chart=echarts.init(_this.paneChart,"macarons").setOption($.extend(!0,{},_this.optionDefault,dataOption))},AnlzEnergy}();