var WorkflowEfficiency=function(){function WorkflowEfficiency(){this.maxNum=10,this.i18=I18n.resource.workflow.efficiency,this.dateRange={beginTime:"",endTime:""}}return WorkflowEfficiency.prototype={show:function(){var _this=this;$.get("/static/views/workflow/efficiency.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($("#workflow-efficiency"))})},close:function(){},init:function(){this.renderGroupEfficiency(),this.attachEvent()},attachEvent:function(){var _this=this;$(".workflow-efficiency-table-footer").click(function(){}),$("#thisMonth, #cumulative, #lastMonth").click(function(){var $this=$(this);if($this.hasClass("btn-success"))return!1;$this.removeClass("btn-default").addClass("btn-success").css("cursor","default").siblings("button").removeClass("btn-success").addClass("btn-default").css("cursor","pointer");var thisMonthBegin,lastMonthBegin,lastMonthEnd,today=new Date;"thisMonth"==$this.attr("id")?(thisMonthBegin=new Date(today.getFullYear(),today.getMonth(),1).format("yyyy-MM-dd"),_this.setDateRange(thisMonthBegin,today.format("yyyy-MM-dd"))):"cumulative"==$this.attr("id")?_this.setDateRange():"lastMonth"==$this.attr("id")&&(lastMonthBegin=new Date(today.getFullYear(),today.getMonth()-1,1).format("yyyy-MM-dd"),lastMonthEnd=new Date(today.getFullYear(),today.getMonth(),0).format("yyyy-MM-dd"),_this.setDateRange(lastMonthBegin,lastMonthEnd)),_this.renderGroupEfficiency()}),$("#divGroupStatics").on("click",".isSeeChart",function(){var $this=$(this),$userStaticsContent=$this.parents(".recordCon").next(".divUserStatics");$userStaticsContent.is(":hidden")?0===$userStaticsContent.children().length?_this.renderMemberEfficiency($userStaticsContent,$this.data("group-id")).done(function(){$this.text(_this.i18.HIDE),$userStaticsContent.slideDown(300)}):($this.text(_this.i18.HIDE),$userStaticsContent.slideDown(300)):($this.text(_this.i18.VIEW),$userStaticsContent.slideUp(300))})},setDateRange:function(beginTime,endTime){this.dateRange.beginTime=beginTime?beginTime:"",this.dateRange.endTime=endTime?endTime:""},renderGroupEfficiency:function(){return Spinner.spin($("#GroupStatics")[0]),WebAPI.post("workflow/groupEfficiency/",{userId:AppConfig.userId,beginTime:this.dateRange.beginTime,endTime:this.dateRange.endTime}).done(function(result){if(result.success){var mainHtml=beopTmpl("efficiencyMainTmpl",{groups:result.data});$("#divGroupStatics").empty().append(mainHtml)}I18n.fillArea($("#workflow-efficiency"))}).always(function(){Spinner.stop()})},handleUserData:function(users){for(var user,maxCount=0,m=0;m<users.length;m++)user=users[m],user.totalCount>maxCount&&(maxCount=user.totalCount);for(var m=0;m<users.length;m++)user=users[m],user.countPercent=(user.totalCount/maxCount*100).toFixed(1);return users=users.sort(function(a,b){return a.totalCount<b.totalCount})},renderMemberEfficiency:function($container,groupId){Spinner.spin($("#GroupStatics")[0]);var _this=this;return WebAPI.post("workflow/memberEfficiency/",{userId:AppConfig.userId,groupId:groupId,beginTime:this.dateRange.beginTime,endTime:this.dateRange.endTime}).done(function(result){if(result.success){var html=beopTmpl("efficiencyMemeberTmpl",{users:_this.handleUserData(result.data)});$container.append(html)}}).always(function(){Spinner.stop()})}},WorkflowEfficiency}(),WorkflowTool=function(){function getStatusText(status){switch(status){case"new":return I18n.resource.workflow.main.NEW;case 1:return I18n.resource.workflow.main.ASSIGNED;case 2:return I18n.resource.workflow.main.DEALING;case 3:return I18n.resource.workflow.main.PAUSED;case 4:return I18n.resource.workflow.main.FINISHED;case 5:return I18n.resource.workflow.main.DELETED}}function translate(text){if(!text)return"";if(text.indexOf("was renamed")>0){var textList=text.split("was renamed"),html="";if(2!=textList.length)return text;for(var m=0;m<textList.length;m++)html+=0===m?"<p>"+textList[m]+"</p><p>"+I18n.resource.workflow.notice.TASK_RENAME+"</p>":"<p>"+textList[m]+"</p>";return html}switch(text){case"edit":return I18n.resource.workflow.notice.TASK_EDIT;case"complete":return I18n.resource.workflow.notice.TASK_FINISH;case"restart":return I18n.resource.workflow.notice.TASK_RESTART;case"start":return I18n.resource.workflow.notice.TASK_START;case"pause":return I18n.resource.workflow.notice.TASK_PAUSE;case"reply":return I18n.resource.workflow.notice.TASK_REPLY;case"new":return I18n.resource.workflow.notice.TASK_CREATE;default:return text}}function updateBadge(count,list){var $badge=$("#paneWorkflow").find('li[screen="mine"]').find(".badge");count?$badge.text(count).data("new-tasks",list):$badge.text("").data("new-tasks","")}function updateNewTaskCount(){AppConfig.userId&&$.get("/workflow/new_task_count/"+AppConfig.userId).done(function(result){try{var r_obj=JSON.parse(result)}catch(e){return!1}var storageNewTask=localStorage.getItem("new_task_"+AppConfig.userId);if(storageNewTask){try{storageNewTask=JSON.parse(storageNewTask)}catch(e){return!1}for(var unreadList=[],n=0,len=r_obj.length;len>n;n++)-1===$.inArray(r_obj[n],storageNewTask)&&unreadList.push(r_obj[n]);updateBadge(unreadList.length,unreadList),localStorage.setItem("new_task_temp_"+AppConfig.userId,result)}else updateBadge(r_obj.length,r_obj)})}function getTemplate(template,selector){templateStorage=templateStorage||{};var promise;promise=templateStorage[template]?templateStorage[template]:templateStorage[template]=$.get(template);var dfd=$.Deferred();return promise.done(function(result){var $result=$(result),$template=$result.find(selector).children(),$return=$template.clone();I18n.fillArea($return),dfd.resolve($return)}),dfd}function getWorkflowTemplate(selector){return getTemplate("/static/views/workflow/template.html",selector)}function inherits(clazz,base){function F(){}var clazzPrototype=clazz.prototype;F.prototype=base.prototype,clazz.prototype=new F;for(var prop in clazzPrototype)clazz.prototype[prop]=clazzPrototype[prop];clazz.constructor=clazz}function getUserName(rawUserName){return rawUserName.indexOf("@")>0?rawUserName.substring(0,rawUserName.indexOf("@")):rawUserName}var templateStorage,pic_path="/static/images/workflow/";return{pic_path:pic_path,getStatusText:getStatusText,updateBadge:updateBadge,updateNewTaskCount:updateNewTaskCount,getWorkflowTemplate:getWorkflowTemplate,inherits:inherits,getUserName:getUserName,translate:translate}}(),WorkflowMain=function(){function render_template(group_info){WorkflowTool.getWorkflowTemplate("#wf-main-gd-block").done(function(template_inner){if(!template_inner)return!1;if(template_inner.find(".media-heading").text(group_info.name).attr("title",group_info.name),group_info.pic){var image=WorkflowTool.pic_path+group_info.pic;template_inner.find(".media-left").empty().append('<img class="wf-project-icon" src="'+image+'">')}template_inner.find(".media-body").append(group_info.description).attr("title",group_info.description),template_inner.find(".glyphicon-stats .icon-row-text").text(group_info.totalCount),template_inner.find(".glyphicon-ok-circle .icon-row-text").text(group_info.finishedCount),template_inner.find(".glyphicon-time .icon-row-text").text(group_info.delayedCount),template_inner.find(".gd").data("group",group_info),$(".gd-row").prepend(template_inner)})}function WorkflowMain(){}return WorkflowMain.prototype={show:function(){var _this=this;$.get("/static/views/workflow/main.html").done(function(resultHtml){$(ElScreenContainer).empty().html(resultHtml),_this.init(),I18n.fillArea($(ElScreenContainer))})},close:function(){},init:function(){Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/init",{user_id:AppConfig.userId}).done(function(result){if(result)try{var result_obj=JSON.parse(result),group_info=result_obj.group_info;group_info&&"string"==typeof group_info&&(group_info=[]);for(var n=0,nLen=group_info.length;nLen>n;n++)render_template(group_info[n])}catch(e){}}).always(function(){Spinner.stop()}),$("#workflow-main").on("click",".new-gd",function(){var $gd=$(this);if($gd.find(".media-body.edit").size()>0)return!1;$gd.find(".media-body").hide();var edit_media_body=$('<div class="media-body edit"><h3 class="media-heading"><textarea class="gd-edit-textarea title" placeholder="'+I18n.resource.workflow.main.ADD+' " maxlength="255"></textarea></h3><textarea class="gd-edit-textarea desc" placeholder="'+I18n.resource.workflow.main.ALARM_CONTENT+' " maxlength="255"></textarea></div>');edit_media_body.append('<div class="gd-operator-btns"><button type="button" class="pull-right btn btn-success edit-btn edit-btn-save"><span i18n="workflow.main.SAVE"></span></button><button type="button" class="pull-right btn btn-default edit-btn edit-btn-cancel"><span i18n="workflow.main.CANCEL"></span></button></div>'),$gd.find(".media").append(edit_media_body),I18n.fillArea($gd)}).on("click",".edit-btn-cancel",function(){var content_row=$(this).closest(".content-row");return content_row.find(".media-body.edit").remove().end().find(".media-body").show(),!1}).on("click",".edit-btn-save",function(){var media_body=$(this).closest(".media-body"),title=media_body.find(".title").val().trim(),desc=media_body.find(".desc").val().trim();if(!title){var alert=new Alert(".new-gd","danger",I18n.resource.workflow.main.NAME_NOT_NULL).show();return setTimeout(function(){alert.close()},2e3),!1}return Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/group/add/",{userId:AppConfig.userId,name:title,description:desc}).done(function(result){if(!result)return!1;try{var result_obj=JSON.parse(result)}catch(e){return!1}render_template({id:result_obj.id,name:title,description:desc,totalCount:0,finishedCount:0,delayedCount:0,pic:result_obj.pic});var content_row=media_body.closest(".content-row");return content_row.find(".media-body.edit").remove().end().find(".media-body").show(),!1}).always(function(){Spinner.stop()}),!1}).on("click",".gd:not(.new-gd)",function(){var group=$(this).data("group");ScreenCurrent.close(),ScreenCurrent=new workflowTransaction(group),ScreenCurrent.show()})}},WorkflowMain}();$(function(){function FetchMembers(){return _fetchMemberPromise||(_fetchMemberPromise=WebAPI.get("/getTransactionGroupUser")),_fetchMemberPromise}function FetchGroups(){return _fetchGroupPromise||(_fetchGroupPromise=WebAPI.get("workflow/getTransactionGroup/"+AppConfig.userId)),_fetchGroupPromise}var _fetchMemberPromise,_fetchGroupPromise;$(ElScreenContainer).on("click.filter-toggle",".member-filter-dialog-icon",function(ele){$(".filter-dialog-icon").siblings(".mini-dialog").removeClass("open");var $this=$(this),mini_dialog=$this.siblings(".mini-dialog");mini_dialog.toggleClass("open"),mini_dialog.hasClass("open")&&!mini_dialog.attr("done")&&(Spinner.spin(mini_dialog[0]),FetchMembers().done(function(result){try{result=JSON.parse(result)}catch(e){return}for(var group_section=mini_dialog.find(".groups").find(".content"),memeber_section=mini_dialog.find(".members"),gInd=0,gLen=result.length;gLen>gInd;gInd++){var group=result[gInd],members=group.mem;group_section.append('<a class="btn btn-info group-btn" data-id="'+group.id+'">'+group.nm+"</a>");for(var mInd=0,mLen=members.length;mLen>mInd;mInd++){var member=members[mInd];memeber_section.append('<a class="btn btn-info member-btn" data-id="'+member.id+'" data-group="'+group.id+'">'+member.nm+"</a>")}}mini_dialog.attr("done",!0)}).always(function(){Spinner.stop()}))}).on("click.filter-toggle",".group-filter-dialog-icon",function(ele){$(".filter-dialog-icon").siblings(".mini-dialog").removeClass("open");var $this=$(this),mini_dialog=$this.siblings(".mini-dialog");mini_dialog.toggleClass("open"),mini_dialog.hasClass("open")&&!mini_dialog.attr("done")&&(Spinner.spin(mini_dialog[0]),FetchGroups().done(function(result){var groups=[];result.success&&(groups=result.data);var $groups=mini_dialog.find(".groups").find(".content");$groups.append('<a class="btn btn-info task-btn">'+I18n.resource.workflow.main.ALL+"</a>");for(var n=0,nlen=groups.length;nlen>n;n++)$groups.append('<a class="btn btn-info task-btn" data-id="'+groups[n].id+'">'+groups[n].name+"</a>");mini_dialog.attr("done",!0)}).always(function(){Spinner.stop()}))}).on("click.row-toggle",".row-toggle-icon",function(ele){var openIconClass="glyphicon-circle-arrow-down",closeIconClas="glyphicon-circle-arrow-up",$this=$(this),$toggle=$this.parent().siblings().filter(".toggle-enable").toggleClass("hidden");$toggle.hasClass("hidden")?$this.removeClass(openIconClass).addClass(closeIconClas):$this.removeClass(closeIconClas).addClass(openIconClass)}).on("click.group-btn",".group-btn",function(){var group_btn=$(this),id=group_btn.data("id"),mini_dialog=group_btn.closest(".mini-dialog");mini_dialog.find(".group-btn").removeClass("active"),group_btn.addClass("active"),mini_dialog.find(".members").children(".member-btn").addClass("disabled").filter("[data-group="+id+"]").removeClass("disabled")}).on("click.all-member","#all-member-btn",function(){$(this).closest(".mini-dialog").find(".group-btn").removeClass("active").end().find(".member-btn").removeClass("disabled")}).on("click.notice_filter",".member-btn",function(e){var $this=$(this),memberId=$this.data("id");$this.closest(".filter-body").find(".filter-result").text($this.text()),memberId||(memberId=-1),ScreenCurrent instanceof WorkflowReport?ScreenCurrent.updateSelUser(memberId):ScreenCurrent instanceof WorkflowNotice&&ScreenCurrent.updateNoticeContent(memberId)}).on("click.notice_filter",".task-btn",function(e){var $this=$(this),id=$this.data("id");$this.closest(".filter-body").find(".filter-result").text($this.text()),id||(id=-1),ScreenCurrent instanceof WorkflowReport?ScreenCurrent.updateSelPrj(id):ScreenCurrent instanceof WorkflowTeam&&ScreenCurrent.loadPage(id)})}),$(document).on("click.wf.mini-dialog",function(ent){var $target=$(ent.target);$target.hasClass("filter-dialog-icon")||$(ent.target).closest(".mini-dialog").length||$(".mini-dialog").is(":visible")&&$(".mini-dialog").removeClass("open")});var WorkflowMine=function(){function getStatusText(status){switch(I18n.fillArea($("span")),status){case 0:return I18n.resource.workflow.mine.TASK_STATUS_NEW;case 1:return I18n.resource.workflow.mine.TASK_STATUS_DISTRIBUTED;case 2:return I18n.resource.workflow.mine.TASK_STATUS_PROCESSING;case 3:return I18n.resource.workflow.mine.TASK_STATUS_PAUSED;case 4:return I18n.resource.workflow.mine.TASK_STATUS_COMPLETED}}function _GroupArray(prop,array){for(var group={},n=0,nlen=array.length;nlen>n;n++){var item=array[n],groupItem=group[item[prop]];groupItem?groupItem.push(item):group[item[prop]]=[item]}return group}function WorkflowMine(){this.i18=I18n.resource.workflow.urgencyLevel,this.i18n=I18n.resource.workflow.main,this.i18urgencyLevelArr=["workflow.urgencyLevel.0","workflow.urgencyLevel.1","workflow.urgencyLevel.2"]}var profilePromise,memberListPromise={};return WorkflowMine.prototype={show:function(){var _this=this;$.get("/static/views/workflow/mine.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($("#workflow-mine"))})},close:function(){},check_empty_tasks:function(){var new_tasks=$(".new-task-row .task-items"),urgent_tasks=$(".urgent-task-row .task-items"),pend_tasks=$(".pend-task-row .task-items");0===new_tasks.find(".task-item").length?new_tasks.find(".empty-message").show():new_tasks.find(".empty-message").hide(),0===urgent_tasks.find(".task-item").length?urgent_tasks.find(".empty-message").show():urgent_tasks.find(".empty-message").hide(),0===pend_tasks.find(".task-item").length?pend_tasks.find(".empty-message").show():pend_tasks.find(".empty-message").hide()},refresh_tasks:function(){var _this=this;return Spinner.spin($(".workflow-container")[0]),WorkflowTool.getWorkflowTemplate("#wf-mine-tasks").pipe(function(template){return $.get("/workflow/transaction/notCompleted/"+AppConfig.userId).done(function(result){try{var result_json=JSON.parse(result)}catch(e){return}for(var new_tasks=$(".new-task-row .task-items").find(".task-item").remove().end(),urgent_tasks=$(".urgent-task-row .task-items").find(".task-item").remove().end(),pend_tasks=$(".pend-task-row .task-items").find(".task-item").remove().end(),n=0,nlen=result_json.length;nlen>n;n++){var item=result_json[n],temp=template.clone();switch(temp.attr("task-id",item.id),temp.find(".task-title").html('<span class="taskNoWrapper"><em i18n="workflow.common.NUMBER"></em><em class="taskNo">'+item.id+'</em></span>：<span class="taskTxt">'+item.title+"</span>").attr("title",I18n.resource.workflow.common.NUMBER+item.id+":"+item.title),temp.find(".date").text(item.dueDate?new Date(item.dueDate).format("yyyy-MM-dd"):"").attr("title","deadline"),temp.find(".timer").children("span").removeClass().addClass("glyphicon ic"+item.critical).attr("i18n","title="+_this.i18urgencyLevelArr[item.critical]),temp.find(".alert-type").text(item.groupNm).attr("title",item.groupNm),2===item.statusId?temp.find(".play-pause").addClass("glyphicon-pause").attr("i18n","title=workflow.main.PAUSE"):temp.find(".play-pause").addClass("glyphicon-play").attr("i18n","title=workflow.main.START"),temp.find(".status").html(getStatusText(item.statusId)),temp.data("task",item),item.priority){case 5:new_tasks.append(temp);break;case 6:urgent_tasks.append(temp);break;case 4:pend_tasks.append(temp)}}_this.check_empty_tasks();var currentNewTask=localStorage.getItem("new_task_temp_"+AppConfig.userId),newTask=$("#ulPages").find('li[screen="mine"]').find(".badge").data("new-tasks");if(newTask){var new_task_row=$(".new-task-row").find(".task-items");new_task_row.css({border:"1px dotted #666",backgroundColor:"antiquewhite"}),setTimeout(function(){new_task_row.css({border:"none",backgroundColor:"white"})},1e3)}localStorage.setItem("new_task_"+AppConfig.userId,currentNewTask),WorkflowTool.updateBadge(0)}).done(function(){}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})})},refresh_categories:function(){var _this=this;return Spinner.spin($(".workflow-container")[0]),$.when(WorkflowTool.getWorkflowTemplate("#wf-mine-tasks"),WorkflowTool.getWorkflowTemplate("#wf-mine-tasks-complete")).done(function(tasks_template,completed_template){return WebAPI.get("/workflow/transaction/getAll/"+AppConfig.userId).done(function(result){if(!result)return!1;try{var result_obj=JSON.parse(result)}catch(e){return void console.error(e)}$(".categories-container").children().remove();var groupedResult=_GroupArray("groupName",result_obj),inner_template=completed_template.clone(),completedTaskItemTemplate=inner_template.find(".task-item"),uncompletedTaskItemTemplate=tasks_template.clone();inner_template.find(".task-item").remove();for(var groupNm in groupedResult){var template=inner_template.clone(),groups=groupedResult[groupNm];template.find(".task-type").text(groupNm);for(var n=0,nlen=groups.length;nlen>n;n++){var group=groups[n];if(4===group.statusId){var taskItem=completedTaskItemTemplate.clone();taskItem.find(".glyphicon-ok").attr("i18n","title=workflow.main.FINISHED"),taskItem.find(".task-title").html('<span class="taskNoWrapper"><em i18n="workflow.common.NUMBER"></em><em class="taskNo">'+group.id+'</em></span>：<span class="taskTxt">'+group.title+"</span>").attr("title",I18n.resource.workflow.common.NUMBER+group.id+":"+group.title),taskItem.find(".date").text(group.completeTime?new Date(group.completeTime).format("yyyy-MM-dd"):"").attr("title","resolved date"),taskItem.data("task",group)}else{var taskItem=uncompletedTaskItemTemplate.clone();taskItem.find(".task-title").html('<span class="taskNoWrapper"><em i18n="workflow.common.NUMBER"></em><em class="taskNo">'+group.id+'</em></span>：<span class="taskTxt">'+group.title+"</span>").attr("title",I18n.resource.workflow.common.NUMBER+group.id+":"+group.title),taskItem.find(".date").text(group.dueDate?new Date(group.dueDate).format("yyyy-MM-dd"):"").attr("title","deadline"),2===group.statusId?taskItem.find(".play-pause").addClass("glyphicon-pause").attr("i18n","title=workflow.main.PAUSE"):taskItem.find(".play-pause").addClass("glyphicon-play").attr("i18n","title=workflow.main.START"),taskItem.find(".status").html(getStatusText(group.statusId)),taskItem.data("task",group)}taskItem.find(".timer").children("span").removeClass().addClass("glyphicon ic"+group.critical).attr("i18n","title="+_this.i18urgencyLevelArr[group.critical]),template.find(".task-items").append(taskItem)}$(".categories-container").append(template)}}).always(function(){Spinner.stop(),I18n.fillArea($(ElScreenContainer))})})},refresh_mine:function(){var _this=this;return Spinner.spin($(".workflow-container")[0]),WorkflowTool.getWorkflowTemplate("#wf-mine-mines").then(function(template,completed_template){return WebAPI.post("/workflow/myCreated/",{userId:AppConfig.userId}).done(function(result){if(result.success){for(var new_tasks=$(".new-task-row .task-items").find(".task-item").remove().end(),createDateArr=($(".urgent-task-row .task-items").find(".task-item").remove().end(),$(".pend-task-row .task-items").find(".task-item").remove().end(),[]),dueDateArr=[],workflowNamArr=[],n=0,nlen=result.data.length;nlen>n;n++){var item=result.data[n],temp=template.clone();temp.attr("task-id",item.id),temp.attr("executor-id",item.executorID),temp.attr("status-id",item.statusId),temp.find(".task-title").html('<span class="taskNoWrapper"><em i18n="workflow.common.NUMBER"></em><em class="taskNo">'+item.id+'</em></span>：<span class="taskTxt">'+item.title+"</span>").attr("title",I18n.resource.workflow.common.NUMBER+item.id+":"+item.title),temp.find(".date").text(item.dueDate?new Date(item.dueDate).format("yyyy-MM-dd"):"").attr("title","deadline"),temp.find(".create-date").text(item.dueDate?new Date(item.createTime).format("yyyy-MM-dd"):""),temp.find(".executor-person").text(item.executorName),temp.find(".timer").children("span").removeClass().addClass("glyphicon ic"+item.critical).attr("i18n","title="+_this.i18urgencyLevelArr[item.critical]),temp.find(".alert-type").text(item.groupName).attr("title",item.groupName),4===item.statusId?temp.find(".glyphiconWrapper").empty().html('<span class="glyphicon glyphicon-repeat" i18n="title=workflow.main.FINISH"></span>'):2===item.statusId?temp.find(".play-pause").addClass("glyphicon-pause").attr("i18n","title=workflow.main.PAUSE"):temp.find(".play-pause").addClass("glyphicon-play").attr("i18n","title=workflow.main.START"),temp.find(".status").html(getStatusText(item.statusId)),temp.data("task",item),createDateArr.push(item.dueDate?new Date(item.createTime).format("yyyy-MM-dd"):""),dueDateArr.push(item.dueDate?new Date(item.dueDate).format("yyyy-MM-dd"):""),workflowNamArr.push(item.groupName),new_tasks.append(temp)}_this.check_empty_tasks(),$.each($(".task-item"),function(index,item){var $item=$(item),creatorID=$item.attr("executor-id");creatorID!=AppConfig.userId&&$item.find(".operator .glyphicon").hide()}),createDateArr.sort(),dueDateArr.sort(),workflowNamArr.sort(),$.unique(createDateArr),$.unique(dueDateArr),$.unique(workflowNamArr),$("#selectCreateDate").html('<li class="selectAll" i18n="workflow.mine.ALL_ORDER"></li>'),$("#selectDueDate").html('<li class="selectAll" i18n="workflow.mine.ALL_ORDER"></li>'),$("#selectWorkflowName").html('<li class="selectAll" i18n="workflow.mine.ALL_ORDER"></li>');for(var i=0;i<createDateArr.length;i++)$("#selectCreateDate").append("<li>"+createDateArr[i]+"</li>");for(var i=0;i<dueDateArr.length;i++)$("#selectDueDate").append("<li>"+dueDateArr[i]+"</li>");for(var i=0;i<workflowNamArr.length;i++)$("#selectWorkflowName").append("<li>"+workflowNamArr[i]+"</li>")}}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})})},refresh_completed:function(){return Spinner.spin($(".workflow-container")[0]),WorkflowTool.getWorkflowTemplate("#wf-mine-tasks-complete").pipe(function(completed_template){return WebAPI.get("/workflow/transaction/completed/"+AppConfig.userId).done(function(result){if(!result)return!1;try{var result_obj=JSON.parse(result)}catch(e){return void console.error(e)}$(".completed-container").children().remove();var groupedResult=_GroupArray("groupName",result_obj),inner_completed_template=completed_template.clone(),taskItemTemplate=inner_completed_template.find(".task-item");inner_completed_template.find(".task-item").remove();for(var groupNm in groupedResult){var template=inner_completed_template.clone(),groups=groupedResult[groupNm];template.find(".task-type").text(groupNm);for(var n=0,nlen=groups.length;nlen>n;n++){var group=groups[n],taskItem=taskItemTemplate.clone();taskItem.find(".task-title").html('<span class="taskNoWrapper"><em i18n="workflow.common.NUMBER"></em><em class="taskNo">'+group.id+'</em></span>：<span class="taskTxt">'+group.title+"</span>").attr("title",I18n.resource.workflow.common.NUMBER+group.id+":"+group.title),taskItem.find(".date").text(group.completeTime?new Date(group.completeTime).format("yyyy-MM-dd"):"").attr("title","resolved date"),taskItem.data("task",group),template.find(".task-items").append(taskItem)}$(".completed-container").append(template)}}).always(function(){Spinner.stop()})})},refresh_starred:function(){var _this=this;return Spinner.spin($(".workflow-container")[0]),$.when(WorkflowTool.getWorkflowTemplate("#wf-mine-tasks"),WorkflowTool.getWorkflowTemplate("#wf-mine-tasks-complete")).done(function(tasks_template,completed_template){return WebAPI.get("/workflow/transaction/starred/"+AppConfig.userId).done(function(result){if(!result)return!1;try{var result_obj=JSON.parse(result)}catch(e){return void console.error(e)}$(".starreds-container").children().remove();var groupedResult=_GroupArray("groupName",result_obj),inner_template=completed_template.clone(),completedTaskItemTemplate=inner_template.find(".task-item"),uncompletedTaskItemTemplate=tasks_template.clone();inner_template.find(".task-item").remove();for(var groupNm in groupedResult){var template=inner_template.clone(),groups=groupedResult[groupNm];template.find(".task-type").text(groupNm);for(var n=0,nlen=groups.length;nlen>n;n++){var group=groups[n];if(4===group.statusId){var taskItem=completedTaskItemTemplate.clone();taskItem.find(".glyphicon-ok").attr("i18n","title=workflow.main.FINISHED"),taskItem.find(".task-title").html('<span class="taskNoWrapper"><em i18n="workflow.common.NUMBER"></em><em class="taskNo">'+group.id+'</em></span>：<span class="taskTxt">'+group.title+"</span>").attr("title",I18n.resource.workflow.common.NUMBER+group.id+":"+group.title),taskItem.find(".date").text(group.completeTime?new Date(group.completeTime).format("yyyy-MM-dd"):"").attr("title","resolved date"),taskItem.data("task",group)}else{var taskItem=uncompletedTaskItemTemplate.clone();taskItem.find(".task-title").html('<span class="taskNoWrapper"><em i18n="workflow.common.NUMBER"></em><em class="taskNo">'+group.id+'</em></span>：<span class="taskTxt">'+group.title+"</span>").attr("title",I18n.resource.workflow.common.NUMBER+group.id+":"+group.title),taskItem.find(".date").text(group.dueDate?new Date(group.dueDate).format("yyyy-MM-dd"):"").attr("title","deadline"),2===group.statusId?taskItem.find(".play-pause").addClass("glyphicon-pause").attr("i18n","title=workflow.main.PAUSE"):taskItem.find(".play-pause").addClass("glyphicon-play").attr("i18n","title=workflow.main.START"),taskItem.find(".timer").children("span").removeClass().addClass("glyphicon ic"+group.critical).attr("i18n","title="+_this.i18urgencyLevelArr[group.critical]),taskItem.find(".status").html(getStatusText(group.statusId)),taskItem.data("task",group)}template.find(".task-items").append(taskItem)}$(".starreds-container").append(template)}}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})})},screeningItem:function($obj,str,num){if($obj.hasClass("selectAll"))return void $(".task-item").show();var text=$obj.text();if(num){var urgencyClass=$obj.attr("urgencyClass");$(".task-item").hide(),$(".task-item ."+urgencyClass).closest(".task-item").show()}else $.each($(".mine ."+str),function(index,item){var $item=$(item),itemStatus=$item.text();text!==itemStatus?$item.closest(".task-item").hide():$item.closest(".task-item").show()})},init:function(){profilePromise||(profilePromise=$.get("/workflow/profile/"+AppConfig.userId)),profilePromise.done(function(result){var jResult=JSON.parse(result);$(".mine-avatar-name").text(jResult.userfullname?jResult.userfullname:jResult.username),$(".mine-avatar-desc").text(jResult.useremail?jResult.useremail:""),$(".avatar-icon").attr("src",jResult.userpic)}),$(".screen-row").hide(),$(".tasks").show(),this.refresh_tasks();var _this=this;$("#workflow-mine").on("click",".glyphicon-ok-sign",function(){var taskitem=$(this).closest(".task-item"),task=taskitem.data("task");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/complete/",{trans_id:task.id,user_id:AppConfig.userId}).done(function(result){"success"===result&&taskitem.remove()}).always(function(){Spinner.stop()})}).on("click",".glyphicon-pause",function(){var taskitem=$(this).closest(".task-item"),task=taskitem.data("task");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/pause/",{trans_id:task.id,user_id:AppConfig.userId}).done(function(result){"success"===result&&(taskitem.find(".status").html(getStatusText(3)).end().find(".glyphicon-pause").removeClass("glyphicon-pause").addClass("glyphicon-play").attr("i18n","title=workflow.main.START"),taskitem.attr("status-id","")),I18n.fillArea($(ElScreenContainer))}).always(function(){Spinner.stop()})}).on("click",".glyphicon-play",function(){var taskitem=$(this).closest(".task-item"),task=taskitem.data("task");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/start/",{trans_id:task.id,user_id:AppConfig.userId}).done(function(result){"success"===result&&(taskitem.find(".status").html(getStatusText(2)).end().find(".glyphicon-play").removeClass("glyphicon-play").addClass("glyphicon-pause").attr("i18n","title=workflow.main.PAUSE"),taskitem.attr("status-id","2"))}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})}).on("click",".glyphicon-edit",function(){var ownId=AppConfig.userId,task=$(this).parents(".task-item"),task_body=(task.attr("task-id"),$(this).closest(".task-body")),groupid=task.data("task").groupId;if(task_body.hasClass("editing"))return!1;task_body.addClass("editing");var title_div=task_body.find(".task-title"),title=title_div.find(".taskTxt").text(),taskTxt=title_div.find(".taskTxt").text();title_div.data("title",title),title_div.find(".taskTxt").empty(),title_div.find(".taskTxt").append('<textarea class="edit-textarea">'+taskTxt+"</textarea>");var memPromise=memberListPromise[groupid];memPromise||(memPromise=WebAPI.get("/workflow/getTransactionGroupMembers/"+groupid),memberListPromise[groupid]=memPromise),Spinner.spin(task[0]),memPromise.done(function(result){var btnObj='<button type="button" class="pull-right btn btn-success edit-btn edit-btn-save" i18n="workflow.main.SAVE"></button><button type="button" class="pull-right btn btn-default edit-btn edit-btn-cancel" i18n="workflow.main.CANCEL"></button>';title_div.append(btnObj);for(var selectArr=JSON.parse(result),html='<select class="pull-right" style="width:120px;height:30px;position:relative;top:6px;left:-2px;"><option disabled i18n="workflow.main.ASSIGN_AGAIN"></option>',selectArrL=selectArr.length,i=0;selectArrL>i;i++){var selectObj=selectArr[i],selectId=selectObj.id,selectName=selectObj.name;html+=selectId!=ownId?'<option value="'+selectId+'">'+selectName+"</option>":'<option value="'+selectId+'" selected>'+selectName+"</option>"}html+="</select>",title_div.append(html)}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})}).on("click","#ckeck_completed",function(){$(".screen-row").hide(),_this.refresh_completed().done(function(){$(".completed").show(),$(".member-nav").find("li.active").removeClass("active"),I18n.fillArea($("span"))})}).on("click",".btn-tasks",function(){$(".screen-row").hide();var $this=$(this);_this.refresh_tasks().done(function(){$(".tasks").show(),$this.closest(".member-nav").find("li.active").removeClass("active").end().end().closest("li").addClass("active"),
I18n.fillArea($("span"))})}).on("click",".btn-starreds",function(){$(".screen-row").hide();var $this=$(this);_this.refresh_starred().done(function(){$(".starreds").show(),$this.closest(".member-nav").find("li.active").removeClass("active").end().end().closest("li").addClass("active"),I18n.fillArea($("span"))})}).on("click",".btn-cates",function(){$(".screen-row").hide();var $this=$(this);_this.refresh_categories().done(function(){$(".categories").show(),$this.closest(".member-nav").find("li.active").removeClass("active").end().end().closest("li").addClass("active"),I18n.fillArea($("span"))})}).on("click",".btn-mine",function(){$(".screen-row").hide();var $this=$(this);_this.refresh_mine().done(function(){$(".mine").show(),$this.closest(".member-nav").find("li.active").removeClass("active").end().end().closest("li").addClass("active"),I18n.fillArea($("span"))})}).on("click",".glyphicon-repeat",function(){var taskitem=$(this).closest(".task-item"),task=taskitem.data("task");Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/restart/",{trans_id:task.id,user_id:AppConfig.userId}).done(function(result){"success"===result&&taskitem.remove()}).always(function(){Spinner.stop()})}).on("click",".edit-btn-cancel",function(e){var taskTitle_div=$(this).closest(".task-title"),title=taskTitle_div.data("title");taskTitle_div.find("button").remove(),taskTitle_div.find(".pull-right").remove(),taskTitle_div.find(".taskTxt").html(title),taskTitle_div.closest(".task-body").removeClass("editing"),e.stopPropagation()}).on("click",".edit-btn-save",function(e){Spinner.spin($(".workflow-container")[0]);var taskIdObj=$(this).parents(".task-item"),taskTitle_div=$(this).closest(".task-title"),title=$(this).siblings(".taskTxt").find(".edit-textarea").val(),task_item=$(this).closest(".task-item"),taskData=task_item.data("task"),select=$(this).siblings("select"),selectVal=select.val(),data={title:title,transId:taskData.id,userId:AppConfig.userId,executorID:selectVal};WebAPI.post("/workflow/transaction/edit",data).done(function(result){"deassign"===result?taskIdObj.remove():"success"===result&&(taskTitle_div.find("button").remove(),taskTitle_div.find(".pull-right").remove(),taskTitle_div.find(".taskTxt").html(title),task_item.find(".task-body").removeClass("editing"))}).always(function(){Spinner.stop()}),e.stopPropagation()}).on("click",".task-title",function(){if($(this).closest(".task-body").hasClass("editing"))return!1;var id=$(this).closest(".task-item").data("task").id;new workflowNoticeDetail(id,I18n.resource.workflow.pageInfo.TITLE_WO_MY,$(ElScreenContainer).children().detach()).show()}).on("click","#selectUrgency li",function(){_this.screeningItem($(this),$(this).attr("urgencyClass"),1)}).on("click","#selectStatus li",function(){_this.screeningItem($(this),"status")}).on("click","#selectCreateDate li",function(){_this.screeningItem($(this),"create-date")}).on("click","#selectDueDate li",function(){_this.screeningItem($(this),"date")}).on("click","#selectWorkflowName li",function(){_this.screeningItem($(this),"alert-type")}),I18n.fillArea($(ElScreenContainer))}},WorkflowMine}(),WorkflowNotice=function(){function render_template(notice){WorkflowTool.getWorkflowTemplate("#wf-notice-latest-info").done(function(template){template.find(".avatar-icon").attr("src",notice.userpic),template.find(".avatar-name").text(notice.userName),template.find(".info-date-row .date").text(notice.opTime),template.find(".latest-info-title").html(WorkflowTool.translate(notice.title)),template.find(".notice-item").html(WorkflowTool.translate(notice.detail)),template.find(".notice-item").attr("href","#/notice/"+notice.linkToTransactionId).attr("data-id",notice.linkToTransactionId),$("#operations").append(template)})}function WorkflowNotice(id){this.id=id}var rownumber=0,userID=AppConfig.userId;return WorkflowNotice.prototype={show:function(){var _this=this;$.get("/static/views/workflow/notice.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($("#notice-container"))})},close:function(){rownumber=0,userID=AppConfig.userId},init:function(){var _this=this;_this.clearNoticeContent(),$("#more").click(function(){rownumber+=1,Spinner.spin($(".workflow-container")[0]),WebAPI.get("/getTransactionOperationRecordByUserId/"+(userID?userID:AppConfig.userId)+"/"+rownumber).done(function(result){_this.initNoticeContent(JSON.parse(result))}).always(function(){Spinner.stop()})}),Spinner.spin($(".workflow-container")[0]),WebAPI.get("/getTransactionOperationRecordByUserId/"+(userID?userID:AppConfig.userId)+"/"+rownumber).done(function(result){_this.initNoticeContent(JSON.parse(result))}).always(function(){Spinner.stop()}),$("#notice-container").on("click",".notice-item",function(){try{if(Path&&!Path.version)return!0}catch(e){return ScreenCurrent.close(),ScreenCurrent=new workflowNoticeDetail($(this).data("id"),I18n.resource.workflow.notice.TITLE_WO_DYNAMIC),ScreenCurrent.show(),!1}})},initNoticeContent:function(notices){this.clearNoticeContent();var paneSelector=$("#operations");notices&&notices.length?paneSelector.find(".latest-info-description").remove():paneSelector.append("<div class='latest-info-description'>"+I18n.resource.workflow.notice.NO_FOUND+"</div>");for(var i=0;i<notices.length;i++){var notice=notices[i];render_template(notice)}},clearNoticeContent:function(){$("#operations").html("")},updateNoticeContent:function(userid){var _this=this;userID=userid,rownumber=0,Spinner.spin($(".workflow-container")[0]),WebAPI.get("/getTransactionOperationRecordByUserId/"+userID+"/"+rownumber).done(function(result){_this.clearNoticeContent(),_this.initNoticeContent(JSON.parse(result))}).always(function(){Spinner.stop()})}},WorkflowNotice}(),workflowNoticeDetail=function(){function workflowNoticeDetail(id,backTitle,backContent){this.id=id,this.backTitle=backTitle,this.backContent=backContent,null===i18&&(i18=I18n.resource.workflow.main),this.model=null}var memberListPromise={},i18=null;return workflowNoticeDetail.prototype={show:function(){var _this=this;$.get("/static/views/workflow/notice_detail.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($(ElScreenContainer)),$("#notDetDeadline").attr("title",I18n.resource.workflow.notice.DEADLINE)})},close:function(){window.onresize=null},setBackTitle:function(title){$(".backTitle").text(title?title:I18n.resource.workflow.notice.BACK)},renderChart:function(record){var arrXAxis,list_description=record.list_description,list_value=record.list_value;if(list_description.length==list_value.length){record.list_time.length>0&&(arrXAxis=record.list_time[0].split(","));for(var arrSeriesTemp=[],i=0;i<list_value.length;i++){var arrDatas=[];if(8>i){var item=list_value[i];if(item)for(var strDatas=item.split(","),j=0;j<strDatas.length;++j)arrDatas.push(parseFloat(strDatas[j]).toFixed(1));arrSeriesTemp.push({name:list_description[i],type:"line",itemStyle:{normal:{lineStyle:{type:"solid"}}},data:arrDatas})}}var option={title:{text:I18n.resource.workflow.notice.FAULT_CURVE,x:"left"},tooltip:{trigger:"axis",formatter:function(params){var strResult;if(params[0].name.length>0){strResult=params[0].name+"<br/>";for(var i=0;i<params.length;++i)strResult+=params[i].seriesName+" : "+params[i].value,i!=params.length-1&&(strResult+="<br/>")}return strResult}},legend:{data:list_description,x:"center"},toolbox:{show:!0},dataZoom:{show:!0,realtime:!0,start:0,end:100},xAxis:[{name:"",type:"category",boundaryGap:!1,axisLine:{onZero:!1},data:arrXAxis}],yAxis:[{name:"",type:"value"}],series:arrSeriesTemp,showLoading:{text:"loading",effect:"spin"}},myChart=echarts.init($("#error_line").get(0));myChart.setOption(option),window.onresize=myChart.resize}},refreshPage:function(){Spinner.spin($(".workflow-container")[0]);var _this=this;WebAPI.get("/workflow/transaction/notice/"+AppConfig.userId+"/"+this.id).done(function(result){return result.success?(_this.model=result,_this.model.criticalMap={0:I18n.resource.workflow.urgencyLevel[0],1:I18n.resource.workflow.urgencyLevel[1],2:I18n.resource.workflow.urgencyLevel[2]},$("#workInfo").empty().replaceWith(beopTmpl("recordDetailTmpl",_this.model)),_this.model.record_detail&&_this.model.record_detail.list_value&&_this.model.record_detail.list_value.length&&($(".breakdown-row").show(),_this.renderChart(_this.model.record_detail)),_this.refreshOperations(),_this.refreshReply(),void _this.renderStatus()):!1}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})},refreshReply:function(){this.model.replyList&&$("#reply-content").empty().append(beopTmpl("replyContentTmpl",this.model))},refreshOperations:function(){this.model.operations&&this.model.operations.length&&$("#workOrderHistoryUl").html(beopTmpl("workOrderHistoryUlTmpl",this.model))},addReply:function(detail){var _this=this;Spinner.spin($(".workflow-container")[0]);var replyTime=(new Date).format("yyyy-MM-dd HH:mm:ss");return WebAPI.post("/workflow/transaction/insert_reply/",{ofTransactionId:this.id,replyUserId:AppConfig.userId,replyTime:replyTime,detail:detail}).done(function(result){result&&(_this.model.replyList||(_this.model.replyList=[]),_this.model.replyList.push({replyTime:replyTime,detail:detail,userfullname:AppConfig.userProfile.fullname,userpic:AppConfig.userProfile.picture}),_this.refreshReply())}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})},renderMemberList:function(){var memPromise,$workInfo=$("#workInfo"),$assignSelect=$("#assignSelect"),groupId=this.model.record_detail.groupid,executorId=this.model.record_detail.executorId;memPromise=memberListPromise[groupId],memPromise||(memPromise=WebAPI.get("/workflow/getTransactionGroupMembers/"+groupId),memberListPromise[groupId]=memPromise),Spinner.spin($workInfo[0]),memPromise.done(function(result){for(var memberList=JSON.parse(result),memberOptionsHtml='<option disabled i18n="workflow.main.ASSIGN_AGAIN"></option>',i=0;i<memberList.length;i++)memberOptionsHtml+=executorId==memberList[i].id?'<option value="'+memberList[i].id+'" selected>'+memberList[i].name+"</option>":'<option value="'+memberList[i].id+'">'+memberList[i].name+"</option>";$assignSelect.empty().append(memberOptionsHtml)}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})},renderStatus:function(){$("#taskStatus").replaceWith(beopTmpl("taskStatusTmpl",this.model.record_detail))},changeStatus:function(url,status,callback){var _this=this;Spinner.spin($(".workflow-container")[0]),WebAPI.post(url,{trans_id:this.id,user_id:AppConfig.userId}).done(function(result){"success"===result&&(callback&&callback.call(_this,status),(null!=status||void 0!=status)&&(_this.model.record_detail.statusId=status),_this.renderStatus())}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})},resetEditing:function(){var $detailEditor=$("#detail-editor"),$titleEditor=$("#title-editor");$titleEditor.val(this.model.record_detail.title),$detailEditor.val(this.model.record_detail.detail),$("#changeDate").attr("value",this.model.record_detail.due_date).datetimepicker({minView:"month",autoclose:!0,todayBtn:!0,format:"yyyy-mm-dd"})},getSaveModel:function(){return{title:$("#title-editor").val(),transId:this.id,userId:AppConfig.userId,detail:$("#detail-editor").val(),executorID:$("#assignSelect option:selected").val(),critical:$("#criticalSelect option:selected").val(),dueDate:$("#changeDate").val()}},updateViewModel:function(){var newModel=this.getSaveModel();this.model.record_detail.title=newModel.title,this.model.record_detail.detail=newModel.detail,this.model.record_detail.executorId=newModel.executorID,this.model.record_detail.critical=newModel.critical,this.model.record_detail.due_date=newModel.dueDate},showEditperface:function(str){var $workInfo=$("#workInfo");"show"==str?($workInfo.find(".info").removeClass("edit-no-info").addClass("edit-info"),$workInfo.find(".infoNo").removeClass("edit-no-num").addClass("edit-num")):"hide"==str&&($workInfo.find(".info").removeClass("edit-info").addClass("edit-no-info"),$workInfo.find(".infoNo").removeClass("edit-num").addClass("edit-no-num"))},init:function(){this.refreshPage(),this.setBackTitle(this.backTitle);var _this=this,$editor=($("#workInfo"),$("#editor"));$("#notice_detail").on("click",".btn-reply",function(){_this.addReply($editor.html()).done($editor.empty())}).on("click",".star",function(){_this.changeStatus("/workflow/transaction/star/",null,function(){this.model.record_detail.star=Math.abs(this.model.record_detail.star-1)})}).on("click","#workflow-finish",function(){_this.changeStatus("/workflow/complete/",4)}).on("click",".glyphicon-repeat",function(){_this.changeStatus("/workflow/transaction/restart/",2)}).on("click",".glyphicon-play",function(){_this.changeStatus("/workflow/transaction/start/",2)}).on("click",".glyphicon-pause",function(){_this.changeStatus("/workflow/transaction/pause/",3)}).on("click",".glyphicon-edit",function(){var $workInfo=$("#workInfo").toggleClass("editing"),$detailEditor=$("#detail-editor");$workInfo.hasClass("editing")&&$detailEditor.height($detailEditor.get(0).scrollHeight),_this.renderMemberList(),_this.showEditperface("show")}).on("focus","#changeDate,#dateIcon",function(){$("#changeDate").datetimepicker({minView:"month",autoclose:!0,todayBtn:!0,format:"yyyy-mm-dd"})}).on("click","#dateIcon",function(){$("#changeDate").focus()}).on("click",".edit-btn-delete",function(){var wh=$(window).height(),top=(wh-400)/2;$(".modal-dialog").css({top:top}),$("#isDelWorkflowWin").modal()}).on("click","#wfConfrim",function(){WebAPI.post("/workflow/transaction/delete/",{task_id:_this.id}).done(function(){$(".description-section").css({"text-align":"center",color:"red"}).html(I18n.resource.workflow.main.WORK_ORDER_DELETED)}).always(function(){I18n.fillArea($(ElScreenContainer)),$("#isDelWorkflowWin").modal("hide")})}).on("click",".edit-btn-cancel",function(){$("#workInfo").removeClass("editing"),_this.resetEditing(),_this.showEditperface("hide")}).on("click",".edit-btn-save",function(){Spinner.spin($(".workflow-container")[0]),I18n.fillArea($(ElScreenContainer)),WebAPI.post("/workflow/transaction/edit",_this.getSaveModel()).done(function(result){if("deassign"===result){_this.updateViewModel(),$("#workInfo").removeClass("editing").replaceWith(beopTmpl("recordDetailTmpl",_this.model));var wh=$(window).height(),top=(wh-400)/2;$(".modal-dialog").css({top:top}),$("#deassignWinInfo").text(i18.ASSIGNED+$("#assignSelect option:selected").text()),$("#deassignWin").modal(),setTimeout(function(){$("#deassignWin").modal("hide")},2e3)}else"success"===result&&(_this.updateViewModel(),$("#workInfo").removeClass("editing").replaceWith(beopTmpl("recordDetailTmpl",_this.model)),_this.renderStatus())}).always(function(){_this.showEditperface("hide"),I18n.fillArea($(ElScreenContainer)),Spinner.stop()})}).on("click","#backTo",function(){if(_this.backTitle){if(_this.backContent)if(_this.backTitle==I18n.resource.workflow.pageInfo.TITLE_WO_MY){var ScreenFactory=WorkflowMine;ScreenCurrent=new ScreenFactory,ScreenCurrent.show()}else $(ElScreenContainer).empty().append(_this.backContent)}else ScreenCurrent.close(),ScreenCurrent=new WorkflowNotice(this.id),ScreenCurrent.show()}),$("#editor").wysiwyg(),I18n.fillArea($(ElScreenContainer))}},workflowNoticeDetail}(),WorkflowReport=function(){function WorkflowReport(){this.projData=void 0,this.userData=void 0,this.selProj=-1,this.selUser=AppConfig.userId,this.showProj=5,this.showUser=5,this.nWeekBefore=0}function GetNthWeek(date){var onejan=new Date(date.getFullYear(),0,1);return Math.ceil(((date-onejan)/864e5+(7+onejan.getDay()-1)%7)/7)}return WorkflowReport.prototype={show:function(){var _this=this;$.get("/static/views/workflow/report.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),I18n.fillArea($(ElScreenContainer))})},close:function(){},getData:function(){this.projData={},this.userData={},Spinner.spin($("#week-report")[0]);var _this=this;WebAPI.post("/workflow_get_week_report_statics",{projid:_this.selProj,userid:_this.selUser,weekbefore:_this.nWeekBefore}).done(function(result){var data=JSON.parse(result);_this.renderData(data),Spinner.stop()}).done(function(){I18n.fillArea($(ElScreenContainer))})},init:function(){var _this=this;this.getData(),$(".workflow-efficiency-table-footer").click(function(){_this.showProj*=2,_this.getData()}),$(".loading-more").click(function(){_this.showUser*=2,_this.getData()}),$(".last-week").click(function(){_this.nWeekBefore+=1,_this.getData()}),$(".next-week").click(function(){_this.nWeekBefore>0&&(_this.nWeekBefore-=1,_this.getData())})},renderData:function(data){var divFdate=$(".report-summary-row .sd-first-date"),divSdate=$(".report-summary-row .sd-second-date"),now=new Date,weekbefore_ms=7*this.nWeekBefore*864e5;now=new Date(Date.parse(now)-weekbefore_ms);var mili_sec=(7+now.getDay()-1)%7*864e5,begin=new Date(now-mili_sec);mili_sec=(7-now.getDay())%7*864e5;var end=new Date(Date.parse(now)+mili_sec);divSdate.text("zh"===I18n.type?I18n.resource.workflow.report.TITLE_TIME3.format(begin.getMonth()+1+I18n.resource.workflow.report.MONTH,begin.getDate(),end.getMonth()+1+I18n.resource.workflow.report.MONTH,end.getDate()):I18n.resource.workflow.report.TITLE_TIME3.format(DateUtil.getMonthName(begin.getMonth(),I18n.type),begin.getDate(),DateUtil.getMonthName(end.getMonth(),I18n.type),end.getDate()));var weeknow,nownow=new Date;weeknow=nownow.getFullYear()==begin.getFullYear()?begin:end;var year=weeknow.getFullYear(),weekth=GetNthWeek(weeknow).toString();divFdate.text(I18n.resource.workflow.report.TITLE_TIME2.format(year,weekth));var divPrj=$(".workflow-efficiency-table-body");divPrj.children().remove();for(var projdata=data.projdata,i=0;i<projdata.length&&i<this.showProj;i++){var item=projdata[i],done=parseInt(item[1]),undone=parseInt(item[2]),total=done+undone,percent=done/(done+undone)*100;if(percent=percent.toFixed(1),$.isArray(item[3]))var userList=item[3].join("  ");else var userList=item[3];divPrj.append($('<div class="row workflow-report-table-row"><div class="col-xs-3">'+item[0]+'</div><div class="col-xs-2">'+total+'</div> <div class="col-xs-2">'+undone+'</div><div class="col-xs-2">'+percent+'%</div> <div class="col-xs-3">'+userList+"</div></div>"))}var divMember=$(".workflow-report-memeber");divMember.children().remove();var userdata=data.user_data,transaction=data.transaction,numUser=0;for(var key in userdata){if(0!=userdata[key].done||0!=userdata[key].undone){numUser++;for(var name=userdata[key].name,userpic=userdata[key].userpic,done=userdata[key].done,undone=userdata[key].undone,total=undone+done,divList=$('<div class="col-md-10 col-md-offset-1 pb20" id = "week-report-member"><div class="row"><div class="description col-md-11"><img class="avatar-icon" src='+userpic+' /><div class="text">'+name+'</div><div class="text"><span i18n="workflow.report.ALL_DEAL_NUM"></span>：'+total+'</div><div class="text"><span i18n="workflow.report.FINISH_NUM"></span>：'+done+'</div><div class="text"><span i18n="workflow.report.UNFINISH"></span>：'+undone+"</div></div></div>"),doneList=userdata[key].donelist,i=0;i<doneList.length;i++){var item=transaction[doneList[i]];divList.append($('<div class="row item-row"><div class="col-md-12 content"><div class="col-md-3 name" title="'+item.title+'">'+item.title+'</div><div class="col-md-5 text item-text-color" title="'+item.detail+'">'+item.detail+'</div><div class="col-md-2 text item-text-color" title="resolved date">'+(item.complete_time?new Date(item.complete_time).format("yyyy-MM-dd").toLocaleString(I18n.type?I18n.type:"zh"):"")+'</div><div class="col-md-2 text item-text-color"><span i18n="workflow.report.FINISH"></span></div></div></div>'))}for(var undoneList=userdata[key].undonelist,i=0;i<undoneList.length;i++){var item=transaction[undoneList[i]];divList.append($('<div class="row item-row"><div class="col-md-12 content"><div class="col-md-3 name" title="'+item.title+'">'+item.title+'</div><div class="col-md-5 text item-text-color" title="'+item.detail+'">'+item.detail+'</div><div class="col-md-2 text item-text-color" title="deadline">'+(item.duedate?new Date(item.duedate).format("yyyy-MM-dd").toLocaleString(I18n.type?I18n.type:"zh"):"")+'</div><div class="col-md-2 text item-text-color"><span i18n="workflow.report.UNFINISH"></span></div></div></div>'))}divMember.append(divList)}if(numUser>=this.showUser)break}},updateSelUser:function(memberid){memberid||(memberid=-1),this.selUser=memberid,this.getData()},updateSelPrj:function(projid){projid||(projid=-1),this.selProj=projid,this.getData()}},WorkflowReport}(),WorkflowTeam=function(){function WorkflowTeam(){this.teamMembersModel=[],this.isManager=!1}return WorkflowTeam.prototype={show:function(){var _this=this;$.get("/static/views/workflow/team.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init()})},renderTeamMembers:function(){$(".dpt-row").empty().append(beopTmpl("tmpl_team",{groups:this.teamMembersModel,isManager:this.isManager})),I18n.fillArea($("#workflow-team"))},loadPage:function(groupId){var _this=this;return Spinner.spin($(".workflow-container")[0]),"undefined"==typeof groupId&&(groupId=-1),$.get("/workflow/team/"+AppConfig.userId+"/"+groupId).done(function(result){result.success&&(_this.teamMembersModel=result.data.team,_this.isManager=result.data.isManager,_this.renderTeamMembers(),Spinner.stop())})},close:function(){},init:function(){var _this=this,$teamAssignDialog=$("#team-assign-dialog");$("#team-assign-dialog").on("show.bs.modal",function(e){Spinner.spin($("#team-assign-dialog")[0]);var $this=$(this),$memebers=$teamAssignDialog.find(".members").empty();WebAPI.post("/workflow/getTeamMember/",{userId:AppConfig.userId,groupId:$this.data("projectID"),roleId:$this.data("roleID")}).done(function(result){return result.success?void $memebers.append(0===result.data.length?'<h4 style="text-align: center;">'+I18n.resource.workflow.team.TIP2+"</h4>":beopTmpl("tmpl_selectMember",{users:result.data})):!1}).always(function(){Spinner.stop()})}).on("click",".media",function(){$(this).toggleClass("member-selected")}).on("click",".save",function(){var selectedMembers={},$dialog=$("#team-assign-dialog"),roleID=$dialog.data("roleID"),projectID=$dialog.data("projectID");return $dialog.find(".member-selected").map(function(index,item){var $item=$(item);selectedMembers[$item.data("id")]={userid:$item.data("id"),userfullname:$item.data("userfullname"),userpic:$item.data("userpic"),editable:!0}}),0===Object.keys(selectedMembers).length?!1:(Spinner.spin($("#team-assign-dialog")[0]),void WebAPI.post("/workflow/team/addmember",{roleID:roleID,projectID:projectID,users:Object.keys(selectedMembers).join(",")}).done(function(result){if("success"===result){$dialog.modal("hide");for(var userId in selectedMembers)_this.addModelTeamMember(projectID,roleID,selectedMembers[userId]);_this.renderTeamMembers()}}))}),$("#workflow-team").on("mouseenter",".member",function(){$(this).find(".operator").removeClass("hidden")}).on("mouseleave",".member",function(){$(this).find(".operator").addClass("hidden")}).on("click",".btn-del-member",function(){I18n.fillArea($("span"));var $this=$(this);Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/team/delete",{userID:$this.data("user-id"),roleID:$this.data("role-id"),projectID:$this.data("group-id")}).done(function(result){if("success"===result)_this.removeModelTeamMember($this.data("group-id"),$this.data("role-id"),$this.data("user-id")),_this.renderTeamMembers();else if(result.indexOf("the last")){var alert=new Alert($this.closest(".dpt-container"),"danger",I18n.resource.workflow.team.TIP1);alert.showAtTop(),setTimeout(function(){alert.close()},2e3)}}).always(function(){Spinner.stop()})}).on("click",".add-btn",function(){var $this=$(this);$("#team-assign-dialog").data("roleID",$this.data("role-id")).data("projectID",$this.data("group-id")).modal("show"),I18n.fillArea($("#workflow-team"))}),this.loadPage().done(function(){I18n.fillArea($("#workflow-team"))})},removeModelTeamMember:function(groupId,roleId,userId){for(var group,role,m=0;m<this.teamMembersModel.length;m++)if(group=this.teamMembersModel[m],group.groupId==groupId){if(role=group.roles[roleId],!role)break;for(var n=0;n<role.users.length;n++)role.users[n].userid==userId&&role.users.splice(n,1)}},addModelTeamMember:function(groupId,roleId,user){for(var group,role,m=0;m<this.teamMembersModel.length;m++)if(group=this.teamMembersModel[m],group.groupId==groupId){if(role=group.roles[roleId],!role)break;role.users.push(user)}}},WorkflowTeam}(),WorkflowInsert=function(){function WorkflowInsert(insertData){this.$container=$(""),this.insertData=insertData}return WorkflowInsert.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get("/static/views/workflow/insert.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),Spinner.spin(ElScreenContainer),_this.$container=$("#workflow-insert"),_this.init(),I18n.fillArea($(ElScreenContainer))})},close:function(){},init:function(){this.loadData(),this.attachEvents()},attachEvents:function(){var _this=this;this.$container.on("change","#selectGroup",function(){var $this=$(this);_this.insertData.groupId=$this.val(),WebAPI.get("/workflow/getGroupMembers/"+_this.insertData.groupId).done(function(result){if(result.success){var selectExecutorHtml=beopTmpl("selectExecutorTmpl",result.data);$("#selectExecutor").replaceWith(selectExecutorHtml)}})}),this.$container.on("click","#workflow-insert-submit",function(){_this.submitCheck()&&(Spinner.spin(ElScreenContainer),WebAPI.post("/workflow/transaction/add/",_this.getSubmitModel()).done(function(result){alert(result.success?"created successfully":"created incorrect")}).always(function(){Spinner.stop(),ScreenManager.show(DiagnosisScreen)}))}),this.$container.on("click","#workflow-insert-cancel",function(){ScreenManager.show(DiagnosisScreen)})},getSubmitModel:function(){return{noticeId:this.insertData.noticeId,groupId:$("#selectGroup").val(),executorId:$("#selectExecutor").val(),title:$("#workflow-insert-title").val(),detail:$("#workflow-insert-detail").val(),dueDate:$("#dueDate").val(),critical:$("#critical").val(),projectId:this.insertData.projectId,chartPointList:this.insertData.chartPointList,chartQueryCircle:this.insertData.chartQueryCircle,chartStartTime:this.insertData.chartStartTime,chartEndTime:this.insertData.chartEndTime,userId:AppConfig.userId}},submitCheck:function(){return""===$.trim($("#dueDate").val())?($("#insert-errorInfo").text(I18n.resource.workflow.insert.DEADLINE_REQUIRED),!1):""===$.trim($("#workflow-insert-title").val())?($("#insert-errorInfo").text(I18n.resource.workflow.insert.TITLE_REQUIRED),!1):!0},loadData:function(){if($.isEmptyObject(this.insertData))return!1;var _this=this;WebAPI.post("/workflow/loadInsertPage",this.insertData).done(function(result){result.success&&(_this.renderChart(result.data),_this.renderForm({insertData:_this.insertData,groups:result.data.group,groupMembers:result.data.groupMembers}),I18n.fillArea($(ElScreenContainer)))}).always(function(){Spinner.stop()})},renderForm:function(formData){var insertInfoContentHtml=beopTmpl("insertInfoContentTmpl",formData);$("#insert-info-content").empty().html(insertInfoContentHtml),$("#dueDate").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,startDate:new Date})},renderChart:function(record){var arrXAxis,list_description=record.list_description,list_value=record.list_value;if(list_description.length==list_value.length){record.list_time.length>0&&(arrXAxis=record.list_time[0].split(","));for(var arrSeriesTemp=[],i=0;i<list_value.length;i++){var arrDatas=[];if(8>i){var item=list_value[i];if(item)for(var strDatas=item.split(","),j=0;j<strDatas.length;++j)arrDatas.push(parseFloat(strDatas[j]).toFixed(1));arrSeriesTemp.push({name:list_description[i],type:"line",itemStyle:{normal:{lineStyle:{type:"solid"}}},data:arrDatas})}}var option={title:{text:I18n.resource.workflow.notice.FAULT_CURVE,x:"left"},tooltip:{trigger:"axis",formatter:function(params){var strResult;if(params[0].name.length>0){strResult=params[0].name+"<br/>";for(var i=0;i<params.length;++i)strResult+=params[i].seriesName+" : "+params[i].value,i!=params.length-1&&(strResult+="<br/>")}return strResult}},legend:{data:list_description,x:"center"},toolbox:{show:!0},dataZoom:{show:!0,realtime:!0,start:0,end:100},xAxis:[{name:"",type:"category",boundaryGap:!1,axisLine:{onZero:!1},data:arrXAxis}],yAxis:[{name:"",type:"value"}],series:arrSeriesTemp,showLoading:{text:"loading",effect:"spin"}},myChart=echarts.init($("#insert-chart").get(0));myChart.setOption(option),window.onresize=myChart.resize}}},WorkflowInsert}(),workflowTransaction=function(){function workflowTransaction(group){this.group=group,this.i18urgencyLevelArr=["workflow.urgencyLevel.0","workflow.urgencyLevel.1","workflow.urgencyLevel.2"]}return workflowTransaction.prototype={show:function(){var _this=this;$.get("/static/views/workflow/transaction.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init(),$("#tipFaultTitle").attr("placeholder",I18n.resource.workflow.main.FAULT_TITLE),$("#tipFaultInfo").attr("placeholder",I18n.resource.workflow.main.FAULT_INFO),$("#iconSum").attr("title",I18n.resource.workflow.main.SUM),$("#iconFinish").attr("title",I18n.resource.workflow.main.FINISHED),$("#iconDelay").attr("title",I18n.resource.workflow.main.DELAY)})},refreshPage:function(){var _this=this;Spinner.spin($(".workflow-container")[0]),$.get("/workflow/group/"+AppConfig.userId+"/"+this.group.id).done(function(result){try{var result_obj=JSON.parse(result)}catch(e){return!1}var $workflow_transaction=$("#workflow-transaction").find(".mine-avatar-name").text(result_obj.name).end().find(".mine-avatar-desc").text(result_obj.description).end().find(".totalCount").text(result_obj.totalCount).end().find(".delayedCount").text(result_obj.delayedCount).end().find(".finishedCount").text(result_obj.finishedCount).end();if(result_obj.pic){var image=WorkflowTool.pic_path+result_obj.pic;$workflow_transaction.find(".top-section .media-left").empty().append('<img class="wf-project-icon" src="'+image+'">')}else $workflow_transaction.find(".top-section .media-left").empty().append('<div class="avatar-icon" style="background: url(/static/images/login_feature_icons.jpg) no-repeat -50px 0;"></div>');{var trans=result_obj.transactions,$task_items=$(".task-items").empty();I18n.resource.workflow.urgencyLevel}WorkflowTool.getWorkflowTemplate("#wf-transaction-task").done(function(temp){for(var n=0,nlen=trans.length;nlen>n;n++){var inner_temp=temp.clone(),item=trans[n];inner_temp.attr("task-id",item.id),inner_temp.find(".task-title").html('<span class="taskNoWrapper"><em i18n="workflow.common.NUMBER"></em><em class="taskNo">'+item.id+"</em></span>："+item.title).attr("title",I18n.resource.workflow.common.NUMBER+item.id+":"+item.title),inner_temp.find(".date").text(new Date(item.dueDate).format("yyyy-MM-dd")).attr("title","deadline"),inner_temp.find(".member").text(item.username?item.username:""),inner_temp.find(".timer").children("span").removeClass().addClass("glyphicon ic"+item.critical).attr("i18n","title="+_this.i18urgencyLevelArr[item.critical]),inner_temp.find(".status").text(WorkflowTool.getStatusText(item.statusId)),inner_temp.data("task",item),$task_items.append(inner_temp)}}),result_obj.isAdmin&&0===$(".project-operator").size()&&WorkflowTool.getWorkflowTemplate("#wf-transaction-group-operator").done(function(group_operator_template){$(".nav-content").append(group_operator_template)})}).done(function(){I18n.fillArea($(ElScreenContainer))}).always(function(){Spinner.stop()})},close:function(){},init:function(){var that=this;this.refreshPage();var projectMembersPromise=$.get("/workflow/projectmember/"+this.group.id);$("#workflow-transaction").on("click",".add-btn",function(){var $this=$(this);projectMembersPromise.done(function(result){try{var result_obj=JSON.parse(result);if(!result_obj||0===result_obj.length){
$(".success-alert").empty();var alert=new Alert(".success-alert","danger",I18n.resource.workflow.main.TIP1).show();return setTimeout(function(){alert.close()},2e3),!1}}catch(e){return!1}$this.hide().closest(".add-row").find(".add-section").show()})}).on("click",".edit-btn-cancel",function(){var add_row=$(this).closest(".add-row");add_row.find(".trans-edit-textarea").val("").end().find(".add-section").hide().end().find(".add-btn").show()}).on("show.bs.dropdown","#project-user",function(){var _this=this;projectMembersPromise.done(function(result){try{var result_obj=JSON.parse(result)}catch(e){return!1}var menu=$(_this).find(".dropdown-menu").empty();if(0===result_obj.length)return menu.append($('<li class="empty-member">'+I18n.resource.workflow.main.TIP2+"</li>")),!1;for(var n=0,nlen=result_obj.length;nlen>n;n++){var member=result_obj[n];menu.append($('<li class="member-item">'+member.username+"</li>").data("member",member))}})}).on("click","#project-critical ul li",function(){var $o=$(this),text=$o.text(),val=$o.attr("objval"),$obj=$("#project-critical").find(".selected-critical span");$obj.text(text),$("#project-critical").attr("objval",val)}).on("click",".member-item",function(){var $this=$(this),member=$this.data("member");$this.closest(".project-members").find(".selected-member").text(member.username).data("member",member)}).on("click",".complete-time",function(){var $this=$(this);$this.find(".time-picker").datetimepicker({minView:"month",autoclose:!0,todayBtn:!0,format:"yyyy-mm-dd",startDate:new Date})}).on("changeDate",".time-picker",function(e){var $this=$(this),date=$this.data("date");$this.closest(".complete-time").find(".selected-date").text(date).data("date",date),$this.dropdown("toggle")}).on("click",".add-section .edit-btn-save",function(){var $this=$(this),add_section=$this.closest(".add-section"),title=add_section.find(".trans-edit-textarea.trans-title").val();if(!title){$(".alert").empty();var alert=new Alert(".alert","danger",I18n.resource.workflow.main.NAME_NOT_NULL).show();return setTimeout(function(){alert.close()},2e3),!1}var detail=add_section.find(".trans-edit-textarea.trans-detail").val(),complete_time=add_section.find(".selected-date").data("date"),selected_member=add_section.find(".selected-member").data("member");if(!complete_time){$(".alert").empty();var alert=new Alert(".alert","danger",I18n.resource.workflow.main.FINISH_TIME_NOT_NULL).show();return setTimeout(function(){alert.close()},2e3),!1}if(!selected_member||void 0===selected_member.userId){$(".alert").empty();var alert=new Alert(".alert","danger",I18n.resource.workflow.main.PEOPLE_NOT_NULL).show();return setTimeout(function(){alert.close()},2e3),!1}var critical=$("#project-critical").attr("objval");if(""==critical){$(".alert").empty();var alert=new Alert(".alert","danger",I18n.resource.workflow.urgencyLevel.URGENCY_LEVEL_REQUIRED).show();return setTimeout(function(){alert.close()},2e3),!1}var data={userId:AppConfig.userId,dueDate:complete_time,title:title,detail:detail,groupId:that.group.id,executorId:selected_member.userId,critical:critical};Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/transaction/add/",data).done(function(result){$this.closest(".add-row").find(".selected-date").text(I18n.resource.workflow.main.FINISH_TIME).data("date","").end().find(".selected-member").text(I18n.resource.workflow.main.PEOPLE).data("member","").end().find(".trans-edit-textarea").val("").end().find(".add-section").hide().end().find(".add-btn").show(),$(".alert").empty();var alert=new Alert(".success-alert","success",I18n.resource.workflow.main.ADD_SUCCESS).show();setTimeout(function(){alert.close()},1e3),that.refreshPage(),$("#project-critical").attr("objval",""),$("#project-critical .selected-critical>span").text(I18n.resource.workflow.urgencyLevel.URGENCY_LEVEL)}).always(function(){Spinner.stop()})}).on("click","#backToMain",function(){ScreenCurrent.close(),ScreenCurrent=new WorkflowMain,ScreenCurrent.show()}).on("click",".task-title",function(){var id=$(this).closest(".task-item").data("task").id;new workflowNoticeDetail(id,I18n.resource.workflow.main.CREATE_TASK,$(ElScreenContainer).children().detach()).show()}).on("click","#del-project",function(){$(this).hide(),$("#workflow-transaction .delete-dialog").show()}).on("click","#del-project-cancel",function(){$(this).closest(".delete-dialog").hide(),$("#del-project").show()}).on("click","#del-project-OK",function(){Spinner.spin($(".workflow-container")[0]),WebAPI.post("/workflow/group/delete/",{id:that.group.id}).done(function(){ScreenCurrent.close(),ScreenCurrent=new WorkflowMain,ScreenCurrent.show()}).always(function(){Spinner.stop()})}).on("click","#edit-project",function(){var top_section=$(".top-section");if(top_section.find(".media").hasClass("editing"))return!1;top_section.find(".media").addClass("editing");var old_media_body=top_section.find(".media-body").detach(),new_media_body=$('<div class="media-body"></div>');new_media_body.append('<h3 class="media-heading"><textarea class="gd-edit-textarea title" maxlength="255">'+that.group.name+"</textarea></h3>").append('<textarea class="gd-edit-textarea desc" maxlength="255">'+that.group.description+"</textarea>").append('<button type="button" class="pull-right btn btn-success edit-btn edit-btn-save">'+I18n.resource.workflow.main.SAVE+"</button>").append('<button type="button" class="pull-right btn btn-default edit-btn edit-btn-cancel">'+I18n.resource.workflow.main.CANCEL+"</button>"),top_section.find(".media").append(new_media_body),new_media_body.find(".edit-btn-cancel").click(function(){top_section.find(".media").find(".media-body").remove().end().append(old_media_body).removeClass("editing")}),new_media_body.find(".edit-btn-save").click(function(){var media=$(this).closest(".media"),new_name=media.find(".title").val().trim(),new_desc=media.find(".desc").val().trim();if(!new_name){var error_dialog=$(".error-dialog").find("h4").text(I18n.resource.workflow.main.NAME_NOT_NULL).end().show();return setTimeout(function(){error_dialog.find("h4").text("").end().hide()},2e3),!1}return new_name===that.group.name&&new_desc===that.group.description?(media.find(".media-body").remove().end().append(old_media_body).removeClass("editing"),!1):(Spinner.spin($(".workflow-container")[0]),void WebAPI.post("/workflow/group/edit/",{id:that.group.id,name:new_name,desc:new_desc}).done(function(){that.group.name=new_name,that.group.description=new_desc,old_media_body.find(".media-heading").text(new_name).end().find(".mine-avatar-desc").text(new_desc),media.find(".media-body").remove().end().append(old_media_body),media.removeClass("editing")}).always(function(){Spinner.stop()}))})})}},workflowTransaction}();