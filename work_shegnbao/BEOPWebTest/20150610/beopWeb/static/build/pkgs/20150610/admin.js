var ProductDownload=function(){function ProductDownload(){this.curr=void 0,this.interval=void 0,this.all=void 0}return ProductDownload.prototype={show:function(){WebAPI.get("/static/views/admin/productDownload.html").done(function(resultHtml){$("#indexMain").html(resultHtml)}),this.init()},init:function(){this.curr=1,this.interval=5e3,this.all=0;var len=this.elemNodesLen(document.getElementById("scroll_product_list").childNodes);this.all=len;var _this=this,$scrollProductList=$("#scroll_product_list"),$mediaAndSupport=$(".mediaandsupport .list-group-item"),$panel=$(".panel"),$divideTitle=$(".divide-title");$("#scroll_btn_list li").each(function(index,domEle){$(domEle).mouseover(function(event){_this.pause();var prev=_this.curr;if(prev!=index){var curr=index+1;_this.timeoutSet=setTimeout(function(){_this.go(curr)},500),event.stopPropagation()}}).mouseout(function(){_this.timeoutSet&&clearTimeout(_this.timeoutSet),_this.play()})}),$scrollProductList.mouseover(function(){_this.pause()}),$scrollProductList.mouseout(function(){_this.play()}),_this.play(),$(".panel>.panel-heading:first").css("background","#bce8f1"),$panel.on("show.bs.collapse",function(){$(this).find(".panel-heading").css("background","#bce8f1")}),$panel.on("hide.bs.collapse",function(){$(this).find(".panel-heading").css("background","white")}),$mediaAndSupport.not($divideTitle).mouseenter(function(){$(this).css("border","1px solid #bce8f1")}),$mediaAndSupport.not($divideTitle).mouseleave(function(){$(this).css("border","1px solid transparent")}),$mediaAndSupport.mouseenter(function(){$(this).find(".btn").css("display","inline")}),$mediaAndSupport.mouseleave(function(){$(this).find(".btn").css("display","none")})},next:function(){var to;to=this.curr==this.all?1:this.curr+1,this.go(to)},prev:function(){var to;to=1==this.curr?this.all:this.curr-1,this.go(to)},go:function(index){var curr=this.curr;if(curr!=index){var elems_b=$("#scroll_product_list li"),curr_elem=elems_b.eq(curr-1);curr_elem.animate({opacity:0},500,null,function(){curr_elem.removeClass("on")}),elems_b.eq(index-1).css("opacity",0).addClass("on").animate({opacity:1},500);var elems_btn=$("#scroll_btn_list li");elems_btn.removeClass("on"),elems_btn.eq(index-1).addClass("on");var elems_download=$("#scroll_download_list li");elems_download.removeClass("on"),elems_download.eq(index-1).addClass("on"),this.curr=index}},pause:function(){this.timeSet&&clearInterval(this.timeSet)},play:function(){this.timeSet&&clearInterval(this.timeSet);this.timeSet=setInterval(function(){this.next()},this.interval)},elemNodesLen:function(elems){if(!elems||"undefined"==typeof elems.length||0==elems.length)return 0;for(var len_true=0,i=0,len=elems.length;len>i;i++)1==elems[i].nodeType&&len_true++;return len_true}},ProductDownload}(),UserManagerController=function(){function User(){this.id=null,this.username=null,this.userfullname=null,this.userpic=null}function Records(){this.recordType={0:I18n.resource.admin.panelManagement.ALL_RECORDS,1:I18n.resource.admin.panelManagement.ACCOUNT_LOGIN_RECORD,2:I18n.resource.admin.panelManagement.USER_MANAGEMENT_RECORD,3:I18n.resource.admin.panelManagement.PAGE_MANAGEMENT_RECORD},this.loginRecords=[],this.userManageRecords=[],this.pageManageRecords=[],this.allRecords=[]}function UserManagerController(manager){this.manager=manager,this.recordVM=new Records,this.viewSource="/static/views/admin/userManager/userManagerController.html"}return User.prototype={updateUserfullname:function(userfullname){var _this=this;return WebAPI.post("/admin/updateUser",{id:this.id,userfullname:userfullname}).done(function(result){result.success&&(_this.userfullname=userfullname)})},updatePassword:function(oldPwd,newPwd){return WebAPI.post("/admin/updateUser",{id:this.id,oldPassword:oldPwd,password:newPwd})},updateAvatar:function(fileData){var _this=this,formData=new FormData;return formData.append("file",fileData),formData.append("userId",this.id),$.ajax({url:"/admin/updateAvatar",type:"POST",data:formData,cache:!1,processData:!1,contentType:!1,success:function(result,textStatus,jqXHR){if("undefined"==typeof result.error&&result.success)_this.userpic=result.data;else{var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[result.code]);alert.showAtTop(2e3)}}})}},Records.prototype={fetchRecords:function(recordType,userId,beginTime,endTime){var postData={userId:userId,type:recordType,beginTime:beginTime,endTime:endTime};return 0===recordType&&delete postData.type,WebAPI.post("/admin/getRecords",postData)},fetchAllRecords:function(userId,beginTime,endTime){var _this=this;return this.fetchRecords(0,userId,beginTime,endTime).done(function(result){_this.allRecords=result&&result.data||[]})},fetchLoginRecords:function(userId,beginTime,endTime){var _this=this;return this.fetchRecords(1,userId,beginTime,endTime).done(function(result){_this.loginRecords=result&&result.data||[]})},fetchUserManageRecords:function(userId,beginTime,endTime){var _this=this;return this.fetchRecords(2,userId,beginTime,endTime).done(function(result){_this.userManageRecords=result&&result.data||[]})},fetchPageManageRecords:function(userId,beginTime,endTime){var _this=this;return this.fetchRecords(3,userId,beginTime,endTime).done(function(result){_this.pageManageRecords=result&&result.data||[]})}},UserManagerController.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get(this.viewSource).done(function(resultHtml){var $ElScreenContainer=$(ElScreenContainer).html($(resultHtml)),$tab=beopTmpl("managerTabTmpl",AppConfig);$ElScreenContainer.find("#manageTab").append($tab),_this.init(),ScreenManager.show(_this.manager),I18n.fillArea($(ElScreenContainer)),$('#manageTab li[screen="'+BEOPUtil.getFunctionName(_this.manager)+'"] a').tab("show")}).always(function(){Spinner.stop()})},init:function(){var _this=this;$("#manageTab a").click(function(e){var screen=$(this).parent().attr("screen");screen&&window[screen]&&(_this.manager=window[screen],ScreenManager.show(_this.manager))})},close:function(){$(document).off("click.userManager"),this.addValidStatus("hide",$("#editInput"),"top"),this.addValidStatus("hide",$("#editOldPwd")),this.addValidStatus("hide",$("#editNewPwd")),this.addValidStatus("hide",$("#editCheckNewPwd"))},addValidStatus:function(msg,$obj,placement){var placement=placement||"right",errorTooltip=$obj.tooltip({container:"body",placement:placement,trigger:"manual",template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',html:!0,title:msg||""});"hide"!=msg?errorTooltip.tooltip("show"):errorTooltip&&errorTooltip.tooltip("destroy")},loadUser:function(userId){var dfd=$.Deferred();return userId||dfd.reject(),WebAPI.get("admin/accountManger/"+userId).pipe(function(result){if(result.success){var user=$.extend(!0,new User,result.data);dfd.resolve(user)}else dfd.reject(result);return dfd})},loadRecords:function(){var dfd=$.Deferred();return dfd.resolve(new Records),dfd},setFloatingWin:function($win,h){var wh=$(window).height(),top=(wh-h)/2;$win.find(".modal-dialog").css({top:top}),$win.modal()},checkEmail:function(str){var flag=!0,re=/^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;return flag=re.test(str)?!0:!1},buildSubTree:function(buildTreeItemFunc,root,childField){if(!buildTreeItemFunc||"function"!=typeof buildTreeItemFunc)return"";if(childField||(childField="children"),root[childField]&&root[childField].length>0){for(var $container=$("<ul></ul>"),i=0;i<root[childField].length;i++){var child=root[childField][i],$li=$(buildTreeItemFunc(child));child[childField]&&child[childField].length&&$li.append(this.buildSubTree(buildTreeItemFunc,child,childField)),$container.append($li)}return $container}},validateTime:function($startTime,$endTime,$msg){var flag=!1,startTimeVal=$startTime.val(),endTimeVal=$endTime.val();return""==startTimeVal?($msg.text(I18n.resource.admin.panelManagement.START_TIME_CHECKINFO).css("display","block"),flag=!1):""==endTimeVal?($msg.text(I18n.resource.admin.panelManagement.END_TIME_CHECKINFO).css("display","block"),flag=!1):startTimeVal>endTimeVal?($msg.text(I18n.resource.admin.panelManagement.TIME_GREATER_CHECKINFO).css("display","block"),flag=!1):flag=!0,flag?$msg.hide():$msg.show(),flag},isArrayRepeat:function(arr){return/(\x0f[^\x0f]+)\x0f[\s\S]*\1/.test(""+arr.join("")+"")},renderLoginRecords:function($container){var compiledTemplate=beopTmpl("loginRecordTmpl",this.recordVM.loginRecords);$container.html(compiledTemplate)},renderUserManageRecords:function($container){var compiledTemplate=beopTmpl("userManageRecordTmpl",this.recordVM.userManageRecords);$container.html(compiledTemplate)},renderPageManageRecords:function($container){var compiledTemplate=beopTmpl("pageManageRecordTmpl",this.recordVM.pageManageRecords);$container.html(compiledTemplate)},renderAllRecords:function($container){var compiledTemplate=beopTmpl("allRecordTmpl",this.recordVM.pageManageRecords);$container.html(compiledTemplate)},renderRecordsEvent:function(userId,$startTime,$endTime,$msg,$typeSelector,$container,isWinFlag){var flag=this.validateTime($startTime,$endTime,$msg);if(flag){if(!userId)return!1;isWinFlag&&$("#userAllRecord").show();var recordType=$typeSelector.find("option:selected").val(),beginTime=$startTime.val(),endTime=$endTime.val(),_this=this;switch(parseInt(recordType)){case 0:this.recordVM.fetchAllRecords(userId,beginTime,endTime).done(function(){_this.renderAllRecords($container)});break;case 1:this.recordVM.fetchLoginRecords(userId,beginTime,endTime).done(function(){_this.renderLoginRecords($container)});break;case 2:this.recordVM.fetchUserManageRecords(userId,beginTime,endTime).done(function(){_this.renderUserManageRecords($container)});break;case 3:this.recordVM.fetchPageManageRecords(userId,beginTime,endTime).done(function(){_this.renderPageManageRecords($container)})}}else isWinFlag&&$("#userAllRecord").hide()}},UserManagerController}(),AccountManager=function(){function AccountManager(){this.viewSource="/static/views/admin/userManager/accountManager.html",this.managerCtrl=new UserManagerController,this.userVM=null,this.recordVM=null,this.$container=$(),this.i18=I18n.resource.admin.panelManagement}return AccountManager.prototype={show:function(){$("#ulPages").empty();var _this=this;Spinner.spin(ElScreenContainer),$.get(this.viewSource).done(function(resultHtml){_this.$container=$("#accountManageWrapper").html(resultHtml).find("#accountManage"),$("#panelContentWrapper").hide(),_this.init(),I18n.fillArea($(ElScreenContainer))}).always(function(){Spinner.stop()})},setUserInfoHeight:function(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-20),$("#allRecord").height($(window).height()-$(".navbar").height()-320)},init:function(){var _this=this;this.setUserInfoHeight(),$("#panelContentWrapper").show(),this.renderManageUserInfo(AppConfig.userId),this.managerCtrl.loadRecords().done(function(result){_this.recordVM=result}),$("#txtLogDateStart").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,endDate:new Date}),$("#txtLogDateEnd").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0}),this.attachEvents()},renderManageUserInfo:function(userId){var _this=this;this.managerCtrl.loadUser(userId).done(function(user){_this.userVM=user,_this.refreshManageUserInfo(),I18n.fillArea($(ElScreenContainer))})},refreshManageUserInfo:function(){var compiledTemplate=beopTmpl("paneProjectUserInfoTmpl",this.userVM);this.$container.find("#userInfo").html(compiledTemplate)},attachEvents:function(){var _this=this;this.$container.on("click","#editName",function(){$("#confrimEditName").show(),$(this).hide(),$("#accountManage .nameEditor").toggleClass("editing")}),this.$container.on("click","#confrimEditName",function(){var userfullname=$.trim($("#accountManage #editInput").val()),flag=/^(\w|-|[\u4E00-\u9FA5]){2,10}$/g.test(userfullname);return flag?(_this.managerCtrl.addValidStatus("hide",$("#editInput"),"top"),userfullname&&userfullname.trim()!==_this.userVM.userfullname&&(Spinner.spin(ElScreenContainer),_this.userVM.updateUserfullname(userfullname.trim()).done(function(result){result.success&&(_this.refreshManageUserInfo(),AppConfig.userProfile.fullname=userfullname.trim())}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})),$("#accountManage .nameEditor").removeClass("editing"),$("#paneUser").text(userfullname),$("#confrimEditName").hide(),$("#editName").show(),void 0):void _this.managerCtrl.addValidStatus(_this.i18.EMAIL_FORMAT,$("#editInput"),"top")}),this.$container.on("click",".userPwd",function(){var wh=$(window).height(),top=(wh-300)/2;$(".modal-dialog").css({top:top}),$("#editPwdWin").modal()}),$("#submitResetPwd").click(function(){var $oldPwd=$("#editOldPwd"),$newPwd=$("#editNewPwd"),$editCheckNewPwd=$("#editCheckNewPwd"),oldPwd=$oldPwd.val(),newPwd=$newPwd.val(),editCheckNewPwd=$editCheckNewPwd.val();if(""==oldPwd)return void _this.managerCtrl.addValidStatus(_this.i18.ORIGINAL_PASSWORD_NULL,$oldPwd);if(_this.managerCtrl.addValidStatus("hide",$oldPwd),""==newPwd)return void _this.managerCtrl.addValidStatus(_this.i18.NEW_PASSWORD_NULL,$newPwd);if(_this.managerCtrl.addValidStatus("hide",$newPwd),""==editCheckNewPwd)return void _this.managerCtrl.addValidStatus(_this.i18.CONFIRMED_PASSWORD_NULL,$editCheckNewPwd);if(_this.managerCtrl.addValidStatus("hide",$editCheckNewPwd),newPwd!=editCheckNewPwd)return void _this.managerCtrl.addValidStatus(_this.i18.PASSWORD_CONSISTENT_ERROR,$newPwd);_this.managerCtrl.addValidStatus("hide",$newPwd);var reg=/^[A-Za-z0-9\@\!\#\$\&\.]{4,22}$/;if(!reg.test(newPwd))return void _this.managerCtrl.addValidStatus(_this.i18.PASSWORD_FORMAT_ERROR,$newPwd);var $returnInfo=$("#returnInfo"),$returnInfoCon=$("#returnInfoCon");_this.userVM.updatePassword(oldPwd,newPwd).done(function(result){return $returnInfo.text(I18n.resource.code[result.code[0]]),$returnInfoCon.show(),result.success?($oldPwd.val(""),$newPwd.val(""),$editCheckNewPwd.val(""),$returnInfoCon.hide(),$("#editPwdWin").modal("hide"),void 0):!1}).fail(function(){$returnInfo.text(_this.i18.REQUEST_ERROR),$returnInfoCon.show()}).always(function(){I18n.fillArea($(ElScreenContainer))})}),$("#editPwdWin").on("hide.bs.modal",function(){_this.managerCtrl.addValidStatus("hide",$("#editOldPwd")),_this.managerCtrl.addValidStatus("hide",$("#editNewPwd")),_this.managerCtrl.addValidStatus("hide",$("#editCheckNewPwd"))}),this.$container.on("change","#file-input",function(event){Spinner.spin(ElScreenContainer),event.stopPropagation(),event.preventDefault();var fileData=event.target.files[0];if(fileData.size>1048576){$(".modal-dialog").css({top:($(window).height()-200)/2}),$("#PromptWinInfo").text(_this.i18.FILE_SIZE_LIMITED),$("#PromptWin").modal();var t=null;return t&&clearTimeout(t),t=setTimeout(function(){$("#PromptWin").modal("hide")},2e3),Spinner.stop(),!1}_this.userVM.updateAvatar(fileData).done(function(result){Spinner.spin(ElScreenContainer),result.success&&($(".image-upload img").attr("src",result.data),AppConfig.profile.picture=result.data)}).always(function(){Spinner.stop()})}),$("#searchRecord").click(function(){_this.managerCtrl.renderRecordsEvent.call(_this.managerCtrl,AppConfig.userId,$("#txtLogDateStart"),$("#txtLogDateEnd"),$("#infoDate"),$("#selectRecord"),$("#allRecord"),!1)}),$(window).on("resize.setUserInfoHeight",function(){_this.setUserInfoHeight()})},detachEvents:function(){$(window).off("resize.setUserInfoHeight")},close:function(){this.detachEvents(),this.managerCtrl.addValidStatus("hide",$("#editInput"),"top"),this.managerCtrl.addValidStatus("hide",$("#editOldPwd")),this.managerCtrl.addValidStatus("hide",$("#editNewPwd")),this.managerCtrl.addValidStatus("hide",$("#editCheckNewPwd"))}},AccountManager}(),MemberManager=function(){function MemberManager(){this.viewSource="/static/views/admin/userManager/MemberManager.html",this.managerCtrl=new UserManagerController,this.$container=$(),this.userTree={},this.i18=I18n.resource.admin.panelManagement}return MemberManager.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get(this.viewSource).done(function(resultHtml){_this.$container=$("#memberManageWrapper").html(resultHtml).find("#memberManage"),$("#manageTab li[screen='AccountManager']").remove(),$("#manageTab").show(),$("#panelContentWrapper").hide(),_this.init(),I18n.fillArea($(ElScreenContainer))}).always(function(){Spinner.stop()})},setMemberManagerHeight:function(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-62),$("#userTreeCon").height($(window).height()-$(".navbar").height()-205)},init:function(){this.setMemberManagerHeight(),$("#panelContentWrapper").show(),this.loadUserTree(),this.attachEvents()},attachEvents:function(){var $startDateRecord,$endDateRecord,_this=this,$userSettingWin=$("#userSettingWin"),$userTreeCon=$("#userTreeCon");$userTreeCon.on("click",".setting",function(event){var userId=$(this).closest("li").attr("userId");$userTreeCon.find("span").removeClass("selected"),$(this).parents("span").addClass("selected"),WebAPI.post("/admin/loadUsersSetting",{userId:userId,currentUser:AppConfig.userId}).done(function(result){result.success&&(result.data.managers.sort(function(a,b){return a.userfullname>b.userfullname}),$userSettingWin.find(".modal-body").empty().append(beopTmpl("userSettingTmpl",result.data)),_this.managerCtrl.setFloatingWin($userSettingWin,700),$userSettingWin.attr("userId",userId),$startDateRecord=$("#recordLogDateStart").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0,endDate:new Date}),$endDateRecord=$("#recordLogDateEnd").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:!0})),I18n.fillArea($(ElScreenContainer))})}).on("click",".icon-minus-sign",function(){var $this=$(this),$opSpan=$this.parents("span"),$ul=$opSpan.next("ul"),ulL=$ul.length;ulL&&($ul.slideUp(300),$this.removeClass("icon-minus-sign").addClass("icon-plus-sign"))}).on("click",".icon-plus-sign",function(){var $this=$(this),$opSpan=$this.parents("span"),$ul=$opSpan.next("ul"),ulL=$ul.length;ulL&&($ul.slideDown(300),$this.removeClass("icon-plus-sign").addClass("icon-minus-sign"))}),$userSettingWin.on("click","#userDel",function(){_this.managerCtrl.setFloatingWin($("#isUserDelWin"),300)}).on("click","#userEditConfrim",function(){var userId=$userSettingWin.attr("userId");AppConfig.userId==userId&&$userSettingWin.modal("hide");var isManager=$("#isManager option:selected").val(),supervisor=$("#supervisor  option:selected").val(),oldSupervisor=$("#oldSupervisor").val(),oldIsManager=$("#oldIsManager").val();supervisor!=oldSupervisor||isManager!=oldIsManager?WebAPI.post("/admin/updateUsersSetting",{userId:userId,isManager:isManager,supervisor:supervisor}).done(function(result){result.success&&(_this.loadUserTree(),$userSettingWin.modal("hide")),I18n.fillArea($(ElScreenContainer))}):$userSettingWin.modal("hide")}).on("click","#btnRecord",function(){var userId=$userSettingWin.attr("userId");if(!userId)return!1;_this.managerCtrl.renderRecordsEvent.call(_this.managerCtrl,userId,$("#recordLogDateStart"),$("#recordLogDateEnd"),$("#recordInfoDate"),$("#userRecord"),$("#userAllRecord"),!0)}),$("#deleteUser").click(function(){var userId=$userSettingWin.attr("userId");WebAPI.post("/admin/deleteUser",{userId:userId,currentUserId:AppConfig.userId}).done(function(result){result.success&&(_this.loadUserTree(),$userSettingWin.modal("hide"),$("#isUserDelWin").modal("hide"),I18n.fillArea($(ElScreenContainer)))})}),$("#addPerson").on("click",function(){_this.loadManagersByUserId(AppConfig.userId).done(function(result){if(!result.success)return!1;var wh=$(window).height(),$addPersonWin=$("#addPersonWin"),top=(wh-600)/2;$(".modal-dialog").css({top:top}),$addPersonWin.find(".modal-body").empty().append(beopTmpl("addUserTmpl",{addCount:5,managers:result.data})),I18n.fillArea($(ElScreenContainer)),$addPersonWin.modal()})});var selectedUserId,selectedProjectId,projectPermission={};$("#addPersonWin").on("change","#selectSupervisor",function(){return(selectedUserId=$(this).find("option:checked").val())?void WebAPI.post("/admin/getProjectPermissionByUserId",{userId:selectedUserId}).done(function(result){if(result.success){projectPermission=result.data;var $selectInitProject=$("#selectInitProject").empty();$("#selectInitRole option.roles").remove();var newSelectInitProjectHtml=beopTmpl("selectInitProjectTmpl",projectPermission);$selectInitProject.replaceWith(newSelectInitProjectHtml)}else $("#selectInitProject").find("option.projects").remove(),projectPermission={};I18n.fillArea($(ElScreenContainer))}).fail(function(){$("#selectInitProject").find("option.projects").remove(),projectPermission={}}):!1}).on("change","#selectInitProject",function(){selectedProjectId=$(this).find("option:checked").val();var $selectInitRole=$("#selectInitRole").empty(),roles=projectPermission[selectedProjectId].roles;if(roles){var newSelectInitRoleHtml=beopTmpl("selectInitRoleTmpl",roles);$selectInitRole.replaceWith(newSelectInitRoleHtml)}}),$("#addPersonOK").click(function(){var $this=$(this),$addPersonWin=$("#addPersonWin"),emails=[],userName=[],$userEmails=$addPersonWin.find(".userEmail"),supervisorId=$("#selectSupervisor option:selected").val(),$addPersonErr=$("#addPersonErr");if($addPersonErr.text("").hide(),"0"==supervisorId)return $addPersonErr.text(_this.i18.IMMEDIATE_SUPERIOR_NULL+"！").show(),!1;for(var i=0;i<$userEmails.length;i++){var $email=$userEmails.eq(i),email=$email.val();if(""!=email){if(!_this.managerCtrl.checkEmail(email))return $email.focus(),$addPersonErr.text(_this.i18.MAILBOX_FORMAT_WRONG+"！").show(),!1;emails.push(email),userName.push($addPersonWin.find(".userName").eq(i).val())}}if($addPersonErr.text("").hide(),_this.managerCtrl.isArrayRepeat(emails))return $addPersonErr.text(_this.i18.MAILBOX_CHECKINFO_REPEATED+"！").show(),!1;var initProjectId=$("#selectInitProject option:selected").val(),initRoleId=$("#selectInitRole option:selected").val();if("0"===initProjectId)return $addPersonErr.text(_this.i18.INITIAL_PROJECT_NOTNULL+"！").show(),!1;if("0"===initRoleId)return $addPersonErr.text(_this.i18.INITIAL_ROLE_NOTNULL+"！").show(),!1;$addPersonErr.text("").hide();var postData={inviterId:AppConfig.userId,supervisorId:supervisorId,isManager:$("#givenMR").get(0).checked?1:0,userInfo:[],initRole:initRoleId};if(void 0!=userName){for(var postUserInfo=[],i=0,len=userName.length;len>i;i++)void 0!=userName[i]&&(void 0==emails[i]&&(emails[i]=""),postUserInfo.push({userfullname:userName[i],email:emails[i]}));postData.userInfo=postUserInfo}return postData.userInfo.length?($this.button("loading"),void WebAPI.post("/admin/inviteUsers",postData).done(function(result){if(result.success){_this.loadUserTree().done(function(result){}),result.data.info={apply:_this.i18.MAILBOX_CHECKINFO_APPLY,invited:_this.i18.MAILBOX_CHECKINFO_INVITED,registered:_this.i18.MAILBOX_CHECKINFO_REGISTERED,token_failed:_this.i18.SEND_MAIL_FAILED,succeed:_this.i18.SEND_EMAIL_SUCCESS};var compiledTemplate=beopTmpl("inviteMsgTmpl",result.data);$("#inviteMsg").empty().html(compiledTemplate),$addPersonErr.text("").hide()}}).fail(function(){$addPersonErr.text(_this.i18.REQUEST_ERROR+"！").show()}).always(function(){I18n.fillArea($(ElScreenContainer)),$this.button("reset")})):($addPersonErr.text(_this.i18.PLEASE_ADD_USER+"。").show(),!1)}),$("#searchUserIc").click(function(){var val=$("#searchUser").val();_this.searchUserObj(val,$(".userTree"))}),$("#searchUser").keyup(function(e){var val=$("#searchUser").val();_this.searchUserObj(val,$(".userTree")),40==e.keyCode&&$("#userListUl li").eq(0).find("input").focus()}),$(document).on("click.memberManager",function(e){var $target=$(e.target);$target.parents("#searchUserCon").length||$("#userListUl").slideUp(300)}),$("#userListUl").on("click","li",function(){var userid=$(this).attr("userid"),val=$(this).find("input").val();_this.selectedUserObj(userid,val)}),$("#userListUl").on("keydown","li input",function(e){var $li=$(this).parents("li"),$liAll=$("#userListUl li");if(38==e.keyCode)if($liAll.index($li)+1==1){$liAll.eq($liAll.length-1).find("input").focus();var t2=null;t2&&clearTimeout(t2),t2=setTimeout(function(){$("#userListUl").scrollTop(1e4)},30)}else $li.prev().find("input").focus(),$("#userListUl").scrollTop(28*$liAll.index($li));else if(40==e.keyCode)if($liAll.index($li)+1==$liAll.length){$liAll.eq(0).find("input").focus();var t1=null;t1&&clearTimeout(t1),t1=setTimeout(function(){$("#userListUl").scrollTop(0)},30)}else $("#userListUl").scrollTop(28*$liAll.index($li)),$li.next().find("input").focus();else 13==e.keyCode&&($("#userListUl").slideUp(300),_this.selectedUserObj($li.attr("userid"),$(this).val()))}),$(window).on("resize.setMemberManagerHeight",function(){_this.setMemberManagerHeight()})},detachEvents:function(){$(window).off("resize.setMemberManagerHeight"),$(window).off("click.memberManager")},close:function(){this.detachEvents()},loadUserTree:function(){var _this=this;return WebAPI.post("/admin/loadUsersTree",{userId:AppConfig.userId}).done(function(result){if(result.success){_this.userTree=result.data;var $userTree=_this.buildUserTree(_this.userTree);$(".userTree").empty().append($userTree),$("#treeUl .setting").eq(0).find("img").css({position:"relative","z-index":8}),I18n.fillArea($(ElScreenContainer))}})},buildUserTree:function(root){var buildUserTreeItem=function(item){return beopTmpl("userTreeItemTmpl",item)},$root=$('<ul id="treeUl"></ul>').append(buildUserTreeItem(root));return $root.find("li").append(this.managerCtrl.buildSubTree(buildUserTreeItem,root,"sub")),$root},loadManagersByUserId:function(userId){return WebAPI.post("/admin/loadManagersByUserId",{userId:userId})},loadInvitePanel:function(userId){return WebAPI.post("/admin/loadInvitePanel",{userId:userId})},searchUserObj:function(val,$tree){for(var arrNameInfo=[],arrPicInfo=[],arrIdInfo=[],userNameArr=[],userPicArr=[],userIdArr=[],$userLiAll=$tree.find("li"),$userNameAll=$userLiAll.find(".userfullname"),$userPicAll=$userLiAll.find(".setting>img"),userNameAllL=$userNameAll.length,i=0;userNameAllL>i;i++)userNameArr.push($userNameAll.eq(i).text()),userPicArr.push($userPicAll.eq(i).attr("src")),userIdArr.push($userLiAll.eq(i).attr("userid"));for(var userNameArrL=userNameArr.length,i=0;userNameArrL>i;i++)userNameArr[i].toLowerCase().indexOf(val.toLowerCase())>-1&&(arrNameInfo.push(userNameArr[i]),arrPicInfo.push(userPicArr[i]),arrIdInfo.push(userIdArr[i]));for(var li="",i=0;i<arrNameInfo.length;i++){var userNameStr=arrNameInfo[i],userPicUrl=arrPicInfo[i],userId=arrIdInfo[i];li+='<li userId="'+userId+'" class="pr"><input type="text" value="'+userNameStr+'" class="pa" readonly /><img src="'+userPicUrl+'" class="pa" style="z-index:55" /></li>'}$("#userListUl").empty().append(li).slideDown(300)},selectedUserObj:function(userid,searchText){$("#userListUl").slideUp(300);var $treeUl=$("#treeUl"),$userTreeCon=$("#userTreeCon"),$span=$treeUl.find("span"),$userSpan=$treeUl.find("li[userid="+userid+"]>span"),$targetUl=$userSpan.parents("ul"),$targetI=$targetUl.prev("span").find(".icon-plus-sign");$span.removeClass("selected"),$userSpan.addClass("selected"),$targetI.removeClass("icon-plus-sign").addClass("icon-minus-sign"),$targetUl.slideDown(300),$("#searchUser").val(searchText);var t1=null;t1&&clearTimeout(t1),t1=setTimeout(function(){$userTreeCon.scrollTop($userSpan.offset().top+$userTreeCon.scrollTop()-300),$userTreeCon.scrollLeft($userSpan.offset().left+$userTreeCon.scrollLeft()-$treeUl.width()-15),$("#searchUser").focus()},500)}},MemberManager}(),ProjectPermissionManager=function(){function ProjectPermissionManager(){this.viewSource="/static/views/admin/userManager/projectPermissionManager.html",this.managerCtrl=new UserManagerController,this.$container=$(),this.pageViewModel={},this.i18=I18n.resource.admin.panelManagement}return ProjectPermissionManager.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get(this.viewSource).done(function(resultHtml){_this.$container=$("#permissionManageWrapper").html(resultHtml).find("#permissionManage"),$("#manageTab li[screen='AccountManager']").remove(),$("#manageTab").show(),$("#panelContentWrapper").hide(),_this.init(),I18n.fillArea($(ElScreenContainer))}).always(function(){})},setPermissionManagerHeight:function(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-62),$("#projectCon").height($(window).height()-$(".navbar").height()-185)},init:function(){this.setPermissionManagerHeight(),$("#panelContentWrapper").show();this.loadProjectPermission()},attachEvents:function(){var _this=this,$isDelUserWin=$("#isDelUserWin"),deleteUserId=null,roleOfDeleteUser=null,$permissionManage=$("#permissionManage");$("#selectProject").change(function(){this.value?($(".proCompany").hide(),$("#"+this.value).show()):$(".proCompany").show()}),$("#addProject").click(function(){ScreenManager.show(PaneProjectCreator)}),$("#permissionManage").off().on("mouseover",".proUser",function(){var $this=$(this);$this.attr("userId")!=AppConfig.userId&&$(this).find(".closed").show()}).on("mouseout",".proUser",function(){$(this).find(".closed").hide()}).on("click",".closed",function(){var $this=$(this);deleteUserId=$this.attr("userId"),roleOfDeleteUser=$this.attr("roleId"),_this.managerCtrl.setFloatingWin($isDelUserWin,300)}).on("click",".addGroup",function(){var $this=$(this);$("#groupName").val(""),$("#groupNameInfo").hide(),$(".proCompany>ul").removeClass("isAdd"),$this.parents(".addGroupWrapper").prev("ul").addClass("isAdd");var obj=$("#addGroupWin");$(".modal-dialog").css({top:($(window).height()-300)/2}),obj.modal()}),$isDelUserWin.off().on("click",".btn-primary",function(){BEOPUtil.isUndefined(deleteUserId)||BEOPUtil.isUndefined(roleOfDeleteUser)||WebAPI.post("/admin/deleteRoleUser",{roleId:roleOfDeleteUser,userId:deleteUserId}).done(function(result){result.success&&($permissionManage.find('.proList[roleId="'+roleOfDeleteUser+'"] .proUser[userId="'+deleteUserId+'"]').remove(),$isDelUserWin.modal("hide"))}).fail(function(){})}),$("#addGroupWin").off().on("click",".addGroupWinOK",function(){var $addGroupWin=$("#addGroupWin"),$roleNameInput=$("#groupName"),$groupNameInfo=$("#groupNameInfo");if(""==$roleNameInput.val())return $groupNameInfo.text(_this.i18.GROUP_NAME_NOTNULL).show(),!1;var projectId=$(".isAdd").parent(".proCompany").attr("id"),groupNameArr=[];return $("#"+projectId).find(".role").each(function(){groupNameArr.push($(this).text())}),$.inArray($roleNameInput.val(),groupNameArr)>=0?($groupNameInfo.text(_this.i18.GROUPINGNAME_NOT_REPEAT).show(),!1):($groupNameInfo.hide(),WebAPI.post("/admin/addProjectRole",{projectId:projectId,roleName:$roleNameInput.val(),userId:AppConfig.userId}).done(function(result){result.success&&_this.loadProjectPermission().done(function(result){result.success&&$addGroupWin.modal("hide")})}),$roleNameInput.val(""),void 0)}),$("#projectCon").off().on("click",".delCon",function(){var $this=$(this),$op=$this.parents(".proListWrapper"),wh=$(window).height(),$isDelWin=$("#isDelWin"),top=(wh-300)/2;$(".proListWrapper").removeClass("isDel"),$op.addClass("isDel");var dataRoleId=$this.attr("data-roleid"),dataProjectid=$this.attr("data-projectid");$("#isDelWin").attr("data-roleid",dataRoleId).attr("data-projectid",dataProjectid),$(".modal-dialog").css({top:top}),$isDelWin.modal()}),$("#isDelWin").off().on("click",".btn-primary",function(){var $isDelWin=$("#isDelWin");$isDelWin.modal("hide");var $isDel=$("#projectCon .isDel"),projectId=$isDelWin.attr("data-projectid"),roleId=$isDelWin.attr("data-roleid");WebAPI.post("/admin/deleteProjectRole",{projectId:projectId,roleId:roleId,userId:AppConfig.userId}).done(function(result){if(result.success)$isDelWin.attr("data-projectid","").attr("data-roleid",""),$isDel.remove();else{var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[result.code]);alert.showAtTop(2e3)}}).fail(function(){})}),$("#searchProjectUser").keyup(function(e){for(var $listNameAll=$("#userList .listName"),i=0;i<$listNameAll.length;i++){var $listName=$listNameAll.eq(i);$listName.text().toLowerCase().indexOf($(this).val().toLowerCase())<0?$listName.parents("li").hide():$listName.parents("li").show();

}}),$("#userList li").each(function(){this.draggable=!0,this.ondragstart=function(e){var $this=$(this),userInfo={userId:$this.attr("userid"),userName:$this.find(".listName").text(),userPic:$this.attr("userPic")};$("#dragObj").val("user"),e.dataTransfer.setData("user",JSON.stringify(userInfo))}}),$(".proUser").each(function(){this.draggable=!0,this.ondragstart=function(e){var $this=$(this),userInfo={userId:$this.attr("userid"),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser"),e.dataTransfer.setData("itemUser",JSON.stringify(userInfo))}}),$(".proList").each(function(){this.ondragover=function(e){e.preventDefault()},this.ondrop=_this.dropUserToRoleEvent}),$("#projectCon").off("click",".setPage").on("click",".setPage",function(){Spinner.spin(ElScreenContainer);var wh=$(window).height(),top=(wh-500)/2;$("#pageSet .modal-dialog").css({top:top});var $this=$(this),projectId=$this.data("projectid"),roleId=$this.data("roleid");WebAPI.post("/admin/loadPageMenu",{projectId:projectId,roleId:roleId}).done(function(result){if(result.success){var $menuTree,data=result.data,nav=data.nav,$pageSet=$("#pageSet");nav&&nav.length?($menuTree=_this.buildMenuTree(nav),$pageSet.find(".winCon").empty().append($menuTree),$pageSet.find("#savePageMenu").attr("project-id",projectId).attr("role-id",roleId),_this.renderTreeView()):$pageSet.find(".winCon").empty().append(_this.i18.MENU_NOT_CONFIGURED+"！"),I18n.fillArea($(ElScreenContainer)),$pageSet.modal()}}).always(function(){Spinner.stop()})}),$("#pageSet").off().on("click","input:checkbox",function(){var $this=$(this),parent_liL=$this.parents(".parent_li").length;if(parent_liL){var $parent_li=$this.parents(".parent_li"),$rootSpan=$parent_li.children("span"),$ul=$rootSpan.next("ul"),$label=$this.parents("label"),$checkboxRoot=$rootSpan.find("input:checkbox"),$checkboxLeaf=$ul.find("input:checkbox"),iL=$label.prev("i").length;if($this.is(":checked"))iL?$checkboxLeaf.each(function(){this.checked=!0}):$checkboxRoot[0].checked=!0;else if(iL)$checkboxLeaf.each(function(){this.checked=!1});else{var inputCheckL=$ul.find("input:checkbox:checked").length;inputCheckL||$checkboxRoot.attr("checked",!1)}}}),$("#savePageMenu").click(function(){var $pageSet=$("#pageSet");if(0===$pageSet.find(".winCon ul").size())return $pageSet.modal("hide"),!1;var allTopNavChecked=$pageSet.find("input.topNav:checked").map(function(){return $(this).val()}).get(),allFuncNavChecked=$pageSet.find("input.funcNav:checked").map(function(){return $(this).val()}).get(),$this=$(this),projectId=$this.attr("project-id"),roleId=$this.attr("role-id");$this.button("loading"),WebAPI.post("/admin/savePageMenu",{projectId:projectId,roleId:roleId,topNavList:allTopNavChecked,funcNavList:allFuncNavChecked}).done(function(result){if(result.success){var alert=new Alert($pageSet.find(".modal-content").get(0),Alert.type.success,I18n.resource.code[result.code]);alert.showAtTop(2e3),setTimeout(function(){$pageSet.modal("hide")},1e3)}}).always(function(){$this.button("reset"),I18n.fillArea($(ElScreenContainer))})}),$(window).on("resize.permissionManager",function(){_this.setPermissionManagerHeight(),_this.setUserListPosition()})},detachEvents:function(){$(window).off("resize.permissionManager")},close:function(){this.detachEvents()},dropUserToRoleEvent:function(e){Spinner.spin(ElScreenContainer),e.preventDefault();var $target=$(e.target),dragObjStr=$("#dragObj").val();if($target.hasClass("proList")||($target=$target.closest(".proList")),"user"==dragObjStr)var data=JSON.parse(e.dataTransfer.getData("user"));else var data=JSON.parse(e.dataTransfer.getData("itemUser"));var isExisted=!1;if(!data)return void Spinner.stop();if($target.find(".userId").each(function(){return $(this).attr("userid")==data.userId?(isExisted=!0,void Spinner.stop()):void 0}),!isExisted){var roleId=$target.attr("roleId");if("itemUser"==dragObjStr){if(AppConfig.userId==data.userId)return Spinner.stop(),!1;var dragRoleId=data.roleid;if(roleId===dragRoleId)return Spinner.stop(),!1}if("undefined"==typeof data.userId||"undefined"==typeof roleId)return Spinner.stop(),!1;"user"==dragObjStr?WebAPI.post("/admin/addRoleUser",{roleId:roleId,userId:data.userId}).done(function(result){return result.success&&(data.roleId=roleId,$target.find(".userList").append(beopTmpl("proUserTmpl",data)),$target.find(".proUser").each(function(){this.draggable=!0,this.ondragstart=function(e){var $this=$(this),userInfo={userId:$this.attr("userid"),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser"),e.dataTransfer.setData("itemUser",JSON.stringify(userInfo))}})),!1}).fail(function(){var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.panelManagement.REQUEST_ERROR);alert.showAtTop(2e3)}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()}):WebAPI.post("/admin/deleteRoleUser",{roleId:dragRoleId,userId:data.userId}).then(function(result){result.success&&($("#permissionManage").find('.proList[roleId="'+dragRoleId+'"] .proUser[userId="'+data.userId+'"]').remove(),$("#isDelUserWin").modal("hide")),WebAPI.post("/admin/addRoleUser",{roleId:roleId,userId:data.userId}).done(function(result){return result.success&&(data.roleId=roleId,$target.find(".userList").append(beopTmpl("proUserTmpl",data)),$target.find(".proUser").each(function(){this.draggable=!0,this.ondragstart=function(e){var $this=$(this),userInfo={userId:$this.attr("userid"),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser"),e.dataTransfer.setData("itemUser",JSON.stringify(userInfo))}})),!1}).fail(function(){var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.panelManagement.REQUEST_ERROR);alert.showAtTop(2e3)}).always(function(){I18n.fillArea($(ElScreenContainer)),Spinner.stop()})})}},loadProjectPermission:function(){var _this=this;return WebAPI.post("/admin/loadProjectPermission",{userId:AppConfig.userId}).done(function(result){result.success&&(_this.pageViewModel=result.data,_this.renderSelectProject(),_this.renderUserList(),_this.renderProjectList(),_this.attachEvents(),I18n.fillArea($(ElScreenContainer)))}).always(function(){Spinner.stop()})},setUserListPosition:function(){var $manageTab=$("#manageTab");$("#staffList").css({left:$manageTab.width()+30})},renderSelectProject:function(){var compiledTemplate=beopTmpl("selectProjectListTmpl",this.pageViewModel);$("#selectProject").html(compiledTemplate)},renderUserList:function(){var compiledTemplate=beopTmpl("userListTmpl",this.pageViewModel);$("#userList").html(compiledTemplate),this.setUserListPosition(),$("#staffList").show()},renderProjectList:function(){var compiledTemplate=beopTmpl("permissionManageTmpl",this.pageViewModel);$("#projectCon").html(compiledTemplate)},buildMenuTree:function(nav){for(var buildMenuTreeItem=function(item){return beopTmpl("menuTreeItemTmpl",item)},$html=$("<ul></ul>"),i=0,length=nav.length;length>i;i++){var root=nav[i],$root=$(buildMenuTreeItem(root));$root.append(this.managerCtrl.buildSubTree(buildMenuTreeItem,root)),$html.append($root)}return $html},renderTreeView:function(){$(".tree li:has(ul)").addClass("parent_li").find(" > span"),$(".tree li.parent_li > span > i").on("click",function(e){var children=$(this).closest("li.parent_li").find(" > ul > li");children.is(":visible")?(children.hide("fast"),$(this).parent("span").find(" > i").addClass("icon-plus-sign").removeClass("icon-minus-sign")):(children.show("fast"),$(this).parent("span").find(" > i").addClass("icon-minus-sign").removeClass("icon-plus-sign")),e.stopPropagation()})}},ProjectPermissionManager}(),PaneProjectCreator=function(){function FlowControl(){this.$btnPrev=$("#btnPrev"),this.$btnNext=$("#btnNext"),this.$panes=$(".step-pane"),this.$crumbs=$(".reg-wizard > ul li"),this.step=0,this.totalStep=this.$panes.length}function PaneProjectCreator(){this.map=null,this.flowCtl=null,this.formValidInfo={"#iptPjName":0,"#iptPjAddr":0,"#iptPjCity":0}}var util={tooltip:{show:function($ele,cnt){$ele.attr("data-original-title",cnt),$ele.tooltip("show"),$ele[0].timer&&(window.clearTimeout($ele[0].timer),$ele[0].timer=null),$ele[0].timer=window.setTimeout(function(){$ele.tooltip("hide")},3e3)},hide:function($ele){$ele.tooltip("hide")}},inputbox:{changeStatus:function($ele,status){var $wrap=$ele.parent("div"),$icon=$ele.siblings(".glyphicon"),cls=$icon.attr("class").replace(/\s*\b(?:glyphicon-).+?\b\s*/," ").trim();switch($icon.attr("class",cls),status){case"success":$wrap.addClass("has-success"),$icon.addClass("glyphicon-ok");break;case"error":$wrap.addClass("has-error"),$icon.addClass("glyphicon-remove");break;case"default":default:$wrap.removeClass("has-error has-success"),$icon.addClass("glyphicon-pencil")}}},upload:{readURL:function(ele,onSuccess,onError){var file;if(!ele.files||!ele.files[0])return alert("上传文件出错了，请刷新页面后重试！"),"function"==typeof onError&&onError(1),!1;if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))return alert("当前浏览器不支持最新的文件接口！"),"function"==typeof onError&&onError(2),!1;if("undefined"==typeof FileReader)return alert("当前浏览器不支持 FileReader 接口！"),"function"==typeof onError&&onError(3),!1;if(file=ele.files[0],!/image/i.test(file.type))return alert("当前文件不是图片，请选择正确的图片进行上传！"),"function"==typeof onError&&onError(4),!1;var reader=new FileReader;reader.onload=onSuccess,reader.readAsDataURL(file)}}};return FlowControl.prototype.prev=function(){this.to(this.step-1)},FlowControl.prototype.next=function(){this.to(this.step+1)},FlowControl.prototype.to=function(step){var $pane;return step=Math.min(Math.max(1,step),this.totalStep),this.step===step?!1:($pane=this.$panes.filter("[data-prograss="+step+"]"),$crumb=this.$crumbs.filter("[data-step="+step+"]"),$pane&&$pane.length?(this.step=step,this.refreshStatus(),$pane.addClass("active"),$crumb&&$crumb.length&&$crumb.addClass("active"),!0):!1)},FlowControl.prototype.refreshStatus=function(){var $crumb;this.$btnPrev.prop("disabled",this.step<=1?!0:!1),this.$btnNext.prop("disabled",this.step>=this.totalStep?!0:!1),this.$panes.removeClass("active"),this.$crumbs.removeClass("active complete");for(var i=this.$crumbs.length-1;i>=0;i--)$crumb=this.$crumbs.eq(i),parseInt($crumb.attr("data-step"))<this.step&&$crumb.addClass("complete")},PaneProjectCreator.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get("/static/views/admin/paneProjectCreator.html").done(function(resultHtml){Spinner.stop(),$(ElScreenContainer).html(resultHtml),I18n.fillArea($("#reg-wizard").not("input, .map_wrap")),I18n.fillAreaAttribute($(".pi_left_ct").eq(0).find("input"),"placeholder"),_this.init()})},init:function(){var _this=this;this.flowCtl=new FlowControl,this.flowCtl.to(1),beop.baseMap.load(function(map){_this.map=map,_this.attachMapEvents(),_this.map.addSearchBox("#btnMapSch","#mapSchPane")}),this.attachEvents()},validForm:function(onErrorHandler){var error=0;for(ctl in this.formValidInfo)this.formValidInfo.hasOwnProperty(ctl)&&1!==this.formValidInfo[ctl]&&(error+=1,typeof onErrorHandler&&onErrorHandler.call($(ctl)));return 0>=error},attachEvents:function(){var _this=this,$pjName=$("#iptPjName"),$pjAddr=$("#iptPjAddr"),$pjCity=$("#iptPjCity"),$pjLnglat=$("#iptPjLnglat"),$btnSubmit=$("#btnSubmit"),$btnPrevStep=$("#btnPrev"),$btnNextStep=$("#btnNext"),$imgPreview=$("#imgPreview"),$pjFile=$("#iptPjFile"),$btnUploadCSV=$("#btnUploadCSV"),$spUploadInfo=$("#spUploadInfo"),$pjData=$("#iptPjData"),$divPjDataDropHandler=$("#divPjDataDropHandler"),$tip=$divPjDataDropHandler.children("p"),$uploadMask=$("#uploadMask"),$body=$("body"),isDataUploadReady=!0,isImgUploadReady=!1,uploadHandler=null,fileSelected=null,dragFix=!1;$pjName.tooltip({title:"",trigger:"manual"}),$pjAddr.tooltip({title:"",trigger:"manual"}),$pjCity.tooltip({title:"",trigger:"manual"}),$spUploadInfo.tooltip({title:"",trigger:"manual",placement:"right"}),$btnPrevStep.click(function(){_this.flowCtl.prev()}),$btnNextStep.click(function(){_this.validForm(function(){$(this).trigger("blur")})&&_this.flowCtl.next()}),$pjName.blur(function(e){var $this=$(this),$wrapDiv=$this.parent("div"),value=$this.val().replace(/^\s+|\s+$/g,"");return _this.formValidInfo["#iptPjName"]=0,value?/[^A-Za-z0-9]/.test(value)?(_this.formValidInfo["#iptPjName"]=0,util.tooltip.show($this,I18n.resource.admin.projectCreator.ERROR_WRONG_CRITERIA),void util.inputbox.changeStatus($this,"error")):(util.inputbox.changeStatus($this,"default"),WebAPI.post("/proj_name/check",{proName:value}).done(function(result){return result=eval("("+result+")"),result.status?(_this.formValidInfo["#iptPjName"]=1,void util.inputbox.changeStatus($this,"success")):(_this.formValidInfo["#iptPjName"]=0,util.tooltip.show($this,I18n.resource.admin.projectCreator.ERROR_EXIST_NAME),void util.inputbox.changeStatus($this,"error"))}),void e.preventDefault()):(_this.formValidInfo["#iptPjName"]=0,util.tooltip.show($this,I18n.resource.admin.projectCreator.ERROR_NOT_EMPTY),void util.inputbox.changeStatus($this,"error"))}).focus(function(e){util.tooltip.hide($(this)),e.preventDefault()}),$pjAddr.blur(function(e){var $this=$(this),val=$this.val().trim();return""===val?(_this.formValidInfo["#iptPjAddr"]=0,void util.tooltip.show($this,I18n.resource.admin.projectCreator.ERROR_NOT_CHOOSE_ADDRESS)):(_this.formValidInfo["#iptPjAddr"]=1,void e.preventDefault())}),$pjCity.blur(function(e){var $this=$(this),val=$this.val().trim();return""===val?(_this.formValidInfo["#iptPjCity"]=0,void util.tooltip.show($this,I18n.resource.admin.projectCreator.ERROR_NOT_CHOOSE_ADDRESS)):(_this.formValidInfo["#iptPjCity"]=1,void e.preventDefault())}),$imgPreview.click(function(e){$pjFile.click(),e.preventDefault()}),$pjFile.change(function(e){var file=$(this)[0].files[0];return".jpg"!==file.name.match(/\.[A-Za-z0-9]+$/)[0].toLowerCase()?(isImgUploadReady=!1,void alert("图片格式有误，请上传正确的 .jpg 格式文件！")):(util.upload.readURL($(this)[0],function(e){$("#imgPreview").attr("src",e.target.result),isImgUploadReady=!0},function(errCode){isImgUploadReady=!1}),void e.preventDefault())}),$btnUploadCSV.click(function(e){$pjData.click()}),uploadHandler=function(file){var formData=new FormData,match=file.name.match(/\.[A-Za-z0-9]+$/),supportFiles=[".csv",".xls",".xlsx"];return!file||!match||supportFiles.indexOf(match[0])<0?(util.tooltip.show($spUploadInfo,"文件格式有误，请上传正确的 .csv/.xls/.xlsx 格式文件！"),void(isDataUploadReady=!1)):(fileSelected=file,formData.append("config-file",file),$btnUploadCSV.prop("disabled",!0),void $.ajax({url:"/get_config_data/"+AppConfig.userId,type:"post",data:formData,dataType:"json",xhr:function(){var xhr=$.ajaxSettings.xhr();return xhr.upload&&(xhr.upload.addEventListener("progress",function(e){var progress=Math.round(e.loaded/e.total*100);e.lengthComputable&&$spUploadInfo.html("正在上传..."+progress+"%")},!1),xhr.upload.addEventListener("load",function(e){$spUploadInfo.html("正在处理数据...")},!1)),xhr},cache:!1,contentType:!1,processData:!1}).done(function(rs){$spUploadInfo.removeClass().addClass("text-success").html("上传成功 - "+file.name)}).fail(function(err){$spUploadInfo.removeClass().addClass("text-danger").html("上传失败，文件中有错误！")}).always(function(){$btnUploadCSV.prop("disabled",!1)}))},$pjData.change(function(){var $this=$(this),file=$this[0].files[0];uploadHandler(file)}),$divPjDataDropHandler.on("dragenter",function(e){dragFix=!0,$tip.html("松开鼠标开始上传"),e.preventDefault(),e.stopPropagation()}),$divPjDataDropHandler.on("dragleave",function(e){dragFix=!1,$tip.html("请将文件拖拽到此处进行上传"),e.preventDefault()}),$divPjDataDropHandler.on("drop",function(e){var files,file;$divPjDataDropHandler.hide(),$uploadMask.hide(),$tip.html("请将文件拖拽到此处进行上传"),files=e.originalEvent.dataTransfer.files,files.length>1&&alert("请注意：\n目前系统不支持同时上传多个文件，将会使用您选择的第一个文件进行上传！"),file=files[0],uploadHandler(file),e.stopPropagation(),e.preventDefault()}),$uploadMask.on("dragenter",function(e){e.stopPropagation()}),$uploadMask.on("dragleave",function(e){e.stopPropagation(),dragFix||($uploadMask.hide(),$divPjDataDropHandler.hide())}),$body.on("dragenter",function(e){$divPjDataDropHandler.show(),$uploadMask.show(),e.preventDefault()}),$body.on("keydown",function(e){27===e.keyCode&&($uploadMask.hide(),$divPjDataDropHandler.hide(),e.preventDefault())}),$body.add($uploadMask).add($divPjDataDropHandler).on("dragover",function(e){e.preventDefault()}),$body.on("drop",function(e){$uploadMask.hide(),$divPjDataDropHandler.hide(),e.preventDefault()}),$btnSubmit.click(function(){var formData=new FormData;isImgUploadReady&&formData.append("pro-pic-file",$pjFile[0].files[0]),formData.append("userId",AppConfig.userId),formData.append("userName",AppConfig.account),formData.append("projName",$pjName.val().trim()),formData.append("address",$pjAddr.val()),formData.append("latlng",$pjLnglat.val()),formData.append("weatherStationId",101020100),fileSelected&&formData.append("dataFileName",fileSelected.name),Spinner.spin($("body")[0]),$.ajax({url:"/project/create",type:"post",data:formData,dataType:"json",cache:!1,contentType:!1,processData:!1}).done(function(rs){"object"==typeof rs&&"successful"===rs.error?(alert("项目创建成功，需要您重新登录系统！"),window.location.reload()):alert("服务器正在忙碌，请稍后重试！")}).fail(function(e){alert("服务器正在忙碌，请稍后重试！")}).always(function(e){Spinner.stop()})}),$("#cancelRegist").click(function(){ScreenManager.show(UserManagerController,ProjectPermissionManager)})},attachMapEvents:function(){var _this=this;this.map.addListener("click",function(e){var point=e.lnglat;_this.map.removeAllMarkers(),_this.map.addMarker(point.lng,point.lat),_this.map.setFitView(),_this.map.getAddress(point.lng,point.lat,function(rs){if(0===rs.status){rs=rs.data;var $pjAddr=$("#iptPjAddr"),$pjCity=$("#iptPjCity"),$pjLnglat=$("#iptPjLnglat"),components=rs[0].components,city=components.city||components.province||rs[0].name;$pjAddr.val(rs[0].name),$pjCity.val(city),$pjLnglat.val(point.lat+","+point.lng),_this.formValidInfo["#iptPjAddr"]=1,_this.formValidInfo["#iptPjCity"]=1,util.inputbox.changeStatus($pjAddr,"success"),util.inputbox.changeStatus($pjCity,"success")}})})},detachEvents:function(){$("#iptPjName").tooltip("destroy"),$("#iptPjAddr").tooltip("destroy"),$("#iptPjCity").tooltip("destroy"),$("#btnPrev").unbind(),$("#btnNext").unbind(),$("#iptPjName").unbind(),$("#iptPjAddr").unbind(),$("#iptPjCity").unbind(),$("#imgPreview").unbind(),$("#iptPjFile").unbind(),$("#divPjDataDropHandler").off(),$("#uploadMask").off,$("body").off()},close:function(){this.detachEvents(),this.map.destroy()}},PaneProjectCreator}(),PaneProjectConfigure;PaneProjectConfigure=function(){function PaneProjectConfigure(){this.proName=void 0,this.stepCur=void 0,this.stepNext=void 0,this.stepPre=void 0,this.stepPreShow=void 0,this.stepAll=void 0,this.curPic=void 0,this.nextPic=void 0,this.prePic=void 0,this.preShowPic=void 0,this.allPic=void 0,this.initData=void 0,this.chartData=void 0,this.dataFlag=void 0,this.nameFlag=void 0,this.btnNext=void 0,this.scrollRange=void 0,this.i18=I18n.resource.admin.projectConfigure}return PaneProjectConfigure.prototype={show:function(){var _this=this;$.get("/static/views/admin/paneProjectConfigure.html").done(function(resultHtml){$("#indexMain").html(resultHtml),_this.init()})},init:function(){this.stepCur=0,this.stepNext=-1,this.stepPre=-1,this.stepPreShow=-1,this.stepAll=4,this.curPic=0,this.nextPic=-1,this.prePic=-1,this.preShowPic=-1,this.allPic=$(".step3LiLg").length,this.dataFlag=0,this.nameFlag=0,this.btnNext=this.i18.NEXT,this.btnFinish=this.i18.FINISH;var _this=this,windowWidth=$(window).width();windowWidth>1200?this.scrollRange=6:windowWidth>992?this.scrollRange=5:(this.scrollRange=3,this.scrollRange=3),_this.stepInit(),$("#returnMain").click(function(){ScreenManager.show(""!=$("#ulLogin").text()?IndexScreen:ProjectManager)}),$(".configNavA").click(function(){if(!$(this).hasClass("configNavEdit")){var i=$(".configNavA").index(this);i>-1?(_this.stepJump(i),_this.wholeJudge()):alert("No configNavA exist.")}}),$("#stepPre").click(function(){_this.stepMinus()}),$("#stepNext").click(function(){_this.stepPlus()}),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){$(e.target)[0].id;3==_this.stepCur&&_this.chartDraw()}),$("#newProName").change(function(e){var $newProName=$("#newProName");null==$newProName.val()||void 0==$newProName.val()||""==$newProName.val()?_this.dataFlag=0:_this.dataFlag=1,_this.dataFlag&&_this.nameFlag?$("#configNavA4").removeClass("disabled"):$("#configNavA4").addClass("disabled")}),$("#newProData").change(function(e){document.getElementById("newProPath").value=this.value,_this.uploadConfigData()}),$("#step2-data-delete").click(function(){_this.tableInit()}),$("#step2DataDllSel").click(function(e){for(var arr=document.getElementsByClassName("chk-flag"),i=0;i<arr.length;i++)arr[i].checked=!0}),$("#step2DataReverseSel").click(function(e){for(var arr=document.getElementsByClassName("chk-flag"),i=0;i<arr.length;i++)arr[i].checked=!arr[i].checked}),_this.modelSelInit(),_this.btnlgInit(),_this.btnsmInit(),_this.smallPicSelected(),$("#step3BtnLgLeft").click(function(){_this.modelSelMinus()}),$("#step3BtnLgRight").click(function(){_this.modelSelPlus()}),$(".step3LiSm").click(function(){if("step3ModelSelSm"!=$(this).attr("class")){var i=$(".step3LiSm").index(this);_this.modelSelJump(i),_this.btnlgInit(),_this.smallPicSelected()}}),$("#step3BtnSmLeft").click(function(){var $step3ModelNavUl=$("#step3ModelNavUl"),$step3BtnSmRight=$("#step3BtnSmRight"),leftPosition=$step3ModelNavUl.css("left"),leftPositionNum=Number(leftPosition.substring(0,leftPosition.length-2));leftPosition=leftPositionNum+147+"px";var bestLeftNum=147*-($(".step3LiSm").length-_this.scrollRange);"0px"==leftPosition&&($(this).hasClass("disabled")||$(this).addClass("disabled")),leftPositionNum+147>bestLeftNum&&$step3BtnSmRight.hasClass("disabled")&&$step3BtnSmRight.removeClass("disabled"),"stop"==$step3ModelNavUl.attr("rel")&&($step3ModelNavUl.attr("rel","moving"),$step3ModelNavUl.stop(),$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr("rel","stop")}))}),$("#step3BtnSmRight").click(function(){var $step3ModelNavUl=$("#step3ModelNavUl"),$step3BtnSmLeft=$("#step3BtnSmLeft"),leftPosition=$step3ModelNavUl.css("left"),leftPositionNum=Number(leftPosition.substring(0,leftPosition.length-2));leftPosition=leftPositionNum-147+"px";var bestLeftNum=147*-($(".step3LiSm").length-_this.scrollRange);leftPositionNum-147==bestLeftNum&&$(this).addClass("disabled"),0==leftPositionNum&&$step3BtnSmLeft.hasClass("disabled")&&$step3BtnSmLeft.removeClass("disabled"),"stop"==$step3ModelNavUl.attr("rel")&&($step3ModelNavUl.attr("rel","moving"),$step3ModelNavUl.stop(),$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr("rel","stop")}))})},stepInit:function(){this.stepNext=this.stepCur+1,this.stepPre=this.stepAll-1},stepPlus:function(){var $stepPre=$("#stepPre"),$stepNext=$("#stepNext");this.stepCur<this.stepAll-1&&(this.stepPre=this.stepCur,this.stepCur=this.stepNext,this.stepNext=this.stepCur+1,this.stepPreShow=this.stepPre,$("#configNavA"+(this.stepCur+1)).tab("show")),$("#configNavSpan"+(this.stepPre+1)).removeClass("glyphicon-edit configNavEdit").addClass("glyphicon-check configNavComplete"),$("#configNavSpan"+(this.stepCur+1)).removeClass("glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete").addClass("glyphicon-edit configNavEdit"),this.wholeJudge(),this.stepCur>0&&$stepPre.hasClass("disabled")&&$stepPre.removeClass("disabled"),this.stepCur==this.stepAll-1&&($stepNext.text()!=this.btnFinish?$stepNext.text(this.btnFinish):this.finalDataUpload())},stepMinus:function(){var $stepPre=$("#stepPre"),$stepNext=$("#stepNext");this.stepNext=this.stepCur,this.stepCur=this.stepPre,this.stepPre=this.stepCur-1,this.stepPreShow=this.stepNext,$("#configNavA"+(this.stepCur+1)).tab("show"),$("#configNavSpan"+(this.stepNext+1)).removeClass("glyphicon-edit configNavEdit").addClass("glyphicon-check configNavComplete"),$("#configNavSpan"+(this.stepCur+1)).removeClass("glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete").addClass("glyphicon-edit configNavEdit"),this.wholeJudge(),0!=this.stepCur||$stepPre.hasClass("disabled")||$stepPre.addClass("disabled"),this.stepCur<this.stepAll&&$stepNext.text()!=this.btnNext&&$stepNext.text(this.btnNext)},stepJump:function(num){var $stepPre=$("#stepPre"),$stepNext=$("#stepNext");this.stepPreShow=this.stepCur,this.stepCur=num,this.stepPre=num-1,this.stepNext=num+1,$("#configNavSpan"+(this.stepPreShow+1)).removeClass("glyphicon-edit configNavEdit").addClass("glyphicon-check configNavComplete"),$("#configNavSpan"+(this.stepCur+1)).removeClass("glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete").addClass("glyphicon-edit configNavEdit"),0==this.stepCur?($stepPre.addClass("disabled"),$stepNext.text(this.btnNext)):this.stepCur==this.stepAll-1?($stepNext.text(this.btnFinish),$stepPre.removeClass("disabled")):($stepPre.removeClass("disabled"),$stepNext.text(this.btnNext))},dataJudge:function(){var dataFlag=0;return void 0==this.chartData||0==this.chartData[0].value.length?($("#configNavSpan2").removeClass("glyphicon-check glyphicon-edit configNavPend configNavComplete configNavEdit").addClass("glyphicon-exclamation-sign configNavErr"),dataFlag=0):($("#configNavSpan2").removeClass("glyphicon-exclamation-sign configNavErr").addClass("glyphicon-check configNavComplete"),dataFlag=1),dataFlag},proNameJudge:function(){var $newProName=$("#newProName"),nameFlag=0;return null==$newProName.val()||void 0==$newProName.val()||""==$newProName.val()?($("#configNavSpan1").removeClass("glyphicon-check glyphicon-edit configNavPend configNavComplete configNavEdit").addClass("glyphicon-exclamation-sign configNavErr"),nameFlag=0):($("#configNavSpan1").removeClass("glyphicon-exclamation-sign configNavErr").addClass("glyphicon-check configNavComplete"),nameFlag=1),nameFlag},wholeJudge:function(){var $stepNext=$("#stepNext");0==this.stepPreShow&&(this.nameFlag=this.proNameJudge()),1==this.stepPreShow&&(this.dataGet(),this.dataFlag=this.dataJudge()),this.dataFlag&&this.nameFlag?($stepNext.removeClass("disabled"),$("#configNavA4").removeClass("disabled")):($("#configNavA4").addClass("disabled"),2==this.stepCur?$stepNext.addClass("disabled"):$stepNext.removeClass("disabled"))},tableInit:function(){var $initData=$("#initData");$initData.find("thead").remove(),$initData.find("tr").remove(),this.initData=void 0,this.chartData=void 0},modelSelInit:function(){this.allPic>1?(this.nextPic=this.curPic+1,this.prePic=this.allPic-1):1==this.allPic&&(this.nextPic=0,this.prePic=0),$(".step3LiLg:eq("+this.curPic+")").fadeIn().css("display","inline")},modelSelPlus:function(){var $step3LiLg=$(".step3LiLg"),$step3BtnLgLeft=$("#step3BtnLgLeft");this.preShowPic=this.curPic,this.prePic=this.curPic,this.curPic=this.nextPic,this.curPic<this.allPic-1?this.nextPic=this.curPic+1:this.curPic==this.allPic-1&&(this.nextPic=0),$step3LiLg.eq(this.curPic).fadeIn().css("display","inline"),this.preShowPic!=this.curPic&&$step3LiLg.eq(this.preShowPic).css("display","none"),this.btnsmInit(),this.smallPicSelected(),this.smallPicScroll(),this.curPic==this.allPic-1&&$("#step3BtnLgRight").addClass("disabled"),this.curPic>0&&$step3BtnLgLeft.hasClass("disabled")&&$step3BtnLgLeft.removeClass("disabled")},modelSelMinus:function(){var $step3LiLg=$(".step3LiLg"),$step3BtnLgRight=$("#step3BtnLgRight");this.preShowPic=this.curPic,this.nextPic=this.curPic,this.curPic=this.prePic,this.curPic>0?this.prePic=this.curPic-1:0==this.curPic&&this.allPic>1&&(this.prePic=this.allPic-1),$step3LiLg.eq(this.curPic).fadeIn().css("display","inline"),this.preShowPic!=this.curPic&&$step3LiLg.eq(this.preShowPic).css("display","none"),this.btnsmInit(),this.smallPicSelected(),this.smallPicScroll(),0==this.curPic&&$("#step3BtnLgLeft").addClass("disabled"),this.curPic<this.allPic-1&&$step3BtnLgRight.hasClass("disabled")&&$step3BtnLgRight.removeClass("disabled")},modelSelJump:function(num){var $step3LiLg=$(".step3LiLg");this.preShowPic=this.curPic,this.curPic=num,this.curPic==this.allPic-1?(this.nextPic=0,this.allPic>1?this.prePic=this.curPic-1:1==this.allPic&&(this.prePic=0)):0==this.curPic?(this.prePic=this.allPic-1,this.allPic>1?this.nextPic=1:1==this.allPic&&(this.nextPic=0)):(this.nextPic=this.curPic+1,this.prePic=this.curPic-1),$step3LiLg.eq(this.curPic).fadeIn().css("display","inline"),this.preShowPic!=this.curPic&&$step3LiLg.eq(this.preShowPic).css("display","none")},btnlgInit:function(){var $step3BtnLgLeft=$("#step3BtnLgLeft"),$step3BtnLgRight=$("#step3BtnLgRight");this.allPic<2?($step3BtnLgLeft.addClass("disabled"),$step3BtnLgRight.addClass("disabled")):0==this.curPic?($step3BtnLgLeft.addClass("disabled"),$step3BtnLgRight.removeClass("disabled")):this.curPic==this.allPic-1?($step3BtnLgRight.addClass("disabled"),$step3BtnLgLeft.removeClass("disabled")):($step3BtnLgRight.removeClass("disabled"),$step3BtnLgLeft.removeClass("disabled"))},btnsmInit:function(){var $step3BtnSmLeft=$("#step3BtnSmLeft"),$step3BtnSmRight=$("#step3BtnSmRight");this.curPic>2&&this.allPic-this.curPic>4?($step3BtnSmLeft.hasClass("disabled")&&$step3BtnSmLeft.removeClass("disabled"),$step3BtnSmRight.hasClass("disabled")&&$step3BtnSmRight.removeClass("disabled")):this.curPic<3?($step3BtnSmLeft.hasClass("disabled")||$step3BtnSmLeft.addClass("disabled"),this.allPic>6?$step3BtnSmRight.hasClass("disabled")&&$step3BtnSmRight.removeClass("disabled"):$step3BtnSmRight.hasClass("disabled")||$step3BtnSmRight.addClass("disabled")):this.curPic>this.allPic-4&&($step3BtnSmRight.hasClass("disabled")||$step3BtnSmRight.addClass("disabled"),this.allPic>6?$step3BtnSmLeft.hasClass("disabled")&&$step3BtnSmLeft.removeClass("disabled"):$step3BtnSmLeft.hasClass("disabled")||$step3BtnSmLeft.addClass("disabled"))},smallPicSelected:function(){var $step3LiSm=$(".step3LiSm");$step3LiSm.eq(this.curPic).hasClass("step3ModelSelSm")||$step3LiSm.eq(this.curPic).addClass("step3ModelSelSm"),-1!=this.preShowPic&&$step3LiSm.eq(this.preShowPic).hasClass("step3ModelSelSm")&&$step3LiSm.eq(this.preShowPic).removeClass("step3ModelSelSm")},smallPicScroll:function(){var $step3ModelNavUl=$("#step3ModelNavUl"),$step3LiSm=$(".step3LiSm");if(this.curPic!=this.preShowPic){var leftPosition=0;this.curPic>2&&this.curPic<$step3LiSm.length-3?leftPosition=147*-(this.curPic-2):this.curPic>$step3LiSm.length-4&&$step3LiSm.length>6&&(leftPosition=147*-($step3LiSm.length-this.scrollRange)),leftPosition+="px",$step3ModelNavUl.attr("rel","moving"),$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr("rel","stop")})}},uploadConfigData:function(){var _this=this,fileObj=document.getElementById("newProData").files[0],form=new FormData;void 0!=this.initData&&this.tableInit(),form.append("config-file",fileObj);var xhr=new XMLHttpRequest;xhr.onload=function(){4==xhr.readyState&&200==xhr.status?(_this.initData=JSON.parse(xhr.responseText),new UploadConfigData(_this.initData).show()):alert(this.i18.READ_DATA_FAILED)},xhr.open("post","/get_config_data",!0),xhr.send(form)},dataGet:function(){if(void 0!=this.initData){for(var selDateNum=$(".chkPtSel input:checked").length,ptSelData=new Array,i=0;i<this.initData.length;++i)ptSelData[i]=new Object,ptSelData[i].pointName=this.initData[i].pointName,ptSelData[i].value=new Array;this.proName=$("#newProName").val();for(var selIndex,i=0;selDateNum>i;++i){selIndex=$(".chkPtSel input:checked").eq(i).closest("tr").index();for(var j=0;j<this.initData.length;++j)ptSelData[j].value.push(this.initData[j].value[selIndex])}this.chartData=ptSelData}},chartDraw:function(){var myChart1=echarts.init(document.getElementById("step4Chart1")),myChart2=echarts.init(document.getElementById("step4Chart2")),myChart3=echarts.init(document.getElementById("step4Chart3")),myChart4=echarts.init(document.getElementById("step4Chart4")),legendData=new Array,seriesData1=new Array,seriesData2=new Array,xAxisData=new Array;

legendData.push("2013"+this.chartData[0].pointName),legendData.push("2014"+this.chartData[0].pointName);for(var i=0;i<this.chartData[0].value.length/2;++i)xAxisData[i]=this.chartData[0].value[i].time.substr(5);for(var i=0;i<this.chartData[0].value.length/2;++i)seriesData1.push(this.chartData[0].value[i].value);for(var i=this.chartData[0].value.length/2;i<this.chartData[0].value.length;++i)seriesData2.push(this.chartData[0].value[i].value);var option1={backgroundColor:"rgba(0,0,0,0)",grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:"axis"},legend:{data:legendData},toolbox:{show:!1},calculable:!0,xAxis:[{type:"category",data:xAxisData}],yAxis:[{type:"value"}],series:[{name:"2013低温冰机",type:"line",data:seriesData1},{name:"2014低温冰机",type:"line",data:seriesData2}]};legendData=new Array,seriesData1=new Array,seriesData2=new Array,xAxisData=new Array,legendData.push("2013"+this.chartData[1].pointName),legendData.push("2014"+this.chartData[1].pointName);for(var i=0;i<this.chartData[1].value.length/2;++i)xAxisData[i]=this.chartData[1].value[i].time.substr(5);for(var i=0;i<this.chartData[1].value.length/2;++i)seriesData1.push(this.chartData[1].value[i].value);for(var i=this.chartData[1].value.length/2;i<this.chartData[1].value.length;++i)seriesData2.push(this.chartData[1].value[i].value);var option2={backgroundColor:"rgba(0,0,0,0)",grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:"axis"},legend:{data:legendData},toolbox:{show:!1},calculable:!0,xAxis:[{type:"category",data:xAxisData}],yAxis:[{type:"value"}],series:[{name:"2013低温冷冻泵",type:"line",data:seriesData1},{name:"2014低温冷冻泵",type:"line",data:seriesData2}]};legendData=new Array,seriesData1=new Array,seriesData2=new Array,xAxisData=new Array,legendData.push("2013"+this.chartData[2].pointName),legendData.push("2014"+this.chartData[2].pointName);for(var i=0;i<this.chartData[2].value.length/2;++i)xAxisData[i]=this.chartData[2].value[i].time.substr(5);for(var i=0;i<this.chartData[2].value.length/2;++i)seriesData1.push(this.chartData[2].value[i].value);for(var i=this.chartData[2].value.length/2;i<this.chartData[2].value.length;++i)seriesData2.push(this.chartData[2].value[i].value);var option3={backgroundColor:"rgba(0,0,0,0)",grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:"axis"},legend:{data:legendData},toolbox:{show:!1},calculable:!0,xAxis:[{type:"category",data:xAxisData}],yAxis:[{type:"value"}],series:[{name:"2013低冷却泵",type:"line",data:seriesData1},{name:"2014低温冷却泵",type:"line",data:seriesData2}]};legendData=new Array,seriesData1=new Array,seriesData2=new Array,xAxisData=new Array,legendData.push("2013"),legendData.push("2014");for(var dataSum=0,i=0;10>i;++i)xAxisData[i]=this.chartData[i].pointName;for(var i=0;10>i;++i){dataSum=0;for(var j=0;j<this.chartData[i].value.length/2;++j)isNaN(parseInt(this.chartData[i].value[j].value))||(dataSum+=parseInt(this.chartData[i].value[j].value));seriesData1.push(dataSum)}for(var i=0;10>i;++i){dataSum=0;for(var j=this.chartData[i].value.length/2;j<this.chartData[i].value.length;++j)isNaN(parseInt(this.chartData[i].value[j].value))||(dataSum+=parseInt(this.chartData[i].value[j].value));seriesData2.push(dataSum)}var option4={backgroundColor:"rgba(0,0,0,0)",grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:"axis"},legend:{data:legendData},toolbox:{show:!1},calculable:!0,xAxis:[{type:"category",data:xAxisData}],yAxis:[{type:"value"}],series:[{name:"2013能效",type:"bar",data:seriesData1},{name:"2014能效",type:"bar",data:seriesData2}]};myChart1.setOption(option1),myChart2.setOption(option2),myChart3.setOption(option3),myChart4.setOption(option4)},finalDataUpload:function(){var _this=this;WebAPI.post("/project/create",{projName:this.proName,pointData:this.chartData,userName:AppConfig.account,userId:AppConfig.userId}).done(function(result){var data=JSON.parse(result);data.error?alert(I18n.resource.admin.projectConfigure.UPLOAD_PROJECT_FAILED):(WebAPI.post("/project/update",{userId:AppConfig.userId}).done(function(pro_result){var proList=JSON.parse(pro_result);proList.error?alert(I18n.resource.admin.projectConfigure.UPDATE_FAILED):AppConfig.projectList=proList}),(new PaneProjectSelector).initProject(data,_this.proName).done(function(){$("#ulLogin").html(""),ScreenManager.show(EnergyScreen)}))})}},PaneProjectConfigure}();var UploadConfigData=function(){function UploadConfigData(data){this.m_data=data,this.i18=I18n.admin.projectConfigure}return UploadConfigData.prototype={show:function(){var tr,thead,th,td,_this=this,$tbody=$("#initDataTbody"),jsonData=_this.m_data;if(jsonData.length&&jsonData.length>0){thead=document.getElementById("initData").createTHead(),th=document.createElement("th"),th.innerHTML=this.i18.SELECT,thead.appendChild(th),th=document.createElement("th"),th.innerHTML=this.i18.DATE,thead.appendChild(th);for(var i=0;i<jsonData.length;++i)th=document.createElement("th"),th.className="ptName",th.innerHTML=jsonData[i].pointName,thead.appendChild(th);for(var i=0;i<jsonData[0].value.length;i++){tr=document.createElement("tr"),td=document.createElement("td"),td.className="chkPtSel",td.innerHTML="<input type='checkbox' class='chk-flag' />",tr.appendChild(td),td=document.createElement("td"),td.className="ptTime",td.innerHTML=jsonData[0].value[i].time,tr.appendChild(td);for(var j=0;j<jsonData.length;j++)td=document.createElement("td"),td.className="ptValue",td.innerHTML=jsonData[j].value[i].value,tr.appendChild(td);tbody=document.createElement("tbody"),$tbody.append(tr)}}else $tbody.append("<tr><td colspan=3>"+i18.NO_DATA_READ+"</td></tr>")}},UploadConfigData}(),MenuConfigure=function(){function MenuItem(id,text,type,reportType,reportFolder,children,parentId){this.text=text,this.type=type,this.reportType=reportType,this.reportFolder=reportFolder,children?this.children=children:this.children=[],id?this._id=id:this._id=this.uniqueId(),parentId&&(this.parent=parentId)}function MenuConfigure(){this.viewModel={traverseNav:function(navCollection,id,cb){if(!id)return cb&&"function"==typeof cb?cb(navCollection):navCollection;if(navCollection&&0!==navCollection.length)for(var m=0;m<navCollection.length;m++){var collectionItem=navCollection[m];if(collectionItem._id===id){if(!cb||"function"!=typeof cb)return collectionItem;cb(navCollection,m)}else this.traverseNav(collectionItem.children,id,cb)}},setNav:function(id,text,type,reportType,reportFolder){var ret={};return this.traverseNav(this.nav,id,function(collection,index){collection&&collection.length&&(ret=collection[index],ret.type===menuType.DropDownList&&type!==menuType.DropDownList&&(ret.children=[]),ret.text=text,ret.type=type,type===menuType.ReportScreen&&(ret.reportType=reportType,ret.reportFolder=reportFolder))}),ret},getNav:function(id){if(!id)return{};var ret={};return this.traverseNav(this.nav,id,function(collection,index){ret=collection[index]}),ret},removeNav:function(id){var ret={};return this.traverseNav(this.nav,id,function(collection,index){collection&&collection.length&&(ret=collection.splice(index,1))}),ret},clearChildren:function(id){this.traverseNav(this.nav,id,function(collection,index){collection[index].children=[]})},addNav:function(parentId,text,type,reportType,reportFolder){if(!type)return{};var nav=this.nav,ret={};return this.traverseNav(this.nav,parentId,function(collection,index){parentId?collection&&collection.length&&collection[index]&&(BEOPUtil.isUndefined(collection[index].children)&&(collection[index].children=[]),ret=new MenuItem(null,text,type,reportType,reportFolder,null,parentId),collection[index].children.push(ret)):(ret=new MenuItem(null,text,type,reportType,reportFolder),nav.push(ret))}),ret}}}var static_id=0,reportType={0:"日报",1:"月报"},menuType={ObserverScreen:"ObserverScreen",DiagnosisScreen:"DiagnosisScreen",AnalysisScreen:"AnalysisScreen",ReportScreen:"ReportScreen",DropDownList:"DropDownList",EnergyScreen:"EnergyScreen"};return MenuItem.prototype={uniqueId:function(){return"new_"+static_id++}},MenuConfigure.prototype={defaultTopNavNum:8,defaultSubNavNum:10,init:function(){Spinner.spin(ElScreenContainer);var _this=this;$.get("/static/views/admin/menuConfigure.html").done(function(htmlResult){$(ElScreenContainer).html(htmlResult),WebAPI.post("/admin/menuConfigure",{userId:AppConfig.userId,projectId:AppConfig.projectId}).done(function(result){result.success&&$.extend(_this.viewModel,result.data.firstProjectMenu),_this.renderProjectMenu(_this.viewModel),_this.renderProjectSelector(result.data.projects),Spinner.stop()}),_this.bindEvents()})},show:function(){$("#ulPages").empty(),this.init()},close:function(){},bindEvents:function(){var _this=this,$con=$("#menuConfigure"),$topNavConfigWin=$("#menuConfigureInfo");$con.on("click","#projectSelector li",function(){var projectId=parseInt($(this).attr("project-id")),projectName=$(this).find("a").text(),projectSrc=$(this).find("img").attr("src");Spinner.spin(ElScreenContainer),WebAPI.post("/admin/loadProjectMenu",{projectId:projectId}).done(function(result){result.success&&($("#projectMenu").text(projectName),$("#projectName").text(projectName).attr("project-id",projectId),$("#itemMainPic").attr("src",projectSrc),AppConfig.projectId=projectId,_this.viewModel.nav=result.data.nav,_this.renderProjectMenu())}).always(function(){Spinner.stop()})}),$con.off("liShow").on("mouseover.liShow",".itemLi",function(e){$(this).find(".menuOperation .itemEdit").show()}).on("mouseout",".itemLi",function(e){$(this).find(".menuOperation .itemEdit").hide()}),$con.off("change","select").on("change","select",function(){var $this=$(this),val=$this.val(),$li=$this.closest("li"),$input=$li.find(".displayName"),$itemInfo=$this.next(".itemInfo"),$configDropDownDenuUl=$this.parents(".itemLi").find(".configDropDownDenuUl");$this.hasClass("reportTypeSelect")||($li.find("input").val(""),$li.find(".itemTextContent").remove(),$li.find(".itemInfo").html('<input type="text" value="" class="form-control displayName menuName" placeholder="请填入显示名称"/>'),$this.hasClass("mainMenu")?($this.parents(".itemLi").find(".menuOperation").remove(),val==menuType.DropDownList?($configDropDownDenuUl.html(beopTmpl("sub_nav_tmpl",_this.viewModel)).slideDown(100),$configDropDownDenuUl.find("li").attr("parent-id",$(this).parents(".itemLi").attr("nav-id"))):$configDropDownDenuUl.slideUp(100).html("")):"ReportScreen"==val?$(this).parents("li[parent-id]").css("width","100%"):$(this).parents("li[parent-id]").css("width","50%"),val?val==menuType.DropDownList?($input.attr("disabled",!1),$itemInfo.find(".reportContent").remove()):"ReportScreen"==val?($input.attr("disabled",!1),$itemInfo.append(beopTmpl("operating_Report_tmpl"))):($input.attr("disabled",!1),$itemInfo.find(".reportContent").remove()):($li.find(".displayName").attr({value:"",disabled:!0,placeholder:""}),$itemInfo.find(".reportContent").remove()))}),$con.on("click",".itemEdit",function(){var $itemLi=$(this).parents(".itemLi"),$mainMenu=$itemLi.find(".mainMenu"),$itemInfo=$mainMenu.next(".itemInfo"),mainMenuText=$mainMenu.next(".itemInfo").find(".mainMenuText").text(),$ul=$itemLi.find(".configDropDownDenuUl");if($mainMenu.val()==menuType.DropDownList)$ul.find("li").length>0?$ul.slideDown(100):($ul.html(beopTmpl("sub_nav_tmpl",_this.viewModel)).slideDown(100),$ul.find("li").attr("parent-id",$itemLi.attr("nav-id"))),$itemLi.find(".menuOperation").html(beopTmpl("dropDown_okOrNo_tmpl")),$itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="请填入显示名称"/>'),$itemLi.find(".itemCancel").show();else if("ReportScreen"==$mainMenu.val()){var directoryTypeText=$itemInfo.find(".directoryType").text(),reportTypeText=$itemInfo.find(".reportType").text();$itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="请填入显示名称"/>').append(beopTmpl("operating_Report_tmpl")),$itemInfo.find(".directoryTypeInput").val(directoryTypeText).attr("originalValue",directoryTypeText);var selectVal;selectVal="日报"==reportTypeText?0:1,$itemInfo.find(".reportTypeSelect").val(selectVal).attr("originalValue",reportTypeText)}else $itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="请填入显示名称"/>');$itemInfo.find(".displayName").focus(),$(this).remove()}),$con.on("click",".itemCancel",function(){var $itemLi=$(this).parents(".itemLi"),index=$("#navTopUl>li").index($itemLi),$li=$itemLi.find(".configDropDownDenuUl li"),dataNav=_this.viewModel.nav[index].children;$itemLi.find(".mainInfo .displayName").val(_this.viewModel.nav[index].text),$.each($li,function(indexItem,item){if(indexItem<dataNav.length){var type=dataNav[indexItem].type,text=dataNav[indexItem].text;$(item).find(".secondaryMenu").val(type),$(item).find(".displayName").val(text)}else $(item).find(".secondaryMenu").val(""),$(item).find(".displayName").val("").attr({disabled:"disabled",placeholder:""})})});var getMenuModelFromPage=function($item){return{navId:$item.attr("nav-id"),text:$item.find(".menuName").text()||$item.find(".menuName").val(),type:$item.find(".typeSelector option:selected").val(),reportFolder:$item.find(".directoryType").text()||$item.find(".directoryTypeInput").val(),reportType:$item.find(".reportTypeSelect").length?$item.find(".reportTypeSelect option:selected").val():$item.find(".reportType").attr("report-type")}},updateMenuModel=function($item,parentId){var menuModel=getMenuModelFromPage($item);if(menuModel.type)if(menuModel.navId)_this.viewModel.setNav(menuModel.navId,menuModel.text,menuModel.type,menuModel.reportType,menuModel.reportFolder);else{var newItem=_this.viewModel.addNav(parentId,menuModel.text,menuModel.type,menuModel.reportType,menuModel.reportFolder);$item.attr("nav-id",newItem._id)}else menuModel.navId&&(_this.viewModel.removeNav(menuModel.navId),$item.attr("nav-id",""))};$("#saveSet").click(function(){var commitFlag=!0;if($.each($("#navTopUl input:enabled"),function(i,inputItem){var val=$.trim($(inputItem).val());return""==val?($(inputItem).focus(),commitFlag=!1,$("#errorConfigure").text("文本框不能为空！").show(),!1):void 0}),!commitFlag)return!1;Spinner.spin(ElScreenContainer),$.each($("#navTopUl>li"),function(index,item){var $item=$(item);if(updateMenuModel($item),$item.find(".configDropDownDenuUl li").length){var $li=$item.find(".configDropDownDenuUl li");$.each($li,function(indexChild,itemChild){updateMenuModel($(itemChild),$item.attr("nav-id"))})}});var projectId=parseInt($("#projectName").attr("project-id"));WebAPI.post("/admin/menuEdit",{userId:AppConfig.userId,projectId:projectId,menu:_this.viewModel}).done(function(result){result.success?(new Alert($topNavConfigWin,Alert.type.success,I18n.resource.code[result.code]).showAtTop(2e3),_this.viewModel.nav=result.data.nav,_this.renderProjectMenu()):new Alert($topNavConfigWin,Alert.type.danger,I18n.resource.code[result.code]).showAtTop(2e3),$("#errorConfigure").text("").hide()}).always(function(){Spinner.stop()})})},renderProjectMenu:function(model){model||(model=this.viewModel);var html=beopTmpl("top_nav_tmpl",{nav:model.nav,type:model.type,defaultNum:this.defaultTopNavNum,reportType:reportType});$("#navTop").empty().append(html),$.each($(".configDropDownDenuUl li"),function(index,item){var $item=$(item);$item.attr("parent-id",$item.parents(".itemLi").attr("nav-id"))})},renderProjectSelector:function(projects){var html=beopTmpl("project_selector_tmpl",{projects:projects});$("#projectSelector").empty().append(html);var projectName=$("#projectSelector").find("li[project-id="+AppConfig.projectId+"] a").text(),projectSrc=$("#projectSelector").find("li[project-id="+AppConfig.projectId+"] img").attr("src");$("#projectName").text(projectName).attr("project-id",AppConfig.projectId),$("#itemMainPic").attr("src",projectSrc),$("#saveSet").show()}},MenuConfigure}();