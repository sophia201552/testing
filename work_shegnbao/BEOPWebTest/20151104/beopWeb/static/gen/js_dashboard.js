var ScreenManager=(function(){var slice=Array.prototype.slice;var m_dictScreen={};var panPrjSel;var preScreenName,nowScreenName;var isMobile=false;if(navigator.userAgent.match(/iP(ad|hone|od)|Android|Version/i))isMobile=true;if(!isMobile&&window.history&&history.replaceState){$(window).on("popstate",function(event){var curId=location.hash;if(Boolean(curId)){curId=curId.substring(1,curId.length);if(Boolean(m_dictScreen[curId])){preScreenName=nowScreenName;nowScreenName=m_dictScreen[curId].name;if('PaneProjectSelector'==preScreenName&&'PaneProjectSelector'!=nowScreenName){if(Boolean(panPrjSel)&&Boolean(AppConfig.projectId)){panPrjSel.initProject(AppConfig.projectId,AppConfig.projectName,AppConfig.projectShowName,m_dictScreen[curId].navSelPageId);}}
else{var navLi=$('#ulPages').children('li');if(Boolean(navLi)&&navLi.length){navLi.filter('.active').attr('class','');var navBtnA=navLi.children('a');for(var i=0,len=navBtnA.length;i<len;i++){var item=navBtnA.eq(i);if(item.attr('pageid')==m_dictScreen[curId].navSelPageId){item.closest('li').attr('class','active');break;}}}}
m_dictScreen[curId].screen.show();}}
else{m_dictScreen={};location.href=location.origin;}});}
function ScreenManager(){};ScreenManager.show=function(){if(arguments.length===0){return;}
var screenClass=arguments[0];if(typeof screenClass!=='function'){return;}
var screenObj=Object.create(screenClass.prototype);if(ScreenCurrent){window.onresize=null;if(ScreenCurrent.close()===false){return;}}
ScreenCurrent=(screenClass.apply(screenObj,slice.call(arguments,1))||screenObj);if(ScreenCurrent.onresize)window.onresize=ScreenCurrent.onresize;ScreenCurrent.show();if(!isMobile&&'IndexScreen'!=screenClass.name){nowScreenName=screenClass.name;var navSelPageId=Boolean(arguments[1])?arguments[1]:null;var id=+new Date();location.hash=id;m_dictScreen[id]={'screen':ScreenCurrent,'name':screenClass.name,'navSelPageId':navSelPageId};history.replaceState(null,'',window.location.href);}
if('PaneProjectSelector'==screenClass.name&&Boolean(ScreenCurrent)){panPrjSel=ScreenCurrent;}};ScreenManager.clearHistory=function(){if(isMobile)return;m_dictScreen={};location.hash='';};return ScreenManager;})();﻿
var beop=beop||{};beop.constant={project_img_path:'/static/images/project_img/',project_default_img:'default.jpg'};var ObjectId=function(){var hex8=('00000000'+Math.floor(Math.random()*0xFFFFFFFF).toString(16)).slice(-8);var userId=('000'+(AppConfig.userId||'000')).slice(-3);var timestamp=new Date().valueOf();return hex8+userId+timestamp;};var FullScreenManager=(function(){var manager=Object.create({init:function(){var _this=this;$(document).off('webkitfullscreenchange');$(document).on('webkitfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('mozfullscreenchange');$(document).on('mozfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('msfullscreenchange');$(document).on('msfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});if(typeof onError==='function'){$(document).off('webkitfullscreenerror');$(document).on('webkitfullscreenerror',this.onFullScreenError);$(document).off('mozfullscreenerror');$(document).on('mozfullscreenerror',this.onFullScreenError);$(document).off('msfullscreenerror');$(document).on('msfullscreenerror',this.onFullScreenError);}},onFullScreenEnter:function(){},onFullScreenOut:function(){},onFullScreenError:function(){},toggle:function(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!document.msFullscreenElement){if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}}});manager.init();return manager;}());function StringBuilder(){this.data=Array("");}
StringBuilder.prototype.append=function(){this.data.push(arguments[0]);return this;};StringBuilder.prototype.toString=function(){return this.data.join("");};StringBuilder.prototype.getLength=function(){return this.data.length;};if(!String.prototype.format){String.prototype.format=function(){if(arguments[0]===undefined){return'';}
if(arguments[0].constructor===Array){var args=arguments[0];}else{var args=arguments;}
return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
if(!String.prototype.formatEL){String.prototype.formatEL=function(o){var str=this.toString();if(!str||!o)return'';for(var p in o){if(o.hasOwnProperty(p)){str=str.replace(new RegExp('{'+p+'}','g'),o[p]);}}
return str;};}
String.prototype.toDate=function(){var str=this;if(str.indexOf('-')>-1)
str=str.replace('-','/').replace('-','/');return new Date(str);}
Number.prototype.toDate=function(){return new Date(this);};function Alert(targetElement,type,msg){this.element=targetElement;this.str=new StringBuilder();this.str.append('<div class="alert alert-').append(type).append(' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<div class="alert-msg">'+msg+'</div>').append('</div>');this.$alert=$(this.str.toString());}
Alert.danger=function(targetElement,msg){return new Alert(targetElement,Alert.type.danger,msg).show();};Alert.warning=function(targetElement,msg){return new Alert(targetElement,Alert.type.warning,msg).show();};Alert.success=function(targetElement,msg){return new Alert(targetElement,Alert.type.success,msg).show();};Alert.info=function(targetElement,msg){return new Alert(targetElement,Alert.type.info,msg).show();};Alert.type={danger:'danger',warning:'warning',success:'success',info:'info'};Alert.prototype.show=function(duration){if(duration){var _this=this;setTimeout(function(){_this.close();},duration);}
$(this.element).append(this.$alert);return this;};Alert.prototype.close=function(){var _this=this;this.$alert.fadeOut(3000,function(){_this.$alert.remove();_this=null;});};Alert.prototype.setMessage=function(msg){if(!msg){return false}
this.$alert.find('.alert-msg').text(msg);};Alert.prototype.setStyle=function(style){if(style&&typeof style!=='string'){this.$alert.css(style);}
return this;};Alert.prototype.showAtTop=function(duration){this.setStyle({position:'absolute',top:0,left:0,right:0,margin:'auto',width:'50%',textAlign:'center'})
this.show(duration);};function showDialog(url){return WebAPI.get(url).done(function(resultHtml){$("#dialogContent").html(resultHtml);$('#dialogModal').modal({});});}
function clone(obj){if(obj==null||typeof(obj)!='object')
return obj;var temp=obj.constructor();for(var key in obj){if(obj.hasOwnProperty(key)){temp[key]=clone(obj[key]);}}
return temp;}
Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var week={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
if(/(E+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,((RegExp.$1.length>1)?(RegExp.$1.length>2?"/u661f/u671f":"/u5468"):"")+week[this.getDay()+""]);}
for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)));}}
return fmt;}
var DateUtil=(function(){var dateLocale={month:{en:{month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],month_names_short:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']},zh:{month_names:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],month_names_short:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']}}};function getWeekNumber(d){d=new Date(+d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7)
return[d.getFullYear(),weekNo];}
function getLastWeekNumberOf(y,w){w-=1;if(w===0){y=y-1;w=52;}
return[y,w];}
function getNextWeekNumberOf(y,w){w+=1;if(w===53){y+=1;w=1;}
return[y,w];}
function isLeapYear(y){if(Object.prototype.toString.call(y)==='[object Date]'){y=y.getUTCFullYear();}
return((y%4===0)&&(y%100!==0))||(y%400===0);}
function daysInMonth(dt){var m=dt.getUTCMonth();if(m===1){return isLeapYear(dt)?29:28;}
return[31,28,31,30,31,30,31,31,30,31,30,31][m];}
function getFirstDayOfWeek(year,week){var d=new Date(year,0,1),offset=d.getTimezoneOffset();d.setDate(d.getDate()+4-(d.getDay()||7));d.setTime(d.getTime()+7*24*60*60*1000*(week+(year==d.getFullYear()?-1:0)));d.setTime(d.getTime()
+(d.getTimezoneOffset()-offset)*60*1000);d.setDate(d.getDate()-3);return d;}
function getDateRangeOnWeekNumber(year,week){if(!year||!week){return;}
var firstDay=getFirstDayOfWeek(year,week),lastDay=new Date(firstDay);lastDay.setDate(firstDay.getDate()+6);return[firstDay,lastDay];}
function getMonthName(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names:dateLocale.month['en'].month_names;return monthList[index];}
function getMonthNameShort(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names_short:dateLocale.month['en'].month_names_short;return monthList[index];}
function getLastMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===1){return 12;}else{return currentMonth-1;}}
function getNextMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===12){return 1;}else{return currentMonth+1;}}
function getRelativeDateInfo(date1,date2){var now=new Date();var lang=I18n.type;var value1,value2,ts,info;if(!date1&&!date2)return'';value1=(date1||now).valueOf();value2=(date2||now).valueOf();ts=Math.floor(Math.abs(value1-value2)/1000);switch(true){case ts<60:info=ts+(ts===1?' second':' seconds');break;case ts<60*60:ts=Math.floor(ts/60);info=ts+(ts===1?' minute':' minutes');break;case ts<60*60*24:ts=Math.floor(ts/(60*60));info=ts+(ts===1?' hour':' hours');break;case ts<60*60*24*365:ts=Math.floor(ts/(60*60*24));info=ts+(ts===1?' day':' days');break;default:ts=Math.floor(ts/(60*60*24*365));info=ts+(ts===1?' year':' years');break;}
info+=value1>value2?' ago':' later';if(lang==='zh'){info=info.replace(/\s(seconds?|minutes?|hours?|days?|years?)\s(ago|later)$/,function($0,$1,$2){var rs='';if($1.indexOf('second')>-1)rs+='秒钟';if($1.indexOf('minute')>-1)rs+='分钟';if($1.indexOf('hour')>-1)rs+='小时';if($1.indexOf('day')>-1)rs+='天';if($1.indexOf('year')>-1)rs+='年';if($2==='ago')rs+='前';if($2==='later')rs+='后';return rs;});}
return info;}
return{getWeekNumber:getWeekNumber,isLeapYear:isLeapYear,daysInMonth:daysInMonth,getLastWeekNumberOf:getLastWeekNumberOf,getNextWeekNumberOf:getNextWeekNumberOf,getDateRangeOnWeekNumber:getDateRangeOnWeekNumber,getFirstDayOfWeek:getFirstDayOfWeek,getMonthName:getMonthName,getMonthNameShort:getMonthNameShort,getLastMonth:getLastMonth,getNextMonth:getNextMonth,getRelativeDateInfo:getRelativeDateInfo}})();var StringUtil=(function(){var HTML_ENTITIES={'&':'&amp;','>':'&gt;','<':'&lt;','"':'&quot;',"'":'&#39;','`':'&#x60;'},HTML_ENTITIES_INVERT=invert(HTML_ENTITIES);function invert(obj){var result={},keys=Object.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i];}
return result;};function padLeft(oldStr,padNum,padStr){if(!padStr){return oldStr;}
return Array(padNum-String(oldStr).length+1).join(padStr)+oldStr;}
function htmlEscape(text){if(!text){return text}
var source='(?:'+Object.keys(HTML_ENTITIES).join('|')+')',replaceRegexp=RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES[character];});}
function htmlUnEscape(text){if(!text){return text}
var source='(?:'+Object.keys(HTML_ENTITIES_INVERT).join('|')+')',replaceRegexp=RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES_INVERT[character];});}
var getI18nProjectName=function(project){if(!I18n||!project){return'';}
var result='';switch(I18n.type){case'en':{result=project.name_english;break;}
case'zh':{result=project.name_cn;break;}
default:{result=project.name_english;}}
return result||'';};return{padLeft:padLeft,htmlEscape:htmlEscape,htmlUnEscape:htmlUnEscape,getI18nProjectName:getI18nProjectName}})();var BEOPUtil=(function(){var jsType={function:typeof $.noop,number:typeof 0,string:typeof'',undefined:typeof undefined};var projectImgPath=beop.constant.project_img_path;var setRelativePosition=function($obj,$target,topOffset,leftOffset){var offset=$obj.offset();var topOffset=topOffset||10;var leftOffset=leftOffset||5;var top=offset.top+topOffset;var left=offset.left+$obj.width()+leftOffset;$target.css({"left":left,"top":top});};var projectDefaultImgPath=projectImgPath+beop.constant.project_default_img;var getProjectImgPath=function(project){if(!project){return;}else{return project.pic?projectImgPath+project.pic:projectDefaultImgPath;}};function getFunctionName(func){if(!func||typeof func!=jsType.function){return'';}
var ret=func.toString();ret=ret.substr('function '.length);ret=ret.substr(0,ret.indexOf('('));return ret;}
function isUndefined(obj){return typeof obj===jsType.undefined;}
return{setRelativePosition:setRelativePosition,getProjectImgPath:getProjectImgPath,getFunctionName:getFunctionName,isUndefined:isUndefined}})();(function(){var beop_tmpl_cache={};this.beopTmpl=function tmpl(str,data){var fn=!/\W/.test(str)?beop_tmpl_cache[str]=beop_tmpl_cache[str]||tmpl(document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split(/<!/).join("\t").replace(/((^|!>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)!>/g,"',$1,'").split("\t").join("');").split(/!>/).join("p.push('").split("\r").join("\\'")
+"');}return p.join('');");return data?fn(data):fn;};})();var SidebarMenuEffect=(function(){function SidebarMenuEffect(){}
SidebarMenuEffect.prototype.init=function(center,left,right){var _this=this;this.$paneCt=$(center);this.$leftBtn=$(center).find('#leftCt');this.$rightBtn=$(center).find('#rightCt');var container=document.getElementById('st-container'),buttons=Array.prototype.slice.call(document.querySelectorAll('.sideTrans')),refresh=function(){var leftCol=0,rightCol=0,centerCol=0;var leftArrow='<span class="glyphicon glyphicon-chevron-left"></span>';var rightArrow='<span class="glyphicon glyphicon-chevron-right"></span>';if(_this.$leftBtn.length>0){if(container.className.indexOf('st-effect-7')>0){var prev=_this.$paneCt.prev('div')[0];if(prev&&prev.className.indexOf('col-')>-1){leftCol=parseInt(prev.classList[0].split('-')[2]);}else{leftCol=0;}
_this.$leftBtn.removeClass('leftCtClose').addClass('leftCtOpen').html(leftArrow);}else{leftCol=0;_this.$leftBtn.removeClass('leftCtOpen').addClass('leftCtClose').html(rightArrow);}}
if(_this.$rightBtn.length>0){if(container.className.indexOf('st-effect-1')>0){var next=_this.$paneCt.next('div')[0];if(next&&next.className.indexOf('col-')>-1){rightCol=parseInt(next.classList[0].split('-')[2]);}else{rightCol=0;}
_this.$rightBtn.removeClass('rightCtClose').addClass('rightCtOpen').html(rightArrow);}else{rightCol=0;_this.$rightBtn.removeClass('rightCtOpen').addClass('rightCtClose').html(leftArrow);}}
centerCol=12-leftCol-rightCol;_this.$paneCt.removeClass().addClass('col-sm-'+centerCol+' st-content');};buttons.forEach(function(el,i){var effect=el.getAttribute('data-effect');el.addEventListener('click',function(ev){var target=ev.target.getAttribute('data-effect')!=null?ev.target.getAttribute('data-effect'):ev.target.parentNode.getAttribute('data-effect');var stCtClass=document.getElementById('st-container').className;if(stCtClass.indexOf(target)<0){ev.stopPropagation();ev.preventDefault();container.classList.add(effect);setTimeout(function(){if($(container.children[0]).children('div').length==3){container.classList.add('st-menu-open');}
refresh();},250);}else{container.classList.remove(target)
refresh();}});});}
return SidebarMenuEffect;})();(function(window){{var unknown='-';var screenSize='';if(screen.width){var width=(screen.width)?screen.width:'';var height=(screen.height)?screen.height:'';screenSize+=''+width+" x "+height;}
var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var browser=navigator.appName;var version=''+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if((verOffset=nAgt.indexOf('Opera'))!=-1){browser='Opera';version=nAgt.substring(verOffset+6);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('MSIE'))!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(verOffset+5);}
else if((verOffset=nAgt.indexOf('Chrome'))!=-1){browser='Chrome';version=nAgt.substring(verOffset+7);}
else if((verOffset=nAgt.indexOf('Safari'))!=-1){browser='Safari';version=nAgt.substring(verOffset+7);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('Firefox'))!=-1){browser='Firefox';version=nAgt.substring(verOffset+8);}
else if(nAgt.indexOf('Trident/')!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(nAgt.indexOf('rv:')+3);}
else if((nameOffset=nAgt.lastIndexOf(' ')+1)<(verOffset=nAgt.lastIndexOf('/'))){browser=nAgt.substring(nameOffset,verOffset);version=nAgt.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName;}}
if((ix=version.indexOf(';'))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(' '))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(')'))!=-1)version=version.substring(0,ix);majorVersion=parseInt(''+version,10);if(isNaN(majorVersion)){version=''+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10);}
var mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);var cookieEnabled=(navigator.cookieEnabled)?true:false;if(typeof navigator.cookieEnabled=='undefined'&&!cookieEnabled){document.cookie='testcookie';cookieEnabled=(document.cookie.indexOf('testcookie')!=-1)?true:false;}
var os=unknown;var clientStrings=[{s:'Windows 3.11',r:/Win16/},{s:'Windows 95',r:/(Windows 95|Win95|Windows_95)/},{s:'Windows ME',r:/(Win 9x 4.90|Windows ME)/},{s:'Windows 98',r:/(Windows 98|Win98)/},{s:'Windows CE',r:/Windows CE/},{s:'Windows 2000',r:/(Windows NT 5.0|Windows 2000)/},{s:'Windows XP',r:/(Windows NT 5.1|Windows XP)/},{s:'Windows Server 2003',r:/Windows NT 5.2/},{s:'Windows Vista',r:/Windows NT 6.0/},{s:'Windows 7',r:/(Windows 7|Windows NT 6.1)/},{s:'Windows 8.1',r:/(Windows 8.1|Windows NT 6.3)/},{s:'Windows 8',r:/(Windows 8|Windows NT 6.2)/},{s:'Windows NT 4.0',r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:'Windows ME',r:/Windows ME/},{s:'Android',r:/Android/},{s:'Open BSD',r:/OpenBSD/},{s:'Sun OS',r:/SunOS/},{s:'Linux',r:/(Linux|X11)/},{s:'iOS',r:/(iPhone|iPad|iPod)/},{s:'Mac OS X',r:/Mac OS X/},{s:'Mac OS',r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:'QNX',r:/QNX/},{s:'UNIX',r:/UNIX/},{s:'BeOS',r:/BeOS/},{s:'OS/2',r:/OS\/2/},{s:'Search Bot',r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var id in clientStrings){var cs=clientStrings[id];if(cs.r.test(nAgt)){os=cs.s;break;}}
var osVersion=unknown;if(/Windows/.test(os)){osVersion=/Windows (.*)/.exec(os)[1];os='Windows';}
switch(os){case'Mac OS X':osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];break;case'Android':osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1];break;case'iOS':osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);osVersion=osVersion[1]+'.'+osVersion[2]+'.'+(osVersion[3]|0);break;}}
window.jscd={screen:screenSize,browser:browser,browserVersion:version,mobile:mobile,os:os,osVersion:osVersion,cookies:cookieEnabled};}(this));var getWysiwyg=function(hasEditor){hasEditor=hasEditor===undefined?true:hasEditor;var wysiwyg='\
        <div class="btn-toolbar" data-role="editor-toolbar" data-target="#editor">\
          <div class="btn-group">\
            <a class="btn dropdown-toggle" data-toggle="dropdown" title="Font" data-original-title="Font"><i class="icon-font"></i><b class="caret"></b></a>\
              <ul class="dropdown-menu">\
              <li><a data-edit="fontName Serif" style="font-family:\'Serif\'">Serif</a></li><li><a data-edit="fontName Sans" style="font-family:\'Sans\'">Sans</a></li><li><a data-edit="fontName Arial" style="font-family:\'Arial\'">Arial</a></li><li><a data-edit="fontName Arial Black" style="font-family:\'Arial Black\'">Arial Black</a></li><li><a data-edit="fontName Courier" style="font-family:\'Courier\'">Courier</a></li><li><a data-edit="fontName Courier New" style="font-family:\'Courier New\'">Courier New</a></li><li><a data-edit="fontName Comic Sans MS" style="font-family:\'Comic Sans MS\'">Comic Sans MS</a></li><li><a data-edit="fontName Helvetica" style="font-family:\'Helvetica\'">Helvetica</a></li><li><a data-edit="fontName Impact" style="font-family:\'Impact\'">Impact</a></li><li><a data-edit="fontName Lucida Grande" style="font-family:\'Lucida Grande\'">Lucida Grande</a></li><li><a data-edit="fontName Lucida Sans" style="font-family:\'Lucida Sans\'">Lucida Sans</a></li><li><a data-edit="fontName Tahoma" style="font-family:\'Tahoma\'">Tahoma</a></li><li><a data-edit="fontName Times" style="font-family:\'Times\'">Times</a></li><li><a data-edit="fontName Times New Roman" style="font-family:\'Times New Roman\'">Times New Roman</a></li><li><a data-edit="fontName Verdana" style="font-family:\'Verdana\'">Verdana</a></li></ul>\
            </div>\
          <div class="btn-group">\
            <a class="btn dropdown-toggle" data-toggle="dropdown" title="Font Size" data-original-title="Font Size"><i class="icon-text-height"></i>&nbsp;<b class="caret"></b></a>\
              <ul class="dropdown-menu">\
              <li><a data-edit="fontSize 5"><font size="5">Huge</font></a></li>\
              <li><a data-edit="fontSize 3"><font size="3">Normal</font></a></li>\
              <li><a data-edit="fontSize 1"><font size="1">Small</font></a></li>\
              </ul>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="bold" title="Bold (Ctrl/Cmd+B)" data-original-title="Bold (Ctrl/Cmd+B)"><i class="icon-bold"></i></a>\
            <a class="btn" data-edit="italic" title="Italic (Ctrl/Cmd+I)" data-original-title="Italic (Ctrl/Cmd+I)"><i class="icon-italic"></i></a>\
            <a class="btn" data-edit="strikethrough" title="Strikethrough" data-original-title="Strikethrough"><i class="icon-strikethrough"></i></a>\
            <a class="btn" data-edit="underline" title="Underline (Ctrl/Cmd+U)" data-original-title="Underline (Ctrl/Cmd+U)"><i class="icon-underline"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="insertunorderedlist" title="Bullet list" data-original-title="Bullet list"><i class="icon-list-ul"></i></a>\
            <a class="btn" data-edit="insertorderedlist" title="Number list" data-original-title="Number list"><i class="icon-list-ol"></i></a>\
            <a class="btn" data-edit="outdent" title="Reduce indent" data-original-title="Reduce indent (Shift+Tab)"><i class="icon-indent-left"></i></a>\
            <a class="btn" data-edit="indent" title="Indent" data-original-title="Indent (Tab)"><i class="icon-indent-right"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="justifyleft" title="Align Left" data-original-title="Align Left (Ctrl/Cmd+L)"><i class="icon-align-left"></i></a>\
            <a class="btn" data-edit="justifycenter" title="Center" data-original-title="Center (Ctrl/Cmd+E)"><i class="icon-align-center"></i></a>\
            <a class="btn" data-edit="justifyright" title="Align Right" data-original-title="Align Right (Ctrl/Cmd+R)"><i class="icon-align-right"></i></a>\
            <a class="btn btn-info" data-edit="justifyfull" title="Justify" data-original-title="Justify (Ctrl/Cmd+J)"><i class="icon-align-justify"></i></a>\
          </div>\
          <div class="btn-group" style="display:none;">\
              <a class="btn dropdown-toggle" data-toggle="dropdown" title="Hyperlink" data-original-title="Hyperlink"><i class="icon-link"></i></a>\
                <div class="dropdown-menu input-append">\
                    <input class="span2" placeholder="URL" type="text" data-edit="createLink">\
                    <button class="btn" type="button">Add</button>\
            </div>\
            <a class="btn" data-edit="unlink" title="Remove Hyperlink" data-original-title="Remove Hyperlink"><i class="icon-cut"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" title="Insert picture" id="pictureBtn" data-original-title="Insert picture (or just drag &amp; drop)"><i class="icon-picture"></i></a>\
            <input type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage" style="opacity: 0; position: absolute; top: 0px; left: 0px; width: 41px; height: 30px;">\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="undo" title="Undo (Ctrl/Cmd+Z)" data-original-title="Undo (Ctrl/Cmd+Z)"><i class="icon-undo"></i></a>\
            <a class="btn" data-edit="redo" title="Redo (Ctrl/Cmd+Y)" data-original-title="Redo (Ctrl/Cmd+Y)"><i class="icon-repeat"></i></a>\
          </div>\
          <input type="text" data-edit="inserttext" id="voiceBtn" x-webkit-speech="" style="display: none;">\
        </div>';wysiwyg+=hasEditor?'<div id="editor" contenteditable="true" class="form-control gray-scrollbar">':'';wysiwyg+='</div>';return wysiwyg;}
﻿var WebAPI=(function(){var siteId;switch(window.location.hostname){case'beop.rnbtech.com.hk':siteId='b79c068f77198848e22fe79758836e53';break;case'beop6.rnbtech.com.hk':siteId='f1f6b2b9e6b64592c0b4cb5e9b8bd79e';break;case'beopdemo.rnbtech.com.hk':siteId='ac0df98f274d9a5980a571297248d80b';break;default:break;}
(function(){if(siteId){var hm=document.createElement("script");hm.src="//hm.baidu.com/hm.js?"+siteId;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);}})();var mockList={'/static/mock/analysis_workspace_saveLayout.json':/\/analysis\/workspace\/saveLayout\/\d+\/[01]/i,'/static/mock/analysis_template_get.json':/\/analysis\/template\/get\/\d+/i};function mock(url){var match=null;for(var i in mockList){match=url.match(mockList[i]);if(match!==null)return i;}
return url;}
function WebAPI(){}
WebAPI.isMock=false;$.ajaxSetup({dataFilter:function(result,type){if(result&&result.substring(2,7)=='error'){var data=JSON.parse(result);if(data.error=='token_invalid'){console.log(this.url+' ('+data.error+': code"'+data.msg+'")');if(confirm(i18n_resource.error.token[data.msg]+'. '+i18n_resource.error.relogin+'.')){location.reload();}
throw data.error;}}
return result;}});WebAPI.post=function(url,data,isMock){var mockUrl;isMock=isMock===undefined?WebAPI.isMock:isMock;if(isMock){mockUrl=mock(url);if(url!==mockUrl)return this.get(mockUrl,false);}
return $.ajax({url:url,type:'POST',data:JSON.stringify(data),contentType:'application/json'});};WebAPI.get=function(url,isMock){isMock=isMock===undefined?WebAPI.isMock:isMock;url=isMock?mock(url):url;if(_hmt&&url.indexOf('.html')>0)_hmt.push(['_trackPageview',url]);return $.ajax({url:url,type:'Get',contentType:'application/json'});};WebAPI.getHistoryDS=function(callback){};WebAPI.getHistory=function(callback){};return WebAPI;})();(function(){'use strict';var indexedDB=indexedDB||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(!indexedDB){return;}
function _initStorage(options){var _this=this;this._dbInfo=$.extend({db:null},options);var promise=$.Deferred();(function(){var _this=this;var dbInfo=this._dbInfo;var openreq=indexedDB.open(dbInfo.name,dbInfo.version);openreq.onerror=function(){promise.reject(openreq.error);};openreq.onsuccess=function(){dbInfo.db=openreq.result;promise.resolve();};openreq.onupgradeneeded=function(){var names=openreq.result.objectStoreNames;var length,key;var indexOf=([]).indexOf;if(indexOf.call(names,'cache')>-1){openreq.result.deleteObjectStore('cache');}
if(indexOf.call(names,'datasource')>-1){openreq.result.deleteObjectStore('datasource');}
if(indexOf.call(names,'thumbnail')>-1){openreq.result.deleteObjectStore('thumbnail');}
if(indexOf.call(names,'buffer')===-1){openreq.result.createObjectStore('buffer');}
openreq.result.createObjectStore('datasource');openreq.result.createObjectStore('thumbnail');for(var i=0,len=localStorage.length;i<len;i++){key=localStorage.key(i);if(key.indexOf('workSpacePicStorageEnable')===0){localStorage.removeItem(key);}}};}).call(this);}
function length(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.count();req.onsuccess=function(){promise.resolve(req.result);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.get(key);req.onsuccess=function(){var value=req.result;value=value===undefined?null:value;promise.resolve(value);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var result={};var promise=this.iterate(function(key,value,i){if(keyList.indexOf(key)>-1){result[key]=value;}}).then(function(){return result;},function(){console.warn('getItemList error!');});excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.put(value,key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();try{(function(){var _this=this;var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var result={};kvList.forEach(function(kv,i){var key=kv.key,value=kv.value;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
store.put(value,key);});transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=transaction.error;promise.reject(err);};}).call(this);}catch(e){console.warn('setItemList error!');promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.delete(key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;var request;if(!cursor){promise.resolve();return;}
if(keyList.indexOf(cursor.key)>-1){cursor.delete();}
cursor.continue();};req.onerror=function(err){promise.reject(err);};}).call(this);}catch(e){promise.reject();}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.clear();transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var advanced=false;req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(null);return;}
if(n===0){promise.resolve(cursor.key);}else{if(!advanced){advanced=true;cursor.advance(n);}else{promise.resolve(cursor.key);}}};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var keys=[];var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(keys);return;}
keys.push(cursor.key);cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var index=0;req.onsuccess=function(){var cursor=req.result;var result;if(!cursor){promise.resolve();return;}
result=iterator(cursor.key,cursor.value,index++);if(result===false){promise.resolve();return;}
cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var indexDBWrapper={_driver:'indexedDBWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.indexedDB=indexDBWrapper;}).call(this);(function($){'use strict';var localStorage;try{if(!this.localStorage||!('setItem'in this.localStorage)){return;}
localStorage=this.localStorage;}catch(e){return;}
function _initStorage(options){this._dbInfo=$.extend({},options);this._dbInfo.keyPrefix=this._dbInfo.name+'/';}
function length(callback){var _this=this;var promise=this.keys().then(function(keys){return keys.length;});excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var result;result=localStorage.getItem(this._dbInfo.keyPrefix+key);try{result=JSON.parse(result);}catch(e){}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var _this=this;var promise=$.Deferred();(function(){var result={};keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
result[key]=localStorage.getItem(_this._dbInfo.keyPrefix+key);try{result[key]=JSON.parse(result[key]);}catch(e){}});promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var _this=this;var result;try{try{value=JSON.stringify(value);}catch(e){}
result=localStorage.setItem(_this._dbInfo.keyPrefix+key,value);promise.resolve(result);}catch(e){result=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}
promise.reject(e);}}).call(this);excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();(function(){var _this=this;var result={};kvList.forEach(function(kv,i){var value;if(typeof kv.key!=='string'){console.warn('The key is not a string!');kv.key=String(kv.key);}
try{try{value=JSON.stringify(kv.value);}catch(e){value=kv.value;}
result[kv.key]=localStorage.setItem(_this._dbInfo.keyPrefix+kv.key,value);}catch(e){console.warn('occur error when set data into storage [key: "'+kv.key+'", value: "'+kv.value+'"]');result[kv.key]=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}}});promise.resolve();}).call(this);excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){localStorage.removeItem(this._dbInfo.keyPrefix+key);promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var _this=this;keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
localStorage.removeItem(_this._dbInfo.keyPrefix+key);});promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){localStorage.removeItem(key);}}
promise.resolve();}).call(this);}catch(e){proimse.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();(function(){var result;result=localStorage.key(n);if(result){result=result.substring(_this._dbInfo.keyPrefix.length);}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();(function(){var keyPrefix=this._dbInfo.keyPrefix;var length=localStorage.length;var keys=[],key;for(var i=0;i<length;i++){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){keys.push(key.substring(keyPrefix.length));}}
promise.resolve(keys);}).call(this);excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key,value;var result;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){value=localStorage.getItem(key);try{value=JSON.parse(value);}catch(e){}
result=iterator(key.substring(keyPrefix.length),value,i);}
if(result===false){break;}}
promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var localStorageWrapper={_driver:'localStorageWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.localStorage=localStorageWrapper;}).call(this,jQuery);(function($){function BaseCache(options){this.options=$.extend({},DEFAULTS,options);this.storage=Object.create(Beop.cache.drivers[this.options.driver]);this.init();}
BaseCache.prototype.init=function(){this.storage._initStorage(this.options);};BaseCache.prototype.length=function(){return this.storage.length();};BaseCache.prototype.key=function(n,callback){return this.storage.key(n,callback);};BaseCache.prototype.keys=function(callback){return this.storage.keys(callback);};BaseCache.prototype.getItem=function(key,callback){return this.storage.getItem(key,callback);};BaseCache.prototype.getItemList=function(keyList,callback){return this.storage.getItemList(keyList,callback);};BaseCache.prototype.setItem=function(key,value,callback){return this.storage.setItem(key,value,callback);};BaseCache.prototype.setItemList=function(kvList,callback){return this.storage.setItemList(kvList,callback);};BaseCache.prototype.removeItem=function(key,callback){return this.storage.removeItem(key,callback);};BaseCache.prototype.removeItemList=function(keyList,callback){return this.storage.removeItemList(keyList,callback);};BaseCache.prototype.clear=function(callback){return this.storage.clear(callback);};BaseCache.prototype.iterate=function(iterator,callback){return this.storage.iterate(iterator,callback);};var DEFAULTS={dbType:'localStorage',name:'beopcache',version:3};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.BaseCache=BaseCache;}).call(this,jQuery);var EventAdapter=(function(){var eventData,eventStatus;function EventAdapter($){}
EventAdapter.on=function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;eventHmt=true;if(arguments.length<3||arguments.length>5){console.log('EventAdapter.on arguments.length error');return;}
if(typeof arguments[0]!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}}
if(typeof arguments[1]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[1];}
if(typeof arguments[2]=='function'){eventFunction=arguments[2];eventSelector=null;if(typeof arguments[3]=='boolean'){eventHmt=arguments[3]}}else if(typeof arguments[2]=='string'){if(arguments[3]&&typeof arguments[3]=='function'){eventSelector=arguments[2];eventFunction=arguments[3];if(typeof arguments[4]=='boolean'){eventHmt=arguments[4]}}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(eventHmt){EventAdapter.analyse(eventTarget,eventType);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':eventTarget.on('touchstart',eventSelector,function(e){mobileDragStart.call(this,e,eventTarget,finalFunction)});break;case'dragover':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragOver.call(this,e,eventTarget,finalFunction)});break;case'dragleave':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragLeave.call(this,e,eventTarget,finalFunction)});break;case'drop':$(document).on('touchend.drop',eventSelector,function(e){mobileDrop.call(this,e,eventTarget,finalFunction)});break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;};EventAdapter.off=function(){if((arguments.length>3||arguments.length<1)||(arguments[0]&&typeof arguments[1]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}
if(arguments.length==1){eventTarget.off();return eventTarget;}
if(typeof arguments[1]=='string'){eventType=arguments[1]}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[2]=='string'){eventSelector=arguments[2];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;};$.fn.extend({'eventOn':function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;eventHmt=true;if(arguments.length<2||arguments.length>4){console.log('EventAdapter.on arguments.length error');return;}
if(typeof this!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(this instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=this;}}
if(typeof arguments[0]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[0];}
if(typeof arguments[1]=='function'){eventFunction=arguments[1];eventSelector=null;if(typeof arguments[2]=='boolean'){eventHmt=arguments[2]}}else if(typeof arguments[1]=='string'){if(arguments[2]&&typeof arguments[2]=='function'){eventSelector=arguments[1];eventFunction=arguments[2];if(typeof arguments[3]=='boolean'){eventHmt=arguments[3]}}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(eventHmt){EventAdapter.analyse(eventTarget,eventType);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':mobileDragStart(eventTarget,eventSelector,finalFunction);break;case'dragover':mobileDragOver(eventTarget,eventSelector,finalFunction);break;case'dragleave':mobileDragLeave(eventTarget,eventSelector,finalFunction);break;case'drop':mobileDrop(eventTarget,eventSelector,finalFunction);break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;},'eventOff':function(){if((arguments.length>2)||(arguments[0]&&typeof arguments[0]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(this instanceof jQuery)){eventTarget=jQuery(this);}else{eventTarget=this;}
if(arguments.length==0){eventTarget.off();return eventTarget;}
if(typeof arguments[0]=='string'){eventType=arguments[0];}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[1]=='string'){eventSelector=arguments[1];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector,mobileDragStart);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;}});EventAdapter.setData=function(date){if(date==undefined)return;eventData=date;};EventAdapter.getData=function(){return eventData;};document.addEventListener('drop',function(){eventData=null;},false);document.addEventListener('touchend',function(){eventData=null;},false);EventAdapter.clearEvent=function(){$(document).off('touchmove.copy');$(document).off('touchmove.drag');$(document).off('touchend.drop');};EventAdapter.analyse=function(eventTarget,eventType){if(eventTarget.length==0)return;var eventTargetName;if(eventTarget.attr('id')){eventTargetName=eventTarget.attr('id');}else if(eventTarget.attr('i18n')){eventTargetName=eventTarget.attr('i18n');}else if(eventTarget.attr('title')){eventTargetName=eventTarget.attr('title');}else{eventTargetName=eventTarget[0].textContent.substr(0,30);}
if(!eventTargetName)return;_hmt.push(['_trackEvent',eventTargetName,eventType,'']);};var mobileDragStart=function(e,target,eventFunction){var originalTarget=$(e.target).closest('[draggable="true"]')[0];var ev=e.type=='touchstart'?e.originalEvent.touches[0]:e,startPos={left:$(originalTarget).css('left'),top:$(originalTarget).css('top'),zIndex:$(originalTarget).css('z-index')},disX=originalTarget.offsetWidth/2,disY=originalTarget.offsetHeight/2;var $copyTarget=$(originalTarget).clone();$copyTarget.data('startPos',startPos);$copyTarget.css('z-index',10000);$copyTarget.css('position','absolute');$copyTarget.css('opacity','0.5');$copyTarget.css('pointer-events','none');var $container=$('body');$container.append($copyTarget);var sPos=$(originalTarget)[0].getBoundingClientRect();$copyTarget.css('left',sPos.left-$container[0].offsetLeft+'px');$copyTarget.css('top',sPos.top-$container[0].offsetTop+'px');$copyTarget[0].cssText=originalTarget.cssText;$copyTarget.css('width',originalTarget.offsetWidth);$copyTarget.css('height',originalTarget.offsetHeight);eventStatus='dragStart';eventFunction.call(this,ev);$(document).off('touchend.copy').on('touchend.copy',function(e){$copyTarget.remove();eventStatus='dragEnd';});$(document).on('touchmove.copy',function(e){eventStatus='dragMove';var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var $parent=$copyTarget.offsetParent();$parent=$parent.is(':root')?$(window):$parent;var targetLeft=ev.pageX-disX;var targetTop=ev.pageY-disY;$copyTarget.css({left:targetLeft+'px',top:targetTop+'px','z-index':10000});})};var mobileDragOver=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn'&&eventStatus!='dragMoveOut')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveIn';eventFunction.call(this,e);break;}}};var mobileDragLeave=function(e,target,eventFunction){if(eventStatus!='dragMoveIn')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(!((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY))){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveOut';eventFunction.call(this,e);}}};var mobileDragEnd=function(e,target,eventFunction){eventFunction.call(this,e);};var mobileDrop=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn')return;var ev=e.type=='touchend'?e.originalEvent.changedTouches[0]:e;var eventTarget=target;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventFunction.call(this,e);break;}}};return EventAdapter;})(jQuery);﻿
var Internationalization=(function(){function Internationalization(){this.type=localStorage["language"];this.resource=JSON.parse(localStorage["i18n"]);this.setDefautFont();};Internationalization.prototype={getResource:function(){return this.resource;},setDefautFont:function(strFont){if(!strFont){if(/OS/.test(window.jscd.os))strFont='Helvetica';if(window.jscd.os=='windows')strFont='微软雅黑';}
if(strFont)document.getElementsByTagName('body')[0].style.fontFamily=strFont;},fillPage:function(){this.fill2($('[i18n]'));},fillArea:function(element){this.fill2(element.find('[i18n]'));},fillAreaAttribute:function(element,attributeName){this.fill(element.find('[i18n]['+attributeName+']'),attributeName);},fill:function(arrElement,attributeName){for(var i=0,arrPath,text,len=arrElement.length;i<len;i++){arrPath=arrElement[i].attributes["i18n"].value.split('.');text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
if(!attributeName){arrElement[i].innerHTML=text;}
else{arrElement[i].setAttribute(attributeName,text);}}},getI18nValue:function(i18nKey){if(!i18nKey){return'';}
var arrPath=i18nKey.split('.');var text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
return text;},fill2:function(arrElement){for(var i=0,len=arrElement.length;i<len;i++){var i18nValue=arrElement[i].attributes["i18n"];var items=i18nValue.value.split(';'),item,i18nValue,attrMap;for(var j=0;j<items.length;j++){item=items[j];if(!item){continue;}
if(item.indexOf('=')===-1){i18nValue=this.getI18nValue(item);arrElement[i].innerHTML=i18nValue;}else{attrMap=item.split('=');if(!attrMap[0]){continue;}
arrElement[i].setAttribute(attrMap[0],this.getI18nValue(attrMap[1]));}}}},findContent:function(strPath){var arrPath=strPath.split('.');var text=this.resource;for(var i=0,len=arrPath.length;i<len;i++){text=text&&text[arrPath[i]];}
return text;}}
return Internationalization;})();﻿
var ReportScreen=(function(){var getThisWeekReportNum=function(){var weekNum=DateUtil.getWeekNumber(new Date());return DateUtil.getLastWeekNumberOf(weekNum[0],weekNum[1]);};function ReportScreen(reportStringId,reportType,reportFolder,reportDate){this.$reportNavigation=null;this.$ElScreenContainer=$(ElScreenContainer);this.reportStringId=reportStringId;this.reportType=reportType;this.reportFolder=reportFolder;this.dateList=[];this.pdfMap=[];this.datePickerInstance=null;this.reportDate=reportDate;this.reportName='';this.week=null;this.getMonthFirst=true;this.currentTR=null;this.currentDatePicker=null;this.currentYear=null;this.currentGoToday=false;this.firstOpen=true;this.dateTimePickerInline=false;this.i18nEcharts=I18n.resource.echarts;}
ReportScreen.prototype={displayWeek:getThisWeekReportNum(),reportTypeMap:{daily:'0',monthly:'1',weekly:'2'},baseChartOption:{title:{x:'center',textStyle:{fontSize:15}},tooltip:{trigger:'axis'},toolbox:{show:true,feature:{mark:{show:true},dataView:{show:true,readOnly:true},restore:{show:true},saveAsImage:{show:true}}},animation:false},chartYOffsetSetting:{grid:{y:100},legend:{y:40}},chartType:{pie:'pie',line:'line',scatter:'scatter',bar:'bar',area:'area',table:'table'},chartList:{},show:function(){this.init();},close:function(){this.unregisterChartResize();this.clearHash();this.disposeChart();this.chartList={};$(window).off('resize');this.unregisterPrintEvent();},disposeChart:function(){for(var chartId in this.chartList){this.chartList[chartId].dispose();}},init:function(){if(this.reportDate){this.getReport.apply(this,this.reportDate.split('-'));}else{this.getReport();}
this.chartList={};this.registerPrintEvent();this.registerExportPDFEvent();},pieOptionToContent:function(opt){var html='';var series=$.extend(true,[],opt.series);for(var m=0,ml=series.length;m<ml;m++){series[m].data.sort(function(a,b){return a.name.localeCompare(b.name);});var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+series[m].name+'</p>';html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';for(var n=0,nl=series[m].data.length;n<nl;n++){html+='<tr>'+'<td>'+series[m].data[n].name+'</td>';for(var j=0,jl=series[m].data[n].value.length;j<jl;j++){html+='<td>'+series[m].data[n].value[j]+'</td>'}
html+='</tr>'}
html+='</tbody></table>';}
return html;},optionToContent:function(opt){var axisData=opt.xAxis&&opt.xAxis[0].data,series=opt.series;var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+opt.title.text+'</p>';var html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';if(BEOPUtil.isUndefined(axisData)){html+='<tr>';for(var i=0,l=series.length;i<l;i++){html+='<td colspan="2">'+series[i].name+'</td>';}
html+='</tr>';var longestSeriesData=[],longestLength=0;for(var j=0,sl=series.length;j<sl;j++){if(series[j].data.length>longestLength){longestSeriesData=series[j].data;longestLength=longestSeriesData.length;}}
for(var i=0,il=longestSeriesData.length;i<il;i++){html+='<tr>';for(var m=0,ml=series.length;m<ml;m++){if(!BEOPUtil.isUndefined(series[m].data[i])){for(var n=0,nl=series[m].data[i].length;n<nl;n++){html+='<td>'+series[m].data[i][n]+'</td>';}}}
html+='</tr>';}}else{html+='<tr><td>'+opt.xAxis[0].name+'</td>';for(var i=0,l=series.length;i<l;i++){html+='<td>'+series[i].name+'</td>';}
html+='</tr>';for(var i=0,l=axisData.length;i<l;i++){html+='<tr>'+'<td>'+axisData[i]+'</td>';for(var j=0,sl=series.length;j<sl;j++){html+='<td>'+series[j].data[i]+'</td>';}
html+='</tr>';}}
html+='</tbody></table>';return html;},registerChartResize:function(){var _this=this;this.unregisterChartResize();$(window).on('resize.beop.report.echarts',function(){for(var m in _this.chartList){_this.chartList[m].resize();}});},unregisterChartResize:function(){$(window).off('resize.beop.report.echarts');},beforePrintReportScreen:function(){var chart=null,image,$chart;for(var m in this.chartList){chart=this.chartList[m];if(chart){image=this.chartList[m].getImage();$(image).addClass('chartImage');$chart=$(chart.dom);$chart.parent().append(image);$chart.hide();}}},afterPrintReportSceen:function(){var chart=null,$chart;for(var m in this.chartList){chart=this.chartList[m];if(chart){$chart=$(chart.dom);$chart.show();$chart.parent().children('.chartImage').remove();chart.resize();}}},mediaPrintEvent:function(mql){if(mql.matches){this.beforePrintReportScreen();}else{this.afterPrintReportSceen();}},registerExportPDFEvent:function(){var _this=this;var downloadPDF=function(href,filename){var a=$("<a id='test' download='"+filename+"' target='_self'' href='"+href+"'>Download2</a>")[0];try{try{a.click();}catch(ex){var evObj=document.createEvent('MouseEvents');evObj.initEvent('click',true,true,window);a.dispatchEvent(evObj);}}catch(ex){alert('download failed.Please contact the administrator.');return false;}};$(ElScreenContainer).off('click','#exportPDF').on('click','#exportPDF',function(){var chart=null,$image,$chart,$this=$(this),$report=$('.step-play-list').clone(),reportFolderName=$this.attr('reportFolderName'),version=$this.attr('version'),pdfName=AppConfig.projectShowName+'.'+_this.getReportName()+'.'+version+'.pdf';if(_this.pdfMap[version]){downloadPDF(_this.pdfMap[version],pdfName);}else{Spinner.spin(ElScreenContainer);for(var m in _this.chartList){chart=_this.chartList[m];if(chart){$chart=$report.find('[chart-id='+$(chart.dom).attr('chart-id')+']');$image=$(_this.chartList[m].getImage()).addClass('chartImage');$chart.replaceWith($image);}}
$('.canvas-container',$report).each(function(index,item){$(item).prev('.summary').addBack().wrapAll('<div class="pageHeaderWrapper"></div>');});$('.step-item-container',$report).each(function(index,item){$(item).find('.page-header').next().addBack().wrapAll('<div class="pageHeaderWrapper"></div>');});WebAPI.post('/admin/getReportPDF',{html:$report.html(),folder:reportFolderName,version:version,projectName:AppConfig.projectName}).done(function(result){if(result.success){downloadPDF(result.data.createdPDF,pdfName);_this.pdfMap=result.data.pdfMap;}}).always(function(){Spinner.stop();});}})},registerPrintEvent:function(){if(window.matchMedia){window.matchMedia('print').addListener(this.mediaPrintEvent.bind(this));}
$(window).on('beforeprint.beop.report.echarts',this.beforePrintReportScreen.bind(this));$(window).on('afterprint.beop.report.echarts',this.afterPrintReportSceen.bind(this));},unregisterPrintEvent:function(){if(window.matchMedia){window.matchMedia('print').removeListener(this.mediaPrintEvent.bind(this));}
$(window).off('beforeprint.beop.report.echarts');$(window).off('afterprint.beop.report.echarts');},registerMousewheelEvent:function(){var _this=this;$('#indexMain').on('mousewheel.beop.report','.step-container',function(event){var $target=$(this);if(event.originalEvent.wheelDelta>0){if($target.scrollTop()===0){_this.preReportUnit();event.stopPropagation();return false;}else{event.stopPropagation();return true;}}else{if($target.scrollTop()+$target.innerHeight()+1>=$target[0].scrollHeight){_this.nextReportUnit();event.stopPropagation();return false;}else{event.stopPropagation();return true;}}}).on('mousewheel.beop.report',function(event){if(event.originalEvent.wheelDelta>0){_this.preReportUnit();}else{_this.nextReportUnit();}
return false;});},unregisterMousewheelEvent:function(){$('#indexMain').off('mousewheel.beop.report');},clearHash:function(){},_getNextReportUnitItem:function(nextItemFunc){var $reportUnitList=this.$ElScreenContainer.find('.report-unit'),currentIndex,nextIndex,nextReportUnit,nextListItemId;$reportUnitList.each(function(index,item){if($(item).hasClass('active')){currentIndex=index;}});nextIndex=nextItemFunc($reportUnitList.length-1,currentIndex);nextReportUnit=$reportUnitList.get(nextIndex);if(nextReportUnit){nextListItemId=nextReportUnit.id;return this.$reportNavigation.find('a[report-unit="'+nextListItemId+'"]').closest('li');}else{return null;}},nextReportUnit:function(){var $nextItem=this._getNextReportUnitItem(function(total,current){return current===total?0:current+1;});$nextItem&&$nextItem.trigger('click');},preReportUnit:function(){var $nextItem=this._getNextReportUnitItem(function(total,current){return current===0?total:current-1;});$nextItem&&$nextItem.trigger('click',true);},getReportFolder:function(key){return this.reportFolder;},getReportType:function(){return this.reportType;},getReportName:function(){if(!this.reportStringId){return'';}
if(!this.reportName){for(var i=0;i<AppConfig.navItems.length;i++){var navItem=AppConfig.navItems[i];if(navItem.id===this.reportStringId){this.reportName=navItem.text;}}}
return this.reportName;},initReportList:function(){if(!AppConfig.navItems){return false;}
var reportItem,reportItemList,$reportItemBtn,_this=this,$listGroup=$('<ul id="reportNavList" class="list-group reportList" style="width:110px;overflow-y: auto;height: 90%;overflow-x: hidden;"></ul>');reportItemList=AppConfig.navItems.filter(function(item){return item.type==='ReportScreen';});for(var i=0;i<reportItemList.length;i++){reportItem=reportItemList[i];$reportItemBtn=$('<li class="list-group-item ellipsis" id="'+reportItem.id+'" title="'+reportItem.text+'">'+reportItem.text+'</li>');$reportItemBtn.click((function(reportItem){return function(){ScreenManager.show(ReportScreen,reportItem.id,reportItem.reportType,reportItem.reportFolder,_this.reportDate?_this.reportDate.format('yyyy-MM-dd'):null);};})(reportItem));$listGroup.append($reportItemBtn);}
$('#indexMain').append($listGroup);$("#"+_this.reportStringId).addClass("active");var $reportNavList=$("#reportNavList");$reportNavList.css({left:parseInt($(".step-container").offset().left)-parseInt($reportNavList.width())+1-2+'px'});$(window).resize(function(){$reportNavList.css({left:parseInt($(".step-container").offset().left)-parseInt($reportNavList.width())+1-2+'px'});});},getReport:function(year,month,day,isWeekly){var _this=this,version,thisDay;Spinner.spin(ElScreenContainer);var reportFolderName=this.getReportFolder();if(this.getReportType()===this.reportTypeMap.daily){if(!month||!year||!day){thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);version=thisDay.format('yyyy-MM-dd');year=thisDay.getFullYear();month=thisDay.getMonth()+1;day=thisDay.getDate();}else{version=year+"-"+StringUtil.padLeft(month,2,'0')+"-"+StringUtil.padLeft(day,2,'0');}}
else if(this.getReportType()===this.reportTypeMap.monthly){if(!month||!year){thisDay=new Date();year=thisDay.getFullYear();month=DateUtil.getLastMonth();}
version=year+'-'+StringUtil.padLeft(month,2,'0');}else{thisDay=new Date();year=thisDay.getFullYear();month=month?month:(_this.iso8601Week(new Date(year,thisDay.getMonth()-1)));version=year+'-'+month+'-w';}
var getReportFailed=function(){Spinner.spin(ElScreenContainer);WebAPI.get('/static/projectReports/emptyReport.html').done(function(resultHtml){I18n.fillArea($(ElScreenContainer).html(resultHtml));Spinner.spin(ElScreenContainer);if(day){day=day<10?day.length==2?day:'0'+day:day;}
_this.initDatePicker(year,month,day);if(_this.dateTimePickerInline){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,-10);}else{BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50);}
$(window).resize(function(){if(_this.dateTimePickerInline){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,39);}else{BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50);}});_this.initReportList();Spinner.stop();})};return WebAPI.get("/report/getReport/"+AppConfig.projectName+"/"+reportFolderName+'/'+version).done(function(resultHtml){I18n.fillArea($(ElScreenContainer).html(resultHtml));Spinner.stop($(ElScreenContainer));_this.renderCharts($('#beopReport .report-unit'));_this.$reportNavigation=$('.reportNavigation');_this.initDatePicker(year,month,day);if(_this.dateTimePickerInline){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,-10);}else{BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50);}
$(window).resize(function(){if(_this.dateTimePickerInline){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,39);}else{BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50);}});_this.$reportNavigation.affix({offset:{top:100}});$('.step-container').scrollspy({target:'.reportNavigation'});var $pdfContent='<a id="exportPDF" class="pdf_download exportPDF pa"><span class="add-on"><img class="pdf_img" src="/static/images/pdf_download.png"　alt="PDF" /></span><span class="pdf_text" i18n="observer.reportScreen.PDF_DOWNLOAD"></span></a>';$(".reportNavigation").prepend($pdfContent);var $exportPDF=$('#beopReport #exportPDF');if(!$exportPDF.length){$('#beopReport').append($exportPDF);}
$exportPDF.attr('reportFolderName',reportFolderName).attr('version',version);_this.initReportList();Spinner.stop();}).fail(function(){getReportFailed();}).always(function(){WebAPI.get("/report/getReportList/"+AppConfig.projectName+"/"+reportFolderName+'/'+version).done(function(result){if(result.success){_this.dateList=$.unique(result.data.htmlReport);_this.pdfMap=result.data.pdfReportMap;}});I18n.fillArea($(ElScreenContainer));Spinner.stop();});},addActiveWeeksStyle:function(){var $con=this.datePickerInstance.picker,yearMonth=this.datePickerInstance.viewDate.format('yyyy-MM').split('-'),year=yearMonth[0],i,timeList;this.filterDateList('week');for(i=0;i<this.dateList.length;i++){timeList=this.dateList[i].split('-');if(timeList[0]==year){$con.find('.datetimepicker-days table tbody td.ui-week-col').each(function(){if($(this).text()==timeList[1]){$(this).parent().addClass('hasReport');}});}}},addActiveDaysStyle:function(){var $con=this.datePickerInstance.picker;var yearMonth=this.datePickerInstance.viewDate.format('yyyy-MM').split("-");var year=yearMonth[0];var month=yearMonth[1];this.filterDateList('day');for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList[0]==year&&timeList[1]==month){$con.find(".day:not('.old,.new')").eq(Number(timeList[2])-1).addClass("hasReport");}}},addActiveMonthsStyle:function(){var $con=this.datePickerInstance.picker;var year=this.datePickerInstance.viewDate.format('yyyy').split("-");this.filterDateList('month');for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList[0]==year){$con.find(".month").eq(Number(timeList[1])-1).addClass("hasReport");}}},filterDateList:function(val){var dayList=[];var monthList=[];var weekList=[];for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList.length==3&&this.getReportType()==this.reportTypeMap.weekly){weekList.push(this.dateList[i]);}
else if(timeList.length>2){dayList.push(this.dateList[i]);}else{monthList.push(this.dateList[i]);}}
if(val=="day"){this.dateList=dayList;}else if(val=='month'){this.dateList=monthList;}else{this.dateList=weekList;}},triggerDateStyle:function(val){var _this=this;var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){if(val=="day"){_this.addActiveDaysStyle();}else if(val=="month"){_this.addActiveMonthsStyle();}else if(val=='weekly'){_this.addActiveWeeksStyle();}},50);},iso8601Week:function(date){var time,checkDate=new Date(date.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},renderCharts:function($chartContainer){var echartForI18Option={};if(this.i18nEcharts){echartForI18Option={toolbox:{feature:{mark:{show:true,title:{mark:this.i18nEcharts.MARK,markUndo:this.i18nEcharts.MARKUNDO,markClear:this.i18nEcharts.MARKCLEAR}},dataZoom:{title:{dataZoom:this.i18nEcharts.DATAZOOM,dataZoomReset:this.i18nEcharts.DATAZOOMRESET}},dataView:{title:this.i18nEcharts.DATAVIEW,lang:[this.i18nEcharts.DATAVIEW,this.i18nEcharts.CLOSE,this.i18nEcharts.REFRESH],show:true,readOnly:true},magicType:{title:{line:this.i18nEcharts.LINE,bar:this.i18nEcharts.BAR,stack:this.i18nEcharts.STACK,tiled:this.i18nEcharts.TILED,force:this.i18nEcharts.FORCE,chord:this.i18nEcharts.CHORD,pie:this.i18nEcharts.PIE,funnel:this.i18nEcharts.FUNNEL}},restore:{show:true,title:this.i18nEcharts.REDUCTION},saveAsImage:{show:true,title:this.i18nEcharts.SAVE_AS_PICTURE,lang:[this.i18nEcharts.SAVE]}}}};}
if(jscd.mobile){var _this=this;window.addEventListener('load',function(){$('canvas').off().remove();var m=0;ReportScreen=null;for(m=0;m<_this.chartList.length;m++){_this.chartList[m].clear();_this.chartList[m].dispose();}
_this.chartList=null;$('.canvas-container').off();$('.step-container').off();$(".form_datetime").off();},false);var extraOptionsForMobile={toolbox:{show:false},title:{textStyle:{fontSize:2.5}},grid:{x:2,y:2,x2:2,y2:2},xAxis:[{axisLabel:{textStyle:{fontSize:12},interval:'auto'},nameTextStyle:{fontSize:1.8}}],yAxis:[{axisLabel:{textStyle:{fontSize:2}},nameTextStyle:{fontSize:1.8}}],legend:{textStyle:{fontSize:2}},renderAsImage:true};this.baseChartOption=$.extend(true,this.baseChartOption,extraOptionsForMobile,echartForI18Option);}else{this.baseChartOption=$.extend(true,this.baseChartOption,echartForI18Option);}
var charts=$chartContainer.find('.chart-param');for(var i=0;i<charts.length;i++){this.initCharts($(charts[i]));}},initDatePicker:function(year,month,day){var now=new Date();var year=!year?now.getFullYear():year;var monthNameShort=!month?DateUtil.getMonthNameShort(DateUtil.getLastMonth()-1):DateUtil.getMonthNameShort(month-1);var monthName=!month?DateUtil.getMonthName(DateUtil.getLastMonth()-1):DateUtil.getMonthName(month-1);var day=!day?now.getDate():day;var $datePick=$(".form_datetime");if(this.dateTimePickerInline==true){$datePick.empty();}
var _this=this;var dateDisplay;if(this.getReportType()==this.reportTypeMap.daily){if(!_this.dateTimePickerInline){$datePick.find('input').val(monthNameShort+' '+day+','+year);}
$datePick.datetimepicker({format:"MM dd,yyyy",minView:"month",startView:"month",todayBtn:true,inline:true,sideBySide:true,autoclose:true,endDate:new Date()}).on('changeDate',function(ev){try{var date=ev.date.valueOf().toDate();_this.reportDate=date;_this.getReport(date.getFullYear(),date.getMonth()+1,date.getDate());}catch(e){return false;}}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('day');}).on('show',function(ev){var dayFormat=ev.date.getDate()>=10?ev.date.getDate():'0'+ev.date.getDate();dateDisplay=DateUtil.getMonthNameShort(ev.date.getMonth())+' '+dayFormat+','+ev.date.getFullYear();if(!_this.dateTimePickerInline){$datePick.find('input').val(dateDisplay);}
_this.addActiveDaysStyle();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('day');});});this.dateTimePickerInline==true?updateDaily():'';function updateDaily(){setTimeout(function(){_this.triggerDateStyle('day');$datePick.datetimepicker('update',new Date(year,Number(month)-1,day));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('day');});},0)}}else if(this.getReportType()==this.reportTypeMap.monthly){if(!_this.dateTimePickerInline){$datePick.find('input').val(monthNameShort+','+year);}
$datePick.datetimepicker({format:"MM,yyyy",minView:"year",startView:"year",todayBtn:true,inline:true,sideBySide:true,autoclose:true,endDate:new Date(),monthAbbreviation:true}).on('changeDate',function(ev){try{var date=ev.date.valueOf().toDate();_this.reportDate=date;_this.getReport(date.getFullYear(),date.getMonth()+1);}catch(e){return false;}}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('month');}).on('show',function(ev){dateDisplay=DateUtil.getMonthNameShort(ev.date.getMonth())+','+ev.date.getFullYear();_this.addActiveMonthsStyle();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('month');});});this.dateTimePickerInline==true?updateMonthly():'';function updateMonthly(){setTimeout(function(){_this.triggerDateStyle('month');$datePick.datetimepicker('update',new Date(year,Number(month)-1))
_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('month');});},0)}}else if(this.getReportType()==this.reportTypeMap.weekly){var week;if(this.week!=null){week=this.week;}else if(this.getMonthFirst=true){var date=new Date();week=this.iso8601Week(new Date(date.getFullYear(),date.getMonth()-1));}else{week=this.iso8601Week(new Date(year,['January','February','March','April','May','June','July','August','September','October','November','December'].indexOf(monthName)));}
this.getMonthFirst=false;if(this.currentYear){year=this.currentYear;}
if(!_this.dateTimePickerInline){$datePick.find('input').val(year+'-'+week+'-周');}
$datePick.datetimepicker({format:'yyyy-mm-dd hh:ii',todayBtn:true,autoclose:true,showWeek:true,inline:true,sideBySide:true,minView:2,endDate:new Date()}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('weekly');}).on('show',function(ev){_this.addActiveWeeksStyle();if(_this.currentTR!==null&&_this.currentTR!==undefined&&_this.currentTR!=='undefined'){if(_this.currentDatePicker){if(!_this.currentGoToday){$datePick.datetimepicker('update',new Date(_this.currentDatePicker).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();$('.datetimepicker:last .datetimepicker-days table tbody tr').eq(_this.currentTR).addClass('active');}else{var weekNow=_this.iso8601Week(new Date())-1;$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});_this.currentGoToday=false;}
_this.addActiveWeeksStyle();}}else{if(_this.firstOpen){$datePick.datetimepicker('update',new Date(year,date.getMonth()-1).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();}else{var weekNow=_this.iso8601Week(new Date())-1;$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});}}
dateDisplay=DateUtil.getMonthName(ev.date.getMonth())+','+ev.date.getFullYear();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('weekly');});}).on('changeDay',function(date){try{_this.reportDate=date.date;_this.getReport(new Date(date.date).getFullYear(),date.week,null,true);_this.week=date.week;_this.currentTR=date.currentTr;_this.currentDatePicker=date.date;_this.currentYear=new Date(date.date).getFullYear();}catch(e){return false;}}).on('goToToday',function(date){_this.currentGoToday=false;_this.firstOpen=false;try{_this.reportDate=date.date;_this.getReport(new Date(date.date).getFullYear(),date.week,null,true);_this.week=date.week;_this.currentTR=date.currentTr;_this.currentDatePicker=date.date;_this.currentYear=new Date(date.date).getFullYear();}catch(e){return false;}});this.dateTimePickerInline==true?updateWeekly():'';function updateWeekly(){setTimeout(function(){_this.triggerDateStyle('weekly');$datePick.datetimepicker('update',new Date(year,Number(month)-1));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('weekly');});_this.addActiveWeeksStyle();if(_this.currentTR!==null&&_this.currentTR!==undefined&&_this.currentTR!=='undefined'){if(_this.currentDatePicker){if(!_this.currentGoToday){$datePick.datetimepicker('update',new Date(_this.currentDatePicker).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();$('.datetimepicker:last .datetimepicker-days table tbody tr').eq(_this.currentTR).addClass('active');}else{var weekNow=_this.iso8601Week(new Date())-1;$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});_this.currentGoToday=false;}
_this.addActiveWeeksStyle();}}else{if(_this.firstOpen){$datePick.datetimepicker('update',new Date(year,date.getMonth()-1).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();}else{var weekNow=_this.iso8601Week(new Date())-1;$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});}}},0)}}
this.datePickerInstance=$datePick.data('datetimepicker');},initReportNavigation:function(){var _this=this;this.$reportNavigation.on('click','li.reportChapter',function(){var $this=$(this),$reportUnit,reportUnitId,$sub_li;if($this.hasClass('active')){return false;}
$this.closest('.reportNavigation').find('li.active').removeClass('active');$this.addClass('active');$sub_li=$this.find('li:first');if($sub_li.size()>0){reportUnitId=$sub_li.addClass('active').find('a').attr('report-unit');}
$reportUnit=$('#'+reportUnitId);_this.showReportUnit($reportUnit).done(function(){_this.renderCharts($reportUnit);if(_this.chartList[reportUnitId]){_this.chartList[reportUnitId].resize();}});})},showReportUnit:function($reportUnit,isUp){$reportUnit.closest('.step-play-list').find('.report-unit.active').removeClass('active');var dfd=$.Deferred();$('.step-container').animate({top:isUp?'-200px':'100px',opacity:"toggle"},'fast',function(){$reportUnit.addClass('active');$('.step-container').css('top',isUp?'200px':'-100px').animate({top:'0px',opacity:"toggle"},function(){dfd.resolve();});});return dfd;},generateChartId:function(){return new Date().getTime();},initCharts:function($canvasChart){var chartOpts=this.getChartParam($canvasChart);if(!chartOpts){return;}
var chartDom=$canvasChart.parent()[0],chartId=this.generateChartId(),chartInstance;$(chartDom).attr('chart-id',chartId);switch(chartOpts.type){case this.chartType.line:chartInstance=this.initChartLine(chartDom,chartOpts);break;case this.chartType.pie:chartInstance=this.initChartPie(chartDom,chartOpts);break;case this.chartType.bar:chartInstance=this.initChartBar(chartDom,chartOpts);break;case this.chartType.scatter:chartInstance=this.initChartScatter(chartDom,chartOpts);break;case this.chartType.area:chartInstance=this.initChartArea(chartDom,chartOpts);break;case this.chartType.table:chartInstance=this.initChartTable(chartDom,chartOpts);break;default:console.log('生成图像错误:没有类型'+chartOpts.type);break;}
if(chartOpts.theme){chartInstance.setTheme(chartOpts.theme);}
if(chartInstance){chartInstance.on(echarts.config.EVENT.MAGIC_TYPE_CHANGED,function(event,chart){if(event.magicType.line){chart.setOption({tooltip:{axisPointer:{type:'line'}}})}else if(event.magicType.bar){chart.setOption({tooltip:{axisPointer:{type:'shadow'}}})}});this.chartList[chartId]=chartInstance;this.registerChartResize();}},getChartParam:function($chartParam){try{var unitString=$chartParam.text();if(!unitString){return null;}
unitString=unitString.replace(/"/g,"\\\"").replace(/'/g,"\"");return JSON.parse(unitString);}catch(e){console.error(e);return null;}},getChartSeriesData:function(type,x,yData,y){var result=[];switch(type){case this.chartType.bar:case this.chartType.line:case this.chartType.scatter:case this.chartType.area:{result=yData;break;}
case this.chartType.pie:{for(var i=0;i<y.length;i++){result.push({name:y[i].name,value:y[i].value})}
break;}
default:{result=yData;}}
return result;},getChartOptsFromParam:function(chartParam,type){var y=chartParam.chartItems.y,x=chartParam.chartItems.x,series=[],legend=[],yItem,seriesItem,result,yAxis=[],_this=this;if(type===this.chartType.pie){legend=x;seriesItem={};seriesItem.name=chartParam.title;seriesItem.data=this.getChartSeriesData(type,x,null,y);seriesItem.type=type;seriesItem.selectedMode='single';series.push(seriesItem);}else{if(!$.isArray(y)){var temp=[];for(var key in y){var obj={name:key,value:y[key],yAxisIndex:0};temp.push(obj);}
y=temp;}
for(var m=0,length=y.length;m<length;m++){yItem=y[m];var seriesItem={};seriesItem.yAxisIndex=Number(yItem.yAxisIndex)||0;seriesItem.name=yItem.name;seriesItem.data=this.getChartSeriesData(type,x,yItem.value,yItem);if(yItem.stack){seriesItem.stack=yItem.stack;}
if(type===this.chartType.area){seriesItem.type=this.chartType.line;seriesItem.stack=I18n.resource.observer.widgets.TOTAL_AMOUNT;seriesItem.itemStyle={normal:{areaStyle:{type:'default'}}};}else{if(yItem.type){seriesItem.type=yItem.type;}else{seriesItem.type=type;}}
if(yItem.otherOptions){$.extend(seriesItem,yItem.otherOptions);}
seriesItem._name=yItem.name;series.push(seriesItem);legend.push(yItem.name);}
if(!$.isArray(chartParam.Options.y)){yAxis.push({name:chartParam.Options.y,type:'value',scale:true})}else{for(var i=0;i<chartParam.Options.y.length;i++){var yAxisItem={name:chartParam.Options.y[i],type:'value',scale:true};if(!BEOPUtil.isUndefined(chartParam.yMax)&&chartParam.yMax.length){yAxisItem.max=+chartParam.yMax[i];yAxisItem.scale=false;}
if(!BEOPUtil.isUndefined(chartParam.yMin)&&chartParam.yMin.length){yAxisItem.min=+chartParam.yMin[i];yAxisItem.scale=false;}
yAxis.push(yAxisItem);}}}
result={title:{text:chartParam.title},noDataLoadingOption:{text:I18n.resource.observer.reportScreen.TITLE_NO_DATA,effect:'whirling'},legend:{data:this._sortLegend(legend)},series:series.sort(function(a,b){return _this._sortFunction(a._name,b._name);}),xAxis:[{scale:true,name:chartParam.Options.x}],yAxis:yAxis};if(x&&x.length>0){result.xAxis[0].data=x;result.xAxis[0].type='category';}else{result.xAxis[0].type='value';}
if(type===this.chartType.pie){delete result.xAxis;delete result.yAxis;}
if(chartParam.commonChartOptions){var convertTheFunction=function(obj){for(var prop in obj){if(typeof obj[prop]==='string'&&obj[prop].indexOf('function(')!=-1){obj[prop]=eval(obj[prop]);}else if($.isPlainObject(obj[prop])){convertTheFunction(obj[prop]);}}};try{convertTheFunction(chartParam.commonChartOptions);$.extend(result,chartParam.commonChartOptions);}catch(e){}}
return result;},_sortFunction:function(a,b){var ax=[],bx=[];a.replace(/(\d+)|(\D+)/g,function(_,$1,$2){ax.push([$1||Infinity,$2||""])});b.replace(/(\d+)|(\D+)/g,function(_,$1,$2){bx.push([$1||Infinity,$2||""])});while(ax.length&&bx.length){var an=ax.shift();var bn=bx.shift();var nn=(an[0]-bn[0])||an[1].localeCompare(bn[1]);if(nn)return nn;}
return ax.length-bx.length;},_sortLegend:function(legend){if(!legend){return[];}
legend.sort(this._sortFunction);var ret=[],splitNum;if(legend.length>15){splitNum=Math.ceil(legend.length/3);}else{splitNum=5;}
for(var i=0,j=legend.length;i<j;i++){ret.push(legend[i]);if((i+1)%splitNum===0){ret.push('');}}
return ret;},initChartLine:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{magicType:{show:true,type:['line','bar','stack','tiled']},dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.line));return echarts.init(chartDom).setOption(option);},initChartPie:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.pieOptionToContent}}},legend:{orient:'vertical',x:'left',y:40}};var option=$.extend(true,defaultOption,this.getChartOptsFromParam(chartParam,this.chartType.pie),this.baseChartOption);if(!option.tooltip.formatter||$.isEmptyObject(option.tooltip.formatter)){$.extend(true,option,{tooltip:{trigger:'item',formatter:"{a} <br/> {b} : {c} ({d}%)"}})}
return echarts.init(chartDom).setOption(option);},initChartBar:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{magicType:{show:true,type:['line','bar','stack','tiled']},dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.bar));return echarts.init(chartDom).setOption(option);},initChartScatter:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.scatter));return echarts.init(chartDom).setOption(option);},initChartArea:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.area));return echarts.init(chartDom).setOption(option);},initChartTable:function(chartDom,chartParam){if(chartParam&&chartParam.chartItems&&chartDom){chartParam.chartItems.title=chartParam.title?chartParam.title:'';chartParam.chartItems.firstColumn=chartParam.Options&&chartParam.Options.x?chartParam.Options.x:'';$(chartDom).replaceWith(beopTmpl('tmpl_table',chartParam.chartItems));}}};return ReportScreen;})();var ElScreenContainer=document.getElementById('indexMain');var ScreenCurrent=undefined;var ScreenPrevious=undefined;var Spinner=new LoadingSpinner({color:'#00FFFF'});var AppConfig={userId:undefined,account:undefined,isMobile:true};var ProjectConfig={projectId:undefined,projectIndex:undefined,projectList:undefined,projectInfo:undefined,reportList:undefined,reportDetail:undefined,reportId:undefined,reportIndex:undefined,refreshTime:undefined,refreshInterval:7200000};var WkConfig={defaultSize:13,wkList:{working:[],created:[],finished:[],joined:[]},refreshTime:undefined,refreshInterval:1800000};var I18n=undefined;var appConfigManager=(function(){var DEFAULT_CONFIG={gps:0};function get(){var options=window.localStorage.getItem('appConfig');if(options===null){set(DEFAULT_CONFIG);return DEFAULT_CONFIG;}
try{options=JSON.parse(options);}catch(e){}
return options;}
function set(options){window.localStorage.setItem('appConfig',JSON.stringify(options));}
return{get:get,set:set}}());$(document).ready(function(){if(navigator.userAgent.match(/iP(ad|hone|od)|Android/i))AppConfig.isMobile=true;InitI18nResource(navigator.language.split('-')[0]);});var IndexScreen=(function(){function IndexScreen(){}
IndexScreen.prototype={show:function(){var _this=this;$.ajax({url:'static/app/dashboard/views/admin/login.html'}).done(function(resultHTML){$('#indexMain').html(resultHTML);_this.init();});},close:function(){document.onkeydown=false;},init:function(){var _this=this;_this.initNav();_this.initLogin();},initLogin:function(){this.restorePwd();var _this=this;$("#btnLogin").hammer().off('tap').on('tap',function(e){_this.login();});$(document).on("keydown","#divLogin input",function(event){var e=event||window.event||arguments.callee.caller.arguments[0];if(e&&e.keyCode==13){_this.login();}});},login:function(){var _this=this;var $btnLogin=$('#btnLogin');Spinner.spin(ElScreenContainer);var userName=$("#userName").val(),password=$("#password").val();var loginFail=function(msg){$('.alert').remove();new Alert($("#divAlert"),"danger",msg).show().close();Spinner.stop();};if(!(userName&&password)){loginFail('用户名或密码错误！');return;}
WebAPI.post("/login",{name:userName,pwd:password,agent:jscd?jscd:{}}).then(function(_login_result){try{var login_result=JSON.parse(_login_result);var after_login=function(){if(login_result.status!=undefined&&login_result.status==true){if(login_result.projects&&login_result.projects.length>0){_this.rememberPwd();AppConfig.userId=login_result.id;AppConfig.account=$("#userName").val();AppConfig.userProfile=login_result.userProfile;AppConfig.userOfRole=login_result.userProfile.userOfRole;ProjectConfig.projectList=login_result.projects;if(!localStorage.getItem('defaultProjectId')){switch(localStorage.getItem('module')){case'project':router.empty().to({typeClass:ProjectList,data:{}});break;case'message':router.empty().to({typeClass:MessageIndex,data:{}});break;case'workflow':router.empty().to({typeClass:WorkflowList,data:{}});break;default:router.empty().to({typeClass:ProjectList,data:{}});break;}}else{for(var i=0;i<ProjectConfig.projectList.length;i++){if(ProjectConfig.projectList[i].id==localStorage.getItem('defaultProjectId')){ProjectConfig.projectId=ProjectConfig.projectList[i].id;ProjectConfig.projectInfo=ProjectConfig.projectList[i];ProjectConfig.projectIndex=i;switch(localStorage.getItem('module')){case'project':router.empty().to({typeClass:ProjectSummary,data:{}});break;case'message':router.empty().to({typeClass:MessageIndex,data:{}});break;case'workflow':router.empty().to({typeClass:WorkflowList,data:{}});break;default:router.empty().to({typeClass:ProjectSummary,data:{}});break;}
break;}}}}else{loginFail("登录失败，没有任何项目的权限！");}}else{loginFail("用户名或密码错误！");}}}catch(e){loginFail("登录失败！");return false;}
after_login();}).always(function(){Spinner.stop();})},rememberPwd:function(){localStorage["userInfo"]=JSON.stringify({name:$("#userName").val(),pwd:$("#password").val()});},restorePwd:function(){if(localStorage["userInfo"]){var data=JSON.parse(localStorage["userInfo"]);if(data.pwd&&data.pwd!=""){$("#userName").val(data.name);$("#password").val(data.pwd);}}},initNav:function(){$('.btn-back','#navTop').hammer().off('tap').on('tap',function(e){router.back();});$('#btnProject').hammer().off('tap').on('tap',function(e){router.to({typeClass:ProjectSummary});e.preventDefault();});$('#btnMessage').hammer().off('tap').on('tap',function(e){router.to({typeClass:MessageIndex});e.preventDefault();});$('#btnWorkFlow').hammer().off('tap').on('tap',function(e){router.to({typeClass:WorkflowList});e.preventDefault();});$('#btnAdminConfig').hammer().off('tap').on('tap',function(e){router.to({typeClass:AdminConfig});e.preventDefault();});}};return IndexScreen;})();function InitI18nResource(strLanguage,isForce){if(strLanguage=='')return;if(isForce){localStorage["isUserSelectedLanguage"]=strLanguage;}
else if(localStorage["isUserSelectedLanguage"]){strLanguage=localStorage["isUserSelectedLanguage"];}
$.getScript("/static/views/js/i18n/"+strLanguage+".js").done(function(e){localStorage["language"]=strLanguage;localStorage["i18n"]=JSON.stringify(i18n_resource);Init();}).error(function(e){if(!localStorage["i18n"]){$.getScript("/static/views/js/i18n/en.js").done(function(e){localStorage["language"]="en";localStorage["i18n"]=JSON.stringify(i18n_resource);Init();})}});}
function Init(){router.to({typeClass:IndexScreen,data:{}});I18n=new Internationalization();}
var toggle=(function(){var _this=this;function toggle(){_this=this;}
toggle.pageLeft=function(target,data){$(ElScreenContainer).hammer().off('swipeleft').on('swipeleft',function(e){router.to({typeClass:target,data:data})})};toggle.pageRight=function(target,data){$(ElScreenContainer).hammer().off('swiperight').on('swiperight',function(e){router.to({typeClass:target,data:data})})};toggle.configLeft=function(target,func,data){$(ElScreenContainer).hammer().off('swipeleft.left').on('swipeleft.left',function(e){target.hide();if(func&&typeof(func)=='function'){func.call(this,data);}});$(ElScreenContainer).hammer().off('swiperight.left').on('swiperight.left',function(e){target.show();if(func&&typeof(func)=='function'){func.call(this,data);}})};toggle.configRight=function(target,func,data){$(ElScreenContainer).hammer().off('swiperight.right').on('swiperight.right',function(e){target.hide();if(func&&typeof(func)=='function'){func.call(this,data);}});$(ElScreenContainer).hammer().off('swipeleft.right').on('swipeleft.right',function(e){target.show();if(func&&typeof(func)=='function'){func.call(this,data);}})};toggle.configBottom=function(target,func,data){$(ElScreenContainer).hammer().off('swipedown.bottom').on('swipedown.bottom',function(e){target.hide();if(func&&typeof(func)=='function'){func.call(this,data);}});$(ElScreenContainer).hammer().off('swipeup.bottom').on('swipeup.bottom',function(e){target.show();if(func&&typeof(func)=='function'){func.call(this,data);}})};toggle.carousel=function(container){container.hammer().off('swipeleft').on('swipeleft',function(e){$(e.currentTarget).carousel('next');});container.hammer().off('swiperight').on('swiperight',function(e){$(e.currentTarget).carousel('prev');});};return toggle;})();(function(){window.alert=function(str){return;}})();var router=(function(){function Router(){this.path=[];}
+function(){this.back=function(){this.path.pop();this._display();return this;};this.to=function(pathNode){this.path.push(pathNode);this._display();return this;};this.empty=function(){this.path.length=0;return this;};this._display=function(){var node=this.path[this.path.length-1];var typeClass=node.typeClass;var data=node.data;var $body=$('body');var $navTop=$('#navTop');var $navBottom=$('#navBottom');$body.removeClass('top-nav bottom-nav');$navTop.hide();$navBottom.hide();$('.btn-back','#navTop').hide();$navTop.find(':not(.btn-back)').remove();if(typeClass.navOptions){if(typeClass.navOptions.bottom){$body.addClass('bottom-nav');$navBottom.show();}
if(typeClass.navOptions.top){$body.addClass('top-nav');$navTop.append(typeClass.navOptions.top).show();}}
if(this.path.length>1&&!typeClass.navOptions.backDisable){$body.addClass('top-nav');$('.btn-back','#navTop').show();}
$('.navTool.selected').removeClass('selected');if(typeClass.navOptions&&typeClass.navOptions.module){switch(typeClass.navOptions.module){case'project':$('#btnProject').addClass('selected');break;case'message':$('#btnMessage').addClass('selected');break;case'workflow':$('#btnWorkFlow').addClass('selected');break;case'admin':$('#btnAdminConfig').addClass('selected');break;default:break;}}
$(ElScreenContainer).hammer().off('swipeleft swiperight');ScreenManager.show(node.typeClass,data);};}.call(Router.prototype);return new Router();}).call(this);var beop=window.beop||{};beop.baseMap=beop.baseMap||{};(function(window,$,nsBaseMap){var CONSTS={AMap:{name:'高德地图',url:'http://webapi.amap.com/maps',params:{key:'9cc89c68a4bd6f3f5f65589f85ad7685',v:'1.3'}},GLoader:{name:'Google Loader',url:'https://www.google.com/jsapi'},GMap:{name:'Google Map',url:'http://maps.googleapis.com/maps/api/js',params:{key:'AIzaSyAzzOzAmrGov5GLacve9w8_Q8dS-xBYCgc',sensor:'false',libraries:'geometry,places'}}};var defaults={mapContainer:'mapContainer',defaultLng:'121.6283679',defaultLat:'31.2114943',markerImgPath:'http://images.rnbtech.com.hk/static/images/map_marker_online.png'};var util={inherits:function(clazz,base){var clazzPrototype=clazz.prototype;var F=function(){};F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;},loadJS:function(url,callback){var done=false;var script=document.createElement('script');script.type='text/javascript';script.language='javascript';script.src=url;script.onload=script.onreadystatechange=function(){if(!done&&(!script.readyState||script.readyState=='loaded'||script.readyState=='complete')){done=true;script.onload=script.onreadystatechange=null;typeof callback==='function'&&callback.call(script);}}
document.getElementsByTagName("head")[0].appendChild(script);},runJS:function(url,callback){this.loadJS(url,function(){document.getElementsByTagName('head')[0].removeChild(this);typeof callback==='function'&&callback();});}};function PaneMapSearch(map,iptSch,paneSchRes){this.map=map;this.$iptSch=$(iptSch);this.$paneSchRes=$(paneSchRes);this.$liSets=[];this.rs=null;this.rsCount=0;this.showLimits=5;this.curSelect=-1;this.isPaneShow=false;this.bindEvents();this.$iptSch.parent('div').show();}
PaneMapSearch.prototype.bindEvents=function(){var _this=this;this.$iptSch.keyup(function(e){var kc=e.keyCode;switch(kc){case 38:_this.prev();e.preventDefault();break;case 40:_this.next();e.preventDefault();break;case 13:_this.doSearch();break;default:_this.autoComplete();break;}});this.$paneSchRes.on('click','a',function(e){var $this=$(this);var index=$this.attr('data-sort')||0;_this.to(index);_this.doSearch();e.preventDefault();});};PaneMapSearch.prototype.showPane=function(){this.$paneSchRes.show();this.isPaneShow=true;};PaneMapSearch.prototype.hidePane=function(){this.$paneSchRes.hide();this.isPaneShow=false;};PaneMapSearch.prototype.prev=function(){this.to(this.curSelect-1);};PaneMapSearch.prototype.next=function(){this.to(this.curSelect+1);};PaneMapSearch.prototype.to=function(index){if(!this.isPaneShow){this.showPane();return;}
index=Math.min(Math.max(0,index),this.rsCount-1);if(index===this.curSelect)return;this.curSelect=index;this.$liSets.removeClass('on');this.$liSets.eq(index).addClass('on');this.$iptSch.val(this.rs[index].name);};PaneMapSearch.prototype.doSearch=function(){var _this=this;var keywords=this.$iptSch.val().trim();var options;if(keywords==='')return;_this.hidePane();if(this.curSelect>-1){options={pageSize:1,city:this.rs[this.curSelect].adcode}}
this.map.placeSearch(keywords,options,function(rs){if(rs.status!==0)return;rs=rs.data;if(_this.curSelect<0){_this.map.setCenter(rs[0].lng,rs[0].lat);_this.map.setZoom(15);}else{_this.map.trigger('click',{lnglat:rs[0]});}});};PaneMapSearch.prototype.autoComplete=function(){var _this=this;var keywords=this.$iptSch.val().trim();keywords=keywords.replace(/[\\\?\.\+\^\$]/g,'');if(keywords==='')return;this.map.search(keywords,function(rs){if(rs.status!==0)return;rs=rs.data;var arrHtml=[];_this.rsCount=Math.min(rs.length,_this.showLimits);_this.rs=rs;_this.curSelect=-1;if(_this.rsCount<=0){_this.hidePane();return;}
for(var i=0;i<_this.rsCount;i++){arrHtml.push('<li><a data-sort="'+i+'" href="javascript:;"><span class="rs-name">'+
rs[i].name.replace(new RegExp(keywords.replace(/([\(\)])/g,'\\$1')),'<span class="keywords">'+keywords+'</span>')+'</span><span class="rs-district">'+
rs[i].district+'</span</a></li>');};_this.$paneSchRes.html(arrHtml.join(''));_this.showPane();_this.$liSets=_this.$paneSchRes.children('li');});};PaneMapSearch.prototype.destroy=function(){this.$iptSch.unbind();this.$paneSchRes.off();};var BaseMap=function(options){this.options=$.extend({},defaults,options);this.markers=[];};BaseMap.load=function(type,callback){var _this=this;var url=CONSTS[type].url;var params=CONSTS[type].params;var p=[];for(var i in params){if(params.hasOwnProperty(i)){p.push(i+'='+params[i]);}}
if(p.length)url=url+'?';util.runJS(url+p.join('&'),function(){window.console&&console.log('load JS: '+url+' success!');typeof callback&&callback.call(_this);});};var GDMap=function(options){BaseMap.call(this,options);this.markers=[];this.controls=[];this.zoom=15;this.init();};GDMap.load=function(options,callback){if(typeof options==='function'){callback=options;options=null;}
if(!GDMap.isLoaded()){BaseMap.load('AMap',function(){callback(new GDMap(options));});}else{callback(new GDMap(options));}};GDMap.isLoaded=function(){return window.AMap&&window.AMap.Map;};GDMap.prototype.init=function(){this.map=new AMap.Map(this.options.mapContainer,{resizeEnable:true,view:new AMap.View2D({zoom:this.zoom})});};GDMap.prototype.setCenter=function(lng,lat){return this.map.setCenter(this.getPoint(lng,lat));};GDMap.prototype.setZoom=function(level){return this.map.setZoom(level);};GDMap.prototype.getPoint=function(lng,lat){return new AMap.LngLat(lng,lat);};GDMap.prototype.addMarker=function(lng,lat){var marker;lng=lng||this.options.defaultLng;lat=lat||this.options.defaultLat;marker=new AMap.Marker({map:this.map,icon:this.options.markerImgPath,position:this.getPoint(lng,lat)});marker&&this.markers.push(marker);return marker;};GDMap.prototype.removeMarker=function(marker){var removed;for(var i=this.markers.length-1;i>=0;i--){if(this.markers[i]===marker){removed=this.markers.splice(i,1);removed.setMap(null);}};};GDMap.prototype.removeAllMarkers=function(){for(var i=this.markers.length-1;i>=0;i--){this.markers[i].setMap(null);}
this.markers.length=0;};GDMap.prototype.addListener=function(eventName,handler){AMap.event.addListener(this.map,eventName,handler);};GDMap.prototype.trigger=function(eventName,args){AMap.event.trigger(this.map,eventName,args);};GDMap.prototype.getAddress=function(lng,lat,callback){var _this=this;var geocoder;var format=[],statusCode=-1;AMap.service(["AMap.Geocoder"],function(){var geocoder=new AMap.Geocoder();geocoder.getAddress(_this.getPoint(lng,lat),function(status,rs){var geoinfo=rs.regeocode;if(status==='complete'&&rs.info==='OK'){format.push({name:geoinfo.formattedAddress,components:{city:geoinfo.addressComponent.city,province:geoinfo.addressComponent.province}});statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.getLocation=function(addr,callback){var _this=this;var format=[],statusCode=-1;AMap.service(["AMap.Geocoder"],function(){var geocoder=new AMap.Geocoder();geocoder.getLocation(addr,function(status,rs){var point;if(status==='complete'&&rs.info==='OK'){for(var i=0,len=rs.geocodes.length;i<len;i+=1){point=rs.geocodes[i].location;format.push({lng:point.lng,lat:point.lat});}
statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.search=function(keywords,callback){var format=[],statusCode=-1;AMap.service(['AMap.Autocomplete'],function(){var auto=new AMap.Autocomplete();if(keywords.length>0){auto.search(keywords,function(status,result){if(status==='complete'&&result.info==='OK'){for(var i=0,len=result.tips.length;i<len;i++){format.push({name:result.tips[i].name,district:result.tips[i].district,adcode:result.tips[i].adcode});};statusCode=0;typeof callback==='function'&&callback({status:statusCode,data:format});}});}});};GDMap.prototype.placeSearch=function(keywords,options,callback){var pSearch;if(typeof options==='function'){callback=options;options=null;}
AMap.service(['AMap.PlaceSearch'],function(){pSearch=new AMap.PlaceSearch(options);pSearch.search(keywords,function(status,rs){var format=[],statusCode=-1;var row;if(status==='complete'&&rs.info==='OK'){for(var i=0,len=rs.poiList.pois.length;i<len;i++){row=rs.poiList.pois[i];format.push({lng:row.location.getLng(),lat:row.location.getLat(),address:row.address});}
statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.setFitView=function(){this.map.setFitView();};GDMap.prototype.addSearchBox=function(iptSch,mapSchPane){this.controls.push(new PaneMapSearch(this,iptSch,mapSchPane));};GDMap.prototype.destroy=function(){for(var i=this.controls.length-1;i>=0;i--){if(typeof this.controls[i].destroy!=='function'){console.warn('one map UI control not destroy!');continue;}
this.controls[i].destroy();};this.map.destroy();};var GoogleMap=function(options){BaseMap.call(this,options);this.markers=[];this.controls=[];this.zoom=16;this.init();};GoogleMap.load=function(options,callback){if(typeof options==='function'){callback=options;options=null;}
if(!GoogleMap.isLoaded()){BaseMap.load('GLoader',function(){var params=CONSTS['GMap'].params;var p=[];for(var i in params){if(params.hasOwnProperty(i)){p.push(i+'='+params[i]);}}
google.load('maps',3,{other_params:p.join('&'),callback:function(){callback(new GoogleMap(options));}});});}else{callback(new GoogleMap(options));}};GoogleMap.isLoaded=function(){return window.google&&window.google.maps;};GoogleMap.prototype.init=function(){this.map=new google.maps.Map($('#'+this.options.mapContainer)[0],{zoom:this.zoom,disableDefaultUI:true,center:this.getPoint(this.options.defaultLng,this.options.defaultLat)});};GoogleMap.prototype.setCenter=function(lng,lat){return this.map.setCenter(this.getPoint(lng,lat));};GoogleMap.prototype.setZoom=function(level){return this.map.setZoom(level);};GoogleMap.prototype.getPoint=function(lng,lat){return new google.maps.LatLng(lat,lng);};GoogleMap.prototype.addMarker=function(lng,lat){var marker;lng=lng||this.options.defaultLng;lat=lat||this.options.defaultLat;marker=new google.maps.Marker({map:this.map,icon:this.options.markerImgPath,position:this.getPoint(lng,lat)});marker&&this.markers.push(marker);return marker;};GoogleMap.prototype.removeMarker=function(marker){var removed;for(var i=this.markers.length-1;i>=0;i--){if(this.markers[i]===marker){removed=this.markers.splice(i,1);removed.setMap(null);}};};GoogleMap.prototype.removeAllMarkers=function(){for(var i=this.markers.length-1;i>=0;i--){this.markers[i].setMap(null);}
this.markers.length=0;};GoogleMap.prototype.addListener=function(eventName,handler){var _this=this;return google.maps.event.addListener(this.map,eventName,function(e){_this.formatEventResult(e);handler.call(this,e);});};GoogleMap.prototype.removeAllListener=function(){google.maps.event.clearInstanceListeners(this.map);};GoogleMap.prototype.trigger=function(eventName,args){args.latLng=args.lnglat;return google.maps.event.trigger(this.map,eventName,args);};GoogleMap.prototype.formatEventResult=function(rs){rs.lnglat={lng:rs.latLng.lng(),lat:rs.latLng.lat()};};GoogleMap.prototype.getAddress=function(lng,lat,callback){var _this=this;var geocoder=new google.maps.Geocoder();var format=[],statusCode=-1;geocoder.geocode({latLng:this.getPoint(lng,lat)},function(rs,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0,len=rs.length;i<len;i++){format.push({name:rs[0].formatted_address,components:_this._formatAddressComponents(rs[i].address_components)});};statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});};GoogleMap.prototype.getLocation=function(addr,callback){var geocoder=new google.maps.Geocoder();var format=[],statusCode=-1;geocoder.geocode({address:addr},function(rs,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0,len=rs.length;i<len;i++){format.push({name:rs[i].formatted_address,lng:rs[i].geometry.location.lng(),lat:rs[i].geometry.location.lat()});};statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});};GoogleMap.prototype.search=function(keywords,callback){};GoogleMap.prototype.setFitView=function(){if(this.markers.length<=0)return;this.map.panTo(this.markers[0].getPosition());};GoogleMap.prototype.addSearchBox=function(iptSch){var _this=this;var input=document.getElementById('btnGoogleSch');var searchBox;this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);searchBox=new google.maps.places.SearchBox((input));google.maps.event.addListener(searchBox,'places_changed',function(){var places=searchBox.getPlaces();if(places.length<=0)return;_this.trigger('click',{latLng:places[0].geometry.location});});input.style.display='';};GoogleMap.prototype.destroy=function(){for(var i=this.controls.length-1;i>=0;i--){if(typeof this.controls[i].destroy!=='function'){console.warn('one map UI control does not destroy!');continue;}
this.controls[i].destroy();};this.removeAllMarkers();this.removeAllListener();};GoogleMap.prototype._formatAddressComponents=function(addressComponents,type){var format={};for(var i=addressComponents.length-1;i>=0;i--){switch(addressComponents[i].types[0]){case'administrative_area_level_1':format.province=addressComponents[i].long_name;break;case'locality':format.city=addressComponents[i].long_name;break;}}
return format;};nsBaseMap.load=function(callback){if(I18n.type.indexOf('zh')>-1){GDMap.load(callback);}else{GoogleMap.load(callback);}};}(window,jQuery,beop.baseMap,undefined));var beop;(function(beop){var configMap={AmapKey:'9cc89c68a4bd6f3f5f65589f85ad7685',AmapUrl:'http://webapi.amap.com/maps',AmapVersion:'1.3',GmapKey:'AIzaSyAzzOzAmrGov5GLacve9w8_Q8dS-xBYCgc',GmapUrl:'https://maps.googleapis.com/maps/api/js',GmapVersion:'3.0',mapContainer:'map-canvas',project_img_path:'http://images.rnbtech.com.hk/static/images/project_img/',mapLoadCallBack:'mapLoadCallBack',defaultLatlng:'31.2114943,121.6283679',projectStatus:{online:'Online',offline:'Offline'},online_img_path:'http://images.rnbtech.com.hk/static/images/map_marker_online.png',offline_img_path:'http://images.rnbtech.com.hk/static/images/map_marker_offline.png',neighbouringRadius:80000,loadMapTimeout:3000};function inherits(clazz,base){var clazzPrototype=clazz.prototype;function F(){}
F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;}
function buildSrc(url,opts){if(!url){return null}
if(!opts){return url}
var paramArr=[];for(var prop in opts){if(opts[prop]){paramArr.push(prop+'='+opts[prop]);}}
return url+'?'+paramArr.join('&');}
function getProject(id){for(var n=0,len=ProjectConfig.projectList.length;n<len;n++){var item=ProjectConfig.projectList[n];if(item.id==id){return item;}}}
function BeopMap(){this.url='';this.key='';this.container=configMap.mapContainer;this.map=null;this.zoom=5;this.markers={};this.infoWindows={};this.$projectInfo=$('#divProjectInfo');this.projectIndex=undefined;}
BeopMap.prototype.init=function(){};BeopMap.prototype.initPaneProject=function(){var _this=this;_this.initSingleProject(ProjectConfig.projectInfo);var swipeEnable=true;this.$projectInfo.off('touchstart').on('touchstart','.iconHide',function(e){$('.iconHide').css('display','none');$('.iconShow').css('display','inline-block');_this.$projectInfo.animate({opacity:0.25,bottom:'-35%'},1000,function(){});}).on('touchstart','.iconShow',function(e){$('.iconHide').css('display','inline-block');$('.iconShow').css('display','none');_this.$projectInfo.animate({opacity:1,bottom:0},1000,function(){});});this.$projectInfo.hammer().on('swipedown',function(){$('.iconHide').css('display','none');$('.iconShow').css('display','inline-block');_this.$projectInfo.animate({opacity:0.25,bottom:'-35%'},1000,function(){});});this.$projectInfo.hammer().on('swipeup',function(){$('.iconHide').css('display','inline-block');$('.iconShow').css('display','none');_this.$projectInfo.animate({opacity:1,bottom:0},1000,function(){});});this.$projectInfo.hammer().on('swipeleft',function(){var length=$('.divDetail').length;if(_this.projectIndex>=length-1||!swipeEnable)return;_this.projectIndex+=1;swipeEnable=false;_this.$projectInfo.animate({left:(-100*_this.projectIndex)+'%'},1000,function(){swipeEnable=true;});});this.$projectInfo.hammer().on('swiperight',function(){var length=$('.divDetail').length;if(_this.projectIndex<=0||!swipeEnable)return;_this.projectIndex-=1;swipeEnable=false;_this.$projectInfo.animate({left:(-100*_this.projectIndex)+'%'},1000,function(){swipeEnable=true;});});};BeopMap.prototype.loadMapScriptFailed=function(msg){console.log(this.mapName+I18n.resource.core.beopMap.LOADED_FAILED);if(msg){console.log(msg);}};BeopMap.prototype.loadScript=function(opts){if(!opts){opts={};}
$.extend(opts,{key:this.key});var src=buildSrc(this.url,opts),_this=this;$.ajax({url:src,dataType:"script",success:function(){if(_this instanceof GoogleMap){isMapAsyncLoadSuccess=true;}
if(typeof isMapAsyncLoadSuccess=='undefined'&&_this instanceof GaodeMap){isMapAsyncLoadSuccess=false;return false;}
if(isMapAsyncLoadSuccess){console.log(_this.mapName+I18n.resource.core.beopMap.LOADED_SUCCESSFUL+'.');}else{_this.loadMapScriptFailed('');}},error:function(jqXHR,errorText){_this.loadMapScriptFailed(errorText);},timeout:configMap.loadMapTimeout});};BeopMap.prototype.clickMarker=function(marker){if(!marker){return;}
this.trigger(marker,'click');};BeopMap.prototype.getInfoWindowContent=function(project){var info=[];info.push("<div style=\"padding:0px 0px 0px 4px;\"><b>"+StringUtil.getI18nProjectName(project)+"</b>");if(project.online){info.push(I18n.resource.admin.projectSelector.PROJECT_STATUS+" : "+project.online);}
if(project.lastReceivedTime){info.push(I18n.resource.admin.projectSelector.PROJECT_LAST_RECEIVED_TIME+" : "+project.lastReceivedTime);}
info.push("</div'>");return info.join('<br/>')};BeopMap.prototype.getMarkerImagePath=function(isOnline){return isOnline?configMap.online_img_path:configMap.offline_img_path;};BeopMap.prototype.expandNearbyProject=function(){if(this.$nearbyProjects.find('.media').length===0){return;}
this.$nearbyProjects.slideDown(500);};BeopMap.prototype.addMarkers=function(markerCollection){var item,marker,infoWindow,isOnline;if(!markerCollection||!markerCollection.length){return false}
var _this=this;for(var m=0;m<markerCollection.length;m++){item=markerCollection[m];isOnline=item.online&&item.online===configMap.projectStatus.online?true:false;marker=this.addMarker(item.id,item.latlng,isOnline);if(!marker){continue;}
infoWindow=this.addInfoWindow(item.id,this.getInfoWindowContent(item));_this.addMarkerClick(marker,(function(item){return function(){_this.initSingleProject(item);}})(item));}};BeopMap.prototype.renderNearbyProjects=function(projectList){var $projectsContainer=this.$nearbyProjects.find('.projects-section');$projectsContainer.empty();for(var m=0,len=projectList.length;m<len;m++){$projectsContainer.append(this.createProjectItemOfCard(projectList[m]));}};BeopMap.prototype.createProjectItemOfCard=function(project){var projectName=StringUtil.getI18nProjectName(project);var divMedia=$('<div class="media wobble-horizontal"><a class="pull-left"><img class="media-object" src="'+BEOPUtil.getProjectImgPath(project)+'" style="width: 48px; height: 48px;"></a></div>')
divMedia.attr('id',project.id+"-"+project.name_en+"-"+project.level);divMedia.attr('title',projectName);var divMediaBody=$('<div class="media-body"></div>').append($('<h4 class="media-heading"></h4>').text(projectName));divMedia.append(divMediaBody);return divMedia;};BeopMap.prototype.expandProjectPanel=function(callback){this.$projectDetailCard.slideDown("normal",callback?callback.bind(this):$.noop);};BeopMap.prototype.collapseProjectPanel=function(callback){this.$projectDetailCard.slideUp("normal",callback?callback.bind(this):$.noop);};BeopMap.prototype.addToVersionHistory=function(){var versionHistory=window.localStorage.getItem('versionHistory'),$controlBtn;if(!versionHistory){$controlBtn=this.createVersionHistory('获取最新版本失败，请重新登陆');}else{$controlBtn=this.createVersionHistory(versionHistory);}
this.addControl($controlBtn,function(){ScreenManager.show(UserManagerController,VersionHistory);})};BeopMap.prototype.createVersionHistory=function(text){var versionHistoryUI;versionHistoryUI=$('<div class="map-beop-version-history" title="beop版本历史记录"><a  id="beopVersionHistory"> beop version: '+text+' </a></div>');return versionHistoryUI;};BeopMap.prototype.loadProjectPanel=function(project){if(!project){return false;}
var name=StringUtil.getI18nProjectName(project);this.$projectDetailCard.attr('project-id',project.id).find('.project-img').attr('src',BEOPUtil.getProjectImgPath(project)).attr('alt',name).end().find('.name').text(name);if(!project.address){this.$projectDetailCard.find('.address').hide();}else{this.$projectDetailCard.find('.address').show().find('address').text(project.address);}};BeopMap.prototype.initSingleProject=function(project){var _this=this;this.projectIndex=0;this.$projectInfo.children().not(':first-child').remove();this.$projectInfo.css('left',0);var $projectName=$('.projectName');var $main=$('.mainDetail');$projectName.html(project.name_cn);$main.find('.iconSelect').remove();if(ProjectConfig.projectId==project.id){$main.append('<span class="iconSelect glyphicon glyphicon-ok-circle"></span>');}
$main.css('background-image','url(http://images.rnbtech.com.hk/static/images/project_img/'+project.pic+')');_this.openInfoWindow(_this.infoWindows[project.id],_this.markers[project.id]);var nearbyProjectList=_this.getNearbyProjects(project.id,configMap.neighbouringRadius);var strNearby;for(var i=0;i<nearbyProjectList.length;i++){strNearby=new StringBuilder();strNearby.append('<div class="divDetail nearbyDetail" project-to="'+nearbyProjectList[i].id+'"style="background-image:url(http://images.rnbtech.com.hk/static/images/project_img/'+nearbyProjectList[i].pic+'">');strNearby.append('<div class="divInfo"><span class="projectName">'+nearbyProjectList[i].name_cn+'</span>');strNearby.append('<span class="iconShow glyphicon glyphicon-chevron-up"></span>');strNearby.append('<span class="iconHide glyphicon glyphicon-remove"></span></div>');strNearby.append('</div>');this.$projectInfo.append(strNearby.toString());}
var $divDetail=$('.divDetail');this.$projectInfo.css('width',(100*(nearbyProjectList.length+1))+'%');$divDetail.css('width',(100/(nearbyProjectList.length+1))+'%');_this.openInfoWindow(_this.infoWindows[project.id],_this.markers[project.id]);nearbyProjectList=_this.getNearbyProjects(project.id,configMap.neighbouringRadius);$divDetail.hammer().off('tap').on('tap',function(e){var id=$(e.currentTarget).attr('project-to');for(var i=0;i<ProjectConfig.projectList.length;i++){if(ProjectConfig.projectList[i].id==id){_this.initSingleProject(ProjectConfig.projectList[i]);break;}}});};BeopMap.prototype.setFitView=function(){};BeopMap.prototype.getNearbyProjects=function(centerProjectId,radius){var centerProjectMarker=this.markers[centerProjectId],centerProjectLnglat=this.getMarkerPosition(centerProjectMarker),nearbyList=[];for(var projectId in this.markers){if((projectId+'')===(centerProjectId+'')){continue;}
var marker=this.markers[projectId],markLnglat=this.getMarkerPosition(marker);if(this.computeDistanceBetween(centerProjectLnglat,markLnglat)<=radius){nearbyList.push(getProject(projectId));}}
return nearbyList;};function GaodeMap(){BeopMap.call(this);this.url=configMap.AmapUrl;this.key=configMap.AmapKey;this.mapName=I18n.resource.core.beopMap.AMAP;}
GaodeMap.prototype.init=function(){BeopMap.prototype.init.call(this);if(this.map){this.map.destroy&&this.map.destroy();}
this.map=new AMap.Map(this.container,{view:new AMap.View2D({zoom:this.zoom})});};GaodeMap.prototype.getLatLng=function(lat,lng){return new AMap.LngLat(lng,lat);};GaodeMap.prototype.isMapLoaded=function(){try{if(AMap&&AMap.Map){return true;}}catch(e){return false;}};GaodeMap.prototype.addControl=function($controlUI,callback){var _this=this;var controlDiv=function(){};controlDiv.prototype={addTo:function(map,dom){dom.appendChild(this._getHtmlDom(map));},_getHtmlDom:function(map){this.map=map;$controlUI.click(function(){callback.call(_this);});this.container=$controlUI[0];return $controlUI[0];}};this.map.addControl(new controlDiv(this.map));};GaodeMap.prototype.load=function(){if(this.isMapLoaded()){mapLoadCallBack();}else{this.loadScript({v:configMap.AmapVersion,callback:configMap.mapLoadCallBack});}};GaodeMap.prototype.trigger=function(instance,eventName,var_args){AMap.event.trigger(instance,eventName,var_args)};GaodeMap.prototype.openInfoWindow=function(infoWindow,marker){infoWindow.open(this.map,marker.getPosition());};GaodeMap.prototype.addMarker=function(identifier,lnglat,isOnline,opts){if(!identifier||!lnglat){return null;}
if(!lnglat){lnglat=configMap.defaultLatlng;}
if(typeof lnglat==='string'){var temp=lnglat.split(',');lnglat={'lat':+temp[0],'lng':+temp[1]};}
var defaultOpts={map:this.map,position:this.getLatLng(lnglat.lat,lnglat.lng),offset:new AMap.Pixel(-8,-8),content:'<div class="map-marker" data-id="'+identifier+'"></div>',extData:{id:identifier}};if(opts){$.extend(defaultOpts,opts);}
var marker=new AMap.Marker(defaultOpts);this.markers[identifier]=marker;return marker;};GaodeMap.prototype.removeMarker=function(identifier){if(!identifier){return false}
var marker=this.markers[identifier];if(!marker){return false;}
marker.setMap(null);return true;};GaodeMap.prototype.addInfoWindow=function(id,content){var infoWindow=new AMap.InfoWindow({offset:new AMap.Pixel(0,0),content:content});this.infoWindows[id]=infoWindow;return infoWindow;};GaodeMap.prototype.addMarkerClick=function(marker,eventFunc){var _this=this;AMap.event.addListener(marker,'click',function(){eventFunc.call(_this);});};GaodeMap.prototype.setFitView=function(){this.map.setFitView();};GaodeMap.prototype.computeDistanceBetween=function(from,to){if(!from||!to){return}
return from.distance(to);};GaodeMap.prototype.getMarkerPosition=function(marker){if(!marker){return}
return marker.getPosition();};GaodeMap.prototype.closeAllInfoWindow=function(){};inherits(GaodeMap,BeopMap);function GoogleMap(){BeopMap.call(this);this.url=configMap.GmapUrl;this.key=configMap.GmapKey;this.zoom=4;this.mapName='google'+I18n.resource.core.beopMap.MAP;}
GoogleMap.prototype.init=function(){BeopMap.prototype.init.call(this);this.map=new google.maps.Map($('#'+this.container)[0],{zoom:this.zoom,disableDefaultUI:true});GMarker=function(latlng,map,args){this.latlng=latlng;this.args=args;this.setMap(map);}
GMarker.prototype=new google.maps.OverlayView();GMarker.prototype.draw=function(){var self=this;var div=this.div;if(!div){div=this.div=document.createElement('div');div.className='map-marker';div.style.position='absolute';if(typeof(self.args.id)!=='undefined'){div.dataset.id=self.args.id;}
google.maps.event.addDomListener(div,"click",function(event){google.maps.event.trigger(self,"click");});var panes=this.getPanes();panes.overlayImage.appendChild(div);}
var point=this.getProjection().fromLatLngToDivPixel(this.latlng);if(point){div.style.left=(point.x-8)+'px';div.style.top=(point.y-8)+'px';}};GMarker.prototype.onRemove=function(){if(this.div){this.div.parentNode.removeChild(this.div);this.div=null;}};GMarker.prototype.getPosition=function(){return this.latlng;};GMarker.prototype.getExtData=function(){return this.args;};GMarker.prototype.show=function(){this.div.style.display='';};GMarker.prototype.hide=function(){this.div.style.display='none';};};GoogleMap.prototype.isMapLoaded=function(){try{if(google&&google.maps){return true;}}catch(e){return false;}};GoogleMap.prototype.load=function(){if(this.isMapLoaded()){mapLoadCallBack();}else{this.loadScript({callback:configMap.mapLoadCallBack,sensor:false,libraries:'geometry,places',language:'en'});}};GoogleMap.prototype.getLatLng=function(lat,lng){return new google.maps.LatLng(lat,lng);};GoogleMap.prototype.openInfoWindow=function(infoWindow,marker){infoWindow.open(this.map,marker);};GoogleMap.prototype.addMarker=function(identifier,lnglat,isOnline,opts){if(!identifier||!lnglat){return null;}
if(typeof lnglat==='string'){var temp=lnglat.split(',');lnglat={'lat':+temp[0],'lng':+temp[1]};}
if(opts){$.extend(defaultOpts,opts);}
var marker=new GMarker(this.getLatLng(lnglat.lat,lnglat.lng),this.map,{id:identifier});this.markers[identifier]=marker;return marker;};GoogleMap.prototype.addInfoWindow=function(id,content){var infoWindow=new google.maps.InfoWindow({content:content,pixelOffset:new google.maps.Size(0,0)});this.infoWindows[id]=infoWindow;return infoWindow;};GoogleMap.prototype.addControl=function($controlUI,callback){var _this=this,controlUIDom=$controlUI[0];this.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlUIDom);google.maps.event.addDomListener(controlUIDom,'click',function(){callback.call(_this);});};GoogleMap.prototype.closeAllInfoWindow=function(){for(var m=0,len=this.infoWindows.length;m<len;m++){this.infoWindows[m].close();}};GoogleMap.prototype.addMarkerClick=function(marker,eventFunc){var _this=this;google.maps.event.addListener(marker,'click',function(){_this.closeAllInfoWindow();eventFunc.call(_this);});};GoogleMap.prototype.setFitView=function(){var bounds=new google.maps.LatLngBounds();for(var project in this.markers){bounds.extend(this.markers[project].getPosition());}
this.map.fitBounds(bounds);};GoogleMap.prototype.computeDistanceBetween=function(from,to){if(!from||!to){return}
return google.maps.geometry.spherical.computeDistanceBetween(from,to);};GoogleMap.prototype.getMarkerPosition=function(marker){if(!marker){return}
return marker.getPosition();};GoogleMap.prototype.trigger=function(instance,eventName,var_args){google.maps.event.trigger(instance,eventName,var_args);};inherits(GoogleMap,BeopMap);var GMarker=null;beop.getMapInstance=function(){if(typeof AppConfig.isGoogleServiceAvailable==='boolean'){return AppConfig.isGoogleServiceAvailable?new GoogleMap():new GaodeMap();}else{if(I18n.type==='zh'){return new GaodeMap();}else{return new GoogleMap();}}};beop.GaodeMap=GaodeMap;beop.GoogleMap=GoogleMap;})(beop||(beop={}));var isMapAsyncLoadSuccess=undefined;function mapLoadCallBack(){var mapIns=beop.getMapInstance();mapIns.init();mapIns.addToVersionHistory();mapIns.addMarkers(ProjectConfig.projectList);mapIns.initPaneProject();mapIns.setFitView();isMapAsyncLoadSuccess=true;mapIns.customCtrls=mapIns.customCtrls||{};}
var ProjectSummary=(function(){var _this;function ProjectSummary(data){_this=this;if(data&&data.id){ProjectConfig.projectId=data.id;for(var i=0;i<ProjectConfig.projectList.length;i++){if(ProjectConfig.projectList[i].id==data.id){ProjectConfig.projectInfo=ProjectConfig.projectList[i];ProjectConfig.projectIndex=i;break;}}}
if(data&&data.index){ProjectConfig.projectId=ProjectConfig.projectList[data.index].id;ProjectConfig.projectInfo=ProjectConfig.projectList[data.index];ProjectConfig.projectIndex=data.index;}}
ProjectSummary.navOptions={top:'<div id="btnProjectMap" class="glyphicon glyphicon-map-marker topNavLeft" aria-hidden="true"></div>'+'<div id="projectName" class="topNavTitle"></div>',bottom:true,backDisable:true,module:'project'};ProjectSummary.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/project/projectSummary.html'}).done(function(resultHtml){ElScreenContainer.innerHTML=resultHtml;$('.navTool .selected').removeClass('selected');$('#btnProject').addClass('selected');$('#projectName').html(ProjectConfig.projectInfo.name_cn);_this.init();localStorage.setItem('defaultProjectId',ProjectConfig.projectId);localStorage.setItem('module','project');})},init:function(){Spinner.spin(ElScreenContainer);WebAPI.get('/report/getReportMenu/'+ProjectConfig.projectId).done(function(result){if(result.success&&result.data.length>0){ProjectConfig.reportList=result.data;_this.initReportShow();_this.initDashboardShow();}else{}}).always(function(){Spinner.stop();});_this.initProjectSelect();_this.initTopNav();},initDashboardShow:function(){var $divEChart=$('.slideChart');var container=$('#containerEChartsSlide .carousel-inner');var timeShaft=['0:00','1:00','2:00','3:00','4:00','5:00','6:00','7:00','8:00','9:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00'];var arrSeries=[{name:'KPI运行指标',type:'line',itemStyle:{normal:{labelLine:{show:true},label:{show:true}},emphasis:{label:{show:true,position:'inner',formatter:"{d}%"}}},data:[1000,1200,1400,1600,1300,1400,1450,1600,1000,1200,1100,1600,1300,800]}];var option={color:['#86b379'],title:{text:'KPI汇总',x:'left',y:-5,textStyle:{fontSize:18,fontWeight:500,fontFamily:'Microsoft YaHei',color:'#333'}},tooltip:{show:true},grid:{x:20,y:20,x2:20,y2:20},xAxis:[{type:'category',boundaryGap:false,data:timeShaft}],yAxis:[{type:'value'}],series:arrSeries};$divEChart.eq(0).css({height:container.height()*0.85+'px',width:container.width()*0.9+'px',top:container.height()*0.05+'px',left:container.width()*0.05+'px'});var myChart=echarts.init($divEChart[0]);myChart.setOption(option);option={color:['#a9cba2','#a0ccf1','#f7d596'],title:{text:'制冷负荷',x:'left',y:-5,textStyle:{fontSize:18,fontWeight:500,fontFamily:'Microsoft YaHei',color:'#333'}},tooltip:{show:true,formatter:"{b} : ({d}%)"},series:[{name:'制冷负荷',type:'pie',radius:'80%',center:['50%','50%'],itemStyle:{normal:{areaStyle:{color:'green'},labelLine:{show:true},label:{show:true}},emphasis:{label:{show:true,position:'inner',formatter:"{d}%"}}},data:[{value:670,name:'释冰负荷'},{value:1575,name:'机载主机制冷负荷'},{value:270,name:'双工况主机制冷负荷'}]}]};$divEChart.eq(1).css({height:container.height()*0.85+'px',width:container.width()*0.9+'px',top:container.height()*0.05+'px',left:container.width()*0.05+'px'});myChart=echarts.init($divEChart[1]);myChart.setOption(option);option={title:{text:'平均月温度同比',x:'left',y:-5,textStyle:{fontSize:18,fontWeight:500,fontFamily:'Microsoft YaHei',color:'#333'}},tooltip:{trigger:'axis'},grid:{x:20,y:20,x2:20,y2:20},legend:{show:false,data:['2014年月平均温度','2015年月平均温度']},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月']}],yAxis:[{type:'value'}],series:[{name:'2014年月平均温度',type:'bar',data:[2.0,4.9,7.0,23.2,25.6,76.7,135.6,162.2,32.6,20.0,6.4,3.3],markLine:{data:[{type:'average',name:'平均值'}]}},{name:'2015年月平均温度',type:'bar',data:[2.6,5.9,9.0,26.4,28.7,70.7,175.6,182.2,48.7,18.8,6.0,2.3],markLine:{data:[{type:'average',name:'平均值'}]}}]};$divEChart.eq(2).css({height:container.height()*0.85+'px',width:container.width()*0.9+'px',top:container.height()*0.05+'px',left:container.width()*0.05+'px'});myChart=echarts.init($divEChart[2]);myChart.setOption(option);toggle.carousel($('#containerEChartsSlide'));},initReportShow:function(){var $reportContainer=$('#divProjectSummary');var postData,reportType,num=0;var strPanelReport;ProjectConfig.reportList.forEach(function(val,i){postData={chapter:val.structure?val.structure.data[0].name:'',menuId:val._id,projectId:ProjectConfig.projectId,unit:''};strPanelReport=new StringBuilder();reportType=val.reportFolder;strPanelReport.append('<div class="panel panel-primary panel'+reportType+'">');strPanelReport.append('    <div class="panel-heading" role="tab" id="reportTitle_'+i+'"> ');strPanelReport.append('        <h4 class="panel-title">');strPanelReport.append('            <a class="aCollapse collapsed" role="button" data-toggle="collapse" data-parent="#divProjectSummary" href="#divReport_'+i+'" aria-expanded="false" aria-controls="divReport_'+i+'">');strPanelReport.append('                <span class="reportType">'+val.text+'</span>');strPanelReport.append('                <span class="collapseArrow glyphicon glyphicon-chevron-up" aria-hidden="true"></span>');strPanelReport.append('                <span class="collapseArrow glyphicon glyphicon-chevron-down" aria-hidden="true"></span>');strPanelReport.append('            </a>');strPanelReport.append('        </h4>');strPanelReport.append('    </div>');strPanelReport.append('    <div id="divReport_'+i+'" class="panel-collapse collapse div'+reportType+'" role="tabpanel" aria-labelledby="reportTitle_'+i+'">');strPanelReport.append('        <div class="panel-body" id="'+val._id+'">');strPanelReport.append('        </div>');strPanelReport.append('        <div class="btnDetail" report-to="'+val._id+'">更多详情');strPanelReport.append('        </div>');strPanelReport.append('    </div>');strPanelReport.append('</div>');$reportContainer.append(strPanelReport.toString());Spinner.spin(ElScreenContainer);WebAPI.post('/report/getReportHtml/',postData).done(function(result){if(result.success){document.getElementById(val._id).innerHTML=result.data;}else{alert(result.msg);}
if(num==ProjectConfig.reportList.length-1){var $reportUnit=$('#beopReport .report-unit');$reportUnit.find('.canvas-container').css({height:'300px',width:($(ElScreenContainer).width()-60)+'px'});_this.reportScreen=new ReportScreen();_this.reportScreen.renderCharts($reportUnit);_this.initReportDetail();}
num+=1;}).always(function(){Spinner.stop();});})},initReportDetail:function(){var btnReportDetail=$('.panel-collapse .btnDetail');btnReportDetail.hammer().off('tap').on('tap',function(e){e.preventDefault();e.stopPropagation();for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i]._id==$(e.currentTarget).attr('report-to')){ProjectConfig.reportIndex=i;ProjectConfig.reportDetail=ProjectConfig.reportList[i];router.to({typeClass:ProjectReport});break;}}})},initProjectSelect:function(){},initTopNav:function(){$('#btnProjectMap').hammer().off('tap').on('tap',function(){router.to({typeClass:ProjectMap,data:{}})})},close:function(){}};return ProjectSummary;})();var ProjectReport=(function(){var _this;function ProjectReport(data){_this=this;if(data&&data.projectId){ProjectConfig.projectId=data.projectId}}
ProjectReport.navOptions={top:'<div id="reportSelect" class="topNavTitle dropdown"></div>'+'<div id="btnWeChat" class="topNavRight glyphicon glyphicon-share-alt"></div>',bottom:false,backDisable:false,module:'project'};ProjectReport.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/project/projectReport.html'}).done(function(resultHTML){var $reportSelect=$('#reportSelect');var strReportSelect=new StringBuilder();strReportSelect.append('<button class="btn btn-default dropdown-toggle" type="button" id="ulReportSelect" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">');strReportSelect.append('  <span>'+ProjectConfig.reportDetail.text+'</span>');strReportSelect.append('  <span class="caret"></span>');strReportSelect.append('</button>');strReportSelect.append('<ul class="dropdown-menu" aria-labelledby="ulReportSelect">');for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i]._id==ProjectConfig.reportDetail._id)continue;strReportSelect.append('  <li report-to="'+ProjectConfig.reportList[i]._id+'">'+ProjectConfig.reportList[i].text+'</li>');}
strReportSelect.append('</ul>');$reportSelect.html(strReportSelect.toString());$reportSelect.find('li').hammer().off('tap').on('tap',function(e){var id=$(e.currentTarget).attr('report-to');for(var i=0;i<ProjectConfig.reportList.length;i++){if(ProjectConfig.reportList[i]._id==id){ProjectConfig.reportDetail=ProjectConfig.reportList[i];break;}}
router.to({typeClass:ProjectReport})});$(ElScreenContainer).html(resultHTML);_this.init();})},init:function(){var $container=$('#containerReport');var postData={projectId:ProjectConfig.projectId,menuId:ProjectConfig.reportDetail._id,chapter:'',unit:''};Spinner.spin(ElScreenContainer);WebAPI.post('/report/getReportHtml/',postData).done(function(result){$container.html(result.data);var $reportUnit=$('#beopReport .report-unit');$reportUnit.find('.canvas-container').css({height:'300px',width:($(ElScreenContainer).width()-30)+'px'});_this.reportScreen=new ReportScreen();_this.reportScreen.renderCharts($reportUnit);}).always(function(){Spinner.stop();});_this.initReportSelect();},initReportSelect:function(){if(ProjectConfig.reportDetail.structure){var date=ProjectConfig.reportDetail.structure.updateTime;$('#reportYear').html(new Date(date).getFullYear()+'年');$('#reportMonth').html(new Date(date).getMonth()+'<small>月</small>');}},close:function(){}};return ProjectReport;})();var ProjectList=(function(){var _this;function ProjectList(){_this=this;}
ProjectList.navOptions={top:'<span id="btnProjectList" class="topNavRight glyphicon glyphicon-share"></span>',bottom:true,backDisable:false,module:'project'};ProjectList.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/project/projectList.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);$('.navTool .selected').removeClass('selected');$('#btnProject').addClass('selected');_this.init();_this.initProjectDisplay();});},init:function(){var $ulProjectList=$('#ulProjectList');var strLiProject=new StringBuilder();for(var i=0;i<ProjectConfig.projectList.length;++i){strLiProject=new StringBuilder();strLiProject.append('<div class="liProject" id="proj_'+ProjectConfig.projectList[i].id+'">');strLiProject.append('   <div class="projectIcon"><img src="http://images.rnbtech.com.hk/static/images/project_img/'+ProjectConfig.projectList[i].pic+'"></div>');if(ProjectConfig.projectList[i].id==ProjectConfig.projectId){strLiProject.append('   <div class="iconSelect"><span class="glyphicon glyphicon-ok-circle"></span></div>');}
strLiProject.append('   <div class="projectName">'+ProjectConfig.projectList[i].name_cn+'</div>');strLiProject.append('   <div class="projectInfo">'+ProjectConfig.projectList[i].address+'</div>');strLiProject.append('</div>');$ulProjectList.append(strLiProject.toString());}},initProjectDisplay:function(){$('.liProject').hammer().off('tap').on('tap',function(e){ProjectConfig.projectId=$(e.currentTarget).attr('id').match(/\d+/)[0];for(var i=0;i<ProjectConfig.projectList.length;i++){if(ProjectConfig.projectId==ProjectConfig.projectList[i].id){ProjectConfig.projectInfo=ProjectConfig.projectList[i];ProjectConfig.projectIndex=i;}}
router.to({typeClass:ProjectSummary})})},close:function(){}};return ProjectList;})();var ProjectMap=(function(){var _this;function ProjectMap(){_this=this;}
ProjectMap.navOptions={top:'<div class="topNavInput" ><input id="projectSearch" type="text"></div>'+'<div id="btnProjectList" class="topNavRight glyphicon glyphicon-list"></div>',bottom:true,backDisable:false,module:'project'};ProjectMap.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/project/projectMap.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);var map=new beop.getMapInstance();map.load();_this.init()})},init:function(){_this.initTopNav();},initTopNav:function(){$('#btnProjectList').off('touchstart').on('touchstart',function(e){router.to({typeClass:ProjectList,data:{}})});},close:function(){}};return ProjectMap;})();var MessageIndex=(function(){var _this=this;function MessageIndex(){_this=this;}
MessageIndex.navOptions={top:'<div class="topNavTitle">消息中心</div>',bottom:true,backDisable:true,module:'message'};MessageIndex.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/message/messageIndex.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.init();localStorage.setItem('module','message');});},init:function(){_this.initWorkflow();_this.initReport();_this.initSchedule();_this.initAffairs();},initWorkflow:function(){},initReport:function(){},initSchedule:function(){},initAffairs:function(){},close:function(){}};return MessageIndex;})();var MessageWorkflow=(function(){function MessageWorkflow(){}
return MessageWorkflow;})();var WorkflowList=(function(){var _this=this;function WorkflowList(){_this=this;_this.wkType='working';_this.tempWkList=WkConfig.wkList.working;_this.tempWkContainer=undefined;_this.sortType=true;}
WorkflowList.navOptions={top:'<div class="topNavTitle">工单列表</div>'+'<div id="btnWorkFlowAdd" class="topNavRight"><span class="glyphicon glyphicon-plus"></span></div>',bottom:true,backDisable:true,module:'workflow'};WorkflowList.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/workflow/workflowList.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);$('.navTool .selected').removeClass('selected');$('#btnWorkFlow').addClass('selected');localStorage.setItem('module','workflow');_this.init();});},init:function(){_this.initWkTypeSelect();if(!WkConfig.refreshTime||new Date()-WkConfig.refreshTime>WkConfig.refreshInterval){_this.initWorkingWorkflow();_this.initCreatedWorkflow();_this.initFinishedWorkflow();_this.initJoinedWorkflow();WkConfig.refreshTime=new Date();}else{_this.initWorkflowList(WkConfig.wkList.working,$('#divWorking'),'working',true);_this.initWorkflowList(WkConfig.wkList.created,$('#divCreated'),'created',true);_this.initWorkflowList(WkConfig.wkList.finished,$('#divFinished'),'finished',true);_this.initWorkflowList(WkConfig.wkList.joined,$('#divJoined'),'joined',true);}
_this.initAddWk();_this.initSort();},initWorkingWorkflow:function(){Spinner.spin(ElScreenContainer);WebAPI.post('/workflow/transaction/working/'+AppConfig.userId+'/1/'+WkConfig.defaultSize).done(function(resultData){Spinner.stop();_this.initWorkflowList(resultData.data.records,$('#divWorking'),'working');});},initCreatedWorkflow:function(){WebAPI.post('/workflow/transaction/created_by/'+AppConfig.userId+'/1/'+WkConfig.defaultSize).done(function(resultData){_this.initWorkflowList(resultData.data.records,$('#divCreated'),'created');})},initFinishedWorkflow:function(){WebAPI.post('/workflow/transaction/finished_by/'+AppConfig.userId+'/1/'+WkConfig.defaultSize).done(function(resultData){_this.initWorkflowList(resultData.data.records,$('#divFinished'),'finished');})},initJoinedWorkflow:function(){WebAPI.post('/workflow/transaction/joined_by/'+AppConfig.userId+'/1/'+WkConfig.defaultSize).done(function(resultData){_this.initWorkflowList(resultData.data.records,$('#divJoined'),'joined');})},initWorkflowList:function(resultData,container,type,isExist){var record=resultData;var $container=container;var strWorkFlow;var tempWkList,tempContainer;switch(type){case'working':tempWkList=WkConfig.wkList.working;tempContainer=$('#divWorking');break;case'created':tempWkList=WkConfig.wkList.created;tempContainer=$('#divCreated');break;case'finished':tempWkList=WkConfig.wkList.finished;tempContainer=$('#divFinished');break;case'joined':tempWkList=WkConfig.wkList.joined;tempContainer=$('#divJoined');break;}
if(isExist){for(var i=0;i<record.length;i++){strWorkFlow=new StringBuilder();strWorkFlow.append('<div class="liWkRecord" id="'+record[i].id+'">');strWorkFlow.append('<div class="wkEmergency wkEmergency_'+record[i].critical+'"></div>');strWorkFlow.append('<div class="wkTitle">'+record[i].title+'</div>');strWorkFlow.append('<div class="wkInfo">'+record[i].detail+'</div>');strWorkFlow.append('<div class="wkUser">'+record[i].executorName+'</div>');strWorkFlow.append('<div class="wkDate">'+record[i].createTime.toDate().format('yyyy-MM-dd')+'</div>');strWorkFlow.append('<div class="wkGetStatus get_'+record[i].status+'"></div>');strWorkFlow.append('</div>');$container.append(strWorkFlow.toString());}}else{for(var i=0;i<record.length;i++){record[i].status=false;strWorkFlow=new StringBuilder();strWorkFlow.append('<div class="liWkRecord" id="'+record[i].id+'">');strWorkFlow.append('<div class="wkEmergency wkEmergency_'+record[i].critical+'"></div>');strWorkFlow.append('<div class="wkTitle">'+record[i].title+'</div>');strWorkFlow.append('<div class="wkInfo">'+record[i].detail+'</div>');strWorkFlow.append('<div class="wkUser">'+record[i].executorName+'</div>');strWorkFlow.append('<div class="wkDate">'+record[i].createTime.toDate().format('yyyy-MM-dd')+'</div>');strWorkFlow.append('<div class="wkGetStatus get_'+record[i].status+'"></div>');strWorkFlow.append('</div>');$container.append(strWorkFlow.toString());tempWkList.push(record[i]);}}
_this.initWkDetail(tempContainer);},initWkTypeSelect:function(){_this.tempWkContainer=$('#divWorking');$('.divWkList').hide();_this.tempWkContainer.show();_this.sortType=true;$('.btnWkSelect').hammer().off('tap').on('tap',function(e){$('.btnWkSelect').removeClass('selected');$(e.currentTarget).addClass('selected');var $spanWkType=$('#wkType');switch($(e.currentTarget).attr('id')){case'btnWorking':_this.wkType='working';_this.tempWkList=WkConfig.wkList.working;_this.tempWkContainer=$('#divWorking');$spanWkType.html('进行中');break;case'btnCreated':_this.wkType='created';_this.tempWkList=WkConfig.wkList.created;_this.tempWkContainer=$('#divCreated');$spanWkType.html('我创建');break;case'btnFinished':_this.wkType='finished';_this.tempWkList=WkConfig.wkList.finished;_this.tempWkContainer=$('#divFinished');$spanWkType.html('我完成');break;case'btnJoined':_this.wkType='joined';_this.tempWkList=WkConfig.wkList.joined;_this.tempWkContainer=$('#divJoined');$spanWkType.html('我参与');break;default:break;}
$('.divWkList').hide();_this.tempWkContainer.show();});},initWkDetail:function(container){container.find('.liWkRecord').hammer().off('tap').on('tap',function(e){var wkId,wkDetail;wkId=$(e.currentTarget).attr('id');for(var i=0;i<_this.tempWkList.length;i++){if(_this.tempWkList[i].id==wkId){wkDetail=_this.tempWkList[i];_this.tempWkList[i].status=true;break;}}
router.to({typeClass:WorkflowDetail,data:{id:wkId,detail:wkDetail}})});},initAddWk:function(){$('#btnWorkFlowAdd').hammer().off('tap').on('tap',function(){router.to({typeClass:WorkflowAdd})});},initSort:function(){$('#idSort').hammer().off('tap').on('tap',function(){sort('id');});$('#createTimeSort').hammer().off('tap').on('tap',function(){sort('createTime','date');});$('#deadlineSort').hammer().off('tap').on('tap',function(){sort('dueDate','date');});$('#emergencySort').hammer().off('tap').on('tap',function(){sort('cirtical');});$('#executorSort').hammer().off('tap').on('tap',function(){sort('executorId')});$('#teamSort').hammer().off('tap').on('tap',function(){sort('groupId')});$('#collectSort').hammer().off('tap').on('tap',function(){sort('star');});function sort(data,type){_this.tempWkContainer.html('');var newWkList=_this.tempWkList;var low=0,high=newWkList.length-1;var temp;if(type=='date'){if(_this.sortType){while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data].toDate()>newWkList[i+1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data].toDate()<newWkList[i-1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}else{while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data].toDate()<newWkList[i+1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data].toDate()>newWkList[i-1][data].toDate()){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}}else{if(_this.sortType){while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data]>newWkList[i+1][data]){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data]<newWkList[i-1][data]){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}else{while(low<high){for(var i=low;i<high;++i){if(newWkList[i][data]<newWkList[i+1][data]){temp=newWkList[i];newWkList[i]=newWkList[i+1];newWkList[i+1]=temp}}
--high;for(var i=high;i>low;--i){if(newWkList[i][data]>newWkList[i-1][data]){temp=newWkList[i];newWkList[i]=newWkList[i-1];newWkList[i-1]=temp}}
++low;}}}
var strWorkFlow;for(var i=0;i<newWkList.length;i++){strWorkFlow=new StringBuilder();strWorkFlow.append('<div class="liWkRecord" id="'+newWkList[i].id+'">');strWorkFlow.append('<div class="wkEmergency wkEmergency_'+newWkList[i].critical+'"></div>');strWorkFlow.append('<div class="wkTitle">'+newWkList[i].title+'</div>');strWorkFlow.append('<div class="wkInfo">'+newWkList[i].detail+'</div>');strWorkFlow.append('<div class="wkUser">'+newWkList[i].executorName+'</div>');strWorkFlow.append('<div class="wkDate">'+newWkList[i].createTime.toDate().format('yyyy-MM-dd')+'</div>');strWorkFlow.append('<div class="wkGetStatus get_'+newWkList[i].status+'"></div>');strWorkFlow.append('</div>');_this.tempWkContainer.append(strWorkFlow.toString());}
_this.sortType=!_this.sortType;_this.initWkDetail(_this.tempWkContainer);}},close:function(){}};return WorkflowList;})();var WorkflowAdd=(function(){var _this;function WorkflowAdd(){_this=this;}
WorkflowAdd.navOptions={top:'<div class="topNavTitle">新建工单</div>',bottom:false,backDisable:false,module:'workflow'};WorkflowAdd.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/workflow/workflowAdd.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.init();});},init:function(){_this.initUploadImg();_this.initTransactor();_this.initTeam();},initUploadImg:function(){var $inputWkImg=$('#inputWkImg');$('#spanWkImg').hammer().off('tap').on('tap',function(e){e.stopPropagation();$inputWkImg.trigger('click');});var file,fileType,reader,strDivWkImg;fileType=/image*/;$inputWkImg.off('change').on('change',function(e){file=e.currentTarget.files[0];if(!file.type.match(fileType)){return;}
reader=new FileReader();reader.readAsDataURL(file);reader.onload=function(e){strDivWkImg=new StringBuilder();strDivWkImg.append('<div class="divWkImg">');strDivWkImg.append('    <img class="imgWkImg" src=" + e.target.result + ">');strDivWkImg.append('    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>');strDivWkImg.append('</div>')};});$('wkImg').off('touchstart').on('touchstart','.imgWkImg',function(){$(e.currentTarget).parent().remove();});},initTransactor:function(){},initTeam:function(){},close:function(){}};return WorkflowAdd;})();var WorkflowDetail=(function(){var _this=this;function WorkflowDetail(data){_this=this;if(data&&data.id){WkConfig.wkId=data.id;if(data.detail){WkConfig.wkDetail=data.detail;}}}
WorkflowDetail.navOptions={top:'<div class="topNavTitle">工单详情</div>',bottom:false,backDisable:false,module:'workflow'};WorkflowDetail.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/workflow/workflowDetail.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.init();});},init:function(){_this.initData();_this.initComment();_this.initProgress();_this.initAdditionToggle();},initData:function(){$('#wkId .partContent').html(WkConfig.wkDetail.id);switch(WkConfig.wkDetail.critical){case 0:$('#wkEmergency').html('一般').css('background-color','green');break;case 1:$('#wkEmergency').html('严重').css('background-color','organge');break;case 2:$('#wkEmergency').html('紧急').css('background-color','red');break;}
$('#wkCreateDate .partContent').html(WkConfig.wkDetail.createTime.toDate().format('yyyy-MM-dd'));$('#wkExecutor .partContent').html(WkConfig.wkDetail.executorName);$('#detailTitle').html(WkConfig.wkDetail.title);$('#detailContent').html(WkConfig.wkDetail.detail);$('#wkDeadline .partContent').html(WkConfig.wkDetail.dueDate.toDate().format('yyyy-MM-dd'))},initComment:function(){var $container=$('#wkComment');var strReply;WebAPI.get('/workflow/transaction/get_reply/'+WkConfig.wkId).done(function(result){var replyList=result.data;for(var i=0;i<replyList.length;i++){strReply=new StringBuilder();strReply.append('<div class="divReply">');strReply.append('   <div class="replyPic"><img src="'+replyList[i].userpic+'"></div>');strReply.append('   <div class="replyUser">'+replyList[i].userfullname+'</div>');strReply.append('   <div class="replyTime">'+replyList[i].replyTime+'</div>');strReply.append('   <div class="replyDetail">'+replyList[i].detail+'</div>');strReply.append('</div>');$container.append(strReply.toString());}});},initProgress:function(){var $container=$('#wkProgress');var strProgress,status;WebAPI.get('/workflow/transaction/get_progress/'+WkConfig.wkId).done(function(result){var progressList=result.data;for(var i=0;i<progressList.length;i++){strProgress=new StringBuilder();switch(progressList[i].op){case'complete':status='完成了任务';break;case'edit':status='编辑了任务';break;case'new':status='创建了任务';break;}
strProgress.append('<div class="divProgress">');strProgress.append('   <div class="progressPic"><img src="'+progressList[i].userpic+'"></div>');strProgress.append('   <div class="progressTime">'+progressList[i].opTime.toDate().format('yy:MM:dd')+'</div>');strProgress.append('   <div class="progressUser">'+progressList[i].userfullname+'</div>');strProgress.append('   <div class="progressStatus">'+status+'</div>');strProgress.append('</div>');$container.append(strProgress.toString());}});},initAdditionToggle:function(){$('#wkProgress').hide();$('#wkComment').show();$('#btnComment').hammer().off('tap').on('tap',function(e){if($(e.currentTarget).hasClass('selected')){return;}else{$('#wkAddition .partTitle').removeClass('selected');$(e.currentTarget).addClass('selected');$('#wkProgress').hide();$('#wkComment').show();}});$('#btnProgress').hammer().off('tap').on('tap',function(e){if($(e.currentTarget).hasClass('selected')){return;}else{$('#wkAddition .partTitle').removeClass('selected');$(e.currentTarget).addClass('selected');$('#wkProgress').show();$('#wkComment').hide();}})},close:function(){}};return WorkflowDetail;})();var AdminConfig=(function(){var _this;function AdminConfig(){_this=this;}
AdminConfig.navOptions={top:'<div class="topNavTitle">消息中心</div>',bottom:true,backDisable:true,module:'admin'};AdminConfig.prototype={show:function(){$.ajax({url:'static/app/dashboard/views/admin/adminConfig.html'}).done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.init();_this.initLogout();});},init:function(){_this.initToggle();},initToggle:function(){$('.btnToggle').hammer().off('tap').on('tap',function(e){if($(e.currentTarget).hasClass('btnOn')){$(e.currentTarget).removeClass('btnOn');}else{$(e.currentTarget).addClass('btnOn');}});},initLogout:function(){localStorage.clear('userInfo');router.empty.to({typeClass:IndexScreen})},close:function(){}};return AdminConfig;})();