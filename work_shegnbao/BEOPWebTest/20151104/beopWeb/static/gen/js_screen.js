var Stopwatch=(function(){Stopwatch=function(){};Stopwatch.prototype={startTime:0,running:false,elapsedTime:0,start:function(){this.startTime=+new Date();this.elapsedTime=0;this.running=true;},stop:function(){this.elapsedTime=+new Date()-this.startTime;this.running=false;},getElapsedTime:function(){if(this.running)return+new Date()-this.startTime;else return this.elapsedTime;},reset:function(){this.elapsedTime=0;this.startTime=0;this.running=false;}};return Stopwatch;})();var TimerAnimation=(function(){function TimerAnimation(duration,timeWarp){this.timeWarp=timeWarp;if(duration!==undefined)this.duration=duration;else this.duration=1000;this.stopwatch=new Stopwatch();};TimerAnimation.prototype={start:function(){this.stopwatch.start();},stop:function(){this.stopwatch.stop();},getRealElapsedTime:function(){return this.stopwatch.getElapsedTime();},getElapsedTime:function(){var elapsedTime=this.stopwatch.getElapsedTime(),percentComplete=elapsedTime/this.duration;if(!this.stopwatch.running)return undefined;if(this.timeWarp==undefined)return elapsedTime;return elapsedTime*(this.timeWarp(percentComplete)/percentComplete);},isRunning:function(){return this.stopwatch.running;},isOver:function(){return this.stopwatch.getElapsedTime()>this.duration;},reset:function(){this.stopwatch.reset();}}
TimerAnimation.makeEaseOut=function(strength){return function(percentComplete){return 1-Math.pow(1-percentComplete,strength*2);};};TimerAnimation.makeEaseIn=function(strength){return function(percentComplete){return Math.pow(percentComplete,strength*2);};};TimerAnimation.makeEaseInOut=function(){return function(percentComplete){return percentComplete-Math.sin(percentComplete*2*Math.PI)/(2*Math.PI);};};TimerAnimation.makeElastic=function(passes){passes=passes||3;return function(percentComplete){return((1-Math.cos(percentComplete*Math.PI*passes))*(1-percentComplete))+percentComplete;};};TimerAnimation.makeBounce=function(bounces){var fn=AnimationTimer.makeElastic(bounces);return function(percentComplete){percentComplete=fn(percentComplete);return percentComplete<=1?percentComplete:2-percentComplete;};};TimerAnimation.makeLinear=function(){return function(percentComplete){return percentComplete;};};return TimerAnimation;})();﻿var ImagePainter=function(imageUrl){this.image=new Image;this.image.src=imageUrl;};ImagePainter.prototype={image:undefined,paint:function(sprite,context){if(this.image!==undefined){if(!this.image.complete){this.image.onload=function(e){sprite.width=this.width;sprite.height=this.height;context.drawImage(this,sprite.x,sprite.y,sprite.width,sprite.height);};}
else{context.drawImage(this.image,sprite.x,sprite.y,sprite.width,sprite.height);}}}};SpriteSheetPainter=function(cells){this.cells=cells;};SpriteSheetPainter.prototype={cells:[],cellIndex:0,advance:function(){if(this.cellIndex==this.cells.length-1){this.cellIndex=0;}
else{this.cellIndex++;}},paint:function(sprite,context){var cell=this.cells[this.cellIndex];context.drawImage(spritesheet,cell.left,cell.top,cell.width,cell.height,sprite.left,sprite.top,cell.width,cell.height);}};var SpriteAnimator=function(painters,elapsedCallback){this.painters=painters;if(elapsedCallback){this.elapsedCallback=elapsedCallback;}};SpriteAnimator.prototype={painters:[],duration:1000,startTime:0,index:0,elapsedCallback:undefined,end:function(sprite,originalPainter){sprite.animating=false;if(this.elapsedCallback){this.elapsedCallback(sprite);}
else{sprite.painter=originalPainter;}},start:function(sprite,duration){var endTime=+new Date()+duration,period=duration/(this.painters.length),interval=undefined,animator=this,originalPainter=sprite.painter;this.index=0;sprite.animating=true;sprite.painter=this.painters[this.index];interval=setInterval(function(){if(+new Date()<endTime){sprite.painter=animator.painters[++animator.index];}
else{animator.end(sprite,originalPainter);clearInterval(interval);}},period);},};var Sprite=function(id,painter,behaviors){if(id!==undefined)this.id=id;if(painter!==undefined)this.painter=painter;if(behaviors!==undefined)this.behaviors=behaviors;return this;};Sprite.prototype={x:0,y:0,width:10,height:10,velocityX:0,velocityY:0,visible:true,animating:false,painter:undefined,behaviors:[],paint:function(context){if(this.painter!==undefined&&this.visible){this.painter.paint(this,context);}},update:function(context,time){for(var i=this.behaviors.length;i>0;--i){this.behaviors[i-1].execute(this,context,time);}}};﻿
var HitModel=(function(){function HitModel(canvas){this.list={};this.scaleX=1;this.scaleY=1;this.scaleBoxX=undefined;this.scaleBoxY=undefined;this.rectLeft=undefined;this.rectTop=undefined;this.currentId=undefined;this.canvas=canvas;this.setScale(canvas);}
HitModel.prototype={add:function(id,type,x,y,width,height){if(!this.list[type])this.list[type]={};this.list[type][id]={startX:x,startY:y,endX:x+width,endY:y+height};},clear:function(){this.list={};},remove:function(type,id){if(arguments.length===1){if(this.list[type]){this.list[type]=null;}}else if(arguments.length>1){if(this.list[type]&&this.list[type][id]){this.list[type][id]=null;}}},isHit:function(x,y,hitModel){if(!(x&&y))return false;if(hitModel.startX>x||x>hitModel.endX)return false;if(hitModel.startY>y||y>hitModel.endY)return false;return true;},firstHitId:function(_x,_y,_type){var obj=this.convertToCanvasPosition(_x,_y);if(_type){for(var key in this.list[_type]){if(this.isHit(obj.x,obj.y,this.list[_type][key])){return{id:key,type:_type};}}}else{for(var type in this.list){for(var key in this.list[type]){if(this.isHit(obj.x,obj.y,this.list[type][key])){return{id:key,type:type};}}}}
return null;},setScale:function(canvas){var rect=canvas.getBoundingClientRect();this.scaleBoxX=canvas.width/rect.width;this.scaleBoxY=canvas.height/rect.height;this.rectLeft=rect.left*this.scaleBoxX;this.rectTop=rect.top*this.scaleBoxY;},convertToCanvasPosition:function(x,y){var rect=this.canvas.getBoundingClientRect();return{x:(x-rect.left-this.canvas.scrollLeft)*this.scaleX,y:(y-rect.top-this.canvas.scrollTop)*this.scaleY}}}
return HitModel;})();StringTools={};StringTools.wordWrap=function(context,x,y,width,text,options){var strs=new Array();var str="";for(var i=0;i<text.length;i++){str+=text[i];if(context.measureText(str).width>width-8){strs.push(str);str="";}}
strs.push(str);var size=context.font.split("px")[0];size=size.split(' ');size=size[size.length-1];var heigth=parseInt(size)*4/3;for(var i=0;i<strs.length;i++){context.fillText(strs[i],x,y+heigth*i);}};StringTools.getRealStringLength=function(str){var length=0;for(i=0;i<str.length;i++){if((str.charCodeAt(i)&0xff00)!=0){length++;}
length++;}
return length;}
var CanvasGeometry=(function(){function CanvasGeometry(){};CanvasGeometry.fillRadiusRect=function(ctx,x,y,width,height,radius){ctx.beginPath();ctx.moveTo(x+radius,y);ctx.arcTo(x+width,y,x+width,y+height,radius);ctx.arcTo(x+width,y+height,x,y+height,radius);ctx.arcTo(x,y+height,x,y,radius);ctx.arcTo(x,y,x+width,y,radius);ctx.closePath();};return CanvasGeometry;})();(function(){"use strict";var root=this,previous=root.Chart;var Chart=function(context){var chart=this;this.canvas=context.canvas;this.ctx=context;var width=this.width=context.canvas.width;var height=this.height=context.canvas.height;this.aspectRatio=this.width/this.height;helpers.retinaScale(this);return this;};Chart.defaults={global:{animation:true,animationSteps:60,animationEasing:"easeOutQuart",showScale:true,scaleOverride:false,scaleSteps:null,scaleStepWidth:null,scaleStartValue:null,scaleLineColor:"rgba(0,0,0,.1)",scaleLineWidth:1,scaleShowLabels:true,scaleLabel:"<%=value%>",scaleIntegersOnly:true,scaleBeginAtZero:false,scaleFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",scaleFontSize:12,scaleFontStyle:"normal",scaleFontColor:"#666",responsive:false,maintainAspectRatio:true,showTooltips:true,tooltipEvents:["mousemove","touchstart","touchmove","mouseout"],tooltipFillColor:"rgba(0,0,0,0.8)",tooltipFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",tooltipFontSize:14,tooltipFontStyle:"normal",tooltipFontColor:"#fff",tooltipTitleFontFamily:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",tooltipTitleFontSize:14,tooltipTitleFontStyle:"bold",tooltipTitleFontColor:"#fff",tooltipYPadding:6,tooltipXPadding:6,tooltipCaretSize:8,tooltipCornerRadius:6,tooltipXOffset:10,tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value %>",multiTooltipTemplate:"<%= value %>",multiTooltipKeyBackground:'#fff',onAnimationProgress:function(){},onAnimationComplete:function(){}}};Chart.types={};var helpers=Chart.helpers={};var each=helpers.each=function(loopable,callback,self){var additionalArgs=Array.prototype.slice.call(arguments,3);if(loopable){if(loopable.length===+loopable.length){var i;for(i=0;i<loopable.length;i++){callback.apply(self,[loopable[i],i].concat(additionalArgs));}}
else{for(var item in loopable){callback.apply(self,[loopable[item],item].concat(additionalArgs));}}}},clone=helpers.clone=function(obj){var objClone={};each(obj,function(value,key){if(obj.hasOwnProperty(key))objClone[key]=value;});return objClone;},extend=helpers.extend=function(base){each(Array.prototype.slice.call(arguments,1),function(extensionObject){each(extensionObject,function(value,key){if(extensionObject.hasOwnProperty(key))base[key]=value;});});return base;},merge=helpers.merge=function(base,master){var args=Array.prototype.slice.call(arguments,0);args.unshift({});return extend.apply(null,args);},indexOf=helpers.indexOf=function(arrayToSearch,item){if(Array.prototype.indexOf){return arrayToSearch.indexOf(item);}
else{for(var i=0;i<arrayToSearch.length;i++){if(arrayToSearch[i]===item)return i;}
return-1;}},where=helpers.where=function(collection,filterCallback){var filtered=[];helpers.each(collection,function(item){if(filterCallback(item)){filtered.push(item);}});return filtered;},findNextWhere=helpers.findNextWhere=function(arrayToSearch,filterCallback,startIndex){if(!startIndex){startIndex=-1;}
for(var i=startIndex+1;i<arrayToSearch.length;i++){var currentItem=arrayToSearch[i];if(filterCallback(currentItem)){return currentItem;}};},findPreviousWhere=helpers.findPreviousWhere=function(arrayToSearch,filterCallback,startIndex){if(!startIndex){startIndex=arrayToSearch.length;}
for(var i=startIndex-1;i>=0;i--){var currentItem=arrayToSearch[i];if(filterCallback(currentItem)){return currentItem;}};},inherits=helpers.inherits=function(extensions){var parent=this;var ChartElement=(extensions&&extensions.hasOwnProperty("constructor"))?extensions.constructor:function(){return parent.apply(this,arguments);};var Surrogate=function(){this.constructor=ChartElement;};Surrogate.prototype=parent.prototype;ChartElement.prototype=new Surrogate();ChartElement.extend=inherits;if(extensions)extend(ChartElement.prototype,extensions);ChartElement.__super__=parent.prototype;return ChartElement;},noop=helpers.noop=function(){},uid=helpers.uid=(function(){var id=0;return function(){return"chart-"+id++;};})(),warn=helpers.warn=function(str){if(window.console&&typeof window.console.warn=="function")console.warn(str);},amd=helpers.amd=(typeof define=='function'&&define.amd),isNumber=helpers.isNumber=function(n){return!isNaN(parseFloat(n))&&isFinite(n);},max=helpers.max=function(array){return Math.max.apply(Math,array);},min=helpers.min=function(array){return Math.min.apply(Math,array);},cap=helpers.cap=function(valueToCap,maxValue,minValue){if(isNumber(maxValue)){if(valueToCap>maxValue){return maxValue;}}
else if(isNumber(minValue)){if(valueToCap<minValue){return minValue;}}
return valueToCap;},getDecimalPlaces=helpers.getDecimalPlaces=function(num){if(num%1!==0&&isNumber(num)){return num.toString().split(".")[1].length;}
else{return 0;}},toRadians=helpers.radians=function(degrees){return degrees*(Math.PI/180);},getAngleFromPoint=helpers.getAngleFromPoint=function(centrePoint,anglePoint){var distanceFromXCenter=anglePoint.x-centrePoint.x,distanceFromYCenter=anglePoint.y-centrePoint.y,radialDistanceFromCenter=Math.sqrt(distanceFromXCenter*distanceFromXCenter+distanceFromYCenter*distanceFromYCenter);var angle=Math.PI*2+Math.atan2(distanceFromYCenter,distanceFromXCenter);if(distanceFromXCenter<0&&distanceFromYCenter<0){angle+=Math.PI*2;}
return{angle:angle,distance:radialDistanceFromCenter};},aliasPixel=helpers.aliasPixel=function(pixelWidth){return(pixelWidth%2===0)?0:0.5;},splineCurve=helpers.splineCurve=function(FirstPoint,MiddlePoint,AfterPoint,t){var d01=Math.sqrt(Math.pow(MiddlePoint.x-FirstPoint.x,2)+Math.pow(MiddlePoint.y-FirstPoint.y,2)),d12=Math.sqrt(Math.pow(AfterPoint.x-MiddlePoint.x,2)+Math.pow(AfterPoint.y-MiddlePoint.y,2)),fa=t*d01/(d01+d12),fb=t*d12/(d01+d12);return{inner:{x:MiddlePoint.x-fa*(AfterPoint.x-FirstPoint.x),y:MiddlePoint.y-fa*(AfterPoint.y-FirstPoint.y)},outer:{x:MiddlePoint.x+fb*(AfterPoint.x-FirstPoint.x),y:MiddlePoint.y+fb*(AfterPoint.y-FirstPoint.y)}};},calculateOrderOfMagnitude=helpers.calculateOrderOfMagnitude=function(val){return Math.floor(Math.log(val)/Math.LN10);},calculateScaleRange=helpers.calculateScaleRange=function(valuesArray,drawingSize,textSize,startFromZero,integersOnly){var minSteps=2,maxSteps=Math.floor(drawingSize/(textSize*1.5)),skipFitting=(minSteps>=maxSteps);var maxValue=max(valuesArray),minValue=min(valuesArray);if(maxValue===minValue){maxValue+=0.5;if(minValue>=0.5&&!startFromZero){minValue-=0.5;}
else{maxValue+=0.5;}}
var valueRange=Math.abs(maxValue-minValue),rangeOrderOfMagnitude=calculateOrderOfMagnitude(valueRange),graphMax=Math.ceil(maxValue/(1*Math.pow(10,rangeOrderOfMagnitude)))*Math.pow(10,rangeOrderOfMagnitude),graphMin=(startFromZero)?0:Math.floor(minValue/(1*Math.pow(10,rangeOrderOfMagnitude)))*Math.pow(10,rangeOrderOfMagnitude),graphRange=graphMax-graphMin,stepValue=Math.pow(10,rangeOrderOfMagnitude),numberOfSteps=Math.round(graphRange/stepValue);while((numberOfSteps>maxSteps||(numberOfSteps*2)<maxSteps)&&!skipFitting){if(numberOfSteps>maxSteps){stepValue*=2;numberOfSteps=Math.round(graphRange/stepValue);if(numberOfSteps%1!==0){skipFitting=true;}}
else{if(integersOnly&&rangeOrderOfMagnitude>=0){if(stepValue/2%1===0){stepValue/=2;numberOfSteps=Math.round(graphRange/stepValue);}
else{break;}}
else{stepValue/=2;numberOfSteps=Math.round(graphRange/stepValue);}}}
if(skipFitting){numberOfSteps=minSteps;stepValue=graphRange/numberOfSteps;}
return{steps:numberOfSteps,stepValue:stepValue,min:graphMin,max:graphMin+(numberOfSteps*stepValue)};},template=helpers.template=function(templateString,valuesObject){if(templateString instanceof Function){return templateString(valuesObject);}
var cache={};function tmpl(str,data){var fn=!/\W/.test(str)?cache[str]=cache[str]:new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return data?fn(data):fn;}
return tmpl(templateString,valuesObject);},generateLabels=helpers.generateLabels=function(templateString,numberOfSteps,graphMin,stepValue){var labelsArray=new Array(numberOfSteps);if(labelTemplateString){each(labelsArray,function(val,index){labelsArray[index]=template(templateString,{value:(graphMin+(stepValue*(index+1)))});});}
return labelsArray;},easingEffects=helpers.easingEffects={linear:function(t){return t;},easeInQuad:function(t){return t*t;},easeOutQuad:function(t){return-1*t*(t-2);},easeInOutQuad:function(t){if((t/=1/2)<1)return 1/2*t*t;return-1/2*((--t)*(t-2)-1);},easeInCubic:function(t){return t*t*t;},easeOutCubic:function(t){return 1*((t=t/1-1)*t*t+1);},easeInOutCubic:function(t){if((t/=1/2)<1)return 1/2*t*t*t;return 1/2*((t-=2)*t*t+2);},easeInQuart:function(t){return t*t*t*t;},easeOutQuart:function(t){return-1*((t=t/1-1)*t*t*t-1);},easeInOutQuart:function(t){if((t/=1/2)<1)return 1/2*t*t*t*t;return-1/2*((t-=2)*t*t*t-2);},easeInQuint:function(t){return 1*(t/=1)*t*t*t*t;},easeOutQuint:function(t){return 1*((t=t/1-1)*t*t*t*t+1);},easeInOutQuint:function(t){if((t/=1/2)<1)return 1/2*t*t*t*t*t;return 1/2*((t-=2)*t*t*t*t+2);},easeInSine:function(t){return-1*Math.cos(t/1*(Math.PI/2))+1;},easeOutSine:function(t){return 1*Math.sin(t/1*(Math.PI/2));},easeInOutSine:function(t){return-1/2*(Math.cos(Math.PI*t/1)-1);},easeInExpo:function(t){return(t===0)?1:1*Math.pow(2,10*(t/1-1));},easeOutExpo:function(t){return(t===1)?1:1*(-Math.pow(2,-10*t/1)+1);},easeInOutExpo:function(t){if(t===0)return 0;if(t===1)return 1;if((t/=1/2)<1)return 1/2*Math.pow(2,10*(t-1));return 1/2*(-Math.pow(2,-10*--t)+2);},easeInCirc:function(t){if(t>=1)return t;return-1*(Math.sqrt(1-(t/=1)*t)-1);},easeOutCirc:function(t){return 1*Math.sqrt(1-(t=t/1-1)*t);},easeInOutCirc:function(t){if((t/=1/2)<1)return-1/2*(Math.sqrt(1-t*t)-1);return 1/2*(Math.sqrt(1-(t-=2)*t)+1);},easeInElastic:function(t){var s=1.70158;var p=0;var a=1;if(t===0)return 0;if((t/=1)==1)return 1;if(!p)p=1*0.3;if(a<Math.abs(1)){a=1;s=p/4;}else s=p/(2*Math.PI)*Math.asin(1/a);return-(a*Math.pow(2,10*(t-=1))*Math.sin((t*1-s)*(2*Math.PI)/p));},easeOutElastic:function(t){var s=1.70158;var p=0;var a=1;if(t===0)return 0;if((t/=1)==1)return 1;if(!p)p=1*0.3;if(a<Math.abs(1)){a=1;s=p/4;}else s=p/(2*Math.PI)*Math.asin(1/a);return a*Math.pow(2,-10*t)*Math.sin((t*1-s)*(2*Math.PI)/p)+1;},easeInOutElastic:function(t){var s=1.70158;var p=0;var a=1;if(t===0)return 0;if((t/=1/2)==2)return 1;if(!p)p=1*(0.3*1.5);if(a<Math.abs(1)){a=1;s=p/4;}else s=p/(2*Math.PI)*Math.asin(1/a);if(t<1)return-0.5*(a*Math.pow(2,10*(t-=1))*Math.sin((t*1-s)*(2*Math.PI)/p));return a*Math.pow(2,-10*(t-=1))*Math.sin((t*1-s)*(2*Math.PI)/p)*0.5+1;},easeInBack:function(t){var s=1.70158;return 1*(t/=1)*t*((s+1)*t-s);},easeOutBack:function(t){var s=1.70158;return 1*((t=t/1-1)*t*((s+1)*t+s)+1);},easeInOutBack:function(t){var s=1.70158;if((t/=1/2)<1)return 1/2*(t*t*(((s*=(1.525))+1)*t-s));return 1/2*((t-=2)*t*(((s*=(1.525))+1)*t+s)+2);},easeInBounce:function(t){return 1-easingEffects.easeOutBounce(1-t);},easeOutBounce:function(t){if((t/=1)<(1/2.75)){return 1*(7.5625*t*t);}else if(t<(2/2.75)){return 1*(7.5625*(t-=(1.5/2.75))*t+0.75);}else if(t<(2.5/2.75)){return 1*(7.5625*(t-=(2.25/2.75))*t+0.9375);}else{return 1*(7.5625*(t-=(2.625/2.75))*t+0.984375);}},easeInOutBounce:function(t){if(t<1/2)return easingEffects.easeInBounce(t*2)*0.5;return easingEffects.easeOutBounce(t*2-1)*0.5+1*0.5;}},requestAnimFrame=helpers.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return window.setTimeout(callback,1000/60);};})(),cancelAnimFrame=helpers.cancelAnimFrame=(function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(callback){return window.clearTimeout(callback,1000/60);};})(),animationLoop=helpers.animationLoop=function(callback,totalSteps,easingString,onProgress,onComplete,chartInstance){var currentStep=0,easingFunction=easingEffects[easingString]||easingEffects.linear;var animationFrame=function(){currentStep++;var stepDecimal=currentStep/totalSteps;var easeDecimal=easingFunction(stepDecimal);callback.call(chartInstance,easeDecimal,stepDecimal,currentStep);onProgress.call(chartInstance,easeDecimal,stepDecimal);if(currentStep<totalSteps){chartInstance.animationFrame=requestAnimFrame(animationFrame);}else{onComplete.apply(chartInstance);}};requestAnimFrame(animationFrame);},getRelativePosition=helpers.getRelativePosition=function(evt){var mouseX,mouseY;var e=evt.originalEvent||evt,canvas=evt.currentTarget||evt.srcElement,boundingRect=canvas.getBoundingClientRect();if(e.touches){mouseX=e.touches[0].clientX-boundingRect.left;mouseY=e.touches[0].clientY-boundingRect.top;}
else{mouseX=e.clientX-boundingRect.left;mouseY=e.clientY-boundingRect.top;}
return{x:mouseX,y:mouseY};},addEvent=helpers.addEvent=function(node,eventType,method){if(node.addEventListener){node.addEventListener(eventType,method);}else if(node.attachEvent){node.attachEvent("on"+eventType,method);}else{node["on"+eventType]=method;}},removeEvent=helpers.removeEvent=function(node,eventType,handler){if(node.removeEventListener){node.removeEventListener(eventType,handler,false);}else if(node.detachEvent){node.detachEvent("on"+eventType,handler);}else{node["on"+eventType]=noop;}},bindEvents=helpers.bindEvents=function(chartInstance,arrayOfEvents,handler){if(!chartInstance.events)chartInstance.events={};each(arrayOfEvents,function(eventName){chartInstance.events[eventName]=function(){handler.apply(chartInstance,arguments);};addEvent(chartInstance.chart.canvas,eventName,chartInstance.events[eventName]);});},unbindEvents=helpers.unbindEvents=function(chartInstance,arrayOfEvents){each(arrayOfEvents,function(handler,eventName){removeEvent(chartInstance.chart.canvas,eventName,handler);});},getMaximumWidth=helpers.getMaximumWidth=function(domNode){var container=domNode.parentNode;return container.clientWidth;},getMaximumHeight=helpers.getMaximumHeight=function(domNode){var container=domNode.parentNode;return container.clientHeight;},getMaximumSize=helpers.getMaximumSize=helpers.getMaximumWidth,retinaScale=helpers.retinaScale=function(chart){var ctx=chart.ctx,width=chart.canvas.width,height=chart.canvas.height;if(window.devicePixelRatio){ctx.canvas.style.width=width+"px";ctx.canvas.style.height=height+"px";ctx.canvas.height=height*window.devicePixelRatio;ctx.canvas.width=width*window.devicePixelRatio;ctx.scale(window.devicePixelRatio,window.devicePixelRatio);}},clear=helpers.clear=function(chart){chart.ctx.clearRect(0,0,chart.width,chart.height);},fontString=helpers.fontString=function(pixelSize,fontStyle,fontFamily){return fontStyle+" "+pixelSize+"px "+fontFamily;},longestText=helpers.longestText=function(ctx,font,arrayOfStrings){ctx.font=font;var longest=0;each(arrayOfStrings,function(string){var textWidth=ctx.measureText(string).width;longest=(textWidth>longest)?textWidth:longest;});return longest;},drawRoundedRectangle=helpers.drawRoundedRectangle=function(ctx,x,y,width,height,radius){ctx.beginPath();ctx.moveTo(x+radius,y);ctx.lineTo(x+width-radius,y);ctx.quadraticCurveTo(x+width,y,x+width,y+radius);ctx.lineTo(x+width,y+height-radius);ctx.quadraticCurveTo(x+width,y+height,x+width-radius,y+height);ctx.lineTo(x+radius,y+height);ctx.quadraticCurveTo(x,y+height,x,y+height-radius);ctx.lineTo(x,y+radius);ctx.quadraticCurveTo(x,y,x+radius,y);ctx.closePath();};Chart.instances={};Chart.Type=function(data,options,chart){this.options=options;this.chart=chart;this.id=uid();Chart.instances[this.id]=this;if(options.responsive){this.resize();}
this.initialize.call(this,data);};extend(Chart.Type.prototype,{initialize:function(){return this;},clear:function(){clear(this.chart);return this;},stop:function(){helpers.cancelAnimFrame.call(root,this.animationFrame);return this;},resize:function(callback){this.stop();var canvas=this.chart.canvas,newWidth=getMaximumWidth(this.chart.canvas),newHeight=this.options.maintainAspectRatio?newWidth/this.chart.aspectRatio:getMaximumHeight(this.chart.canvas);canvas.width=this.chart.width=newWidth;canvas.height=this.chart.height=newHeight;retinaScale(this.chart);if(typeof callback==="function"){callback.apply(this,Array.prototype.slice.call(arguments,1));}
return this;},reflow:noop,render:function(reflow){if(reflow){this.reflow();}
if(this.options.animation&&!reflow){helpers.animationLoop(this.draw,this.options.animationSteps,this.options.animationEasing,this.options.onAnimationProgress,this.options.onAnimationComplete,this);}
else{this.draw();this.options.onAnimationComplete.call(this);}
return this;},generateLegend:function(){return template(this.options.legendTemplate,this);},destroy:function(){this.clear();unbindEvents(this,this.events);delete Chart.instances[this.id];},showTooltip:function(ChartElements,forceRedraw){if(typeof this.activeElements==='undefined')this.activeElements=[];var isChanged=(function(Elements){var changed=false;if(Elements.length!==this.activeElements.length){changed=true;return changed;}
each(Elements,function(element,index){if(element!==this.activeElements[index]){changed=true;}},this);return changed;}).call(this,ChartElements);if(!isChanged&&!forceRedraw){return;}
else{this.activeElements=ChartElements;}
this.draw();if(ChartElements.length>0){if(this.datasets&&this.datasets.length>1){var dataArray,dataIndex;for(var i=this.datasets.length-1;i>=0;i--){dataArray=this.datasets[i].points||this.datasets[i].bars||this.datasets[i].segments;dataIndex=indexOf(dataArray,ChartElements[0]);if(dataIndex!==-1){break;}}
var tooltipLabels=[],tooltipColors=[],medianPosition=(function(index){var Elements=[],dataCollection,xPositions=[],yPositions=[],xMax,yMax,xMin,yMin;helpers.each(this.datasets,function(dataset){dataCollection=dataset.points||dataset.bars||dataset.segments;if(dataCollection[dataIndex]&&dataCollection[dataIndex].hasValue()){Elements.push(dataCollection[dataIndex]);}});helpers.each(Elements,function(element){xPositions.push(element.x);yPositions.push(element.y);tooltipLabels.push(helpers.template(this.options.multiTooltipTemplate,element));tooltipColors.push({fill:element._saved.fillColor||element.fillColor,stroke:element._saved.strokeColor||element.strokeColor});},this);yMin=min(yPositions);yMax=max(yPositions);xMin=min(xPositions);xMax=max(xPositions);return{x:(xMin>this.chart.width/2)?xMin:xMax,y:(yMin+yMax)/2};}).call(this,dataIndex);new Chart.MultiTooltip({x:medianPosition.x,y:medianPosition.y,xPadding:this.options.tooltipXPadding,yPadding:this.options.tooltipYPadding,xOffset:this.options.tooltipXOffset,fillColor:this.options.tooltipFillColor,textColor:this.options.tooltipFontColor,fontFamily:this.options.tooltipFontFamily,fontStyle:this.options.tooltipFontStyle,fontSize:this.options.tooltipFontSize,titleTextColor:this.options.tooltipTitleFontColor,titleFontFamily:this.options.tooltipTitleFontFamily,titleFontStyle:this.options.tooltipTitleFontStyle,titleFontSize:this.options.tooltipTitleFontSize,cornerRadius:this.options.tooltipCornerRadius,labels:tooltipLabels,legendColors:tooltipColors,legendColorBackground:this.options.multiTooltipKeyBackground,title:ChartElements[0].label,chart:this.chart,ctx:this.chart.ctx}).draw();}else{each(ChartElements,function(Element){var tooltipPosition=Element.tooltipPosition();new Chart.Tooltip({x:Math.round(tooltipPosition.x),y:Math.round(tooltipPosition.y),xPadding:this.options.tooltipXPadding,yPadding:this.options.tooltipYPadding,fillColor:this.options.tooltipFillColor,textColor:this.options.tooltipFontColor,fontFamily:this.options.tooltipFontFamily,fontStyle:this.options.tooltipFontStyle,fontSize:this.options.tooltipFontSize,caretHeight:this.options.tooltipCaretSize,cornerRadius:this.options.tooltipCornerRadius,text:template(this.options.tooltipTemplate,Element),chart:this.chart}).draw();},this);}}
return this;},toBase64Image:function(){return this.chart.canvas.toDataURL.apply(this.chart.canvas,arguments);}});Chart.Type.extend=function(extensions){var parent=this;var ChartType=function(){return parent.apply(this,arguments);};ChartType.prototype=clone(parent.prototype);extend(ChartType.prototype,extensions);ChartType.extend=Chart.Type.extend;if(extensions.name||parent.prototype.name){var chartName=extensions.name||parent.prototype.name;var baseDefaults=(Chart.defaults[parent.prototype.name])?clone(Chart.defaults[parent.prototype.name]):{};Chart.defaults[chartName]=extend(baseDefaults,extensions.defaults);Chart.types[chartName]=ChartType;Chart.prototype[chartName]=function(data,options){var config=merge(Chart.defaults.global,Chart.defaults[chartName],options||{});return new ChartType(data,config,this);};}else{warn("Name not provided for this chart, so it hasn't been registered");}
return parent;};Chart.Element=function(configuration){extend(this,configuration);this.initialize.apply(this,arguments);this.save();};extend(Chart.Element.prototype,{initialize:function(){},restore:function(props){if(!props){extend(this,this._saved);}else{each(props,function(key){this[key]=this._saved[key];},this);}
return this;},save:function(){this._saved=clone(this);delete this._saved._saved;return this;},update:function(newProps){each(newProps,function(value,key){this._saved[key]=this[key];this[key]=value;},this);return this;},transition:function(props,ease){each(props,function(value,key){this[key]=((value-this._saved[key])*ease)+this._saved[key];},this);return this;},tooltipPosition:function(){return{x:this.x,y:this.y};},hasValue:function(){return isNumber(this.value);}});Chart.Element.extend=inherits;Chart.Point=Chart.Element.extend({display:true,inRange:function(chartX,chartY){var hitDetectionRange=this.hitDetectionRadius+this.radius;return((Math.pow(chartX-this.x,2)+Math.pow(chartY-this.y,2))<Math.pow(hitDetectionRange,2));},draw:function(){if(this.display){var ctx=this.ctx;ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);ctx.closePath();ctx.strokeStyle=this.strokeColor;ctx.lineWidth=this.strokeWidth;ctx.fillStyle=this.fillColor;ctx.fill();ctx.stroke();}}});Chart.Arc=Chart.Element.extend({inRange:function(chartX,chartY){var pointRelativePosition=helpers.getAngleFromPoint(this,{x:chartX,y:chartY});var betweenAngles=(pointRelativePosition.angle>=this.startAngle&&pointRelativePosition.angle<=this.endAngle),withinRadius=(pointRelativePosition.distance>=this.innerRadius&&pointRelativePosition.distance<=this.outerRadius);return(betweenAngles&&withinRadius);},tooltipPosition:function(){var centreAngle=this.startAngle+((this.endAngle-this.startAngle)/2),rangeFromCentre=(this.outerRadius-this.innerRadius)/2+this.innerRadius;return{x:this.x+(Math.cos(centreAngle)*rangeFromCentre),y:this.y+(Math.sin(centreAngle)*rangeFromCentre)};},draw:function(animationPercent){var easingDecimal=animationPercent||1;var ctx=this.ctx;ctx.beginPath();ctx.arc(this.x,this.y,this.outerRadius,this.startAngle,this.endAngle);ctx.arc(this.x,this.y,this.innerRadius,this.endAngle,this.startAngle,true);ctx.closePath();ctx.strokeStyle=this.strokeColor;ctx.lineWidth=this.strokeWidth;ctx.fillStyle=this.fillColor;ctx.fill();ctx.lineJoin='bevel';if(this.showStroke){ctx.stroke();}}});Chart.Rectangle=Chart.Element.extend({draw:function(){var ctx=this.ctx,halfWidth=this.width/2,leftX=this.x-halfWidth,rightX=this.x+halfWidth,top=this.base-(this.base-this.y),halfStroke=this.strokeWidth/2;if(this.showStroke){leftX+=halfStroke;rightX-=halfStroke;top+=halfStroke;}
ctx.beginPath();ctx.fillStyle=this.fillColor;ctx.strokeStyle=this.strokeColor;ctx.lineWidth=this.strokeWidth;ctx.moveTo(leftX,this.base);ctx.lineTo(leftX,top);ctx.lineTo(rightX,top);ctx.lineTo(rightX,this.base);ctx.fill();if(this.showStroke){ctx.stroke();}},height:function(){return this.base-this.y;},inRange:function(chartX,chartY){return(chartX>=this.x-this.width/2&&chartX<=this.x+this.width/2)&&(chartY>=this.y&&chartY<=this.base);}});Chart.Tooltip=Chart.Element.extend({draw:function(){var ctx=this.chart.ctx;ctx.font=fontString(this.fontSize,this.fontStyle,this.fontFamily);this.xAlign="center";this.yAlign="above";var caretPadding=2;var tooltipWidth=ctx.measureText(this.text).width+2*this.xPadding,tooltipRectHeight=this.fontSize+2*this.yPadding,tooltipHeight=tooltipRectHeight+this.caretHeight+caretPadding;if(this.x+tooltipWidth/2>this.chart.width){this.xAlign="left";}else if(this.x-tooltipWidth/2<0){this.xAlign="right";}
if(this.y-tooltipHeight<0){this.yAlign="below";}
var tooltipX=this.x-tooltipWidth/2,tooltipY=this.y-tooltipHeight;ctx.fillStyle=this.fillColor;switch(this.yAlign)
{case"above":ctx.beginPath();ctx.moveTo(this.x,this.y-caretPadding);ctx.lineTo(this.x+this.caretHeight,this.y-(caretPadding+this.caretHeight));ctx.lineTo(this.x-this.caretHeight,this.y-(caretPadding+this.caretHeight));ctx.closePath();ctx.fill();break;case"below":tooltipY=this.y+caretPadding+this.caretHeight;ctx.beginPath();ctx.moveTo(this.x,this.y+caretPadding);ctx.lineTo(this.x+this.caretHeight,this.y+caretPadding+this.caretHeight);ctx.lineTo(this.x-this.caretHeight,this.y+caretPadding+this.caretHeight);ctx.closePath();ctx.fill();break;}
switch(this.xAlign)
{case"left":tooltipX=this.x-tooltipWidth+(this.cornerRadius+this.caretHeight);break;case"right":tooltipX=this.x-(this.cornerRadius+this.caretHeight);break;}
drawRoundedRectangle(ctx,tooltipX,tooltipY,tooltipWidth,tooltipRectHeight,this.cornerRadius);ctx.fill();ctx.fillStyle=this.textColor;ctx.textAlign="center";ctx.textBaseline="middle";ctx.fillText(this.text,tooltipX+tooltipWidth/2,tooltipY+tooltipRectHeight/2);}});Chart.MultiTooltip=Chart.Element.extend({initialize:function(){this.font=fontString(this.fontSize,this.fontStyle,this.fontFamily);this.titleFont=fontString(this.titleFontSize,this.titleFontStyle,this.titleFontFamily);this.height=(this.labels.length*this.fontSize)+((this.labels.length-1)*(this.fontSize/2))+(this.yPadding*2)+this.titleFontSize*1.5;this.ctx.font=this.titleFont;var titleWidth=this.ctx.measureText(this.title).width,labelWidth=longestText(this.ctx,this.font,this.labels)+this.fontSize+3,longestTextWidth=max([labelWidth,titleWidth]);this.width=longestTextWidth+(this.xPadding*2);var halfHeight=this.height/2;if(this.y-halfHeight<0){this.y=halfHeight;}else if(this.y+halfHeight>this.chart.height){this.y=this.chart.height-halfHeight;}
if(this.x>this.chart.width/2){this.x-=this.xOffset+this.width;}else{this.x+=this.xOffset;}},getLineHeight:function(index){var baseLineHeight=this.y-(this.height/2)+this.yPadding,afterTitleIndex=index-1;if(index===0){return baseLineHeight+this.titleFontSize/2;}else{return baseLineHeight+((this.fontSize*1.5*afterTitleIndex)+this.fontSize/2)+this.titleFontSize*1.5;}},draw:function(){drawRoundedRectangle(this.ctx,this.x,this.y-this.height/2,this.width,this.height,this.cornerRadius);var ctx=this.ctx;ctx.fillStyle=this.fillColor;ctx.fill();ctx.closePath();ctx.textAlign="left";ctx.textBaseline="middle";ctx.fillStyle=this.titleTextColor;ctx.font=this.titleFont;ctx.fillText(this.title,this.x+this.xPadding,this.getLineHeight(0));ctx.font=this.font;helpers.each(this.labels,function(label,index){ctx.fillStyle=this.textColor;ctx.fillText(label,this.x+this.xPadding+this.fontSize+3,this.getLineHeight(index+1));ctx.fillStyle=this.legendColorBackground;ctx.fillRect(this.x+this.xPadding,this.getLineHeight(index+1)-this.fontSize/2,this.fontSize,this.fontSize);ctx.fillStyle=this.legendColors[index].fill;ctx.fillRect(this.x+this.xPadding,this.getLineHeight(index+1)-this.fontSize/2,this.fontSize,this.fontSize);},this);}});Chart.Scale=Chart.Element.extend({initialize:function(){this.fit();},buildYLabels:function(){this.yLabels=[];var stepDecimalPlaces=getDecimalPlaces(this.stepValue);for(var i=0;i<=this.steps;i++){this.yLabels.push(template(this.templateString,{value:(this.min+(i*this.stepValue)).toFixed(stepDecimalPlaces)}));}
this.yLabelWidth=(this.display&&this.showLabels)?longestText(this.ctx,this.font,this.yLabels):0;},addXLabel:function(label){this.xLabels.push(label);this.valuesCount++;this.fit();},removeXLabel:function(){this.xLabels.shift();this.valuesCount--;this.fit();},fit:function(){this.startPoint=(this.display)?this.fontSize:0;this.endPoint=(this.display)?this.height-(this.fontSize*1.5)-5:this.height;this.startPoint+=this.padding;this.endPoint-=this.padding;var cachedHeight=this.endPoint-this.startPoint,cachedYLabelWidth;this.calculateYRange(cachedHeight);this.buildYLabels();this.calculateXLabelRotation();while((cachedHeight>this.endPoint-this.startPoint)){cachedHeight=this.endPoint-this.startPoint;cachedYLabelWidth=this.yLabelWidth;this.calculateYRange(cachedHeight);this.buildYLabels();if(cachedYLabelWidth<this.yLabelWidth){this.calculateXLabelRotation();}}},calculateXLabelRotation:function(){this.ctx.font=this.font;var firstWidth=this.ctx.measureText(this.xLabels[0]).width,lastWidth=this.ctx.measureText(this.xLabels[this.xLabels.length-1]).width,firstRotated,lastRotated;this.xScalePaddingRight=lastWidth/2+3;this.xScalePaddingLeft=(firstWidth/2>this.yLabelWidth+10)?firstWidth/2:this.yLabelWidth+10;this.xLabelRotation=0;if(this.display){var originalLabelWidth=longestText(this.ctx,this.font,this.xLabels),cosRotation,firstRotatedWidth;this.xLabelWidth=originalLabelWidth;var xGridWidth=Math.floor(this.calculateX(1)-this.calculateX(0))-6;while((this.xLabelWidth>xGridWidth&&this.xLabelRotation===0)||(this.xLabelWidth>xGridWidth&&this.xLabelRotation<=90&&this.xLabelRotation>0)){cosRotation=Math.cos(toRadians(this.xLabelRotation));firstRotated=cosRotation*firstWidth;lastRotated=cosRotation*lastWidth;if(firstRotated+this.fontSize/2>this.yLabelWidth+8){this.xScalePaddingLeft=firstRotated+this.fontSize/2;}
this.xScalePaddingRight=this.fontSize/2;this.xLabelRotation++;this.xLabelWidth=cosRotation*originalLabelWidth;}
if(this.xLabelRotation>0){this.endPoint-=Math.sin(toRadians(this.xLabelRotation))*originalLabelWidth+3;}}
else{this.xLabelWidth=0;this.xScalePaddingRight=this.padding;this.xScalePaddingLeft=this.padding;}},calculateYRange:noop,drawingArea:function(){return this.startPoint-this.endPoint;},calculateY:function(value){var scalingFactor=this.drawingArea()/(this.min-this.max);return this.endPoint-(scalingFactor*(value-this.min));},calculateX:function(index){var isRotated=(this.xLabelRotation>0),innerWidth=this.width-(this.xScalePaddingLeft+this.xScalePaddingRight),valueWidth=innerWidth/(this.valuesCount-((this.offsetGridLines)?0:1)),valueOffset=(valueWidth*index)+this.xScalePaddingLeft;if(this.offsetGridLines){valueOffset+=(valueWidth/2);}
return Math.round(valueOffset);},update:function(newProps){helpers.extend(this,newProps);this.fit();},draw:function(){var ctx=this.ctx,yLabelGap=(this.endPoint-this.startPoint)/this.steps,xStart=Math.round(this.xScalePaddingLeft);if(this.display){ctx.fillStyle=this.textColor;ctx.font=this.font;each(this.yLabels,function(labelString,index){var yLabelCenter=this.endPoint-(yLabelGap*index),linePositionY=Math.round(yLabelCenter);ctx.textAlign="right";ctx.textBaseline="middle";if(this.showLabels){ctx.fillText(labelString,xStart-10,yLabelCenter);}
ctx.beginPath();if(index>0){ctx.lineWidth=this.gridLineWidth;ctx.strokeStyle=this.gridLineColor;}else{ctx.lineWidth=this.lineWidth;ctx.strokeStyle=this.lineColor;}
linePositionY+=helpers.aliasPixel(ctx.lineWidth);ctx.moveTo(xStart,linePositionY);ctx.lineTo(this.width,linePositionY);ctx.stroke();ctx.closePath();ctx.lineWidth=this.lineWidth;ctx.strokeStyle=this.lineColor;ctx.beginPath();ctx.moveTo(xStart-5,linePositionY);ctx.lineTo(xStart,linePositionY);ctx.stroke();ctx.closePath();},this);each(this.xLabels,function(label,index){var xPos=this.calculateX(index)+aliasPixel(this.lineWidth),linePos=this.calculateX(index-(this.offsetGridLines?0.5:0))+aliasPixel(this.lineWidth),isRotated=(this.xLabelRotation>0);ctx.beginPath();if(index>0){ctx.lineWidth=this.gridLineWidth;ctx.strokeStyle=this.gridLineColor;}else{ctx.lineWidth=this.lineWidth;ctx.strokeStyle=this.lineColor;}
ctx.moveTo(linePos,this.endPoint);ctx.lineTo(linePos,this.startPoint-3);ctx.stroke();ctx.closePath();ctx.lineWidth=this.lineWidth;ctx.strokeStyle=this.lineColor;ctx.beginPath();ctx.moveTo(linePos,this.endPoint);ctx.lineTo(linePos,this.endPoint+5);ctx.stroke();ctx.closePath();ctx.save();ctx.translate(xPos,(isRotated)?this.endPoint+12:this.endPoint+8);ctx.rotate(toRadians(this.xLabelRotation)*-1);ctx.font=this.font;ctx.textAlign=(isRotated)?"right":"center";ctx.textBaseline=(isRotated)?"middle":"top";ctx.fillText(label,0,0);ctx.restore();},this);}}});Chart.RadialScale=Chart.Element.extend({initialize:function(){this.size=min([this.height,this.width]);this.drawingArea=(this.display)?(this.size/2)-(this.fontSize/2+this.backdropPaddingY):(this.size/2);},calculateCenterOffset:function(value){var scalingFactor=this.drawingArea/(this.max-this.min);return(value-this.min)*scalingFactor;},update:function(){if(!this.lineArc){this.setScaleSize();}else{this.drawingArea=(this.display)?(this.size/2)-(this.fontSize/2+this.backdropPaddingY):(this.size/2);}
this.buildYLabels();},buildYLabels:function(){this.yLabels=[];var stepDecimalPlaces=getDecimalPlaces(this.stepValue);for(var i=0;i<=this.steps;i++){this.yLabels.push(template(this.templateString,{value:(this.min+(i*this.stepValue)).toFixed(stepDecimalPlaces)}));}},getCircumference:function(){return((Math.PI*2)/this.valuesCount);},setScaleSize:function(){var largestPossibleRadius=min([(this.height/2-this.pointLabelFontSize-5),this.width/2]),pointPosition,i,textWidth,halfTextWidth,furthestRight=this.width,furthestRightIndex,furthestRightAngle,furthestLeft=0,furthestLeftIndex,furthestLeftAngle,xProtrusionLeft,xProtrusionRight,radiusReductionRight,radiusReductionLeft,maxWidthRadius;this.ctx.font=fontString(this.pointLabelFontSize,this.pointLabelFontStyle,this.pointLabelFontFamily);for(i=0;i<this.valuesCount;i++){pointPosition=this.getPointPosition(i,largestPossibleRadius);textWidth=this.ctx.measureText(template(this.templateString,{value:this.labels[i]})).width+5;if(i===0||i===this.valuesCount/2){halfTextWidth=textWidth/2;if(pointPosition.x+halfTextWidth>furthestRight){furthestRight=pointPosition.x+halfTextWidth;furthestRightIndex=i;}
if(pointPosition.x-halfTextWidth<furthestLeft){furthestLeft=pointPosition.x-halfTextWidth;furthestLeftIndex=i;}}
else if(i<this.valuesCount/2){if(pointPosition.x+textWidth>furthestRight){furthestRight=pointPosition.x+textWidth;furthestRightIndex=i;}}
else if(i>this.valuesCount/2){if(pointPosition.x-textWidth<furthestLeft){furthestLeft=pointPosition.x-textWidth;furthestLeftIndex=i;}}}
xProtrusionLeft=furthestLeft;xProtrusionRight=Math.ceil(furthestRight-this.width);furthestRightAngle=this.getIndexAngle(furthestRightIndex);furthestLeftAngle=this.getIndexAngle(furthestLeftIndex);radiusReductionRight=xProtrusionRight/Math.sin(furthestRightAngle+Math.PI/2);radiusReductionLeft=xProtrusionLeft/Math.sin(furthestLeftAngle+Math.PI/2);radiusReductionRight=(isNumber(radiusReductionRight))?radiusReductionRight:0;radiusReductionLeft=(isNumber(radiusReductionLeft))?radiusReductionLeft:0;this.drawingArea=largestPossibleRadius-(radiusReductionLeft+radiusReductionRight)/2;this.setCenterPoint(radiusReductionLeft,radiusReductionRight);},setCenterPoint:function(leftMovement,rightMovement){var maxRight=this.width-rightMovement-this.drawingArea,maxLeft=leftMovement+this.drawingArea;this.xCenter=(maxLeft+maxRight)/2;this.yCenter=(this.height/2);},getIndexAngle:function(index){var angleMultiplier=(Math.PI*2)/this.valuesCount;return index*angleMultiplier-(Math.PI/2);},getPointPosition:function(index,distanceFromCenter){var thisAngle=this.getIndexAngle(index);return{x:(Math.cos(thisAngle)*distanceFromCenter)+this.xCenter,y:(Math.sin(thisAngle)*distanceFromCenter)+this.yCenter};},draw:function(){if(this.display){var ctx=this.ctx;each(this.yLabels,function(label,index){if(index>0){var yCenterOffset=index*(this.drawingArea/this.steps),yHeight=this.yCenter-yCenterOffset,pointPosition;if(this.lineWidth>0){ctx.strokeStyle=this.lineColor;ctx.lineWidth=this.lineWidth;if(this.lineArc){ctx.beginPath();ctx.arc(this.xCenter,this.yCenter,yCenterOffset,0,Math.PI*2);ctx.closePath();ctx.stroke();}else{ctx.beginPath();for(var i=0;i<this.valuesCount;i++)
{pointPosition=this.getPointPosition(i,this.calculateCenterOffset(this.min+(index*this.stepValue)));if(i===0){ctx.moveTo(pointPosition.x,pointPosition.y);}else{ctx.lineTo(pointPosition.x,pointPosition.y);}}
ctx.closePath();ctx.stroke();}}
if(this.showLabels){ctx.font=fontString(this.fontSize,this.fontStyle,this.fontFamily);if(this.showLabelBackdrop){var labelWidth=ctx.measureText(label).width;ctx.fillStyle=this.backdropColor;ctx.fillRect(this.xCenter-labelWidth/2-this.backdropPaddingX,yHeight-this.fontSize/2-this.backdropPaddingY,labelWidth+this.backdropPaddingX*2,this.fontSize+this.backdropPaddingY*2);}
ctx.textAlign='center';ctx.textBaseline="middle";ctx.fillStyle=this.fontColor;ctx.fillText(label,this.xCenter,yHeight);}}},this);if(!this.lineArc){ctx.lineWidth=this.angleLineWidth;ctx.strokeStyle=this.angleLineColor;for(var i=this.valuesCount-1;i>=0;i--){if(this.angleLineWidth>0){var outerPosition=this.getPointPosition(i,this.calculateCenterOffset(this.max));ctx.beginPath();ctx.moveTo(this.xCenter,this.yCenter);ctx.lineTo(outerPosition.x,outerPosition.y);ctx.stroke();ctx.closePath();}
var pointLabelPosition=this.getPointPosition(i,this.calculateCenterOffset(this.max)+5);ctx.font=fontString(this.pointLabelFontSize,this.pointLabelFontStyle,this.pointLabelFontFamily);ctx.fillStyle=this.pointLabelFontColor;var labelsCount=this.labels.length,halfLabelsCount=this.labels.length/2,quarterLabelsCount=halfLabelsCount/2,upperHalf=(i<quarterLabelsCount||i>labelsCount-quarterLabelsCount),exactQuarter=(i===quarterLabelsCount||i===labelsCount-quarterLabelsCount);if(i===0){ctx.textAlign='center';}else if(i===halfLabelsCount){ctx.textAlign='center';}else if(i<halfLabelsCount){ctx.textAlign='left';}else{ctx.textAlign='right';}
if(exactQuarter){ctx.textBaseline='middle';}else if(upperHalf){ctx.textBaseline='bottom';}else{ctx.textBaseline='top';}
ctx.fillText(this.labels[i],pointLabelPosition.x,pointLabelPosition.y);}}}}});helpers.addEvent(window,"resize",(function(){var timeout;return function(){clearTimeout(timeout);timeout=setTimeout(function(){each(Chart.instances,function(instance){if(instance.options.responsive){instance.resize(instance.render,true);}});},50);};})());if(amd){define(function(){return Chart;});}else if(typeof module==='object'&&module.exports){module.exports=Chart;}
root.Chart=Chart;Chart.noConflict=function(){root.Chart=previous;return Chart;};}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={scaleBeginAtZero:true,scaleShowGridLines:true,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,barShowStroke:true,barStrokeWidth:2,barValueSpacing:5,barDatasetSpacing:1,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].fillColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"};Chart.Type.extend({name:"Bar",defaults:defaultConfig,initialize:function(data){var options=this.options;this.ScaleClass=Chart.Scale.extend({offsetGridLines:true,calculateBarX:function(datasetCount,datasetIndex,barIndex){var xWidth=this.calculateBaseWidth(),xAbsolute=this.calculateX(barIndex)-(xWidth/2),barWidth=this.calculateBarWidth(datasetCount);return xAbsolute+(barWidth*datasetIndex)+(datasetIndex*options.barDatasetSpacing)+barWidth/2;},calculateBaseWidth:function(){return(this.calculateX(1)-this.calculateX(0))-(2*options.barValueSpacing);},calculateBarWidth:function(datasetCount){var baseWidth=this.calculateBaseWidth()-((datasetCount-1)*options.barDatasetSpacing);return(baseWidth/datasetCount);}});this.datasets=[];if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activeBars=(evt.type!=='mouseout')?this.getBarsAtEvent(evt):[];this.eachBars(function(bar){bar.restore(['fillColor','strokeColor']);});helpers.each(activeBars,function(activeBar){activeBar.fillColor=activeBar.highlightFill;activeBar.strokeColor=activeBar.highlightStroke;});this.showTooltip(activeBars);});}
this.BarClass=Chart.Rectangle.extend({strokeWidth:this.options.barStrokeWidth,showStroke:this.options.barShowStroke,ctx:this.chart.ctx});helpers.each(data.datasets,function(dataset,datasetIndex){var datasetObject={label:dataset.label||null,fillColor:dataset.fillColor,strokeColor:dataset.strokeColor,bars:[]};this.datasets.push(datasetObject);helpers.each(dataset.data,function(dataPoint,index){datasetObject.bars.push(new this.BarClass({value:dataPoint,label:data.labels[index],datasetLabel:dataset.label,strokeColor:dataset.strokeColor,fillColor:dataset.fillColor,highlightFill:dataset.highlightFill||dataset.fillColor,highlightStroke:dataset.highlightStroke||dataset.strokeColor}));},this);},this);this.buildScale(data.labels);this.BarClass.prototype.base=this.scale.endPoint;this.eachBars(function(bar,index,datasetIndex){helpers.extend(bar,{width:this.scale.calculateBarWidth(this.datasets.length),x:this.scale.calculateBarX(this.datasets.length,datasetIndex,index),y:this.scale.endPoint});bar.save();},this);this.render();},update:function(){this.scale.update();helpers.each(this.activeElements,function(activeElement){activeElement.restore(['fillColor','strokeColor']);});this.eachBars(function(bar){bar.save();});this.render();},eachBars:function(callback){helpers.each(this.datasets,function(dataset,datasetIndex){helpers.each(dataset.bars,callback,this,datasetIndex);},this);},getBarsAtEvent:function(e){var barsArray=[],eventPosition=helpers.getRelativePosition(e),datasetIterator=function(dataset){barsArray.push(dataset.bars[barIndex]);},barIndex;for(var datasetIndex=0;datasetIndex<this.datasets.length;datasetIndex++){for(barIndex=0;barIndex<this.datasets[datasetIndex].bars.length;barIndex++){if(this.datasets[datasetIndex].bars[barIndex].inRange(eventPosition.x,eventPosition.y)){helpers.each(this.datasets,datasetIterator);return barsArray;}}}
return barsArray;},buildScale:function(labels){var self=this;var dataTotal=function(){var values=[];self.eachBars(function(bar){values.push(bar.value);});return values;};var scaleOptions={templateString:this.options.scaleLabel,height:this.chart.height,width:this.chart.width,ctx:this.chart.ctx,textColor:this.options.scaleFontColor,fontSize:this.options.scaleFontSize,fontStyle:this.options.scaleFontStyle,fontFamily:this.options.scaleFontFamily,valuesCount:labels.length,beginAtZero:this.options.scaleBeginAtZero,integersOnly:this.options.scaleIntegersOnly,calculateYRange:function(currentHeight){var updatedRanges=helpers.calculateScaleRange(dataTotal(),currentHeight,this.fontSize,this.beginAtZero,this.integersOnly);helpers.extend(this,updatedRanges);},xLabels:labels,font:helpers.fontString(this.options.scaleFontSize,this.options.scaleFontStyle,this.options.scaleFontFamily),lineWidth:this.options.scaleLineWidth,lineColor:this.options.scaleLineColor,gridLineWidth:(this.options.scaleShowGridLines)?this.options.scaleGridLineWidth:0,gridLineColor:(this.options.scaleShowGridLines)?this.options.scaleGridLineColor:"rgba(0,0,0,0)",padding:(this.options.showScale)?0:(this.options.barShowStroke)?this.options.barStrokeWidth:0,showLabels:this.options.scaleShowLabels,display:this.options.showScale};if(this.options.scaleOverride){helpers.extend(scaleOptions,{calculateYRange:helpers.noop,steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+(this.options.scaleSteps*this.options.scaleStepWidth)});}
this.scale=new this.ScaleClass(scaleOptions);},addData:function(valuesArray,label){helpers.each(valuesArray,function(value,datasetIndex){this.datasets[datasetIndex].bars.push(new this.BarClass({value:value,label:label,x:this.scale.calculateBarX(this.datasets.length,datasetIndex,this.scale.valuesCount+1),y:this.scale.endPoint,width:this.scale.calculateBarWidth(this.datasets.length),base:this.scale.endPoint,strokeColor:this.datasets[datasetIndex].strokeColor,fillColor:this.datasets[datasetIndex].fillColor}));},this);this.scale.addXLabel(label);this.update();},removeData:function(){this.scale.removeXLabel();helpers.each(this.datasets,function(dataset){dataset.bars.shift();},this);this.update();},reflow:function(){helpers.extend(this.BarClass.prototype,{y:this.scale.endPoint,base:this.scale.endPoint});var newScaleProps=helpers.extend({height:this.chart.height,width:this.chart.width});this.scale.update(newScaleProps);},draw:function(ease){var easingDecimal=ease||1;this.clear();var ctx=this.chart.ctx;this.scale.draw(easingDecimal);helpers.each(this.datasets,function(dataset,datasetIndex){helpers.each(dataset.bars,function(bar,index){if(bar.hasValue()){bar.base=this.scale.endPoint;bar.transition({x:this.scale.calculateBarX(this.datasets.length,datasetIndex,index),y:this.scale.calculateY(bar.value),width:this.scale.calculateBarWidth(this.datasets.length)},easingDecimal).draw();}},this);},this);}});}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={segmentShowStroke:true,segmentStrokeColor:"#fff",segmentStrokeWidth:2,percentageInnerCutout:50,animationSteps:100,animationEasing:"easeOutBounce",animateRotate:true,animateScale:false,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<segments.length; i++){%><li><span style=\"background-color:<%=segments[i].fillColor%>\"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>"};Chart.Type.extend({name:"Doughnut",defaults:defaultConfig,initialize:function(data){this.segments=[];this.outerRadius=(helpers.min([this.chart.width,this.chart.height])-this.options.segmentStrokeWidth/2)/2;this.SegmentArc=Chart.Arc.extend({ctx:this.chart.ctx,x:this.chart.width/2,y:this.chart.height/2});if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activeSegments=(evt.type!=='mouseout')?this.getSegmentsAtEvent(evt):[];helpers.each(this.segments,function(segment){segment.restore(["fillColor"]);});helpers.each(activeSegments,function(activeSegment){activeSegment.fillColor=activeSegment.highlightColor;});this.showTooltip(activeSegments);});}
this.calculateTotal(data);helpers.each(data,function(datapoint,index){this.addData(datapoint,index,true);},this);this.render();},getSegmentsAtEvent:function(e){var segmentsArray=[];var location=helpers.getRelativePosition(e);helpers.each(this.segments,function(segment){if(segment.inRange(location.x,location.y))segmentsArray.push(segment);},this);return segmentsArray;},addData:function(segment,atIndex,silent){var index=atIndex||this.segments.length;this.segments.splice(index,0,new this.SegmentArc({value:segment.value,outerRadius:(this.options.animateScale)?0:this.outerRadius,innerRadius:(this.options.animateScale)?0:(this.outerRadius/100)*this.options.percentageInnerCutout,fillColor:segment.color,highlightColor:segment.highlight||segment.color,showStroke:this.options.segmentShowStroke,strokeWidth:this.options.segmentStrokeWidth,strokeColor:this.options.segmentStrokeColor,startAngle:Math.PI*1.5,circumference:(this.options.animateRotate)?0:this.calculateCircumference(segment.value),label:segment.label}));if(!silent){this.reflow();this.update();}},calculateCircumference:function(value){return(Math.PI*2)*(value/this.total);},calculateTotal:function(data){this.total=0;helpers.each(data,function(segment){this.total+=segment.value;},this);},update:function(){this.calculateTotal(this.segments);helpers.each(this.activeElements,function(activeElement){activeElement.restore(['fillColor']);});helpers.each(this.segments,function(segment){segment.save();});this.render();},removeData:function(atIndex){var indexToDelete=(helpers.isNumber(atIndex))?atIndex:this.segments.length-1;this.segments.splice(indexToDelete,1);this.reflow();this.update();},reflow:function(){helpers.extend(this.SegmentArc.prototype,{x:this.chart.width/2,y:this.chart.height/2});this.outerRadius=(helpers.min([this.chart.width,this.chart.height])-this.options.segmentStrokeWidth/2)/2;helpers.each(this.segments,function(segment){segment.update({outerRadius:this.outerRadius,innerRadius:(this.outerRadius/100)*this.options.percentageInnerCutout});},this);},draw:function(easeDecimal){var animDecimal=(easeDecimal)?easeDecimal:1;this.clear();helpers.each(this.segments,function(segment,index){segment.transition({circumference:this.calculateCircumference(segment.value),outerRadius:this.outerRadius,innerRadius:(this.outerRadius/100)*this.options.percentageInnerCutout},animDecimal);segment.endAngle=segment.startAngle+segment.circumference;segment.draw();if(index===0){segment.startAngle=Math.PI*1.5;}
if(index<this.segments.length-1){this.segments[index+1].startAngle=segment.endAngle;}},this);}});Chart.types.Doughnut.extend({name:"Pie",defaults:helpers.merge(defaultConfig,{percentageInnerCutout:0})});}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={scaleShowGridLines:true,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:true,bezierCurveTension:0.4,pointDot:true,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:20,datasetStroke:true,datasetStrokeWidth:2,datasetFill:true,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].strokeColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"};Chart.Type.extend({name:"Line",defaults:defaultConfig,initialize:function(data){this.PointClass=Chart.Point.extend({strokeWidth:this.options.pointDotStrokeWidth,radius:this.options.pointDotRadius,display:this.options.pointDot,hitDetectionRadius:this.options.pointHitDetectionRadius,ctx:this.chart.ctx,inRange:function(mouseX){return(Math.pow(mouseX-this.x,2)<Math.pow(this.radius+this.hitDetectionRadius,2));}});this.datasets=[];if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activePoints=(evt.type!=='mouseout')?this.getPointsAtEvent(evt):[];this.eachPoints(function(point){point.restore(['fillColor','strokeColor']);});helpers.each(activePoints,function(activePoint){activePoint.fillColor=activePoint.highlightFill;activePoint.strokeColor=activePoint.highlightStroke;});this.showTooltip(activePoints);});}
helpers.each(data.datasets,function(dataset){var datasetObject={label:dataset.label||null,fillColor:dataset.fillColor,strokeColor:dataset.strokeColor,pointColor:dataset.pointColor,pointStrokeColor:dataset.pointStrokeColor,points:[]};this.datasets.push(datasetObject);helpers.each(dataset.data,function(dataPoint,index){datasetObject.points.push(new this.PointClass({value:dataPoint,label:data.labels[index],datasetLabel:dataset.label,strokeColor:dataset.pointStrokeColor,fillColor:dataset.pointColor,highlightFill:dataset.pointHighlightFill||dataset.pointColor,highlightStroke:dataset.pointHighlightStroke||dataset.pointStrokeColor}));},this);this.buildScale(data.labels);this.eachPoints(function(point,index){helpers.extend(point,{x:this.scale.calculateX(index),y:this.scale.endPoint});point.save();},this);},this);this.render();},update:function(){this.scale.update();helpers.each(this.activeElements,function(activeElement){activeElement.restore(['fillColor','strokeColor']);});this.eachPoints(function(point){point.save();});this.render();},eachPoints:function(callback){helpers.each(this.datasets,function(dataset){helpers.each(dataset.points,callback,this);},this);},getPointsAtEvent:function(e){var pointsArray=[],eventPosition=helpers.getRelativePosition(e);helpers.each(this.datasets,function(dataset){helpers.each(dataset.points,function(point){if(point.inRange(eventPosition.x,eventPosition.y))pointsArray.push(point);});},this);return pointsArray;},buildScale:function(labels){var self=this;var dataTotal=function(){var values=[];self.eachPoints(function(point){values.push(point.value);});return values;};var scaleOptions={templateString:this.options.scaleLabel,height:this.chart.height,width:this.chart.width,ctx:this.chart.ctx,textColor:this.options.scaleFontColor,fontSize:this.options.scaleFontSize,fontStyle:this.options.scaleFontStyle,fontFamily:this.options.scaleFontFamily,valuesCount:labels.length,beginAtZero:this.options.scaleBeginAtZero,integersOnly:this.options.scaleIntegersOnly,calculateYRange:function(currentHeight){var updatedRanges=helpers.calculateScaleRange(dataTotal(),currentHeight,this.fontSize,this.beginAtZero,this.integersOnly);helpers.extend(this,updatedRanges);},xLabels:labels,font:helpers.fontString(this.options.scaleFontSize,this.options.scaleFontStyle,this.options.scaleFontFamily),lineWidth:this.options.scaleLineWidth,lineColor:this.options.scaleLineColor,gridLineWidth:(this.options.scaleShowGridLines)?this.options.scaleGridLineWidth:0,gridLineColor:(this.options.scaleShowGridLines)?this.options.scaleGridLineColor:"rgba(0,0,0,0)",padding:(this.options.showScale)?0:this.options.pointDotRadius+this.options.pointDotStrokeWidth,showLabels:this.options.scaleShowLabels,display:this.options.showScale};if(this.options.scaleOverride){helpers.extend(scaleOptions,{calculateYRange:helpers.noop,steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+(this.options.scaleSteps*this.options.scaleStepWidth)});}
this.scale=new Chart.Scale(scaleOptions);},addData:function(valuesArray,label){helpers.each(valuesArray,function(value,datasetIndex){this.datasets[datasetIndex].points.push(new this.PointClass({value:value,label:label,x:this.scale.calculateX(this.scale.valuesCount+1),y:this.scale.endPoint,strokeColor:this.datasets[datasetIndex].pointStrokeColor,fillColor:this.datasets[datasetIndex].pointColor}));},this);this.scale.addXLabel(label);this.update();},removeData:function(){this.scale.removeXLabel();helpers.each(this.datasets,function(dataset){dataset.points.shift();},this);this.update();},reflow:function(){var newScaleProps=helpers.extend({height:this.chart.height,width:this.chart.width});this.scale.update(newScaleProps);},draw:function(ease){var easingDecimal=ease||1;this.clear();var ctx=this.chart.ctx;var hasValue=function(item){return item.value!==null;},nextPoint=function(point,collection,index){return helpers.findNextWhere(collection,hasValue,index)||point;},previousPoint=function(point,collection,index){return helpers.findPreviousWhere(collection,hasValue,index)||point;};this.scale.draw(easingDecimal);helpers.each(this.datasets,function(dataset){var pointsWithValues=helpers.where(dataset.points,hasValue);helpers.each(dataset.points,function(point,index){if(point.hasValue()){point.transition({y:this.scale.calculateY(point.value),x:this.scale.calculateX(index)},easingDecimal);}},this);if(this.options.bezierCurve){helpers.each(pointsWithValues,function(point,index){var tension=(index>0&&index<pointsWithValues.length-1)?this.options.bezierCurveTension:0;point.controlPoints=helpers.splineCurve(previousPoint(point,pointsWithValues,index),point,nextPoint(point,pointsWithValues,index),tension);if(point.controlPoints.outer.y>this.scale.endPoint){point.controlPoints.outer.y=this.scale.endPoint;}
else if(point.controlPoints.outer.y<this.scale.startPoint){point.controlPoints.outer.y=this.scale.startPoint;}
if(point.controlPoints.inner.y>this.scale.endPoint){point.controlPoints.inner.y=this.scale.endPoint;}
else if(point.controlPoints.inner.y<this.scale.startPoint){point.controlPoints.inner.y=this.scale.startPoint;}},this);}
ctx.lineWidth=this.options.datasetStrokeWidth;ctx.strokeStyle=dataset.strokeColor;ctx.beginPath();helpers.each(pointsWithValues,function(point,index){if(index===0){ctx.moveTo(point.x,point.y);}
else{if(this.options.bezierCurve){var previous=previousPoint(point,pointsWithValues,index);ctx.bezierCurveTo(previous.controlPoints.outer.x,previous.controlPoints.outer.y,point.controlPoints.inner.x,point.controlPoints.inner.y,point.x,point.y);}
else{ctx.lineTo(point.x,point.y);}}},this);ctx.stroke();if(this.options.datasetFill&&pointsWithValues.length>0){ctx.lineTo(pointsWithValues[pointsWithValues.length-1].x,this.scale.endPoint);ctx.lineTo(pointsWithValues[0].x,this.scale.endPoint);ctx.fillStyle=dataset.fillColor;ctx.closePath();ctx.fill();}
helpers.each(pointsWithValues,function(point){point.draw();});},this);}});}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;var defaultConfig={scaleShowLabelBackdrop:true,scaleBackdropColor:"rgba(255,255,255,0.75)",scaleBeginAtZero:true,scaleBackdropPaddingY:2,scaleBackdropPaddingX:2,scaleShowLine:true,segmentShowStroke:true,segmentStrokeColor:"#fff",segmentStrokeWidth:2,animationSteps:100,animationEasing:"easeOutBounce",animateRotate:true,animateScale:false,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<segments.length; i++){%><li><span style=\"background-color:<%=segments[i].fillColor%>\"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>"};Chart.Type.extend({name:"PolarArea",defaults:defaultConfig,initialize:function(data){this.segments=[];this.SegmentArc=Chart.Arc.extend({showStroke:this.options.segmentShowStroke,strokeWidth:this.options.segmentStrokeWidth,strokeColor:this.options.segmentStrokeColor,ctx:this.chart.ctx,innerRadius:0,x:this.chart.width/2,y:this.chart.height/2});this.scale=new Chart.RadialScale({display:this.options.showScale,fontStyle:this.options.scaleFontStyle,fontSize:this.options.scaleFontSize,fontFamily:this.options.scaleFontFamily,fontColor:this.options.scaleFontColor,showLabels:this.options.scaleShowLabels,showLabelBackdrop:this.options.scaleShowLabelBackdrop,backdropColor:this.options.scaleBackdropColor,backdropPaddingY:this.options.scaleBackdropPaddingY,backdropPaddingX:this.options.scaleBackdropPaddingX,lineWidth:(this.options.scaleShowLine)?this.options.scaleLineWidth:0,lineColor:this.options.scaleLineColor,lineArc:true,width:this.chart.width,height:this.chart.height,xCenter:this.chart.width/2,yCenter:this.chart.height/2,ctx:this.chart.ctx,templateString:this.options.scaleLabel,valuesCount:data.length});this.updateScaleRange(data);this.scale.update();helpers.each(data,function(segment,index){this.addData(segment,index,true);},this);if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activeSegments=(evt.type!=='mouseout')?this.getSegmentsAtEvent(evt):[];helpers.each(this.segments,function(segment){segment.restore(["fillColor"]);});helpers.each(activeSegments,function(activeSegment){activeSegment.fillColor=activeSegment.highlightColor;});this.showTooltip(activeSegments);});}
this.render();},getSegmentsAtEvent:function(e){var segmentsArray=[];var location=helpers.getRelativePosition(e);helpers.each(this.segments,function(segment){if(segment.inRange(location.x,location.y))segmentsArray.push(segment);},this);return segmentsArray;},addData:function(segment,atIndex,silent){var index=atIndex||this.segments.length;this.segments.splice(index,0,new this.SegmentArc({fillColor:segment.color,highlightColor:segment.highlight||segment.color,label:segment.label,value:segment.value,outerRadius:(this.options.animateScale)?0:this.scale.calculateCenterOffset(segment.value),circumference:(this.options.animateRotate)?0:this.scale.getCircumference(),startAngle:Math.PI*1.5}));if(!silent){this.reflow();this.update();}},removeData:function(atIndex){var indexToDelete=(helpers.isNumber(atIndex))?atIndex:this.segments.length-1;this.segments.splice(indexToDelete,1);this.reflow();this.update();},calculateTotal:function(data){this.total=0;helpers.each(data,function(segment){this.total+=segment.value;},this);this.scale.valuesCount=this.segments.length;},updateScaleRange:function(datapoints){var valuesArray=[];helpers.each(datapoints,function(segment){valuesArray.push(segment.value);});var scaleSizes=(this.options.scaleOverride)?{steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+(this.options.scaleSteps*this.options.scaleStepWidth)}:helpers.calculateScaleRange(valuesArray,helpers.min([this.chart.width,this.chart.height])/2,this.options.scaleFontSize,this.options.scaleBeginAtZero,this.options.scaleIntegersOnly);helpers.extend(this.scale,scaleSizes,{size:helpers.min([this.chart.width,this.chart.height]),xCenter:this.chart.width/2,yCenter:this.chart.height/2});},update:function(){this.calculateTotal(this.segments);helpers.each(this.segments,function(segment){segment.save();});this.render();},reflow:function(){helpers.extend(this.SegmentArc.prototype,{x:this.chart.width/2,y:this.chart.height/2});this.updateScaleRange(this.segments);this.scale.update();helpers.extend(this.scale,{xCenter:this.chart.width/2,yCenter:this.chart.height/2});helpers.each(this.segments,function(segment){segment.update({outerRadius:this.scale.calculateCenterOffset(segment.value)});},this);},draw:function(ease){var easingDecimal=ease||1;this.clear();helpers.each(this.segments,function(segment,index){segment.transition({circumference:this.scale.getCircumference(),outerRadius:this.scale.calculateCenterOffset(segment.value)},easingDecimal);segment.endAngle=segment.startAngle+segment.circumference;if(index===0){segment.startAngle=Math.PI*1.5;}
if(index<this.segments.length-1){this.segments[index+1].startAngle=segment.endAngle;}
segment.draw();},this);this.scale.draw();}});}).call(this);(function(){"use strict";var root=this,Chart=root.Chart,helpers=Chart.helpers;Chart.Type.extend({name:"Radar",defaults:{scaleShowLine:true,angleShowLineOut:true,scaleShowLabels:false,scaleBeginAtZero:true,angleLineColor:"rgba(0,0,0,.1)",angleLineWidth:1,pointLabelFontFamily:"'Arial'",pointLabelFontStyle:"normal",pointLabelFontSize:10,pointLabelFontColor:"#666",pointDot:true,pointDotRadius:3,pointDotStrokeWidth:1,pointHitDetectionRadius:20,datasetStroke:true,datasetStrokeWidth:2,datasetFill:true,legendTemplate:"<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].strokeColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"},initialize:function(data){this.PointClass=Chart.Point.extend({strokeWidth:this.options.pointDotStrokeWidth,radius:this.options.pointDotRadius,display:this.options.pointDot,hitDetectionRadius:this.options.pointHitDetectionRadius,ctx:this.chart.ctx});this.datasets=[];this.buildScale(data);if(this.options.showTooltips){helpers.bindEvents(this,this.options.tooltipEvents,function(evt){var activePointsCollection=(evt.type!=='mouseout')?this.getPointsAtEvent(evt):[];this.eachPoints(function(point){point.restore(['fillColor','strokeColor']);});helpers.each(activePointsCollection,function(activePoint){activePoint.fillColor=activePoint.highlightFill;activePoint.strokeColor=activePoint.highlightStroke;});this.showTooltip(activePointsCollection);});}
helpers.each(data.datasets,function(dataset){var datasetObject={label:dataset.label||null,fillColor:dataset.fillColor,strokeColor:dataset.strokeColor,pointColor:dataset.pointColor,pointStrokeColor:dataset.pointStrokeColor,points:[]};this.datasets.push(datasetObject);helpers.each(dataset.data,function(dataPoint,index){var pointPosition;if(!this.scale.animation){pointPosition=this.scale.getPointPosition(index,this.scale.calculateCenterOffset(dataPoint));}
datasetObject.points.push(new this.PointClass({value:dataPoint,label:data.labels[index],datasetLabel:dataset.label,x:(this.options.animation)?this.scale.xCenter:pointPosition.x,y:(this.options.animation)?this.scale.yCenter:pointPosition.y,strokeColor:dataset.pointStrokeColor,fillColor:dataset.pointColor,highlightFill:dataset.pointHighlightFill||dataset.pointColor,highlightStroke:dataset.pointHighlightStroke||dataset.pointStrokeColor}));},this);},this);this.render();},eachPoints:function(callback){helpers.each(this.datasets,function(dataset){helpers.each(dataset.points,callback,this);},this);},getPointsAtEvent:function(evt){var mousePosition=helpers.getRelativePosition(evt),fromCenter=helpers.getAngleFromPoint({x:this.scale.xCenter,y:this.scale.yCenter},mousePosition);var anglePerIndex=(Math.PI*2)/this.scale.valuesCount,pointIndex=Math.round((fromCenter.angle-Math.PI*1.5)/anglePerIndex),activePointsCollection=[];if(pointIndex>=this.scale.valuesCount||pointIndex<0){pointIndex=0;}
if(fromCenter.distance<=this.scale.drawingArea){helpers.each(this.datasets,function(dataset){activePointsCollection.push(dataset.points[pointIndex]);});}
return activePointsCollection;},buildScale:function(data){this.scale=new Chart.RadialScale({display:this.options.showScale,fontStyle:this.options.scaleFontStyle,fontSize:this.options.scaleFontSize,fontFamily:this.options.scaleFontFamily,fontColor:this.options.scaleFontColor,showLabels:this.options.scaleShowLabels,showLabelBackdrop:this.options.scaleShowLabelBackdrop,backdropColor:this.options.scaleBackdropColor,backdropPaddingY:this.options.scaleBackdropPaddingY,backdropPaddingX:this.options.scaleBackdropPaddingX,lineWidth:(this.options.scaleShowLine)?this.options.scaleLineWidth:0,lineColor:this.options.scaleLineColor,angleLineColor:this.options.angleLineColor,angleLineWidth:(this.options.angleShowLineOut)?this.options.angleLineWidth:0,pointLabelFontColor:this.options.pointLabelFontColor,pointLabelFontSize:this.options.pointLabelFontSize,pointLabelFontFamily:this.options.pointLabelFontFamily,pointLabelFontStyle:this.options.pointLabelFontStyle,height:this.chart.height,width:this.chart.width,xCenter:this.chart.width/2,yCenter:this.chart.height/2,ctx:this.chart.ctx,templateString:this.options.scaleLabel,labels:data.labels,valuesCount:data.datasets[0].data.length});this.scale.setScaleSize();this.updateScaleRange(data.datasets);this.scale.buildYLabels();},updateScaleRange:function(datasets){var valuesArray=(function(){var totalDataArray=[];helpers.each(datasets,function(dataset){if(dataset.data){totalDataArray=totalDataArray.concat(dataset.data);}
else{helpers.each(dataset.points,function(point){totalDataArray.push(point.value);});}});return totalDataArray;})();var scaleSizes=(this.options.scaleOverride)?{steps:this.options.scaleSteps,stepValue:this.options.scaleStepWidth,min:this.options.scaleStartValue,max:this.options.scaleStartValue+(this.options.scaleSteps*this.options.scaleStepWidth)}:helpers.calculateScaleRange(valuesArray,helpers.min([this.chart.width,this.chart.height])/2,this.options.scaleFontSize,this.options.scaleBeginAtZero,this.options.scaleIntegersOnly);helpers.extend(this.scale,scaleSizes);},addData:function(valuesArray,label){this.scale.valuesCount++;helpers.each(valuesArray,function(value,datasetIndex){var pointPosition=this.scale.getPointPosition(this.scale.valuesCount,this.scale.calculateCenterOffset(value));this.datasets[datasetIndex].points.push(new this.PointClass({value:value,label:label,x:pointPosition.x,y:pointPosition.y,strokeColor:this.datasets[datasetIndex].pointStrokeColor,fillColor:this.datasets[datasetIndex].pointColor}));},this);this.scale.labels.push(label);this.reflow();this.update();},removeData:function(){this.scale.valuesCount--;this.scale.labels.shift();helpers.each(this.datasets,function(dataset){dataset.points.shift();},this);this.reflow();this.update();},update:function(){this.eachPoints(function(point){point.save();});this.reflow();this.render();},reflow:function(){helpers.extend(this.scale,{width:this.chart.width,height:this.chart.height,size:helpers.min([this.chart.width,this.chart.height]),xCenter:this.chart.width/2,yCenter:this.chart.height/2});this.updateScaleRange(this.datasets);this.scale.setScaleSize();this.scale.buildYLabels();},draw:function(ease){var easeDecimal=ease||1,ctx=this.chart.ctx;this.clear();this.scale.draw();helpers.each(this.datasets,function(dataset){helpers.each(dataset.points,function(point,index){if(point.hasValue()){point.transition(this.scale.getPointPosition(index,this.scale.calculateCenterOffset(point.value)),easeDecimal);}},this);ctx.lineWidth=this.options.datasetStrokeWidth;ctx.strokeStyle=dataset.strokeColor;ctx.beginPath();helpers.each(dataset.points,function(point,index){if(index===0){ctx.moveTo(point.x,point.y);}
else{ctx.lineTo(point.x,point.y);}},this);ctx.closePath();ctx.stroke();ctx.fillStyle=dataset.fillColor;ctx.fill();helpers.each(dataset.points,function(point){if(point.hasValue()){point.draw();}});},this);}});}).call(this);﻿
var TimeShaft=(function(){function TimeShaft(_parent){this.parent=_parent;this.containerHeight=100;this.pointList=undefined;this.timeShaftLabel=undefined;this.dictData=undefined;this.startTime=undefined;this.endTime=undefined;this.tbCurrentTime=undefined;this.playHandle=undefined;this.isPlaying=false;this.playInterval=1000;this.$inputInterval=undefined;var _this=this;this.defer=$.Deferred();}
TimeShaft.prototype={show:function(){var _this=this;WebAPI.get("/static/views/observer/widgets/timeShaft.html").done(function(resultHtml){_this.resultHtml=resultHtml;_this.defer.resolve();});$.when(this.defer).done(function(){_this.parent.toolContainer.html(_this.resultHtml);_this.parent.toolContainer.animate({height:_this.containerHeight+'px'},200);_this.init();I18n.fillArea(_this.parent.toolContainer);});},close:function(){if(this.parent.toolContainer)this.parent.toolContainer.html('');this.parent=null;this.containerHeight=null;this.pointList=null;this.timeShaftLabel=null;this.dictData=null;this.tbCurrentTime=null;if(this.playHandle)clearInterval(this.playHandle);this.playHandle=null;this.resultHtml=null;},init:function(){var _this=this;this.tbCurrentTime=document.getElementById('txtCurrentTime');this.$inputInterval=$('#inputInterval');WebAPI.get("/get_history_data/getMinPeriod/"+AppConfig.projectId).done(function(result){var dataSrc=JSON.parse(result);if(undefined==dataSrc)
return;if(dataSrc['minPeriod']!='m1')
_this.$inputInterval.children(':first').css('display','none');else
_this.$inputInterval.children(':first').css('display','block');});var now=new Date();this.startTime=new Date(now-86400000);this.endTime=now;$("#txtTimeStart").val(this.startTime.format("yyyy-MM-dd HH:mm"));$("#txtTimeEnd").val(this.endTime.format("yyyy-MM-dd HH:mm"));_this.refreshCalendar();$("#select_id option[index='0']").prop("selected",'selected');_this.$inputInterval.off('change').change(function(){_this.refreshCalendar();});$('#divFramesConfig a[elapse]').off('click').click(function(e){var timeBaseline,timeFlags;timeFlags=e.currentTarget.attributes['elapse'].value.split(',');if(timeFlags.length==2){timeBaseline=+new Date();timeBaseline=timeBaseline+(new Date()).getTimezoneOffset()*60000-timeBaseline%86400000;var end=new Date(timeBaseline+parseInt(timeFlags[1])-1000);var now=new Date();_this.endTime=end>now?now:end;_this.startTime=new Date(timeBaseline+parseInt(timeFlags[0]));}else{var time=new Date();if(timeFlags[0]=='thisWeek'){time.setDate(time.getDate()-time.getDay());time.setHours(0);time.setMinutes(0);time.setSeconds(0);_this.endTime=new Date();_this.startTime=time;}else if(timeFlags[0]=='lastWeek'){time.setDate(time.getDate()-time.getDay()-7);time.setHours(0);time.setMinutes(0);time.setSeconds(0);_this.startTime=time;_this.endTime=new Date(time.getTime()+86400000*7);}}
_this.requestData(_this.startTime,_this.endTime);});$('#btnRquestHistory').off('click').click(function(e){_this.startTime=$("#txtTimeStart").val().toDate();_this.endTime=$("#txtTimeEnd").val().toDate();_this.requestData(_this.startTime,_this.endTime);});$("#btnPlay").off('click').click(function(e){if(_this.isPlaying){_this.stop();}else{_this.play();}});$("#btnPrevious").off('click').click(function(e){var element=$('#tabFrames .td-frame-selected');var label=$('#tabFrames .td-frame-selected').attr('title');if(label&&label!=''){var index=_this.timeShaftLabel.indexOf(label);if(index>0){_this.setActive(element.prev());_this.renderParentScreen(_this.timeShaftLabel[index-1]);if(index<2){this.classList.add('disabled');}
if(index<=(_this.timeShaftLabel.length-1)){$("#btnNext").removeClass('disabled');}}}});$("#btnNext").off('click').click(function(e){var element=$('#tabFrames .td-frame-selected');var label=$('#tabFrames .td-frame-selected').attr('title');if(label&&label!=''){var index=_this.timeShaftLabel.indexOf(label);if(index>-1&&index<(_this.timeShaftLabel.length-1)){_this.setActive(element.next());_this.renderParentScreen(_this.timeShaftLabel[index+1]);if(index>(_this.timeShaftLabel.length-3)){this.classList.add('disabled');}
if(index>=0){$('#btnPrevious').removeClass('disabled');}}}});var $intervalTimes=$('#intervalTimes');$("#btnTime").off('click').click(function(e){$intervalTimes.prev('div').hide();$intervalTimes.show();});$intervalTimes.children('span').off('click').click(function(){$intervalTimes.prev('div').show();$intervalTimes.hide();_this.playInterval=parseInt($(this).attr('time'))*1000;if(_this.isPlaying){_this.stop();_this.play();}});$("#btnConfig").click(function(e){$('#divFramesConfig').show();$('#divPaneFrames').hide();});},showFramePane:function(){$('#divFramesConfig').hide();$('#divPaneFrames').show();},requestData:function(startTime,endTime,screen,isPlayTheCenterFrame){var _this=this;if(startTime>endTime){alert('Time range error.')
return;}
this.startTime=startTime;this.endTime=endTime;_this.refreshCalendar();var timeStepSelectedValue=_this.$inputInterval.val();var data={projectId:AppConfig.projectId,timeStart:startTime.format("yyyy-MM-dd HH:mm:ss"),timeEnd:endTime.format("yyyy-MM-dd HH:mm:ss"),timeFormat:timeStepSelectedValue,pointList:Object.keys(screen?screen.dictRefreshMap:this.parent.dictRefreshMap)};Spinner.spin(ElScreenContainer);WebAPI.post("/get_history_data_padded_reduce",data).done(function(result){var dataSrc=JSON.parse(result);if(dataSrc==undefined||!dataSrc.timeStamp){alert('no history data');return;}
if(screen){_this.renderCurrentMoment(screen,dataSrc);}else{_this.initData(dataSrc);_this.initTimeShaft();$('#divFramesConfig').hide();$('#divPaneFrames').show();isPlayTheCenterFrame&&ToolCurrent.playTheCenterMoment();}}).always(function(){Spinner.stop();});},returnToMoment:function(time,screen){var screen=screen?screen:this.parent;this.requestData(time,time,screen);},requestDataForCurrentMoment:function(screen){var time=this.tbCurrentTime.value.toDate();this.requestData(time,time,screen);},renderCurrentMoment:function(screen,dataSrc){var arrData=[];for(var key in dataSrc.data){arrData.push({name:key,value:dataSrc.data[key][0]});}
screen.renderData(arrData);},initData:function(dataSrc){if(undefined==dataSrc.data)return;this.timeShaftLabel=new Array();this.dictData=new Object();if(this.timeShaftLabel.length==0){for(var i=0,len=dataSrc.timeStamp.length;i<len;i++){var time=dataSrc.timeStamp[i].toDate().format("yyyy-MM-dd HH:mm");this.timeShaftLabel.push(time);this.dictData[time]=new Array();}}
var name,val,time;for(var key in dataSrc.data){name=key;for(var i=0,len=dataSrc.timeStamp.length;i<len;i++){var time=dataSrc.timeStamp[i].toDate().format("yyyy-MM-dd HH:mm");this.dictData[time].push({name:name,value:dataSrc.data[key][i]});}}},planTdColSpan:function(){var _this=this;var labels=this.timeShaftLabel;var iptIntlVal=_this.$inputInterval.val();if(iptIntlVal=='m5'){var tempMinute='';this.dictMinute={};for(var i=0;i<labels.length;i++){var labelMinute=labels[i];if(tempMinute!=labelMinute.split(':')[0]){tempMinute=labelMinute.split(':')[0];this.dictMinute[tempMinute]=1;}else{this.dictMinute[tempMinute]++;}}}else if(iptIntlVal=='h1'){var tempHour='';this.dictHour={};for(var i=0;i<labels.length;i++){var labelHour=labels[i];if(tempHour!=labelHour.split(' ')[0]){tempHour=labelHour.split(' ')[0];this.dictHour[tempHour]=1;}else{this.dictHour[tempHour]++;}}}else if(iptIntlVal=='d1'){var tempDay='';this.dictDay={};for(var i=0;i<labels.length;i++){var labelDay=labels[i];var secondHrPost=labelDay.indexOf('-',labelDay.indexOf('-')+1);if(tempDay!=labelDay.substring(0,secondHrPost)){tempDay=labelDay.substring(0,secondHrPost);this.dictDay[tempDay]=1;}else{this.dictDay[tempDay]++;}}}else if(iptIntlVal=='M1'){var tempMouth='';this.dictMouth={};for(var i=0;i<labels.length;i++){var labelMouth=labels[i];if(tempMouth!=labelMouth.split('-')[0]){tempMouth=labelMouth.split('-')[0];this.dictMouth[tempMouth]=1;}else{this.dictMouth[tempMouth]++;}}}},addFirstTd:function(dict,label,trtop,iptIntvlVal){var _this=this;var tdContTotal=label.split(':')[0];td=document.createElement('td');td.className='td-border-split';$(td).css({'white-space':'nowrap'});if(iptIntvlVal=='m5'){td.textContent=tdContTotal+':00';}else if(iptIntvlVal=='h1'){td.textContent=tdContTotal.split(' ')[0];}else if(iptIntvlVal=='d1'){td.textContent=tdContTotal.split('-')[0]+'-'+tdContTotal.split('-')[1];}else{td.textContent=tdContTotal.split('-')[0];}
for(var temp in dict){var countTotal=dict[temp];if(td.textContent.split(':')[0]==temp){td.colSpan=countTotal;}}
trtop.appendChild(td);},initTimeShaft:function(){var _this=this;var trs=document.getElementById('tabFrames').getElementsByTagName('tr');var trTop=trs[0],trData=trs[1],trBottom=trs[2],td;var iptIntvlVal=_this.$inputInterval.val();trTop.innerHTML='';trData.innerHTML='';trBottom.innerHTML='';this.planTdColSpan();for(var i=0,count=1,len=this.timeShaftLabel.length;i<len;i++){var label=this.timeShaftLabel[i];if(iptIntvlVal=='m5'){if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].split(':')[1]!='00'&&i==0){this.addFirstTd(this.dictMinute,label,trTop,'m5');}else if((this.timeShaftLabel[i]&&this.timeShaftLabel[i].indexOf(':00')>=0)){this.addFirstTd(this.dictMinute,label,trTop,'m5');count=0;}}else if(iptIntvlVal=='h1'){if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].split(' ')[1]!='00:00'&&i==0){this.addFirstTd(this.dictHour,label,trTop,'h1');}else if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].indexOf('00:00')>=0){this.addFirstTd(this.dictHour,label,trTop,'h1');count=0;}}else if(iptIntvlVal=='d1'){if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].split('-')[2]!='01 00:00'&&i==0){this.addFirstTd(this.dictDay,label,trTop,'d1');}else if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].indexOf('01 00:00')>=0){this.addFirstTd(this.dictDay,label,trTop,'d1');count=0;}}else{if(this.timeShaftLabel[i]&&(this.timeShaftLabel[i].split('-')[1]+'-'+this.timeShaftLabel[i].split('-')[2])!='01-01 00:00'&&i==0){this.addFirstTd(this.dictMouth,label,trTop);}else if(this.timeShaftLabel[i]&&this.timeShaftLabel[i].indexOf('01-01 00:00')>=0){this.addFirstTd(this.dictMouth,label,trTop);count=0;}}
td=document.createElement('td');td.title=label;td.className='td-frame';if(i==0){td.classList.add('td-frame-selected');this.renderParentScreen(label);}
td.onclick=function(e){var target=e.currentTarget||e.target;_this.setActive($(target));_this.renderParentScreen(target.attributes['title'].value);_this.setBtnStatus();};trData.appendChild(td);td=document.createElement('td');td.className='td-border-split';if(iptIntvlVal=='m5'){td.textContent=label.split(':')[1];}else if(iptIntvlVal=='h1'){var hourThirdTd=label.split(':')[0];td.textContent=hourThirdTd.split(' ')[1].split(':')[0];}else if(iptIntvlVal=='d1'){var dayThirdTd=label.split(':')[0];td.textContent=dayThirdTd.split('-')[2].split(' ')[0];}else{var dayThirdTd=label.split(':')[0];td.textContent=dayThirdTd.split('-')[1];}
trBottom.appendChild(td);count++;}
this.setBtnStatus();},renderParentScreen:function(time){if(undefined==time){return;}
this.tbCurrentTime.value=time;this.parent.renderData(this.dictData[time]);},play:function(){var _this=this;this.isPlaying=true;var startTimeLabel;var selectedFrames=$('#tabFrames .td-frame-selected');if(selectedFrames.length>0){startTimeLabel=selectedFrames.first().attr('title')}else{startTimeLabel=this.timeShaftLabel[0];}
var index=this.timeShaftLabel.indexOf(startTimeLabel);this.playHandle=setInterval(function(e){if(index>_this.timeShaftLabel.length){_this.stop();}else{if(index<_this.timeShaftLabel.length-1){var element=$('#tabFrames .td-frame-selected').removeClass('td-frame-selected').next();element.addClass('td-frame-selected');}
_this.renderParentScreen(_this.timeShaftLabel[index]);index++;}},_this.playInterval);$('#btnPlay span').removeClass('glyphicon-play').addClass('glyphicon-pause');},stop:function(){this.isPlaying=false;if(this.playHandle)clearInterval(this.playHandle);$('#btnPlay span').removeClass('glyphicon-pause').addClass('glyphicon-play');},setActive:function(jqueryElement){$('#tabFrames .td-frame-selected').removeClass('td-frame-selected').next();jqueryElement.addClass('td-frame-selected');this.stop();},playTheCenterMoment:function(){var indexCenter=parseInt(this.timeShaftLabel.length/2);this.setActive($($('#tabFrames .td-frame')[indexCenter]));this.renderParentScreen(this.timeShaftLabel[indexCenter]);},setBtnStatus:function(){var $btnPre=$('#btnPrevious');var $btnNext=$('#btnNext');if($('#tabFrames tbody tr:nth-child(2) td:nth-child(1)')[0].className.indexOf('td-frame-selected')>-1){$btnPre.addClass('disabled');}else{$btnPre.removeClass('disabled');}
if($('#tabFrames tbody tr:nth-child(2) td:nth-last-child(1)')[0].className.indexOf('td-frame-selected')>-1){$btnNext.addClass('disabled');}else{$btnNext.removeClass('disabled');}},refreshCalendar:function(){var _this=this;if(_this.$inputInterval.val()=='M1'){$('.navbar-left .form_datetime').datetimepicker('remove');$(".navbar-left .form_datetime").datetimepicker({format:"yyyy-mm-dd 00:00",minView:"year",autoclose:true,todayBtn:true,pickerPosition:"top-right",startView:4,initialDate:new Date(),}).off('changeDate').on('changeDate',function(ev){var selectTime=(ev.date.valueOf().toDate().toUTCString().replace(' GMT','')).toDate().getTime();var time=selectTime-selectTime%(5*60*1000).toDate().format('yyyy-MM-dd HH:mm');$('#tabFrames .td-frame[title="'+time+'"]').click();});}else{$('.form_datetime').datetimepicker('remove');$(".form_datetime").datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:true,todayBtn:false,pickerPosition:"top-right",initialDate:new Date()}).off('changeDate').on('changeDate',function(ev){var selectTime=(ev.date.valueOf().toDate().toUTCString().replace(' GMT','')).toDate().getTime();var time=selectTime-selectTime%(5*60*1000).toDate().format('yyyy-MM-dd HH:mm');$('#tabFrames .td-frame[title="'+time+'"]').click();});}}};return TimeShaft;})();var TimeShaftDashboard=(function(){function TimeShaftDashboard(_parent){TimeShaft.call(_parent);this.parent=_parent;this.containerHeight=100;this.timeShaftLabel=undefined;this.dictData=undefined;this.startTime=undefined;this.endTime=undefined;this.tbCurrentTime=undefined;this.$inputInterval=undefined;var _this=this;this.defer=$.Deferred();WebAPI.get("/static/views/observer/widgets/timeShaft.html").done(function(resultHtml){_this.resultHtml=resultHtml;_this.defer.resolve();});}
TimeShaftDashboard.prototype=new TimeShaft();TimeShaftDashboard.prototype.show=function(){var _this=this;$.when(this.defer).done(function(){_this.parent.toolContainer.html(_this.resultHtml);_this.parent.toolContainer.css({height:_this.containerHeight+'px'});for(var key in _this.parent.listEntity){var echart=_this.parent.listEntity[key].chart;if(undefined!=echart){echart.resize();}}
_this.init();I18n.fillArea(_this.parent.toolContainer);});};TimeShaftDashboard.prototype.requestData=function(startTime,endTime,screen,isPlayTheCenterFrame){var _this=this;if(startTime>endTime){alert('Time range error.')
return;}
this.startTime=startTime;this.endTime=endTime;_this.refreshCalendar();if(undefined==_this.parent.store.dsInfoList){return;}
var dsIdList=[];for(var i=0,len=_this.parent.store.dsInfoList.length;i<len;i++){dsIdList.push(_this.parent.store.dsInfoList[i].id);}
var timeStepSelectedValue=_this.$inputInterval.val();var postData={dsItemIds:dsIdList,timeStart:startTime.format("yyyy-MM-dd HH:mm:ss"),timeEnd:endTime.format("yyyy-MM-dd HH:mm:ss"),timeFormat:timeStepSelectedValue}
Spinner.spin(ElScreenContainer);WebAPI.post("/analysis/startWorkspaceDataGenHistogram",postData).done(function(result){var dataSrc=JSON.parse(result);if(dataSrc==undefined||!dataSrc.timeShaft){alert('no history data');return;}
if(screen){_this.renderCurrentMoment(screen,dataSrc);}else{_this.initData(dataSrc);_this.initTimeShaft();$('#divFramesConfig').hide();$('#divPaneFrames').show();isPlayTheCenterFrame&&ToolCurrent.playTheCenterMoment();}}).always(function(){Spinner.stop();});};TimeShaftDashboard.prototype.initData=function(dataSrc){if(undefined==dataSrc.list)return;this.timeShaftLabel=new Array();this.dictData=new Object();if(this.timeShaftLabel.length==0){for(var i=0,len=dataSrc.timeShaft.length;i<len;i++){var time=dataSrc.timeShaft[i].toDate().format("yyyy-MM-dd HH:mm");this.timeShaftLabel.push(time);this.dictData[time]=new Array();}}
var name,time;for(var j=0,len2=dataSrc.list.length;j<len2;j++){name=dataSrc.list[j].dsItemId;for(var k=0,len3=dataSrc.timeShaft.length;k<len3;k++){time=dataSrc.timeShaft[k].toDate().format("yyyy-MM-dd HH:mm");this.dictData[time].push({dsItemId:name,data:dataSrc.list[j].data[k],time:time});}}};TimeShaftDashboard.prototype.renderParentScreen=function(time){if(undefined==time){return;}
this.tbCurrentTime.value=time;this.parent.renderData(this.dictData[time],new Date(time),this.startTime,this.endTime);};TimeShaftDashboard.prototype.setBtnStatus=function(){var $btnPre=$('#btnPrevious');var $btnNext=$('#btnNext');var child1=$('#tabFrames tbody tr:nth-child(2) td:nth-child(1)')[0];if(undefined!=child1){if(child1.className.indexOf('td-frame-selected')>-1){$btnPre.addClass('disabled');}else{$btnPre.removeClass('disabled');}}
var child2=$('#tabFrames tbody tr:nth-child(2) td:nth-last-child(1)')[0];if(undefined!=child2){if(child2.className.indexOf('td-frame-selected')>-1){$btnNext.addClass('disabled');}else{$btnNext.removeClass('disabled');}}};return TimeShaftDashboard;})();var ModalWiki=(function(){function ModalWiki(parent){this.parent=parent;this.$modal=undefined;this.$modalContent=undefined;this.searchWikis={};this.isManager=false;this.managerWikis={};var tempHtml='\
            <div class="modal fade in" id="modalWikiConfig" role="dialog" aria-labelledby="templateType" aria-hidden="false">\
                <div class="modal-dialog">\
                    <div class="modal-content">\
                    </div>\
                </div>\
            </div>';$('body').append(tempHtml);this.$modal=$('#modalWikiConfig');this.$modalContent=this.$modal.find('.modal-content');}
ModalWiki.prototype.show=function(){var _this=this;WebAPI.get('/static/scripts/observer/widgets/modalWiki.html').done(function(resultHTML){$(ElScreenContainer).html(resultHTML);_this.init();});}
ModalWiki.prototype.init=function(){var _this=this;var data={projectIds:this.getProjectIds()};WebAPI.post('/getAllWiki',data).done(function(result){var rlst=JSON.parse(result);if(rlst.length>0){var $divWiki=$('.divWiki'),temp='';for(var i=0,wiki;i<rlst.length;i++){wiki=rlst[i];if(!_this.managerWikis[wiki.id]){_this.managerWikis[wiki.id]=wiki;}
temp+=_this.tpl_wiki_mng.formatEL({id:wiki.id,title:wiki.title,tagArr:_this.addTagOfKewWord(wiki.tagStrArr),tagProjectArr:_this.addTagOfProject(wiki.tagProjectIdArr),modifyTime:wiki.modifyTime})}
$divWiki.html(temp);}else{alert('There is no wiki currently, you can create wiki.')}
_this.$wikiListPanel=$('#wikiListPanel');_this.isManager=true;_this.attachEvent();}).fail(function(){}).always(function(){});}
ModalWiki.prototype.close=function(){this.parent=null;this.$modal=null;this.$modalContent=null;this.searchWikis=null;this.isManager=null;this.managerWikis=null;}
ModalWiki.prototype.tpl_wiki_mng='\
        <div class="row" id="{id}">\
            <div class="col-xs-3">{id}</div>\
            <div class="col-xs-2">{title}</div>\
            <div class="col-xs-2">{tagArr}</div>\
            <div class="col-xs-2">{tagProjectArr}</div>\
            <div class="col-xs-2">{modifyTime}</div>\
            <div class="col-xs-1 btns">\
                <span class="glyphicon glyphicon-remove grow" title="Delete"></span>\
                <span class="glyphicon glyphicon-edit grow" title="Edit"></span>\
            </div>\
        </div>';ModalWiki.prototype.attachEvent=function(){var _this=this;this.$wikiListPanel.find('#mngCreateWiki').off('click').on('click',function(e){e.stopPropagation();_this.showWikiCreate();});this.$wikiListPanel.on('click','.glyphicon-edit',function(e){e.stopPropagation();_this.showWikiEdit(_this.managerWikis[$(this).closest('.row').attr('id')]);});this.$wikiListPanel.on('click','.glyphicon-remove',function(e){e.stopPropagation();_this.removeWiki($(this).closest('.row').attr('id'));});this.$wikiListPanel.on('click','.row',function(e){e.stopPropagation();_this.showWikiDetail(_this.managerWikis[$(this).attr('id')]);});}
ModalWiki.prototype.removeWiki=function(wikiId){if(confirm('Delete this wiki ?')){WebAPI.get('/deleteWiki/'+wikiId).done(function(result){$('#'+wikiId).remove();}).fail(function(){alert('delete failed !');});}}
ModalWiki.prototype.showWikiSearch=function(){var _this=this,$addWiki,$searchResultList,$configAlert;var tempHtml='\
            <div class="modal-header">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>\
                <h4 class="modal-title" id="" i18n="modalConfig.TITLE">Config Wiki</h4>\
            </div>\
            <div class="modal-body" id="">\
                <div class="bodyTop">\
                    <div class="">\
                        <div class="form-inline">\
                          <div class="form-group" style="width: 260px;">\
                            <label class="sr-only" for="wikiKeyWord"></label>\
                            <input type="text" class="form-control" id="wikiKeyWord" placeholder="Input Keyword" style="width: 100%;">\
                          </div>\
                          <div class="form-group">\
                            <label class="sr-only" for="wikiProject"></label>\
                            <select id="wikiProject" class="form-control">\
                            </select>\
                          </div>\
                          <button type="" class="btn btn-default" id="btnSearchWiki">Search</button>\
                        </div>\
                    </div>\
                </div>\
                <div class="bodyMiddle">\
                    <div class="searchResultCtn">\
                        <ul class="list-unstyled" id="searchResultList">\
                        </ul>\
                    </div>\
                </div>\
            </div>\
            <div class="modal-footer">\
                <div id="configAlert"></div>\
                <button type="button" class="btn btn-primary" id="addWiki" i18n="">Create</button>\
            </div>';this.$modalContent.html(tempHtml);this.$modalContent.find('#wikiProject').html(renderSelectProject())
$addWiki=this.$modal.find('#addWiki');$searchResultList=this.$modal.find('#searchResultList');$configAlert=_this.$modalContent.find("#configAlert");$addWiki.off().on('click',function(e){e.stopPropagation();_this.showWikiCreate();});this.$modalContent.find('#btnSearchWiki').click(function(){var selectPrj=$('#wikiProject').val();var queryCondition={keywords:$('#wikiKeyWord').val().split(' '),projectId:(selectPrj!='')?new Array(selectPrj):_this.getProjectIds()}
$searchResultList.empty();WebAPI.post('/getWikiByKeywordsAndProjectId',queryCondition).done(function(result){var rslt=JSON.parse(result),temp='';var tpl_search='<li wikiId="{id}"><span class="title">{title}</span><span class="keywordTags" title="Tag">{tagArr}</span><span class="projectTags" title="Project">{tagProjectArr}</span><span class="glyphicon glyphicon-link"></span></li>';if(rslt.length>0){for(var i=0,wiki;i<rslt.length;i++){wiki=rslt[i];if(!_this.searchWikis[wiki.id]){_this.searchWikis[wiki.id]=wiki;}
temp+=tpl_search.formatEL({id:wiki.id,title:wiki.title,tagArr:_this.addTagOfKewWord(wiki.tagStrArr),tagProjectArr:_this.addTagOfProject(wiki.tagProjectIdArr)})}
$searchResultList.html(temp);}else{$configAlert.parent().show();var $tip=$('<span>There is no wiki match input,you can create a new wiki !</span>');$configAlert.html($tip)
$tip.fadeOut(3000);}});});$searchResultList.off().on('click','li',function(e){e.stopPropagation();var wikiId=$(this).attr('wikiId');_this.showWikiDetail(_this.searchWikis[wikiId]);_this.$modalContent.find('.modal-footer').show();_this.$modalContent.find('#confirm').off().on('click',function(){if(_this.parent.entity.modal.type=='ModalPointKPI'){_this.parent.kpiItem.wikiId=wikiId;_this.parent.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);})
_this.parent.parentArgt.screen.isScreenChange=true;}else{_this.parent.entity.modal.wikiId=wikiId;_this.parent.screen.isScreenChange=true;$('#wikiId','#divContainer_'+_this.parent.entity.id).val(wikiId).hide().next('.chartTitleShow').show().html(wikiId);}
$(this).addClass('disabled').html('Binding');function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.parent.kpiItem.id){node.wikiId=wikiId;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}});});this.$modal.off('show.bs.modal').on('show.bs.modal',function(e){});this.$modal.off('hidden.bs.modal').on('hidden.bs.modal',function(){});this.$modal.modal('show');function renderSelectProject(){var projectName='',option='',temp='<option value="">Choose project(Optional)</option>';for(var i=0;i<AppConfig.projectList.length;i++){var project=AppConfig.projectList[i];if(I18n.type=='zh'){projectName=project.name_cn;}else{projectName=project.name_en;}
option='<option value="'+AppConfig.projectList[i].id+'">'+projectName+'</option>';temp+=option;}
return temp;}}
ModalWiki.prototype.showWikiCreate=function(){var _this=this;var tempHtml='\
            <div class="modal-header">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>\
                <h4 class="modal-title" id="" i18n="">Create Wiki</h4>\
            </div>\
            <div class="modal-body" id="">\
                <div class="bodyTop">\
                    <div class="">\
                        <form class="form-horizontal">\
                            <div class="form-group">\
                                <label class="col-sm-1 control-label" for="wikiTitle">Title</label>\
                                <div class="col-sm-9"><input type="text" class="form-control" id="wikiTitle" placeholder="Input title"/></div>\
                            </div>\
                            <div class="form-group">\
                                <label class="col-sm-1 control-label" for="">Tag</label>\
                                <div class="col-sm-9">\
                                    <ul class="list-inline tagCtn" id="tagStr">\
                                        <li><span class="glyphicon glyphicon-remove-circle add"></span></li>\
                                    </ul>\
                                </div>\
                            </div>\
                            <div class="form-group">\
                                <label class="col-sm-1 control-label" for="">Project</label>\
                                <div class="col-sm-9">\
                                    <ul class="list-inline tagCtn" id="tagProject">\
                                        <li><span class="glyphicon glyphicon-remove-circle add"></span></li>\
                                    </ul>\
                                </div>\
                            </div>\
                        </form>\
                    </div>\
                </div>\
                <div class="bodyMiddle">\
                    <div id="wikiContentCtn">\
                        <label for="">Content</label>\
                        <hr style="position: absolute;width: calc(100% - 70px);right: 0;top: -8px;"/>\
                        <div class="divWikiEditor" style="height: 320px">'
+getWysiwyg()+'</div>\
                    </div>\
                </div>\
            </div>\
            <div class="modal-footer">\
                <div id="configAlert"></div>\
                <button type="button" class="btn btn-primary" id="confirm" i18n="modalConfig.btnStartConfig.TYPE2">Confirm</button>\
            </div>';this.$modalContent=this.$modal.find('.modal-content');this.$modalContent.html(tempHtml);this.$modalContent.find('#editor').wysiwyg().css({height:'calc(100% - 79px)'});this.$modalContent.find('#confirm').off().on('click',function(e){e.stopPropagation();_this.createWiki();});this.$modalContent.find('#tagStr .add').off().on('click',function(e){e.stopPropagation();_this.addTagStr(this);});this.$modalContent.find('#tagProject .add').off().on('click',function(e){e.stopPropagation();_this.addTagProject(this);});this.$modalContent.on('click','.glyphicon.remove',function(){$(this).closest('li').remove();});this.$modal.modal('show');}
ModalWiki.prototype.getWikiById=function(){var _this=this;var wiki=this.parent.parentArgt.wikis[this.parent.kpiItem.wikiId];if(wiki){_this.showWikiEdit(wiki);}else{WebAPI.get('/getWikiById/'+this.parent.kpiItem.wikiId).done(function(result){var result=JSON.parse(result);if(result.id){_this.parent.parentArgt.wikis[result.id]=result;_this.showWikiEdit(result);}else{_this.showWikiSearch();}}).fail(function(result){alert(result)});}}
ModalWiki.prototype.showWikiEdit=function(wiki){var _this=this,$tagStrAdd,$tagProjectAdd,$divWikiEditor,$editor;var tempHtml='\
            <div class="modal-header">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>\
                <h4 class="modal-title" id="" i18n="">Edit Wiki\
                    <a id="btnChangeWiki" style="position: absolute;right: 150px;top: 18px;font-size:14px;" title="Change Wiki">Change</a>\
                    <a id="btnRemoveWiki" style="position: absolute;right: 80px;top: 18px;font-size:14px;" title="Unbind Wiki">Unbind</a>\
                </h4>\
            </div>\
            <div class="modal-body" id="">\
                <div class="bodyTop">\
                    <div class="">\
                        <form class="form-horizontal">\
                            <div class="form-group">\
                                <label class="col-sm-1 control-label" for="wikiTitle">Title</label>\
                                <div class="col-sm-9"><input type="text" class="form-control" id="wikiTitle" placeholder="Input title"/></div>\
                            </div>\
                            <div class="form-group">\
                                <label class="col-sm-1 control-label" for="">Tag</label>\
                                <div class="col-sm-9">\
                                    <ul class="list-inline tagCtn" id="tagStr">\
                                        <li><span class="glyphicon glyphicon-remove-circle add"></span></li>\
                                    </ul>\
                                </div>\
                            </div>\
                            <div class="form-group">\
                                <label class="col-sm-1 control-label" for="">Project</label>\
                                <div class="col-sm-9">\
                                    <ul class="list-inline tagCtn" id="tagProject">\
                                        <li><span class="glyphicon glyphicon-remove-circle add"></span></li>\
                                    </ul>\
                                </div>\
                            </div>\
                        </form>\
                    </div>\
                </div>\
                <div class="bodyMiddle">\
                    <div id="wikiContentCtn">\
                        <label for="">Content</label>\
                        <hr style="position: absolute;width: calc(100% - 70px);right: 0;top: -8px;"/>\
                        <div class="divWikiEditor" style="height: 320px;">'
+getWysiwyg()+'</div>\
                    </div>\
                </div>\
            </div>\
            <div class="modal-footer">\
                <div id="configAlert"></div>\
                <button type="button" class="btn btn-primary" id="confirm" i18n="modalConfig.btnStartConfig.TYPE2">Confirm</button>\
            </div>';this.$modalContent=this.$modal.find('.modal-content');this.$modalContent.html(tempHtml);$tagStrAdd=this.$modalContent.find('#tagStr li');$tagProjectAdd=this.$modalContent.find('#tagProject li');$divWikiEditor=this.$modalContent.find('.divWikiEditor');$editor=this.$modalContent.find('#editor').wysiwyg().html(wiki.content);if(this.isManager){this.$modalContent.find('#btnChangeWiki').hide();this.$modalContent.find('#btnRemoveWiki').hide();}
this.$modalContent.find('#wikiTitle').val(wiki.title);(wiki.tagStrArr instanceof Array)&&wiki.tagStrArr.forEach(function(tag){$tagStrAdd.before($('<li class="tagItem"><span class="tag">'+tag+'</span><span class="glyphicon remove">&times;</span></li>'));});(wiki.tagProjectIdArr instanceof Array)&&wiki.tagProjectIdArr.forEach(function(tag){var projectName=undefined;for(var i=0;i<AppConfig.projectList.length;i++){if(AppConfig.projectList[i].id==tag){if(I18n.type=='zh'){projectName=AppConfig.projectList[i].name_cn;}else{projectName=AppConfig.projectList[i].name_en;}}}
$tagProjectAdd.before($('<li class="tagItem"><span class="tag" projectId="'+tag+'">'+projectName+'</span><span class="glyphicon remove">&times;</span></li>'));});this.$modalContent.find('#editor').css({height:'calc(100% - 88px)',width:'calc(100% - 18px)'});this.$modalContent.find('#btnChangeWiki').off().on('click',function(e){_this.showWikiSearch();});this.$modalContent.find('#btnRemoveWiki').off().on('click',function(e){if(confirm('Are you sure to unbind this wiki ?')){if(_this.parent.entity.modal.type=='ModalPointKPI'){_this.parent.kpiItem.wikiId='';_this.parent.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});_this.parent.parentArgt.screen.isScreenChange=true;function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.parent.kpiItem.id){node.wikiId='';return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}else{_this.parent.entity.modal.wikiId='';_this.parent.screen.isScreenChange=true;$('#wikiId','#divContainer_'+_this.parent.entity.id).val('').show().next('.chartTitleShow').hide().html('');}
_this.$modalContent.find('#configAlert').html('Unbind success !');setTimeout(function(){_this.$modal.modal('hide');},1000);}});this.$modalContent.find('#tagStr .add').off().on('click',function(e){e.stopPropagation();_this.addTagStr(this);});this.$modalContent.find('#tagProject .add').off().on('click',function(e){e.stopPropagation();_this.addTagProject(this);});this.$modalContent.on('click','.glyphicon.remove',function(){$(this).closest('li').remove();});this.$modalContent.find('#confirm').off().on('click',function(){var tagStrArr=[],tagProjectIdArr=[];var title=_this.$modalContent.find('#wikiTitle').val();var content=$editor[0].innerHTML;if(title.trim()==''){alert('Title is required !');return false;}
if(content.trim()==''){alert('Content is required !');return false;}
_this.$modalContent.find('#tagStr .tag').each(function(){tagStrArr.push($.trim(this.innerHTML));});_this.$modalContent.find('#tagProject .tag').each(function(){tagProjectIdArr.push(parseInt($(this).attr('projectId')));});var newWiki={id:wiki.id,modifierId:AppConfig.userId,title:title,content:content,tagStrArr:tagStrArr,tagProjectIdArr:tagProjectIdArr}
WebAPI.post('/updateWiki',newWiki).done(function(result){if(_this.isManager){_this.managerWikis[wiki.id]=newWiki;$('#'+newWiki.id).after(_this.tpl_wiki_mng.formatEL({id:newWiki.id,title:newWiki.title,tagArr:_this.addTagOfKewWord(newWiki.tagStrArr),tagProjectArr:_this.addTagOfProject(newWiki.tagProjectIdArr),modifyTime:new Date().format('yyyy-MM-dd HH:mm')}));$('#'+newWiki.id).remove();}else{if(_this.parent.entity.modal.type=='ModalPointKPI'){_this.parent.parentArgt.screen.isScreenChange=true;}else{_this.parent.screen.isScreenChange=true;}}
_this.$modalContent.find('#configAlert').html('Modify success !');setTimeout(function(){_this.$modal.modal('hide');},1000);}).fail(function(result){}).always(function(){_this.$modal.modal('show')});});this.$modal.modal('show');}
ModalWiki.prototype.viewWikiInfo=function(wikiId){var _this=this,wiki;if(this.parent.entity.modal.type=='ModalPointKPI'){wiki=this.parent.parentArgt.wikis[wikiId];}else{wiki=this.parent.wikis[wikiId]}
if(wiki){_this.showWikiDetail(wiki);}else{WebAPI.get('/getWikiById/'+wikiId).done(function(result){var result=JSON.parse(result);if(result.id){if(_this.parent.parentArgt){_this.parent.parentArgt.wikis[result.id]=result}else{_this.parent.wikis[result.id]=result}
_this.showWikiDetail(result);}else{alert('The wiki may be have been removed, please bind a new wiki !');}}).fail(function(result){alert(result)});}}
ModalWiki.prototype.showWikiDetail=function(wiki){var tempHtml='\
            <div class="modal-header">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>\
                <h4 class="modal-title" id="" i18n="">{title}</h4>\
            </div>\
            <div class="modal-body" id="">\
                <div class="bodyTop">\
                    <div class="">\
                        <form class="form-horizontal">\
                            <div class="form-group">\
                                <label class="col-sm-1 control-label" for="">Tag</label>\
                                <div class="col-sm-9">\
                                    <ul class="list-inline tagCtn" id="tagStr">\
                                    </ul>\
                                </div>\
                            </div>\
                            <div class="form-group">\
                                <label class="col-sm-1 control-label" for="">Project</label>\
                                <div class="col-sm-9">\
                                    <ul class="list-inline tagCtn" id="tagProject">\
                                    </ul>\
                                </div>\
                            </div>\
                        </form>\
                    </div>\
                </div>\
                <div class="bodyMiddle">\
                    <div id="wikiContentCtn" style="position: relative; padding-top: 10px;">\
                        <hr style="position: absolute;width: calc(100% - 70px);right: 0;top: 0px;"/>\
                        <label for="">Content</label>\
                        <div id="divWikiContent" style="min-height: 180px;"></div>\
                    </div>\
                </div>\
            </div>\
            <div class="modal-footer" style="display: none;">\
                <div id="configAlert"></div>\
                <button type="button" class="btn btn-primary" id="confirm" i18n="">Bind</button>\
            </div>';this.$modalContent.html(tempHtml.formatEL(wiki));var $tagStrAdd=this.$modalContent.find('#tagStr');var $tagProjectAdd=this.$modalContent.find('#tagProject');this.$modalContent.find('#divWikiContent').html(wiki.content);var tempTagStr='',tempTagProj='';(wiki.tagStrArr instanceof Array)&&wiki.tagStrArr.forEach(function(tag){tempTagStr+='<li class="tagItem"><span class="tag">'+tag+'</span></li>';});$tagStrAdd.html(tempTagStr);(wiki.tagProjectIdArr instanceof Array)&&wiki.tagProjectIdArr.forEach(function(tag){var projectName=undefined;for(var i=0;i<AppConfig.projectList.length;i++){if(AppConfig.projectList[i].id==tag){if(I18n.type=='zh'){projectName=AppConfig.projectList[i].name_cn;}else{projectName=AppConfig.projectList[i].name_en;}}}
tempTagProj='<li class="tagItem"><span class="tag" projectId="'+tag+'">'+projectName+'</span></li>';});$tagProjectAdd.html(tempTagProj);this.$modal.modal('show');}
ModalWiki.prototype.addTagOfProject=function(arr){var str='';if(arr instanceof Array){for(var i=0;i<arr.length;i++){for(var j=0;j<AppConfig.projectList.length;j++){if(arr[i]==AppConfig.projectList[j].id){if(I18n.type='zh'){str+=('<span class="wikiTag">'+AppConfig.projectList[j].name_cn+'</span>');}else{str+=('<span class="wikiTag">'+AppConfig.projectList[j].name_en+'</span>');}}}}}
return str;}
ModalWiki.prototype.addTagOfKewWord=function(arr){var str='';if(arr instanceof Array){for(var i=0;i<arr.length;i++){str+=('<span class="wikiTag">'+arr[i]+'</span>');}}
return str;}
ModalWiki.prototype.createWiki=function(){var tagStrArr=[],tagProjectIdArr=[],_this=this;var title=this.$modalContent.find('#wikiTitle').val();var content=this.$modalContent.find('#editor')[0].innerHTML;this.$modalContent.find('#tagStr .tag').each(function(){tagStrArr.push($.trim(this.innerHTML));});this.$modalContent.find('#tagProject .tag').each(function(){tagProjectIdArr.push(parseInt($(this).attr('projectId')));});if(title.trim()==''){alert('Title is required !');return false;}
if(content.trim()==''){alert('Content is required !');return false;}
var wiki={creatorId:AppConfig.userId,title:title,content:content,tagStrArr:tagStrArr,tagProjectIdArr:tagProjectIdArr,modifyTime:new Date().format('yyyy-MM-dd HH:mm')}
WebAPI.post('/createWiki',wiki).done(function(result){var rslt=JSON.parse(result);if(rslt.wikiId){wiki.id=rslt.wikiId;if(_this.isManager){_this.managerWikis[wiki.id]=wiki;_this.$wikiListPanel.find('.divWiki').append(_this.tpl_wiki_mng.formatEL({id:wiki.id,title:wiki.title,tagArr:_this.addTagOfKewWord(wiki.tagStrArr),tagProjectArr:_this.addTagOfProject(wiki.tagProjectIdArr),modifyTime:wiki.modifyTime}))}else{if(_this.parent.entity.modal.type=='ModalPointKPI'){_this.parent.kpiItem.wikiId=rslt.wikiId;_this.parent.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});_this.parent.parentArgt.screen.isScreenChange=true;}else{_this.parent.entity.modal.wikiId=rslt.wikiId;_this.parent.wikis[rslt.wikiId]=wiki;_this.parent.screen.isScreenChange=true;$('#wikiId','#divContainer_'+_this.parent.entity.id).val(rslt.wikiId).hide().next('.chartTitleShow').show().html(rslt.wikiId);}}
_this.$modalContent.find('#configAlert').html('Create success !');setTimeout(function(){_this.$modal.modal('hide');},1000);function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.parent.kpiItem.id){node.wikiId=rslt.wikiId;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}}).fail(function(){}).always(function(){});}
ModalWiki.prototype.addTagStr=function(obj){if($('#tagStr input').length>0)return;var $input=$('<input type="text"/>');$input.blur(function(){var inputTxt=$input.val();if($.trim(inputTxt)!=''){var $li=$('<li class="tagItem"><span class="tag">'+inputTxt+'</span><span class="glyphicon remove">&times;</span></li>');$(obj.parentElement).prev().remove();$(obj.parentElement).before($li);}});$(obj.parentElement).before($input);}
ModalWiki.prototype.addTagProject=function(obj){if($('#tagProject select').length>0)return;var $select=$('<select class="">'),name;$select[0].options.add(new Option('Select a project',''))
for(var i=0;i<AppConfig.projectList.length;i++){var project=AppConfig.projectList[i];if(I18n.type=='zh'){name=project.name_cn;}else{name=project.name_en;}
$select[0].options.add(new Option(name,project.id))}
$select.change(function(){var selectTxt=$select[0].options[$select[0].selectedIndex].text;var selectVal=$select.val();if(selectVal!=''){var $li=$('<li class="tagItem"><span class="tag" projectId="'+selectVal+'">'+selectTxt+'</span><span class="glyphicon remove">&times;</span></li>');$(obj.parentElement).prev().remove();$(obj.parentElement).before($li);}});$(obj.parentElement).before($select);}
ModalWiki.prototype.getProjectIds=function(){var arrProjectId=[];for(var i=0;i<AppConfig.projectList.length;i++){arrProjectId.push(AppConfig.projectList[i].id);}
return arrProjectId;}
return ModalWiki;})();﻿
var ModelPipeline=(function(){function ModelPipeline(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[{execute:this.executeAnimation}];this.idCom=undefined;this.dictIdCom={};this.startX=undefined;this.startY=undefined;this.endX=undefined;this.endY=undefined;this.layer=undefined;this.lineWidth=10;this.color=undefined;this.pathLengthX=undefined;this.pathLengthY=undefined;this.originX=undefined;this.originY=undefined;this.direction=undefined;this.speed=undefined;this.pointX=undefined;this.pointY=undefined;this.radius=10;this.waterType=undefined;this.isRunning=false;};ModelPipeline.prototype=new Sprite();ModelPipeline.prototype.paint=function(ctx){ctx.save();var alpha=this.isRunning?'0.7':'0.2';switch(this.waterType){case"0":ctx.strokeStyle='rgba(0, 114, 201, '+alpha+')';break;case"1":ctx.strokeStyle='rgba(78, 157, 50, '+alpha+')';break;case"2":ctx.strokeStyle='rgba(244, 191, 88, '+alpha+')';break;case"3":ctx.strokeStyle='rgba(196, 101, 105, '+alpha+')';break;default:ctx.strokeStyle='#ccc';break;}
ctx.lineWidth=this.lineWidth;ctx.beginPath();ctx.moveTo(this.startX,this.startY);ctx.lineTo(this.endX,this.endY);ctx.closePath();ctx.stroke();ctx.restore();ctx.fillStyle='#017db6';ctx.save();if(this.waterType)ctx.fillStyle=this.waterType==0?"#017db6":"#6fc88f";ctx.beginPath();ctx.arc(this.pointX,this.pointY,this.lineWidth/2-1,0,Math.PI*2);ctx.closePath();ctx.fill();ctx.restore();}
ModelPipeline.prototype.executeAnimation=function(sprite,ctx,time){sprite.isRunning=false;for(var item in sprite.dictIdCom){if(sprite.dictIdCom[item]){sprite.isRunning=true;break;}}
if(!sprite.isRunning)return;if(sprite.pointX==undefined||sprite.pointY==undefined)sprite.initAnimationParams();if(sprite.endY==sprite.startY){if(Math.abs(sprite.pointX-sprite.originX)>sprite.pathLengthX)sprite.initAnimationParams();sprite.pointX+=sprite.speed;}else{if(Math.abs(sprite.pointY-sprite.originY)>sprite.pathLengthY)sprite.initAnimationParams();sprite.pointY+=sprite.speed;}}
ModelPipeline.prototype.initAnimationParams=function(){this.pathLengthX=Math.abs(this.endX-this.startX)-this.radius;this.pathLengthY=Math.abs(this.endY-this.startY)-this.radius;if(this.direction){this.originX=this.startX;this.originY=this.startY;if(this.speed>0&&(this.endX<this.startX||this.endY<this.startY))this.speed=-1*this.speed;}else{this.originX=this.endX;this.originY=this.endY;if(this.speed>0&&(this.endX>this.startX||this.endY>this.startY))this.speed=-1*this.speed;}
this.pointX=this.originX;this.pointY=this.originY;}
return ModelPipeline;})();﻿
var ModelEquipment=(function(){function ModelEquipment(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[{execute:this.updateImageIndex}];this.url=undefined;this.image=undefined;this.rotate=undefined;this.value=undefined;this.hasAnimation=undefined;this.animation=undefined;this.idCom=undefined;this.indexImage=0;this.layer=undefined;this.link=undefined;this.history=undefined;this.timeLastRefresh=0;};ModelEquipment.prototype=new Sprite();ModelEquipment.prototype.paint=function(ctx){if(this.image){if(this.image.complete){this.drawImage(this,ctx);}else{var _this=this;this.image.onload=function(e){_this.drawImage(_this,ctx)};}}},ModelEquipment.prototype.drawImage=function(_this,ctx){ctx.save();if((!_this.width)||(!_this.height)){_this.width=_this.image.width;_this.height=_this.image.height;}
try{if(_this.rotate){ctx.translate(_this.x,_this.y);ctx.translate(_this.width/2,_this.height/2);ctx.rotate(_this.rotate*Math.PI/180);if(Math.abs(_this.rotate)>90&&Math.abs(_this.rotate<270)){ctx.drawImage(_this.image,-_this.width/2,-_this.height/2,_this.width,_this.height);}else{ctx.drawImage(_this.image,-_this.height/2,-_this.width/2,_this.height,_this.width);}}else{ctx.drawImage(_this.image,_this.x,_this.y,_this.width,_this.height);}}catch(e){}
ctx.restore();},ModelEquipment.prototype.updateImageIndex=function(_this,ctx,time){_this.value=parseInt(_this.value);if(!(_this.animation[_this.value]&&_this.animation[_this.value].frameCount))return;if(_this.animation[_this.value].frameCount>1&&_this.indexImage<_this.animation[_this.value].frameCount){if(time&&time-_this.timeLastRefresh>_this.animation[_this.value].interval){_this.indexImage++;_this.timeLastRefresh=time;}}else{_this.indexImage=0;}}
ModelEquipment.prototype.refreshImage=function(dictList,dictImages){if(this.hasAnimation==undefined){this.hasAnimation=false;for(var item in this.animation){this.hasAnimation=true;break;}}
if(this.hasAnimation&&this.animation[this.value]&&this.animation[this.value].frameCount){var id=this.animation[this.value].frameCount>1?"animation_":"";if(this.animation[this.value].frameCount>1&&dictList[this.animation[this.value].animationId])
id+=dictList[this.animation[this.value].animationId][this.indexImage];else id=this.animation[this.value].animationId;if(dictImages[id]){this.image=dictImages[id];}}},ModelEquipment.prototype.mouseEnter=function(){if(this.history==undefined){this.history={};this.history.width=this.width;this.history.height=this.height;this.history.x=this.x;this.history.y=this.y;this.width+=30;this.height+=30;this.x-=15;this.y-=15;var _this=this;setTimeout(function(){_this.mouseOut();},1000);}},ModelEquipment.prototype.mouseOut=function(){if(this.history){this.width=this.history.width;this.height=this.history.height;this.x=this.history.x;this.y=this.history.y;this.history=undefined;}}
return ModelEquipment;})();﻿
var ModelButton=(function(){function ModelButton(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.image=undefined;this.imageComm=undefined;this.imageOver=undefined;this.imageDown=undefined;this.imageDisable=undefined;this.url=undefined;this.idCom=undefined;this.text=undefined;this.link=undefined;this.description=undefined;this.fontSize=undefined;this.fontColor=undefined;this.idCom=undefined;this.setValue=undefined;this.status=undefined;this.history=undefined;};ModelButton.prototype=new Sprite();ModelButton.prototype.paint=function(ctx){if(this.image!==undefined){if(this.image.complete){this.drawImage(this,ctx);}else{var _this=this;this.image.onload=function(e){_this.drawImage(_this,ctx)};}}},ModelButton.prototype.drawImage=function(_this,ctx){ctx.save();if((!_this.width)||(!_this.height)){_this.width=_this.image.width;_this.height=_this.image.height;}
try{ctx.drawImage(_this.image,_this.x,_this.y,_this.width,_this.height);if(_this.text){if(this.fontSize)strFont=_this.fontSize+"px Arial";ctx.fillStyle=_this.fontColor?"rgb("+_this.fontColor.r+","+_this.fontColor.g+","+_this.fontColor.b+")":"#333333";ctx.textBaseline="middle";ctx.textAlign="center";ctx.fillText(_this.text,_this.x+_this.width/2,_this.y+_this.height/2);}}
catch(e){}
ctx.restore();},ModelButton.prototype.mouseEnter=function(){if(this.status=="down")return;this.image=this.imageOver;},ModelButton.prototype.mouseOut=function(){this.image=this.imageComm;this.status=undefined;}
ModelButton.prototype.mouseDown=function(){this.image=this.imageDown;this.status="down";}
return ModelButton;})();﻿
var ModelText=(function(){var textEditorTemplate='<div class="popover observer-text-editor" style="padding: 10px;"><button type="button" class="close"><span>×</span></button>'+'<div class="popover-content">'+'<div class="form-horizontal">'+'<div class="form-group">'+'<div class="col-sm-9" id="pointName"></div>'+'</div>'+'<button class="btn btn-default btn-sm pull-right text-editor-btn-ok"></button>'+'</div>'+'</div>'+'</div>';var textTooltipTemplate='<div class="tooltip observer-text-tooltip observer-text-editor"><div class="tooltip-inner"><div id="pointName"></div><div><a class="lkAddToDS" href="javascript:;">'+'{0}</a></div></div></div>';var errTipTemplate='<div id="errTip">\
    </div>';var errTipTpNew='<div id="errTipNew">\
        <div class="errTipHeader"></div>\
        <div class="vavBox"><div class="airVolume">实际风量：  <span></span></div>\
        <div class="floStptVol">设定风量：  <span></span></div>\
        <div class="dmprPos">风阀开度：  <span></span></div>\
        <div class="roomTemp">房间温度：  <span></span></div>\
        </div>\
        <div class="fptuBox"><div class="spaceTemp">空间温度：  <span></span></div>\
        <div class="tempSetpoint">温度设定：  <span></span></div>\
        <div class="fanOnOff">风机状态：  <span></span></div>\
        <div class="fanErr">风机故障：  <span></span></div>\
        <div class="boxFlowDP">流量开关：  <span></span></div>\
        <div class="fanSpeedSet">风速设定：  <span></span></div>\
        <div class="fanSpeed">风速：  <span></span></div>\
        </div>\
        </div>';var TOOLTIP_DELAY=1000;var $tooltip=null;var tooltipTimer=null;var tooltip={show:function(){$tooltip.css('display','');$tooltip.css('opacity',configMap.textEditorOpacity);if(tooltipTimer){window.clearTimeout(tooltipTimer);tooltipTimer=null;}},hide:function(){if(!tooltipTimer){tooltipTimer=window.setTimeout(function(){$tooltip!==null&&$tooltip.css('opacity',0);tooltipTimer=null;},TOOLTIP_DELAY);}}};var ERRTIP_DELAY=1000;var $errTip=null;var errTipTimer=null;var errTip={show:function(){$errTip.css('display','');$errTip.css('opacity',1);if(errTipTimer){window.clearTimeout(errTipTimer);errTipTimer=null;}},hide:function(){if(!errTipTimer){errTipTimer=window.setTimeout(function(){$errTip!==null&&$errTip.css('opacity',0);errTipTimer=null;},ERRTIP_DELAY);}}}
var ERRTIPNEW_DELAY=1000;var $errTipNew=null;var errTipNewTimer=null;var errTipNew={show:function(){$errTipNew.css('display','');$errTipNew.css('opacity',1);if(errTipNewTimer){window.clearTimeout(errTipNewTimer);errTipNewTimer=null;}},hide:function(){if(!errTipNewTimer){errTipNewTimer=window.setTimeout(function(){$errTipNew!==null&&$errTipNew.css('opacity',0);errTipNewTimer=null;},ERRTIPNEW_DELAY);}}}
var configMap={textTooltipTemplate:null,textErrTipTemplate:errTipTemplate,textErrTipTpNew:errTipTpNew,textEditorTemplate:textEditorTemplate,textEditorZIndex:2200,textEditorOpacity:0.8,textTooltipBackgroundColor:'#1A1A1A',textEditorIdPrefix:'observer-text-editor-'}
function ModelText(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[{execute:this.executeAnimation}];this.value=undefined;this.isDiffValue=undefined;this.font=undefined;this.color=undefined;this.fontSize=undefined;this.decimalplace=undefined;this.idCom=undefined;this.dictBindString=[];this.showMode=undefined;this.tooltipTemplate=configMap.textTooltipTemplate;this.editorTemplate=configMap.textEditorTemplate;this.enableTooltip=true;this.isInMouserOver=false;this.errTipTimerout=null;if(!configMap.textTooltipTemplate){configMap.textTooltipTemplate=textTooltipTemplate.format(I18n.resource.observer.observerScreen.TEXT_ADD_TO_DATASOURCE);}};ModelText.prototype=new Sprite();ModelText.prototype.isTextEditorOpen=function(){return $(ElScreenContainer).find('#'+configMap.textEditorIdPrefix+this.id).length>0;}
ModelText.prototype.clearTextTooltip=function(){$(ElScreenContainer).find('.observer-text-tooltip').remove();}
ModelText.prototype.paint=function(ctx){var _this=this;ctx.save();var curColor=this.color;var strFont;if(this.fontSize)strFont=this.fontSize+"px ";strFont+=_this.font?_this.font:"Arial";ctx.font=strFont;if(this.bgColor){curColor="#ffffff";paintDiagNoticeBg();}
if(!this.isDiffValue){paintText(curColor);}else{strFont='bold '+strFont;paintText("#ff7200");setTimeout(function(){paintText(curColor);},200);}
ctx.restore();function paintText(color){ctx.save();ctx.textBaseline="middle";if(color)ctx.fillStyle=color;var str;if(!isNaN(_this.value)&&_this.decimalplace!=undefined){str=parseFloat(_this.value).toFixed(_this.decimalplace);if(str=="NaN")str="--";}
else{str=_this.value;}
var index=parseInt(_this.value);if(_this.dictBindString[index])str=_this.dictBindString[index];if(_this.width&&ctx.measureText(str).width<_this.width){ctx.fillText(str,_this.x,_this.y);}else{StringTools.wordWrap(ctx,_this.x,_this.y-_this.height/2+15,_this.width,str,null);}
ctx.restore();}
function paintDiagNoticeBg(){if(!_this.alphaBg)_this.alphaBg=1;if(!(_this.grade==0||_this.grade==undefined)){if(_this.alphaBg<0.3||_this.alphaBg>1){_this.isFade=!_this.isFade;}
_this.alphaBg=_this.isFade?_this.alphaBg+0.02:_this.alphaBg-0.02;}
ctx.save();ctx.fillStyle=_this.bgColor;ctx.globalAlpha=_this.alphaBg.toFixed(2);CanvasGeometry.fillRadiusRect(ctx,_this.x-5,_this.y-_this.height/2,ctx.measureText(_this.value).width+12,_this.height,3)
ctx.fill();ctx.restore();}}
ModelText.prototype.update=function(value){this.isDiffValue=!(this.value==value);if(this.value=='--')this.isDiffValue=false;this.value=value;}
ModelText.prototype.updateDiagnosisGrade=function(grade){this.grade=grade;switch(grade){case 0:this.bgColor='#5bc0de';break;case 1:this.bgColor='#f0ad4e';break;case 2:this.bgColor='#d9534f';break;default:this.bgColor='#d9534f';break;}}
ModelText.prototype.createTooltip=function(){var _this=this;var template,$template=$tooltip;if(!$template||!$template.length){template=this.tooltipTemplate;$template=$(template);$template.on('mouseenter',function(){tooltip.show();}).on('mouseleave',function(){tooltip.hide();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();}).css({'display':'block','max-width':'none','opacity':configMap.textEditorOpacity,'z-index':configMap.textEditorZIndex-1}).find('.tooltip-inner').css({'background-color':configMap.textTooltipBackgroundColor,'opacity':configMap.textEditorOpacity,'max-width':'none'});$template.find('.lkAddToDS').click(function(e){var pointName=$(this).parents('.tooltip-inner').find('#pointName').text();new ModalAppendPointToDs(false,null,[pointName]).show();e.preventDefault();});$(ElScreenContainer).append($template);}
$template.find('#pointName').text(this.idCom);return $template;}
ModelText.prototype.createTextEditor=function(){var $template=$(this.editorTemplate),_this=this,$operation,$select;if(this.dictBindString&&this.dictBindString.length>0){$operation=$('<div class="form-group"><input type="hidden" id="pointValue"></input><select class="form-control" style="width: 150px;margin: 0 auto;"></select></div>'),$select=$operation.find('select');for(var m=0,len=this.dictBindString.length;m<len;m++){var selected=parseInt(this.value)===m?'selected':'';$select.append('<option value="'+m+'" '+selected+'>'+this.dictBindString[m]+'</option>');}
$select.change(function(){$operation.find('#pointValue').val($(this).val());})}else{$operation=$('<div class="form-group">'+'<input type="text" class="form-control" id="pointValue" placeholder="'+this.value+'" style="width: 150px;margin: 0 auto;">'+'</div>');}
$template.css({'display':'block','min-width':'230px','z-index':configMap.textEditorZIndex}).attr('id',configMap.textEditorIdPrefix+this.id).find('.text-editor-btn-ok').text(I18n.resource.observer.observerScreen.TEXT_EDITOR_CONFIRM).before($operation);$template.on('click','.close',function(){$(this).closest('.popover').remove();}).on('click','.text-editor-btn-ok',function(){var value=$template.find('#pointValue').val(),projectId=AppConfig.projectId,idCom=_this.idCom,alert;if(!value||!projectId||!idCom||parseInt(_this.value)===value||isNaN(parseInt(_this.value))){return;}
var data={db:projectId,point:idCom,value:$template.find('#pointValue').val()}
Spinner.spin($template[0]);WebAPI.post('/set_realtimedata',data).pipe(function(result){if(result.indexOf('succeeded')!=-1){return WebAPI.post("/get_realtimedata",{proj:AppConfig.projectId,pointList:[_this.idCom]}).done(function(result){var resultJson,resultItem,latestValue;try{resultJson=JSON.parse(result);}catch(e){resultJson=[];}
resultItem=resultJson[0];if(!resultItem){latestValue=null;}
latestValue=resultItem.value;if(latestValue===_this.value){alert=new Alert($template[0],Alert.type.danger,I18n.resource.observer.observerScreen.TEXT_EDITOR_SEND_FAIL);}else{alert=new Alert($template[0],Alert.type.success,I18n.resource.observer.observerScreen.TEXT_EDITOR_SEND_SUCCESS);}});}else{alert=new Alert($template[0],Alert.type.danger,I18n.resource.observer.observerScreen.TEXT_EDITOR_SEND_FAIL);}}).fail(function(){alert=new Alert($template[0],Alert.type.danger,I18n.resource.observer.observerScreen.TEXT_EDITOR_SEND_FAIL);}).always(function(){alert.setStyle({width:'70%',fontSize:'10px'});alert.show(1000);Spinner.stop();});});$template.find('#pointName').text(this.idCom);return $template;};ModelText.prototype.createErrTip=function(data){var $find=$(),$each,_this=this;if(!$errTip||$errTip.length===0){$(ElScreenContainer).append($errTip=$(configMap.textErrTipTemplate));$errTip.on('mouseenter',function(e){errTip.show();e.stopPropagation();}).on('mouseleave',function(e){errTip.hide();e.stopPropagation();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();}).on('click','.err-replay',function(){var $this=$(this);var date=$this.siblings('span[data-time]').attr('data-time');_this.retrunToMoment(date);});}
for(var i=0,len=data.length;i<len;i++){$each=$('#divPaneNotice').find('[faultid="'+data[i]+'"]').clone(true);$each.each(function(){this.onmouseenter=null;this.onmouseleave=null;});$('<span class="glyphicon glyphicon-play span-hover-pointer grow err-replay"></span>').appendTo($each.children('div')[0]);$find=$find.add($each);}
$errTip.html($find);return $errTip;};ModelText.prototype.createErrTipNew=function(modelType,errTipNewRe){if(!$errTipNew||$errTipNew.length===0){$(ElScreenContainer).append($errTipNew=$(configMap.textErrTipTpNew));}
$errTipNew.on('mouseenter',function(e){errTipNew.show();e.stopPropagation();}).on('mouseleave',function(e){errTipNew.hide();e.stopPropagation();}).on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'&&e.target.style.opacity==='0'){e.target.style.display='none';}
e.stopPropagation();})
return $errTipNew;};ModelText.prototype.checkPopoverBoundary=function($popover,pageX,pageY){if(!pageX){pageX=this.x;}
if(!pageY){pageY=this.y;}
var documentWidth=$(document).width(),documentHeight=$(document).height(),popoverWidth=$popover.width(),popoverHeight=$popover.height(),popoverX=this.width+pageX+popoverWidth,popoverY=this.height+pageY+popoverHeight,popoverXOffset,popoverYOffset;popoverXOffset=popoverX>documentWidth?pageX-popoverWidth:pageX+15;popoverYOffset=popoverY>documentHeight?pageY-popoverHeight:pageY-45;$popover.css({left:popoverXOffset,top:popoverYOffset})}
ModelText.prototype.mouseEnter=function(event){var _this=this;var data,dataNew,modelType;var requestDataNew=[];if(this.enableTooltip){if(this.isInMouserOver)return;if(this.isErrTip){if(AppConfig.projectId==80){dataNew=this.getErrDataNew(this.id);modelType=dataNew[0].split('_')[0];if(!dataNew)return;_this.errTipTimerout=window.setTimeout(function(e){if(!_this.errTipTimerout)return;if(modelType=='VAV'){requestDataNew.push(dataNew[0]+'_AirVolume');requestDataNew.push(dataNew[0]+'_FloStptVol');requestDataNew.push(dataNew[0]+'_DmprPos');requestDataNew.push(dataNew[0]+'_RoomTemp');}else if(modelType=='FTPU'){requestDataNew.push(dataNew[0]+'_SpaceTemp');requestDataNew.push(dataNew[0]+'_TempSetpoint');requestDataNew.push(dataNew[0]+'_FanOnOff');requestDataNew.push(dataNew[0]+'_FanErr');requestDataNew.push(dataNew[0]+'_BoxFlowDP');requestDataNew.push(dataNew[0]+'_FanSpeedSet');requestDataNew.push(dataNew[0]+'_FanSpeed');}
WebAPI.post('/get_realtimedata',{pointList:requestDataNew,proj:AppConfig.projectId}).done(function(result){var errTipNewRe=JSON.parse(result);var vavPara,vavValue,ftpuPara,ftpuValue,getValue,getPara,getDataLen,getParaClass;$errTipNew=_this.createErrTipNew(modelType,errTipNewRe);getDataLen=errTipNewRe.length;if(modelType=='VAV'){$errTipNew.find('.errTipHeader').html('VAV');$errTipNew.find('.vavBox').show();$errTipNew.find('.fptuBox').hide();}else{$errTipNew.find('.errTipHeader').html('FPTU');$errTipNew.find('.vavBox').hide();$errTipNew.find('.fptuBox').show();}
for(var i=0;i<errTipNewRe.length;i++){getValue=errTipNewRe[i].value;getPara=(errTipNewRe[i].name).split('_')[2];getParaClass=(getPara.substring(0,1)).toLowerCase()+getPara.substring(1,getPara.length);if(getValue==null){getValue='N / A';}else{getValue=getValue;}
$('#errTipNew .'+getParaClass).find('span').html(getValue);}
errTipNew.show();_this.checkPopoverBoundary($errTipNew,event.pageX,event.pageY);});window.clearTimeout(_this.errTipTimerout);},1000);}else{data=this.getErrData(this.id);if(!data||data.length===0)return;if(this.grade===0)return;$errTip=this.createErrTip(data);errTip.show();this.checkPopoverBoundary($errTip,event.pageX,event.pageY);}}else{if(this.isTextEditorOpen())return;$tooltip=this.createTooltip();tooltip.show();this.checkPopoverBoundary($tooltip,event.pageX,event.pageY);}
this.isInMouserOver=true;}}
ModelText.prototype.mouseOut=function(event){var _this=this;this.errTipTimerout=null;if(this.enableTooltip){if(this.isErrTip){if(AppConfig.projectId==80){errTipNew.hide();}else{errTip.hide();}}else{tooltip.hide();}
this.isInMouserOver=false;}}
ModelText.prototype.mouseDown=function(event){}
ModelText.destroy=function(){if(tooltipTimer){window.clearTimeout(tooltipTimer);tooltipTimer=null;}
if($tooltip!==null){$tooltip.remove();$tooltip=null;}
if(errTipTimer){window.clearTimeout(errTipTimer);errTipTimer=null;}
if($errTip!==null){$errTip.remove();$errTip=null;}};return ModelText;})();﻿
var ModelChart=(function(){function ModelChart(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.interval=5000;this.units=undefined;this.dataTable={};this.maxPointCount=30;this.chartData=[];this.chartlabels=undefined;this.chart=undefined;this.chartOptions={animation:false,bezierCurve:false,scaleStartValue:0,};this.canvasOffline=undefined;this.ctxOffline=undefined;this.isRunning=false;this.receivedDate={};};ModelChart.prototype=new Sprite();ModelChart.prototype.close=function(){this.isRunning=false;this.canvasOffline=null;this.ctxOffline=null;}
ModelChart.prototype.drawLegend=function(){this.ctxOffline.textBaseline="middle";this.ctxOffline.textAlign="left";var legendItemBeginX=0,legendItemHeight=14,legendItemLine=0;for(var i=0;i<this.units.length;i++){if(legendItemBeginX>(this.width*0.8)){legendItemBeginX=0;legendItemLine+=1;}
if((!text)||text=='')continue;var text=this.units[i].title,itemHeight=legendItemHeight*legendItemLine;this.ctxOffline.fillStyle=this.units[i].color;this.ctxOffline.fillRect(legendItemBeginX+50,8+itemHeight,10,4);this.ctxOffline.fillStyle="#333333";this.ctxOffline.fillText(text,legendItemBeginX+70,10+itemHeight);legendItemBeginX+=this.ctxOffline.measureText(text).width+50;}}
ModelChart.prototype.paint=function(ctx){ctx.drawImage(this.canvasOffline,this.x,this.y);},ModelChart.prototype.update=function(pointName,value){this.receivedDate[pointName]=value;if(value<0)this.chartOptions.scaleStartValue=null;}
return ModelChart;})();var LineChart=(function(){function LineChart(id,painter,behaviors){ModelChart.call(this,id,painter,behaviors);}
LineChart.prototype=new ModelChart();LineChart.prototype.constructor=LineChart;LineChart.prototype.renderChart=function(_this){if(!_this.isRunning)return;_this.chartlabels.shift();_this.chartlabels.push(new Date().toLocaleTimeString());for(var pointName in _this.receivedDate){_this.dataTable[pointName].shift();_this.dataTable[pointName].push(_this.receivedDate[pointName]);for(var i=0;i<_this.chartData.length;i++){if(_this.chartData[i].pointName==pointName){_this.chartData[i].data=_this.dataTable[pointName];break;}}}
_this.canvasOffline.width=this.width;_this.canvasOffline.height=this.height;_this.ctxOffline.clearRect(0,0,_this.canvasOffline.width,_this.canvasOffline.height);_this.chart=new Chart(_this.ctxOffline);_this.chart.Line({labels:_this.chartlabels,datasets:_this.chartData},_this.chartOptions);this.drawLegend();setTimeout(function(){_this.renderChart(_this)},_this.interval);}
LineChart.prototype.init=function(){this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;var unit,sbColor,arr;for(var i=0;i<this.units.length;i++){unit=this.units[i];arr=[];for(var j=0;j<this.maxPointCount;j++)arr.push(null);this.dataTable[unit.pointName]=arr;this.receivedDate[unit.pointName]=null;sbColor=new StringBuilder();sbColor.append("rgba(").append(unit.color.b).append(",").append(unit.color.g).append(",").append(unit.color.r);this.units[i].color=sbColor.toString().replace("rgba","rgb")+")";this.chartData.push({fillColor:sbColor.toString()+", 0.5)",strokeColor:sbColor.toString()+", 1)",pointColor:sbColor.toString()+", 1)",pointStrokeColor:"#fff",data:this.dataTable[unit.pointName],pointName:unit.pointName,});}
this.chartlabels=new Array();for(var i=0;i<this.maxPointCount;i++)this.chartlabels.push('');}
return LineChart;})();var BarChart=(function(){function BarChart(id,painter,behaviors){ModelChart.call(this,id,painter,behaviors);}
BarChart.prototype=new ModelChart();BarChart.prototype.constructor=BarChart;BarChart.prototype.renderChart=function(_this){if(!_this.isRunning)return;for(var i=0;i<_this.units.length;i++){var unit=_this.units[i],pointName=unit.pointName;!_this.chartlabels[i]&&(_this.chartlabels[i]=unit.title);for(var j=0;j<_this.chartData.length;j++){if(_this.chartData[j].pointName===pointName){_this.chartData[j].data[0]=Number(_this.receivedDate[pointName]);}}}
_this.canvasOffline.width=this.width;_this.canvasOffline.height=this.height;_this.ctxOffline.clearRect(0,0,_this.canvasOffline.width,_this.canvasOffline.height);_this.chart=new Chart(_this.ctxOffline);_this.chart.Bar({labels:[' '],datasets:_this.chartData},_this.chartOptions);this.drawLegend();setTimeout(function(){_this.renderChart(_this)},_this.interval);}
BarChart.prototype.init=function(){this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;this.chartlabels=[];var unit,sbColor;for(var i=0;i<this.units.length;i++){unit=this.units[i];this.dataTable[unit.pointName]=[];this.receivedDate[unit.pointName]=null;sbColor=new StringBuilder();sbColor.append("rgba(").append(unit.color.b).append(",").append(unit.color.g).append(",").append(unit.color.r);this.units[i].color=sbColor.toString().replace("rgba","rgb")+")";this.chartData.push({fillColor:sbColor.toString()+", 0.5)",strokeColor:sbColor.toString()+", 1)",data:this.dataTable[unit.pointName],pointName:unit.pointName,});}}
return BarChart;})();var PieChart=(function(){function PieChart(id,painter,behaviors){ModelChart.call(this,id,painter,behaviors);this.painter={paint:this.paint};}
PieChart.prototype=new ModelChart();PieChart.prototype.constructor=PieChart;PieChart.prototype.paint=function(ctx){ctx.drawImage(this.canvasOffline,this.x+this.width*0.1,this.y+this.height*0.2);ctx.save();ctx.textBaseline="middle";ctx.textAlign="left";var legendItemBeginX=0,legendItemHeight=14,legendItemLine=0;for(var i=0;i<this.units.length;i++){if(legendItemBeginX>(this.width*0.8)){legendItemBeginX=0;legendItemLine+=1;}
var text=this.units[i].title,itemHeight=legendItemHeight*legendItemLine;ctx.fillStyle=this.units[i].color;ctx.fillRect(legendItemBeginX+50+this.x,8+itemHeight+this.y,10,4);ctx.fillStyle="#333333";ctx.font="bold 14px 微软雅黑";ctx.fillText(text,legendItemBeginX+70+this.x,10+itemHeight+this.y);legendItemBeginX+=ctx.measureText(text).width+50;}
ctx.restore();},PieChart.prototype.renderChart=function(_this){if(!_this.isRunning)return;for(var i=0;i<_this.units.length;i++){var unit=_this.units[i],pointName=unit.pointName;for(var j=0;j<_this.chartData.length;j++){if(_this.chartData[j].pointName===pointName){_this.chartData[j].value=Number(_this.receivedDate[pointName]);_this.chartData[j].label=unit.title;}}}
_this.canvasOffline.width=this.width*0.8;_this.canvasOffline.height=this.height*0.8;_this.ctxOffline.clearRect(0,0,_this.canvasOffline.width,_this.canvasOffline.height);_this.chart=new Chart(_this.ctxOffline);_this.chart.Pie(_this.chartData,_this.chartOptions);setTimeout(function(){_this.renderChart(_this)},_this.interval);}
PieChart.prototype.init=function(){this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.canvasOffline.width=this.width*0.8;this.canvasOffline.height=this.height*0.8;this.chartlabels=[];var unit,sbColor;for(var i=0;i<this.units.length;i++){unit=this.units[i];this.dataTable[unit.pointName]=[];this.receivedDate[unit.pointName]=null;sbColor=new StringBuilder();sbColor.append("rgba(").append(unit.color.b).append(",").append(unit.color.g).append(",").append(unit.color.r);this.units[i].color=sbColor.toString().replace("rgba","rgb")+")";this.chartData.push({color:sbColor.toString()+", 1)",value:0,label:'',pointName:unit.pointName,});}}
return PieChart;})();﻿
var ModelGage=(function(){function ModelGage(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.value=0;this.maxValue=1.5;this.minValue=0;this.idCom=undefined;this.imgMeterPan=new Image();this.imgMeterPan.src="/static/images/meterpan.png";this.imgMeterPointer=new Image();this.imgMeterPointer.src="/static/images/meterpointer.png";};ModelGage.prototype=new Sprite();ModelGage.prototype.close=function(){this.canvasOffline=null;this.ctxOffline=null;}
ModelGage.prototype.paint=function(ctx){ctx.drawImage(this.canvasOffline,this.x,this.y);},ModelGage.prototype.renderGage=function(){this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;this.ctxOffline.clearRect(0,0,this.canvasOffline.width,this.canvasOffline.height);var _this=this;if(this.imgMeterPan!=undefined){if(this.imgMeterPan.complete){this.drawMeterPan(this,this.ctxOffline);}else{this.imgMeterPan.onload=function(e){_this.drawMeterPan(_this,_this.ctxOffline);};}}
if(this.imgMeterPointer!=undefined){if(this.imgMeterPointer.complete){this.drawMeterPointer(this,this.ctxOffline);}else{this.imgMeterPointer.onload=function(e){_this.drawMeterPointer(_this,_this.ctxOffline);};}}},ModelGage.prototype.drawMeterPan=function(_this,ctx)
{_this.ctxOffline.drawImage(_this.imgMeterPan,0,0,_this.width,_this.height);gradient=_this.ctxOffline.createLinearGradient(0,0,_this.width,_this.height);gradient.addColorStop(0,'blue');gradient.addColorStop(0.25,'blue');gradient.addColorStop(0.5,'white');gradient.addColorStop(0.75,'red');gradient.addColorStop(1.0,'yellow');_this.ctxOffline.font="22pt Arial";_this.ctxOffline.fillStyle=gradient;_this.ctxOffline.strokeStyle='white';_this.ctxOffline.shadowColor='rgba(1,1,1,0.8)';_this.ctxOffline.shadowOffsetX=2;_this.ctxOffline.shadowOffsetY=2;_this.ctxOffline.shadowBlur=5;_this.ctxOffline.textAlign='center';var valueDisplay=Math.round(_this.value*100)/100;_this.ctxOffline.fillText(valueDisplay.toString(),_this.width*0.5,_this.height*0.75);_this.ctxOffline.font="9pt Arial";_this.ctxOffline.fillStyle='#4ebaff';var interval=(_this.maxValue-_this.minValue)/5,pi=Math.PI,angleInterval=pi/5,radius=_this.width*0.25,centerX=_this.width*0.5,centerY=_this.width*0.5;for(var n=0;n<6;n++){var value=_this.minValue+(n*interval);if(value%1!==0){value=value.toFixed(1);}
var angle=angleInterval*n;_this.ctxOffline.fillText(value,centerX-Math.cos(angle)*radius,centerY-Math.sin(angle)*radius);}}
ModelGage.prototype.drawMeterPointer=function(_this,ctx){_this.ctxOffline.save();var maxValueAsAngle=Math.PI/2.0*3.0;var minValueAsAngle=Math.PI/2.0;var curValueAngle=0.0;if(Number(_this.value)>_this.maxValue){curValueAngle=maxValueAsAngle;}else if(Number(_this.value)<_this.minValue){curValueAngle=minValueAsAngle;}else{if(_this.maxValue>_this.minValue){curValueAngle=minValueAsAngle+(maxValueAsAngle-minValueAsAngle)/(_this.maxValue-_this.minValue)*(_this.value-_this.minValue);}}
var pointerbasex=_this.width*0.5;var pointerbasey=_this.height*0.5;_this.ctxOffline.translate(pointerbasex,pointerbasey);_this.ctxOffline.rotate(curValueAngle);_this.ctxOffline.drawImage(_this.imgMeterPointer,-_this.imgMeterPointer.width/2.0,-_this.imgMeterPointer.width/2.0,_this.imgMeterPointer.width,_this.imgMeterPointer.height);_this.ctxOffline.restore();}
ModelGage.prototype.update=function(value)
{if(value==this.value)return;this.value=value;this.renderGage();}
return ModelGage;})();﻿
var ModelRuler=(function(){var PANEL_DECIMAL_PRECISION=2,GRADUATION_MAIN_HEIGHT=28,GRADUATION_HALF_HEIGHT=10,GRADUATION_TENTH_HEIGHT=5,COLOR_IMPROVEMENT='#d17965',COLOR_FAIR='#d4861e',COLOR_GOOD='#5b9d00',COLOR_EXCELLENT='#0078b6';var isLoaded=false;var panel_change_max=300,panel_change_rate=6,panel_change_current=0,panel_change_value=0,panel_change_value_direc=1;function changeRangeIndex(){if(panel_change_value===0){panel_change_value_direc=1;}else if(panel_change_value===1){panel_change_value_direc=-1;}
panel_change_value=panel_change_value+panel_change_value_direc;}
function drawReferrencePanel(context,x,y,w,h,isCurrentProject){context.save();context.shadowColor="RGBA(100,100,100,1)";context.shadowOffsetX=0;context.shadowOffsetY=2;context.shadowBlur=0;if(isCurrentProject){if(panel_change_current>panel_change_max){panel_change_current=0;changeRangeIndex();}else{panel_change_current+=panel_change_rate;}
switch(panel_change_value){case 0:context.fillStyle="#FF9900";break;case 1:context.fillStyle="#FFF";break;}}else{context.fillStyle="RGBA(255,255,255,1)";}
CanvasGeometry.fillRadiusRect(context,x,y,w,h,3);context.fill();context.restore();}
function drawbutton(ctx,x,y,text){if($('.check-big-data').size()!=0){return;}
var btn=$('<div class="btn btn-default check-big-data i18n="observer.entities.BIG_DATA_COMPARISON""></div>');btn.css({'position':'absolute','top':y+100,'left':x,'float':'right','font-size':'18px','font-family':'微软雅黑','box-shadow':'0px 2px #666'});btn.click(function(){isBigDataLoad=!isBigDataLoad;});$('#divMain').append(btn);}
function getColorByAppraise(appraisement){if(!appraisement)return'';var result=null;var o=I18n.resource.observer.entities;switch(appraisement){case o.RELATIVELY_POOR:result=COLOR_IMPROVEMENT;break;case o.GENERAL:result=COLOR_FAIR;break;case o.GOOD:result=COLOR_GOOD;break;case o.EXCELLENT:result=COLOR_EXCELLENT;break;}
return result;}
function ModelRuler(screen,id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.screen=screen;this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.maxValue=undefined;this.minValue=undefined;this.name=undefined;this.decimal=undefined;this.mainScale=undefined;this.minorScale=undefined;this.idCom=undefined;this.list=new Array();this.levels=new Array();this.references=new Array();this.isInitFinished=false;this.plantIcon=new Image();this.plantIcon.src='/static/images/plant_icon.png';this.isBigDataLoad=false};ModelRuler.prototype=new Sprite();ModelRuler.prototype.close=function(){this.canvasOffline=null;this.ctxOffline=null;$('#divMain').find('.check-big-data').remove();}
ModelRuler.prototype.paint=function(ctx){var _this=this;ctx.drawImage(this.canvasOffline,this.x,this.y);if(!this.references||this.references.length===0){return;}
if(!this.isInitFinished){var ANIMATION_INTERVAL=0.01,ANIMATION_DECIMAL_PRECISION=3}else{var ANIMATION_INTERVAL=this.mainScale?Number(this.mainScale)/20:0.01,ANIMATION_DECIMAL_PRECISION=3}
var that=this,PANEL_WIDTH=147,tempHeigth=this.height/5,PANEL_MARGIN=5;for(var rInd=0,rLen=this.references.length;rInd<rLen;rInd++){var ref=this.references[rInd];ref.joinPoint=null;ref.arrowPoint=null;ref.panel=null;ref.value=Number(ref.value).toFixed(PANEL_DECIMAL_PRECISION);if(Number(ref.isInUp)===1){this.references[rInd]=new ModelRulerCurrentReference(ref,this);}else{this.references[rInd]=new ModelRulerReference(ref,this);}}
function checkValue(value,maxValue,minValue){if(value>maxValue){return maxValue;}else if(value<minValue){return minValue;}else{return value;}}
var getDownJoinPoint=function(item){var itemValue=checkValue(item.currentDrawValue,that.maxValue,that.minValue);return{X:that.x+20+(that.width-40)*(itemValue-that.minValue)/(that.maxValue-that.minValue),Y:that.y+that.height-tempHeigth+10}},getUpJoinPoint=function(item){var itemValue=checkValue(item.currentDrawValue,that.maxValue,that.minValue);return{X:that.x+20+(that.width-40)*(itemValue-that.minValue)/(that.maxValue-that.minValue),Y:that.y+tempHeigth-10}},getUpArrowPoint=function(item){var itemValue=checkValue(item.currentDrawValue,that.maxValue,that.minValue);return{X:that.x+20+(that.width-40)*(itemValue-that.minValue)/(that.maxValue-that.minValue),Y:that.y+that.height/2-35}},getDownArrowPoint=function(item){var itemValue=checkValue(item.currentDrawValue,that.maxValue,that.minValue);return{X:that.x+20+(that.width-40)*(itemValue-that.minValue)/(that.maxValue-that.minValue),Y:that.y+that.height/2+35}};var compareJoinPoint=function(thisJoinPoint,comparedPoint){var comparedValue=thisJoinPoint.X-comparedPoint.X
if(Math.abs(comparedValue)<(PANEL_WIDTH)){thisJoinPoint.X+=Math.abs(PANEL_WIDTH-comparedValue)+5
return thisJoinPoint;}
return null;}
this.references.sort(function(itemA,itemB){return Number(itemA.currentDrawValue)-Number(itemB.currentDrawValue);});var upRefs=this.references.filter(function(val,index){return Number(val.isInUp)==0&&index%2===1;});var downRefs=this.references.filter(function(val,index){return Number(val.isInUp)==0&&index%2===0;});upRefs.push(this.references.filter(function(val,index){return Number(val.isInUp)!=0;})[0])
upRefs.sort(function(itemA,itemB){return Number(itemA.currentDrawValue)-Number(itemB.currentDrawValue);});downRefs.sort(function(itemA,itemB){return Number(itemA.currentDrawValue)-Number(itemB.currentDrawValue);});var reverseCheck=function(refs,index,item,itemIndex,getJoinPoint){for(var n=index-1;n>-1;n--){if(n===itemIndex){continue;}
var comparedJoinPoint=refs[n].joinPoint?refs[n].joinPoint:getJoinPoint(refs[n]);var comparedResult=compareJoinPoint(item.joinPoint,comparedJoinPoint);if(comparedResult){item.joinPoint=comparedResult;return true;}}
return false;}
var handleRefs=function(refs,isUpRef){if(isUpRef){var getJoinPoint=getUpJoinPoint,getArrowPoint=getUpArrowPoint;}else{var getJoinPoint=getDownJoinPoint,getArrowPoint=getDownArrowPoint;}
for(var i=0;i<refs.length;i++){var currentRef=refs[i];currentRef.isUpRef=isUpRef;if(!currentRef.currentDrawValue){currentRef.currentDrawValue=currentRef.value;}
if(isLoaded&&Number(currentRef.value)===0){currentRef.currentDrawValue=Number(currentRef.value);}
if(Number(currentRef.currentDrawValue)<Number(currentRef.value)){currentRef.currentDrawValue=(Number(currentRef.currentDrawValue)+ANIMATION_INTERVAL).toFixed(ANIMATION_DECIMAL_PRECISION);}else if(Number(currentRef.currentDrawValue)>Number(currentRef.value)){currentRef.currentDrawValue=(Number(currentRef.currentDrawValue)-ANIMATION_INTERVAL).toFixed(ANIMATION_DECIMAL_PRECISION);}else if(Number(currentRef.value)!=0){isLoaded=true;}else{this.isInitFinished=true;}
var currentJoinPoint=getJoinPoint(currentRef);currentRef.arrowPoint=getArrowPoint(currentRef);if(i===0){currentRef.joinPoint=currentJoinPoint;}else{var lastRef=refs[i-1],lastJoinPoint=lastRef.joinPoint;var comparedResult;lastJoinPoint&&(comparedResult=compareJoinPoint(currentJoinPoint,lastJoinPoint));if(comparedResult){currentRef.joinPoint=comparedResult;}
if(!currentRef.joinPoint){currentRef.joinPoint=currentJoinPoint;}}
while(reverseCheck(refs,i,currentRef,i,getJoinPoint)){};currentRef.panel={};currentRef.panel.x=currentJoinPoint.X-PANEL_WIDTH/2;currentRef.panel.y=isUpRef?currentJoinPoint.Y-tempHeigth:currentJoinPoint.Y;currentRef.panel.w=PANEL_WIDTH;currentRef.panel.h=tempHeigth;}};if(!this.isBigDataLoad){downRefs=[];upRefs=upRefs.filter(function(item){if(Number(item.isInUp)===1){return true;}})}
handleRefs(upRefs,true);handleRefs(downRefs,false);var refs=upRefs.concat(downRefs);for(var i=0;i<refs.length;i++){refs[i].value&&Number(refs[i].value)&&this.drawReference(ctx,refs[i]);}
updateToHitModel();function updateToHitModel(){var ScreenCurrent=_this.screen;if(!ScreenCurrent){return};ScreenCurrent.hitModel.remove(ScreenCurrent.enmuElementType.ruler);for(var n=0,len=that.references.length;n<len;n++){var ref=that.references[n];Number(ref.value)!==0&&ref.panel&&ScreenCurrent.hitModel.add(that.id+'_'+n,ScreenCurrent.enmuElementType.ruler,ref.panel.x,ref.panel.y,ref.panel.w,ref.panel.h);}}},ModelRuler.prototype.init=function(){this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;var ctx=this.ctxOffline;var geometry=new CanvasGeometry(ctx);ctx.clearRect(0,0,this.canvasOffline.width,this.canvasOffline.height);var length=this.maxValue-this.minValue;var paneY=this.height/3,paneHeight=this.height/3,paneX,paneWidth;var gradient=ctx.createLinearGradient(0,paneY,0,paneY+paneHeight);gradient.addColorStop(0,"#f1f1f1");gradient.addColorStop(0.2,"#fff");gradient.addColorStop(0.6,"#fff");gradient.addColorStop(1,"#e3e3e3");ctx.fillStyle=gradient;ctx.lineWidth=0;CanvasGeometry.fillRadiusRect(ctx,0,paneY,this.width,paneHeight,15);ctx.fill();paneX=15;paneY+=paneHeight/3-3;paneHeight=paneHeight/3+6;paneWidth=this.width-30;var gradient=ctx.createLinearGradient(0,paneY,0,paneY+paneHeight);gradient.addColorStop(0,"#989898");gradient.addColorStop(0.2,"#e3e3e3");gradient.addColorStop(0.8,"#fff");ctx.fillStyle=gradient;ctx.lineWidth=0;CanvasGeometry.fillRadiusRect(ctx,paneX,paneY,paneWidth,paneHeight,5);ctx.fill();paneX+=5;paneY+=3;paneHeight-=6;paneWidth-=10
ctx.textBaseline="middle";ctx.textAlign="center";ctx.fillStyle="#323232";for(var i=0;i<this.levels.length;i++){var tempX=paneX+paneWidth*(this.levels[i].min-this.minValue)/length;var tempWidth=paneWidth*(this.levels[i].max-this.levels[i].min)/length;ctx.save();ctx.fillStyle=this.levels[i].color;ctx.fillRect(tempX,paneY,tempWidth,paneHeight);ctx.restore();ctx.save();ctx.font="22px 微软雅黑";ctx.fillText(this.levels[i].text,tempX+tempWidth/2,paneY+paneHeight/2);ctx.restore();}
if(this.mainScale==0){alert(I18n.resource.observer.entities.MAIN_SCALE_INFO);return;}
var scaleY=paneY-4;var unitWidth=paneWidth/length*this.mainScale,tenthUnitWidth=unitWidth/10;ctx.lineWidth=1;ctx.fillStyle="#666666";for(var i=0;i<=length/this.mainScale+1;i++){var tempX=paneX+i*unitWidth;ctx.strokeStyle="#999999";ctx.beginPath();ctx.moveTo(tempX,scaleY);ctx.lineTo(tempX,scaleY-15);ctx.closePath();ctx.stroke();ctx.save();ctx.font="16px 微软雅黑";ctx.fillText((parseFloat(this.minValue)+this.mainScale*i).toFixed(this.decimal),tempX,scaleY-GRADUATION_MAIN_HEIGHT);ctx.restore();ctx.strokeStyle="#cccccc";ctx.beginPath();ctx.moveTo(tempX+unitWidth/2,scaleY);ctx.lineTo(tempX+unitWidth/2,scaleY-GRADUATION_HALF_HEIGHT);ctx.closePath();ctx.stroke();var tenthX=0;for(var count=1;count<10;count++){tenthX=tempX+tenthUnitWidth*count;if(tenthX<(tempX+unitWidth)){ctx.strokeStyle="#cccccc";ctx.beginPath();ctx.moveTo(tenthX,scaleY);ctx.lineTo(tenthX,scaleY-GRADUATION_TENTH_HEIGHT);ctx.closePath();ctx.stroke();}}}
scaleY=paneY+paneHeight+1;unitWidth=paneWidth/length*this.mainScale;for(var i=0;i<=length/this.mainScale+1;i++){var tempX=paneX+i*unitWidth;ctx.strokeStyle="#999999";ctx.beginPath();ctx.moveTo(tempX,scaleY);ctx.lineTo(tempX,scaleY+15);ctx.closePath();ctx.stroke();ctx.save();ctx.font="16px 微软雅黑";ctx.fillText((parseFloat(this.minValue)+this.mainScale*i).toFixed(this.decimal),tempX,scaleY+GRADUATION_MAIN_HEIGHT);ctx.restore();ctx.strokeStyle="#cccccc";ctx.beginPath();ctx.moveTo(tempX+unitWidth/2,scaleY);ctx.lineTo(tempX+unitWidth/2,scaleY+GRADUATION_HALF_HEIGHT);ctx.closePath();ctx.stroke();var tenthX=0;for(var count=1;count<10;count++){tenthX=tempX+tenthUnitWidth*count;if(tenthX<(tempX+unitWidth)){ctx.strokeStyle="#cccccc";ctx.beginPath();ctx.moveTo(tenthX,scaleY);ctx.lineTo(tenthX,scaleY+GRADUATION_TENTH_HEIGHT);ctx.closePath();ctx.stroke();}}}},ModelRuler.prototype.update=function(pointName,value){for(var i=0;i<this.references.length;i++){if(this.references[i].idCom==pointName){this.references[i].value=value;}}},ModelRuler.prototype.drawReference=function(ctx,item){if(Number(item.value)===0){return;}
ctx.save();var tempHeigth=this.height/5;var joinPoint=item.joinPoint,arrowPoint=item.arrowPoint,panelPoint=item.panel,isCurrentProject=Number(item.isInUp)===1;if(item.isZoom){panelPoint.w+=30;panelPoint.h+=20;panelPoint.x-=15;panelPoint.y-=15
item.isUpRef?joinPoint.Y+=5:joinPoint.Y-=14;}
ctx.textBaseline="middle";ctx.textAlign="center";ctx.save();ctx.beginPath();ctx.moveTo(arrowPoint.X,arrowPoint.Y);ctx.lineTo(joinPoint.X,joinPoint.Y);ctx.lineTo(joinPoint.X+7,joinPoint.Y);ctx.closePath();ctx.fillStyle="#939393";ctx.fill();ctx.beginPath();ctx.fillStyle="#fff";ctx.moveTo(arrowPoint.X,arrowPoint.Y);ctx.lineTo(joinPoint.X,joinPoint.Y);ctx.lineTo(joinPoint.X-7,joinPoint.Y);ctx.closePath();ctx.fill();ctx.restore();ctx.save();ctx.fillStyle="#ddd";ctx.fillRect(arrowPoint.X-1,item.isUpRef?arrowPoint.Y:arrowPoint.Y-18,2,18);ctx.restore();drawReferrencePanel(ctx,panelPoint.x,panelPoint.y,panelPoint.w,panelPoint.h,isCurrentProject);ctx.save();var zoomChangeHeight=item.isZoom?5:0;var itemValue=parseFloat(item.currentDrawValue).toFixed(PANEL_DECIMAL_PRECISION);if(isCurrentProject){switch(panel_change_value){case 0:ctx.fillStyle="#FFF";break;case 1:ctx.fillStyle="#FF9900";break;}
ctx.font="25px 微软雅黑";ctx.fillText(itemValue,joinPoint.X,panelPoint.y+tempHeigth/7*5+zoomChangeHeight);}else{if(itemValue<this.levels[0].min){ctx.fillStyle=COLOR_EXCELLENT;}else if(itemValue>this.levels[this.levels.length-1].max){ctx.fillStyle=COLOR_IMPROVEMENT;}else{for(var j=0;j<this.levels.length;j++){if(Number(itemValue)>=Number(this.levels[j].min)&&Number(itemValue)<=Number(this.levels[j].max)){ctx.fillStyle=getColorByAppraise(this.levels[j].text);break;}}}
ctx.font="25px 微软雅黑";ctx.fillText(itemValue,joinPoint.X+8,panelPoint.y+tempHeigth/7*5+zoomChangeHeight);}
var valueStyle=ctx.fillStyle;if(isCurrentProject){switch(panel_change_value){case 0:ctx.fillStyle="#FFF";break;case 1:ctx.fillStyle="#FF9900";break;}
ctx.font="18px 微软雅黑";var itemNm=I18n.resource.observer.entities.CURRENT_PROJECT;ctx.fillText(itemNm,joinPoint.X,panelPoint.y+tempHeigth/7*2+zoomChangeHeight);}else{ctx.fillStyle=valueStyle;ctx.fillRect(joinPoint.X-70,panelPoint.y+tempHeigth/7*2+zoomChangeHeight-15,35,33);ctx.fillStyle="#FFF";ctx.font="35px 微软雅黑";var itemNm=item.name;if(itemNm.match(/\w/)){itemNm=itemNm.match(/\w/)[0];}
ctx.fillText(itemNm,joinPoint.X-53,panelPoint.y+tempHeigth/7*2+zoomChangeHeight);ctx.font="14px 微软雅黑";ctx.fillStyle="#232323";ctx.fillText(I18n.resource.observer.entities.WORKING_CONDITION_RATE,joinPoint.X+10,panelPoint.y+tempHeigth/7*2+zoomChangeHeight);ctx.lineWidth=1;ctx.strokeStyle='#CCC'
ctx.beginPath();ctx.moveTo(joinPoint.X-35,panelPoint.y+tempHeigth/7*2+zoomChangeHeight-14);ctx.lineTo(joinPoint.X-35,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+50);ctx.moveTo(joinPoint.X-35,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+18);ctx.lineTo(joinPoint.X-70,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+18);ctx.closePath()
ctx.stroke();if(this.plantIcon!==undefined){if(!this.plantIcon.complete){this.plantIcon.onload=function(e){ctx.drawImage(this.plantIcon,joinPoint.X-70,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+20,30,30);};}
else{ctx.drawImage(this.plantIcon,joinPoint.X-70,panelPoint.y+tempHeigth/7*2+zoomChangeHeight+20,30,30);}}}
ctx.restore();ctx.restore();}
function ModelRulerReference(item,ruler){this.ruler=ruler;for(var prop in item){if(item.hasOwnProperty(prop)){this[prop]=item[prop];}}}
ModelRulerReference.prototype=new Sprite();ModelRulerReference.prototype.constructor=ModelRulerReference;ModelRulerReference.prototype.mouseEnter=function(){for(var n=0;n<this.ruler.references.length;n++){this.ruler.references[n].isZoom=false;}
this.isZoom=true;}
ModelRulerReference.prototype.mouseOut=function(){this.isZoom=false;}
function ModelRulerCurrentReference(item,ruler){this.ruler=ruler;for(var prop in item){if(item.hasOwnProperty(prop)){this[prop]=item[prop];}}}
ModelRulerCurrentReference.prototype=new Sprite();ModelRulerCurrentReference.prototype.constructor=ModelRulerCurrentReference;ModelRulerCurrentReference.prototype.mouseDown=function(){this.ruler.isBigDataLoad=!this.ruler.isBigDataLoad;}
ModelRuler.ModelRulerCurrentReference=ModelRulerCurrentReference;ModelRuler.ModelRulerReference=ModelRulerReference;return ModelRuler;})();﻿
var ModelCheckbox=(function(){function ModelCheckbox(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.idCom=undefined;this.type=undefined;this.fontColor=undefined;this.fontSize=undefined;this.setValue=undefined;this.unsetValue=undefined;this.text=undefined;this.idGroup=undefined;this.expression=undefined;};ModelCheckbox.prototype=new Sprite();ModelCheckbox.prototype.paint=function(ctx){},ModelCheckbox.prototype.update=function(_this,ctx){}
return ModelCheckbox;})();﻿var ModelTempDistribution=(function(){var configMap={heat_radius:15,heat_blur:40,heat_interval_y:15,heat_interval_x:20,TEMP_RANGE:{min:null,max:null}};function getHeatData(data){var result=[];for(var n=0,len=data.length;n<len;n++){var item=data[n],temp=+item.value;result.push([item.x,item.y,temp?temp:0])}
return result;}
function getTwoPointDistance(x1,y1,x2,y2){return Math.sqrt(Math.pow((Math.abs(x2)-Math.abs(x1)),2)+Math.pow((Math.abs(y2)-Math.abs(y1)),2));}
function getArrayMin(arr){return!arr?null:Math.min.apply(null,arr);}
function getArrayMax(arr){return!arr?null:Math.max.apply(null,arr);}
function calcPointTemp(x,y,heatData){if(!heatData||heatData.length===0){return}
var temp=0,distanceTotal=0;for(var m=0,mlen=heatData.length;m<mlen;m++){var heatDataItem=heatData[m],distance=getTwoPointDistance(x,y,heatDataItem[0],heatDataItem[1]);if(distance===0){return(Number(heatDataItem[2])-configMap.TEMP_RANGE.min)*configMap.heat_zoom_rate;}
temp+=(heatDataItem[2]&&distance)?heatDataItem[2]/distance:heatDataItem[2];distanceTotal+=1/distance;}
temp=temp/distanceTotal;return(Number(temp)-configMap.TEMP_RANGE.min);}
function calcAllTempData(rawData,x,y,w,h){var heatData=getHeatData(rawData),maxX=x+w,maxY=y+h,yInterval=configMap.heat_interval_y,xInterval=configMap.heat_interval_x,allTempPoint=[],rawTempArray,handledTempArray=[];rawTempArray=heatData.map(function(item){return item[2];});if(!configMap.TEMP_RANGE.min){configMap.TEMP_RANGE.min=getArrayMin(rawTempArray);}
for(var m=x-5*xInterval;m<maxX+5*xInterval;m=m+xInterval){for(var n=y-5*yInterval;n<maxY+5*yInterval;n=n+yInterval){var temp=calcPointTemp(m,n,heatData);temp=Number(temp.toFixed(2));if(!temp||temp===0||temp<0){continue;}
allTempPoint.push([Number(m.toFixed(2)),Number(n.toFixed(2))-y,temp]);handledTempArray.push(temp);}}
if(!configMap.TEMP_RANGE.max){configMap.TEMP_RANGE.max=getArrayMax(handledTempArray)+configMap.TEMP_RANGE.min;}
return allTempPoint;}
var simpleheat=(function(){function simpleheat(canvas){if(!(this instanceof simpleheat)){return new simpleheat(canvas);}
this._canvas=canvas=typeof canvas==='string'?document.getElementById(canvas):canvas;this._ctx=canvas.getContext('2d');this._width=canvas.width;this._height=canvas.height;this._max=1;this._data=[];}
simpleheat.prototype={defaultRadius:25,defaultGradient:{0.5:'blue',0.6:'cyan',0.7:'lime',0.8:'yellow',1.0:'red'},data:function(data){this._data=data;return this;},max:function(max){this._max=max;return this;},add:function(point){this._data.push(point);return this;},clear:function(){this._data=[];return this;},radius:function(r,blur){blur=blur||15;var circle=this._circle=document.createElement('canvas'),ctx=circle.getContext('2d'),r2=this._r=r+blur;circle.width=circle.height=r2*2;ctx.shadowOffsetX=ctx.shadowOffsetY=200;ctx.shadowBlur=blur;ctx.shadowColor='black';ctx.beginPath();ctx.arc(r2-200,r2-200,r,0,Math.PI*2,true);ctx.closePath();ctx.fill();return this;},gradient:function(grad){var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),gradient=ctx.createLinearGradient(0,0,0,256);canvas.width=1;canvas.height=256;for(var i in grad){gradient.addColorStop(i,grad[i]);}
ctx.fillStyle=gradient;ctx.fillRect(0,0,1,256);this._grad=ctx.getImageData(0,0,1,256).data;return this;},draw:function(minOpacity){if(!this._circle){this.radius(this.defaultRadius);}
if(!this._grad){this.gradient(this.defaultGradient);}
var ctx=this._ctx;ctx.clearRect(0,0,this._width,this._height);for(var i=0,len=this._data.length,p;i<len;i++){p=this._data[i];ctx.globalAlpha=Math.max(p[2]/this._max,minOpacity===undefined?0.05:minOpacity);ctx.drawImage(this._circle,p[0]-this._r,p[1]-this._r);}
var colored=ctx.getImageData(0,0,this._width,this._height);this._colorize(colored.data,this._grad);ctx.putImageData(colored,0,0);return this;},_colorize:function(pixels,gradient){for(var i=3,len=pixels.length,j;i<len;i+=4){j=pixels[i]*4;if(j){pixels[i-3]=gradient[j];pixels[i-2]=gradient[j+1];pixels[i-1]=gradient[j+2];}}}};return simpleheat;})();function ModelTempDistribution(id,painter,behaviors){Sprite.call(this,id,painter,behaviors);if(!(this.painter&&this.painter.print))this.painter={paint:this.paint};if(!(this.behaviors&&this.behaviors[0]&&this.behaviors[0].execute))this.behaviors=[];this.canvasOffline=document.createElement("canvas");this.ctxOffline=this.canvasOffline.getContext("2d");this.data=[];};ModelTempDistribution.prototype=new Sprite();ModelTempDistribution.prototype.constructor=ModelTempDistribution;ModelTempDistribution.prototype.close=function(){this.canvasOffline=null;this.ctxOffline=null;this.data=[];};ModelTempDistribution.prototype.init=function(){this.canvasOffline.width=this.width;this.canvasOffline.height=this.height;this.loadColorSetting();};ModelTempDistribution.prototype.loadColorSetting=function(){var _this=this;this.loadColorSettingPromise=WebAPI.post('/admin/getColorSetting',{userId:AppConfig.userId}).done(function(result){if(result.success){_this.colorSettings=result.data;}})};ModelTempDistribution.prototype.setMaxMinTemp=function(){if(this.colorSettings){for(var n=0,length=this.colorSettings.length;n<length;n++){if(this.colorSettings[n].type==='max'){configMap.TEMP_RANGE.max=+this.colorSettings[n].value;}else if(this.colorSettings[n].type==='min'){configMap.TEMP_RANGE.min=+this.colorSettings[n].value;}}}};ModelTempDistribution.prototype.paint=function(ctx){ctx.rect(this.x,this.y,this.canvasOffline.width,this.canvasOffline.height);ctx.drawImage(this.canvasOffline,this.x,this.y);};ModelTempDistribution.prototype.update=function(updateData){if(!updateData){return;}
if(!this.width||!this.height){return;}
for(var m=0;m<this.data.length;m++){for(var n=0;n<updateData.length;n++){if(this.data[m].idCom===updateData[n].name){this.data[m].value=updateData[n].value;break;}}}
this.renderTempDistribution();};ModelTempDistribution.prototype.renderTempDistribution=function(){var _this=this,heat;this.loadColorSettingPromise.done(function(){_this.setMaxMinTemp();var allHeatData=calcAllTempData(_this.data,_this.x,_this.y,_this.width,_this.height);if(!allHeatData||!allHeatData.length){return;}
heat=simpleheat(_this.ctxOffline.canvas).data(allHeatData);heat.radius(configMap.heat_radius,configMap.heat_blur);heat.max((configMap.TEMP_RANGE.max-configMap.TEMP_RANGE.min).toFixed(2));heat.draw();});};return ModelTempDistribution;})();var SharpViewScreen=(function($,window,undefined){var _this=null;var showMode={TILE:'Tile',LINEAR:'Linear'};var layoutClasses={'Tile':TileLayout,'Linear':LinearLayout};function SharpViewScreen(sliders,store){_this=this;this.options=SharpViewScreen.DEFAULTS;this.cur=null;this.total=sliders.length;this.sliderList=sliders;this.slidersStatus={};this.layoutHandler=null;this.store=store;this.factoryIoC=new FactoryIoC('analysis');this.curModal=null;this.datasource=new DataSource(this);this.dataSourceConflict=AppConfig.datasource;AppConfig.datasource=this.datasource;this.saveModalJudge=$.Deferred();this.$stage=null;this.$sliders=null;}
SharpViewScreen.prototype={constructor:SharpViewScreen,show:function(){WebAPI.get('/static/views/observer/sharpViewScreen.html').done(function(resultHtml){$('<div class="sharpview-wrap sharpview" id="sharpViewWrap">').appendTo('body').html(resultHtml);_this.init();});},init:function(){var arrHtml=[];this.$stage=$('#sharpViewStage');for(var i=0,len=this.sliderList.length;i<len;i++){arrHtml.push(this.options.itemTmpl.format(i));}
this.$stage.html(arrHtml.join(''));this.$sliders=this.$stage.children('*');this.layout(showMode.LINEAR);},onresize:function(){if(ScreenCurrent.paneCenter&&ScreenCurrent.paneCenter.chart){ScreenCurrent.paneCenter.chart.resize();}},layout:function(mode){var _this=this;var options={};mode=mode||showMode.TILE;if(this.layoutHandler)this.layoutHandler.destroy();switch(mode){case showMode.TILE:break;case showMode.LINEAR:options.onFlipStart=function(e){var pos=e.pos;if(pos===_this.cur)return;};options.onFlipEnd=function(e){var pos=e.pos;_this.cur=pos;_this.renderSlider();};break;}
this.layoutHandler=new layoutClasses[mode](this.$stage,this.$sliders,options);this.layoutHandler.layout();},renderSlider:function(container){this.renderModal(this.cur);this.renderModal(Math.min(this.total-1,Math.max(this.cur-1,0)));this.renderModal(Math.min(this.total-1,Math.max(this.cur+1,0)));},renderModal:function(index){var container=this.$sliders.eq(index).children('div')[0];var modal=this.sliderList[index];var modalId=modal.id;this.curModal=modal.option;if(this.slidersStatus[modalId]==='loaded')return;if(this.curModal.type){var modalClass=this.factoryIoC.getModel(this.curModal.type);this.slidersStatus[modalId]='loaded';new modalClass(container,this.curModal,this).show();}else{this.alertNoData();}},updateModal:function(){},showConfigMode:function(){},setModalOption:function(){},spinnerStop:function(){},saveModal:function(){},alertNoData:function(){},destroy:function(){$('#sharpViewWrap').remove();this.layoutHandler.destroy();AppConfig.datasource=this.dataSourceConflict;}}
SharpViewScreen.DEFAULTS={itemTmpl:'<div class="play-slider-ctn" data-index="{0}"><div style="padding: 20px;z-index: 100;position: absolute;left:0;top:0;right:0;bottom:0;overflow-x: hidden;overflow-y: auto;">This page has no data.</div></div>'};function Layout($stage,$sliders){this.$stage=$stage;this.$sliders=$sliders;this.curPos=null;this.total=null;}
Layout.prototype={constructor:Layout,layout:function(){this.total=this.$sliders.length;this._layout.apply(this,arguments);},destroy:function(){this._destroy();}}
function TileLayout($stage,$sliders){Layout.apply(this,arguments);this.name='Tile';}
TileLayout.prototype=Object.create(Layout.prototype);TileLayout.prototype.constructor=TileLayout;TileLayout.prototype._layout=function(){var per;for(var i=0;i<this.total;i++){per=(i-1)*105;this.$sliders.eq(i).css({'transform':'translateZ(-2500px) translate('+per+'%, 0%)'});}};function LinearLayout($stage,$sliders,options){Layout.apply(this,arguments);this.options=$.extend({},LinearLayout.DEFAULTS,options);this.name='linear';}
LinearLayout.prototype=Object.create(Layout.prototype);LinearLayout.prototype.constructor=LinearLayout;LinearLayout.prototype._layout=function(startPos){var per;this.$stage.addClass(this.options.animateCls);this.attachEvents();this.to(startPos||0);};LinearLayout.prototype.to=function(pos){var _this=this;var direction=pos<this.curPos?'left':'right';var pos=pos===undefined?0:Math.min(Math.max(pos,0),this.total-1);if(pos===this.curPos){this.doBoundAnimation(direction);return;}
this.curPos=pos;typeof _this.options.onFlipStart==='function'&&_this.options.onFlipStart({pos:pos});this.$sliders.each(function(i){if(i<pos)$(this).removeClass().addClass('past');if(i>pos)$(this).removeClass().addClass('future');});window.setTimeout((function(pos){return function(){_this.$sliders.eq(pos).removeClass().addClass('present');}}(pos)),50);this.$sliders.off().on('transitionend',function(e){e=e.originalEvent;if(e.target.className!=='present')return;if(e.propertyName==='transform'){typeof _this.options.onFlipEnd==='function'&&_this.options.onFlipEnd({pos:pos});}});};LinearLayout.prototype.prev=function(){this.to(this.curPos-1);};LinearLayout.prototype.next=function(){this.to(this.curPos+1);};LinearLayout.prototype.doBoundAnimation=function(direction){direction=direction||'left';$slider=this.$sliders.eq(this.curPos);if(direction==='left'){$slider.addClass('bound-left');}else{$slider.addClass('bound-right');}
if(this.curPos===0);else $slider.addClass('bound-right');};LinearLayout.prototype.attachEvents=function(){var _this=this;$(window).on('keydown.sharpview',function(e){switch(e.keyCode){case 37:_this.prev();break;case 38:break;case 39:_this.next();break;case 40:break;}});$(window).on('keyup.sharpview',function(e){switch(e.keyCode){case 37:_this.$sliders.eq(_this.curPos).removeClass('bound-left');break;case 38:break;case 39:_this.$sliders.eq(_this.curPos).removeClass('bound-right');break;case 40:break;}});};LinearLayout.prototype.detachEvents=function(){$(window).off('keydown.sharpview');$(window).off('keyup.sharpview');};LinearLayout.prototype._destroy=function(){this.detachEvents();};LinearLayout.DEFAULTS={animateCls:'linear-1'};var Parallex={step:1000,rateBg1:1,rateBg2:0.5,rateBg3:0.2,direction:1,flowLeft:function(){this.direction=-1;this.flow();},flowRight:function(){this.direction=1;this.flow();},flow:function(){var posBg1=parseFloat(this.$bg1.css('background-position-x'));var posBg2=parseFloat(this.$bg2.css('background-position-x'));var posBg3=parseFloat(this.$bg3.css('background-position-x'));this.changeTransition('.5s','cubic-bezier(0.26,.86,.44,.985)');if(this.direction>0){this.$bg1.css('background-position-x',(posBg1+this.step*this.rateBg1)+'px');this.$bg2.css('background-position-x',(posBg2+this.step*this.rateBg2)+'px');this.$bg3.css('background-position-x',(posBg3+this.step*this.rateBg3)+'px');}
else{this.$bg1.css('background-position-x',(posBg1-this.step*this.rateBg1)+'px');this.$bg2.css('background-position-x',(posBg2-this.step*this.rateBg2)+'px');this.$bg3.css('background-position-x',(posBg3-this.step*this.rateBg3)+'px');}},changeTransition:function(duration,TimingFn){this.$bg1.css({'transition-duration':duration,'transition-timing-function':TimingFn});this.$bg2.css({'transition-duration':duration,'transition-timing-function':TimingFn});this.$bg3.css({'transition-duration':duration,'transition-timing-function':TimingFn});},init:function(){var _this=this;this.$bg1=$('#bg1');this.$bg2=$('#bg2');this.$bg3=$('#bg3');this.$bg1.off().on('transitionend',function(e){var distance=1500;var posBg1=parseFloat(_this.$bg1.css('background-position-x'));var posBg2=parseFloat(_this.$bg2.css('background-position-x'));var posBg3=parseFloat(_this.$bg3.css('background-position-x'));e=e.originalEvent;_this.changeTransition('30s','linear');if(e.propertyName==='background-position-x'){if(_this.direction>0){_this.$bg1.css('background-position-x',(posBg1+distance*_this.rateBg1)+'px');_this.$bg2.css('background-position-x',(posBg2+distance*_this.rateBg2)+'px');_this.$bg3.css('background-position-x',(posBg3+distance*_this.rateBg3)+'px');}else{_this.$bg1.css('background-position-x',(posBg1-distance*_this.rateBg1)+'px');_this.$bg2.css('background-position-x',(posBg2-distance*_this.rateBg2)+'px');_this.$bg3.css('background-position-x',(posBg3-distance*_this.rateBg3)+'px');}}});}}
return SharpViewScreen;}(jQuery,window));﻿
var AnlzBase=(function(){var _this;function AnlzBase(container,option,screen){_this=this;this.container=container;this.options=option;this.screen=screen;this.paneChart=undefined;this.paneNotes=undefined;this.chart=undefined;this.noteCount=0;this.chartAnimationDuration=500;this.spinnerRender=new LoadingSpinner({color:'#00FFFF'});this.noteDefaultWidth=440;this.noteDefaultHeight=220;this.dockArea=[];this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.$svgBox=$('.svgBox');this.graphType='arrow';this.color='red';}
AnlzBase.prototype={show:function(){this.initTools();this.container.innerHTML='';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();if(!this.screen.curModal.noteList){this.screen.curModal.noteList=[];}else{_this.initNotes();}
$divBackgroundContainer=$('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">');if(!this.paneChart){this.paneChart=$('<div style="width: 100%; height: 100%;">')[0];$(this.container).append($divBackgroundContainer).append(this.paneChart);}
else{$(this.container).append($divBackgroundContainer);}
_this.spinnerRender.spin(this.container.parentElement);$('#graphBox').hide();$('.graphActive').click();this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{_this.initGraphs(this.screen.curModal.graphList);}
this.init();},renderModal:function(data){_this=this;_this.spinnerRender.stop();try{_this.render(data);}catch(e){console.warn(e);}
setTimeout(function(){_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);_this.spinnerRender.stop();},_this.chartAnimationDuration);},spinnerStop:function(){Spinner.stop();_this.spinnerRender.stop();},close:function(){this.spinnerRender.stop();this.screen=null;this.options=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();this.$svgBox=null;$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;},init:function(){},errAlert:function(err){var $dataAlert=$('#dataAlert');switch(err){case'no data history':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE6+"</strong>").show().close();break;case'time':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE7+"</strong>").show().close();break;case'invalid time string':new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE8+"</strong>").show().close();break;default:new Alert($dataAlert,"danger","<strong>"+I18n.resource.modalConfig.err.TYPE9+"</strong>").show().close();break;}
setTimeout(function(){_this.screen.refreshPaneCenter(new AnalysisTemplate(_this.screen));},500);},initDock:function(){var arrHtml=[],previewerHtml=[];var $paneDock=$('.pane-dock',this.$parentContainer);if($paneDock.length){this.$paneDock=$paneDock;this.$dockManager=$('.dock-manager',$paneDock);this.$dockPreviewer=$('.dock-previewer-manager',$paneDock);return;}
arrHtml.push('<div class="dock-wheel dock-wheel-fill-icon" data-type="fill"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-fill" data-type="fill" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-top-icon" data-type="top"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-top" data-type="top" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-right-icon" data-type="right"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-right" data-type="right" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-down-icon" data-type="bottom"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-down" data-type="bottom" style="display:none;"></div>');arrHtml.push('<div class="dock-wheel dock-wheel-left-icon" data-type="left"></div>');previewerHtml.push('<div class="dock-previewer dock-previewer-left" data-type="left" style="display:none;"></div>');this.$paneDock=$('<div class="pane-dock" style="position: absolute; left: 0; top: 0; width:100%; height:100%;">');this.$dockManager=$('<div class="dock-manager" style="position: absolute;left: 0; top: 0; width:100%; height:100%;">');this.$dockPreviewer=$('<div class="dock-previewer-manager" style="position: absolute; left:0; top:0; width:100%;height:100%;">');this.$dockManager[0].innerHTML=arrHtml.join('');this.$dockPreviewer[0].innerHTML=previewerHtml.join('');this.$paneDock[0].appendChild(this.$dockManager[0]);this.$paneDock[0].appendChild(this.$dockPreviewer[0]);this.$parentContainer[0].appendChild(this.$paneDock[0]);},resetDock:function(){this.$parentContainer.children('.dock-window-ctn').remove();this.$parentContainer.children('.dock-note-toolbar').remove();this.$paneDock.remove();$(this.container).css({'top':0,'left':0,'bottom':0,'right':0});},initTools:function(){var _this=this;var $noteHideShow=$('#btnNoteHideOrShow');var $graphSelect=$('#graphSelsect');var $graphsBox=$('#graphBox');$('.itemTools .glyphicon-log-out').off('click').on('click',function(){if(!_this.screen)return;_this.screen.refreshPaneCenter(new AnalysisTemplate(_this.screen));$('.divPage.selected').removeClass('selected');$('.itemTools .glyphicon-cog').off('click');$('#rightCt').trigger('click');});$('.itemTools .glyphicon-cog').off('click').on('click',function(){var optionTemplate=_this.screen.factoryIoC.getModel(_this.screen.curModal.type).prototype.optionTemplate;var data=[];for(var i=0;i<_this.screen.curModal.itemDS.length;i++){data.push({});data[i].dsType=_this.screen.curModal.itemDS[i].type;data[i].dsId=_this.screen.curModal.itemDS[i].arrId;data[i].dsName=[];for(var j=0;j<_this.screen.curModal.itemDS[i].arrId.length;j++){data[i].dsName.push(AppConfig.datasource.getDSItemById(_this.screen.curModal.itemDS[i].arrId[j]).alias);}}
var option={};option={modeUsable:optionTemplate.chartConfig,allDataNeed:(optionTemplate.templateParams.paraAnlysMode=='all'),rowDataType:optionTemplate.templateParams.paraName,dataTypeMaxNum:optionTemplate.templateParams.dataTypeMaxNum,templateType:_this.screen.curModal.type,dsChartCog:_this.screen.curModal.dsChartCog,optionPara:{mode:_this.screen.curModal.mode,startTime:_this.screen.curModal.startTime,endTime:_this.screen.curModal.endTime,interval:_this.screen.curModal.format,dataItem:data}};_this.screen.modalConfig.showModalInit(false,option)});$('.itemTools .glyphicon-edit').off('click').click(function(){_this.createNote();$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$('.divNote').show();});$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$noteHideShow.off('click').click(function(){if($noteHideShow.hasClass('glyphicon-eye-close')){$noteHideShow.removeClass('glyphicon-eye-close').addClass('glyphicon-eye-open');$('.divNote').show();}else if($noteHideShow.hasClass('glyphicon-eye-open')){$noteHideShow.removeClass('glyphicon-eye-open').addClass('glyphicon-eye-close');$('.divNote').hide();}});if($graphsBox.length===0){$graphsBox=$('<ul id="graphBox" style="top:36px;left:auto;right:18px;width:118px;float:right;padding:5px 10px;position:absolute;z-index:150;border:1px solid #DDDDDE;border-radius:5px;background:#fff;display:none;">'+'<li style="width:98px;margin:0 auto;list-style:none;" class="graphSel"><i class="icon-arrow-right" value="arrow" style="font-size:18px;color:#B6B4B4;margin-right:15px;display:inline-block!important;" id="arrowActive"></i>'+'<i class="icon-check-empty" id="rectActive" value="rect" style="font-size:18px;color:#B6B4B4;margin-right:15px;display:inline-block!important;"></i>'+'<i class="icon-circle-blank" id="circleActive" value="circle" style="font-size:18px;color:#B6B4B4;display:inline-block!important;"></i></li>'+'<li class="colorTotal" style="width:98px;margin:10px auto 0px;list-style:none;display:none;"><div style="width:24px;height:24px;border:1px solid #BDBEBF;float:left;margin-right:10px;">'+'<span class="colorSelect" style="display:block;width:20px;height:20px;margin:1px;background:red;"></span></div>'+'<div class="colorList" style="float:left;width:60px;margin-top:-5px;">'+'<span style="display:inline-block;width:11px;height:11px;background:#000;margin-right:3px;line-height:11px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;background:#7ab900;margin-right:3px;line-height:11px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#007acc;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ecede5;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ff2525;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#fcd209;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#ff5500;margin-right:3px;font-size:11px;"></span>'+'<span style="display:inline-block;width:11px;height:11px;line-height:11px;background:#a6b16c;font-size:11px;"></span></div>'+'<br style="clear:both;"></li>'+'</ul>');$('#anlsPaneContain').append($graphsBox);}
$('#anlsPaneContain').css('position','relative');$('#graphSelsect').off('click').click(function(){if($graphsBox.is(':hidden')){$graphsBox.show();}else{$graphsBox.hide();}});$('#btnDataFilter').off('click').click(function(){new DataCalcFilter(_this).show();});$('#anlsPaneContain .colorList span').hover(function(){$(this).css({'border-width':'1px','border-style':'solid','border-color':'#ddddde','border-radius':'5px'});},function(){$(this).css({'border':'none','border-radius':'0px'});});$('#anlsPaneContain .colorList span').off('click').click(function(){$('#anlsPaneContain .colorSelect').css('background-color',$(this).css('background-color'));_this.color=$('#anlsPaneContain .colorSelect').css('background-color');$('.svgGraph').remove();_this.createGraphs(_this.graphType,_this.color);});$('#anlsPaneContain .graphSel i').off('click').click(function(){var color=$('#anlsPaneContain .colorSelect').css('background-color');var $graphSel=$(this);_this.graphType=$graphSel.attr('value');if(!$graphSel.hasClass('graphActive')){$graphSel.css('color','#000');$graphSel.siblings().css('color','#B6B4B4');$graphSel.siblings().removeClass('graphActive');$graphSel.addClass('graphActive');}else{$graphSel.css('color','#B6B4B4');$graphSel.removeClass('graphActive');}
if($('#anlsPaneContain .graphSel i').hasClass('graphActive')){$('#anlsPaneContain .colorTotal').show();}else{$('#anlsPaneContain .colorTotal').hide();}
if(!_this.$svgBox){_this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');$('#anlsPaneContain .panel-body').append(_this.$svgBox);}else{if(_this.$svgBox.length===0){_this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');$('#anlsPaneContain .panel-body').append(_this.$svgBox);}}
_this.createGraphs(_this.graphType,_this.color);});},createGraphs:function(graphType,color){if(!_this.$svgBox){$('.svgBox').remove();return}
var $svgGraph=$('.svgGraph'),$svgDefs=$('.svgDefs'),svgW,svgH,$close=$('.close');var $svgGraphCopy=$('.svgGraphCopy');var $svgCopyBox=$('.svgCopyBox'),$removeGraphBox=$('.removeGraphBox');if($svgGraph.length===0){$svgGraph=$('<svg class="svgGraph" style="position:absolute;z-index:149;">'+'<defs><marker id="arrowHead" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="red"/></marker>'+'</defs>'+'<path id="arrow-line" marker-end="url(#arrowHead)" stroke-width="4" fill="none" stroke="red" d=""/>'+'<ellipse style="fill:rgba(0,0,0,0);stroke-width:2px;" orient="auto" class="circle" orient="auto"/>'+'<rect style="fill:rgba(0,0,0,0);stroke-width:2px;" class="rect" orient="auto"/>'+'</svg>');_this.$svgBox.append($svgGraph);}
svgW=$('#anlsPaneContain .panel-body').width();svgH=$('#anlsPaneContain .panel-body').height();$svgGraph[0].setAttribute("viewBox","0 0 "+svgW+" "+svgH);$svgGraph[0].setAttribute("width",svgW);$svgGraph[0].setAttribute("height",svgH);if(graphType=='arrow'){function rotate(angle){var arrowLine=$('#arrow-line')[0];arrowLine.setAttribute("transform","rotate("+angle+")");}
function lineTo(start,end){var arrowLine=$('#arrow-line')[0];var arrowHeadP=$('#arrowHead path')[0];arrowLine.setAttribute('d','M'+start.join(',')+' L'+end.join(','));arrowLine.setAttribute("stroke",color);arrowHeadP.setAttribute('fill',color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;lineTo([downX,downY],[curX,curY]);}
$svgGraph[0].onmouseup=function(e){if(!_this.$svgBox){$('.svgBox').remove();return}
var xDiffer=Math.abs(e.offsetX-downX);var yDiffer=Math.abs(e.offsetY-downY);if(xDiffer<20){xDiffer=20}
if(yDiffer<20){yDiffer=20}
$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();if(e.offsetX>=downX&&e.offsetY<downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgW)+'%;top:'+((e.offsetY)*100/svgH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph" style="display:none;position:absolute;top:-10px;right:-10px;z-index:149;font-size:18px;color:#000;"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+newGraphId+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'">'+'<defs><marker id="marker_'+newGraphId+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+_this.color+'"/></marker></defs>'+'<path class="arrow-line2" marker-end="url(#marker_'+newGraphId+')" stroke-width="4" stroke="'+_this.color+'" d="M0 , '+yDiffer+'L'+Math.abs(e.offsetX-downX-8)+',8"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);_this.$svgBox.append($svgCopyBox);_this.graphHover();$('.svgGraph').remove();_this.graphDrage(newGraphId);_this.saveGraph(_this.getGraphData($svgGraphCopy));}
else if(e.offsetX>downX&&e.offsetY>=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgW)+'%;top:'+(downY*100/svgH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph" style="display:none;position:absolute;top:-10px;right:-10px;z-index:149;font-size:18px;color:#000;"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+newGraphId+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'">'+'<defs><marker id="marker_'+newGraphId+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+_this.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+newGraphId+')" stroke-width="4" stroke="'+_this.color+'" d="M0 ,0 '+'L'+Math.abs(e.offsetX-downX-8)+','+Math.abs(e.offsetY-downY-8)+'"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);_this.$svgBox.append($svgCopyBox);_this.graphHover();$('.svgGraph').remove();_this.graphDrage(newGraphId);_this.saveGraph(_this.getGraphData($svgGraphCopy));}
else if(e.offsetX<=downX&&e.offsetY<=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+((e.offsetX)*100/svgW)+'%;top:'+((e.offsetY)*100/svgH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph" style="display:none;position:absolute;top:-10px;right:-10px;z-index:149;font-size:18px;color:#000;"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+newGraphId+'" id="new Date().getTime()" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'">'+'<defs><marker id="marker_'+newGraphId+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+_this.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+newGraphId+')" stroke-width="4" stroke="'+_this.color+'" d="M '+xDiffer+','+yDiffer+'L8,8"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);_this.$svgBox.append($svgCopyBox);_this.graphHover();$('.svgGraph').remove();_this.graphDrage(newGraphId);_this.saveGraph(_this.getGraphData($svgGraphCopy));}
else if(e.offsetX<downX&&e.offsetY>=downY){$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(xDiffer+8)+'px;height:'+(yDiffer+8)+'px;padding:2px;position:absolute;left:'+((e.offsetX)*100/svgW)+'%;top:'+(downY/svgH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph" style="display:none;position:absolute;top:-10px;right:-10px;z-index:149;font-size:18px;color:#000;"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+newGraphId+'" viewBox="0 0 '+xDiffer+' '+yDiffer+'" width="'+xDiffer+'" height="'+yDiffer+'" >'+'<defs><marker id="marker_'+newGraphId+'" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="'+_this.color+'"/></marker></defs>'+'<path class="arrow-line1" marker-end="url(#marker_'+newGraphId+')" stroke-width="4" stroke="'+_this.color+'" d="M'+xDiffer+' ,0 '+' L8,'+Math.abs(e.offsetY-downY-8)+'"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);_this.$svgBox.append($svgCopyBox);_this.graphHover();$('.svgGraph').remove();_this.graphDrage(newGraphId);_this.saveGraph(_this.getGraphData($svgGraphCopy));}
$('#graphBox').hide();$('.graphActive').click();$('.svgGraph').remove();}}}
if(graphType=='rect'){function rectTo(start,end){var rect=$('.rect')[0];rect.setAttribute('width',Math.abs(end[0]-start[0]));rect.setAttribute('height',Math.abs(end[1]-start[1]));rect.setAttribute('x',start[0]);rect.setAttribute('y',start[1]);rect.setAttribute('stroke',color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;rectTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(Math.abs(e.offsetX-downX)+8)+'px;height:'+(Math.abs(e.offsetY-downY)+8)+'px;padding:2px;position:absolute;left:'+(downX*100/svgW)+'%;top:'+(downY*100/svgH)+'%;z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph" style="display:none;position:absolute;top:-10px;right:-10px;z-index:149;font-size:18px;color:#000;"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+newGraphId+'" viewBox="0 0 '+Math.abs(e.offsetX-downX)+' '+Math.abs(e.offsetY-downY)+'" width="'+Math.abs(e.offsetX-downX)+'" height="'+Math.abs(e.offsetY-downY)+'">'+'<rect style="fill:rgba(0,0,0,0);stroke-width:4px;stroke:'+_this.color+'" orient="auto" width="'+Math.abs(e.offsetX-downX)+'" height="'+Math.abs(e.offsetY-downY)+'"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);_this.$svgBox.append($svgCopyBox);_this.graphHover();_this.graphDrage(newGraphId);_this.saveGraph(_this.getGraphData($svgGraphCopy));$('#graphBox').hide();$('.graphActive').click();$('.svgGraph').remove();}}}
if(graphType=='circle'){function circleTo(start,end){var circle=$('.circle')[0];circle.setAttribute("cx",start[0]+Math.abs(end[0]-start[0])/2);circle.setAttribute("cy",start[1]+Math.abs(end[1]-start[1])/2);circle.setAttribute("rx",Math.abs(end[0]-start[0])/2);circle.setAttribute("ry",Math.abs(end[1]-start[1])/2);circle.setAttribute("stroke",color);}
$svgGraph[0].onmousedown=function(e){var downX=e.offsetX;var downY=e.offsetY;$svgGraph[0].onmousemove=function(e){var curX=e.offsetX;var curY=e.offsetY;circleTo([downX,downY],[curX,curY]);};$svgGraph[0].onmouseup=function(e){$svgGraph[0].onmousemove=null;$svgGraph[0].onmouseup=null;var newGraphId=new Date().getTime();$svgCopyBox=$('<div class="svgCopyBox" style="width:'+(Math.abs(e.offsetX-downX)+8)+'px;height:'+(Math.abs(e.offsetY-downY)+8)+'px;position:absolute;left:'+(downX*100/svgW)+'%;top:'+(downY*100/svgH)+'%;z-index:149;padding:2px;">'+'<span class="glyphicon glyphicon-remove deleteGraph" style="display:none;curor:pointer;position:absolute;top:-10px;right:-10px;z-index:149;font-size:18px;color:#000;"></span></div>');$svgGraphCopy=$('<svg class="svgGraphCopy" id="'+newGraphId+'" viewBox="0 0 '+Math.abs(e.offsetX-downX)+' '+Math.abs(e.offsetY-downY)+'" width="'+Math.abs(e.offsetX-downX)+'" height="'+Math.abs(e.offsetY-downY)+'" >'+'<ellipse style="fill:rgba(0,0,0,0);stroke-width:3px;stroke:'+_this.color+'" orient="auto" cx="'+Math.abs(e.offsetX-downX)/2+'" cy="'+Math.abs(e.offsetY-downY)/2+'" rx="'+Math.abs(e.offsetX-downX-4)/2+'" ry="'+Math.abs(e.offsetY-downY-4)/2+'" x="0" y="0"/>'+'</svg>');$svgCopyBox.append($svgGraphCopy);_this.$svgBox.append($svgCopyBox);_this.graphHover();_this.graphDrage(newGraphId);_this.saveGraph(_this.getGraphData($svgGraphCopy));$('#graphBox').hide();$('.graphActive').click();$('.svgGraph').remove();}}}},graphHover:function(){$('.svgCopyBox').hover(function(){_this.deleteGraph();$(this).children('.deleteGraph').show();$(this).css({'border-width':'2px','border-style':'dashed','border-color':'#000','cursor':'move'});},function(){$(this).children('.deleteGraph').hide();$(this).css('border','none');});},deleteGraph:function(){if($('.deleteGraph').length===0){return;}
$('.deleteGraph').hover(function(e){$(this).css('cursor','pointer');},function(){$(this).css('cursor','');});$('.deleteGraph').off('click').click(function(){$(this).parent('.svgCopyBox').remove();var index=_this.getGraphListIndex($(this).parent('.svgCopyBox').children('.svgGraphCopy').attr('id'));if(index!=undefined){_this.screen.curModal.graphList.splice(index,1);_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}});},graphDrage:function(id){var $target=$('#'+id);if($target.length===0){return;}
var svgGraphCopy=$target[0];var disX=0,disY=0;svgGraphCopy.onmousedown=function(e){var svgCopyBox=svgGraphCopy.parentNode;var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=e.clientX+scrollLeft-svgCopyBox.offsetLeft;disY=e.clientY+scrollTop-svgCopyBox.offsetTop;this.onmousemove=function(e){var ol=e.clientX+scrollLeft;var ot=e.clientY+scrollTop;var l=ol-disX;var t=ot-disY;svgCopyBox.style.left=l+"px";svgCopyBox.style.top=t+"px";var isTop=svgCopyBox.offsetTop<0
var isLeft=svgCopyBox.offsetLeft<0;var isRight=svgCopyBox.offsetParent.offsetWidth-svgCopyBox.offsetLeft<svgCopyBox.offsetWidth;var isBottom=svgCopyBox.offsetParent.offsetHeight-svgCopyBox.offsetTop<svgCopyBox.offsetHeight;if(isTop){svgCopyBox.style.top='0px';}
if(isLeft){svgCopyBox.style.left='0px';}
if(isRight){svgCopyBox.style.left=svgCopyBox.parentNode.offsetWidth-svgCopyBox.offsetWidth+'px';}
if(isBottom){svgCopyBox.style.top=svgCopyBox.parentNode.offsetHeight-svgCopyBox.offsetHeight+'px';}}
this.onmouseup=function(e){this.onmousemove=null;this.onmouseup=null;var graph={id:id,top:(parseInt(svgCopyBox.style.top.split('px')[0])*100/_this.$svgBox.height()).toFixed(2)+'%',left:(parseInt(svgCopyBox.style.left.split('px')[0])*100/_this.$svgBox.width()).toFixed(2)+'%',}
_this.saveGraph(graph);}}},initGraphs:function(graphs){var temp;var tpl_arrow='<svg class="svgGraphCopy" id="{id}" viewBox="0 0 {width} {height}" width="{width}" height="{height}" >'+'<defs><marker id="{marker_id}" orient="auto" markerWidth="2" markerHeight="4" refX="0.1" refY="2"><path d="M0,0 V4 L2,2 Z" fill="{color}"/></marker></defs>'+'<path class="arrow-line2" marker-end="url(#{marker_id})" stroke-width="4" stroke="{color}" d="{path_d}"/>'+'</svg>';var tpl_circle='<svg class="svgGraphCopy" id="{id}" viewBox="0 0 {width} {height}" width="{width}" height="{height}" >'+'<ellipse style="fill:rgba(0,0,0,0);stroke-width:3px;stroke:{color}" orient="auto" cx="{cx}" cy="{cy}" rx="{rx}" ry="{ry}" x="0" y="0"/>'+'</svg>';var tpl_rect='<svg class="svgGraphCopy" id="{id}" viewBox="0 0 {width} {height}" width="{width}" height="{height}" >'+'<rect style="fill:rgba(0,0,0,0);stroke-width:4px;stroke:{color}" orient="auto" width="{width}" height="{height}"/>'+'</svg>';graphs.forEach(function(graph){renderGraph(graph);});function renderGraph(graph){var graphTempl={id:graph.id,type:graph.type,color:graph.color,top:graph.top,left:graph.left,width:graph.width,height:graph.height,marker_id:graph.marker_id?graph.marker_id:null,path_d:graph.path_d?graph.path_d:null,cx:graph.cx?graph.cx:0,cy:graph.cy?graph.cy:0,rx:graph.rx?graph.rx:0,ry:graph.ry?graph.ry:0}
if(graph){if(graph.type=='arrow'){temp=tpl_arrow.formatEL(graphTempl)}else if(graph.type=='rect'){temp=tpl_rect.formatEL(graphTempl);}else if(graph.type=='circle'){temp=tpl_circle.formatEL(graphTempl);}
var box_Html='<div class="svgCopyBox" style="width:'+(graph.width+8)+'px;height:'+(graph.height+8)+'px;padding:2px;position:absolute;left:'+graph.left+';top:'+graph.top+';z-index:149;">'+'<span class="glyphicon glyphicon-remove deleteGraph" style="display:none;curor:pointer;position:absolute;top:-10px;right:-10px;z-index:149;font-size:18px;color:#000;"></span>'+temp+'</div>';_this.$svgBox.append(box_Html);onEvents()}
function onEvents(){_this.graphHover();_this.deleteGraph();_this.graphDrage(graph.id);}}},createNote:function(note){var origZIndex;var notePos=getDivNotePos();var dockTriggerIndex=null;var $divNote=$('<div class="divNote">').click(function(){if($('.divNote').length>1){_this.curtNote=$divNote[0];if(this.style.zIndex<_this.getNoteMaxZIndex()){this.style.zIndex=_this.getNoteMaxZIndex()+1;origZIndex=this.style.zIndex;}}}).hover(function(e){if(this.style.zIndex<_this.getNoteMaxZIndex()){origZIndex=getComputedStyle(this).zIndex;this.style.zIndex=_this.getNoteMaxZIndex()+1;}}).attr('id',note?note.id:(new Date()).valueOf()).css({zIndex:_this.getNoteMaxZIndex()+1,left:note?note.x:'auto',right:note?'auto':notePos.x+'px',top:note?note.y:notePos.y,width:note?note.width:this.noteDefaultWidth+'px',height:note?note.height:this.noteDefaultHeight+'px',backgroundColor:note?note.bgColor:''}).mousedown(_this.doDown).mouseup(_this.doUp);var $divTitle=$('<div class="title">').appendTo($divNote);$divTitle[0].draggable=true;setDrag($divTitle[0]);var disX=0;var disY=0;function setDrag(obj){obj.onmouseover=function(){obj.style.cursor="move";}
obj.onmousedown=function(event){var realDragObj=obj.parentNode
var scrollTop=document.documentElement.scrollTop||document.body.scrollTop;var scrollLeft=document.documentElement.scrollLeft||document.body.scrollLeft;disX=event.clientX+scrollLeft-realDragObj.offsetLeft;disY=event.clientY+scrollTop-realDragObj.offsetTop;_this.showDockWheel();document.onmousemove=function(event){var ol=event.clientX+scrollLeft;var ot=event.clientY+scrollTop;var l=ol-disX;var t=ot-disY;realDragObj.style.left=l+"px";realDragObj.style.top=t+"px";var isTop=realDragObj.offsetTop<0
var isLeft=realDragObj.offsetLeft<0;var isRight=realDragObj.offsetParent.offsetWidth-realDragObj.offsetLeft<realDragObj.offsetWidth;var isBottom=realDragObj.offsetParent.offsetHeight-realDragObj.offsetTop<realDragObj.offsetHeight;if(isTop){realDragObj.style.top='0px';}
if(isLeft){realDragObj.style.left='0px';}
if(isRight){realDragObj.style.left=realDragObj.parentNode.offsetWidth-realDragObj.offsetWidth+'px';}
if(isBottom){realDragObj.style.top=realDragObj.parentNode.offsetHeight-realDragObj.offsetHeight+'px';}
var area;if(dockTriggerIndex!==null){area=_this.dockArea[dockTriggerIndex];if(ol>area.left&&ol<area.right&&ot>area.top&&ot<area.bottom){}else{dockTriggerIndex=null;area.$ele.removeClass('on');_this.hideDockPreviewer();}
return;}
for(var i=0,len=_this.dockArea.length;i<len;i++){area=_this.dockArea[i];if(ol>area.left&&ol<area.right&&ot>area.top&&ot<area.bottom){dockTriggerIndex=i;area.$ele.addClass('on');_this.showDockPreviewer(area.$ele[0].dataset.type);return;}}}
document.onmouseup=function(){var area=_this.dockArea[dockTriggerIndex];document.onmousemove=null;document.onmouseup=null;var note={id:realDragObj.id,x:((realDragObj.offsetLeft/realDragObj.offsetParent.offsetWidth)*100).toFixed(2)+'%',y:((realDragObj.offsetTop/realDragObj.offsetParent.offsetHeight)*100).toFixed(2)+'%'};_this.hideDockPreviewer();_this.hideDockWheel();if(dockTriggerIndex!==null){_this.saveDockNoteLayout(note.id,area.$ele[0].dataset.type);note.x='10%';note.y='10%';_this.saveDockLayout();return false;}
_this.saveNote(note);}
return false;}}
var $divPin=$('<div class="glyphicon pinIcon grow">').appendTo($divTitle);$divPin.mousedown(function(e){_this.removeNote(this);e.stopPropagation();});var $divText=$('<div class="divText gray-scrollbar">').appendTo($divNote);if(_this.isShareMode!==1){$divText.click(function(e){var $modalConfig;WebAPI.get('/static/views/observer/widgets/modalUEditor.html').done(function(resultHTML){$('.divNote').hide();$('.dock-layout').hide();$('.svgBox').hide();$(_this.container).append(resultHTML);$modalConfig=$('#modalUEditor');$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$('.divNote').show();$('.dock-layout').show();$('#modalUEditorContainer').remove();$('#edui_fixedlayer').remove();$('#anlsPane').css({overflowX:'hidden',overflowY:'auto'})
$('.svgBox').show();});$modalConfig.off('show.bs.modal').on('show.bs.modal',function(){$('#anlsPane').css({overflow:'visible'})
UE.delEditor('ueditor');UE.getEditor('ueditor',{lang:(I18n.type=='zh'?'zh-cn':'en')}).ready(function(){UE.insertPic(this);$(document.querySelector('iframe')).addClass('gray-scrollbar')
var bodyEditor=document.querySelector('iframe').contentWindow.document.querySelector('body');note&&note.bgColor&&(bodyEditor.style.backgroundColor=note.bgColor);bodyEditor.innerHTML=note?note.text:'';});});$modalConfig.off('shown.bs.modal').on('shown.bs.modal',function(){});$modalConfig.modal('show');$(_this.container).find('#saveNote').off('click').on('click',function(){var body=$('iframe','.edui-editor-iframeholder')[0].contentWindow.document.querySelector('body');var content=body.innerHTML;var newNote={id:$divNote[0].id};if(note){newNote.text=content;newNote.bgColor=body.style.backgroundColor;}else{newNote.text=content;newNote.bgColor=body.style.backgroundColor;newNote.height=_this.noteDefaultHeight+'px';newNote.width=_this.noteDefaultWidth+'px';$divNote[0].style.right='';$divNote[0].style.left=($divNote.parent().width()-_this.noteDefaultWidth)+'px';}
_this.saveNote(newNote);$divText.html(content);$divNote.css({backgroundColor:newNote.bgColor})
$modalConfig.modal('hide');if(note){note.text=content;note.bgColor=newNote.bgColor;}else{note=newNote;}})});});}
$divText.html(note?note.text:'');note&&note.bgColor&&$divNote.css({backgroundColor:note.bgColor});$(this.paneNotes).append($divNote);$(document).on('click','#st-container',_this.doClick);$(document).on('mousemove','#st-container',_this.doMove);function getDivNotePos(){var pos={}
var $lastNote=$('.divNote:nth-last-child(1)');if($lastNote[0]){if($lastNote[0].offsetLeft<100){pos.x=0;pos.y=$lastNote[0].offsetTop+$lastNote[0].offsetHeight+20;_this.noteCount=0;}else{++_this.noteCount;pos.x=_this.noteCount*130;pos.y=$lastNote[0].offsetTop;}}else{pos.x=0;pos.y=0;}
return pos;}},removeNote:function(obj){if(confirm(i18n_resource.analysis.workspace.CONFIRM_NOTE_DELETE)){var $divNote=$(obj).closest('.divNote');$divNote.remove();var index=_this.getNoteListIndex($divNote.attr('id'));if(index!=undefined){_this.screen.curModal.noteList.splice(index,1);_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);}}},initNotes:function(){var _this=this;var notes=this.screen.curModal.noteList;var layout=this.screen.curModal.layout||{};if(!notes.length)return;notes.forEach(function(row){var dockPosition=null;for(var t in layout){if(!layout.hasOwnProperty(t)){continue;}
if(!layout[t]||!layout[t].length){continue;}
if(layout[t].indexOf(row.id)>-1){dockPosition=t;break;}}
if(!!dockPosition){_this.createDockNote(row,dockPosition);}else{_this.createNote(row);}});_this.layoutDockNotes();},hideNotes:function(){},showNotes:function(){},getNoteMaxZIndex:function(){var divNoteList=$('.divNote');var maxZIndex=102;for(var i=0;i<divNoteList.length;i++){var zIndex=parseInt(getComputedStyle(divNoteList[i]).zIndex);if(zIndex>maxZIndex){maxZIndex=zIndex;}}
return maxZIndex;},getNoteListIndex:function(id){for(var i=0;i<_this.screen.curModal.noteList.length;i++){if(_this.screen.curModal.noteList[i].id==id){return i;}}},showDockWheel:function(){var _this=this;var $dockFill=this.$dockManager.children('.dock-wheel-fill-icon');var $dockTop=this.$dockManager.children('.dock-wheel-top-icon');var $dockRight=this.$dockManager.children('.dock-wheel-right-icon');var $dockDown=this.$dockManager.children('.dock-wheel-down-icon');var $dockLeft=this.$dockManager.children('.dock-wheel-left-icon');var offset;this.$parentContainer.addClass('on');[$dockFill,$dockTop,$dockRight,$dockDown,$dockLeft].forEach(function($dock,i){offset=$dock.offset();_this.dockArea.push({'left':offset.left,'top':offset.top,'right':offset.left+$dock.width(),'bottom':offset.top+$dock.height(),'$ele':$dock});});},hideDockWheel:function(){this.$parentContainer.removeClass('on');this.$dockManager.children().removeClass('on');},showDockPreviewer:function(type){this.$dockPreviewer.show();this.$dockPreviewer.children('[data-type="'+type+'"]').show();},hideDockPreviewer:function(){this.$dockPreviewer.children().hide();this.$dockPreviewer.hide();},saveDockNoteLayout:function(noteId,direction){var layout=this.screen.curModal.layout;var notes=this.screen.curModal.noteList;var note;if(['top','right','bottom','left'].indexOf(direction)===-1)return;if(!layout){layout=this.screen.curModal.layout={};}
layout[direction]=layout[direction]||[];if(layout[direction].indexOf(noteId)>-1)return;layout[direction].push(noteId);$('#'+noteId).remove();note=notes.filter(function(row,i){return row.id===noteId;});if(note&&note.length){this.createDockNote(note[0],direction);this.layoutDockNotes();_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},initDockToolbar:function(){},createDockNote:function(note,direction){var _this=this;var $ctn=this.$parentContainer.children('.dock-window-ctn');var $divNote=$('<div class="dock-note" style="background-color: '+note.bgColor+'">'+'<div class="dock-note-resizer" data-direction="'+direction+'"></div>'+'<button type="button" class="close editor"><span aria-hidden="true">'+I18n.resource.analysis.workspace.EDIT_NOTE+'</span></button>'+'<button type="button" class="close cancel"><span aria-hidden="true">'+I18n.resource.analysis.workspace.CANCEL_FIX+'</span></button>'+'<div class="dock-note-ct gray-scrollbar" data-id="'+note.id+'"></div>'+'<button id="saveDockNote" type="button" class="" style="display:none;position:absolute;bottom:5px;right:5px;z-index: 1000;color: #333;border-radius: 4px;box-shadow: 0px 3px 8px 2px #ccc;border: 1px solid #ccc;">Save</button>'+'</div>');var $divNoteCt=$divNote.children('.dock-note-ct');var $noteResizer=$divNote.children('.dock-note-resizer');var $layoutCtn,$layoutCtnWrap;var $layoutContainer;if($ctn.length===0){$ctn=$('<div class="dock-window-ctn">');this.$parentContainer.append($ctn[0]);}
if(['top','bottom'].indexOf(direction)>-1){$layoutContainer=$ctn;$divNoteCt.height(note.height);}
if(['left','right'].indexOf(direction)>-1){$layoutCtnWrap=$ctn.children('.dock-layout-wrap');if($layoutCtnWrap.length===0){$layoutCtnWrap=$('<div class="dock-layout-wrap">');$ctn.append($layoutCtnWrap);}
$layoutContainer=$layoutCtnWrap;$divNoteCt.width(note.width);}
$layoutCtn=$layoutContainer.children('.dock-layout-'+direction);if($layoutCtn.length===0){$layoutCtn=$('<div class="dock-layout dock-layout-'+direction+'" data-direction="'+direction+'">');$layoutContainer.append($layoutCtn);}
$divNoteCt.html(note.text);$layoutCtn.append($divNote);$divNote.children('.cancel').off().click(function(){var $this=$(this);var $curNote=$this.closest('.dock-note');var $curNoteCt=$curNote.children('.dock-note-ct');var id=$curNoteCt[0].dataset.id;var index=_this.getNoteListIndex(id);var note=_this.screen.curModal.noteList[index];var arr=_this.screen.curModal.layout[direction];for(var i=0,len=arr.length;i<len;i++){if(arr[i]===id){arr.splice(i,1);break;}}
_this.createNote({id:id,text:$curNoteCt.html(),x:note.x,y:note.y,width:note.width,height:note.height,bgColor:note.bgColor});$curNote.remove();_this.layoutDockNotes('top');_this.saveDockLayout();});$divNote.children('.editor').off().click(function(e){$(document).click();var realHeight=getComputedStyle($divNoteCt[0]).height;var height=realHeight<'100px'?'100px':realHeight;var width=getComputedStyle($divNoteCt[0]).width;var $saveDockNote=$('#saveDockNote');$divNoteCt.hide();$('.divNote').hide();$('.svgBox').hide();$divNote.append('<div style="width: '+width+';height: '+height+';"><script id="ueditor" type="text/plain" style="height:calc(100% - 20px);"></script></div>');UE.delEditor('ueditor');UE.getEditor('ueditor',{lang:(I18n.type=='zh'?'zh-cn':'en')}).ready(function(){UE.insertPic(this);$saveDockNote.show();var iframe=document.querySelector('iframe');var iframeHtml=iframe.contentWindow.document.querySelector('html');var bodyEditor=iframe.contentWindow.document.querySelector('body');$(iframe).addClass('gray-scrollbar');$(iframeHtml).css({overflowX:'hidden'});note&&note.bgColor&&(bodyEditor.style.backgroundColor=note.bgColor);$('.edui-editor-iframeholder').css({height:parseInt(height.split('px')[0])-$('.edui-editor-toolbarbox').height()});bodyEditor.innerHTML=note?note.text:'';$saveDockNote.off('click').on('click',function(){$divNoteCt[0].innerHTML=bodyEditor.innerHTML;var newNote={id:$divNoteCt.attr('data-id'),text:$divNoteCt[0].innerHTML,bgColor:bodyEditor.style.backgroundColor}
_this.saveNote(newNote);note.text=$divNoteCt[0].innerHTML;note.bgColor=bodyEditor.style.backgroundColor;$(this).hide();Spinner.spin($('.dock-layout')[0]);var timer=setTimeout(function(){UE.delEditor('ueditor');$('#ueditor').parent().remove();$divNoteCt.show();$('.divNote').show();$('.svgBox').show();clearTimeout(timer);Spinner.stop();},1500);});});});$noteResizer.off('mousedown').mousedown(function(e){$(document).click();var $resizer=$(this);var $note=$resizer.closest('.dock-note');var $noteCt=$note.children('.dock-note-ct');var $wrap=_this.$parentContainer.find('.dock-layout-wrap');var $container=$(_this.container);var direction=$resizer[0].dataset.direction;var downX,downY;var downWidth=$noteCt.width();var downHeight=$noteCt.height();var ctnPos={left:parseFloat($container.css('left'))||0,right:parseFloat($container.css('right'))||0,top:parseFloat($container.css('top'))||0,bottom:parseFloat($container.css('bottom'))||0}
downX=e.pageX;downY=e.pageY;$(document).mousemove(function(e){var moveX=e.pageX;var moveY=e.pageY;var delta;if(direction==='left'){delta=moveX-downX;$noteCt.width(downWidth+delta);}else if(direction==='right'){delta=downX-moveX;$noteCt.width(downWidth+delta);}else if(direction==='top'){delta=moveY-downY;$noteCt.height(downHeight+delta);$wrap.css('top',ctnPos.top+delta);}else if(direction==='bottom'){delta=downY-moveY;$noteCt.height(downHeight+delta);$wrap.css('bottom',ctnPos.bottom+delta);}});$(document).mouseup(function(e){var $this=$(this);var id=$noteCt[0].dataset.id;var params={id:id};var moveX=e.pageX;var moveY=e.pageY;var delta;if(direction==='left'){delta=moveX-downX;$noteCt.width(downWidth+delta);$container.css('left',ctnPos.left+delta);}else if(direction==='right'){delta=downX-moveX;$noteCt.width(downWidth+delta);$container.css('right',ctnPos.right+delta);}else if(direction==='top'){delta=moveY-downY;$noteCt.height(downHeight+delta);$wrap.css('top',ctnPos.top+delta);$container.css('top',ctnPos.top+delta);}else if(direction==='bottom'){delta=downY-moveY;$noteCt.height(downHeight+delta);$wrap.css('bottom',ctnPos.bottom+delta);$container.css('bottom',ctnPos.bottom+delta);}
if(direction==='left'||direction==='right'){params['width']=$note.width();}else{params['height']=$note.height();}
_this.saveNote(params);_this.screen.onresize();$this.off('mousemove');$this.off('mouseup');});e.stopPropagation();});},layoutDockNotes:function(){var _this=this;var $ctn=this.$parentContainer.children('.dock-window-ctn');var $layoutCtnWrap=$ctn.children('.dock-layout-wrap');var $container=$(this.container);$ctn.find('.dock-layout').each(function(i,dom){var $this=$(this);var direction=$this[0].dataset.direction;var $notes=$this.children('.dock-note');var sum=0;if($notes.length===0){$this.remove();}
if(['left','right'].indexOf(direction)>-1){$notes.each(function(i,dom){var $this=$(this);var width=$this.outerWidth();sum+=width;});}
if(['top','bottom'].indexOf(direction)>-1){$notes.each(function(i,dom){var $this=$(this);var height=$this.outerHeight();sum+=height;});$layoutCtnWrap.css(direction,sum);}
$container.css(direction,sum);});_this.screen.onresize();},saveDockLayout:function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);},resizeObject:function(){this.el=null;this.dir="";this.grabx=null;this.graby=null;this.width=null;this.height=null;this.left=null;this.top=null;},getDirection:function(el){var xPos,yPos,offset,dir;dir="";xPos=window.event.offsetX;yPos=window.event.offsetY;offset=8;if(yPos<offset)dir+="n";else if(yPos>el.offsetHeight-offset)dir+="s";if(xPos<offset)dir+="w";else if(xPos>el.offsetWidth-offset)dir+="e";return dir;},doDown:function(){if(this.style.cursor.indexOf('-resize')>-1){$('.divTextEditor').blur();var el=_this.getReal(event.srcElement,"className","divNote");if(el==null){_this.theobject=null;return;}
if(el.className&&el.className.indexOf('divNote')<0)return;_this.dir=_this.getDirection(el);if(_this.dir=="")return;_this.leftObject=new _this.resizeObject();_this.leftObject.el=el;_this.leftObject.dir=_this.dir;_this.leftObject.grabx=window.event.clientX;_this.leftObject.graby=window.event.clientY;_this.leftObject.width=el.offsetWidth;_this.leftObject.height=el.offsetHeight;_this.leftObject.left=el.offsetLeft;_this.leftObject.top=el.offsetTop;window.event.returnValue=false;window.event.cancelBubble=true;}},doUp:function(e){if(e.target.classList.contains('pinIcon'))return;if(_this.leftObject!=null){var note={id:_this.leftObject.el.id,width:_this.leftObject.el.style.width,height:_this.leftObject.el.style.height}
_this.saveNote(note);_this.leftObject=null;}},doMove:function(e){var el,str,xMin,yMin;xMin=_this.noteDefaultWidth/4;yMin=_this.noteDefaultHeight/5;el=event.srcElement;if(!el)return;if(el.className&&typeof(el.className)=='string'&&el.className.indexOf("divNote")>-1){str=_this.getDirection(el);if(str=="")str="default";else str+="-resize";el.style.cursor=str;}
if(_this.leftObject!=null){if(_this.dir.indexOf("e")!=-1)
_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width+window.event.clientX-_this.leftObject.grabx)+"px";if(_this.dir.indexOf("s")!=-1)
_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height+window.event.clientY-_this.leftObject.graby)+"px";if(_this.dir.indexOf("w")!=-1){_this.leftObject.el.style.left=Math.min(_this.leftObject.left+window.event.clientX-_this.leftObject.grabx,_this.leftObject.left+_this.leftObject.width-xMin)+"px";_this.leftObject.el.style.width=Math.max(xMin,_this.leftObject.width-window.event.clientX+_this.leftObject.grabx)+"px";}
if(_this.dir.indexOf("n")!=-1){_this.leftObject.el.style.top=Math.min(_this.leftObject.top+window.event.clientY-_this.leftObject.graby,_this.leftObject.top+_this.leftObject.height-yMin)+"px";_this.leftObject.el.style.height=Math.max(yMin,_this.leftObject.height-window.event.clientY+_this.leftObject.graby)+"px";}
window.event.returnValue=false;window.event.cancelBubble=true;}},doClick:function(e){if(!_this.screen||!_this.screen.curModal)return;if(_this.curtNote){if(e.target.classList.contains('pinIcon'))return;if(e.target==_this.curtNote||$(e.target).closest('.divNote')[0]==_this.curtNote){_this.curtNote.style.zIndex=_this.getNoteMaxZIndex()+1;}else{var $thisEditor=$(_this.curtNote).find('.divTextEditor');$(_this.curtNote).find('.btn-toolbar').slideUp('1000',function(){$thisEditor.hide();$(_this.curtNote).find('.divText').html($thisEditor.html()).show();_this.curtNote.style.minWidth='';_this.curtNote.style.minHeight='';});$thisEditor.removeClass('editing');var id=$(_this.curtNote).attr('id');var index=_this.getNoteListIndex(id);var note={id:id,text:$(_this.curtNote).find('.divTextEditor').html(),width:$(_this.curtNote).css('width'),height:$(_this.curtNote).css('height')}
_this.saveNote(note)}}},getReal:function(el,type,value){var temp=el;while((temp!=null)&&(temp.tagName!="BODY")){if(eval("temp."+type)==value){el=temp;return el;}
temp=temp.parentElement;}
return el;},saveNote:function(note){var id=note.id;var isSave=false
if(_this.screen.curModal.noteList==undefined)return;var index=_this.getNoteListIndex(id);if(index==undefined){if(!note.text||$.trim(note.text.length)==0)return;var $divNote=$('#'+id);var note={id:id,x:((parseInt(getComputedStyle($divNote[0]).left.split('px')[0])/$divNote.parent().width())*100).toFixed(2)+'%',y:((parseInt(getComputedStyle($divNote[0]).top.split('px')[0])/$divNote.parent().height())*100).toFixed(2)+'%',width:note.width,height:note.height,text:note.text,bgColor:note.bgColor}
_this.screen.curModal.noteList.push(note);doSave();}else{var note_old=_this.screen.curModal.noteList[index];if(note.x&&note.x!=note_old.x){isSave=true}
if(!isSave&&note.y&&note.y!=note_old.y){isSave=true}
if(!isSave&&note.width&&note.width!=note_old.width){isSave=true}
if(!isSave&&note.height&&note.height!=note_old.height){isSave=true}
if(!isSave&&note.text&&note.text!=note_old.text){isSave=true}
if(isSave){_this.screen.curModal.noteList[index]={id:id,x:note.x?note.x:note_old.x,y:note.y?note.y:note_old.y,width:note.width?note.width:note_old.width,height:note.height?note.height:note_old.height,text:note.text?note.text:note_old.text,bgColor:note.bgColor?note.bgColor:note_old.bgColor}
doSave();}}
function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},getGraphListIndex:function(id){for(var i=0;i<_this.screen.curModal.graphList.length;i++){if(_this.screen.curModal.graphList[i].id==id){return i;}}},getGraphData:function($graph){if(_this.screen.curModal.graphList==undefined)_this.screen.curModal.graphList=[];var id=$graph.attr('id');var graph={chartName:_this.screen.curModal.type,id:id,type:_this.graphType,color:_this.color,top:(parseInt($graph.parent('.svgCopyBox').css('top').split('px')[0])*100/_this.$svgBox.height()).toFixed(2)+'%',left:(parseInt($graph.parent('.svgCopyBox').css('left').split('px')[0])*100/_this.$svgBox.width()).toFixed(2)+'%',width:$graph.width(),height:$graph.height(),marker_id:$graph.find('marker')?$graph.find('marker').attr('id'):null,path_d:$graph.children('path')?$graph.children('path').attr('d'):null,cx:$graph.children('ellipse')?$graph.children('ellipse').attr('cx'):null,cy:$graph.children('ellipse')?$graph.children('ellipse').attr('cy'):null,rx:$graph.children('ellipse')?$graph.children('ellipse').attr('rx'):null,ry:$graph.children('ellipse')?$graph.children('ellipse').attr('ry'):null,}
return graph;},saveGraph:function(graph){var isSave=false;var index=_this.getGraphListIndex(graph.id);if(index==undefined){_this.screen.curModal.graphList.push(graph);doSave();}else{var graph_old=_this.screen.curModal.graphList[index];if(graph.left&&graph.left!=graph_old.left){isSave=true}
if(!isSave&&graph.top&&graph.top!=graph_old.top){isSave=true}
if(isSave){_this.screen.curModal.graphList[index].left=graph.left;_this.screen.curModal.graphList[index].top=graph.top;doSave();}}
function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},initPointAlias:function(arrPointsAlias){var lastRepeatIndex=-1;var tempAlias;var repeatNum=0;var tempIndex;for(var i=0;i<arrPointsAlias.length;++i){lastRepeatIndex=arrPointsAlias.lastIndexOf(arrPointsAlias[i]);if(lastRepeatIndex>i){repeatNum=1;tempAlias=arrPointsAlias[i];arrPointsAlias[i]=tempAlias+'_No1';tempIndex=i;for(var j=tempIndex+1;j<lastRepeatIndex+1;++j){repeatNum+=1;tempIndex=arrPointsAlias.indexOf(tempAlias);if(tempIndex==-1)break;arrPointsAlias[tempIndex]=tempAlias+'_No'+repeatNum;}}}
return arrPointsAlias;}};return AnlzBase;})();﻿var AnlzChart=(function(){function AnlzChart(containerId,entityParams){}
AnlzChart.prototype.renderModal=function(){this.container.innerHTML=template;},AnlzChart.prototype.updateModal=function(name,value){},AnlzChart.prototype.showConfigMode=function(){}
return AnlzChart;})();var AnlzPieRealtime=(function(){var _this;function AnlzPieRealtime(container,option,screen){AnlzBase.call(this,container,option,screen);_this=this;this.paneChart=undefined;this.chart=undefined;this.dictLegend={};this.postData={};this.interv=undefined;}
AnlzPieRealtime.prototype=new AnlzBase();AnlzPieRealtime.prototype.optionTemplate={imgName:'anlsPieRealtime.png',imgIndex:5,imgColor:'211,97,78',templateName:'analysis.modalType.PIE_REAL_TIME',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['realTime']};AnlzPieRealtime.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.dictLegend=null;clearInterval(_this.interv);this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();this.$svgBox=null;$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzPieRealtime.prototype.init=function(){_this.postData={dsItemIds:_this.screen.curModal.itemDS[0].arrId};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',_this.postData).done(function(result){if(result&&result!=''){var rslt=JSON.parse(result).dsItemList;if(rslt.error&&rslt.error.length>0){alert(rslt.error);_this.spinnerStop();return;}
_this.renderModal(rslt);}}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});_this.interv=setInterval(function(){_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/startWorkspaceDataGenPieChart',_this.postData).done(function(result){var data=JSON.parse(result).dsItemList;if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
if(data&&data!=''){var arrData=[];for(var i=0,item;i<data.length;i++){item=data[i];var itemName=AppConfig.datasource.getDSItemById(item.dsItemId).alias;arrData.push({value:parseFloat(item.data),name:itemName});}
var series=[{type:'pie',radius:'55%',center:['50%','60%'],data:arrData}];_this.chart.setSeries(series,true);}
_this.spinnerStop();}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});},60000);};AnlzPieRealtime.prototype.render=function(data){var arrLabel=[],arrData=[];for(var i=0,item;i<data.length;i++){item=data[i];var itemName=AppConfig.datasource.getDSItemById(item.dsItemId).alias;arrLabel.push(itemName);arrData.push({value:parseFloat(item.data),name:itemName});}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:'',x:'center'},tooltip:{trigger:'item',formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:'vertical',x:'left',data:arrLabel},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,series:[{type:'pie',radius:'55%',center:['50%','60%'],data:arrData}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(option);};return AnlzPieRealtime;})();﻿var AnlzHistoryCompare=(function(){var _this;function AnlzHistoryCompare(container,option,screen){AnlzBase.call(this,container,option,screen);_this=this;this.curIndex=1;}
AnlzHistoryCompare.prototype=new AnlzBase();AnlzHistoryCompare.prototype.optionTemplate={imgName:'anlsHistory.png',imgIndex:3,imgColor:'65,131,189',templateName:'analysis.modalType.HISTORY_COMPARE',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easyCompareAnalyz','compareSensor','compareMeter']};AnlzHistoryCompare.prototype.show=function(){this.container.innerHTML='';this.initTools();this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();$('#graphBox').hide();$('.graphActive').click();this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{_this.initGraphs(this.screen.curModal.graphList);}
if(!this.screen.curModal.noteList){this.screen.curModal.noteList=[];}else{this.initNotes(this.screen.curModal.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});var temp;this.paneChart=document.createElement('div');temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='100% ';this.container.appendChild(this.paneChart);temp=null;_this.spinnerRender.spin(this.container.parentElement);this.init();};AnlzHistoryCompare.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.dictLegend=null;this.curIndex=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();this.$svgBox=null;$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzHistoryCompare.prototype.init=function(){var _this=this;AppConfig.datasource.getDSItemDataMulti(this,this.screen.curModal.itemDS[0].arrId);};AnlzHistoryCompare.prototype.render=function(data){this.chart?this.refreshChart(data):this.initChart(data);};AnlzHistoryCompare.prototype.initChart=function(data){this.createSeries(data);var i18nEcharts=I18n.resource.echarts;var option={title:{text:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{x:'right',data:this.arrLegendData},toolbox:{show:false,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,grid:{x:60,x2:20,y:60,borderColor:'#eee'},xAxis:[{type:'category',data:this.screen.curModal.arrComparePeriodLabel}],yAxis:[{type:'value'}],series:this.arrSeries};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(option);var _this=this;};AnlzHistoryCompare.prototype.refreshChart=function(data){var arrData=[],item=data.list[0];if(this.dictLegend[item.dsItemId])return;var arrTemp=this.chart.getSeries();arrTemp.push(this.createSeries(item.data));this.chart.setSeries(arrTemp);arrTemp=null;this.screen.curModal.itemDS[0].arrId.push(item.dsItemId);var _this=this;this.screen.saveModal();};AnlzHistoryCompare.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],calcResult=[],arrId=[];var mode=this.screen.curModal.mode;if(mode=='easyCompareAnalyz'||mode=='compareSensor'){for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];calcResult[i][j]=0;if(i==0){arrId.push(point.dsItemId);arrLegendData.push(AppConfig.datasource.getDSItemById(point.dsItemId).alias)}
for(var k=0;k<point.data.length;k++){calcResult[i][j]+=parseFloat(point.data[k])}
calcResult[i][j]=calcResult[i][j]/point.data.length;}}}else if(mode=='compareMeter'){for(var i=0;i<data.length;i++){var item=data[i];calcResult[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];if(i==0){arrLegendData.push(AppConfig.datasource.getDSItemById(point.dsItemId).alias)}
calcResult[i][j]=point.data[point.data.length-1]-point.data[0];}}}
arrLegendData=_this.initPointAlias(arrLegendData);for(var i=0;i<data[0].list.length;i++){var seriesData=[];var name=AppConfig.datasource.getDSItemById(data[0].list[i]).alias;for(var j=0;j<data.length;j++){seriesData.push(calcResult[j][i])}
var color=echarts.config.color[this.curIndex++];var series={id:arrId[i],name:arrLegendData[i],type:'bar',data:seriesData,itemStyle:{normal:{lineStyle:{color:color},barBorderRadius:[5,5,5,5]}}}
arrSeries.push(series);}
this.arrSeries=arrSeries;this.arrLegendData=arrLegendData;};return AnlzHistoryCompare;})();var AnlzHistoryCompare_Line=(function(){var _this;function AnlzHistoryCompare_Line(container,option,screen){_this=this;AnlzHistoryCompare.call(this,container,option,screen);}
AnlzHistoryCompare_Line.prototype=new AnlzHistoryCompare();AnlzHistoryCompare_Line.prototype.optionTemplate={imgName:'anlsHistory.png',imgIndex:3,imgColor:'65,131,189',templateName:'analysis.modalType.HISTORY_COMPARE_LINE',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easyCompareAnalyz','compareSensor','compareMeter']};AnlzHistoryCompare_Line.prototype.initChart=function(data){this.createSeries(data);var xAxis=[];for(var i=0;i<data[0].timeShaft.length;++i){xAxis.push('Day'+new Date(data[0].timeShaft[i]).getDate()+' '+new Date(data[0].timeShaft[i]).format("HH:mm:ss"));}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'},formatter:function(params){var strToolTip='',date;for(var i=0;i<params.length;i++){if(i%2==0){strToolTip+=AppConfig.datasource.getDSItemById(_this.screen.curModal.itemDS[0].arrId[i/2]).alias+'<br/>';strToolTip+=data[0].timeShaft[params[i].dataIndex]+'<br/>Value: '+params[i].value+'<br/>'}else{strToolTip+=data[1].timeShaft[params[i].dataIndex]+'<br/>Value: '+params[i].value+'<br/>'}}
return strToolTip;}},legend:{x:'right',data:this.arrLegendData},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:false,grid:{x:60,x2:20,y:60,borderColor:'#eee'},dataZoom:{show:false},xAxis:[{type:'category',data:xAxis,splitLine:{show:false}}],yAxis:[{type:'value',scale:true}],series:this.arrSeries};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(option);var _this=this;};AnlzHistoryCompare_Line.prototype.createSeries=function(data){var arrSeries=[],arrLegendData=[],pointData=[],arrId=[];var mode=this.screen.curModal.mode;if(mode=='easyCompareAnalyz'||mode=='compareSensor'){for(var i=0;i<data.length;i++){var item=data[i];pointData[i]=[];for(var j=0;j<item.list.length;j++){var point=item.list[j];pointData[i][j]=[];if(i==0){arrId.push(point.dsItemId);arrLegendData.push(this.screen.curModal.arrComparePeriodLabel[0]+':'+AppConfig.datasource.getDSItemById(point.dsItemId).alias);arrLegendData.push(this.screen.curModal.arrComparePeriodLabel[1]+':'+AppConfig.datasource.getDSItemById(point.dsItemId).alias);}
for(var k=0;k<point.data.length;k++){pointData[i][j].push(parseFloat(point.data[k]));}}}}else if(mode=='compareMeter'){for(var i=0;i<data.length;i++){pointData[i]=[];var item=data[i];for(var j=0;j<item.list.length;j++){pointData[i][j]=[];var point=item.list[j];if(i==0){arrLegendData.push(this.screen.curModal.arrComparePeriodLabel[0]+':'+AppConfig.datasource.getDSItemById(point.dsItemId).alias);arrLegendData.push(this.screen.curModal.arrComparePeriodLabel[1]+':'+AppConfig.datasource.getDSItemById(point.dsItemId).alias);}
for(var k=0;k<point.data.length;k++){pointData[i][j].push(parseFloat(point.data[k]));}}}}
if(arrLegendData[0]==arrLegendData[1]){arrLegendData[0]+='_No1';arrLegendData[1]+='_No2';}
var index=0;for(var i=0;i<data[0].list.length;i++){var seriesData=[];var name=AppConfig.datasource.getDSItemById(data[0].list[i]).alias;for(var j=0;j<data.length;j++){seriesData=pointData[j][i];var color=echarts.config.color[this.curIndex++];var series={id:arrId[i],name:arrLegendData[index],type:'line',data:seriesData,itemStyle:{normal:{barBorderRadius:[5,5,5,5]}}};arrSeries.push(series);index=index+1;}}
this.arrSeries=arrSeries;this.arrLegendData=arrLegendData;};return AnlzHistoryCompare_Line;})();﻿var AnlzScatter=(function(){function AnlzScatter(container,option,screen){AnlzBase.call(this,container,option,screen);this.animation=true;}
AnlzScatter.prototype=new AnlzBase();AnlzScatter.prototype.optionTemplate={imgName:'anlsScatter.png',imgIndex:2,imgColor:'211,97,78',templateName:'analysis.modalType.SCATTER',templateParams:{paraName:['X','Y'],paraAnlysMode:'all',dataTypeMaxNum:[1,5]},chartConfig:['easy','fixed','recent']};AnlzScatter.prototype.init=function(){var _this=this;var arrIds=[];arrIds.push(this.screen.curModal.itemDS[0].arrId[0]);arrIds=arrIds.concat(this.screen.curModal.itemDS[1].arrId);var postData={dsItemIds:arrIds,timeStart:this.screen.curModal.startTime.format('yyyy-MM-dd HH:mm:ss'),timeEnd:this.screen.curModal.endTime.format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.screen.curModal.format};WebAPI.post('/analysis/startWorkspaceDataGenScatterChart',postData).done(function(result){var data=JSON.parse(result);if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});};AnlzScatter.prototype.render=function(data){var arrXAxis=data.list[0].data,arrData=[],arrLegend=[],arrSeries=[];for(var i=1;i<data.list.length;i++){arrData.push([]);arrLegend.push(AppConfig.datasource.getDSItemById(data.list[i].dsItemId).alias)}
for(var i=0,valueX;i<arrXAxis.length;i++){valueX=data.list[0].data[i];for(var j=0,jLen=data.list.length-1;j<jLen;j++){arrData[j].push([valueX,data.list[j+1].data[i]]);}}
for(var i=0;i<arrData.length;i++){arrSeries.push({name:arrLegend[i],type:'scatter',data:arrData[i],markLine:{data:[{type:'average',name:I18n.resource.observer.analysis.AVERAGE}]}});}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:'X: '+AppConfig.datasource.getDSItemById(data.list[0].dsItemId).alias,subtext:'Scatter'},tooltip:{trigger:'axis',showDelay:0,axisPointer:{show:true,type:'cross',lineStyle:{type:'dashed',width:1}}},legend:{data:arrLegend},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},xAxis:[{type:'value',scale:true}],yAxis:[{type:'value',scale:true}],series:arrSeries,animation:this.animation,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(option);};return AnlzScatter;})();﻿var AnlzSpectrum=(function(){function AnlzSpectrum(container,option,screen){AnlzBase.call(this,container,option,screen);}
AnlzSpectrum.prototype=new AnlzBase();AnlzSpectrum.prototype.optionTemplate={imgName:'anlsSpectrum.png',imgIndex:1,imgColor:'148,193,142',templateName:'analysis.modalType.SPECTRUM',templateParams:{paraName:['X'],paraAnlysMode:'all',dataTypeMaxNum:[1]},chartConfig:['easy','fixed','recent']};AnlzSpectrum.prototype.init=function(){var _this=this;var postData={dsItemIds:this.screen.curModal.itemDS[0].arrId,timeStart:this.screen.curModal.startTime.format('yyyy-MM-dd HH:mm:ss'),timeEnd:this.screen.curModal.endTime.format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.screen.curModal.format};WebAPI.post('/analysis/startWorkspaceDataGenPattern',postData).done(function(result){var data=JSON.parse(result);if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});};AnlzSpectrum.prototype.render=function(data){var arrLabel=[],arrData=[];for(var i=0,item;i<data.list.length;i++){item=data.list[i];arrLabel.push(item.data);arrData.push(item.pattern);}
var i18nEcharts=I18n.resource.echarts;var option={title:{text:AppConfig.datasource.getDSItemById(this.screen.curModal.itemDS[0].arrId[0]).alias,subtext:'Spectrum'},tooltip:{trigger:'axis'},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,xAxis:[{type:'category',boundaryGap:true,data:arrLabel}],yAxis:[{type:'value'}],series:[{type:'bar',data:arrData,itemStyle:{normal:{color:'#5bc0de',barBorderRadius:[5,5,0,0]}},markLine:{data:[{type:'average',name:I18n.resource.observer.analysis.AVERAGE}]}}],animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(option);};return AnlzSpectrum;})();﻿var AnlzTendency=(function(){var _this;function AnlzTendency(container,option,screen){AnlzBase.call(this,container,option,screen);this.paneLegend=undefined;this.dictLegend={};this.dictTooltip={};this.curIndex=0;this.legendType={NORMAL:0,Prediction:1,Regression:2};this.screen=screen;this.animation=true;this.timeType=!option?'h1':option.format;if(this.screen.curModal.chartOption){this.modifyData=this.screen.curModal.chartOption;if(!this.modifyData.chartName){this.modifyData.chartName='';}
if(!this.modifyData.xUnit){this.modifyData.xUnit='';}
if(!this.modifyData.yUnit){this.modifyData.yUnit='';}
if(!this.modifyData.yMark){this.modifyData.yMark='';}
if(!this.modifyData.yMax){this.modifyData.yMax='';}
if(this.modifyData.yMin||this.modifyData.yMin==0){this.modifyData.yMin=this.modifyData.yMin;}else{this.modifyData.yMin='';}}else{this.modifyData={};}
if(!this.screen.curModal.dictShowData){this.screen.curModal.dictShowData={}}
this.dictShowData=this.screen.curModal.dictShowData;for(var key in this.dictShowData){for(var i=0,len=this.dictShowData[key].length;i<len;i++){this.dictShowData[key][i]=this.fillData(this.dictShowData[key][i]);}}
if(!this.screen.curModal.dictShowFlag){this.screen.curModal.dictShowFlag={};}
this.dictShowFlag=this.screen.curModal.dictShowFlag;_this=this;}
AnlzTendency.prototype=new AnlzBase();AnlzTendency.prototype.optionTemplate={imgName:'anlsTendency.png',imgIndex:0,imgColor:'65,131,189',templateName:'analysis.modalType.TENDENCY',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzTendency.prototype.show=function(){this.container.innerHTML='';this.initTools();this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();$('#graphBox').hide();$('.graphActive').click();this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);$('#chartModify').hide();$('#btnDataFilter').hide();if(this.container.id==='anlsPane'&&!$(this.container).hasClass('panel-readonly')){$('#chartModify').show();$('#btnDataFilter').show();}
_this.modifyEcharts();if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{_this.initGraphs(this.screen.curModal.graphList);}
if(!this.screen.curModal.noteList){this.screen.curModal.noteList=[];}else{this.initNotes(this.screen.curModal.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});var temp,wrap;this.paneChart=document.createElement('div');this.paneChart.className='divPaneChart';temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='calc(100% - 170px)';this.paneLegend=document.createElement('div');this.paneLegend.className='divHover';temp=this.paneLegend.style;temp.marginTop='10px';temp.padding='10px';temp.cssFloat='left';temp.width='100%';temp.height='160px';temp.position='relative';this.container.appendChild(this.paneChart);this.container.appendChild(this.paneLegend);if(this.isShareMode===1)$(this.container).addClass('read-mode');temp=null;_this.spinnerRender.spin(this.container.parentElement);this.init();};AnlzTendency.prototype.modifyEcharts=function(){var _this=this;var $modifyLayer=$('.modifyLayer');if($modifyLayer.length===0){$modifyLayer=$('<div class="modal fade modifyLayer" style="position:absolute;z-index:151;"><div class="modal-dialog" style="width:65%;"><div class="modal-content">'+'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">'+I18n.resource.modalConfig.editChart.TITLE+'</h4></div>'+'<div class="modal-body">'+'<div width="100%" style="margin-top:20px;"><div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.CHART_NAME+':</span><input type="text" id="changeEchName" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.X_AXIS_UNIT+':</span><input type="text" id="addXUnit" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_UNIT+':</span><input type="text" id="addYUnit" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_SCALE+':</span><input type="text" id="changeYMark" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 10px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_MAX+':</span><input type="text" id="changeYMax" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div>'+'<div style="width:92%;padding:0 4%;font-size:16px;line-height:24px;margin:10px 0 40px 4%;"><span style="display:inline-block;width:100px;text-align:right">'+I18n.resource.modalConfig.editChart.Y_AXIS_MIN+':</span><input type="text" id="changeYMin" style="display:inline-block;width:calc(92% - 110px);margin-left:10px;"/></div></div>'+'<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="modifyBtn">'+I18n.resource.modalConfig.editChart.BTN_CONFIRM+'</button></div>'+'</div></div></div>');$(_this.container).parents('#anlsPaneContain').append($modifyLayer);}
$('#chartModify').off('click').click(function(){_this.modifyEcharts();if($modifyLayer.is(':hidden')){$modifyLayer.modal('show');$('#changeEchName')[0].value=_this.modifyData.chartName?_this.modifyData.chartName:'';$('#addXUnit')[0].value=_this.modifyData.xUnit?_this.modifyData.xUnit:'';$('#addYUnit')[0].value=_this.modifyData.yUnit?_this.modifyData.yUnit:'';$('#changeYMark')[0].value=_this.modifyData.yMark?_this.modifyData.yMark:'';$('#changeYMax')[0].value=_this.modifyData.yMax?_this.modifyData.yMax:'';$('#changeYMin')[0].value=(_this.modifyData.yMin===0||_this.modifyData.yMin)?_this.modifyData.yMin:'';}else{$modifyLayer.modal('hide');}});$('#modifyBtn').off('click').click(function(){if($('#addYUnit').val()==null||$('#addYUnit').val()==0||$('#addYUnit').val()==undefined){_this.modifyData.yUnit='';}else{_this.modifyData.yUnit=$('#addYUnit').val();}
if($('#addXUnit').val()==null||$('#addXUnit').val()==0||$('#addXUnit').val()==undefined){_this.modifyData.xUnit='';}else{_this.modifyData.xUnit=$('#addXUnit').val();}
if($('#changeEchName').val()==null||$('#changeEchName').val()==0||$('#changeEchName').val()==undefined){_this.modifyData.chartName='';}else{_this.modifyData.chartName=$('#changeEchName').val();}
if($('#changeYMark').val()==null||$('#changeYMark').val()==0||$('#changeYMark').val()==undefined){_this.modifyData.yMark=null;}else{if(isNaN($('#changeYMark').val())){_this.modifyData.yMark=null;}else{_this.modifyData.yMark=parseInt($('#changeYMark').val());}}
if($('#changeYMax').val()==null||$('#changeYMax').val()==0||$('#changeYMax').val()==undefined){_this.modifyData.yMax=null;}else{if(isNaN($('#changeYMax').val())){_this.modifyData.yMax=null;}else{_this.modifyData.yMax=parseInt($('#changeYMax').val());}}
if($('#changeYMin').val()==null||$('#changeYMin').val()==undefined){_this.modifyData.yMin=null;}else{if(isNaN($('#changeYMin').val())){_this.modifyData.yMin=null;}else{_this.modifyData.yMin=parseInt($('#changeYMin').val());}}
if(parseInt(_this.yMin)>=parseInt(_this.yMax)){_this.modifyData.yMin=0;_this.modifyData.yMax=100;}
_this.saveChartModify();$('.divPage.selected').trigger('click');});},AnlzTendency.prototype.saveChartModify=function(){_this.screen.curModal.chartOption={chartName:_this.modifyData.chartName?_this.modifyData.chartName:null,xUnit:_this.modifyData.xUnit?_this.modifyData.xUnit:null,yUnit:_this.modifyData.yUnit?_this.modifyData.yUnit:null,yMark:_this.modifyData.yMark?parseInt(_this.modifyData.yMark):null,yMax:_this.modifyData.yMax?parseInt(_this.modifyData.yMax):null,yMin:(_this.modifyData.yMin||_this.modifyData.yMin===0)?parseInt(_this.modifyData.yMin):null}
doSave();function doSave(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,false]);}},AnlzTendency.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.dropMaskLayer=null;this.paneLegend=null;this.paneChart=null;this.chart=null;this.dictLegend=null;this.curIndex=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();this.$svgBox=null;$('#graphBox').hide();$('#chartModify').hide();$('#btnDataFilter').hide();this.chartName=null;this.xUnit=null;this.yUnit=null;this.yMark=null;this.yMax=null;this.yMin=null;this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzTendency.prototype.init=function(){var _this=this;var arrDsId=this.screen.curModal.itemDS[0].arrId;if(arrDsId){for(var i=0,len=arrDsId.length;i<len;i++){var bFind=false;for(var key in this.dictShowFlag){if(key==arrDsId[i]){bFind=true;break;}}
if(!bFind){this.dictShowFlag[arrDsId[i]]=true;}}}
AppConfig.datasource.getDSItemData(this,this.screen.curModal.itemDS[0].arrId);this.paneLegend.ondragenter=function(e){var $ele=$(_this.paneLegend);if($ele.hasClass('dis'))return;$ele.addClass('dragHover');e.stopPropagation();e.preventDefault();};this.paneLegend.ondragleave=function(e){$(_this.paneLegend).removeClass('dragHover');e.stopPropagation();e.preventDefault();};this.paneLegend.ondragover=function(e){e.preventDefault();};this.paneLegend.ondrop=function(e){_this.spinnerRender.spin(_this.container.parentElement);var dsItemId=EventAdapter.getData().dsItemId;var $ele=$(_this.paneLegend);$ele.removeClass('dragHover dis');if(dsItemId){if($ele.find('[id="lg_'+dsItemId+'"]').length>0){_this.spinnerStop();return;}
AppConfig.datasource.getDSItemData(_this,[dsItemId]);}else _this.spinnerStop();}};AnlzTendency.prototype.render=function(data){this.chart?this.refreshChart(data):this.initChart(data);this.spinnerRender.stop();};AnlzTendency.prototype.initChart=function(data){var arrSeries=[],legend=[];var series,item,i,option;for(i=0;i<data.list.length;i++){item=data.list[i];series=this.createSeries(item.dsItemId,item.data);legend.push(series.name);arrSeries.push(series);}
this.showFilterCharts(arrSeries);this.resetShowData(data,0);for(var key in this.dictShowFlag){for(var j=0,lenJ=arrSeries.length;j<lenJ;j++){if(key==arrSeries[j].id){if(!this.dictShowFlag[key]){arrSeries[j].data=[];}
break;}}}
option=this.initOption(arrSeries,data.timeShaft);if(this.isShareMode===1)option.legend={data:legend};this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(option);};AnlzTendency.prototype.initOption=function(series,timeSHaft){var i18nEcharts=I18n.resource.echarts;var option={tooltip:{trigger:'axis'},grid:{x:60,x2:20,y:60,borderColor:'#eee'},toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:false,readOnly:true,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,data:timeSHaft,axisLabel:{formatter:'{value} '}}],yAxis:[{type:'value',scale:true,axisLabel:{formatter:'{value} '}}],series:series,animation:this.animation,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};if(this.modifyData&&this.modifyData.chartName){option.title={text:this.modifyData.chartName};}
if(this.modifyData&&this.modifyData.xUnit){option.xAxis[0].name=this.modifyData.xUnit;option.xAxis[0].nameLocation='start';}
if(this.modifyData&&this.modifyData.yUnit){option.yAxis[0].name=this.modifyData.yUnit;}
if(this.modifyData&&this.modifyData.yMax){option.yAxis[0].max=this.modifyData.yMax;}
if(this.modifyData&&this.modifyData.yMin!==null){option.yAxis[0].min=this.modifyData.yMin;}
if(this.modifyData&&this.modifyData.yMark){option.yAxis[0].splitNumber=(this.modifyData.yMax-this.modifyData.yMin)/this.modifyData.yMark;}
return option;};AnlzTendency.prototype.refreshChart=function(data){var arrData=[],item=data.list[0];if(this.dictLegend[item.dsItemId])return;this.resetShowData(data,0);this.dictShowFlag[item.dsItemId]=true;var arrTemp=this.chart.getSeries();arrTemp.push(this.createSeries(item.dsItemId,item.data));this.chart.setSeries(arrTemp);arrTemp=null;this.screen.curModal.itemDS[0].arrId.push(item.dsItemId);var _this=this;this.screen.saveModal();};AnlzTendency.prototype.createSeries=function(id,data,type){if(!type)type=this.legendType.NORMAL;var name,len;if(type==this.legendType.NORMAL){name=AppConfig.datasource.getDSItemById(id).alias;}
else{name=id.split('_');name=AppConfig.datasource.getDSItemById(name[0]).alias+'_'+id[1];}
len=echarts.config.color.length;var color=echarts.config.color[this.curIndex%len];this.curIndex++;var div=this.renderLegend(id,name,type,color);var tipInf=this.getStatisticsInfo(data);if(Boolean(tipInf)){this.initTendencyTips($(div),tipInf.max,tipInf.min,tipInf.avg,tipInf.sum);}
return{id:id,name:name,type:'line',symbol:'none',data:data,itemStyle:{normal:{lineStyle:{color:color}}}}};AnlzTendency.prototype.refreshChartFilter=function(data,condition,series){var arrData=[],item=data.list[0];if(this.dictLegend[item.dsItemId])return;var newFilterId=item.dsItemId+'_filter';var bFilterFind=false;for(var i=0,len=series.length;i<len;i++){if(newFilterId==series[i].id){bFilterFind=true;break;}}
if(bFilterFind){series[i].data=item.data;var $div=$('#lg_'+newFilterId);var tipTmp=$div.data('bs.tooltip');if(!tipTmp){return;}
var tip=tipTmp.$tip;if(tip){var tipInf=this.getStatisticsInfo(item.data);tip.find('.filterMax').text(I18n.resource.observer.widgets.MAXIMUM+': '+tipInf.max);tip.find('.filterMin').text(I18n.resource.observer.widgets.MINIMUM+': '+tipInf.min);tip.find('.filterAvg').text(I18n.resource.observer.widgets.AVERAGE+': '+tipInf.avg);tip.find('.filterSum').text(I18n.resource.observer.widgets.TOTAL_AMOUNT+': '+tipInf.sum);tip.find('.filterCondition').text(I18n.resource.observer.widgets.FILTER_FORMULA+': '+condition);}
var appendId=item.dsItemId+'_append';var arrAppend=[];for(var i=0,len=series.length;i<len;i++){if(appendId==series[i].id){arrAppend.push(i);}}
if(arrAppend.length>0){for(var j=0,len2=arrAppend.length;j<len2;j++){series.splice(arrAppend[j],1);}}}
else{series.push(this.createSeriesFilter(item.dsItemId,item.data,newFilterId,condition));}
this.spinnerRender.stop();};AnlzTendency.prototype.createSeriesFilter=function(id,data,newId,condition){var name,len;name=AppConfig.datasource.getDSItemById(id).alias+'_filter';len=echarts.config.color.length;var color=echarts.config.color[this.curIndex%len];this.curIndex++;var div=this.renderLegend(newId,name,0,color);var tipInf=this.getStatisticsInfo(data);if(Boolean(tipInf)){this.initTendencyTipsFilter($(div),tipInf.max,tipInf.min,tipInf.avg,tipInf.sum,condition);}
return{id:newId,name:name,type:'line',symbol:'none',data:data,itemStyle:{normal:{lineStyle:{color:color}}}}};AnlzTendency.prototype.removeSeries=function(id){var _this=this;delete this.dictLegend[id];$('#lg_'+id).remove();var option=this.chart.getOption();var arrSeries=option.series;for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].id==id){arrSeries.splice(i,1);break;}}
var arrIds=this.screen.curModal.itemDS[0].arrId;for(var i=0;i<arrIds.length;i++){if(arrIds[i]==id){arrIds.splice(i,1);}}
this.screen.curModal.itemDS[0].arrId=arrIds;var nIdx=id.indexOf('_filter');if(-1!=nIdx){var origId=id.substr(0,nIdx);var arrFilter=this.screen.curModal.arrFilter;if(arrFilter){for(var i=0,len=arrFilter.length;i<len;i++){if(origId==arrFilter[i].pointId){arrFilter.splice(i,1);break;}}}}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(this.initOption(arrSeries,option.xAxis[0].data));window.setTimeout(function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);},500);};AnlzTendency.prototype.getDataById=function(id){var arrSeries=this.chart.getSeries();for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].id==id){return arrSeries[i].data;}}};AnlzTendency.prototype.renderLegend=function(id,name,type,color){var _this=this;var name=name;var div=document.createElement("div");var closeBtn='<button type="button" class="close"><span>&times;</span></button>';var btnShow;if(this.dictShowFlag[id]){btnShow='<span class="glyphicon glyphicon-eye-open btnShow" aria-hidden="true"></span>';}
else{btnShow='<span class="glyphicon glyphicon-eye-close btnShow" aria-hidden="true"></span>';}
div.id='lg_'+id;div.dataset.id=id;div.className="divLegend";div.draggable=true;div.style.backgroundColor=color;div.setAttribute('ty',type);switch(type){case this.legendType.Regression:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split('_Regression_')[0]+"_Regression</div>"+btnShow+closeBtn;this.initGeneralRegressorTooltip(id,div);};break;case this.legendType.Prediction:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-retweet' style='margin-right: 10px;'></span>"+name.split('_Prediction_')[0]+"_Prediction</div>"+btnShow+closeBtn;this.initGeneralPredictorTooltip(id,div);};break;default:{div.innerHTML="<div class='divTxtWrap'><span class='glyphicon glyphicon-stats' style='margin-right: 10px;'></span>"+name+'</div>'+btnShow+closeBtn;};break}
div.getElementsByClassName('close')[0].onclick=function(e){var $ele=$(e.currentTarget).parent();var id=$ele[0].dataset.id;if($('.divLegend').length>1){var option=_this.chart.getOption();if(option){var arrSeries=option.series;if(arrSeries){var cnt=0;for(var i=0;i<arrSeries.length;i++){if(arrSeries[i].data.length>0){cnt++;}}
if(cnt<=1){alert('The only parameters can\'t be removed');return;}}}
$ele.tooltip('destroy');_this.removeSeries(id);var cnt=id.indexOf('_filter');if(-1!=cnt){var preId=id.substr(0,cnt);if(preId){_this.removeSeries(preId+'_append');}}}else{alert('The only parameters can\'t be removed');}
e.stopPropagation();};div.getElementsByClassName('btnShow')[0].onclick=function(e){var $ele=$(e.currentTarget).parent();var id=$ele[0].dataset.id;_this.switchSeries(id);e.stopPropagation();};div.ondragstart=function(e){$(_this.paneLegend).addClass('dis');e.dataTransfer.effectAllowed="move";e.dataTransfer.setData("id",e.currentTarget.dataset.id);e.dataTransfer.setData("source","legend");};div.ondragenter=function(e){e.preventDefault();e.stopPropagation();};div.ondragover=function(e){e.preventDefault();e.stopPropagation();};div.ondrop=function(e){var srcId=e.dataTransfer.getData('id');var toId=e.currentTarget.dataset.id;$(_this.paneLegend).removeClass('dis');e.stopPropagation();if(srcId===''||srcId===toId)return;var source=e.dataTransfer.getData("source");if(source&&source=="legend"){if(e.currentTarget.getAttribute('ty')==_this.legendType.Regression)
generatePredictor(e,srcId,toId);else
generateRegressor(e,srcId,toId);}
function generateRegressor(e,sourceId,targetId){var data={source:[_this.getDataById(sourceId).map(function(row,i){return row+'';})],target:_this.getDataById(targetId).map(function(row,i){return row+'';}),sourceNames:sourceId,targetName:targetId};_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/generalRegressor',data).done(function(result){var id=targetId+"_Regression_"+(+new Date());var data=JSON.parse(result);var arrTemp=_this.chart.getSeries();data.SourceId=sourceId;data.TargetId=targetId;_this.dictTooltip[id]=data;arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Regression));_this.chart.setSeries(arrTemp);arrTemp=null;_this.spinnerRender.stop();}).error(function(result){_this.spinnerRender.stop();});}
function generatePredictor(e,sourceId,targetId){var arrCoefficient=_this.dictTooltip[e.currentTarget.dataset.id].Coefficients;for(var i=0;i<arrCoefficient.length;i++)arrCoefficient[i]=arrCoefficient[i].toString();var data={source:[_this.getDataById(sourceId).map(function(row,i){return row+'';})],Coefficients:arrCoefficient};_this.spinnerRender.spin(_this.container.parentElement);WebAPI.post('/analysis/generalPredictor',data).done(function(result){var id=targetId.split('_')[0]+"_Prediction_"+(+new Date());var arrTemp=_this.chart.getSeries();var data=JSON.parse(result);if(data.PredicatedResults){arrTemp.push(_this.createSeries(id,data.PredicatedResults,_this.legendType.Prediction));_this.chart.setSeries(arrTemp);}
_this.spinnerRender.stop();}).error(function(result){_this.spinnerRender.stop();});}}
this.paneLegend.appendChild(div);return div;};AnlzTendency.prototype.initGeneralRegressorTooltip=function(id,element){var data=this.dictTooltip[id];var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip" style="position: fixed;">');sb.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">RSquared: ').append(data.RSquared).append('</p> ');sb.append('        <p>Formula: </p><p style="margin-left: 20px; white-space:nowrap;">').append(data.Formula).append('</p> ');sb.append('        <p style="margin-left: 20px; white-space:nowrap;">x: ').append(AppConfig.datasource.getDSItemById(data.SourceId).alias).append('</p>');sb.append('        <p style="margin-left: 20px; white-space:nowrap;">y: ').append(AppConfig.datasource.getDSItemById(data.TargetId).alias).append('</p>');sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={placement:'top',title:'GeneralRegressor',template:sb.toString()};$(element).tooltip(options);};AnlzTendency.prototype.initGeneralPredictorTooltip=function(id,element){var data=this.dictTooltip[id];var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip" style="position: fixed;">');sb.append('    <div class="tooltipTitle tooltip-inner">GeneralPredictor</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">Source: ').append(AppConfig.datasource.getDSItemById(id.split('_')[0]).alias).append('</p> ');sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={placement:'top',title:'GeneralPredictor',template:sb.toString()};$(element).tooltip(options);};AnlzTendency.prototype.initTendencyTips=function(parent,max,min,avg,sum){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">Statistics</div>');show.append('    <div class="tooltipContent">');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MAXIMUM).append('</span>: ').append(max).append('</p>');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MINIMUM).append('</span>: ').append(min).append('</p> ');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.AVERAGE).append('</span>: ').append(avg).append('</p> ');show.append('        <p style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.TOTAL_AMOUNT).append('</span>: ').append(sum).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'top',title:I18n.resource.observer.widgets.PARAMETER,template:show.toString()};parent.tooltip(options);};AnlzTendency.prototype.initTendencyTipsFilter=function(parent,max,min,avg,sum,condition){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">Statistics</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="filterMax" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MAXIMUM).append('</span>: ').append(max).append('</p>');show.append('        <p class="filterMin" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.MINIMUM).append('</span>: ').append(min).append('</p> ');show.append('        <p class="filterAvg" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.AVERAGE).append('</span>: ').append(avg).append('</p> ');show.append('        <p class="filterSum" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.TOTAL_AMOUNT).append('</span>: ').append(sum).append('</p> ');show.append('        <p class="filterCondition" style="word-break:break-all;"><span style="font-weight:bold">').append(I18n.resource.observer.widgets.FILTER_FORMULA).append('</span>: ').append(condition).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'top',title:I18n.resource.observer.widgets.PARAMETER,template:show.toString()};parent.tooltip(options);};AnlzTendency.prototype.getStatisticsInfo=function(data){if(!data||data.length<=0){return{'max':0,'min':0,'avg':0,'sum':0};}
var max=0;var min=0;for(var i=0,len=data.length;i<len;i++){if(data[i]){max=data[i];min=data[i];break;}}
var avg=0;var sum=0;var flag=2;var len=data.length;var lenAct=len;if('h1'==this.timeType||'d1'==this.timeType||'M1'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
sum+=data[i];}}
else if('m5'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
if(0==i%12){sum+=data[i];}}}
else if('m1'==this.timeType){for(var i=0;i<len;i++){if(!data[i]){lenAct--;continue;}
if(data[i]>max){max=data[i];}
if(data[i]<min){min=data[i];}
if(0==i%60){sum+=data[i];}}}
else{return null;}
avg=sum/lenAct;return{'max':max,'min':min,'avg':avg.toFixed(flag),'sum':sum.toFixed(flag)};};AnlzTendency.prototype.showFilterCharts=function(series){if(!series){series=this.chart.getSeries();}
if(this.options.arrFilter){for(var i=0,len=this.options.arrFilter.length;i<len;i++){var item=this.options.arrFilter[i];for(var j=0,len2=item.appendData.length;j<len2;j++){if(!item.appendData[j]){item.appendData[j]=undefined;}}
for(var k=0,len3=item.filterDrawObj.list[0].data.length;k<len3;k++){if(!item.filterDrawObj.list[0].data[k]){item.filterDrawObj.list[0].data[k]=undefined;}}
if(item.filterDrawObj){this.refreshChartFilter(item.filterDrawObj,item.filterCondition,series);}
if(0==item.showType){this.removeAppendCharts(item,series);}
else{this.setAppendCharts(item,series);}}}};AnlzTendency.prototype.setAppendCharts=function(itemFilter,series){var colorShow;var id=itemFilter.pointId;var idLen=id.length;var bFind=false;for(var i=0,len=series.length;i<len;i++){var tempLen=series[i].id.length;var tempEx=(tempLen>idLen)?(series[i].id.substr(idLen,tempLen-idLen)):('');if(series[i].id.substr(0,idLen)==id&&'_filter'==tempEx){bFind=true;colorShow=series[i].itemStyle.normal.lineStyle.color;break;}}
if(bFind){var itemAppend={id:itemFilter.pointId+'_append',name:'',type:'line',symbol:'none',data:itemFilter.appendData,smooth:false,itemStyle:{normal:{lineStyle:{color:colorShow,width:3,type:'dotted'}}}}
series.push(itemAppend);}};AnlzTendency.prototype.removeAppendCharts=function(itemFilter,series){var id=itemFilter.pointId;var idLen=id.length;var bFind=false;for(var i=0,len=series.length;i<len;i++){var tempLen=series[i].id.length;var tempEx=(tempLen>idLen)?(series[i].id.substr(idLen,tempLen-idLen)):('');if(series[i].id.substr(0,idLen)==id&&'_append'==tempEx){bFind=true;series.splice(i,1);break;}}};AnlzTendency.prototype.switchSeries=function(id){var option=this.chart.getOption();if(!option){return;}
var arrSeries=option.series;if(!arrSeries){return;}
var cnt=0;var flag=false;for(var i=0;i<arrSeries.length;i++){if(-1!=arrSeries[i].id.indexOf('_append')){continue;}
if(arrSeries[i].data.length>0){cnt++;}
if(arrSeries[i].id==id&&arrSeries[i].data.length>0){flag=true;}}
if(cnt<=1&&flag){alert('The only parameters can\'t be removed');return;}
var spanPic=$('#lg_'+id).children('.btnShow');if(spanPic){var bIsExist=false;for(var key in this.dictShowFlag){if(id==key){bIsExist=true;break;}}
if(!bIsExist){return;}
var bIsShow=!this.dictShowFlag[id];this.dictShowFlag[id]=bIsShow;if(bIsShow){spanPic.attr('class','glyphicon glyphicon-eye-open btnShow');}
else{spanPic.attr('class','glyphicon glyphicon-eye-close btnShow');}
for(var i=0,len=arrSeries.length;i<len;i++){if(arrSeries[i].id==id){if(bIsShow){arrSeries[i].data=this.dictShowData[id];}
else{arrSeries[i].data=[];}
break;}}
var appendId='';var nIdx=id.indexOf('_filter');if(-1!=nIdx){appendId=id.substr(0,nIdx)+'_append';for(var i=0,len=arrSeries.length;i<len;i++){if(arrSeries[i].id==appendId){if(bIsShow){arrSeries[i].data=this.dictShowData[appendId];}
else{arrSeries[i].data=[];}
break;}}}}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(this.initOption(arrSeries,option.xAxis[0].data));window.setTimeout(function(){_this.screen.saveModal();_this.screen.saveModalJudge.resolveWith(_this.screen,[_this.screen,1,_this.chart,$('#divWSPane .selected'),_this.screen.curModal,true]);},500);};AnlzTendency.prototype.setTendencyOption=function(series){if(!series){series=this.chart.getSeries();}
var opt=this.chart.getOption();opt.series=series;this.chart.clear();this.chart.setOption(opt);};AnlzTendency.prototype.resetIcon=function(arrCloseId){if(!arrCloseId){return;}
var legend=$('.divHover').find('.divLegend');if(legend){for(var i=0,lenI=legend.length;i<lenI;i++){var bFind=false;for(var j=0,lenJ=arrCloseId.length;j<lenJ;j++){if('lg_'+arrCloseId[j]==legend[i].id){bFind=true;break;}}
if(bFind){var icon=legend.eq(i).children('.btnShow');if(icon){icon.attr('class','glyphicon glyphicon-eye-close btnShow');}}}}};AnlzTendency.prototype.resetShowData=function(data,nFlag){if(!data){return;}
var list=data.list;if(list){var nLenTime=data.timeShaft.length;var nLenTimeOld=nLenTime;for(var key in this.dictShowData){if(this.dictShowData[key]){nLenTimeOld=this.dictShowData[key].length;break;}}
if(nLenTime>nLenTimeOld){nLenTime=nLenTimeOld}
if(0==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId]=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId][j]=this.fillData(list[i].data[j]);}}}
else if(1==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId+'_filter']=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId+'_filter'][j]=this.fillData(list[i].data[j]);}}}
else if(2==nFlag){for(var i=0,len=list.length;i<len;i++){this.dictShowData[list[i].dsItemId+'_append']=[];for(var j=0;j<nLenTime;j++){this.dictShowData[list[i].dsItemId+'_append'][j]=this.fillData(list[i].data[j]);}}}}};AnlzTendency.prototype.fillData=function(data){if(!data&&0!=data){data=undefined;}
return data;};return AnlzTendency;})();﻿var AnlzStack=(function(){var _this;function AnlzStack(container,option,screen){AnlzBase.call(this,container,option,screen);this.screen=screen;_this=this;}
AnlzStack.prototype=new AnlzBase();AnlzStack.prototype.optionTemplate={imgName:'anlsStack.png',imgIndex:4,imgColor:'148,193,142',templateName:'analysis.modalType.STACK',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzStack.prototype.show=function(){this.initTools();this.container.innerHTML='';var temp;this.paneChart=document.createElement('div');temp=this.paneChart.style;temp.cssFloat='left';temp.width='100%';temp.height='100%';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();$('#graphBox').hide();$('.graphActive').click();this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{_this.initGraphs(this.screen.curModal.graphList);}
this.container.appendChild(this.paneChart);this.spinnerRender.spin(this.container.parentElement);this.init();if(!this.screen.curModal.noteList){this.screen.curModal.noteList=[];}else{_this.initNotes(this.screen.curModal.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});};AnlzStack.prototype.close=function(){this.spinnerRender.stop();this.options=null;this.screen=null;this.paneChart=null;this.chart=null;this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();this.$svgBox=null;$('#graphBox').hide();this.resetDock();this.$paneDock=null;this.$dockManager=null;this.$dockPreviewer=null;this.container=null;};AnlzStack.prototype.init=function(){var _this=this;AppConfig.datasource.getDSItemData(this,this.screen.curModal.itemDS[0].arrId);};AnlzStack.prototype.render=function(data){this.initChart(data);var _this=this;};AnlzStack.prototype.initChart=function(data){var arrSeries=[];var arrLengend=[];for(var i=0;i<data.list.length;i++){var item=data.list[i];arrSeries.push(this.createSeries(item.dsItemId,item.data));arrLengend.push(arrSeries[i].name);}
this.chart=echarts.init(this.paneChart,AppConfig.chartTheme).setOption(this.initOption(arrSeries,arrLengend,data.timeShaft));};AnlzStack.prototype.initOption=function(series,arrLengend,timeSHaft){var i18nEcharts=I18n.resource.echarts;return{tooltip:{trigger:'axis'},legend:{data:arrLengend},grid:{x:60,x2:20,y:60,borderColor:'#eee'},toolbox:{show:true,feature:{mark:{show:true,title:{mark:i18nEcharts.MARK,markUndo:i18nEcharts.MARKUNDO,markClear:i18nEcharts.MARKCLEAR}},dataView:{show:true,readOnly:false,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar','stack','tiled'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR,stack:i18nEcharts.STACK,tiled:i18nEcharts.TILED}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,data:timeSHaft}],yAxis:[{type:'value',scale:true}],series:series,animationDuration:this.chartAnimationDuration,animationDurationUpdate:this.chartAnimationDuration/4};};AnlzStack.prototype.createSeries=function(id,data,type){return{id:id,name:AppConfig.datasource.getDSItemById(id).alias,type:'line',smooth:true,itemStyle:{normal:{areaStyle:{type:'default'}}},symbol:'none',stack:I18n.resource.observer.analysis.TOTAL_AMOUNT,data:data}};return AnlzStack;})();﻿var AnlzCluster=(function(){function AnlzCluster(container,option,screen){AnlzBase.call(this,container,option,screen);this.m_panelTrend=undefined;this.m_panelScatter=undefined;}
AnlzCluster.prototype=new AnlzBase();AnlzCluster.prototype.optionTemplate={imgName:'anlsPattern.png',imgIndex:6,imgColor:'65,131,189',templateName:'analysis.modalType.CLUSTER',templateParams:{paraName:['X'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:''};AnlzCluster.prototype.show=function(){var _this=this;this.initTools();this.container.innerHTML='';this.$paneNotes=$('<div style="position: relative; width: 100%; height: 100%;">');this.paneNotes=this.$paneNotes[0];this.$parentContainer=$(this.container).parent();this.$parentContainer.append($('<div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">').append(this.paneNotes));this.initDock();$('#graphBox').hide();$('.graphActive').click();this.$svgBox=$('<div class="svgBox" style="width:100%;height:100%;position:absolute;top:0;left:0;"></div>');this.$parentContainer.append(this.$svgBox);if(!this.screen.curModal.graphList){this.screen.curModal.graphList=[];}else{_this.initGraphs(this.screen.curModal.graphList);}
if(!this.screen.curModal.noteList){this.screen.curModal.noteList=[];}else{this.initNotes(this.screen.curModal.noteList);}
$('.itemTools .glyphicon-bookmark').off('click').click(function(){_this.createNote();});$(this.container).append($('<div style="width: 100%; height: 450px;">\
                <ul class="nav nav-tabs" role="tablist" id="myTab">\
                    <li role="presentation" class="active">\
                        <a id="aTendency" href="#tabTendency" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TREND_DISTRIBUTE"></span></a>\
                    </li>\
                    <li role="presentation">\
                        <a id="aScatter" href="#tabScatter" role="tab" data-toggle="tab" style="cursor:pointer;"><span i18n="analysis.paneConfig.TYPE_POINT"></span></a>\
                    </li>\
                </ul>\
                <div class="tab-content">\
                    <div role="tabpanel" class="tab-pane fade in active" id="tabTendency" style="height: 400px;"></div>\
                    <div role="tabpanel" class="tab-pane fade" id="tabScatter" style="height: 400px;"></div>\
                </div>\
             </div>\
             <div class="panel panel-default" style="position: absolute; height: calc(100% - 450px); top: 450px; left: 0; right: 0;">\
                 <div class="panel-heading"><span i18n="analysis.paneConfig.TYPICAL_CONDITION"></span></div>\
                 <div class="panel-body" style="padding: 0; height: calc(100% - 40px); overflow-y: auto;">\
                     <table class="table" id="tableGroup" style="overflow-x: auto;"></table>\
                 </div>\
             </div>'));I18n.fillArea($(this.container));_this.spinnerRender.spin(this.container.parentElement);this.init();}
AnlzCluster.prototype.close=function(){this.spinnerRender.stop();this.$paneNotes.parent().remove();this.$paneNotes=null;this.paneNotes=null;$('.svgBox').remove();this.$svgBox=null;$('#graphBox').hide();}
AnlzCluster.prototype.init=function(){var _this=this;var arrIds=[];var arrType=[];var arrDSItems=this.screen.curModal.itemDS;for(var i=0;i<arrDSItems.length;i++){var arrTemp=arrDSItems[i].arrId;if(arrTemp&&arrTemp.length>0){arrIds=arrIds.concat(arrTemp);arrType.push(this.optionTemplate.templateParams.paraName[i]);}}
var postData={dsItemIds:arrIds,timeStart:this.screen.curModal.startTime.format('yyyy-MM-dd HH:mm:ss'),timeEnd:this.screen.curModal.endTime.format('yyyy-MM-dd HH:mm:ss'),timeFormat:this.screen.curModal.format,pointType:arrType,systemType:this.optionTemplate.type};WebAPI.post('/analysis/startWorkspaceDataGenCluster',postData).done(function(result){var data=JSON.parse(result);if(data.error&&data.error.length>0){_this.errAlert(data.error);_this.spinnerStop();return;}
_this.renderModal(data);}).error(function(e){_this.screen.alertNoData();_this.spinnerStop();});},AnlzCluster.prototype.render=function(data){var _this=this;this.initTable(data);this.initTendency(data);$('#aScatter').on('shown.bs.tab',function(e){if($("#tabScatter div").length==0){_this.initScatter(data);}});_this.spinnerStop();};AnlzCluster.prototype.initTable=function(data){var table=$("#tableGroup");table.html("");var tbody=document.createElement("tbody");var tr,td,divLegend,details;if(!data.dataAnalysisResult.Pattern)return;for(var i=0;i<data.dataAnalysisResult.Pattern.length;i++){details=data.dataAnalysisResult.Pattern[i].Diagnosis;tr=document.createElement("tr");td=document.createElement("td");td.rowSpan=details?details.length:1;divLegend=document.createElement("span");divLegend.textContent="Group "+data.dataAnalysisResult.Pattern[i].name;divLegend.className='label label-warning';divLegend.style.padding='3px';divLegend.style.backgroundColor=echarts.config.color[i];td.appendChild(divLegend);tr.appendChild(td);td=document.createElement('td');if(details)td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[0].name+'</span>'+details[0].detail;tr.appendChild(td);tbody.appendChild(tr);if(details&&details.length>1){for(var j=1;j<details.length;j++){tr=document.createElement("tr");td=document.createElement("td");td.innerHTML='<span class="label label-warning" style="margin-right: 8px;">'+details[j].name+'</span>'+details[j].detail;tr.appendChild(td);tbody.appendChild(tr);}}}
$("#tableGroup").append(tbody);};AnlzCluster.prototype.initTendency=function(data){var arrSeries=new Array();var arrLegend=new Array();for(var i=0;i<data.dataAnalysisResult.Pattern.length;i++){var item=data.dataAnalysisResult.Pattern[i]
arrLegend.push(item.name);arrSeries.push({name:item.name,type:'line',stack:'总量',itemStyle:{normal:{areaStyle:{type:'default'}}},data:item.TrendValue});}
var i18nEcharts=I18n.resource.echarts;var option={tooltip:{trigger:'axis'},legend:{data:arrLegend},toolbox:{show:true,feature:{magicType:{show:true,type:['line','bar','stack','tiled'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR,stack:i18nEcharts.STACK,tiled:i18nEcharts.TILED}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:true,xAxis:[{type:'category',boundaryGap:false,data:data.dataAnalysisResult.Pattern[0].TrendLabel}],yAxis:[{min:0,max:100,type:'value'}],series:arrSeries,animationDuration:this.chartAnimationDuration};this.m_panelTrend=echarts.init(document.getElementById("tabTendency"),AppConfig.chartTheme);this.m_panelTrend.setOption(option);this.chart=this.m_panelTrend;};AnlzCluster.prototype.initScatter=function(data){var series=new Array();var seriesNames=new Array();for(var i=0,item,name,arrData,len=data.dataAnalysisResult.ScatterChart.length;i<len;i++){item=data.dataAnalysisResult.ScatterChart[i];name=item.name[0];arrData=new Array();for(var j=0,itemPoint;j<item.data.length;j++){itemPoint=item.data[j];arrData.push(itemPoint.split(','));}
seriesNames.push(name);series.push({name:name,type:'scatter',symbolSize:5,data:arrData});}
var i18nEcharts=I18n.resource.echarts;var option={title:{},tooltip:{trigger:'item',formatter:function(params){return params.seriesName+'<br/>'
+params.value[0]+', '+params.value[1];}},toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},legend:{data:seriesNames},xAxis:[{type:'value',scale:true}],yAxis:[{type:'value',scale:true}],animation:true,series:series,animationDuration:this.chartAnimationDuration};var myChart=echarts.init(document.getElementById("tabScatter"),AppConfig.chartTheme);myChart.setOption(option);};return AnlzCluster;})();var AnlzCluster_AHU=(function(){function AnlzCluster_AHU(container,option,screen){AnlzCluster.call(this,container,option,screen);}
AnlzCluster_AHU.prototype=new AnlzCluster();AnlzCluster_AHU.prototype.optionTemplate={imgName:'anlsClusterAhu.png',imgIndex:7,imgColor:'148,193,142',templateName:'analysis.modalType.CLUSTER_AHU',templateParams:{paraName:['MATemp','SATemp','RACO2','OATemp','RATemp','RATempSetting','SATempSetting','RACO2Setting','HWTemp','CWTemp','OperationMode','OADamperRatio','HCDamperRatio','CCDamperRatio','SAStaticPressure','SAStaticPressureSetting','FanVSDFrequency','CWRetrunTemp'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:'AHU'};return AnlzCluster_AHU;})();var AnlzCluster_Chiller=(function(){function AnlzCluster_Chiller(container,option,screen){AnlzCluster.call(this,container,option,screen);}
AnlzCluster_Chiller.prototype=new AnlzCluster();AnlzCluster_Chiller.prototype.optionTemplate={imgName:'anlsClusterChiller.png',imgIndex:8,imgColor:'211,97,78',templateName:'analysis.modalType.CLUSTER_CHILLER',templateParams:{paraName:['OADryTemp','OAWetBulbTemp','AmperRatio','ChwSupplyTemp','ChwReturnTemp','CwReturnTemp','CwSupplyTemp','EvpTemp','CondTemp'],paraAnlysMode:'part'},chartConfig:['easy','fixed','recent'],type:'Chiller'};return AnlzCluster_Chiller;})();﻿var AnlzEnergy=(function(){function AnlzEnergy(container,option,screen){AnlzBase.call(this,container,option,screen);}
AnlzEnergy.prototype=new AnlzBase();AnlzEnergy.prototype.optionTemplate={imgName:'anlsEnergy.png',imgIndex:9,imgColor:'65,131,189',templateName:'analysis.modalType.ENERGY',templateParams:{paraName:['X'],paraAnlysMode:'all'},chartConfig:['easy','fixed','recent']};AnlzEnergy.prototype.init=function(){AppConfig.datasource.getDSItemData(this,this.screen.curModal.itemDS[0].arrId);};AnlzEnergy.prototype.getDefaultOption=function(){var i18nEcharts=I18n.resource.echarts;return{tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},calculable:false,dataZoom:{show:false},grid:{"x":70,"x2":10,"y2":24},xAxis:[{type:'category',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}]};}
AnlzEnergy.prototype.render=function(dataSrc){var _this=this;if(undefined==dataSrc||dataSrc.length<=0||undefined==dataSrc.timeShaft||dataSrc.timeShaft.length<=0){_this.screen.saveModalJudge.rejectWith(_this.screen,[_this.screen]);alert('No data')
return;}
var xAxis;var arrXAxis=[];var len=dataSrc.timeShaft.length;for(var i=0;i<len;i++){arrXAxis.push(dataSrc.timeShaft[i]);}
xAxis=[{type:'category',data:arrXAxis}]
var dataName=[];var arrSeries=[];var showColor;len=dataSrc.list.length;for(var i=0;i<len;i++){showColor=echarts.config.color[i];var itemName=AppConfig.datasource.getDSItemById(dataSrc.list[i].dsItemId).alias;dataName.push(itemName);var arrData=[];var len2=dataSrc.list[i].data.length;var defVal;for(var j=1;j<len2;j++){defVal=dataSrc.list[i].data[j]-dataSrc.list[i].data[j-1];arrData.push(parseFloat(defVal.toFixed(1)));}
arrSeries.push({name:dataName[i],type:'bar',data:arrData,markPoint:{data:[{type:'max',name:'最大值'},{type:'min',name:'最小值'}]},itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,5,5]},emphasis:{color:showColor,barBorderRadius:[5,5,5,5]}}});}
dataOption={title:{text:'',subtext:''},legend:{data:dataName},dataZoom:{show:false},grid:{"x":70,"x2":10,"y2":24},xAxis:xAxis,series:arrSeries};_this.chart=echarts.init(_this.paneChart,AppConfig.chartTheme).setOption($.extend(true,{},_this.getDefaultOption(),dataOption));}
return AnlzEnergy;})();﻿(function($){function ModalDBHistory(){this.options=undefined;this.modal=null;this.refChart=null;this.showOptions={};}
ModalDBHistory.prototype.show=function(){var _this=this;var domPanelContent=document.getElementById('paneCenter');if(!this.modal)return;this.options=getDefaultOption();if($('#modalDBHistoryWrap').length>0){this.initCustomShow();return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalDBHistory.html').done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-db-history-wrap" id="modalDBHistoryWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');I18n.fillArea(_this.$wrap);_this.init();_this.initCustomShow();});};ModalDBHistory.prototype.displayCustomShow=function(options){if(!options)return;this.$selMode.val(options.mode);this.$selMode.trigger('change');if(options.mode==='fast'){this.$selTimerange.val(options.timeRange);}else{this.$selInterval.val(options.timeFmt);this.$selInterval.trigger('change');this.$iptTimeStart.val(options.startTimeStr);this.$iptTimeEnd.val(options.endTimeStr);}
this.$modal.modal('show');};ModalDBHistory.prototype.initCustomShow=function(){var showOptions=this.showOptions;var now;if(this.modal.type==="ModalMultiple"){now=new Date();showOptions.mode='custom';showOptions.timeFmt='h1';showOptions.startTimeStr=function(){return new Date(now.valueOf()-360000000).format('yyyy-MM-dd HH:00');}.call(this);showOptions.endTimeStr=function(){return now.format('yyyy-MM-dd HH:00');}.call(this);}else{showOptions=this.showOptions={mode:'fast',timeRange:'day'};}
this.displayCustomShow(showOptions);};ModalDBHistory.prototype.getOptionsByType=function(data){var options=[];if(this.modal.type==='ModalMultiple'){options=function(){var series=[];var legend=[];var typeMap={};var paraType=this.modal.option.paraType||[];var usedDsNameMap={};paraType.forEach(function(row){if(!row.arrId||!row.arrId.length)return;row.arrId.forEach(function(dsId){if(typeMap[dsId]===undefined){typeMap[dsId]=[row.type];}else{typeMap[dsId].push(row.type);}});});data.list.forEach(function(row){var type=typeMap[row.dsItemId].shift();var dsId=row.dsItemId;var name=AppConfig.datasource.getDSItemById(dsId).alias||dsId;usedDsNameMap[dsId]=usedDsNameMap[dsId]||0;usedDsNameMap[dsId]+=1;if(usedDsNameMap[dsId]>1){name=name+'_'+usedDsNameMap[dsId];}
legend.push(name);switch(type){case'line':series.push({name:name,type:'line',symbol:'none',data:row.data,yAxisIndex:1});break;case'bar':series.push({name:name,type:'bar',symbol:'none',data:row.data,yAxisIndex:0});break;case'area':series.push({name:name,type:'line',itemStyle:{normal:{areaStyle:{type:'default'}}},symbol:'none',data:row.data,yAxisIndex:0});break;case'cumulativeBar':series.push({name:name,type:'bar',stack:'realtime total',symbol:'none',data:row.data,yAxisIndex:0});break;default:break;}});return{series:series,legend:{data:legend},yAxis:[{type:'value',scale:false,splitArea:{show:false}},{type:'value',scale:false,splitArea:{show:false}}]};}.call(this);}else{options=function(){var series=[];var legend=[];var usedDsNameMap={};data.list.forEach(function(row){var dsId=row.dsItemId;var name=AppConfig.datasource.getDSItemById(dsId).alias||dsId;usedDsNameMap[dsId]=usedDsNameMap[dsId]||0;usedDsNameMap[dsId]+=1;if(usedDsNameMap[dsId]>1){name=name+'_'+usedDsNameMap[dsId];}
series.push({name:name,symbol:'none',type:'line',markLine:{data:[{type:'average',name:'average'}]},data:row.data});legend.push(name);});return{series:series,legend:{data:legend}};}.call(this);}
if(this.refChart){try{options.color=this.refChart.getOption().color||[];}catch(e){}}
return options;};ModalDBHistory.prototype.init=function(){this.$chartContainer=$('.chart-container',this.$modal);this.$btnSearch=$('.btn-search',this.$modal);this.$selMode=$('.sel-mode',this.$modal);this.$selTimerange=$('.sel-timerange',this.$modal);this.$selInterval=$('.sel-interval',this.$modal);this.$iptTimeStart=$('.ipt-timestart',this.$modal);this.$iptTimeEnd=$('.ipt-timeend',this.$modal);this.$groupFast=$('[data-group="fast"]',this.$modal);this.$groupCustom=$('[data-group="custom"]',this.$modal);this.initValidator();this.attachEvents();};ModalDBHistory.prototype.initValidator=function(){var _this=this;this.validator=new Validator({elements:[{name:'endTime',selector:this.$iptTimeEnd,rules:[{valid:function(val){var startTimeVal=_this.$iptTimeStart.val();if(val<=startTimeVal){this.fail();}else{this.success();}},msg:'the end time should later than start time.'}]}],icon:false});};ModalDBHistory.prototype.initTimePlugin=function(fmt){var now=new Date();if(!fmt){fmt={format:'yyyy-mm-dd hh:ii',showFormat:'yyyy-MM-dd HH:mm',minView:'hour',startView:'month',startTime:new Date(now.valueOf()-60*60*24*1000)};}else{this.$iptTimeStart.datetimepicker('remove');this.$iptTimeEnd.datetimepicker('remove');}
this.$iptTimeStart.datetimepicker({format:fmt.format,minView:fmt.minView,startView:fmt.startView,autoclose:true,todayBtn:true,initialDate:now});this.$iptTimeStart.val(fmt.startTime.format(fmt.showFormat));this.$iptTimeEnd.datetimepicker({format:fmt.format,minView:fmt.minView,startView:fmt.startView,autoclose:true,todayBtn:true,initialDate:now});this.$iptTimeEnd.val(now.format(fmt.showFormat));};ModalDBHistory.prototype.initChart=function(){if(!this.chart){this.chart=echarts.init(this.$chartContainer[0],'macarons');}};ModalDBHistory.prototype.setOptions=function(options){this.options=options;};ModalDBHistory.prototype.setModal=function(modal,chart){this.modal=modal;this.refChart=chart;};ModalDBHistory.prototype.attachEvents=function(){var _this=this;this.$selMode.off('change').on('change',function(e){var mode=$(this).val();if(mode==='fast'){_this.$selTimerange.val('hour');_this.$groupFast.show();_this.$groupCustom.hide();}else{_this.$groupFast.hide();_this.$groupCustom.show();_this.$selInterval.trigger('change');}
_this.showOptions.mode=mode;});this.$selInterval.off('change').on('change',function(e){var interval=$(this).val();var fmt={};var now=new Date(),nowTick=now.valueOf();fmt.endTime=now;switch(interval){case'm1':fmt.startTime=new Date(nowTick-60000);fmt.format="yyyy-mm-dd hh:ii";fmt.showFormat='yyyy-MM-dd HH:mm';fmt.minView='hour';fmt.startView='month';break;case'm5':fmt.startTime=new Date(nowTick-300000);fmt.format="yyyy-mm-dd hh:ii";fmt.showFormat='yyyy-MM-dd HH:mm';fmt.minView='hour';fmt.startView='month';break;case'h1':fmt.startTime=new Date(nowTick-3600000);fmt.format="yyyy-mm-dd hh:00";fmt.showFormat='yyyy-MM-dd HH:00';fmt.minView='day';fmt.startView='month';break;case'd1':fmt.startTime=new Date(nowTick-86400000);fmt.format="yyyy-mm-dd";fmt.showFormat='yyyy-MM-dd';fmt.minView='month';fmt.startView='month';break;case'M1':fmt.startTime=new Date(nowTick-2592000000);fmt.format="yyyy-mm";fmt.showFormat='yyyy-MM';fmt.minView='year';fmt.startView='year';break;}
_this.initTimePlugin(fmt);});this.$btnSearch.off('click').on('click',function(e){var startTime,endTime,timeFmt;var rangeTick;if(_this.showOptions.mode==='fast'){switch(_this.$selTimerange.val()){case'hour':rangeTick=3600000;timeFmt='m5';break;case'day':rangeTick=86400000;timeFmt='h1';break;case'week':rangeTick=604800000;timeFmt='h1';break;case'month':rangeTick=2592000000;timeFmt='d1';break;case'quarter':rangeTick=7776000000;timeFmt='d1';break;default:break;}
endTime=new Date();startTime=new Date(endTime.valueOf()-rangeTick);_this.updateChart(startTime,endTime,timeFmt);}else{_this.validator.valid().done(function(){startTime=new Date(_this.$iptTimeStart.val());endTime=new Date(_this.$iptTimeEnd.val());timeFmt=_this.$selInterval.val();_this.updateChart(startTime,endTime,timeFmt);});}
e.stopPropagation();});this.$modal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.reset();e.preventDefault();e.stopPropagation();});this.$modal.off('shown.bs.modal').on('shown.bs.modal',function(e){_this.initChart();_this.$btnSearch.trigger('click');});};ModalDBHistory.prototype.updateChart=function(start,end,timeFmt){var _this=this;var startTick,endTick;var points=this.modal.points;if(!points||!points.length){this.chart.setSeries([]);return;}
this.chart.showLoading({text:'Loading',effect:'spin',textStyle:{fontSize:20}});return WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:points,timeStart:start.format('yyyy-MM-dd HH:mm:ss'),timeEnd:end.format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeFmt}).then(function(rs){rs=JSON.parse(rs);var seriesData=[];var xAxisData=[];var timeShaft=rs.timeShaft;var list=rs.list;var optionsFromType;if(!rs.timeShaft||!rs.timeShaft.length){_this.chart.setOption({series:[{}]},true);return;}
timeShaft.forEach(function(row,i){xAxisData.push(row.toDate().format('MM-dd HH:mm'));});optionsFromType=_this.getOptionsByType(rs);_this.options.chartOptions.xAxis=[{boundaryGap:false,type:'category',data:xAxisData}];_this.options.chartOptions=$.extend(false,_this.options.chartOptions,optionsFromType);_this.chart.setOption(_this.options.chartOptions,true);_this.chart.hideLoading();},function(){_this.chart.setOption({series:[{}]},true);});};ModalDBHistory.prototype.reset=function(){if(!!this.chart){this.chart.clear();this.chart.dispose();this.chart=null;}};ModalDBHistory.prototype.close=function(){this.$wrap.remove();};function getDefaultOption(){var i18nEcharts=I18n.resource.echarts;return{chartOptions:{toolbox:{show:true,feature:{dataZoom:{show:true,title:{dataZoom:i18nEcharts.DATAZOOM,dataZoomReset:i18nEcharts.DATAZOOMRESET}},dataView:{show:false,readOnly:true,title:i18nEcharts.DATAVIEW,lang:[i18nEcharts.DATAVIEW,i18nEcharts.CLOSE,i18nEcharts.REFRESH]},magicType:{show:true,type:['line','bar'],title:{line:i18nEcharts.LINE,bar:i18nEcharts.BAR}},restore:{show:true,title:i18nEcharts.REDUCTION},saveAsImage:{show:true,title:i18nEcharts.SAVE_AS_PICTURE,lang:i18nEcharts.SAVE}}},tooltip:{trigger:'axis'},dataZoom:{show:true},grid:{y:50,y2:80},yAxis:[{type:'value',boundaryGap:[0.1,0.1]}],series:[]}};}
this.ModalDBHistory=ModalDBHistory;}).call(this,jQuery);var ModalBase=(function(){function ModalBase(parent,entity,_funcRender,_funcUpdate,_funcConfigMode){if(!parent)return;this.screen=parent;this.entity=entity;this.wikis={};this.container=undefined;this.chart=undefined;this.spinner=undefined;this.executeRender=_funcRender;this.executeConfigMode=_funcConfigMode;this.executeUpdate=_funcUpdate;this.modalWikiCtr=undefined;this.initContainer();};ModalBase.prototype={UNIT_WIDTH:8.325,UNIT_HEIGHT:16.5,initContainer:function(replacedElementId){var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass='';if((!divParent)||replacedElementId){var isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}
else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
divParent.className='springContainer';if(AppConfig.isMobile){divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR*2+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*2+'%';}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.type=='ModalNote'||this.entity.modal.type=='ModalMix'){scrollClass=' gray-scrollbar scrollY'}
if(this.entity.modal.title&&this.entity.modal.title!=''&&(!this.entity.isNotRender)){divParent.innerHTML='<div class="panel panel-default">\
                    <div class="panel-heading springHead">\
                        <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                    </div>\
                    <div class="panel-body springContent'+scrollClass+'" style="position: relative;"></div>\
                </div>';}else{divParent.innerHTML='<div class="panel panel-default" >\
                    <div class="panel-body springContent'+scrollClass+'" style="position: relative;height:100%;"></div>\
                </div>';}
if(!(this instanceof ModalAnalysis)){var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];var lkHistory;if(this.entity.modal.points&&this.entity.modal.points.length>0){var lkJump;lkJump=document.createElement('a');lkJump.className='springLinkBtn';lkJump.title='Add to datasource';lkJump.href='javascript:;';lkJump.innerHTML='<span class="glyphicon glyphicon-export"></span>';divBtnCtn.appendChild(lkJump);lkJump.onclick=function(){new ModalAppendPointToDs(true,_this.entity.modal.points,null).show();}}
if(['ModalHtml','ModalMix','ModalObserver','ModalRank','ModalRankNormal','ModalNone'].indexOf(this.entity.modal.type)>-1||!this.entity.modal.points||!this.entity.modal.points.length){}else{lkHistory=document.createElement('a');lkHistory.className='springLinkBtn';lkHistory.title='Show History';lkHistory.href='javascript:;';lkHistory.innerHTML='<span class="glyphicon glyphicon-stats"></span>';divBtnCtn.appendChild(lkHistory);this.attachLkHistoryEvents(lkHistory);}
var link=this.entity.modal.link;var _this=this;if(link&&AppConfig.menu[link]){var linkBtn=document.createElement('a');linkBtn.className='springLinkBtn';linkBtn.innerHTML='<span class="glyphicon glyphicon-link"></span>';linkBtn.setAttribute('pageid',link);linkBtn.title='Link to '+AppConfig.menu[link];divBtnCtn.appendChild(linkBtn);linkBtn.onclick=function(e){var $ev=$('#ulPages [pageid="'+link+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');}}
var wikiId=this.entity.modal.wikiId;if(wikiId){var wikiBtn=document.createElement('a');wikiBtn.className='springLinkBtn';wikiBtn.innerHTML='<span class="glyphicon glyphicon-info-sign"></span>';wikiBtn.title='View detail info';wikiBtn.id=wikiId;divBtnCtn.appendChild(wikiBtn);wikiBtn.onclick=function(){_this.getInstanceOfModalWiki().viewWikiInfo(wikiId);}}
domPanel.appendChild(divBtnCtn);}
this.container=divParent.getElementsByClassName('springContent')[0];if(this.entity.modal.type!=='ModalMix'){this.spinner=new LoadingSpinner({color:'#00FFFF'});this.spinner.spin(this.container);}
return this;},initToolTips:function(parent){var _this=this;if(!parent)return;var descTip=new StringBuilder();descTip.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');descTip.append('    <div class="tooltipTitle tooltip-inner" style="display:none">GeneralRegressor</div>');descTip.append('    <div class="tooltipContent" style="border:1px solid black">');descTip.append('        <p class="containerDesc" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.entity.modal.desc).append('</span> ').append('</p>');descTip.append('    </div>');descTip.append('    <div class="tooltip-arrow"></div>');descTip.append('</div>');var options={placement:'bottom',title:_this.entity.modal.title,template:descTip.toString()};if(_this.entity.modal.desc&&_this.entity.modal.desc!=''){$(parent).tooltip(options);}},render:function(){try{this.executeRender();}catch(e){console.warn(e);}
if(this.chart){this.chart.on('resize',function(param){this.resize();});}},update:function(options){var modal,dsChartConfig,accuracy;var num,specialCond;if((!options)||options.length==0)return;modal=this.entity.modal;dsChartConfig=modal.dsChartCog&&modal.dsChartCog.length?modal.dsChartCog[0]:{};accuracy=dsChartConfig.accuracy;if(accuracy!==''&&!isNaN(accuracy)){specialCond=['',null,undefined];options=options.map(function(row,i){if(specialCond.indexOf(row.data)>-1||isNaN(row.data)){return row;}else{num=+row.data;row.data=num.toFixed(accuracy);return row;}});}
try{this.executeUpdate(options);}catch(e){console.warn(e);}},configure:function(){this.spinner&&this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';if(this.entity.modal.type!='ModalAnalysis'||!this.screen.isForReport){var btnConfig=document.createElement('span');btnConfig.className='glyphicon glyphicon-cog springConfigBtn grow';btnConfig.title='Options';btnConfig.onclick=btnConfig_clickEvent;divMask.appendChild(btnConfig);}
var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this.screen.isScreenChange=true;_this=null;};divMask.appendChild(btnRemove);var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);if(!(this instanceof ModalAnalysis)){var $divLink=$('<div class="divResize chartLink">');var $labelLink=$('<label>').text(I18n.resource.dashboard.show.LINK_TO);var chartLink=document.createElement('select');chartLink.className='form-control';chartLink.options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,''));for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);if(this.entity.modal.link==i){option.selected='selected';}
chartLink.options.add(option);}
chartLink.onchange=function(){_this.entity.modal.link=chartLink.value;_this.screen.isScreenChange=true;};$divLink.append($labelLink).append($(chartLink));divMask.appendChild($divLink[0]);var $divWiki=$('<div class="divResize chartId chartWiki">');var $labelWiki=$('<label for="title">').text(I18n.resource.dashboard.show.WIKI_ID);var inputChartWiki=document.createElement('input');inputChartWiki.id='wikiId';inputChartWiki.className='form-control';inputChartWiki.value=this.entity.modal.wikiId?this.entity.modal.wikiId:'';if(this.entity.modal.wikiId!=''&&this.entity.modal.wikiId!=undefined){inputChartWiki.style.display='none';}
$divWiki.append($labelWiki).append($(inputChartWiki));divMask.appendChild($divWiki[0]);var chartWikiShow=document.createElement('p');chartWikiShow.innerHTML=inputChartWiki.value;chartWikiShow.className='chartTitleShow';$divWiki[0].appendChild(chartWikiShow);if(this.entity.modal.wikiId==''||this.entity.modal.wikiId==undefined){chartWikiShow.style.display='none';}
chartWikiShow.onclick=function(){chartWikiShow.style.display='none';inputChartWiki.style.display='inline-block';inputChartWiki.focus();};inputChartWiki.onchange=function(){if(inputChartWiki.value!=''){inputChartWiki.style.display='none';chartWikiShow.style.display='inline';}
chartWikiShow.innerHTML=inputChartWiki.value;_this.entity.modal.wikiId=inputChartWiki.value;_this.screen.isScreenChange=true;};var $btnCreateWiki=$('<button  type="button" class="btn btn-primary" style="padding: 3px;line-height: 1.2;">Wiki</button>');$btnCreateWiki.click(function(){var modalWiki=_this.getInstanceOfModalWiki();if(_this.entity.modal.wikiId!=''){if(_this.wikis[_this.entity.modal.wikiId]){modalWiki.showWikiEdit(_this.wikis[_this.entity.modal.wikiId]);}else{WebAPI.get('/getWikiById/'+_this.entity.modal.wikiId).done(function(result){var result=JSON.parse(result);if(result.id){_this.wikis[result.id]=result
modalWiki.showWikiEdit(result);}else{modalWiki.showWikiSearch();}}).fail(function(result){alert(result)});}}else{var modalWiki=_this.getInstanceOfModalWiki();modalWiki.showWikiSearch();}});$divWiki[0].appendChild($btnCreateWiki[0]);var $divPop=$('<div class="divResize chartId chartPop">');var $labelPop=$('<label for="title">').text(I18n.resource.dashboard.show.POP_ID);var inputChartPop=document.createElement('input');inputChartPop.id='popId';inputChartPop.className='form-control';inputChartPop.value=this.entity.modal.popId?this.entity.modal.popId:'';if(this.entity.modal.popId!=''&&this.entity.modal.popId!=undefined){inputChartPop.style.display='none';}
$divPop.append($labelPop).append($(inputChartPop));divMask.appendChild($divPop[0]);var chartPopShow=document.createElement('p');chartPopShow.innerHTML=inputChartPop.value;chartPopShow.className='chartTitleShow';$divPop[0].appendChild(chartPopShow);if(this.entity.modal.popId==''||this.entity.modal.popId==undefined){chartPopShow.style.display='none';}
chartPopShow.onclick=function(){chartPopShow.style.display='none';inputChartPop.style.display='inline-block';inputChartPop.focus();};inputChartPop.onchange=function(){if(inputChartPop.value!=''){inputChartPop.style.display='none';chartPopShow.style.display='inline';}
chartPopShow.innerHTML=inputChartPop.value;_this.entity.modal.popId=inputChartPop.value;_this.screen.isScreenChange=true;};}
var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onchange=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;_this.screen.isScreenChange=true;};this.container.parentNode.appendChild(divMask);if(this.entity.isNotRender&&this.screen.entity){$(document.getElementById('divContainer_'+this.screen.entity.id)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}
this.divResizeByToolInit();function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.modalInit();}
function btnEdit_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).closest('.springContainer').addClass('springSel');_this.showEditModal();}
var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();if(!$sourceParent[0].classList.contains('chartsCt')&&$targetParent[0].classList.contains('chartsCt')){_this.screen.insertChartIntoMix(sourceId,$(e.target).closest('.chartsCt')[0])}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}
_this.screen.isScreenChange=true;}
this.executeConfigMode();},setModalOption:function(option){},modalInit:function(){var _this=this;var dataItem=[],option;var dataTypeUnit;var type=false;if(_this.entity.modal.points!=undefined){if(_this.entity.modal.option&&_this.entity.modal.option.paraType){for(var i=0;i<_this.entity.modal.option.paraType.length;i++){dataTypeUnit={dsId:[],dsType:'',dsName:[]};dataTypeUnit.type=_this.entity.modal.option.paraType[i].type;for(var j=0;j<_this.entity.modal.option.paraType[i].arrId.length;j++){dataTypeUnit.dsId.push(_this.entity.modal.option.paraType[i].arrId[j]);dataTypeUnit.dsName.push(AppConfig.datasource.getDSItemById(_this.entity.modal.option.paraType[i].arrId[j]).alias);}
dataItem.push(dataTypeUnit);}}else{dataTypeUnit={dsId:[],dsType:'',dsName:[]};for(var i=0;i<_this.entity.modal.points.length;i++){dataTypeUnit.dsId.push(_this.entity.modal.points[i]);dataTypeUnit.dsName.push(AppConfig.datasource.getDSItemById(_this.entity.modal.points[i]).alias);}
dataItem.push(dataTypeUnit);}}
if(_this.optionTemplate.mode==='custom'){_this.showConfigModal();return;}
if(_this.optionTemplate.type==='ModalReportChapter'){_this.showConfigModal();return;}
var tempOptionPara;_this.entity.modal.option?tempOptionPara=_this.entity.modal.option:tempOptionPara={};tempOptionPara.dataItem=dataItem;option={modeUsable:_this.optionTemplate.mode,allDataNeed:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraAnlysMode:true,rowDataType:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraName:[I18n.resource.analysis.paneConfig.DATA_TYPE_DEFAULT],rowDataTypeShowName:_this.optionTemplate.modelParams?_this.optionTemplate.modelParams.paraShowName:undefined,dataTypeMaxNum:[_this.optionTemplate.maxNum],templateType:_this.optionTemplate.type,dsChartCog:_this.entity.modal.dsChartCog?_this.entity.modal.dsChartCog:null,optionPara:tempOptionPara};if(dataItem.length==0){type=true;}
if(_this.screen.screen){_this.screen.screen.modalConfigPane.showModalInit(type,option,_this);}else{_this.screen.modalConfigPane.showModalInit(type,option,_this);}
_this.screen.isScreenChange=true;},divResizeByToolInit:function(){var _this=this;var $divContainer=$('#divContainer_'+_this.entity.id);var $divResize=$('.divResize');var $inputResize=$('.inputResize');$divContainer.find('#heightResize').mousedown(function(e){$('.springConfigMask').attr('draggable','false');$('.springContent').attr('draggable','false');$(e.target).mousemove(function(e){$(e.target).closest('.springContainer').css('height',$(e.target).val()*_this.UNIT_HEIGHT+'%');_this.entity.spanR=Number($(e.target).val());$(e.target).next().text($(e.target).val()+' /6');if(_this.screen.screen){_this.screen.screen.setEntity(_this.entity);}else{_this.screen.setEntity(_this.entity);}});}).mouseup(function(e){$('.springConfigMask').attr('draggable','true');$('.springContent').attr('draggable','true');$(e.target).off('mousemove');if(_this.chart)_this.chart.resize();_this.screen.isScreenChange=true;});$divContainer.find('#widthResize').mousedown(function(e){$('.springConfigMask').attr('draggable','false');$('.springContent').attr('draggable','false');$(e.target).mousemove(function(e){$(e.target).closest('.springContainer').css('width',$(e.target).val()*_this.UNIT_WIDTH+'%');_this.entity.spanC=Number($(e.target).val());$(e.target).next().text($(e.target).val()+' /12');if(_this.screen.screen){_this.screen.screen.setEntity(_this.entity);}else{_this.screen.setEntity(_this.entity);}});}).mouseup(function(e){$('.springConfigMask').attr('draggable','true');$('.springContent').attr('draggable','true');$(e.target).off('mousemove');if(_this.chart)_this.chart.resize();_this.screen.isScreenChange=true;});$divContainer.find('.rangeVal').click(function(e){e.stopPropagation();var valueCurrent=Number($(e.target).prev().val());var valuePre=$(e.target).prev().val();var valueMax=Number($(e.target).prevAll('.inputResize').attr('max'));var valueMin=Number($(e.target).prevAll('.inputResize').attr('min'));$(e.target).nextAll('.rangeChange').css('display','inline-block').focus().off('blur').blur(function(e){valueCurrent=Number($(e.target).val());if(valueCurrent<=valueMax&&valueCurrent>=valueMin){$(e.target).prevAll('.inputResize').val(valueCurrent.toString());if($(e.target).prevAll('.inputResize').attr('id')=='widthResize'){$(e.target).closest('.springContainer').css('width',$(e.target).val()*_this.UNIT_WIDTH+'%');_this.entity.spanC=Number($(e.target).val());_this.screen.setEntity(_this.entity);$(e.target).prev().text($(e.target).val()+' /12');if(_this.chart)_this.chart.resize();}else{$(e.target).closest('.springContainer').css('height',$(e.target).val()*_this.UNIT_HEIGHT+'%');_this.entity.spanR=Number($(e.target).val());_this.screen.setEntity(_this.entity);$(e.target).prev().text($(e.target).val()+' /6');if(_this.chart)_this.chart.resize();}
$(e.target).css('display','none');}else if(valueCurrent>valueMax){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR1+"</strong>").show().close();$(e.target).val(valuePre).css('display','none');}else if(valueCurrent<valueMin){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR2+"</strong>").show().close();$(e.target).val(valuePre).css('display','none');}else{if($(e.target).val()!=""){new Alert($('#resizeAlert'),"danger","<strong>"+I18n.resource.dashboard.resize.ERR3+"</strong>").show().close();}
$(e.target).val(valuePre).css('display','none');}
_this.screen.isScreenChange=true;})});},divResizeByMouseInit:function(){var _this=this;var $widthResize;var $heightResize;var divContainer=$('#divContainer_'+_this.entity.id).get(0);var resizeOnRight=document.createElement('div');resizeOnRight.className='resizeOnRight';divContainer.appendChild(resizeOnRight);var resizeOnBottom=document.createElement('div');resizeOnBottom.className='resizeOnBottom';divContainer.appendChild(resizeOnBottom);var resizeOnCorner=document.createElement('div');resizeOnCorner.className='resizeOnCorner';divContainer.appendChild(resizeOnCorner);var mouseStart={};var divStart={};var rightStart={};var bottomStart={};var w,h,tempSpanR,tempSpanC;resizeOnRight.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$widthResize=$(e.target).parent().find('#widthResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;rightStart.x=resizeOnRight.offsetLeft;doResizeOnRight(e);if(resizeOnRight.setCapture){resizeOnRight.onmousemove=doResizeOnRight;resizeOnRight.onmouseup=stopResizeOnRight;resizeOnRight.setCapture();}else{document.addEventListener("mousemove",doResizeOnRight,false);document.addEventListener("mouseup",stopResizeOnRight,false);}};function doResizeOnRight(e){var oEvent=e||event;var l=oEvent.clientX-mouseStart.x+rightStart.x;w=l+resizeOnCorner.offsetWidth;if(w<resizeOnCorner.offsetWidth){w=resizeOnCorner.offsetWidth;}
else if(w>document.documentElement.clientWidth-divContainer.offsetLeft){w=document.documentElement.clientWidth-divContainer.offsetLeft-2;}
divContainer.style.width=w+"px";}
function stopResizeOnRight(e){if(resizeOnRight.releaseCapture){tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /12');$widthResize.next().next().val(tempSpanC.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH+"%";_this.entity.spanC=tempSpanC;resizeOnRight.onmousemove=null;resizeOnRight.onmouseup=null;resizeOnRight.releaseCapture();if(_this.chart)_this.chart.resize();}else{tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /12');$widthResize.next().next().val(tempSpanC.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH+"%";_this.entity.spanC=tempSpanC;document.removeEventListener("mousemove",doResizeOnRight,false);document.removeEventListener("mouseup",stopResizeOnRight,false);if(_this.chart)_this.chart.resize();}
_this.screen.isScreenChange=true;$(e.target).prev().children(':last-child').attr('draggable',true);var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}}
resizeOnBottom.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$heightResize=$(e.target).parent().find('#heightResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;bottomStart.y=resizeOnBottom.offsetTop;doResizeOnBottom(e);if(resizeOnBottom.setCapture){resizeOnBottom.onmousemove=doResizeOnBottom;resizeOnBottom.onmouseup=stopResizeOnBottom;resizeOnBottom.setCapture();}else{document.addEventListener("mousemove",doResizeOnBottom,false);document.addEventListener("mouseup",stopResizeOnBottom,false);}};function doResizeOnBottom(e){var oEvent=e||event;var t=oEvent.clientY-mouseStart.y+bottomStart.y;h=t+resizeOnCorner.offsetHeight;if(h<resizeOnCorner.offsetHeight){h=resizeOnCorner.offsetHeight;}else if(h>document.documentElement.clientHeight-divContainer.offsetTop){h=document.documentElement.clientHeight-divContainer.offsetTop-2;}
divContainer.style.height=h+"px";}
function stopResizeOnBottom(e){if(resizeOnBottom.releaseCapture){tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /6');$heightResize.next().next().val(tempSpanR.toString());divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT+"%";_this.entity.spanR=tempSpanR;resizeOnBottom.onmousemove=null;resizeOnBottom.onmouseup=null;resizeOnBottom.releaseCapture();if(_this.chart)_this.chart.resize();}else{tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /6');$heightResize.next().next().val(tempSpanR.toString());divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT+"%";_this.entity.spanR=tempSpanR;document.removeEventListener("mousemove",doResizeOnBottom,false);document.removeEventListener("mouseup",stopResizeOnBottom,false);if(_this.chart)_this.chart.resize();}
_this.screen.isScreenChange=true;$(e.target).prev().children(':last-child').attr('draggable',true);var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}}
resizeOnCorner.onmousedown=function(e){e.stopPropagation();if(e.button!=0)return;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',false)}
$(e.target).prev().children(':last-child').attr('draggable',false);$widthResize=$(e.target).parent().find('#widthResize');$heightResize=$(e.target).parent().find('#heightResize');var oEvent=e||event;mouseStart.x=oEvent.clientX;mouseStart.y=oEvent.clientY;divStart.x=resizeOnCorner.offsetLeft;divStart.y=resizeOnCorner.offsetTop;doResizeOnCorner(e);if(resizeOnCorner.setCapture){resizeOnCorner.onmousemove=doResizeOnCorner;resizeOnCorner.onmouseup=stopResizeOnCorner;resizeOnCorner.setCapture();}else{document.addEventListener("mousemove",doResizeOnCorner,false);document.addEventListener("mouseup",stopResizeOnCorner,false);}};function doResizeOnCorner(e){var oEvent=e||event;var l=oEvent.clientX-mouseStart.x+divStart.x;var t=oEvent.clientY-mouseStart.y+divStart.y;w=l+resizeOnCorner.offsetWidth;h=t+resizeOnCorner.offsetHeight;if(w<resizeOnCorner.offsetWidth){w=resizeOnCorner.offsetWidth;}
else if(w>document.documentElement.clientWidth-divContainer.offsetLeft){w=document.documentElement.clientWidth-divContainer.offsetLeft-2;}
if(h<resizeOnCorner.offsetHeight){h=resizeOnCorner.offsetHeight;}else if(h>document.documentElement.clientHeight-divContainer.offsetTop){h=document.documentElement.clientHeight-divContainer.offsetTop-2;}
divContainer.style.width=w+"px";divContainer.style.height=h+"px";}
function stopResizeOnCorner(e){if(resizeOnCorner.releaseCapture){tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$widthResize.val(tempSpanC.toString()).get(0).setAttribute('value',tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /12');$widthResize.next().next().val(tempSpanC.toString());$heightResize.val(tempSpanR.toString()).get(0).setAttribute('value',tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /6');$heightResize.next().next().val(tempSpanR.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH+"%";divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT+"%";_this.entity.spanC=tempSpanC;_this.entity.spanR=tempSpanR;resizeOnCorner.onmousemove=null;resizeOnCorner.onmouseup=null;resizeOnCorner.releaseCapture();if(_this.chart)_this.chart.resize();}else{tempSpanC=parseInt(w*100/(divContainer.parentNode.clientWidth*_this.UNIT_WIDTH));tempSpanR=parseInt(h*100/(divContainer.parentNode.clientHeight*_this.UNIT_HEIGHT));rangeJudge();$widthResize.val(tempSpanC.toString());$widthResize.next().text(tempSpanC.toString()+' /12');$widthResize.next().next().val(tempSpanC.toString());$heightResize.val(tempSpanR.toString());$heightResize.next().text(tempSpanR.toString()+' /6');$heightResize.next().next().val(tempSpanR.toString());divContainer.style.width=tempSpanC*_this.UNIT_WIDTH+"%";divContainer.style.height=tempSpanR*_this.UNIT_HEIGHT+"%";_this.entity.spanC=tempSpanC;_this.entity.spanR=tempSpanR;document.removeEventListener("mousemove",doResizeOnCorner,false);document.removeEventListener("mouseup",stopResizeOnCorner,false);if(_this.chart)_this.chart.resize();}
_this.screen.isScreenChange=true;var $possibleParent=$(e.target).closest('.springConfigMask');if($possibleParent.length>0){$possibleParent.attr('draggable',true)}
$(e.target).prev().children(':last-child').attr('draggable',true);}
function rangeJudge(){if(tempSpanC>_this.optionTemplate.maxWidth){tempSpanC=_this.optionTemplate.maxWidth}else if(tempSpanC<_this.optionTemplate.minWidth){tempSpanC=_this.optionTemplate.minWidth}
if(tempSpanR>_this.optionTemplate.maxHeight){tempSpanR=_this.optionTemplate.maxHeight}else if(tempSpanR<_this.optionTemplate.minHeight){tempSpanR=_this.optionTemplate.minHeight}}},attachLkHistoryEvents:function(domItem){var _this=this;domItem.onclick=function(e){_this.modalDBHistory.setModal(_this.entity.modal,_this.chart);_this.modalDBHistory.show();e.preventDefault();e.stopPropagation();};},modalDBHistory:new ModalDBHistory(),initPointAlias:function(arrPoints){var arrPointsAlias=[];var lastRepeatIndex=-1;var tempAlias;var repeatNum=0;var tempIndex;for(var i=0;i<arrPoints.length;++i){arrPointsAlias.push(AppConfig.datasource.getDSItemById(arrPoints[i].dsItemId).alias);}
for(var i=0;i<arrPoints.length;++i){lastRepeatIndex=arrPointsAlias.lastIndexOf(arrPointsAlias[i]);if(lastRepeatIndex>i){repeatNum=1;tempAlias=arrPointsAlias[i];arrPointsAlias[i]=tempAlias+'_No1';tempIndex=i;for(var j=tempIndex+1;j<lastRepeatIndex+1;j++){repeatNum+=1;tempIndex=arrPointsAlias.indexOf(tempAlias);if(tempIndex==-1)break;arrPointsAlias[tempIndex]=tempAlias+'_No'+repeatNum;}}}
return arrPointsAlias;},close:function(){if(this.chart){this.chart.clear();this.chart.dispose();}
this.container=null;this.entity=null;this.executeConfigMode=null;this.executeRender=null;this.executeUpdate=null;this.isFirstRender=null;this.modalWikiCtr=null;this.screen=null;this.isConfigMode=null;this.reportScreen=null;typeof this._close==='function'&&this._close();},renderPop:function(pop){if(!pop)return;var $target=$('#divContainer_'+this.entity.id).find('.panel');var $panePop=$target.find('.panePop');var tpl='<div class="divMove"><span>{popMsg}</span></div>\
                <span class="glyphicon glyphicon-remove-circle btnClosePop" title="Close"></span>';if(!$panePop[0]){$panePop=$('<div class="panel-body panePop"></div>');$target.append($panePop);}
$panePop.html(tpl.formatEL({popMsg:pop.data}));var spanWidth=$panePop.find('span').width();var $divMove=$panePop.find('.divMove');if(spanWidth>$divMove.width()){var $marquee=$('<marquee direction="left" onmouseover="this.stop()" onmouseout="this.start()" scrollAmount="3" style="height: 40px; width: calc(100% - 28px);"></marquee>');$marquee.html($panePop.find('span').html());$marquee.appendTo($panePop);$divMove.remove();}
$panePop.find('.btnClosePop').off().click(function(){$panePop.hide();});},getInstanceOfModalWiki:function(){if(!this.modalWikiCtr){this.modalWikiCtr=new ModalWiki(this);}
return this.modalWikiCtr;}};return ModalBase;})();﻿var ModalNone=(function(){function ModalNone(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,null,null);}
ModalNone.prototype=new ModalBase();ModalNone.prototype.optionTemplate={name:'',mode:['realTime'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalNone'};ModalNone.prototype.renderModal=function(){I18n.fillArea($('#coalSaveName').parent());$(this.container).parent().css('visibility','hidden');this.spinner.stop();},ModalNone.prototype.configure=function(){this.spinner.stop();var _this=this;$(_this.container).parent().css('visibility','');var divAdd=document.createElement('span');divAdd.className='springConfigTips';divAdd.innerHTML='Drag data meta from left panel';this.container.appendChild(divAdd);var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this=null;};this.container.appendChild(btnRemove);var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';this.container.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';this.container.appendChild(btnWidthResize);this.divResizeByMouseInit();this.divResizeByToolInit();if(this.entity.isNotRender&&this.screen.entity){$(document.getElementById('divContainer_'+this.screen.entity.id)).find('.chartsCt')[0].appendChild(this.container.parentNode.parentNode);}
var divParent=$(this.container).closest('.springContainer')[0];var divContent=$(divParent).find('.springContent')[0];divContent.draggable='true';divContent.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divContent.ondragover=function(e){e.preventDefault();};divContent.ondragleave=function(e){e.preventDefault();};divParent.ondrop=function(e){e.stopPropagation();if(e.dataTransfer.getData("type")&&e.dataTransfer.getData("title")){if(e.dataTransfer.getData("type")=="ModalPointKPI"){alert(I18n.resource.toolBox.modal.MSG_KPI_NOT_ALLOW_TO_MIX);return false;}
if(_this.screen.screen){var entity=_this.entity;if(e.dataTransfer.getData("type")=='ModalMix'){alert(I18n.resource.toolBox.modal.MSG_MIX_NOT_ALLOW_TO_MIX);return;}else{_this.screen.screen.rebornEntity(entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"));}}else{_this.screen.rebornEntity(_this.entity,e.dataTransfer.getData("type"),e.dataTransfer.getData("title"));}}else if(e.dataTransfer.getData("id")){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');_this.screen.replaceEntity(e.dataTransfer.getData("id"),targetId);}}}
return ModalNone;})();﻿var ModalAnalysis=(function(){var _this=undefined;function ModalAnalysis(screen,entityParams){entityParams.spanR=6;entityParams.spanC=12;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.spinner.stop();this.container=$('<div style="padding: 20px;position: absolute;left:0;top:0;right:0;bottom:0; z-index: 102; overflow-y: auto;"></div>').appendTo(this.container)[0];_this=this;this.curModal=this.entity.modal.option.option;this.entityAnalysis=undefined;this.saveModalJudge=$.Deferred();}
ModalAnalysis.prototype=new ModalBase();ModalAnalysis.prototype.optionTemplate={name:'toolBox.modal.TRANSIT',parent:2,mode:['realTimeWithoutRange'],maxNum:1,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalAnalysis'};ModalAnalysis.prototype.renderModal=function(){var modalClass=this.screen.factoryIoCAnalysis.getModel(this.entity.modal.option.type);this.screen.curModal=this.curModal;this.entityAnalysis=new modalClass(this.container,this.curModal,this);this.entityAnalysis.isShareMode=1;this.entityAnalysis.paneChart=null;this.entityAnalysis.chartAnimationDuration=500;this.entityAnalysis.animation=false;this.entityAnalysis.show();};ModalAnalysis.prototype.onresize=function(){if(this.entityAnalysis.chart)this.entityAnalysis.chart.resize();};ModalAnalysis.prototype.updateModal=function(points){};ModalAnalysis.prototype.showConfigMode=function(){};ModalAnalysis.prototype.setModalOption=function(option){};ModalAnalysis.prototype.alertNoData=function(){};ModalAnalysis.prototype.spinnerStop=function(){};ModalAnalysis.prototype.saveModal=function(){};return ModalAnalysis;})();var ModalConfig=(function($,undefined){var arrForEach=Array.prototype.forEach;function ModalConfig(options){this.options=$.extend({},this.DEFAULTS,options);this.$wrap=null;};ModalConfig.prototype={constructor:ModalConfig,show:function(){var _this=this;var htmlUrl=this.options.htmlUrl;var matches=htmlUrl.match(/\/?(\w+)(?:\.html)/);var id,domPanelContent;if(!matches||matches[1]===undefined){console.error('the url of config modal is illigal: '+htmlUrl);return false;}
id=matches[1]+'Wrap';if($('#'+id).length>0){this.$modal.modal('show');return;}
domPanelContent=document.getElementById('paneContent')
Spinner.spin(domPanelContent);WebAPI.get(htmlUrl).done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-config-wrap" id="'+id+'">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this._attachEvents();_this.init();_this.$modal.modal('show');});},_setField:function(type,$ele,value){var itemMap,name;switch(type){case'dropdown':itemMap=$ele.data('dropdown-items');if(itemMap===undefined){$ele.data('dropdown-items',itemMap=(function(){var rs={};$ele.siblings('ul').find('a').each(function(i,item){var $item=$(item);var value=$item.attr('data-value');var text=$item.text();if(rs[value]===undefined)rs[value]=text;});return rs;}()));}
$ele.attr('data-value',value).children('span').eq(0).text(itemMap[value]);break;case'input':case'textarea':if(value===undefined||value===null)value='';$ele.val(value);break;case'droparea':if(value===undefined||value.trim()===''){$ele.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');}
else{name=AppConfig.datasource.getDSItemById(value).alias;$ele.attr({'data-value':value,'title':name}).html('<span>'+name+'</span>');}
break;default:break;}},_attachEvents:function(){var _this=this;var $modal;$('.dropdown-menu',this.$wrap).off('click.selected').on('click.selected','a',function(e){var $this=$(this);var $btn=$this.parents('.dropdown-wrap').children('button');var value=$this.attr('data-value');var text=$this.text();$btn.attr('data-value',value);$btn.children('span').eq(0).text(text);e.preventDefault();});$modal=$('.modal',this.$wrap);$modal.off('show.bs.modal').on('show.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.recoverForm(_this.options.modalIns.entity.modal);if(!$rightCt.hasClass('rightCtOpen'))$rightCt.click();});$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.reset();if($rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$wrap.off('dragover').on('dragover','.drop-area',function(e){e.preventDefault();});this.$wrap.off('dragenter').on('dragenter','.drop-area',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});this.$wrap.off('dragleave').on('dragleave','.drop-area',function(e){$(e.target).removeClass('on');e.stopPropagation();});this.$wrap.off('drop').on('drop','.drop-area',function(e){var transfer=e.originalEvent.dataTransfer;var itemId=EventAdapter.getData().dsItemId;var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');_this._setField('droparea',$target,itemId);e.stopPropagation();});},setOptions:function(options){this.options=$.extend({},this.options,options);}};return ModalConfig;}(jQuery));﻿var ModalChart=(function(){function ModalChart(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalChart.prototype=new ModalBase();ModalChart.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART',parent:0,mode:['realTime'],maxNum:10,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalChart'};ModalChart.prototype.optionDefault={color:['#2ec7c9','#b6a2de','#5ab1ef','#ffb980','#d87a80','#8d98b3','#e5cf0d','#97b552','#95706d','#dc69aa','#07a2a4','#9a7fd1','#588dd5','#f5994e','#c05050','#59678c','#c9ab00','#7eb00a','#6f5553','#c14089'],title:{textStyle:{fontWeight:'normal',color:'#008acd'}},dataRange:{itemWidth:15,color:['#5ab1ef','#e0ffff']},toolbox:{x:'right',y:'center',feature:{mark:{show:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}},color:['#1e90ff','#1e90ff','#1e90ff','#1e90ff'],effectiveColor:'#ff4500'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{color:'#008acd'},crossStyle:{color:'#008acd'},shadowStyle:{color:'rgba(200,200,200,0.2)'}}},dataZoom:{dataBackgroundColor:'#efefff',fillerColor:'rgba(182,162,222,0.2)',handleColor:'#008acd'},grid:{borderWidth:0,borderColor:'#eee',x:70,y:38,x2:10,y2:24},categoryAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitLine:{lineStyle:{color:['#eee']}}},valueAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']}},splitLine:{lineStyle:{color:['#eee']}}},polar:{axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{lineStyle:{color:'#008acd'},controlStyle:{normal:{color:'#008acd'},emphasis:{color:'#008acd'}},symbol:'emptyCircle',symbolSize:3},bar:{itemStyle:{normal:{barBorderRadius:5},emphasis:{barBorderRadius:5}},barMaxWidth:80},line:{smooth:true,symbol:'none',symbolSize:3},k:{itemStyle:{normal:{color:'#d87a80',color0:'#2ec7c9',lineStyle:{color:'#d87a80',color0:'#2ec7c9'}}}},scatter:{symbol:'circle',symbolSize:4},radar:{symbol:'emptyCircle',symbolSize:3},map:{itemStyle:{normal:{areaStyle:{color:'#ddd'},label:{textStyle:{color:'#d87a80'}}},emphasis:{areaStyle:{color:'#fe994e'}}}},force:{itemStyle:{normal:{linkStyle:{color:'#1e90ff'}}}},chord:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}},emphasis:{borderWidth:1,borderColor:'rgba(128, 128, 128, 0.5)',chordStyle:{lineStyle:{color:'rgba(128, 128, 128, 0.5)'}}}}},gauge:{axisLine:{lineStyle:{color:[[0.2,'#2ec7c9'],[0.8,'#5ab1ef'],[1,'#d87a80']],width:10}},axisTick:{splitNumber:10,length:15,lineStyle:{color:'auto'}},splitLine:{length:22,lineStyle:{color:'auto'}},pointer:{width:5}},textStyle:{fontFamily:'微软雅黑, Arial, Verdana, sans-serif'}};ModalChart.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption(this.options);},ModalChart.prototype.updateModal=function(pointName,pointValue){},ModalChart.prototype.showConfigMode=function(){},ModalChart.prototype.dsChartCog=function(cog,option){if(!cog)return;if(cog[0].upper)option.yAxis[0].max=cog[0].upper;if(cog[0].lower)option.yAxis[0].min=cog[0].lower;if(cog[0].unit)option.yAxis[0].name=cog[0].unit;if(cog[0].markLine){if(!option.series[0].markLine){option.series[0].markLine={};option.series[0].markLine.data=new Array();}
for(var i in cog[0].markLine){var markLine=cog[0].markLine[i];if(!markLine.value)continue;var arr=[{name:markLine.name,xAxis:-1,yAxis:markLine.value},{name:markLine.name,xAxis:option.series[0].data.length,yAxis:markLine.value}];option.series[0].markLine.data.push(arr);}}}
return ModalChart;})();var ModalRealtimePie=(function(){function ModalRealtimePie(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalRealtimePie.prototype=new ModalBase();ModalRealtimePie.prototype.optionTemplate={name:'',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};ModalRealtimePie.prototype.optionDefault={tooltip:{trigger:'item',formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:'vertical',x:'left',y:'center'},toolbox:{show:false,feature:{mark:{show:true},dataView:{show:true,readOnly:false},magicType:{show:true,type:['pie','funnel'],option:{funnel:{x:'25%',width:'50%',funnelAlign:'center',max:1548}}},restore:{show:true},saveAsImage:{show:true}}},calculable:true,color:['rgb(233,77,60)','rgb(105,170,187)','rgb(244,116,38)','rgb(73,152,234)','rgb(241,156,15)','rgb(241,191,0)','rgb(241,209,0)','rgb(230,224,13)','rgb(182,209,78)','rgb(146,192,129)'],series:[{type:'pie',radius:['50%','70%'],center:['60%','50%'],itemStyle:{normal:{label:{show:true,formatter:'{d}%'},labelLine:{show:true}},emphasis:{label:{show:true,position:'center',textStyle:{fontSize:'20',fontWeight:'bold'}}}}}]};ModalRealtimePie.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},this.optionDefault,this.option));},ModalRealtimePie.prototype.updateModal=function(points){},ModalRealtimePie.prototype.showConfigMode=function(){},ModalRealtimePie.prototype.dealWithData=function(points,len){var arr=[];var arrLegend=this.initPointAlias(points);var arrSeries=[];for(var i=0;i<points.length;i++){var seriesData={value:tofixed(points[i].data),name:arrLegend[i]};arrSeries.push(seriesData);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimePie.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePie;})();var ModalRealtimeLine=(function(){function ModalRealtimeLine(screen,entityParams){if(!entityParams)return;ModalChart.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalRealtimeLine.prototype=new ModalChart();ModalRealtimeLine.prototype.optionTemplate={name:'',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};ModalRealtimeLine.prototype.optionDefault={tooltip:{trigger:'axis'},legend:{data:[],orient:'horizontal',x:'center',y:'top'},grid:{x:70,y:38,x2:10,y2:24},toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']}}},calculable:true,color:['#e84c3d','#1abc9c','#B5C334','#FCCE10','#E87C25','#27727B','#FE8463','#9BCA63','#FAD860','#F3A43B','#60C0DD','#D7504B','#C6E579','#F4E001','#F0805A','#26C0C0'],xAxis:[{type:'category',boundaryGap:false,splitLine:{show:false},splitArea:{show:false},axisTick:{show:false}}],yAxis:[{type:'value',scale:true,splitArea:{show:false}}],series:[{type:'line',symbol:'none',smooth:true}],animation:true};ModalRealtimeLine.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},this.optionDefault,this.option));},ModalRealtimeLine.prototype.updateModal=function(points){},ModalRealtimeLine.prototype.showConfigMode=function(){},ModalRealtimeLine.prototype.dealWithData=function(points,dsChartCog){var arr=[],arrLegend=[],arrSeries=[],accuracy;var index,strArrLegend,pointNameReg;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);}
arrLegend=this.initPointAlias(points.list);for(var i=0;i<points.list.length;i++){var key=points.list[i].dsItemId,dataList=[];for(var j in points.list[i].data){dataList.push(points.list[i].data[j].toFixed(accuracy));}
var series={name:arrLegend[i],type:'line',symbol:'none',smooth:true,data:dataList,z:3}
arrSeries.push(series);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimeLine.prototype.dealWithAddData=function(points,len){var arr=[];for(var i=0;i<points.length;i++){var temp=[i,tofixed(points[i].data),false,true];arr.push(temp);}
return arr;},ModalRealtimeLine.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimeLine;})();var modalRealtimeBar=(function(){function modalRealtimeBar(screen,entityParams){if(!entityParams)return;ModalChart.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};modalRealtimeBar.prototype=new ModalChart();modalRealtimeBar.prototype.optionTemplate={parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12};modalRealtimeBar.prototype.optionDefault={tooltip:{trigger:'item'},calculable:true,grid:{x:70,y:38,x2:10,y2:24},xAxis:[{type:'category',show:true,splitLine:{show:false},splitArea:{show:false},axisTick:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};modalRealtimeBar.prototype.renderModal=function(){this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},this.optionDefault,this.option));},modalRealtimeBar.prototype.updateModal=function(points){},modalRealtimeBar.prototype.showConfigMode=function(){},modalRealtimeBar.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return modalRealtimeBar;})();var ModalRealtimeBarEnegBrkd=(function(){function ModalRealtimeBarEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;modalRealtimeBar.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimeBarEnegBrkd.prototype=new modalRealtimeBar();ModalRealtimeBarEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_BAR_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeBarEnegBrkd'};ModalRealtimeBarEnegBrkd.prototype.renderModal=function(){this.isFirstRender=true;},ModalRealtimeBarEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var dsChartCog=this.entity.modal.dsChartCog;var entityItem=dealWithData(points,dsChartCog);var optionDefault={tooltip:{trigger:'item'},toolbox:{show:false},calculable:true,xAxis:[{type:'category',show:true}],yAxis:[{type:'value',show:true}],series:[{type:'bar',itemStyle:{normal:{color:function(params){var colorList=['#C1232B','#B5C334','#FCCE10','#E87C25','#27727B','#FE8463','#9BCA63','#FAD860','#F3A43B','#60C0DD','#D7504B','#C6E579','#F4E001','#F0805A','#26C0C0'];return colorList[params.dataIndex]},label:{show:true,position:'top',formatter:'{c}'}}},barMaxWidth:80}]};if(!this.chart||this.isFirstRender){var entityData={grid:{x:70,y:38,x2:10,y2:24},xAxis:[{data:entityItem[0]}],yAxis:[{}],series:[{data:entityItem[1],markPoint:{data:entityItem[2]}}]};this.dsChartCog(dsChartCog,entityData);this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},optionDefault,entityData));this.isFirstRender=false;}else{this.chart.setSeries([{type:'bar',itemStyle:{normal:{color:function(params){var colorList=['#C1232B','#B5C334','#FCCE10','#E87C25','#27727B','#FE8463','#9BCA63','#FAD860','#F3A43B','#60C0DD','#D7504B','#C6E579','#F4E001','#F0805A','#26C0C0'];return colorList[params.dataIndex]}}},data:entityItem[1],markPoint:{data:entityItem[2]}}])}
function dealWithData(points,dsChartCog){var arr=[],arrXAxis=[],arrData=[],arrMpData=[],accuracy;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);};arrXAxis=_this.initPointAlias(points);for(var i=0,temp;i<points.length;i++){temp=points[i];arrData.push(tofixed(temp.data,accuracy));arrMpData.push({xAxis:i,value:tofixed(temp.data,accuracy),name:arrXAxis[i],symbol:'none'})}
arr.push(arrXAxis);arr.push(arrData);arr.push(arrMpData);return arr;}},ModalRealtimeBarEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimeBarEnegBrkd;})();var ModalRealtimeBarSub=(function(){function ModalRealtimeBarSub(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;modalRealtimeBar.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalRealtimeBarSub.prototype=new modalRealtimeBar();ModalRealtimeBarSub.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_BAR',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeBarSub'};ModalRealtimeBarSub.prototype.renderModal=function(){this.isFirstRender=true;},ModalRealtimeBarSub.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;if(!this.chart||this.isFirstRender){var pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime).format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
var startTime=endTime.split(' ')[0]+' 01:00:00';WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(result){var dataSrc=JSON.parse(result);if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0]},grid:{x:70,y:38,x2:10,y2:24},xAxis:[{data:['01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00','24:00']}],yAxis:[{}],toolbox:{show:false,feature:{dataView:{show:true,readOnly:false},magicType:{show:true,type:['line','bar']}}},series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);var cha=echarts.init(_this.container,AppConfig.chartTheme);cha.clear();_this.chart=cha.setOption($.extend(true,{},_this.optionDefault,entityData));_this.isFirstRender=false;}).error(function(e){}).always(function(e){});}else{if(!this.chart.getSeries())return;var crtHour=new Date().getHours();if(points&&points.length>0&&this.chart.getSeries()[0].data.length<crtHour){this.chart.addData(this.dealWithAddData(points,2));}
if(this.chart.getSeries()[0].data.length>23){this.isFirstRender=true;}}},ModalRealtimeBarSub.prototype.dealWithData=function(points,dsChartCog){var arr=[],arrLegend=[],arrSeries=[],accuracy;var index,strArrLegend,pointNameReg;if(!dsChartCog){accuracy=2;}else{accuracy=parseInt(dsChartCog[0].accuracy);}
arrLegend=this.initPointAlias(points.list);for(var i=0;i<points.list.length;i++){var key=points.list[i].dsItemId,dataList=[];for(var j in points.list[i].data){dataList.push(points.list[i].data[j].toFixed(accuracy));}
var series={name:arrLegend[i],type:'bar',symbol:'none',smooth:true,data:dataList,itemStyle:{normal:{label:{show:false,position:'top',formatter:'{b}\n{c}'},barBorderRadius:[5,5,0,0]}}}
arrSeries.push(series);}
arr.push(arrLegend);arr.push(arrSeries);return arr;},ModalRealtimeBarSub.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeBarSub.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalRealtimeBarSub;})();var ModalRealtimePieEnegBrkd=(function(){function ModalRealtimePieEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimePie.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimePieEnegBrkd.prototype=new ModalRealtimePie();ModalRealtimePieEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_PIE_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimePieEnegBrkd'};ModalRealtimePieEnegBrkd.prototype.renderModal=function(){this.isFirstRender=true;}
ModalRealtimePieEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;if(!this.chart||this.isFirstRender){var entityItem=this.dealWithData(points,4);var entityData={legend:{data:entityItem[0]},series:[{data:entityItem[1]}]};this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},this.optionDefault,entityData));this.isFirstRender=false}else{var seriesData=(function(points,len){var arr=[];var arrName=_this.initPointAlias(points);for(var i=0;i<points.length;i++){arr.push({value:tofixed(points[i].data),name:arrName[i]});}
return arr;})(points,4);this.chart.setSeries([{type:'pie',radius:['50%','70%'],itemStyle:{normal:{label:{show:true,formatter:'{d}%'},labelLine:{show:true}},emphasis:{label:{show:true,formatter:'{d}%',position:'center',textStyle:{fontSize:'20',fontWeight:'bold'}}}},data:seriesData}],true)}},ModalRealtimePieEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePieEnegBrkd;})();var ModalRealtimePieDataRoom=(function(){function ModalRealtimePieDataRoom(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimePie.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalRealtimePieDataRoom.prototype=new ModalRealtimePie();ModalRealtimePieDataRoom.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_PIE_DATAROOM',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimePieDataRoom'};ModalRealtimePieDataRoom.prototype.renderModal=function(){this.isFirstRender=true;}
ModalRealtimePieDataRoom.prototype.updateModal=function(points){if(points.length<1)return;var entityItem=this.dealWithData(points,3);if(!this.chart||this.isFirstRender){var entityData={legend:{data:entityItem[0]},series:[{type:'pie',radius:['50%','70%'],itemStyle:{normal:{label:{show:true,formatter:'{d}%'},labelLine:{show:true}},emphasis:{label:{show:true,position:'center',textStyle:{fontSize:'20',fontWeight:'bold'}}}},data:entityItem[1]}]};this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption($.extend(true,{},this.optionDefault,entityData));this.isFirstRender=false}else{this.chart.setSeries([{type:'pie',radius:['50%','70%'],itemStyle:{normal:{label:{show:true,formatter:'{d}%'},labelLine:{show:true}},emphasis:{label:{show:true,position:'center',textStyle:{fontSize:'20',fontWeight:'bold'}}}},data:entityItem[1]}],true);}},ModalRealtimePieDataRoom.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalRealtimePieDataRoom;})();var ModalRealtimeLineOutdoor=(function(){function ModalRealtimeLineOutdoor(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalRealtimeLineOutdoor.prototype=new ModalRealtimeLine();ModalRealtimeLineOutdoor.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_LINE_OUTDOOR',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeLineOutdoor'},ModalRealtimeLineOutdoor.prototype.renderModal=function(){this.isFirstRender=true;}
ModalRealtimeLineOutdoor.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;if(!this.chart||this.isFirstRender){var pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime).format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
var startTime=endTime.split(' ')[0]+' 01:00:00';WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(result){var dataSrc=JSON.parse(result);if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0]},xAxis:[{data:['01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00','24:00']}],yAxis:[{}],series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);var cha=echarts.init(_this.container,AppConfig.chartTheme);cha.clear();_this.chart=cha.setOption($.extend(true,{},_this.optionDefault,entityData));_this.isFirstRender=false;}).error(function(e){}).always(function(e){});}else{if(!this.chart.getSeries())return;var crtHour=new Date().getHours();if(points&&points.length>0&&this.chart.getSeries()[0].data.length<crtHour){this.chart.addData(this.dealWithAddData(points,2));}
if(this.chart.getSeries()[0].data.length>23){this.isFirstRender=true;}}},ModalRealtimeLineOutdoor.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeLineOutdoor.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalRealtimeLineOutdoor;})();var ModalRealtimeLinePUE=(function(){function ModalRealtimeLinePUE(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalRealtimeLinePUE.prototype=new ModalRealtimeLine();ModalRealtimeLinePUE.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_LINE_PUE',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeLinePUE'};ModalRealtimeLinePUE.prototype.renderModal=function(){this.isFirstRender=true;}
ModalRealtimeLinePUE.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;if(!this.chart||this.isFirstRender){var pointNameList=(function(points){var arr=[];for(var i=0;i<1;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime).format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
var startTime=endTime.split(' ')[0]+' 01:00:00';WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(result){var dataSrc=JSON.parse(result);if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog.accuracy);var entityData={legend:{data:entityItem[0]},xAxis:[{data:['01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00','24:00']}],yAxis:[{}],series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);var cha=echarts.init(_this.container,AppConfig.chartTheme);cha.clear();_this.chart=cha.setOption($.extend(true,{},_this.optionDefault,entityData));_this.isFirstRender=false;}).error(function(e){}).always(function(e){});}else{if(!this.chart.getSeries())return;var crtHour=new Date().getHours();if(points&&points.length>0&&this.chart.getSeries()[0].data.length<crtHour){this.chart.addData(this.dealWithAddData(points,1));}
if(this.chart.getSeries()[0].data.length>23){this.isFirstRender=true;}}},ModalRealtimeLinePUE.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeLinePUE.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();}
return ModalRealtimeLinePUE;})();var ModalRealtimeGauge=(function(){function ModalRealtimeGauge(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.entityOption=entityParams.modal.option;};ModalRealtimeGauge.prototype=new ModalBase();ModalRealtimeGauge.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_GAUGE',parent:0,mode:['gauge'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeGauge'};ModalRealtimeGauge.prototype.optionDefault={tooltip:{formatter:"{c}"},animation:true,animationDuration:1000,animationDurationUpdate:1000,series:[{name:'PUE',type:'gauge',splitNumber:10,axisLine:{show:true,lineStyle:{width:8}},radius:[0,'90%'],axisTick:{show:true,splitNumber:5,length:15,lineStyle:{width:1,type:'solid',color:'auto'}},axisLabel:{textStyle:{color:'auto'},formatter:function(v){return v.toFixed(2);}},splitLine:{show:true,length:20,lineStyle:{color:'auto'}},pointer:{width:5},detail:{formatter:'{value}'}}]};ModalRealtimeGauge.prototype.renderModal=function(){},ModalRealtimeGauge.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;var scaleList=_this.entityOption.scaleList;var colorList=['#1abc9c','#3598db','#e84c3d'];if(scaleList[scaleList.length-1]<scaleList[0]){scaleList.reverse();colorList=['#e84c3d','#3598db','#1abc9c'];}
this.optionDefault.series[0].max=scaleList[scaleList.length-1];this.optionDefault.series[0].min=scaleList[0];this.optionDefault.series[0].data=[{value:parseFloat(points[0].data).toFixed(2)}];this.optionDefault.series[0].axisLine.lineStyle.color=function(option){var arr=[],colorIndex=0;for(var i=0;i<option.length;i++){if(i==0){continue;}
arr.push([((option[i]-option[0])/(_this.optionDefault.series[0].max-_this.optionDefault.series[0].min)).toFixed(3),colorList[colorIndex]]);colorIndex++;}
return arr;}(scaleList);if(this.chart){this.chart.setOption(this.optionDefault)}else{this.chart=echarts.init(this.container,AppConfig.chartTheme).setOption(this.optionDefault);}},ModalRealtimeGauge.prototype.showConfigMode=function(){},ModalRealtimeGauge.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.scaleList=option.scaleList;this.entity.modal.interval=5;};return ModalRealtimeGauge;})();var ModalRealtimeLineEnegBrkd=(function(){function ModalRealtimeLineEnegBrkd(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalRealtimeLineEnegBrkd.prototype=new ModalRealtimeLine();ModalRealtimeLineEnegBrkd.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CHART_LINE_ENERGY',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRealtimeLineEnegBrkd'};ModalRealtimeLineEnegBrkd.prototype.renderModal=function(){this.isFirstRender=true;}
ModalRealtimeLineEnegBrkd.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;if(!this.chart||this.isFirstRender){var pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime).format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
var startTime=endTime.split(' ')[0]+' 01:00:00';WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(result){var dataSrc=JSON.parse(result);if(dataSrc==undefined||dataSrc.length<=0){return;}
var dsChartCog=_this.entity.modal.dsChartCog;var entityItem=_this.dealWithData(dataSrc,dsChartCog);var entityData={legend:{data:entityItem[0]},xAxis:[{data:['01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00','24:00']}],yAxis:[{}],series:entityItem[1]};_this.dsChartCog(dsChartCog,entityData);var cha=echarts.init(_this.container,AppConfig.chartTheme);cha.clear();_this.chart=cha.setOption($.extend(true,{},_this.optionDefault,entityData));_this.isFirstRender=false;}).error(function(e){}).always(function(e){});}else{if(!this.chart.getSeries())return;var crtHour=new Date().getHours();if(points&&points.length>0&&this.chart.getSeries()[0].data.length<crtHour){this.chart.addData(this.dealWithAddData(points,4));}
if(this.chart.getSeries()&&this.chart.getSeries()[0].data.length>23){this.isFirstRender=true;}}},ModalRealtimeLineEnegBrkd.prototype.setModalOption=function(option){this.entity.modal.interval=5;};ModalRealtimeLineEnegBrkd.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();}
return ModalRealtimeLineEnegBrkd;})();function tofixed(str,accuracy){if(!accuracy)accuracy=2;return parseFloat(str).toFixed(accuracy);}
var ModalHistoryChart=(function(){function ModalHistoryChart(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;ModalChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalHistoryChart.prototype=new ModalChart();ModalHistoryChart.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChart'};ModalHistoryChart.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:true},grid:{x:70,y:38,x2:10,y2:24},xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChart.prototype.renderModal=function(){var _this=this;var hourMilSec=3600000;var dayMilSec=86400000;var weekMilSec=604800000+dayMilSec;var startDate=new Date();var endDate=new Date();var timeType;if('hour'==_this.entity.modal.option.timeType){timeType='m5';startDate.setTime(endDate.getTime()-hourMilSec);}
if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(endDate.getTime()-dayMilSec);}
else if('week'==_this.entity.modal.option.timeType){timeType='d1';startDate.setTime(endDate.getTime()-weekMilSec);}
else if('month'==_this.entity.modal.option.timeType){timeType='d1';var year=endDate.getFullYear();var month=endDate.getMonth();if(0==month){startDate.setFullYear(year-1);startDate.setMonth(11);}
else{startDate.setMonth(month-1);}}
else if('year'==_this.entity.modal.option.timeType){timeType='M1';startDate.setFullYear(endDate.getFullYear()-1);}
else{return;}
var curDate,startTime,endTime;if(!_this.m_bIsGoBackTrace){startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=endDate.format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('hour'==_this.entity.modal.option.timeType){startDate.setTime(curDate.getTime()-hourMilSec);}
else if('day'==_this.entity.modal.option.timeType){startDate.setTime(curDate.getTime()-dayMilSec);}
else if('week'==_this.entity.modal.option.timeType){startDate.setTime(curDate.getTime()-weekMilSec);}
else if('month'==_this.entity.modal.option.timeType){var year=curDate.getFullYear();var month=curDate.getMonth();if(0==month){startDate.setFullYear(year-1);startDate.setMonth(11);}
else{startDate.setMonth(month-1);}}
else if('year'==_this.entity.modal.option.timeType){startDate.setFullYear(curDate.getFullYear()-1);}
else{return;}
startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=curDate.format('yyyy-MM-dd HH:mm:ss');}
var optPtName=_this.entity.modal.points;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:optPtName,timeStart:startTime,timeEnd:endTime,timeFormat:timeType}).done(function(result){var dataSrc=JSON.parse(result);if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var option=_this.initOption(dataSrc);if(undefined==option||undefined==option.series[0].data||0==option.series[0].data.length){return;}
var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=Number(option.series[i].data[j].toFixed(n));}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner.stop();});},ModalHistoryChart.prototype.updateModal=function(options){},ModalHistoryChart.prototype.showConfigMode=function(){},ModalHistoryChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;}
return ModalHistoryChart;})();var ModalHistoryChartNormal=(function(){var defaultParams={title:'',option:{showType:'bar',ptName:'E_Sum',timeType:'week'}}
var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];var m_colorLen=m_color.length;function ModalHistoryChartNormal(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.chart=echarts.init(this.container,AppConfig.chartTheme);this.spinner.spin(this.container);};ModalHistoryChartNormal.prototype=new ModalHistoryChart();ModalHistoryChartNormal.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ENERGY_LINE',parent:1,mode:['easyHistorySelect'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartNormal'}
ModalHistoryChartNormal.prototype.initOption=function(dataSrc){if(undefined==dataSrc||undefined==dataSrc.list[0].data){return;}
var xLen=dataSrc.timeShaft.length;var xAxis;var arrXAxis=[];if('month'==this.entity.modal.option.timeType){for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format("MM-dd"));}}
else if('week'==this.entity.modal.option.timeType){for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format("yyyy-MM-dd"));}}
else if('day'==this.entity.modal.option.timeType){for(var i=0;i<xLen;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format("MM-dd HH:00"));}}
xAxis=[{type:'category',data:arrXAxis}]
var dataName=this.initPointAlias(dataSrc.list);var arrSeries=[];var pointAlias,index,strArrLegend,pointNameReg;var i=0;var showColor='#1abd9b';for(var i=0;i<dataSrc.list.length;i++){var key=dataSrc.list[i].dsItemId;if(dataSrc.list.length>1){showColor=m_color[i%m_colorLen];}
arrSeries.push({name:dataName[i],type:this.entity.modal.option.showType,data:dataSrc.list[i].data,markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.MAXIMUM},{type:'min',name:I18n.resource.dashboard.modalHistoryChart.MINIMUM}]},itemStyle:{normal:{barBorderRadius:[5,5,0,0]},emphasis:{barBorderRadius:[5,5,0,0]}}});}
var dataOption={title:{text:'',subtext:''},legend:{data:dataName},dataZoom:{show:false},grid:{x:70,y:38,x2:10,y2:24},xAxis:xAxis,series:arrSeries};return dataOption;};ModalHistoryChartNormal.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType=option.showType;this.entity.modal.option.timeType=option.timeType;};return ModalHistoryChartNormal;})();var ModalHistoryChartEnergyConsume=(function(){var defaultParams={title:'',option:{showType:'bar',ptName:'E_Sum',timeType:'week'}}
var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];var m_colorLen=m_color.length;function ModalHistoryChartEnergyConsume(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalHistoryChart.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);this.chart=echarts.init(this.container,AppConfig.chartTheme);this.spinner.spin(this.container);};ModalHistoryChartEnergyConsume.prototype=new ModalHistoryChart();ModalHistoryChartEnergyConsume.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_ENERGY_BAR',parent:1,mode:['easyHistory'],maxNum:5,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartEnergyConsume'}
ModalHistoryChartEnergyConsume.prototype.initOption=function(dataSrc){if(undefined==dataSrc||undefined==dataSrc.list||undefined==dataSrc.list[0]){return;}
var xLen=dataSrc.timeShaft.length;var xAxis;var arrXAxis=[];var showColor;if('week'==this.entity.modal.option.timeType){for(var i=0;i<xLen-1;i++){var dayNum=dataSrc.timeShaft[i].toDate().getDay();arrXAxis.push(i18n_resource.dataSource.WEEK[dayNum]);}
showColor='#3499da';}
else if('month'==this.entity.modal.option.timeType){for(var i=0;i<xLen-1;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format('MM-dd'));}
showColor=m_color[0];}
else if('year'==this.entity.modal.option.timeType){for(var i=0;i<xLen-1;i++){var monthNum=dataSrc.timeShaft[i].toDate().getMonth();arrXAxis.push(i18n_resource.dataSource.MONTH[monthNum]);}
showColor='#3e72ac';}
else if('day'==this.entity.modal.option.timeType){for(var i=0;i<xLen-1;i++){arrXAxis.push(dataSrc.timeShaft[i].toDate().format('MM-dd HH:00'));}
showColor='#3e72ac';}
xAxis=[{type:'category',data:arrXAxis}]
var dataName=this.initPointAlias(dataSrc.list);var arrSeries=[];var i=0;for(var i=0;i<dataSrc.list.length;i++){var key=dataSrc.list[i].dsItemId;if(dataSrc.list.length>1){showColor=m_color[i%m_colorLen];}
var arrData=[];var hisLen=dataSrc.list[0].data.length;var defVal;var fixNum=0;for(var j=1;j<hisLen;j++){var preVal=dataSrc.list[0].data[j-1];if(0==preVal){arrData.push(0);continue;}
defVal=dataSrc.list[0].data[j]-preVal;if(defVal<100){fixNum=2;}
else{fixNum=0;}
arrData.push(parseFloat(defVal.toFixed(fixNum)));}
arrSeries.push({name:dataName[i],type:this.entity.modal.option.showType,data:arrData,markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.MAXIMUM},{type:'min',name:I18n.resource.dashboard.modalHistoryChart.MINIMUM}]},itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,5,5]},emphasis:{color:showColor,barBorderRadius:[5,5,5,5]}}});i++;}
var dataOption={title:{text:'',subtext:''},legend:{show:false,data:dataName},dataZoom:{show:false},grid:{x:70,y:38,x2:10,y2:24},xAxis:xAxis,series:arrSeries};return dataOption;};ModalHistoryChartEnergyConsume.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='bar';this.entity.modal.option.timeType=option.timeType;};return ModalHistoryChartEnergyConsume;})();var ModalHistoryChartYearOnYearLine=(function(){var defaultParams={title:'',option:{ptName:'E_Sum',timeType:'week'}}
var _this;function ModalHistoryChartYearOnYearLine(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigModal=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigModal);this.option=entityParams.option;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.spinner.spin(this.container);this.store={};this.pointAlias=this.entity.modal.point?AppConfig.datasource.getDSItemById(this.entity.modal.points[0]).alias:'';this.m_bIsGoBackTrace=false;this.m_traceData=undefined;_this=this;};ModalHistoryChartYearOnYearLine.prototype=new ModalBase();ModalHistoryChartYearOnYearLine.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_YEAR_LINE',parent:1,mode:['easyCompare'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartYearOnYearLine'};ModalHistoryChartYearOnYearLine.prototype.optionDefault={tooltip:{trigger:'axis',formatter:function(params){var tar0=params[0];var tar1=params[1];var pointAlias=_this.pointAlias;return pointAlias+' : '+tar0.name+'<br/>'+tar0.seriesName+' : '+tar0.value+'<br/>'
+tar1.seriesName+' : '+tar1.value;}},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:false},grid:{x:70,y:38,x2:10,y2:24},xAxis:[{type:'time',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChartYearOnYearLine.prototype.renderModal=function(){var _this=this;var hourMilSec=3600000;var dayMilSec=86400000;var weekMilSec=604800000;var startDate=new Date();var endDate=new Date();var tmFlag=new Date();var timeType;if('hour'==_this.entity.modal.option.timeType){timeType='m5';startDate.setTime(endDate.getTime()-hourMilSec);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(endDate.getTime());tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(endDate.getTime()-dayMilSec);startDate.setHours(0);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(endDate.getTime());tmFlag.setHours(0);tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else{return;}
var curDate,startTime,endTime;if(!_this.m_bIsGoBackTrace){startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=endDate.format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('hour'==_this.entity.modal.option.timeType){timeType='m5';startDate.setTime(curDate.getTime()-hourMilSec);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(curDate.getTime());tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(curDate.getTime()-dayMilSec);startDate.setHours(0);startDate.setMinutes(0);startDate.setSeconds(0);tmFlag.setTime(curDate.getTime());tmFlag.setHours(0);tmFlag.setMinutes(0);tmFlag.setSeconds(0);tmFlag.setMilliseconds(0);}
else{return;}
startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=curDate.format('yyyy-MM-dd HH:mm:ss');}
var optPtName=_this.entity.modal.points;WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:optPtName,timeStart:startTime,timeEnd:endTime,timeFormat:timeType}).done(function(result){var dataSrc=JSON.parse(result);if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var arrXAxis=[];var flagCount=0;var len=dataSrc.timeShaft.length;tmFlag=tmFlag.format('yyyy-MM-dd HH:mm:ss');for(flagCount=0;flagCount<len;flagCount++){if(dataSrc.timeShaft[flagCount]>=tmFlag){break;}}
_this.store.timeShaft=dataSrc.timeShaft.slice(0,flagCount);_this.store.deadline=dataSrc.timeShaft[flagCount-1].toDate().valueOf();var fixNum=0;var setVal;var dataName=[];var arrSeries=[];for(var k=0,lenK=Math.min(flagCount,dataSrc.timeShaft.length);k<lenK;k++){arrXAxis.push(dataSrc.timeShaft[k].toDate().format("HH:mm"));}
var currentCount=0;for(var n=0;n<dataSrc.list.length;n++){var key=dataSrc.list[n].dsItemId;var dataSrc1=[];var dataSrc2=[];var eachName=[];if(1==dataSrc.list.length){dataName.push(I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(I18n.resource.dataSource.TIME_TODAY);eachName.push(I18n.resource.dataSource.TIME_YESTERDAY);eachName.push(I18n.resource.dataSource.TIME_TODAY);}
else{dataName.push(key+'_'+I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(key+'_'+I18n.resource.dataSource.TIME_TODAY);eachName.push(key+'_'+I18n.resource.dataSource.TIME_YESTERDAY);eachName.push(key+'_'+I18n.resource.dataSource.TIME_TODAY);}
for(var j=0,len=dataSrc.list[n].data.length;j<len;j++){setVal=dataSrc.list[n].data[j];if(setVal<100){fixNum=2;}
else{fixNum=0;}
setVal=parseFloat(setVal.toFixed(fixNum));if(j<flagCount){dataSrc1.push(setVal);}
else{dataSrc2.push(setVal);}}
var showColor;var showData;var showMark;for(var i=0;i<2;i++){if(0==i){if(0==currentCount){showColor='#1abd9b';}
else{showColor=echarts.config.color[currentCount*2];}
showData=dataSrc1;showMark={data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.MAXIMUM},{type:'min',name:I18n.resource.dashboard.modalHistoryChart.MINIMUM}]}}
else if(1==i){if(0==currentCount){showColor='#e74a37';}
else{showColor=echarts.config.color[currentCount*2+1];}
showData=dataSrc2;var lastCntX=dataSrc2.length-1;var lastCntY=Number(dataSrc2[lastCntX]);showMark={symbol:'emptyCircle',symbolSize:10,effect:{show:true,shadowBlur:0},itemStyle:{normal:{label:{show:false}},emphasis:{label:{position:'top'}}},data:[{name:'',value:lastCntY,xAxis:lastCntX,yAxis:lastCntY}]}}
arrSeries.push({name:eachName[i],type:'line',data:showData,markPoint:showMark,itemStyle:{normal:{color:showColor,barBorderRadius:[5,5,0,0]},emphasis:{color:showColor,barBorderRadius:[5,5,0,0]}},symbolSize:3});showColor='';}
currentCount++;}
var xAxis=[{type:'category',boundaryGap:false,data:arrXAxis}]
var option={title:{text:'',subtext:''},dataZoom:{show:false},legend:{data:dataName},xAxis:xAxis,series:arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=option.series[i].data[j].toFixed(n);}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner.stop();});},ModalHistoryChartYearOnYearLine.prototype.updateModal=function(options){var _this=this;var modalOptions=this.entity.modal.option;var lastIndex,lastTick,nowTick;if(undefined===options||options.length<1||undefined===options[0]){return;}
lastIndex=this.chart.getSeries()[1].data.length-1;lastTick=this.store.timeShaft[lastIndex].toDate().valueOf();nowTick=new Date().valueOf();if(lastTick===undefined)return;if('hour'===modalOptions.timeType){lastTick+=3600000;refreshInterval=300000;}
if('day'===modalOptions.timeType){lastTick+=86400000;refreshInterval=3600000;}
else{return;}
if(nowTick<lastTick+refreshInterval)return;var addParam=[];for(var i=0,len=options.length;i<len;i++){if(options[i].data!==null){addParam.push([1,options[i].data,false,true]);}}
_this.chart.addData(addParam);_this.chart.delMarkPoint(1,'');var dataSeries=_this.chart.getOption().series;if(dataSeries.length<2){return;}
var temp=dataSeries[1].data;var lastCntX=temp.length-1;var lastCntY=Number(temp[lastCntX]);var showMark={symbol:'emptyCircle',symbolSize:10,effect:{show:true,shadowBlur:0},itemStyle:{normal:{label:{show:false}},emphasis:{label:{position:'top'}}},data:[{name:'',value:lastCntY,xAxis:lastCntX,yAxis:lastCntY}]}
_this.chart.addMarkPoint(1,showMark);},ModalHistoryChartYearOnYearLine.prototype.showConfigMode=function(){},ModalHistoryChartYearOnYearLine.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='line';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChartYearOnYearLine.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;};return ModalHistoryChartYearOnYearLine;})();var ModalHistoryChartYearOnYearBar=(function(){var defaultParams={title:'',option:{ptName:'E_Sum',timeType:'day'}}
var m_color=['#e74a37','#ff8050','#1abd9b','#3499da','#3e72ac'];function ModalHistoryChartYearOnYearBar(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigModal=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigModal);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;this.option=entityParams.option;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.spinner.spin(this.container);};ModalHistoryChartYearOnYearBar.prototype=new ModalBase();ModalHistoryChartYearOnYearBar.prototype.optionTemplate={name:'toolBox.modal.HIS_CHART_YEAR_BAR',parent:1,mode:['easyCompare'],maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHistoryChartYearOnYearBar'};ModalHistoryChartYearOnYearBar.prototype.optionDefault={tooltip:{trigger:'axis'},toolbox:{show:false,feature:{dataView:{show:false,readOnly:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}}},calculable:false,dataZoom:{show:false},grid:{x:70,y:38,x2:10,y2:24},xAxis:[{type:'category',splitLine:{show:false}}],yAxis:[{type:'value',splitArea:{show:false}}],animation:true};ModalHistoryChartYearOnYearBar.prototype.renderModal=function(){var _this=this;var hourMilSec=3600000;var dayMilSec=86400000;var weekMilSec=604800000;var startDate=new Date();var endDate=new Date();var startDateZero=new Date();var endDateZero=new Date();var timeType;if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(endDate.getTime()-dayMilSec);startDateZero.setTime(startDate.getTime());startDateZero.setHours(0);startDateZero.setMinutes(0);startDateZero.setSeconds(0);endDateZero.setTime(endDate.getTime());endDateZero.setHours(0);endDateZero.setMinutes(0);endDateZero.setSeconds(0);}
else{return;}
var optPtName=_this.entity.modal.points;if(optPtName.length>1){return;}
var curDate,startTime,endTime;if(!_this.m_bIsGoBackTrace){startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=endDate.format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{curDate=_this.m_traceData.currentTime;_this.optionDefault.animation=false;if('day'==_this.entity.modal.option.timeType){timeType='h1';startDate.setTime(curDate.getTime()-dayMilSec);startDateZero.setTime(startDate.getTime());startDateZero.setHours(0);startDateZero.setMinutes(0);startDateZero.setSeconds(0);endDateZero.setTime(curDate.getTime());endDateZero.setHours(0);endDateZero.setMinutes(0);endDateZero.setSeconds(0);}
else{return;}
startTime=startDate.format('yyyy-MM-dd HH:mm:ss');endTime=curDate.format('yyyy-MM-dd HH:mm:ss');}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:optPtName,timeStart:startDateZero.format('yyyy-MM-dd HH:mm:ss'),timeEnd:endDate.format('yyyy-MM-dd HH:mm:ss'),timeFormat:timeType}).done(function(result){var dataSrc=JSON.parse(result);if(!dataSrc||!dataSrc.list[0].data||!dataSrc.timeShaft||dataSrc.timeShaft.length<=0){return;}
var flag1,flag2;var len=dataSrc.timeShaft.length;for(var i=0;i<len;i++){if(dataSrc.timeShaft[i].toDate()>=startDate){flag1=i;break;}}
for(var i=0;i<len;i++){if(dataSrc.timeShaft[i].toDate()>=endDateZero){flag2=i;break;}}
var arrVal1=[];var arrVal2=[];var val1=0;var val2=0;var fixNum1=0;var fixNum2=0;var preVal=0;for(var i=0;i<dataSrc.list.length;i++){var key=dataSrc.list[i].dsItemId;for(var j=0,len=dataSrc.list[i].data.length;j<len;j++){if(j==flag1){preVal=dataSrc.list[i].data[0];if(0==preVal){val1=0;}
else{val1=dataSrc.list[i].data[j]-preVal;}}
else if(j==flag2){preVal=dataSrc.list[i].data[j];if(0==preVal){val2=0;}
else{val2=dataSrc.list[i].data[len-1]-preVal;}}}
if(val1<100){fixNum1=2;}
else{fixNum1=0;}
if(val2<100){fixNum2=2;}
else{fixNum2=0;}
arrVal1.push(parseFloat(val1.toFixed(fixNum1)));arrVal2.push(parseFloat(val2.toFixed(fixNum2)));break;}
var tmFlag=new Date();var arrXAxis=[];tmFlag=tmFlag.format('yyyy-MM-dd HH:mm:ss');for(flagCount=0;flagCount<len;flagCount++){if(dataSrc.timeShaft[flagCount]>=tmFlag){break;}}
for(var k=0,lenK=Math.min(flagCount,dataSrc.timeShaft.length);k<lenK;k++){arrXAxis.push(dataSrc.timeShaft[k].toDate().format("HH:mm"));}
var xAxis=[{type:'category',boundaryGap:true,data:arrXAxis}];var dataName=[];dataName.push(I18n.resource.dataSource.TIME_YESTERDAY);dataName.push(I18n.resource.dataSource.TIME_TODAY);var arrSeries=[{name:dataName[0],type:'bar',data:arrVal1,itemStyle:{normal:{color:m_color[2],barBorderRadius:[5,5,0,0]},emphasis:{color:m_color[2],barBorderRadius:[5,5,0,0]}},markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.EnergyConsumption}]}},{name:dataName[1],type:'bar',data:arrVal2,itemStyle:{normal:{color:m_color[1],barBorderRadius:[5,5,0,0]},emphasis:{color:m_color[1],barBorderRadius:[5,5,0,0]}},markPoint:{data:[{type:'max',name:I18n.resource.dashboard.modalHistoryChart.EnergyConsumption}]}},];var option={title:{text:'',subtext:''},dataZoom:{show:false},legend:{data:dataName},xAxis:xAxis,series:arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){if(_this.entity.modal.dsChartCog[0].upper!=''){optionTemp.yAxis[0].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){optionTemp.yAxis[0].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){optionTemp.yAxis[0].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<option.series.length;i++){for(var j=0;j<option.series[i].data.length;j++){option.series[i].data[j]=option.series[i].data[j].toFixed(n);}}}
var tempMarkLine;for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[0].markLine[k].value!=''){if(!option.series[0].markLine){option.series[0].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[0].markLine[k].name,value:_this.entity.modal.dsChartCog[0].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[0].markLine[k].value)}];option.series[0].markLine.data.push(tempMarkLine);}}}
_this.chart.clear();_this.chart.setOption($.extend(true,{},optionTemp,option));}).error(function(e){}).always(function(e){_this.spinner.stop();});},ModalHistoryChartYearOnYearBar.prototype.updateModal=function(options){},ModalHistoryChartYearOnYearBar.prototype.showConfigMode=function(){},ModalHistoryChartYearOnYearBar.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.showType='bar';this.entity.modal.option.timeType=option.timeType;};ModalHistoryChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;};return ModalHistoryChartYearOnYearBar;})();﻿
var ModalCarbonFootprint=(function(){function ModalCarbonFootprint(containerId,entityParams){ModalBase.call(this,containerId,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.isFirstTime=true;this.widthRuler=undefined;this.$elMask=undefined;this.elPaneValue=undefined;this.elPaneTitle=undefined;this.maxValue=undefined;};ModalCarbonFootprint.prototype=new ModalBase();ModalCarbonFootprint.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CARBON_FOOTPRINT',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:3,minWidth:4,maxHeight:6,maxWidth:12,type:'ModalCarbonFootprint'};ModalCarbonFootprint.prototype.renderModal=function(){if(this.isFirstTime)this.init();},ModalCarbonFootprint.prototype.init=function(){var _this=this;WebAPI.get('/static/scripts/spring/entities/modalCarbonFootprint.html').done(function(resultHTML){_this.container.innerHTML=resultHTML;_this.initStandard();_this.isFirstTime=false;I18n.fillArea($('.divCFTitle').parent());});},ModalCarbonFootprint.prototype.initStandard=function(){$divMain=$(this.container);this.widthRuler=$divMain.find('.cfProcessScale').width();this.$elMask=$divMain.find('.cfProcessMask');this.elPaneValue=document.getElementById('cfFootprintDashboardCurrent');this.elPaneTitle=document.getElementById('divCFTitle');var unitValue=this.entity.modal.option.valueStandard/4;this.maxValue=unitValue*5;var tdScaleNums=this.container.getElementsByClassName('cfProcessScaleNum');for(var i=0,len=tdScaleNums.length;i<len;i++){tdScaleNums[i].textContent=parseInt(unitValue*i).toString();}
$divMain.find('.cfLegendBarWarning').animate({width:this.widthRuler*0.2+'px'},1000);document.getElementById('cfFootprintDashboardStandard').textContent=this.entity.modal.option.valueStandard;},ModalCarbonFootprint.prototype.updateModal=function(points){var value=parseFloat(points[0].data).toFixed(1).toString();this.elPaneValue.textContent=value;this.elPaneTitle.textContent=value;this.$elMask.animate({width:this.widthRuler-value*this.widthRuler/this.maxValue+'px'},1000);},ModalCarbonFootprint.prototype.showConfigMode=function(){};ModalCarbonFootprint.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.option.valueStandard=3500;};return ModalCarbonFootprint;})();var ModalWeather=(function(){function ModalWeather(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalBase.call(this,screen,entityParams,renderModal,updateModal,showConfigMode);};ModalWeather.prototype=new ModalBase();ModalWeather.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_WEATHER',parent:0,mode:['weather'],maxNum:0,title:'',minHeight:2,minWidth:4,maxHeight:6,maxWidth:12,type:'ModalWeather'};var yin='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <path fill="#009FE3" d="M75.291,34.467C70.5,26.344,61.767,21.32,52.311,21.32c-12.728,0-23.524,8.832-26.105,21.158  c-6.569,2.188-11.324,8.382-11.324,15.676c0,9.111,7.414,16.525,16.526,16.525c3.289,0,6.415-0.945,9.119-2.745  c3.647,1.8,7.688,2.745,11.785,2.745c4.251,0,8.451-1.029,12.205-2.966c3.149,1.939,6.733,2.966,10.492,2.966  c11.089,0,20.11-9.021,20.11-20.109C95.118,43.577,86.249,34.621,75.291,34.467z M75.007,69.104c-3.247,0-6.315-1.046-8.877-3.023  c-1.219-0.941-2.969-0.716-3.91,0.503c-0.018,0.021-0.027,0.047-0.045,0.07c-3.019,1.6-6.42,2.45-9.865,2.45  c-3.653,0-7.255-0.947-10.41-2.74c-0.795-0.451-1.713-0.461-2.488-0.123c-0.447,0.072-0.883,0.245-1.263,0.542  c-1.94,1.519-4.271,2.32-6.744,2.32c-6.038,0-10.95-4.911-10.95-10.949s4.912-10.951,10.95-10.951c3.048,0,5.979,1.285,8.048,3.521  c1.044,1.132,2.809,1.201,3.938,0.157c1.131-1.045,1.202-2.809,0.157-3.938c-2.941-3.187-7.042-5.088-11.354-5.296  C34.91,32.951,42.94,26.893,52.31,26.893c6.688,0,12.931,3.178,16.885,8.443c-2.639,0.797-5.108,2.118-7.232,3.93  c-1.171,0.999-1.311,2.761-0.313,3.932c1,1.172,2.762,1.31,3.932,0.31c2.624-2.239,5.973-3.472,9.428-3.472  c8.014,0,14.535,6.52,14.535,14.534C89.542,62.584,83.021,69.104,75.007,69.104z"/>\
                </svg>';var dayu='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path fill="#009FE3" d="M75.293,23.69c-4.791-8.123-13.525-13.147-22.981-13.147c-12.726,0-23.525,8.832-26.107,21.159   c-6.568,2.188-11.323,8.381-11.323,15.675c0,9.112,7.414,16.526,16.525,16.526c3.289,0,6.415-0.945,9.119-2.744   c3.648,1.797,7.689,2.744,11.786,2.744c4.25,0,8.452-1.029,12.206-2.966c3.149,1.938,6.732,2.966,10.492,2.966   c11.088,0,20.108-9.021,20.108-20.11C95.118,32.798,86.251,23.841,75.293,23.69z M75.01,58.326c-3.246,0-6.315-1.045-8.877-3.023   c-1.22-0.941-2.971-0.717-3.91,0.503c-0.019,0.021-0.027,0.047-0.043,0.069c-3.021,1.601-6.422,2.451-9.867,2.451   c-3.656,0-7.256-0.947-10.411-2.74c-0.794-0.453-1.713-0.461-2.491-0.123c-0.444,0.074-0.879,0.244-1.26,0.543   c-1.938,1.52-4.271,2.32-6.743,2.32c-6.038,0-10.951-4.912-10.951-10.95c0-6.038,4.913-10.951,10.951-10.951   c3.045,0,5.979,1.285,8.047,3.523c1.047,1.131,2.81,1.202,3.939,0.156c1.131-1.045,1.201-2.81,0.156-3.938   c-2.942-3.185-7.043-5.086-11.354-5.294c2.718-8.697,10.748-14.755,20.117-14.755c6.69,0,12.929,3.177,16.885,8.443   c-2.64,0.797-5.109,2.118-7.233,3.93c-1.17,0.999-1.311,2.76-0.312,3.931c0.999,1.172,2.759,1.311,3.931,0.311   c2.624-2.239,5.973-3.472,9.43-3.472c8.014,0,14.533,6.52,14.533,14.534C89.544,51.806,83.023,58.326,75.01,58.326z"/>\
                    <path fill="#009FE3" d="M44.751,79.875c0,3.084-2.5,5.582-5.583,5.582s-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S44.751,76.791,44.751,79.875z"/>\
                    <path fill="#009FE3" d="M59.557,79.875c0,3.084-2.5,5.582-5.582,5.582c-3.084,0-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S59.557,76.791,59.557,79.875z"/>\
                    <path fill="#009FE3" d="M74.362,79.875c0,3.084-2.499,5.582-5.583,5.582c-3.083,0-5.583-2.498-5.583-5.582   s5.583-11.408,5.583-11.408S74.362,76.791,74.362,79.875z"/>\
                </g>\
                </svg>';var baoyu='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path fill="#009FE3" d="M75.292,23.756c-4.791-8.123-13.524-13.146-22.98-13.146c-12.729,0-23.527,8.832-26.107,21.159   c-6.569,2.187-11.324,8.381-11.324,15.675c0,9.112,7.414,16.526,16.526,16.526c3.29,0,6.416-0.946,9.118-2.745   c3.648,1.799,7.69,2.745,11.787,2.745c4.25,0,8.452-1.03,12.206-2.967c3.148,1.939,6.731,2.967,10.492,2.967   c11.088,0,20.109-9.021,20.109-20.11C95.119,32.865,86.25,23.909,75.292,23.756z M75.008,58.394c-3.246,0-6.316-1.046-8.878-3.024   c-1.219-0.94-2.969-0.716-3.909,0.503c-0.019,0.021-0.027,0.047-0.045,0.07c-3.02,1.6-6.421,2.451-9.865,2.451   c-3.655,0-7.256-0.948-10.412-2.741c-0.795-0.451-1.713-0.461-2.49-0.122c-0.445,0.074-0.881,0.244-1.261,0.542   c-1.94,1.519-4.271,2.321-6.743,2.321c-6.038,0-10.951-4.912-10.951-10.95s4.913-10.951,10.951-10.951   c3.046,0,5.979,1.285,8.047,3.522c1.044,1.132,2.808,1.2,3.938,0.156c1.132-1.045,1.202-2.809,0.157-3.938   c-2.94-3.187-7.042-5.087-11.354-5.295c2.717-8.697,10.748-14.755,20.118-14.755c6.688,0,12.928,3.177,16.884,8.442   c-2.641,0.797-5.11,2.118-7.234,3.931c-1.171,0.999-1.31,2.76-0.313,3.931c1,1.172,2.762,1.31,3.932,0.31   c2.623-2.238,5.973-3.472,9.428-3.472c8.016,0,14.535,6.521,14.535,14.534C89.543,51.872,83.021,58.394,75.008,58.394z"/>\
                    <path fill="#009FE3" d="M30.448,85.391c-0.531,0-1.067-0.149-1.543-0.47c-1.281-0.854-1.628-2.584-0.773-3.864l9.026-13.539   c0.854-1.28,2.584-1.629,3.865-0.772c1.281,0.854,1.627,2.584,0.773,3.865L32.77,84.151C32.232,84.955,31.348,85.391,30.448,85.391   z"/>\
                    <path fill="#009FE3" d="M45.313,85.391c-0.53,0-1.067-0.149-1.543-0.47c-1.281-0.854-1.627-2.584-0.772-3.864l9.026-13.539   c0.854-1.28,2.585-1.629,3.865-0.772c1.281,0.854,1.627,2.584,0.773,3.865l-9.026,13.541   C47.099,84.955,46.214,85.391,45.313,85.391z"/>\
                    <path fill="#009FE3" d="M60.182,85.391c-0.53,0-1.067-0.149-1.543-0.47c-1.283-0.854-1.627-2.584-0.772-3.864l9.024-13.539   c0.854-1.28,2.586-1.629,3.867-0.772c1.279,0.854,1.627,2.584,0.772,3.865l-9.027,13.541   C61.967,84.955,61.083,85.391,60.182,85.391z"/>\
                </g>\
                </svg>';var duoyun='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <g>\
                            <path fill="#009FE3" d="M59.271,34.332c-4.592-8.123-12.961-13.146-22.021-13.146c-12.197,0-22.546,8.832-25.019,21.159    C5.936,44.531,1.379,50.726,1.379,58.02c0,9.111,7.104,16.525,15.836,16.525c3.152,0,6.148-0.945,8.739-2.745    c3.495,1.8,7.368,2.745,11.295,2.745c4.074,0,8.098-1.029,11.696-2.966c3.017,1.939,6.451,2.966,10.053,2.966    c10.627,0,19.271-9.021,19.271-20.109C78.271,43.441,69.772,34.485,59.271,34.332z M58.998,68.97    c-3.109,0-6.051-1.047-8.506-3.024c-1.168-0.94-2.845-0.715-3.747,0.503c-0.017,0.021-0.025,0.047-0.042,0.07    c-2.893,1.601-6.153,2.452-9.453,2.452c-3.504,0-6.953-0.948-9.977-2.741c-0.759-0.45-1.639-0.46-2.384-0.123    c-0.428,0.074-0.846,0.244-1.211,0.542c-1.86,1.519-4.096,2.321-6.463,2.321c-5.787,0-10.494-4.912-10.494-10.95    s4.707-10.951,10.494-10.951c2.92,0,5.729,1.285,7.711,3.521c1.003,1.134,2.692,1.202,3.775,0.157    c1.084-1.045,1.15-2.809,0.147-3.938c-2.817-3.187-6.749-5.087-10.88-5.295c2.604-8.697,10.3-14.755,19.277-14.755    c6.411,0,12.39,3.177,16.181,8.442c-2.528,0.797-4.897,2.118-6.934,3.93c-1.121,0.999-1.254,2.761-0.296,3.932    c0.959,1.171,2.645,1.31,3.767,0.31c2.514-2.238,5.722-3.472,9.033-3.472c7.682,0,13.93,6.52,13.93,14.534    C72.928,62.448,66.68,68.97,58.998,68.97z"/>\
                            <g>\
                                <path fill="#009FE3" d="M93.438,42.01c-3.744-6.411-10.431-10.365-17.66-10.365c-3.071,0-6.082,0.715-8.819,2.063     c1.803,1.117,3.451,2.482,4.896,4.05c1.271-0.351,2.588-0.537,3.923-0.537c4.587,0,8.882,2.146,11.767,5.744     c-1.765,0.665-3.414,1.654-4.861,2.941c-1.121,1-1.254,2.759-0.297,3.931c0.957,1.17,2.644,1.312,3.767,0.313     c1.874-1.67,4.269-2.59,6.735-2.59c5.729,0,10.388,4.861,10.388,10.839c0,5.977-4.659,10.84-10.388,10.84     c-2.319,0-4.514-0.78-6.344-2.256c-1.148-0.927-2.791-0.718-3.701,0.452c-2.168,1.176-4.6,1.804-7.064,1.804     c-0.736,0-1.473-0.063-2.195-0.17c-1.275,1.733-2.77,3.286-4.441,4.603c2.129,0.752,4.373,1.145,6.638,1.145     c3.188,0,6.343-0.781,9.181-2.25c2.396,1.469,5.099,2.25,7.93,2.25c8.675,0,15.73-7.365,15.73-16.416     C108.619,49.538,101.856,42.316,93.438,42.01z"/>\
                            </g>\
                        </g>\
                        <path fill="#009FE3" d="M59.271,34.332c-4.592-8.123-12.961-13.146-22.021-13.146c-12.197,0-22.546,8.832-25.019,21.159   C5.936,44.531,1.379,50.726,1.379,58.02c0,9.111,7.104,16.525,15.836,16.525c3.152,0,6.148-0.945,8.739-2.745   c3.495,1.8,7.368,2.745,11.295,2.745c4.074,0,8.098-1.029,11.696-2.966c3.017,1.939,6.451,2.966,10.053,2.966   c10.627,0,19.271-9.021,19.271-20.109C78.271,43.441,69.772,34.485,59.271,34.332z M58.998,68.97c-3.109,0-6.051-1.047-8.506-3.024   c-1.168-0.94-2.845-0.715-3.747,0.503c-0.017,0.021-0.025,0.047-0.042,0.07c-2.893,1.601-6.153,2.452-9.453,2.452   c-3.504,0-6.953-0.948-9.977-2.741c-0.759-0.45-1.639-0.46-2.384-0.123c-0.428,0.074-0.846,0.244-1.211,0.542   c-1.86,1.519-4.096,2.321-6.463,2.321c-5.787,0-10.494-4.912-10.494-10.95s4.707-10.951,10.494-10.951   c2.92,0,5.729,1.285,7.711,3.521c1.003,1.134,2.692,1.202,3.775,0.157c1.084-1.045,1.15-2.809,0.147-3.938   c-2.817-3.187-6.749-5.087-10.88-5.295c2.604-8.697,10.3-14.755,19.277-14.755c6.411,0,12.39,3.177,16.181,8.442   c-2.528,0.797-4.897,2.118-6.934,3.93c-1.121,0.999-1.254,2.761-0.296,3.932c0.959,1.171,2.645,1.31,3.767,0.31   c2.514-2.238,5.722-3.472,9.033-3.472c7.682,0,13.93,6.52,13.93,14.534C72.928,62.448,66.68,68.97,58.998,68.97z"/>\
                    </g>\
                    </svg>';var xiaoyu='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path fill="#009FE3" d="M75.293,23.69c-4.791-8.123-13.523-13.147-22.98-13.147c-12.727,0-23.526,8.831-26.107,21.159   c-6.567,2.188-11.323,8.382-11.323,15.675c0,9.112,7.414,16.526,16.525,16.526c3.289,0,6.415-0.945,9.119-2.744   c3.647,1.799,7.688,2.744,11.786,2.744c4.25,0,8.451-1.029,12.205-2.966c3.147,1.938,6.731,2.966,10.492,2.966   c11.09,0,20.108-9.021,20.108-20.11C95.118,32.798,86.25,23.842,75.293,23.69z M75.009,58.326c-3.246,0-6.316-1.047-8.877-3.023   c-1.22-0.941-2.971-0.717-3.91,0.501c-0.02,0.021-0.027,0.048-0.045,0.069c-2.15,1.142-4.495,1.896-6.912,2.238l-6.184-0.043   c-2.521-0.39-4.963-1.224-7.183-2.482c-0.795-0.453-1.716-0.463-2.493-0.121c-0.443,0.074-0.877,0.244-1.256,0.539   c-1.942,1.52-4.274,2.322-6.745,2.322c-6.038,0-10.951-4.912-10.951-10.951c0-6.038,4.913-10.951,10.951-10.951   c3.046,0,5.979,1.285,8.048,3.523c1.044,1.13,2.811,1.2,3.939,0.156c1.129-1.044,1.2-2.81,0.155-3.938   c-2.941-3.185-7.043-5.086-11.354-5.294c2.716-8.697,10.747-14.755,20.116-14.755c6.689,0,12.929,3.177,16.885,8.443   c-2.639,0.797-5.107,2.118-7.232,3.93c-1.173,1-1.313,2.76-0.313,3.931c0.997,1.17,2.758,1.312,3.93,0.313   c2.625-2.24,5.975-3.473,9.431-3.473c8.015,0,14.534,6.519,14.534,14.534C89.544,51.808,83.024,58.326,75.009,58.326z"/>\
                    <path fill="#009FE3" d="M59.558,79.875c0,3.084-2.5,5.582-5.583,5.582s-5.583-2.498-5.583-5.582s5.583-11.408,5.583-11.408   S59.558,76.791,59.558,79.875z"/>\
                </g>\
                </svg>';var qing_duoyun='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <g>\
                        <g>\
                            <path fill="#009FE3" d="M90.923,16.534c1.333,0.771,1.79,2.479,1.021,3.811l-3.938,6.816c-0.77,1.334-2.475,1.791-3.809,1.021     c-1.332-0.771-1.79-2.477-1.02-3.811l3.938-6.814C87.885,16.225,89.588,15.768,90.923,16.534z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M103.951,29.564c0.771,1.334,0.313,3.039-1.021,3.809l-6.818,3.938c-1.332,0.771-3.039,0.313-3.809-1.02     c-0.77-1.336-0.314-3.039,1.02-3.811l6.818-3.938C101.477,27.773,103.18,28.232,103.951,29.564z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M108.721,47.36c0,1.541-1.25,2.787-2.787,2.787h-7.873c-1.541,0.002-2.789-1.248-2.789-2.787     c0-1.541,1.248-2.785,2.789-2.787l7.873,0.002C107.471,44.575,108.719,45.819,108.721,47.36z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M103.951,65.157c-0.77,1.334-2.475,1.789-3.809,1.021l-6.817-3.938c-1.333-0.77-1.79-2.475-1.021-3.807     c0.771-1.336,2.475-1.791,3.809-1.021l6.818,3.938C104.266,62.118,104.721,63.823,103.951,65.157z"/>\
                        </g>\
                        <path fill="#009FE3" d="M62.053,28.184c-1.332,0.77-3.037,0.313-3.808-1.021l-3.937-6.818c-0.771-1.332-0.314-3.035,1.02-3.809    c1.333-0.77,3.038-0.313,3.807,1.021l3.938,6.814C63.844,25.708,63.387,27.413,62.053,28.184z"/>\
                        <g>\
                            <path fill="#009FE3" d="M73.126,25.215c-1.541,0-2.788-1.247-2.788-2.787v-7.873c0-1.539,1.247-2.787,2.788-2.787     c1.54,0,2.787,1.248,2.787,2.787v7.873C75.913,23.969,74.666,25.215,73.126,25.215z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path fill="#009FE3" d="M61.691,44.021c-4.791-8.123-13.524-13.15-22.981-13.15c-12.727,0-23.525,8.83-26.105,21.16    C6.035,54.22,1.279,60.412,1.279,67.707c0,9.111,7.414,16.525,16.526,16.525c3.29,0,6.415-0.947,9.118-2.746    c3.648,1.799,7.691,2.746,11.787,2.746c4.251,0,8.451-1.031,12.205-2.965c3.15,1.938,6.732,2.965,10.493,2.965    c11.088,0,20.108-9.021,20.108-20.109C81.518,53.127,72.648,44.172,61.691,44.021z M61.406,78.654    c-3.247,0-6.317-1.045-8.879-3.025c-1.217-0.939-2.969-0.715-3.909,0.505c-0.017,0.022-0.027,0.048-0.046,0.067    c-3.02,1.604-6.42,2.453-9.864,2.453c-3.655,0-7.255-0.945-10.411-2.742c-0.792-0.449-1.71-0.457-2.485-0.121    c-0.447,0.074-0.884,0.244-1.266,0.541c-1.939,1.521-4.271,2.322-6.742,2.322c-6.038,0-10.951-4.912-10.951-10.949    c0-6.039,4.913-10.951,10.951-10.951c3.047,0,5.979,1.283,8.048,3.523c1.045,1.131,2.809,1.201,3.938,0.156    s1.201-2.809,0.156-3.939c-2.942-3.186-7.042-5.086-11.354-5.295c2.719-8.697,10.748-14.754,20.117-14.754    c6.688,0,12.929,3.176,16.884,8.441c-2.638,0.799-5.109,2.117-7.232,3.932c-1.17,0.998-1.312,2.76-0.312,3.93    s2.761,1.311,3.931,0.313c2.625-2.24,5.973-3.475,9.429-3.475c8.014,0,14.534,6.521,14.534,14.535    C75.941,72.134,69.421,78.654,61.406,78.654z"/>\
                        <g>\
                            <path fill="#009FE3" d="M91.902,47.586c0-10.354-8.422-18.775-18.775-18.775c-5.336,0.002-10.3,2.225-13.822,6.068     c1.295,1.174,2.498,2.453,3.584,3.846c2.557-2.959,6.254-4.684,10.238-4.686c7.469,0,13.544,6.076,13.544,13.547     c0,3.023-0.987,5.854-2.702,8.139c0.727,1.932,1.217,3.977,1.42,6.1C89.443,58.344,91.902,53.208,91.902,47.586z"/>\
                            <g>\
                                <path fill="#009FE3" d="M91.943,74.377l-3.938-6.816c-0.55-0.951-1.574-1.445-2.604-1.379c-0.172,2.033-0.6,3.998-1.25,5.855      l2.961,5.126c0.77,1.334,2.475,1.791,3.808,1.021C92.256,77.414,92.713,75.711,91.943,74.377z"/>\
                            </g>\
                        </g>\
                    </g>\
                    <path fill="#009FE3" d="M61.691,44.021c-4.791-8.123-13.524-13.15-22.981-13.15c-12.727,0-23.525,8.83-26.105,21.16   C6.035,54.22,1.279,60.412,1.279,67.707c0,9.111,7.414,16.525,16.526,16.525c3.29,0,6.415-0.947,9.118-2.746   c3.648,1.799,7.691,2.746,11.787,2.746c4.251,0,8.451-1.031,12.205-2.965c3.15,1.938,6.732,2.965,10.493,2.965   c11.088,0,20.108-9.021,20.108-20.109C81.518,53.127,72.648,44.172,61.691,44.021z M61.406,78.654   c-3.247,0-6.317-1.045-8.879-3.025c-1.217-0.939-2.969-0.715-3.909,0.505c-0.017,0.022-0.027,0.048-0.046,0.067   c-3.02,1.604-6.42,2.453-9.864,2.453c-3.655,0-7.255-0.945-10.411-2.742c-0.792-0.449-1.71-0.457-2.485-0.121   c-0.447,0.074-0.884,0.244-1.266,0.541c-1.939,1.521-4.271,2.322-6.742,2.322c-6.038,0-10.951-4.912-10.951-10.949   c0-6.039,4.913-10.951,10.951-10.951c3.047,0,5.979,1.283,8.048,3.523c1.045,1.131,2.809,1.201,3.938,0.156   s1.201-2.809,0.156-3.939c-2.942-3.186-7.042-5.086-11.354-5.295c2.719-8.697,10.748-14.754,20.117-14.754   c6.688,0,12.929,3.176,16.884,8.441c-2.638,0.799-5.109,2.117-7.232,3.932c-1.17,0.998-1.312,2.76-0.312,3.93   s2.761,1.311,3.931,0.313c2.625-2.24,5.973-3.475,9.429-3.475c8.014,0,14.534,6.521,14.534,14.535   C75.941,72.134,69.421,78.654,61.406,78.654z"/>\
                </g>\
                </svg>';var qing='<svg  x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
				<g>\
					<path fill="#009FE3" d="M54.999,67c-10.354,0-18.776-8.424-18.776-18.774c0-10.354,8.425-18.776,18.776-18.776   c10.354,0,18.775,8.424,18.775,18.776C73.776,58.576,65.354,67,54.999,67z M54.999,34.681c-7.469,0-13.545,6.076-13.545,13.545   c0,7.47,6.076,13.545,13.545,13.545c7.468,0,13.545-6.075,13.545-13.545C68.544,40.756,62.468,34.681,54.999,34.681z"/>\
					<g>\
						<g>\
							<path fill="#009FE3" d="M43.927,67.176c1.333,0.771,1.79,2.479,1.021,3.811l-3.938,6.816c-0.769,1.332-2.476,1.791-3.808,1.023     c-1.334-0.773-1.791-2.479-1.021-3.813l3.938-6.818C40.889,66.865,42.594,66.408,43.927,67.176z"/>\
							<path fill="#009FE3" d="M72.796,17.174c1.333,0.771,1.79,2.476,1.021,3.81l-3.938,6.815c-0.771,1.334-2.476,1.791-3.808,1.022     c-1.334-0.77-1.791-2.475-1.021-3.809l3.938-6.818C69.758,16.861,71.462,16.404,72.796,17.174z"/>\
						</g>\
						<g>\
							<path fill="#009FE3" d="M35.821,59.07c0.771,1.334,0.313,3.039-1.021,3.811l-6.817,3.936c-1.334,0.77-3.039,0.313-3.81-1.02     c-0.771-1.334-0.313-3.036,1.021-3.809l6.816-3.938C33.346,57.281,35.052,57.738,35.821,59.07z"/>\
							<path fill="#009FE3" d="M85.825,30.204c0.77,1.334,0.313,3.039-1.021,3.807l-6.816,3.938c-1.334,0.77-3.039,0.313-3.811-1.021     c-0.77-1.336-0.313-3.039,1.021-3.809l6.816-3.938C83.351,28.413,85.054,28.87,85.825,30.204z"/>\
						</g>\
						<g>\
							<path fill="#009FE3" d="M32.854,48c0,1.539-1.246,2.785-2.787,2.785h-7.873c-1.539,0-2.787-1.248-2.787-2.785     c0-1.541,1.246-2.787,2.787-2.787l7.873-0.002C31.608,45.211,32.854,46.459,32.854,48z"/>\
							<path fill="#009FE3" d="M90.593,48c0,1.539-1.248,2.785-2.788,2.785h-7.872c-1.541,0.002-2.787-1.248-2.787-2.785     c0-1.541,1.246-2.787,2.787-2.789l7.872,0.002C89.345,45.213,90.593,46.459,90.593,48z"/>\
						</g>\
						<g>\
							<path fill="#009FE3" d="M35.821,36.926c-0.771,1.336-2.475,1.791-3.809,1.021l-6.816-3.938c-1.334-0.768-1.791-2.473-1.021-3.807     c0.771-1.334,2.477-1.791,3.809-1.021l6.817,3.938C36.134,33.89,36.591,35.595,35.821,36.926z"/>\
							<path fill="#009FE3" d="M85.825,65.797c-0.771,1.334-2.475,1.789-3.811,1.02l-6.816-3.936c-1.332-0.77-1.791-2.477-1.021-3.809     c0.771-1.334,2.476-1.791,3.81-1.021l6.817,3.937C86.137,62.758,86.594,64.463,85.825,65.797z"/>\
						</g>\
						<g>\
							<path fill="#009FE3" d="M43.927,28.822c-1.334,0.769-3.038,0.312-3.809-1.021l-3.938-6.817c-0.77-1.334-0.313-3.037,1.021-3.808     c1.332-0.771,3.037-0.313,3.808,1.021l3.938,6.818C45.717,26.349,45.26,28.054,43.927,28.822z"/>\
							<path fill="#009FE3" d="M72.796,78.824c-1.333,0.771-3.038,0.313-3.809-1.021l-3.938-6.815c-0.77-1.334-0.313-3.039,1.021-3.809     c1.332-0.77,3.037-0.313,3.808,1.021l3.938,6.816C74.586,76.35,74.129,78.053,72.796,78.824z"/>\
						</g>\
						<g>\
							<path fill="#009FE3" d="M54.999,25.854c-1.54,0-2.788-1.248-2.788-2.787v-7.873c0-1.538,1.248-2.786,2.788-2.786     c1.539,0,2.787,1.248,2.787,2.786v7.873C57.788,24.607,56.54,25.854,54.999,25.854z"/>\
							<path fill="#009FE3" d="M54.999,83.592c-1.54,0-2.788-1.246-2.788-2.787v-7.871c0-1.541,1.248-2.789,2.788-2.789     c1.539,0,2.787,1.248,2.787,2.789v7.871C57.788,82.346,56.54,83.592,54.999,83.592z"/>\
						</g>\
					</g>\
				</g>\
			</svg>';var duoyun_zhenyu='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                        <g>\
                            <g>\
                                <g>\
                                    <g>\
                                        <path fill="#009FE3" d="M90.924,5.36c1.334,0.771,1.791,2.476,1.021,3.81l-3.938,6.817c-0.77,1.334-2.475,1.791-3.809,1.021      c-1.332-0.771-1.789-2.476-1.021-3.81l3.939-6.815C87.885,5.049,89.59,4.592,90.924,5.36z"/>\
                                    </g>\
                                    <g>\
                                        <path fill="#009FE3" d="M103.953,18.39c0.77,1.334,0.313,3.039-1.021,3.807l-6.818,3.938c-1.332,0.771-3.037,0.313-3.809-1.021      c-0.77-1.334-0.313-3.039,1.021-3.809l6.818-3.938C101.477,16.599,103.18,17.056,103.953,18.39z"/>\
                                    </g>\
                                    <g>\
                                        <path fill="#009FE3" d="M108.721,36.187c0,1.541-1.248,2.787-2.787,2.787h-7.873c-1.543,0-2.787-1.248-2.787-2.787      c0-1.541,1.244-2.787,2.785-2.787h7.873C107.473,33.399,108.719,34.646,108.721,36.187z"/>\
                                    </g>\
                                    <g>\
                                        <path fill="#009FE3" d="M103.953,53.983c-0.771,1.334-2.477,1.789-3.811,1.021l-6.816-3.937      c-1.334-0.771-1.791-2.476-1.021-3.808c0.771-1.336,2.477-1.79,3.809-1.021l6.816,3.938      C104.264,50.944,104.721,52.649,103.953,53.983z"/>\
                                    </g>\
                                    <path fill="#009FE3" d="M62.053,17.008c-1.332,0.771-3.037,0.313-3.807-1.021l-3.938-6.818c-0.77-1.334-0.313-3.037,1.021-3.808     c1.332-0.771,3.037-0.313,3.807,1.021l3.939,6.815C63.844,14.534,63.387,16.239,62.053,17.008z"/>\
                                    <g>\
                                        <path fill="#009FE3" d="M73.127,14.041c-1.539,0-2.787-1.247-2.787-2.788V3.38c0-1.539,1.248-2.786,2.787-2.786      c1.541,0,2.789,1.247,2.789,2.786v7.873C75.916,12.794,74.668,14.041,73.127,14.041z"/>\
                                    </g>\
                                </g>\
                                <g>\
                                    <path fill="#009FE3" d="M61.691,32.845c-4.791-8.121-13.523-13.148-22.98-13.148c-12.729,0-23.527,8.83-26.107,21.16     C6.035,43.043,1.279,49.235,1.279,56.532c0,9.111,7.414,16.523,16.525,16.523c3.291,0,6.416-0.945,9.121-2.742     c3.646,1.797,7.689,2.742,11.785,2.742c4.252,0,8.453-1.031,12.207-2.966c3.148,1.938,6.73,2.966,10.492,2.966     c11.088,0,20.107-9.021,20.107-20.109C81.516,41.952,72.65,32.998,61.691,32.845z M61.408,67.48     c-3.246,0-6.316-1.045-8.879-3.025c-1.219-0.939-2.971-0.716-3.91,0.505c-0.018,0.021-0.027,0.047-0.043,0.067     c-3.02,1.604-6.422,2.453-9.867,2.453c-3.654,0-7.254-0.947-10.41-2.742c-0.793-0.449-1.711-0.459-2.488-0.121     c-0.445,0.074-0.883,0.244-1.264,0.541c-1.939,1.521-4.271,2.322-6.744,2.322c-6.039,0-10.951-4.912-10.951-10.949     c0-6.041,4.914-10.953,10.951-10.953c3.047,0,5.98,1.285,8.047,3.523c1.045,1.133,2.811,1.203,3.941,0.155     c1.131-1.043,1.199-2.808,0.154-3.938c-2.939-3.187-7.043-5.088-11.354-5.295c2.717-8.697,10.748-14.756,20.115-14.756     c6.689,0,12.93,3.178,16.885,8.442c-2.639,0.799-5.109,2.116-7.234,3.931c-1.172,1-1.311,2.76-0.311,3.932     c1,1.17,2.76,1.31,3.93,0.312c2.623-2.239,5.973-3.474,9.43-3.474c8.014,0,14.533,6.521,14.533,14.533S69.422,67.48,61.408,67.48     z"/>\
                                    <g>\
                                        <path fill="#009FE3" d="M91.904,36.411c0-10.354-8.424-18.773-18.777-18.773c-5.336,0-10.301,2.225-13.822,6.068      c1.295,1.173,2.498,2.453,3.584,3.846c2.557-2.96,6.254-4.684,10.238-4.686c7.469,0,13.547,6.076,13.547,13.545      c0,3.025-0.99,5.854-2.705,8.141c0.727,1.932,1.217,3.977,1.42,6.098C89.445,47.166,91.904,42.034,91.904,36.411z"/>\
                                        <g>\
                                            <path fill="#009FE3" d="M91.945,63.203l-3.939-6.819c-0.549-0.948-1.574-1.442-2.604-1.377c-0.174,2.034-0.6,3.998-1.248,5.856       l2.959,5.125c0.771,1.336,2.477,1.791,3.809,1.021C92.258,66.24,92.715,64.537,91.945,63.203z"/>\
                                        </g>\
                                    </g>\
                                </g>\
                                <path fill="#009FE3" d="M61.691,32.845c-4.791-8.121-13.523-13.148-22.98-13.148c-12.729,0-23.527,8.83-26.107,21.16    C6.035,43.043,1.279,49.235,1.279,56.532c0,9.111,7.414,16.523,16.525,16.523c3.291,0,6.416-0.945,9.121-2.742    c3.646,1.797,7.689,2.742,11.785,2.742c4.252,0,8.453-1.031,12.207-2.966c3.148,1.938,6.73,2.966,10.492,2.966    c11.088,0,20.107-9.021,20.107-20.109C81.516,41.952,72.65,32.998,61.691,32.845z M61.408,67.48c-3.246,0-6.316-1.045-8.879-3.025    c-1.219-0.939-2.971-0.716-3.91,0.505c-0.018,0.021-0.027,0.047-0.043,0.067c-3.02,1.604-6.422,2.453-9.867,2.453    c-3.654,0-7.254-0.947-10.41-2.742c-0.793-0.449-1.711-0.459-2.488-0.121c-0.445,0.074-0.883,0.244-1.264,0.541    c-1.939,1.521-4.271,2.322-6.744,2.322c-6.039,0-10.951-4.912-10.951-10.949c0-6.041,4.914-10.953,10.951-10.953    c3.047,0,5.98,1.285,8.047,3.523c1.045,1.133,2.811,1.203,3.941,0.155c1.131-1.043,1.199-2.808,0.154-3.938    c-2.939-3.187-7.043-5.088-11.354-5.295c2.717-8.697,10.748-14.756,20.115-14.756c6.689,0,12.93,3.178,16.885,8.442    c-2.639,0.799-5.109,2.116-7.234,3.931c-1.172,1-1.311,2.76-0.311,3.932c1,1.17,2.76,1.31,3.93,0.312    c2.623-2.239,5.973-3.474,9.43-3.474c8.014,0,14.533,6.521,14.533,14.533S69.422,67.48,61.408,67.48z"/>\
                            </g>\
                            <path fill="#009FE3" d="M39.525,89.822c0,3.086-2.5,5.584-5.582,5.584c-3.084,0-5.584-2.498-5.584-5.584   c0-3.082,5.584-11.406,5.584-11.406S39.525,86.74,39.525,89.822z"/>\
                            <path fill="#009FE3" d="M54.332,89.822c0,3.086-2.5,5.584-5.582,5.584c-3.084,0-5.584-2.498-5.584-5.584   c0-3.082,5.584-11.406,5.584-11.406S54.332,86.74,54.332,89.822z"/>\
                        </g>\
                        </svg>';var dalei='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <g>\
                        <path fill="#009FE3" d="M75.294,27.418c-4.791-8.121-13.525-13.146-22.98-13.146c-12.729,0-23.527,8.83-26.107,21.16    c-6.57,2.187-11.324,8.379-11.324,15.674c0,9.11,7.414,16.524,16.525,16.524c3.291,0,6.416-0.945,9.119-2.744    c0.365,0.181,0.738,0.347,1.111,0.508c0.352-0.805,1.945-5.232,1.945-5.232c-0.57-0.261-1.137-0.537-1.682-0.849    c-0.795-0.449-1.51-0.694-2.453-0.248c-0.445,0.073-0.918,0.37-1.301,0.67c-1.938,1.519-4.271,2.319-6.742,2.319    c-6.037,0-10.949-4.912-10.949-10.948c0-6.039,4.912-10.951,10.949-10.951c3.047,0,5.979,1.283,8.047,3.523    c1.047,1.131,2.811,1.201,3.939,0.156s1.199-2.808,0.156-3.938c-2.943-3.187-7.045-5.088-11.354-5.293    c2.717-8.699,10.746-14.756,20.115-14.756c6.689,0,12.93,3.176,16.887,8.441c-2.641,0.801-5.109,2.118-7.234,3.934    c-1.172,0.998-1.311,2.758-0.311,3.928c0.996,1.172,2.758,1.312,3.93,0.312c2.623-2.24,5.973-3.474,9.43-3.474    c8.014,0,14.535,6.521,14.535,14.535c0,8.015-6.521,14.532-14.535,14.532c-2.246,0-4.402-0.51-6.369-1.475    c-0.469,1.172-2.086,5.172-2.086,5.172c2.625,1.228,5.48,1.879,8.455,1.879c11.088,0,20.107-9.021,20.107-20.108    C95.118,36.528,86.251,27.571,75.294,27.418z"/>\
                    </g>\
                    <path fill="#009FE3" d="M56.185,45.789c0.055-0.529-0.09-0.57-0.32-0.093l-9.371,19.437c-0.23,0.479,0.016,0.871,0.545,0.871h6.012   c0.529,0,0.936,0.432,0.896,0.961l-1,14.333c-0.035,0.529,0.129,0.576,0.367,0.103l10.475-20.774c0.24-0.476,0-0.869-0.529-0.881   l-7.525-0.149c-0.527-0.011-0.92-0.451-0.863-0.979L56.185,45.789z"/>\
                </g>\
                </svg>';var dalei_baoyu='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                        <g>\
                            <g>\
                                <g>\
                                    <path fill="#009FE3" d="M75.293,20.978C70.502,12.855,61.768,7.832,52.311,7.832c-12.727,0-23.523,8.83-26.104,21.159     c-6.57,2.187-11.326,8.38-11.326,15.675c0,9.11,7.414,16.524,16.525,16.524c3.289,0,6.416-0.944,9.119-2.744     c0.365,0.181,0.738,0.345,1.111,0.509c0.35-0.806,1.947-5.234,1.947-5.234c-0.572-0.26-1.137-0.535-1.684-0.848     c-0.795-0.449-1.508-0.695-2.453-0.248c-0.445,0.073-0.918,0.373-1.301,0.668c-1.938,1.52-4.27,2.319-6.742,2.319     c-6.037,0-10.949-4.909-10.949-10.946c0-6.039,4.912-10.953,10.949-10.953c3.047,0,5.979,1.285,8.049,3.524     c1.047,1.132,2.809,1.201,3.938,0.156s1.201-2.809,0.156-3.938c-2.939-3.187-7.043-5.089-11.354-5.295     c2.719-8.697,10.748-14.755,20.115-14.755c6.691,0,12.932,3.175,16.887,8.441c-2.641,0.799-5.109,2.119-7.234,3.932     c-1.17,1-1.311,2.759-0.311,3.929c1,1.174,2.76,1.311,3.932,0.313c2.623-2.24,5.971-3.473,9.426-3.473     c8.016,0,14.535,6.521,14.535,14.535c0,8.012-6.521,14.53-14.535,14.53c-2.244,0-4.4-0.511-6.367-1.476     c-0.471,1.174-2.086,5.174-2.086,5.174c2.625,1.229,5.482,1.88,8.453,1.88c11.09,0,20.111-9.021,20.111-20.108     C95.119,30.088,86.252,21.131,75.293,20.978z"/>\
                                </g>\
                                <path fill="#009FE3" d="M56.182,39.349c0.055-0.529-0.09-0.57-0.32-0.092L46.49,58.693c-0.229,0.479,0.018,0.869,0.547,0.869    h6.012c0.531,0,0.936,0.435,0.896,0.961l-1,14.332c-0.035,0.529,0.129,0.576,0.365,0.104l10.479-20.774    c0.236-0.476,0-0.869-0.529-0.881l-7.525-0.15c-0.529-0.01-0.92-0.45-0.865-0.979L56.182,39.349z"/>\
                            </g>\
                            <path fill="#009FE3" d="M69.432,88.168c-0.484,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.965-3.821l5.5-9.219   c0.787-1.322,2.502-1.753,3.82-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.502,9.219C71.307,87.68,70.383,88.168,69.432,88.168z   "/>\
                            <path fill="#009FE3" d="M40.76,88.168c-0.486,0-0.98-0.127-1.426-0.396c-1.322-0.786-1.756-2.495-0.967-3.821l5.5-9.219   c0.789-1.322,2.502-1.753,3.822-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.502,9.219C42.635,87.68,41.709,88.168,40.76,88.168z   "/>\
                            <path fill="#009FE3" d="M26.424,88.168c-0.486,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.967-3.821l5.502-9.219   c0.789-1.322,2.502-1.753,3.82-0.968c1.322,0.793,1.756,2.502,0.967,3.824l-5.5,9.219C28.299,87.68,27.375,88.168,26.424,88.168z"/>\
                            <path fill="#009FE3" d="M55.096,88.168c-0.486,0-0.979-0.127-1.426-0.396c-1.322-0.786-1.754-2.495-0.967-3.821l5.5-9.219   c0.789-1.322,2.504-1.753,3.822-0.968c1.322,0.793,1.754,2.502,0.967,3.824l-5.502,9.219C56.971,87.68,56.047,88.168,55.096,88.168   z"/>\
                        </g>\
                        </svg>';var daxue='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path fill="#009FE3" d="M75.294,18.086C70.503,9.963,61.771,4.94,52.313,4.94c-12.729,0-23.525,8.828-26.107,21.158   c-6.568,2.187-11.324,8.381-11.324,15.676c0,9.11,7.414,16.524,16.525,16.524c3.291,0,6.416-0.946,9.119-2.745   c3.648,1.797,7.689,2.745,11.787,2.745c4.25,0,8.451-1.032,12.205-2.967c3.146,1.938,6.73,2.967,10.492,2.967   c11.088,0,20.107-9.022,20.107-20.11C95.12,27.196,86.251,18.237,75.294,18.086z M75.011,52.721c-3.248,0-6.316-1.048-8.877-3.022   c-1.219-0.941-2.971-0.716-3.91,0.5c-0.02,0.022-0.027,0.049-0.045,0.073c-3.021,1.599-6.42,2.449-9.865,2.449   c-3.654,0-7.254-0.944-10.41-2.742c-0.795-0.45-1.715-0.461-2.492-0.123c-0.445,0.074-0.881,0.248-1.26,0.546   c-1.939,1.518-4.271,2.319-6.744,2.319c-6.037,0-10.951-4.912-10.951-10.946c0-6.041,4.914-10.955,10.951-10.955   c3.047,0,5.98,1.284,8.047,3.526c1.045,1.129,2.809,1.198,3.939,0.153c1.129-1.045,1.201-2.812,0.156-3.938   c-2.941-3.185-7.043-5.088-11.355-5.295c2.717-8.696,10.748-14.754,20.117-14.754c6.689,0,12.93,3.176,16.885,8.44   c-2.639,0.799-5.111,2.119-7.234,3.932c-1.172,1-1.311,2.763-0.311,3.932c1,1.17,2.76,1.313,3.93,0.313   c2.623-2.241,5.973-3.477,9.428-3.477c8.016,0,14.533,6.521,14.533,14.536C89.544,46.204,83.026,52.721,75.011,52.721z"/>\
                    <g>\
                        <g>\
                            <path fill="#009FE3" d="M45.401,65.618c0.529,0.918,0.217,2.09-0.701,2.621l-10.115,5.84c-0.918,0.528-2.09,0.215-2.617-0.703     c-0.529-0.918-0.217-2.088,0.699-2.619l10.117-5.84C43.7,64.387,44.872,64.702,45.401,65.618z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M45.401,73.375c-0.529,0.918-1.701,1.232-2.619,0.703l-10.115-5.84c-0.918-0.531-1.229-1.703-0.701-2.621     c0.529-0.916,1.701-1.229,2.617-0.701l10.117,5.84C45.616,71.288,45.931,72.457,45.401,73.375z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M38.683,77.255c-1.059,0-1.916-0.856-1.916-1.92v-11.68c0-1.059,0.857-1.918,1.916-1.918     s1.918,0.859,1.918,1.918v11.68C40.601,76.398,39.741,77.255,38.683,77.255z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <g>\
                            <path fill="#009FE3" d="M76.196,65.618c0.529,0.918,0.215,2.09-0.701,2.621l-10.115,5.84c-0.918,0.528-2.09,0.215-2.619-0.701     c-0.529-0.92-0.215-2.09,0.701-2.621l10.115-5.84C74.495,64.387,75.667,64.702,76.196,65.618z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M76.196,73.375c-0.529,0.918-1.701,1.232-2.617,0.703l-10.117-5.84c-0.916-0.531-1.23-1.703-0.701-2.621     c0.529-0.916,1.701-1.229,2.619-0.701l10.115,5.84C76.411,71.288,76.726,72.457,76.196,73.375z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M69.479,77.255c-1.061,0-1.916-0.856-1.916-1.92v-11.68c0-1.059,0.855-1.918,1.916-1.918     c1.059,0,1.916,0.859,1.916,1.918v11.68C71.396,76.398,70.538,77.255,69.479,77.255z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <g>\
                            <path fill="#009FE3" d="M60.798,79.425c0.529,0.916,0.217,2.089-0.701,2.615l-10.115,5.842c-0.916,0.527-2.088,0.218-2.619-0.7     c-0.529-0.916-0.215-2.091,0.703-2.619l10.115-5.839C59.097,78.192,60.269,78.505,60.798,79.425z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M60.798,87.182c-0.527,0.918-1.701,1.229-2.617,0.7l-10.115-5.84c-0.918-0.528-1.232-1.701-0.703-2.617     c0.531-0.919,1.703-1.233,2.619-0.702l10.117,5.839C61.013,85.091,61.327,86.266,60.798,87.182z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M54.079,91.06c-1.059,0-1.916-0.857-1.916-1.916V77.462c0-1.059,0.857-1.916,1.916-1.916     c1.061,0,1.918,0.857,1.918,1.916v11.682C55.997,90.202,55.138,91.06,54.079,91.06z"/>\
                        </g>\
                    </g>\
                </g>\
                </svg>';var yujiaxue='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <path fill="#009FE3" d="M60.281,85.717c0,3.082-2.5,5.582-5.582,5.582c-3.084,0-5.584-2.5-5.584-5.582s5.584-11.406,5.584-11.406   S60.281,82.635,60.281,85.717z"/>\
                        <path fill="#009FE3" d="M75.291,17.851C70.5,9.728,61.766,4.701,52.311,4.701c-12.727,0-23.525,8.832-26.107,21.16   c-6.568,2.187-11.322,8.381-11.322,15.674c0,9.115,7.414,16.525,16.525,16.525c3.289,0,6.414-0.944,9.117-2.74   c3.648,1.796,7.691,2.74,11.787,2.74c4.252,0,8.451-1.028,12.205-2.964c3.15,1.939,6.734,2.964,10.494,2.964   c11.088,0,20.109-9.021,20.109-20.107C95.117,26.961,86.248,18.004,75.291,17.851z M75.006,52.488   c-3.246,0-6.316-1.048-8.877-3.025c-1.219-0.94-2.969-0.717-3.91,0.5c-0.018,0.022-0.029,0.049-0.045,0.074   c-3.02,1.598-6.42,2.451-9.865,2.451c-3.656,0-7.256-0.949-10.412-2.742c-0.795-0.453-1.713-0.463-2.492-0.123   c-0.441,0.074-0.879,0.246-1.258,0.543c-1.939,1.521-4.27,2.322-6.744,2.322c-6.037,0-10.951-4.913-10.951-10.954   c0-6.037,4.914-10.948,10.951-10.948c3.047,0,5.98,1.284,8.049,3.522c1.043,1.131,2.809,1.201,3.939,0.156   c1.131-1.045,1.201-2.81,0.158-3.938c-2.941-3.184-7.043-5.086-11.355-5.297c2.717-8.694,10.746-14.752,20.117-14.752   c6.689,0,12.928,3.176,16.883,8.441c-2.639,0.799-5.109,2.119-7.232,3.932c-1.17,1.002-1.311,2.76-0.311,3.928   c1,1.175,2.76,1.313,3.93,0.313c2.623-2.24,5.971-3.473,9.428-3.473c8.014,0,14.535,6.521,14.535,14.534   C89.543,45.969,83.021,52.488,75.006,52.488z"/>\
                        <g>\
                            <g>\
                                <path fill="#009FE3" d="M45.396,65.385c0.531,0.916,0.215,2.088-0.701,2.617L34.58,73.844c-0.918,0.529-2.09,0.213-2.619-0.7     c-0.529-0.918-0.215-2.091,0.701-2.621l10.115-5.838C43.695,64.154,44.869,64.469,45.396,65.385z"/>\
                            </g>\
                            <g>\
                                <path fill="#009FE3" d="M45.396,73.142c-0.529,0.913-1.701,1.229-2.619,0.7L32.662,68c-0.916-0.529-1.23-1.701-0.701-2.617     s1.701-1.229,2.617-0.701l10.117,5.839C45.611,71.053,45.928,72.223,45.396,73.142z"/>\
                            </g>\
                            <g>\
                                <path fill="#009FE3" d="M38.68,77.021c-1.061,0-1.918-0.858-1.918-1.918V63.42c0-1.057,0.857-1.918,1.918-1.918     c1.059,0,1.916,0.861,1.916,1.918v11.683C40.596,76.162,39.738,77.021,38.68,77.021z"/>\
                            </g>\
                        </g>\
                        <g>\
                            <g>\
                                <path fill="#009FE3" d="M76.191,65.383c0.531,0.918,0.217,2.09-0.699,2.619l-10.117,5.842c-0.918,0.529-2.09,0.213-2.619-0.7     c-0.529-0.918-0.215-2.091,0.701-2.621l10.117-5.838C74.492,64.154,75.666,64.469,76.191,65.383z"/>\
                            </g>\
                            <g>\
                                <path fill="#009FE3" d="M76.193,73.142c-0.529,0.913-1.701,1.229-2.617,0.7L63.459,68c-0.918-0.529-1.23-1.701-0.703-2.617     c0.529-0.916,1.701-1.229,2.619-0.701l10.117,5.839C76.408,71.053,76.723,72.223,76.193,73.142z"/>\
                            </g>\
                            <g>\
                                <path fill="#009FE3" d="M69.475,77.021c-1.061,0-1.916-0.858-1.916-1.918V63.42c0-1.057,0.855-1.918,1.916-1.918     s1.918,0.861,1.918,1.918v11.683C71.393,76.162,70.535,77.021,69.475,77.021z"/>\
                            </g>\
                        </g>\
                    </g>\
                    </svg>';var leizhenyu='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path fill="#009FE3" d="M44.017,83.052c0,3.084-2.5,5.582-5.582,5.582c-3.084,0-5.582-2.498-5.582-5.582   c0-3.085,5.582-11.407,5.582-11.407S44.017,79.967,44.017,83.052z"/>\
                    <path fill="#009FE3" d="M61.212,83.052c0,3.084-2.5,5.582-5.584,5.582c-3.082,0-5.582-2.498-5.582-5.582   c0-3.085,5.582-11.407,5.582-11.407S61.212,79.967,61.212,83.052z"/>\
                    <path fill="#009FE3" d="M78.733,83.052c0,3.084-2.498,5.582-5.58,5.582c-3.084,0-5.584-2.498-5.584-5.582   c0-3.085,5.584-11.407,5.584-11.407S78.733,79.967,78.733,83.052z"/>\
                    <g>\
                        <g>\
                            <path fill="#009FE3" d="M48.616,38.884c0.053-0.528-0.09-0.569-0.32-0.091l-9.371,19.436c-0.23,0.479,0.016,0.869,0.545,0.869     h6.012c0.531,0,0.936,0.435,0.896,0.963l-1,14.336c-0.035,0.528,0.129,0.573,0.367,0.102l10.477-20.775     c0.238-0.474,0-0.869-0.529-0.881l-7.523-0.15c-0.529-0.011-0.92-0.449-0.865-0.979L48.616,38.884z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path fill="#009FE3" d="M48.616,38.884c0.053-0.528-0.09-0.569-0.32-0.091l-9.371,19.436c-0.23,0.479,0.016,0.869,0.545,0.869    h6.012c0.531,0,0.936,0.435,0.896,0.963l-1,14.336c-0.035,0.528,0.129,0.573,0.367,0.102l10.477-20.775    c0.238-0.474,0-0.869-0.529-0.881l-7.523-0.15c-0.529-0.011-0.92-0.449-0.865-0.979L48.616,38.884z"/>\
                    </g>\
                    <g>\
                        <g>\
                            <path fill="#009FE3" d="M68.927,38.884c0.055-0.528-0.092-0.569-0.32-0.091l-9.373,19.436c-0.23,0.479,0.016,0.869,0.545,0.869     h6.012c0.531,0,0.936,0.435,0.898,0.963l-1,14.336c-0.037,0.528,0.127,0.573,0.367,0.102L76.53,53.723     c0.238-0.474,0-0.869-0.531-0.881l-7.523-0.15c-0.531-0.011-0.92-0.449-0.865-0.979L68.927,38.884z"/>\
                        </g>\
                        <g>\
                            <path fill="#009FE3" d="M95.118,40.618c0-10.994-8.869-19.951-19.826-20.104c-4.791-8.123-13.523-13.148-22.98-13.148     c-12.727,0-23.523,8.834-26.105,21.157c-6.57,2.189-11.324,8.386-11.324,15.679c0,9.11,7.414,16.521,16.523,16.521     c1.021,0,2.023-0.098,3.008-0.273c-0.52-1.365-0.461-2.908,0.207-4.295l0.863-1.793c-1.283,0.514-2.654,0.788-4.078,0.788     c-6.039,0-10.949-4.911-10.949-10.948c0-6.041,4.91-10.953,10.949-10.953c3.045,0,5.98,1.285,8.049,3.524     c1.043,1.132,2.809,1.199,3.938,0.154c1.131-1.045,1.201-2.807,0.156-3.938c-2.941-3.184-7.043-5.086-11.354-5.293     c2.717-8.699,10.746-14.754,20.117-14.754c6.689,0,12.928,3.176,16.885,8.442c-2.641,0.797-5.111,2.115-7.236,3.928     c-1.17,1.002-1.309,2.761-0.309,3.933c1,1.17,2.76,1.311,3.93,0.311c2.623-2.242,5.973-3.475,9.428-3.475     c8.016,0,14.533,6.521,14.533,14.537c0,5.723-3.336,10.674-8.156,13.041c-0.041,0.752-0.23,1.506-0.588,2.213l-2.289,4.543     C87.935,58.754,95.118,50.512,95.118,40.618z"/>\
                        </g>\
                    </g>\
                    <g>\
                        <path fill="#009FE3" d="M68.927,38.884c0.055-0.528-0.092-0.569-0.32-0.091l-9.373,19.436c-0.23,0.479,0.016,0.869,0.545,0.869    h6.012c0.531,0,0.936,0.435,0.898,0.963l-1,14.336c-0.037,0.528,0.127,0.573,0.367,0.102L76.53,53.723    c0.238-0.474,0-0.869-0.531-0.881l-7.523-0.15c-0.531-0.011-0.92-0.449-0.865-0.979L68.927,38.884z"/>\
                    </g>\
                </g>\
                </svg>';var ye_yin='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                <g>\
                    <path fill="#009FE3" d="M77.502,43.357c-5.789-9.226-3.951-21.271,3.67-29.865c-2.723,0.771-5.41,1.939-7.963,3.545   C65.748,21.723,61.068,29,59.826,36.529c-4.893-4.662-11.439-7.381-18.389-7.381c-12.727,0-23.525,8.832-26.105,21.161   C8.764,52.496,4.008,58.689,4.008,65.982c0,9.109,7.414,16.525,16.525,16.525c3.287,0,6.416-0.949,9.117-2.744   c3.648,1.793,7.691,2.744,11.787,2.744c4.252,0,8.451-1.031,12.205-2.967c3.15,1.938,6.734,2.967,10.492,2.967   c10.787,0,19.611-8.535,20.088-19.205c5.082-0.135,10.33-1.639,15.113-4.643c2.555-1.604,4.775-3.51,6.656-5.631   C94.941,56.162,83.291,52.578,77.502,43.357z M64.137,76.932c-3.246,0-6.314-1.047-8.877-3.021c-1.219-0.943-2.969-0.717-3.91,0.5   c-0.018,0.021-0.025,0.049-0.043,0.068c-3.02,1.604-6.422,2.453-9.867,2.453c-3.654,0-7.256-0.945-10.41-2.74   c-0.795-0.451-1.713-0.459-2.488-0.123c-0.445,0.072-0.881,0.248-1.262,0.545c-1.941,1.518-4.273,2.318-6.744,2.318   c-6.037,0-10.949-4.91-10.949-10.949c0-6.037,4.912-10.949,10.949-10.949c3.047,0,5.979,1.283,8.049,3.521   c1.045,1.129,2.809,1.201,3.938,0.156s1.201-2.809,0.156-3.939c-2.943-3.184-7.045-5.086-11.354-5.297   c2.717-8.693,10.746-14.754,20.115-14.754c6.691,0,12.93,3.177,16.887,8.441c-2.639,0.799-5.109,2.117-7.234,3.932   c-1.17,1-1.313,2.758-0.313,3.93c0.998,1.172,2.758,1.311,3.932,0.313c2.625-2.24,5.973-3.475,9.428-3.475   c8.016,0,14.535,6.521,14.535,14.534C78.672,70.412,72.15,76.932,64.137,76.932z"/>\
                    <polygon fill="#009FE3" points="91.719,25.223 95.803,23.078 95.021,27.626 98.326,30.843 93.762,31.509 91.719,35.648    89.676,31.509 85.109,30.843 88.412,27.626 87.635,23.078  "/>\
                    <polygon fill="#009FE3" points="52.994,19.479 55.869,17.97 55.32,21.171 57.648,23.441 54.432,23.908 52.994,26.824    51.555,23.908 48.338,23.441 50.664,21.171 50.117,17.97  "/>\
                </g>\
                </svg>';var ye_qing='<svg x="0px" y="0px" width="110px" height="76px" viewBox="0 0 110 96" enable-background="new 0 0 110 96" xml:space="preserve">\
                    <g>\
                        <polygon fill="#009FE3" points="64.13,36.086 68.216,33.936 67.435,38.487 70.739,41.709 66.173,42.369 64.13,46.507    62.087,42.369 57.522,41.709 60.825,38.487 60.046,33.936  "/>\
                        <polygon fill="#009FE3" points="68.909,51.216 71.786,49.707 71.237,52.91 73.565,55.179 70.347,55.645 68.909,58.559    67.472,55.645 64.253,55.179 66.581,52.91 66.032,49.707  "/>\
                        <g>\
                            <path fill="#009FE3" d="M61.856,77.953c-0.002,0-0.002,0-0.002,0c-11.102-0.002-21.279-5.582-27.236-14.936    c-4.629-7.266-6.15-15.896-4.283-24.311c1.865-8.414,6.896-15.594,14.162-20.224c0.977-0.623,2.24-0.575,3.17,0.119    c0.928,0.697,1.328,1.896,1.004,3.011c-0.043,0.15-4.369,15.786,4.723,29.371c8.965,13.393,24.672,16.801,24.828,16.83    c1.109,0.23,1.973,1.111,2.176,2.229c0.203,1.115-0.285,2.246-1.242,2.854C73.962,76.203,67.981,77.953,61.856,77.953z     M42.101,27.705c-3.113,3.405-5.299,7.582-6.324,12.209c-1.543,6.959-0.285,14.102,3.545,20.109    c4.926,7.734,13.35,12.352,22.533,12.352c0,0,0,0,0.002,0c2.838,0,5.639-0.453,8.309-1.332    c-6.154-2.521-15.107-7.549-21.402-16.953C42.384,44.563,41.64,34.421,42.101,27.705z"/>\
                        </g>\
                    </g>\
                    </svg>';ModalWeather.prototype.renderModal=function(){var crtContainer=this.container;var timeTicket;var _this=this;_this.isFirstRender=true;_this.chart=undefined;getWeatherStatus();if(timeTicket){clearInterval(timeTicket)}
timeTicket=setInterval(getWeatherStatus,1000*60*10);function formatTemp(temprt){return temprt.substring(temprt.indexOf('温')+1);}
function getWeatherPic(weathType,type){var resultPic;switch(weathType)
{case'阴':resultPic=yin;if(type==2){resultPic=ye_yin;}
break;case'大雨':resultPic=dayu;break;case'暴雨':resultPic=baoyu;break;case'多云':resultPic=duoyun;if(type==2){resultPic=ye_yin;}
break;case'小雨':resultPic=xiaoyu;break;case'晴转多云':resultPic=qing_duoyun;break;case'晴':resultPic=qing;if(type==2){resultPic=ye_qing;}
break;case'阵雨':resultPic=duoyun_zhenyu;break;case'打雷':resultPic=dalei;break;case'打雷暴雨':resultPic=dalei_baoyu;break;case'大雪':resultPic=daxue
break;case'雨夹雪':resultPic=yujiaxue;break;case'雷阵雨':resultPic=leizhenyu;break;default:resultPic=qing;}
return resultPic;}
function getWeatherStatus(){WebAPI.get('/dashboard/get_weather/1').done(function(result){var rslt=JSON.parse(result);if(rslt){var tempdata=rslt.data;var weatherCrtCt='',weatherCrtPic='';var tempday=tempdata.forecast[0].date;var day=tempday.substring(tempday.indexOf('星期'));var crtTemp=tempdata.wendu;var crtDate=new Date();var _date=(crtDate.getMonth()+1)+'月'+crtDate.getDate()+'日';var today=getWeatherPic(tempdata.forecast[0].type);var todaytTemp=formatTemp(tempdata.forecast[0].high);var tonight=getWeatherPic(tempdata.forecast[0].type,2);var tonightTemp=formatTemp(tempdata.forecast[0].low);weatherCrtCt='<dl class="weathCrtDayCt" style="margin-left: 4%;"><dt class="weathCrtDay dtTop">'+day+'</dt><dd class="weathCrtTemprt">'+crtTemp+'℃</dd><dd class="ddBottom weatherDate"> '+_date+'</dd></dl>';weatherCrtPic='<dl class="weathCrtDayPic" style="left:42%;">\
                                        <dt class="weathCrtToday dtTop">白 天</dt>\
                                        <dd class="temprtIconBig">'
+today+'</dd>\
                                        <dd class="ddBottom">'+todaytTemp+'</dd>\
                                    </dl>\
                                    <dl class="weathCrtDayPic" style="left:66%;">\
                                        <dt class="weathCrtToday dtTop">晚 上</dt>\
                                        <dd class="temprtIconBig">'
+tonight+'</dd>\
                                        <dd class="ddBottom">'+tonightTemp+'</dd>\
                                    </dl>';var weatherStatus='';for(var i in tempdata.forecast){if(i==0)
continue;var _day=tempdata.forecast[i].date.substring(tempdata.forecast[i].date.indexOf('日')+1);var _tempArange=formatTemp(tempdata.forecast[i].high)+'/'+formatTemp(tempdata.forecast[i].low);var temp='<dl class="weathFuture">\
                                        <dt>'+_day+'</dt>\
                                        <dd>'
+qing+'</dd>\
                                        <dd> '+_tempArange+'</dd>\
                                    </dl>';weatherStatus+=temp;}}
if(_this.isFirstRender){_this.tempList=[];_this.xData=[];_this.chart=undefined;if(rslt.tempHistory.length>0){for(var i=rslt.tempHistory.length-1;i>0;i--){if(_this.xData.length<12){var time=rslt.tempHistory[i].time.replace(' GMT','')
time=time.toDate().getHours();if(time!=_this.xData[_this.xData.length-1]){_this.xData.unshift(parseInt(time));_this.tempList.unshift(rslt.tempHistory[i].temp);}}}
while(_this.xData.length<12){var xMax=_this.xData[_this.xData.length-1];if(new Date().getHours()>xMax){_this.tempList.push(crtTemp);}
if(xMax>23){_this.xData.push(0);}else{_this.xData.push(_this.xData[_this.xData.length-1]+1);}}
_this.isFirstRender=true;}else{_this.tempList.push(crtTemp);var xDataFirst=new Date().getHours();var tempXDataLen=_this.xData.length;for(var i=0;i<12-tempXDataLen;i++){if(xDataFirst<23){_this.xData.push(xDataFirst++)}else{_this.xData.push(xDataFirst)
xDataFirst=0;}}
_this.isFirstRender=false;}
crtContainer.innerHTML=getDaysWeather(weatherCrtCt,weatherCrtPic,weatherStatus);_this.optionChart={title:{text:I18n.resource.dashboard.modalWeather.REAL_TIME_TEMPERATURE,y:2,x:38,textStyle:{color:'#5c5e62',fontFamily:'Microsoft YaHei',fontSize:12}},tooltip:{trigger:'axis'},backgroundColor:'#f7f9fa',calculable:false,color:['#1abc9c'],xAxis:[{type:'category',boundaryGap:true,splitLine:{show:false},axisTick:{show:false},data:(function(xData){var arr=[];for(var i=0;i<xData.length;i++){if(xData[i]<10){arr.push('0'+xData[i]+':00')}else{arr.push(xData[i]+':00')}}
return arr;})(_this.xData)}],yAxis:[{type:'value',splitNumber:5,scale:true}],grid:{height:'56%',width:'86%',y:24,x:60},series:[{type:'line',smooth:true,data:_this.tempList}]};_this.chart=echarts.init(document.getElementById('modalWeatherChart'),AppConfig.chartTheme).setOption(_this.optionChart);}else{$('.weatherWrap').html('<div>'+weatherCrtCt+weatherCrtPic+'</div><div style="width: 50%;right:0;position: absolute;top:0">'+weatherStatus+'</div>');var nowTime=new Date().getHours();if(_this.xData[_this.tempList.length-1]<nowTime){if(_this.chart.getSeries()[0].data.length>11){var xDataLabel=_this.xData[_this.xData.length-1]+1;if(xDataLabel>23){xDataLabel=0;}
_this.xData.splice(0,1);_this.xData.push(xDataLabel);var xDataLabelFmt=xDataLabel+':00';if(xDataLabel<10){xDataLabelFmt='0'+xDataLabelFmt;}
_this.chart.addData([[0,rslt.data.wendu,false,false,xDataLabelFmt]]);_this.tempList.splice(0,1);}else{_this.chart.addData([[0,rslt.data.wendu,false,true]]);}
_this.tempList.push(rslt.data.wendu);}}});}
function getDaysWeather(weatherCrtCt,weatherCrtPic,weatherStatus){var str='\
                                                <style>\
                                                 .weatherWrap{\
                                                    background: #fff;border-radius: 4px;height: 100%;position:relative;\
                                                }\
                                                .weatherWrap dl{\
                                                    display: inline-block;font-family: "Microsoft YaHei";text-align: center;height: 100%;\
                                                }\
                                                .weathCrtDayCt{\
                                                    width: 33%;position: absolute;top: 0;\
                                                }\
                                                .weathCrtDayCt *{\
                                                    position: absolute;left: 23%;\
                                                }\
                                                @media screen and (max-width: 1920px) {\
                                                    .weathFuture{width: 22%;margin-top: 14.5%;}\
                                                    .weathCrtDay, .weathCrtToday{margin-top: 4%;}\
                                                    .weathCrtDayPic dd svg {\
                                                        width: 100%;height: 100%;\
                                                    }\
                                                    .temprtIconBig{position: relative;top: 24%;left: -30%;}\
                                                }\
                                                @media screen and (max-width: 1366px) {\
                                                    .weathFuture{width: 24%;margin-top: 11%; }\
                                                    .temprtIconBig{position: relative;top: 24%;  left: -24%;}\
                                                }\
                                                @media screen and (max-height: 768px) {\
                                                    .weathCrtTemprt{top: 30% !important;left: 20% !important; font-size: 3rem !important; transform: scaley(1.2) !important;}\
                                                }\
                                                .weathCrtDayCt, .weatherDate{\
                                                    color: #009fe3;font-weight: 800;font-size: 18px;font-family: "Microsoft YaHei";\
                                                }\
                                                .weatherDate{\
                                                      left: 23% !important;\
                                                }\
                                                .weathCrtTemprt{\
                                                    font-size: 3.5rem;color: #009fe3;  top: 33%;left: 20%;  transform: scaley(1.3);\
                                                }\
                                                .weathCrtToday{\
                                                    color: #5c5e62;font-size: 18px;font-weight: 300;\
                                                }\
                                                .weathFuture dd svg g path{\
                                                    fill: #626262;\
                                                }\
                                                .weathFuture dd svg {\
                                                    width: 70%;height: 100%\
                                                }\
                                                .weathFuture *{\
                                                    color: #5c5e62;font-size: 12px;font-family: "Microsoft YaHei";\
                                                }\
                                                \.weathCrtDayPic{\
                                                    width: 30%;position: absolute;\
                                                }\
                                                .weathCrtDayPic > * {\
                                                    color: #5c5e62;font-size: 18px;font-family: "Microsoft YaHei";\
                                                }\
                                                .weatherWrap div{\
                                                    display: inline-block;width: 50%;position: relative;height:100%\
                                                }\
                                                .dtTop{  top:0; position: absolute;  }\
                                                .ddBottom{ bottom:0;  left: 5px;  position: absolute; }\
                                                </style>\
                                                <div style="width: 100%; height: 48%;">\
                                                <div class="weatherWrap">\
                                                    <div>'
+weatherCrtCt+weatherCrtPic+'</div><div style="width: 50%;right:0;position: absolute;top:0">'
+weatherStatus+'</div>'+'</div>\
                                                </div>\
                                                <div id="modalWeatherChart" style="width: 98%; height: 49%;margin: 1%;"></div>';return str;}
this.container.style.background='#fff';this.container.style.borderRadius='4px';},ModalWeather.prototype.showConfigMode=function(){}
return ModalWeather;})();var ModalEnergySaveRate=(function(){function ModalEnergySaveRate(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalEnergySaveRate.prototype=new ModalBase();ModalEnergySaveRate.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_ENERGY_SAVE_RATE',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalEnergySaveRate'};ModalEnergySaveRate.prototype.renderModal=function(){var _this=this;WebAPI.get('/static/scripts/spring/entities/modalEnergySaveRate.html').done(function(resultHtml){_this.container.innerHTML=resultHtml;I18n.fillArea($('#energySaveName').parent());});},ModalEnergySaveRate.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+'%';$('#energySavePerVal').text(show);$('#progressItem').css('width',show);},ModalEnergySaveRate.prototype.showConfigMode=function(){var _this=this;},ModalEnergySaveRate.prototype.setModalOption=function(option){this.entity.modal.interval=5;};return ModalEnergySaveRate;})();var ModalCoalSaveTotal=(function(){function ModalCoalSaveTotal(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalCoalSaveTotal.prototype=new ModalBase();ModalCoalSaveTotal.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_COAL_SAVE_TOTAL',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalCoalSaveTotal'};ModalCoalSaveTotal.prototype.renderModal=function(){this.container.innerHTML=template;I18n.fillArea($('#coalSaveName').parent());},ModalCoalSaveTotal.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+' Ton';$('#coalSaveVal').text(show);},ModalCoalSaveTotal.prototype.showConfigMode=function(){var _this=this;},ModalCoalSaveTotal.prototype.setModalOption=function(option){this.entity.modal.interval=5;};var template='<style type="text/css">\
        .frameCtl {position: relative;height: 100%;}\
        .imgBackground {position: absolute;width: 100%;height: 100%;right: 0;bottom: 0;top: 0;left: 0;z-index: -1;}\
        #coalSaveVal {position: absolute;left: 60px;top: 40px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
        #coalSaveName {position: absolute;left: 60px;top: 80px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
    </style>\
    <div class="frameCtl">\
        <img src="/static/images/spring/entities/modalCoalSaveTotal.png" class="imgBackground" alt="Background image">\
        <div id="coalSaveVal"> Ton</div>\
        <div id="coalSaveName" i18n="dashboard.carbonFootprint.STANDARD_COAL_SAVING"></div>\
    </div>';return ModalCoalSaveTotal;})();var ModalCo2SaveTotal=(function(){function ModalCo2SaveTotal(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);}
ModalCo2SaveTotal.prototype=new ModalBase();ModalCo2SaveTotal.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_CO2_SAVE_TOTAL',parent:0,mode:['realTimeDashboard'],maxNum:1,title:'',minHeight:1,minWidth:2,maxHeight:6,maxWidth:12,type:'ModalCo2SaveTotal'};ModalCo2SaveTotal.prototype.renderModal=function(){this.container.innerHTML=template;I18n.fillArea($('#co2Name').parent());},ModalCo2SaveTotal.prototype.updateModal=function(points){var show=parseFloat(points[0].data).toFixed(1).toString()+' Ton';$('#co2SaveVal').text(show);},ModalCo2SaveTotal.prototype.showConfigMode=function(){var _this=this;},ModalCo2SaveTotal.prototype.setModalOption=function(option){this.entity.modal.interval=5;};var template='<style type="text/css">\
        .frameCtl {position: relative;height: 100%;}\
        .imgBackground {position: absolute;width: 100%;height: 100%;right: 0;bottom: 0;top: 0;left: 0;z-index: -1;}\
        #co2SaveVal {position: absolute;left: 60px;top: 40px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
        #co2Name {position: absolute;left: 60px;top: 80px;width: 220px;font-size: 25px;font-weight: 500;color: #eeeeee;}\
    </style>\
    <div class="frameCtl">\
        <img src="/static/images/spring/entities/modalCo2SaveTotal.png" class="imgBackground" alt="Background image">\
        <div id="co2SaveVal"></div>\
        <div id="co2Name" i18n="dashboard.carbonFootprint.CO2_SAVING"></div>\
    </div>';return ModalCo2SaveTotal;})();var ModalKPIConfig=(function($,window,undefined){var _this;function ModalKPIConfig(options){_this=this;this.options=$.extend({},DEFAULTS,options);this.$wrap=null;}
ModalKPIConfig.prototype.show=function(){var domPanelContent=document.getElementById('paneContent');if($('#modalKPIConfigWrap').length>0){this.$modal.modal('show');return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalKPIConfig.html').done(function(html){Spinner.stop();_this.$wrap=$('<div class="modal-kpi-config-wrap" id="modalKPIConfigWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this.init();_this.$modal.modal('show');});};ModalKPIConfig.prototype.init=function(){this.$formWrap=$("#formWrap",this.$wrap);this.$btnClose=$('.close',this.$wrap);this.$btnWarnMode=$('#btnWarnMode',this.$formWrap);this.$ulWarnMode=$('#ulWarnMode',this.$formWrap);this.$btnWarnTimeMode=$('#btnWarnTimeMode',this.$formWrap);this.$ulWarnTimeMode=$('#ulWarnTimeMode',this.$formWrap);this.$btnPreWarnMode=$('#btnPreWarnMode',this.$formWrap);this.$ulPreWarnMode=$('#ulPreWarnMode',this.$formWrap);this.$btnPreWarnTimeMode=$('#btnPreWarnTimeMode',this.$formWrap);this.$ulPreWarnTimeMode=$('#ulPreWarnTimeMode',this.$formWrap);this.$btnDataCycleMode=$('#btnDataCycleMode',this.$formWrap);this.$ulDataCycleMode=$('#ulDataCycleMode',this.$formWrap);this.$btnStartMonth=$('#btnStartMonth',this.$formWrap);this.$ulStartMonth=$('#ulStartMonth',this.$formWrap);this.$btnHistoryValUsage=$('#btnHistoryValUsage',this.$formWrap);this.$ulHistoryValUsage=$('#ulHistoryValUsage',this.$formWrap);this.$btnPreHistoryValUsage=$('#btnPreHistoryValUsage',this.$formWrap);this.$ulPreHistoryValUsage=$('#ulPreHistoryValUsage',this.$formWrap);this.$fgWarnRange=$('#fgWarnRange',this.$formWrap);this.$fgWarnTime=$('#fgWarnTime',this.$formWrap);this.$fgWarnTimeRange=$('#fgWarnTimeRange',this.$formWrap);this.$fgPreWarnRange=$('#fgPreWarnRange',this.$formWrap);this.$fgPreWarnTime=$('#fgPreWarnTime',this.$formWrap);this.$fgPreWarnTimeRange=$('#fgPreWarnTimeRange',this.$formWrap);this.$fgiStartMonth=$('#fgiStartMonth',this.$formWrap);this.$iptChartName=$('#iptChartName',this.$formWrap);this.$iptChartLowerLimit=$('#iptChartLowerLimit',this.$formWrap);this.$iptChartUpperLimit=$('#iptChartUpperLimit',this.$formWrap);this.$divTargetPoint=$('#divTargetPoint',this.$formWrap);this.$divReferencePoint=$('#divReferencePoint',this.$formWrap);this.$btnCondition=$('#btnCondition',this.$formWrap);this.$iptConditionVal=$('#iptConditionVal',this.$formWrap);this.$btnIsShowRC=$('#btnIsShowRC',this.$formWrap);this.$iptLowerWarnVal=$('#iptLowerWarnVal',this.$formWrap);this.$iptUpperWarnVal=$('#iptUpperWarnVal',this.$formWrap);this.$iptPreGreaterThan=$('#iptPreGreaterThan',this.$formWrap);this.$iptPreLessThan=$('#iptPreLessThan',this.$formWrap);this.$iptWarnTimeRangeStart=$('#iptWarnTimeRangeStart',this.$formWrap);this.$iptPreWarnTimeRangeStart=$('#iptPreWarnTimeRangeStart',this.$formWrap);this.$dropArea=$('.drop-area',this.$formWrap);this.$btnSubmit=$('#btnSubmit',this.$wrap);this.attachEvents();this.initValidator();$(".datetime").datetimepicker({format:'yyyy-mm-dd',autoclose:true,todayBtn:true,startView:'year',minView:'year',pickerPosition:'top-right'});};ModalKPIConfig.prototype.initValidator=function(){};ModalKPIConfig.prototype.displayField=function(animArr,doAnim){var $animWrap=animArr[0].$ele.parent('.optional');var actionGroup={$show:$(),$hide:$()};var showLen,curShowLen=$animWrap.children('.on').length;var $all;if(doAnim===undefined)doAnim=true;for(var i=0,len=animArr.length;i<len;i++){actionGroup['$'+animArr[i].action]=actionGroup['$'+animArr[i].action].add(animArr[i].$ele);}
showLen=actionGroup.$show.length;if(!doAnim){actionGroup.$hide.removeClass('on').css('display','none');actionGroup.$show.addClass('on').css('display','');$animWrap.height(49*showLen);return;}
$all=actionGroup.$hide.add(actionGroup.$show).filter('.on');$all.filter('.on').eq(0).one('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='opacity'){$all.css('display','none');if(showLen!==curShowLen){$animWrap.height(49*showLen);$animWrap.off('transitionend').on('transitionend',function(e){e=e.originalEvent;if(e.propertyName==='height'){actionGroup.$show.css('display','');window.setTimeout(function(){actionGroup.$show.addClass('on');},0);}
e.stopPropagation();});}else{actionGroup.$show.css('display','');window.setTimeout(function(){actionGroup.$show.addClass('on');},0);}}
e.stopPropagation();});$all.removeClass('on');};ModalKPIConfig.prototype.reset=function(name){var animArr=[];name=typeof name==='string'?[name]:name;if(!name){this.$iptChartName.val('');this.$iptChartLowerLimit.val('');this.$iptChartUpperLimit.val('');this.$divTargetPoint.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');this.$divReferencePoint.attr('data-value','').html('<span class="glyphicon glyphicon-plus"></span>');this.$btnCondition.attr('data-value',0).children('span').eq(0).text('Equal To (=)');this.$iptConditionVal.val('');this.$btnWarnMode.attr('data-value',0).children('span').eq(0).text('From User Input');this.$btnHistoryValUsage.attr('data-value',0).children('span').eq(0).text('Use As Lower Limit');this.$iptWarnTimeRangeStart.val('');this.$iptLowerWarnVal.val('');this.$iptUpperWarnVal.val('');this.$btnPreWarnMode.attr('data-value',0).children('span').eq(0).text('From User Input');this.$iptPreGreaterThan.val('');this.$iptPreLessThan.val('');animArr=[];animArr.push({$ele:this.$fgWarnRange,action:'show'});animArr.push({$ele:this.$fgWarnTime,action:'hide'});animArr.push({$ele:this.$fgWarnTimeRange,action:'hide'});this.displayField(animArr,false);animArr=[];animArr.push({$ele:this.$fgPreWarnRange,action:'show'});animArr.push({$ele:this.$fgPreWarnTime,action:'hide'});animArr.push({$ele:this.$fgPreWarnTimeRange,action:'hide'});this.displayField(animArr,false);}
if(!name||name.indexOf('warn-time')>-1){this.$btnWarnTimeMode.attr('data-value',0);this.$btnWarnTimeMode.children('span').eq(0).text('From User Input');this.$btnHistoryValUsage.attr('data-value',0);this.$btnHistoryValUsage.children('span').eq(0).text('Use As Lower Limit');}
if(!name||name.indexOf('start-month')>-1){this.$btnStartMonth.attr('data-value','');this.$btnStartMonth.children('span').eq(0).text('Start Month');}
if(!name||name.indexOf('pre-warn-time')>-1){this.$btnPreWarnTimeMode.attr('data-value',0);this.$btnPreWarnTimeMode.children('span').eq(0).text('From User Input');}};ModalKPIConfig.prototype.recoverForm=function(form){var name,animArr=[],animArr2=[];var _this=this;if(!form)return;this.$iptChartName.val(form.chartName);this.$iptChartLowerLimit.val(form.chartLowerLimit);this.$iptChartUpperLimit.val(form.chartUpperLimit);name=AppConfig.datasource.getDSItemById(form.targetPointId).alias;this.$divTargetPoint.attr({'data-value':form.targetPointId,'title':name}).html('<span>'+name+'</span>');name=AppConfig.datasource.getDSItemById(form.referencePointId).alias;if(name){this.$divReferencePoint.attr({'data-value':form.referencePointId,'title':name}).html('<span>'+name+'</span>');}
this.$btnCondition.attr('data-value',form.referenceCondition).children('span').eq(0).text(form.referenceConditionName);this.$iptConditionVal.val(form.referenceConditionVal);this.$btnDataCycleMode.attr('data-value',form.dataCycleMode).children('span').eq(0).text(form.dataCycleModeName);this.$btnWarnMode.attr('data-value',form.warnMode).children('span').eq(0).text(form.warnModeName);this.$btnWarnTimeMode.attr('data-value',form.warnTimeMode).children('span').eq(0).text(form.warnTimeModeName);this.$btnHistoryValUsage.attr('data-value',form.historyValUsage).children('span').eq(0).text(form.historyValUsageName);this.$iptWarnTimeRangeStart.val(form.warnTimeRangeStart);if(form.warnMode===1){animArr.push({$ele:this.$fgWarnRange,action:'hide'});animArr.push({$ele:this.$fgWarnTime,action:'show'});if(form.warnTimeMode===0){animArr.push({$ele:this.$fgWarnTimeRange,action:'show'});}else{animArr.push({$ele:this.$fgWarnTimeRange,action:'hide'});}
window.setTimeout(function(){_this.displayField(animArr);},1200);}
this.$iptLowerWarnVal.val(form.warnLowerLimit);this.$iptUpperWarnVal.val(form.warnUpperLimit);this.$btnPreWarnMode.attr('data-value',form.preWarnMode).children('span').eq(0).text(form.preWarnModeName);this.$iptPreGreaterThan.val(form.preGreaterThan);this.$iptPreLessThan.val(form.preLessThan);this.$btnPreWarnTimeMode.attr('data-value',form.preWarnTimeMode).children('span').eq(0).text(form.preWarnTimeModeName);this.$btnPreHistoryValUsage.attr('data-value',form.preHistoryValUsage).children('span').eq(0).text(form.preHistoryValUsageName);this.$iptPreWarnTimeRangeStart.val(form.preWarnTimeRangeStart);if(form.preWarnMode===1){animArr2.push({$ele:this.$fgPreWarnRange,action:'hide'});animArr2.push({$ele:this.$fgPreWarnTime,action:'show'});if(form.preWarnTimeMode===0){animArr2.push({$ele:this.$fgPreWarnTimeRange,action:'show'});}else{animArr2.push({$ele:this.$fgPreWarnTimeRange,action:'hide'});}
window.setTimeout(function(){_this.displayField(animArr2);},1200);}};ModalKPIConfig.prototype.setOptions=function(options){this.options=$.extend({},this.options,options);};ModalKPIConfig.prototype.attachEvents=function(){$('.dropdown-menu',this.$wrap).off('click.selected').on('click.selected','a',function(e){var $this=$(this);var $btn=$this.parents('.dropdown-wrap').children('button');var value=$this.attr('data-value');var text=$this.text();$btn.attr('data-value',value);$btn.children('span').eq(0).text(text);e.preventDefault();});this.$modal.off('show.bs.modal').on('show.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.recoverForm(_this.options.modalIns.entity.modal.option);if(!$rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$modal.off('hide.bs.modal').on('hide.bs.modal',function(e){var $rightCt;if(e.namespace!=='bs.modal')return true;$rightCt=$('#rightCt');_this.reset();if($rightCt.hasClass('rightCtOpen'))$rightCt.click();});this.$ulWarnMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnWarnMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnWarnMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgWarnRange,action:'show'});animArr.push({$ele:_this.$fgWarnTime,action:'hide'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'hide'});}else{_this.reset(['warn-time']);animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'show'});}
_this.displayField(animArr);});this.$ulWarnTimeMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnWarnTimeMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnWarnTimeMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'show'});}else{animArr.push({$ele:_this.$fgWarnRange,action:'hide'});animArr.push({$ele:_this.$fgWarnTime,action:'show'});animArr.push({$ele:_this.$fgWarnTimeRange,action:'hide'});}
_this.displayField(animArr);});this.$ulPreWarnMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnPreWarnMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnPreWarnMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgPreWarnRange,action:'show'});animArr.push({$ele:_this.$fgPreWarnTime,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'hide'});}else{_this.reset('pre-warn-time');animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'show'});}
_this.displayField(animArr);});this.$ulPreWarnTimeMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnPreWarnTimeMode.attr('data-value'));var animArr=[];if(value===lastValue)return;_this.$btnPreWarnTimeMode.attr('data-value',value);if(value===0){animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'show'});}else{animArr.push({$ele:_this.$fgPreWarnRange,action:'hide'});animArr.push({$ele:_this.$fgPreWarnTime,action:'show'});animArr.push({$ele:_this.$fgPreWarnTimeRange,action:'hide'});}
_this.displayField(animArr);});this.$ulDataCycleMode.find('a').off().on('click',function(e){var value=parseInt($(this).attr('data-value'));var lastValue=parseInt(_this.$btnDataCycleMode.attr('data-value'));var lastMonth,lastMonth2,nowMonth,lang,arrHtml=[];var liTmpl='<li><a href="javascript:;" data-value="{0}">{1}</a></li>';if(value===lastValue)return;_this.$btnDataCycleMode.attr('data-value',value);if(value===0)_this.$fgiStartMonth.removeClass('on');else{lang=I18n.type
nowMonth=DateUtil.getNextMonth(new Date().getMonth());lastMonth=DateUtil.getLastMonth(nowMonth);lastMonth2=DateUtil.getLastMonth(lastMonth);arrHtml.push(liTmpl.format(lastMonth2,DateUtil.getMonthNameShort(lastMonth2-1,lang)));arrHtml.push(liTmpl.format(lastMonth,DateUtil.getMonthNameShort(lastMonth-1,lang)));arrHtml.push(liTmpl.format(nowMonth,DateUtil.getMonthNameShort(nowMonth-1,lang)));_this.$ulStartMonth.html(arrHtml.join(''));_this.reset('start-month');_this.$fgiStartMonth.addClass('on');}});this.$dropArea.off('dragover').on('dragover',function(e){e.preventDefault();});this.$dropArea.off('dragenter').on('dragenter',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});this.$dropArea.off('dragleave').on('dragleave',function(e){$(e.target).removeClass('on');e.stopPropagation();});this.$dropArea.off('drop').on('drop',function(e){var transfer=e.originalEvent.dataTransfer;var itemId=transfer.getData('dsItemId');var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');name=AppConfig.datasource.getDSItemById(itemId).alias;$target.attr({'data-value':itemId,'title':name});$target.html('<span>'+name+'</span>');e.stopPropagation();});this.$btnSubmit.off().click(function(){var form={};form.chartName=_this.$iptChartName.val();form.chartLowerLimit=parseFloat(_this.$iptChartLowerLimit.val());form.chartUpperLimit=parseFloat(_this.$iptChartUpperLimit.val());form.targetPointId=_this.$divTargetPoint.attr('data-value');form.referencePointId=_this.$divReferencePoint.attr('data-value');form.referenceCondition=parseInt(_this.$btnCondition.attr('data-value'));form.referenceConditionName=_this.$btnCondition.children('span').eq(0).text();form.referenceConditionVal=parseFloat(_this.$iptConditionVal.val());form.dataCycleMode=parseInt(_this.$btnDataCycleMode.attr('data-value'));form.dataCycleModeName=_this.$btnDataCycleMode.children('span').eq(0).text();form.btnStartMonth=_this.$btnStartMonth.attr('data-value');form.warnMode=parseInt(_this.$btnWarnMode.attr('data-value'));form.warnModeName=_this.$btnWarnMode.children('span').eq(0).text();form.isShowRC=parseInt(_this.$btnIsShowRC.attr('data-value'));form.isShowRCName=_this.$btnIsShowRC.children('span').eq(0).text();form.warnLowerLimit=parseFloat(_this.$iptLowerWarnVal.val());form.warnUpperLimit=parseFloat(_this.$iptUpperWarnVal.val());form.warnTimeMode=parseInt(_this.$btnWarnTimeMode.attr('data-value'));form.warnTimeModeName=_this.$btnWarnTimeMode.children('span').eq(0).text();form.historyValUsage=parseInt(_this.$btnHistoryValUsage.attr('data-value'));form.historyValUsageName=_this.$btnHistoryValUsage.children('span').eq(0).text();form.warnTimeRangeStart=_this.$iptWarnTimeRangeStart.val();form.preWarnMode=parseInt(_this.$btnPreWarnMode.attr('data-value'));form.preWarnModeName=_this.$btnPreWarnMode.children('span').eq(0).text();form.preGreaterThan=parseFloat(_this.$iptPreGreaterThan.val());form.preLessThan=parseFloat(_this.$iptPreLessThan.val());form.preWarnTimeMode=parseInt(_this.$btnPreWarnTimeMode.attr('data-value'));form.preWarnTimeModeName=_this.$btnPreWarnTimeMode.children('span').eq(0).text();form.preHistoryValUsage=parseInt(_this.$btnPreHistoryValUsage.attr('data-value'));form.preHistoryValUsageName=_this.$btnPreHistoryValUsage.children('span').eq(0).text();form.preWarnTimeRangeStart=_this.$iptPreWarnTimeRangeStart.val();_this.options.onSubmit.call(_this.options.modalIns,form);_this.$btnClose.trigger('click');});};ModalKPIConfig.prototype.detachEvents=function(){};ModalKPIConfig.prototype.destroy=function(){this.detachEvents();this.$wrap.remove();};var DEFAULTS={};return ModalKPIConfig;}(jQuery,window));var ModalKPIChart=(function($){var PRECISION=2;function ModalKPIChart(screen,entityParams){ModalBase.call(this,screen,entityParams,this._render,null,this._showConfig);this.options=$.extend(true,{},DEFAULTS);this.historyChartOptions=$.extend(true,{},HISTORY_CHART_DEFAULTS);this.startline=null;this.endline=null;this.targetPointData=null;this.referencePointData=null;this.refreshTimesInOneHour=1;this.period=null;this.indicators={};this.samplingPeriod={format:'h1',value2ms:3600000};this.historyChart=null;this.$lkUpdateTime=null;this.m_bIsGoBackTrace=false;this.m_traceData=undefined;}
ModalKPIChart.prototype=Object.create(ModalBase.prototype);ModalKPIChart.prototype.constructor=ModalKPIChart;ModalKPIChart.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_KPI_CHART',parent:0,mode:'custom',maxNum:1,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalKPIChart'};ModalKPIChart.prototype.init=function(){var $panel=$(this.container).closest('.panel');this.$lkUpdateTime=$('<div class="lk-update-time" title="Last Update Time"><span class="glyphicon glyphicon-time"></span><span>updating...</span></div>').appendTo($panel);};ModalKPIChart.prototype._render=function(){var _this=this;var option=this.entity.modal.option;var min=option.chartLowerLimit||0;var max=option.chartUpperLimit||100;var warnMode=option.warnMode;var warnLower=option.warnLowerLimit;var warnUpper=option.warnUpperLimit;var preWarnMode=option.preWarnMode;var preWarnLower=warnLower+option.preGreaterThan;var preWarnUpper=warnUpper-option.preLessThan;var historyValUsage=option.historyValUsage;var targetPointId=option.targetPointId;var referencePointId=option.referencePointId;var dataCycleMode=option.dataCycleMode;var period=this.period=this.getTimePeriod();var postData;var ids=referencePointId?[targetPointId,referencePointId]:[targetPointId];postData=[{dsItemIds:ids,timeStart:period.nowStart,timeEnd:period.nowEnd,timeFormat:this.samplingPeriod.format}];if(warnMode===1){postData.push({dsItemIds:ids,timeStart:period.refStart,timeEnd:period.refEnd,timeFormat:this.samplingPeriod.format});}
this.init();this.options.series[0].data[0].value=min;this.options.series[0].min=min;this.options.series[0].max=max;this.historyChartOptions.yAxis[0].min=min;this.historyChartOptions.yAxis[0].max=max;this.options.tooltip.formatter=function(p){return p.seriesName+': <strong>'+p.value+'</strong><br/>From: '+
_this.store.timeShaft[0]+'<br/>To: '+_this.store.timeShaft[_this.store.timeShaft.length-1];};this.spinner.spin(this.container);WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(rs){var axisColor=_this.options.series[0].axisLine.lineStyle.color;var range=max-min;var maxIndex;rs=JSON.parse(rs);_this.store={list:{},timeShaft:rs[0].timeShaft};for(var i=0,len=rs[0].list.length;i<len;i++){_this.store.list[rs[0].list[i].dsItemId]=rs[0].list[i].data;}
if(rs[1]!==undefined){_this.store2={list:{},timeShaft:rs[1].timeShaft};for(i=0,len=rs[1].list.length;i<len;i++){_this.store2.list[rs[1].list[i].dsItemId]=rs[1].list[i].data;}}
_this.filterPointData();_this.initIndicators();_this.setTimeParams();maxIndex=_this.store.fullTimeShaft.length-1;if(warnMode===0){if(warnLower!==undefined&&(warnLower-min)>0){axisColor.push([(warnLower-min)/range,'#ff4500']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Warn Line',value:warnLower,xAxis:0,yAxis:warnLower,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:warnLower}]);}
if(preWarnLower!==undefined&&(preWarnLower-min)>0){axisColor.push([(preWarnLower-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:preWarnLower,xAxis:0,yAxis:preWarnLower,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnLower}]);}
if(preWarnUpper!==undefined&&(preWarnUpper-min)>0){axisColor.push([(preWarnUpper-min)/range,'lightgreen']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:preWarnUpper,xAxis:0,yAxis:preWarnUpper,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:maxIndex,yAxis:preWarnUpper}]);}
if(warnUpper!==undefined&&(warnUpper-min)>0){axisColor.push([(warnUpper-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Warn Line',value:warnUpper,xAxis:0,yAxis:warnUpper,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:maxIndex,yAxis:warnUpper}]);}
axisColor.push([1,'#ff4500']);}
else{if(historyValUsage===0){axisColor.push([(_this.indicators.average2-min)/range,'#ff4500']);if(preWarnMode===0){preWarnLower=_this.indicators.average2+option.preGreaterThan;if(preWarnLower!==undefined&&(preWarnLower-min)>0){axisColor.push([(preWarnLower-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:preWarnLower.toFixed(PRECISION),xAxis:0,yAxis:preWarnLower,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnLower}]);}}else if(preWarnMode===1&&_this.indicators.preWarnValue>_this.indicators.average2){axisColor.push([(_this.indicators.preWarnValue-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Pre-Warn Line',value:_this.indicators.preWarnValue.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.preWarnValue,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.preWarnValue}]);}
axisColor.push([1,'lightgreen']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Lower Warn Line',value:_this.indicators.average2.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.average2,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.average2}]);}
else{if(preWarnMode===0){preWarnUpper=_this.indicators.average2-option.preLessThan;if(preWarnUpper!==undefined&&(preWarnUpper-min)>0){axisColor.push([(preWarnUpper-min)/range,'lightgreen']);axisColor.push([(_this.indicators.average2-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:preWarnUpper.toFixed(PRECISION),xAxis:0,yAxis:preWarnUpper,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:preWarnUpper}]);}}else if(preWarnMode===1&&_this.indicators.preWarnValue<_this.indicators.average2){axisColor.push([(_this.indicators.preWarnValue-min)/range,'lightgreen']);axisColor.push([(_this.indicators.average2-min)/range,'orange']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Pre-Warn Line',value:_this.indicators.preWarnValue.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.preWarnValue,itemStyle:{normal:{color:'orange',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.preWarnValue}]);}else{axisColor.push([(_this.indicators.average2-min)/range,'lightgreen']);}
axisColor.push([1,'#ff4500']);_this.historyChartOptions.series[0].markLine.data.push([{name:'Upper Warn Line',value:_this.indicators.average2.toFixed(PRECISION),xAxis:0,yAxis:_this.indicators.average2,itemStyle:{normal:{color:'#ff4500',lineStyle:{type:'solid'}}}},{xAxis:_this.store.deadline,yAxis:_this.indicators.average2}]);}}
_this.fitContainer();var cha=echarts.init(_this.container,AppConfig.chartTheme);cha.clear();_this.chart=cha.setOption(_this.options);_this.reloadChart();}).always(function(){_this.spinner.stop();});};ModalKPIChart.prototype.filterPointData=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var cond=option.referenceCondition;var condVal=option.referenceConditionVal;var tPoints=null,rPoints=null;if(!option.referencePointId)return;tPoints=this.store.list[option.targetPointId];rPoints=this.store.list[option.referencePointId];if(tPoints.length!==rPoints.length)return;for(var i=0,len=rPoints.length;i<len;i++){tPoints[i]=parseFloat(tPoints[i]);rPoints[i]=parseFloat(rPoints[i]);if(!this.isPointRuled(rPoints[i],condVal,cond)){tPoints[i]='-';}}
if(warnMode===1){tPoints=this.store2.list[option.targetPointId];rPoints=this.store2.list[option.referencePointId];if(tPoints.length!==rPoints.length)return;for(var i=0,len=rPoints.length;i<len;i++){tPoints[i]=parseFloat(tPoints[i]);rPoints[i]=parseFloat(rPoints[i]);if(!this.isPointRuled(rPoints[i],condVal,cond)){tPoints[i]='-';}}}};ModalKPIChart.prototype.isPointRuled=function(pointVal,condVal,cond){if(condVal===null)return true;switch(cond){case 0:return pointVal===condVal;case 1:return pointVal<condVal;case 2:return pointVal>condVal;default:return true;}};ModalKPIChart.prototype.setAnimation=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var historyValUsage=option.historyValUsage;var warnLower=option.warnLowerLimit;var warnUpper=option.warnUpperLimit;var preWarnLower=warnLower+option.preGreaterThan;var preWarnUpper=warnUpper-option.preLessThan;var $parent=$(this.container).parents('.panel');var curVal=this.indicators.average;$parent.removeClass('warn-anim pre-warn-anim');if(warnMode===1){if((historyValUsage===0&&curVal<this.indicators.average2)||(historyValUsage===1&&curVal>this.indicators.average2)){$parent.addClass('warn-anim');}}else{switch(true){case curVal<preWarnLower:$parent.addClass('pre-warn-anim');break;case curVal<warnLower:$parent.addClass('warn-anim');break;case curVal<preWarnUpper:break;case curVal<warnUpper:$parent.addClass('pre-warn-anim');break;default:$parent.addClass('warn-anim');break;}}};ModalKPIChart.prototype.update=function(rs){var option=this.entity.modal.option;var targetPointId=option.targetPointId;var referencePointId=option.referencePointId;var targetPointData,referencePointData;var lastTick,nowTick;if(!this.store)return;lastTick=this.store.timeShaft[this.store.timeShaft.length-1];lastTick=lastTick.toDate().valueOf()+60000;nowTick=new Date().valueOf();if(nowTick<lastTick){return;}
for(var i=0,len=rs.length;i<len;i++){if(targetPointId===rs[i].dsItemId){targetPointData=parseFloat(rs[i].data);}
if(referencePointId===rs[i].dsItemId){referencePointData=parseFloat(rs[i].data);}}
if(isNaN(targetPointData))return;this.appendData(targetPointData,referencePointData);this.reloadChart();};ModalKPIChart.prototype.reloadChart=function(){this.options.series[0].data[0].value=this.indicators.average.toFixed(PRECISION);this.chart.setSeries(this.options.series,true);this.setAnimation();this.$lkUpdateTime.children('span').eq(1).text(new Date().format('HH:mm'));};ModalKPIChart.prototype._showConfig=function(){};ModalKPIChart.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalKPIChart.prototype.setOptions=function(options){this.options=$.extend({},this.opitons,options);};ModalKPIChart.prototype.destroy=function(){};ModalKPIChart.prototype.saveConfig=function(form){this.entity.modal.title=form.chartName;this.entity.modal.points=[form.targetPointId];if(form.referencePointId)this.entity.modal.points.push(form.referencePointId);this.entity.modal.option=form;this.entity.modal.interval=60000;};ModalKPIChart.prototype.configModal=new ModalKPIConfig({onSubmit:function(form){this.saveConfig(form);}});ModalKPIChart.prototype.getTimePeriod=function(){var now;var period={};var option=this.entity.modal.option;var warnMode=option.warnMode;var historyValUsage=option.historyValUsage;var warnStart=option.warnTimeRangeStart;var warnTimeMode=option.warnTimeMode;var startDate=option.warnTimeRangeStart;var circleMode=option.dataCycleMode;var startMonth;if(!this.m_bIsGoBackTrace){now=new Date();this.DEFAULTS=true;this.HISTORY_CHART_DEFAULTS=true;}
else{now=this.m_traceData.currentTime;this.DEFAULTS=false;this.HISTORY_CHART_DEFAULTS=false;}
if(circleMode===0){period.nowStart=now.format('yyyy-MM-01 00:00:00');period.nowEnd=now.format('yyyy-MM-dd HH:mm:ss');if(warnMode===0)return period;if(warnTimeMode===0){period.refStart=warnStart.toDate().format('yyyy-MM');period.refEnd=period.refStart+'-'+DateUtil.daysInMonth(period.refStart.toDate())+' 23:59:59';period.refStart+='-01 00:00:00';}else{period.refStart=(now.format('yyyy')-1)+now.format('-MM');period.refEnd=period.refStart+'-'+DateUtil.daysInMonth(period.refStart.toDate())+' 23:59:59';period.refStart+='-01 00:00:00';}
period.lag=period.nowStart.toDate().valueOf()-period.refStart.toDate().valueOf();}
else{}
return period;};ModalKPIChart.prototype.initIndicators=function(){var option=this.entity.modal.option;var warnMode=option.warnMode;var preWarnMode=option.preWarnMode;var dsId=option.targetPointId;var data=this.store.list[dsId];var average=0,sum=0;var list1,list2;for(var i=0,len=data.length;i<len;i++){if(isNaN(data[i]))continue;average+=data[i]*1;};if(isNaN(average))this.indicators.average=this.entity.modal.option.chartLowerLimit;else this.indicators.average=average/len;if(warnMode===1){average=0;data=this.store2.list[dsId];for(var i=0,len=data.length;i<len;i++){if(isNaN(parseFloat(data[i])))continue;average+=data[i]*1;};if(isNaN(average))this.indicators.average2=this.entity.modal.option.chartLowerLimit;else this.indicators.average2=average/len;}
if(preWarnMode===1){this.setPreWarnValue();}};ModalKPIChart.prototype.setPreWarnValue=function(){var option=this.entity.modal.option;var targetPointId=option.targetPointId;var warnMode=option.warnMode;var preHistoryValUsage=option.preHistoryValUsage;var list1=this.store.list[targetPointId];var list2=this.store2.list[targetPointId];var average=0;var sum=0;var validNum=0;for(var i=0,len1=list1.length,len2=list2.length;i<len2;i++){if(i>=len1){if(isNaN(list2[i]))continue;sum+=list2[i];}else{if(isNaN(list1[i]))continue;sum+=list1[i];}
validNum+=1;}
if(warnMode===1){this.indicators.preWarnValue=this.indicators.average+this.indicators.average2-sum/validNum;}else{if(preHistoryValUsage===0){this.indicators.preWarnValue=this.indicators.average+option.warnLowerLimit-sum/validNum;}else{this.indicators.preWarnValue=this.indicators.average+option.warnUpperLimit-sum/validNum;}}};ModalKPIChart.prototype.appendData=function(tValue,rValue){var lastTick=this.store.timeShaft[this.store.timeShaft.length-1];var option=this.entity.modal.option;var preWarnMode=option.preWarnMode;var targetPointId=option.targetPointId;var targetPointList=this.store.list[targetPointId];var cond=option.referenceCondition;var condVal=option.referenceConditionVal;var len=this.store.list[targetPointId].length;var nowStr=new Date().format('yyyy-MM-dd HH:00:00')
var lastValue,newLastValue;var timeStamp;if(isNaN(rValue)||this.isPointRuled(rValue,condVal,cond)){tValue=tValue.toFixed(3)*1;if(lastTick!==nowStr){timeStamp=lastTick.toDate().valueOf();if((nowStr.toDate().valueOf()-timeStamp)>3600000){this.store.timeShaft.push(new Date(timeStamp+3600000).format('yyyy-MM-dd HH:00:00'));}
this.store.timeShaft.push(nowStr);this.refreshTimesInOneHour=0;this.indicators.average=(this.indicators.average*len+tValue)/(len+1);targetPointList.push(tValue);}else{lastValue=targetPointList[targetPointList.length-1]
newLastValue=(lastValue*this.refreshTimesInOneHour+tValue)/(this.refreshTimesInOneHour+1);targetPointList[targetPointList.length-1]=newLastValue.toFixed(3)*1;this.indicators.average=(this.indicators.average*len-lastValue+newLastValue)/len;this.refreshTimesInOneHour+=1;}
if(preWarnMode===1){this.setPreWarnValue();}}};ModalKPIChart.prototype.setTimeParams=function(){var lastTick=this.store.timeShaft[this.store.timeShaft.length-1].toDate().valueOf();var option=this.entity.modal.option;var tick=lastTick+this.samplingPeriod.value2ms;var now=new Date();this.store.fullTimeShaft=this.store.timeShaft.concat();if(option.dataCycleMode===0){this.store.deadline=now.format('yyyy-MM-'+DateUtil.daysInMonth(now)+' 23:55:00').toDate();while(tick<=this.store.deadline){tick+=this.samplingPeriod.value2ms;this.store.fullTimeShaft.push(tick.toDate().format('yyyy-MM-dd HH:mm:ss'));}}
else{}};ModalKPIChart.prototype.fitContainer=function(){var row=this.entity.spanR;var column=this.entity.spanC;if(Math.min(row,column)<3){this.options.series[0].splitLine.length=15;this.options.series[0].axisLine.lineStyle.width=15;this.options.series[0].axisTick.length=4;this.options.series[0].pointer.width=4;this.options.series[0].detail.textStyle.fontSize=20;}};ModalKPIChart.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this._render();this.m_bIsGoBackTrace=false;};var DEFAULTS={tooltip:{},series:[{name:'KPI Indicator',type:'gauge',precision:2,splitNumber:10,startAngle:140,endAngle:-140,axisLine:{show:true,lineStyle:{width:30,color:[]}},axisTick:{show:true,splitNumber:5,length:8,lineStyle:{color:'#eee',width:1,type:'solid'}},splitLine:{show:true,length:30,lineStyle:{color:'#eee',width:2,type:'solid'}},pointer:{length:'80%',width:8},detail:{offsetCenter:['-65%',-15],textStyle:{fontSize:30}},data:[{name:''}]}],animation:true};var HISTORY_CHART_DEFAULTS={title:{text:'History Data'},legend:{data:['Target Point']},tooltip:{trigger:'axis'},dataZoom:{show:false,realtime:true,start:0,end:100},grid:{y2:80},xAxis:[{type:'category'}],yAxis:[{type:'value'}],series:[{name:'Target Point',type:'line',symbolSize:0,markLine:{precision:3,symbol:'none',data:[]},markPoint:{symbol:'emptyCircle',effect:{show:true,shadowBlur:0},data:[]}}],animation:true};return ModalKPIChart;}(jQuery));var ModalObserverConfig=(function($,window,undefined){var _this;function ModalObserverConfig(options){_this=this;this.options=$.extend({},DEFAULTS,options);this.$wrap=null;}
ModalObserverConfig.prototype.show=function(){var domPanelContent=document.getElementById('paneContent');if($('#modalObserverConfigWrap').length>0){this.$modal.modal('show');return;}
Spinner.spin(domPanelContent);WebAPI.get('/static/views/observer/widgets/modalObserverConfig.html').done(function(html){_this.$wrap=$('<div class="modal-observer-config-wrap" id="modalObserverConfigWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');WebAPI.get("/get_s3db_pages/"+AppConfig.projectId+"/"+AppConfig.userId).done(function(result){_this.init(result.pages);_this.$modal.modal('show');}).always(function(msg){Spinner.stop();});});};ModalObserverConfig.prototype.init=function(data){this.$formWrap=$('#obFormWrap','#modalObserverConfigWrap');this.$btnClose=$('.close','#modalObserverConfigWrap');this.$sltObserverId=$('#sltObserverId','#obFormWrap');this.$btnSubmit=$('#btnObSubmit','#modalObserverConfigWrap');var sb=new StringBuilder();for(var i=0,item,len=data.length;i<len;i++){item=data[i];sb.append('<option value="').append(item.id).append('">').append(item.name+' (width: '+item.width+', height: '+item.height+')</option>');}
this.$sltObserverId.html(sb.toString());this.attachEvents();};ModalObserverConfig.prototype.attachEvents=function(){this.$btnSubmit.off().click(function(e){var form={};form.id=_this.$sltObserverId.val().trim();_this.options.onSubmit.call(_this.options.modalIns,form);_this.$btnClose.trigger('click');e.preventDefault();});};ModalObserverConfig.prototype.setOptions=function(options){this.options=$.extend({},this.options,options);};var DEFAULTS={};return ModalObserverConfig;}(jQuery,window));var ModalObserver=(function ModalObserver($,window,undefined){function ModalObserver(screen,entityParams){ModalBase.call(this,screen,entityParams,this._render,null,this._showConfig);this.options=$.extend(true,{},DEFAULTS);this.obScreen=null;};ModalObserver.prototype=Object.create(ModalBase.prototype);ModalObserver.prototype.constructor=ModalObserver;ModalObserver.prototype.optionTemplate={name:'toolBox.modal.OBSERVER',parent:0,mode:'custom',maxNum:1,title:'',minHeight:1,minWidth:1,maxHeight:6,maxWidth:12,type:'ModalObserver'};ModalObserver.prototype._render=function(){var options=this.entity.modal.option;var id=options.id||'200000360';this.obScreen=new ObserverScreen(id);this.container=$(this.container).html('<div class="divMain" style="width: 100%; height: 100%;">\
                <div class="div-canvas-ctn" style="padding: 0; margin: 0 auto; height: 100%; width: 100%;">\
                    <canvas class="canvas-ctn" style="width: 100%; height: 100%;">浏览器不支持</canvas>\
                </div>\
                <div id="divObserverTools" style="height: 0"></div>\
            </div>')[0];this.obScreen.isInDashBoard=true;this.obScreen.show(this.container);};ModalObserver.prototype._showConfig=function(){};ModalObserver.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalObserver.prototype.saveConfig=function(form){this.entity.modal.option=form;this.entity.modal.points=[];};ModalObserver.prototype.configModal=new ModalObserverConfig({onSubmit:function(form){this.saveConfig(form);}});ModalObserver.prototype._close=function(){if(this.obScreen)this.obScreen.close();};var DEFAULTS={};return ModalObserver;}(jQuery,window));var ModalMultiple=(function(){function ModalMultiple(screen,entityParams,_renderModal,_updateModal,_showConfigMode){if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalMultiple.prototype=new ModalRealtimeLine();ModalMultiple.prototype.optionTemplate={name:'toolBox.modal.MULTIPLE',parent:0,mode:['multiple'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMultiple',modelParams:{paraName:['line','bar','area','cumulativeBar'],paraShowName:{'line':'Line Chart Parameters','bar':"Bar Chart Parameters",'area':"Area Chart Parameters",'cumulativeBar':"Cumulative Bar Chart Parameters"},paraAnlysMode:'part'}};ModalMultiple.prototype.renderModal=function(){this.isFirstRender=true;};ModalMultiple.prototype.updateModal=function(points){if(points.length<1)return;var _this=this;if(this.isFirstRender){var pointNameList=(function(points){var arr=[];for(var i=0;i<points.length;i++){arr.push(points[i].dsItemId)}
return arr;})(points);var endTime;if(!_this.m_bIsGoBackTrace){endTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=true;}
else{this.m_bIsGoBackTrace=false;endTime=new Date(_this.m_traceData.currentTime).format('yyyy-MM-dd HH:mm:ss');_this.optionDefault.animation=false;}
var startTime=endTime.split(' ')[0]+' 01:00:00';WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:pointNameList,timeStart:startTime,timeEnd:endTime,timeFormat:'h1'}).done(function(result){var dataSrc=JSON.parse(result);if(dataSrc==undefined||dataSrc.length<=0){return;}
var entityItem=_this.dealWithData(dataSrc,2);var option={legend:{data:entityItem.arrLegend},grid:{x:70,y:34,x2:50,y2:24},xAxis:[{data:['01:00','02:00','03:00','04:00','05:00','06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00','19:00','20:00','21:00','22:00','23:00','24:00'],boundaryGap:true}],yAxis:[{type:'value',scale:false,splitArea:{show:false}},{type:'value',scale:false,splitArea:{show:false}}],series:entityItem.arrSeries};var optionTemp={};$.extend(true,optionTemp,_this.optionDefault);if(_this.entity.modal.dsChartCog){var ptIndex=0;if(_this.entity.modal.dsChartCog[0].upper!=''){option.yAxis[1].max=Number(_this.entity.modal.dsChartCog[0].upper);}
if(_this.entity.modal.dsChartCog[0].lower!=''){option.yAxis[1].min=Number(_this.entity.modal.dsChartCog[0].lower);}
if(_this.entity.modal.dsChartCog[0].unit!=''){option.yAxis[1].name=_this.entity.modal.dsChartCog[0].unit;}
if(_this.entity.modal.dsChartCog[0].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[0].accuracy);for(var i=0;i<_this.entity.modal.option.paraType[0].arrId.length;i++){for(var j=0;j<option.series[ptIndex].data.length;j++){option.series[ptIndex].data[j]=Number(option.series[ptIndex].data[j]).toFixed(n);}
ptIndex+=1;}}
var tempChartMax,tempChartMin;for(var m=1;m<4;++m){tempChartMax=null;tempChartMin=null;if(_this.entity.modal.dsChartCog[m].upper!=''){if(tempChartMax==null||tempChartMax<Number(_this.entity.modal.dsChartCog[m].upper)){tempChartMax=Number(_this.entity.modal.dsChartCog[m].upper);}}
if(_this.entity.modal.dsChartCog[m].lower!=''){if(tempChartMin==null||tempChartMin>Number(_this.entity.modal.dsChartCog[m].lower)){tempChartMin=Number(_this.entity.modal.dsChartCog[m].lower);}}
if(_this.entity.modal.dsChartCog[m].unit!=''){option.yAxis[0].name=_this.entity.modal.dsChartCog[m].unit;}
if(_this.entity.modal.dsChartCog[m].accuracy!=''){var n=Number(_this.entity.modal.dsChartCog[m].accuracy);for(var i=0;i<_this.entity.modal.option.paraType[m].arrId.length;i++){for(var j=0;j<option.series[ptIndex].data.length;j++){option.series[ptIndex].data[j]=Number(option.series[ptIndex].data[j]).toFixed(n);}
ptIndex+=1;}}}
if(tempChartMax!=null){option.yAxis[0].max=Number(tempChartMax);}
if(tempChartMin!=null){option.yAxis[0].min=Number(tempChartMin);}
var tempMarkLine;for(var l=0;l<4;l++){for(var k=0;k<4;k++){if(_this.entity.modal.dsChartCog[l].markLine[k].value!=''){for(var index=0;index<_this.entity.modal.option.paraType[l].arrId.length;++index){if(!option.series[l+index].markLine){option.series[l+index].markLine={data:[],symbol:'none',itemStyle:{normal:{label:{show:false}}}}}
tempMarkLine=[{name:_this.entity.modal.dsChartCog[l].markLine[k].name,value:_this.entity.modal.dsChartCog[l].markLine[k].value,xAxis:-1,yAxis:Number(_this.entity.modal.dsChartCog[l].markLine[k].value)},{xAxis:dataSrc.timeShaft.length,yAxis:Number(_this.entity.modal.dsChartCog[l].markLine[k].value)}];option.series[l+index].markLine.data.push(tempMarkLine);}}}}}
var cha=echarts.init(_this.container,AppConfig.chartTheme);cha.clear();_this.chart=cha.setOption($.extend(true,{},optionTemp,option));_this.isFirstRender=false;}).error(function(e){}).always(function(e){});}else{var crtHour=new Date().getHours();if(points&&points.length>0&&this.chart.getSeries()[0].data.length<crtHour){this.chart.addData(this.dealWithAddData(points,2));}
if(this.chart.getSeries()[0].data.length>23){this.isFirstRender=true;}}};ModalMultiple.prototype.dealWithData=function(points){if(points.error){this.container.innerHTML='<div id="dataAlert" ></div>';new Alert($("#dataAlert"),"danger","<strong>"+points.error+"</strong>").show();return;}
var arr={arrLegend:{},arrSeries:{}};arr.arrLegend=[];arr.arrSeries=[];var arrTempPoints=[];var dataType=this.entity.modal.option.paraType;for(var i=0;i<dataType.length;++i){for(var j=0;j<dataType[i].arrId.length;++j)
arrTempPoints.push({dsItemId:dataType[i].arrId[j]})}
var arrPointAlias=this.initPointAlias(arrTempPoints);var tempNum=0;for(var i=0;i<dataType.length;i++){switch(dataType[i].type){case'bar':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'bar',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'line':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'line',symbol:'none',smooth:true,data:points.list[k].data,yAxisIndex:1,z:3}
arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'area':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'line',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0,z:3};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;case'cumulativeBar':for(var j=0;j<dataType[i].arrId.length;j++){for(var k=0;k<points.list.length;++k){if(dataType[i].arrId[j]==points.list[k].dsItemId){var series={name:arrPointAlias[tempNum],type:'bar',stack:'实时累计图',symbol:'none',itemStyle:{normal:{areaStyle:{type:'default'}}},smooth:true,data:points.list[k].data,yAxisIndex:0};arr.arrLegend.push(arrPointAlias[tempNum]);arr.arrSeries.push(series);tempNum+=1;break;}}}
break;}}
return arr;},ModalMultiple.prototype.setModalOption=function(option){this.entity.modal.option={};this.entity.modal.interval=5;this.entity.modal.option.paraType=option.paraType};ModalMultiple.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();};return ModalMultiple;})();var ModalPredictPointLineConfig=(function($,window,undefined){var _this;function ModalPredictPointLineConfig(options){_this=this;ModalConfig.call(this,options);}
ModalPredictPointLineConfig.prototype=Object.create(ModalConfig.prototype);ModalPredictPointLineConfig.prototype.constructor=ModalPredictPointLineConfig;ModalPredictPointLineConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalPredictPointLineConfig.html'};ModalPredictPointLineConfig.prototype.init=function(){this.$formWrap=$('.form-wrap',this.$wrap);this.$iptChartYaxisMin=$('.ipt-chart-y-axis-min',this.$formWrap);this.$iptChartYaxisMax=$('.ipt-chart-y-axis-max',this.$formWrap);this.$iptChartValUnits=$('.ipt-chart-val-units',this.$formWrap);this.$iptChartValPrecision=$('.ipt-chart-val-precision',this.$formWrap);this.$btnOptionMode=$('.btn-option-mode',this.$formWrap);this.$btnTimeMode=$('.btn-time-mode',this.$formWrap);this.$btnPredictMode=$('.btn-predict-mode',this.$formWrap);this.$divTargetPoint=$('.div-target-point',this.$formWrap);this.$divPredictPoint=$('.div-predict-point',this.$formWrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$dropArea=$('.drop-area',this.$formWrap);this.attachEvents();};ModalPredictPointLineConfig.prototype.recoverForm=function(modal){var name,form,dsChartConfig;if(!modal)return;form=modal.option;dsChartConfig=(modal.dsChartCog&&modal.dsChartCog.length)?modal.dsChartCog[0]:{};if(!form)return;this._setField('input',this.$iptChartYaxisMin,dsChartConfig.lower);this._setField('input',this.$iptChartYaxisMax,dsChartConfig.upper);this._setField('input',this.$iptChartValUnits,dsChartConfig.unit);this._setField('input',this.$iptChartValPrecision,dsChartConfig.accuracy);this._setField('droparea',this.$divTargetPoint,form.targetPointId);this._setField('droparea',this.$divPredictPoint,form.predictPointId);this._setField('dropdown',this.$btnOptionMode,form.optionsMode);this._setField('dropdown',this.$btnTimeMode,form.timeMode);this._setField('dropdown',this.$btnPredictMode,form.predictMode);};ModalPredictPointLineConfig.prototype.reset=function(){this._setField('input',this.$iptChartYaxisMin);this._setField('input',this.$iptChartYaxisMax);this._setField('input',this.$iptChartValUnits);this._setField('input',this.$iptChartValPrecision);this._setField('droparea',this.$divTargetPoint);this._setField('droparea',this.$divPredictPoint);this._setField('dropdown',this.$btnOptionMode);this._setField('dropdown',this.$btnTimeMode);this._setField('dropdown',this.$btnPredictMode);};ModalPredictPointLineConfig.prototype.attachEvents=function(){this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var dsChartConfig={},form={};var val;val=parseFloat(_this.$iptChartYaxisMin.val());dsChartConfig.lower=!isNaN(val)?val:'';val=parseFloat(_this.$iptChartYaxisMax.val());dsChartConfig.upper=!isNaN(val)?val:'';val=parseInt(_this.$iptChartValPrecision.val());dsChartConfig.accuracy=!isNaN(val)?val:'';dsChartConfig.unit=_this.$iptChartValUnits.val();form.optionMode=parseInt(_this.$btnOptionMode.attr('data-value'));form.timeMode=parseInt(_this.$btnTimeMode.attr('data-value'));form.predictMode=parseInt(_this.$btnPredictMode.attr('data-value'));form.targetPointId=_this.$divTargetPoint.attr('data-value');form.predictPointId=_this.$divPredictPoint.attr('data-value');modal.dsChartCog=[dsChartConfig];modal.option=form;modal.points=form.predictMode===0?[form.targetPointId,form.predictPointId]:[form.targetPointId];modal.interval=60000;_this.$modal.modal('hide');e.preventDefault();});};return ModalPredictPointLineConfig;}(jQuery,window));var ModalPredictPointLine=(function($,window,undefined){function ModalPredictPointLine(screen,entityParams,_renderModal,_updateModal,_showConfigMode){var _this=this;if(!screen)return;var renderModal=_renderModal?_renderModal:this.renderModal;var updateModal=_updateModal?_updateModal:this.updateModal;var showConfigMode=_showConfigMode?_showConfigMode:this.showConfigMode;ModalRealtimeLine.call(this,screen,entityParams,renderModal,updateModal,null);this.chart=null;this.chartOptions=$.extend(true,{},this.optionDefault,DEFAULTS_CHARTS_OPTIONS);this.period=null;this.firstload=$.Deferred();this.m_bIsGoBackTrace=false;this.m_traceData=undefined;};ModalPredictPointLine.prototype=Object.create(ModalRealtimeLine.prototype);ModalPredictPointLine.prototype.constructor=ModalPredictPointLine;ModalPredictPointLine.prototype.optionTemplate={name:'toolBox.modal.REAL_TIME_PREDICT_POINT_LINE',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalPredictPointLine'};ModalPredictPointLine.prototype.renderModal=function(){var _this=this;var modal=this.entity.modal;var dsChartOption=(modal.dsChartCog&&modal.dsChartCog.length)?modal.dsChartCog[0]:{};var option=modal.option;var chartYaxisMin=dsChartOption.lower;var chartYaxisMax=dsChartOption.upper;var chartValUnits=dsChartOption.unit;var chartValPrecision=dsChartOption.accuracy;var timeMode=option.timeMode;var targetPointId=this.entity.modal.points[0];var predictPointId=option.predictPointId;var predictMode=option.predictMode;var period=this.period=this.getPeriod(timeMode);var params=[];var dsName=[];if(predictMode===undefined)predictMode=option.predictMode=0;params.push({dsItemIds:[targetPointId],timeStart:period.startTime,timeEnd:period.endTime,timeFormat:period.tmFmt});dsName=AppConfig.datasource.getDSItemById(targetPointId).alias||targetPointId;this.chartOptions.legend={data:[dsName]};this.chartOptions.series[0].name=dsName;if(predictMode===1&&period.endTime<period.rangeEndTime){params.push({dsItemIds:[predictPointId],timeStart:period.endTime,timeEnd:period.rangeEndTime,timeFormat:period.tmFmt});this.chartOptions.legend.data.push('Predict Line');}
if(chartYaxisMin!=='')this.chartOptions.yAxis[0].min=chartYaxisMin;if(chartYaxisMax!=='')this.chartOptions.yAxis[0].max=chartYaxisMax;this.chartOptions.yAxis[0].name=chartValUnits;if(chartValPrecision==='')chartValPrecision=2;WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',params).done(function(rs){var rsList=JSON.parse(rs);var predictData;var i,t,leni,lent;for(i=0,leni=rsList.length;i<leni;i++){rsList[i].list[0].data=rsList[i].list[0].data.map(function(row,i){return row.toFixed(chartValPrecision);});}
_this.chartOptions.xAxis[0].data=_this.period.timeShaft;_this.chartOptions.series[0].data=rsList[0].list[0].data;_this.chartOptions.xAxis[0].axisLabel={formatter:function(v){var formatStr;switch(timeMode){case 0:formatStr='HH:00';break;case 1:default:formatStr='MM-dd';break;}
return v.toDate().format(formatStr);}};if(_this.chart){_this.chart.clear();_this.chart=null;}
_this.chart=echarts.init(_this.container,AppConfig.chartTheme);if(predictMode===1&&rsList[1]){_this.chartOptions.legend.data.push()
predictData=rsList[1].list[0].data;predictData[0]=rsList[0].list[0].data[rsList[0].list[0].data.length-1];predictData=new Array(_this.period.timeShaft.length-predictData.length+1).join('-').split('').concat(predictData);_this.chartOptions.series.push({type:'line',name:'Predict Line',symbol:'none',itemStyle:{normal:{lineStyle:{type:'dotted'},color:'#6495ed',label:{position:'right'}}},data:predictData});_this.chart.clear();_this.chart.setOption(_this.chartOptions);return;}
_this.firstload.done(function(points){_this.updateModal(points,true);});});};ModalPredictPointLine.prototype.updateModal=function(points,force){if(this.firstload.state()==='pending')return this.firstload.resolve(points);if(!points||points.length===0)return;var _this=this;var data=this.chartOptions.series[0].data,predictData;var timeShaft=this.chartOptions.xAxis[0].data;var modal=this.entity.modal;var predictMode=modal.option.predictMode;var pointVal,predictPointVal;var pointId=modal.points[0],predictPointId=modal.points[1];var timeInterval=this.period.tmInterval;var dataLen=data.length,timeLen=timeShaft.length;var lastTickVal=timeShaft[dataLen-1].toDate().valueOf();var nowTick=new Date().valueOf();var lastVal,row,i;force=force===undefined?false:force;if((nowTick-lastTickVal)<this.period.tmInterval&&!force)return;for(i=0,len=points.length;i<len;i++){row=points[i];if(row.dsItemId===pointId){pointVal=parseFloat(row.data);}
if(row.dsItemId===predictPointId){predictPointVal=parseFloat(row.data);}}
if(pointVal!==undefined&&!force){pointVal=Math.round(pointVal*1000)/1000
data.push(pointVal);}
if(predictMode===1){if(!this.chartOptions.series[1])return;predictData=this.chartOptions.series[1].data;if(predictData[predictData.length-1]==='-'){this.chartOptions.series.pop();}
else{predictData.splice(predictData.lastIndexOf('-')+1,1,'-');}
if(predictData[predictData.length-1]!=='-'){predictData.splice(predictData.lastIndexOf('-')+1,1,pointVal);}}
else if(predictPointVal!==undefined){dataLen=data.length;if(dataLen===timeLen){timeShaft.push(new Date(lastTickVal+timeInterval).format('yyyy-MM-dd HH:00:00'));}
this.chartOptions.series[0].markPoint.data=[{name:'Predict Value',value:predictPointVal,xAxis:dataLen,yAxis:predictPointVal}];lastVal=data[data.length-1];this.chartOptions.series[0].markLine.data=[[{xAxis:dataLen-1,yAxis:lastVal},{value:predictPointVal,xAxis:dataLen,yAxis:predictPointVal}]];}
this.chart.setOption(this.chartOptions);};ModalPredictPointLine.prototype.getPeriod=function(timeMode){var _this=this;var now,tmFmt,tmInterval,tick,endTick;var start,end;var timeShaft=[];if(!this.m_bIsGoBackTrace){now=new Date();_this.optionDefault.animation=true;}
else{now=this.m_traceData.currentTime;_this.optionDefault.animation=false;}
switch(timeMode){case 0:tmFmt='h1';tmInterval=3600000;start=now.format('yyyy-MM-dd')+' 00:00:00';end=now.format('yyyy-MM-dd HH:00:00');endTick=end.toDate().valueOf();deadlineTick=Math.max(start.toDate().valueOf()+86400000,endTick+28800000);break;case 1:default:tmFmt='d1';tmInterval=86400000;start=now.format('yyyy-MM')+'-01 00:00:00';end=now.format('yyyy-MM-dd 00:00:00');endTick=end.toDate().valueOf();if(this.entity.modal.option.predictMode===1){deadlineTick=now.valueOf()+604800000;}else{deadlineTick=Math.max(start.toDate().valueOf()+DateUtil.daysInMonth(now)*86400000,endTick+604800000);}
break;case 2:tmFmt='h1';tmInterval=3600000;start=new Date(now.valueOf()-((now.getDay()+6)%7)*86400000).format('yyyy-MM-dd 00:00:00');end=now.format('yyyy-MM-dd HH:00:00');endTick=end.toDate().valueOf();deadlineTick=Math.max(start.toDate().valueOf()+604800000,endTick+144000000);break;};tick=start.toDate().valueOf();while(tick<deadlineTick){timeShaft.push(tick.toDate().format('yyyy-MM-dd HH:00:00'));tick+=tmInterval;};return{startTime:start,endTime:end,rangeStartTime:start,rangeEndTime:timeShaft[timeShaft.length-1],tmFmt:tmFmt,tmInterval:tmInterval,timeShaft:timeShaft,deadlineTick:deadlineTick}};ModalPredictPointLine.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalPredictPointLine.prototype.setOptions=function(options){this.options=$.extend({},this.opitons,options);};ModalPredictPointLine.prototype.setModalOption=function(option){};ModalPredictPointLine.prototype.configModal=new ModalPredictPointLineConfig();ModalPredictPointLine.prototype.goBackTrace=function(data){this.m_bIsGoBackTrace=true;this.m_traceData=data;this.renderModal();this.m_bIsGoBackTrace=false;};var DEFAULTS_CHARTS_OPTIONS={tooltip:{formatter:function(p){var arrHtml=[p[0].name];p.forEach(function(row){if(row.value==='-')return;arrHtml.push(row.series.name+': '+row.value);});return arrHtml.join('<br/>');}},grid:{x:50,y:38,x2:25,y2:45},series:[{markPoint:{symbol:'emptyCircle',symbolSize:5,effect:{show:true,shadowBlur:0},itemStyle:{normal:{color:'#6495ed',label:{position:'top'}}},data:[]},markLine:{symbol:'circle',symbolSize:1.5,itemStyle:{normal:{lineStyle:{type:'dotted'},color:'#6495ed',label:{position:'right'}}},tooltip:{show:false},data:[]}}],toolbox:{show:false}};return ModalPredictPointLine;}(jQuery,window));var ModalNote=(function(){function ModalNote(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalNote.prototype=new ModalBase();ModalNote.prototype.optionTemplate={name:'toolBox.modal.NOTE',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalNote'};ModalNote.prototype.show=function(){this.init();}
ModalNote.prototype.init=function(){}
ModalNote.prototype.renderModal=function(e){this.spinner&&this.spinner.stop();if(!this.entity.modal.modalText)return;var temp=this.entity.modal.modalText;temp=temp.replace(/&lt;%\S+\.*\S+%&gt;/g,'--');this.container.style.padding='8px';this.container.innerHTML=temp;}
ModalNote.prototype.showConfigMode=function(){}
ModalNote.prototype.updateModal=function(points){var arrId=[];for(var i in points){var data=points[i].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
var $target=$('#divContainer_'+this.entity.id).find('#'+points[i].dsItemId);var textUrl=this.entity.modal.modalTextUrl?this.entity.modal.modalTextUrl:undefined;var index=$target.closest('.springContent').find('.pointValue').index($target);$target.html(data);arrId.push('');if(textUrl){for(var j=0;j<textUrl[index].ptTextUrl.length;++j){if(textUrl[index].ptTextUrl[j].value==parseInt(data)){arrId[index]=textUrl[index].ptTextUrl[j].url;if(arrId[index]!=''){$target.css({'cursor':'pointer','text-decoration':'underline'});if(textUrl[index].ptTextUrl[j].name&&textUrl[index].ptTextUrl[j].name!=''){$target.html(textUrl[index].ptTextUrl[j].name);}}
break;}}}}
var _this=this;arrId.forEach(function(value,index){if(arrId[index]=='')return;var $target=$('#ulPages').find('[pageId="'+arrId[index]+'"]');var ScreenType;for(var i=0;i<AppConfig.navItems.length;i++){if(AppConfig.navItems[i].id==arrId[index]){ScreenType=AppConfig.navItems[i].type;break;}}
if(!ScreenType){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){ScreenManager.show(ScreenType,arrId[index]);})}else{if(ScreenType=='ReportScreen'){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){var $ev=$('#ulPages [pageid="'+arrId[index]+'"]');if($ev[0].className!='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');})}else if(ScreenType=='EnergyScreen'){$('#divContainer_'+_this.entity.id).find('.pointValue').eq(index).off('click').on('click',function(e){ScreenManager.show(EnergyScreen,arrId[index]);})}}})}
ModalNote.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
return ModalNote;})();var ModalRankConfig=(function($,window,undefined){function ModalRankConfig(options){ModalConfig.call(this,options);}
ModalRankConfig.prototype=Object.create(ModalConfig.prototype);ModalRankConfig.prototype.constructor=ModalRankConfig;ModalRankConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalRank.html'};ModalRankConfig.prototype.init=function(){this.$dropArea=$('.drop-area',this.$wrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$rankPointList=$('#rankPointList',this.$wrap);this.$radioRankAsc=$('#radioRankAsc',this.$wrap);this.$radioRankDesc=$('#radioRankDesc',this.$wrap);this.attachEvents();};ModalRankConfig.prototype.recoverForm=function(modal){this._setField('input',this.$rankPointList,modal.points);if(0==modal.desc||null==modal.desc){this.$radioRankAsc.prop('checked',true);this.$radioRankDesc.prop('checked',false);}
else{this.$radioRankAsc.prop('checked',false);this.$radioRankDesc.prop('checked',true);}};ModalRankConfig.prototype.reset=function(){this._setField('input',this.$rankPointList);};ModalRankConfig.prototype.attachEvents=function(){var _this=this;_this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var ptList=_this.$rankPointList.val();modal.points=ptList.split(',');var radioVal=0;if($('#radioRankAsc')[0].checked){radioVal=0;}
else{radioVal=1;}
modal.desc=radioVal;_this.$modal.modal('hide');e.preventDefault();});};return ModalRankConfig;}(jQuery,window));var ModalRank=(function(){function ModalRank(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalRank.prototype=new ModalBase();ModalRank.prototype.optionTemplate={name:'toolBox.modal.WHIRLWIND_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRank'};ModalRank.prototype.show=function(){this.init();}
ModalRank.prototype.init=function(){}
ModalRank.prototype.renderModal=function(e){var _this=this;var arrPrjId=[];for(var i=0,len=AppConfig.projectList.length;i<len;i++){arrPrjId.push(AppConfig.projectList[i].id);}
var arrRankPt=_this.modal.points;var rankDesc=_this.modal.desc;var postData={'projectIds':arrPrjId,'points':arrRankPt,'desc':rankDesc};var showlist={list:[]};var descFlag=0;if(AppConfig.benchMark!=undefined){for(var i=0,len=arrRankPt.length;i<len;i++){for(var j=0,len2=AppConfig.benchMark.length;j<len2;j++){for(var k=0,len3=AppConfig.benchMark[j].points.length;k<len3;k++){if(arrRankPt[i]==AppConfig.benchMark[j].points[k]){showlist.list=AppConfig.benchMark[j].list;descFlag=AppConfig.benchMark[j].desc;break;}}}}}
if(showlist.list.length>0){var flag=true;if(rankDesc!=descFlag){flag=false;}
_this.drawRankChart(showlist,arrRankPt.length,flag);}
else{WebAPI.post('/benchmark/getListByPointsAndProjectIds',postData).done(function(result){_this.drawRankChart(result,arrRankPt.length,true);}).always(function(e){});}
_this.spinner.stop();}
ModalRank.prototype.updateModal=function(){}
ModalRank.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();}
ModalRank.prototype._showConfig=function(){};ModalRank.prototype.setModalOption=function(option){}
ModalRank.prototype.drawRankChart=function(dataSrc,ptLen,sortFlag){var _this=this;var showValue=[];var yAxis=[];var prjId,prjName,ptVal;var curPrjId=AppConfig.projectId;if(sortFlag){for(var i=dataSrc.list.length-1;i>=0;i--){ptVal=dataSrc.list[i].value;if(-1==ptVal){continue;}
prjId=dataSrc.list[i].projectId;if(prjId==curPrjId){showValue.push({value:ptVal,itemStyle:{normal:{color:'#ff6347'}}});}
else{showValue.push(ptVal);}
var findName=false;for(var j=0,len2=AppConfig.projectList.length;j<len2;j++){if(prjId==AppConfig.projectList[j].id){findName=true;break;}}
if(1==ptLen){if(0==_this.m_langFlag){yAxis.push(AppConfig.projectList[j].name_cn);}
else{yAxis.push(AppConfig.projectList[j].name_english);}}
else{if(findName){if(0==_this.m_langFlag){prjName=AppConfig.projectList[j].name_cn;}
else{prjName=AppConfig.projectList[j].name_english;}
yAxis.push(prjName+'-'+dataSrc.list[i].name);}
else{yAxis.push(dataSrc.list[i].name);}}}}
else{for(var i=0,len=dataSrc.list.length;i<len;i++){ptVal=dataSrc.list[i].value;if(-1==ptVal){continue;}
prjId=dataSrc.list[i].projectId;if(prjId==curPrjId){showValue.push({value:ptVal,itemStyle:{normal:{color:'#ff6347'}}});}
else{showValue.push(ptVal);}
var findName=false;for(var j=0,len2=AppConfig.projectList.length;j<len2;j++){if(prjId==AppConfig.projectList[j].id){findName=true;break;}}
if(1==ptLen){if(0==_this.m_langFlag){yAxis.push(AppConfig.projectList[j].name_cn);}
else{yAxis.push(AppConfig.projectList[j].name_english);}}
else{if(findName){if(0==_this.m_langFlag){prjName=AppConfig.projectList[j].name_cn;}
else{prjName=AppConfig.projectList[j].name_english;}
yAxis.push(prjName+'-'+dataSrc.list[i].name);}
else{yAxis.push(dataSrc.list[i].name);}}}}
var chartOption={title:{subtext:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:['value'],show:false},calculable:false,grid:{x:100,y:10,x2:20,y2:60},xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},axisLabel:{show:true,rotate:45},data:yAxis}],series:[{name:'value',type:'bar',data:showValue,itemStyle:{normal:{label:{show:true,position:'inside'},barBorderRadius:[0,5,5,0]},emphasis:{barBorderRadius:[0,5,5,0]}}}]};_this.chart.setOption(chartOption);}
ModalRank.prototype.configModal=new ModalRankConfig();return ModalRank;})();var ModalRankNormal=(function(){function ModalRankNormal(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalRankNormal.prototype=new ModalBase();ModalRankNormal.prototype.optionTemplate={name:'toolBox.modal.RANK_CHART',parent:0,mode:['modalRankNormal'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalRankNormal'};ModalRankNormal.prototype.show=function(){this.init();}
ModalRankNormal.prototype.init=function(){}
ModalRankNormal.prototype.renderModal=function(e){var _this=this;var arrPoint=_this.modal.points;var postData={'dataSourceId':0,'dsItemIds':arrPoint};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(result){var data=JSON.parse(result);_this.drawRankChart(data);}).always(function(e){_this.spinner.stop();});}
ModalRankNormal.prototype.updateModal=function(){}
ModalRankNormal.prototype.showConfigModal=function(){}
ModalRankNormal.prototype._showConfig=function(){}
ModalRankNormal.prototype.setModalOption=function(option){}
ModalRankNormal.prototype.drawRankChart=function(dataSrc){var _this=this;var yAxis=[];var showValue=[];for(var i=dataSrc.length-1;i>=0;i--){var itemName=AppConfig.datasource.getDSItemById(dataSrc[i].dsItemId).alias;yAxis.push(itemName);showValue.push(parseInt(dataSrc[i].data));}
var chartOption={title:{subtext:''},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}},legend:{data:[],show:false},calculable:false,grid:{x:100,y:10,x2:20,y2:40},xAxis:[{type:'value'}],yAxis:[{type:'category',axisTick:{show:false},axisLabel:{show:true,rotate:45},data:yAxis}],series:[{name:'value',type:'bar',data:showValue,itemStyle:{normal:{label:{show:true,position:'inside'},barBorderRadius:[0,5,5,0]},emphasis:{barBorderRadius:[0,5,5,0]}}}]};_this.chart.setOption(chartOption);}
return ModalRankNormal;})();var ModalMix=(function(){function ModalMix(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalMix.prototype=new ModalBase();ModalMix.prototype.optionTemplate={name:'toolBox.modal.MIX',parent:0,mode:['realTimeDashboard'],maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalMix'};ModalMix.prototype.show=function(){this.init();}
ModalMix.prototype.init=function(){this.container.style.overflowX='hidden';this.container.style.overflowY='auto';}
ModalMix.prototype.renderModal=function(e){var _this=this;var $sliderCont;var $sliderDiv=$('.sliderDiv');var displaySlider=_this.entity.modal.option.displaySlider;displaySlider=displaySlider===undefined?false:displaySlider;var carouselTime=new Date();if(displaySlider){$sliderDiv=$('<div id="carousel_'+carouselTime.getTime()+'" class="carousel slide sliderDiv" data-ride="carousel">'+'<ol class="carousel-indicators" style="bottom:0px;">'+'</ol><div class="carousel-inner" role="listbox">'+'</div>'+'<a class="left carousel-control" href="#carousel_'+carouselTime.getTime()+'" role="button" data-slide="prev"  style="background-image:none;color:rgba(91,91,91,0.6);width:60px;height:40%;top:30%;">'+'<span class="glyphicon glyphicon-chevron-left" aria-hidden="true" style="transform: scale(1,1.3)"></span><span class="sr-only">Previous</span></a>'+'<a class="right carousel-control" href="#carousel_'+carouselTime.getTime()+'" role="button" data-slide="next" style="background-image:none;color:rgba(91,91,91,0.6);width:60px;height:40%;top:30%;">'+'<span class="glyphicon glyphicon-chevron-right" aria-hidden="true" style="transform: scale(1,1.3)"></span><span class="sr-only">Next</span></a>'+'</div>');$sliderDiv.find('.carousel-control').hover(function(){$(this).css('color','rgba(0,0,0,.1)');},function(){$(this).css('color','rgba(51,51,51,.3)');})
$(_this.container).append($sliderDiv);}
if(!this.entity.modal.option||!this.entity.modal.option.subChartIds)return;var index=0;this.entity.modal.option.subChartIds.forEach(function(obj){for(var i=0,item;i<_this.screen.store.layout.length;i++){if(displaySlider){$(_this.container).css({'display':'block','overflow-y':'hidden'});for(var z=0;z<_this.screen.store.layout[i].length;z++){item=_this.screen.store.layout[i][z];if(obj.id!=item.id)continue;var modelClass,entity;_this.screen.store.layout[i][z].spanC=12;var $sliderIner=$('<div class="item sliderIner"><div class="carousel-caption" style="height:100%;width:100%;right:0;left:0;padding-bottom:0;bottom:0px;padding-top:0px;"></div></div>');var $sliderDot=$('<li data-target="#carousel_'+carouselTime.getTime()+'" data-slide-to="'+index+'" style="border-color:#333;box-shadow:1px rgba(0,0,0,.05);margin:1.5px 3px"></li>')
if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalMix'){entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
if(entity){$(entity.container).height($(_this.container).height()-30);$(entity.container).width($(_this.container).width());}
entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);if(entity){$(entity.container).height($(_this.container).height()-30);$(entity.container).width($(_this.container).width());}
entity.render();_this.screen.isForReport&&entity.configure();}
$sliderCont=$(_this.container).children('.springContainer');$sliderIner.children('.carousel-caption').append($sliderCont);$sliderIner.height($(_this.container).height());$sliderDiv.children('.carousel-inner').append($sliderIner);$sliderDiv.children('.carousel-indicators').append($sliderDot);++index;}}else{$(_this.container).css({'display':'flex','overflow-y':'auto','flex-flow':'wrap'});for(var j=0;j<_this.screen.store.layout[i].length;j++){item=_this.screen.store.layout[i][j];if(obj.id!=item.id)continue;var modelClass,entity;if(item.modal.type&&item.modal.type!='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender&&_this.entity.modal.type=='ModalMix'){entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;if($.inArray(item.id,_this.screen.arrEntityOrder)<0){_this.screen.arrEntityOrder.push(item.id);}
if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(_this.screen.requestPoints.indexOf(point)<0){_this.screen.requestPoints.push(point);}}}
if(item.modal.popId){if(!_this.screen.dictPopToEntity[item.modal.popId])_this.screen.dictPopToEntity[item.modal.popId]=[];_this.screen.dictPopToEntity[item.modal.popId].push(item.id);if(_this.screen.requestPoints.indexOf(item.modal.popId)<0){_this.screen.requestPoints.push(item.modal.popId);}}
entity.render();}}else if(item.modal.type=='ModalNone'){modelClass=_this.screen.factoryIoC.getModel(item.modal.type);entity=new modelClass(_this,item);_this.screen.listEntity[item.id]=entity;_this.screen.arrEntityOrder.push(item.id);entity.render();_this.screen.isForReport&&entity.configure();}}}}});if(displaySlider){if($(_this.container).find('.item:first')){$(_this.container).find('.item:first').addClass('active');}
if($(_this.container).find('.carousel-indicators').children(':first')){$(_this.container).find('.carousel-indicators').children(':first').addClass('active');}
$(_this.container).find('.sliderDiv').carousel();}}
ModalMix.prototype.showConfigMode=function(){}
ModalMix.prototype.updateModal=function(points){for(var i in points){var data=points[i].data;if(!isNaN(data)){data=parseFloat(data).toFixed(2);}
$('#'+points[i].dsItemId).html(data);}}
ModalMix.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
ModalMix.prototype.configure=function(){var _this=this;if(this.spinner)this.spinner.stop();var _this=this;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnRemove=document.createElement('span');btnRemove.className='glyphicon glyphicon-remove-circle springConfigRemoveBtn grow';btnRemove.title='Remove';btnRemove.onclick=function(e){if(_this.chart)_this.chart.clear();_this.screen.removeEntity(_this.entity.id);$('#divContainer_'+_this.entity.id).remove();_this=null;};divMask.appendChild(btnRemove);var btnAdd=document.createElement('span');btnAdd.className='glyphicon glyphicon-plus-sign springConfigAddBtn grow';btnAdd.title='Add';btnAdd.onclick=function(e){var spanC=6,spanR=6;var $chartsCt=_this.container.classList.contains('chartsCt')?$(_this.container):$(_this.container).siblings().find('.chartsCt');if($chartsCt.children().length>0){var lastDiv=$chartsCt.children()[$chartsCt.children().length-1];spanC=Math.round(parseInt(lastDiv.style.width.split('%')[0])/10)*12/10;spanR=Math.round(parseInt(lastDiv.style.height.split('%')[0])/10)*6/10;}
if(!_this.container.classList.contains('chartsCt')){_this.container=_this.container.parentElement.getElementsByClassName('chartsCt')[0];}
var entity=new ModalNone(_this,{id:(+new Date()).toString(),spanC:spanC,spanR:spanR,modal:{type:"ModalNone"},isNotRender:true,});_this.screen.arrEntityOrder.push(entity.entity.id);_this.screen.listEntity[entity.entity.id]=entity;if(!_this.entity.modal.option){_this.entity.modal.option={};_this.entity.modal.option.subChartIds=new Array();}
_this.entity.modal.option.subChartIds.push({id:entity.entity.id});entity.render();entity.configure();};divMask.appendChild(btnAdd);var btnInstall=document.createElement('span');var btnInstallParId;btnInstall.className='glyphicon glyphicon-cog springConfigInstallBtn grow';btnInstall.title='Install';var $mixChartShow=$('#mixChartShow');if($mixChartShow.length===0){$mixChartShow=$('<div id="mixChartShow"><div class="modal fade"  style="position:absolute;"><div class="modal-dialog"><div class="modal-content">'+'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">组合图显示模式</h4></div>'+'<div class="modal-body">'+'<input type="checkbox" class="isSlider"/>是否滚动显示组合图'+'</div>'+'<div class="modal-footer"><button type="button" class="btn btn-primary" data-dismiss="modal" id="transSlider">确定</button></div>'+'</div></div></div></div>');}
$('#paneContent').append($mixChartShow);btnInstall.onclick=function(e){$mixChartShow.children('.modal').modal();btnInstallParId=$(this).parents('.springContainer').attr('id').split('_')[1];_this.screen.btnInstallParId=btnInstallParId;if(_this.screen.listEntity[_this.screen.btnInstallParId].entity.modal.option.displaySlider){$('#mixChartShow .isSlider')[0].checked=true;}else{$('#mixChartShow .isSlider')[0].checked=false;}}
divMask.appendChild(btnInstall);$('#transSlider').off('click').click(function(){if($('#mixChartShow .isSlider').is(":checked")){_this.screen.listEntity[_this.screen.btnInstallParId].entity.modal.option.displaySlider=true;}else{_this.screen.listEntity[_this.screen.btnInstallParId].entity.modal.option.displaySlider=false;}});var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $chartCt=$('<div class="divResize chartsCt gray-scrollbar">');divMask.appendChild($chartCt[0]);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();function btnConfig_clickEvent(e){$('.springSel').removeClass('springSel');$(e.target).parents('.springContainer').addClass('springSel');_this.modalInit();}
var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent,$chartsCt;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();$chartsCt=e.target.classList.contains('chartsCt')?$(e.target):$(e.target).closest('.chartsCt');if(!$sourceParent[0].classList.contains('chartsCt')&&($targetParent[0].classList.contains('chartsCt')||$chartsCt.length==1)){if($targetParent[0].classList.contains('chartsCt')){_this.insertChartIntoMix(sourceId,$targetParent[0])}else if($chartsCt.length==1){_this.insertChartIntoMix(sourceId,$chartsCt[0])}}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}}
this.executeConfigMode();},ModalMix.prototype.insertChartIntoMix=function(sourceId,container){if(sourceId){if(this.screen.listEntity[sourceId].entity.modal.type=='ModalMix'){alert(I18n.resource.toolBox.modal.MSG_MIX_NOT_ALLOW_TO_MIX);return false;}
var modelClass,item,entity=this.screen.listEntity[sourceId].entity;$('#divContainer_'+sourceId).remove();entity.isNotRender=true;if(!this.entity.modal.option){this.entity.modal.option={};}
if(!this.entity.modal.option.subChartIds){this.entity.modal.option.subChartIds=[];}
modelClass=this.screen.factoryIoC.getModel(entity.modal.type);this.screen.container=container;if(container.children.length>0){var lastDiv=container.children[container.children.length-1];entity.spanC=Math.round(parseInt(lastDiv.style.width.split('%')[0])/10)*12/10;entity.spanR=Math.round(parseInt(lastDiv.style.height.split('%')[0])/10)*6/10;}else{entity.spanC=6;entity.spanR=6;}
item=new modelClass(this.screen,entity);item.configure()
this.entity.modal.option.subChartIds.push({id:entity.id});}}
return ModalMix;})();(function(){var tags={};var TOOLBOX=['DataSource','LinkTo'];var PATTERN_STR='<('+TOOLBOX.join('|')+').*?(/|'+TOOLBOX.join('|')+')>';window.__spring_html_modal={};function runScript(content){var done=false;var script=document.createElement("script");var head=document.getElementsByTagName("head")[0];script.type="text\/javascript";script.text=content;head.appendChild(script);head.removeChild(script);}
tags.Base=(function(){function Base(modal){this.$textarea=modal.$textarea;this.$modalCt=modal.$modalCt;this.$toolBtn=null;this.init();}
Base.prototype.init=function(){throw new Error('init 方法未被实现，不可直接调用');};Base.prototype.render=function($container){throw new Error('render 方法未被实现，不可直接调用');};return Base;}());tags.DataSource=(function(){var _this;function DataSource(modal){_this=this;tags.Base.call(this,modal);}
DataSource.prototype=Object.create(tags.Base.prototype);DataSource.prototype.constructor=DataSource;DataSource.prototype.insertTpl='<DataSource data-id="{id}"{linkTo}/>';DataSource.prototype.init=function(){var arrHtml=[];this.$toolBtn=$('<button type="button" class="btn btn-default" data-toggle="collapse" data-target="#panelDataSourceConfig" aria-expanded="false">\
                DataSource\
                </button>');this.$toolConfig=$('#panelDataSourceConfig',this.$modalCt);};DataSource.prototype.render=function($btnCtn){$btnCtn.append(this.$toolBtn);this.attachEvents();};DataSource.prototype.attachEvents=function(){};DataSource.save=function(dataset,modal){var id;if(!dataset)return;id=dataset.id;if(id&&modal.points.indexOf(id)===-1)modal.points.push(id);};DataSource.getStaticRender=function(dom){var dataset=dom.dataset;var menuId=dataset.linkTo;var $ele;if(menuId){$ele=$('<a href="javascript:;" data-is="DataSource" data-id="'+dataset.id+'">Loading</a>');$ele.click(function(e){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');});return $ele;}
else return $('<span data-is="DataSource" data-id="'+dataset.id+'">Loading</span>');};DataSource.getRealTimeRender=function($ele,map){var dataset=$ele[0].dataset;$ele.html(map[dataset.id]);};return DataSource;}());tags.LinkTo=(function(){var _this;function LinkTo(modal){_this=this;tags.Base.call(this,modal);}
LinkTo.prototype=Object.create(tags.Base.prototype);LinkTo.prototype.constructor=LinkTo;LinkTo.prototype.insertTpl='<LinkTo data-id="{id}" ></LinkTo>';LinkTo.prototype.init=function(){var arrHtml=[];this.$toolBtn=$('<button type="button" class="btn btn-default" data-parent="#collapseList" data-toggle="collapse" data-target="#panelLinkToConfig" aria-expanded="false">LinkTo</button>');this.$toolConfig=$('#panelLinkToConfig',this.$modalCt);};LinkTo.prototype.render=function($btnCtn){$btnCtn.append(this.$toolBtn);this.attachEvents();};LinkTo.prototype.attachEvents=function(){};LinkTo.save=function(dataset,modal){};LinkTo.getStaticRender=function(dom,doc){var dataset=dom.dataset;var menuId=dataset.id;doc=doc||window.document;$ele=$('<a href="javascript:;">'+(dom.innerHTML||'Link To')+'</a>',doc);$ele.click(function(){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');});return $ele;};return LinkTo;}());var ModalHtmlConfig=(function(){var _this;var gMenusHtml;function ModalHtmlConfig(options){_this=this;ModalConfig.call(this,options);this.toolbox=[];}
ModalHtmlConfig.prototype=Object.create(ModalConfig.prototype);ModalHtmlConfig.prototype.constructor=ModalHtmlConfig;ModalHtmlConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalHtmlConfig.html'};ModalHtmlConfig.prototype.init=function(){this.$modal=$('.modal',this.$wrap);this.$modalCt=$('.modal-content',this.$wrap);this.$formWrap=$('.form-wrap',this.$wrap);this.$dsGroupList=$('.form-horizontal','#panelDataSourceConfig');this.$linkGroupList=$('.form-horizontal','#panelLinkToConfig');this.$textarea=$('.form-textarea',this.$formWrap);this.$btnSubmit=$('.btn-submit',this.$wrap);this.$toolboxCtn=$('.toolbox-ctn',this.$formWrap);this.$btnResizeFull=$('.btn-resize-full',this.$wrap);this.$btnResizeSmall=$('.btn-resize-small',this.$wrap);this.attachEvents();this.initToolbox();};ModalHtmlConfig.prototype.initToolbox=function(){var $toolboxGroup=$('<div class="btn-group" role="group">').appendTo(this.$toolboxCtn);TOOLBOX.forEach(function(row){var labelClass=tags[row];var labelIns;if(typeof labelClass!=='function'){console.warn('没有找到自定义标签: '+row);return;}
labelIns=new labelClass(_this);labelIns.render($toolboxGroup);});var $tools=$('.btn',$toolboxGroup);$toolboxGroup.on('click','.btn',function(){$(this).toggleClass('btn-primary');});};ModalHtmlConfig.prototype.recoverForm=function(form){var _this=this;var options;if(!form||!form.option){this.addDsFormGroup();return;}
options=form.option;form.points.forEach(function(row){var $ele=_this.addDsFormGroup({id:row,cls:' dropped',value:row,name:AppConfig.datasource.getDSItemById(row).alias,display:'inline'});});this.addDsFormGroup();this._setField('textarea',this.$textarea,options.html);};ModalHtmlConfig.prototype.reset=function(){this.$dsGroupList.empty();this._setField('textarea',this.$textarea);};ModalHtmlConfig.prototype.addDsFormGroup=function(data){if(data===undefined){data={id:'引用变量名',cls:'',value:'',name:'<span class="glyphicon glyphicon-plus"></span>'}}
return $('<div class="form-group{cls}">\
                <label class="col-md-2 control-label" for="">Point</label>\
                <div class="col-md-4">\
                    <div class="label-area div-ds-id">{id}</div>\
                </div>\
                <div class="col-md-4">\
                    <div class="drop-area div-ds-point" data-value="{value}">\
                        {name}\
                    </div>\
                </div>\
                <div class="col-md-2">\
                    <div class="opt-icon-area">\
                        <span class="glyphicon glyphicon-remove"></span>\
                    </div>\
                </div>\
            </div>'.formatEL(data)).appendTo(_this.$dsGroupList);};ModalHtmlConfig.prototype.initLinkFormGroup=function(){var arrHtml=[];for(var i in AppConfig.menu){if(!AppConfig.menu.hasOwnProperty(i))continue;arrHtml.push('<div class="form-group">\
                    <label class="col-md-2 control-label" for="">Link</label>\
                    <div class="col-md-4">\
                        <div class="label-area">{id}</div>\
                    </div>\
                    <div class="col-md-4"><div class="label-area">{name}</div></div>\
                </div>'.formatEL({id:i,name:AppConfig.menu[i]}));}
return this.$linkGroupList.html(arrHtml.join(''));};ModalHtmlConfig.prototype.attachEvents=function(){var _this=this;this.$modal.on('show.bs.modal',function(){_this.initLinkFormGroup();});this.$wrap.on('drop','.drop-area',function(e){var $this=$(this);var dsId=$this[0].dataset.value;var $formGroup=$this.closest('.form-group');if(_this.$dsGroupList.find('[data-value="'+dsId+'"]').length>1){_this._setField('droparea',$formGroup.find('.drop-area'));alert('该数据源已存在于列表中！');return false;}else{$formGroup.addClass('dropped');$formGroup.find('.label-area').text(dsId);}
_this.addDsFormGroup();e.stopPropagation();});this.$wrap.on('click','.opt-icon-area',function(e){$(this).closest('.form-group').remove();});this.$btnResizeFull.off().click(function(){var height=_this.$modal.height();_this.$modal.addClass('maxium-screen');_this.$textarea.height(height-208);});this.$btnResizeSmall.off().click(function(){_this.$modal.removeClass('maxium-screen');_this.$textarea.height('auto');});this.$btnSubmit.off().click(function(e){var modalIns=_this.options.modalIns;var modal=modalIns.entity.modal;var form={};var html;var toolboxStr,pattern,match;html=form.html=_this.$textarea.val();modal.points=[];_this.$dsGroupList.find('.dropped .drop-area').each(function(){modal.points.push($(this)[0].dataset.value);});toolboxStr=TOOLBOX.join('|');pattern=new RegExp(PATTERN_STR,'ig');while((match=pattern.exec(html))!==null){try{var dom=$(match[0])[0];}catch(e){continue;}
tags[match[1]].save(dom.dataset,modal);}
modal.option=form;modal.dsChartCog=[{accuracy:2}];modal.interval=60000;_this.$modal.modal('hide');e.preventDefault();});};return ModalHtmlConfig;}());this.ModalHtml=(function(){function ModalHtml(screen,entityParams){ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);this.promise=$.Deferred();this.firstUpdateData=null;this.lastUpdateTimeTick=null;this.customTags={};this.initCustomVaribles();}
ModalHtml.prototype=Object.create(ModalBase.prototype);ModalHtml.prototype.constructor=ModalHtml;ModalHtml.prototype.optionTemplate={name:'toolBox.modal.MODAL_HTML',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalHtml'};ModalHtml.prototype.initCustomVaribles=function(){window.__spring_html_modal[this.entity.id]=this.customVaribles={};this.customVaribles.dataMap={};this.customVaribles.linkTo=function(menuId){var $ev=$('#ulPages [pageid="'+menuId+'"]');if($ev[0].className!=='nav-btn-a'){$ev=$ev.children('a');$ev.closest('.dropdown').children('a').trigger('click');}
$ev.trigger('click');};};ModalHtml.prototype.initCustomTags=function(doc){var _this=this;doc=doc||document;TOOLBOX.forEach(function(row,i){var $tagEle=$(row,doc);var thisTags=[];var staticHtmlRender;if(!$tagEle.length)return;if(typeof(staticHtmlRender=tags[row].getStaticRender)!=='function')return;([]).forEach.call($tagEle,function(rowt,t){var $rs=staticHtmlRender(rowt);if(!$rs)return;thisTags.push($rs);$(rowt).replaceWith($rs);});if(thisTags.length)_this.customTags[row]=thisTags;});};ModalHtml.prototype.initCustomAttrs=function(){var _this=this;var $container=$(this.container);$container.on('click','[data-link-to]',function(e){var menuId=this.dataset['linkTo'];_this.customVaribles.linkTo(menuId);e.preventDefault();});};ModalHtml.prototype.buildDsBinding=function(){var dataMap=this.customVaribles.dataMap={};var $container=$(this.container);var ds=dataMap;var textNodeMap={},attrNodeMap={};var dsNameList=this.entity.modal.points;var $textNodes=$container.find('.text-node-placeholder');var $attrNodes=$container.find('[data-inner-ds-info]');dsNameList.forEach(function(name){var $nodes;if(($nodes=$textNodes.filter('[data-name="'+name+'"]')).length){$nodes.each(function(){var text=document.createTextNode('');if(!textNodeMap[name]){textNodeMap[name]=[text];}else{textNodeMap[name].push(text);}
this.parentNode.replaceChild(text,this);});}else{textNodeMap[name]=[];}
if(($nodes=$attrNodes.filter('[data-inner-ds-info*="'+name+'"]')).length){$nodes.each(function(){var $this=$(this);var attr=$this.data('ds.attr');var info=$this.data('ds.info');if(attr===undefined){$this.data('ds.attr',(attr=this.getAttribute('data-inner-ds-attr')));}
if(info===undefined){info=window.decodeURIComponent(this.getAttribute('data-inner-ds-info'));$this.data('ds.info',(info=JSON.parse(info)));}
if(!attrNodeMap[name]){attrNodeMap[name]=[{node:this.getAttributeNode(attr),info:info}]}else{attrNodeMap[name].push({node:this.getAttributeNode(attr),info:info});}});}else{attrNodeMap[name]=[];}
if(!ds.__observerProps)ds.__observerProps={};if(!ds.__observerProps.hasOwnProperty(name)){ds.__observerProps[name]=null;Object.defineProperty(ds,name,{get:function(){return this.__observerProps[name];},set:function(value){if(value===this.__observerProps[name])return;this.__observerProps[name]=value;textNodeMap[name].forEach(function(row){row.data=value;});attrNodeMap[name].forEach(function(row){var info=row.info;var str='';info.forEach(function(row){if(row.type===TextTemplateParser.types.text){str+=row.value;}else if(row.type===TextTemplateParser.types.binding){if(row.id===name){row.value=value;}
str+=row.value;}});row.node.value=str;});}});}});$attrNodes.each(function(){this.removeAttribute('data-inner-ds-info');this.removeAttribute('data-inner-ds-attr');});};ModalHtml.prototype.renderModal=function(){var _this=this;var options=this.entity.modal.option;var info;var parser=TextTemplateParser;if(!options){$(this.container).html('');this.spinner.stop();return;}
info=this.getFormatHtml(options.html);info.html=info.html.replace(/([\w-]*)="(.*<%.+%>.*)"/mg,function($0,$1,$2){var tokens=parser.parse($2,['<%','%>']);var infoStr;tokens.forEach(function(row){if(row.type===parser.types.binding){row.id=row.value;row.value='';}});infoStr=window.encodeURIComponent(JSON.stringify(tokens));return $1+'="" data-inner-ds-info="'+infoStr+'" data-inner-ds-attr="'+$1+'"';});info.html=info.html.replace(/<%(.+?)%>/mg,function($0,$1){return'<span class="text-node-placeholder" data-name="'+$1+'">'+$1+'</span>';});$(this.container).html(info.html);runScript(info.scriptContent);_this.initCustomTags();_this.initCustomAttrs();_this.buildDsBinding();if(typeof _this.customVaribles.onRenderComplete==='function'){_this.customVaribles.onRenderComplete.call(null);}
_this.promise.done(function(data){if(!data)return;_this.updateModal(data);});_this.promise.resolve(_this.firstUpdateData);_this.spinner.stop();};ModalHtml.prototype.updateModal=function(data){var _this=this;var modal,updateInterval,options,now;var thisTags;var dataMap=this.customVaribles.dataMap;var customEventHandlers;if(this.promise.state()==='pending'){this.firstUpdateData=data;return;}
modal=this.entity.modal;updateInterval=modal.interval;options=this.entity.options;nowTick=new Date().valueOf();if(this.lastUpdateTimeTick&&(nowTick-this.lastUpdateTimeTick)<updateInterval)return;this.lastUpdateTimeTick=nowTick;data.forEach(function(row){dataMap[row.dsItemId]=row.data;});for(var tagName in this.customTags){if(!this.customTags.hasOwnProperty(tagName))continue;thisTags=this.customTags[tagName];thisTags.forEach(function($row,i){var handler=tags[tagName].getRealTimeRender;if(typeof handler!=='function')return;handler($row,dataMap);});}
if(typeof this.customVaribles.onUpdateComplete==='function'){this.customVaribles.onUpdateComplete.call(null,dataMap);}};ModalHtml.prototype.showConfigMode=function(){};ModalHtml.prototype.showConfigModal=function(container,options){this.configModal.setOptions({modalIns:this});this.configModal.show();};ModalHtml.prototype.configModal=new ModalHtmlConfig();ModalHtml.prototype.getFormatHtml=function(html){var _this=this;var patternScript=/(<script\b[^>]*>)([\s\S]*?)(<\/script>)/img;var scriptContent=[];var wrapTpl='(function() { |code| }).call(window.__spring_html_modal[\''+_this.entity.id+'\'])';var formatHtml=html.replace(patternScript,function($0,$1,$2,$3){if($2.trim()!=='')scriptContent.push($2);return'';});return{scriptContent:wrapTpl.replace('|code|',scriptContent.join(';\n')),html:formatHtml}};ModalHtml.prototype.close=function(){};return ModalHtml;}());var TextTemplateParser=(function(){function TextTemplateParser(){}
TextTemplateParser.types={text:0,binding:1};TextTemplateParser.parse=function(template,delimiters){var index,lastIndex,lastToken,length,substring,tokens,value;tokens=[];length=template.length;index=lastIndex=0;while(lastIndex<length){index=template.indexOf(delimiters[0],lastIndex);if(index<0){tokens.push({type:this.types.text,value:template.slice(lastIndex)});break;}else{if(index>0&&lastIndex<index){tokens.push({type:this.types.text,value:template.slice(lastIndex,index)});}
lastIndex=index+delimiters[0].length;index=template.indexOf(delimiters[1],lastIndex);if(index<0){substring=template.slice(lastIndex-delimiters[0].length);lastToken=tokens[tokens.length-1];if((lastToken!==undefined?lastToken.type:void 0)===this.types.text){lastToken.value+=substring;}else{tokens.push({type:this.types.text,value:substring});}
break;}
value=template.slice(lastIndex,index).trim();tokens.push({type:this.types.binding,value:value});lastIndex=index+delimiters[1].length;}}
return tokens;};return TextTemplateParser;}());}).call(this);var ModalChartCustomConfig=(function($,window,undefined){function ModalChartCustomConfig(options){ModalConfig.call(this,options);this.m_bIsRealTime=true;this.m_bIsHisFixCycle=true;}
ModalChartCustomConfig.prototype=Object.create(ModalConfig.prototype);ModalChartCustomConfig.prototype.constructor=ModalChartCustomConfig;ModalChartCustomConfig.prototype.DEFAULTS={htmlUrl:'/static/views/observer/widgets/modalChartCustom.html'};ModalChartCustomConfig.prototype.init=function(){var _this=this;_this.$btnSubmit=$('#btnSubmit',_this.$wrap);_this.$editor=$('#editor',_this.$wrap);_this.$selectMode=$('#inputMode',_this.$wrap);_this.$selRealInterval=$('#selRealInterval',_this.$wrap);_this.$tmStart=$('#timeStart',_this.$wrap);_this.$tmEnd=$('#timeEnd',_this.$wrap);_this.$tmGroup=$('#rangeSel',_this.$wrap);_this.$divRealtmCycle=$('#divRealTimeCycle',_this.$wrap);_this.$selectHisCycleMode=$('#hisCycleMode',_this.$wrap);_this.$selectHisInterval=$('#selHisInterval',_this.$wrap);_this.$divHisTmRange=$('#historyTmRange',_this.$wrap);_this.$divHisTmCycle=$('#historyTmCycle',_this.$wrap);_this.$inputPeriodVal=$('#inputPeriodValue',_this.$wrap);_this.$selPeriUnit=$('#inputPeriodUnit',_this.$wrap);var modal=_this.options.modalIns.entity.modal;EventAdapter.on($(_this.$editor[0]),'drop',function(e){e.preventDefault();this.focus();var itemId=EventAdapter.getData().dsItemId;if(Boolean(itemId)){var itemName=AppConfig.datasource.getDSItemById(itemId).alias;var spanCtl=$('<span id="'+itemId+'" title="'+itemName+'" class="pointValue"></span>');spanCtl.text('"<%'+itemName+'%>"');var sel,range;if(window.getSelection){sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var insertDiv=$('<div>');insertDiv.append('&nbsp;');insertDiv.append(spanCtl);insertDiv.append('&nbsp;');var el=insertDiv[0];var frag=document.createDocumentFragment(),node,lastNode;while((node=el.firstChild)){lastNode=frag.appendChild(node);}
range.insertNode(frag);if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range);}}}
_this.$editor.append('&nbsp;');}});EventAdapter.on($(_this.$editor[0]),'dragover',function(e){e.preventDefault();});if(Boolean(modal.option)){if(!modal.option.isRealTime){_this.m_bIsRealTime=false;_this.$selectMode.val('history');_this.$tmGroup.css('display','block');_this.$divRealtmCycle.css('display','none');}
else{_this.m_bIsRealTime=true;_this.$selectMode.val('realTime');_this.$tmGroup.css('display','none');_this.$divRealtmCycle.css('display','block');}
if(!modal.option.isHisFixCycle){_this.m_bIsHisFixCycle=false;_this.$selectHisCycleMode.val('recent');_this.$divHisTmRange.css('display','none');_this.$divHisTmCycle.css('display','block');}
else{_this.m_bIsHisFixCycle=true;_this.$selectHisCycleMode.val('fixed');_this.$divHisTmRange.css('display','block');_this.$divHisTmCycle.css('display','none');}
switch(modal.interval){case'm1':case'm5':case'h1':case'd1':case'M1':_this.$selRealInterval.val(modal.interval);_this.$selectHisInterval.val(modal.interval);break;default:_this.$selRealInterval.val('h1');_this.$selectHisInterval.val('h1');break;}
_this.$tmStart.val(modal.option.timeStart);_this.$tmEnd.val(modal.option.timeEnd);_this.$inputPeriodVal.val(modal.option.timeCycleValue);if(!modal.option.timeCycleUnit){_this.$selPeriUnit.val(modal.option.timeCycleUnit);}
else{_this.$selPeriUnit.val('hour');}}
else{_this.$selectMode.val('realTime');_this.$tmGroup.css('display','none');}
_this.$selectMode.change(function(e){var flag=$(e.currentTarget).val();if('history'==flag){_this.$tmGroup.css('display','block');_this.m_bIsRealTime=false;_this.$divRealtmCycle.css('display','none');}
else{_this.m_bIsRealTime=true;_this.$tmGroup.css('display','none');_this.$divRealtmCycle.css('display','block');}});_this.$selectHisCycleMode.change(function(e){var $opt=_this.$selectHisInterval.children('option');var flag=$(e.currentTarget).val();if('fixed'==flag){_this.m_bIsHisFixCycle=true;$opt.eq(0).css('display','block');$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$divHisTmRange.css('display','block');_this.$divHisTmCycle.css('display','none');}
else{_this.m_bIsHisFixCycle=false;_this.$selPeriUnit.change();_this.$divHisTmRange.css('display','none');_this.$divHisTmCycle.css('display','block');}});_this.$selPeriUnit.change(function(e){var $opt=_this.$selectHisInterval.children('option');$opt.eq(0).css('display','none');var flag=$(e.currentTarget).val();switch(flag){case'hour':$opt.eq(1).css('display','block');$opt.eq(2).css('display','block');$opt.eq(3).css('display','none');$opt.eq(4).css('display','none');_this.$selectHisInterval.val('m5');break;case'day':$opt.eq(1).css('display','none');$opt.eq(2).css('display','block');$opt.eq(3).css('display','block');$opt.eq(4).css('display','none');_this.$selectHisInterval.val('h1');break;case'month':$opt.eq(1).css('display','none');$opt.eq(2).css('display','none');$opt.eq(3).css('display','block');$opt.eq(4).css('display','block');_this.$selectHisInterval.val('d1');break;default:break;}});if(!_this.m_bIsHisFixCycle){_this.$selPeriUnit.change();}
$(".form_datetime").datetimepicker({format:"yyyy-mm-dd HH:mm:ss",minView:"hour",autoclose:true,todayBtn:false,pickerPosition:"bottom-right",initialDate:new Date()}).off('changeDate').on('changeDate',function(ev){var selectTime=(ev.date.valueOf().toDate().toUTCString().replace(' GMT','')).toDate().getTime();var time=selectTime-selectTime%(5*60*1000).toDate().format('yyyy-MM-dd HH:mm:ss');$('#tabFrames .td-frame[title="'+time+'"]').click();});_this.attachEvents();I18n.fillArea($('#modalCustom'));};ModalChartCustomConfig.prototype.recoverForm=function(modal){if(Boolean(modal.modalText)){this.$editor.html(modal.modalText);}};ModalChartCustomConfig.prototype.reset=function(){};ModalChartCustomConfig.prototype.attachEvents=function(){var _this=this;_this.$btnSubmit.off().click(function(e){var modal=_this.options.modalIns.entity.modal;var customOption=$('#modalCustom').find('#editor');modal.modalText=customOption.html();modal.modalTextUrl=customOption.text();modal.option=new Object();modal.option.list=[];modal.points=[];var arraySpan=customOption.find('.pointValue');for(var i=0,len=arraySpan.length;i<len;i++){modal.option.list.push({dsItemId:arraySpan[i].id,name:arraySpan[i].title,data:0});modal.points.push(arraySpan[i].id);}
modal.interval=_this.m_bIsRealTime?_this.$selRealInterval.val():_this.$selectHisInterval.val();modal.option.isRealTime=_this.m_bIsRealTime;modal.option.isHisFixCycle=_this.m_bIsHisFixCycle;if(_this.m_bIsHisFixCycle){modal.option.timeStart=_this.$tmStart.val();modal.option.timeEnd=_this.$tmEnd.val();}
else{var tmStart=new Date();var tmEnd=new Date();var periodVal=parseInt(_this.$inputPeriodVal.val());var periodUnit=_this.$selPeriUnit.val();switch(periodUnit){case'hour':var time=tmEnd.getTime()-3600000*periodVal;tmStart.setTime(time);break;case'day':var time=tmEnd.getTime()-86400000*periodVal;tmStart.setTime(time);break;case'month':var month=tmEnd.getMonth();if(0==month){tmStart.setFullYear(tmEnd.getFullYear()-1);tmStart.setMonth(11);}
else{tmStart.setMonth(month-1);}
break;default:break;}
modal.option.timeStart=tmStart.format('yyyy-MM-dd HH:mm:ss');modal.option.timeEnd=tmEnd.format('yyyy-MM-dd HH:mm:ss');modal.option.timeCycleValue=_this.$inputPeriodVal.val();modal.option.timeCycleUnit=_this.$selPeriUnit.val();}
_this.$modal.modal('hide');e.preventDefault();});};return ModalChartCustomConfig;}(jQuery,window));var ModalChartCustom=(function(){function ModalChartCustom(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this._showConfig);this.modal=entityParams.modal;this.chart=echarts.init(this.container,AppConfig.chartTheme);this.m_langFlag=('zh'==localStorage['language'])?0:1;this.spinner.spin(this.container);};ModalChartCustom.prototype=new ModalBase();ModalChartCustom.prototype.optionTemplate={name:'toolBox.modal.CUSTOM_CHART',parent:0,mode:'custom',maxNum:10,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalChartCustom'};ModalChartCustom.prototype.show=function(){this.init();}
ModalChartCustom.prototype.init=function(){}
ModalChartCustom.prototype.renderModal=function(e){var _this=this;var optList=_this.modal.option.list;if(!optList){_this.spinner.stop();return;}
var len=optList.length;if(len>0){if(_this.modal.option.isRealTime){var postData={'dataSourceId':0,'dsItemIds':_this.modal.points};WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(result){var res=JSON.parse(result);var data=res.dsItemList;if(!data){return;}
if(data.length>0){for(var i=0,len=data.length;i<len;i++){for(var j=0,len2=optList.length;j<len2;j++){if(optList[j].dsItemId==data[i].dsItemId){optList[j].data=parseFloat(parseFloat(data[i].data).toFixed(2));break;}}}
_this.updateModal(data);}}).always(function(e){_this.spinner.stop();});}
else{WebAPI.post('/analysis/startWorkspaceDataGenHistogram',{dsItemIds:_this.modal.points,timeStart:_this.modal.option.timeStart,timeEnd:_this.modal.option.timeEnd,timeFormat:'m5'}).done(function(result){var dataSrc=JSON.parse(result);if(!dataSrc||dataSrc.timeShaft.length<=0){return;}
_this.updateHistoryChart(dataSrc.list,dataSrc.timeShaft);}).error(function(e){}).always(function(e){_this.spinner.stop();});}}
else{try{var showOption=eval('({'+_this.modal.modalTextUrl+'})');_this.drawChart(showOption);_this.spinner.stop();}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.updateModal=function(src){if(this.modal.option.isRealTime){this.updateRealTimeChart(src);}}
ModalChartCustom.prototype.showConfigModal=function(){this.configModal.setOptions({modalIns:this});this.configModal.show();}
ModalChartCustom.prototype._showConfig=function(){}
ModalChartCustom.prototype.setModalOption=function(option){}
ModalChartCustom.prototype.drawChart=function(chartOption){this.chart.setOption(chartOption);}
ModalChartCustom.prototype.close=function(){}
ModalChartCustom.prototype.updateRealTimeChart=function(src){var _this=this;if(!src){return;}
if(src.length>0){var optList=_this.modal.option.list;for(var m=0,lenM=optList.length;m<lenM;m++){for(var n=0,lenN=src.length;n<lenN;n++){if(optList[m].dsItemId==src[n].dsItemId){optList[m].data=src[n].data;break;}}}
var showOption=_this.modal.modalTextUrl;var arr=showOption.split('<%');for(var j=1,len2=arr.length;j<len2;j++){var name=arr[j].split('%>')[0];if(''==name){continue;}
var data=-1;for(var k=0,len3=optList.length;k<len3;k++){if(optList[k].name==name){data=optList[k].data;break;}}
if(-1!=data&&Boolean(data)){if('object'==typeof(data)){var temp;for(var p=0,lenP=data.length;p<lenP;p++){temp+=data[p]+',';}
showOption=showOption.replace(name,temp);}
else{showOption=showOption.replace(name,data);}}}
showOption=showOption.replace(/"<%/g,'');showOption=showOption.replace(/%>"/g,'');try{showOption=eval('({'+showOption+'})');_this.drawChart(showOption);}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.updateHistoryChart=function(list,timeShaft){var _this=this;if(!list){return;}
if(list.length>0){var infoList=[];for(var i=0,len=list.length;i<len;i++){var itemId=list[i].dsItemId;var itemName=AppConfig.datasource.getDSItemById(itemId).alias;var item={id:itemId,name:itemName,data:list[i].data};infoList.push(item);}
var showOption=_this.modal.modalTextUrl;var arr=showOption.split('<%');for(var j=1,len2=arr.length;j<len2;j++){var name=arr[j].split('%>')[0];if(''==name){continue;}
var data;for(var k=0,len3=infoList.length;k<len3;k++){if(infoList[k].name==name){data=infoList[k].data;break;}}
if(Boolean(data)){if('object'==typeof(data)){var temp='';for(var p=0,lenP=data.length-1;p<lenP;p++){temp+=data[p]+',';}
temp+=data[lenP-1];showOption=showOption.replace(name,temp);}
else{showOption=showOption.replace(name,data);}}}
showOption=showOption.replace(/"<%/g,'');showOption=showOption.replace(/%>"/g,'');try{showOption=eval('({'+showOption+'})');if(!showOption.xAxis||0==showOption.xAxis.length){var arrAxis=[{type:'category',boundaryGap:false,data:timeShaft}];showOption.xAxis=arrAxis;}
else if(!showOption.xAxis[0].data||0==showOption.xAxis[0].data.length){showOption.xAxis[0].data=timeShaft;}
_this.drawChart(showOption);}
catch(e){_this.spinner.stop();return;}}}
ModalChartCustom.prototype.configModal=new ModalChartCustomConfig();return ModalChartCustom;})();var ModalPointKPI=(function(){function ModalPointKPI(screen,entityParams){if(!entityParams)return;this.isConfigMode=false;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalPointKPI.prototype=new ModalBase();ModalPointKPI.prototype.optionTemplate={name:'toolBox.modal.POINT_KPI',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalPointKPI'};ModalPointKPI.prototype.show=function(){this.init();}
ModalPointKPI.prototype.init=function(){this.pointKPIWiki=undefined;}
ModalPointKPI.prototype.renderModal=function(e){var _this=this,tempHtml='',level=1,rootId;this.spinner&&this.spinner.stop();if(!(this.entity.modal.option&&this.entity.modal.option.kpiList))return
this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});$(this.container).append(tempHtml);function traverseTree(tree){new PointKPIItem(tree,_this,0);rootId=tree.id;traverse(tree,0);}
function traverse(node,i){var children=node.list;node.pointPassData=[];node.show=true;if(children!=null&&children.length>0){if(node.parentId==rootId){level=2;}
new PointKPIItem(children[i],_this,level);if(i==children.length-1){for(var j=0;j<children.length;j++){j==0&&level++;traverse(children[j],0);}}else{traverse(node,i+1);}}}}
ModalPointKPI.prototype.showConfigMode=function(){}
ModalPointKPI.prototype.updateModal=function(points){}
ModalPointKPI.prototype.configure=function(){var _this=this;this.spinner&&this.spinner.stop();this.isConfigMode=true;if(this.chart)this.chart.clear();this.divResizeByMouseInit();var divMask=document.createElement('div');divMask.className='springConfigMask';divMask.draggable='true';var btnHeightResize=document.createElement('div');var maxHeight=this.optionTemplate.maxHeight;var maxWidth=this.optionTemplate.maxWidth;var minHeight=this.optionTemplate.minHeight;var minWidth=this.optionTemplate.minWidth;btnHeightResize.className='divResize divHeightResize';btnHeightResize.innerHTML='<label for="heightResize" >H: </label>'+'<input type="range" class="inputResize" id="heightResize" name="points" step="0.5" min="'+minHeight+'" max="'+maxHeight+'" value="'+_this.entity.spanR+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanR+' /6</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanR+'"/>';divMask.appendChild(btnHeightResize);var btnWidthResize=document.createElement('div');btnWidthResize.className='divResize divWidthResize';btnWidthResize.innerHTML='<label for="widthResize" >W: </label>'+'<input type="range" class="inputResize" id="widthResize" name="points" step="0.5" min="'+minWidth+'" max="'+maxWidth+'" value="'+_this.entity.spanC+'"/>'+'<h5 class="rangeVal">'+_this.entity.spanC+' /12</h5>'+'<input type="text" class="rangeChange" value="'+_this.entity.spanC+'"/>';divMask.appendChild(btnWidthResize);var divTitleAndType=document.createElement('div');divTitleAndType.className='divTitleAndType';divMask.appendChild(divTitleAndType);var $divTitle=$('<div class="divResize chartTitle">');var $labelTitle=$('<label for="title">').text(I18n.resource.dashboard.show.TITLE);var inputChartTitle=document.createElement('input');inputChartTitle.id='title';inputChartTitle.className='form-control';inputChartTitle.value=this.entity.modal.title;inputChartTitle.setAttribute('placeholder',I18n.resource.dashboard.show.TITLE_TIP);if(this.entity.modal.title!=''){inputChartTitle.style.display='none';}
inputChartTitle.setAttribute('type','text');$divTitle.append($labelTitle).append($(inputChartTitle));divTitleAndType.appendChild($divTitle[0]);var $divType=$('<div class="divResize chartType">');var $labelType=$('<label>').text(I18n.resource.dashboard.show.TYPE);var chartType=document.createElement('span');chartType.innerHTML=I18n.findContent(this.optionTemplate.name);$divType.append($labelType).append($(chartType));divTitleAndType.appendChild($divType[0]);var chartTitleShow=document.createElement('p');chartTitleShow.innerHTML=inputChartTitle.value;chartTitleShow.className='chartTitleShow';$divTitle[0].appendChild(chartTitleShow);if(this.entity.modal.title==''||this.entity.modal.title==undefined){chartTitleShow.style.display='none';}
chartTitleShow.onclick=function(){chartTitleShow.style.display='none';inputChartTitle.style.display='inline-block';inputChartTitle.focus();};inputChartTitle.onblur=function(){if(inputChartTitle.value!=''){inputChartTitle.style.display='none';chartTitleShow.style.display='inline';}
chartTitleShow.innerHTML=inputChartTitle.value;_this.entity.modal.title=inputChartTitle.value;};var $btnRemove=$('<span class="glyphicon glyphicon-remove-circle springConfigRemoveBtn"></span>');var $btnAdd=$('<span class="glyphicon glyphicon-remove-circle springConfigRemoveBtn addTree" style="transform: rotateZ(45deg);color: #333;right: 50px !important;"></span>');divMask.appendChild($btnAdd[0]);divMask.appendChild($btnRemove[0]);this.container.parentNode.appendChild(divMask);this.divResizeByToolInit();var divContainer=$(this.container).closest('.springContainer')[0];divMask.ondragstart=function(e){e.dataTransfer.setData("id",$(e.target).closest('.springContainer').get(0).id.replace('divContainer_',''));};divMask.ondragover=function(e){e.preventDefault();};divMask.ondragleave=function(e){e.preventDefault();};divContainer&&(divContainer.ondrop=function(e){e.stopPropagation();var sourceId=e.dataTransfer.getData("id");var $sourceParent,$targetParent;if(sourceId){var targetId=$(e.target).closest('.springContainer').get(0).id.replace('divContainer_','');if(sourceId==targetId)return;$sourceParent=$('#divContainer_'+sourceId).parent();$targetParent=$('#divContainer_'+targetId).parent();if(!$sourceParent[0].classList.contains('chartsCt')&&$targetParent[0].classList.contains('chartsCt')){_this.screen.insertChartIntoMix(sourceId,$(e.target).closest('.chartsCt')[0])}else{if(_this.screen.screen){_this.screen.screen.replaceEntity(sourceId,targetId,_this.screen.entity.id);}else{_this.screen.replaceEntity(sourceId,targetId);}}}
_this.screen.isScreenChange=true;})
var $select='<div class="form-group" style="position: absolute;top: 5px;left: 5px;">\
            <label for="inputEmail3" class="col-sm-2 control-label" style="height: 34px;line-height: 34px;">Cycle</label>\
            <div class="col-sm-8" style="display:inline-block;">\
                <select id="selectCycle" class="form-control" style="width: 100px;padding: 0;"> \
                    <option value="month">'+I18n.resource.dashboard.modalPointKPI.MONTH+'</option> \
                    <option value="season">'+I18n.resource.dashboard.modalPointKPI.QUARTER+'</option> \
                    </select>\
            </div>\
            </div>';$(this.container).append($select);var $selectCycle=$(this.container).find('#selectCycle');if(_this.entity.modal.option&&_this.entity.modal.option.dateCycle&&_this.entity.modal.option.dateCycle=='season'){$selectCycle.find('option:nth-of-type(2)')[0].selected='selected';}else{$selectCycle.find('option:nth-of-type(1)')[0].selected='selected';}
$selectCycle[0].onchange=function(){_this.entity.modal.option.dateCycle=$selectCycle[0].value;}
var $chartCt=$('<div class="divResize chartsCt gray-scrollbar" style="overflow:auto;">');$chartCt.append($(this.container));divMask.appendChild($chartCt[0]);if($('.level_2').width()>($chartCt.width()-320)){$('.domTree',$chartCt).width($('.level_2').width()+40);}
if($(this.container).find('.domTree').length==1){$btnAdd.attr('title','Already exists a root').addClass('btnDisabled');}
this.executeConfigMode();$btnRemove.off('click').on('click',function(){if(_this.chart)_this.chart.clear();if(_this.screen.screen){_this.screen.screen.removeEntity(_this.entity.id);}else{_this.screen.removeEntity(_this.entity.id);}
$('#divContainer_'+_this.entity.id).remove();_this=null;});$btnAdd.off('click').on('click',function(){if($(_this.container).find('.domTree').length==0){new PointKPIItem({parentId:''},_this,0);$('#divContainer_'+_this.entity.id).find('.addTree').attr('title','Already exists a root').addClass('btnDisabled');_this.screen.isScreenChange=true;}});}
ModalPointKPI.prototype.initContainer=function(replacedElementId){var _this=this;var divParent=document.getElementById('divContainer_'+this.entity.id);var isNeedCreateDivParent=false;var scrollClass=' gray-scrollbar';if((!divParent)||replacedElementId){isNeedCreateDivParent=true;}
if(isNeedCreateDivParent){divParent=document.createElement('div');divParent.id='divContainer_'+this.entity.id;}
if(replacedElementId){var $old=$('#divContainer_'+replacedElementId);$(divParent).insertAfter($old);$old.remove();}
else{isNeedCreateDivParent&&this.screen.container.appendChild(divParent);}
divParent.className='springContainer';if(AppConfig.isMobile){divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR*2+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC*2+'%';}else{divParent.style.height=this.UNIT_HEIGHT*this.entity.spanR+'%';divParent.style.width=this.UNIT_WIDTH*this.entity.spanC+'%';}
if(this.entity.modal.title&&this.entity.modal.title!=''&&(!this.entity.isNotRender)){divParent.innerHTML='<div class="panel panel-default">\
                <div class="panel-heading springHead">\
                    <h3 class="panel-title" style="font-weight: bold;">'+this.entity.modal.title+'</h3>\
                </div>\
                <div class="panel-body springContent'+scrollClass+'" style="overflow:auto;"></div>\
            </div>';}else{divParent.innerHTML='<div class="panel panel-default" style="background: none;">\
                <div class="panel-body springContent'+scrollClass+'" style="height:100%;overflow:auto;"></div>\
            </div>';}
var divBtnCtn=document.createElement('div');divBtnCtn.className='springLinkBtnCtn';var domPanel=divParent.getElementsByClassName('panel')[0];var lkHistory=document.createElement('a');lkHistory.className='springLinkBtn';lkHistory.title='Show History';lkHistory.href='javascript:;';lkHistory.innerHTML='<span class="glyphicon glyphicon-stats"></span>';divBtnCtn.appendChild(lkHistory);lkHistory.onclick=function(){var dataTree=_this.entity.modal.option.kpiList[0];var dateCycle=!_this.entity.modal.option.dateCycle?'month':_this.entity.modal.option.dateCycle;if(Boolean(dataTree)){new ModalPointKpiGrid(dataTree,dateCycle).show();}};domPanel.appendChild(divBtnCtn);this.initToolTips(divParent.getElementsByClassName('springHead'));this.container=divParent.getElementsByClassName('springContent')[0];}
ModalPointKPI.prototype.setModalOption=function(option){this.entity.modal.interval=5;}
return ModalPointKPI;})();var PointKPIItem=(function(){function PointKPIItem(item,entity,i){this.parentArgt=entity;this.entity=entity.entity;this.container=entity.container;this.kpiItem={id:!item.id?new Date().getTime():item.id,parentId:!item.parentId?'':item.parentId,name:!item.name?'Unaming':item.name,pointKPI:!item.pointKPI?'':item.pointKPI,pointGrade:!item.pointGrade?'':item.pointGrade,pointPass:!item.pointPass?'':item.pointPass,rule:!item.rule?'':item.rule,weight:!item.weight?'':item.weight,wikiId:!item.wikiId?'':item.wikiId,list:!item.list?[]:item.list};if(i===0&&!item.id&&item.parentId==''){!this.entity.modal.option&&(this.entity.modal.option={});!this.entity.modal.option.kpiList&&(this.entity.modal.option.kpiList=[]);this.entity.modal.option.kpiList.push(this.kpiItem);}
this.addItemDom(this.kpiItem,i)
this.attachEventsItem(this.kpiItem);}
PointKPIItem.prototype.addItem=function(id){var _this=this;var level=1;var pointKPIItem;this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(id==node.id){pointKPIItem=new PointKPIItem({parentId:id},_this.parentArgt,level);node.list.push(pointKPIItem.kpiItem);return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){j==0&&level++;traverse(children[j],0);}}else{traverse(node,i+1);}}}}
var btn_tpl='\
            <div class="btnGroup">\
                <span class="glyphicon glyphicon-remove-circle btnAddItem" style="transform: rotateZ(45deg);"></span>\
                <span class="glyphicon glyphicon-cog btnConfigItem"></span>\
                <span class="glyphicon glyphicon-info-sign btnConfigWiki"></span>\
                <span class="glyphicon glyphicon-remove-circle btnRemoveItem"></span>\
                <span class="glyphicon glyphicon-info-sign btnViewWiki{isShow}" wikiId="{wikiId}"></span>\
            </div>';PointKPIItem.prototype.tpl={treeWrap:'<div class="domTree"></div>',level_1_Tpl:'\
            <div class="totalLevel">\
                <div class="itemWrap" id="kpi_{id}">\
                    <div class="hrLine"></div>\
                    <span class="pointName">{name}</span>\
                    <span class="glyphicon glyphicon-pencil"></span>\
                    <div class="circle {bgColor}">\
                        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                        <span>{pointPassVal}</span>\
                    </div>'+btn_tpl+'</div>\
            </div>',level_2_Ctn:'\
            <div class="level_2">\
                <div class="hrLine1"></div>\
                <ul></ul>\
            </div>',level_2_Tpl:'<li class="level_3" parentId="{parentId}" id="item_{id}">\
            	<div class="thirdCon1">\
                	<div class="itemWrap" id="kpi_{id}">\
                	    <div class="circle {bgColor}">\
                	        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                	        <span>{pointPassVal}</span>\
                	    </div>\
                	    <span class="pointName">{name}</span><span class="glyphicon glyphicon-pencil"></span><br class="clear"><div class="hrLine2"></div>'+btn_tpl+'</div>\
                </div>\
                <ul class="childLevel">\
                </ul>\
            </li>',level_3_Tpl:'<li parentId="{parentId}" id="item_{id}">\
                <div class="hrLine3"></div>\
                <div class="itemWrap" id="kpi_{id}">\
                    <div class="smCircle {bgColor}">\
                        <div class="active-border active-border_{bgColor}" data-value=""></div>\
                        <span>{pointPassVal}</span>\
                    </div>\
                    <span class="pointName">{name}</span>\
                    <span class="glyphicon glyphicon-pencil"></span><br class="clear">\
                    <div class="hrLine4"></div>'+btn_tpl+'</div>\
                <ul class="childLevel">\
                </ul>\
            </li>'}
PointKPIItem.prototype.addItemDom=function(kpiItem,i){var kpiItemForEl={id:kpiItem.id,parentId:kpiItem.parentId,name:kpiItem.name,isShow:kpiItem.wikiId!=''?' showWiki':'',pointPassVal:kpiItem.pointPass!=''?I18n.resource.dashboard.modalPointKPI.UNPASS:I18n.resource.dashboard.modalPointKPI.PASS,bgColor:kpiItem.pointPass!=''?'unpass':'pass'}
var $domTree=$(this.container).children('.domTree'),$level_2_ul,$level_3_ul;$domTree&&($level_2_ul=$domTree.find('.level_2>ul'));$level_2_ul&&($level_3_ul=$level_2_ul.find('#item_'+kpiItem.parentId+' > .childLevel'));if(kpiItem.parentId==''){$(this.container).append(this.tpl.treeWrap);$domTree=$(this.container).children('.domTree');$domTree.html(this.tpl.level_1_Tpl.formatEL(kpiItemForEl));}else if(i==1&&$domTree){if($level_2_ul.length==0){$domTree.append(this.tpl.level_2_Ctn);$level_2_ul=$domTree.find('.level_2>ul');}
if($domTree.parent().width()-$level_2_ul.width()<270){$domTree.width($domTree.width()+255);}
$level_2_ul.append(this.tpl.level_2_Tpl.formatEL(kpiItemForEl))}else if($level_2_ul){$level_3_ul.append(this.tpl.level_3_Tpl.formatEL(kpiItemForEl));if($level_3_ul.find('.itemWrap').width()<140){$level_3_ul.find('.btnAddItem').hide();}}}
PointKPIItem.prototype.removeItem=function(id){var _this=this;this.entity.modal.option.kpiList.forEach(function(kpiItem,index){if(kpiItem.id==id&&kpiItem.parentId==''){_this.entity.modal.option.kpiList.splice(index,1);$('#kpi_'+id).closest('.domTree').remove();$('#divContainer_'+_this.entity.id).find('.addTree').removeClass('btnDisabled').attr('title','');}else{traverseTree(kpiItem);}});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(children!=null&&children.length>0){if(id==children[i].id){node.list.splice(i,1);$('#kpi_'+id).closest('li').remove();return;}else{if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}}
PointKPIItem.prototype.showConfigModal=function(){var _this=this,$modalConfig=$('#modalConfig');var tempHtml='\
            <div class="modal-body" id="pointKPI">\
                <div class="form-horizontal">\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divKPI">KPI</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divKPI">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divGrade">Grade</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divGrade">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divIsPass">Is pass</label>\
                        <div class="col-md-4">\
                            <div class="drop-area" id="divIsPass">\
                                <span class="glyphicon glyphicon-plus"></span>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="form-group">\
                        <label class="col-md-3 control-label" for="divDashboard">Config dashboard</label>\
                        <div class="col-md-4">\
                            <button type="button" id="btnDashboard" class="btn btn-default">Config</button>\
                        </div>\
                    </div>\
                </div>\
            </div>';$modalConfig.off('show.bs.modal').on('show.bs.modal',function(e){var pointKPIAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointKPI).alias;var pointGradeAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointGrade).alias;var pointPassAlias=AppConfig.datasource.getDSItemById(_this.kpiItem.pointPass).alias;$modalConfig.find('.modal-body').hide();$modalConfig.find('.modal-footer').before(tempHtml);$modalConfig.find('#divKPI').attr('data-value',_this.kpiItem.pointKPI).attr('title',pointKPIAlias).html(pointKPIAlias);$modalConfig.find('#divGrade').attr('data-value',_this.kpiItem.pointGrade).attr('title',pointKPIAlias).html(pointGradeAlias);$modalConfig.find('#divIsPass').attr('data-value',_this.kpiItem.pointPass).attr('title',pointKPIAlias).html(pointPassAlias);if(pointPassAlias){$modalConfig.find('#startConfig').removeClass('disabled');}
_this.parentArgt.screen.modalConfigPane.toggleDataSource(true);_this.attachEventsConfig($modalConfig)});$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$modalConfig.find('#pointKPI').remove();_this.parentArgt.screen.modalConfigPane.toggleDataSource(false);});$modalConfig.modal('show');}
PointKPIItem.prototype.viewDetail=function(){var $dialog=$('#dialogModal');var energyScreen=new EnergyScreen();var $dialogContent=$dialog.find('#dialogContent').css({height:'90%',width:'90%',margin:'auto',marginTop:'2.5%',backgroundColor:'#fff'});$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$dialogContent.removeAttr('style').html('');energyScreen.workerUpdate&&energyScreen.workerUpdate.terminate();}).modal({});energyScreen.id=this.kpiItem.id+'_'+AppConfig.userId;energyScreen.container=$dialogContent[0];energyScreen.isForBencMark=true;energyScreen.init();}
PointKPIItem.prototype.attachEventsItem=function(kpiItem){var $kpiWrap=$('#kpi_'+kpiItem.id),_this=this;$('.btnAddItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.addItem(_this.kpiItem.id);_this.parentArgt.screen.isScreenChange=true;});$('.btnRemoveItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.removeItem(_this.kpiItem.id);var $domTree=$('.domTree');if($(this).closest('.thirdCon1').length==1&&$domTree.width()-$('.level_2').width()>260){$domTree.width($domTree.width()-255);}
_this.parentArgt.screen.isScreenChange=true;});$('.btnConfigItem',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.showConfigModal();});$('.btnConfigWiki',$kpiWrap).off().on('click',function(e){e.stopPropagation();if(_this.kpiItem.wikiId){_this.showWikiEditModal();}else{_this.showWikiSearchModal();}});$('.btnViewWiki',$kpiWrap).off().on('click',function(e){e.stopPropagation();_this.viewWikiInfoModal();});$('.glyphicon-pencil',$kpiWrap).off().on('click',function(e){e.stopPropagation();if(_this.parentArgt.isConfigMode==true){_this.editPointKPIName();}});$kpiWrap.off().on('click',function(e){e.stopPropagation();if(_this.parentArgt.isConfigMode==false){_this.viewDetail(_this.kpiItem.id);}});}
PointKPIItem.prototype.attachEventsConfig=function($modalConfig){var _this=this;var $dropArea=$modalConfig.find('.drop-area');var $btnConfig=$modalConfig.find('#startConfig');var $btnDashboard=$modalConfig.find('#btnDashboard');$dropArea.off('dragover').on('dragover',function(e){e.preventDefault();});$dropArea.off('dragenter').on('dragenter',function(e){$(e.target).addClass('on');e.preventDefault();e.stopPropagation();});$dropArea.off('dragleave').on('dragleave',function(e){$(e.target).removeClass('on');e.stopPropagation();});$dropArea.off('drop').on('drop',function(e){var transfer=e.originalEvent.dataTransfer;var itemId=transfer.getData('dsItemId');var $target=$(e.target);var name;if(!itemId)return;$target.removeClass('on');name=AppConfig.datasource.getDSItemById(itemId).alias;$target.attr({'data-value':itemId,'title':name});$target.html('<span>'+name+'</span>');e.stopPropagation();if($target.attr('id')=='divIsPass'){$btnConfig.removeClass('disabled');}
_this.parentArgt.screen.isScreenChange=true;});$btnConfig.off().on('click',function(){var KPI=$('#divKPI').attr('data-value');var grade=$('#divGrade').attr('data-value');var pass=$('#divIsPass').attr('data-value');_this.kpiItem.pointKPI=!KPI?'':KPI;_this.kpiItem.pointGrade=!grade?'':grade;_this.kpiItem.pointPass=!pass?'':pass;_this.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.kpiItem.id){node.pointKPI=_this.kpiItem.pointKPI;node.pointGrade=_this.kpiItem.pointGrade;node.pointPass=_this.kpiItem.pointPass;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}
$('#modalConfig').modal('hide');});$btnDashboard.off('click').on('click',function(){ScreenManager.show(EnergyScreen,_this.kpiItem.id+'_'+AppConfig.userId);});}
PointKPIItem.prototype.showWikiSearchModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.showWikiSearch();}
PointKPIItem.prototype.showWikiEditModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.getWikiById();}
PointKPIItem.prototype.viewWikiInfoModal=function(){if(!(this.pointKPIWiki&&this.pointKPIWiki.parent.kpiItem.id==this.kpiItem.id)){this.pointKPIWiki=new ModalWiki(this);}
this.pointKPIWiki.viewWikiInfo(this.kpiItem.wikiId);}
PointKPIItem.prototype.editPointKPIName=function(){var _this=this,$divKPI=$('#kpi_'+this.kpiItem.id),$input=$divKPI.find('.pointNameInput'),$springConfigMask;if($input.length==0){var $input=$('<input type="text" class="form-control pointNameInput"/>').val(_this.kpiItem.name);var $spanName=$('.pointName','#kpi_'+this.kpiItem.id).hide().after($input);$springConfigMask=$divKPI.closest('.springConfigMask[draggable="true"]').attr('draggable',false);$input.blur(function(){savePointName(this);}).keyup(function(e){if(e.keyCode==13){savePointName(this);}});}else{savePointName($input[0]);}
function savePointName(divInput){_this.kpiItem.name=$(divInput).val();$(divInput).remove();$spanName.html(_this.kpiItem.name).show();$springConfigMask.attr('draggable',true);_this.parentArgt.entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});_this.parentArgt.screen.isScreenChange=true;function traverseTree(tree){traverse(tree,0);}
function traverse(node,i){var children=node.list;if(node.id==_this.kpiItem.id){node.name=_this.kpiItem.name;return;}
if(children!=null&&children.length>0){if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}}}
return PointKPIItem;})();var ModalPointKpiGrid=(function(){var _this;function ModalPointKpiGrid(data,dateCycle){if(Boolean(data)){this.m_kpiDataTree=data;this.m_dateCycle=dateCycle;this.m_selectYear=0;this.m_htmlPage;this.m_htmlTreeTemp;this.m_htmlGridTemp;this.m_bIsCurrentYear=false;this.m_nCurrentSeason=0;this.m_nCurrentMonth=0;this.m_strGood='达标';this.m_strBad='未达标';this.m_strCurrentGood='当前达标';this.m_strCurrentBad='当前超标';this.m_strCurrentWarn='警戒';this.m_nStartYear=0;this.m_nEndYear=0;_this=this;}}
ModalPointKpiGrid.prototype=new ModalPointKpiGrid();ModalPointKpiGrid.prototype.show=function(){this.init();}
ModalPointKpiGrid.prototype.init=function(){WebAPI.get('/static/views/observer/widgets/modalPointKpiGrid.html').done(function(resultHtml){_this.m_htmlPage=$(resultHtml);var timeControl=_this.m_htmlPage.find('#timeSelect');var tmNow=new Date();var tmStart=new Date();tmStart.setFullYear(tmNow.getFullYear()-10);_this.m_nStartYear=tmStart.getFullYear();_this.m_nEndYear=tmNow.getFullYear();timeControl.val(tmNow.format('yyyy'));timeControl.datetimepicker({format:'yyyy',startView:'decade',minView:'decade',autoclose:true,todayBtn:false,pickerPosition:'bottom-right',initialDate:tmNow,startDate:tmStart,endDate:tmNow,keyboardNavigation:false}).off('changeDate').on('changeDate',function(ev){_this.m_selectYear=timeControl.val();var tmNow=new Date();var nCurYear=tmNow.getFullYear();if(nCurYear==_this.m_selectYear){_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;}
else{_this.m_bIsCurrentYear=false;}
_this.postDataShow(false);});var yearPre=_this.m_htmlPage.find('#btnYearPre');if(Boolean(yearPre)){yearPre.click(function(e){var year=parseInt(timeControl.val());if(year<=_this.m_nStartYear){year=_this.m_nStartYear;return;}
else{year-=1;}
timeControl.val(year);_this.timeSetting(timeControl.val());_this.postDataShow(false);});}
var yearNext=_this.m_htmlPage.find('#btnYearNext');if(Boolean(yearNext)){yearNext.click(function(e){var year=parseInt(timeControl.val());if(year>=_this.m_nEndYear){year=_this.m_nEndYear;return;}
else{year+=1;}
timeControl.val(year);_this.timeSetting(timeControl.val());_this.postDataShow(false);});}
var tmNow=new Date();_this.m_selectYear=tmNow.getFullYear();_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;_this.postDataShow(true);}).always(function(){});}
ModalPointKpiGrid.prototype.postDataShow=function(bIsFirst){var ptPassArray=[];ptPassArray=_this.recursiveTreeGetPointPassId(_this.m_kpiDataTree);var tmStart=new Date();tmStart.setMonth(0);tmStart.setDate(1);tmStart.setHours(0);tmStart.setMinutes(0);tmStart.setSeconds(0);var tmEnd=new Date();if(!bIsFirst&&tmStart.getFullYear()!=_this.m_selectYear){tmStart.setFullYear(_this.m_selectYear);tmEnd.setFullYear(_this.m_selectYear);tmEnd.setMonth(11);tmEnd.setDate(31);tmEnd.setHours(23);tmEnd.setMinutes(59);tmEnd.setSeconds(59);}
var postData={};postData.dataSourceId='';postData.dsItemIds=ptPassArray;postData.timeStart=tmStart.format('yyyy-MM-dd hh:mm:ss');postData.timeEnd=tmEnd.format('yyyy-MM-dd hh:mm:ss');postData.timeFormat='M1';if(bIsFirst){Spinner.spin($('#paneCenter')[0]);}
else{Spinner.spin(_this.m_htmlPage[2]);}
var tree=_this.m_htmlPage.find('#treeCtl');tree.html('');var table=_this.m_htmlPage.find('#tableCtl');table.html('');WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(result){var res=JSON.parse(result);if(!res||!res.list){return;}
for(var i=0,len=res.list.length;i<len;i++){_this.recursiveTreeSetPointPassData(_this.m_kpiDataTree,res.list[i].dsItemId,res.list[i].data);}
var divContain=$('<div style="cursor:pointer"></div>');divContain.append('<ul class="kpiGridHeader" style="height:32px;margin-bottom:0px"></ul>');tree.append(divContain);var head=$('<thead class="kpiGridHeader"></thead>');var headTr=$('<tr></tr>');if('season'==_this.m_dateCycle){for(var i=0;i<4;i++){var headTh=$('<th colspan="3" class="colSeason">'+(i+1)+'季度</th>');headTr.append(headTh);}
head.append(headTr);}
else if('month'==_this.m_dateCycle){headTr=$('<tr></tr>');for(var i=0;i<12;i++){var headTh=$('<th class="colMonth">'+(i+1)+'月</th>');headTr.append(headTh);}
head.append(headTr);}
table.append(head);_this.showControlInfo();if(bIsFirst){_this.m_htmlPage.modal('show');}}).always(function(){Spinner.stop();});}
ModalPointKpiGrid.prototype.showControlInfo=function(){_this.m_htmlTreeTemp=$('<div style="cursor:pointer"></div>');_this.m_htmlGridTemp=$('<tbody class="kpiGridBody"></tbody>');_this.recursiveTreeSetting(_this.m_kpiDataTree);_this.m_htmlPage.find('#treeCtl').append(_this.m_htmlTreeTemp);_this.m_htmlPage.find('#tableCtl').append(_this.m_htmlGridTemp);}
ModalPointKpiGrid.prototype.recursiveTreeSetting=function(item){var parentNode;if(''==item.parentId){parentNode=_this.m_htmlTreeTemp;}
else{parentNode=_this.m_htmlTreeTemp.find('#tree_'+item.parentId).find('.rows').eq(0);}
if(parentNode.length>0){var bLeaf=(0==item.list.length)?true:false;_this.insertTreeCtrl(item.id,item.name,parentNode,bLeaf);}
var nLen=item.pointPassData.length;if(nLen<12){for(var i=nLen,len=12-nLen;i<12;i++){item.pointPassData.push(-1);}}
nLen=12;var gridTr1=$('<tr class="kpiGridRow" id="grid1_'+item.id+'"></tr>');var gridTd1='';var nLen=item.pointPassData.length;var bIsCurrent=false;var strShow;if('season'==_this.m_dateCycle){var arrSeason=[item.pointPassData[0],item.pointPassData[3],item.pointPassData[6],item.pointPassData[9]];for(var i=0;i<4;i++){if(_this.m_bIsCurrentYear&&i==_this.m_nCurrentSeason){bIsCurrent=true;}
else{bIsCurrent=false;}
if(-1==arrSeason[i]){gridTd1+='<td colspan=3></td>';}
else if(Boolean(arrSeason[i])){strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=3 class="kpiGridGood">'+strShow+'</td>';}
else{strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=3 class="kpiGridBad">'+strShow+'</td>';}}}
else if('month'==_this.m_dateCycle){for(var i=0;i<nLen;i++){if(_this.m_bIsCurrentYear&&i==_this.m_nCurrentMonth){bIsCurrent=true;}
else{bIsCurrent=false;}
if(-1==item.pointPassData[i]){gridTd1+='<td colspan=1></td>';}
else if(Boolean(item.pointPassData[i])){strShow=bIsCurrent?_this.m_strCurrentGood:_this.m_strGood;gridTd1+='<td colspan=1 class="kpiGridGood">'+strShow+'</td>';}
else{strShow=bIsCurrent?_this.m_strCurrentBad:_this.m_strBad;gridTd1+='<td colspan=1 class="kpiGridBad">'+strShow+'</td>';}}}
gridTr1.append($(gridTd1));_this.m_htmlGridTemp.append(gridTr1);var nChildNum=item.list.length;if(0==nChildNum){}
else{for(var i=0;i<nChildNum;i++){arguments.callee(item.list[i]);}}}
ModalPointKpiGrid.prototype.recursiveTreeSetShow=function(item,nFindId,bIsShow){if(nFindId==item.id){for(var i=0,len=item.list.length;i<len;i++){item.list[i].show=bIsShow;}
return;}
else{for(var i=0,len=item.list.length;i<len;i++){arguments.callee(item.list[i],nFindId,bIsShow);}}}
ModalPointKpiGrid.prototype.recursiveTreeGetShow=function(item){var arr=[];var nLen=item.list.length;if(nLen>0){if(item.show){arr.push(item.id);for(var i=0;i<nLen;i++){var temp=arguments.callee(item.list[i]);arr=arr.concat(temp);}}}
else{if(item.show){return[item.id];}}
return arr;}
ModalPointKpiGrid.prototype.recursiveTreeGetPointPassId=function(item){var arr=[];var nLen=item.list.length;if(nLen>0){if(item.show){arr.push(item.pointPass);for(var i=0;i<nLen;i++){var temp=arguments.callee(item.list[i]);arr=arr.concat(temp);}}}
else{if(item.show){return[item.pointPass];}}
return arr;}
ModalPointKpiGrid.prototype.recursiveTreeSetPointPassData=function(item,nPtPassId,ptPassData){if(nPtPassId==item.pointPass){item.pointPassData=ptPassData;return;}
else{for(var i=0,len=item.list.length;i<len;i++){arguments.callee(item.list[i],nPtPassId,ptPassData);}}}
ModalPointKpiGrid.prototype.insertTreeCtrl=function(groupId,groupName,parentNode,bIsLeaf){var $ul=$('<ul class="nav nav-list kpiTreeGroup" id="tree_'+groupId+'">');var $liHd;if(bIsLeaf){$liHd=$('<li class="kpiTreeHeader"><span style="margin-left:40px"></span></li>');}
else{$liHd=$('<li class="kpiTreeHeader"><img src="/static/images/dataSource/group_head_sel.png" alt="png" class="dsTreeHeaderIcon"></li>');}
var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);$liHd.click(function(e){var tar=$(e.currentTarget);if(Boolean(tar)){var treeItemId=tar.closest('.kpiTreeGroup')[0].id;var num=treeItemId.substring(5);var bindRow=tar.next('.rows');if(Boolean(bindRow)){var bIsShow=true;var showFlag=bindRow.eq(0).css('display');if('block'==showFlag){bIsShow=false;}
else{bIsShow=true;}
_this.recursiveTreeSetShow(_this.m_kpiDataTree,num,bIsShow);var arr=_this.recursiveTreeGetShow(_this.m_kpiDataTree);var arrGrid=[];for(var k=0,len3=arr.length;k<len3;k++){arrGrid.push('grid1_'+arr[k]);arrGrid.push('grid2_'+arr[k]);}
var body=_this.m_htmlPage.find('#tableCtl tbody tr');for(var i=0,len=body.length;i<len;i++){var trFind=false;for(var j=0,len2=arrGrid.length;j<len2;j++){if(body[i].id==arrGrid[j]){trFind=true;break;}}
if(!trFind){$(body[i]).css('display','none');}
else{$(body[i]).css('display','');}}
bindRow.slideToggle();}}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow);parentNode.append($ul);}
ModalPointKpiGrid.prototype.timeSetting=function(selYear){_this.m_selectYear=selYear;var tmNow=new Date();var nCurYear=tmNow.getFullYear();if(nCurYear==_this.m_selectYear){_this.m_nCurrentMonth=tmNow.getMonth();_this.m_nCurrentSeason=Math.floor(_this.m_nCurrentMonth/3);_this.m_bIsCurrentYear=true;}
else{_this.m_bIsCurrentYear=false;}}
return ModalPointKpiGrid;})();var ModalReportChapter=(function(){function ModalReportChapter(screen,entityParams){if(!entityParams)return;ModalBase.call(this,screen,entityParams,this.renderModal,this.updateModal,this.showConfigMode);};ModalReportChapter.prototype=new ModalBase();ModalReportChapter.prototype.optionTemplate={name:'toolBox.modal.REPORT_CHAPTER',parent:0,mode:['realTimeDashboard'],maxNum:30,title:'',minHeight:2,minWidth:3,maxHeight:6,maxWidth:12,type:'ModalReportChapter'};ModalReportChapter.prototype.show=function(){this.init();}
ModalReportChapter.prototype.init=function(){}
ModalReportChapter.prototype.renderModal=function(e){var _this=this;var postData={projectId:AppConfig.projectId,menuId:this.entity.modal.option.menuId,chapter:this.entity.modal.option.chapter,unit:this.entity.modal.option.unit};WebAPI.post('/report/getReportHtml/',postData).done(function(result){if(result.success){_this.spinner&&_this.spinner.stop();_this.container.innerHTML=result.data;_this.reportScreen=new ReportScreen();_this.reportScreen.renderCharts($('#beopReport .report-unit'))}else{alert(result.msg);}}).always(function(){_this.spinner&&_this.spinner.stop();});}
ModalReportChapter.prototype.showConfigMode=function(){}
ModalReportChapter.prototype.updateModal=function(points){}
ModalReportChapter.prototype.setModalOption=function(option){}
ModalReportChapter.prototype.modalDialog='\
        <div class="modal-content">\
            <div class="modal-header">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>\
                <h4 class="modal-title" id="">Config</h4>\
            </div>\
            <div class="modal-body">\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Type</label>\
                    </div>\
                    <div class="col-xs-4">\
                        <select id="typeList" class="form-control type"></select>\
                    </div>\
                </div>\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Chapter</label>\
                    </div>\
                    <div class="col-xs-4" id="chapterList">\
                    </div>\
                </div>\
                <div class="row" style="margin-bottom: 15px;">\
                    <div class="col-xs-4">\
                        <label>Section</label>\
                    </div>\
                    <div class="col-xs-4" id="unitList">\
                    </div>\
                </div>\
            </div>\
            <div class="modal-footer">\
                <div id="configAlert"></div>\
                <button type="button" class="btn btn-primary" id="confirm">Confirm</button>\
            </div>\
        </div>';ModalReportChapter.prototype.showConfigModal=function(){var _this=this;var $dialogModal=$('#dialogModal');var $dialogContent=$dialogModal.find('#dialogContent').html(this.modalDialog);var $modalBody=$dialogContent.find('.modal-body');var $confirm=$dialogContent.find('#confirm');$dialogModal.modal('show');Spinner.spin($dialogContent.find('.modal-content')[0]);WebAPI.get('/report/getReportMenu/'+AppConfig.projectId).done(function(result){var $typeList=$modalBody.find('#typeList').empty();var $chapterList=$modalBody.find('#chapterList').empty();var $unitList=$modalBody.find('#unitList').empty();var typeTemp='',$firstUnitSelect,$firstChapterSelect;if(result.data&&result.data.length>0){for(var i=0;i<result.data.length;i++){var type=result.data[i];typeTemp+=('<option value="'+type._id+'" id="'+i+'">'+type.text+'</option>');var $selectChapter=$('<select id="chapter_'+i+'" class="form-control chapter" style="display: none;"></select>');if(type.structure&&type.structure.data&&type.structure.data.length>0){$selectChapter.append('<option value="all" class="type">All Chapter</option>')
for(var j=0;j<type.structure.data.length;j++){var chapter=type.structure.data[j];$selectChapter.append('<option value="'+chapter.name+'" id="'+j+'" parentId="'+i+'">'+chapter.name+'</option>');var $selectUnit=$('<select id="unit_'+i+'_'+j+'" class="form-control unit" style="display: none;"></select>');if(chapter.units&&chapter.units.length>0){$selectUnit.append('<option value="all">All Section</option>');for(var k=0;k<chapter.units.length;k++){var unit=chapter.units[k];$selectUnit.append('<option value="'+unit.unitName+'" id="'+k+'" parentId="'+j+'">'+unit.unitName+'</option>');}}else{$selectUnit.append('<option value="no">No Section</option>');}
$unitList.append($selectUnit);}}else{$selectChapter.append('<option value="no" class="type">No Chapter</option>')}
$chapterList.append($selectChapter);}}else{typeTemp+='<option value="no" class="type">No type</option>';}
$typeList.html(typeTemp);$firstChapterSelect=$chapterList.find('select:eq(0)').show();$firstUnitSelect=$unitList.find('select:eq(0)').show();if($firstChapterSelect.length==0){$chapterList.append('<select class="form-control chapter no"><option value="no" class="type">No Section</option></select>');}
if($firstUnitSelect.length==0){$unitList.append('<select class="form-control unit no"><option value="no" class="type">No Section</option></select>');}
if(_this.entity.modal.option&&result.data&&result.data.length>0){var $selectedChapter=undefined;var $selectedUnit=undefined;var $typeOption=undefined;var $chapterOption=undefined;if(_this.entity.modal.option.menuId){$typeList.val(_this.entity.modal.option.menuId);$typeOption=$typeList.find('option[value="'+_this.entity.modal.option.menuId+'"]');}
if(_this.entity.modal.option.chapter!=undefined){$chapterList.children().hide();$selectedChapter=$chapterList.find('#chapter_'+$typeOption.attr('id'));$selectedChapter.show()
if(_this.entity.modal.option.chapter!=''){$selectedChapter.val(_this.entity.modal.option.chapter);$chapterOption=$selectedChapter.find('option[value="'+_this.entity.modal.option.chapter+'"]');}}
if(_this.entity.modal.option.unit!=undefined&&$chapterOption!=undefined&&$chapterOption.length>0){$unitList.children().hide();$selectedUnit=$unitList.find('#unit_'+$chapterOption.attr('parentId')+'_'+$chapterOption.attr('id'));$selectedUnit.show()
if(_this.entity.modal.option.unit!=''){$selectedUnit.val(_this.entity.modal.option.unit)}}}
$modalBody.off('change').on('change','select',function(){$modalBody.find('select.no').remove();if($(this).hasClass('type')){var typeId=$(this).find('option[value="'+this.value+'"]')[0].id;var $chapterSelect=$('#chapter_'+typeId);$chapterList.children().hide();$chapterSelect.show();var chapterId=$chapterSelect.find('option[value="'+$chapterSelect[0].value+'"]').attr('id');$unitList.children().hide();if(chapterId){var $unitSelect=$('#unit_'+typeId+'_'+chapterId);$unitSelect.show();}else if($chapterSelect[0].value=='all'){$unitList.append('<select class="form-control unit no"><option value="all">All Section</option></select>');}else{$unitList.append('<select class="form-control unit no"><option value="no" class="type">No Section</option></select>');}}
if($(this).hasClass('chapter')){var $typeList=$('#typeList');var typeId=$typeList.find('option[value="'+$typeList[0].value+'"]')[0].id;var $chapterSelect=$('#chapter_'+typeId);var chapterId=$chapterSelect.find('option[value="'+this.value+'"]').attr('id');$unitList.children().hide();if(chapterId){var $unitSelect=$('#unit_'+typeId+'_'+chapterId);$unitSelect.show();}else if($chapterSelect[0].value=='all'){$unitList.append('<select class="form-control unit no"><option value="all">All Section</option></select>');}else{$unitList.append('<select class="form-control unit no"><option value="no">No Section</option></select>');}}});$dialogModal.off('shown.bs.modal').on('shown.bs.modal',function(){});$dialogModal.off('hidden.bs.modal').on('hidden.bs.modal',function(){$dialogContent.empty();});$confirm.off('click').on('click',function(){var chapterVal=$chapterList.find('select:not(:hidden)')[0].value;var unitVal=$unitList.find('select:not(:hidden)')[0].value;var menuId=$typeList[0].value;!_this.entity.modal.option&&(_this.entity.modal.option={});_this.entity.modal.option.menuId=menuId=='no'?'':menuId;_this.entity.modal.option.chapter=(chapterVal=='no'||chapterVal=='all')?'':chapterVal;_this.entity.modal.option.unit=(unitVal=='no'||unitVal=='all')?'':unitVal;$dialogModal.modal('hide');if(_this.entity.modal.option.menuId&&_this.entity.modal.option.menuId!=''){_this.screen.isScreenChange=true;}});}).fail(function(){}).always(function(){Spinner.stop();});};return ModalReportChapter;})();var WorkflowInsert=(function(){function WorkflowInsert(insertData,submitFunc,cancelFunc,insertFunc){this.$container=$('');this.insertData=insertData;this.teamList=[];this.submitFunc=submitFunc;this.cancelFunc=cancelFunc;this.insertFunc=insertFunc;}
WorkflowInsert.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/workflow/insert.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);Spinner.spin(ElScreenContainer);_this.$container=$("#workflow-insert");_this.init();I18n.fillArea($(ElScreenContainer));});},close:function(){},init:function(){this.loadData();this.attachEvents();},setSubmitFunc:function(func){this.submitFunc=func;},setCancelFunc:function(func){this.cancelFunc=func;},setInsertFunc:function(func){this.insertFunc=func;},attachEvents:function(){var _this=this;this.$container.on('change','#selectGroup',function(){var $this=$(this);_this.insertData.groupId=$this.val();WebAPI.get('/workflow/getGroupMembers/'+_this.insertData.groupId).done(function(result){if(result.success){var selectExecutorHtml=beopTmpl('selectExecutorTmpl',result.data);$('#selectExecutor').replaceWith(selectExecutorHtml);}})});this.$container.on("click","#workflow-insert-submit",function(){if(_this.submitCheck()){Spinner.spin(ElScreenContainer);if(!_this.teamList.length){_this.setFloatingWin($("#noTeamHandle"),500);Spinner.stop();return;}
var submitModel=_this.getSubmitModel();$.when(WebAPI.get('/diagnosis/notice/makesure/'+submitModel.projectId+'/'+submitModel.noticeId+''),WebAPI.post('/workflow/transaction/add/',submitModel)).done(function(makesureResult,addResult){if(makesureResult[0]=='true'&&addResult[0].success){alert('created successfully');}else{alert('created incorrect');}
_this.submitFunc&&typeof _this.submitFunc==='function'?_this.submitFunc(makesureResult[0]=='true',addResult[0].success):ScreenManager.show(DiagnosisScreen);}).fail(function(){Alert.danger(ElScreenContainer,'create workflow failed.').showAtTop(2000);}).always(function(){Spinner.stop();});}});this.$container.on("click","#workflow-insert-cancel",function(){_this.cancelFunc&&typeof _this.cancelFunc==='function'?_this.cancelFunc():ScreenManager.show(DiagnosisScreen);});$("#btn_insert_ok").click(function(){_this.insertFunc&&typeof _this.insertFunc==='function'?_this.insertFunc():ScreenManager.show(DiagnosisScreen);});$("#btn_goto_WorkFlow").click(function(){ScreenManager.show(WorkflowMain);});},getSubmitModel:function(){return{noticeId:this.insertData.noticeId,groupId:$('#selectGroup').val(),executorId:$('#selectExecutor').val(),title:$('#workflow-insert-title').val(),detail:$('#workflow-insert-detail').val(),dueDate:$('#dueDate').val(),critical:$('#critical').val(),projectId:this.insertData.projectId,chartPointList:this.insertData.chartPointList,chartQueryCircle:this.insertData.chartQueryCircle,chartStartTime:this.insertData.chartStartTime,chartEndTime:this.insertData.chartEndTime,userId:AppConfig.userId}},setFloatingWin:function($win,h){var wh=$(window).height();var top=(wh-h)/2;$win.find(".modal-dialog").css({'top':top});$win.modal();},submitCheck:function(){if($.trim($("#dueDate").val())===""){$("#insert-errorInfo").text(I18n.resource.workflow.insert.DEADLINE_REQUIRED);return false;}
if($.trim($("#workflow-insert-title").val())===""){$("#insert-errorInfo").text(I18n.resource.workflow.insert.TITLE_REQUIRED);return false;}
return true;},loadData:function(){if($.isEmptyObject(this.insertData)){return false;}
var _this=this;WebAPI.post('/workflow/loadInsertPage',this.insertData).done(function(result){if(result.success){_this.renderChart(result.data);_this.renderForm({insertData:_this.insertData,groups:result.data.group,groupMembers:result.data.groupMembers});_this.teamList=result.data.group;I18n.fillArea($(ElScreenContainer));}}).always(function(){Spinner.stop();})},renderForm:function(formData){var insertInfoContentHtml=beopTmpl('insertInfoContentTmpl',formData);$('#insert-info-content').empty().html(insertInfoContentHtml);$("#dueDate").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true,startDate:new Date()});},renderChart:function(record){var list_description=record.list_description,list_value=record.list_value,arrXAxis;if(list_description.length==list_value.length){if(record.list_time.length>0)
arrXAxis=record.list_time[0].split(',');var arrSeriesTemp=[];for(var i=0;i<list_value.length;i++){var arrDatas=[];if(i<8){var item=list_value[i];if(item){var strDatas=item.split(",");for(var j=0;j<strDatas.length;++j){arrDatas.push(parseFloat(strDatas[j]).toFixed(1));}}
arrSeriesTemp.push({name:list_description[i],type:'line',itemStyle:{normal:{lineStyle:{type:'solid'}}},data:arrDatas});}}
var option={title:{text:I18n.resource.workflow.notice.FAULT_CURVE,x:'left'},tooltip:{trigger:'axis',formatter:function(params){var strResult;if(params[0].name.length>0){strResult=params[0].name+'<br/>';for(var i=0;i<params.length;++i){strResult+=params[i].seriesName+' : '+params[i].value;if(i!=params.length-1){strResult+='<br/>';}}}
return strResult;}},legend:{data:list_description,x:'center'},toolbox:{show:true},dataZoom:{show:true,realtime:true,start:0,end:100},xAxis:[{name:"",type:'category',boundaryGap:false,axisLine:{onZero:false},data:arrXAxis}],yAxis:[{name:"",type:'value',scale:true}],series:arrSeriesTemp,showLoading:{text:'loading',effect:'spin'}};var myChart=echarts.init($('#insert-chart').get(0));myChart.setOption(option);window.onresize=myChart.resize;}}};return WorkflowInsert;})();(function(beop){beop.apiMethod={get:'GET',post:'POST'};beop.apiMap={'addGroup':{'method':beop.apiMethod.post,'url':'/workflow/group/new/<user_id>'},'editGroup':{'method':beop.apiMethod.post,'url':'/workflow/group/edit/<group_id>/<user_id>'},'deleteGroup':{'method':beop.apiMethod.get,'url':'/workflow/group/delete/<group_id>/<user_id>'},'getGroupData':{'method':beop.apiMethod.get,'url':'/workflow/group/get/<group_id>/<user_id>'},'addTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/new/'},'updateTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/update/'},'completeTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/complete/'},'verifyPass':{'method':beop.apiMethod.post,'url':'/workflow/transaction/pass_verify/'},'verifyNotPass':{'method':beop.apiMethod.post,'url':'/workflow/transaction/not_pass_verify/'},'listOneGroup':{'method':beop.apiMethod.get,'url':'/workflow/group/<user_id>/<project_id>'},'listGroupActivities':{'method':beop.apiMethod.get,'url':'/workflow/group_activities/<userId>/<latestUpdateTime>'},'getTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/<trans_id>'},'delTransaction':{'method':beop.apiMethod.post,'url':'/workflow/transaction/delete/<trans_id>'},'getTransactionStar':{'method':beop.apiMethod.get,'url':'/workflow/transaction/star/<user_id>/<page_num>/<page_size>'},'getTransactionWorking':{'method':beop.apiMethod.post,'url':'/workflow/transaction/working/<user_id>/<page_num>/<page_size>'},'getTransactionCreatedBy':{'method':beop.apiMethod.post,'url':'/workflow/transaction/created_by/<user_id>/<page_num>/<page_size>'},'getTransactionFinishedBy':{'method':beop.apiMethod.post,'url':'/workflow/transaction/finished_by/<user_id>/<page_num>/<page_size>'},'getTransactionJoinedBy':{'method':beop.apiMethod.post,'url':'/workflow/transaction/joined_by/<user_id>/<page_num>/<page_size>'},'getWorkflowDetailBy':{'method':beop.apiMethod.get,'url':'/workflow/detail/<record_id>'},'addReply':{'method':beop.apiMethod.post,'url':'/workflow/transaction/insert_reply/'},'listMenu':{'method':beop.apiMethod.post,'url':'/workflow/menu/listMenu/'},'listSecondMenu':{'method':beop.apiMethod.post,'url':'/workflow/menu/list_second_menu/'},'insertReply':{'method':beop.apiMethod.post,'url':'/workflow/insert/reply'},'getReply':{'method':beop.apiMethod.get,'url':'/workflow/transaction/get_reply/<trans_id>'},'getProgress':{'method':beop.apiMethod.get,'url':'/workflow/transaction/get_progress/<trans_id>'},'faultCurve':{'method':beop.apiMethod.get,'url':'/workflow/transaction/fault_curve_data/<trans_id>'},'userGroups':{'method':beop.apiMethod.get,'url':'/workflow/users/group/<user_id>'},'transInGroups':{'method':beop.apiMethod.post,'url':'/workflow/group/transaction/<group_id>/<user_id>/<page_num>/<page_size>'},'searchTasks':{'method':beop.apiMethod.post,'url':'/workflow/transaction/search/<page_num>/<page_size>'},'userDialogList':{'method':beop.apiMethod.get,'url':'/workflow/group/user_dialog_list/<user_id>'},'getUserTags':{'method':beop.apiMethod.get,'url':'/workflow/tag/user/<user_id>'},'addTag':{'method':beop.apiMethod.post,'url':'/workflow/user/tag/add/<user_id>'},'deleteTag':{'method':beop.apiMethod.get,'url':'/workflow/user/tag/delete/<user_id>/<tag_id>'},'editTag':{'method':beop.apiMethod.post,'url':'/workflow/user/tag/update/<user_id>'},'addTransTag':{'method':beop.apiMethod.get,'url':'/workflow/tag/add/<trans_id>/<tag_id>'},'transTagDelete':{'method':beop.apiMethod.get,'url':'/workflow/tag/delete/<trans_id>/<tag_id>'},'transTag':{'method':beop.apiMethod.post,'url':'/workflow/tag/trans/<user_id>/<tag_id>/<page_num>/<page_size>'},'tagTrans':{'method':beop.apiMethod.get,'url':'/workflow/trans/tag/<trans_id>'},'toggleStarred':{'method':beop.apiMethod.get,'url':'/workflow/transaction/star/<user_id>/<trans_id>'}}})(beop||(beop={}));(function(beop){var emit,api,param,data,apiURL,paramRegex=/\<([^\<\>]+)\>/g;emit=function(){if(arguments.length===0||!arguments[0]){beop.util.makeError('request error','api name is Null');return false;}
api=arguments[0],apiURL=api.url;if(arguments.length===2){if(paramRegex.test(api.url)){param=arguments[1];}else{data=arguments[1];}}else if(arguments.length===3){param=arguments[1];data=arguments[2];}
if(param){apiURL=api.url.replace(paramRegex,function(match,p0){return param[p0];});}
if(api.method===beop.apiMethod.get){return WebAPI.get(apiURL);}else if(api.method===beop.apiMethod.post){return WebAPI.post(apiURL,data);}};beop.data={emit:emit,paramRegex:paramRegex}})(beop||(beop={}));(function(beop){var transactionId=177,dfd,makeFakeTransactionId,getApiName,emit,api,param,data;makeFakeTransactionId=function(){return String(transactionId++);};getApiName=function(api){if(!api){return false;}
for(var apiName in beop.apiMap){if(beop.apiMap[apiName].url===api.url&&beop.apiMap[apiName].method===api.method){return apiName;}}
return false;};emit=function(){if(arguments.length===0||!arguments[0]){beop.util.makeError('request error','api name is Null');return false;}
api=arguments[0];if(arguments.length===2){if(beop.data.paramRegex.test(api.url)){param=arguments[1];}else{data=arguments[1];}}else if(arguments.length===3){param=arguments[1];data=arguments[2];}
dfd=$.Deferred();switch(getApiName(api)){case getApiName(beop.apiMap.addGroup):return dfd.resolve({success:true});case getApiName(beop.apiMap.listActivities):return $.getJSON('/static/scripts/workflow2.0/fakeData/activities.json').then(function(result){if(param.startTime){result.data=result.data.filter(function(item){return moment(param.startTime).isBefore(item.opTime);});}
return dfd.resolve(result);});case getApiName(beop.apiMap.getTransactionCreatedBy):return $.getJSON('/static/scripts/workflow2.0/fakeData/transactions.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getTransactionFinishedBy):return $.getJSON('/static/scripts/workflow2.0/fakeData/transactions.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getTransactionJoinedBy):return $.getJSON('/static/scripts/workflow2.0/fakeData/transactions.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getTransaction):return $.getJSON('/static/scripts/workflow2.0/fakeData/details.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getReply):return $.getJSON('/static/scripts/workflow2.0/fakeData/replyList.json').then(function(result){return dfd.resolve(result);});case getApiName(beop.apiMap.getProgress):return $.getJSON('/static/scripts/workflow2.0/fakeData/progress.json').then(function(result){return dfd.resolve(result);});default:{return dfd.reject('can\'t find the api');}}};beop.fake={emit:emit,makeFakeTransactionId:makeFakeTransactionId}})(beop||(beop={}));(function($){var subEvent,pubEvent,unSubEvent,eventMap={};subEvent=function($obj,topic,fn){if(!$obj){return false;}
$obj.off(topic).on(topic,fn);if(eventMap[topic]){eventMap[topic]=$obj;}else{eventMap[topic]=$obj;}};pubEvent=function(topic,data){if(!eventMap[topic]){return false;}
if(data){eventMap[topic].trigger(topic,$.isArray(data)?data:[data]);}else{eventMap[topic].trigger(topic);}
return true;};unSubEvent=function($obj,topic){if(!eventMap[topic]){return false;}
eventMap[topic]=eventMap[topic].not($obj);if(eventMap[topic].length===0){delete eventMap[topic];}
return true;};$.spEvent={subEvent:subEvent,pubEvent:pubEvent,unSubEvent:unSubEvent};}(jQuery));(function(beop){var makeError,setConfigMap;makeError=function(name_text,msg_text,data){var error=new Error();error.name=name_text;error.message=msg_text;if(data){error.data=data;}
return error;};setConfigMap=function(arg_map){var
input_map=arg_map.input_map,settable_map=arg_map.settable_map,config_map=arg_map.config_map,key_name,error;for(key_name in input_map){if(input_map.hasOwnProperty(key_name)){if(settable_map.hasOwnProperty(key_name)){config_map[key_name]=input_map[key_name];}
else{error=makeError('Bad Input','Setting config key |'+key_name+'| is not supported');throw error;}}}};$.fn.serializeObject=function(){var obj={};this.serializeArray().map(function(item){if(/\[\]$/.test(item.name)){if(obj[item.name]){obj[item.name].push(item.value);}else{obj[item.name]=[item.value];}}else{obj[item.name]=item.value;}});return obj;};beop.util=$.extend(beop.util?beop.util:{},{makeError:makeError,setConfigMap:setConfigMap})}(beop||(beop={})));var WorkflowTool=(function(){var pic_path='/static/images/workflow/',templateStorage;function getStatusText(status){if(status==0){status='new';}
switch(status){case'new':return I18n.resource.workflow.main.NEW;case 1||'assigned':return I18n.resource.workflow.main.ASSIGNED;case 2||'start':return I18n.resource.workflow.main.DEALING;case 3||'pause':return I18n.resource.workflow.main.PAUSED;case 4||'completed':return I18n.resource.workflow.main.FINISHED;case 5||'deleted':return I18n.resource.workflow.main.DELETED;}}
function translate(text){if(!text){return'';}
try{text=JSON.parse(text);}catch(e){}
var Translation=function(text){switch(text){case'detail':return I18n.resource.workflow.main.FAULT_INFO;case'dueDate':return I18n.resource.workflow.notice.DEADLINE;case'title':return I18n.resource.workflow.main.FAULT_TITLE;case'due_date':return I18n.resource.workflow.common.DEADLINE;case'critical':return I18n.resource.workflow.urgencyLevel.URGENCY_LEVEL;case'executor':return I18n.resource.workflow.common.EXECUTOR;case'assignTime':return I18n.resource.workflow.notice.TASK_ASSIGN_TIME;case'groupid':return I18n.resource.workflow.task.TASK_GROUP;case'tags':return I18n.resource.workflow.task.TAGS;case'verifiers':return I18n.resource.workflow.task.VERIFIERS;case'watchers':return I18n.resource.workflow.task.WATCHERS;case'op':return I18n.resource.workflow.task.STATUS;default:return text;}};var criticalTranslate=function(num){var level=I18n.resource.workflow.urgencyLevel[parseInt(num)];if(level=='undefined'||level==undefined||level==null){return''}else{return level;}};var groupIdTranslate=function(num){for(var i=0;i<beop.model.stateMap.group_list.length;i++){var groupItem=beop.model.stateMap.group_list[i];if(groupItem.id==num){if(groupItem.name=='undefined'||groupItem.name==undefined||groupItem.name==null){return''}else{return groupItem.name;}}}};var listObjTranslate=function(list){if(!list){return"";}
var text="";for(var i=0;i<list.length;i++){if(i!=list.length-1){text+=list[i].userfullname+", ";}else{text+=list[i].userfullname;}}
if(text=='undefined'||text==null||text==undefined){return''}else{return text;}};var html='<ul class="historyEdit list-unstyled">';if($.isPlainObject(text)){for(var prop in text){if(prop=='critical'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(criticalTranslate(text[prop].old)?criticalTranslate(text[prop].old):'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(criticalTranslate(text[prop].new)?criticalTranslate(text[prop].new):'')+'</span></li>';}else if(prop=='groupid'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(groupIdTranslate(text[prop].old)?groupIdTranslate(text[prop].old):'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(groupIdTranslate(text[prop].new)?groupIdTranslate(text[prop].new):'')+'</span></li>';}else if(prop=='watchers'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(listObjTranslate(text[prop].old)?listObjTranslate(text[prop].old):'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(listObjTranslate(text[prop].new)?listObjTranslate(text[prop].new):'')+'</span></li>';}else if(prop=='verifiers'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(listObjTranslate(text[prop].old)?listObjTranslate(text[prop].old):'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(listObjTranslate(text[prop].new)?listObjTranslate(text[prop].new):'')+'</span></li>';}else if(prop=='op'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(text[prop]?text[prop]:'')+'</span></li>';}
else{if(prop!='assignTime'){html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> '+'<span class="oldName">'+(text[prop].old?text[prop].old:'')+'</span><strong class="historyAction">'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong><span class="newName">'+(text[prop].new?text[prop].new:'')+'</span></li>';}else{html+='<li><span class="historyConTitle">'+Translation(prop)+'：</span> <span class="newName" style="margin-left:0">'+text[prop].new?text[prop].new:text[prop]+'</span></li>';}}}
html+='</ul>';return html;}else{var textList=text.split('was renamed');if(textList.length!=2){switch(text){case'edit':return I18n.resource.workflow.notice.TASK_EDIT;case'complete':return I18n.resource.workflow.notice.TASK_FINISH;case'restart':return I18n.resource.workflow.notice.TASK_RESTART;case'start':return I18n.resource.workflow.notice.TASK_START;case'pause':return I18n.resource.workflow.notice.TASK_PAUSE;case'reply':return I18n.resource.workflow.notice.TASK_REPLY;case'new':return I18n.resource.workflow.notice.TASK_CREATE;case'verified':return I18n.resource.workflow.notice.TASK_VERIFIED;case'not_pass':return I18n.resource.workflow.notice.TASK_VERIFIED_FAILED;case'delete':return I18n.resource.workflow.notice.TASK_DELETE;default:return text;}}else{return'<p>'+'title'+':'+textList[0]+' <strong>'+I18n.resource.workflow.notice.TASK_MODIFY+'</strong>'+textList[1]+'</p>';}}}
function recordTranslate(text){switch(text){case'complete':return I18n.resource.workflow.record.FINISH;case'start':return I18n.resource.workflow.record.START;case'new':return I18n.resource.workflow.record.CREATE;case'verified':return I18n.resource.workflow.record.VERIFIED;default:return text;}}
function updateBadge(count,list){var $badge=$('#paneWorkflow').find('li[screen="mine"]').find('.badge');if(!count){$badge.text('').data('new-tasks','');}else{$badge.text(count).data('new-tasks',list);}}
function updateNewTaskCount(){if(!AppConfig['userId']){return;}
WebAPI.get('/workflow/new_task_count/'+AppConfig['userId']).done(function(result){try{var r_obj=JSON.parse(result)}catch(e){return false;}
var storageNewTask=localStorage.getItem('new_task_'+AppConfig['userId']);if(!storageNewTask){updateBadge(r_obj.length,r_obj);}else{try{storageNewTask=JSON.parse(storageNewTask);}catch(e){return false;}
var unreadList=[];for(var n=0,len=r_obj.length;n<len;n++){if($.inArray(r_obj[n],storageNewTask)===-1){unreadList.push(r_obj[n]);}}
updateBadge(unreadList.length,unreadList);localStorage.setItem('new_task_temp_'+AppConfig['userId'],result);}})}
function getTemplate(template,selector){templateStorage=templateStorage||{};var promise;if(templateStorage[template]){promise=templateStorage[template];}else{promise=templateStorage[template]=WebAPI.get(template);}
var dfd=$.Deferred();promise.done(function(result){var $result=$(result),$template=$result.find(selector).children();var $return=$template.clone()
I18n.fillArea($return)
dfd.resolve($return);});return dfd;}
function getWorkflowTemplate(selector){return getTemplate('/static/views/workflow/template.html',selector);}
function inherits(clazz,base){var clazzPrototype=clazz.prototype;function F(){}
F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;}
function getUserName(rawUserName){if(rawUserName.indexOf('@')>0){return rawUserName.substring(0,rawUserName.indexOf('@'))}
return rawUserName;}
function delArrInvalidValue(arr){for(var i=0;i<arr.length;i++){if(arr[i]==''||arr[i]==null){arr.splice(i,1);i=i-1;}}
return arr;}
function screeningItem($obj,str,num){if($obj.hasClass("selectAll")){$(".task-item").show();return;}
var text=$obj.text();if(!num){$.each($(".task-item ."+str),function(index,item){var $item=$(item);var itemStatus=$item.text();if(text!==itemStatus){$item.closest(".task-item").hide();}else{$item.closest(".task-item").show();}});}else{var urgencyClass=$obj.attr("urgencyClass");$(".task-item").hide();$(".task-item ."+urgencyClass).closest(".task-item").show();}}
return{pic_path:pic_path,getStatusText:getStatusText,updateBadge:updateBadge,updateNewTaskCount:updateNewTaskCount,getWorkflowTemplate:getWorkflowTemplate,inherits:inherits,getUserName:getUserName,translate:translate,recordTranslate:recordTranslate,delArrInvalidValue:delArrInvalidValue,screeningItem:screeningItem};})();(function(beop){var configMap={date_format_full:'yyyy-MM-dd HH:mm:ss',date_format_YMD:'yyyy-MM-dd',activities_number:20,transaction_number:13,activities_store_key:'activities',activities_type:{today:'today',yesterday:'yesterday',thisWeek:'thisWeek',thisMonth:'thisMonth',latestCompleted:'latestCompleted',latestCreated:'latestCreated'},activities_op_type:{'new':'new','complete':'complete'}},stateMap={trans_cid_map:{},activity_cid_map:{},record_detail:{},group_list:[],tag_list:[]},isFake,emit,init;isFake=false;emit=isFake?beop.fake.emit:beop.data.emit;var noop=function(){};var activitiesModel,transactionsModel,menuModel,replyModel,groupModel,tagsModel;var getActivities,getNextPageActivities,startTime,getActivitiesFilter,storedActivities,editGroup;activitiesModel=(function(){getActivities=function(type,startTime){startTime=startTime?startTime:new Date().format(configMap.date_format_full);return stateMap.store.getItem(configMap.activities_store_key).then(function(storedData){return emit(beop.apiMap.listGroupActivities,{userId:stateMap.userId,latestUpdateTime:storedData.latestUpdateTime?storedData.latestUpdateTime:''}).done(function(result){if(result.success){storedActivities=storedData?storedData:{data:[],latestUpdateTime:""};if(result.data&&result.data.length){for(var m=0;m<result.data.length;m++){if(result.data[m].id in stateMap.activity_cid_map){var old_activity=stateMap.activity_cid_map[result.data[m].id];result.data[m].reply=result.data[m].reply?result.data[m].reply.concat(old_activity.reply?old_activity.reply:[]):[];result.data[m].reply.sort(function(a,b){return a.replyTime>b.replyTime;});result.data[m].latestUpdateTime=result.data[m].reply[result.data[m].reply.length-1]&&result.data[m].reply[result.data[m].reply.length-1].replyTime;for(var n=0;n<storedActivities.data.length;n++){if(storedActivities.data[n].id===old_activity.id){storedActivities.data.splice(n,1);}}}else{result.data[m].latestUpdateTime=result.data[m].opTime;}}
storedActivities.data=result.data.concat(storedActivities.data?storedActivities.data:[]);result.data.map(function(item){stateMap.activity_cid_map[item.id]=item;});storedActivities.data.sort(function(a,b){return a.latestUpdateTime<b.latestUpdateTime;});storedActivities.latestUpdateTime=startTime;stateMap.store.setItem(configMap.activities_store_key,storedActivities);}
if(!storedActivities.data||!storedActivities.data.length){stateMap.activities=[];return false;}
stateMap.backup_activities=[];if(type){stateMap.activities=storedActivities.data.filter(getActivitiesFilter(type));if(!stateMap.activities||!stateMap.activities.length){switch(type){case configMap.activities_type.today:stateMap.backup_activities=storedActivities.data.filter(getActivitiesFilter(configMap.activities_type.yesterday));break;case configMap.activities_type.yesterday:stateMap.backup_activities=storedActivities.data.filter(getActivitiesFilter(configMap.activities_type.thisWeek));break;}}}else{stateMap.activities=storedActivities.data;}}});});};getActivitiesFilter=function(type){var now=moment(new Date()),yesterday=now.clone().subtract(1,'days');var isLatestReply=function(activity,checkFunc){if(!activity.reply||!activity.reply.length){return false;}
var latestReply=activity.reply[0];return checkFunc(latestReply.replyTime);};var checkFunc=noop;switch(type){case configMap.activities_type.today:{checkFunc=function(datetime){return now.isSame(new Date(datetime),'days');};return function(item){return item&&(checkFunc(item.opTime)||isLatestReply(item,checkFunc));}}
case configMap.activities_type.yesterday:{checkFunc=function(datetime){return yesterday.isSame(new Date(datetime),'days');};return function(item){return item&&(checkFunc(item.opTime)||isLatestReply(item,checkFunc));};}
case configMap.activities_type.thisWeek:{checkFunc=function(datetime){return moment(new Date(datetime)).isBetween(now.clone().startOf('weeks'),now.clone().endOf('weeks'))};return function(item){return item&&(checkFunc(item.opTime)||isLatestReply(item,checkFunc));};}
case configMap.activities_type.thisMonth:{checkFunc=function(datetime){return moment(new Date(datetime)).isBetween(now.clone().startOf('months'),now.clone().endOf('months'));};return function(item){return item&&(checkFunc(item.opTime)||isLatestReply(item,checkFunc));};}
case configMap.activities_type.latestCompleted:{var count=configMap.activities_number;return function(item){return(--count)>0&&item.op===configMap.activities_op_type.complete;}}
case configMap.activities_type.latestCreated:{var count=configMap.activities_number;return function(item){return(--count)>0&&item.op===configMap.activities_op_type.new;}}
default:{return function(){return true;};}}};getNextPageActivities=function(){return emit(beop.apiMap.listActivities,{userId:stateMap.userId,rownumber:(stateMap.rownumber+1)}).done(function(result){if(result.success){stateMap.activities=result.data;stateMap.rownumber=++stateMap.rownumber;}});};return{getActivities:getActivities,getNextPageActivities:getNextPageActivities}})();var trans_id,getTrans,delTrans,addTrans,searchTrans,listTransWorking,listTransCreatedBy,listTransFinishedBy,listTransJoinedBy,listGroupTrans,updateTrans,addReply,faultCurve,getReply,getProgress,completeTrans,verifyPass,verifyNotPass,toggleStarred,collectionTrans,listTransStarBy;transactionsModel=(function(){getTrans=function(trans_id){return emit(beop.apiMap.getTransaction,{trans_id:trans_id},{user_id:stateMap.userId}).done(function(result){stateMap.cur_trans=result.data;stateMap.trans_cid_map[trans_id]=result.data;});};delTrans=function(trans_id){if(!trans_id){trans_id=stateMap.cur_trans.id;}
return emit(beop.apiMap.delTransaction,{trans_id:trans_id},{user_id:stateMap.userId}).done(function(result){stateMap.cur_trans=null;if(stateMap.trans_cid_map[trans_id]){delete stateMap.trans_cid_map[trans_id];}});};listTransWorking=function(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionWorking,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.transaction_number},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listTransStarBy=function(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionStar,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.transaction_number},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listTransCreatedBy=function(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionCreatedBy,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.transaction_number},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listTransFinishedBy=function(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionFinishedBy,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.transaction_number},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listTransJoinedBy=function(user_id,currentPage,orderObject){return emit(beop.apiMap.getTransactionJoinedBy,{user_id:user_id?user_id:stateMap.userId,page_num:currentPage||1,page_size:configMap.transaction_number},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};searchTrans=function(user_id,text,currentPage,orderObject){var param={};for(var key in orderObject){param[key]=orderObject[key];}
param['text']=text;param['userId']=user_id?user_id:stateMap.userId;return emit(beop.apiMap.searchTasks,{page_num:currentPage||1,page_size:configMap.transaction_number},param).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};listGroupTrans=function(currentPage,orderObject){return emit(beop.apiMap.transInGroups,{group_id:stateMap.currentGroupId,user_id:AppConfig.userId,page_num:currentPage||1,page_size:configMap.transaction_number},orderObject).done(function(result){stateMap.trans_list=result.data;});};addTrans=function(trans){trans.userId=stateMap.userId;return emit(beop.apiMap.addTransaction,trans);};updateTrans=function(trans){trans.userId=stateMap.userId;trans.transId=stateMap.cur_trans.id;return emit(beop.apiMap.updateTransaction,trans);};completeTrans=function(trans){if(!trans){trans={};}
trans.userId=stateMap.userId;trans.transId=stateMap.cur_trans.id;return emit(beop.apiMap.completeTransaction,trans);};verifyPass=function(trans){if(!trans){trans={};}
trans.userId=stateMap.userId;trans.transId=stateMap.cur_trans.id;return emit(beop.apiMap.verifyPass,trans);};verifyNotPass=function(trans){if(!trans){trans={};}
trans.userId=stateMap.userId;trans.transId=stateMap.cur_trans.id;return emit(beop.apiMap.verifyNotPass,trans);};addReply=function(){};faultCurve=function(trans_id){if(!trans_id){trans_id=stateMap.cur_trans.id;}
return emit(beop.apiMap.faultCurve,{trans_id:trans_id}).done(function(result){stateMap.cur_fault_curve=result.data;});};getReply=function(trans_id){if(!trans_id){trans_id=stateMap.cur_trans.id}
return emit(beop.apiMap.getReply,{trans_id:trans_id}).done(function(result){stateMap.replyList=result.data;});};getProgress=function(trans_id){if(!trans_id){trans_id=stateMap.cur_trans.id}
return emit(beop.apiMap.getProgress,{trans_id:trans_id}).done(function(result){stateMap.progress=result.data;});};toggleStarred=function(trans_id,user_id){if(!trans_id){trans_id=stateMap.cur_trans.id}
return emit(beop.apiMap.toggleStarred,{trans_id:trans_id,user_id:user_id}).done(function(result){});};return{getTrans:getTrans,delTrans:delTrans,addTrans:addTrans,completeTrans:completeTrans,verifyPass:verifyPass,verifyNotPass:verifyNotPass,updateTrans:updateTrans,addReply:addReply,getReply:getReply,getProgress:getProgress,faultCurve:faultCurve,listTransWorking:listTransWorking,listTransCreatedBy:listTransCreatedBy,listTransFinishedBy:listTransFinishedBy,listTransJoinedBy:listTransJoinedBy,listTransStarBy:listTransStarBy,listGroupTrans:listGroupTrans,searchTrans:searchTrans,toggleStarred:toggleStarred}})();var getMenu,getSecondMenu;menuModel=(function(){getMenu=function(){return emit(beop.apiMap.listMenu,{userId:stateMap.userId}).done(function(result){});};getSecondMenu=function(firstMenu){return emit(beop.apiMap.listSecondMenu,{userId:stateMap.userId,firstMenu:firstMenu}).done(function(result){});};return{getMenu:getMenu,getSecondMenu:getSecondMenu}})();var insertReply;replyModel=(function(){insertReply=function(param){param['userId']=stateMap.userId;if(!param['ofTransactionId']){param['ofTransactionId']=stateMap.cur_trans.id;}
return emit(beop.apiMap.insertReply,param);};return{insertReply:insertReply}})();var getUserGroups,userDialogList,addGroup,deleteGroup,getGroupData;groupModel=(function(){getUserGroups=function(){return emit(beop.apiMap.userGroups,{'user_id':stateMap.userId}).done(function(result){if(result.success){stateMap.group_list=[];for(var prop in result.data){if(result.data.hasOwnProperty(prop)){stateMap.group_list=stateMap.group_list.concat(result.data[prop]);}}}});};userDialogList=function(){return emit(beop.apiMap.userDialogList,{'user_id':stateMap.userId});};addGroup=function(param){return emit(beop.apiMap.addGroup,{'user_id':stateMap.userId},param);};deleteGroup=function(param){return emit(beop.apiMap.deleteGroup,{group_id:param,user_id:stateMap.userId});};getGroupData=function(param){return emit(beop.apiMap.getGroupData,{group_id:param,user_id:stateMap.userId})};editGroup=function(group_id,param){return emit(beop.apiMap.editGroup,{group_id:group_id,user_id:stateMap.userId},param)};return{getUserGroups:getUserGroups,userDialogList:userDialogList,addGroup:addGroup,deleteGroup:deleteGroup,getGroupData:getGroupData,editGroup:editGroup}})();var getUserTags,addTag,deleteTag,editTag,addTransTag,transTag,transTagDelete,tagTrans;tagsModel=(function(){getUserTags=function(){return emit(beop.apiMap.getUserTags,{'user_id':stateMap.userId}).done(function(result){if(result.success){stateMap.tag_list=result.data;}});};addTag=function(param,tagInfo){return emit(beop.apiMap.addTag,param,tagInfo).done(function(result){if(result.success){stateMap.tag_list=result.data;}});};deleteTag=function(param){return emit(beop.apiMap.deleteTag,param).done(function(result){if(result.success){stateMap.tag_list=result.data;}});};editTag=function(param,tagInfo){return emit(beop.apiMap.editTag,param,tagInfo);};addTransTag=function(param){return emit(beop.apiMap.addTransTag,param);};transTagDelete=function(param){return emit(beop.apiMap.transTagDelete,param).done(function(result){if(result.success){}});};transTag=function(user_id,tag_id,currentPage,orderObject){return emit(beop.apiMap.transTag,{user_id:user_id?user_id:stateMap.userId,tag_id:tag_id,page_num:currentPage||1,page_size:configMap.transaction_number},orderObject).done(function(result){if(result.success){for(var m=0;m<result.data.records.length;m++){stateMap.trans_cid_map[result.data.records[m].id]=result.data.records[m];}
stateMap.trans_list=result.data;}});};tagTrans=function(param){return emit(beop.apiMap.tagTrans,param).done(function(result){if(result.success){}});};return{getUserTags:getUserTags,addTag:addTag,deleteTag:deleteTag,editTag:editTag,addTransTag:addTransTag,transTagDelete:transTagDelete,transTag:transTag,tagTrans:tagTrans}})();init=function(){stateMap.userId=AppConfig.userId;stateMap.userProfile=AppConfig.userProfile;stateMap.store=new Beop.cache.BaseCache({'driver':'localStorage'});stateMap.store.getItem(configMap.activities_store_key).done(function(storedData){if(storedData===null||!storedData){stateMap.store.setItem(configMap.activities_store_key,{data:[],latestUpdateTime:""});}else{stateMap.activities=storedData.data;}});};beop.model={init:init,activitiesModel:activitiesModel,transactionsModel:transactionsModel,menuModel:menuModel,replyModel:replyModel,stateMap:stateMap,groupModel:groupModel,tagsModel:tagsModel}})
(beop||(beop={}));(function(){var configMap={htmlURL:'',settable_map:{menu_model:true},highlightClass:'active',menu_model:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init,showDefaultLevelMenu,showLevelMenu,onMenuItemClick,onLoadTaskList,attachEvent;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_menu:$container.find('#wf-menu'),$wf_main_menu:$container.find('#wf-main-ul'),$wf_level_menu:$container.find('#wf-level-menu'),$wf_content:$container.find('#wf-content'),$wf_content_box:$container.find('#wf-content-box'),$wf_task_groups:$container.find('#wf-task-group'),$wf_label_ul:$container.find('#wf-label-ul'),$wf_del_win:$("#wf-del-win"),$wf_label_toggle:$container.find("#wf-label-toggle"),$wf_label_edit:$container.find("#wf-label-edit"),$wf_level_search:$container.find("#wf-level-search"),$wf_label_plus:$container.find("#wf-label-plus"),$wf_label_name:$container.find(".wf-label-name")};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;setJqueryMap();attachEvent();jqueryMap.$wf_menu.on('click','[data-topic]',onMenuItemClick);$.spEvent.subEvent(jqueryMap.$wf_level_menu,'wf-task-list',onLoadTaskList);};attachEvent=function(){jqueryMap.$wf_level_search.keyup(function(e){if(e.keyCode==13){var val=jqueryMap.$wf_level_search.val();if(val!==""){beop.view.taskList.configModel({enableBack:false});beop.view.taskList.init(jqueryMap.$wf_content).done(function(){$.spEvent.pubEvent('wf-task-list','search');});}}});};showDefaultLevelMenu=function(firstMenuSelector,levelMenuSelector){var highlight=configMap.highlightClass;jqueryMap.$wf_main_menu.children().removeClass(highlight).end().children(firstMenuSelector).addClass(highlight);jqueryMap.$wf_level_menu.children().removeClass(highlight).filter(levelMenuSelector).addClass(highlight);jqueryMap.$wf_level_menu.find('li').removeClass(highlight);var $levelMenuDefaultItem=jqueryMap.$wf_level_menu.children(levelMenuSelector).find('[data-type=default]');if($levelMenuDefaultItem.length){$levelMenuDefaultItem.addClass(highlight);}
if(levelMenuSelector=='#levelMeunCalendar'){jqueryMap.$wf_content.css({'left':341+'px','width':'calc(100% - 345px)','padding':'5px 10px'});}else{jqueryMap.$wf_content.css({'left':280+'px','width':'calc(100% - 340px)','padding':'20px'});}};showLevelMenu=function($menuItem){if(!$menuItem.hasClass('main-menu')){jqueryMap.$wf_level_menu.find('.'+configMap.highlightClass+':not(section)').removeClass(configMap.highlightClass);}
$menuItem.addClass(configMap.highlightClass);};onMenuItemClick=function(){var $this=$(this),paramData=$this.data('param');var topic=$this.data('topic'),param=null;if(paramData){if(typeof paramData==='string'){param=paramData.split(';');}else{param=paramData;}}
var initPromise;switch(topic){case'wf-group-add':{jqueryMap.$wf_content.attr("data-group-no","");initPromise=beop.view.groupAdd.init(jqueryMap.$wf_content);break;}
case'wf-group-edit':{jqueryMap.$wf_content.attr("data-group-no",param[1]);beop.view.groupEdit.configModel({data:{param:param[1],type:'taskGroup'},enableEdit:true});initPromise=beop.view.groupEdit.init(jqueryMap.$wf_content);break;}
case'wf-group-see':{jqueryMap.$wf_content.attr("data-group-no","");beop.view.groupEdit.configModel({data:{param:param[1],type:'taskGroup'},enableEdit:false});initPromise=beop.view.groupEdit.init(jqueryMap.$wf_content);break;}
case'wf-group-delete':{jqueryMap.$wf_del_win.attr("data-param",$(this).attr("data-param"));jqueryMap.$wf_del_win.attr("data-type","taskGroup");initPromise=beop.view.groupDelete.init(jqueryMap.$wf_content);break;}
case'wf-group-show':{initPromise=beop.view.groupShow.init(jqueryMap.$wf_content);break;}
case'wf-task-list':{beop.view.taskList.configModel({enableBack:false});initPromise=beop.view.taskList.init(jqueryMap.$wf_content);beop.view.menu_group_list.configModel({whereComeFrom:'default'});beop.view.menu_tag_list.configModel({whereComeFrom:'default'});showDefaultLevelMenu('#wf-main-task','#level-menu-task');if($this.attr('id')==='wf-main-task'){beop.view.menu_group_list.init(jqueryMap.$wf_task_groups);beop.view.menu_tag_list.init(jqueryMap.$wf_label_ul);}
if($this.hasClass('group-name')){beop.model.stateMap.currentGroupId=param[1];}
break;}
case'wf-firstMenu-change':{showDefaultLevelMenu('#wf-main-calender','#levelMeunCalendar');Spinner.spin(stateMap.$container.get(0));new WorkflowCalendar().show('#wf-content','#calendar-time').Done(function(){Spinner.stop();});beop.view.menu_group_list.configModel({whereComeFrom:'calendar'});beop.view.menu_group_list.init(jqueryMap.$wf_level_menu.find('#levelMeunCalendar'));break;}
case'wf-task-add':{jqueryMap.$wf_content.attr("data-group-no","");initPromise=beop.view.taskDetail.init(jqueryMap.$wf_content,'new');showDefaultLevelMenu('#wf-main-task','#level-menu-task');break;}
case'wf-activities-change':{initPromise=beop.view.activities.init(jqueryMap.$wf_content,true);showDefaultLevelMenu('#wf-main-activity','#level-menu-activity');param=paramData?paramData:'today';beop.view.taskList.configModel({spEventActivities:{param:param,topic:topic}});break;}
case'wf-task-list-calendar':{initPromise=$.Deferred().resolve();break;}}
showLevelMenu($this);initPromise&&initPromise.done(function(){$.spEvent.pubEvent(topic,param);});};onLoadTaskList=function(event,type,param){beop.view.taskList.init(jqueryMap.$wf_content,type);};beop.view=beop.view||{};beop.view.menu={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'',settable_map:{cb_dialog_hide:true,cb_dialog_show:true,group_model:true,userHasSelected:true,maxSelected:true,enableDeleteMember:true,enableAddMember:true},cb_dialog_hide:$.noop,cb_dialog_show:$.noop,group_model:null,userHasSelected:null,maxSelected:null,enableDeleteMember:true,enableAddMember:true,KEY_PY_STORY:'BEOP.WF.PY'},stateMap={usersMap:{},defaultAddedUserList:[],addedUserList:[],allUserList:[],PYMap:{},selectedClassPrefix:'wf-member-selected',memberSelectedDiff:[]},jqueryMap={},setJqueryMap,configModel,init;var progressResultData,bindEvents,renderCheckedUsers,isPYStored;var filterCheckedUser,searchByFirstName,getPYLocalStorage,getZH_EN,addActiveSearchBtn,setPYMap,searchByInput,showSearchByID,resetData,renderAddedUsers,onClickUser,onClickRemoveUser,removeMember,addMember,isMemberAdded,checkUserSelectedAmount,restoreSearchResult;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$add_user_dialog:$container.find('#wf-add-person'),$wf_check_result:$container.find('.wf-check-result')};jqueryMap.$wf_search_by_firstName_li=jqueryMap.$add_user_dialog.find('.wf-search-result-title ul li');jqueryMap.$wf_search_byInput=jqueryMap.$add_user_dialog.find('#input-search-name');jqueryMap.$wf_search_result=jqueryMap.$add_user_dialog.find('.wf-search-result');jqueryMap.$wf_search_result_list=jqueryMap.$add_user_dialog.find('.wf-member');jqueryMap.$wf_added_user_list=jqueryMap.$add_user_dialog.find('.wf-added-user-list');jqueryMap.$wf_seaych_byInput=jqueryMap.$add_user_dialog.find('#input-search-name');jqueryMap.$wf_close_btn1=jqueryMap.$add_user_dialog.find('.modal-header button');jqueryMap.$wf_search_result_list.removeClass(stateMap.selectedClassPrefix);jqueryMap.$wf_check_result.empty();jqueryMap.$wf_search_byInput.val('');};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){resetData();stateMap.$container=$container;configMap.group_model.userDialogList().done(function(resultData){if(resultData.success){setJqueryMap();progressResultData(resultData);}});};bindEvents=function(){jqueryMap.$wf_search_result.off().on('click','.wf-member',onClickUser);jqueryMap.$wf_check_result.off().on('click','.glyphicon-remove',onClickRemoveUser);jqueryMap.$wf_search_by_firstName_li.off().on('click',searchByFirstName);jqueryMap.$wf_seaych_byInput.off().on('keyup',searchByInput);jqueryMap.$wf_close_btn1.off().on('click',function(){jqueryMap.$add_user_dialog.modal('hide');});jqueryMap.$wf_comfirm_btn=jqueryMap.$add_user_dialog.find('#wf-member-comfirm-btn');jqueryMap.$wf_comfirm_btn.off().on('click',renderAddedUsers);jqueryMap.$add_user_dialog.off().on('hide.bs.modal',function(){jqueryMap.$wf_check_result.html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.defaultAddedUserList}));stateMap.addedUserList=[];for(var i=0;i<stateMap.defaultAddedUserList.length;i++){stateMap.addedUserList.push(stateMap.defaultAddedUserList[i]);}
jqueryMap.$wf_search_result_list.removeClass(stateMap.selectedClassPrefix);jqueryMap.$wf_search_result_list.each(function(){var $this=$(this);for(var i=0;i<stateMap.defaultAddedUserList.length;i++){if(stateMap.defaultAddedUserList[i].id==$this.data('user-id')){$this.addClass(stateMap.selectedClassPrefix)}}})});};renderCheckedUsers=function(){jqueryMap.$wf_check_result.html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.addedUserList}))};renderAddedUsers=function(){stateMap.defaultAddedUserList=[];for(var i=0;i<stateMap.addedUserList.length;i++){stateMap.defaultAddedUserList.push(stateMap.addedUserList[i]);}
configMap.cb_dialog_hide(stateMap.addedUserList);jqueryMap.$add_user_dialog.modal('hide');};isPYStored=function(){return!!localStorage.getItem(configMap.KEY_PY_STORY);};progressResultData=function(result){if(configMap.userHasSelected&&configMap.userHasSelected.length!==0){stateMap.addedUserList=configMap.userHasSelected;}
var addedUserMap={};var m;for(m=0;m<stateMap.addedUserList.length;m++){addedUserMap[''+stateMap.addedUserList[m].id]=stateMap.addedUserList[m];}
stateMap.allUserList=result.data;jqueryMap.$wf_search_result.html(beopTmpl('tpl_wf_member',{members:result.data,addUserMap:addedUserMap}));for(var n=0;n<result.data.length;n++){var user=result.data[n];stateMap.usersMap[''+user.id]=user;}
I18n.fillArea(stateMap.$container);getPYLocalStorage().done(function(pin_yin){setPYMap(pin_yin);});jqueryMap.$wf_search_result_list=jqueryMap.$add_user_dialog.find('.wf-member');bindEvents();renderCheckedUsers();restoreSearchResult();jqueryMap.$add_user_dialog.on('show.bs.modal',function(){restoreSearchResult();}).modal('show');};restoreSearchResult=function(){jqueryMap.$wf_search_result_list.show();addActiveSearchBtn(null,2);};setPYMap=function(Pin_Yin){var format,key;for(key in stateMap.usersMap){if(stateMap.usersMap.hasOwnProperty(key)){format=getZH_EN(Pin_Yin,stateMap.usersMap[key].userfullname.charAt(0));stateMap.PYMap.push({id:key,pinyin:format.pinyin,acronym:format.acronym})}}};getPYLocalStorage=function(){if(!isPYStored()){return $.getJSON('/static/scripts/workflow2.0/wf.pinyin.json').done(function(result){if(result){window.localStorage.setItem(configMap.KEY_PY_STORY,JSON.stringify(result));}})}else{var pin_yin=JSON.parse(window.localStorage.getItem(configMap.KEY_PY_STORY));return $.Deferred().resolve(pin_yin);}};getZH_EN=function(PinYin,first_letter){if(typeof first_letter!='string')return false;var _name='',_char='',_firstChar='',_reg=/[a-z0-9A-Z\- ]/;for(var i=0,len=first_letter.length;i<len;i++){var _val=first_letter[i];if(_reg.test(_val)){_name+=_val;}else{_char=getPinYin(_val);_name+=_char;_firstChar+=_char[0];}}
return{pinyin:_name,acronym:_firstChar};function getPinYin(_val){var _key='';for(var i in PinYin){if(PinYin[i].indexOf(_val)!==-1){_key=i;break;}else{_key=_val;}}
return _key;}};showSearchByID=function(result){if(Object.prototype.toString.call(result)!=='[object Array]')return;jqueryMap.$wf_search_result_list.hide();var i;for(i=0;i<result.length;i++){jqueryMap.$wf_search_result_list.each(function(){if($(this).data('user-id')==result[i]){$(this).show();}})}};removeMember=function(userId){for(var m=0;m<stateMap.addedUserList.length;m++){if(stateMap.addedUserList[m].id==userId){stateMap.addedUserList.splice(m,1);}}};addMember=function(userId){stateMap.addedUserList.push(stateMap.usersMap[''+userId]);};isMemberAdded=function(userId){for(var m=0;m<stateMap.addedUserList.length;m++){if(stateMap.addedUserList[m].id==userId){return true;}}
return false;};resetData=function(){stateMap.usersMap=[];stateMap.addedUserList=[];stateMap.allUserList=[];stateMap.PYMap=[];stateMap.memberSelectedDiff=[];stateMap.defaultAddedUserList=[];};checkUserSelectedAmount=function(){if(configMap.maxSelected){var li=jqueryMap.$wf_check_result.find('li');var length=li.length=='undefined'?0:li.length;if(configMap.maxSelected>length){return true;}else{return false;}}else if(configMap.maxSelected==null){return true;}};onClickUser=function(){var $this=$(this),selectedClass=stateMap.selectedClassPrefix;var userId=''+$this.data('user-id');if(configMap.maxSelected==1){if(!$this.hasClass(selectedClass)){if(!isMemberAdded(userId)){stateMap.addedUserList=[];addMember(userId);jqueryMap.$wf_search_result_list.removeClass(selectedClass);$this.addClass(selectedClass);}}}else{if(!$this.hasClass(selectedClass)){if(configMap.enableAddMember){if(checkUserSelectedAmount()){if(!isMemberAdded(userId)){addMember(userId);$this.addClass(selectedClass);}}else{Alert.danger(ElScreenContainer,'超过最大选择数量').showAtTop(300);return false;}}else{Alert.danger(ElScreenContainer,'不能添加人物').showAtTop(300);return false;}}else{if(configMap.enableDeleteMember){$this.removeClass(selectedClass);removeMember(userId);}else{Alert.danger(ElScreenContainer,'不能删除人物').showAtTop(300);return false;}}}
renderCheckedUsers();};onClickRemoveUser=function(){var $this=$(this),userId=$this.data('user-id');if(configMap.enableDeleteMember){$this.parent().remove();removeMember(userId);filterCheckedUser(userId);}else{Alert.danger(ElScreenContainer,'不能删除已经存在的人物').showAtTop(300);return false;}};searchByFirstName=function(){var $this=$(this),searchIndex=$this.text(),result=[],key,i;addActiveSearchBtn($this,1);if($this.index()==0){jqueryMap.$wf_search_result_list.show();}else{for(i=0;i<stateMap.PYMap.length;i++){if(stateMap.PYMap[i].pinyin.charAt(0).toLowerCase()==searchIndex||stateMap.PYMap[i].acronym.charAt(0).toLowerCase()==searchIndex){result.push(stateMap.PYMap[i].id)}}
showSearchByID(result);}};searchByInput=function(ev){ev.preventDefault();ev.stopPropagation();var $this=$(this);var value=$.trim($this.val());if(value==''){jqueryMap.$wf_search_result_list.show();addActiveSearchBtn(null,2);}else{var result=[];for(var i=0;i<stateMap.allUserList.length;i++){(function(i){var member=stateMap.allUserList[i];if(member.userfullname.toLowerCase().indexOf(value.toLowerCase())!=-1){result.push(member.id)}})(i)}
showSearchByID(result)}};filterCheckedUser=function(userId){jqueryMap.$wf_search_result_list.each(function(){var $this=$(this);if($this.data('user-id')==userId){$this.removeClass(stateMap.selectedClassPrefix);}})};addActiveSearchBtn=function($which,type){if($which&&type==1){jqueryMap.$wf_search_by_firstName_li.removeClass('active');$which.addClass('active');}else if(type==2){jqueryMap.$wf_search_by_firstName_li.removeClass('active').eq(0).addClass('active');}};beop.view=beop.view||{};beop.view.memberSelected={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'/static/views/workflow/activity.html',settable_map:{activities_number:true,activities_model:true,transactions_model:true,reply_mode:true},activities_number:20,activities_model:null,transactions_model:null,reply_mode:null},stateMap={getActivitiesStepAmount:10,maxIMGWidth:$('body').width()/2},jqueryMap={},setJqueryMap,configModel,init,renderActivities,onChangeActivities,onReplyFocusout,onReplyFocusin,onReplySubmit,onTaskClick,onUserClick,onGetMoreActivitiesClick,getDataActivities,bindImgZoom,imgZoom;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_activity_container:$container.find('.wf-activity-container'),$wf_activity_container_box:$container.find('.wf-activity-container-box'),$wf_activity_empty:$container.find('.wf-activity-empty'),$wf_activity_getMore:$container.find('.wf-activity-get-more').find('button')};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container,notPubEvent){stateMap.$container=$container;$.spEvent.subEvent(stateMap.$container,'wf-activities-change',onChangeActivities);return WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();jqueryMap.$wf_activity_container.on('focusout','.reply-text-area',onReplyFocusout);jqueryMap.$wf_activity_container.on('focusin','.reply-text-area',onReplyFocusin);jqueryMap.$wf_activity_container.on('submit','form.add-reply-form',onReplySubmit);jqueryMap.$wf_activity_container.on('click','.task-name',onTaskClick);jqueryMap.$wf_activity_container.on('click','.task-user',onUserClick);bindImgZoom();jqueryMap.$wf_activity_getMore.on('click',onGetMoreActivitiesClick);!notPubEvent&&$.spEvent.pubEvent('wf-activities-change','today');});};renderActivities=function(){if(beop.model.stateMap.activities.length!=0){Spinner.spin(jqueryMap.$wf_activity_container.parent().get(0));jqueryMap.$wf_activity_container_box.html(beopTmpl('tpl_wf_activity',{activities:getDataActivities(),getActivitiesStepAmount:stateMap.getActivitiesStepAmount,stateMap:stateMap,showPosition:true}));Spinner.stop();}else if(beop.model.stateMap.activities.length==0&&beop.model.stateMap.backup_activities.length!=0){Spinner.spin(jqueryMap.$wf_activity_container.parent().get(0));var emptyActivity=beopTmpl('tpl_wf_activity_empty',{stateMap:stateMap,showPosition:true});switch(stateMap.activity_type){case'yesterday':stateMap.activity_type='thisWeek';break;case'today':stateMap.activity_type='yesterday';break;}
var backupActivities=beopTmpl('tpl_wf_activity',{activities:beop.model.stateMap.backup_activities?beop.model.stateMap.backup_activities:[],getActivitiesStepAmount:stateMap.getActivitiesStepAmount,stateMap:stateMap,showPosition:true});jqueryMap.$wf_activity_container.html(emptyActivity+backupActivities);Spinner.stop();}else{Spinner.spin(jqueryMap.$wf_activity_container.parent().get(0));jqueryMap.$wf_activity_container.html(beopTmpl('tpl_wf_activity_empty',{stateMap:stateMap,showPosition:false}));Spinner.stop();}
if(beop.model.stateMap.activities.length>stateMap.getActivitiesStepAmount){jqueryMap.$wf_activity_getMore.parent().show();}
bindImgZoom();I18n.fillArea(jqueryMap.$container);};onGetMoreActivitiesClick=function(){jqueryMap.$wf_activity_container_box.append(beopTmpl('tpl_wf_activity',{activities:getDataActivities(),getActivitiesStepAmount:stateMap.getActivitiesStepAmount,stateMap:stateMap,showPosition:false}));bindImgZoom();I18n.fillArea(jqueryMap.$wf_activity_container_box);};getDataActivities=function(){var activitiesData=beop.model.stateMap.activities?beop.model.stateMap.activities:[];if(activitiesData.length<=stateMap.getActivitiesStepAmount){jqueryMap.$wf_activity_getMore.parent().hide();return activitiesData;}else{jqueryMap.$wf_activity_getMore.parent().show();return activitiesData.splice(0,stateMap.getActivitiesStepAmount);}};bindImgZoom=function(){jqueryMap.$wf_activity_IMGZoom=jqueryMap.$container.find('.media-body img');jqueryMap.$wf_activity_IMGZoom.each(function(){var $this=$(this);$this.on('load',function(){if($this.context.naturalWidth>=stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css('cursor','-webkit-zoom-in')}});});};imgZoom=function(ev){ev.stopPropagation();ev.preventDefault();var imgSRC=$(this).attr('src'),$body=$('body'),$htmlMask=$('<div id="wf-img-zoom" class=""><img style="cursor: -webkit-zoom-out;" src="'+imgSRC+' "/> </div>');$htmlMask.off().on('click',function(){$(this).remove();});$body.append($htmlMask);};onChangeActivities=function(event,type,startTime){configMap.activities_model.getActivities(type,startTime).done(function(){stateMap.activity_type=type;renderActivities();bindImgZoom();});};onReplyFocusin=function(){var $this=$(this);$this.closest('.wf-activity-comment').find('.reply-btn-wrapper').slideDown();};onReplyFocusout=function(){var $this=$(this);$this.closest('.wf-activity-comment').find('.reply-btn-wrapper').slideUp();};onReplySubmit=function(){var $form=$(this);configMap.reply_mode.insertReply($form.serializeObject()).done(function(result){if(result.success){Alert.success(ElScreenContainer,'reply success!').showAtTop(2000);$.spEvent.pubEvent('wf-activities-change',stateMap.activity_type);}});};onTaskClick=function(){var $this=$(this),trans_id=$this.data('trans-id');if(!trans_id){return false;}
beop.view.returnActivitiesList=jqueryMap.$container.children().detach();beop.view.taskDetail.configModel({canClose:true,canBack:true,whereBack:'activities'});beop.view.taskDetail.init(jqueryMap.$container,'show',trans_id);return false;};onUserClick=function(){var $this=$(this),user_id=$this.data('user-id');beop.view.taskList.configModel({enableBack:true});beop.view.taskList.init(jqueryMap.$container).done(function(){$.spEvent.pubEvent('wf-task-list',['joinedBy',user_id]);});};beop.view=beop.view||{};beop.view.activities={configModel:configModel,init:init};})
(beop||(beop={}));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_mine.html',settable_map:{taskList_model:true,transactions_model:true,tags_model:true,enableBack:true,spEventActivities:true},taskList_num_per_page:15,transactions_model:null,tags_model:null,enableBack:true,spEventActivities:{}},stateMap={task_list_user:AppConfig.userId,task_list_type:'',orderProperty:'',ASC:true},jqueryMap={},setJqueryMap,configModel,init,onTableTaskClick,starSelect,onTableHeadClick,resetState,renderTaskList,loadTaskList,loadTaskDetail,changeOrderIcon,searchTaskList,paginationRefresh,onClickReturnActivities;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_level_search:$("#wf-level-search"),$wf_taskList_table:$container.find('#wf-task-table'),$wf_taskList_tbody:$container.find('#wf-task-table tbody')};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){resetState();stateMap.$container=$container;$.spEvent.subEvent(stateMap.$container,'wf-task-list',loadTaskList);$.spEvent.subEvent(stateMap.$container,'wf-search-list',searchTaskList);$.spEvent.subEvent(stateMap.$container,'wf-load-detail',loadTaskDetail);return WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);if(configMap.enableBack){var html='<a href="javascript:void (0)" class="btn btn-white btn-sm" id="wf-task-return-activities"><i class="icon-arrow-left"></i><span  i18n="workflow.task.BACK"></span></a>';stateMap.$container.prepend(html);jqueryMap.returnActivitiesList=stateMap.$container.find('#wf-task-return-activities');jqueryMap.$wf_content=stateMap.$container;jqueryMap.returnActivitiesList.on('click',onClickReturnActivities);}
I18n.fillArea(stateMap.$container);setJqueryMap();jqueryMap.$wf_taskList_table.on('click','td',onTableTaskClick);jqueryMap.$wf_taskList_table.on('click','th.order',onTableHeadClick);jqueryMap.$wf_taskList_table.on('click','.wf-task-star',function(e){var $this=$(this);var trans_id=$this.attr("trans_id");if($this.hasClass("glyphicon-star-empty")){$this.removeClass("glyphicon-star-empty").addClass("glyphicon-star");}else{$this.removeClass("glyphicon-star").addClass("glyphicon-star-empty");}
return configMap.transactions_model.toggleStarred(trans_id,AppConfig.userId).done(function(result){if(result.success){}});});});};renderTaskList=function(groupNo){if(groupNo){jqueryMap.$container.attr("data-group-no",groupNo);}else{jqueryMap.$container.attr("data-group-no","");}
jqueryMap.$wf_taskList_tbody.html(beopTmpl('tpl_wf_taskList',{transactions:beop.model.stateMap.trans_list.records?beop.model.stateMap.trans_list.records:[]}));jqueryMap.$wf_task_star=$(".wf-task-star");jqueryMap.$wf_task_pagination=$("#task-pagination");paginationRefresh(beop.model.stateMap.trans_list.total);I18n.fillArea(stateMap.$container);};paginationRefresh=function(totalNum){var totalPages=Math.ceil(totalNum/configMap.taskList_num_per_page);if(!totalNum){return;}
while(totalPages<stateMap.currentPage&&stateMap.currentPage>1){stateMap.currentPage=stateMap.currentPage-1;}
var pageOption={first:'&laquo;&laquo',prev:'&laquo;',next:'&raquo;',last:'&raquo;&raquo;',startPage:stateMap.currentPage?stateMap.currentPage:1,totalPages:!totalPages?1:totalPages,onPageClick:function(event,page){stateMap.currentPage=page;loadTaskList(null,stateMap.task_list_type,stateMap.task_list_user,page,{orderProperty:stateMap.orderProperty,asc:stateMap.asc});}};if(stateMap.currentPage){pageOption['startPage']=stateMap.currentPage?stateMap.currentPage:1;}
stateMap.pagination=jqueryMap.$wf_task_pagination.twbsPagination(pageOption);};starSelect=function(event,type,param){if(jqueryMap.$wf_task_star.hasClass("glyphicon-star-empty")){jqueryMap.$wf_task_star.removeClass("glyphicon-star-empty").addClass("glyphicon-star");}else{jqueryMap.$wf_task_star.removeClass("glyphicon-star").addClass("glyphicon-star-empty");}};changeOrderIcon=function(){jqueryMap.$wf_taskList_table.find('th .glyphicon').remove();};onClickReturnActivities=function(){beop.view.returnActivitiesList=jqueryMap.$container.children().detach();beop.view.activities.init(stateMap.$container,true).done(function(){$.spEvent.pubEvent(configMap.spEventActivities.topic,configMap.spEventActivities.param);});};resetState=function(){stateMap.pagination=null;};loadTaskList=function(event,type,user_id,currentPage,orderObject){currentPage=currentPage||1;stateMap.task_list_user=user_id;stateMap.task_list_type=type;stateMap.orderObject=orderObject;stateMap.currentPage=currentPage;switch(type){case'workingTask':{return configMap.transactions_model.listTransWorking(user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'createdBy':{return configMap.transactions_model.listTransCreatedBy(user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'finishedBy':{return configMap.transactions_model.listTransFinishedBy(user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'joinedBy':{return configMap.transactions_model.listTransJoinedBy(user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'group':{return configMap.transactions_model.listGroupTrans(currentPage,orderObject).done(function(result){if(result.success){renderTaskList(user_id);}});}
case'search':{var text=$.trim(jqueryMap.$wf_level_search.val());return configMap.transactions_model.searchTrans(AppConfig.userId,text,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'tag':{return configMap.tags_model.transTag(AppConfig.userId,user_id,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}
case'myCollection':{return configMap.transactions_model.listTransStarBy(AppConfig.userId,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}}};searchTaskList=function(event,type,user_id,currentPage,orderObject){jqueryMap.$wf_level_search.keyup(function(e){if(e.keyCode==13){loadTaskList(null,stateMap.task_list_type,AppConfig.userId,1,{orderProperty:stateMap.orderProperty,asc:stateMap.asc});}});currentPage=currentPage||1;stateMap.task_list_user=user_id;stateMap.task_list_type=type;switch(type){case'search':{var text=$.trim(jqueryMap.$wf_level_search.val());if(text!=""){return configMap.transactions_model.searchTrans(AppConfig.userId,text,currentPage,orderObject).done(function(result){if(result.success){renderTaskList();}});}}}};loadTaskDetail=function(event,type,param){beop.view.returnTaskList=jqueryMap.$container.children().detach();beop.view.taskDetail.configModel({canBack:true,canEdit:true,whereBack:'taskDetail',taskListType:stateMap.task_list_type,taskListPage:stateMap.currentPage,taskListUserId:stateMap.task_list_user,taskListOrderObject:stateMap.orderObject});beop.view.taskDetail.init(stateMap.$container,type,param);};onTableTaskClick=function(){var $this=$(this);var topic=$this.data('topic'),param=$this.data('param').split(';');$.spEvent.pubEvent(topic,param);};onTableHeadClick=function(){var $this=$(this);stateMap.orderProperty=$this.data('order-property');stateMap.asc=$this.find('.glyphicon').hasClass('glyphicon-sort-by-attributes-alt');loadTaskList(null,stateMap.task_list_type,stateMap.task_list_user,1,{orderProperty:stateMap.orderProperty,asc:stateMap.asc}).done(function(result){if(result.success){$this.siblings('th').find('.glyphicon').remove();if($this.find('.glyphicon').length){$this.find('.glyphicon').toggleClass('glyphicon-sort-by-attributes-alt').toggleClass('glyphicon-sort-by-attributes');}else{$this.prepend('<span class="glyphicon glyphicon-sort-by-attributes-alt"></span>');}
stateMap.currentPage=1;paginationRefresh(beop.model.stateMap.trans_list.total);}})};beop.view=beop.view||{};beop.view.taskList={configModel:configModel,loadTaskList:loadTaskList,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_group.html',settable_map:{group_model:true},group_model:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init,loadTaskDetail,onItemClick;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();stateMap.$container.on('click','[data-topic]',onItemClick);stateMap.$container.on('click','.wf-task-star',function(e){var $this=$(this);if($this.hasClass("glyphicon-star-empty")){$this.removeClass("glyphicon-star-empty").addClass("glyphicon-star");}else{$this.removeClass("glyphicon-star").addClass("glyphicon-star-empty");}});});$.spEvent.subEvent(stateMap.$container,'wf-load-detail',loadTaskDetail);};onItemClick=function(){var $this=$(this);var topic=$this.data('topic'),param=$this.data('param');$.spEvent.pubEvent(topic,param);};loadTaskDetail=function(event,type,param){beop.view.taskDetail.init(stateMap.$container,type);};beop.view=beop.view||{};beop.view.groupShow={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_group_add.html',settable_map:{group_model:true,data:true},group_model:null,data:null},stateMap={usersMap:{},addedUserList:[]},jqueryMap={},setJqueryMap,configModel,init,renderCheckedUsers,renderAddedUsers,onAddUserDialogOpen,onSubmit;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$add_group_form:$container.find('#wf-add-group-form'),$add_user_dialog:$container.parent().find('#wf-add-person'),$wf_check_result:$container.find('.wf-check-result'),$wf_added_user_list:$container.find('.wf-added-user-list'),$wf_add_edit_title:$container.find('#wf-group-addOrEdit'),$wf_task_group:$container.parent().find('#wf-task-group')};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;setJqueryMap();WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();jqueryMap.$add_group_form.html(beopTmpl('tpl_wf_group_add'));jqueryMap.$add_user_dialog.off().on('show.bs.modal',onAddUserDialogOpen);jqueryMap.$add_group_form.submit(onSubmit);jqueryMap.$wf_added_user_list=jqueryMap.$container.find('.wf-added-user-list');jqueryMap.$wf_add_edit_title.attr('i18n','workflow.task.ADD_NEW_TASK_GROUP');}).always(function(){I18n.fillArea(jqueryMap.$container);});};renderCheckedUsers=function(){jqueryMap.$wf_check_result.html(beopTmpl('tpl_wf_dialog_added_member',{members:stateMap.addedUserList}))};renderAddedUsers=function(addedUserList){jqueryMap.$wf_added_user_list.html(beopTmpl('tpl_wf_added_member',{members:addedUserList}))};onAddUserDialogOpen=function(){beop.view.memberSelected.configModel({cb_dialog_hide:renderAddedUsers,maxSelected:null,userHasSelected:null});beop.view.memberSelected.init(jqueryMap.$container.parent());};onSubmit=function(){Spinner.spin(jqueryMap.$wf_task_group.get(0));var $form=$(this);configMap.group_model.addGroup($form.serializeObject()).done(function(result){if(result.success){Alert.success(ElScreenContainer,'add Group success!').showAtTop(2000);jqueryMap.$container.find('#wf-group-name').val('');jqueryMap.$container.find('#wf-group-des').val('');jqueryMap.$container.find('#wf-workflow-memberList').empty();jqueryMap.$add_user_dialog.off().on('show.bs.modal',onAddUserDialogOpen);}
beop.view.menu_group_list.configModel({whereComeFrom:'default'});beop.view.menu_group_list.init(jqueryMap.$wf_task_group);Spinner.stop();});};beop.view=beop.view||{};beop.view.groupAdd={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={settable_map:{group_model:true},group_model:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_del_win:$("#wf-del-win"),$wf_event_confirm:$("#wf-event-confirm"),$wf_task_groups:$("#wf-task-groups")};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;setJqueryMap();jqueryMap.$wf_del_win.modal();jqueryMap.$wf_event_confirm.off().on('click',function(e){if(jqueryMap.$wf_del_win.attr("data-type")==="taskGroup"){var param=jqueryMap.$wf_del_win.attr("data-param");beop.view.menu_group_list.configModel({whereComeFrom:'default'});configMap.group_model.deleteGroup(param).done(function(result){if(result.success){if(jqueryMap.$container.attr("data-group-no")==param){jqueryMap.$container.html("");}
jqueryMap.$wf_del_win.attr("data-type","");jqueryMap.$wf_del_win.modal("hide");Spinner.spin($container.parent().find('#wf-task-group').get(0));beop.view.menu_group_list.init($container.parent()).done(function(){}).always(function(){Spinner.stop();}).fail(function(){});}});}});};beop.view=beop.view||{};beop.view.groupDelete={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_edit.html',settable_map:{transactions_model:true,tags_model:true,canClose:true,canBack:true,canEdit:true,whereBack:true,taskListType:true,taskListPage:true,taskListUserId:true,taskListOrderObject:true},transactions_model:null,tags_model:null,canClose:false,canBack:false,canEdit:false,whereBack:'taskDetail',taskListType:null,taskListPage:null,taskListUserId:null,taskListOrderObject:null},stateMap={userSelectedMap:{'verifiers':[],'executor':[],'watchers':[]},labelList:[],tag_list:[]},jqueryMap={},setJqueryMap,configModel,init,attachEvent,renderTags,renderTagsSelector,onPubEvent,starSelect,funChange,addComment,onNewTaskSubmit,loadTaskDetail,initDatePicker,returnTaskList,showTaskDetail,editTaskDetail,loadFaultCurve,loadBottomSection,onAddUserDialogOpen,onTaskSave,onTaskDelete,onCompleteTask,onVerifyPass,onVerifyNotPass,onTagDelete,onAddTag,addTagOnPage,removeTagOnPage,getTag,isExistTag,renderAddedUsers,resetData,setUserHasSelectedMap;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap=$.extend(jqueryMap?jqueryMap:{},{$container:$container,$wf_taskDetail_container:$container.find('#wf-detail-container'),$wf_taskDetail_form:$container.find('#wf-detail-form'),$begin_time:$container.find("#beginTime"),$due_time:$container.find("#dueTime"),$label_name:$container.find("#labelName"),$wf_detail_star:$container.find("#wf-detail-star"),$wf_labelName_error:$container.find("#wf-labelName-error"),$wf_comment_btn:$container.find("#wf-comment-btn"),$wf_comment_text:$container.find("#wf-comment-text"),$wf_comment_table:$container.find("#wf-comment-table"),$wf_task_label:$container.find(".wf-task-label"),$wf_fault_curve:$container.find('#wf-fault-curve'),$wf_task_return:$container.find('#wf-task-return'),$wf_detail_show:$container.find('#wf-detail-show'),$wf_detail_edit:$container.find('#wf-detail-edit'),$wf_detail_submit:$container.find('#wf-detail-submit'),$wf_detail_other_fun_wrapper:$container.find('#wf-detail-other-fun-wrapper'),$wf_del_win:$("#wf-del-win"),$wf_event_confirm:$("#wf-event-confirm"),$wf_show_tags_text:$("#wf-detail-show-tags-wrapper"),$wf_detail_collection:$("#wf-detail-collection")});};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container,type,transId){stateMap.$container=$container;$.spEvent.subEvent(stateMap.$container,'wf-fun-change',funChange);$.spEvent.subEvent(stateMap.$container,'wf-add-comment',addComment);$.spEvent.subEvent(stateMap.$container,'wf-task-return',returnTaskList);$.spEvent.subEvent(stateMap.$container,'wf-detail-show',showTaskDetail);return WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);stateMap.transId=transId;jqueryMap.$wf_taskDetail_container=stateMap.$container.find('#wf-detail-container');stateMap.$container.off('click.pubEvent').on('click.pubEvent','[data-topic]',onPubEvent);stateMap.$container.off('click.wf-detail-save').on('click.wf-detail-save','#wf-detail-save',onTaskSave);stateMap.$container.off('click.wf-detail-delete').on('click.wf-detail-delete','#wf-detail-delete',onTaskDelete);stateMap.$container.off('click.wf-add-user').on('click.wf-add-user','.wf-add-user',onAddUserDialogOpen);stateMap.$container.off('click.wf-detail-edit').on('click.wf-detail-edit','#wf-detail-edit',editTaskDetail);stateMap.$container.off('click.wf-detail-complete').on('click.wf-detail-complete','#wf-detail-complete',onCompleteTask);stateMap.$container.off('click.wf-verify-pass').on('click.wf-verify-pass','#wf-verify-pass',onVerifyPass);stateMap.$container.off('click.wf-verify-not-pass').on('click.wf-verify-not-pass','#wf-verify-not-pass',onVerifyNotPass);stateMap.$container.off('click.wf-detail-tag-delete').on('click.wf-detail-tag-delete','.wf-detail-tag-delete',onTagDelete);stateMap.$container.off('click.wf-star-select').on('click.wf-star-select','#wf-detail-star',starSelect);stateMap.$container.off('change.labelName').on('change.labelName','#labelName',onAddTag);resetData();loadTaskDetail(type).done(function(){I18n.fillArea(stateMap.$container);setJqueryMap();attachEvent();initDatePicker();});});};attachEvent=function(e){jqueryMap.$wf_event_confirm.off().on('click',function(e){if(jqueryMap.$wf_del_win.attr("data-type")==="taskItem"){configMap.transactions_model.delTrans(stateMap.transId).done(function(result){if(result.success){beop.view.taskList.init(jqueryMap.$container).done(function(){$.spEvent.pubEvent('wf-task-list',[configMap.taskListType,configMap.taskListUserId,configMap.taskListPage,configMap.taskListOrderObject]);jqueryMap.$wf_del_win.attr("data-type","");jqueryMap.$wf_del_win.modal("hide");});}});}});};renderTags=function(tags){jqueryMap.$wf_detail_labelWrapper=stateMap.$container.find("#wf-detail-labelWrapper");jqueryMap.$wf_detail_labelWrapper.html(beopTmpl('tpl_wf_detail_labels',{tags:tags}));};starSelect=function(){if(jqueryMap.$wf_detail_star.hasClass("glyphicon-star-empty")){jqueryMap.$wf_detail_star.removeClass("glyphicon-star-empty").addClass("glyphicon-star");jqueryMap.$wf_detail_collection.val(1);}else{jqueryMap.$wf_detail_star.removeClass("glyphicon-star").addClass("glyphicon-star-empty");jqueryMap.$wf_detail_collection.val(0);}};returnTaskList=function(){switch(configMap.whereBack){case'activities':stateMap.$container.html("").append(beop.view.returnActivitiesList);break;case'taskDetail':beop.view.taskList.init(jqueryMap.$container).done(function(){$.spEvent.pubEvent('wf-task-list',[configMap.taskListType,configMap.taskListUserId,configMap.taskListPage,configMap.taskListOrderObject]);});break;}};funChange=function(event,type,param){if(type=="comment"){jqueryMap.$wf_detail_comment.show();jqueryMap.$wf_detail_progress.hide();jqueryMap.$wf_detail_comment_nav.addClass("active").siblings().removeClass("active");}else if(type=="progress"){jqueryMap.$wf_detail_comment.hide();jqueryMap.$wf_detail_progress.show();jqueryMap.$wf_detail_progress_nav.addClass("active").siblings().removeClass("active");beop.view.progress.init(jqueryMap.$wf_detail_progress);}};addComment=function(event,type,param){var val=$.trim(jqueryMap.$wf_comment_text.val());if(val!=''){jqueryMap.$wf_comment_table.prepend(jqueryMap.$wf_comment_table.find("tbody tr").eq(0).clone());jqueryMap.$wf_comment_table.find("tbody tr").eq(0).find(".wf-comment-content").text(val);}};renderAddedUsers=function(type){return function(addedUserList){stateMap.userSelectedMap[type]=addedUserList;jqueryMap.$wf_added_user_list.filter(function(index,item){return $(item).data('type')===type;}).html(beopTmpl('tpl_wf_added_member_personal',{members:addedUserList,userListName:type?type:'addedUserList'}))}};onPubEvent=function(){var $this=$(this);var topic=$this.data('topic'),param=$this.data('param');$.spEvent.pubEvent(topic,param);};resetData=function(){for(var key in stateMap.userSelectedMap){if(stateMap.userSelectedMap.hasOwnProperty(key)){stateMap.userSelectedMap[key]=[];}}
stateMap.tag_list=[];};initDatePicker=function(){jqueryMap.$due_time=jqueryMap.$container.find('#dueTime');jqueryMap.$due_time.datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true});};loadTaskDetail=function(param,newTransId){if(param=="new"){jqueryMap.$wf_taskDetail_container.html("");jqueryMap.$wf_taskDetail_container.append(beopTmpl('tpl_wf_detail_new'));jqueryMap.$wf_taskDetail_container.on('submit','form.task-new',onNewTaskSubmit);setJqueryMap();renderTagsSelector();return $.Deferred().resolve();}
resetData();if(!stateMap.transId){stateMap.transId=newTransId;}
return configMap.transactions_model.getTrans(stateMap.transId).done(function(result){if(result.success){if(param=="show"){jqueryMap.$wf_taskDetail_container.html(beopTmpl('tpl_wf_detail_show',{trans:beop.model.stateMap.cur_trans}));}else if(param=="edit"){jqueryMap.$wf_taskDetail_container.html(beopTmpl('tpl_wf_detail_edit',{trans:beop.model.stateMap.cur_trans,labels:stateMap.labelList}));renderTagsSelector();}
stateMap.tag_list=beop.model.stateMap.cur_trans.tags.slice();renderTags(stateMap.tag_list);stateMap.dataDefault=Object.freeze({verifiers:result.data.verifiers,executor:[result.data.executor],watchers:result.data.watchers});setUserHasSelectedMap(result.data);I18n.fillArea($('#wf-content'));$('[data-toggle="tooltip"]').tooltip();}else{jqueryMap.$wf_taskDetail_container.html(beopTmpl('tpl_wf_detail_empty',{}));}
stateMap.type=param;loadFaultCurve();loadBottomSection();I18n.fillArea(stateMap.$container);});};loadFaultCurve=function(){if(beop.model.stateMap.cur_trans.chartPointList){jqueryMap.$wf_fault_curve=stateMap.$container.find('#wf-fault-curve');beop.view.faultCurve.init(jqueryMap.$wf_fault_curve);}};loadBottomSection=function(){jqueryMap.$wf_detail_other_fun_wrapper=$("#wf-detail-other-fun-wrapper");jqueryMap.$wf_detail_other_fun_wrapper.html(beopTmpl('tpl_wf_detail_fun'));jqueryMap.$wf_detail_comment_nav=stateMap.$container.find("#wf-detail-comment-nav");jqueryMap.$wf_detail_progress_nav=stateMap.$container.find("#wf-detail-progress-nav");jqueryMap.$wf_detail_comment=stateMap.$container.find("#wf-detail-comment");jqueryMap.$wf_detail_progress=stateMap.$container.find("#wf-detail-progress");beop.view.replyList.init(jqueryMap.$wf_detail_comment);};setUserHasSelectedMap=function(result){var executor=result.executor,verifiers=result.verifiers||[],watchers=result.watchers||[];if(executor){stateMap.userSelectedMap.executor=[{"id":executor.id,"userfullname":executor.userfullname,"username":executor.username,"userpic":executor.userpic}];}
verifiers.forEach(function(item,index,array){stateMap.userSelectedMap.verifiers.push({"id":item.id,"userfullname":item.userfullname,"username":item.username,"userpic":item.userpic});});watchers.forEach(function(item,index,array){stateMap.userSelectedMap.watchers.push({"id":item.id,"userfullname":item.userfullname,"username":item.username,"userpic":item.userpic});});};onTaskSave=function(){Spinner.spin(jqueryMap.$container[0]);configMap.transactions_model.updateTrans(jqueryMap.$wf_taskDetail_form.serializeObject()).done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).always(function(){Spinner.stop();});};onTaskDelete=function(){jqueryMap.$wf_del_win.modal();jqueryMap.$wf_del_win.attr("data-type","taskItem");};onAddUserDialogOpen=function(){var type=$(this).data('type');jqueryMap.$wf_added_user_list=$(this).siblings('.wf-detail-userInfoWrapper');beop.view.memberSelected.configModel({cb_dialog_hide:renderAddedUsers(type),userHasSelected:stateMap.userSelectedMap[type],maxSelected:type=='executor'?1:null,enableDeleteMember:true,enableAddMember:true});beop.view.memberSelected.init(jqueryMap.$container.parent());};showTaskDetail=function(){var empty={};stateMap.userSelectedMap=$.extend(true,empty,stateMap.dataDefault);jqueryMap.$wf_taskDetail_form.html(beopTmpl('tpl_wf_detail_show',{trans:beop.model.stateMap.cur_trans}));setJqueryMap();I18n.fillArea(jqueryMap.$container);$('[data-toggle="tooltip"]').tooltip();stateMap.type="show";stateMap.tag_list=[];renderTags(beop.model.stateMap.cur_trans.tags);};renderTagsSelector=function(){jqueryMap.$label_name.html(beopTmpl('tpl_wf_detail_new_tags_option',{tags:beop.model.stateMap.tag_list}));I18n.fillArea(jqueryMap.$label_name);};editTaskDetail=function(){jqueryMap.$wf_taskDetail_form.html(beopTmpl('tpl_wf_detail_edit',{trans:beop.model.stateMap.cur_trans,labels:stateMap.labelList}));setJqueryMap();initDatePicker();I18n.fillArea(jqueryMap.$container);$('[data-toggle="tooltip"]').tooltip();stateMap.type="edit";stateMap.tag_list=beop.model.stateMap.cur_trans.tags.slice();renderTags(beop.model.stateMap.cur_trans.tags);renderTagsSelector();};addTagOnPage=function(tagId){if(stateMap.tag_list.length>=3){jqueryMap.$wf_labelName_error.show();return false;}
jqueryMap.$wf_labelName_error.hide();if(isExistTag(tagId)){return false;}
var tag=getTag(tagId);if(tag){stateMap.tag_list.push(tag);}};isExistTag=function(tagId){for(var m=0;m<stateMap.tag_list.length;m++){if(stateMap.tag_list[m].id==tagId){return true;}}
return false;};removeTagOnPage=function(tagId){for(var m=0;m<stateMap.tag_list.length;m++){if(stateMap.tag_list[m].id==tagId){stateMap.tag_list.splice(m,1);}}};getTag=function(tagId){for(var m=0;m<beop.model.stateMap.tag_list.length;m++){if(beop.model.stateMap.tag_list[m].id==tagId){return beop.model.stateMap.tag_list[m];}}
return null;};onAddTag=function(){addTagOnPage($(this).val());renderTags(stateMap.tag_list);};onTagDelete=function(){removeTagOnPage($(this).data('id'));renderTags(stateMap.tag_list);};onNewTaskSubmit=function(){var $form=$(this);Spinner.spin(jqueryMap.$container[0]);configMap.transactions_model.addTrans($form.serializeObject()).done(function(result){if(result.success){loadTaskDetail("show",result.data).done(function(){loadFaultCurve();showTaskDetail();});}else{if(result.msg){Alert.danger(ElScreenContainer,'add new task fail!'+'<br/>'+result.msg).showAtTop(1000);}}}).fail(function(result){if(result.success){Alert.danger(ElScreenContainer,'add new task fail!').showAtTop(1000);}}).always(function(){Spinner.stop();});};onCompleteTask=function(){configMap.transactions_model.completeTrans().done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).fail(function(result){if(result.success){Alert.danger(ElScreenContainer,'update fail!').showAtTop(2000);}})};onVerifyPass=function(){if($(this).hasClass('active')){return false;}
Spinner.spin(jqueryMap.$container.get(0));configMap.transactions_model.verifyPass().done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).fail(function(result){if(result.success){Alert.danger(ElScreenContainer,'update fail!').showAtTop(2000);}}).always(function(){Spinner.stop();})};onVerifyNotPass=function(){if($(this).hasClass('active')){return false;}
Spinner.spin(jqueryMap.$container.get(0));configMap.transactions_model.verifyNotPass().done(function(result){if(result.success){loadTaskDetail("show").done(function(){showTaskDetail();});}}).fail(function(result){if(result.success){Alert.danger(ElScreenContainer,'update fail!').showAtTop(2000);}}).always(function(){Spinner.stop();})};beop.view=beop.view||{};beop.view.taskDetail={configModel:configModel,loadTaskDetail:loadTaskDetail,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'',settable_map:{transactions_model:true},transactions_model:null},stateMap={chartInstance:null},jqueryMap={},setJqueryMap,configModel,init,renderChart;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){if(!$container||!$container.length){return;}
stateMap.$container=$container;stateMap.$container.show();setJqueryMap();stateMap.chartInstance=echarts.init(jqueryMap.$container.get(0),AppConfig.chartTheme);stateMap.chartInstance.showLoading({text:'loading',effect:'spin',textStyle:{fontSize:20}});configMap.transactions_model.faultCurve().done(function(result){if(result.success){renderChart(result.data);}});};renderChart=function(record){var list_description=record.description,list_value=record.value,arrXAxis;if(list_description.length!==list_value.length){jqueryMap.$container.hide();}
if(record.time.length>0)
arrXAxis=record.time[0].split(',');var arrSeriesTemp=[];for(var i=0;i<list_value.length;i++){var arrDatas=[];if(i<8){var item=list_value[i];if(item){var strDatas=item.split(",");for(var j=0;j<strDatas.length;++j){arrDatas.push(parseFloat(strDatas[j]).toFixed(1));}}
arrSeriesTemp.push({name:list_description[i],type:'line',itemStyle:{normal:{lineStyle:{type:'solid'}}},data:arrDatas});}}
var option={title:{text:I18n.resource.workflow.notice.FAULT_CURVE,x:'left'},tooltip:{trigger:'axis'},legend:{data:list_description,x:'center'},toolbox:{show:true},dataZoom:{show:true,start:0,end:100},xAxis:[{type:'category',boundaryGap:false,axisLine:{onZero:false},data:arrXAxis}],yAxis:[{type:'value',scale:true}],series:arrSeriesTemp};stateMap.chartInstance.hideLoading();stateMap.chartInstance.setOption(option);window.onresize=stateMap.chartInstance.resize;};beop.view=beop.view||{};beop.view.faultCurve={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'',settable_map:{transactions_model:true,reply_mode:true},transactions_model:null,reply_mode:null},stateMap={maxIMGWidth:$('body').width()/2},jqueryMap={},setJqueryMap,configModel,init,onReplySubmit,refreshReply,bindImgZoom,imgZoom;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$wf_reply_table:$container.find("#wf-reply-table"),$wf_editor:$container.find('#wf-editor'),$wf_btn_reply:$container.find('#wf-btn-reply')};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;stateMap.$container.show();setJqueryMap();configMap.transactions_model.getReply().done(function(result){if(result.success){$container.html(beopTmpl('tpl_detail_reply',result));$container.find('#wf-reply-table').html(beopTmpl('tpl_reply_table_body',result));setJqueryMap();jqueryMap.$wf_editor.wysiwyg();jqueryMap.$wf_btn_reply.off().on("click",onReplySubmit);bindImgZoom();}}).always(function(){I18n.fillArea($container);});};refreshReply=function(){configMap.transactions_model.getReply().done(function(result){if(result.success){jqueryMap.$container.find('#wf-reply-table').html(beopTmpl('tpl_reply_table_body',result));setTimeout(function(){bindImgZoom('new');},0)}});};bindImgZoom=function(type){var imgList=jqueryMap.$container.find('#wf-reply-table').find('.wf-reply-info img');if(type==='new'){imgList.eq(0).off().on('load',function(){var $this=$(this);if($this.context.naturalWidth>stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css('cursor','-webkit-zoom-in')}});imgList.each(function(){var $this=$(this);if($this.context.naturalWidth>stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css('cursor','-webkit-zoom-in')}})}else{imgList.each(function(){var $this=$(this);$this.off().on('load',function(){if($this.context.naturalWidth>stateMap.maxIMGWidth){$this.off().on('click',imgZoom);$this.css('cursor','-webkit-zoom-in')}});})}};imgZoom=function(ev){ev.stopPropagation();ev.preventDefault();var imgSRC=$(this).attr('src'),$body=$('body'),$htmlMask=$('<div id="wf-img-zoom" class=""><img style="cursor: -webkit-zoom-out;" src="'+imgSRC+' "/> </div>');$htmlMask.off().on('click',function(){$(this).remove();});$body.append($htmlMask);};onReplySubmit=function(){var val=$.trim(jqueryMap.$wf_editor.html());if(!val){alert('reply can\'t be empty');}
configMap.reply_mode.insertReply({'detail':val}).done(function(result){if(result.success){jqueryMap.$wf_editor.html('');refreshReply();}});};beop.view=beop.view||{};beop.view.replyList={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'',settable_map:{transactions_model:true},transactions_model:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;stateMap.$container.show();setJqueryMap();configMap.transactions_model.getProgress().done(function(result){if(result.success){$container.html(beopTmpl('tpl_detail_progress',result));jqueryMap.$wf_detail_verticalLine=$container.find("#wf-detail-verticalLine");if($container.find("li").length>1){var height=$("#wf-detail-progress .timeLineIcon:last").offset().top-$("#wf-detail-progress .timeLineIcon:first").offset().top;jqueryMap.$wf_detail_verticalLine.css("height",height+"px");}}});};beop.view=beop.view||{};beop.view.progress={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'/static/views/workflow/task_group_add.html',settable_map:{group_model:true,data:true,enableEdit:true},group_model:null,data:null,enableEdit:null},stateMap={usersMap:{},addedUserList:[]},jqueryMap={},setJqueryMap,configModel,init;var getGroupData,setEditJqueryMap,renderAddedUsers,onAddUserDialogOpen,onSubmit;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$add_group_form:$container.find('#wf-add-group-form'),$add_user_dialog:$container.parent().find('#wf-add-person'),$wf_added_user_list:$container.find('.wf-added-user-list'),$wf_add_edit_title:$container.find('#wf-group-addOrEdit'),$wf_task_group:$container.parent().find('#wf-task-group')};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;Spinner.spin($container.get(0));WebAPI.get(configMap.htmlURL).done(function(resultHtml){stateMap.$container.html(resultHtml);I18n.fillArea(stateMap.$container);setJqueryMap();getGroupData().done(function(result){if(result.success){jqueryMap.$add_group_form.html(beopTmpl('tpl_wf_group_edit',{data:result.data,enableEdit:configMap.enableEdit}));setEditJqueryMap();jqueryMap.$add_user_dialog.off().on('show.bs.modal',onAddUserDialogOpen);if(configMap.enableEdit){jqueryMap.$wf_add_edit_title.attr('i18n','workflow.task.EDIT_TASK_GROUP');jqueryMap.$add_group_form.submit(onSubmit).find('button.wf-btn-add-group').attr('i18n','workflow.task.EDIT_TASK_GROUP_BTN;value=workflow.task.EDIT_TASK_GROUP_BTN;title=workflow.task.EDIT_TASK_GROUP_BTN');}else{jqueryMap.$wf_add_edit_title.attr('i18n','workflow.task.SEE_TASK_GROUP_INFO');}
jqueryMap.$wf_added_user_list=jqueryMap.$container.find('.wf-added-user-list');jqueryMap.$workflowMemberContainer.html(beopTmpl('tpl_wf_added_member',{members:result.data.members}));beop.view.memberSelected.configModel({maxSelected:null,userHasSelected:result.data.members});}}).fail(function(){Alert.danger(ElScreenContainer,'Got Data Failed').showAtTop(300);}).always(function(result){if(result.msg){Alert.danger(ElScreenContainer,result.msg).showAtTop(300);}
I18n.fillArea(jqueryMap.$container);Spinner.stop();});});};setEditJqueryMap=function(){jqueryMap.$workflowMemberContainer=jqueryMap.$container.find('#wf-workflow-memberList');};renderAddedUsers=function(addedUserList){jqueryMap.$wf_added_user_list.html(beopTmpl('tpl_wf_added_member',{members:addedUserList}))};getGroupData=function(){return configMap.group_model.getGroupData(configMap.data.param);};onAddUserDialogOpen=function(){beop.view.memberSelected.configModel({cb_dialog_hide:renderAddedUsers,maxSelected:null});beop.view.memberSelected.init(jqueryMap.$container.parent());};onSubmit=function(){Spinner.spin(jqueryMap.$wf_task_group.get(0));var $form=$(this);configMap.group_model.editGroup(configMap.data.param,$form.serializeObject()).done(function(result){if(result.success){Alert.success(ElScreenContainer,'edit Group success!').showAtTop(2000);beop.view.menu_group_list.configModel({whereComeFrom:'default'});beop.view.menu_group_list.init(jqueryMap.$wf_task_group);Spinner.stop();}});};beop.view.groupEdit={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'',settable_map:{group_model:true,whereComeFrom:true},group_model:null,whereComeFrom:null},stateMap={},jqueryMap={},setJqueryMap,configModel,init,bindCalendarEvents,onGroupTypeChange,onToggleGroup;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$container:$container,$group_ul:$container.find('#wf-task-groups'),$group_type_selector:$container.find('#wf-group-type')};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;setJqueryMap();if(configMap.whereComeFrom=='calendar'){return configMap.group_model.getUserGroups().done(function(result){jqueryMap.$group_ul.html(beopTmpl('tpl_wf_group_list_calendar',result.data));jqueryMap.$group_type_selector.on('change',onGroupTypeChange);I18n.fillArea(jqueryMap.$container);});}else if(configMap.whereComeFrom=='default'){return configMap.group_model.getUserGroups().done(function(result){jqueryMap.$group_ul.html(beopTmpl('tpl_wf_group_list',result.data));jqueryMap.$edit_group=jqueryMap.$container.find('.edit-group');jqueryMap.$edit_group.off().on('click',onToggleGroup);I18n.fillArea(jqueryMap.$container);jqueryMap.$group_type_selector.on('change',onGroupTypeChange);});}};onToggleGroup=function(){var $this=$(this);var $editPanel=$this.closest(".group-item").find(".wf-group-edit");$this.closest('#wf-task-groups').find('.wf-group-edit').not($editPanel).hide();$editPanel.toggle();};onGroupTypeChange=function(){var $this=$(this);if($this.val()==0){jqueryMap.$group_ul.find('li').show();}else{jqueryMap.$group_ul.find('li').not('.wf-get-crumbs').hide();jqueryMap.$group_ul.find('li[grouptype='+$this.val()+']').show();}
jqueryMap.$group_ul.find('.wf-group-edit').hide();};beop.view=beop.view||{};beop.view.menu_group_list={configModel:configModel,init:init};}(beop||(beop={})));(function(beop){var configMap={htmlURL:'',settable_map:{tags_model:true,whereComeFrom:true},tags_model:null,whereComeFrom:null},stateMap={labelTagList:[],tagDataList:{update:[],new:[]}},jqueryMap={},setJqueryMap,configModel,init,onToggleUl,onLabelEdit,onLabelPlus,onLabelDelete,progressData,resetTagDataList,sendDataToBack,restoreEditStatus;setJqueryMap=function(){var $container=stateMap.$container;jqueryMap={$wrapper:$("#wf-outline"),$wf_label_form:$("#wf-label-form"),$wf_label_edit:$("#wf-label-edit"),$wf_label_plus:$("#wf-label-plus"),$wf_label_icon_wrapper:$("#wf-label-icon-wrapper"),$container:$container};};configModel=function(input_map){beop.util.setConfigMap({input_map:input_map,settable_map:configMap.settable_map,config_map:configMap});return true;};init=function($container){stateMap.$container=$container;setJqueryMap();restoreEditStatus();configMap.tags_model.getUserTags().done(function(result){if(result.data){stateMap.labelTagList=result.data;stateMap.$container.html(beopTmpl('tpl_wf_tags_list_text',{labels:stateMap.labelTagList}));}
jqueryMap.$wrapper.off('click.wf-label-toggle').on('click.wf-label-toggle','#wf-label-toggle',onToggleUl);jqueryMap.$wrapper.off('click.wf-label-edit').on('click.wf-label-edit','#wf-label-edit',onLabelEdit);jqueryMap.$wrapper.off('click.wf-label-plus').on('click.wf-label-plus','#wf-label-plus',onLabelPlus);jqueryMap.$wrapper.off('click.wf-label-delete').on('click.wf-label-delete','.wf-label-delete',onLabelDelete);}).fail(function(result){}).always(function(){I18n.fillArea(jqueryMap.$container);});};resetTagDataList=function(){stateMap.tagDataList.new=[];stateMap.tagDataList.update=[];};onToggleUl=function(){var $this=$(this);if($this.hasClass("wf-tags-ul-hide")){jqueryMap.$container.show();jqueryMap.$wf_label_icon_wrapper.show();$this.removeClass("wf-tags-ul-hide").addClass("wf-tags-ul-show");}else if($this.hasClass("wf-tags-ul-show")){jqueryMap.$container.hide();jqueryMap.$wf_label_icon_wrapper.hide();$this.removeClass("wf-tags-ul-show").addClass("wf-tags-ul-hide");}};restoreEditStatus=function(){jqueryMap.$wrapper.find('#wf-label-edit').removeClass("glyphicon-ok-circle").addClass("glyphicon-edit");jqueryMap.$wf_label_plus.hide();jqueryMap.$container.hide();jqueryMap.$wf_label_icon_wrapper.hide();jqueryMap.$wrapper.find('#wf-label-toggle').removeClass("wf-tags-ul-show").addClass("wf-tags-ul-hide");};onLabelEdit=function(){var $this=$(this);if($this.hasClass("glyphicon-edit")){$this.removeClass("glyphicon-edit").addClass("glyphicon-ok-circle");jqueryMap.$wf_label_plus.show();stateMap.$container.html(beopTmpl('tpl_wf_tags_list_input',{labels:stateMap.labelTagList}));stateMap.$container.find('input').off().on('focus',function(){$(this).select();})}else{sendDataToBack().done(function(){configMap.tags_model.getUserTags().done(function(result){if(result.data){stateMap.labelTagList=result.data;stateMap.$container.html(beopTmpl('tpl_wf_tags_list_text',{labels:stateMap.labelTagList}));}}).always(function(){jqueryMap.$wf_label_plus.hide();$this.removeClass("glyphicon-ok-circle").addClass("glyphicon-edit");Spinner.stop();I18n.fillArea(jqueryMap.$container);}).fail(function(){Alert.danger(ElScreenContainer,'Edit Tags Failed').showAtTop(300);})}).fail(function(){Alert.danger(ElScreenContainer,'Edit Tags To DATABASE Failed').showAtTop(300);})}};onLabelPlus=function(){jqueryMap.$container.append(beopTmpl('tpl_wf_tags_list_input_empty'));jqueryMap.$wf_label_form.scrollTop(3000);I18n.fillArea($(ElScreenContainer));};onLabelDelete=function(){var $this=$(this);if($(this).closest(".wf-label-li").attr("labelId")){Spinner.spin(jqueryMap.$container.get(0));configMap.tags_model.deleteTag({'user_id':AppConfig.userId,'tag_id':$(this).closest(".wf-label-li").attr("labelId")}).done(function(result){if(result.data){stateMap.labelTagList=result.data;}}).fail(function(result){}).always(function(){Spinner.stop();});}
$this.closest(".wf-label-li").remove();};progressData=function(){Spinner.spin(jqueryMap.$container.get(0));jqueryMap.$wf_lable_list=jqueryMap.$container.find('li');var updateList=jqueryMap.$container.find("li[labeltype!='new']"),newTagList=jqueryMap.$container.find("li[labeltype='new']");resetTagDataList();if(newTagList.length!==0){newTagList.each(function(){var $this=$(this),value=$.trim($this.find('input').val());if(value!==''){stateMap.tagDataList.new.push({name:value,color:"#fff"})}})}
updateList.each(function(){var $this=$(this),value=$.trim($this.find('input').val()),id=$this.attr('labelid');stateMap.labelTagList.forEach(function(item,index,array){if(id==$.trim(item.id)){if($.trim(item.name)!==value){stateMap.tagDataList.update.push({id:$.trim($this.attr('labelid')),name:value,color:"#fff"})}}});});};sendDataToBack=function(){progressData();var UserID=AppConfig.userId;var updateTagsLength=stateMap.tagDataList.update.length,newTagsLength=stateMap.tagDataList.new.length;if(updateTagsLength==0&&newTagsLength==0){return $.Deferred().resolve();}
function updateTag(){if(updateTagsLength!==0){configMap.tags_model.editTag({user_id:UserID},stateMap.tagDataList.update).fail(function(){})}else{return true;}}
function addNewTag(){if(newTagsLength!==0){configMap.tags_model.addTag({user_id:UserID},stateMap.tagDataList.new).fail(function(){});}else{return true;}}
function merge(){return Array.prototype.concat.apply([],arguments);}
return $.when(addNewTag(),updateTag()).done(function(){})};beop.view=beop.view||{};beop.view.menu_tag_list={configModel:configModel,init:init};}(beop||(beop={})));﻿var WorkflowCalendar=(function(){function WorkflowCalendar(){this.noticeList=[];this.eventType={'notice':1,'workflow':2};this.currentEvent=null;this.currentElement=null;this.$calendar=null;this.displayType=2;this.oldColor=null;this.addedNoticedMap={};this.$dateTimePicker=null;this.isManager=false;this.DOMDone=null;this.noticePromiseMap={};this.projectId=window.localStorage.getItem('calendarDefault')==null?AppConfig.projectList[0].id:window.localStorage.getItem('calendarDefault');this.firstRender=true;}
WorkflowCalendar.prototype={show:function(wrapper,dateTimePicker){var _this=this;$.get("/static/views/workflow/calendar.html").done(function(resultHtml){if(wrapper){var arr=resultHtml.split('<div class="datetimepicker-container"></div>'),html='';for(var i=0;i<arr.length;i++){html+=arr[i]}
$(wrapper).html(html);_this.isManager=true;}else{$(ElScreenContainer).html(resultHtml);}
_this.$dateTimePicker=$(dateTimePicker).length==1?$(dateTimePicker):$('.datetimepicker-container');setTimeout(function(){_this.DOMDone&&_this.DOMDone();Spinner.spin($('#events')[0]);},0);_this.init();I18n.fillArea($("#wrap"));});return this;},close:function(){this.detachEvents();},refreshPage:function(){},Done:function(func){this.DOMDone=func;},init:function(){this.$calendar=$('#calendar');this.renderProjectSelector();this.attachEvent();if(window.localStorage.calendarDefault){$('.project-selector').val(window.localStorage.calendarDefault)}},renderProjectSelector:function(){var $projectSelector=$('.project-selector');for(var m=0;m<AppConfig.projectList.length;m++){var projectItem=AppConfig.projectList[m];var projectName=StringUtil.getI18nProjectName(projectItem);$projectSelector.append('<option value="'+projectItem.id+'">'+projectName+'</option>');}},fetchNoticesData:function(force){var _this=this;var projectID=window.localStorage.getItem('calendarDefault')==null?this.projectId:window.localStorage.getItem('calendarDefault');if(force){this.noticePromiseMap[projectID]=null;}
var noticePromise=this.noticePromiseMap[projectID];if(!noticePromise){noticePromise=$.getJSON('/diagnosis/getAll/'+projectID);this.noticePromiseMap[projectID]=noticePromise;}
return noticePromise.done(function(data){var faults=data.faults,equipments=data.equipments,equipmentsMap={},zones=data.zones,zonesMap={},notices=data.notices,noticeItem;_this.noticeList=[];if(!notices||!notices.length){return _this.noticeList=[];}
for(var i=0;i<equipments.length;i++){equipmentsMap[String(equipments[i].id)]=equipments[i];}
for(var j=0;j<zones.length;j++){zonesMap[String(zones[j].id)]=zones[j];}
for(var m=0;m<notices.length;m++){noticeItem=notices[m];for(var n=0;n<faults.length;n++){var fault=faults[n];if(noticeItem.faultId===fault.id){var equipment=equipmentsMap[String(fault.equipmentId)];$.extend(equipment,{zone:zonesMap[String(equipment.zoneId)]});var faultItem=$.extend(true,{},fault,{equipment:equipment});var notice=$.extend(true,{},noticeItem,{fault:faultItem});_this.noticeList.push(notice);faults.splice(n,1);break;}}}})},renderNoticeList:function(){$('.event-container:first').empty();var i=0,notice,$events=$('<div id="itemContent"></div>'),$eventItems,eventColor,_this=this;for(i;i<this.noticeList.length;i++){notice=this.noticeList[i];$eventItems=$('<div class="fc-event ui-draggable ui-draggable-handle ellipsis">'+'<span class="zoneInfo">'+'<em class="mr20">'+notice.fault.equipment.name+'</em>'+'</span>'+'<span class="itemPoolTitle">'+notice.fault.name+'</span>'+'<span class="itemTime">'+notice.time+'</span>'+'</div>');var dateNow=new Date();var date=new Date(notice.time);if(date.getDate()==dateNow.getDate()){$eventItems.attr('data-today','true');}
if(date.getDate()==(dateNow.getDate()-1)){$eventItems.attr('data-yesterday','true');}
if(this.getThisWeek().some(function(item){return(item==date.getDate())})){$eventItems.attr('data-week','true')}
if(getQuarterSeason(dateNow.getMonth()+1).filter(function(element){return element==(date.getMonth()+1)}).length!==0){$eventItems.attr('data-season','true')}
function getQuarterSeason(month){if(month<3){return[1,2,3]}else if(month<=4&&month<=6){return[4,5,6]}else if(month>=7&&month<=9){return[7,8,9]}else if(month>=10&&month<=12){return[10,11,12]}}
switch(Math.abs((date.getMonth()+1)-(dateNow.getMonth()+1))){case 1:$eventItems.attr('data-one-month','true');break;case 2:$eventItems.attr('data-two-month','true');break;case 3:$eventItems.attr('data-three-month','true');break;case 6:$eventItems.attr('data-half-year','true');break;}
if(date.getMonth()==dateNow.getMonth()){$eventItems.attr('data-month','true')}
if(date.getFullYear()==dateNow.getFullYear()){$eventItems.attr('data-year','true')}
$eventItems.attr('data-dates',notice.time);$eventItems.attr('userFaultGrade',this.noticeList[i].fault.userFaultGrade);switch($eventItems.attr('userFaultGrade')){case'0':eventColor='#3a87ad';$eventItems.addClass('FaultGrade0');break;case'1':eventColor='#fdbb4a';$eventItems.addClass('FaultGrade1');break;case'2':eventColor='#ed7a3a';$eventItems.addClass('FaultGrade2');break;default:$eventItems.addClass('FaultGradeUndifined');}
$eventItems.draggable({zIndex:999,opacity:1,revert:true,revertDuration:0,distance:5,appendTo:'body',containment:'window',scroll:false,helper:'clone'});$eventItems.data('event',{id:this.noticeList[i].id,title:notice.fault.name,startTime:notice.time,description:notice.fault.description,allDay:true,userFaultGrade:notice.fault.userFaultGrade,content:notice,taskType:this.eventType.notice,editable:true,stick:true,color:eventColor}).on('click',function(){_this.currentEvent=$(this).data('event');_this.showWorkInfoDefault(_this,$(this).data('event'))});if(this.addedNoticedMap[notice.id]){this.displayAddScheduler($eventItems);}
$events.append($eventItems);}
$events.append('<div id="taskPoolInfoTxt" class="dn tc" i18n="workflow.calendar.NO_TASK"></div>');$('.event-container').append($events);this.checkEmptyTasks();I18n.fillArea($("#wrap"));},showWorkInfoDefault:function(_this,event){var $workflowInfo=$('#workflowInfo'),$wfContent=$('#wf-outline');_this.setWinData(event);$workflowInfo.attr('data-from','events');$workflowInfo.find('#itemDel,#itemEdit,.calendarInfoColor').hide();_this.itemContenteditable(false);$workflowInfo.css({'left':$wfContent.outerWidth()/2-$workflowInfo.width()/2+'px','top':$wfContent.outerHeight()/2-$workflowInfo.height()/2+'px'}).show();_this.getEcharts.call(_this,event,$workflowInfo.find('.taskPoolInfoEcharts').get(0));},displayAddScheduler:function(item){var $item=$(item);if($item.find('.label-success').length===0){$item.append('<div class="label label-success added-calendar" i18n="workflow.calendar.ADD_SCHEDULER"></div>');}},getThisWeek:function(){var dateNow=new Date(),dayNow=dateNow.getDate(),daysTotalMonth=new Date(dateNow.getFullYear(),dateNow.getMonth(),0).getDate(),result=[],i;if(daysTotalMonth-dayNow>=7){for(i=0;i<=7;i++){result.push(dayNow++);}}else{var length=daysTotalMonth-dayNow;for(i=0;i<=length;i++){result.push(dayNow++);}
for(i=1;i<=7-length;i++){result.push(i);}}
return result;},showUserCalendar:function(userId){var _this=this;var eventSource={url:'/workflow/plan/listTasks',type:'POST',data:{userId:userId},error:function(){Alert.danger(ElScreenContainer,'there was an error while fetching events!').showAtTop(2000);},success:function(result){_this.fetchNoticesData().done(function(data){Spinner.stop();result.map(function(item){_this.addedNoticedMap[item.noticeId]=item;});if(_this.firstRender){_this.renderNoticeList();_this.firstRender=false;}})},textColor:'white',backgroundColor:'#5484ed'};this.$calendar.fullCalendar('removeEventSource','/workflow/plan/listTasks');this.$calendar.fullCalendar('addEventSource',eventSource);},showGroupCalendar:function(groupId){var _this=this;var eventSource={url:'/workflow/plan/listTasks',type:'POST',data:{groupId:groupId},error:function(){Alert.danger(ElScreenContainer,'there was an error while fetching events!').showAtTop(2000);},success:function(result){_this.fetchNoticesData().done(function(data){Spinner.stop();result.map(function(item){_this.addedNoticedMap[item.noticeId]=item;});if(_this.firstRender){_this.renderNoticeList();_this.firstRender=false;}})},textColor:'white',backgroundColor:'#5484ed'};this.$calendar.fullCalendar('removeEventSource','/workflow/plan/listTasks');this.$calendar.fullCalendar('addEventSource',eventSource);},attachEvent:function(){var _this=this;$.spEvent.subEvent($('#wf-content'),'wf-task-list-calendar',function(event,type,id){if(type==='group'){_this.showGroupCalendar(id);}else if(type==='user'){if(!id){id=AppConfig.userId;}
_this.showUserCalendar(id);}});this.$dateTimePicker.datetimepicker({inline:true,sideBySide:true,minView:2,format:"yyyy-mm-dd ",todayHighlight:true}).datetimepicker('update',moment(new Date()).format('YYYY-MM-DD 00:00')).on('changeDate',function(date){var dateChangeNow=moment(date.date).format('YYYY-MM-DD');switch(_this.$calendar.fullCalendar('getView').type){case'month':_this.$calendar.fullCalendar('changeView','month');break;case'basicWeek':_this.$calendar.fullCalendar('changeView','basicWeek');break;case'basicDay':_this.$calendar.fullCalendar('changeView','basicDay');break;default:break;}
_this.$calendar.fullCalendar('gotoDate',dateChangeNow);_this.$dateTimePicker.datetimepicker('update',moment(date.date).format('YYYY-MM-DD 00:00'));$('.fc-bg').find('td').each(function(){$(this).css('backgroundColor','transparent');if($(this).attr('data-date')==dateChangeNow){$(this).css('backgroundColor','#ccc');}})});this.$calendar.fullCalendar({eventSources:[],events:[],eventLimit:true,firstDay:0,lang:localStorage.getItem('language')==='zh'?"zh-cn":localStorage.getItem('language'),defaultView:"month",header:{left:'prev,next today',center:'title',right:'month,basicWeek,basicDay'},lazyFetching:true,allDayDefault:true,editable:true,droppable:true,drop:function(date,jsEvent,ui){var $this=$(this);WebAPI.post('/workflow/plan/addNoticeToScheduler',{userId:AppConfig.userId,notice:$this.data('event').content,color:$this.data('event').color,startTime:date.format('YYYY-MM-DD HH:mm:ss')}).done(function(result){if(result.success){if($this.data('event')&&$this.data('event').id&&result.data.id){var event=_this.$calendar.fullCalendar('clientEvents',$this.data('event').id)[0];event.id=result.data.id;$('#calendar').fullCalendar('updateEvent',event);}
_this.noticeList.forEach(function(item,index,array){if(array[index].id==$this.data('event').id){array.splice(index,1)}});BackgroundWorkers.schedulerReporter?BackgroundWorkers.schedulerReporter.postMessage({type:'fetchWorkflowData',userId:AppConfig.userId}):$.noop();_this.displayAddScheduler($this);I18n.fillArea($("#wrap"));}else{Alert.danger(ElScreenContainer,'添加日程失败').showAtTop(2000)}})},eventDrop:function(event){var eventItem={startTime:event.start.format('YYYY-MM-DD HH:mm:ss')};if(event.end){eventItem['endTime']=event.end.format('YYYY-MM-DD HH:mm:ss');}else{if(event.allDay){eventItem['endTime']=event.start.format('YYYY-MM-DD')+' 23:59:59';}else{eventItem['endTime']=moment(event.start).add(2,'h').format('YYYY-MM-DD HH:mm:ss');}}
WebAPI.post('/workflow/plan/updateScheduledTask',{scheduleId:event.id,event:eventItem}).done(function(result){return result.success;});},eventResize:function(event){WebAPI.post('/workflow/plan/updateScheduledTask',{scheduleId:event.id,event:{startTime:event.start.format('YYYY-MM-DD HH:mm:ss'),endTime:event.end.format('YYYY-MM-DD HH:mm:ss')}}).done(function(result){return result.success;});},eventClick:function(event,jsEvent){_this.oldColor=event.color;_this.itemContenteditable(false);_this.setWinData(event);var $workflowInfo=$("#workflowInfo");if(!event.editable){$workflowInfo.find('#itemDel,#itemEdit').hide();}else{$workflowInfo.find('#itemDel,#itemEdit').show();}
$workflowInfo.find('.calendarInfoColor').show();$workflowInfo.data("event",event);var wh=$(window).height();var ww=$(window).width();var oh=$workflowInfo.height();var x=jsEvent.clientX-$workflowInfo.width()/2;var y=jsEvent.clientY-43;if((wh-y)<(oh+40)){y=y-oh+30;if(y<50){y=60;}}
if(_this.isManager){if(jsEvent.clientX<ww/2){x=x-80;}else{x=x-240;}}
_this.getEcharts.call(_this,event,$workflowInfo.find('.taskPoolInfoEcharts').get(0));$workflowInfo.css({"left":x,"top":y}).show();jsEvent.stopPropagation();return false;},viewRender:function(view){$('.fc-today-button').one('click',function(){_this.$dateTimePicker.datetimepicker('update',moment(new Date()).format('YYYY-MM-DD'));$('.fc-bg').find('td').each(function(){$(this).css('backgroundColor','transparent');if($(this).attr('data-date')==moment(new Date()).format('YYYY-MM-DD')){$(this).css('backgroundColor','#eee')}});});if(view.type=="basicWeek"){$('.fc-bg').find('td').each(function(){$(this).css('backgroundColor','transparent');if($(this).attr('data-date')==view.start.format()){$(this).css('backgroundColor','#ccc')}else if($(this).attr('data-date')==moment(new Date()).format('YYYY-MM-DD')){$(this).css('backgroundColor','#eee')}});}},eventRender:function(event,element){element.on('click',function(){_this.currentEvent=event;_this.currentElement=element;});},eventAfterAllRender:function(){var date=_this.$calendar.fullCalendar('getDate');_this.$dateTimePicker.datetimepicker('update',moment(date).format('YYYY-MM-DD 00:00'));}});this.showUserCalendar(AppConfig.userId);$("#calendarDateStart").datetimepicker({format:"yyyy-mm-dd",autoclose:true,miniView:1,endDate:new Date()});$("#calendarDateEnd").datetimepicker({format:"yyyy-mm-dd",miniView:1,autoclose:true});$('#calendar').on("click.winEdit",function(e){var $workflowInfo=$("#workflowInfo"),isFormEvents=$workflowInfo.attr('data-from');if(isFormEvents){isFormEvents=true;$workflowInfo.attr('data-from','')}else{isFormEvents=false;}
if(!$(e.target).closest("#workflowInfo").length&&$workflowInfo.is(':visible')){$workflowInfo.hide();if(!isChangeColor&&!isFormEvents){_this.currentEvent.color=_this.oldColor;_this.$calendar.fullCalendar('updateEvent',_this.currentEvent)}}});_this.setCalendarHeight();$(window).on("resize.calendarHeight",function(){_this.setCalendarHeight();});var timer=null;var $taskPoolInfoEcharts=$('#taskPoolInfo').find('.taskPoolInfoEcharts');$("#events").on("mouseover",'.fc-event',function(){var $this=$(this);var item=$(this).data("event");var $taskPoolInfo=$("#taskPoolInfo");$("#taskPoolTitle").text(item.title);$("#taskPoolDetail").text(item.description);$("#taskPoolTime").text(item.startTime);$("#equipmentName").text(item.content.fault.equipment.points);var wh=$(window).height();var x=$this.offset().left-(_this.isManager?590:215);var y=$this.offset().top+$taskPoolInfo.height();if(y>wh){y=$this.offset().top-$taskPoolInfo.height();$taskPoolInfo.find('.tooltip-arrow').css('top','55px');}else{y=$this.offset().top-$this.height()*2;$taskPoolInfo.find('.tooltip-arrow').css('top','65px');}
var echartsHeight=200;$taskPoolInfo.css({"left":x-200,"top":y}).toggleClass('wf-bounceleft').show();clearTimeout(timer);timer=setTimeout(function(){if(y>360){$taskPoolInfo.animate({top:y-echartsHeight+'px'},'fast');$taskPoolInfo.find('.tooltip-arrow').css('top',65+echartsHeight+'px');}
_this.getEcharts.call(_this,item,$taskPoolInfoEcharts.get(0));$taskPoolInfoEcharts.slideDown();},2000);}).on("mouseout",'.fc-event',function(e){$("#taskPoolTitle").text('');$("#taskPoolDetail").text('');$("#taskPoolTime").text('');$("#taskPoolPoints").text('');$("#equipmentName").text('');$("#taskPoolInfo").toggleClass('wf-bounceleft').hide().find('.taskPoolInfoEcharts').empty();clearTimeout(timer);$taskPoolInfoEcharts.hide();timer=null;});var oldColor,isChangeColor=false;$("#workflowInfo .itemColor").click(function(){$("#workflowInfo .itemColor").each(function(){$(this).removeClass('active');});$(this).addClass('active');isChangeColor=false;var color=$(this).attr("data-color");$("#workflowInfo").data("color",color);if($("#workflowInfo").data("color")){_this.currentEvent.color=$("#workflowInfo").data("color");_this.$calendar.fullCalendar('updateEvent',_this.currentEvent)}});$("#itemDel").click(function(){WebAPI.post('/workflow/plan/delScheduledTask',{scheduleId:_this.currentEvent.id}).done(function(result){if(result.success){_this.$calendar.fullCalendar("removeEvents",_this.currentEvent._id);if(_this.projectId==_this.currentEvent.content.project){_this.noticeList.push(_this.currentEvent.content);delete _this.addedNoticedMap[_this.currentEvent.noticeId];_this.renderNoticeList();}
$("#workflowInfo").hide();try{if(_this.currentEvent.start.format('YYYY-MM-DD')==new Date().format('yyyy-MM-dd')&&_this.currentEvent.start-new Date()<=0&&(_this.currentEvent.allDay||_this.currentEvent.end-new Date()>=0)){var $workflowMenuButtonBadge=$('#paneWorkflow').find('.workflow-menu-button .badge');$workflowMenuButtonBadge.text(parseInt($workflowMenuButtonBadge.text())-1);var $menuItemCalendarBadge=$('#paneWorkflow').find('.menuItemCalendar .badge');$menuItemCalendarBadge.text(parseInt($menuItemCalendarBadge.text())-1);}}catch(e){}}else{Alert.danger(ElScreenContainer,'delete event failed!');}});});function changeSelectorInfo(index,which){var $calenderSelectorInfo=$('#wf-calender-selectorInfo');$calenderSelectorInfo.show();$calenderSelectorInfo.find('section').removeClass('label label-primary');$('#events .event-selector').find('.dropdown').removeClass('active').eq(index).addClass('active');if(index==1){var value=$(which).text();var i18=I18n.resource.workflow.calendar;switch(value){case i18.SERIOUS:$calenderSelectorInfo.find('span').attr('i18n','').text('').eq(index).attr('i18n',$(which).attr('i18n')).parent().css('backgroundColor','#ed7a3a').addClass('label label-primary');break;case i18.EMERGENCY:$calenderSelectorInfo.find('span').attr('i18n','').text('').eq(index).attr('i18n',$(which).attr('i18n')).parent().css('backgroundColor','#fdbb4a').addClass('label label-primary');break;case i18.GENERAL:$calenderSelectorInfo.find('span').attr('i18n','').text('').eq(index).attr('i18n',$(which).attr('i18n')).parent().css('backgroundColor','#3a87ad').addClass('label label-primary');break;case i18.All:$calenderSelectorInfo.find('span').attr('i18n','').text('').eq(index).attr('i18n',$(which).attr('i18n')).parent().css('backgroundColor','#428bca').addClass('label label-primary');break;}}else{$calenderSelectorInfo.find('section').eq(1).css('backgroundColor','transparent');$calenderSelectorInfo.find('span').attr('i18n','').text('').eq(index).attr('i18n',$(which).attr('i18n')).parent().addClass('label label-primary');}
I18n.fillArea($calenderSelectorInfo);}
$('#wf-Emergency-degree').find('a').click(function(){var value=$(this).text();var i18=I18n.resource.workflow.calendar;$('#events .dropdown-menu li').removeClass('active');changeSelectorInfo(1,this);$(this).parent().addClass('active');switch(value){case i18.SERIOUS:changeEventContainer(2,2);break;case i18.EMERGENCY:changeEventContainer(2,1);break;case i18.GENERAL:changeEventContainer(2,0);break;case i18.All:changeEventContainer(1,'all');break;}});$('#wf-fault-time').find('a').click(function(){var value=$(this).text();var i18=I18n.resource.workflow.calendar;$('#events .dropdown-menu li').removeClass('active');changeSelectorInfo(2,this);$(this).parent().addClass('active');switch(value){case i18.TODAY:changeEventContainer(1,'data-today');break;case i18.THIS_WEEK:changeEventContainer(1,'data-week');break;case i18.THIS_MONTH:changeEventContainer(1,'data-month');break;case i18.THIS_YEAR:changeEventContainer(1,'data-year');break;case i18.THIS_SEASON:changeEventContainer(1,'data-season');break;case i18.YESTERDAY:changeEventContainer(1,'data-yesterday');break;case i18.All:changeEventContainer(1,'all');break;default:return false;}});$('#wf-Time-overdue').find('a').click(function(){var value=$(this).text();var i18=I18n.resource.workflow.calendar;$('#events .dropdown-menu li').removeClass('active');changeSelectorInfo(0,this);$(this).parent().addClass('active');switch(value){case i18.ONE_MONTH:changeEventContainer(1,'data-one-month');break;case i18.TWO_MONTH:changeEventContainer(1,'data-two-month');break;case i18.THREE_MONTH:changeEventContainer(1,'data-three-month');break;case i18.HALF_YEAR:changeEventContainer(1,'data-half-year');break;case i18.All:changeEventContainer(1,'all');break;default:return false;}});$('#createWF').click(function(){var $calendarSavedHtml=$('#indexMain').children().detach();function insertCallback(makesureSuccess,insertSuccess){$('#indexMain').empty().append($calendarSavedHtml);if(insertSuccess){BackgroundWorkers.schedulerReporter?BackgroundWorkers.schedulerReporter.postMessage({type:'fetchWorkflowData',userId:AppConfig.userId}):$.noop();Alert.success(ElScreenContainer,I18n.resource.workflow.calendar.ORDER_CREATION_SUCCESS).showAtTop(2000);}}
var momentTime=_this.currentEvent.content.time.toDate();var faultGrade=0;if(_this.currentEvent.content.fault.isUserDefined){faultGrade=_this.currentEvent.content.fault.userFaultGrade;}
else{faultGrade=_this.currentEvent.content.fault.defaultGrade;}
ScreenManager.show(WorkflowInsert,{noticeId:_this.currentEvent.content.id,title:_this.currentEvent.content.fault.name,detail:_this.currentEvent.content.fault.description,dueDate:new Date(+new Date()+172800000).format('yyyy-MM-dd'),critical:faultGrade,projectId:_this.currentEvent.content.project,chartPointList:_this.currentEvent.content.fault.points,chartQueryCircle:'m5',chartStartTime:new Date(momentTime-43200000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(momentTime+43200000).format('yyyy-MM-dd HH:mm:ss'),userId:AppConfig.userId},insertCallback,insertCallback,insertCallback);});$("#itemClose").click(function(){var $workflowInfo=$("#workflowInfo"),isFormEvents=$workflowInfo.attr('data-from');if(isFormEvents){isFormEvents=true;$workflowInfo.attr('data-from','')}else{isFormEvents=false;}
if(!isChangeColor&&_this.currentEvent&&!isFormEvents){_this.currentEvent.color=_this.oldColor;_this.$calendar.fullCalendar('updateEvent',_this.currentEvent)}
$workflowInfo.hide();});$("#itemEdit").click(function(){_this.itemContenteditable(true);$(this).hide();$("#itemSave").show();$('#wf-name').removeClass('ellipsis');});$("#itemSave").click(function(){var date_start=$("#calendarDateStart").val();var date_end=$("#calendarDateEnd").val();if(date_start>date_end){$("#errorInfo").text(I18n.resource.workflow.calendar.DATE_ERROR_INFO).show();return false;}else{$("#errorInfo").hide();}
WebAPI.post('/workflow/plan/updateScheduledTask',{scheduleId:_this.currentEvent.id,event:{startTime:new Date($(".calendarDateStart").val()).format('yyyy-MM-dd HH:mm:00'),endTime:new Date($(".calendarDateEnd").val()).format('yyyy-MM-dd HH:mm:00'),title:$("#wf-name").text(),color:$("#workflowInfo").data("color")}}).done(function(result){if(result.success){_this.currentEvent.title=$('#wf-name').text();_this.currentEvent.start=$(".calendarDateStart").val();_this.currentEvent.end=moment($(".calendarDateEnd").val()).add(1,'days').format('YYYY-MM-DD HH:MM 00');if($("#workflowInfo").data("color")){_this.currentEvent.color=$("#workflowInfo").data("color");}
_this.$calendar.fullCalendar('updateEvent',_this.currentEvent);isChangeColor=true;$("#workflowInfo").hide();}else{Alert.danger(ElScreenContainer,I18n.resource.workflow.calendar.SAVE_FAILED);}});});$('#events select.task-filter').each(function(){$(this).change(function(){var value=$(this).val();var i18=I18n.resource.workflow.calendar;switch(value){case i18.TODAY:changeEventContainer(1,'data-today');break;case i18.THIS_WEEK:changeEventContainer(1,'data-week');break;case i18.THIS_MONTH:changeEventContainer(1,'data-month');break;case i18.THIS_YEAR:changeEventContainer(1,'data-year');break;case i18.All:changeEventContainer(1,'all');break;default:return false;}})});function changeEventContainer(type,changeType){if(arguments.length==2){if(type==1){$('.event-container').find('.fc-event').each(function(){$(this).hide();changeType=='all'?$(this).show():$(this).attr(changeType)=='true'?$(this).show():$(this).hide();});}else if(type==2){$('.event-container').find('.fc-event').each(function(){$(this).hide();$(this).attr('userFaultGrade')==changeType?$(this).show():$(this).hide();});}else return false;}
_this.checkEmptyTasks();$("#taskPoolInfo").hide();}
$('#events select.project-selector').change(function(){_this.checkEmptyTasks();_this.projectId=$(this).val();window.localStorage.calendarDefault=$(this).val();Spinner.spin($('#events')[0]);_this.fetchNoticesData(true).done(function(result){Spinner.stop();_this.renderNoticeList();});});},checkEmptyTasks:function(){var $taskPoolInfoTxt=$("#taskPoolInfoTxt");if(!($("#itemContent>.fc-event:visible").length)){$taskPoolInfoTxt.show();}else{$taskPoolInfoTxt.hide();}},setEventsTotalTips:function(_year,_month){var _this=this,i;var result=[],_Arr_prevMonth=[],_Arr_nextMonth=[],lastDay;var prevDay=new Date(_year,_month-1,0).getDate();var firstDay=new Date(_year,_month-1,1).getDay();var dayTotal=new Date(_year,_month,0).getDate();for(i=0;i<firstDay;i++){_Arr_prevMonth.push(prevDay--);}
_Arr_prevMonth.sort().forEach(function(item,index,array){result.push(_this.$calendar.fullCalendar('clientEvents',function(event){return event.start.format('YYYY-MM-DD')==moment(new Date(_year+'-'+(_month-1)+'-'+item)).format('YYYY-MM-DD')}).length);});for(i=1;i<=dayTotal;i++){result.push(_this.$calendar.fullCalendar('clientEvents',function(event){return event.start.format('YYYY-MM-DD')==moment(new Date(_year+'-'+_month+'-'+i)).format('YYYY-MM-DD')}).length);}
for(i=0,lastDay=42-result.length;i<lastDay;i++){_Arr_nextMonth.push(i+1);}
_Arr_nextMonth.forEach(function(item,index,array){result.push(_this.$calendar.fullCalendar('clientEvents',function(event){return event.start.format('YYYY-MM-DD')==moment(new Date(_year+'-'+(_month+1)+'-'+array[index])).format('YYYY-MM-DD')}).length);});_this.$dateTimePicker.find('.datetimepicker-days tbody td').each(function(i,item){if(result[i]!==0){$(item).attr('data-eventstotal',result[i])}});},getEcharts:function(event,echartContainer){$(echartContainer).empty();var $taskPoolContainer=$('#taskPoolInfoEcharts');var faultGrade=0;var _this=this;var momentTime=event.content.time.toDate();var Spinner=new LoadingSpinner({color:'#00FFFF'});Spinner.spin(echartContainer);WebAPI.post('workflow/transaction/fault_curve_data/',{projectId:event.content.project,chartPointList:event.content.fault.points,chartQueryCircle:'m5',chartStartTime:new Date(momentTime-3600000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(momentTime+3600000).format('yyyy-MM-dd HH:mm:ss')}).done(function(result){if(result.success){_this.renderChart(result.data,echartContainer);}}).always(function(){Spinner.stop();Spinner=null;})},renderChart:function(record,echartContainer){var list_description=record.description,list_value=record.value,arrXAxis;if(record.time.length>0)
arrXAxis=record.time[0].split(',');var arrSeriesTemp=[];for(var i=0;i<list_value.length;i++){var arrDatas=[];if(i<8){var item=list_value[i];if(item){var strDatas=item.split(",");for(var j=0;j<strDatas.length;++j){arrDatas.push(parseFloat(strDatas[j]).toFixed(1));}}
arrSeriesTemp.push({name:list_description[i],type:'line',itemStyle:{normal:{lineStyle:{type:'solid'}}},data:arrDatas});}}
var option={tooltip:{trigger:'axis'},legend:{data:list_description,x:'center'},toolbox:{show:true},xAxis:[{type:'category',boundaryGap:false,axisLine:{onZero:false},data:arrXAxis}],yAxis:[{type:'value',scale:true}],series:arrSeriesTemp};var myChart=echarts.init(echartContainer);myChart.setOption(option);window.onresize=myChart.resize;},detachEvents:function(){$(window).off("resize.calendarHeight");},setFloatingWin:function($win,h){var wh=$(window).height();var top=(wh-h)/2;$win.find(".modal-dialog").css({'top':top});$win.modal();},setCalendarHeight:function(){var wh=$(window).height(),$wrap=$("#wrap"),$navHeader=$("#navHeader");this.isManager?$wrap.css("height",wh-$navHeader.height()-12):$wrap.css("height",wh-$navHeader.height());$("#taskPoolContent").css("height",wh-267);this.$calendar.fullCalendar('option','height',wh-100);},setWinData:function(event){var _this=this,$this=$(this);var $calendarDateStart=$(".calendarDateStart");var $calendarDateEnd=$(".calendarDateEnd");$('#wf-name').addClass('ellipsis');$("#errorInfo").hide();$("#itemSave").hide();$("#itemEdit").show();var dateStart=moment(event.start).format('YYYY-MM-DD');var dateEnd=event.end?moment(event.end).subtract('days',1).format('YYYY-MM-DD'):moment(event.start).format('YYYY-MM-DD');var title=I18n.resource.workflow.calendar.NO_TITLE;if(event.title&&event.title.split(': ').length===2){title=event.title.split(': ')[1];}else{title=event.title?event.title:title;}
$("#owner").text(event.username?event.username:AppConfig.userProfile.fullname);$('#wf-name').text(title);$("#wf-detail").text(event.content.fault.description);$("#wf-critical").text(event.content.fault.userFaultGrade==2?I18n.resource.workflow.calendar.EMERGENCY:I18n.resource.workflow.calendar.NOT_URGENT);$("#wf-equipmentName").text(event.content.fault.equipment.name);$("#wf-zones").text(event.content.fault.equipment.zone?event.content.fault.equipment.zone.subBuildingName:'');$calendarDateStart.val(dateStart);$calendarDateEnd.val(dateEnd);$('.colorWrapper .itemColor').each(function(){if($(this).attr('data-color')==_this.oldColor){$(this).show();}});var projectName='';for(var i=0;i<AppConfig.projectList.length;i++){if(event.content.project==AppConfig.projectList[i].id){projectName=StringUtil.getI18nProjectName(AppConfig.projectList[i]);break;}}
$("#wf-projectName").text(projectName);I18n.fillArea($(ElScreenContainer));},itemContenteditable:function(flag){var $itemColor=$("#workflowInfo .itemColor");$("#wf-name").attr("contenteditable",flag);if(flag===true){$itemColor.show();}else{$itemColor.hide();}
$(".calendarDateStart").attr({"contenteditable":flag,"disabled":!flag});$(".calendarDateEnd").attr({"contenteditable":flag,"disabled":!flag});}};return WorkflowCalendar;})();(function(){var
configMap={htmlURL:''},stateMap={},jqueryMap={},setJqueryMap,init,show,close;setJqueryMap=function(){var $container=stateMap.$container,$content=$container.find('#wf-content');jqueryMap={$container:$container,$main_menu:$container.find('#wf-main-menu'),$level_menu:$container.find('#wf-level-menu'),$content:$content,$content_wrapper:$content.find('#wf-content-wrapper'),$content_box:$content.find('#wf-content-box')};};show=function(){beop.main.prototype.init($(ElScreenContainer));};close=function(){};init=function($container){stateMap.$container=$container;Spinner.spin($container.get(0));WebAPI.get("/static/views/workflow/outline.html").done(function(resultHtml){var $ElScreenContainer=$(ElScreenContainer);$ElScreenContainer.html(resultHtml);setJqueryMap();I18n.fillArea($container);var language=localStorage.getItem('language');if(language==='zh'){moment.locale('zh-cn');}else{moment.locale('en');}
beop.model.init();beop.view.activities.configModel({activities_model:beop.model.activitiesModel,transactions_model:beop.model.transactionsModel,reply_mode:beop.model.replyModel});beop.view.taskList.configModel({transactions_model:beop.model.transactionsModel,tags_model:beop.model.tagsModel});beop.view.faultCurve.configModel({transactions_model:beop.model.transactionsModel});beop.view.replyList.configModel({transactions_model:beop.model.transactionsModel,reply_mode:beop.model.replyModel});beop.view.progress.configModel({transactions_model:beop.model.transactionsModel});beop.view.groupAdd.configModel({group_model:beop.model.groupModel});beop.view.groupDelete.configModel({group_model:beop.model.groupModel});beop.view.memberSelected.configModel({group_model:beop.model.groupModel});beop.view.taskDetail.configModel({transactions_model:beop.model.transactionsModel,tags_model:beop.model.tagsModel});beop.view.menu_group_list.configModel({group_model:beop.model.groupModel});beop.view.menu_tag_list.configModel({tags_model:beop.model.tagsModel});beop.view.groupEdit.configModel({group_model:beop.model.groupModel});beop.view.menu.init(stateMap.$container);jqueryMap.$main_menu.find('#wf-main-task').trigger('click');}).always(function(){Spinner.stop();});};var _main=function(){};_main.prototype={init:init,show:show,close:close};beop.main=_main;}(beop||(beop={})));var TaskPool=(function(){function TaskPool(){this.urlMap={htmlTemplateURL:'static/views/workflow/taskPoolTemplate.html'};this.apiMap={getHtmlTemplate:'',testJSON:'static/notices.json',getDiagnosisAll:'diagnosis/getAll/'};this.configMap={faultsHtmlTemplateId:'task_pool_faults_list'};this.jqueryMap={};this.noticeList=[];this.query={overDueTime:['oneMonth','twoMonth','threeMonth','halfYear'],emergencyLevel:['general','emergency','serious'],faultsTime:['today','yesterday','thisYear','thisWeek','thisMonth','thisSeason']};this.timer=null;this.echarts=null;}
TaskPool.prototype={show:function($container,projectID){var _this=this;var $currentContainer=$container?$container:$(ElScreenContainer);var Spinner=new LoadingSpinner({color:'#00FFFF'});Spinner.spin($currentContainer.get(0));this.init($currentContainer).done(function(){Spinner.spin(_this.jqueryMap.taskPool.get(0));$.getJSON(_this.apiMap.getDiagnosisAll+projectID).done(function(getDiagnosisAllData){if(getDiagnosisAllData.notices!==undefined&&getDiagnosisAllData.notices.length!==0){_this.renderFaultsList(getDiagnosisAllData).done(function(){Spinner.stop();});}else{$('.taskPoolInfoTxt').show();Spinner.stop();}}).fail(function(){alert('读取数据失败');})}).always(function(){I18n.fillArea($currentContainer);}).fail(function(){alert('读取html模板失败');Spinner.stop();})},init:function($container){var _this=this;return WebAPI.get(this.urlMap.htmlTemplateURL+'?='+new Date().getTime()).done(function(html){$container.html(html);_this.setJqueryMap();})},setJqueryMap:function(){this.jqueryMap={faultsContainer:'.task_pool_container',faultsContent:'<div id="task_pool_content"></div>',taskPool:$('#task_pool'),taskPoolTips:$('#taskPool_toolTip'),toolTipsFaultsTime:$('#taskPool_faults_Time'),toolTipsFaultsDetail:$('#taskPool_faults_Detail'),toolTipsFaultsTitle:$('#taskPool_faults_Title'),taskPoolSelectorInfo:$('.task_pool_selectorInfo')}},attachEvent:function(){var $taskPoolDropDownList=this.jqueryMap.taskPool.find('.dropdown li'),_this=this;$taskPoolDropDownList.off().on('click',function(){var $this=$(this),paramType=$this.parent().data('param-type'),param=$this.data('param');if(param==-1){_this.toggleFaultsStatus('all');}else{try{var values=_this.query[paramType][param];if(!!values&&values!==null&&values!=='undefined'){_this.toggleFaultsStatus(paramType,values);}else{_this.toggleFaultsStatus('all');}}catch(ex){_this.toggleFaultsStatus('all');}}
_this.checkEmptyTasks();$taskPoolDropDownList.removeClass('active');$this.addClass('active');var emergencyLevelColor='',taskPoolSelectorInfo=$this.text();if(paramType=='emergencyLevel'){switch(param){case 0:emergencyLevelColor='#3a87ad';break;case 1:emergencyLevelColor='#ed7a3a';break;case 2:emergencyLevelColor='#fdbb4a';break;}}
_this.jqueryMap.taskPoolSelectorInfo.show().find('section').css('backgroundColor','transparent').each(function(){var $this=$(this);if($this.attr('data-param-type')==paramType){if(!emergencyLevelColor){$this.css('backgroundColor','#428bca').show().find('span').text(taskPoolSelectorInfo);}else{$this.css('backgroundColor',emergencyLevelColor).show().find('span').text(taskPoolSelectorInfo);}}});});this.jqueryMap.taskPool.off().on("mouseover",'.faults',function(){_this.showToolTips($(this));}).on('mouseout','.faults',function(){_this.hideToolTips($(this));})},showToolTips:function($this){var dataEvent=$this.data().event,_this=this;var $taskPoolInfo=$("#taskPool_toolTip");this.jqueryMap.toolTipsFaultsTitle.text(dataEvent.title);this.jqueryMap.toolTipsFaultsDetail.text(dataEvent.description);this.jqueryMap.toolTipsFaultsTime.text(dataEvent.startTime);var wh=$(window).height();var x=this.jqueryMap.taskPoolTips.outerWidth();var y=$this.offset().top+$taskPoolInfo.height();var echartsHeight=200;if(y>wh){y=$this.offset().top-$this.height()*3;$taskPoolInfo.find('.tooltip-arrow').css('top','70%');}else{y=$this.offset().top-$this.height()*2.5;$taskPoolInfo.find('.tooltip-arrow').css('top','45px');}
$taskPoolInfo.css({"left":-x,"top":y}).toggleClass('wf-bounceleft').show();clearTimeout(this.timer);this.timer=setTimeout(function(){if(y>360){$taskPoolInfo.animate({top:y-echartsHeight+'px'},'fast');$taskPoolInfo.find('.tooltip-arrow').css('top',45+echartsHeight+'px');}
_this.jqueryMap.taskPoolTips.find('.taskPoolInfoEcharts').slideDown();_this.getEcharts.call(_this,dataEvent,_this.jqueryMap.taskPool.find('.taskPoolInfoEcharts').get(0));},2000);},hideToolTips:function($this){this.jqueryMap.toolTipsFaultsTitle.text('');this.jqueryMap.toolTipsFaultsDetail.text('');this.jqueryMap.toolTipsFaultsTime.text('');$("#taskPool_toolTip").toggleClass('wf-bounceleft').hide().find('.taskPoolInfoEcharts').empty().hide();clearTimeout(this.timer);this.timer=null;this.echarts=null;},getEcharts:function(event,echartContainer){$(echartContainer).empty();var _this=this;var momentTime=event.content.time.toDate();var Spinner=new LoadingSpinner({color:'#00FFFF'});Spinner.spin(echartContainer);WebAPI.post('workflow/transaction/fault_curve_data/',{projectId:event.content.project,chartPointList:event.content.fault.points,chartQueryCircle:'m5',chartStartTime:new Date(momentTime-3600000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(momentTime+3600000).format('yyyy-MM-dd HH:mm:ss')}).done(function(result){if(result.success){_this.renderChart(result.data,echartContainer);}}).always(function(){Spinner.stop();Spinner=null;})},renderChart:function(record,echartContainer){var list_description=record.description,list_value=record.value,arrXAxis;if(record.time.length>0)
arrXAxis=record.time[0].split(',');var arrSeriesTemp=[];for(var i=0;i<list_value.length;i++){var arrDatas=[];if(i<8){var item=list_value[i];if(item){var strDatas=item.split(",");for(var j=0;j<strDatas.length;++j){arrDatas.push(parseFloat(strDatas[j]).toFixed(1));}}
arrSeriesTemp.push({name:list_description[i],type:'line',itemStyle:{normal:{lineStyle:{type:'solid'}}},data:arrDatas});}}
var option={tooltip:{trigger:'axis'},legend:{data:list_description,x:'center'},toolbox:{show:true},xAxis:[{type:'category',boundaryGap:false,axisLine:{onZero:false},data:arrXAxis}],yAxis:[{type:'value',scale:true}],series:arrSeriesTemp};var myChart=echarts.init(echartContainer);myChart.setOption(option);this.echarts=myChart;},toggleFaultsStatus:function(queryType,values){var $faultsList=$('#task_pool_content').find('.faults');if(arguments.length==2){$faultsList.each(function(){var $this=$(this);$this.hide();try{if($this.data().query[queryType][values]){$this.show();}}catch(ex){}})}else{if(arguments.length==1&&arguments[0]=='all'){$faultsList.show();}}},checkEmptyTasks:function(){var $taskPoolInfoTxt=this.jqueryMap.taskPool.find('.taskPoolInfoTxt');if(!(this.jqueryMap.taskPool.find('.faults:visible').length)){$taskPoolInfoTxt.show();}else{$taskPoolInfoTxt.hide();}},detachEvents:function(){},renderFaultsList:function(getDiagnosisAllData){var _this=this,data=getDiagnosisAllData;var faults=data.faults,equipments=data.equipments,equipmentsMap={},zones=data.zones,zonesMap={},notices=data.notices,noticeItem;_this.noticeList=[];if(!notices||!notices.length){return _this.noticeList=[];}
for(var i=0;i<equipments.length;i++){equipmentsMap[String(equipments[i].id)]=equipments[i];}
for(var j=0;j<zones.length;j++){zonesMap[String(zones[j].id)]=zones[j];}
for(var m=0;m<notices.length;m++){noticeItem=notices[m];for(var n=0;n<faults.length;n++){var fault=faults[n];if(noticeItem.faultId===fault.id){var equipment=equipmentsMap[String(fault.equipmentId)];$.extend(equipment,{zone:zonesMap[String(equipment.zoneId)]});var faultItem=$.extend(true,{},fault,{equipment:equipment});var notice=$.extend(true,{},noticeItem,{fault:faultItem});_this.noticeList.push(notice);faults.splice(n,1);break;}}}
return this.setDataOnFaults().done(function(){_this.attachEvent();});},setDataOnFaults:function(){$(this.jqueryMap.faultsContainer).empty();var i=0,notice,$faultsItem,_this=this,$events=$(this.jqueryMap.faultsContent),data=this.noticeList;for(i;i<data.length;i++){notice=data[i];$faultsItem=$('<div class="ellipsis faults">'+'<span class="zoneInfo">'+'<em class="mr20">'+notice.fault.equipment.name+'</em>'+'</span>'+'<span class="itemPoolTitle">'+notice.fault.name+'</span>'+'<span class="itemTime">'+notice.time+'</span>'+'</div>');var dateNow=new Date(),date=new Date(notice.time);var queryObject={userFaultGrade:_this.noticeList[i].fault.userFaultGrade,overDueTime:{oneMonth:false,twoMonth:false,threeMonth:false,halfYear:false},emergencyLevel:{general:false,emergency:false,serious:false},faultsTime:{today:false,yesterday:false,thisYear:false,thisWeek:false,thisMonth:false,thisSeason:false}};if(date.getDate()==dateNow.getDate()){queryObject.faultsTime.today=true;}
if(date.getDate()==(dateNow.getDate()-1)){queryObject.faultsTime.yesterday=true;}
if(this.getThisWeek().some(function(item){return(item==date.getDate())})){queryObject.faultsTime.thisWeek=true;}
if(_this.getQuarterSeason(dateNow.getMonth()+1).filter(function(element){return element==(date.getMonth()+1)}).length!==0){queryObject.faultsTime.thisSeason=true;}
if(date.getMonth()==dateNow.getMonth()){queryObject.faultsTime.thisMonth=true;}
if(date.getFullYear()==dateNow.getFullYear()){queryObject.faultsTime.thisYear=true;}
switch(Math.abs((date.getMonth()+1)-(dateNow.getMonth()+1))){case 1:queryObject.overDueTime.oneMonth=true;$faultsItem.attr('data-overDueTime','1');break;case 2:queryObject.overDueTime.threeMonth=true;break;case 3:queryObject.overDueTime.threeMonth=true;break;case 6:queryObject.overDueTime.halfYear=true;break;}
var grade=_this.noticeList[i].fault.userFaultGrade;switch(grade){case 0:queryObject.emergencyLevel.general=true;break;case 1:queryObject.emergencyLevel.emergency=true;break;case 2:queryObject.emergencyLevel.serious=true;break;default:break;}
$faultsItem.addClass('fault_grade_'+grade);var dataObj={query:queryObject,event:{id:this.noticeList[i].id,title:notice.fault.name,startTime:notice.time,description:notice.fault.description,userFaultGrade:notice.fault.userFaultGrade,content:notice}};$faultsItem.data(dataObj);$events.append($faultsItem);}
$(this.jqueryMap.faultsContainer).html($events);return $.Deferred().resolve();},getQuarterSeason:function(month){if(month<3){return[1,2,3]}else if(month<=4&&month<=6){return[4,5,6]}else if(month>=7&&month<=9){return[7,8,9]}else if(month>=10&&month<=12){return[10,11,12]}},getThisWeek:function(){var dateNow=new Date(),dayNow=dateNow.getDate(),daysTotalMonth=new Date(dateNow.getFullYear(),dateNow.getMonth(),0).getDate(),result=[],i;if(daysTotalMonth-dayNow>=7){for(i=0;i<=7;i++){result.push(dayNow++);}}else{var length=daysTotalMonth-dayNow;for(i=0;i<=length;i++){result.push(dayNow++);}
for(i=1;i<=7-length;i++){result.push(i);}}
return result;},close:function(){}};return TaskPool;})
();