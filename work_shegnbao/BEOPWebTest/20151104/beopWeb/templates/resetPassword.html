<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title i18n="admin.resetPassword.RESET_PASSWORD"></title>
    <link href="/static/scripts/lib/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>

    <style type="text/css">

        .alert-section {
            margin-top: 20px;
        }

        body {
            overflow-y: hidden;
            overflow-x: hidden;
            font-family: 微软雅黑;
        }

        #clouds {
            position: absolute;
        }

        #top-msg {
            position: relative;
            color: white;
            padding-top: 10%;
        }

        #register-form {
            margin-top: 5%;
        }

        .register-section h2 {
            border-bottom: 3px solid;
            padding-bottom: 10px;
        }

        .pop-msg {
            position: absolute;
            left: 100%;
            top: 0px;
            padding: 5px;
            color: brown;
            border: 1px solid;
            border-radius: 2px;
            display: none;
            width: 50%;
        }

        #register-form .row {
            position: relative;
        }
    </style>
</head>
<body>
<input type="hidden" value="{{ user.email }}" id="name"/>

<div id="clouds"></div>
<div class="container" id="register">
    <div class="row" id="top-msg">
        <div class="col-sm-offset-3 col-sm-6 col-xs-offset-1 col-xs-10 register-section form-horizontal">
            <h2>Welcome to beop</h2>

            <h3 i18n="admin.resetPassword.RESET_PASSWORD"></h3>
        </div>

    </div>
    <div class="row" id="register-form">
        <div class="col-sm-offset-3 col-sm-6 col-xs-offset-1 col-xs-10 register-section form-horizontal">
            <div class="row">
                <label for="inputEmail" class="control-label col-sm-3" i18n="admin.resetPassword.MAIL"></label>

                <div class="form-group input-group col-sm-9">
                    <span class="input-group-addon"><span class="glyphicon glyphicon-envelope"></span></span>
                    <input type="text" class="form-control" id="inputEmail" placeholder="{{ user.email }}"
                           disabled>
                </div>
            </div>
            <div class="row">
                <label for="inputPassword1" class="control-label col-sm-3" i18n="admin.resetPassword.PASSWORD"></label>

                <div class="form-group input-group col-sm-9">

                    <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                    <input type="password" class="form-control" id="inputPassword1" maxlength="20">
                </div>
                <div class="pop-msg bg-danger"></div>
            </div>
            <div class="row">
                <label for="inputPassword2" class="control-label col-sm-3"
                       i18n="admin.resetPassword.PASSWORD_CONFIRM"></label>

                <div class="form-group input-group col-sm-9">

                    <span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
                    <input type="password" class="form-control" id="inputPassword2" maxlength="20">
                </div>
                <div class="pop-msg bg-danger"></div>
            </div>

            </br>
            <div class="row">
                <button type="button" class="btn btn-success pull-right col-sm-9" data-loading-text="..."
                        data-complete-text=""
                        id="submitBtn"
                        i18n="admin.resetPassword.RESET_PASSWORD;data-complete-text=admin.resetPassword.RESET_PASSWORD_SUCCESSFUL;data-loading-text=admin.resetPassword.PASSWORD_RESETTING">
                </button>
            </div>

            <div class="alert-section">
            </div>
        </div>
    </div>
</div>

<script src="/static/scripts/lib/jquery-1.11.1.min.js"></script>
<script src="/static/scripts/lib/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/scripts/core/common.js"></script>
<script src="/static/scripts/core/webAPI.js"></script>
<script src="/static/scripts/i18n/i18n.js"></script>
<script src="/static/views/js/i18n/zh.js"></script>
<script src="/static/views/js/i18n/en.js"></script>
<script>
    I18n = new Internationalization();
    var addValidStatus, removeValidStatus, isValidPwd, configMap = {
        validStatus: {
            type: {
                success: 'success',
                warning: 'warning',
                error: 'error'
            },
            icon: {
                success: 'glyphicon-ok',
                warning: 'glyphicon-warning-sign',
                error: 'glyphicon-remove'
            },
            class: {
                success: 'has-success',
                warning: 'has-warning',
                error: 'has-error'
            },
            msg: {
                pwdNotMatch: I18n.resource.admin.resetPassword.PASSWORD_DONOT_MATCH,
                invalidPwd: I18n.resource.admin.resetPassword.PASSWORD_INFO,
                resetSuccess: I18n.resource.admin.resetPassword.RESET_SUCCESSFUL_GOTO,
                resetFailed: I18n.resource.admin.resetPassword.PASSWORD_RESET_FAILED
            }
        }
    }, isValid = true;


    addValidStatus = function ($parent, validStatus, alertMsg) {
        if (!$parent) {
            return false;
        }
        removeValidStatus($parent);
        var $feedback = $('<span class="glyphicon form-control-feedback" aria-hidden="true"></span>').addClass(configMap.validStatus.icon[validStatus]);
        $parent.addClass('has-feedback has-validated').addClass(configMap.validStatus.class[validStatus])
                .find('.form-control-feedback').remove().end()
                .append($feedback);
        var $alertMsg = $parent.siblings('.pop-msg');
        if (validStatus === configMap.validStatus.type.success || !alertMsg) {
            $alertMsg.text('').hide();
        } else {
            $alertMsg.text(alertMsg).show();
        }
    };
    removeValidStatus = function ($parent) {
        if (!$parent) {
            return false;
        }
        $parent.removeClass(function (index, css) {
            return (css.match(/(^|\s)has-\S+/g) || []).join(' ');
        }).find('.form-control-feedback').remove();
        $parent.siblings('.pop-msg').text('').hide();

    }, resetControlStatus = function () {
        removeValidStatus($(this).closest('.form-group'));
    }, isValidPwd = function (pwd) {
        return pwd.length > 5 && pwd.length < 16;
    };

    $('#inputPassword1').on('keydown', resetControlStatus).on('blur', function () {
        var $this = $(this), pwd = $this.val(), $formControl = $this.closest('.form-group'), $pwd2 = $('#inputPassword2');
        if (!isValidPwd(pwd)) {
            addValidStatus($formControl, configMap.validStatus.type.error, configMap.validStatus.msg.invalidPwd);
            isValid = false;
            return false;
        } else {
            addValidStatus($formControl, configMap.validStatus.type.success);
            if ($pwd2.val() === pwd) {
                addValidStatus($pwd2.closest('.form-group'), configMap.validStatus.type.success);
            }
            isValid = true;
        }
    });
    $('#inputPassword2').on('keydown', resetControlStatus).on('blur', function () {
        var $this = $(this), pwd = $this.val(), $formControl = $this.closest('.form-group'), pwd2 = $('#inputPassword1').val();
        if (!isValidPwd(pwd)) {
            addValidStatus($formControl, configMap.validStatus.type.error, configMap.validStatus.msg.invalidPwd);
            isValid = false;
            return false;
        } else if (pwd !== pwd2) {
            addValidStatus($formControl, configMap.validStatus.type.error, configMap.validStatus.msg.pwdNotMatch);
            isValid = false;
            return false;
        } else {
            addValidStatus($formControl, configMap.validStatus.type.success);
            isValid = true;
        }
    });

    $('#submitBtn').click(function () {

        if (!isValid) {
            return false;
        }

        var $psw1 = $('#inputPassword1'),
                $this = $(this),
                alert;

        $this.button('loading');

        WebAPI.post("/reset_password", {
            password: $psw1.val(),
            token: "{{ token }}"
        }).done(function (result) {
            if (result === 'success') {
                alert = new Alert('.alert-section', 'success', configMap.validStatus.msg.resetSuccess);
                setTimeout(function () {
                    parent.location.href = "/observer"
                }, 5000)
                $this.remove();
            } else {
                alert = new Alert('.alert-section', 'danger', configMap.validStatus.msg.resetFailed + '  ' + result);
                $this.button('reset');
            }

        }).fail(function () {
            alert = new Alert('.alert-section', 'danger', configMap.validStatus.msg.resetFailed);
            $this.button('reset');
        }).always(function () {
            alert.show(2000);
        })
    })

</script>

<script src="/static/scripts/lib/effects/cloud/Detector.js"></script>
<script src="/static/scripts/lib/effects/three.min.js"></script>
<script id="vs" type="x-shader/x-vertex">
    varying vec2 vUv;

    void main() {

    vUv = uv;
    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }

</script>
<script id="fs" type="x-shader/x-fragment">
    uniform sampler2D map;

    uniform vec3 fogColor;
    uniform float fogNear;
    uniform float fogFar;

    varying vec2 vUv;

    void main() {
        float depth = gl_FragCoord.z / gl_FragCoord.w;
        float fogFactor = smoothstep( fogNear, fogFar, depth );

        gl_FragColor = texture2D( map, vUv );
        gl_FragColor.w *= pow( gl_FragCoord.z, 20.0 );
        gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );
    }

</script>
<script>

    var container;
    var camera, scene, renderer;
    var mesh, geometry, material;
    var isRunningBG = true;

    var mouseX = 0, mouseY = 0;
    var start_time = Date.now();

    var windowHalfX = window.innerWidth / 2;
    var windowHalfY = window.innerHeight / 2 + 40;
    if (Detector.webgl) {
        init();
    } else {
        //Detector.addGetWebGLMessage();
        var register = document.getElementById("register");
        register && (register.style.backgroundColor = "rgb(51, 51, 51)");
    }

    function init() {
        container = $('#clouds').get(0);

        var canvas = document.createElement('canvas');
        canvas.width = 32;
        canvas.height = window.innerHeight;


        var context = canvas.getContext('2d');

        var gradient = context.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, "#1e4877");
        gradient.addColorStop(0.5, "#4584b4");

        context.fillStyle = gradient;
        context.fillRect(0, 0, canvas.width, canvas.height);

        container.style.background = 'url(' + canvas.toDataURL('image/png') + ')';
        container.style.backgroundSize = '32px 100%';
        container.style.height = window.innerHeight - 52 + 'px';


        camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 1, 3000);
        camera.position.z = 6000;

        scene = new THREE.Scene();

        geometry = new THREE.Geometry();

        var texture = THREE.ImageUtils.loadTexture('/static/scripts/lib/effects/cloud/cloud.png', null, animate);
        texture.magFilter = THREE.LinearMipMapLinearFilter;
        texture.minFilter = THREE.LinearMipMapLinearFilter;

        var fog = new THREE.Fog(0x4584b4, -100, 3000);

        material = new THREE.ShaderMaterial({
            uniforms: {
                "map": {type: "t", value: texture},
                "fogColor": {type: "c", value: fog.color},
                "fogNear": {type: "f", value: fog.near},
                "fogFar": {type: "f", value: fog.far}
            },
            vertexShader: document.getElementById('vs').textContent,
            fragmentShader: document.getElementById('fs').textContent,
            depthWrite: false,
            depthTest: false,
            transparent: true
        });

        var plane = new THREE.Mesh(new THREE.PlaneGeometry(64, 64));

        for (var i = 0; i < 8000; i++) {
            plane.position.x = Math.random() * 1000 - 500;
            plane.position.y = -Math.random() * Math.random() * 200 - 15;
            plane.position.z = i;
            plane.rotation.z = Math.random() * Math.PI;
            plane.scale.x = plane.scale.y = Math.random() * Math.random() * 1.5 + 0.5;

            THREE.GeometryUtils.merge(geometry, plane);
        }

        mesh = new THREE.Mesh(geometry, material);
        scene.add(mesh);

        mesh = new THREE.Mesh(geometry, material);
        mesh.position.z = -8000;
        scene.add(mesh);

        renderer = new THREE.WebGLRenderer({antialias: false});
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);
        document.addEventListener('mousemove', onDocumentMouseMove, false);
    }

    function onDocumentMouseMove(event) {
        mouseX = (event.clientX - windowHalfX) * 0.25;
        mouseY = (event.clientY - windowHalfY) * 0.15;
    }

    function onWindowResize(event) {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        if (!isRunningBG) return;
        requestAnimationFrame(animate);
        var position = ((Date.now() - start_time) * 0.03) % 8000;
        camera.position.x += (mouseX - camera.position.x) * 0.01;
        camera.position.y += (-mouseY - camera.position.y) * 0.01;
        camera.position.z = -position + 8000;
        renderer.render(scene, camera);
    }

    I18n.fillPage();
</script>
</body>
</html>