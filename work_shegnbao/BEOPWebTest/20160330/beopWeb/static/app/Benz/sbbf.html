<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/static/scripts/lib/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/content/index.css">
    <link rel="stylesheet" type="text/css" href="/static/content/index-black.css">
    <link rel="stylesheet" type="text/css" href="/static/content/index-black.css">
    <link rel="stylesheet" type="text/css" href="/static/app/Benz/env.css">
    <script src="/static/scripts/lib/jquery-2.1.4.min.js"></script>
    <script src="/static/scripts/lib/bootstrap/js/bootstrap.min.js"></script>
</head>
<body>
    <div id="t1455936021398">
        <style>
            #t1455936021398, #t1455936021398 .xungeng {
                width: 100%;
                height: 100%;
            }
            #t1455936021398 .xungeng {
                margin: 10px;
                position: relative;
            }
            #t1455936021398 .btn-toolbar .btn {
                color: #eee;
                background-color: transparent;
                border-color: #eee;
            }
            #t1455936021398 .table { cursor: pointer;  }
            #t1455936021398 .pagination {
                margin: 0;
            }
            #t1455936021398 .pagin-wrap {
                position: absolute;
                bottom: 20px;
            }
        </style>

        <div class="xungeng container-fluid">

            <div class="btn-toolbar" role="toolbar">
                <button type="button" class="btn btn-default btn-sm" id="btnAddFlow"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> 新增</button>
                <button type="button" class="btn btn-default btn-sm" id="btnEditFlow" disabled="disabled"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> 修改</button>
                <button type="button" class="btn btn-default btn-sm" id="btnStartFlow" disabled="disabled"><span class="glyphicon glyphicon-play" aria-hidden="true"></span> 开始</button>
                <button type="button" class="btn btn-default btn-sm" id="btnCloseFlow" disabled="disabled"><span class="glyphicon glyphicon-stop" aria-hidden="true"></span> 关闭</button>
            </div>

            <div class="table-responsive">
                <table class="table  table-hover" id="equipmentTable">
                    <thead>
                        <tr>
                            <th>报废申请单编号</th>
                            <th>报废设备编号</th>
                            <th>报废设备名称</th>
                            <th>报废原因</th>
                            <th>申请人</th>
                            <th>当前申请状态</th>
                            <th>当前处理人</th>
                            <th>已处理时间</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-status="1">
                            <td>Q1823-800</td>
                            <td>EQ-850_000</td>
                            <td>冷冻水管2#主蝶阀</td>
                            <td>设备使用寿命已到，此时损坏，，维修意义不大，建议报废</td>
                            <td>唐云</td>
                            <td><span class="label label-info">正在工程总监审批</span></td>
                            <td>赵今山</td>
                            <td>32小时</td>

                        </tr>
                        <tr data-status="1">
                            <td>Q1823-800</td>
                            <td>EQ-850_000</td>
                            <td>冷冻水管2#主蝶阀</td>
                            <td>设备使用寿命已到，此时损坏，，维修意义不大，建议报废</td>
                            <td>唐云</td>
                            <td><span class="label label-info">正在财务审批</span></td>
                            <td>赵今山</td>
                            <td>32小时</td>
                        </tr>
                        <tr data-status="1">
                            <td>Q1823-800</td>
                            <td>EQ-850_000</td>
                            <td>冷冻水管2#主蝶阀</td>
                            <td>设备使用寿命已到，此时损坏，，维修意义不大，建议报废</td>
                            <td>唐云</td>
                            <td><span class="label label-info">正在废品校验</span></td>
                            <td>赵今山</td>
                            <td>32小时</td>
                        </tr>
                        <tr data-status="1">
                            <td>Q1823-800</td>
                            <td>EQ-850_000</td>
                            <td>冷冻水管2#主蝶阀</td>
                            <td>设备使用寿命已到，此时损坏，，维修意义不大，建议报废</td>
                            <td>唐云</td>
                            <td><span class="label label-success">报废完成</span></td>
                            <td>-</td>
                            <td>46小时</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <nav class="clearfix pagin-wrap">
                <ul class="pagination">
                    <li>
                        <a href="javascript:;" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    <li><a href="javascript:;">1</a></li>
                    <li>
                        <a hrefjavascript:; aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <script>
            var domWrap = document.querySelector('#t1455936021398');
            var domBtnAddFlow = domWrap.querySelector('#btnAddFlow');
            var domBtnStartFlow = domWrap.querySelector('#btnStartFlow');
            var domBtnCloseFlow = domWrap.querySelector('#btnCloseFlow');
            var domBtnEditFlow = domWrap.querySelector('#btnEditFlow');
            var domTabale = domWrap.querySelector('#equipmentTable');
            var domSelectedRow = null;

            var equipmentTable = {
                addRow: function (data) {
                    var $tbody = $('#equipmentTable tbody', domWrap);
                    var arrHtml = ['<tr data-status="0">'];

                    arrHtml.push('<td>Q1823-800</td>');
                    arrHtml.push('<td>'+data.no+'</td>');
                    arrHtml.push('<td>'+data.name+'#'+data.group+'</td>');
                    arrHtml.push('<td>'+data.reason+'</td>');
                    arrHtml.push('<td>'+AppConfig.userProfile.fullname+'</td>');
                    arrHtml.push('<td><span class="label label-info">尚未开始</span></td>');
                    arrHtml.push('<td>'+data.people+'</td>');
                    arrHtml.push('<td>0小时</td>');

                    arrHtml.push('</tr>');

                    $tbody.append(arrHtml.join(''));
                }
            };

            var equipmentSelect = {
                data: [{
                    "name": '请选择设备...',
                    "no": '-1',
                    "group": ''
                },{
                    "_id": "ccccccccccccf32fbc300001",
                    "group": "冷却水系统",
                    "prefix": "",
                    "arrP": ["IceTankRatio_svr", "Pi3","Ti3","Ti4"],
                    "path": "",
                    "type": "IceTank",
                    "name": "蓄冰槽",
                    "no": 'EQ-850_000'
                }],
                $sel: null,
                show: function (sel) {
                    var arrHtml;

                    this.$sel = $(sel);

                    arrHtml = this.data.map(function (row) {
                        return '<option value="'+row.no+'">'+row.name+(row.group ? (' - '+row.group) : '' )+'</option>';
                    });

                    this.$sel.empty().html(arrHtml.join(''));
                }
            };

            // 新增设备弹出框
            var equipmentAddModal = {
                tpl: '\
    <div class="modal fade" role="dialog">\
        <div class="modal-dialog modal-lg">\
            <div class="modal-content">\
                <div class="modal-header">\
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span></button>\
                    <h4 class="modal-title">添加报废申请单</h4>\
                </div>\
                <div class="modal-body">\
                    <form>\
                        <div class="form-group">\
                            <label for="selEquipmentList">报废设备</label>\
                            <select class="form-control" id="selEquipmentList"></select>\
                        </div>\
                        <div class="form-group">\
                            <label for="selPeople">处理人</label>\
                            <select class="form-control" id="selPeople">\
                                <option value="窦天鹏">窦天鹏</option>\
                                <option value="朱杰  ">朱杰   </option>\
                                <option value="宋怀安">宋怀安 </option>\
                                <option value="阮小倩">阮小倩 </option>\
                                <option value="宋佳佳">宋佳佳 </option>\
                                <option value="顾峰  ">顾峰   </option>\
                                <option value="徐林  ">徐林   </option>\
                                <option value="沈春华">沈春华 </option>\
                                <option value="林倩茹">林倩茹 </option>\
                                <option value="贾远  ">贾远   </option>\
                                <option value="白杜  ">白杜   </option>\
                                <option value="袁晓磊">袁晓磊 </option>\
                                <option value="范东  ">范东   </option>\
                                <option value="祝胜春">祝胜春 </option>\
                                <option value="李林峰">李林峰 </option>\
                                <option value="钱睿斌">钱睿斌 </option>\
                                <option value="邓悠悠">邓悠悠 </option>\
                                <option value="彭兵  ">彭兵   </option>\
                                <option value="何山  ">何山   </option>\
                                <option value="田嘉怡">田嘉怡 </option>\
                                <option value="刘人仁">刘人仁 </option>\
                                <option value="苏小强">苏小强 </option>\
                                <option value="金林  ">金林   </option>\
                                <option value="孔德玉">孔德玉 </option>\
                                <option value="何春发">何春发 </option>\
                                <option value="于叶军">于叶军 </option>\
                                <option value="沈兰花">沈兰花 </option>\
                                <option value="褚丽琴">褚丽琴 </option>\
                                <option value="岳森  ">岳森   </option>\
                                <option value="任石峰">任石峰 </option>\
                            </select>\
                        </div>\
                        <div class="form-group">\
                            <label for="taScrapReason">报废原因</label>\
                            <textarea class="form-control" id="taScrapReason" placeholder="请填写设备的报废原因"></textarea>\
                        </div>\
                    </form>\
                </div>\
                <div class="modal-footer">\
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>\
                    <button type="button" class="btn btn-primary" id="btnSubmit">确认提交</button>\
                </div>\
            </div>\
        </div>\
    </div>',
                $modal: null,
                show: function () {
                    var $wrap = $('body');

                    if (!this.$modal) {
                        this.$modal = $(this.tpl);
                        this.attachEvents();
                    }
                    this.$modal.appendTo($wrap);
                    this.$modal.modal('show');
                },
                attachEvents: function () {
                    var _this = this;

                    this.$modal.off();
                    this.$modal.on('shown.bs.modal', function () {
                        // 初始化下拉框
                        equipmentSelect.show(this.querySelector('#selEquipmentList'));
                    });

                    this.$modal.on('hidden.bs.modal', function () {
                        $(this).detach();
                    });

                    $('#btnSubmit', this.$modal).off().click(function (e) {
                        var data = _this.getFormData();
                        var equipment = (function (no, data) {
                            for (var i = 0, len = data.length; i < len; i++) {
                                if (data[i].no === no) {
                                    return data[i];
                                }
                            }
                            return null;
                        } (data.no, equipmentSelect.data));

                        if (equipment.no === '-1') {
                            alert('请选择一个设备进行报销！');
                        } else if (data.people === '-1') {
                            alert('请选择一名处理人！');
                        } else {
                            equipmentTable.addRow({
                                name: equipment.name,
                                no: equipment.no,
                                group: equipment.group,
                                people: data.people,
                                reason: data.reason
                            });
                            _this.$modal.modal('hide');
                        }
                    });
                },
                getFormData: function () {
                    return {
                        no: this.$modal.find('#selEquipmentList').val(),
                        people: this.$modal.find('#selPeople').val(),
                        reason: this.$modal.find('#taScrapReason').val()
                    }
                },
                close: function () {
                    if (this.$modal) {
                        this.$modal.remove();
                        this.$modal = null;   
                    }
                }
            };

            var refreshToolStatus = function () {
                var $ele = $(domSelectedRow);
                if (!domSelectedRow) {
                    $(domBtnEditFlow).prop('disabled', true);
                    $(domBtnCloseFlow).prop('disabled', true);
                    $(domBtnStartFlow).prop('disabled', true);
                } else if (domSelectedRow.dataset.status === '0') {
                    $(domBtnEditFlow).prop('disabled', false);
                    $(domBtnStartFlow).prop('disabled', false);
                    $(domBtnCloseFlow).prop('disabled', true);
                } else if (domSelectedRow.dataset.status === '1') {
                    $(domBtnEditFlow).prop('disabled', false);
                    $(domBtnStartFlow).prop('disabled', true);
                    $(domBtnCloseFlow).prop('disabled', false);
                } else if (domSelectedRow.dataset.status === '-1') {
                    $(domBtnEditFlow).prop('disabled', true);
                    $(domBtnCloseFlow).prop('disabled', true);
                    $(domBtnStartFlow).prop('disabled', true);
                }
            };

            domBtnAddFlow.onclick = function (e) {
                equipmentAddModal.show();

                e.preventDefault();
                e.stopPropagation();
            };

            domBtnStartFlow.onclick = function (e) {
                if (!domSelectedRow) return;

                domSelectedRow.dataset.status = 1;
                domSelectedRow.querySelector('.label').innerHTML = '正在工程总监审批';

                refreshToolStatus();
            };

            domBtnCloseFlow.onclick = function (e) {
                if (!domSelectedRow) return;

                domSelectedRow.dataset.status = -1;
                $(domSelectedRow.querySelector('.label')).removeClass('label-info').addClass('label-danger').html('作废');
                refreshToolStatus();
            };

            $(domTabale).off().on('click', 'tbody > tr', function () {
                var $this = $(this);
                var isActive = $this.hasClass('active');

                if (!isActive) {
                    $this.siblings().removeClass('active');
                    $this.addClass('active');
                    domSelectedRow = this;
                } else {
                    $this.removeClass('active');
                    domSelectedRow = null;
                }
                refreshToolStatus();
            });

        </script>
    </div>
</body>