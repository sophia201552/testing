(function(root,factory){if(typeof exports=='object')module.exports=factory()
else if(typeof define=='function'&&define.amd)define(factory)
else root.LoadingSpinner=factory()}
(this,function(){"use strict";var prefixes=['webkit','Moz','ms','O'],animations={},useCssAnimations;function createEl(tag,prop){var el=document.createElement(tag||'div'),n;for(n in prop)el[n]=prop[n]
return el}
function ins(parent){for(var i=1,n=arguments.length;i<n;i++)
parent.appendChild(arguments[i])
return parent}
var sheet=(function(){var el=createEl('style',{type:'text/css'})
ins(document.getElementsByTagName('head')[0],el)
return el.sheet||el.styleSheet}())
function addAnimation(alpha,trail,i,lines){var name=['opacity',trail,~~(alpha*100),i,lines].join('-'),start=0.01+i/lines*100,z=Math.max(1-(1-alpha)/trail*(100-start),alpha),prefix=useCssAnimations.substring(0,useCssAnimations.indexOf('Animation')).toLowerCase(),pre=prefix&&'-'+prefix+'-'||''
if(!animations[name]){sheet.insertRule('@'+pre+'keyframes '+name+'{'+'0%{opacity:'+z+'}'+
start+'%{opacity:'+alpha+'}'+
(start+0.01)+'%{opacity:1}'+
(start+trail)%100+'%{opacity:'+alpha+'}'+'100%{opacity:'+z+'}'+'}',sheet.cssRules.length)
animations[name]=1}
return name}
function vendor(el,prop){var s=el.style,pp,i
prop=prop.charAt(0).toUpperCase()+prop.slice(1)
for(i=0;i<prefixes.length;i++){pp=prefixes[i]+prop
if(s[pp]!==undefined)return pp}
if(s[prop]!==undefined)return prop}
function css(el,prop){for(var n in prop)
el.style[vendor(el,n)||n]=prop[n]
return el}
function merge(obj){for(var i=1;i<arguments.length;i++){var def=arguments[i]
for(var n in def)
if(obj[n]===undefined)obj[n]=def[n]}
return obj}
function pos(el){var o={x:el.offsetLeft,y:el.offsetTop}
while((el=el.offsetParent))
o.x+=el.offsetLeft,o.y+=el.offsetTop
return o}
function getColor(color,idx){return typeof color=='string'?color:color[idx%color.length]}
var defaults={lines:12,length:10,width:5,radius:15,rotate:0,corners:1,color:'#000',direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:1001,className:'spinner',top:'50%',left:'50%',position:'absolute'}
function LoadingSpinner(o){this.opts=merge(o||{},LoadingSpinner.defaults,defaults)}
LoadingSpinner.defaults={}
merge(LoadingSpinner.prototype,{spin:function(target){this.stop()
this.opts.target=target;var divMask=document.createElement("div");divMask.className="spinnerMask";divMask.style.width=target.width;divMask.style.height=target.height;target.appendChild(divMask);this.divMask=divMask;var self=this,o=self.opts,el=self.el=css(createEl(0,{className:o.className}),{position:o.position,width:0,zIndex:o.zIndex}),mid=o.radius+o.length+o.width
css(el,{left:o.left,top:o.top})
if(target){target.insertBefore(el,target.firstChild||null)}
el.setAttribute('role','progressbar')
self.lines(el,self.opts)
if(!useCssAnimations){var i=0,start=(o.lines-1)*(1-o.direction)/2,alpha,fps=o.fps,f=fps/o.speed,ostep=(1-o.opacity)/(f*o.trail/100),astep=f/o.lines;(function anim(){i++;for(var j=0;j<o.lines;j++){alpha=Math.max(1-(i+(o.lines-j)*astep)%f*ostep,o.opacity)
self.opacity(el,j*o.direction+start,alpha,o)}
self.timeout=self.el&&setTimeout(anim,~~(1000/fps))})()}
return self},stop:function(){var el=this.el
if(el){clearTimeout(this.timeout)
if(el.parentNode)el.parentNode.removeChild(el)
this.el=undefined
if(this.divMask){if(this.divMask.parentNode)this.divMask.parentNode.removeChild(this.divMask)
this.el=undefined}}
return this},lines:function(el,o){var i=0,start=(o.lines-1)*(1-o.direction)/2,seg
function fill(color,shadow){return css(createEl(),{position:'absolute',width:(o.length+o.width)+'px',height:o.width+'px',background:color,boxShadow:shadow,transformOrigin:'left',transform:'rotate('+~~(360/o.lines*i+o.rotate)+'deg) translate('+o.radius+'px'+',0)',borderRadius:(o.corners*o.width>>1)+'px'})}
for(;i<o.lines;i++){seg=css(createEl(),{position:'absolute',top:1+~(o.width/2)+'px',transform:o.hwaccel?'translate3d(0,0,0)':'',opacity:o.opacity,animation:useCssAnimations&&addAnimation(o.opacity,o.trail,start+i*o.direction,o.lines)+' '+1/o.speed+'s linear infinite'})
if(o.shadow)ins(seg,css(fill('#000','0 0 4px '+'#000'),{top:2+'px'}))
ins(el,ins(seg,fill(getColor(o.color,i),'0 0 1px rgba(0,0,0,.1)')))}
return el},opacity:function(el,i,val){if(i<el.childNodes.length)el.childNodes[i].style.opacity=val}})
function initVML(){function vml(tag,attr){return createEl('<'+tag+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',attr)}
sheet.addRule('.spin-vml','behavior:url(#default#VML)')
LoadingSpinner.prototype.lines=function(el,o){var r=o.length+o.width,s=2*r
function grp(){return css(vml('group',{coordsize:s+' '+s,coordorigin:-r+' '+-r}),{width:s,height:s})}
var margin=-(o.width+o.length)*2+'px',g=css(grp(),{position:'absolute',top:margin,left:margin}),i
function seg(i,dx,filter){ins(g,ins(css(grp(),{rotation:360/o.lines*i+'deg',left:~~dx}),ins(css(vml('roundrect',{arcsize:o.corners}),{width:r,height:o.width,left:o.radius,top:-o.width>>1,filter:filter}),vml('fill',{color:getColor(o.color,i),opacity:o.opacity}),vml('stroke',{opacity:0}))))}
if(o.shadow)
for(i=1;i<=o.lines;i++)
seg(i,-2,'progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)')
for(i=1;i<=o.lines;i++)seg(i)
return ins(el,g)}
LoadingSpinner.prototype.opacity=function(el,i,val,o){var c=el.firstChild
o=o.shadow&&o.lines||0
if(c&&i+o<c.childNodes.length){c=c.childNodes[i+o];c=c&&c.firstChild;c=c&&c.firstChild
if(c)c.opacity=val}}}
var probe=css(createEl('group'),{behavior:'url(#default#VML)'})
if(!vendor(probe,'transform')&&probe.adj)initVML()
else useCssAnimations=vendor(probe,'animation')
return LoadingSpinner}));﻿var ScreenManager=(function(){function ScreenManager(){}
ScreenManager.screenFlag='page';ScreenManager.root='#page=IndexScreen';ScreenManager.paneRoot="#page=PaneProjectSelector";ScreenManager.isListening=false;ScreenManager.Init=function(){I18n.fillArea($(".navbar"));};ScreenManager.show=function(){if(arguments.length===0){return;}
var screenClass=arguments[0];if(typeof screenClass!=='function'){return;}
if(!ScreenManager.isListening){ScreenManager.applyScreen.apply(null,arguments);}else{ScreenManager.applyGoTo.apply(null,arguments);}};ScreenManager.applyGoTo=function(){var screenClass=arguments[0];if(!screenClass.name){alert(I18n.resource.common.NOT_FOUND_PAGE);return false;}
var paramObj={page:screenClass.name},paramList=ScreenManager._getFunctionParams(screenClass);for(var m=0,n=paramList.length;m<n;m++){if(typeof arguments[m+1]!=typeof undefined){paramObj[paramList[m]]=arguments[m+1];}}
ScreenManager.goTo(paramObj);};ScreenManager.applyScreen=function(){var screenClass=arguments[0];if(!screenClass){alert('Can\'t find the page.');return;}
if(ScreenCurrent){window.onresize=null;if(ScreenCurrent.close&&ScreenCurrent.close()===false){return;}}
var screenObj=Object.create(screenClass.prototype);ScreenCurrent=(screenClass.apply(screenObj,Array.prototype.slice.call(arguments,1))||screenObj);if(ScreenCurrent.onresize)window.onresize=ScreenCurrent.onresize;ScreenCurrent.show();};ScreenManager._getFunctionParams=function(func){var STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg,ARGUMENT_NAMES=/([^\s,]+)/g,fnStr,result;fnStr=func.toString().replace(STRIP_COMMENTS,'');result=fnStr.slice(fnStr.indexOf('(')+1,fnStr.indexOf(')')).match(ARGUMENT_NAMES);if(result===null){result=[];}
return result;};ScreenManager._getHashParamsMap=function(){var hashParamsList,hashParamsMap={};hashParamsList=location.hash.substr(1).split('&');for(var m=0;m<hashParamsList.length;m++){var paramsItem=hashParamsList[m].split('=');hashParamsMap[paramsItem[0]]=paramsItem[1];}
return hashParamsMap;};ScreenManager.loadProjectMenu=function(project,page_id){new PaneProjectSelector().init().initProject(project['id'],project['name_en'],StringUtil.getI18nProjectName(project),page_id);};ScreenManager.loadUserPanel=function(){$("#right-nav").show();};ScreenManager.screenChange=function(e){var promise=$.Deferred();if(I18n&&I18n.resource){promise.resolve();}else{InitI18nResource().always(function(rs){I18n=new Internationalization(null,rs);promise.resolve();});}
promise.always(function(){var hashParamsMap,screen,currentPage,screenParamsNameList=[],screenParamsValueList=[];if(AppConfig.afterLogin){$('#navHeader').fadeIn();$('#indexMain').animate({top:'55px'});}
hashParamsMap=ScreenManager._getHashParamsMap();if(typeof hashParamsMap.projectId!=='undefined'){AppConfig.projectId=hashParamsMap.projectId;var project=BEOPUtil.getProjectFromAppConfig(hashParamsMap.projectId);if(project){AppConfig.projectEnName=project['name_en'];AppConfig.projectName=project['name_en'];if(location.hash!=ScreenManager.paneRoot){ScreenManager.loadProjectMenu(project,hashParamsMap.id);}}}
ScreenManager.loadUserPanel();currentPage=hashParamsMap[ScreenManager.screenFlag];if(currentPage){if(currentPage.indexOf('.')>0){screen=namespace(currentPage)}else{if(currentPage==='EnergyScreen_M'){currentPage='EnergyScreen';}
screen=window[currentPage]||namespace('observer.screens')[currentPage];}}else{console.error('无法识别的location hash! hash is '+location.hash);return true;}
if(screen&&typeof screen==='function'){screenParamsNameList=ScreenManager._getFunctionParams(screen);for(var m=0;m<screenParamsNameList.length;m++){var paramName=screenParamsNameList[m];if(typeof hashParamsMap[paramName]!=='undefined'){screenParamsValueList[m]=_unserializeParams(hashParamsMap[paramName]);}else{screenParamsValueList[m]=undefined;}}
ScreenManager.applyScreen.apply(null,[screen].concat(screenParamsValueList));I18n.fillArea($('#navPane'));return false;}else{return true;}});};ScreenManager.goTo=function(pageInfo){var hashFlag='#',hashList=[];if(!pageInfo){return false;}
if(AppConfig.projectId){pageInfo['projectId']=AppConfig.projectId;}
if(pageInfo[ScreenManager.screenFlag]){hashList.push(ScreenManager.screenFlag+'='+pageInfo[ScreenManager.screenFlag]);}
for(var param in pageInfo){if(pageInfo.hasOwnProperty(param)){if(param!==ScreenManager.screenFlag){hashList.push(param+'='+_serializeParams(pageInfo[param]));}}}
if(location.hash===hashFlag+hashList.join('&')){Spinner&&Spinner.stop();}else{location.hash=hashFlag+hashList.join('&');}};ScreenManager.listen=function(){if("onhashchange"in window&&(!document.documentMode||document.documentMode>=8)){ScreenManager.isListening=true;window.onhashchange=ScreenManager.screenChange;ScreenManager.detectAnchorHash();if(location.hash===''){if(AppConfig.afterLogin){window.addEventListener('load',function(){location.hash=ScreenManager.paneRoot;new PaneProjectSelector().init().show();},false);}else{location.hash=ScreenManager.root;}}else{if(location.hash==ScreenManager.root){if(AppConfig.afterLogin){location.hash=ScreenManager.paneRoot;}else{ScreenManager.screenChange();}}
if(AppConfig.afterLogin){window.addEventListener('load',function(){ScreenManager.screenChange();new PaneProjectSelector().init();},false)}else{location.hash=ScreenManager.root;}}}else{console.error('This browser can\'t support onhashchange event.')}};ScreenManager.detectAnchorHash=function(){var isValidHash=function(hash){if(typeof hash===typeof undefined||hash.startsWith('http')||hash.startsWith('https')){return true;}else if(hash==='/factory'||hash==='/point_tool/editor'){return true;}else{return hash.indexOf('=')!=-1;}};$(document).on('click.anchorHash','a',function(ev){var $this=$(this),hash=$this.attr('href'),isManagedHash=$this.attr('nothash');if(typeof isManagedHash!==typeof undefined&&isManagedHash!==false){return true;}
if(!isValidHash(hash)){ev.preventDefault();var dom=document.getElementById(hash.substr(1));if(dom){dom.scrollIntoView();}}
return true;})};if(typeof AppConfig!=typeof undefined){ScreenManager.listen();}
function _serializeParams(params){if(typeof params!=='string'){return window.encodeURIComponent(JSON.stringify(params));}
return params;}
function _unserializeParams(params){try{params=JSON.parse(window.decodeURIComponent(params));}catch(e){}
return params;}
return ScreenManager;})();﻿
var beop=beop||{};beop.constant={project_img_path:'/static/images/project_img/',project_default_img:'default.jpg'};var ObjectId=function(){var hex8=('00000000'+Math.floor(Math.random()*0xFFFFFFFF).toString(16)).slice(-8);var userId=('000'+(AppConfig.userId||'000')).slice(-3);var timestamp=new Date().valueOf();return timestamp+userId+hex8;};(function(exports){exports.namespace=function(path){var obj=window;path=path.split('.');path.forEach(function(p,i){p=p.trim();if(i===0&&p==='window')return;obj=obj[p]=obj[p]||{};});return obj;};}(window));var FullScreenManager=(function(){var manager=Object.create({init:function(){var _this=this;$(document).off('webkitfullscreenchange');$(document).on('webkitfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('mozfullscreenchange');$(document).on('mozfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('msfullscreenchange');$(document).on('msfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});if(typeof onError==='function'){$(document).off('webkitfullscreenerror');$(document).on('webkitfullscreenerror',this.onFullScreenError);$(document).off('mozfullscreenerror');$(document).on('mozfullscreenerror',this.onFullScreenError);$(document).off('msfullscreenerror');$(document).on('msfullscreenerror',this.onFullScreenError);}},onFullScreenEnter:function(){},onFullScreenOut:function(){},onFullScreenError:function(){},toggle:function(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!document.msFullscreenElement){if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}}});manager.init();return manager;}());function StringBuilder(){this.data=Array("");}
StringBuilder.prototype.append=function(){this.data.push(arguments[0]);return this;};StringBuilder.prototype.toString=function(){return this.data.join("");};StringBuilder.prototype.getLength=function(){return this.data.length;};if(!String.prototype.format){String.prototype.format=function(){if(arguments[0]===undefined){return'';}
if(arguments[0].constructor===Array){var args=arguments[0];}else{var args=arguments;}
return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
if(!String.prototype.formatEL){String.prototype.formatEL=function(o){var str=this.toString();if(!str||!o)return'';for(var p in o){if(o.hasOwnProperty(p)){str=str.replace(new RegExp('{'+p+'}','g'),o[p]);}}
return str;};}
String.prototype.toDate=function(){var str=this;if(str.indexOf('-')>-1)
str=str.replace('-','/').replace('-','/');return new Date(str);};Number.prototype.toDate=function(){return new Date(this);};function Alert(targetElement,type,msg){this.element=targetElement;this.str=new StringBuilder();this.str.append('<div style="display:none;" class="alert beop-alert alert-').append(type).append(' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<div class="alert-msg">'+msg+'</div>').append('</div>');this.$alert=$(this.str.toString());}
Alert.danger=function(targetElement,msg){return new Alert(targetElement,Alert.type.danger,msg).show();};Alert.warning=function(targetElement,msg){return new Alert(targetElement,Alert.type.warning,msg).show();};Alert.success=function(targetElement,msg){return new Alert(targetElement,Alert.type.success,msg).show();};Alert.info=function(targetElement,msg){return new Alert(targetElement,Alert.type.info,msg).show();};Alert.closeAll=function(){$('.beop-alert').remove();};Alert.type={danger:'danger',warning:'warning',success:'success',info:'info'};Alert.prototype.show=function(duration){Alert.closeAll();if(duration){var _this=this;setTimeout(function(){_this.close();},duration);}
$(this.element).append(this.$alert);this.$alert.slideDown(500);return this;};Alert.prototype.close=function(){var _this=this;this.$alert.slideUp(500,function(){_this.$alert.remove();_this=null;});};Alert.prototype.setMessage=function(msg){if(!msg){return false}
this.$alert.find('.alert-msg').text(msg);};Alert.prototype.setStyle=function(style){if(style&&typeof style!=='string'){this.$alert.css(style);}
return this;};Alert.prototype.showAtTop=function(duration){this.setStyle({position:'absolute',top:0,left:0,right:0,margin:'auto',width:'30%',textAlign:'center',zIndex:10000});this.show(duration);};function showDialog(url){return WebAPI.get(url).done(function(resultHtml){$("#dialogContent").html(resultHtml);$('#dialogModal').modal({});});}
function clone(obj){if(obj==null||typeof(obj)!='object')
return obj;var temp=obj.constructor();for(var key in obj){if(obj.hasOwnProperty(key)){temp[key]=clone(obj[key]);}}
return temp;}
Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var week={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
if(/(E+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,((RegExp.$1.length>1)?(RegExp.$1.length>2?"/u661f/u671f":"/u5468"):"")+week[this.getDay()+""]);}
for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)));}}
return fmt;}
var DateUtil=(function(){var dateLocale={month:{en:{month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],month_names_short:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']},zh:{month_names:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],month_names_short:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']}}};function getWeekNumber(d){d=new Date(+d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7)
return[d.getFullYear(),weekNo];}
function getLastWeekNumberOf(y,w){w-=1;if(w===0){y=y-1;w=52;}
return[y,w];}
function getNextWeekNumberOf(y,w){w+=1;if(w===53){y+=1;w=1;}
return[y,w];}
function isLeapYear(y){if(Object.prototype.toString.call(y)==='[object Date]'){y=y.getUTCFullYear();}
return((y%4===0)&&(y%100!==0))||(y%400===0);}
function daysInMonth(dt){var m=dt.getUTCMonth();if(m===1){return isLeapYear(dt)?29:28;}
return[31,28,31,30,31,30,31,31,30,31,30,31][m];}
function getFirstDayOfWeek(year,week){var d=new Date(year,0,1),offset=d.getTimezoneOffset();d.setDate(d.getDate()+4-(d.getDay()||7));d.setTime(d.getTime()+7*24*60*60*1000*(week+(year==d.getFullYear()?-1:0)));d.setTime(d.getTime()
+(d.getTimezoneOffset()-offset)*60*1000);d.setDate(d.getDate()-3);return d;}
function getDateRangeOnWeekNumber(year,week){if(!year||!week){return;}
var firstDay=getFirstDayOfWeek(year,week),lastDay=new Date(firstDay);lastDay.setDate(firstDay.getDate()+6);return[firstDay,lastDay];}
function getMonthName(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names:dateLocale.month['en'].month_names;return monthList[index];}
function getMonthNameShort(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names_short:dateLocale.month['en'].month_names_short;return monthList[index];}
function getLastMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===1){return 12;}else{return currentMonth-1;}}
function getNextMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===12){return 1;}else{return currentMonth+1;}}
function getRelativeDateInfo(date1,date2){var now=new Date();var lang=I18n.type;var value1,value2,ts,info;if(!date1&&!date2)return'';value1=(date1||now).valueOf();value2=(date2||now).valueOf();ts=Math.floor(Math.abs(value1-value2)/1000);switch(true){case ts<60:info=ts+(ts===1?' second':' seconds');break;case ts<3600:ts=Math.floor(ts/60);info=ts+(ts===1?' minute':' minutes');break;case ts<86400:ts=Math.floor(ts/(3600));info=ts+(ts===1?' hour':' hours');break;case ts<31536000:ts=Math.floor(ts/(86400));info=ts+(ts===1?' day':' days');break;default:ts=Math.floor(ts/(31536000));info=ts+(ts===1?' year':' years');break;}
info+=value1>value2?' ago':' later';if(lang==='zh'){info=info.replace(/\s(seconds?|minutes?|hours?|days?|years?)\s(ago|later)$/,function($0,$1,$2){var rs='';if($1.indexOf('second')>-1)rs+='秒钟';if($1.indexOf('minute')>-1)rs+='分钟';if($1.indexOf('hour')>-1)rs+='小时';if($1.indexOf('day')>-1)rs+='天';if($1.indexOf('year')>-1)rs+='年';if($2==='ago')rs+='前';if($2==='later')rs+='后';return rs;});}
return info;}
return{getWeekNumber:getWeekNumber,isLeapYear:isLeapYear,daysInMonth:daysInMonth,getLastWeekNumberOf:getLastWeekNumberOf,getNextWeekNumberOf:getNextWeekNumberOf,getDateRangeOnWeekNumber:getDateRangeOnWeekNumber,getFirstDayOfWeek:getFirstDayOfWeek,getMonthName:getMonthName,getMonthNameShort:getMonthNameShort,getLastMonth:getLastMonth,getNextMonth:getNextMonth,getRelativeDateInfo:getRelativeDateInfo}})();var StringUtil=(function(){var HTML_ENTITIES={'&':'&amp;','>':'&gt;','<':'&lt;','"':'&quot;',"'":'&#39;','`':'&#x60;'},HTML_ENTITIES_INVERT=invert(HTML_ENTITIES);function invert(obj){var result={},keys=Object.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i];}
return result;};function padLeft(oldStr,padNum,padStr){if(!padStr){return oldStr;}
return Array(padNum-String(oldStr).length+1).join(padStr)+oldStr;}
function htmlEscape(text){if(!text){return text}
var source='(?:'+Object.keys(HTML_ENTITIES).join('|')+')',replaceRegexp=RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES[character];});}
function htmlUnEscape(text){if(!text){return text}
var source='(?:'+Object.keys(HTML_ENTITIES_INVERT).join('|')+')',replaceRegexp=RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES_INVERT[character];});}
var getI18nProjectName=function(project){if(!I18n||!project){return'';}
var result='';switch(I18n.type){case'en':{result=project.name_english;break;}
case'zh':{result=project.name_cn;break;}
default:{result=project.name_english;}}
return result||'';};return{padLeft:padLeft,htmlEscape:htmlEscape,htmlUnEscape:htmlUnEscape,getI18nProjectName:getI18nProjectName}})();var BEOPUtil=(function(){var jsType={function:typeof $.noop,number:typeof 0,string:typeof'',undefined:typeof undefined};var projectImgPath=beop.constant.project_img_path;var setRelativePosition=function($obj,$target,topOffset,leftOffset){var offset=$obj.offset();var topOffset=topOffset||10;var leftOffset=leftOffset||5;var top=offset.top+topOffset;var left=offset.left+$obj.width()+leftOffset;$target.css({"left":left,"top":top});};var projectDefaultImgPath=projectImgPath+beop.constant.project_default_img;var getProjectImgPath=function(project){if(!project){return;}else{return project.pic?projectImgPath+project.pic:projectDefaultImgPath;}};var getProjectFromAppConfig=function(projectId){for(var m=0,len=AppConfig.projectList.length;m<len;m++){if(AppConfig.projectList[m].id==projectId){return AppConfig.projectList[m];}}};function getFunctionName(func){if(!func||typeof func!=jsType.function){return'';}
var ret=func.toString();ret=ret.substr('function '.length);ret=ret.substr(0,ret.indexOf('('));return ret;}
function isUndefined(obj){return typeof obj===jsType.undefined;}
function getCookie(name){var value="; "+document.cookie;var parts=value.split("; "+name+"=");if(parts.length==2)return parts.pop().split(";").shift();}
return{setRelativePosition:setRelativePosition,getProjectImgPath:getProjectImgPath,getFunctionName:getFunctionName,isUndefined:isUndefined,getCookie:getCookie,getProjectFromAppConfig:getProjectFromAppConfig}})();(function(){var beop_tmpl_cache={};this.beopTmpl=function tmpl(str,data){var fn=!/\W/.test(str)?beop_tmpl_cache[str]=beop_tmpl_cache[str]||tmpl(document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split(/<!/).join("\t").replace(/((^|!>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)!>/g,"',$1,'").split("\t").join("');").split(/!>/).join("p.push('").split("\r").join("\\'")
+"');}return p.join('');");return data?fn(data):fn;};})();var SidebarMenuEffect=(function(){function SidebarMenuEffect(){}
SidebarMenuEffect.prototype.init=function(center,left,right){var _this=this;this.$paneCt=$(center);this.$leftBtn=$(center).find('#leftCt');this.$rightBtn=$(center).find('#rightCt');var container=document.getElementById('st-container'),buttons=Array.prototype.slice.call(document.querySelectorAll('.sideTrans')),refresh=function(){var leftCol=0,rightCol=0,centerCol=0;var leftArrow='<span class="glyphicon glyphicon-chevron-left"></span>';var rightArrow='<span class="glyphicon glyphicon-chevron-right"></span>';if(_this.$leftBtn.length>0){if(container.className.indexOf('st-effect-7')>0){var prev=_this.$paneCt.prev('div')[0];if(prev&&prev.className.indexOf('col-')>-1){leftCol=parseInt(prev.classList[0].split('-')[2]);}else{leftCol=0;}
_this.$leftBtn.removeClass('leftCtClose').addClass('leftCtOpen').html(leftArrow);}else{leftCol=0;_this.$leftBtn.removeClass('leftCtOpen').addClass('leftCtClose').html(rightArrow);}}
if(_this.$rightBtn.length>0){if(container.className.indexOf('st-effect-1')>0){var next=_this.$paneCt.next('div')[0];if(next&&next.className.indexOf('col-')>-1){rightCol=parseInt(next.classList[0].split('-')[2]);}else{rightCol=0;}
_this.$rightBtn.removeClass('rightCtClose').addClass('rightCtOpen').html(rightArrow);}else{rightCol=0;_this.$rightBtn.removeClass('rightCtOpen').addClass('rightCtClose').html(leftArrow);}}
centerCol=12-leftCol-rightCol;_this.$paneCt.removeClass().addClass('col-sm-'+centerCol+' st-content');};buttons.forEach(function(el,i){var effect=el.getAttribute('data-effect');el.addEventListener('click',function(ev){var target=ev.target.getAttribute('data-effect')!=null?ev.target.getAttribute('data-effect'):ev.target.parentNode.getAttribute('data-effect');var stCtClass=document.getElementById('st-container').className;if(stCtClass.indexOf(target)<0){ev.stopPropagation();ev.preventDefault();container.classList.add(effect);setTimeout(function(){if($(container.children[0]).children('div').length==3){container.classList.add('st-menu-open');}
refresh();},250);}else{container.classList.remove(target);refresh();}});});};return SidebarMenuEffect;})();(function(window){{var unknown='-';var screenSize='';if(screen.width){var width=(screen.width)?screen.width:'';var height=(screen.height)?screen.height:'';screenSize+=''+width+" x "+height;}
var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var browser=navigator.appName;var version=''+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if((verOffset=nAgt.indexOf('Opera'))!=-1){browser='Opera';version=nAgt.substring(verOffset+6);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('MSIE'))!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(verOffset+5);}
else if((verOffset=nAgt.indexOf('Chrome'))!=-1){browser='Chrome';version=nAgt.substring(verOffset+7);}
else if((verOffset=nAgt.indexOf('Safari'))!=-1){browser='Safari';version=nAgt.substring(verOffset+7);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('Firefox'))!=-1){browser='Firefox';version=nAgt.substring(verOffset+8);}
else if(nAgt.indexOf('Trident/')!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(nAgt.indexOf('rv:')+3);}
else if((nameOffset=nAgt.lastIndexOf(' ')+1)<(verOffset=nAgt.lastIndexOf('/'))){browser=nAgt.substring(nameOffset,verOffset);version=nAgt.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName;}}
if((ix=version.indexOf(';'))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(' '))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(')'))!=-1)version=version.substring(0,ix);majorVersion=parseInt(''+version,10);if(isNaN(majorVersion)){version=''+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10);}
var mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);var cookieEnabled=(navigator.cookieEnabled)?true:false;if(typeof navigator.cookieEnabled=='undefined'&&!cookieEnabled){document.cookie='testcookie';cookieEnabled=(document.cookie.indexOf('testcookie')!=-1)?true:false;}
var os=unknown;var clientStrings=[{s:'Windows 3.11',r:/Win16/},{s:'Windows 95',r:/(Windows 95|Win95|Windows_95)/},{s:'Windows ME',r:/(Win 9x 4.90|Windows ME)/},{s:'Windows 98',r:/(Windows 98|Win98)/},{s:'Windows CE',r:/Windows CE/},{s:'Windows 2000',r:/(Windows NT 5.0|Windows 2000)/},{s:'Windows XP',r:/(Windows NT 5.1|Windows XP)/},{s:'Windows Server 2003',r:/Windows NT 5.2/},{s:'Windows Vista',r:/Windows NT 6.0/},{s:'Windows 7',r:/(Windows 7|Windows NT 6.1)/},{s:'Windows 8.1',r:/(Windows 8.1|Windows NT 6.3)/},{s:'Windows 8',r:/(Windows 8|Windows NT 6.2)/},{s:'Windows NT 4.0',r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:'Windows ME',r:/Windows ME/},{s:'Android',r:/Android/},{s:'Open BSD',r:/OpenBSD/},{s:'Sun OS',r:/SunOS/},{s:'Linux',r:/(Linux|X11)/},{s:'iOS',r:/(iPhone|iPad|iPod)/},{s:'Mac OS X',r:/Mac OS X/},{s:'Mac OS',r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:'QNX',r:/QNX/},{s:'UNIX',r:/UNIX/},{s:'BeOS',r:/BeOS/},{s:'OS/2',r:/OS\/2/},{s:'Search Bot',r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var id in clientStrings){var cs=clientStrings[id];if(cs.r.test(nAgt)){os=cs.s;break;}}
var osVersion=unknown;if(/Windows/.test(os)){osVersion=/Windows (.*)/.exec(os)[1];os='Windows';}
switch(os){case'Mac OS X':osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];break;case'Android':osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1];break;case'iOS':osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);osVersion=osVersion[1]+'.'+osVersion[2]+'.'+(osVersion[3]|0);break;}}
window.jscd={screen:screenSize,browser:browser,browserVersion:version,mobile:mobile,os:os,osVersion:osVersion,cookies:cookieEnabled};}(this));var getWysiwyg=function(hasEditor){hasEditor=hasEditor===undefined?true:hasEditor;var wysiwyg='\
        <div class="btn-toolbar" data-role="editor-toolbar" data-target="#editor">\
          <div class="btn-group">\
            <a class="btn dropdown-toggle" data-toggle="dropdown" title="Font" data-original-title="Font"><i class="icon-font"></i><b class="caret"></b></a>\
              <ul class="dropdown-menu">\
              <li><a data-edit="fontName Serif" style="font-family:\'Serif\'">Serif</a></li><li><a data-edit="fontName Sans" style="font-family:\'Sans\'">Sans</a></li><li><a data-edit="fontName Arial" style="font-family:\'Arial\'">Arial</a></li><li><a data-edit="fontName Arial Black" style="font-family:\'Arial Black\'">Arial Black</a></li><li><a data-edit="fontName Courier" style="font-family:\'Courier\'">Courier</a></li><li><a data-edit="fontName Courier New" style="font-family:\'Courier New\'">Courier New</a></li><li><a data-edit="fontName Comic Sans MS" style="font-family:\'Comic Sans MS\'">Comic Sans MS</a></li><li><a data-edit="fontName Helvetica" style="font-family:\'Helvetica\'">Helvetica</a></li><li><a data-edit="fontName Impact" style="font-family:\'Impact\'">Impact</a></li><li><a data-edit="fontName Lucida Grande" style="font-family:\'Lucida Grande\'">Lucida Grande</a></li><li><a data-edit="fontName Lucida Sans" style="font-family:\'Lucida Sans\'">Lucida Sans</a></li><li><a data-edit="fontName Tahoma" style="font-family:\'Tahoma\'">Tahoma</a></li><li><a data-edit="fontName Times" style="font-family:\'Times\'">Times</a></li><li><a data-edit="fontName Times New Roman" style="font-family:\'Times New Roman\'">Times New Roman</a></li><li><a data-edit="fontName Verdana" style="font-family:\'Verdana\'">Verdana</a></li></ul>\
            </div>\
          <div class="btn-group">\
            <a class="btn dropdown-toggle" data-toggle="dropdown" title="Font Size" data-original-title="Font Size"><i class="icon-text-height"></i>&nbsp;<b class="caret"></b></a>\
              <ul class="dropdown-menu">\
              <li><a data-edit="fontSize 5"><font size="5">Huge</font></a></li>\
              <li><a data-edit="fontSize 3"><font size="3">Normal</font></a></li>\
              <li><a data-edit="fontSize 1"><font size="1">Small</font></a></li>\
              </ul>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="bold" title="Bold (Ctrl/Cmd+B)" data-original-title="Bold (Ctrl/Cmd+B)"><i class="icon-bold"></i></a>\
            <a class="btn" data-edit="italic" title="Italic (Ctrl/Cmd+I)" data-original-title="Italic (Ctrl/Cmd+I)"><i class="icon-italic"></i></a>\
            <a class="btn" data-edit="strikethrough" title="Strikethrough" data-original-title="Strikethrough"><i class="icon-strikethrough"></i></a>\
            <a class="btn" data-edit="underline" title="Underline (Ctrl/Cmd+U)" data-original-title="Underline (Ctrl/Cmd+U)"><i class="icon-underline"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="insertunorderedlist" title="Bullet list" data-original-title="Bullet list"><i class="icon-list-ul"></i></a>\
            <a class="btn" data-edit="insertorderedlist" title="Number list" data-original-title="Number list"><i class="icon-list-ol"></i></a>\
            <a class="btn" data-edit="outdent" title="Reduce indent" data-original-title="Reduce indent (Shift+Tab)"><i class="icon-indent-left"></i></a>\
            <a class="btn" data-edit="indent" title="Indent" data-original-title="Indent (Tab)"><i class="icon-indent-right"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="justifyleft" title="Align Left" data-original-title="Align Left (Ctrl/Cmd+L)"><i class="icon-align-left"></i></a>\
            <a class="btn" data-edit="justifycenter" title="Center" data-original-title="Center (Ctrl/Cmd+E)"><i class="icon-align-center"></i></a>\
            <a class="btn" data-edit="justifyright" title="Align Right" data-original-title="Align Right (Ctrl/Cmd+R)"><i class="icon-align-right"></i></a>\
            <a class="btn btn-info" data-edit="justifyfull" title="Justify" data-original-title="Justify (Ctrl/Cmd+J)"><i class="icon-align-justify"></i></a>\
          </div>\
          <div class="btn-group" style="display:none;">\
              <a class="btn dropdown-toggle" data-toggle="dropdown" title="Hyperlink" data-original-title="Hyperlink"><i class="icon-link"></i></a>\
                <div class="dropdown-menu input-append">\
                    <input class="span2" placeholder="URL" type="text" data-edit="createLink">\
                    <button class="btn" type="button">Add</button>\
            </div>\
            <a class="btn" data-edit="unlink" title="Remove Hyperlink" data-original-title="Remove Hyperlink"><i class="icon-cut"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" title="Insert picture" id="pictureBtn" data-original-title="Insert picture (or just drag &amp; drop)"><i class="icon-picture"></i></a>\
            <input type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage" style="opacity: 0; position: absolute; top: 0px; left: 0px; width: 41px; height: 30px;">\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="undo" title="Undo (Ctrl/Cmd+Z)" data-original-title="Undo (Ctrl/Cmd+Z)"><i class="icon-undo"></i></a>\
            <a class="btn" data-edit="redo" title="Redo (Ctrl/Cmd+Y)" data-original-title="Redo (Ctrl/Cmd+Y)"><i class="icon-repeat"></i></a>\
          </div>\
          <input type="text" data-edit="inserttext" id="voiceBtn" x-webkit-speech="" style="display: none;">\
        </div>';wysiwyg+=hasEditor?'<div id="editor" contenteditable="true" class="form-control gray-scrollbar">':'';wysiwyg+='</div>';return wysiwyg;};var getUrlParams=function(){var search=window.location.search.substring(1);var kvArr=search.split('&');var rs={};kvArr.forEach(function(kv){var arr=kv.split('=');if(typeof arr[1]!=='undefined'){rs[arr[0]]=arr[1];}});return rs;};﻿var WebAPI=(function(){var siteId;switch(window.location.hostname){case'beop.rnbtech.com.hk':siteId='b79c068f77198848e22fe79758836e53';break;case'beop6.rnbtech.com.hk':siteId='f1f6b2b9e6b64592c0b4cb5e9b8bd79e';break;case'beopdemo.rnbtech.com.hk':siteId='ac0df98f274d9a5980a571297248d80b';break;default:break;}
(function(){if(siteId){var hm=document.createElement("script");hm.src="//hm.baidu.com/hm.js?"+siteId;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);}})();var mockList={'/static/mock/analysis_workspace_saveLayout.json':/\/analysis\/workspace\/saveLayout\/\d+\/[01]/i,'/static/mock/analysis_template_get.json':/\/analysis\/template\/get\/\d+/i};function mock(url){var match=null;for(var i in mockList){match=url.match(mockList[i]);if(match!==null)return i;}
return url;}
function requestFailHandle(result){if(result&&result.status==401){alert(i18n_resource.error.noPermission);}}
function WebAPI(){}
WebAPI.isMock=false;$.ajaxSetup({converters:{"text json":true},dataFilter:function(result,type){var data=result;if(type==='script'){return data;}else if(typeof data==='string'){if(/^\s*</.test(data)){return data;}
try{data=JSON.parse(result);}catch(e){console.log('request error: '+e+', the data is :'+data);return data;}}
if(data){if(data.error){switch(data.error){case'token_invalid':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');confirm(i18n_resource.error.token[data.msg]+'. '+i18n_resource.error.relogin+'.',function(){location.href='/';});throw data.error;}
case'historyData':{console.log(this.url+' ('+data.error+': code"'+data.msg+'")');alert(data.msg);return{};}
default:break;}}
if(data.code==403){console.log(this.url+' ('+data.msg+'")');alert(I18n.resource.error.noPermission);return{};}}
return data;}});WebAPI.post=function(url,data,isMock){var mockUrl;isMock=isMock===undefined?WebAPI.isMock:isMock;if(isMock){mockUrl=mock(url);if(url!==mockUrl)return this.get(mockUrl,false);}
return $.ajax({url:url,type:'POST',data:JSON.stringify(data),contentType:'application/json'}).fail(requestFailHandle);};WebAPI.get=function(url,isMock){isMock=isMock===undefined?WebAPI.isMock:isMock;url=isMock?mock(url):url;if(window._hmt&&url.indexOf('.html')>0)window._hmt.push(['_trackPageview',url]);return $.ajax({url:url,type:'Get',contentType:'application/json'}).fail(requestFailHandle);};WebAPI.getHistoryDS=function(callback){};WebAPI.getHistory=function(callback){};WebAPI.ajaxForDebugTool=function(ajaxObj,host,dtuName,endpoint){var defaultUrl='http://'+host+'/'+endpoint+'/'+dtuName,defaultAjaxObj={url:defaultUrl,crossDomain:true,dataType:'json'},dfd,timer=10,intervalFlags,url,requestFlag='requestFlag='+new Date().getTime()+Math.ceil(Math.random()*100);$.extend(defaultAjaxObj,ajaxObj);url=defaultAjaxObj.url;if(url.indexOf('?')<0){requestFlag='?'+requestFlag}else{requestFlag='&'+requestFlag}
var userId=BEOPUtil.getCookie('userId');defaultAjaxObj.url+=requestFlag+'&userId='+userId;return $.ajax(defaultAjaxObj).then(function(result){dfd=$.Deferred();if(result.success){intervalFlags=setInterval(function(){if(timer<0){clearInterval(intervalFlags);return dfd.reject({success:false,msg:'no response from server'});}
$.ajax({type:'GET',url:'http://'+host+'/getCMDResponse/'+dtuName+requestFlag,crossDomain:true,dataType:'json'}).done(function(result){if(result.success){clearInterval(intervalFlags);return dfd.resolve(result);}}).always(function(){timer--;})},2000);}else{return dfd.reject(result);}
return dfd;});};return WebAPI;})();(function(){'use strict';var indexedDB=indexedDB||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(!indexedDB){return;}
function _initStorage(options){var _this=this;this._dbInfo=$.extend({db:null},options);var promise=$.Deferred();(function(){var _this=this;var dbInfo=this._dbInfo;var openreq=indexedDB.open(dbInfo.name,dbInfo.version);openreq.onerror=function(){promise.reject(openreq.error);};openreq.onsuccess=function(){dbInfo.db=openreq.result;promise.resolve();};openreq.onupgradeneeded=function(){var names=openreq.result.objectStoreNames;var length,key;var indexOf=([]).indexOf;if(indexOf.call(names,'cache')>-1){openreq.result.deleteObjectStore('cache');}
if(indexOf.call(names,'datasource')>-1){openreq.result.deleteObjectStore('datasource');}
if(indexOf.call(names,'thumbnail')>-1){openreq.result.deleteObjectStore('thumbnail');}
if(indexOf.call(names,'buffer')===-1){openreq.result.createObjectStore('buffer');}
openreq.result.createObjectStore('datasource');openreq.result.createObjectStore('thumbnail');for(var i=0,len=localStorage.length;i<len;i++){key=localStorage.key(i);if(key.indexOf('workSpacePicStorageEnable')===0){localStorage.removeItem(key);}}};}).call(this);}
function length(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.count();req.onsuccess=function(){promise.resolve(req.result);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.get(key);req.onsuccess=function(){var value=req.result;value=value===undefined?null:value;promise.resolve(value);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var result={};var promise=this.iterate(function(key,value,i){if(keyList.indexOf(key)>-1){result[key]=value;}}).then(function(){return result;},function(){console.warn('getItemList error!');});excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.put(value,key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();try{(function(){var _this=this;var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var result={};kvList.forEach(function(kv,i){var key=kv.key,value=kv.value;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
store.put(value,key);});transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=transaction.error;promise.reject(err);};}).call(this);}catch(e){console.warn('setItemList error!');promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.delete(key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;var request;if(!cursor){promise.resolve();return;}
if(keyList.indexOf(cursor.key)>-1){cursor.delete();}
cursor.continue();};req.onerror=function(err){promise.reject(err);};}).call(this);}catch(e){promise.reject();}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.clear();transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var advanced=false;req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(null);return;}
if(n===0){promise.resolve(cursor.key);}else{if(!advanced){advanced=true;cursor.advance(n);}else{promise.resolve(cursor.key);}}};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var keys=[];var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(keys);return;}
keys.push(cursor.key);cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var index=0;req.onsuccess=function(){var cursor=req.result;var result;if(!cursor){promise.resolve();return;}
result=iterator(cursor.key,cursor.value,index++);if(result===false){promise.resolve();return;}
cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var indexDBWrapper={_driver:'indexedDBWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.indexedDB=indexDBWrapper;}).call(this);(function($){'use strict';var localStorage;try{if(!this.localStorage||!('setItem'in this.localStorage)){return;}
localStorage=this.localStorage;}catch(e){return;}
function _initStorage(options){this._dbInfo=$.extend({},options);this._dbInfo.keyPrefix=this._dbInfo.name+'/';}
function length(callback){var _this=this;var promise=this.keys().then(function(keys){return keys.length;});excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var result;result=localStorage.getItem(this._dbInfo.keyPrefix+key);try{result=JSON.parse(result);}catch(e){}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var _this=this;var promise=$.Deferred();(function(){var result={};keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
result[key]=localStorage.getItem(_this._dbInfo.keyPrefix+key);try{result[key]=JSON.parse(result[key]);}catch(e){}});promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var _this=this;var result;try{try{value=JSON.stringify(value);}catch(e){}
result=localStorage.setItem(_this._dbInfo.keyPrefix+key,value);promise.resolve(result);}catch(e){result=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}
promise.reject(e);}}).call(this);excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();(function(){var _this=this;var result={};kvList.forEach(function(kv,i){var value;if(typeof kv.key!=='string'){console.warn('The key is not a string!');kv.key=String(kv.key);}
try{try{value=JSON.stringify(kv.value);}catch(e){value=kv.value;}
result[kv.key]=localStorage.setItem(_this._dbInfo.keyPrefix+kv.key,value);}catch(e){console.warn('occur error when set data into storage [key: "'+kv.key+'", value: "'+kv.value+'"]');result[kv.key]=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}}});promise.resolve();}).call(this);excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){localStorage.removeItem(this._dbInfo.keyPrefix+key);promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var _this=this;keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
localStorage.removeItem(_this._dbInfo.keyPrefix+key);});promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){localStorage.removeItem(key);}}
promise.resolve();}).call(this);}catch(e){proimse.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();(function(){var result;result=localStorage.key(n);if(result){result=result.substring(_this._dbInfo.keyPrefix.length);}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();(function(){var keyPrefix=this._dbInfo.keyPrefix;var length=localStorage.length;var keys=[],key;for(var i=0;i<length;i++){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){keys.push(key.substring(keyPrefix.length));}}
promise.resolve(keys);}).call(this);excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key,value;var result;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){value=localStorage.getItem(key);try{value=JSON.parse(value);}catch(e){}
result=iterator(key.substring(keyPrefix.length),value,i);}
if(result===false){break;}}
promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var localStorageWrapper={_driver:'localStorageWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.localStorage=localStorageWrapper;}).call(this,jQuery);(function($){function BaseCache(options){this.options=$.extend({},DEFAULTS,options);this.storage=Object.create(Beop.cache.drivers[this.options.driver]);this.init();}
BaseCache.prototype.init=function(){this.storage._initStorage(this.options);};BaseCache.prototype.length=function(){return this.storage.length();};BaseCache.prototype.key=function(n,callback){return this.storage.key(n,callback);};BaseCache.prototype.keys=function(callback){return this.storage.keys(callback);};BaseCache.prototype.getItem=function(key,callback){return this.storage.getItem(key,callback);};BaseCache.prototype.getItemList=function(keyList,callback){return this.storage.getItemList(keyList,callback);};BaseCache.prototype.setItem=function(key,value,callback){return this.storage.setItem(key,value,callback);};BaseCache.prototype.setItemList=function(kvList,callback){return this.storage.setItemList(kvList,callback);};BaseCache.prototype.removeItem=function(key,callback){return this.storage.removeItem(key,callback);};BaseCache.prototype.removeItemList=function(keyList,callback){return this.storage.removeItemList(keyList,callback);};BaseCache.prototype.clear=function(callback){return this.storage.clear(callback);};BaseCache.prototype.iterate=function(iterator,callback){return this.storage.iterate(iterator,callback);};var DEFAULTS={dbType:'localStorage',name:'beopcache',version:3};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.BaseCache=BaseCache;}).call(this,jQuery);﻿
var Internationalization=(function(){function Internationalization(lang,resource){this.type=lang||localStorage["language"];this.resource=resource||{};}
Internationalization.prototype={getResource:function(){return this.resource;},fillPage:function(){this.fill2($('[i18n]'));},fillArea:function(element){this.fill2(element.find('[i18n]'));try{Permission.check(element);}catch(e){console.log('check permission failed:'+e);}},fillAreaAttribute:function(element,attributeName){this.fill(element.find('[i18n]['+attributeName+']'),attributeName);},fill:function(arrElement,attributeName){for(var i=0,arrPath,text,len=arrElement.length;i<len;i++){arrPath=arrElement[i].attributes["i18n"].value.split('.');text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
if(!attributeName){arrElement[i].innerHTML=text;}
else{arrElement[i].setAttribute(attributeName,text);}}},getI18nValue:function(i18nKey){if(!i18nKey){return'';}
var arrPath=i18nKey.split('.');var text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
return text;},fill2:function(arrElement){for(var i=0,len=arrElement.length;i<len;i++){var i18nValue=arrElement[i].attributes["i18n"];var items=i18nValue.value.split(';'),item,attrMap;for(var j=0;j<items.length;j++){item=items[j];if(!item){continue;}
if(item.indexOf('=')===-1){i18nValue=this.getI18nValue(item);arrElement[i].innerHTML=i18nValue;}else{attrMap=item.split('=');if(!attrMap[0]){continue;}
arrElement[i].setAttribute(attrMap[0],this.getI18nValue(attrMap[1]));}}}},findContent:function(strPath){var arrPath=strPath.split('.');var text=this.resource;for(var i=0,len=arrPath.length;i<len;i++){text=text&&text[arrPath[i]];}
return text;}};return Internationalization;})();function InitI18nResource(strLanguage,isForce,filePath){if(!strLanguage){strLanguage=localStorage["isUserSelectedLanguage"]||navigator.language.split('-')[0];}
if(isForce){localStorage["isUserSelectedLanguage"]=strLanguage;}else if(localStorage["isUserSelectedLanguage"]){strLanguage=localStorage["isUserSelectedLanguage"];}
filePath=filePath||'/static/views/js/i18n/';return $.ajax({async:false,url:filePath+strLanguage+".js",dataType:"script"}).then(function(){localStorage["language"]=strLanguage;return i18n_resource;},function(){return $.ajax({async:false,url:filePath+"en.js",dataType:'script'}).then(function(){localStorage["language"]="en";return i18n_resource;},function(){console.warn('i18n files loading failed!');return{};});});}
var EventAdapter=(function(){var eventData,eventStatus;function EventAdapter($){}
EventAdapter.on=function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<3||arguments.length>5){console.log('EventAdapter.on arguments.length error');return;}
if(typeof arguments[0]!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}}
if(typeof arguments[1]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[1];}
if(typeof arguments[2]=='function'){eventFunction=arguments[2];eventSelector=null;eventHmt=arguments[3]}else if(typeof arguments[2]=='string'){if(arguments[3]&&typeof arguments[3]=='function'){eventSelector=arguments[2];eventFunction=arguments[3];eventHmt=arguments[4]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':eventTarget.on('touchstart',eventSelector,function(e){mobileDragStart.call(this,e,eventTarget,finalFunction)});break;case'dragover':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragOver.call(this,e,eventTarget,finalFunction)});break;case'dragleave':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragLeave.call(this,e,eventTarget,finalFunction)});break;case'drop':$(document).on('touchend.drop',eventSelector,function(e){mobileDrop.call(this,e,eventTarget,finalFunction)});break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;};EventAdapter.off=function(){if((arguments.length>3||arguments.length<1)||(arguments[0]&&typeof arguments[1]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}
if(arguments.length==1){eventTarget.off();return eventTarget;}
if(typeof arguments[1]=='string'){eventType=arguments[1]}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[2]=='string'){eventSelector=arguments[2];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;};$.fn.extend({'eventOn':function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;if(arguments.length<2||arguments.length>4){console.log('EventAdapter.on arguments.length error');return;}
if(typeof this!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(this instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=this;}}
if(typeof arguments[0]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[0];}
if(typeof arguments[1]=='function'){eventFunction=arguments[1];eventSelector=null;eventHmt=arguments[2]}else if(typeof arguments[1]=='string'){if(arguments[2]&&typeof arguments[2]=='function'){eventSelector=arguments[1];eventFunction=arguments[2];eventHmt=arguments[3]}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(!(eventHmt===false)){EventAdapter.analyse(e,eventType,eventHmt);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':mobileDragStart(eventTarget,eventSelector,finalFunction);break;case'dragover':mobileDragOver(eventTarget,eventSelector,finalFunction);break;case'dragleave':mobileDragLeave(eventTarget,eventSelector,finalFunction);break;case'drop':mobileDrop(eventTarget,eventSelector,finalFunction);break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;},'eventOff':function(){if((arguments.length>2)||(arguments[0]&&typeof arguments[0]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(this instanceof jQuery)){eventTarget=jQuery(this);}else{eventTarget=this;}
if(arguments.length==0){eventTarget.off();return eventTarget;}
if(typeof arguments[0]=='string'){eventType=arguments[0];}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[1]=='string'){eventSelector=arguments[1];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector,mobileDragStart);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;}});EventAdapter.setData=function(date){if(date==undefined)return;eventData=date;};EventAdapter.getData=function(){return eventData;};document.addEventListener('drop',function(){eventData=null;},false);document.addEventListener('touchend',function(){eventData=null;},false);EventAdapter.clearEvent=function(){$(document).off('touchmove.copy');$(document).off('touchmove.drag');$(document).off('touchend.drop');};EventAdapter.analyse=function(e,eventType,hmtInfo){var mainInfo='',initArrTag,finalArrTag,tag,unitTag;var target=$(e.currentTarget);if(hmtInfo instanceof Array&&hmtInfo[0]){mainInfo=judgeWay(hmtInfo[0]);initArrTag=hmtInfo.filter(function(ele,index){return index>0&&ele!='';});finalArrTag=[];for(var i=0;i<initArrTag.length;i++){unitTag=judgeWay(initArrTag[i]);if(unitTag=='')continue;finalArrTag.push(unitTag)}
tag=finalArrTag.join('-');}else{if(typeof hmtInfo=='string'){mainInfo=hmtInfo;}else{mainInfo=getInfo(target);}
mainInfo=mainInfo?mainInfo:'';tag=mainInfo;}
_hmt.push(['_trackEvent',mainInfo.substr(0,30),eventType,tag.substr(0,100)]);function getInfo(tar){if(tar.length==0)return;var tarInfo;if(tar.attr('id')){tarInfo=tar.attr('id');}else if(tar.attr('i18n')){tarInfo=tar.attr('i18n');}else if(tar.attr('title')){tarInfo=tar.attr('title');}else{tarInfo=tar[0].innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30);}
return tarInfo;}
function judgeWay(arg){if(typeof arg=='undefined'){return'';}
if(arg instanceof Function){return arg.call(this,e)}else if(typeof arg=='string'){if(arg=='text'){return e.currentTarget.innerText.replace(/^\s\s*/,'').replace(/\s\s*$/,'').substr(0,30)}else{return $(e.currentTarget).attr(arg)?$(e.currentTarget).attr(arg):arg;}}else if(typeof arg=='number'){return arg;}}};var mobileDragStart=function(e,target,eventFunction){var originalTarget=$(e.target).closest('[draggable="true"]')[0];var ev=e.type=='touchstart'?e.originalEvent.touches[0]:e,startPos={left:$(originalTarget).css('left'),top:$(originalTarget).css('top'),zIndex:$(originalTarget).css('z-index')},disX=originalTarget.offsetWidth/2,disY=originalTarget.offsetHeight/2;var $copyTarget=$(originalTarget).clone();$copyTarget.data('startPos',startPos);$copyTarget.css('z-index',10000);$copyTarget.css('position','absolute');$copyTarget.css('opacity','0.5');$copyTarget.css('pointer-events','none');var $container=$('body');$container.append($copyTarget);var sPos=$(originalTarget)[0].getBoundingClientRect();$copyTarget.css('left',sPos.left-$container[0].offsetLeft+'px');$copyTarget.css('top',sPos.top-$container[0].offsetTop+'px');$copyTarget[0].cssText=originalTarget.cssText;$copyTarget.css('width',originalTarget.offsetWidth);$copyTarget.css('height',originalTarget.offsetHeight);eventStatus='dragStart';eventFunction.call(this,ev);$(document).off('touchend.copy').on('touchend.copy',function(e){$copyTarget.remove();eventStatus='dragEnd';});$(document).on('touchmove.copy',function(e){eventStatus='dragMove';var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var $parent=$copyTarget.offsetParent();$parent=$parent.is(':root')?$(window):$parent;var targetLeft=ev.pageX-disX;var targetTop=ev.pageY-disY;$copyTarget.css({left:targetLeft+'px',top:targetTop+'px','z-index':10000});})};var mobileDragOver=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn'&&eventStatus!='dragMoveOut')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveIn';eventFunction.call(this,e);break;}}};var mobileDragLeave=function(e,target,eventFunction){if(eventStatus!='dragMoveIn')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(!((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY))){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveOut';eventFunction.call(this,e);}}};var mobileDragEnd=function(e,target,eventFunction){eventFunction.call(this,e);};var mobileDrop=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn')return;var ev=e.type=='touchend'?e.originalEvent.changedTouches[0]:e;var eventTarget=target;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventFunction.call(this,e);break;}}};return EventAdapter;})(jQuery);function QR8bitByte(data){this.mode=QRMode.MODE_8BIT_BYTE;this.data=data;}
QR8bitByte.prototype={getLength:function(buffer){return this.data.length;},write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8);}}};function QRCode(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=new Array();}
QRCode.prototype={addData:function(data){var newData=new QR8bitByte(data);this.dataList.push(newData);this.dataCache=null;},isDark:function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col){throw new Error(row+","+col);}
return this.modules[row][col];},getModuleCount:function(){return this.moduleCount;},make:function(){if(this.typeNumber<1){var typeNumber=1;for(typeNumber=1;typeNumber<40;typeNumber++){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,this.errorCorrectLevel);var buffer=new QRBitBuffer();var totalDataCount=0;for(var i=0;i<rsBlocks.length;i++){totalDataCount+=rsBlocks[i].dataCount;}
for(var i=0;i<this.dataList.length;i++){var data=this.dataList[i];buffer.put(data.mode,4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.mode,typeNumber));data.write(buffer);}
if(buffer.getLengthInBits()<=totalDataCount*8)
break;}
this.typeNumber=typeNumber;}
this.makeImpl(false,this.getBestMaskPattern());},makeImpl:function(test,maskPattern){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++){this.modules[row][col]=null;}}
this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupPositionAdjustPattern();this.setupTimingPattern();this.setupTypeInfo(test,maskPattern);if(this.typeNumber>=7){this.setupTypeNumber(test);}
if(this.dataCache==null){this.dataCache=QRCode.createData(this.typeNumber,this.errorCorrectLevel,this.dataList);}
this.mapData(this.dataCache,maskPattern);},setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)){this.modules[row+r][col+c]=true;}else{this.modules[row+r][col+c]=false;}}}},getBestMaskPattern:function(){var minLostPoint=0;var pattern=0;for(var i=0;i<8;i++){this.makeImpl(true,i);var lostPoint=QRUtil.getLostPoint(this);if(i==0||minLostPoint>lostPoint){minLostPoint=lostPoint;pattern=i;}}
return pattern;},createMovieClip:function(target_mc,instance_name,depth){var qr_mc=target_mc.createEmptyMovieClip(instance_name,depth);var cs=1;this.make();for(var row=0;row<this.modules.length;row++){var y=row*cs;for(var col=0;col<this.modules[row].length;col++){var x=col*cs;var dark=this.modules[row][col];if(dark){qr_mc.beginFill(0,100);qr_mc.moveTo(x,y);qr_mc.lineTo(x+cs,y);qr_mc.lineTo(x+cs,y+cs);qr_mc.lineTo(x,y+cs);qr_mc.endFill();}}}
return qr_mc;},setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++){if(this.modules[r][6]!=null){continue;}
this.modules[r][6]=(r%2==0);}
for(var c=8;c<this.moduleCount-8;c++){if(this.modules[6][c]!=null){continue;}
this.modules[6][c]=(c%2==0);}},setupPositionAdjustPattern:function(){var pos=QRUtil.getPatternPosition(this.typeNumber);for(var i=0;i<pos.length;i++){for(var j=0;j<pos.length;j++){var row=pos[i];var col=pos[j];if(this.modules[row][col]!=null){continue;}
for(var r=-2;r<=2;r++){for(var c=-2;c<=2;c++){if(r==-2||r==2||c==-2||c==2||(r==0&&c==0)){this.modules[row+r][col+c]=true;}else{this.modules[row+r][col+c]=false;}}}}}},setupTypeNumber:function(test){var bits=QRUtil.getBCHTypeNumber(this.typeNumber);for(var i=0;i<18;i++){var mod=(!test&&((bits>>i)&1)==1);this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=mod;}
for(var i=0;i<18;i++){var mod=(!test&&((bits>>i)&1)==1);this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=mod;}},setupTypeInfo:function(test,maskPattern){var data=(this.errorCorrectLevel<<3)|maskPattern;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var mod=(!test&&((bits>>i)&1)==1);if(i<6){this.modules[i][8]=mod;}else if(i<8){this.modules[i+1][8]=mod;}else{this.modules[this.moduleCount-15+i][8]=mod;}}
for(var i=0;i<15;i++){var mod=(!test&&((bits>>i)&1)==1);if(i<8){this.modules[8][this.moduleCount-i-1]=mod;}else if(i<9){this.modules[8][15-i-1+1]=mod;}else{this.modules[8][15-i-1]=mod;}}
this.modules[this.moduleCount-8][8]=(!test);},mapData:function(data,maskPattern){var inc=-1;var row=this.moduleCount-1;var bitIndex=7;var byteIndex=0;for(var col=this.moduleCount-1;col>0;col-=2){if(col==6)col--;while(true){for(var c=0;c<2;c++){if(this.modules[row][col-c]==null){var dark=false;if(byteIndex<data.length){dark=(((data[byteIndex]>>>bitIndex)&1)==1);}
var mask=QRUtil.getMask(maskPattern,row,col-c);if(mask){dark=!dark;}
this.modules[row][col-c]=dark;bitIndex--;if(bitIndex==-1){byteIndex++;bitIndex=7;}}}
row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break;}}}}};QRCode.PAD0=0xEC;QRCode.PAD1=0x11;QRCode.createData=function(typeNumber,errorCorrectLevel,dataList){var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel);var buffer=new QRBitBuffer();for(var i=0;i<dataList.length;i++){var data=dataList[i];buffer.put(data.mode,4);buffer.put(data.getLength(),QRUtil.getLengthInBits(data.mode,typeNumber));data.write(buffer);}
var totalDataCount=0;for(var i=0;i<rsBlocks.length;i++){totalDataCount+=rsBlocks[i].dataCount;}
if(buffer.getLengthInBits()>totalDataCount*8){throw new Error("code length overflow. ("
+buffer.getLengthInBits()
+">"
+totalDataCount*8
+")");}
if(buffer.getLengthInBits()+4<=totalDataCount*8){buffer.put(0,4);}
while(buffer.getLengthInBits()%8!=0){buffer.putBit(false);}
while(true){if(buffer.getLengthInBits()>=totalDataCount*8){break;}
buffer.put(QRCode.PAD0,8);if(buffer.getLengthInBits()>=totalDataCount*8){break;}
buffer.put(QRCode.PAD1,8);}
return QRCode.createBytes(buffer,rsBlocks);}
QRCode.createBytes=function(buffer,rsBlocks){var offset=0;var maxDcCount=0;var maxEcCount=0;var dcdata=new Array(rsBlocks.length);var ecdata=new Array(rsBlocks.length);for(var r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount;var ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount);maxEcCount=Math.max(maxEcCount,ecCount);dcdata[r]=new Array(dcCount);for(var i=0;i<dcdata[r].length;i++){dcdata[r][i]=0xff&buffer.buffer[i+offset];}
offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount);var rawPoly=new QRPolynomial(dcdata[r],rsPoly.getLength()-1);var modPoly=rawPoly.mod(rsPoly);ecdata[r]=new Array(rsPoly.getLength()-1);for(var i=0;i<ecdata[r].length;i++){var modIndex=i+modPoly.getLength()-ecdata[r].length;ecdata[r][i]=(modIndex>=0)?modPoly.get(modIndex):0;}}
var totalCodeCount=0;for(var i=0;i<rsBlocks.length;i++){totalCodeCount+=rsBlocks[i].totalCount;}
var data=new Array(totalCodeCount);var index=0;for(var i=0;i<maxDcCount;i++){for(var r=0;r<rsBlocks.length;r++){if(i<dcdata[r].length){data[index++]=dcdata[r][i];}}}
for(var i=0;i<maxEcCount;i++){for(var r=0;r<rsBlocks.length;r++){if(i<ecdata[r].length){data[index++]=ecdata[r][i];}}}
return data;}
var QRMode={MODE_NUMBER:1<<0,MODE_ALPHA_NUM:1<<1,MODE_8BIT_BYTE:1<<2,MODE_KANJI:1<<3};var QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1<<0),G18:(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1<<0),G15_MASK:(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1),getBCHTypeInfo:function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0){d^=(QRUtil.G15<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)));}
return((data<<10)|d)^QRUtil.G15_MASK;},getBCHTypeNumber:function(data){var d=data<<12;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0){d^=(QRUtil.G18<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)));}
return(data<<12)|d;},getBCHDigit:function(data){var digit=0;while(data!=0){digit++;data>>>=1;}
return digit;},getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber-1];},getMask:function(maskPattern,i,j){switch(maskPattern){case QRMaskPattern.PATTERN000:return(i+j)%2==0;case QRMaskPattern.PATTERN001:return i%2==0;case QRMaskPattern.PATTERN010:return j%3==0;case QRMaskPattern.PATTERN011:return(i+j)%3==0;case QRMaskPattern.PATTERN100:return(Math.floor(i/2)+Math.floor(j/3))%2==0;case QRMaskPattern.PATTERN101:return(i*j)%2+(i*j)%3==0;case QRMaskPattern.PATTERN110:return((i*j)%2+(i*j)%3)%2==0;case QRMaskPattern.PATTERN111:return((i*j)%3+(i+j)%2)%2==0;default:throw new Error("bad maskPattern:"+maskPattern);}},getErrorCorrectPolynomial:function(errorCorrectLength){var a=new QRPolynomial([1],0);for(var i=0;i<errorCorrectLength;i++){a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));}
return a;},getLengthInBits:function(mode,type){if(1<=type&&type<10){switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:return 8;case QRMode.MODE_KANJI:return 8;default:throw new Error("mode:"+mode);}}else if(type<27){switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw new Error("mode:"+mode);}}else if(type<41){switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw new Error("mode:"+mode);}}else{throw new Error("type:"+type);}},getLostPoint:function(qrCode){var moduleCount=qrCode.getModuleCount();var lostPoint=0;for(var row=0;row<moduleCount;row++){for(var col=0;col<moduleCount;col++){var sameCount=0;var dark=qrCode.isDark(row,col);for(var r=-1;r<=1;r++){if(row+r<0||moduleCount<=row+r){continue;}
for(var c=-1;c<=1;c++){if(col+c<0||moduleCount<=col+c){continue;}
if(r==0&&c==0){continue;}
if(dark==qrCode.isDark(row+r,col+c)){sameCount++;}}}
if(sameCount>5){lostPoint+=(3+sameCount-5);}}}
for(var row=0;row<moduleCount-1;row++){for(var col=0;col<moduleCount-1;col++){var count=0;if(qrCode.isDark(row,col))count++;if(qrCode.isDark(row+1,col))count++;if(qrCode.isDark(row,col+1))count++;if(qrCode.isDark(row+1,col+1))count++;if(count==0||count==4){lostPoint+=3;}}}
for(var row=0;row<moduleCount;row++){for(var col=0;col<moduleCount-6;col++){if(qrCode.isDark(row,col)&&!qrCode.isDark(row,col+1)&&qrCode.isDark(row,col+2)&&qrCode.isDark(row,col+3)&&qrCode.isDark(row,col+4)&&!qrCode.isDark(row,col+5)&&qrCode.isDark(row,col+6)){lostPoint+=40;}}}
for(var col=0;col<moduleCount;col++){for(var row=0;row<moduleCount-6;row++){if(qrCode.isDark(row,col)&&!qrCode.isDark(row+1,col)&&qrCode.isDark(row+2,col)&&qrCode.isDark(row+3,col)&&qrCode.isDark(row+4,col)&&!qrCode.isDark(row+5,col)&&qrCode.isDark(row+6,col)){lostPoint+=40;}}}
var darkCount=0;for(var col=0;col<moduleCount;col++){for(var row=0;row<moduleCount;row++){if(qrCode.isDark(row,col)){darkCount++;}}}
var ratio=Math.abs(100*darkCount/moduleCount/moduleCount-50)/5;lostPoint+=ratio*10;return lostPoint;}};var QRMath={glog:function(n){if(n<1){throw new Error("glog("+n+")");}
return QRMath.LOG_TABLE[n];},gexp:function(n){while(n<0){n+=255;}
while(n>=256){n-=255;}
return QRMath.EXP_TABLE[n];},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};for(var i=0;i<8;i++){QRMath.EXP_TABLE[i]=1<<i;}
for(var i=8;i<256;i++){QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];}
for(var i=0;i<255;i++){QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;}
function QRPolynomial(num,shift){if(num.length==undefined){throw new Error(num.length+"/"+shift);}
var offset=0;while(offset<num.length&&num[offset]==0){offset++;}
this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++){this.num[i]=num[i+offset];}}
QRPolynomial.prototype={get:function(index){return this.num[index];},getLength:function(){return this.num.length;},multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++){for(var j=0;j<e.getLength();j++){num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));}}
return new QRPolynomial(num,0);},mod:function(e){if(this.getLength()-e.getLength()<0){return this;}
var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++){num[i]=this.get(i);}
for(var i=0;i<e.getLength();i++){num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);}
return new QRPolynomial(num,0).mod(e);}};function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount;}
QRRSBlock.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]];QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){var rsBlock=QRRSBlock.getRsBlockTable(typeNumber,errorCorrectLevel);if(rsBlock==undefined){throw new Error("bad rs block @ typeNumber:"+typeNumber+"/errorCorrectLevel:"+errorCorrectLevel);}
var length=rsBlock.length/3;var list=new Array();for(var i=0;i<length;i++){var count=rsBlock[i*3+0];var totalCount=rsBlock[i*3+1];var dataCount=rsBlock[i*3+2];for(var j=0;j<count;j++){list.push(new QRRSBlock(totalCount,dataCount));}}
return list;}
QRRSBlock.getRsBlockTable=function(typeNumber,errorCorrectLevel){switch(errorCorrectLevel){case QRErrorCorrectLevel.L:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+0];case QRErrorCorrectLevel.M:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+1];case QRErrorCorrectLevel.Q:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+2];case QRErrorCorrectLevel.H:return QRRSBlock.RS_BLOCK_TABLE[(typeNumber-1)*4+3];default:return undefined;}}
function QRBitBuffer(){this.buffer=new Array();this.length=0;}
QRBitBuffer.prototype={get:function(index){var bufIndex=Math.floor(index/8);return((this.buffer[bufIndex]>>>(7-index%8))&1)==1;},put:function(num,length){for(var i=0;i<length;i++){this.putBit(((num>>>(length-i-1))&1)==1);}},getLengthInBits:function(){return this.length;},putBit:function(bit){var bufIndex=Math.floor(this.length/8);if(this.buffer.length<=bufIndex){this.buffer.push(0);}
if(bit){this.buffer[bufIndex]|=(0x80>>>(this.length%8));}
this.length++;}};(function($){$.fn.qrcode=function(options){if(typeof options==='string'){options={text:options};}
options=$.extend({},{render:"canvas",width:256,height:256,typeNumber:-1,correctLevel:QRErrorCorrectLevel.H,background:"#ffffff",foreground:"#000000"},options);var createCanvas=function(){var qrcode=new QRCode(options.typeNumber,options.correctLevel);qrcode.addData(options.text);qrcode.make();var canvas=document.createElement('canvas');canvas.width=options.width;canvas.height=options.height;var ctx=canvas.getContext('2d');var tileW=options.width/qrcode.getModuleCount();var tileH=options.height/qrcode.getModuleCount();for(var row=0;row<qrcode.getModuleCount();row++){for(var col=0;col<qrcode.getModuleCount();col++){ctx.fillStyle=qrcode.isDark(row,col)?options.foreground:options.background;var w=(Math.ceil((col+1)*tileW)-Math.floor(col*tileW));var h=(Math.ceil((row+1)*tileW)-Math.floor(row*tileW));ctx.fillRect(Math.round(col*tileW),Math.round(row*tileH),w,h);}}
return canvas;}
var createTable=function(){var qrcode=new QRCode(options.typeNumber,options.correctLevel);qrcode.addData(options.text);qrcode.make();var $table=$('<table></table>').css("width",options.width+"px").css("height",options.height+"px").css("border","0px").css("border-collapse","collapse").css('background-color',options.background);var tileW=options.width/qrcode.getModuleCount();var tileH=options.height/qrcode.getModuleCount();for(var row=0;row<qrcode.getModuleCount();row++){var $row=$('<tr></tr>').css('height',tileH+"px").appendTo($table);for(var col=0;col<qrcode.getModuleCount();col++){$('<td></td>').css('width',tileW+"px").css('background-color',qrcode.isDark(row,col)?options.foreground:options.background).appendTo($row);}}
return $table;}
return this.each(function(){var element=options.render=="canvas"?createCanvas():createTable();jQuery(element).appendTo(this);});};})(jQuery);var ElScreenContainer=document.getElementById('indexMain');var SpinnerContainer=document.getElementById('divSpinner');var AlertContainer=document.getElementById('divAlert');var ScreenCurrent=undefined;var ScreenPrevious=undefined;var Spinner=new LoadingSpinner({color:'#00FFFF'});var AppConfig={userId:undefined,account:undefined,isMobile:true,roomId:undefined};var roomAll=undefined;var curRoom=undefined;var spaceAll=undefined;var ctrAll=undefined;var sensorAll=undefined;var I18n=undefined;var BomConfig={};var appConfigManager=(function(){var DEFAULT_CONFIG={gps:0};function get(){var options=window.localStorage.getItem('appConfig');if(options===null){set(DEFAULT_CONFIG);return DEFAULT_CONFIG;}
try{options=JSON.parse(options);}catch(e){}
return options;}
function set(options){window.localStorage.setItem('appConfig',JSON.stringify(options));}
return{get:get,set:set}}());$(document).ready(function(){if(navigator.userAgent.match(/iP(ad|hone|od)|Android/i))AppConfig.isMobile=true;InitI18nResource(navigator.language.split('-')[0],null,'static/views/js/i18n/').always(function(rs){I18n=new Internationalization(null,rs);Init();});});document.addEventListener('deviceready',onDeviceReady,false);function onDeviceReady(){AppConfig.device=device;document.addEventListener("backbutton",router.back,false);document.addEventListener("offline",function(){window.plugins.toast.show('网络连接不可能，部分功能可能受影响','short','bottom');},false);document.addEventListener("online",function(){window.plugins.toast.show('网络已连接','short','bottom');},false);}
var IndexScreen=(function(){function IndexScreen(){}
IndexScreen.prototype={show:function(){var _this=this;_this.time=60;if(localStorage.getItem('beopHost')){AppConfig.host=localStorage.getItem('beopHost')}else{AppConfig.host='http://beop.rnbtech.com.hk'}
if(localStorage.getItem('userInfo')&&typeof JSON.parse(localStorage.userInfo).name!='undefined'&&JSON.parse(localStorage.userInfo).name!='undefined'){_this.initNav();_this.login(true);}else{_this.loginLoad();}
if(!BomConfig.height){BomConfig.height=$(window).height()+'px';}},loginLoad:function(){var _this=this;$.ajax({url:'static/app/temperatureControl/views/admin/login.html'}).done(function(resultHTML){$('#indexMain').empty().html(resultHTML);_this.init();$('#registerPerson').off('click').click(function(){WebAPI.get('/static/app/temperatureControl/views/admin/register.html').done(function(result){$('#indexMain').empty().html(result);_this.veriCode();});});});},close:function(){document.onkeydown=false;this.time=null;},init:function(){var _this=this;$(ElScreenContainer).css({'height':'100%','top':0});CssAdapter.adapter({bottom:false,top:false});_this.initNav();_this.initLogin();_this.initLanguage();},initLogin:function(){var _this=this;$("#btnLogin").hammer().off('tap').on('tap',function(e){_this.login();});$(document).on("keydown","#divLogin input",function(event){var e=event||window.event||arguments.callee.caller.arguments[0];if(e&&e.keyCode==13){_this.login();}});},veriResponse:function(dom,callback){var _this=this;if(_this.time==0){dom.html("<button id='repeatGetVeri'>重新获取</button>");_this.time=60;callback();}else{dom.html("<label>"+_this.time+"</label>s后重新发送");_this.time--;setTimeout(function(){_this.veriResponse(dom,callback);},1000)}},veriCode:function(){var _this=this;var $veriCode=$('#veriCode');$('#isAgree').change(function(){if($('#isAgree')[0].checked===true){$veriCode.removeAttr('disabled');}else{$veriCode.attr('disabled','disabled');}});$('.loginPerson').off('click').click(function(){_this.loginLoad();});$veriCode.off('click').click(function(){var mobileNum=$('#userNum').val();var reg=/^1[3|4|5|8][0-9]\d{4,8}$/;var $wrongInfo=$('#wrongInfo');if(mobileNum==""){new Alert($wrongInfo,"danger",'请填写手机号码！').show(1000).close();return;}
if(mobileNum.length!=11){new Alert($wrongInfo,"danger",'手机号码为11位数字！请正确填写！').show(1000).close();return;}
if(!reg.test(mobileNum)||isNaN(mobileNum)){new Alert($wrongInfo,"danger",'您的手机号码不正确，请重新输入！').show(1000).close();return;}
WebAPI.post('/user/checknewphone',{phone:mobileNum}).then(function(result){if(result.data===true){$('#vericodePage').hide();$('#passwordPage').show();_this.veriResponse($('.repeatGet'),repeatVeri);function repeatVeri(){$('#repeatGetVeri').off('click').click(function(){_this.veriResponse($('.repeatGet'),repeatVeri);WebAPI.post('/user/checknewphone',{phone:mobileNum}).then(function(result){})});}
$('#submitRegister').off('click').click(function(){var userVeriCode=$('#userVeriCode').val();var userPassword=$('#userPassword').val();var $wrongInfot=$('#wrongInfot');var sexSelectVal=$('#sexSelect').val();if(userVeriCode===''||userPassword===''){new Alert($wrongInfot,"danger",'请填写完整！').show(1000).close();return;}
if(userPassword.length<6){new Alert($wrongInfot,"danger",'请至少设置6位密码！').show(1000).close();return;}
WebAPI.post('/user/adduserbyphone',{phone:mobileNum,password:userPassword,code:userVeriCode,sex:sexSelectVal}).then(function(result){if(result.data===true){if(typeof cordova!='undefined'){cordova.plugins.barcodeScanner.scan(function(result){console.log("We got a barcode\n"+"Result: "+result.text+"\n"+"Format: "+result.format+"\n"+"Cancelled: "+result.cancelled);var postData={tokenId:result.text,userId:AppConfig.userId}
WebAPI.post('/appTemperature/token/corelateRoom',postData).done(function(){});},function(error){console.log("Scanning failed: "+error);});}else{}}else{new Alert($wrongInfot,"danger",'验证码错误，请重新输入！').show(1000).close();}})});}else{new Alert($wrongInfo,"danger",'手机号码已经注册，请登录！').show(1000).close();}});});},initLanguage:function(){I18n.fillArea($('#divAppDashboardLanguage'));I18n.fillArea($('#divLoginInfo'));$("#selectLanguage a").off('click').click(function(e){InitI18nResource(e.currentTarget.attributes.value.value,true).always(function(rs){I18n=new Internationalization(null,rs);Init();});e.preventDefault();});},login:function(isRestorePwd){var _this=this;SpinnerControl.show();var loginFail=function(msg){$('.alert').remove();new Alert($("#divAlert"),"danger",msg).show().close();SpinnerControl.hide();localStorage.removeItem('userInfo')
router.empty().to({typeClass:IndexScreen});};if(isRestorePwd){var userName=JSON.parse(localStorage.userInfo).name,password=JSON.parse(localStorage.userInfo).pwd;}else{var $btnLogin=$('#btnLogin');var userName=$("#userName").val(),password=$("#password").val();this.rememberPwd();if(!(userName||password)){loginFail('用户名密码不存在！');return;}}
WebAPI.post("/login",{name:userName,pwd:password,agent:jscd?jscd:{}}).then(function(login_result){try{var after_login=function(){CssAdapter.adapter({bottom:false});if(login_result.status!=undefined&&login_result.status==true){AppConfig.userId=login_result.id;AppConfig.account=$("#userName").val();router.empty().to({typeClass:ObserverScreen,data:{}});}else{loginFail("用户名或密码错误！");}}}catch(e){loginFail("登录失败！");return false;}
after_login();}).always(function(){Spinner.stop();})},rememberPwd:function(){localStorage["userInfo"]=JSON.stringify({name:$("#userName").val(),pwd:$("#password").val()});},restorePwd:function(){if(localStorage["userInfo"]){var data=JSON.parse(localStorage["userInfo"]);if(data.pwd&&data.pwd!=""){$("#userName").val(data.name);$("#password").val(data.pwd);}}},initNav:function(){$('#btnBack','#navTop').off('touchstart').on('touchstart',function(e){router.back();});$('#btnRoomSel','#navBottom').off('touchstart').on('touchstart',function(e){router.to({typeClass:ProjectSel});e.preventDefault();});}};return IndexScreen;})();function Init(){ScreenManager.show(IndexScreen);I18n.fillArea($("#navBottom"));}
var AdminConfigure=(function(){var _this;AdminConfigure.navOptions={top:'<span class="topNavTitle">设置</span>'};function AdminConfigure(){_this=this;}
AdminConfigure.prototype={show:function(){WebAPI.get('/static/app/temperatureControl/views/admin/adminConfigure.html').done(function(resultHTML){$('#indexMain').html(resultHTML);_this.init();});},init:function(){this.$container=$('#appConfig');this.$swGps=$('#swGps',this.$container);this.$optChkUpdate=$('#optChkUpdate',this.$container);_this.initNav();_this.initConfigStatus();_this.attachEvents();_this.initConfig();_this.initLogout();},initNav:function(){var $navTitle=$('.nav-title','#navTop');$navTitle.text('配置').show();},initConfigStatus:function(){var options=appConfigManager.get();var action;options.gps===1&&this.$swGps.addClass('on');},attachEvents:function(){var _this=this;$('.btn-switch',this.$container).hammer().off('tap').on('tap',function(e){var $this=$(this);var options=appConfigManager.get();var config={};$(this).toggleClass('on');if($this.hasClass('on')){config[$this[0].dataset['key']]=1;}else{config[$this[0].dataset['key']]=0;}
options=$.extend(false,options,config);appConfigManager.set(options);e.stopPropagation();e.preventDefault();});},initLogout:function(){$('#btnLogout').off('touchstart').on('touchstart',function(e){localStorage.clear('userInfo');router.empty().to({typeClass:IndexScreen})});},close:function(){},initConfig:function(){var $appConfig=$('#appConfig');$('#mSchedule',$appConfig).hammer().off('tap').on('tap',function(e){router.to({typeClass:Schedule});e.preventDefault();});if(curRoom&&curRoom.grade!==0){$('#mMode',$appConfig).removeClass('hidden').hammer().off('tap').on('tap',function(e){router.to({typeClass:Mode});e.preventDefault();});}
$('#mNews',$appConfig).hammer().off('tap').on('tap',function(e){router.to({typeClass:NewsCenter});e.preventDefault();});newsList();function newsList(){var $newsCount=$('#newsCount');var data=[];if(data&&data.length>0){$newsCount.text(data.length)}else{$newsCount.text('');}
router.newsList=data;}}};return AdminConfigure;})();var ProjectSel=(function(){var _this;var groupTpl='<div class="list-group">'+'<a class="list-group-item active">'+'<h4 class="list-group-item-heading">{buildingName}</h4>'+'</a>{itemsHtml}</div>';var groupItemTpl='<a href="javascript:;" class="list-group-item room-item" data-id="{roomId}">'+'<h4 class="list-group-item-heading">{roomName}</h4>'+'</a>';ProjectSel.navOptions={top:'<span id="roomName" class="topNavTitle">房间</span>',bottom:true};function ProjectSel(){_this=this;this.$qrcodePane=undefined;}
ProjectSel.prototype={show:function(){WebAPI.get('static/app/temperatureControl/views/admin/projectSel.html').done(function(resultHTML){$('#indexMain').html(resultHTML);_this.init();});},init:function(){this.$qrcodePane=$('#qrcodePane');_this.initRoom();_this.initRoomToggle();_this.attachEvents();},initRoom:function(){var room,checkbox,span,grade,label;var ctn=document.getElementById('projectSel');ctn.innerHTML='';if(!roomAll||roomAll.length==0){return;}
for(var i=0;i<roomAll.length;i++){room=document.createElement('div');room.className='divRoom';room.id=roomAll[i]["_id"];checkbox=document.createElement('input');checkbox.type='checkbox';checkbox.className='regular-checkbox';checkbox.id='ckRoom_'+room.id;if(roomAll[i].grade===0)checkbox.setAttribute('disabled',false);room.appendChild(checkbox);label=document.createElement('label');label.className='hidden';label.setAttribute('for',checkbox.id);room.appendChild(label);span=document.createElement('span');span.textContent=roomAll[i].name;span.className='name';room.appendChild(span);grade=document.createElement('span');if(roomAll[i].grade===30){grade.className='glyphicon glyphicon-king';}else if(roomAll[i].grade===20){grade.className='glyphicon glyphicon-queen';}else if(roomAll[i].grade===10){grade.className='glyphicon glyphicon-pawn';}
room.appendChild(grade);ctn.appendChild(room);}
if($(':checkbox:disabled').length==roomAll.length){$('#btnQrcode').hide();$('#btnEdit').hide();}},initRoomToggle:function(){var ctn=document.getElementById('projectSel');$(ctn).hammer().on('tap',function(e){if(e.gesture.changedPointers[0].target.tagName=='LABEL'||!$('#btnCancel').is(':hidden'))return;var $target=$(e.gesture.changedPointers[0].target).hasClass('divRoom')?$(e.gesture.changedPointers[0].target):$(e.gesture.changedPointers[0].target).parent();if($target.length==1){AppConfig.roomId=$target[0].id;router.to({typeClass:ObserverScreen})}})},attachEvents:function(){var $projectSel=$('#projectSel');var $btnEdit=$('#btnEdit');var $btnCancel=$('#btnCancel');var $btnAdd=$('#btnAdd');var $btnGenerate=$('#btnGenerate');var $btnQrcode=$('#btnQrcode');var $btnBackToRoomPane=$('#btnBackToRoomPane');var $inviteCodePane=$('#inviteCodePane');$btnEdit.hammer().off('tap').on('tap',function(){$(':checkbox:disabled').parent().addClass('disabled');$('.divRoom label').removeClass('hidden');$(this).hide().next('#btnCancel').show();$('#bottomBtns').removeClass('hidden');});$btnCancel.hammer().off('tap').on('tap',function(){$(':checkbox:disabled').parent().removeClass('disabled');$('.divRoom label').addClass('hidden');$(this).hide().prev('#btnEdit').show();$('#bottomBtns').addClass('hidden');});$btnGenerate.hammer().off('tap').on('tap',function(){var postData={'userId':AppConfig.userId,'elapse':14,'arrRoomIds':[]}
$('.divRoom input:checked').each(function(){var id=$(this).parent('.divRoom').attr('id');id&&postData.arrRoomIds.push(id);});WebAPI.post('/appTemperature/token/create',postData).done(function(result){_this.makeQrcode(result);})});$btnQrcode.hammer().off('tap').on('tap',function(){$projectSel.hide();_this.$qrcodePane.slideDown();_this.getTokenList();$btnEdit.hide();$btnQrcode.hide();$btnCancel.hide();$btnBackToRoomPane.show();$('.divRoom input').addClass('hidden');$('#bottomBtns').addClass('hidden');});$btnBackToRoomPane.hammer().off('tap').on('tap',function(){$btnEdit.show();$btnQrcode.show();$btnBackToRoomPane.hide();_this.$qrcodePane.hide();$projectSel.slideDown();});$btnAdd.off('touchstart').on('touchstart',function(){var $scanCode=$('#scanCode');var $inviteCode=$('#inviteCode');var $btnEdit=$('#btnEdit');var $btnCancel=$('#btnCancel');$scanCode.off('touchstart').on('touchstart',function(){if(typeof cordova!='undefined'){cordova.plugins.barcodeScanner.scan(function(result){console.log("We got a barcode\n"+"Result: "+result.text+"\n"+"Format: "+result.format+"\n"+"Cancelled: "+result.cancelled);relateRoom(result.text);},function(error){console.log("Scanning failed: "+error);});}else{}});$inviteCode.off('touchstart').on('touchstart',function(){$inviteCodePane.removeClass('hidden');$btnEdit.addClass('hidden');$btnCancel.addClass('hidden');$projectSel.addClass('hidden');$('#btnInviteCode').off('touchstart').on('touchstart',function(){relateRoom($('#iptInviteCode').val())});});function relateRoom(token){var postData={tokenId:token,userId:AppConfig.userId}
WebAPI.post('/appTemperature/token/corelateRoom',postData).done(function(result){window.plugins&&window.plugins.toast.show('关联成功'+result.text,'short','center');$projectSel.removeClass('hidden');$inviteCodePane.addClass('hidden');$btnEdit.removeClass('hidden');$btnCancel.removeClass('hidden');_this.getRoomList();});}});},makeQrcode:function(text){$('#qrcode').empty().qrcode({width:200,height:200,correctLevel:0,text:text});$('#qrcodeModal').modal();},getTokenList:function(){var tpl='<div class="itemQrcode" data-id={tokenId}><h4 class="token">{tokenId}</h4><div><span class="room">{roomIds}</span><span class="elapse">{elapse}失效</span></div></div>'
WebAPI.get('/appTemperature/token/getListByUserId').done(function(result){var strHtml='';if(!result.data||$.isEmptyObject(result.data))return;for(var i=0,token;i<result.data.length;i++){token=result.data[i];strHtml+=tpl.formatEL({tokenId:token._id,roomIds:(function(roomIds){var arr=[];if(!roomIds||roomIds.length==0)return;roomIds.forEach(function(id){for(var i=0;i<roomAll.length;i++){if(id==roomAll[i]._id){arr.push(roomAll[i].name);break;}}});return arr.join(',');})(token.arrRoomIds),elapse:DateUtil.getRelativeDateInfo(new Date(),new Date(new Date(token.time.replace(/\-/g,'/')).getTime()+86400000*parseInt(token.elapse)))});}
_this.$qrcodePane.html(strHtml);_this.attachEventsToken();})},attachEventsToken:function(){var start,disX;$('.itemQrcode',this.$qrcodePane).hammer().off('tap').on('tap',function(e){if(e.target.id=="btnRemoveQrcode")return;$('#btnRemoveQrcode').remove();_this.makeQrcode(this.dataset.id);e.stopPropagation();e.preventDefault();});var oUl=document.getElementById('qrcodePane');var sX=0;var sLeft=0;var curLeft=0;var disX=0;var $target=undefined;var $btnRemove=undefined;oUl.addEventListener('touchstart',touchstart,false);function touchstart(e){e.preventDefault();if(e.target.id=="btnRemoveQrcode")return;if(e.target.className=='itemQrcode'||$(e.target).closest('.itemQrcode').length==1){$target=e.target.className=='itemQrcode'?$(e.target):$(e.target).closest('.itemQrcode');sX=e.changedTouches[0].pageX;sLeft=$target[0].style.transform?-parseInt(/\d+/.exec($target[0].style.transform)[0]):0;oUl.style.transition='none';document.addEventListener('touchmove',touchmove,false);document.addEventListener('touchend',touchend,false);}}
function touchmove(e){disX=sX-e.changedTouches[0].pageX;if(disX<0)return;curLeft=sLeft-30;$target[0].style.transform='translateX('+curLeft+'px)';}
function touchend(e){if(disX>15){$('#btnRemoveQrcode').remove();$target.append('<button class="btn btn-danger" id="btnRemoveQrcode" style="position: absolute;right: -70px;top: 0;height: 100%;padding: 6px 20px;border-radius: 0;">删除</button>');$btnRemove=$('#btnRemoveQrcode');$btnRemove[0].style.transition='.5s';$btnRemove[0].style.transform='translateX(-70px)';$btnRemove.hammer().off('tap').on('tap',function(e){e.stopPropagation();e.preventDefault();$target.remove();WebAPI.get('/appTemperature/token/remove/'+$target[0].dataset.id).done(function(result){});});}
$target[0].style.transition='.5s';$target[0].style.transform='translateX(0px)';}},getRoomList:function(){WebAPI.get('/appTemperature/room/getlist/'+AppConfig.userId).done(function(rs){roomAll=rs.roomList;_this.initRoom();_this.initRoomToggle();});}};return ProjectSel;})();var HistoryChart=(function(){var _this;HistoryChart.navOptions={top:'<span class="topNavTitle">历史曲线</span>'};function HistoryChart(data){_this=this;this.data=data;}
HistoryChart.prototype={show:function(){var getHtml=WebAPI.get('/static/app/temperatureControl/views/observer/historyChart.html');getHtml.done(function(resultHtml){$('#indexMain').empty().html(resultHtml)
_this.getHistoryData();})},attachEvents:function(){},close:function(){},option:{color:['#2ec7c9','#b6a2de','#5ab1ef','#ffb980','#d87a80','#8d98b3','#e5cf0d','#97b552','#95706d','#dc69aa','#07a2a4','#9a7fd1','#588dd5','#f5994e','#c05050','#59678c','#c9ab00','#7eb00a','#6f5553','#c14089'],title:{textStyle:{fontWeight:'normal',color:'#008acd'}},legend:{textStyle:{fontFamily:"Microsoft YaHei"}},toolbox:{x:'right',y:'center',feature:{mark:{show:true},magicType:{show:true,type:['line','bar']},restore:{show:true},saveAsImage:{show:true}},color:['#1e90ff','#1e90ff','#1e90ff','#1e90ff'],effectiveColor:'#ff4500'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{color:'#008acd'},crossStyle:{color:'#008acd'},shadowStyle:{color:'rgba(200,200,200,0.2)'}}},dataZoom:{dataBackgroundColor:'#efefff',fillerColor:'rgba(182,162,222,0.2)',handleColor:'#008acd'},grid:(function(isMobile){var grid={borderWidth:0,borderColor:'#eee',x:70,y:38,x2:30,y2:24}
if(isMobile){grid.x=40;}
return grid;}(AppConfig.isMobile)),categoryAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitLine:{lineStyle:{color:['#eee']}}},valueAxis:{axisLine:{lineStyle:{color:'#008acd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']}},splitLine:{lineStyle:{color:['#eee']}}},bar:{itemStyle:{normal:{barBorderRadius:5},emphasis:{barBorderRadius:5}},barMaxWidth:80},line:{smooth:true,symbol:'none',symbolSize:3},textStyle:{fontFamily:'微软雅黑, Arial, Verdana, sans-serif'}},getHistoryData:function(){var now=new Date();var postData={dsItemIds:this.data.ids,timeEnd:now.format('yyyy-MM-dd HH:mm:ss'),timeFormat:"h1",timeStart:new Date(now.getTime()-86400000).format('yyyy-MM-dd HH:mm:ss')}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(result){var opt=_this.createOpt(result);echarts.init(document.getElementById('chartCtn')).setOption($.extend(_this.option,opt));});},createOpt:function(data){var opt={legend:{data:[]},xAxis:[{type:'category',boundaryGap:false,data:data.timeShaft}],yAxis:[{type:'value'}],series:[]}
for(var i=0,name;i<data.list.length;i++){name=data.list[i].dsItemId;opt.legend.data.push(name);opt.series.push({name:name,type:'line',smooth:true,data:data.list[i].data});}
return opt;}};return HistoryChart;})();var Controllers=(function(){var _this;function Controllers(){_this=this;this.init();}
Controllers.navOptions={top:'<span class="topNavTitle">控制器列表</span>'};Controllers.prototype={show:function(){WebAPI.get('/static/app/temperatureControl/views/admin/controllers.html').done(function(resultHtml){$('#indexMain').html(resultHtml);var $tableCtn=$('#tableCtn');router.controlles.showController({parent:$tableCtn});_this.attachPatchEvents();});},init:function(){var postData={dsItemIds:[]}
this.$indexMain=$('#indexMain');this.$wrapController=$('<div id="wrapController"></div>');for(var i=0;i<ctrAll.length;i++){for(var j in ctrAll[i].arrP){postData.dsItemIds.push(ctrAll[i].arrP[j]);}}
WebAPI.post('/analysis/startWorkspaceDataGenPieChart',postData).done(function(result){_this.render(ctrAll,result.dsItemList);});},render:function(ctrData,arrData){var strHtml='\
                <style>\
                    .list-unstyled .item{\
                        border-top: 1px solid #eee;\
                        padding: 10px 20px;\
                    }\
                    .list-unstyled .item .glyphicon{\
                        display: none;\
                    }\
                    .list-unstyled .item.selected .glyphicon{\
                        display: inline-block;\
                        color: #ff0000;\
                    }\
                </style>\
                <table class="table" id="tbController">\
                    <thead><tr><th class=""></th><th>名称</th><th>温度</th><th>风速</th><th>启停</th><th>季节模式</th><th>阀位</th><th>自动</th></tr></thead>\
                    <tbody></tbody>\
                </table>';var tpl='<tr data-id="{_id}"><td class=""><input type="checkbox" id="checkbox_{_id}" class="regular-checkbox"><label for="checkbox_{_id}"></label></td><td>{name}</td><td>{temp}</td><td>{speed}</td><td>{switch}</td><td>{sp}</td><td>{valueL}</td><td>{auto}</td></tr>'
this.$wrapController.append(strHtml);this.$indexMain.append(this.$wrapController);var $tbController=$('#tbController');var strTR='';for(var i=0,attr={};i<ctrData.length;i++){for(var j in ctrData[i].arrP){for(var k=0;k<arrData.length;k++){if(ctrData[i].arrP[j]==arrData[k].dsItemId){attr[j]=arrData[k].data;break;}}}
strTR+=tpl.formatEL({_id:ctrData[i]._id,name:ctrData[i].name?ctrData[i].name:'--',temp:attr.FCUTSet?attr.FCUTSet:'--',speed:attr.FCUSpeedDSet?attr.FCUSpeedDSet:'--',switch:attr.FCUOnOffSet==0?'停':'开',sp:attr.FCUSeasonMode==0?'制冷':'制热',valueL:attr.FCUValvePositionDSet?attr.FCUValvePositionDSet:'--',auto:attr.FCUAutoMode==0?'手动':'自动'})}
$tbController.find('tbody').html(strTR);},attachEvents:function(){var $tbController=$('#tbController')
$('input',$tbController).off('change').on('change',function(){var selectedLen=$('input:checked:not(#checkAll)',$tbController).length;if(selectedLen==$('input:not(#checkAll)',$tbController).length){$('#checkAll').prop('checked',true);}else{$('#checkAll').prop('checked',false);}});$('#checkAll').off('change').on('change',function(){if($(this).is(':checked')){$tbController.find('tr input').prop('checked',true);}else{$tbController.find('tr input').prop('checked',false);}});},close:function(){var $tbController=$('#tbController');this.$wrapController.hide();$tbController.find('tr input:checked').prop('checked',false);},showController:function(option){var $parent=this.$indexMain;if(option){if(option.parent)$parent=option.parent;if(option.style)this.$wrapController.attr('style',option.style);}
$parent.append(this.$wrapController);this.$wrapController.show();this.attachEvents();},boot:function(){var arrData=[];var $tbController=$('#tbController');$tbController.find('tbody tr input:checked').each(function(){var id=$(this).closest('tr').attr('data-id');if(!id)return;var data={_id:_this.device._id,prefix:_this.device.prefix,projectId:curRoom.projId,attrs:{}};data.attrs['FCUOnOffSet']=1;arrData.push(data);});if(arrData.length==0){return;}
this.patchSetController(arrData);},shutdown:function(){var arrData=[];var $tbController=$('#tbController');$tbController.find('tbody tr input:checked').each(function(){var id=$(this).closest('tr').attr('data-id');if(!id)return;var data={_id:_this.device._id,prefix:_this.device.prefix,projectId:curRoom.projId,attrs:{}};data.attrs['FCUOnOffSet']=1;arrData.push(data);});if(arrData.length==0){return;}
this.patchSetController(arrData);},attachPatchEvents:function(){$('#btnPatchBoot').off('touchstart').on('touchstart',function(){router.controlles.boot();});$('#btnPatchShut').off('touchstart').on('touchstart',function(){router.controlles.shutdown();});$('#btnPatchHist').off('touchstart').on('touchstart',function(){router.to({typeClass:HistoryChart,data:{ids:[]}})});},patchSetController:function(arrData){WebAPI.post('/appTemperature/setControllers',arrData).done(function(result){})}};return Controllers;})();var ObserverScreen=(function(){var _this;ObserverScreen.navOptions={top:'<span id="roomName" class="topNavTitle"></span>\
              <span class="topNavRight" id="btnConfig">\
                  <span class="glyphicon glyphicon-cog" aria-hidden="true"></span>\
              </span>',bottom:true,backDisable:false};function ObserverScreen(){_this=this;this.mapTool=undefined;this.mapConfig=undefined;this.tempHis=undefined;this.deviceSize={w:90,h:60};_this.mode=undefined;_this.dictClass=undefined;_this.workerUpdate=undefined;}
ObserverScreen.prototype={tplCtr:'\
                <div class="paneInfo paneInfo1">\
                    <div>\
                        <div class="divLabel">{deviceName}</div>\
                         <div class="divLabel"><span class="iconfont icon-medium icon-{FCUBattery}"></span></div>\
                        <div class="divLabel"><span class="iconfont icon-medium icon-{FCUSignalStrength}" style="margin-top: -5px;display: inline-block;"></span></div>\
                    </div>\
                    <div class="divItem"><span class="kaiguan">&#xe644;</span><span class="spanlabel">开关</span><div class="opt-btn{FCUOnOff}" id="btnSwitch" data-key=""><div class="btn-switch-slider"></div></div></div>\
                    <div class="divItem {FCUSpeedD}" id="divItemWs"><span class="fengsushezhi">&#xe647;</span><span class="spanlabel">风速</span><span id="spanWs">{FCUSpeedD}</span><span class="glyphicon glyphicon-menu-right" id="btnWs" style="color:#888;"></span></div>\
                    <div class="divItem {FCUAutoMode}" id=""><span class="glyphicon glyphicon-lamp" style="color:rgb(234, 193, 36);"></span><span class="spanlabel">手自动设定</span><span id="">{FCUAutoMode}</span></div>\
                    <div class="divItem {FCUSeasonMode}" id=""><span class="glyphicon glyphicon-grain"  style="color:rgb(92, 184, 92);"></span><span class="spanlabel">季节模式</span><span id="">{FCUSeasonMode}</span></div>\
                    <div class="divItem {FCUValvePositionD}" id=""><span class="glyphicon glyphicon-dashboard" style="color:#9199DA;"></span><span class="spanlabel">水阀开度</span><span id="">{FCUValvePositionD}</span></div>\
                    <div style="margin-top:8px;"><span class="btn btn-default" id="btnMatch">配对</span><span class="btn btn-default" id="btnHist">历史</span></div>\
                </div>\
                <div class="paneConfig"></div>',tplSensor:'\
                <div class="paneInfo paneInfo1">\
                    <div>\
                        <div class="divLabel">{deviceName}</div>\
                        <div class="divLabel"><span class="iconfont icon-{SensorBattery} icon-medium"></span></div>\
                        <div class="divLabel"><span class="iconfont icon-{SensorSignalStrength} icon-medium" style="margin-top: -5px;display: inline-block;"></span></div>\
                    </div>\
                    <div class="divItem {SensorT}" id=""><span class="iconfont icon-wenduchuanganqi icon-medium"  style="color:rgb(92, 184, 92);"></span><span class="spanlabel">温度</span><span id="">{SensorT}</span></div>\
                    <div class="divItem {SensorH}" id=""><span class="glyphicon glyphicon-tree-conifer" style="color:#9199DA;"></span><span class="spanlabel">湿度</span><span id="">{SensorH}</span></div>\
                    <div style="margin-top:8px;"><span class="btn btn-default" id="btnMatch">配对</span><span class="btn btn-default" id="btnHist">历史</span></div>\
                </div>\
                <div class="paneConfig"></div>',tplTemp:'\ <div class="paneInfo" style="position: relative; height: 100%;">\
                        <div class="shadow"></div>\
                        <div class="divTemp">\
                            <div id="btnSetTemp" class="li" style="position: relative;">\
                                <div class="a">\
                                    <div style="width: 100%; height: 100%; border: 1px dashed rgba(255, 255, 255, 0.5); border-radius: 50%;">\
                                        <div style="width: 9rem; height:7rem; margin: 0 auto 0 auto; padding-bottom: 0.5rem; border-bottom: 1.5px solid rgba(255, 255, 255, 0.40);">\
                                            <div style="width: 100%; height:100%; line-height: 9.8rem;">\
                                                <span id="spanTemp">{SensorT}</span><span>℃</span>\
                                            </div>\
                                        </div>\
                                        <div style="height: 5rem; line-height: 3rem;">\
                                            <span id="spanHumidity">{SensorH}</span><span>%</span>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>\
                        <span class="iconfont icon-fengsushezhi" id="btnSetWs" style="left: calc(15% - 1.7rem)"></span>\
                        <span style="position: absolute; width: 3.4rem; bottom: 1.6em; left: calc(15% - 1.7rem); text-align: center;">{FCUSpeedA}</span>\
                        <span class="iconfont icon-nvshi" id="btnSetMode" style="right: calc(15% - 1.7rem)"></span>\
                    </div>\
                    <div class="paneConfig"></div>',show:function(){WebAPI.get('/static/app/temperatureControl/views/observer/observerScreen.html').done(function(resultHTML){$('#indexMain').html(resultHTML).css('height',BomConfig.wrapHeight);$('#topBlank').hide();$('#containerMap').css({'top':'-'+BomConfig.topHeight,'padding-top':BomConfig.topHeight,'padding-bottom':'15rem'});_this.init();});},init:function(){WebAPI.get('/appTemperature/room/getlist/'+AppConfig.userId).done(function(rs){var findId,room;roomAll=rs.roomList;if(!roomAll||roomAll.length==0){window.plugins&&window.plugins.toast.show('请先关联房间');}
if(AppConfig.roomId===undefined){findId=localStorage.getItem('lastOpenRoomId');}else{findId=AppConfig.roomId;}
if(!!findId){room=(function(id){var roomList=roomAll;for(var i=0,len=roomList.length;i<len;i++){if(roomList[i]['_id']===id){return roomList[i];}}
return;}(findId));}
if(!room){room=roomAll[0];}
if(!!room){_this.mapConfig=room.params.map;curRoom=room;localStorage.setItem('lastOpenRoomId',room['_id']);AppConfig.roomId=room['_id'];}else{return;}
WebAPI.get('/iot/getClassFamily/thing/cn').done(function(result){_this.dictClass=result;_this.initNav();_this.initMap();_this.initMapTool();_this.initRoom();_this.initTempSet();_this.initToggle();_this.clickZindex()})}).fail(function(){});},initWorkerUpdate:function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);var pointList={dsItemIds:[]};for(var i=0;i<sensorAll.length;i++){for(var ele in sensorAll[i].arrP){pointList.dsItemIds.push(sensorAll[i].arrP[ele])}}
for(var i=0;i<ctrAll.length;i++){for(var ele in ctrAll[i].arrP){pointList.dsItemIds.push(ctrAll[i].arrP[ele])}}
this.workerUpdate.postMessage({pointList:pointList.dsItemIds,type:"datasourceRealtime"});},refreshData:function(e){console.log(e);var tar;if(!e.data.dsItemList||e.data.dsItemList.length==0)return;for(var i=0;i<e.data.dsItemList.length;i++){tar=document.getElementById(e.data.dsItemList[i].dsItemId);if(tar)tar.innerHTML=e.data.dsItemList[i].data+'℃'}},initNav:function(){if(typeof curRoom.name!='undefined'){$('#roomName').text(curRoom.name)}
$('#btnConfig').off('touchstart').on('touchstart',function(e){router.to({typeClass:AdminConfigure});e.preventDefault();});$('#btnBack','#navTop').off('touchstart').on('touchstart',function(e){router.to({typeClass:ProjectSel});e.preventDefault();});},initMap:function(){var strMap='<img id="imgMap" src="'+_this.mapConfig.img+'"/>';var divObserver=document.getElementById('divObserverMap');$('#containerMap').append(strMap).css({'height':'-webkit-calc('+_this.mapConfig.height+'px + '+BomConfig.topHeight+' + 15rem)','width':_this.mapConfig.width+'px'});var $locateTool=$('#btnLocate');var $spanLocateTool=$('#spanLocateIcon');this.mapConfig.offsetX=0;this.mapConfig.offsetY=0;this.mapConfig.scale=1;this.mapConfig.imgX=0;this.mapConfig.imgY=0;this.mapConfig.mapX=0;this.mapConfig.mapY=0;},initMapTool:function(){_this.mapTool=new ObserverMap(this);_this.mapTool.show();},initRoom:function(){WebAPI.get('/appTemperature/room/getDetail/'+curRoom['_id']).done(function(resultData){sensorAll=[];ctrAll=[];spaceAll=resultData.data.space;resultData.data.device.forEach(function(val){if(val.type.indexOf('Sensor')>-1){sensorAll.push(val)}else{ctrAll.push(val)}});var strSensorAttr=_this.getDeviceAttr('sensor');var strCtrAttr=_this.getDeviceAttr('ctr');_this.initEquipments('Sensor',sensorAll,'<span class="iconfont icon-wenduchuanganqi"></span><span class="spVal" id="<%tempId%>"></span>',strSensorAttr);_this.initEquipments('Ctr',ctrAll,'<span class="iconfont icon-fengjipaiguan"></span>',strCtrAttr);router.controlles=new Controllers();_this.initWorkerUpdate();$('#btnHistory').hammer().off('tap').on('tap',function(){router.to({typeClass:HistoryChart})});})},initTempSet:function(){var $tempChange=$('.tempChange');var $locateTool=$('#btnLocate');var $spanLocateTool=$('#spanLocateIcon');var $tempSetValue=$('#tempSetValue');var $btnTempSet=$('#btnTempSet');var mapX,mapY,interval,setValue;$tempChange.off('touchstart').on('touchstart',function(e){interval=1;setValue=Number($tempSetValue.html());if(e.currentTarget.id=='tempRaise'){setValue+=interval;$tempSetValue.html(setValue.toFixed(0));}else{setValue-=interval;$tempSetValue.html(setValue.toFixed(0));}});},getTempHist:function(){var postDate={gps:[]};var pos=_this.mapTool.getRealPos();var spaceId=_this.mapTool.getSpace();for(var i in pos){postDate.gps.push(pos[i]);}
if(!spaceId||spaceId=='room')spaceId=curRoom._id;postDate.spaceId=spaceId;WebAPI.post('/appTemperature/location/getInfo',postDate).done(function(result){_this.tempHis=result;return;_this.initTempHis();});},initTempHis:function(){if(_this.tempHis&&_this.tempHis.list){$('.divHis').remove();var divHis,spName,spVal,pos;var ctn=document.getElementById('containerMap');for(var i=0;i<_this.tempHis.list.length;i++){divHis=document.createElement('div');divHis.className='divHis divUnit';divHis.dataset.userId=_this.tempHis.list[i].userId;spName=document.createElement('span');spName.className='spUserName';spName.textContent=_this.tempHis.list[i].name;spVal=document.createElement('span');spVal.className='spHisVal';spVal.textContent=_this.tempHis.list[i].temp;pos=_this.mapTool.getScreenPos({x:_this.tempHis.list[i].gps[0],y:_this.tempHis.list[i].gps[1]});divHis.style.left=pos.x+'px';divHis.style.top=pos.y+'px';divHis.appendChild(spName);divHis.appendChild(spVal);ctn.appendChild(divHis);}}},initEquipments:function(type,list,strIcon,strAttr){var ctn=document.getElementById('containerMap');var divEquip,spIcon,spAttr,strTemp;for(var i=0;i<list.length;i++){divEquip=document.createElement('div');divEquip.className='divUnit divEquip div'+type;divEquip.id=list[i]['_id'];divEquip.dataset.type=type.toLocaleLowerCase();spIcon=document.createElement('div');spIcon.className='spIcon';if(spIcon){if(list[i].arrP['SensorT']){strTemp=strIcon.replace('<%tempId%>',list[i].arrP['SensorT'])}else{strTemp=strIcon.replace('<%tempId%>','')}
spIcon.innerHTML=strTemp}
spAttr=document.createElement('span');spAttr.className=' spAttr';if(spAttr){spAttr.innerHTML=strAttr}
divEquip.appendChild(spIcon);divEquip.appendChild(spAttr);switch(type){case'Sensor':divEquip.style.left=list[i].params.gps[0]-_this.deviceSize.w/2+'px';divEquip.style.top=list[i].params.gps[1]-_this.deviceSize.h/2+_this.mapTool.mapScreenTop+'px';break;case'Ctr':divEquip.style.left=list[i].params.gps[0]-_this.deviceSize.w/2+'px';divEquip.style.top=list[i].params.gps[1]-_this.deviceSize.h/2+_this.mapTool.mapScreenTop+'px';break;}
$(divEquip).hammer().on('tap',function(e){_this.initEquipDetail(e.currentTarget.id,e.currentTarget.dataset.type);});ctn.appendChild(divEquip);}
_this.clickZindex();},initEquipDetail:function(id,type,gps){var $divTemperature=$('#divTemperature');var tpl=undefined;this.device=undefined;$divTemperature.show();_this.mapTool.mapConfig.mapScreenBottom=$divTemperature[0].offsetHeight;if(this.mode=="device"&&type=='ctr'){if(ctrAll&&ctrAll.length>0){for(var i=0;i<ctrAll.length;i++){if(id==ctrAll[i]._id){this.device=ctrAll[i];break;}}}}else{if(sensorAll&&sensorAll.length>0){for(var i=0;i<sensorAll.length;i++){if(id==sensorAll[i]._id){this.device=sensorAll[i];break;}}}}
if(!this.device)return;if(this.device.arrP&&!$.isEmptyObject(this.device.arrP)){_this.getArrPRealtimeData(this.device).done(function(result){var objTpl;var data=_this.getarrPValById(result.dsItemList);if(_this.mode=="temp"){$divTemperature.html(tpl.formatEL({SensorH:data['SensorH']?data['SensorH']:'39',SensorT:data['SensorT']?parseFloat(data['SensorT']).toFixed(1):'--',FCUSpeedA:data['FCUSpeedA']?data['FCUSpeedA']:'--',mode:'女士优先'}));_this.attachEventsTemp(gps);}else{if(_this.device.type.indexOf('Controller')>-1){objTpl=_this.getCtrInfoByData(data);}else{objTpl=_this.getTempInfoByData(data);}
$divTemperature.html(tpl.formatEL(objTpl));_this.attachEventsDevice();}});}
if(this.mode=="device"){if(type=='sensor'){tpl=this.tplSensor;$divTemperature.html(tpl.formatEL({deviceName:'--',SensorBattery:'--',SensorH:'--',SensorSignalStrength:'--',SensorT:'--'}));}else{tpl=this.tplCtr;$divTemperature.html(tpl.formatEL({deviceName:'--',FCUAutoMode:'--',FCUBattery:'--',FCUOnOff:' btn-switch-on',FCUSeasonMode:'--',FCUSignalStrength:'--',FCUSpeedD:'--',FCUValvePositionD:'--'}));}}else if(this.mode=="temp"){tpl=this.tplTemp;$divTemperature.html(tpl.formatEL({SensorH:'--',SensorT:'--',FCUSpeedA:'--',mode:0}));}},getDeviceAttr:function(type){var spBattery='<span class="spBattery iconfont icon-dianliangtiaoman"></span>';var spAttr='<span class="spBatteryVal " >-</span>';var spNet='<span class="spNet iconfont icon-xinhaoman"></span>';return spBattery+spAttr+spNet;},clickZindex:function(){var $divUnit=$('.divUnit');$divUnit.on('touchstart',function(){$divUnit.removeClass("selected");$(this).addClass("selected");})},initToggle:function(){var $btnMode=$('.btnMode');var $btnShowTable=$('#btnShowTable');var $btnDevice=$('#btnDeviceMode');var $btnTemp=$('#btnTempMode');var $btnHistory=$('#btnHistory');var $ctnScreen=$('#divObserverMap');$btnMode.on('touchstart',function(e){if(!$(e.currentTarget).hasClass('selected')){$btnMode.removeClass('selected');$(e.currentTarget).addClass('selected');if($(e.currentTarget)[0].id=='btnTempMode'){$ctnScreen.removeClass('deviceMode').addClass('tempMode');$('.divSensor').addClass('tempMode');$('.divCtr').css('display','none');$btnShowTable.hide();router.controlles&&router.controlles.close();$($btnShowTable).addClass('notShow');_this.mode='temp';}else{$ctnScreen.removeClass('tempMode').addClass('deviceMode');$('.divSensor').removeClass('tempMode');$('.divCtr').css('display','block');$btnShowTable.show();$btnShowTable.hammer().off('tap').on('tap',function(){router.to({typeClass:Controllers});});_this.mode='device'}}});$btnTemp.trigger('touchstart');if(curRoom&&curRoom.grade===0)$btnDevice.hide();},attachEventsDevice:function(){var $btnSwitch=$('#btnSwitch');var $divItemWs=$('#divItemWs');var $btnMatch=$('#btnMatch');var $btnHist=$('#btnHist');var $paneInfo=$('.paneInfo');var $paneConfig=$('.paneConfig');$btnSwitch.off('touchend').on('touchend',function(){var postData=[{_id:_this.device._id,prefix:_this.device.prefix,projectId:curRoom.projId,attrs:{}}];if($(this).hasClass('btn-switch-on')){$(this).removeClass('btn-switch-on').addClass('btn-switch-off');postData[0].attrs['FCUOnOffSet']=0;}else{$(this).removeClass('btn-switch-off').addClass('btn-switch-on');postData[0].attrs['FCUOnOffSet']=1;}
Spinner.spin($('#divTemperature')[0]);_this.setControllers(postData).done(function(result){WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:[_this.device.arrP['FCUOnOff']]}).done(function(result){if(result&&result.dsItemList&&result.dsItemList.length==1){if(result.dsItemList[0].data==0){$btnSwitch.removeClass('btn-switch-on').addClass('btn-switch-off');}else{$btnSwitch.removeClass('btn-switch-off').addClass('btn-switch-on');}}}).always(function(){Spinner.stop();});});});$divItemWs.off('touchstart').on('touchstart',function(){var $spanWs=$('#spanWs');$paneInfo.hide();var tpl='\
                <div class="divBtnBottom"><button class="btn btn-default" id="btnCancel">取消</button><button class="btn btn-success" id="btnSave">确定</button></div>\
                <span id="spanWsVal" style="margin-left: 20px;text-align:center;">{wsVal}</span>\
                <input type="range" id="iptWsVal" min="1" max="5" step="1" value="{wsVal}"/>\
                    ';var wsVal=$spanWs.text();$paneConfig.html(tpl.formatEL({wsVal:wsVal}));var $iptWsVal=$('#iptWsVal');$iptWsVal.off('change').on('change',function(){$('#spanWsVal').text(this.value);});$('#btnSave').off('touchend').on('touchend',function(){if(parseFloat($iptWsVal.val())==parseFloat(wsVal))return;var postData=[{_id:_this.device._id,prefix:_this.device.prefix,projectId:curRoom.projId,attrs:{}}];postData[0].attrs['FCUSpeedDSet']=parseFloat($iptWsVal.val());$spanWs.text($iptWsVal.val());Spinner.spin($('#divTemperature')[0]);_this.setControllers(postData).done(function(result){WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:[_this.device.arrP['FCUSpeedD']]}).done(function(result){if(result&&result.dsItemList&&result.dsItemList.length==1){$spanWs.text(result.dsItemList[0].data);}}).always(function(){Spinner.stop();});});$paneConfig.empty();$paneInfo.show();});$('#btnCancel').off('touchend').on('touchend',function(){$paneConfig.empty();$paneInfo.show();});});$btnMatch.off('touchend').on('touchend',function(){if(typeof cordova!='undefined'){cordova.plugins.barcodeScanner.scan(function(result){console.log("We got a barcode\n"+"Result: "+result.text+"\n"+"Format: "+result.format+"\n"+"Cancelled: "+result.cancelled);_this.device.params.gateway=result.text;WebAPI.post('setIotInfo',_this.device).done(function(){window.plugins.toast.show('关联成功，网关为'+result.text,'short','center');});},function(error){console.log("Scanning failed: "+error);});}else{}});$btnHist.off('touchend').on('touchend',function(){router.to({typeClass:HistoryChart,data:{ids:[_this.device.arrP.SensorT]}})});},attachEventsTemp:function(gps){var $btnSetWs=$('#btnSetWs');var $btnSetMode=$('#btnSetMode');var $btnSetTemp=$('#btnSetTemp');var $paneInfo=$('.paneInfo');var $paneConfig=$('.paneConfig');var tplTempWs='\
                    <div class="divBtnBottom"><button class="btn btn-default" id="btnCancel">取消</button><button class="btn btn-success" id="btnSave">确定</button></div>\
                    <div class="divSetItem">\
                        <label id="spanTempVal" for="iptTempVal" style="">温度</label>\
                        <div style="display: inline-block;text-align: center;width: calc(100% - 70px);">\
                            <span class="glyphicon glyphicon-minus" id="btnMinusTemp"></span><span id="iptTempVal">{tempVal}</span><span class="glyphicon glyphicon-plus" id="btnPlusTemp"></span>\
                        </div>\
                    </div>\
                    <div class="divSetItem">\
                        <label for="iptWsVal">风速</label>\
                        <input type="range" id="iptWsVal" min="1" max="5" step="1" value="{wsVal}" style="display: inline-block;width: calc(100% - 60px);margin-left: 20px;"/>\
                    </div>\
                    ';$btnSetWs.off('touchstart').on('touchstart',function(){_this.getTempHist();$paneInfo.hide();var wsVal=$(this).next('span').text();var tempVal=$('#spanTemp').text().split('℃')[0];$paneConfig.html(tplTempWs.formatEL({wsVal:wsVal,tempVal:tempVal}));var $iptWsVal=$('#iptWsVal');var $iptTempVal=$('#iptTempVal');$iptWsVal.off('change').on('change',function(){$('#spanWsVal').text(this.value);});$('#btnSave').off('touchend').on('touchend',function(){var postData={prefix:_this.deviceCtr.prefix,projectId:curRoom.projId,attrs:{},controllerId:_this.device._id,roomId:curRoom._id,spaceId:_this.mapTool.getSpace(),gps:gps,userId:AppConfig.userId};var isNeedSave=false;if(parseFloat(wsVal)!=parseFloat($iptWsVal.val())){postData.attrs['FCUSpeedDSet']=parseFloat($iptWsVal.val());isNeedSave=true;}
if(parseFloat(tempVal)!=parseFloat($iptTempVal.text())){postData.attrs['FCUTSet']=parseFloat($iptTempVal.text());isNeedSave=true;}
if(!isNeedSave)return;_this.setTemp(postData);$paneConfig.empty();$paneInfo.show();});$('#btnCancel').off('touchend').on('touchend',function(){$paneConfig.empty();$paneInfo.show();});$('#btnPlusTemp').off('touchend').on('touchend',function(){var tempVal=parseFloat($iptTempVal.text());if(tempVal<40){$iptTempVal.text(Math.floor(tempVal)+1);}});$('#btnMinusTemp').off('touchend').on('touchend',function(){var tempVal=parseFloat($iptTempVal.text());if(tempVal>0){$iptTempVal.text(Math.ceil(tempVal)-1);}});});$btnSetMode.off('touchstart').on('touchstart',function(){$paneInfo.hide();var tpl='\
                    <div id="divModeList">\
                        <button class="btn btn-default" id="btnLadies">女士优先</button>\
                        <button class="btn btn-default" id="btnComfortable">舒适模式</button>\
                        <button class="btn btn-default" id="btnEnergySave">节能模式</button>\
                    </div>\
                    <div class="divBtnBottom"><button class="btn btn-default" id="btnCancel">取消</button><button class="btn btn-success" id="btnSave">确定</button></div>';$paneConfig.html(tpl.formatEL({wsVal:60}));$('#divModeList .btn').off('touchend').on('touchend',function(){$(this).addClass('btn-success').siblings('.btn').removeClass('btn-success');});$('#btnSave').off('touchend').on('touchend',function(){$paneConfig.empty();$paneInfo.show();});$('#btnCancel').off('touchend').on('touchend',function(){$paneConfig.empty();$paneInfo.show();});});$btnSetTemp.off('touchstart').on('touchstart',function(){$btnSetWs.trigger('touchstart');});},getArrPRealtimeData:function(device){var arrId=[];for(var i in device.arrP){arrId.push(device.arrP[i]);}
if(this.mode=='temp'&&this.device.params.cId){for(var j=0;j<ctrAll.length;j++){if(this.device.params.cId==ctrAll[j]._id){this.deviceCtr=ctrAll[j];for(var i in ctrAll[j].arrP){arrId.push(ctrAll[j].arrP[i]);}
break;}}}
if(arrId.length==0)return;return WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{dsItemIds:arrId});},getarrPValById:function(arrData){var arrPVal={}
for(var j in this.device.arrP){for(var i=0;i<arrData.length;i++){if(arrData[i].dsItemId==this.device.arrP[j]){arrPVal[j]=arrData[i].data;break;}}}
if(this.mode=='temp'){for(var j in this.deviceCtr.arrP){for(var i=0;i<arrData.length;i++){if(arrData[i].dsItemId==this.deviceCtr.arrP[j]){arrPVal[j]=arrData[i].data;break;}}}}
return arrPVal;},setControllers:function(arrData){return WebAPI.post('/appTemperature/setControllers',arrData);},setTemp:function(data){WebAPI.post('/appTemperature/temp/set',data).done(function(result){})},getCtrInfoByData:function(data){var objTpl={FCUAutoMode:'--',FCUBattery:'--',FCUOnOff:' btn-switch-on',FCUSeasonMode:'--',FCUSignalStrength:'--',FCUSpeedD:'--',FCUValvePositionD:'--'}
for(var i in objTpl){if(i==='FCUOnOff'){objTpl[i]=data[i]!=0?' btn-switch-on':' btn-switch-off'}else if(i==='FCUBattery'){var className='dianliangtiaoman';var battery=parseFloat(data[i]);if(battery>90){className='dianliangtiaoman';}else if(battery>50){className='dianliangtiao3';}else if(battery>25){className='dianliangtiao2';}else if(battery>10){className='dianliangtiao1';}
objTpl[i]=className;}else if(i==='FCUSignalStrength'){var className='xinhaoman';var signal=parseFloat(data[i]);if(signal>90){className='xinhaoman';}else if(signal>50){className='xinhao3';}else if(signal>25){className='xinhao2';}else if(signal>10){className='xinhao1';}
objTpl[i]=className;}else if(i==='FCUSeasonMode'){if(data[i]==0){objTpl[i]='制冷';}else if(data[i]==1){objTpl[i]='制热';}else{objTpl[i]=' hidden';}}else if(i==='FCUAutoMode'){if(data[i]==0){objTpl[i]='手动';}else if(data[i]==1){objTpl[i]='自动';}else{objTpl[i]=' hidden';}}else{objTpl[i]=data[i]?data[i]:' hidden';}}
objTpl.deviceName=_this.device.name;return objTpl;},getTempInfoByData:function(data){var objTpl={SensorBattery:'--',SensorH:'--',SensorSignalStrength:'--',SensorT:'--'};for(var i in objTpl){if(i==='SensorBattery'){var className='dianliangtiaoman';var battery=parseFloat(data[i]);if(battery>90){className='dianliangtiaoman';}else if(battery>50){className='dianliangtiao3';}else if(battery>25){className='dianliangtiao2';}else if(battery>10){className='dianliangtiao1';}
objTpl[i]=className;}else if(i==='SensorSignalStrength'){var className='xinhaoman';var signal=parseFloat(data[i]);if(signal>90){className='xinhaoman';}else if(signal>50){className='xinhao3';}else if(signal>25){className='xinhao2';}else if(signal>10){className='xinhao1';}
objTpl[i]=className;}else{objTpl[i]=data[i]?data[i]:' hidden';}}
objTpl.deviceName=_this.device.name;return objTpl;},close:function(){if(this.workerUpdate)this.workerUpdate.terminate();$(ElScreenContainer).css('height',BomConfig.mainHeight);$('#topBlank').show();$('#btnBack','#navTop').off('touchstart').on('touchstart',function(e){router.back();});}};return ObserverScreen;})();var ObserverMap=(function(){var _this;function getOffsetSum(ele){var top=0,left=0;while(ele){top+=ele.offsetTop;left+=ele.offsetLeft;ele=ele.offsetParent;}
return{top:top,left:left}}
function ObserverMap(page){_this=this;this.page=page;this.mapMoveRate=15;this.mapConfig=page.mapConfig;this.mapScreenTop=getOffsetSum($('#divObserverMap')[0]).top+parseFloat(BomConfig.topHeight);this.mapEvent=new Hammer(document.getElementById('mapBg'));this.lastScale=1;this.mapScreenBottom=document.getElementById('divTemperature').offsetHeight;}
ObserverMap.prototype={show:function(){_this.init();},init:function(){_this.initLocate();_this.initMapResize();_this.initMapRelocate();},initMapRelocate:function(){var $btnRelocate=$('#btnRelocate');var $map=$('#divObserverMap');var divMapHeight=$map[0].offsetHeight;var divMapWidth=$map[0].offsetWidth;var $containerMap=$('#containerMap');$btnRelocate.off('touchstart').on('touchstart',function(e){_this.mapConfig.offsetX-=(_this.mapConfig.imgX+_this.mapConfig.offsetX)-divMapWidth/2;_this.mapConfig.offsetY-=(_this.mapConfig.imgY+_this.mapConfig.offsetY)-divMapHeight/2;_this.offsetAdjust();$containerMap.css({left:_this.mapConfig.offsetX,top:_this.mapConfig.offsetY-_this.mapScreenTop});});},initMapResize:function(){var $btnSizeUp=$('#btnSizeUp');var $btnSizeDown=$('#btnSizeDown');var $imgMap=$('#imgMap');var $containerMap=$('#containerMap');var $locateTool=$('#btnLocate');var $spanLocateTool=$('#spanLocateIcon');var $map=$('#divObserverMap');var divMapHeight=$map[0].offsetHeight;var divMapWidth=$map[0].offsetWidth;$imgMap[0].onload=function(e){var minXScale=Math.ceil(10*divMapWidth/_this.mapConfig.width)/10;var minYScale=Math.ceil(10*divMapHeight/_this.mapConfig.height)/10;var minScale=Math.max(minXScale,minYScale);var maxScale=Infinity;var scaleStep=0.1;var mapWidth=_this.mapConfig.width;var mapHeight=_this.mapConfig.height;_this.lastScale=1;$btnSizeUp.off('touchstart').on('touchstart',function(e){if(_this.mapConfig.scale+scaleStep>maxScale)return;_this.mapConfig.scale+=scaleStep;resizeCalc();});$btnSizeDown.off('touchstart').on('touchstart',function(e){if(_this.mapConfig.scale-scaleStep<minScale)return;_this.mapConfig.scale-=scaleStep;resizeCalc();});function resizeCalc(){$containerMap.width(mapWidth*_this.mapConfig.scale);$containerMap.height(mapHeight*_this.mapConfig.scale);_this.mapConfig.offsetX=_this.mapConfig.offsetX-_this.mapConfig.imgX*(_this.mapConfig.scale/_this.lastScale-1);_this.mapConfig.offsetY=_this.mapConfig.offsetY-_this.mapConfig.imgY*(_this.mapConfig.scale/_this.lastScale-1);_this.mapConfig.imgX=_this.mapConfig.imgX*_this.mapConfig.scale/_this.lastScale;_this.mapConfig.imgY=_this.mapConfig.imgY*_this.mapConfig.scale/_this.lastScale;_this.offsetAdjust();$locateTool.css({left:_this.mapConfig.imgX-$spanLocateTool.width()/2,top:_this.mapConfig.imgY-$spanLocateTool.height()+_this.mapScreenTop});$containerMap.css({left:_this.mapConfig.offsetX,top:_this.mapConfig.offsetY-_this.mapScreenTop});$('#divTemperatureShow').text(minScale+':'+maxScale+':'+_this.mapConfig.scale.toFixed(1));_this.unitRelocate();_this.lastScale=_this.mapConfig.scale;_this.getRealPos();}
var scaleTransferCoe=0.05;var finalScale=1;_this.mapEvent.add(new Hammer.Pinch());_this.mapEvent.off('pinchmove').on('pinchmove',function(e){var ev=e;finalScale=1+(ev.scale-1)*scaleTransferCoe;$('#divTemperatureShow').text(scaleTransferCoe+':'+minScale+':'+maxScale+':'+ev.scale.toFixed(1));if(finalScale*_this.lastScale>maxScale||finalScale*_this.lastScale<minScale)return;_this.mapConfig.scale*=finalScale;resizeCalc();});};},initLocate:function(){var $map=$('#divObserverMap');var $imgMap=$('#imgMap');var $locateTool=$('#btnLocate');var $containerMap=$('#containerMap');var $spanLocateTool=$('#spanLocateIcon');var locateStatus='end';var $divTemperature=$('#divTemperature');this.mapEvent.add(new Hammer.Tap());this.mapEvent.off('tap').on('tap',function(e){if(_this.page.mode=='device')return;e.preventDefault();var ev=e;_this.mapConfig.imgX=ev.pointers[0].pageX-_this.mapConfig.offsetX;_this.mapConfig.imgY=ev.pointers[0].pageY-_this.mapConfig.offsetY;$locateTool.css({left:_this.mapConfig.imgX-$spanLocateTool.width()/2,top:_this.mapConfig.imgY-$spanLocateTool.height()+_this.mapScreenTop});_this.getRealPos();var sensorId=_this.getSensor();if(sensorId&&_this.page.mapTool.page.mode=='temp'){_this.page.mapTool.page.initEquipDetail(sensorId,'sensor',[_this.mapConfig.mapX,_this.mapConfig.mapY]);}});$locateTool.hammer().off('panmove').on('panmove',function(e){e.preventDefault();var ev=e.gesture;_this.mapConfig.imgX=ev.pointers[0].pageX-_this.mapConfig.offsetX;_this.mapConfig.imgY=ev.pointers[0].pageY-_this.mapConfig.offsetY;$locateTool.css({left:_this.mapConfig.imgX-$spanLocateTool.width()/2,top:_this.mapConfig.imgY-$spanLocateTool.height()+_this.mapScreenTop});_this.getRealPos()});$locateTool.hammer().off('panend').on('panend',function(e){e.preventDefault();var ev=e.gesture;_this.mapConfig.imgX=ev.changedPointers[0].pageX-_this.mapConfig.offsetX;_this.mapConfig.imgY=ev.changedPointers[0].pageY-_this.mapScreenTop-_this.mapConfig.offsetY;});var initimgX,initimgY,initOffsetX,initOffsetY;this.mapEvent.add(new Hammer.Pan({threshold:0}));this.mapEvent.off('panstart').on('panstart',function(e){e.preventDefault();var ev=e;initimgX=ev.pointers[0].pageX;initimgY=ev.pointers[0].pageY;initOffsetX=_this.mapConfig.offsetX;initOffsetY=_this.mapConfig.offsetY;});this.mapEvent.off('panmove').on('panmove',function(e){var ev=e;var evLeft=ev.pointers[0].pageX-initimgX+initOffsetX;var evTop=ev.pointers[0].pageY-initimgY+initOffsetY-_this.mapScreenTop;if(evLeft>0){evLeft=0;}
if(evTop>0){evTop=0;}
if(evLeft+$containerMap.width()-$map.width()<0){evLeft=-($containerMap.width()-$map.width());}
if(evTop+$containerMap[0].offsetHeight-$map.height()<0){evTop=-($containerMap[0].offsetHeight-$map.height());}
$containerMap.css({'left':evLeft+'px','top':evTop+'px'});});this.mapEvent.off('panend').on('panend',function(e){e.preventDefault();var ev=e;_this.mapConfig.offsetX+=ev.changedPointers[0].pageX-initimgX;_this.mapConfig.offsetY+=ev.changedPointers[0].pageY-initimgY;_this.offsetAdjust();_this.getRealPos()});},unitRelocate:function(){var arrUnit=$('.divUnit');var unit,left,top;for(var i=0;i<arrUnit.length;i++){unit=arrUnit[i];unit.style.left=parseInt(unit.style.left)*_this.mapConfig.scale/_this.lastScale+'px';unit.style.top=parseInt(unit.style.top)*_this.mapConfig.scale/_this.lastScale+'px';}},offsetAdjust:function(){var $map=$('#divObserverMap');var divMapHeight=$map[0].offsetHeight;var divMapWidth=$map[0].offsetWidth;var $containerMap=$('#containerMap');if(_this.mapConfig.offsetX>0){_this.mapConfig.offsetX=0}
if(_this.mapConfig.offsetY>_this.mapScreenTop){_this.mapConfig.offsetY=_this.mapScreenTop}
if(_this.mapConfig.offsetX<-($containerMap.width()-divMapWidth)){_this.mapConfig.offsetX=-($containerMap.width()-divMapWidth)}
if(_this.mapConfig.offsetY<-($containerMap[0].offsetHeight-divMapHeight-_this.mapScreenTop)){_this.mapConfig.offsetY=-($containerMap[0].offsetHeight-divMapHeight-_this.mapScreenTop)}},getRealPos:function(){var mapX=_this.mapConfig.imgX/_this.mapConfig.scale;var mapY=_this.mapConfig.imgY/_this.mapConfig.scale;_this.mapConfig.mapX=mapX;_this.mapConfig.mapY=mapY;console.log(_this.mapConfig.mapX+' '+_this.mapConfig.mapY);return{x:mapX,y:mapY,z:0};},getScreenPos:function(pos){var imgX=pos.x*_this.mapConfig.scale;var imgY=pos.y*_this.mapConfig.scale;return{x:imgX,y:imgY}},getSensor:function(){var spaceId=_this.getSpace();if(spaceId){var arrSensor=[],minDistance,distance,sensorId;if(spaceId!='room'){for(var i=0;i<sensorAll.length;i++){if(sensorAll[i].pId.toString()==spaceId){arrSensor.push(sensorAll[i])}}}else{for(var i=0;i<sensorAll.length;i++){if(sensorAll[i].pId.toString()==curRoom['_id']){arrSensor.push(sensorAll[i])}}}
minDistance=Infinity;for(var i=0;i<arrSensor.length;i++){distance=Math.pow(arrSensor[i].params.gps[0]-_this.mapConfig.mapX,2)+Math.pow(arrSensor[i].params.gps[1]-_this.mapConfig.mapY,2)
if(distance<minDistance){minDistance=distance;sensorId=arrSensor[i]['_id'];}}
return sensorId;}},getSpace:function(){for(var i=0;i<spaceAll.length;i++){if(_this.mapConfig.mapX>spaceAll[i].params.x&&_this.mapConfig.mapX<spaceAll[i].params.x+spaceAll[i].params.width&&_this.mapConfig.mapY>spaceAll[i].params.y&&_this.mapConfig.mapY<spaceAll[i].params.y+spaceAll[i].params.height){return spaceAll[i]['_id'];}}
return'room';},close:function(){}};return ObserverMap;})();var ObserverEquip=(function(){var _this;function observerEquip(screen){_this=this;this.screen=screen;this.equipList=screen.equipList}
observerEquip.prototype={show:function(){WebAPI.get('/static/app/temperatureControl/views/observer/widgets/equipmentConfig.html').done(function(resultHTML){$('#indexMain').html(resultHTML);_this.init();});},init:function(){var strEquipImg='<img id="imgMap" src="static/app/temperatureControl/img/2.jpg"/>';$('#divEquipImg').append(strEquipImg);_this.initConfigure();},initConfigure:function(){var $spanBtnCfg=$('.spanCfgBtn');$spanBtnCfg.off('touchstart').on('touchstart',function(e){var ev=e.originalEvent?e.originalEvent:e;var $btnCfg=$(ev.currentTarget).find('.btnCfg');if($btnCfg.hasClass('btnCfgOn')){$btnCfg.removeClass('btnCfgOn').addClass('btnCfgOff');}else{$btnCfg.removeClass('btnCfgOff').addClass('btnCfgOn');}})},};return observerEquip;})();var Schedule=(function(){var _this;Schedule.navOptions={top:'<span class="topNavTitle">日程</span>'};function Schedule(){_this=this;this.store=undefined;this.isEdit=false;this.schedule=undefined;}
Schedule.prototype={show:function(){WebAPI.get('/static/app/temperatureControl/views/config/schedule.html').done(function(resultHTML){$('#indexMain').html(resultHTML);if(curRoom&&curRoom.grade===0)$('.btnCtn').hide();WebAPI.get('/appTemperature/schedule/get/'+AppConfig.roomId).done(function(result){if(!result||$.isEmptyObject(result)){_this.store={'roomId':AppConfig.roomId,'option':[]}}else{_this.store=result;_this.renderSchedule(result);}
if(curRoom&&curRoom.grade!==0)_this.attachEvents();});});},init:function(){},renderSchedule:function(data){var strHtml='';for(var j=0,schedule;j<data.option.length;j++){schedule=data.option[j];strHtml+=('<div class="itemSchedule" data-id="'+data._id+'_'+schedule.moment+'">\
                <div class="">\
                    <span class="glyphicon glyphicon-minus btnRemove"></span>\
                    <span class="time">'+schedule.moment+'</span>\
                    <div class="opt-btn btn-switch-on" id="" data-key="">\
                        <div class="btn-switch-slider"></div>\
                    </div>\
                </div>\
            </div>');}
$('#listScheduleCtn').html(strHtml);var sortEl=$('#listScheduleCtn .itemSchedule').sort(function(item1,item2){return item1.dataset.id.split('_')[1]>item2.dataset.id.split('_')[1];});$('#listScheduleCtn').empty().html(sortEl);this.attachEventsItem();},attachEvents:function(){var $listSchedulePane=$('#listSchedulePane');var $editPane=$('#editPane');var $dateListPane=$('#dateListPane');var $ulOperateType=$('#ulOperateType');$('#btnAdd',$listSchedulePane).hammer().off('tap').on('tap',function(e){$listSchedulePane.hide();$editPane.show();router.controlles.showController({parent:$('#controlCtn')});$('#iptPickTime').val(new Date().format('HH:mm'));$('#ulOperateType li:eq(0)').addClass('selected');$('#tbController input:checkbox').prop('checked',false);e.stopPropagation();e.preventDefault();});$('#btnEdit',$listSchedulePane).hammer().off('tap').on('tap',function(e){$('.itemSchedule').addClass('selected');$(this).hide().next('#btnFinish').show();e.stopPropagation();e.preventDefault();});$('#btnFinish',$listSchedulePane).hammer().off('tap').on('tap',function(e){$('.itemSchedule').removeClass('selected');$(this).hide().prev('#btnEdit').show();if(_this.isEdit){_this.saveSchedule();}
e.stopPropagation();e.preventDefault();});$('#btnCancel',$editPane).hammer().off('tap').on('tap',function(e){$editPane.hide();router.controlles.close();$listSchedulePane.show();$('.itemSchedule',$listSchedulePane).removeClass('selected');$('#btnDelete',$editPane).hide();$('#btnFinish').hide();$('#btnEdit').show();e.stopPropagation();e.preventDefault();});$('#btnSave',$editPane).hammer().off('tap').on('tap',function(e){var $tbController=$('#tbController');var time=$('#iptPickTime').val();var $inputs=$tbController.find('tbody tr input:checked');var $liSel=$('#ulOperateType li.selected');if(!time)return;if($inputs.length<1)return;if($liSel.length==0)return;if($('#btnDelete').is(':hidden')){var data={'moment':$('#iptPickTime').val(),'userId':AppConfig.userId,'lastTime':new Date().format('yyyy-MM-dd HH:mm:ss'),'arrCommand':[]};var type=$liSel.attr('data-value');$inputs.each(function(){var id=$(this).closest('tr')[0].dataset.id;if(id){data.arrCommand.push({controllerId:id,switch:type});}});_this.store.option.push(data);}else{_this.schedule.moment=$('#iptPickTime').val();_this.schedule.userId=AppConfig.userId;_this.schedule.lastTime=new Date().format('yyyy-MM-dd HH:mm:ss');_this.schedule.arrCommand=[];var type=$liSel.attr('data-value');$tbController.find('tbody tr input:checked').each(function(){var id=$(this).closest('tr')[0].dataset.id;if(id){_this.schedule.arrCommand.push({controllerId:id,switch:type});}});}
$editPane.hide();$listSchedulePane.show();$('.item',$listSchedulePane).removeClass('selected');$('.item',$ulOperateType).removeClass('selected');$('#btnDelete',$editPane).hide();$('#btnFinish').hide();$('#btnEdit').show();_this.saveSchedule();e.stopPropagation();e.preventDefault();});$('#btnRepeat',$editPane).hammer().off('tap').on('tap',function(e){$editPane.hide();$dateListPane.show();e.stopPropagation();e.preventDefault();});$('.itemRepeat',$dateListPane).hammer().off('tap').on('tap',function(e){$(this).toggleClass('selected');e.stopPropagation();e.preventDefault();});$('.item',$ulOperateType).hammer().off('tap').on('tap',function(e){$(this).addClass('selected').siblings('.item').removeClass('selected');e.stopPropagation();e.preventDefault();});},attachEventsItem:function(){var $listSchedulePane=$('#listSchedulePane');var $editPane=$('#editPane');$('.btnRemove',$listSchedulePane).hammer().off('tap').on('tap',function(e){var time=$(this).closest('.itemSchedule').attr('data-id').split('_')[1]
$(this).closest('.itemSchedule').remove();_this.isEdit=true;for(var i=0;i<_this.store.option.length;i++){if(_this.store.option[i].moment==time){_this.store.option.splice(i,1);break;}}
e.stopPropagation();e.preventDefault();});$('.itemSchedule',$listSchedulePane).hammer().off('tap').on('tap',function(e){var arrItem=this.dataset.id.split('_');if(!$(this).hasClass('selected'))return;$listSchedulePane.hide();$editPane.show();router.controlles.showController({parent:$('#controlCtn')});var $tbController=$('#tbController');if(_this.store.option){for(var i=0;i<_this.store.option.length;i++){if(_this.store.option[i].moment==arrItem[1]){$('#iptPickTime').val(_this.store.option[i].moment);_this.schedule=_this.store.option[i];if(_this.store.option[i].arrCommand&&_this.store.option[i].arrCommand.length>0){_this.store.option[i].arrCommand.forEach(function(command,i){if(i==0){$('#ulOperateType li[data-value="'+command.switch+'"]').addClass('selected');}
$tbController.find('tbody tr[data-id="'+command.controllerId+'"] input').prop('checked',true);});}
break;}}}
var selectedLen=$('input:checked:not(#checkAll)',$tbController).length;if(selectedLen==$('input:not(#checkAll)',$tbController).length){$('#checkAll').prop('checked',true);}else{$('#checkAll').prop('checked',false);}
$('#btnDelete',$editPane).show().off('click').on('click',function(){for(var i=0;i<_this.store.option.length;i++){if(_this.store.option[i].moment==_this.schedule.moment){$('.itemSchedule[data-id="'+_this.store._id+'_'+_this.schedule.moment+'"]').remove();_this.store.option.splice(i,1);_this.saveSchedule();$('#btnEdit').show();$('#btnFinish').hide();break;}}
$editPane.hide();$listSchedulePane.show();$('.itemSchedule',$listSchedulePane).removeClass('selected');});e.stopPropagation();e.preventDefault();});},close:function(){},saveSchedule:function(){WebAPI.post('/appTemperature/schedule/save',_this.store).done(function(result){router.controlles.close();_this.renderSchedule(_this.store);}).always(function(){});}};return Schedule;})();var Mode=(function(){var _this;Mode.navOptions={top:'<span class="topNavTitle">模式</span>'};function Mode(){_this=this;}
Mode.prototype={show:function(){WebAPI.get('/static/app/temperatureControl/views/config/mode.html').done(function(resultHTML){$('#indexMain').html(resultHTML);_this.init();});},init:function(){_this.attachEvents();},attachEvents:function(){var $ulMode=$('#ulMode');$('.itemMode',$ulMode).hammer().off('tap').on('tap',function(e){$(this).addClass('selected').siblings().removeClass('selected');e.stopPropagation();e.preventDefault();});},close:function(){}};return Mode;})();var NewsCenter=(function(){var _this;NewsCenter.navOptions={top:'<span class="topNavTitle">消息</span>'};function NewsCenter(){_this=this;}
NewsCenter.prototype={show:function(){var strHtml='\
                <style>\
                    .list-unstyled .item{\
                        border-top: 1px solid #eee;\
                        padding: 10px 20px;\
                    }\
                </style>\
                <ul class="list-unstyled">';for(var i=0,news;i<router.newsList.length;i++){news=router.newsList[i];strHtml+=('<li class="item" data-id="'+news._id+'">'+news.text+'</li>');}
strHtml+='</ul>';$('#indexMain').html(strHtml);this.attachEvents();},attachEvents:function(){},close:function(){}};return NewsCenter;})();