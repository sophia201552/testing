<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>用户操作记录</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <link type="text/css" href="scripts/lib/bootstrap/css/bootstrap.min.css" rel="Stylesheet"/>
    <link type="text/css" href="scripts/lib/bootstrap/bootstrap-datetimepicker/bootstrap-datetimepicker.min.css" rel="Stylesheet"/>
    <link type="text/css" href="content/common.min.css" rel="Stylesheet"/>
    <link type="text/css" href="content/index.css" rel="Stylesheet"/>
    <script src="scripts/lib/jquery-1.11.1.min.js"></script>
    <script src="scripts/lib/bootstrap/responsive-nav/responsive-nav.min.js"></script>
    <script src="scripts/lib/bootstrap/js/bootstrap.js"></script>
    <script src="scripts/lib/bootstrap/bootstrap-datetimepicker/bootstrap-datetimepicker.min.js"></script>
    <script src="scripts/i18n/i18n.js"></script>
    <script src="scripts/lib/spin.js"></script>
    <script src="scripts/core/common.js"></script>
    <script src="scripts/index.js"></script>
    <script src="scripts/core/webAPI.js"></script>
    <script src="scripts/workflow2.0/jquery.twbsPagination.min.js"></script>
    <style>
        .mr1 {
            margin-right: 7px;
        }

        #pageTitle {
            font-size: 20px;;
            margin-bottom: 30px;
            color: #666;
        }

        #UserOperationRecord {
            margin-top: 40px;
            padding: 10px 50px;
            height: 700px;
            background: #fff;
        }

        #screeningConditions {
            overflow: hidden;
            height: 34px;
            line-height: 34px;;
        }

        #userLoginNumWrapper {
            float: left;
            color: #999;
            margin-left: 50px;;
        }

        #txtLogDateStart {
            border-radius: 5px 0 0 5px;
        }

        #txtLogDateEnd {
            border-radius: 0 5px 5px 0;
        }

        #userLoginNum {
            color: #f0ad4e;
            font-weight: bold;
        }

        #infoError {
            color: #d9534f;
            margin-left: 15px;
        }

        #recordTableWrapper {
            height: 500px;
        }

        #recordTable {
            margin-top: 30px;
        }

        #recordTable tr {
            height: 30px;
            line-height: 30px;
            cursor: pointer;
            border: 1px solid #ccc;
        }

        #recordTable td, #recordTable th {
            padding: 5px 10px;
            text-align: center;
        }

        #viewDetailsWin .modal-body {
            min-height: 400px;
            max-height: 600px;
            overflow: auto;
        }

        #recordDetail {
            list-style-type: none;
        }

        #recordDetail li ul {
            margin-left: 10px;
            padding-left: 0;
            list-style-type: none;
        }

        #viewDetailsWin .modal-dialog {
            width: 60%;
        }

    </style>

</head>
<body style="font-family: 微软雅黑; overflow-x:hidden; background-color: #edf0f5;background-image:url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHhtbG5zOnhsaW5rPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJyB3aWR0aD0nNicgaGVpZ2h0PSc2Jz4KICA8bGluZSB4MT0nMTAlJyB5MT0nMTAlJyB4Mj0nOTAlJyB5Mj0nOTAlJyBzdHJva2Utd2lkdGg9JzEnIHN0cm9rZT0nI2U4ZThlOCcvPgogIDxsaW5lIHgxPSc5MCUnIHkxPScxMCUnIHgyPScxMCUnIHkyPSc5MCUnIHN0cm9rZS13aWR0aD0nMScgc3Ryb2tlPScjZThmMGZmJy8+ICAKPC9zdmc+');">
<section class="col-xs-12 vertical-roll">
    <article id="UserOperationRecord" class="col-xs-offset-2 col-xs-8">
        <h3 id="pageTitle" class="tc">用户操作记录</h3>

        <div id="screeningConditions">
            <select id="user" class="fl form-control w150"></select>

            <div class="fl ml20">
                <div class="fl mr1">
                    <input class="form-control" size="16" type="text" value="" id="txtLogDateStart" placeholder="起始时间"/>
                </div>
                <div class="fl">
                    <input class="form-control" size="16" type="text" value="" id="txtLogDateEnd" placeholder="结束时间">
                </div>
                <button type="button" id="searchRecord" class="btn btn-primary ml30" data-dismiss="modal">确定</button>
                <span id="infoError" class="dn"></span>
            </div>
            <div class="fr" id="userLoginNumWrapper">
                用户登录次数：<span id="userLoginNum">0</span>
            </div>
        </div>
        <div id="recordWrapper">
            <div id="recordTableWrapper" class="dn">
                <table id="recordTable" class="col-xs-12">
                    <thead>
                    <tr>
                        <th width="50%">时间</th>
                        <th width="50%">访问类型</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="paginationWrapper">
                <ul id="pagination" class="pagination fr"></ul>
            </div>
        </div>
    </article>
</section>
<!--查看详情模态窗口-->
<div class="modal fade" id="viewDetailsWin" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">查看详情</h4>
            </div>
            <div class="modal-body">
                <ul id="recordDetail"></ul>
            </div>
        </div>
    </div>
</div>

<!--修改密码模态窗口结束-->
<script>
    (function () {
        var totalNum = 0;
        var perNum = 10;
        $(function () {
            var resultList;
            $("#txtLogDateStart").datetimepicker({
                minView: 2,
                format: "yyyy-mm-dd",
                autoclose: true,
                endDate: new Date()
            });
            $("#txtLogDateEnd").datetimepicker({
                minView: 2,
                format: "yyyy-mm-dd",
                autoclose: true,
                endDate: new Date()
            });

            Spinner.spin($("#UserOperationRecord")[0]);
            WebAPI.get("/get_registered_user_info").done(function (result) {
                var html = '';
                try {
                    var result = JSON.parse(result);
                } catch (e) {
                    console.log(e);
                    return;
                }
                var userHtml = '';
                for (var i = 0; i < result.length; i++) {
                    userHtml += '<option value="' + result[i][0] + '">' + result[i][1] + '</option>';
                }
                $("#user").append(userHtml);
            }).always(function () {
                Spinner.stop();
            });

            $("#searchRecord").click(function () {
                var userVal = $("#user").val();
                var startDate = $("#txtLogDateStart").val();
                var endDate = $("#txtLogDateEnd").val();
                var $infoError = $("#infoError");

                if (!userVal || userVal == 0) {
                    $infoError.html("请选择一个用户").show();
                    return;
                }

                if (!startDate) {
                    $infoError.html("开始时间不能为空").show();
                    return;
                }

                if (!endDate) {
                    $infoError.html("结束时间不能为空").show();
                    return;
                }

                if (startDate > endDate) {
                    $infoError.html("结束时间必须大于开始时间").show();
                    return;
                } else {
                    $infoError.hide();
                }

                Spinner.spin($("#UserOperationRecord")[0]);
                WebAPI.post("/operation_record/" + userVal, {
                    'startTime': startDate,
                    'endTime': endDate
                }).done(function (result) {
                    var html = '';
                    try {
                        var result = JSON.parse(result);
                    } catch (e) {
                        console.log(e);
                        return;
                    }

                    var $recordTableTbody = $("#recordTable tbody");
                    var record_pagination = $("#pagination");
                    if (result.length > 0) {
                        totalNum = result.length;
                        resultList = result;
                        var $recordTableWrapper = $("#recordTableWrapper");
                        var loginNum = 0;
                        for (var i = 0; i < result.length; i++) {
                            if (result[i].pageType == 'login') {
                                loginNum++;
                            }
                            html += '<tr><td>' + new Date(result[i].time.replace('GMT', '')).format('yyyy-MM-dd HH:mm:ss') + '</td><td>' + getPageTypeStr(result[i].pageType) + '</td></tr>';
                        }
                        $("#userLoginNum").text(loginNum);
                        $recordTableTbody.html(html);
                        $("#paginationWrapper").html('<ul id="pagination" class="pagination fr"></ul>');
                        $recordTableWrapper.show();
                        paginationItems(1);
                        pagination();
                        record_pagination.hide();

                    } else {
                        html = '<tr><td colspan="2" class="tc">暂未查询到数据</td></tr>';
                        $recordTableTbody.html(html);
                        record_pagination.hide();
                    }
                }).always(function () {
                    Spinner.stop();
                });
            });

            //点击查看详情
            $("#recordTable").on("click", "tbody tr", function () {
                var index = $("#recordTable tbody tr").index($(this));
                var data = resultList[index].remarks;
                var wh = $(window).height();
                var top = (wh - 700) / 2;
                $("#viewDetailsWin .modal-dialog").css({
                    'top': top
                });
                $('#viewDetailsWin').modal();
                $("#recordDetail").empty().html('<pre>' + $('#recordDetail').text(JSON.stringify(data, null, 4)).html() + '</pre>');
            });

        });

        function getPageTypeStr(pageType) {//访问类型中文
            switch (pageType) {
                case 'analysis':
                    return '数据分析';
                case 'diagnosis':
                    return '系统诊断';
                case 'dashboard':
                    return '实时图表';
                case 'observer':
                    return '系统监视';
                case 'report':
                    return '运营报表';
                case 'default':
                    return '默认';
                case 'shareLog':
                    return '我的分享';
                case 'myWorkflow':
                    return '我的工单';
                case 'switchProject':
                    return '项目列表';
                case 'teamWork':
                    return '工单项目团队';
                case 'workflowDynamic':
                    return '工单动态';
                case 'weekReport':
                    return '工单周报';
                case 'teamConfig':
                    return '工单人员配置';
                case 'groupEfficiency':
                    return '工单团队效率';
                default :
                    return pageType;
            }
        }

        function paginationItems(currentNum) {//分页显示记录
            var $items = $("#recordTable tbody tr");
            var startPage = perNum * (currentNum - 1);
            var endPage = perNum * currentNum;
            for (var i = 0; i < $items.length; i++) {
                var $item = $items.eq(i);
                if (i < startPage || i >= endPage) {
                    $item.hide();
                } else {
                    $item.show();
                }
            }
        }

        function pagination() {//重置分页
            var totalPages = (totalNum % perNum == 0) ? totalNum / perNum : totalNum / perNum + 1;
            $("#pagination").twbsPagination({
                first: '&laquo;&laquo',
                prev: '&laquo;',
                next: '&raquo;',
                last: '&raquo;&raquo;',
                startPage: 1,
                totalPages: totalPages,
                onPageClick: function (event, page) {
                    paginationItems(page);
                }
            });
        }

    })();
</script>
</body>
</html>
