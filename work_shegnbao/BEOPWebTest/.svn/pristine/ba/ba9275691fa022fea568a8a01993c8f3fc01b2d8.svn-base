function uploadFile(){var fileObj=document.getElementById("input_load_csv").files[0],form=new FormData;form.append("cvsFile",fileObj);var xhr=new XMLHttpRequest;xhr.onload=function(){4==xhr.readyState&&200==xhr.status?new UploadFile(xhr.responseText).show():alert(I18n.resource.observer.widgets.READ_DATA_FAILED+"！")},xhr.open("post","/get_csv_data",!0),xhr.send(form)}var OperatingPane=function(){function OperatingPane(pointName,value,description,screen){this.pointName=pointName,this.value=value,this.description=description,this.screen=screen,this.element=void 0,this.i18=I18n.resource.observer.widgets,this.init()}return OperatingPane.prototype={show:function(){$("#dialogOperatingPane").modal({})},close:function(){this.pointName=null,this.value=null,this.description=null,this.screen=null,this.element.parentNode.removeChild(this.element)},init:function(){var _this=this;$("#dialogOperatingPane").remove(),this.element=document.createElement("div"),this.element.id="dialogOperatingPane",this.element.className="modal fade",this.element.attributes.tabindex=-1,this.element.attributes.role="dialog",this.element.attributes["aria-labelledby"]="myModalLabel",this.element.attributes["aria-hidden"]=!0;var divModal=document.createElement("div");divModal.className="modal-dialog";var sb=new StringBuilder;sb.append('<div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>\r\n                <span class="sr-only">Close</span></button><h4 class="modal-title" id="myModalLabel" i18n="observer.widgets.ACTION_CONFIRM"></h4></div>\r\n                <div class="modal-body">'),sb.append(I18n.resource.observer.widgets.CONFIRM).append(this.description).append("？"),sb.append('</div><div class="modal-footer"></div></div>'),divModal.innerHTML=sb.toString();var btnSure=document.createElement("button");btnSure.type="button",btnSure.className="btn btn-primary",btnSure.attributes["data-dismiss"]="modal",btnSure.textContent=this.i18.CONFIRM,btnSure.onclick=function(e){$("#dialogOperatingPane .modal-footer").hide(),$("#dialogOperatingPane .modal-body").html(this.i18.EXECUTING+"..."),_this.initProcessBar(),_this.setValue()};var btnCancel=document.createElement("button");btnCancel.type="button",btnCancel.className="btn",btnCancel.attributes["data-dismiss"]="modal",btnCancel.textContent=this.i18.CANCEL,btnCancel.onclick=function(e){$("#dialogOperatingPane").modal("hide")},this.element.appendChild(divModal),$("body").append(this.element);var $footer=$("#dialogOperatingPane .modal-footer");$footer.append(btnSure),$footer.append(btnCancel),$("#dialogOperatingPane").on("hidden.bs.modal",function(e){_this.close()})},setValue:function(){var _this=this;this.updateProcess("10%： "+this.i18.START_SENDING_REQUEST+"...",10),WebAPI.post("/set_realtimedata",{db:AppConfig.projectId,point:this.pointName,value:this.value}).done(function(result){_this.updateProcess("40%： "+this.i18.REQUEST_SENT_CONFIRM+"...+",40);var count=1,interval=setInterval(function(){WebAPI.post("/get_realtimedata",{proj:AppConfig.projectId,pointList:[_this.pointName]}).done(function(result){var data=JSON.parse(result);if(!data.error&&data[0].value&&data[0].value==_this.value)_this.updateProcess("100%: "+I18n.resource.observer.widgets.DATA_OPERATION_COMPLETE+"！",100),clearInterval(interval),_this.screen.refreshData({data:data}),setTimeout(function(){$("#dialogOperatingPane").modal("hide")},1e3);else if(5>count){var percen=40+10*count;_this.updateProcess(percen.toString()+"%: 第 "+count.toString()+I18n.resource.observer.widgets.TIMES_DATA_CONFIRM,40+10*count),count++}else _this.processError("error： "+I18n.resource.observer.widgets.FAIL_TRY_AGAIN+"！"),clearInterval(interval)})},2e3)}).error(function(result){_this.processError("error： "+I18n.resource.observer.widgets.FAIL_SEND_REQUEST)})},processError:function(strMessage){var $bars=$("#divOperatingBar .progress-bar");$bars.removeClass("progress-bar-success"),$bars.addClass("progress-bar-danger"),this.updateProcess(strMessage,100)},initProcessBar:function(){var divProcessBar=document.createElement("div");divProcessBar.id="divOperatingBar",divProcessBar.className="progress",divProcessBar.style.height="30px",divProcessBar.style.marginTop="10px";var divBar=document.createElement("div");divBar.className="progress-bar progress-bar-success progress-bar-striped active",divBar.style.lineHeight="30px",divBar.setAttribute("role","progressbar"),divBar.setAttribute("role","progressbar"),divProcessBar.appendChild(divBar),$("#dialogOperatingPane .modal-body").append(divProcessBar)},updateProcess:function(strProcess,value){var $bars=$("#divOperatingBar .progress-bar");$bars.html(strProcess),$bars.width(value+"%")}},OperatingPane}(),OperatingRecord=function(){function OperatingRecord(){this.init()}return OperatingRecord.prototype={show:function(){$("#dialogModal").modal({})},init:function(){var _this=this;$.get("/static/views/observer/widgets/operatingRecord.html").done(function(resultHtml){var $dialogContent=$("#dialogContent");$dialogContent.html(resultHtml),$("#datePickerLog").datetimepicker({minView:"month",autoclose:!0,todayBtn:!0,initialDate:new Date}),$("#txtLogDate").val((new Date).toLocaleDateString().replace("/","-").replace("/","-")),$("#txtLogDate").change(function(e){_this.refreshData()}),$("#btnLogPre").click(function(e){var preDay=new Date(Date.parse($("#txtLogDate").val())-864e5);$("#txtLogDate").val(preDay.toLocaleDateString().replace("/","-").replace("/","-")),_this.refreshData()}),$("#btnLogNext").click(function(e){var nextDay=new Date(Date.parse($("#txtLogDate").val())+864e5);$("#txtLogDate").val(nextDay.toLocaleDateString().replace("/","-").replace("/","-")),_this.refreshData()}),_this.refreshData(),I18n.fillArea($dialogContent)})},refreshData:function(){Spinner.spin($("#dialogContent .modal-body")[0]);var _this=this;WebAPI.post("/get_operation_log",{proj:AppConfig.projectId,date:$("#txtLogDate").val()}).done(function(result){var data=JSON.parse(result);_this.renderData(data)}).always(function(){Spinner.stop()})},renderData:function(data){var sb=new StringBuilder;if(data.length&&data.length>0)for(var i=0;i<data.length;i++)sb.append("<tr><td>").append(new Date(1e3*data[i].RecordTime).format("yyyy-MM-dd HH:mm:ss")).append("</td>"),sb.append("<td>").append(data[i].user).append("</td>"),sb.append("<td>").append(data[i].OptRemart).append("</td></tr>");else sb.append("<tr><td colspan=3 i18n='observer.widgets.NO_OPERATIONS_TODAY'></td></tr>");$("#tableOperatingRecord tbody").html(sb.toString())}},OperatingRecord}(),HistoryChart=function(){function HistoryChart(data){this.init(),this.m_data=data}return HistoryChart.prototype={show:function(){$("#dialogModal").modal({})},init:function(){var _this=this;$.get("/static/views/observer/widgets/historyChart.html").done(function(resultHtml){$("#dialogContent").html(resultHtml),_this.refreshData()})},refreshData:function(){this.drawEChart(this.m_data)},drawEChart:function(data){for(var arrayName=new Array,nArraySize=data.length,arraySeries=new Array,i=0;nArraySize>i;i++){arrayName.push(data[i].name);for(var arrPt=new Array,nEachSize=data[i].point.length,j=0;nEachSize>j;j++){var tm=data[i].point[j].time;arrPt.push([new Date(Date.parse(tm.replace(/-/g,"/"))),data[i].point[j].value])}0!=arrPt.length&&arraySeries.push({name:data[i].name,type:"line",data:arrPt,markPoint:{data:[{type:"max",name:I18n.resource.observer.widgets.MAXIMUM},{type:"min",name:I18n.resource.observer.widgets.MINIMUM}]}})}option={title:{text:"",subtext:""},tooltip:{trigger:"axis",formatter:function(params){var date=new Date(params.value[0]);return data=date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()+" "+date.getHours()+":"+date.getMinutes(),data+"<br/>,"+params.value[1]}},legend:{data:arrayName},toolbox:{show:!0,feature:{mark:{show:!0},dataZoom:{show:!0,readOnly:!1},dataView:{show:!0,readOnly:!0},restore:{show:!0},saveAsImage:{show:!0}}},dataZoom:{show:!0},grid:{y2:80},calculable:!0,xAxis:[{type:"time"}],yAxis:[{type:"value"}],series:arraySeries};var myChart=echarts.init(document.getElementById("tableOperatingRecord"));myChart.setOption(option)},uniqueArray:function(arr){for(var elem,result=[],hash={},i=0;null!=(elem=arr[i]);i++)hash[elem]||(result.push(elem),hash[elem]=!0);return result}},HistoryChart}(),UploadFile=function(){function UploadFile(data){this.init(),this.m_data=data}return UploadFile.prototype={show:function(){$("#dialogModal").modal({})},init:function(){var _this=this;$.get("/static/views/observer/widgets/uploadFile.html").done(function(resultHtml){$("#dialogContent").html(resultHtml),_this.refreshData(),$("#btn_write_pt").click(function(e){var name,value,row,ptList=[];return $(".chkPtSel").each(function(){name=$(this).closest("tr").find(".ptName").text(),value=$(this).closest("tr").find(".ptValue").text(),row={pointName:name,pointValue:value},ptList.push(row)}),0==ptList.length?void alert(I18n.resource.observer.widgets.PLEASE_SELECT_POINT+"！"):void WebAPI.post("/update_realtimedata_input_value",{project:AppConfig.projectName,listInfo:ptList}).done(function(result){}).error(function(e){alert(I18n.resource.observer.widgets.UPDATE_TABLE+"realtimedata_input"+I18n.resource.observer.widgets.FAILED+"！"),Spinner.stop()})}),$("#chk_all_sel").click(function(e){for(var state=$("#chk_all_sel").is(":checked"),arr=document.getElementsByClassName("chkFlag"),i=0;i<arr.length;i++)arr[i].checked=state})})},refreshData:function(){this.initData(this.m_data)},initData:function(data){var tr,td,table=$("#tableOperatingRecord tbody"),jsonData=JSON.parse(data);if(jsonData.length&&jsonData.length>0)for(var i=0;i<jsonData.length;i++)tr=document.createElement("tr"),td=document.createElement("td"),td.className="chkPtSel",td.innerHTML="<input type='checkbox' class='chkFlag' />",tr.appendChild(td),td=document.createElement("td"),td.className="ptName",td.innerHTML=jsonData[i][0].name,tr.appendChild(td),td=document.createElement("td"),td.className="ptValue",td.innerHTML=jsonData[i][1].value,tr.appendChild(td),table.append(tr);else table.append("<tr><td colspan=3 i18n='observer.widgets.NO_DATA_READ'></td></tr>")}},UploadFile}(),DataWatch=function(){function DataWatch(){this.currentMode=void 0,this.listAllPointValues=void 0,this.listPoints=void 0,this.listPointsTemp=void 0,this.startTime=void 0,this.endTime=void 0,this.interval=void 0,this.allData=void 0}return DataWatch.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$("#ulPages li").removeClass("active"),$("#page-DataWatch").parent().addClass("active"),$.get("/static/views/observer/widgets/dataWatch.html").done(function(resultHtml){Spinner.spin(ElScreenContainer),$(ElScreenContainer).html(resultHtml),_this.init()})},close:function(){this.listAllPoints=null,this.listPoints=null,this.listPointsTemp=null,this.startTime=null,this.endTime=null,this.currentMode=null},init:function(){this.initPoints(),this.initElement(),I18n.fillArea($("#divAllPointsPane .panel-heading"))},initPoints:function(){var _this=this;this.listAllPointValues={},Spinner.spin($("#divDataWatchPage")[0]),WebAPI.post("/get_realtimedata_with_description_by_projname",{projid:AppConfig.projectId}).done(function(result){var data=JSON.parse(result);_this.renderPoints(data),Spinner.stop()})},renderPoints:function(data){for(var i=0;i<data.length;i++)this.listAllPointValues[data[i].name]=[data[i].value,data[i].desc];var tr,td,i=(document.createElement("div"),0),table=$("#tableWatch");for(var key in this.listAllPointValues){{$("#tableWatch tr").length-1}tr=document.createElement("tr"),td=document.createElement("td"),td.innerHTML="<input type='checkbox' id='chk_"+i+"'/>",tr.appendChild(td),td=document.createElement("td"),td.innerHTML=i,tr.appendChild(td),td=document.createElement("td"),td.id="point_name_"+i,td.className="ptName",td.textContent=key,tr.appendChild(td),td=document.createElement("td"),td.id="point_value_"+i,td.innerHTML=this.listAllPointValues[key][0],td.onclick=function(e){var target=e.currentTarget,temp=target.innerText;if(""!=temp){target.innerText="";var textBox=document.createElement("input");textBox.value=temp,textBox.onblur=function(e){var arr=target.id.split("_");WebAPI.post("/set_realtimedata",{db:AppConfig.projectId,point:$("#point_name_"+arr[2]).text(),value:textBox.value}).done(function(result){}),target.removeChild(textBox),target.textContent=textBox.value},target.appendChild(textBox),textBox.select()}},tr.appendChild(td),td=document.createElement("td"),td.innerHTML=this.listAllPointValues[key][1],tr.appendChild(td),td=document.createElement("td"),td.innerHTML="--",tr.appendChild(td),table.append(tr),i++}},initElement:function(){{var _this=this;new Date}this.startTime="2014-11-24 06:10",this.endTime="2014-11-28 12:50",$(".form_datetime").datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:!0,todayBtn:!0,initialDate:new Date}),$("#txtStartTime").val(this.startTime),$("#txtEndTime").val(this.endTime),$("#btnReset").click(function(e){$("#divDisplayOptions").hide(),$("#divSettingOptions").show(),_this.close(),_this.show()}),$("#btn_hist_curve").click(function(e){var point_value_list=[];if($("[type=checkbox]:checked").each(function(){point_value_list.push($(this).closest("tr").find(".ptName").text())}),0==point_value_list.length)return void alert(I18n.resource.observer.widgets.PLEASE_SELECT_POINT+"！");var tmStart=$("#txtLogDateStart").val();if(""==tmStart)return void alert(I18n.resource.observer.widgets.SELECT_START_TIME+"！");tmStart+=":00";var tmEnd=$("#txtLogDateEnd").val();return""==tmEnd?void alert(I18n.resource.observer.widgets.SELECT_CLOSING_TIME+"！"):(tmEnd+=":00",void WebAPI.post("/get_history_data_ex",{project:AppConfig.projectName,listPtName:point_value_list,timeStart:tmStart,timeEnd:tmEnd,timeFormat:"m5"}).done(function(result){var data=JSON.parse(result);new HistoryChart(data).show()}).error(function(e){alert(I18n.resource.observer.widgets.HISTORY_CURVE_FAILED+"！"),Spinner.stop()}))})}},DataWatch}(),PointManager=function(){function PointManager(){this.i18=I18n.resource.observer.widgets}var util={tooltip:{show:function($ele,cnt){$ele.attr("data-original-title",cnt),$ele.tooltip("show"),$ele[0].timer&&(window.clearTimeout($ele[0].timer),$ele[0].timer=null),$ele[0].timer=window.setTimeout(function(){$ele.tooltip("hide")},3e3)},hide:function($ele){$ele.tooltip("hide")}}};return PointManager.prototype={show:function(){var _this=this;$("#ulPages li").removeClass("active"),$("#page-DataWatch").parent().addClass("active"),$.get("/static/views/observer/pointManager.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),null==AppConfig.projectName?$("#myTab li:last-child").hide():$("#stPjName").html(AppConfig.projectName),I18n.fillArea($("#divUploadWrap")),_this.InitMemberValues(),_this.initProjectPointList(),_this.initElement(),_this.attachEvents()})},close:function(){this.detachEvents()},attachEvents:function(){var fileSelected,$pjData=$("#iptPjData"),$btnConfirm=$("#btnConfirmUpload"),$spUploadInfo=$("#spUploadInfo"),$btnUploadCSV=$("#btnUploadCSV"),$divPjDataDropHandler=$("#divPjDataDropHandler"),$tip=$divPjDataDropHandler.children("p"),$uploadMask=$("#uploadMask"),$body=$("body"),uploadStatus=-1,dragFix=!1;$spUploadInfo.tooltip({title:"",trigger:"manual",placement:"right"});var uploadHandler=function(file){var formData=new FormData,match=file.name.match(/\.[A-Za-z0-9]+$/),supportFiles=[".csv",".xls",".xlsx"];return!file||!match||supportFiles.indexOf(match[0].toLowerCase())<0?(util.tooltip.show($spUploadInfo,"文件格式有误，请上传正确的 .csv/.xls/.xlsx 格式文件！"),void(isDataUploadReady=!1)):(fileSelected=file,formData.append("config-file",file),void $.ajax({url:"/get_config_data/"+AppConfig.userId,type:"post",data:formData,dataType:"json",xhr:function(){var xhr=$.ajaxSettings.xhr();return xhr.upload&&(xhr.upload.addEventListener("progress",function(e){var progress=Math.round(e.loaded/e.total);e.lengthComputable&&$("#spUploadInfo").html("正在上传..."+100*progress+"%")},!1),xhr.upload.addEventListener("load",function(e){$("#spUploadInfo").html("正在处理数据...")},!1)),xhr},cache:!1,contentType:!1,processData:!1}).done(function(rs){$("#spUploadInfo").removeClass().addClass("text-success").html("上传成功 - "+file.name),uploadStatus=0}).fail(function(err){$("#spUploadInfo").removeClass().addClass("text-danger").html("上传失败，文件中有错误！"),uploadStatus=-1}))};$btnUploadCSV.click(function(e){$pjData.click()}),$pjData.change(function(){uploadHandler($(this)[0].files[0])}),$divPjDataDropHandler.on("dragenter",function(e){dragFix=!0,$tip.html("松开鼠标开始上传"),e.stopPropagation(),e.preventDefault()}),$divPjDataDropHandler.on("dragleave",function(e){dragFix=!1,$tip.html("请将文件拖拽到此处进行上传"),e.stopPropagation(),e.preventDefault()}),$divPjDataDropHandler.on("drop",function(e){var files,file;$divPjDataDropHandler.hide(),$uploadMask.hide(),$tip.html("请将文件拖拽到此处进行上传"),files=e.originalEvent.dataTransfer.files,files.length>1&&alert("请注意：\n目前系统不支持同时上传多个文件，将会使用您选择的第一个文件进行上传！"),file=files[0],uploadHandler(file),e.stopPropagation(),e.preventDefault()}),$uploadMask.on("dragleave",function(e){e.stopPropagation(),dragFix||($uploadMask.hide(),$divPjDataDropHandler.hide())}),$body.on("dragenter",function(e){$divPjDataDropHandler.show(),$uploadMask.show(),e.preventDefault()}),$body.add($uploadMask).add($divPjDataDropHandler).on("dragover",function(e){e.preventDefault()}),$body.on("keydown",function(e){27===e.keyCode&&($uploadMask.hide(),$divPjDataDropHandler.hide(),e.preventDefault())}),$body.on("drop",function(e){$uploadMask.hide(),$divPjDataDropHandler.hide(),e.preventDefault()}),$btnConfirm.click(function(){return null==AppConfig.projectId?void alert("请您先选择一个项目，再进行上传！"):0!==uploadStatus?void alert("请您先上传数据，并保证数据的正确性！"):(Spinner.spin($body[0]),void WebAPI.post("/project/import_user_data/"+AppConfig.userId,{dataFileName:fileSelected.name,projId:AppConfig.projectId}).done(function(rs){rs=JSON.parse(rs),"object"==typeof rs&&"successful"===rs.error?(alert("数据导入成功！"),ScreenManager.show(PointManager)):alert("服务器忙碌中，请稍后重试！")}).fail(function(){alert("服务器忙碌中，请稍后重试！")}).always(function(){Spinner.stop()}))})},detachEvents:function(){$("#divPjDataDropHandler").off(),$("#uploadMask").off,$("body").off()},initProjectPointList:function(){var _this=this,projSelector=$("#divProjectList .panel-body");projSelector.html("");var divProj=document.createElement("div"),ul=document.createElement("ul");ul.className="list-group";for(var nSize=AppConfig.projectList.length,i=0;nSize>i;i++){var project=AppConfig.projectList[i],li=document.createElement("li");li.className="list-group-item list-group-item-success",li.id="project_"+project.name_en,li.title=project.name_en,li.textContent=project.name_cn,li.value=project.id,li.onclick=function(e){var tarProj=e.currentTarget;_this.SelectProjectName(tarProj,!0);var nPrjId=tarProj.value,ptListSelector=$("#tableWatch tbody");ptListSelector.html(""),Spinner.spin($("#divPointManagerPage")[0]),WebAPI.post("/get_realtimedata",{proj:tarProj.value}).done(function(result){var ptList=JSON.parse(result);if(0==ptList.length)return alert("'"+tarProj.textContent+"' "+this.i18.FAIL_FIND_POINT+"！"),_this.SelectProjectName(tarProj,!1),void Spinner.stop();for(var tr,td,nListSize=ptList.length,i=0;nListSize>i;i++)tr=document.createElement("tr"),tr.className="",td=document.createElement("td"),td.innerHTML="<input type='checkbox' class='checkBtn' id='chk_"+i+"' value='"+ptList[i].name+"'/>",td.onclick=function(e){var tarChk=e.currentTarget,ptName=tarChk.children[0].value;tarChk.children[0].checked?_this.OperateMemberValues(nPrjId,ptName,"add"):_this.OperateMemberValues(nPrjId,ptName,"del")},tr.appendChild(td),td=document.createElement("td"),td.textContent=i+1,tr.appendChild(td),td=document.createElement("td"),td.id="point_"+ptList[i].name,td.textContent=ptList[i].name,tr.appendChild(td),td=document.createElement("td"),td.id="value_"+ptList[i].name,td.textContent=ptList[i].value,td.onclick=function(e){var tarVal=e.currentTarget,temp=tarVal.innerText;if(""!=temp){tarVal.innerText="";var textBox=document.createElement("input");textBox.value=temp,textBox.onblur=function(e){var arr=tarVal.id.split("_");Spinner.spin($("#divPointManagerPage")[0]),WebAPI.post("/set_realtimedata",{db:tarProj.value,point:arr[1],value:textBox.value}).done(function(result){Spinner.stop()}).error(function(result){alert(I18n.resource.analysis.paneConfig.ERR1),Spinner.stop()}),tarVal.removeChild(textBox),tarVal.textContent=textBox.value},tarVal.appendChild(textBox),textBox.select()}},tr.appendChild(td),ptListSelector.append(tr);_this.SetCheckboxStatus(nPrjId),Spinner.stop()}).error(function(result){alert(I18n.resource.analysis.paneConfig.ERR1),Spinner.stop()})},ul.appendChild(li)}divProj.appendChild(ul),projSelector.append(divProj)},initElement:function(){var _this=this;$(".form_datetime").datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:!0,todayBtn:!0,initialDate:new Date}),$("#btn_hist_curve").click(function(e){var tmStart=$("#selStartTime").val();if(""==tmStart)return void alert(I18n.resource.observer.widgets.SELECT_START_TIME+"！");tmStart+=":00";var tmEnd=$("#selEndTime").val();if(""==tmEnd)return void alert(I18n.resource.observer.widgets.SELECT_CLOSING_TIME+"！");tmEnd+=":00";var project_name;$("div#divProjectList .list-group-item").each(function(){var nIndex=this.className.indexOf("active");return-1!=nIndex?(project_name=this.title,!1):void 0});var point_name_list=[];return $("div#divPointsList [type=checkbox]:checked").each(function(){point_name_list.push($(this).parent().parent().find("td:eq(2)").text())}),0==point_name_list.length?void alert(I18n.resource.observer.widgets.PLEASE_SELECT_POINT+"！"):(Spinner.spin($("#divPointManagerPage")[0]),void WebAPI.post("/get_history_data_ex",{project:project_name,listPtName:point_name_list,timeStart:tmStart,timeEnd:tmEnd,timeFormat:"m5"}).done(function(result){var data=JSON.parse(result);new HistoryChart(data).show(),Spinner.stop()}).error(function(e){alert(I18n.resource.observer.widgets.HISTORY_CURVE_FAILED+"！"),Spinner.stop()}))}),$("#btn_sel_all").click(function(e){for(var arr=document.getElementsByClassName("checkBtn"),i=0;i<arr.length;i++)arr[i].checked=!0}),$("#btn_sel_none").click(function(e){for(var arr=document.getElementsByClassName("checkBtn"),i=0;i<arr.length;i++)arr[i].checked=!1}),$("#btn_sel_save").click(function(e){var tmStart=$("#selStartTime").val();if(""==tmStart)return alert(I18n.resource.observer.widgets.ENTER_STAT_TIME+"！"),void Spinner.stop();tmStart+=":00";var tmEnd=$("#selEndTime").val();if(""==tmEnd)return alert(I18n.resource.observer.widgets.ENTER_CLOSING_TIME+"！"),void Spinner.stop();tmEnd+=":00",Spinner.spin($("#divPointManagerPage")[0]);var prjList=JSON.stringify(_this.m_arrayPrjPt);WebAPI.post("/save_history_config_value",{userName:_this.m_strUserName,configName:"myConfig",startTime:tmStart,endTime:tmEnd,projectList:prjList}).done(function(result){Spinner.stop()}).error(function(e){alert(I18n.resource.observer.widgets.FAIL_SAVE_CONFIGURATION+"！"),Spinner.stop()})}),$("#btn_sel_load").click(function(e){Spinner.spin($("#divPointManagerPage")[0]),WebAPI.get("/load_history_config_value/"+_this.m_strUserName).done(function(result){Spinner.stop()}).error(function(e){alert(I18n.resource.observer.widgets.FAIL_SAVE_CONFIGURATION+"！"),Spinner.stop()})}),$("#btn_sel_clear").click(function(e){(new PointManager).show()})},SelectProjectName:function(clickTarget,bActive){$("div#divProjectList .list-group-item").each(function(){$(this).attr("class","list-group-item list-group-item-success")}),1==bActive&&$(clickTarget).attr("class","list-group-item list-group-item-success active")},SelectPointName:function(clickTarget){var nIndex=clickTarget.className.indexOf("info");-1!=nIndex?$(clickTarget).attr("class",""):$(clickTarget).attr("class","info")},InitMemberValues:function(){var _this=this;_this.m_strUserName=AppConfig.account,_this.m_arrayPrjPt=new Array,_this.m_arrayPrjPt.splice(0,_this.m_arrayPrjPt.length)},OperateMemberValues:function(nPrjId,ptName,flag){for(var _this=this,nFindIdx=-1,nLen=_this.m_arrayPrjPt.length,i=0;nLen>i;i++)if(_this.m_arrayPrjPt[i].nProjectId==nPrjId){nFindIdx=i;break}if("add"==flag)if(-1==nFindIdx){var ptList=new Array;ptList.push(ptName),_this.m_arrayPrjPt.push({nProjectId:nPrjId,pointList:ptList})}else _this.m_arrayPrjPt[nFindIdx].pointList.push(ptName);else if("del"==flag)if(-1==nFindIdx);else{for(var ptIdx=-1,ptLen=_this.m_arrayPrjPt[nFindIdx].pointList.length,i=0;ptLen>i;i++)if(_this.m_arrayPrjPt[nFindIdx].pointList[i]==ptName){ptIdx=i;break}_this.m_arrayPrjPt[nFindIdx].pointList.splice(ptIdx,1)}},SetCheckboxStatus:function(nPrjId){var _this=this,nLen=_this.m_arrayPrjPt.length;if(0!=nLen){for(var nIndex=-1,i=0;nLen>i;i++)if(_this.m_arrayPrjPt[i].nProjectId==nPrjId){nIndex=i;break}if(-1!=nIndex){var ptList=_this.m_arrayPrjPt[nIndex].pointList,nLen=ptList.length;$("[type=checkbox]").each(function(){for(var i=0;nLen>i;i++)this.value==ptList[i]&&(this.checked=!0)})}}}},PointManager}(),AlarmLogging=function(){function AlarmLogging(){_this=this,this.timer=null,this.onmessage_global=BackgroundWorkers.alarmReporter.onmessage}var _this=this,ALARM_RULE_NAME="alarm_rules",alarmMode={LIMIT_VALUE:0,LIMIT_VALUE_TITLE:"Limit-Value Alarm Mode",BOOL:1,BOOL_TITLE:"Bool Alarm Mode",DIAGNOSIS:2,DIAGNOSIS_TITLE:"Diagnosis Alarm Mode"},util={date:{formatString:function(d){var year=d.getFullYear(),month=d.getMonth(),dayMonth=d.getDate(),hours=d.getHours(),minutes=d.getMinutes(),seconds=d.getSeconds();return month=10>month?"0"+(month+1):month+1,dayMonth=10>dayMonth?"0"+dayMonth:dayMonth,hours=10>hours?"0"+hours:hours,minutes=10>minutes?"0"+minutes:minutes,seconds=10>seconds?"0"+seconds:seconds,[year,month,dayMonth].join("-")+" "+[hours,minutes,seconds].join(":")}},checkbox:{selectAll:function($eles){$eles.each(function(){var $this=$(this);$this.is(":checked")||$this.prop("checked",!0)})},selectInverse:function($eles){$eles.each(function(i){var $this=$(this);$this.prop("checked",$this.is(":checked")?!1:!0)})},unSelectAll:function($eles){$eles.each(function(i){var $this=$(this);$this.is(":checked")&&$this.prop("checked",!1)})},isAllChecked:function($eles){return $eles.not(":checked").length<=0},keepOneCheckbox:function($cbs){var $checkedCb=$cbs.filter(":checked");$checkedCb.length<=1?$checkedCb.prop("disabled",!0):$cbs.prop("disabled",!1)}}};return AlarmLogging.prototype={show:function(){Spinner.spin(ElScreenContainer),$("#ulPages li").removeClass("active"),$("#page-DataWatch").parent().addClass("active"),$.get("/static/views/observer/widgets/alarmLogging.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init()}).always(function(){Spinner.stop()})},init:function(){this.$alarmLoggingPane=$("#alarmLoggingPane"),this.$btnClose=$("#btnClose"),this.$iptStartTime=$("#iptStartTime"),this.$iptEndTime=$("#iptEndTime"),this.$panelLog=$("#panelLog"),this.$tbAlarm=$("#tbAlarm"),this.$btnAlarmSrch=$("#btnAlarmSrch"),this.$btnReload=$("#btnReload"),this.$spLoading=this.$btnReload.children("span"),this.$btnCog=$("#btnConfig"),this.$btnAddRule=$("#btnAddRule"),this.$btnDelRule=$("#btnDelRule"),this.$tbRule=$("#tbRule"),this.$panelCog=$("#panelCog"),this.$btnRuleSrch=$("#btnRuleSrch"),this.$iptRuleSrch=$("#iptRuleSrch"),this.$btnLogList=$("#btnLogList"),this.$btnSelectAll=$("#btnSelectAll"),this.$cbSelectAll=this.$btnSelectAll.children("input"),this.$lkSelectAll=$("#lkSelectAll"),this.$lkSelectInverse=$("#lkSelectInverse"),this.$lkUnSelectAll=$("#lkUnSelectAll"),this.$ruleModal=$("#ruleModal"),this.$divRuleForm=$("#divRuleForm"),this.$divAlarmInfo=$("#divAlarmInfo"),this.$divRuleEnable=$("#divRuleEnable"),this.$divRuleValue=$("#divRuleValue"),this.$divAlarmLevel=$("#divAlarmLevel"),this.$cbLL=$("#cbLL"),this.$cbL=$("#cbL"),this.$cbH=$("#cbH"),this.$cbHH=$("#cbHH"),this.$iptLL=$("#iptLL"),this.$iptL=$("#iptL"),this.$iptH=$("#iptH"),this.$iptHH=$("#iptHH"),this.$iptLLInfo=$("#iptLLInfo"),this.$iptLInfo=$("#iptLInfo"),this.$iptHInfo=$("#iptHInfo"),this.$iptHHInfo=$("#iptHHInfo"),this.$iptPointName=$("#iptPointName"),this.$iptAlarmInfo=$("#iptAlarmInfo"),this.$iptAlarmLevel=$("#iptAlarmLevel"),this.$btnRuleSubmit=$("#btnRuleSubmit"),this.$divFormTip=$("#divFormTip"),this.$ddAlarmMode=$("#ddAlarmMode"),this.$btnAlarmMode=this.$ddAlarmMode.find("button"),this.$spAlarmModeTitle=this.$btnAlarmMode.find("span").eq(0),this.$lkAlarmModeItems=this.$ddAlarmMode.find("ul>li>a"),$(".form-datetime").datetimepicker({format:"yyyy-mm-dd hh:ii:ss",autoclose:!0,todayBtn:!0,minuteStep:20}),this.attachEvents(),this.initTable(),this.resize(),this.$iptEndTime.val(util.date.formatString(new Date)).datetimepicker("update"),this.startAutoload(),this.initFormValidation()},startAutoload:function(runAtStart){runAtStart=void 0===runAtStart||null===runAtStart?!0:runAtStart,runAtStart&&this.$btnReload.trigger("click"),BackgroundWorkers.alarmReporter.onmessage=function(e){var rs=e.data;return"LOADING"===rs.status?(_this.$tbAlarm.table("loading"),void _this.$spLoading.addClass("loading")):(_this.reloadRecord(rs.data),void _this.onmessage_global(e))}},stopAutoload:function(){BackgroundWorkers.alarmReporter.onmessage=this.onmessage_global},initTable:function(){this.$tbAlarm.table({columns:[{name:"no",title:"No",formatter:function(i,row){return i+1}},{name:"time",title:"Time",formatter:"{time}"},{name:"bindpointname",title:"Point Name",formatter:"{bindpointname}"},{name:"info",title:"Info",formatter:"{info}"},{name:"level",title:"Level",formatter:function(i,row){switch(row.level){case 1:case 2:return'<span class="label label-warning">Warning</span>';case 3:case 4:default:return'<span class="label label-danger">Danger</span>'}}},{name:"operations",title:"Operations",formatter:'\r\n                    <div class="dropdown">\r\n                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">\r\n                            Delay this alarm <span class="caret"></span>\r\n                        </button>\r\n                        <ul class="dropdown-menu" role="menu">\r\n                            <li data-value="30"><a href="javascript:">Delay 30 minutes</a></li>\r\n                            <li data-value="60"><a href="javascript:">Delay 1 hour</a></li>\r\n                            <li data-value="180"><a href="javascript:">Delay 3 hours</a></li>\r\n                            <li data-value="360"><a href="javascript:">Delay 6 hours</a></li>\r\n                            <li data-value="1440"><a href="javascript:">Delay 1 day</a></li>\r\n                        </ul>\r\n                    </div>'}]}),this.$tbRule.table({columns:[{name:"cb",title:"",formatter:function(i,row){return'<input type="checkbox" data-rowindex="'+i+'" />'}},{name:"pointname",title:"Point",formatter:"{pointname}"},{name:"warningtype",title:"Warning Type",formatter:function(i,row){switch(row.boolwarning){case alarmMode.LIMIT_VALUE:return alarmMode.LIMIT_VALUE_TITLE;case alarmMode.BOOL:return alarmMode.BOOL_TITLE;default:return"Unknow"}}},{name:"warninglevel",title:"Warning Level",formatter:"{boolwarninglevel}"},{name:"warningvalue",title:"Warning Value",formatter:function(i,row){var arrHtml=[];switch(row.boolwarning){case alarmMode.LIMIT_VALUE:return arrHtml.push("LL: "+(1===row.LLEnable?row.LLLimit:"disabled")),arrHtml.push("L: "+(1===row.LEnable?row.LLimit:"disabled")),arrHtml.push("H: "+(1===row.HEnable?row.HLimit:"disabled")),arrHtml.push("HH: "+(1===row.HHEnable?row.HHLimit:"disabled")),arrHtml.join("<br/>");case alarmMode.BOOL:return"/";default:return"/"}}},{name:"warninginfo",title:"Warning Info",formatter:function(i,row){var arrHtml=[];switch(row.boolwarning){case alarmMode.LIMIT_VALUE:return arrHtml.push("LL: "+(1===row.LLEnable?row.LLwarninginfo:"disabled")),arrHtml.push("L: "+(1===row.LEnable?row.Lwarninginfo:"disabled")),arrHtml.push("H: "+(1===row.HEnable?row.Hwarninginfo:"disabled")),arrHtml.push("HH: "+(1===row.HHEnable?row.HHwarninginfo:"disabled")),arrHtml.join("<br/>");

case alarmMode.BOOL:return row.boolwarninginfo;default:return"/"}}},{name:"operations",title:"Operations",formatter:function(i,row){var htmlTpl='\r\n                        <button class="btn btn-primary btn-rule-edit" type="button" title="edit this rule">\r\n                            <span class="glyphicon glyphicon-pencil"></span>\r\n                        </button>\r\n                        <button class="btn btn-primary btn-rule-del" type="button" title="delete this rule">\r\n                            <span class="glyphicon glyphicon-trash"></span>\r\n                        </button>';return htmlTpl}}]})},initFormValidation:function(){this.$divRuleForm.validator({elements:[{name:"pointName",selector:this.$iptPointName,rules:[{valid:/^.+$/,msg:'"Point Name" cannot be empty!'}]},{name:"alarmInfo",selector:this.$iptAlarmInfo,rules:[{valid:/^.+$/,msg:'"Alarm Info" cannot be empty!'}]},{name:"limitValueInfo",selector:"#divRuleValue :text:enabled",rules:[{valid:/^.+$/,msg:"This field cannot be empty!"}]},{name:"alarmLevel",selector:this.$iptAlarmLevel,rules:[{valid:/^.+$/,msg:'"Alarm Level" cannot be empty!'}]}]})},attachEvents:function(){this.$btnClose.click(function(e){ScreenManager.show(PaneProjectSelector)}),this.$btnCog.click(function(e){_this.stopAutoload(),_this.$panelLog.hide(),_this.$panelCog.show(),_this.$tbRule.table("loading"),$.getJSON("/warning/getConfig/"+AppConfig.projectId,function(rs){_this.$tbRule.table("load",rs)}),e.preventDefault()}),this.$btnLogList.click(function(e){_this.$panelCog.hide(),_this.$panelLog.show(),_this.startAutoload()}),this.$btnReload.click(function(){_this.reloadRecord()}),this.$tbAlarm.on("click",".dropdown-menu>li",function(e){var $this=$(this),rowIndex=parseInt($this.parents("tr").attr("data-rowindex")),rowData=_this.$tbAlarm.table("getData")[rowIndex],minutes=parseInt($this.attr("data-value")),deadline=util.date.formatString(new Date((new Date).valueOf()+60*minutes*1e3)),msg='You have chosen "{0}", this alarm will not be shown until the time below:\n{1}\nAre you sure to do this?'.format($this.children("a").text(),deadline);_this.stopAutoload(),confirm(msg)?(_this.setDelayTime(rowData,deadline),_this.startAutoload()):_this.startAutoload(!1),e.stopPropagation()}),this.$btnAlarmSrch.click(function(e){var startTime=_this.$iptStartTime.val()||"1970-01-01 00:00:00",endTime=_this.$iptEndTime.val()||util.date.formatString(new Date);_this.$tbAlarm.table("loading"),$.getJSON("/warning/getRecord/"+AppConfig.projectId,{startTime:startTime,endTime:endTime},function(rs){_this.$tbAlarm.table("load",rs)}),e.preventDefault()}),this.$btnRuleSrch.click(function(e){var key=_this.$iptRuleSrch.val().trim();_this.$cbSelectAll.prop("checked",!1),key?_this.$tbRule.table("filter",{pointname:key}):_this.$tbRule.table("filter"),e.preventDefault()}),this.$btnAddRule.click(function(){_this.$ruleModal.find(".modal-title").text("Add Rule"),_this.$btnRuleSubmit.attr("data-action","add"),_this.setModal(),_this.$ruleModal.modal("show")}),this.$btnDelRule.click(function(){var $chosen=$(".ui-tbl-col-cb>input:checked"),names=[],data=_this.$tbRule.table("getData"),index=null;return 0===$chosen.length?void alert("You should choose one row at least!"):($chosen.each(function(i,item){index=parseInt($(item).attr("data-rowindex")),names.push(data[index].pointname)}),void _this.delRule("Are you sure to delete these rules?",names))}),this.$btnSelectAll.click(function(e){_this.$cbSelectAll.trigger("click"),e.preventDefault()}),this.$cbSelectAll.click(function(e){var $ckbs=$(".ui-tbl-col-cb").children("input");$(this).is(":checked")?util.checkbox.selectAll($ckbs):util.checkbox.unSelectAll($ckbs),e.stopPropagation()}),this.$lkSelectAll.click(function(e){var $ckbs=$(".ui-tbl-col-cb").children("input");util.checkbox.selectAll($ckbs),_this.$cbSelectAll.prop("checked",!0)}),this.$lkSelectInverse.click(function(e){var $ckbs=$(".ui-tbl-col-cb").children("input");util.checkbox.selectInverse($ckbs),_this.$cbSelectAll.prop("checked",util.checkbox.isAllChecked($ckbs))}),this.$lkUnSelectAll.click(function(e){var $ckbs=$(".ui-tbl-col-cb").children("input");util.checkbox.unSelectAll($ckbs),_this.$cbSelectAll.prop("checked",!1)}),this.$tbRule.on("click",".ui-tbl-col-cb",function(){var $ckbs=($(this),$(".ui-tbl-col-cb").children("input"));_this.$cbSelectAll.prop("checked",util.checkbox.isAllChecked($ckbs))}),this.$cbLL.click(function(){_this.$iptLL.add(_this.$iptLLInfo).prop("disabled",!$(this).is(":checked")),util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(":checkbox"))}),this.$cbL.click(function(){_this.$iptL.add(_this.$iptLInfo).prop("disabled",!$(this).is(":checked")),util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(":checkbox"))}),this.$cbH.click(function(){_this.$iptH.add(_this.$iptHInfo).prop("disabled",!$(this).is(":checked")),util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(":checkbox"))}),this.$cbHH.click(function(){_this.$iptHH.add(_this.$iptHHInfo).prop("disabled",!$(this).is(":checked")),util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(":checkbox"))}),this.$tbRule.on("click",".btn-rule-edit",function(){var $this=$(this),index=$this.parents("tr").attr("data-rowindex"),rowData=_this.$tbRule.table("getData")[index];_this.$btnRuleSubmit.attr("data-action","edit"),_this.$ruleModal.find(".modal-title").text("Edit Rule"),_this.setModal(rowData),_this.$ruleModal.modal("show")}),this.$tbRule.on("click",".btn-rule-del",function(){var $this=$(this),index=$this.parents("tr").attr("data-rowindex"),pointName=_this.$tbRule.table("getData")[index].pointname;_this.delRule("Are you sure to delete this rule?",[pointName])}),this.$lkAlarmModeItems.click(function(e){var $this=$(this),value=parseInt($this.attr("data-value")),title=$this.text();switch(_this.$spAlarmModeTitle.attr("data-value",value).text(title),value){case alarmMode.LIMIT_VALUE:_this.$divAlarmInfo.hide(),_this.$divRuleEnable.show(),_this.$divRuleValue.show();break;case alarmMode.BOOL:default:_this.$divAlarmInfo.show(),_this.$divRuleEnable.hide(),_this.$divRuleValue.hide()}}),this.$btnRuleSubmit.click(function(){var valid,p={},url="add"===$(this).attr("data-action")?"/warning/addWarningConfig/":"/warning/modifyWarningConfig/";p.pointname=_this.$iptPointName.val(),p.unitproperty01=0,p.warninglevel=_this.$iptAlarmLevel.val(),p.warningtype=parseInt(_this.$spAlarmModeTitle.attr("data-value")),p.warningtype!==alarmMode.LIMIT_VALUE?(p.HHEnable=0,p.HEnable=0,p.LEnable=0,p.LLEnable=0,p.HHLimit=0,p.HLimit=0,p.LLimit=0,p.LLLimit=0,p.HHwarninginfo="",p.Hwarninginfo="",p.Lwarninginfo="",p.LLwarninginfo="",p.boolwarninginfo=_this.$iptAlarmInfo.val(),valid=_this.$divRuleForm.validator("not","limitValueInfo").valid()):(p.HHEnable=_this.$cbHH.is(":checked")?1:0,p.HEnable=_this.$cbH.is(":checked")?1:0,p.LEnable=_this.$cbL.is(":checked")?1:0,p.LLEnable=_this.$cbLL.is(":checked")?1:0,p.HHLimit=1===p.HHEnable?parseInt(_this.$iptHH.val()):0,p.HLimit=1===p.HEnable?parseInt(_this.$iptH.val()):0,p.LLimit=1===p.LEnable?parseInt(_this.$iptL.val()):0,p.LLLimit=1===p.LLEnable?parseInt(_this.$iptLL.val()):0,p.HHwarninginfo=1===p.HHEnable?_this.$iptHHInfo.val():"",p.Hwarninginfo=1===p.HEnable?_this.$iptHInfo.val():"",p.Lwarninginfo=1===p.LEnable?_this.$iptLInfo.val():"",p.LLwarninginfo=1===p.LLEnable?_this.$iptLLInfo.val():"",p.boolwarninginfo="",valid=_this.$divRuleForm.validator("not","alarmInfo").valid()),valid.status&&(Spinner.spin(_this.$ruleModal[0]),$.post(url+AppConfig.projectId,p).done(function(rs){return rs=JSON.parse(rs),0!==rs.status?void alert("Sorry, operation faild, we will fix this as soom as possible."):(_this.$tbRule.table("loading"),void $.getJSON("/warning/getConfig/"+AppConfig.projectId,function(rs){_this.$tbRule.table("load",rs)}))}).always(function(){_this.$ruleModal.modal("hide"),Spinner.stop()}))}),$(window).resize(this.resize)},setDelayTime:function(row,delayTime){var rules=JSON.parse(localStorage.getItem(ALARM_RULE_NAME))||{},key=window.encodeURIComponent(row.bindpointname+"_"+row.time),projectId=AppConfig.projectId,datetimeNow=util.date.formatString(new Date);rules[projectId]=rules[projectId]||{};for(var i in rules[projectId])rules[projectId].hasOwnProperty(i)&&rules[projectId][i]<=datetimeNow&&delete rules[projectId][i];rules[AppConfig.projectId][key]=delayTime,localStorage.setItem(ALARM_RULE_NAME,JSON.stringify(rules))},filterByDelayRule:function(data){var result=[],rules=JSON.parse(localStorage.getItem(ALARM_RULE_NAME)),row=deadline=key=null;if(!rules||!(rules=rules[AppConfig.projectId]))return data;for(var i=0,len=data.length;len>i;i++)row=data[i],key=window.encodeURIComponent(row.bindpointname+"_"+row.time),(deadline=rules[key])?data[i].endtime>=deadline&&result.push(row):result.push(row);return result},setModal:function(data){if(this.$divRuleForm.validator("resetStatus"),this.$iptPointName.val(""),this.$iptAlarmLevel.val(""),this.$iptAlarmInfo.val(""),this.$iptLL.val("").prop("disabled",!1),this.$iptL.val("").prop("disabled",!0),this.$iptH.val("").prop("disabled",!0),this.$iptHH.val("").prop("disabled",!0),this.$cbLL.prop("checked",!0),this.$cbL.prop("checked",!1),this.$cbH.prop("checked",!1),this.$cbHH.prop("checked",!1),this.$iptLLInfo.val("").prop("disabled",!1),this.$iptLInfo.val("").prop("disabled",!0),this.$iptHInfo.val("").prop("disabled",!0),this.$iptHHInfo.val("").prop("disabled",!0),data)switch(this.$iptPointName.val(data.pointname).prop("disabled",!0),this.$btnAlarmMode.prop("disabled",!0),this.$iptAlarmLevel.val(data.boolwarninglevel),data.boolwarning){case alarmMode.LIMIT_VALUE:this.$lkAlarmModeItems.eq(1).trigger("click"),this.$iptLL.val(data.LLLimit).prop("disabled",0===data.LLEnable?!0:!1),this.$iptL.val(data.LLimit).prop("disabled",0===data.LEnable?!0:!1),this.$iptH.val(data.HLimit).prop("disabled",0===data.HEnable?!0:!1),this.$iptHH.val(data.HHLimit).prop("disabled",0===data.HHEnable?!0:!1),this.$cbLL.prop("checked",0===data.LLEnable?!1:!0),this.$cbL.prop("checked",0===data.LEnable?!1:!0),this.$cbH.prop("checked",0===data.HEnable?!1:!0),this.$cbHH.prop("checked",0===data.HHEnable?!1:!0),util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(":checkbox")),this.$iptLLInfo.val(data.LLwarninginfo).prop("disabled",0===data.LLEnable?!0:!1),this.$iptLInfo.val(data.Lwarninginfo).prop("disabled",0===data.LEnable?!0:!1),this.$iptHInfo.val(data.Hwarninginfo).prop("disabled",0===data.HEnable?!0:!1),this.$iptHHInfo.val(data.HHwarninginfo).prop("disabled",0===data.HHEnable?!0:!1);break;case alarmMode.BOOL:this.$iptAlarmInfo.val(data.boolwarninginfo),this.$lkAlarmModeItems.eq(0).trigger("click");break;default:return"Unknow"}else this.$iptPointName.prop("disabled",!1),this.$btnAlarmMode.prop("disabled",!1),this.$lkAlarmModeItems.eq(0).trigger("click")},reloadRecord:function(data){if(data)_this.$tbAlarm.table("load",_this.filterByDelayRule(data)),_this.$spLoading.removeClass("loading");else{if(_this.$spLoading.hasClass("loading"))return;window.BackgroundWorkers.alarmReporter.postMessage({type:"dataAlarmRealtime",projectId:AppConfig.projectId})}},delRule:function(msg,names){msg=msg||"Are you sure to do this operation?",confirm(msg)&&(Spinner.spin(_this.$alarmLoggingPane[0]),$.post("/warning/deleteWarningConfig/"+AppConfig.projectId,{pointNames:names.join("','")}).done(function(rs){return rs=JSON.parse(rs),0!==rs.status?void alert("Sorry, operation faild, we will fix this as soom as possible."):(_this.$tbRule.table("loading"),void $.getJSON("/warning/getConfig/"+AppConfig.projectId,function(rs){_this.$tbRule.table("load",rs)}))}).always(function(){Spinner.stop()}))},resize:function(){var totalHeight=$(window).height(),height=totalHeight-278;100>height||(_this.$tbAlarm.table("setStretchHeight",height),_this.$tbRule.table("setStretchHeight",height))},close:function(){this.stopAutoload()}},AlarmLogging}();!function(){function t(){}function e(t){var e=U.call(arguments,1);return function(){return t.apply(this,e)}}function n(t,e){if(!e)throw new Error("prayer failed: "+t)}function i(t){n("a direction was passed",t===G||t===X)}function r(e,n,i,r){function s(){u=a;var t=c.selection?"$"+c.selection.latex()+"$":"";d.select(t)}function o(){h.detach(),l.focused=!1}var c,h,l,u,p,f,d,m=e.contents().detach();return i||e.addClass("mathquill-rendered-math"),n.jQ=e.attr(F,n.id),n.revert=function(){e.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(m)},c=n.cursor=I(n),n.renderLatex(m.text()),h=n.textarea=Z('<span class="textarea"><textarea></textarea></span>'),l=h.children(),n.selectionChanged=function(){u===a&&(u=setTimeout(s)),ue(e[0])},e.bind("selectstart.mathquill",function(t){t.target!==l[0]&&t.preventDefault(),t.stopPropagation()}),f=c.blink,e.bind("mousedown.mathquill",function(n){function i(t){return c.seek(Z(t.target),t.pageX,t.pageY),(c[G]!==p[G]||c.parent!==p.parent)&&c.selectFrom(p),!1}function s(t){return delete t.target,i(t)}function o(t){p=a,c.blink=f,c.selection||(r?c.show():h.detach()),e.unbind("mousemove",i),Z(t.target.ownerDocument).unbind("mousemove",s).unbind("mouseup",o)}return setTimeout(function(){l.focus(),l.focused=!0}),c.blink=t,c.seek(Z(n.target),n.pageX,n.pageY),p=Y(c.parent,c[G],c[X]),r||l.focused||e.prepend(h),e.mousemove(i),Z(n.target.ownerDocument).mousemove(s).mouseup(o),!1}),r?(d=K(l,{container:e,key:function(t,e){c.parent.bubble("onKey",t,e)},text:function(t){c.parent.bubble("onText",t)},cut:function(t){c.selection&&setTimeout(function(){c.prepareEdit(),c.parent.bubble("redraw")}),t.stopPropagation()},paste:function(t){t="$"===t.slice(0,1)&&"$"===t.slice(-1)?t.slice(1,-1):"\\text{"+t+"}",c.writeLatex(t).show()}}),e.prepend(h),e.addClass("mathquill-editable"),i&&e.addClass("mathquill-textbox"),l.focus(function(t){c.parent||c.insAtRightEnd(n),c.parent.jQ.addClass("hasCursor"),c.selection?(c.selection.jQ.removeClass("blur"),setTimeout(n.selectionChanged)):c.show(),t.stopPropagation()}).blur(function(t){c.hide().parent.blur(),c.selection&&c.selection.jQ.addClass("blur"),t.stopPropagation()}),void e.bind("focus.mathquill blur.mathquill",function(t){l.trigger(t)}).blur()):(d=K(l,{container:e}),e.bind("cut paste",!1).bind("copy",s).prepend('<span class="selectable">$'+n.latex()+"$</span>"),void l.blur(function(){c.clearSelection(),setTimeout(o)}))}function s(t,e,n){return H(q,{ctrlSeq:t,htmlTemplate:"<"+e+" "+n+">&0</"+e+">"})}var a,o,c,h,l,u,p,f,d,m,g,b,v,w,x,j,k,q,y,Q,C,S,L,D,O,E,A,R,T,z,$,B,I,_,W=window.jQuery,M="mathquill-command-id",F="mathquill-block-id",P=Math.min,U=(Math.max,[].slice),H=function(t,e,n){function i(t){return"object"==typeof t}function r(t){return"function"==typeof t}function s(){}return function a(o,c){function h(){var t=new l;return r(t.init)&&t.init.apply(t,arguments),t}function l(){}var u,p,f;return c===n&&(c=o,o=Object),h.Bare=l,u=s[t]=o[t],p=l[t]=h[t]=h.p=new s,p.constructor=h,h.mixin=function(e){return l[t]=h[t]=a(h,e)[t],h},(h.open=function(t){if(f={},r(t)?f=t.call(h,p,u,h,o):i(t)&&(f=t),i(f))for(var n in f)e.call(f,n)&&(p[n]=f[n]);return r(p.init)||(p.init=o),h})(c)}}("prototype",{}.hasOwnProperty),K=function(){function e(t){var e,i=t.which||t.keyCode,r=n[i],s=[];return t.ctrlKey&&s.push("Ctrl"),t.originalEvent&&t.originalEvent.metaKey&&s.push("Meta"),t.altKey&&s.push("Alt"),t.shiftKey&&s.push("Shift"),e=r||String.fromCharCode(i),s.length||r?(s.push(e),s.join("-")):e}var n={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return function(n,i){function r(t){j=t,clearTimeout(k),k=setTimeout(t)}function s(e){j(),j=t,clearTimeout(k),w.val(e),e&&w[0].select()}function a(){var t=w[0];return"selectionStart"in t?t.selectionStart!==t.selectionEnd:!1}function o(t){var e=w.val();w.val(""),e&&t(e)}function c(){g(e(q),q)}function h(t){q=t,y=null,c()}function l(t){q&&y&&c(),y=t,r(u)}function u(){a()||o(m)}function p(){q=y=null}function f(){w.focus(),r(d)}function d(){o(b)}var m,g,b,v,w,x,j,k,q=null,y=null;return i||(i={}),m=i.text||t,g=i.key||t,b=i.paste||t,v=i.cut||t,w=W(n),x=W(i.container||w),j=t,x.bind("keydown keypress input keyup focusout paste",function(){j()}),x.bind({keydown:h,keypress:l,focusout:p,cut:v,paste:f}),{select:s}}}(),N=H(function(t,e,i){function r(t,e){throw t=t?"'"+t+"'":"EOF","Parse Error: "+e+" at "+t}var s,a,o,c,h,l,u,p,f,d,m,g,b;t.init=function(t){this._=t},t.parse=function(t){function e(t,e){return e}return this.skip(b)._(t,e,r)},t.or=function(t){n("or is passed a parser",t instanceof i);var e=this;return i(function(n,i,r){function s(){return t._(n,i,r)}return e._(n,i,s)})},t.then=function(t){var e=this;return i(function(r,s,a){function o(e,r){var o=t instanceof i?t:t(r);return n("a parser is returned",o instanceof i),o._(e,s,a)}return e._(r,o,a)})},t.many=function(){var t=this;return i(function(e,n){function i(t,n){return e=t,s.push(n),!0}function r(){return!1}for(var s=[];t._(e,i,r););return n(e,s)})},t.times=function(t,e){arguments.length<2&&(e=t);var n=this;return i(function(i,r,s){function a(t,e){return u.push(e),i=t,!0}function o(t,e){return h=e,i=t,!1}function c(){return!1}var h,l,u=[],p=!0;for(l=0;t>l;l+=1)if(p=n._(i,a,o),!p)return s(i,h);for(;e>l&&p;l+=1)p=n._(i,a,c);return r(i,u)})},t.result=function(t){return this.then(o(t))},t.atMost=function(t){return this.times(0,t)},t.atLeast=function(t){var e=this;return e.times(t).then(function(t){return e.many().map(function(e){return t.concat(e)})})},t.map=function(t){return this.then(function(e){return o(t(e))})},t.skip=function(t){return this.then(function(e){return t.result(e)})},s=this.string=function(t){var e=t.length,n="expected '"+t+"'";return i(function(i,r,s){var a=i.slice(0,e);return a===t?r(i.slice(e),a):s(i,n)})},a=this.regex=function(t){n("regexp parser is anchored","^"===t.toString().charAt(1));var e="expected "+t;return i(function(n,i,r){var s,a=t.exec(n);return a?(s=a[0],i(n.slice(s.length),s)):r(n,e)})},o=i.succeed=function(t){return i(function(e,n){return n(e,t)})},c=i.fail=function(t){return i(function(e,n,i){return i(e,t)})},h=i.letter=a(/^[a-z]/i),l=i.letters=a(/^[a-z]*/i),u=i.digit=a(/^[0-9]/),p=i.digits=a(/^[0-9]*/),f=i.whitespace=a(/^\s+/),d=i.optWhitespace=a(/^\s*/),m=i.any=i(function(t,e,n){return t?e(t.slice(1),t.charAt(0)):n(t,"expected any character")}),g=i.all=i(function(t,e){return e("",t)}),b=i.eof=i(function(t,e,n){return t?n(t,"expected EOF"):e(t,t)})}),G=-1,X=1,Z=H(W,function(t){t.insDirOf=function(t,e){return t===G?this.insertBefore(e.first()):this.insertAfter(e.last())},t.insAtDirEnd=function(t,e){return t===G?this.prependTo(e):this.appendTo(e)}}),Y=H(function(t){t.parent=0,t[G]=0,t[X]=0,t.init=function(t,e,n){this.parent=t,this[G]=e,this[X]=n}}),J=H(function(t){t[G]=0,t[X]=0,t.parent=0,t.init=function(){this.ends={},this.ends[G]=0,this.ends[X]=0},t.children=function(){return V(this.ends[G],this.ends[X])},t.eachChild=function(t){return this.children().each(t)},t.foldChildren=function(t,e){return this.children().fold(t,e)},t.adopt=function(t,e,n){return V(this,this).adopt(t,e,n),this},t.disown=function(){return V(this,this).disown(),this}}),V=H(function(t){function e(t,e,i){n("a parent is always present",t),n("leftward is properly set up",function(){return e?e[X]===i&&e.parent===t:t.ends[G]===i}()),n("rightward is properly set up",function(){return i?i[G]===e&&i.parent===t:t.ends[X]===e}())}t.init=function(t,e){n("no half-empty fragments",!t==!e),this.ends={},t&&(n("left end node is passed to Fragment",t instanceof J),n("right end node is passed to Fragment",e instanceof J),n("leftEnd and rightEnd have the same parent",t.parent===e.parent),this.ends[G]=t,this.ends[X]=e)},t.adopt=function(t,n,i){var r,s,a;return e(t,n,i),r=this,r.disowned=!1,(s=r.ends[G])?(a=r.ends[X],n||(t.ends[G]=s),i?i[G]=a:t.ends[X]=a,r.ends[X][X]=i,r.each(function(e){e[G]=n,e.parent=t,n&&(n[X]=e),n=e}),r):this},t.disown=function(){var t,n,i=this,r=i.ends[G];return!r||i.disowned?i:(i.disowned=!0,t=i.ends[X],n=r.parent,e(n,r[G],r),e(n,t,t[X]),r[G]?r[G][X]=t[X]:n.ends[G]=t[X],t[X]?t[X][G]=r[G]:n.ends[X]=r[G],i)},t.each=function(t){var e=this,n=e.ends[G];if(!n)return e;for(;n!==e.ends[X][X]&&t.call(e,n)!==!1;n=n[X]);return e},t.fold=function(t,e){return this.each(function(n){t=e.call(this,t,n)}),t}}),te=function(){var t=0;return function(){return t+=1}}(),ee=H(J,function(t,e){t.init=function(){e.init.call(this),this.id=te(),ee[this.id]=this},t.toString=function(){return"[MathElement "+this.id+"]"},t.bubble=function(t){var e,n,i=U.call(arguments,1);for(e=this;e&&(n=e[t]&&e[t].apply(e,i),n!==!1);e=e.parent);return this},t.postOrder=function(t){var e,n=U.call(arguments,1);"string"==typeof t&&(e=t,t=function(t){e in t&&t[e].apply(t,n)}),function i(e){e.eachChild(i),t(e)}(this)},t.jQ=Z(),t.jQadd=function(t){this.jQ=this.jQ.add(t)},this.jQize=function(t){var e=Z(t);return e.find("*").andSelf().each(function(){var t=Z(this),e=t.attr("mathquill-command-id"),n=t.attr("mathquill-block-id");e&&ee[e].jQadd(t),n&&ee[n].jQadd(t)}),e},t.finalizeInsert=function(){var t=this;t.postOrder("finalizeTree"),t.postOrder("blur"),t.postOrder("respace"),t[X].respace&&t[X].respace(),t[G].respace&&t[G].respace(),t.postOrder("redraw"),t.bubble("redraw")}}),ne=H(ee,function(e,i){e.init=function(t,e,n){var r=this;i.init.call(r),r.ctrlSeq||(r.ctrlSeq=t),e&&(r.htmlTemplate=e),n&&(r.textTemplate=n)},e.replaces=function(t){t.disown(),this.replacedFragment=t},e.isEmpty=function(){return this.foldChildren(!0,function(t,e){return t&&e.isEmpty()})},e.parser=function(){var t=B.block,e=this;return t.times(e.numBlocks()).map(function(t){e.blocks=t;for(var n=0;n<t.length;n+=1)t[n].adopt(e,e.ends[X],0);return e})},e.createLeftOf=function(t){var e=this,n=e.replacedFragment;e.createBlocks(),ee.jQize(e.html()),n&&(n.adopt(e.ends[G],0,0),n.jQ.appendTo(e.ends[G].jQ)),t.jQ.before(e.jQ),t[G]=e.adopt(t.parent,t[G],t[X]),e.finalizeInsert(t),e.placeCursor(t)},e.createBlocks=function(){var t,e,n=this,i=n.numBlocks(),r=n.blocks=Array(i);for(t=0;i>t;t+=1)e=r[t]=re(),e.adopt(n,n.ends[X],0)},e.respace=t,e.placeCursor=function(t){t.insAtRightEnd(this.foldChildren(this.ends[G],function(t,e){return t.isEmpty()?t:e}))},e.remove=function(){return this.disown(),this.jQ.remove(),this.postOrder(function(t){delete ee[t.id]}),this},e.numBlocks=function(){var t=this.htmlTemplate.match(/&\d+/g);return t?t.length:0},e.html=function(){var t,e,i,r=this,s=r.blocks,a=" mathquill-command-id="+r.id,o=r.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);for(n("no unmatched angle brackets",o.join("")===this.htmlTemplate),t=0,e=o[0];e;t+=1,e=o[t])if("/>"===e.slice(-2))o[t]=e.slice(0,-2)+a+"/>";else if("<"===e.charAt(0)){n("not an unmatched top-level close tag","/"!==e.charAt(1)),o[t]=e.slice(0,-1)+a+">",i=1;do t+=1,e=o[t],n("no missing close tags",e),"</"===e.slice(0,2)?i-=1:"<"===e.charAt(0)&&"/>"!==e.slice(-2)&&(i+=1);while(i>0)}return o.join("").replace(/>&(\d+)/g,function(t,e){return" mathquill-block-id="+s[e].id+">"+s[e].join("html")})},e.latex=function(){return this.foldChildren(this.ctrlSeq,function(t,e){return t+"{"+(e.latex()||" ")+"}"})},e.textTemplate=[""],e.text=function(){var t=this,e=0;return t.foldChildren(t.textTemplate[e],function(n,i){e+=1;var r=i.text();return n&&"("===t.textTemplate[e]&&"("===r[0]&&")"===r.slice(-1)?n+r.slice(1,-1)+t.textTemplate[e]:n+i.text()+(t.textTemplate[e]||"")})}}),ie=H(ne,function(e,n){e.init=function(t,e,i){i||(i=t&&t.length>1?t.slice(1):t),n.init.call(this,t,e,[i])},e.parser=function(){return N.succeed(this)},e.numBlocks=function(){return 0},e.replaces=function(t){t.remove()},e.createBlocks=t,e.latex=function(){return this.ctrlSeq},e.text=function(){return this.textTemplate},e.placeCursor=t,e.isEmpty=function(){return!0}}),re=H(ee,function(t){t.join=function(t){return this.foldChildren("",function(e,n){return e+n[t]()})},t.latex=function(){return this.join("latex")},t.text=function(){return this.ends[G]===this.ends[X]?this.ends[G].text():"("+this.join("text")+")"},t.isEmpty=function(){return 0===this.ends[G]&&0===this.ends[X]},t.write=function(t,e,n){var i;i=e.match(/^[a-eg-zA-Z]$/)?D(e):(i=he[e]||le[e])?i(e):O(e),n&&i.replaces(n),i.createLeftOf(t)},t.focus=function(){return this.jQ.addClass("hasCursor"),this.jQ.removeClass("empty"),this},t.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this}}),se=H(V,function(t,e){t.init=function(t,n){e.init.call(this,t,n||t),this.jQ=this.fold(Z(),function(t,e){return e.jQ.add(t)})},t.latex=function(){return this.fold("",function(t,e){return t+e.latex()})},t.remove=function(){return this.jQ.remove(),this.each(function(t){t.postOrder(function(t){delete ee[t.id]})}),this.disown()}}),ae=H(re,function(t,e){t.latex=function(){return e.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/gi,"$1")},t.text=function(){return this.foldChildren("",function(t,e){return t+e.text()})},t.renderLatex=function(t){var e=this.jQ;e.children().slice(1).remove(),this.ends[G]=this.ends[X]=0,delete this.cursor.selection,this.cursor.insAtRightEnd(this).writeLatex(t)},t.onKey=function(t,e){var n;switch(t){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":for(;this.cursor[G]||this.cursor.selection;)this.cursor.backspace();break;case"Shift-Backspace":case"Backspace":this.cursor.backspace();break;case"Esc":case"Tab":case"Spacebar":if(n=this.cursor.parent,n===this.cursor.root)return void("Spacebar"===t&&e.preventDefault());this.cursor.prepareMove(),n[X]?this.cursor.insAtLeftEnd(n[X]):this.cursor.insRightOf(n.parent);break;case"Shift-Tab":case"Shift-Esc":case"Shift-Spacebar":if(n=this.cursor.parent,n===this.cursor.root)return void("Shift-Spacebar"===t&&e.preventDefault());this.cursor.prepareMove(),n[G]?this.cursor.insAtRightEnd(n[G]):this.cursor.insLeftOf(n.parent);break;case"Enter":break;case"End":this.cursor.prepareMove().insAtRightEnd(this.cursor.parent);break;case"Ctrl-End":this.cursor.prepareMove().insAtRightEnd(this);break;case"Shift-End":for(;this.cursor[X];)this.cursor.selectRight();break;case"Ctrl-Shift-End":for(;this.cursor[X]||this.cursor.parent!==this;)this.cursor.selectRight();break;case"Home":this.cursor.prepareMove().insAtLeftEnd(this.cursor.parent);break;case"Ctrl-Home":this.cursor.prepareMove().insAtLeftEnd(this);break;case"Shift-Home":for(;this.cursor[G];)this.cursor.selectLeft();break;case"Ctrl-Shift-Home":for(;this.cursor[G]||this.cursor.parent!==this;)this.cursor.selectLeft();break;case"Left":this.cursor.moveLeft();break;case"Shift-Left":this.cursor.selectLeft();break;case"Ctrl-Left":break;case"Right":this.cursor.moveRight();break;case"Shift-Right":this.cursor.selectRight();break;case"Ctrl-Right":break;case"Up":this.cursor.moveUp();break;case"Down":this.cursor.moveDown();break;case"Shift-Up":if(this.cursor[G])for(;this.cursor[G];)this.cursor.selectLeft();else this.cursor.selectLeft();case"Shift-Down":if(this.cursor[X])for(;this.cursor[X];)this.cursor.selectRight();else this.cursor.selectRight();case"Ctrl-Up":break;case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":for(;this.cursor[X]||this.cursor.selection;)this.cursor.deleteForward();break;case"Shift-Del":case"Del":this.cursor.deleteForward();break;case"Meta-A":case"Ctrl-A":if(this!==this.cursor.root)return;for(this.cursor.prepareMove().insAtRightEnd(this);this.cursor[G];)this.cursor.selectLeft();break;default:return!1}return e.preventDefault(),!1},t.onText=function(t){return this.cursor.write(t),!1}}),oe=H(ne,function(t,e){t.init=function(t){e.init.call(this,"$"),this.cursor=t},t.htmlTemplate='<span class="mathquill-rendered-math">&0</span>',t.createBlocks=function(){this.ends[G]=this.ends[X]=ae(),this.blocks=[this.ends[G]],this.ends[G].parent=this,this.ends[G].cursor=this.cursor,this.ends[G].write=function(t,e,n){"$"!==e?re.prototype.write.call(this,t,e,n):this.isEmpty()?(t.insRightOf(this.parent).backspace().show(),O("\\$","$").createLeftOf(t)):t[X]?t[G]?re.prototype.write.call(this,t,e,n):t.insLeftOf(this.parent):t.insRightOf(this.parent)}},t.latex=function(){return"$"+this.ends[G].latex()+"$"}}),ce=H(re,function(t){t.renderLatex=function(t){var e,n,i,r,s,a,o,c,h,l,u,p=this,f=p.cursor;if(p.jQ.children().slice(1).remove(),p.ends[G]=p.ends[X]=0,delete f.selection,f.show().insAtRightEnd(p),e=N.regex,n=N.string,i=N.eof,r=N.all,s=n("$").then(B).skip(n("$").or(i)).map(function(t){var e,n=oe(f);return n.createBlocks(),e=n.ends[G],t.children().adopt(e,0,0),n}),a=n("\\$").result("$"),o=a.or(e(/^[^$]/)).map(O),c=s.or(o).many(),h=c.skip(i).or(r.result(!1)).parse(t)){for(l=0;l<h.length;l+=1)h[l].adopt(p,p.ends[X],0);u=p.join("html"),ee.jQize(u).appendTo(p.jQ),this.finalizeInsert()}},t.onKey=function(t){"Spacebar"!==t&&"Shift-Spacebar"!==t&&ae.prototype.onKey.apply(this,arguments)},t.onText=ae.prototype.onText,t.write=function(t,e,n){if(n&&n.remove(),"$"===e)oe(t).createLeftOf(t);else{var i;"<"===e?i="&lt;":">"===e&&(i="&gt;"),O(e,i).createLeftOf(t)}}}),he={},le={},ue=t,pe=document.createElement("div"),fe=pe.style,de={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1};for(h in de)if(h in fe){c=h;break}c?o=function(t,e,n){t.css(c,"scale("+e+","+n+")")}:"filter"in fe?(ue=function(t){t.className=t.className},o=function(t,e,n){function i(){t.css("marginRight",(r.width()-1)*(e-1)/e+"px")}var r,s;e/=1+(n-1)/2,t.css("fontSize",n+"em"),t.hasClass("matrixed-container")||t.addClass("matrixed-container").wrapInner('<span class="matrixed"></span>'),r=t.children().css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+e+",SizingMethod='auto expand')"),i(),s=setInterval(i),Z(window).load(function(){clearTimeout(s),i()})}):o=function(t,e,n){t.css("fontSize",n+"em")},l=H(ne,function(t,e){t.init=function(t,n,i){e.init.call(this,t,"<"+n+" "+i+">&0</"+n+">")}}),le.mathrm=e(l,"\\mathrm","span",'class="roman font"'),le.mathit=e(l,"\\mathit","i",'class="font"'),le.mathbf=e(l,"\\mathbf","b",'class="font"'),le.mathsf=e(l,"\\mathsf","span",'class="sans-serif font"'),le.mathtt=e(l,"\\mathtt","span",'class="monospace font"'),le.underline=e(l,"\\underline","span",'class="non-leaf underline"'),le.overline=le.bar=e(l,"\\overline","span",'class="non-leaf overline"'),u=H(ne,function(t,e){t.init=function(t,n,i){e.init.call(this,t,"<"+n+' class="non-leaf">&0</'+n+">",[i])},t.finalizeTree=function(){function t(t){var e=this.parent,n=t;do{if(n[X])return t.insLeftOf(e),!1;n=n.parent.parent}while(n!==e);return t.insRightOf(e),!1}n("SupSub is only _ and ^","^"===this.ctrlSeq||"_"===this.ctrlSeq),"_"===this.ctrlSeq?(this.down=this.ends[G],this.ends[G].up=t):(this.up=this.ends[G],this.ends[G].down=t)},t.latex=function(){var t=this.ends[G].latex();return 1===t.length?this.ctrlSeq+t:this.ctrlSeq+"{"+(t||" ")+"}"},t.redraw=function(){this[G]&&this[G].respace(),this[G]instanceof u||(this.respace(),!this[X]||this[X]instanceof u||this[X].respace())},t.respace=function(){if("\\int "===this[G].ctrlSeq||this[G]instanceof u&&this[G].ctrlSeq!=this.ctrlSeq&&this[G][G]&&"\\int "===this[G][G].ctrlSeq?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),this.respaced=this[G]instanceof u&&this[G].ctrlSeq!=this.ctrlSeq&&!this[G].respaced,this.respaced){var t=+this.jQ.css("fontSize").slice(0,-2),e=this[G].jQ.outerWidth(),n=this.jQ.outerWidth();this.jQ.css({left:(this.limit&&"_"===this.ctrlSeq?-.25:0)-e/t+"em",marginRight:.1-P(n,e)/t+"em"})}else this.jQ.css(this.limit&&"_"===this.ctrlSeq?{left:"-.25em",marginRight:""}:{left:"",marginRight:""});return this[X]instanceof u&&this[X].respace(),this}}),le.subscript=le._=e(u,"_","sub","_"),le.superscript=le.supscript=le["^"]=e(u,"^","sup","**"),p=le.frac=le.dfrac=le.cfrac=le.fraction=H(ne,function(t){t.ctrlSeq="\\frac",t.htmlTemplate='<span class="fraction non-leaf"><span class="numerator">&0</span><span class="denominator">&1</span><span style="display:inline-block;width:0">&nbsp;</span></span>',t.textTemplate=["(","/",")"],t.finalizeTree=function(){this.up=this.ends[X].up=this.ends[G],this.down=this.ends[G].down=this.ends[X];

}}),f=le.over=he["/"]=H(p,function(t,e){t.createLeftOf=function(t){if(!this.replacedFragment){for(var n=t[G];n&&!(n instanceof R||n instanceof q||n instanceof z||/^[,;:]$/.test(n.ctrlSeq));)n=n[G];n instanceof z&&n[X]instanceof u&&(n=n[X],n[X]instanceof u&&n[X].ctrlSeq!=n.ctrlSeq&&(n=n[X])),n!==t[G]&&(this.replaces(se(n[X]||t.parent.ends[G],t[G])),t[G]=n)}e.createLeftOf.call(this,t)}}),d=le.sqrt=le["√"]=H(ne,function(t,e){t.ctrlSeq="\\sqrt",t.htmlTemplate='<span class="non-leaf"><span class="scaled sqrt-prefix">&radic;</span><span class="non-leaf sqrt-stem">&0</span></span>',t.textTemplate=["sqrt(",")"],t.parser=function(){return B.optBlock.then(function(t){return B.block.map(function(e){var n=g();return n.blocks=[t,e],t.adopt(n,0,0),e.adopt(n,t,0),n})}).or(e.parser.call(this))},t.redraw=function(){var t=this.ends[X].jQ;o(t.prev(),1,t.innerHeight()/+t.css("fontSize").slice(0,-2)-.1)}}),m=le.vec=H(ne,function(t){t.ctrlSeq="\\vec",t.htmlTemplate='<span class="non-leaf"><span class="vector-prefix">&rarr;</span><span class="vector-stem">&0</span></span>',t.textTemplate=["vec(",")"]}),g=le.nthroot=H(d,function(t){t.htmlTemplate='<sup class="nthroot non-leaf">&0</sup><span class="scaled"><span class="sqrt-prefix scaled">&radic;</span><span class="sqrt-stem non-leaf">&1</span></span>',t.textTemplate=["sqrt[","](",")"],t.latex=function(){return"\\sqrt["+this.ends[G].latex()+"]{"+this.ends[X].latex()+"}"}}),b=H(ne,function(t,e){t.init=function(t,n,i,r){e.init.call(this,"\\left"+i,'<span class="non-leaf"><span class="scaled paren">'+t+'</span><span class="non-leaf">&0</span><span class="scaled paren">'+n+"</span></span>",[t,n]),this.end="\\right"+r},t.jQadd=function(){e.jQadd.apply(this,arguments);var t=this.jQ;this.bracketjQs=t.children(":first").add(t.children(":last"))},t.latex=function(){return this.ctrlSeq+this.ends[G].latex()+this.end},t.redraw=function(){var t=this.ends[G].jQ,e=t.outerHeight()/+t.css("fontSize").slice(0,-2);o(this.bracketjQs,P(1+.2*(e-1),1.2),1.05*e)}}),le.left=H(ne,function(t){t.parser=function(){var t=N.regex,e=N.string,n=N.succeed,i=N.optWhitespace;return i.then(t(/^(?:[([|]|\\\{)/)).then(function(r){"\\"===r.charAt(0)&&(r=r.slice(1));var s=he[r]();return B.map(function(t){s.blocks=[t],t.adopt(s,0,0)}).then(e("\\right")).skip(i).then(t(/^(?:[\])|]|\\\})/)).then(function(t){return t.slice(-1)!==s.end.slice(-1)?N.fail("open doesn't match close"):n(s)})})}}),le.right=H(ne,function(t){t.parser=function(){return N.fail("unmatched \\right")}}),le.lbrace=he["{"]=e(b,"{","}","\\{","\\}"),le.langle=le.lang=e(b,"&lang;","&rang;","\\langle ","\\rangle "),v=H(b,function(t,e){t.createLeftOf=function(t){t[X]||!t.parent.parent||t.parent.parent.end!==this.end||this.replacedFragment?e.createLeftOf.call(this,t):t.insRightOf(t.parent.parent)},t.placeCursor=function(t){this.ends[G].blur(),t.insRightOf(this)}}),le.rbrace=he["}"]=e(v,"{","}","\\{","\\}"),le.rangle=le.rang=e(v,"&lang;","&rang;","\\langle ","\\rangle "),w=function(t,e){t.init=function(t,n){e.init.call(this,t,n,t,n)}},x=H(b,w),le.lparen=he["("]=e(x,"(",")"),le.lbrack=le.lbracket=he["["]=e(x,"[","]"),j=H(v,w),le.rparen=he[")"]=e(j,"(",")"),le.rbrack=le.rbracket=he["]"]=e(j,"[","]"),k=le.lpipe=le.rpipe=he["|"]=H(x,function(t,e){t.init=function(){e.init.call(this,"|","|")},t.createLeftOf=v.prototype.createLeftOf}),q=he.$=le.text=le.textnormal=le.textrm=le.textup=le.textmd=H(ne,function(t,e){t.ctrlSeq="\\text",t.htmlTemplate='<span class="text">&0</span>',t.replaces=function(t){t instanceof se?this.replacedText=t.remove().jQ.text():"string"==typeof t&&(this.replacedText=t)},t.textTemplate=['"','"'],t.parser=function(){var t=this,e=N.string,n=N.regex,i=N.optWhitespace;return i.then(e("{")).then(n(/^[^}]*/)).skip(e("}")).map(function(e){var n,i,r;for(t.createBlocks(),n=t.ends[G],i=0;i<e.length;i+=1)r=O(e.charAt(i)),r.adopt(n,n.ends[X],0);return t})},t.createBlocks=function(){this.ends[G]=this.ends[X]=y(),this.blocks=[this.ends[G]],this.ends[G].parent=this},t.finalizeInsert=function(){this.ends[G].blur=function(){return delete this.blur,this},e.finalizeInsert.call(this)},t.createLeftOf=function(t){if(e.createLeftOf.call(this,this.cursor=t),this.replacedText)for(var n=0;n<this.replacedText.length;n+=1)this.ends[G].write(t,this.replacedText.charAt(n))}}),y=H(re,function(t,e){t.onKey=function(t){return"Spacebar"===t||"Shift-Spacebar"===t?!1:void 0},t.deleteOutOf=function(t,e){this.isEmpty()&&e.insRightOf(this.parent)},t.write=function(t,e,n){var i,r;return n&&n.remove(),"$"!==e?("<"===e?i="&lt;":">"===e&&(i="&gt;"),O(e,i).createLeftOf(t)):this.isEmpty()?(t.insRightOf(this.parent).backspace(),O("\\$","$").createLeftOf(t)):t[X]?t[G]?(r=q(),r.replaces(se(t[X],this.ends[X])),t.insRightOf(this.parent),r.adopt=function(){delete this.adopt,this.adopt.apply(this,arguments),this[G]=0},r.createLeftOf(t),r[G]=this.parent,t.insLeftOf(r)):t.insLeftOf(this.parent):t.insRightOf(this.parent),!1},t.blur=function(){if(this.jQ.removeClass("hasCursor"),this.isEmpty()){var t=this.parent,e=t.cursor;e.parent===this?this.jQ.addClass("empty"):(e.hide(),t.remove(),e[X]===t?e[X]=t[X]:e[G]===t&&(e[G]=t[G]),e.show().parent.bubble("redraw"))}return this},t.focus=function(){var t,n,i,r;return e.focus.call(this),t=this.parent,t[X].ctrlSeq===t.ctrlSeq?(n=this,i=t.cursor,r=t[X].ends[G],r.eachChild(function(t){t.parent=n,t.jQ.appendTo(n.jQ)}),this.ends[X]?this.ends[X][X]=r.ends[G]:this.ends[G]=r.ends[G],r.ends[G][G]=this.ends[X],this.ends[X]=r.ends[X],r.parent.remove(),i[G]?i.insRightOf(i[G]):i.insAtLeftEnd(this),i.parent.bubble("redraw")):t[G].ctrlSeq===t.ctrlSeq&&(i=t.cursor,i[G]?t[G].ends[G].focus():i.insAtRightEnd(t[G].ends[G])),this}}),le.em=le.italic=le.italics=le.emph=le.textit=le.textsl=s("\\textit","i",'class="text"'),le.strong=le.bold=le.textbf=s("\\textbf","b",'class="text"'),le.sf=le.textsf=s("\\textsf","span",'class="sans-serif text"'),le.tt=le.texttt=s("\\texttt","span",'class="monospace text"'),le.textsc=s("\\textsc","span",'style="font-variant:small-caps" class="text"'),le.uppercase=s("\\uppercase","span",'style="text-transform:uppercase" class="text"'),le.lowercase=s("\\lowercase","span",'style="text-transform:lowercase" class="text"'),Q=he["\\"]=H(ne,function(t,e){t.ctrlSeq="\\",t.replaces=function(t){this._replacedFragment=t.disown(),this.isEmpty=function(){return!1}},t.htmlTemplate='<span class="latex-command-input non-leaf">\\<span>&0</span></span>',t.textTemplate=["\\"],t.createBlocks=function(){e.createBlocks.call(this),this.ends[G].focus=function(){return this.parent.jQ.addClass("hasCursor"),this.isEmpty()&&this.parent.jQ.removeClass("empty"),this},this.ends[G].blur=function(){return this.parent.jQ.removeClass("hasCursor"),this.isEmpty()&&this.parent.jQ.addClass("empty"),this}},t.createLeftOf=function(t){if(e.createLeftOf.call(this,t),this.cursor=t.insAtRightEnd(this.ends[G]),this._replacedFragment){var n=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(t){return Z(t.target=n).trigger(t),!1}).insertBefore(this.jQ).add(this.jQ)}this.ends[G].write=function(t,e,n){n&&n.remove(),e.match(/[a-z]/i)?O(e).createLeftOf(t):(this.parent.renderCommand(),"\\"===e&&this.isEmpty()||this.parent.parent.write(t,e))}},t.latex=function(){return"\\"+this.ends[G].latex()+" "},t.onKey=function(t,e){return"Tab"===t||"Enter"===t||"Spacebar"===t?(this.renderCommand(),e.preventDefault(),!1):void 0},t.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this[X]?this.cursor.insLeftOf(this[X]):this.cursor.insAtRightEnd(this.parent);var t=this.ends[G].latex();t||(t="backslash"),this.cursor.insertCmd(t,this._replacedFragment)}}),C=le.binom=le.binomial=H(ne,function(t){t.ctrlSeq="\\binom",t.htmlTemplate='<span class="paren scaled">(</span><span class="non-leaf"><span class="array non-leaf"><span>&0</span><span>&1</span></span></span><span class="paren scaled">)</span>',t.textTemplate=["choose(",",",")"],t.redraw=function(){var t=this.jQ.eq(1),e=t.outerHeight()/+t.css("fontSize").slice(0,-2),n=this.jQ.filter(".paren");o(n,P(1+.2*(e-1),1.2),1.05*e)}}),S=le.choose=H(C,function(t){t.createLeftOf=f.prototype.createLeftOf}),L=le.vector=H(ne,function(t,e){t.ctrlSeq="\\vector",t.htmlTemplate='<span class="array"><span>&0</span></span>',t.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(t,e){return t.push(e.latex()),t}).join("\\\\")+"\\end{matrix}"},t.text=function(){return"["+this.foldChildren([],function(t,e){return t.push(e.text()),t}).join()+"]"},t.createLeftOf=function(t){e.createLeftOf.call(this,this.cursor=t)},t.onKey=function(t,e){var n,i=this.cursor.parent;if(i.parent===this){if("Enter"===t)return n=re(),n.parent=this,n.jQ=Z("<span></span>").attr(F,n.id).insertAfter(i.jQ),i[X]?i[X][G]=n:this.ends[X]=n,n[X]=i[X],i[X]=n,n[G]=i,this.bubble("redraw").cursor.insAtRightEnd(n),e.preventDefault(),!1;if("Tab"===t&&!i[X])return i.isEmpty()?i[G]?(this.cursor.insRightOf(this),delete i[G][X],this.ends[X]=i[G],i.jQ.remove(),this.bubble("redraw"),e.preventDefault(),!1):void 0:(n=re(),n.parent=this,n.jQ=Z("<span></span>").attr(F,n.id).appendTo(this.jQ),this.ends[X]=n,i[X]=n,n[G]=i,this.bubble("redraw").cursor.insAtRightEnd(n),e.preventDefault(),!1);if(8===e.which){if(i.isEmpty())return i[G]?(this.cursor.insAtRightEnd(i[G]),i[G][X]=i[X]):(this.cursor.insLeftOf(this),this.ends[G]=i[X]),i[X]?i[X][G]=i[G]:this.ends[X]=i[G],i.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.bubble("redraw"),e.preventDefault(),!1;if(!this.cursor[G])return e.preventDefault(),!1}}}}),le.editable=H(oe,function(t,e){t.init=function(){ne.prototype.init.call(this,"\\editable")},t.jQadd=function(){var t,n,i=this;e.jQadd.apply(i,arguments),t=i.ends[G].disown(),n=i.jQ.children().detach(),i.ends[G]=i.ends[X]=ae(),i.blocks=[i.ends[G]],i.ends[G].parent=i,r(i.jQ,i.ends[G],!1,!0),i.cursor=i.ends[G].cursor,t.children().adopt(i.ends[G],0,0),n.appendTo(i.ends[G].jQ),i.ends[G].cursor.insAtRightEnd(i.ends[G])},t.latex=function(){return this.ends[G].latex()},t.text=function(){return this.ends[G].text()}}),le.f=e(ie,"f",'<var class="florin">&fnof;</var><span style="display:inline-block;width:0">&nbsp;</span>'),D=H(ie,function(t,e){t.init=function(t,n){e.init.call(this,t,"<var>"+(n||t)+"</var>")},t.text=function(){var t=this.ctrlSeq;return!this[G]||this[G]instanceof D||this[G]instanceof R||(t="*"+t),!this[X]||this[X]instanceof R||"^"===this[X].ctrlSeq||(t+="*"),t}}),O=H(ie,function(t,e){t.init=function(t,n){e.init.call(this,t,"<span>"+(n||t)+"</span>")}}),he[" "]=e(O,"\\:"," "),le.prime=he["'"]=e(O,"'","&prime;"),E=H(ie,function(t,e){t.init=function(t,n){e.init.call(this,t,'<span class="nonSymbola">'+(n||t)+"</span>")}}),le["@"]=E,le["&"]=e(E,"\\&","&amp;"),le["%"]=e(E,"\\%","%"),le.alpha=le.beta=le.gamma=le.delta=le.zeta=le.eta=le.theta=le.iota=le.kappa=le.mu=le.nu=le.xi=le.rho=le.sigma=le.tau=le.chi=le.psi=le.omega=H(D,function(t,e){t.init=function(t){e.init.call(this,"\\"+t+" ","&"+t+";")}}),le.phi=e(D,"\\phi ","&#981;"),le.phiv=le.varphi=e(D,"\\varphi ","&phi;"),le.epsilon=e(D,"\\epsilon ","&#1013;"),le.epsiv=le.varepsilon=e(D,"\\varepsilon ","&epsilon;"),le.piv=le.varpi=e(D,"\\varpi ","&piv;"),le.sigmaf=le.sigmav=le.varsigma=e(D,"\\varsigma ","&sigmaf;"),le.thetav=le.vartheta=le.thetasym=e(D,"\\vartheta ","&thetasym;"),le.upsilon=le.upsi=e(D,"\\upsilon ","&upsilon;"),le.gammad=le.Gammad=le.digamma=e(D,"\\digamma ","&#989;"),le.kappav=le.varkappa=e(D,"\\varkappa ","&#1008;"),le.rhov=le.varrho=e(D,"\\varrho ","&#1009;"),le.pi=le["π"]=e(E,"\\pi ","&pi;"),le.lambda=e(E,"\\lambda ","&lambda;"),le.Upsilon=le.Upsi=le.upsih=le.Upsih=e(ie,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),le.Gamma=le.Delta=le.Theta=le.Lambda=le.Xi=le.Pi=le.Sigma=le.Phi=le.Psi=le.Omega=le.forall=H(O,function(t,e){t.init=function(t){e.init.call(this,"\\"+t+" ","&"+t+";")}}),A=H(ne,function(t){t.init=function(t){this.latex=t},t.createLeftOf=function(t){t.writeLatex(this.latex)},t.parser=function(){var t=B.parse(this.latex).children();return N.succeed(t)}}),le["¹"]=e(A,"^1"),le["²"]=e(A,"^2"),le["³"]=e(A,"^3"),le["¼"]=e(A,"\\frac14"),le["½"]=e(A,"\\frac12"),le["¾"]=e(A,"\\frac34"),R=H(ie,function(t,e){t.init=function(t,n,i){e.init.call(this,t,'<span class="binary-operator">'+n+"</span>",i)}}),T=H(R,function(t){t.init=O.prototype.init,t.respace=function(){return this.jQ[0].className=this[G]?this[G]instanceof R&&this[X]&&!(this[X]instanceof R)?"unary-operator":"binary-operator":"",this}}),le["+"]=e(T,"+","+"),le["–"]=le["-"]=e(T,"-","&minus;"),le["±"]=le.pm=le.plusmn=le.plusminus=e(T,"\\pm ","&plusmn;"),le.mp=le.mnplus=le.minusplus=e(T,"\\mp ","&#8723;"),he["*"]=le.sdot=le.cdot=e(R,"\\cdot ","&middot;"),le["="]=e(R,"=","="),le["<"]=e(R,"<","&lt;"),le[">"]=e(R,">","&gt;"),le.notin=le.sim=le.cong=le.equiv=le.oplus=le.otimes=H(R,function(t,e){t.init=function(t){e.init.call(this,"\\"+t+" ","&"+t+";")}}),le.times=e(R,"\\times ","&times;","[x]"),le["÷"]=le.div=le.divide=le.divides=e(R,"\\div ","&divide;","[/]"),le["≠"]=le.ne=le.neq=e(R,"\\ne ","&ne;"),le.ast=le.star=le.loast=le.lowast=e(R,"\\ast ","&lowast;"),le.therefor=le.therefore=e(R,"\\therefore ","&there4;"),le.cuz=le.because=e(R,"\\because ","&#8757;"),le.prop=le.propto=e(R,"\\propto ","&prop;"),le["≈"]=le.asymp=le.approx=e(R,"\\approx ","&asymp;"),le.lt=e(R,"<","&lt;"),le.gt=e(R,">","&gt;"),le["≤"]=le.le=le.leq=e(R,"\\le ","&le;"),le["≥"]=le.ge=le.geq=e(R,"\\ge ","&ge;"),le.isin=le["in"]=e(R,"\\in ","&isin;"),le.ni=le.contains=e(R,"\\ni ","&ni;"),le.notni=le.niton=le.notcontains=le.doesnotcontain=e(R,"\\not\\ni ","&#8716;"),le.sub=le.subset=e(R,"\\subset ","&sub;"),le.sup=le.supset=le.superset=e(R,"\\supset ","&sup;"),le.nsub=le.notsub=le.nsubset=le.notsubset=e(R,"\\not\\subset ","&#8836;"),le.nsup=le.notsup=le.nsupset=le.notsupset=le.nsuperset=le.notsuperset=e(R,"\\not\\supset ","&#8837;"),le.sube=le.subeq=le.subsete=le.subseteq=e(R,"\\subseteq ","&sube;"),le.supe=le.supeq=le.supsete=le.supseteq=le.supersete=le.superseteq=e(R,"\\supseteq ","&supe;"),le.nsube=le.nsubeq=le.notsube=le.notsubeq=le.nsubsete=le.nsubseteq=le.notsubsete=le.notsubseteq=e(R,"\\not\\subseteq ","&#8840;"),le.nsupe=le.nsupeq=le.notsupe=le.notsupeq=le.nsupsete=le.nsupseteq=le.notsupsete=le.notsupseteq=le.nsupersete=le.nsuperseteq=le.notsupersete=le.notsuperseteq=e(R,"\\not\\supseteq ","&#8841;"),z=H(ie,function(t,e){t.init=function(t,n){e.init.call(this,t,"<big>"+n+"</big>")}}),le["∑"]=le.sum=le.summation=e(z,"\\sum ","&sum;"),le["∏"]=le.prod=le.product=e(z,"\\prod ","&prod;"),le.coprod=le.coproduct=e(z,"\\coprod ","&#8720;"),le["∫"]=le["int"]=le.integral=e(z,"\\int ","&int;"),le.N=le.naturals=le.Naturals=e(O,"\\mathbb{N}","&#8469;"),le.P=le.primes=le.Primes=le.projective=le.Projective=le.probability=le.Probability=e(O,"\\mathbb{P}","&#8473;"),le.Z=le.integers=le.Integers=e(O,"\\mathbb{Z}","&#8484;"),le.Q=le.rationals=le.Rationals=e(O,"\\mathbb{Q}","&#8474;"),le.R=le.reals=le.Reals=e(O,"\\mathbb{R}","&#8477;"),le.C=le.complex=le.Complex=le.complexes=le.Complexes=le.complexplane=le.Complexplane=le.ComplexPlane=e(O,"\\mathbb{C}","&#8450;"),le.H=le.Hamiltonian=le.quaternions=le.Quaternions=e(O,"\\mathbb{H}","&#8461;"),le.quad=le.emsp=e(O,"\\quad ","    "),le.qquad=e(O,"\\qquad ","        "),le.diamond=e(O,"\\diamond ","&#9671;"),le.bigtriangleup=e(O,"\\bigtriangleup ","&#9651;"),le.ominus=e(O,"\\ominus ","&#8854;"),le.uplus=e(O,"\\uplus ","&#8846;"),le.bigtriangledown=e(O,"\\bigtriangledown ","&#9661;"),le.sqcap=e(O,"\\sqcap ","&#8851;"),le.triangleleft=e(O,"\\triangleleft ","&#8882;"),le.sqcup=e(O,"\\sqcup ","&#8852;"),le.triangleright=e(O,"\\triangleright ","&#8883;"),le.odot=e(O,"\\odot ","&#8857;"),le.bigcirc=e(O,"\\bigcirc ","&#9711;"),le.dagger=e(O,"\\dagger ","&#0134;"),le.ddagger=e(O,"\\ddagger ","&#135;"),le.wr=e(O,"\\wr ","&#8768;"),le.amalg=e(O,"\\amalg ","&#8720;"),le.models=e(O,"\\models ","&#8872;"),le.prec=e(O,"\\prec ","&#8826;"),le.succ=e(O,"\\succ ","&#8827;"),le.preceq=e(O,"\\preceq ","&#8828;"),le.succeq=e(O,"\\succeq ","&#8829;"),le.simeq=e(O,"\\simeq ","&#8771;"),le.mid=e(O,"\\mid ","&#8739;"),le.ll=e(O,"\\ll ","&#8810;"),le.gg=e(O,"\\gg ","&#8811;"),le.parallel=e(O,"\\parallel ","&#8741;"),le.bowtie=e(O,"\\bowtie ","&#8904;"),le.sqsubset=e(O,"\\sqsubset ","&#8847;"),le.sqsupset=e(O,"\\sqsupset ","&#8848;"),le.smile=e(O,"\\smile ","&#8995;"),le.sqsubseteq=e(O,"\\sqsubseteq ","&#8849;"),le.sqsupseteq=e(O,"\\sqsupseteq ","&#8850;"),le.doteq=e(O,"\\doteq ","&#8784;"),le.frown=e(O,"\\frown ","&#8994;"),le.vdash=e(O,"\\vdash ","&#8870;"),le.dashv=e(O,"\\dashv ","&#8867;"),le.longleftarrow=e(O,"\\longleftarrow ","&#8592;"),le.longrightarrow=e(O,"\\longrightarrow ","&#8594;"),le.Longleftarrow=e(O,"\\Longleftarrow ","&#8656;"),le.Longrightarrow=e(O,"\\Longrightarrow ","&#8658;"),le.longleftrightarrow=e(O,"\\longleftrightarrow ","&#8596;"),le.updownarrow=e(O,"\\updownarrow ","&#8597;"),le.Longleftrightarrow=e(O,"\\Longleftrightarrow ","&#8660;"),le.Updownarrow=e(O,"\\Updownarrow ","&#8661;"),le.mapsto=e(O,"\\mapsto ","&#8614;"),le.nearrow=e(O,"\\nearrow ","&#8599;"),le.hookleftarrow=e(O,"\\hookleftarrow ","&#8617;"),le.hookrightarrow=e(O,"\\hookrightarrow ","&#8618;"),le.searrow=e(O,"\\searrow ","&#8600;"),le.leftharpoonup=e(O,"\\leftharpoonup ","&#8636;"),le.rightharpoonup=e(O,"\\rightharpoonup ","&#8640;"),le.swarrow=e(O,"\\swarrow ","&#8601;"),le.leftharpoondown=e(O,"\\leftharpoondown ","&#8637;"),le.rightharpoondown=e(O,"\\rightharpoondown ","&#8641;"),le.nwarrow=e(O,"\\nwarrow ","&#8598;"),le.ldots=e(O,"\\ldots ","&#8230;"),le.cdots=e(O,"\\cdots ","&#8943;"),le.vdots=e(O,"\\vdots ","&#8942;"),le.ddots=e(O,"\\ddots ","&#8944;"),le.surd=e(O,"\\surd ","&#8730;"),le.triangle=e(O,"\\triangle ","&#9653;"),le.ell=e(O,"\\ell ","&#8467;"),le.top=e(O,"\\top ","&#8868;"),le.flat=e(O,"\\flat ","&#9837;"),le.natural=e(O,"\\natural ","&#9838;"),le.sharp=e(O,"\\sharp ","&#9839;"),le.wp=e(O,"\\wp ","&#8472;"),le.bot=e(O,"\\bot ","&#8869;"),le.clubsuit=e(O,"\\clubsuit ","&#9827;"),le.diamondsuit=e(O,"\\diamondsuit ","&#9826;"),le.heartsuit=e(O,"\\heartsuit ","&#9825;"),le.spadesuit=e(O,"\\spadesuit ","&#9824;"),le.oint=e(O,"\\oint ","&#8750;"),le.bigcap=e(O,"\\bigcap ","&#8745;"),le.bigcup=e(O,"\\bigcup ","&#8746;"),le.bigsqcup=e(O,"\\bigsqcup ","&#8852;"),le.bigvee=e(O,"\\bigvee ","&#8744;"),le.bigwedge=e(O,"\\bigwedge ","&#8743;"),le.bigodot=e(O,"\\bigodot ","&#8857;"),le.bigotimes=e(O,"\\bigotimes ","&#8855;"),le.bigoplus=e(O,"\\bigoplus ","&#8853;"),le.biguplus=e(O,"\\biguplus ","&#8846;"),le.lfloor=e(O,"\\lfloor ","&#8970;"),le.rfloor=e(O,"\\rfloor ","&#8971;"),le.lceil=e(O,"\\lceil ","&#8968;"),le.rceil=e(O,"\\rceil ","&#8969;"),le.slash=e(O,"\\slash ","&#47;"),le.opencurlybrace=e(O,"\\opencurlybrace ","&#123;"),le.closecurlybrace=e(O,"\\closecurlybrace ","&#125;"),le.caret=e(O,"\\caret ","^"),le.underscore=e(O,"\\underscore ","_"),le.backslash=e(O,"\\backslash ","\\"),le.vert=e(O,"|"),le.perp=le.perpendicular=e(O,"\\perp ","&perp;"),le.nabla=le.del=e(O,"\\nabla ","&nabla;"),le.hbar=e(O,"\\hbar ","&#8463;"),le.AA=le.Angstrom=le.angstrom=e(O,"\\text\\AA ","&#8491;"),le.ring=le.circ=le.circle=e(O,"\\circ ","&#8728;"),le.bull=le.bullet=e(O,"\\bullet ","&bull;"),le.setminus=le.smallsetminus=e(O,"\\setminus ","&#8726;"),le.not=le["¬"]=le.neg=e(O,"\\neg ","&not;"),le["…"]=le.dots=le.ellip=le.hellip=le.ellipsis=le.hellipsis=e(O,"\\dots ","&hellip;"),le.converges=le.darr=le.dnarr=le.dnarrow=le.downarrow=e(O,"\\downarrow ","&darr;"),le.dArr=le.dnArr=le.dnArrow=le.Downarrow=e(O,"\\Downarrow ","&dArr;"),le.diverges=le.uarr=le.uparrow=e(O,"\\uparrow ","&uarr;"),le.uArr=le.Uparrow=e(O,"\\Uparrow ","&uArr;"),le.to=e(R,"\\to ","&rarr;"),le.rarr=le.rightarrow=e(O,"\\rightarrow ","&rarr;"),le.implies=e(R,"\\Rightarrow ","&rArr;"),le.rArr=le.Rightarrow=e(O,"\\Rightarrow ","&rArr;"),le.gets=e(R,"\\gets ","&larr;"),le.larr=le.leftarrow=e(O,"\\leftarrow ","&larr;"),le.impliedby=e(R,"\\Leftarrow ","&lArr;"),le.lArr=le.Leftarrow=e(O,"\\Leftarrow ","&lArr;"),le.harr=le.lrarr=le.leftrightarrow=e(O,"\\leftrightarrow ","&harr;"),le.iff=e(R,"\\Leftrightarrow ","&hArr;"),le.hArr=le.lrArr=le.Leftrightarrow=e(O,"\\Leftrightarrow ","&hArr;"),le.Re=le.Real=le.real=e(O,"\\Re ","&real;"),le.Im=le.imag=le.image=le.imagin=le.imaginary=le.Imaginary=e(O,"\\Im ","&image;"),le.part=le.partial=e(O,"\\partial ","&part;"),le.inf=le.infin=le.infty=le.infinity=e(O,"\\infty ","&infin;"),le.alef=le.alefsym=le.aleph=le.alephsym=e(O,"\\aleph ","&alefsym;"),le.xist=le.xists=le.exist=le.exists=e(O,"\\exists ","&exist;"),le.and=le.land=le.wedge=e(O,"\\wedge ","&and;"),le.or=le.lor=le.vee=e(O,"\\vee ","&or;"),le.o=le.O=le.empty=le.emptyset=le.oslash=le.Oslash=le.nothing=le.varnothing=e(R,"\\varnothing ","&empty;"),le.cup=le.union=e(R,"\\cup ","&cup;"),le.cap=le.intersect=le.intersection=e(R,"\\cap ","&cap;"),le.deg=le.degree=e(O,"^\\circ ","&deg;"),le.ang=le.angle=e(O,"\\angle ","&ang;"),$=H(ie,function(t,e){t.init=function(t){e.init.call(this,"\\"+t+" ","<span>"+t+"</span>")},t.respace=function(){this.jQ[0].className=this[X]instanceof u||this[X]instanceof b?"":"non-italicized-function"}}),le.ln=le.lg=le.log=le.span=le.proj=le.det=le.dim=le.min=le.max=le.mod=le.lcm=le.gcd=le.gcf=le.hcf=le.lim=$,function(){var t,e=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(t in e)le[e[t]]=le[e[t]+"h"]=le["a"+e[t]]=le["arc"+e[t]]=le["a"+e[t]+"h"]=le["arc"+e[t]+"h"]=$}(),B=function(){function t(t){var e=re();return t.adopt(e,0,0),e}function e(t){var e,n=t[0]||re();for(e=1;e<t.length;e+=1)t[e].children().adopt(n,n.ends[X],0);return n}var n=N.string,i=N.regex,r=N.letter,s=N.any,a=N.optWhitespace,o=N.succeed,c=N.fail,h=r.map(D),l=i(/^[^${}\\_^]/).map(O),u=i(/^[^\\a-eg-zA-Z]/).or(n("\\").then(i(/^[a-z]+/i).or(i(/^\s+/).result(" ")).or(s))).then(function(t){var e=le[t];return e?e(t).parser():c("unknown command: \\"+t)}),p=u.or(h).or(l),f=n("{").then(function(){return m}).skip(n("}")),d=a.then(f.or(p.map(t))),m=d.many().map(e).skip(a),g=n("[").then(d.then(function(t){return"]"!==t.join("latex")?o(t):c()}).many().map(e).skip(a)).skip(n("]")),b=m;return b.block=d,b.optBlock=g,b}(),I=H(Y,function(t){function e(t,e){var i,r,s,a;if(t.clearSelection().show(),t[X][e])t.insAtLeftEnd(t[X][e]);else if(t[G][e])t.insAtRightEnd(t[G][e]);else{i=t.parent;do{if(r=i[e],r&&("function"==typeof r&&(r=i[e](t)),r===!1||r instanceof re)){t.upDownCache[i.id]=Y(t.parent,t[G],t[X]),r instanceof re&&(s=t.upDownCache[r.id],s?s[X]?t.insLeftOf(s[X]):t.insAtRightEnd(s.parent):(a=n(t).left,t.insAtRightEnd(r),t.seekHoriz(a,r)));break}i=i.parent.parent}while(i)}return t}function n(t){var e=t.jQ.removeClass("cursor").offset();return t.jQ.addClass("cursor"),e}function r(t){t.upDownCache={}}t.init=function(t){this.parent=this.root=t;var e=this.jQ=this._jQ=Z('<span class="cursor">&#8203;</span>');this.blink=function(){e.toggleClass("blink")},this.upDownCache={}},t.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this[X]?this.jQ.insertBefore(this.selection&&this.selection.ends[G][G]===this[G]?this.selection.jQ:this[X].jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},t.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=Z(),this},t.withDirInsertAt=function(t,e,n,i){var r=this.parent;this.parent=e,this[t]=n,this[-t]=i,r.blur()},t.insDirOf=function(t,e){return i(t),this.withDirInsertAt(t,e.parent,e[t],e),this.parent.jQ.addClass("hasCursor"),this.jQ.insDirOf(t,e.jQ),this},t.insLeftOf=function(t){return this.insDirOf(G,t)},t.insRightOf=function(t){return this.insDirOf(X,t)},t.insAtDirEnd=function(t,e){return i(t),this.withDirInsertAt(t,e,0,e.ends[t]),t===G&&e.textarea?this.jQ.insDirOf(-t,e.textarea):this.jQ.insAtDirEnd(t,e.jQ),e.focus(),this},t.insAtLeftEnd=function(t){return this.insAtDirEnd(G,t)},t.insAtRightEnd=function(t){return this.insAtDirEnd(X,t)},t.hopDir=function(t){return i(t),this.jQ.insDirOf(t,this[t].jQ),this[-t]=this[t],this[t]=this[t][t],this},t.hopLeft=function(){return this.hopDir(G)},t.hopRight=function(){return this.hopDir(X)},t.moveDirWithin=function(t,e){if(i(t),this[t])this[t].ends[-t]?this.insAtDirEnd(-t,this[t].ends[-t]):this.hopDir(t);else{if(this.parent===e)return;this.parent[t]?this.insAtDirEnd(-t,this.parent[t]):this.insDirOf(t,this.parent.parent)}},t.moveLeftWithin=function(t){return this.moveDirWithin(G,t)},t.moveRightWithin=function(t){return this.moveDirWithin(X,t)},t.moveDir=function(t){return i(t),r(this),this.selection?this.insDirOf(t,this.selection.ends[t]).clearSelection():this.moveDirWithin(t,this.root),this.show()},t.moveLeft=function(){return this.moveDir(G)},t.moveRight=function(){return this.moveDir(X)},t.moveUp=function(){return e(this,"up")},t.moveDown=function(){return e(this,"down")},t.seek=function(t,e){r(this);var n,i,s=this.clearSelection().show();return t.hasClass("empty")?(s.insAtLeftEnd(ee[t.attr(F)]),s):(n=ee[t.attr(M)],n instanceof ie?(t.outerWidth()>2*(e-t.offset().left)?s.insLeftOf(n):s.insRightOf(n),s):(n||(i=ee[t.attr(F)],i||(t=t.parent(),n=ee[t.attr(M)],n||(i=ee[t.attr(F)],i||(i=s.root)))),n?s.insRightOf(n):s.insAtRightEnd(i),s.seekHoriz(e,s.root)))},t.seekHoriz=function(t,e){var i,r=this,s=n(r).left-t;do r.moveLeftWithin(e),i=s,s=n(r).left-t;while(s>0&&(r[G]||r.parent!==e));return-s>i&&r.moveRightWithin(e),r},t.writeLatex=function(t){var e,n,i,s=this;return r(s),s.show().deleteSelection(),e=N.all,n=N.eof,i=B.skip(n).or(e.result(!1)).parse(t),i&&(i.children().adopt(s.parent,s[G],s[X]),ee.jQize(i.join("html")).insertBefore(s.jQ),s[G]=i.ends[X],i.finalizeInsert(),s.parent.bubble("redraw")),this.hide()},t.write=function(t){var e=this.prepareWrite();return this.insertCh(t,e)},t.insertCh=function(t,e){return this.parent.write(this,t,e),this},t.insertCmd=function(t,e){var n=le[t];return n?(n=n(t),e&&n.replaces(e),n.createLeftOf(this)):(n=q(),n.replaces(t),n.ends[G].focus=function(){return delete this.focus,this},n.createLeftOf(this),this.insRightOf(n),e&&e.remove()),this},t.unwrapGramp=function(){var t=this.parent.parent,e=t.parent,n=t[X],i=t[G];if(t.disown().eachChild(function(r){r.isEmpty()||(r.children().adopt(e,i,n).each(function(e){e.jQ.insertBefore(t.jQ.first())}),i=r.ends[X])}),!this[X])if(this[G])this[X]=this[G][X];else for(;!this[X];){if(this.parent=this.parent[X],!this.parent){this[X]=t[X],this.parent=e;break}this[X]=this.parent.ends[G]}this[X]?this.insLeftOf(this[X]):this.insAtRightEnd(e),t.jQ.remove(),t[G]&&t[G].respace(),t[X]&&t[X].respace()},t.deleteDir=function(t){if(i(t),r(this),this.show(),this.deleteSelection());else if(this[t])this[t].isEmpty()?this[t]=this[t].remove()[t]:this.selectDir(t);else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insDirOf(-t,this.parent.parent).deleteDir(t);this.unwrapGramp()}return this[G]&&this[G].respace(),this[X]&&this[X].respace(),this.parent.bubble("redraw"),this},t.backspace=function(){return this.deleteDir(G)},t.deleteForward=function(){return this.deleteDir(X)},t.selectFrom=function(t){var e,n,i,r,s,a,o=this,c=t;t:for(;;){for(e=this;e!==o.parent.parent;e=e.parent.parent)if(e.parent===c.parent){i=e,r=c;break t}for(n=t;n!==c.parent.parent;n=n.parent.parent)if(o.parent===n.parent){i=o,r=n;break t}o.parent.parent&&(o=o.parent.parent),c.parent.parent&&(c=c.parent.parent)}if(i[X]!==r){for(a=i;a;a=a[X])if(a===r[G]){s=!0;break}s||(s=r,r=i,i=s)}this.hide().selection=_(i[G][X]||i.parent.ends[G],r[X][G]||r.parent.ends[X]),this.insRightOf(r[X][G]||r.parent.ends[X]),this.root.selectionChanged()},t.selectDir=function(t){if(i(t),r(this),this.selection)if(this.selection.ends[t]===this[-t])this[t]?this.hopDir(t).selection.extendDir(t):this.parent!==this.root&&this.insDirOf(t,this.parent.parent).selection.levelUp();else{if(this.hopDir(t),this.selection.ends[t]===this.selection.ends[-t])return void this.clearSelection().show();this.selection.retractDir(t)}else{if(this[t])this.hopDir(t);else{if(this.parent===this.root)return;this.insDirOf(t,this.parent.parent)}this.hide().selection=_(this[-t])}this.root.selectionChanged()},t.selectLeft=function(){return this.selectDir(G)},t.selectRight=function(){return this.selectDir(X)},t.prepareMove=function(){return r(this),this.show().clearSelection()},t.prepareEdit=function(){return r(this),this.show().deleteSelection()},t.prepareWrite=function(){return r(this),this.show().replaceSelection()},t.clearSelection=function(){return this.selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged()),this},t.deleteSelection=function(){return this.selection?(this[G]=this.selection.ends[G][G],this[X]=this.selection.ends[X][X],this.selection.remove(),this.root.selectionChanged(),delete this.selection):!1},t.replaceSelection=function(){var t=this.selection;return t&&(this[G]=t.ends[G][G],this[X]=t.ends[X][X],delete this.selection),t}}),_=H(se,function(t,e){t.init=function(){var t=this;e.init.apply(t,arguments),t.jQwrap(t.jQ)},t.jQwrap=function(t){this.jQ=t.wrapAll('<span class="selection"></span>').parent()},t.adopt=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),e.adopt.apply(this,arguments)},t.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},t.levelUp=function(){var t=this,e=t.ends[G]=t.ends[X]=t.ends[X].parent.parent;return t.clear().jQwrap(e.jQ),t},t.extendDir=function(t){return i(t),this.ends[t]=this.ends[t][t],this.ends[t].jQ.insAtDirEnd(t,this.jQ),this},t.extendLeft=function(){return this.extendDir(G)},t.extendRight=function(){return this.extendDir(X)},t.retractDir=function(t){i(t),this.ends[-t].jQ.insDirOf(-t,this.jQ),this.ends[-t]=this.ends[-t][t]},t.retractRight=function(){return this.retractDir(X)},t.retractLeft=function(){return this.retractDir(G)}}),W.fn.mathquill=function(t,e){var n,i,s,a,o;switch(t){case"redraw":return this.each(function(){var t=Z(this).attr(F),e=t&&ee[t];e&&!function n(t){t.eachChild(n),t.redraw&&t.redraw()}(e)});case"revert":return this.each(function(){var t=Z(this).attr(F),e=t&&ee[t];e&&e.revert&&e.revert()});case"latex":return arguments.length>1?this.each(function(){var t=Z(this).attr(F),n=t&&ee[t];n&&n.renderLatex(e)}):(n=Z(this).attr(F),i=n&&ee[n],i&&i.latex());case"text":return n=Z(this).attr(F),i=n&&ee[n],i&&i.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var t=Z(this).attr(F),n=t&&ee[t],i=n&&n.cursor;i&&i.writeLatex(e).parent.blur()});case"cmd":if(arguments.length>1)return this.each(function(){var t,n=Z(this).attr(F),i=n&&ee[n],r=i&&i.cursor;r&&(t=r.prepareWrite(),/^\\[a-z]+$/i.test(e)?r.insertCmd(e.slice(1),t):r.insertCh(e,t),r.hide().parent.blur())});default:return s="textbox"===t,a=s||"editable"===t,o=s?ce:ae,this.each(function(){r(Z(this),o(),s,a)})}},W(function(){W(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),W(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox"),W(".mathquill-embedded-latex").mathquill()})}();var DataSourceConfigure=function(){function DataSourceConfigure(_parent,_showType,_bIsAdd,_customName,_ptName,_ptDesc,_prjId){this.parent=_parent,this.container=void 0,this.m_showType=_showType,this.m_bIsAdd=_bIsAdd,this.m_customName=_customName,this.m_pointName=_ptName,this.m_pointDesc=_ptDesc,this.m_projectId=_prjId}return DataSourceConfigure.prototype={show:function(){var _this=this;_this.container=document.createElement("div"),_this.container.className="panel panel-default",_this.container.id="addPointPanelContain",_this.container.style.height="100%",_this.container.style.width="99%",_this.container.style.position="absolute",_this.container.style.zIndex="2",document.getElementById("dialogContent").style.height="50%",$.get("/static/views/observer/DataSourceAdd.html").done(function(resultHtml){
_this.parent.m_parent.hideAnlsPane(),_this.container.innerHTML=resultHtml,document.getElementById("paneContent").appendChild(_this.container),I18n.fillArea($("#divDataSourceAddPage")),I18n.fillArea($("#divDataSourceFormula")),$("#dataSrcPtSearch").attr("placeholder",I18n.resource.dataSource.PROJECT_SEARCH);var dsLi=$("#dataSouceConfigure li");0===_this.m_showType?(dsLi.eq(1).remove(),$("#divDataSourceFormula").remove(),new DataSourceOriginal(_this.parent,_this).show()):1===_this.m_showType?(dsLi.eq(0).remove(),$("#divDataSourceAddPage").remove(),$("#divDataSourceFormula").attr("class","tab-pane active"),new DataSourceFormula(_this.parent,_this).show()):2===_this.m_showType&&(new DataSourceOriginal(_this.parent,_this).show(),new DataSourceFormula(_this.parent,_this).show())})},close:function(){$(this.container).remove()}},DataSourceConfigure}(),DataSourceOriginal=function(){function DataSourceOriginal(_parent,_dsCfg){this.parent=_parent,this.m_strPrjName="",this.m_pointList="",this.m_dsCfg=_dsCfg,this.m_iconColor=new Array("#ff7f50","#87cefa","#da70d6","#32cd32","#6495ed","#ff69b4","#ba55d3","#cd5c5c","#ffa500","#40e0d0","#1e90ff","#ff6347","#7b68ee","#00fa9a","#ffd700","#6b8e23","#ff00ff","#3cb371","#b8860b","#30e0e0")}return DataSourceOriginal.prototype={show:function(){var _this=this;_this.initElement()},initElement:function(){var _this=this;_this.m_dsCfg.m_bIsAdd?($("#dsConfig").css("display","none"),$("#dsPtName").css("display","none")):($("#divPointsBody").css("height","calc(100% - 194px)"),$("#inputCustomName").attr("placeholder",_this.parent.m_lang.CUSTOM_NAME),$("#inputPointDesc").attr("placeholder",_this.parent.m_lang.POINT_DESC),$("#inputCustomName").val(_this.m_dsCfg.m_customName),$("#inputPointName").val(_this.m_dsCfg.m_pointName),$("#inputPointDesc").val(_this.m_dsCfg.m_pointDesc));var opt,selectPrj=$("#dataSrcPrjName"),prjId=0,nSize=AppConfig.projectList.length,nColorSize=_this.m_iconColor.length;prjId=_this.m_dsCfg.m_bIsAdd||-1==_this.m_dsCfg.m_projectId?Number(AppConfig.projectId):_this.m_dsCfg.m_projectId,selectPrj.empty();for(var i=0;nSize>i;i++){var project=AppConfig.projectList[i];opt=document.createElement("option"),"en"==localStorage.language?opt.textContent=project.name_english:opt.textContent=project.name_cn,opt.value=project.id,opt.setAttribute("iconColor",_this.m_iconColor[i-parseInt(i/nColorSize)*nColorSize]),selectPrj.append(opt)}selectPrj.val(prjId),_this.initNavSelect(),selectPrj.change(function(e){var prjId=$("#dataSrcPrjName").find("option:selected").val();if("undefined"==typeof prjId||""==prjId)return void $("#dataSrcPtSearch").attr("disabled","");$("#dataSrcPtSearch").removeAttr("disabled"),_this.initNavSelect(),_this.clearSearch();var selectPt=$("#divPointsBody tbody");selectPt.html("");var s3dbData;Spinner.spin($("#divDataSourceAddPage")[0]),WebAPI.get("/analysis/get_pointList_from_s3db/"+prjId).done(function(result){s3dbData=JSON.parse(result),WebAPI.get("/analysis/get_pointList_from_rtTable/"+prjId).done(function(result){var rtData=JSON.parse(result);null==s3dbData.pointList?_this.m_pointList=rtData.pointList:_this.m_pointList={pointList:s3dbData.pointList.concat(rtData.pointList)}}).always(function(e){_this.showPointListAll(),Spinner.stop()})}).error(function(e){document.getElementById("dialogContent").style.height="50%"}).always(function(e){})}),$("#btnAddDataSrc").click(function(e){_this.selectPoint()&&(_this.parent.m_parent.showAnlsPane(),$(_this.m_dsCfg.container).remove())}),$("#btnCancelDataSrc").click(function(e){_this.parent.m_parent.showAnlsPane(),$(_this.m_dsCfg.container).remove()}),$("#dataSrcPtSearch").keyup(function(e){13==e.keyCode&&_this.parsePointListByInput()}),$("#btnSearch").click(function(e){_this.parsePointListByInput()}),$("#divPointsHead li").click(function(e){_this.clearSearch();var target=$(e.currentTarget),showChar=target.find("a").text();if("All"==showChar)_this.initNavSelect(),_this.showPointListAll();else{_this.clearNavSelect(),target.attr("class","active");var upChar=showChar.toUpperCase(),lowChar=showChar.toLowerCase();_this.parsePointListByAlphabet(upChar,lowChar)}}),selectPrj.change()},selectPointName:function(clickTarget){if(this.m_dsCfg.m_bIsAdd){var target=$(clickTarget),flag=target.attr("class");"info"==flag?target.attr("class",""):target.attr("class","info")}else{$("#tableWatch tbody tr").attr("class","");var target=$(clickTarget);target.attr("class","info"),$("#inputPointName").val(target.find("td").eq(1).text())}},showPointListAll:function(){var _this=this;if(null!=_this.m_pointList.pointList){var selectPt=$("#divPointsBody tbody");selectPt.html("");for(var tr,td,nSize=_this.m_pointList.pointList.length,i=0;nSize>i;i++)tr=document.createElement("tr"),tr.className="",tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target)},td=document.createElement("td"),td.textContent=i,tr.appendChild(td),td=document.createElement("td"),td.textContent=_this.m_pointList.pointList[i].name,tr.appendChild(td),td=document.createElement("td"),td.textContent=_this.m_pointList.pointList[i].description,tr.appendChild(td),selectPt.append(tr)}},parsePointListByAlphabet:function(upCharName,lowCharName){var _this=this;if(null!=_this.m_pointList.pointList){var selectPt=$("#divPointsBody tbody");selectPt.html("");for(var tr,td,nSize=_this.m_pointList.pointList.length,i=0;nSize>i;i++){var firstChar=_this.m_pointList.pointList[i].name[0];(upCharName==firstChar||lowCharName==firstChar)&&(tr=document.createElement("tr"),tr.className="",tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target)},td=document.createElement("td"),td.textContent=i,tr.appendChild(td),td=document.createElement("td"),td.textContent=_this.m_pointList.pointList[i].name,tr.appendChild(td),td=document.createElement("td"),td.textContent=_this.m_pointList.pointList[i].description,tr.appendChild(td),selectPt.append(tr))}}},parsePointListByInput:function(){var _this=this;if(null==_this.m_pointList.pointList){var selectPt=$("#divPointsBody tbody");selectPt.html("");var tr,td;return tr=document.createElement("tr"),tr.style.height="100px",td=document.createElement("td"),td.colSpan=3,td.style.lineHeight="100%",td.style.verticalAlign="middle",td.style.fontSize="20px",td.style.fontWeight="bold",td.style.color="darkred",td.textContent=_this.parent.m_lang.NO_MATCH_FOUND,tr.appendChild(td),void selectPt.append(tr)}_this.initNavSelect();var strSearchVal;if(strSearchVal=$("#dataSrcPtSearch").val(),null!=strSearchVal){""==strSearchVal&&_this.showPointListAll(),strSearchVal=strSearchVal.toLowerCase();var selectPt=$("#divPointsBody tbody");selectPt.html("");for(var tr,td,strGetName,strGetDesc,nIdxName,nIdxDesc,nSize=_this.m_pointList.pointList.length,i=0;nSize>i;i++)strGetName=_this.m_pointList.pointList[i].name,strGetName=strGetName.toLowerCase(),strGetName.indexOf(strSearchVal,0),nIdxName=strGetName.indexOf(strSearchVal,0),strGetDesc=_this.m_pointList.pointList[i].description,strGetDesc=strGetDesc.toLowerCase(),strGetDesc.indexOf(strSearchVal,0),nIdxDesc=strGetDesc.indexOf(strSearchVal,0),(-1!=nIdxName||-1!=nIdxDesc)&&(tr=document.createElement("tr"),tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target)},td=document.createElement("td"),td.textContent=i,tr.appendChild(td),td=document.createElement("td"),td.textContent=_this.m_pointList.pointList[i].name,tr.appendChild(td),td=document.createElement("td"),td.textContent=_this.m_pointList.pointList[i].description,tr.appendChild(td),selectPt.append(tr));""===selectPt.html()&&(tr=document.createElement("tr"),tr.style.height="100px",td=document.createElement("td"),td.colSpan=3,td.style.lineHeight="100%",td.style.verticalAlign="middle",td.style.fontSize="20px",td.style.fontWeight="bold",td.style.color="darkred",td.textContent=_this.parent.m_lang.NO_MATCH_FOUND,tr.appendChild(td),selectPt.append(tr))}},clearNavSelect:function(){$("#divPointsHead").find("li").each(function(){$(this).attr("class","")})},initNavSelect:function(){var _this=this;_this.clearNavSelect(),$("#li_nav_all").attr("class","active")},selectPoint:function(){var _this=this,ctlSelectPrj=$("#dataSrcPrjName");if(_this.m_strPrjName=ctlSelectPrj.find("option:selected").text(),""==_this.m_strPrjName)return alert(I18n.resource.observer.widgets.PLEASE_SELECT_PROJECT+"！"),!1;var row,newPointList=[],strUserId=AppConfig.userId,strUserName=AppConfig.account,prjId=Number(ctlSelectPrj.find("option:selected").attr("value")),prjName=_this.parent.getProjectNameFromId(prjId),iconColor=ctlSelectPrj.find("option:selected").attr("iconColor"),strPtName="",strPtDesc="",groupId=_this.parent.m_selectGroupId;if(!_this.m_dsCfg.m_bIsAdd){var custName=$("#inputCustomName").val();return strPtName=$("#inputPointName").val(),strPtDesc=$("#inputPointDesc").val(),row={itemId:_this.parent.m_selectItemId,userId:strUserId,userName:strUserName,customName:custName,prjId:prjId,prjName:prjName,ptName:strPtName,ptDesc:strPtDesc,iconColor:iconColor,itemType:0,groupId:groupId,groupName:""},newPointList.push(row),_this.parent.m_newPointList=newPointList,_this.parent.modifyTable(),!0}return $("#tableWatch tbody tr").each(function(){"info"==this.className&&(strPtName=$(this).find("td:eq(1)").text(),strPtDesc=$(this).find("td:eq(2)").text(),row={userId:strUserId,userName:strUserName,customName:strPtName,prjId:prjId,prjName:prjName,ptName:strPtName,ptDesc:strPtDesc,iconColor:iconColor,itemType:0,groupId:groupId,groupName:""},newPointList.push(row))}),newPointList.length<=0?void alert(_this.parent.m_lang.NO_SELECT_POINT):(_this.parent.m_newPointList=newPointList,_this.parent.renderTabel(),!0)},clearSearch:function(){$("#dataSrcPtSearch").val("")}},DataSourceOriginal}(),DataSourceFormula=function(){function DataSourceFormula(_parent,_dsCfg){this.m_parent=_parent,this.m_dsCfg=_dsCfg}return DataSourceFormula.prototype={show:function(){this.init()},init:function(){var _this=this;_this.initElement(),_this.dragInit(),_this.varConfigInit(),_this.varAddInit(),$("#inputCustName").attr("placeholder",_this.m_parent.m_lang.CUSTOM_NAME),$("#inputFormulaDesc").attr("placeholder",_this.m_parent.m_lang.POINT_DESC),$(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),_this.m_dsCfg.m_bIsAdd||($("#inputCustName").val(_this.m_dsCfg.m_customName),$("#inputFormulaDesc").val(_this.m_dsCfg.m_pointDesc))},initElement:function(){var _this=this;$("#btnFormulaDataAdd").click(function(e){var name,input=$("#inputCustName"),preName=$("#inputCustName").val();if(""==preName){for(var list=_this.m_parent.m_allPointList,count=0,i=0,len=list.length;len>i;i++)1==list[i].itemType&&count++;name="Formula"+count}else name=preName;if(""==name)return input.focus(),void alert(_this.m_parent.m_lang.CUSTOM_NOT_NULL);var strFormulaVal=_this.formulaGet();"error"!=strFormulaVal&&(_this.m_dsCfg.m_bIsAdd?_this.m_parent.renderFormula(name,strFormulaVal,$("#inputFormulaDesc").val()):_this.m_parent.modifyFormula(name,strFormulaVal,$("#inputFormulaDesc").val()),_this.m_parent.m_parent.showAnlsPane(),$(_this.m_dsCfg.container).remove())}),$("#btnCancelFormulaData").click(function(e){_this.m_parent.m_parent.showAnlsPane(),$(_this.m_dsCfg.container).remove()})},dragInit:function(){var $formulaVarRow=$("#varConfig .varRow").not("#varConfig .row:first-child");$formulaVarRow.on("dragenter",function(e){e.preventDefault(),e.stopPropagation()}),$formulaVarRow.on("dragover",function(e){e.preventDefault(),$(e.currentTarget).addClass("varSel")}),$formulaVarRow.on("dragleave",function(e){e.preventDefault(),$(e.currentTarget).removeClass("varSel")});for(var i=0;i<$formulaVarRow.length;++i)$formulaVarRow[i].ondrop=function(e){var targetId;e.preventDefault(),targetId=e.dataTransfer.getData("dsItemId");var formulaVarValue='<div class="col-lg-6 col-xs-8 formulaVarValue grow" varId="'+targetId+'">\r\n                                            <span></span>\r\n                                            <div>'+AppConfig.datasource.getDSItemById(targetId).alias+'</div>\r\n                                            <span class="glyphicon glyphicon-remove-sign grow removeVarValue" aria-hidden="true" ></span>\r\n                                            </div>';$(e.currentTarget).find(".divVarValue").html(formulaVarValue),$(e.currentTarget).find(".removeVarValue").on("click",function(){$(this).parents(".formulaVarValue").remove()})};$("#dataSrcPanel").on("dragend",function(e){e.preventDefault(),$(".varSel").removeClass("varSel")})},varConfigInit:function(){var $varConfig=$("#varConfig");$(".formulaVarName").click(function(){$(this).children().css("display","inline"),$(this).children().val(this.childNodes[1].textContent).focus(),$(this).children("span").css("display","none")}),$(".varNameChange").blur(function(){this.style.display="none",""!=this.value&&(this.parentNode.childNodes[1].textContent=this.value),$(this).next("span").css("display","inline")}),$varConfig.find(".varRemove").on("click",function(){$(this).parents(".row").remove()})},varAddInit:function(){var newVarName,$varConfig=$("#varConfig"),_this=this;$varConfig.find(".glyphicon-plus-sign").click(function(){newVarName=$(".formulaVarName").last().text(),newVarName=newVarName.substr(0,newVarName.length-1)+String.fromCharCode(newVarName.charCodeAt(newVarName.length-1)+1),0==newVarName.charCodeAt(0)&&(newVarName="a"),$varConfig.get(0).innerHTML+='<div class="row"><div class="col-xs-12 varRow">\r\n                                                    <div class="varRemove"><span class="glyphicon glyphicon-remove-sign grow" aria-hidden="true"></span></div>\r\n                                                    <div class="col-lg-4 col-xs-4 formulaVarName"><input type="text" name="inputVarValue" class="varNameChange">'+newVarName+'</div>\r\n                                                    <div class="col-xs-6 divVarValue"></div>\r\n                                                </div></div>',_this.varAddInit(),_this.dragInit(),_this.varConfigInit()})},formulaGet:function(){var varId,varName,searchReg,$editableMath=$("#editable-math"),$varRow=$("#varConfig .varRow"),latexMathValue=$editableMath.mathquill("latex"),varNum=$varRow.length,varError=new Array;$(".varLack").remove();for(var i=0;varNum>i;++i)varName=$($varRow.find(".formulaVarName").get(i)),varId=$($varRow.find(".divVarValue").get(i)).children().attr("varId"),searchReg=new RegExp("\\b"+varName.text()+"\\b","g"),searchReg.test(latexMathValue)&&(varId?latexMathValue=latexMathValue.replace(searchReg,"<%"+varId+"%>"):varError.push(varName));if(varError.length>0){for(var ele=0;ele<varError.length;++ele)varError[ele].append($('<span class="varLack">Unassigned!<span>'));return alert("Lack Variable in Formula"),"error"}return latexMathValue}},DataSourceFormula}(),DataSource=function(){function DataSource(parent){this.m_parent=parent,this.m_newPointList=[],this.m_allPointList=[],this.m_allGroupList=[],this.m_arrProjIdColorMap={},this.m_dataSourceId,this.m_lang=I18n.resource.dataSource,this.m_selectItemId=0,this.m_selectGroupId=0,this.m_groupIconOpen="/static/images/dataSource/group_head_sel.png",this.m_groupIconClose="/static/images/dataSource/group_head_normal.png",this.m_cfgPanel}return DataSource.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),I18n.fillArea($("#divAnlsDatasourcePane")),I18n.fillArea($("#divEnergyAnlsPane")),_this.initContain(),_this.initElement(),_this.loadDataSourceRecord(),_this.initDrag(),Spinner.stop()},close:function(){this.m_newPointList=null,this.m_allPointList=null},initContain:function(){var _this=this,dsContain=$("#dataSrcContain"),panel=$('<div id="dataSrcPanel"></div>');dsContain.append(panel);var addGroup=$('<div id="dataSrcAddGroup"><input type="text" id="inputAddGroup" placeholder="+ Add group" ></input></div>');dsContain.append(addGroup),$("#inputAddGroup").attr("placeholder",_this.m_lang.ADD_GROUP),dsContain.keyup(function(e){if(13==e.keyCode){var groupName=$("#inputAddGroup").val();if(""==groupName)return;var postData={groupId:"",name:groupName,parent:"",userId:AppConfig.userId};WebAPI.post("/datasource/saveDataSourceGroup",postData).done(function(result){var data=JSON.parse(result);if(void 0!=data){var groupId=data.groupId;if(24==groupId.length){for(var bIsFind=!1,i=0,len=_this.m_allGroupList.length;len>i;i++)if(groupId===_this.m_allGroupList[i].id){bIsFind=!0;break}bIsFind||(_this.m_allGroupList.push({id:groupId,name:data.groupName}),_this.insertTreeGroup(data.groupId,data.groupName,0,""),$("#"+data.groupId).find(".dsTreeHeader").click()),$("#inputAddGroup").val("")}}}).fail(function(result){}).always(function(e){})}})},initElement:function(){for(var item,_this=this,len=AppConfig.projectList.length,nColorSize=_this.m_parent.arrColor.length,i=0;len>i;i++)item=AppConfig.projectList[i],_this.m_arrProjIdColorMap[item.id]=_this.m_parent.arrColor[i-parseInt(i/nColorSize)*nColorSize];$("#data_source_add").click(function(e){return 0==_this.m_selectGroupId?void alert(_this.m_lang.NO_SELECT_GROUP):(void 0!=_this.m_cfgPanel&&_this.m_cfgPanel.close(),void WebAPI.get("/static/views/observer/dataSourceAdd.html").done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,!0,"","","",-1),_this.m_cfgPanel.show()}).error(function(result){}).always(function(e){}))}),$("#data_source_formula_add").click(function(e){return 0==_this.m_selectGroupId?void alert(_this.m_lang.NO_SELECT_GROUP):(void 0!=_this.m_cfgPanel&&_this.m_cfgPanel.close(),void WebAPI.get("/static/views/observer/dataSourceAdd.html").done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,!0,"","","",-1),_this.m_cfgPanel.show()}).error(function(result){}).always(function(e){}))}),$("#divAnlsDatasourcePane").click(function(e){_this.clearSelect()})},insertIntoDataList:function(customName,ptName,ptDesc,prjName,iconColor,itemId,baseNode,bIsAppend,bIsSelected){var div,_this=this;div=$(bIsSelected?'<div draggable="true" class="dsItem grow dsSelected" style="height:34px"></div>':'<div draggable="true" class="dsItem grow" style="height:34px"></div>'),div.attr("id",itemId),div.click(function(e){_this.clearSelect();var target=$(e.currentTarget);"dsItem grow"==target.attr("class")?target.attr("class","dsItem grow dsSelected"):target.attr("class","dsItem grow"),_this.stopBubble(e)});var icon=$('<div class="dsMark"></div>');icon.css("background-color",iconColor),div.append(icon);var custName=$('<div class="dsValue" style="height:36px;">'+customName+"</div>");div.append(custName);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){void 0!=_this.m_cfgPanel&&_this.m_cfgPanel.close(),_this.m_selectItemId=$(e.currentTarget).closest(".dsItem").get(0).id;for(var customName,ptDesc,ptName,item,prjId,i=0,len=_this.m_allPointList.length;len>i;i++)if(item=_this.m_allPointList[i],itemId===item.itemId){customName=item.customName,ptName=item.ptName,ptDesc=item.ptDesc,prjId=item.prjId;break}WebAPI.get("/static/views/observer/dataSourceAdd.html").done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,!1,customName,ptName,ptDesc,prjId),_this.m_cfgPanel.show()}).fail(function(result){}).always(function(e){})}).error(function(e){}),div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){var retCon=confirm(_this.m_lang.REMOVE_CONFIRM_TIPS);if(!0===retCon){var div=$(e.currentTarget).closest(".dsItem"),dataSrcItemId=div.attr("id"),dataSrcId=_this.m_dataSourceId;WebAPI.get("/analysis/datasource/removeSingle/"+dataSrcId+"/"+dataSrcItemId+"/"+AppConfig.userId).done(function(result){var data=JSON.parse(result);if(Boolean(data.success)){for(var len=_this.m_allPointList.length,i=0;len>i;i++)if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break}_this.calUpdateDataSources(),div.tooltip("destroy"),div.remove();var arr=data.deleteModal,len=arr.length;if(len>0){for(var delMod,arrDelTitle=[],i=0;len>i;i++)delMod=$("#"+arr[i]),arrDelTitle.push(delMod.find(".newDivPageTitle").val()),delMod.remove();for(var delTitle=_this.m_lang.WORKSPACE+":",i=0,len=arrDelTitle.length;len>i;i++)delTitle+=arrDelTitle[i]+" ";delTitle+=_this.m_lang.REMOVE_RESULT,alert(delTitle)}}}).error(function(){})}}).error(function(e){}),div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>'),ctlPrjName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.PROJECT_NAME+": "+prjName+"</label></div>");ctlPrjName.click(function(e){_this.stopBubble(e)}),divChange.append(ctlPrjName);var ctlPtName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.POINT_NAME+": "+ptName+"</label></div>");ctlPtName.click(function(e){_this.stopBubble(e)}),divChange.append(ctlPtName);var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find("label").text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find("input");ctlInput.attr("value",customName),ctlInput.attr("placeholder",_this.m_lang.CUSTOM_NAME),inputCustName.click(function(e){_this.stopBubble(e)}),divChange.append(inputCustName);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find("label").text(_this.m_lang.POINT_DESC),ctlInput=inputDesc.find("input"),ctlInput.attr("value",ptDesc),ctlInput.attr("placeholder",_this.m_lang.POINT_DESC),inputDesc.click(function(e){_this.stopBubble(e)}),divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE),btnOk.click(function(e){for(var prjId,ptName,item,temp=$(e.currentTarget).closest(".dsDivChange").find("input"),strName=$(temp[0]).val(),strDesc=$(temp[1]).val(),i=0,len=_this.m_allPointList.length;len>i;i++)if(item=_this.m_allPointList[i],itemId==item.itemId){prjId=item.prjId,ptName=item.ptName;break}var postData={datasourceId:_this.m_dataSourceId,itemList:[{id:itemId,type:0,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:""}]};WebAPI.post("/analysis/datasource/saveMulti/"+AppConfig.userId,postData).done(function(result){for(var data=JSON.parse(result),id=data.itemIdList[0].id,i=0,len=_this.m_allPointList.length;len>i;i++)if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName,_this.m_allPointList[i].ptDesc=strDesc;break}_this.setToolTipsCustomName(div,strName),_this.setToolTipsDesc(div,strDesc),_this.calUpdateDataSources(),$("#"+id).find(".dsValue").text(strName)}).error(function(e){})}),divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL),btnCancel.click(function(e){}),divChange.append(btnCancel),div.append(divChange),bIsAppend?baseNode.append(div):baseNode.after(div)},initToolTips:function(parent,customName,projectName,pointName,pointDesc){var _this=this,show=new StringBuilder;show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">'),show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>'),show.append('    <div class="tooltipContent">'),show.append('        <p class="customName" style="word-break:break-all;">').append(_this.m_lang.CUSTOM_NAME).append(": ").append(customName).append("</p>"),show.append('        <p class="projectName" style="word-break:break-all;">').append(_this.m_lang.PROJECT_NAME).append(": ").append(projectName).append("</p> "),show.append('        <p class="pointName" style="word-break:break-all;">').append(_this.m_lang.POINT_NAME).append(": ").append(pointName).append("</p> "),show.append('        <p class="pointDesc" style="word-break:break-all;">').append(_this.m_lang.POINT_DESC).append(": ").append(pointDesc).append("</p> "),show.append("    </div>"),show.append('    <div class="tooltip-arrow"></div>'),show.append("</div>");var options={placement:"left",title:_this.m_lang.PARAM,template:show.toString()};parent.tooltip(options),parent.tooltip("show"),parent.tooltip("hide")},setToolTipsAll:function(row,userName,customName,projectName,pointName,pointDesc){var tip=row.data("bs.tooltip").$tip;userName=": "+userName,customName=": "+customName,projectName=": "+projectName,pointName=": "+pointName,pointDesc=": "+pointDesc,tip.find(".userName").text(this.m_lang.USER_NAME+userName),tip.find(".customName").text(this.m_lang.CUSTOM_NAME+customName),tip.find(".projectName").text(this.m_lang.PROJECT_NAME+projectName),tip.find(".pointName").text(this.m_lang.POINT_NAME+pointName),tip.find(".pointDesc").text(this.m_lang.POINT_DESC+pointDesc)},setToolTipsCustomName:function(row,customName){var tip=row.data("bs.tooltip").$tip;tip.find(".customName").text(this.m_lang.CUSTOM_NAME+": "+customName)},setToolTipsDesc:function(row,ptDesc){var tip=row.data("bs.tooltip").$tip;tip.find(".pointDesc").text(this.m_lang.POINT_DESC+": "+ptDesc)},renderTabel:function(){var _this=this,len=_this.m_newPointList.length;if(!(0>=len)){{var item,eachItem,postData,div=$("#dataSrcPanel");div.find(".dsItem").length}if(len=_this.m_newPointList.length,len>0){postData=_this.m_dataSourceId?{datasourceId:_this.m_dataSourceId,itemList:[]}:{itemList:[]};for(var i=0;len>i;i++)item=_this.m_newPointList[i],eachItem={type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId},postData.itemList.push(eachItem);var projName=_this.m_newPointList[0].prjName,iconColor=_this.m_newPointList[0].iconColor;WebAPI.post("/analysis/datasource/saveMulti/"+AppConfig.userId,postData).done(function(result){if(""!=result){var data=JSON.parse(result);""!=data.id&&(_this.m_dataSourceId=data.id);for(var list=data.itemIdList,len=list.length,i=0;len>i;i++)_this.m_newPointList[i].customName==list[i].alias&&(_this.m_newPointList[i].itemId=list[i].id);var divInsert=$("#"+_this.m_selectGroupId);if(void 0!=divInsert)for(var i=0;len>i;i++)_this.insertTreeItem(divInsert,list[i].id,iconColor,list[i].alias,0,"",!0),_this.initToolTips($("#"+list[i].id),list[i].alias,projName,list[i].value,list[i].note);_this.m_allPointList=_this.m_allPointList.concat(_this.m_newPointList),_this.calUpdateDataSources()}}).error(function(){}).always(function(){})}}},modifyTable:function(){var item,eachItem,postData,_this=this,len=_this.m_newPointList.length;len>0&&(postData=_this.m_dataSourceId?{datasourceId:_this.m_dataSourceId,itemList:[]}:{itemList:[]},item=_this.m_newPointList[0],eachItem={id:item.itemId,type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId},postData.itemList.push(eachItem),WebAPI.post("/analysis/datasource/saveMulti/"+AppConfig.userId,postData).done(function(result){if(""!=result){var data=JSON.parse(result);""!=data.id&&(_this.m_dataSourceId=data.id);for(var i=0,len=_this.m_allPointList.length;len>i;i++)if(item.itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].prjId=item.prjId,_this.m_allPointList[i].prjName=_this.m_newPointList[0].prjName,_this.m_allPointList[i].customName=item.customName,_this.m_allPointList[i].ptName=item.ptName,_this.m_allPointList[i].ptDesc=item.ptDesc;break}var divItem=$("#"+item.itemId);divItem.find(".showName").text(item.customName),_this.setToolTipsAll(divItem,item.userName,item.customName,item.prjName,item.ptName,item.ptDesc),_this.calUpdateDataSources()}}).error(function(){}).always(function(){}))},initDrag:function(){var _this=this;_this.dragOperateSrc($("#dataSrcPanel").get(0)),_this.dragOperateCfg($(".springConfigMask").parent().get(0))},dragOperateSrc:function(tableList){if(void 0!=tableList){var _this=this;tableList.ondragstart=function(e){var tar=$(e.target),className=tar.attr("class");if("nav nav-list tree-group"==className){var dragSrcId=tar.attr("id");e.dataTransfer.setData("dsGroupId",dragSrcId)}else{if("treeRow ui-draggable"!=className)return;var dragSrcId=tar.attr("id");e.dataTransfer.setData("dsItemId",dragSrcId)}$(".templatePara").css("display","block")},tableList.ondragover=function(e){e.preventDefault()},tableList.ondrop=function(e){var tarItem=$(e.target),tarId=0,tarParentGroupId=0,dragParentGroupId=0,rowClass=tarItem.attr("class"),dragType=-1,draggedID=0;if("nav nav-list tree-group"==rowClass||"dsTreeHeader"==rowClass)tarId=tarItem.closest(".nav").attr("id"),draggedID=e.dataTransfer.getData("dsGroupId"),""!=draggedID?dragType=0:(draggedID=e.dataTransfer.getData("dsItemId"),""!=draggedID&&(dragType=2,tarId=tarItem.closest(".nav").attr("id"),tarParentGroupId=tarId,dragParentGroupId=$("#"+draggedID).closest(".nav").attr("id")));else{if("showName"!=rowClass&&"treeRow ui-draggable"!=rowClass)return;dragType=1,draggedID=e.dataTransfer.getData("dsItemId"),tarId=tarItem.closest(".treeRow").attr("id"),tarParentGroupId=tarItem.closest(".nav").attr("id"),dragParentGroupId=$("#"+draggedID).closest(".nav").attr("id")}if(draggedID!=tarId&&""!=draggedID&&0!=draggedID)if(0===dragType){for(var item,groupName,i=0,len=_this.m_allGroupList.length;len>i;i++)if(item=_this.m_allGroupList[i],draggedID==item.id){groupName=item.name;break}$("#"+draggedID).remove(),_this.insertTreeGroup(draggedID,groupName,1,$("#"+tarId));for(var i=0,len=_this.m_allPointList.length;len>i;i++)if(item=_this.m_allPointList[i],draggedID==item.groupId){_this.insertTreeItem($("#"+draggedID),item.itemId,item.iconColor,item.customName,0,"",!0);var prjName=_this.getProjectNameFromId(item.prjId);_this.initToolTips($("#"+item.itemId),item.customName,prjName,item.ptName,item.ptDesc)}var groups=$("#dataSrcPanel .nav"),arrTemp=[];$.each(groups,function(i,n){var id=n.id;""!=id&&("groupEmpty"==id&&(id=""),arrTemp.push(id))});var postData={groupIdList:arrTemp};WebAPI.post("/datasource/saveDataSourceGroupLayout/"+AppConfig.userId,postData).done(function(result){var data=JSON.parse(result);"successful"==data.error}).error(function(){}).always(function(){})}else if(1===dragType||2===dragType){for(var itemType=0,iconColor="",custName="",projId=0,pointName="",pointDesc="",i=0,len=_this.m_allPointList.length;len>i;i++)if(draggedID==_this.m_allPointList[i].itemId){_this.m_allPointList[i].groupId=tarParentGroupId,itemType=_this.m_allPointList[i].itemType,iconColor=_this.m_allPointList[i].iconColor,custName=_this.m_allPointList[i].customName,projId=_this.m_allPointList[i].prjId,pointName=_this.m_allPointList[i].ptName,pointDesc=_this.m_allPointList[i].ptDesc;break}var selItem=$("#"+draggedID);if(selItem.tooltip("destroy"),selItem.remove(),_this.insertTreeItem($("#"+tarParentGroupId),draggedID,iconColor,custName,dragType,$("#"+tarId),!0),0==itemType){var prjName=_this.getProjectNameFromId(projId);_this.initToolTips($("#"+draggedID),custName,prjName,showName,pointDesc)}else{if(1!=itemType)return;var showName=_this.getShowNameFromFormula(pointName);_this.initFormulaToolTips($("#"+draggedID),custName,showName,pointDesc)}var lyItem=$("#dataSrcPanel .treeRow"),arrTemp=[];$.each(lyItem,function(i,n){var id=n.id;""!=id&&arrTemp.push(id)});var postData={datasourceId:_this.m_dataSourceId,list:arrTemp};WebAPI.post("/analysis/datasource/saveLayout/"+AppConfig.userId,postData).done(function(result){var data=JSON.parse(result);if(data.success&&tarParentGroupId!=dragParentGroupId){var postData2;postData2=_this.m_dataSourceId?{datasourceId:_this.m_dataSourceId,itemList:[]}:{itemList:[]};var eachPostItem={id:draggedID,type:itemType,projId:projId,alias:custName,note:pointDesc,value:pointName,groupId:tarParentGroupId};postData2.itemList.push(eachPostItem),WebAPI.post("/analysis/datasource/saveMulti/"+AppConfig.userId,postData2).done(function(result){if(""!=result){var data=JSON.parse(result);""!=data.id&&(_this.m_dataSourceId=data.id),void 0!=data.itemIdList&&data.itemIdList[0].id==draggedID}}).error(function(){}).always(function(){})}}).error(function(){}).always(function(){})}}}},dragOperateCfg:function(divItem){if(void 0!=divItem){
divItem.ondragstart=function(e){var target=$(e.target),className=target.attr("class");if("dsItem grow"==className||"dsItem grow dsSelected"==className){var dragSrcId=target.attr("id");e.dataTransfer.setData("dsItemId",dragSrcId)}},divItem.ondragover=function(e){e.preventDefault()},divItem.ondrop=function(e){$(e.target)}}},saveCurrentRecords:function(){var _this=this;Spinner.spin(ElScreenContainer),WebAPI.post("/delete_data_source_records_by_userid",{userId:AppConfig.userId}).done(function(result){if(0!=result)return void Spinner.stop();var id,newRow,item,newPtList=[],len=_this.m_allPointList.length;$("#dataSrcPanel .dsItem").each(function(){id=$(this).attr("id");for(var i=0;len>i;i++)if(item=_this.m_allPointList[i],id==item.itemId){newRow={itemId:id,userId:item.userId,userName:item.userName,customName:item.customName,prjId:item.prjId,prjName:item.prjName,ptName:item.ptName,ptDesc:item.ptDesc,iconColor:item.iconColor,itemId:item.itemId},newPtList.push(newRow);break}}),_this.m_allPointList=newPtList;for(var row,data=[],len=_this.m_allPointList.length,i=0;len>i;i++)item=_this.m_allPointList[i],row={userId:item.userId,customName:item.customName,projectId:item.prjId,pointName:item.ptName,pointDesc:item.ptDesc,iconColor:item.iconColor},data.push(row);WebAPI.post("/save_data_source_record",{sourceList:data}).done(function(result){}).error(function(result){alert(I18n.resource.observer.widgets.DATABASE_OPERATION_FAILED+"！")})}).error(function(result){alert(I18n.resource.observer.widgets.FAIL_BEFORE_EXECUTING+"！")}).always(function(){Spinner.stop()})},loadDataSourceRecord:function(){var _this=this,groupInfo=($("#dataSrcPanel"),_this.m_parent.store.group);if(void 0!=groupInfo){_this.m_allPointList=[],_this.m_allGroupList=[];for(var m=0,n=groupInfo.length;n>m;m++){var groupId=groupInfo[m].groupId;""==groupId&&(groupId="groupEmpty");var groupName=groupInfo[m].groupName,data=groupInfo[m].datasourceList;if(_this.m_allGroupList.push({id:groupId,name:groupName}),void 0!=data)for(var item,len=data.length,i=0;len>i;i++)item={userId:AppConfig.userId,userName:AppConfig.account,customName:data[i].alias,prjId:data[i].projId,prjName:_this.getProjectNameFromId(data[i].projId),ptName:data[i].value,ptDesc:data[i].note,iconColor:_this.m_arrProjIdColorMap[data[i].projId],itemId:data[i].id,itemType:data[i].type,itemValue:data[i].value,groupId:groupId,groupName:groupName},1==item.itemType&&(item.iconColor="#000000"),_this.m_allPointList.push(item)}for(var i=0,len=_this.m_allGroupList.length;len>i;i++)_this.insertTreeGroup(_this.m_allGroupList[i].id,_this.m_allGroupList[i].name,0,"");for(var i=0,len=_this.m_allPointList.length;len>i;i++){var item=_this.m_allPointList[i],bIsPoint=!0;bIsPoint=0==item.itemType?!0:!1;var parentGroup=$("#"+item.groupId);if(_this.insertTreeItem(parentGroup,item.itemId,item.iconColor,item.customName,0,"",bIsPoint),bIsPoint){var prjName=_this.getProjectNameFromId(item.prjId);_this.initToolTips($("#"+item.itemId),item.customName,prjName,item.ptName,item.ptDesc)}else{var showName=_this.getShowNameFromFormula(item.ptName);_this.initFormulaToolTips($("#"+item.itemId),item.customName,showName,item.ptDesc)}}for(var item,treeAllHead=$(".dsTreeHeader .dsGroupName"),i=0,len=treeAllHead.length;len>i;i++)item=treeAllHead.eq(i),"unassigned"!=item.text()&&item.closest(".dsTreeHeader").click()}},getProjectNameFromId:function(id){for(var name,item,len=AppConfig.projectList.length,i=0;len>i;i++)if(item=AppConfig.projectList[i],id==item.id){name=item.name_cn;break}return name},getProjectIdFromName:function(projectName){for(var id,item,len=AppConfig.projectList.length,i=0;len>i;i++)if(item=AppConfig.projectList[i],projectName==item.name_cn){id=item.id;break}return id},calUpdateDataSources:function(){for(var _this=this,updateData=[],i=0,len=_this.m_allGroupList.length;len>i;i++){for(var groupItem={groupId:_this.m_allGroupList[i].id,groupName:_this.m_allGroupList[i].name,parentId:"",datasourceList:""},dsList=[],j=0,len2=_this.m_allPointList.length;len2>j;j++){var curItem=_this.m_allPointList[j];if(groupItem.groupId==curItem.groupId){var pushItem={id:curItem.itemId,type:curItem.itemType,projId:curItem.prjId,alias:curItem.customName,note:curItem.ptDesc,value:curItem.ptName,groupId:curItem.groupId};dsList.push(pushItem)}}groupItem.datasourceList=dsList,updateData.push(groupItem)}this.m_parent.updateDataSources(updateData)},renderFormula:function(_customName,_formulaVal,_formulaDesc){var postData,_this=this;postData=_this.m_dataSourceId?{datasourceId:_this.m_dataSourceId,itemList:[]}:{itemList:[]};var prjId=0,eachItem={type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId};postData.itemList.push(eachItem),WebAPI.post("/analysis/datasource/saveMulti/"+AppConfig.userId,postData).done(function(result){if(""!=result){var data=JSON.parse(result);""!=data.id&&(_this.m_dataSourceId=data.id);for(var item,list=data.itemIdList,i=0,len=list.length;len>i;i++){item={itemId:list[i].id,itemType:1,customName:list[i].alias,itemValue:list[i].value,ptName:list[i].value,prjId:prjId,iconColor:"#000000",ptDesc:_formulaDesc,groupId:list[i].groupId},_this.m_allPointList.push(item),_this.insertTreeItem($("#"+_this.m_selectGroupId),item.itemId,item.iconColor,item.customName,0,"",!1);var showName=_this.getShowNameFromFormula(list[i].value);_this.initFormulaToolTips($("#"+item.itemId),item.customName,showName,_formulaDesc)}_this.calUpdateDataSources()}})},modifyFormula:function(_customName,_formulaVal,_formulaDesc){var postData,_this=this,itemId=_this.m_selectItemId;postData=_this.m_dataSourceId?{datasourceId:_this.m_dataSourceId,itemList:[]}:{itemList:[]};var prjId=Number(AppConfig.projectId),eachItem={id:itemId,type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:""};postData.itemList.push(eachItem),WebAPI.post("/analysis/datasource/saveMulti/"+AppConfig.userId,postData).done(function(result){if(""!=result){var data=JSON.parse(result);""!=data.id&&(_this.m_dataSourceId=data.id);var list=data.itemIdList;if(list.length>0){for(var showName=list[0].value,arr=showName.split("<%"),j=0,len2=arr.length;len2>j;j++){var id=arr[j].split("%>")[0];if(""!=id){var retVal=_this.getDSItemById(id);null!=retVal&&(showName=showName.replace(id,retVal.value))}}showName=showName.replace(/<%/g,""),showName=showName.replace(/%>/g,"");for(var i=0,len=_this.m_allPointList.length;len>i;i++)if(itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=list[0].alias,_this.m_allPointList[i].ptName=list[0].value,_this.m_allPointList[i].ptDesc=list[0].note;break}var divFormula=$("#"+itemId);divFormula.find(".dsValue").text(list[0].alias),_this.setFormulaToolTipsAll(divFormula,list[0].alias,showName,list[0].note),_this.calUpdateDataSources()}}})},insertFormula:function(itemId,customName,iconColor,formula,desc){var _this=this,div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');div.attr("id",itemId),div.click(function(e){_this.clearSelect();var tar=$(e.currentTarget);"dsItem grow"==tar.attr("class")?tar.attr("class","dsItem grow dsSelected"):tar.attr("class","dsItem grow"),_this.stopBubble(e)});var icon=$('<div class="dsMark"></div>');icon.css("background-color",iconColor),div.append(icon);var name=$('<div class="dsValue" style="height:36px"></div>');name.text(customName),div.append(name);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){var show=$(e.currentTarget).prevAll(".dsValue");show.css("display","none");var target=$(e.currentTarget).nextAll(".dsDivChange");target.attr("class","dsDivChange show"),div.css("height","240px"),div.css("width","100%");for(var item,strName="",strFormula="",strDesc="",i=0,len=_this.m_allPointList.length;len>i;i++)if(item=_this.m_allPointList[i],itemId==item.itemId){strName=item.customName,strFormula=item.ptName,strDesc=item.ptDesc;break}var temp=target.find("input");2==temp.length&&($(temp[0]).val(strName),$(temp[1]).val(strDesc)),_this.stopBubble(e)}).error(function(e){}),div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){var retCon=confirm(_this.m_lang.REMOVE_CONFIRM);if(!0===retCon){var div=$(e.currentTarget).closest(".dsItem"),dataSrcId=_this.m_dataSourceId,dataSrcItemId=div.attr("id");WebAPI.get("/analysis/datasource/removeSingle/"+dataSrcId+"/"+dataSrcItemId+"/"+AppConfig.userId).done(function(result){var data=JSON.parse(result);if(Boolean(data.success)){for(var len=_this.m_allPointList.length,i=0;len>i;i++)if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break}_this.calUpdateDataSources(),div.tooltip("destroy"),div.remove()}}).error(function(){})}}),div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>'),inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find("label").text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find("input");ctlInput.attr("value",customName),ctlInput.attr("placeholder",_this.m_lang.CUSTOM_NAME),inputCustName.click(function(e){_this.stopBubble(e)}),divChange.append(inputCustName);var ctlFormula=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.FORMULA_NAME+": </label></div>"),showFormula=$("<span>"+formula+"</span>");showFormula.appendTo(ctlFormula.find("label")).mathquill(),ctlFormula.click(function(e){_this.stopBubble(e)}),divChange.append(ctlFormula);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find("label").text(_this.m_lang.POINT_DESC),ctlInput=inputDesc.find("input"),ctlInput.attr("value",desc),ctlInput.attr("placeholder",_this.m_lang.POINT_DESC),inputDesc.click(function(e){_this.stopBubble(e)}),divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE),btnOk.click(function(e){for(var prjId,ptName,item,temp=$(e.currentTarget).closest(".dsDivChange").find("input"),strName=$(temp[0]).val(),strDesc=$(temp[1]).val(),i=0,len=_this.m_allPointList.length;len>i;i++)if(item=_this.m_allPointList[i],itemId==item.itemId){prjId=item.prjId,ptName=item.ptName;break}var postData={datasourceId:_this.m_dataSourceId,itemList:[{id:itemId,type:1,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:""}]};WebAPI.post("/analysis/datasource/saveMulti/"+AppConfig.userId,postData).done(function(result){var data=JSON.parse(result);if(0!=data.itemIdList.length){for(var id=data.itemIdList[0].id,i=0,len=_this.m_allPointList.length;len>i;i++)if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName,_this.m_allPointList[i].ptDesc=strDesc;break}_this.setToolTipsCustomName(div,strName),_this.setToolTipsDesc(div,strDesc),_this.calUpdateDataSources(),$("#"+id).find(".dsValue").text(strName)}}).error(function(e){})}),divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL),btnCancel.click(function(e){}),divChange.append(btnCancel),div.append(divChange),$("#dataSrcPanel").append(div)},initFormulaToolTips:function(parent,customName,formula,desc){var _this=this,show=new StringBuilder;show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:400px;">'),show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>'),show.append('    <div class="tooltipContent">'),show.append('        <p class="customName" style="white-space:nowrap;">').append(_this.m_lang.CUSTOM_NAME).append(": ").append(customName).append("</p>"),show.append('        <p class="formula" style="white-space:nowrap;">').append(_this.m_lang.FORMULA_NAME).append(": ").append("</p>"),show.append('        <p class="pointDesc" style="white-space:nowrap;">').append(_this.m_lang.POINT_DESC).append(": ").append(desc).append("</p>"),show.append("    </div>"),show.append('    <div class="tooltip-arrow"></div>'),show.append("</div>");var showFormula=$("<span>"+formula+"</span>"),showObj=$(show.toString());showFormula.appendTo(showObj.find(".formula")).mathquill();var options={placement:"left",title:_this.m_lang.PARAM,template:showObj};parent.tooltip(options),parent.tooltip("show"),parent.tooltip("hide")},setFormulaToolTipsAll:function(row,customName,formulaVal,formulaDesc){var tip=row.data("bs.tooltip").$tip;customName=": "+customName,formulaVal=": "+formulaVal,formulaDesc=": "+formulaDesc,tip.find(".customName").text(this.m_lang.CUSTOM_NAME+customName),tip.find(".formula").text(this.m_lang.PROJECT_NAME+formulaVal),tip.find(".pointDesc").text(this.m_lang.POINT_NAME+formulaDesc)},checkRepeatWithCustomName:function(_name){var bRet=!1,grids=$("#dataSrcPanel .dsItem .dsValue");return $.each(grids,function(i,n){return _name==$(n).text()?(bRet=!0,!1):void 0}),bRet},stopBubble:function(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0},clearSelect:function(e){var itemList=$("#dataSrcPanel .dsItem");itemList.attr("class","dsItem grow"),itemList.css("height","34px"),itemList.css("width","33%");var panel=$("#dataSrcPanel");panel.find(".dsDivChange").attr("class","dsDivChange"),panel.find(".dsValue").css("display","inline")},insertTreeGroup:function(groupId,groupName,type,baseGroup){var _this=this,divContain=$("#dataSrcPanel"),$ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true">'),$liHd=$('<li class="dsTreeHeader"><img src="/static/images/dataSource/group_head_sel.png" alt="png" class="dsTreeHeaderIcon"><span class="dsGroupName">'+groupName+"</span></li>"),btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true"></span>');btnRemove.click(function(e){var retCon=confirm(_this.m_lang.REMOVE_CONFIRM);if(!0===retCon){void 0!=_this.m_cfgPanel&&(_this.m_cfgPanel.close(),_this.m_parent.showAnlsPane());var div=$(e.currentTarget).closest(".nav"),groupId=div.attr("id");WebAPI.get("/datasource/deleteDataSourceGroup/"+AppConfig.userId+"/"+groupId).done(function(result){var data=JSON.parse(result);if("successful"==data.error){for(var len=_this.m_allGroupList.length,i=0;len>i;i++)if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1),div.remove();break}_this.calUpdateDataSources()}}).fail(function(e){})}}).error(function(e){}),$liHd.append(btnRemove);var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add"></span>');btnAddDs.click(function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest(".tree-group").get(0).id,_this.stopBubble(e),void 0!=_this.m_cfgPanel&&_this.m_cfgPanel.close(),WebAPI.get("/static/views/observer/dataSourceAdd.html").done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,!0,"","","",-1),_this.m_cfgPanel.show()}).error(function(result){}).always(function(e){})}),$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add" /></span>');btnAddFormula.click(function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest(".tree-group").get(0).id,_this.stopBubble(e),void 0!=_this.m_cfgPanel&&_this.m_cfgPanel.close(),WebAPI.get("/static/views/observer/dataSourceAdd.html").done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,!0,"","","",-1),_this.m_cfgPanel.show()}).error(function(result){}).always(function(e){})}),btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find("img");img.attr("src","/static/images/dataSource/formula_add_hover.png"),img.css("width","23px"),img.css("height","20px")}).error(function(e){}),btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find("img");img.attr("src","/static/images/dataSource/formula_add_normal.png"),img.css("width","21px"),img.css("height","19px")}).error(function(e){}),$liHd.append(btnAddFormula),$liHd.click(function(e){divContain.find(".dsTreeBtnCfg").css("display","none"),divContain.find(".dsTreeBtnRemove").css("display","none");var curTarHead=$(e.currentTarget);curTarHead.find(".dsTreeBtnRemove").css("display","inline"),_this.m_selectGroupId=curTarHead.closest(".tree-group").get(0).id,$(this).next(".rows").slideToggle();var icon=$(this).find(".dsTreeHeaderIcon"),imgPath=icon.attr("src");_this.m_groupIconOpen==imgPath?(icon.attr("src",_this.m_groupIconClose),curTarHead.find(".dsGroupName").css("font-weight","400"),curTarHead.find(".dsTreeBtnFormula").css("display","none"),curTarHead.find(".dsTreeBtnAdd").css("display","none"),curTarHead.find(".dsTreeBtnDel").css("display","none")):(icon.attr("src",_this.m_groupIconOpen),curTarHead.find(".dsGroupName").css("font-weight","700"),curTarHead.find(".dsTreeBtnFormula").css("display","inline"),curTarHead.find(".dsTreeBtnAdd").css("display","inline"),curTarHead.find(".dsTreeBtnDel").css("display","inline"))}),$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow),0===type?divContain.append($ul):1===type&&""!=baseGroup&&baseGroup.after($ul)},insertTreeItem:function(divParentGroup,itemId,iconColor,itemName,insertType,baseItem,bIsPoint){var _this=this,div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true"> '),icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css("background-color",iconColor),div.append(icon);var divShowName=$('<span class="showName">'+itemName+"</span>");divShowName.click(function(e){var oldCustName=$(e.currentTarget).text(),input=$('<input type="text" value="'+oldCustName+'" style="width:300px;">');input.blur(function(e){var newCustName=$(e.currentTarget).val();if(oldCustName!=newCustName){for(var item,type,prjId,ptName,ptDesc,groupId,postData,i=0,len=_this.m_allPointList.length;len>i;i++)if(item=_this.m_allPointList[i],itemId==item.itemId){type=item.itemType,prjId=item.prjId,ptName=item.ptName,ptDesc=item.ptDesc,groupId=item.groupId;break}postData=_this.m_dataSourceId?{datasourceId:_this.m_dataSourceId,itemList:[]}:{itemList:[]};var eachItem={id:itemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId};postData.itemList.push(eachItem),WebAPI.post("/analysis/datasource/saveMulti/"+AppConfig.userId,postData).done(function(result){if(""!=result){var data=JSON.parse(result);""!=data.id&&(_this.m_dataSourceId=data.id);for(var dstId,dstCustomName,list=data.itemIdList,i=0,len=list.length;len>i;i++){dstId=list[i].id,dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;len2>j;j++)if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break}divShowName.text(dstCustomName),_this.setToolTipsCustomName(divShowName.closest(".treeRow"),dstCustomName)}_this.calUpdateDataSources()}})}input.remove(),divShowName.css("display","inline")}),input.keyup(function(e){13==e.keyCode&&input.blur(),_this.stopBubble(e)}),divShowName.after(input),divShowName.css("display","none"),input.select()}),div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');if(btnRemove.click(function(e){var retCon=confirm(_this.m_lang.REMOVE_CONFIRM_TIPS);if(!0===retCon){void 0!=_this.m_cfgPanel&&(_this.m_cfgPanel.close(),_this.m_parent.showAnlsPane());var div=$(e.currentTarget).closest(".treeRow"),dataSrcItemId=div.attr("id"),dataSrcId=_this.m_dataSourceId;WebAPI.get("/analysis/datasource/removeSingle/"+dataSrcId+"/"+dataSrcItemId+"/"+AppConfig.userId).done(function(result){var data=JSON.parse(result);if(Boolean(data.success)){for(var len=_this.m_allPointList.length,i=0;len>i;i++)if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break}_this.calUpdateDataSources(),div.tooltip("destroy"),div.remove();var arr=data.deleteModal,len=arr.length;if(len>0){for(var delMod,arrDelTitle=[],i=0;len>i;i++)delMod=$("#"+arr[i]),arrDelTitle.push(delMod.find(".newDivPageTitle").val()),delMod.remove();for(var delTitle=_this.m_lang.WORKSPACE+":",i=0,len=arrDelTitle.length;len>i;i++)delTitle+=arrDelTitle[i]+" ";delTitle+=_this.m_lang.REMOVE_RESULT,alert(delTitle)}}}).fail(function(e){})}}).error(function(e){}),div.append(btnRemove),bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');btnCfg.click(function(e){void 0!=_this.m_cfgPanel&&_this.m_cfgPanel.close();var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest(".treeRow").get(0).id,_this.m_selectGroupId=curTar.closest(".tree-group").get(0).id;for(var customName,ptDesc,ptName,item,prjId,i=0,len=_this.m_allPointList.length;len>i;i++)if(item=_this.m_allPointList[i],itemId===item.itemId){customName=item.customName,ptName=item.ptName,ptDesc=item.ptDesc,prjId=item.prjId;break}WebAPI.get("/static/views/observer/dataSourceAdd.html").done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,!1,customName,ptName,ptDesc,prjId),_this.m_cfgPanel.show()}).fail(function(result){}).always(function(e){})}).error(function(e){}),btnCfg.mouseenter(function(e){btnCfg.attr("src","/static/images/dataSource/item_edit_hover.png"),btnCfg.css("width","18px"),btnCfg.css("height","18px")}).error(function(e){}),btnCfg.mouseleave(function(e){btnCfg.attr("src","/static/images/dataSource/item_edit.png"),btnCfg.css("width","16px"),btnCfg.css("height","16px")}).error(function(e){}),div.append(btnCfg)}if(div.click(function(e){var divContain=$("#dataSrcPanel");divContain.find(".dsTreeBtnCfg").css("display","none"),divContain.find(".dsTreeBtnRemove").css("display","none");var curTarItem=$(e.currentTarget);curTarItem.find(".dsTreeBtnCfg").css("display","inline"),curTarItem.find(".dsTreeBtnRemove").css("display","inline"),_this.m_selectGroupId=curTarItem.closest(".tree-group").get(0).id}),0===insertType)divParentGroup.find(".rows").append(div);else if(1===insertType)""!=baseItem&&baseItem.after(div);else if(2===insertType){var lyRow=divParentGroup.find(".rows").find(".treeRow");0==lyRow.length?divParentGroup.find(".rows").append(div):lyRow.eq(0).before(div)}},getDSItemById:function(datasourceItemId){if(void 0!=this.m_parent.store.group)for(var itemGroup,lenItem,i=0,len=this.m_parent.store.group.length;len>i;i++){itemGroup=this.m_parent.store.group[i],lenItem=itemGroup.datasourceList.length;for(var j=0;lenItem>j;j++)if(datasourceItemId==itemGroup.datasourceList[j].id)return itemGroup.datasourceList[j]}if(void 0!=this.m_parent.store.dsInfoList)for(var itemInfo,i=0,len=this.m_parent.store.dsInfoList.length;len>i;i++)if(itemInfo=this.m_parent.store.dsInfoList[i],datasourceItemId==itemInfo.id)return itemInfo;return{}},getDSItemData:function(target,arrDSItemIds){var _this=this.m_parent,tmStart=_this.curModal.startTime,tmEnd=_this.curModal.endTime,tmFmt=_this.curModal.format,postData={dsItemIds:arrDSItemIds,timeStart:tmStart.format("yyyy-MM-dd HH:mm:ss"),timeEnd:tmEnd.format("yyyy-MM-dd HH:mm:ss"),timeFormat:tmFmt},ItemKey="anal_"+tmFmt+"_"+arrDSItemIds[0],sessionFind=sessionStorage.getItem(ItemKey);if(null==sessionFind)WebAPI.post("/analysis/startWorkspaceDataGenHistogram",postData).done(function(result){var data=JSON.parse(result);return data.error&&data.error.length>0?(target.errAlert(data.error),void target.spinnerStop()):(sessionStorage.setItem(ItemKey,result),void target.renderModal(data))}).error(function(e){_this.alertNoData()});else{var jsonSes=JSON.parse(sessionFind),tmStartSes=new Date(jsonSes.timeShaft[0]),tmLen=jsonSes.timeShaft.length,tmEndSes=new Date(jsonSes.timeShaft[tmLen-1]);if(tmStart>=tmStartSes&&tmEndSes>=tmEnd){var dataSrc=sessionStorage.getItem(ItemKey);target.renderModal(JSON.parse(dataSrc))}else sessionStorage.removeItem(ItemKey),WebAPI.post("/analysis/startWorkspaceDataGenHistogram",postData).done(function(result){var data=JSON.parse(result);return data.error&&data.error.length>0?(target.errAlert(data.error),void target.spinnerStop()):(sessionStorage.setItem(ItemKey,result),void target.renderModal(data))}).error(function(e){_this.alertNoData()}).always(function(e){})}},getDSItemDataMulti:function(target,arrDSItemIds){function getCurrentMonthLastDay(date){var current=new Date(date),currentMonth=current.getMonth(),nextMonth=++currentMonth,nextMonthDayOne=new Date(current.getFullYear(),nextMonth,1);return new Date(nextMonthDayOne.getTime())}function isLeapYear(year){return year%400==0||year%4==0&&year%100!=0}function getMonthDays(year,month){return[31,null,31,30,31,30,31,31,30,31,30,31][month]||(isLeapYear(year)?29:28)}function getWeekNumber(date){for(var now=new Date(date),year=now.getFullYear(),month=now.getMonth(),days=now.getDate(),i=0;month>i;i++)days+=getMonthDays(year,i);var yearFirstDay=new Date(year,0,1).getDay()||7,week=null;return 1==yearFirstDay?week=Math.ceil(days/yearFirstDay):(days-=7-yearFirstDay+1,week=Math.ceil(days/7)+1),week}var _this=this.m_parent;_this.curModal.arrComparePeriodLabel=[];var tmStart=_this.curModal.startTime;tmStart=tmStart.length<=10?tmStart+" 00:00:00":tmStart;var tmEnd=_this.curModal.endTime;tmEnd=tmEnd.length<=10?tmEnd+" 00:00:00":tmEnd;var period1,period2,time,tmFmt=_this.curModal.format,comparePeriod=_this.curModal.comparePeriod,startDate=new Date(tmStart),endDate=new Date(tmEnd);"hour"==comparePeriod&&(time=36e5,period1=new Date(startDate.getTime()+time).format("yyyy-MM-dd HH:mm:ss"),period2=new Date(endDate.getTime()+time).format("yyyy-MM-dd HH:mm:ss"),_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+"年"+(startDate.getMonth()+1)+"月"+startDate.getDate()+"日"+startDate.getHours()+":00"),_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+"年"+(endDate.getMonth()+1)+"月"+endDate.getDate()+"日"+endDate.getHours()+":00")),"day"==comparePeriod&&(time=864e5,period1=new Date(startDate.getTime()+time).format("yyyy-MM-dd HH:mm:ss"),period2=new Date(endDate.getTime()+time).format("yyyy-MM-dd HH:mm:ss"),_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+"年"+(startDate.getMonth()+1)+"月"+startDate.getDate()+"日"),_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+"年"+(endDate.getMonth()+1)+"月"+endDate.getDate()+"日")),"week"==comparePeriod&&(time=6048e5,period1=new Date(startDate.getTime()+time).format("yyyy-MM-dd HH:mm:ss"),period2=new Date(endDate.getTime()+time).format("yyyy-MM-dd HH:mm:ss"),_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+"年第"+getWeekNumber(tmStart)+"周"),_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+"年第"+getWeekNumber(tmEnd)+"周")),"month"==comparePeriod&&(period1=getCurrentMonthLastDay(tmStart),period2=getCurrentMonthLastDay(tmEnd),_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+"年"+(startDate.getMonth()+1)+"月"),_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+"年"+(endDate.getMonth()+1)+"月"));var postData=[{dsItemIds:arrDSItemIds,timeStart:tmStart.format("yyyy-MM-dd HH:mm:ss"),timeEnd:period1.format("yyyy-MM-dd HH:mm:ss"),timeFormat:tmFmt},{dsItemIds:arrDSItemIds,timeStart:tmEnd.format("yyyy-MM-dd HH:mm:ss"),timeEnd:period2.format("yyyy-MM-dd HH:mm:ss"),timeFormat:tmFmt}],ItemKey="anal_"+tmFmt+"_"+arrDSItemIds[0];WebAPI.post("/analysis/startWorkspaceDataGenHistogramMulti",postData).done(function(result){var data=JSON.parse(result);return data.error&&data.error.length>0?(target.errAlert(data.error),void target.spinnerStop()):(sessionStorage.setItem(ItemKey,result),void target.renderModal(data))}).error(function(e){_this.alertNoData()})},getShowNameFromFormula:function(formula){var _this=this,inputStr=formula,nStart=inputStr.indexOf("<%"),nEnd=inputStr.indexOf("%>");if(-1==nStart||-1==nEnd)return inputStr;var id=inputStr.substring(nStart+2,nEnd);if(""==id)return _this.getShowNameFromFormula(inputStr);var retVal=_this.getDSItemById(id);return null==retVal?_this.getShowNameFromFormula(inputStr):(inputStr=inputStr.replace("<%"+id+"%>",retVal.value),_this.getShowNameFromFormula(inputStr))}},DataSource}(),modalConfigurePane=function(){function modalConfigurePane(container,screen,modalType){_this=this,this.container=container,this.screen=screen,this.modalType=modalType,this.templateObj=void 0,this.optionType=void 0,this.option=void 0}var _this;return modalConfigurePane.prototype={show:function(){$.get("/static/views/observer/widgets/modalConfigurePane.html").done(function(resultHtml){_this.container.innerHTML+=resultHtml,"dataAnalysis"==_this.modalType?document.getElementById("startConfig").setAttribute("i18n","modalConfig.btnStartConfig.TYPE1"):"dashboard"==_this.modalType&&document.getElementById("startConfig").setAttribute("i18n","modalConfig.btnStartConfig.TYPE2"),I18n.fillArea($("#modalConfig"))})},showModalInit:function(optionType,option,templateObj){this.optionType=optionType,this.option=option,this.templateObj=templateObj,!_this.option.dataTypeMaxNum&&(_this.option.dataTypeMaxNum=[5]),this.init(),$("#modalConfig").modal("show")},init:function(){var $modalConfig=$("#modalConfig");$modalConfig.off("show.bs.modal").on("show.bs.modal",function(e){return"bs.modal"!==e.namespace?!0:(_this.initOption(),_this.initConfigData(),$("#inputAddGroup").click(function(e){$(e.target).focus()}),void("dashboard"==_this.modalType&&document.querySelector("#rightCt").click()))}),$modalConfig.off("shown.bs.modal").on("shown.bs.modal",function(){_this.initTime(),_this.initDrag(),_this.initConfigStart()}),$modalConfig.off("hidden.bs.modal").on("hidden.bs.modal",function(){$modalConfig.find("#dataConfig").html('<div><span I18n="modalConfig.data.DATA_CONFIG_TITLE_PRE"></span><span I18n="modalConfig.data.DATA_CONFIG_TITLE_TYPE1"></span></div>'),I18n.fillArea($modalConfig.find("#dataConfig")),"dashboard"==_this.modalType&&document.querySelector("#rightCt").click()})},initDataTypeWidth:function(ele){ele.addClass(window.innerWidth>1200?ele.outerWidth()<ele.parent().outerWidth()/4?"col-lg-3":ele.outerWidth()<ele.parent().outerWidth()/2?"col-lg-6":ele.outerWidth()<3*ele.parent().outerWidth()/4?"col-lg-9":"col-lg-12":ele.outerWidth()<ele.parent().outerWidth()/3?"col-xs-4":ele.outerWidth()<2*ele.parent().outerWidth()/3?"col-xs-8":"col-xs-12")},initOption:function(){function initMode(mode){sessionStorage.setItem("mode",$inputMode.val()),$divMode.siblings().css("display","none"),$inputInterval.children().removeClass("forbid");for(var i=0;i<totalModeType[mode].length;i++)totalModeType[mode][i].css("display","block");switch(mode){case"easy":initPeriodDropDown(mode),initInterval(mode);break;case"recent":initInterval(mode);break;case"easyEnergy":initPeriodDropDown(mode),initInterval(mode);break;case"compareSensor":initCompareDate();break;case"compareMeter":initCompareDate();break;case"weather":$dataConfig.css("display","none"),$startConfig.addClass("alwaysEnable");break;case"easyCompareAnalyz":$inputComparePeriod.val("month"),initCompareDate();break;case"easyCompare":$inputComparePeriod.val("day")}}function initInterval(mode){if($inputInterval.children().addClass("forbid"),"recent"==mode){switch(sessionStorage.setItem("periodUnit",$inputPeriodUnit.children(":selected").val()),$inputPeriodUnit.children(":selected").val()){case"second":firstSelect="m5",secondSelect="m1";break;case"minute":firstSelect="m5",secondSelect="m1";break;case"hour":firstSelect="h1",secondSelect="m5";break;case"day":firstSelect="d1",secondSelect="h1";break;case"month":firstSelect="M1",secondSelect="d1"}$inputInterval.find('option[value="'+secondSelect+'"]').removeClass("forbid")}if("easy"==mode)switch(sessionStorage.setItem("periodDropDown",$inputPeriodDropDown.val()),$inputPeriodDropDown.val()){case"today":firstSelect="h1";break;case"yesterday":firstSelect="h1";break;case"thisWeek":firstSelect="d1";break;case"lastWeek":firstSelect="d1";break;case"thisYear":firstSelect="M1"}$inputInterval.find('option[value="'+firstSelect+'"]').removeClass("forbid").attr("selected",!0),
sessionStorage.setItem("interval",$inputInterval.val())}function initPeriodDropDown(mode){$inputPeriodDropDown.children("").removeClass("forbid"),"easy"==mode?$inputPeriodDropDown.children().eq(1).addClass("forbid"):"easyEnergy"==mode&&($inputPeriodDropDown.children().eq(2).addClass("forbid"),$inputPeriodDropDown.children().eq(4).addClass("forbid"),$inputPeriodDropDown.children().eq(5).addClass("forbid"))}function initCompareDate(){var $compareDate=$(".form_datetime.compare"),periodType=$inputComparePeriod.val();switch(periodType){case"hour":$compareDate.datetimepicker("remove"),$compareDate.datetimepicker({format:"yyyy-mm-dd hh:ii:ss",minView:"day",startView:"day",autoclose:!0,todayBtn:!0,initialDate:new Date});break;case"day":$compareDate.datetimepicker("remove"),$compareDate.datetimepicker({format:"yyyy-mm-dd",minView:"month",startView:"month",autoclose:!0,todayBtn:!0,initialDate:new Date});break;case"week":$compareDate.datetimepicker("remove"),$compareDate.datetimepicker({format:"yyyy-mm-dd",minView:"month",startView:"month",autoclose:!0,todayBtn:!0,initialDate:new Date});break;case"month":$compareDate.datetimepicker("remove"),$compareDate.datetimepicker({format:"yyyy-mm-dd",minView:"year",startView:"year",autoclose:!0,todayBtn:!0,initialDate:new Date})}}function initGaugeMode(){var green='<span class="input-group-addon gaugeGreen" i18n="modalConfig.option.GAUGE_GREEN"></span>',red='<span class="input-group-addon gaugeRed" i18n="modalConfig.option.GAUGE_RED"></span>';"high"==$gaugeMode.val()?($gaugeLowerLimit.next().remove(),$gaugeLowerLimit.after(green),$normalUpperLimit.next().remove(),$normalUpperLimit.after(red)):"low"==$gaugeMode.val()&&($gaugeLowerLimit.next().remove(),$gaugeLowerLimit.after(red),$normalUpperLimit.next().remove(),$normalUpperLimit.after(green)),I18n.fillArea($("#divGauge"))}var i,$inputMode=$("#inputMode"),$divMode=$inputMode.parent(),$inputInterval=$("#inputInterval"),$divInterval=$inputInterval.parent(),$divInputGroupPeriod=$("#divInputGroupPeriod"),$divPeriod=$divInputGroupPeriod.parent(),$inputPeriodUnit=$("#inputPeriodUnit"),$inputPeriodValue=$("#inputPeriodValue"),$inputPeriodDropDown=$("#inputPeriodDropDown"),$divPeriodDropDown=$inputPeriodDropDown.parent(),$divInputGroupTimeRange=$("#divInputGroupTimeRange"),$divTimeRange=$divInputGroupTimeRange.parent(),$inputTimeStart=$("#inputTimeStart"),$inputTimeEnd=$("#inputTimeEnd"),$gaugeMode=$("#gaugeMode"),$divGaugeMode=$gaugeMode.parent(),$divGauge=$("#divGauge"),$gaugeLowerLimit=$("#gaugeLowerLimit"),$gaugeUpperLimit=$("#gaugeUpperLimit"),$normalLowerLimit=$("#normalLowerLimit"),$normalUpperLimit=$("#normalUpperLimit"),$inputComparePeriod=$("#inputComparePeriod"),$divComparePeriod=$inputComparePeriod.parent(),$divCompareDate=($("#inputCompareDate1"),$("#inputCompareDate2"),$("#divCompareDate")),$inputRealTimeInterval=$("#inputRealTimeInterval"),$divRealTimeInterval=$inputRealTimeInterval.parent(),$divHistoryRange=$("#divHistoryRange"),$inputHistoryRange=$("#inputHistoryRange"),totalModeType={easy:[$divPeriodDropDown],fixed:[$divInterval,$divTimeRange],recent:[$divInterval,$divPeriod],realTime:[],easyEnergy:[$divPeriodDropDown],realTimeDashboard:[$divRealTimeInterval],easyCompareAnalyz:[$divCompareDate],easyCompare:[$divComparePeriod],compareSensor:[$divInterval,$divComparePeriod,$divCompareDate],compareMeter:[$divInterval,$divComparePeriod,$divCompareDate],gauge:[$divGauge,$divGaugeMode],weather:[],easyHistory:[$divHistoryRange]},$dataConfig=$("#dataConfig"),$startConfig=$("#startConfig");$dataConfig.css("display","block"),$startConfig.removeClass("alwaysEnable"),$inputMode.children().css("display","none");var modeSelectInit=!1;for(i=0;i<_this.option.modeUsable.length;i++)$inputMode.children("option[value="+_this.option.modeUsable[i]+"]").css("display","block"),_this.optionType?sessionStorage.getItem("mode")!=_this.option.modeUsable[i]||modeSelectInit||($inputMode.val(_this.option.modeUsable[i]),modeSelectInit=!0):"fixed"!=_this.option.modeUsable[i]||modeSelectInit||($inputMode.val("fixed"),modeSelectInit=!0);modeSelectInit||$inputMode.val(_this.option.modeUsable[0]),initMode($inputMode.val()),$inputMode.change(function(e){initMode($inputMode.val())}),this.optionType?null!=sessionStorage.getItem("interval")?$inputInterval.val($inputInterval.children('option[value="'+sessionStorage.getItem("interval")+'"]').hasClass("forbid")?$inputInterval.children(":not(.forbid)").first():sessionStorage.getItem("interval")):sessionStorage.setItem("interval",$inputInterval.val()):$inputInterval.val(_this.option.optionPara.interval?_this.option.optionPara.interval:$inputInterval.children(":not(.forbid)").first()),$inputInterval.change(function(e){sessionStorage.setItem("interval",$(e.target).val())});var firstSelect,secondSelect;this.optionType&&(sessionStorage.getItem("periodValue")&&$inputPeriodValue.val(sessionStorage.getItem("periodValue")),sessionStorage.getItem("periodUnit")&&$inputPeriodUnit.val(sessionStorage.getItem("periodUnit")),sessionStorage.getItem("periodDropDown")&&($inputPeriodDropDown.children('option[value="'+sessionStorage.getItem("periodDropDown")+'"]').hasClass("forbid")&&$inputPeriodDropDown.val($inputPeriodDropDown.children(":not(.forbid)").first()),$inputPeriodDropDown.val(sessionStorage.getItem("periodDropDown")))),$inputPeriodValue.off("change").change(function(e){sessionStorage.setItem("periodValue",e.target.value)}),$inputPeriodUnit.off("change").change(function(e){initInterval($inputMode.val())}),$divPeriodDropDown.off("change").change(function(e){initInterval($inputMode.val())}),$inputTimeStart.val(_this.optionType&&null!=sessionStorage.getItem("timeStart")?sessionStorage.getItem("timeStart"):_this.option.optionPara.startTime),$inputTimeStart.change(function(e){""!=e.target.value&&sessionStorage.setItem("timeStart",e.target.value)}),$inputTimeEnd.val(_this.optionType&&null!=sessionStorage.getItem("timeEnd")?sessionStorage.getItem("timeEnd"):_this.option.optionPara.endTime),$inputTimeEnd.change(function(e){""!=e.target.value&&sessionStorage.setItem("timeEnd",e.target.value)}),_this.option.optionPara.timeType&&"easyCompare"==$inputMode.val()?$inputComparePeriod.val(_this.option.optionPara.timeType):null!=sessionStorage.getItem("comparePeriod")&&$inputComparePeriod.val(sessionStorage.getItem("comparePeriod")),$inputComparePeriod.change(function(){sessionStorage.setItem("comparePeriod",$inputComparePeriod.val()),initCompareDate()}),null!=sessionStorage.getItem("gaugeMode")&&$gaugeMode.val(sessionStorage.getItem("gaugeMode")),$gaugeMode.change(function(){sessionStorage.setItem("gaugeMode",$gaugeMode.val())}),initGaugeMode(),$gaugeMode.change(function(){initGaugeMode()}),_this.option.optionPara.scaleList&&_this.option.optionPara.scaleList.sort(function(a,b){return a>b?1:-1}),_this.optionType&&null!=sessionStorage.getItem("gaugeLowerLimit")?$gaugeLowerLimit.val(sessionStorage.getItem("gaugeLowerLimit")):!_this.optionType&&_this.option.optionPara.scaleList&&$gaugeLowerLimit.val(_this.option.optionPara.scaleList[0]),$gaugeLowerLimit.change(function(){sessionStorage.setItem("gaugeLowerLimit",$gaugeLowerLimit.val())}),_this.optionType&&null!=sessionStorage.getItem("gaugeUpperLimit")?$gaugeUpperLimit.val(sessionStorage.getItem("gaugeUpperLimit")):!_this.optionType&&_this.option.optionPara.scaleList&&$gaugeUpperLimit.val(_this.option.optionPara.scaleList[3]),$gaugeUpperLimit.change(function(){sessionStorage.setItem("gaugeUpperLimit",$gaugeUpperLimit.val())}),_this.optionType&&null!=sessionStorage.getItem("normalLowerLimit")?$normalLowerLimit.val(sessionStorage.getItem("normalLowerLimit")):!_this.optionType&&_this.option.optionPara.scaleList&&$normalLowerLimit.val(_this.option.optionPara.scaleList[1]),$normalLowerLimit.change(function(){sessionStorage.setItem("normalLowerLimit",$normalLowerLimit.val())}),_this.optionType&&null!=sessionStorage.getItem("normalUpperLimit")?$normalUpperLimit.val(sessionStorage.getItem("normalUpperLimit")):!_this.optionType&&_this.option.optionPara.scaleList&&$normalUpperLimit.val(_this.option.optionPara.scaleList[2]),$normalUpperLimit.change(function(){sessionStorage.setItem("normalUpperLimit",$normalUpperLimit.val())}),_this.option.optionPara.timeType&&"realTimeDashboard"==$inputMode.val()?$inputHistoryRange.val(_this.option.optionPara.timeType):null!=sessionStorage.getItem("historyRange")&&$inputHistoryRange.val(sessionStorage.getItem("historyRange")),$inputHistoryRange.change(function(){sessionStorage.setItem("historyRange",$inputHistoryRange.val())}),_this.option.optionPara.timeType&&"easyHistory"==$inputMode.val()?$inputHistoryRange.val(_this.option.optionPara.timeType):null!=sessionStorage.getItem("historyRange")&&$inputHistoryRange.val(sessionStorage.getItem("historyRange")),$inputHistoryRange.change(function(){sessionStorage.setItem("historyRange",$inputHistoryRange.val())})},initConfigData:function(){function initDataTipAndButton(){for(var NumOfDataTypeWithValue=0,$rowDataValue=$(".rowDataValue"),i=0;i<$rowDataValue.length;++i)$rowDataValue.eq(i).children().length>1&&(NumOfDataTypeWithValue+=1),$rowDataValue.eq(i).children().length>_this.option.dataTypeMaxNum[i]?$(".dataDragTip").get(i).style.display="none":$(".dataDragTip").get(i).style.display="block";1==_this.option.allDataNeed?NumOfDataTypeWithValue==$rowDataValue.length?$("#startConfig").removeClass("disabled"):$("#startConfig").addClass("disabled"):NumOfDataTypeWithValue?$("#startConfig").removeClass("disabled"):$("#startConfig").addClass("disabled")}var $dataConfig=$("#dataConfig"),strDataTitle="<span>"+I18n.resource.modalConfig.data.DATA_CONFIG_TITLE_TYPE1+"</span>",strTempDataTitle="<span>"+I18n.resource.modalConfig.data.DATA_CONFIG_TITLE_TYPE2+"</span>";strDataTitle=strDataTitle.replace("5",_this.option.dataTypeMaxNum[0]),$dataConfig.find("span").get(1).outerHTML=strDataTitle;var resetFlag=!1;if(1!=_this.option.dataTypeMaxNum.length)for(var i=0;i<_this.option.dataTypeMaxNum.length;++i)if(_this.option.dataTypeMaxNum[i]!=_this.option.dataTypeMaxNum[i+1]&&!resetFlag){$dataConfig.find("span").get(1).outerHTML="",i=0,resetFlag=!0;break}if(resetFlag)for(var i=0;i<_this.option.dataTypeMaxNum.length;++i)strDataTitle=strTempDataTitle.replace("<%type%>",_this.option.rowDataType[i]),strDataTitle=strDataTitle.replace("<%maxNum%>",_this.option.dataTypeMaxNum[i]),$dataConfig.children().get(0).innerHTML+=strDataTitle;for(var strConfigModalBody=$dataConfig.html(),i=0;i<_this.option.rowDataType.length;++i)strConfigModalBody+='<div class="divConfigData" dataType="'+_this.option.rowDataType[i]+'">\r\n                                                <div class="dataTypeName">'+_this.option.rowDataType[i]+'</div>\r\n                                                <div class="row rowDataValue"><div class="dataDragTip col-lg-3 col-xs-4"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></div></div>\r\n                                    </div>';$dataConfig.html(strConfigModalBody);var btnStartConfigEnable;for(i=0;i<_this.option.optionPara.dataItem.length;++i){var $dataDragTip=$dataConfig.find('[dataType="'+_this.option.optionPara.dataItem[i].dsType+'"]').find(".dataDragTip");0==$dataDragTip.length&&($dataDragTip=$(".dataDragTip").eq(i));for(var strDSConfig,j=0;j<_this.option.optionPara.dataItem[i].dsId.length;++j)strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow" dsid="'+_this.option.optionPara.dataItem[i].dsId[j]+'"><span class="contentDS">'+_this.option.optionPara.dataItem[i].dsName[j]+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>',$dataDragTip.before(strDSConfig),btnStartConfigEnable=!0}initDataTipAndButton(),$(".alwaysEnable").removeClass("disabled"),$(".divDSConfigure span").on("click",function(e){var $thisPar=$(e.target).parent();$thisPar.remove(),initDataTipAndButton()})},initTime:function(){var $inputTimeStart=$("#inputTimeStart"),$inputTimeEnd=$("#inputTimeEnd");if($inputTimeStart.datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:!0,todayBtn:!0,initialDate:new Date}),$inputTimeEnd.datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:!0,todayBtn:!0,initialDate:new Date}),_this.optionType&&!sessionStorage.getItem("timeStart")&&!sessionStorage.getItem("timeEnd")){var now=new Date,time=new Date(now-2592e5).format("yyyy-MM-dd HH:mm");$inputTimeStart.val(time),now=now.format("yyyy-MM-dd HH:mm"),$inputTimeEnd.val(now)}var mode=$("#inputMode").val();"easyCompareAnalyz"==mode&&($("#inputCompareDate1").val(new Date(new Date((new Date).setMonth((new Date).getMonth()-2)).setDate(1)).format("yyyy-MM-dd")+" 00:00:00"),$("#inputCompareDate2").val(new Date(new Date((new Date).setMonth((new Date).getMonth()-1)).setDate(1)).format("yyyy-MM-dd")+" 00:00:00")),("compareMeter"==mode||"compareSensor"==mode)&&$("#inputComparePeriod").change(function(){$(this).val()})},initDrag:function(){function initBtnStartAndDragTip(indexOfDataType){var tempDivDS=$divConfigData.find(".rowDataValue").eq(indexOfDataType).children();if(1==_this.option.allDataNeed){initBtnStartEnable=!0;for(var i=0;i<$divConfigData.length;++i)if($divConfigData.find(".rowDataValue").eq(i).children().length<=1){initBtnStartEnable=!1;break}tempDivDS.length>1?tempDivDS.length>_this.option.dataTypeMaxNum[indexOfDataType]?initDragTipShow[indexOfDataType]=!1:initDragTipShow[indexOfDataType]=!0:(initBtnStartEnable-=1,initDragTipShow[indexOfDataType]=!0)}else initBtnStartEnable=$divConfigData.find(".divDSConfigure").length>0?!0:!1,tempDivDS.length>_this.option.dataTypeMaxNum[indexOfDataType]?initDragTipShow[indexOfDataType]=!1:initDragTipShow[indexOfDataType]=!0;initBtnStartEnable>0?$btnConfigStart.removeClass("disabled"):$btnConfigStart.addClass("disabled"),initDragTipShow[indexOfDataType]?tempDivDS.last().css("display","block"):tempDivDS.last().css("display","none")}var $divConfigData=$(".divConfigData"),$btnConfigStart=$("#startConfig"),_this=this;$divConfigData.on("dragover",function(e){e.preventDefault(),$(e.currentTarget).find(".dataDragTip").addClass("addData")}),$divConfigData.on("dragleave",function(e){e.preventDefault(),$(e.currentTarget).find(".dataDragTip").removeClass("addData")});var targetId,targetContent,initBtnStartEnable,index,initDragTipShow=[];$divConfigData.on("drop",function(e){for(var j=0;j<$divConfigData.length;++j)$divConfigData.find(".rowDataValue").eq(j).children().length<_this.option.dataTypeMaxNum[j]+1?initDragTipShow[j]=!0:initDragTipShow[j]=!1;if(index=$(e.currentTarget).index()-1,!initDragTipShow[index])return void new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE1+"</strong>").show().close();var $rowTempData=$(e.currentTarget).find(".rowDataValue"),$dataDragTip=$rowTempData.find(".dataDragTip");if(targetId=e.originalEvent.dataTransfer.getData("dsItemId"),targetContent=AppConfig.datasource.getDSItemById(targetId).alias,$rowTempData.find('.divDSConfigure[dsid="'+targetId+'"]').length>0)return void new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE2+"</strong>").show().close();var strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow" dsid="'+targetId+'"><span class="contentDS">'+targetContent+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig),initBtnStartAndDragTip(index),$(e.currentTarget).find(".divDSConfigure span").last().on("click",function(e){{var $thisPar=$(e.target).parent();$thisPar.attr("dsid")}$thisPar.remove(),initBtnStartAndDragTip(index);var $dataConfig=$("#dataConfig");$dataConfig.height(""),$dataConfig.height()>window.innerHeight-80&&$dataConfig.css("height","100%")});var $dataConfig=$("#dataConfig");$dataConfig.height(""),$dataConfig.height()>window.innerHeight-80&&$dataConfig.css("height","100%")})},initConfigStart:function(){var $modalConfig=$("#modalConfig"),$inputModal=$("#inputMode");document.getElementById("startConfig").onclick=function(){function getTimeOfMidnightZero(date){var tempDate;return tempDate=date?date:new Date,new Date(date.format("yyyy-MM-dd")+" 00:00:00")}for(var tempStartTime,tempEndTime,tempPeriodTime,tempDSId,tempDS,timeType,scaleList,now,tempInterval=0,$inputPeriodValue=$("#inputPeriodValue"),periodValue=$inputPeriodValue.val(),arrItemDS=[],$rowDataValue=$(".rowDataValue"),$inputInterval=$("#inputInterval"),$inputTimeStart=$("#inputTimeStart"),$inputTimeEnd=$("#inputTimeEnd"),$inputPeriodUnit=$("#inputPeriodUnit"),$inputPeriodDropDown=$("#inputPeriodDropDown"),$inputCompareDate1=$("#inputCompareDate1"),$inputCompareDate2=$("#inputCompareDate2"),$inputComparePeriod=$("#inputComparePeriod"),$gaugeMode=$("#gaugeMode"),$gaugeLowerLimit=$("#gaugeLowerLimit"),$gaugeUpperLimit=$("#gaugeUpperLimit"),$normalLowerLimit=$("#normalLowerLimit"),$normalUpperLimit=$("#normalUpperLimit"),i=0;i<$rowDataValue.length;++i){tempDS={},tempDS.type=$rowDataValue[i].parentNode.getAttribute("dataType"),tempDSId=[];for(var j=0;j<$rowDataValue[i].children.length-1;++j)tempDSId.push($rowDataValue[i].children[j].getAttribute("dsid"));tempDS.arrId=tempDSId,arrItemDS.push(tempDS)}var totalModeType={easy:"easy",fixed:"fixed",recent:"recent",realTime:"realTime",easyCompareAnalyz:"easyCompareAnalyz",easyCompare:"easyCompare",compareSensor:"compareSensor",compareMeter:"compareMeter",realTimeDashboard:"realTimeDashboard",gauge:"gauge",weather:"weather",easyHistory:"easyHistory"};switch($inputModal.val()){case totalModeType.fixed:if(tempStartTime=new Date($inputTimeStart.val()).format("yyyy-MM-dd HH:mm:ss"),tempEndTime=new Date($inputTimeEnd.val()).format("yyyy-MM-dd HH:mm:ss"),new Date(tempStartTime)>=new Date(tempEndTime))return void new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE3+"</strong>").show().close();if(new Date(tempEndTime)>=new Date)return void new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE4+"</strong>").show().close();break;case totalModeType.recent:switch(tempEndTime=(new Date).format("yyyy-MM-dd HH:mm:ss"),$inputPeriodUnit.val()){case"hour":tempPeriodTime=36e5*periodValue;break;case"day":tempPeriodTime=864e5*periodValue;break;case"month":tempPeriodTime=2592e6*periodValue;break;case"year":tempPeriodTime=31536e6*periodValue}now=new Date,tempStartTime=new Date(now-tempPeriodTime).format("yyyy-MM-dd HH:mm:ss");break;case totalModeType.realTime:tempStartTime="",tempEndTime="";break;case totalModeType.easy:switch(now=new Date,$inputPeriodDropDown.val()){case"today":tempPeriodTime=864e5,tempEndTime=now.format("yyyy-MM-dd HH:mm:ss"),tempStartTime=new Date(now-tempPeriodTime).format("yyyy-MM-dd HH:mm:ss");break;case"yesterday":var yesterday=new Date;yesterday=new Date(yesterday.setDate(yesterday.getDate()-1)),tempEndTime=new Date(getTimeOfMidnightZero(now).getTime()-1e3).format("yyyy-MM-dd HH:mm:ss"),tempStartTime=getTimeOfMidnightZero(yesterday).format("yyyy-MM-dd HH:mm:ss");break;case"thisWeek":tempPeriodTime=6048e5,tempEndTime=now.format("yyyy-MM-dd HH:mm:ss"),tempStartTime=new Date(now-tempPeriodTime).format("yyyy-MM-dd HH:mm:ss");break;case"lastWeek":tempPeriodTime=6048e5,tempEndTime=getTimeOfMidnightZero(new Date(now-864e5*(now.getDay()+1))).format("yyyy-MM-dd HH:mm:ss"),tempStartTime=getTimeOfMidnightZero(new Date(now-864e5*(now.getDay()+7))).format("yyyy-MM-dd HH:mm:ss");break;case"thisYear":tempPeriodTime=31536e6,tempEndTime=now.format("yyyy-MM-dd HH:mm:ss"),tempStartTime=new Date(now-tempPeriodTime).format("yyyy-MM-dd HH:mm:ss")}break;case totalModeType.realTimeDashboard:tempStartTime="",tempEndTime="",tempInterval=$inputInterval.val(),timeType=$("#inputRealTimeInterval").val();break;case totalModeType.easyCompareAnalyz:tempStartTime=$inputCompareDate1.val(),tempEndTime=$inputCompareDate2.val(),tempPeriodTime="month",$inputInterval.val("h1"),timeType=$inputComparePeriod.val();break;case totalModeType.easyCompare:tempPeriodTime="month",$inputInterval.val("h1"),timeType=$inputComparePeriod.val();break;case totalModeType.compareSensor:tempStartTime=$inputCompareDate1.val(),tempEndTime=$inputCompareDate2.val(),tempPeriodTime=$inputComparePeriod.val(),timeType=$inputComparePeriod.val();break;case totalModeType.compareMeter:tempStartTime=$inputCompareDate1.val(),tempEndTime=$inputCompareDate2.val(),tempPeriodTime=$inputComparePeriod.val(),timeType=$inputComparePeriod.val();break;case totalModeType.gauge:for(scaleList="high"==$gaugeMode.val()?[$gaugeLowerLimit.val(),$normalLowerLimit.val(),$normalUpperLimit.val(),$gaugeUpperLimit.val()]:[$gaugeUpperLimit.val(),$normalUpperLimit.val(),$normalLowerLimit.val(),$gaugeLowerLimit.val()],i=0;i<scaleList.length;i++){if(isNaN(Number(scaleList[i])))return void new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE10+"</strong>").show().close();scaleList[i]=parseFloat(scaleList[i])}var tempArr=scaleList.concat();if(tempArr.sort("high"==$gaugeMode.val()?function(a,b){return a>b?1:-1}:function(a,b){return b>a?1:-1}),tempArr.toString()!=scaleList.toString())return void new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE5+"</strong>").show().close();break;case totalModeType.weather:tempStartTime="",tempEndTime="";break;case totalModeType.easyHistory:timeType=$("#inputHistoryRange").val()}if("dataAnalysis"==_this.modalType)_this.screen.curModal={startTime:tempStartTime,endTime:tempEndTime,format:$inputInterval.val(),mode:$inputModal.val(),type:_this.option.templateType,itemDS:arrItemDS,comparePeriod:tempPeriodTime};else if("dashboard"==_this.modalType){_this.templateObj.configParams={};var $divDSConfigure=$(".divDSConfigure");_this.templateObj.entity.modal.title=$(".springSel .chartTitle").val(),_this.templateObj.entity.modal.points=[],_this.templateObj.entity.modal.StartTime=tempStartTime,_this.templateObj.entity.modal.EndTime=tempEndTime;for(var i=0;i<$divDSConfigure.length;++i)_this.templateObj.entity.modal.points.push($divDSConfigure.get(i).attributes.dsid.value);var option={};timeType&&(option.timeType=timeType),scaleList&&(option.scaleList=scaleList)}$modalConfig.modal("hide"),_this.newPageFlag=!0,"dataAnalysis"==_this.modalType?_this.screen.renderModal():"dashboard"==_this.modalType&&(_this.templateObj.setModalOption(option),_this.templateObj.render())}},close:function(){this.screen=null,this.container=null,this.modalType=null}},modalConfigurePane}(),ObserverScreen=function(){function ObserverScreen(id){this.id=id,this.canvas=void 0,this.ctx=void 0,this.cacheCanvas=void 0,this.cacheCtx=void 0,this.hitModel=void 0,this.workerUpdate=void 0,this.isRunning=!0,this.store={},this.dictRefreshMap=void 0,this.stopWatch=void 0,this.dictPipelines=void 0,this.dictEquipments=void 0,this.dictCharts=void 0,this.dictGages=void 0,this.dictRulers=void 0,this.dictButtons=void 0,this.dictCheckboxs=void 0,this.dictTexts=void 0,this.dictTempDistributions=void 0,this.dictImages={},this.indexImageLoaded=0,this.isDetailPage=!1,this.dialogTitle=void 0,this.isDataReady=!1,this.isPlayback=!1,this.toolContainer=void 0}return ObserverScreen.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),_this.isDetailPage?this.init():$.get("/static/views/observer/observerScreen.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),Spinner.spin(ElScreenContainer),_this.init(),I18n.fillArea($(ElScreenContainer))})},close:function(){$(".observer-text-editor").remove(),ModelText.destroy();var $toolBacktrace=$(".toolBacktrace");$toolBacktrace.prev().remove(),$toolBacktrace.remove(),this.workerUpdate&&this.workerUpdate.terminate(),this.workerUpdate=null;for(var item in this.dictCharts)this.dictCharts[item].close();this.isRunning=null,this.canvas=null,this.ctx=null,this.cacheCanvas=null,this.store=null,this.dictRefreshMap=null,this.dictPipelines=null,this.dictGages=null,this.dictRulers=null,this.dictEquipments=null,this.dictButtons=null,this.dictTexts=null,this.dictCheckboxs=null,this.dictImages=null,this.hitModel=null,this.stopWatch=null,this.isDetailPage||($("#ulTools").html(""),ToolCurrent&&ToolCurrent.close(),ToolCurrent=null)},stop:function(){this.isRunning=!1,this.workerUpdate&&this.workerUpdate.terminate()},resume:function(){this.isRunning=!0,this.initWorkerForUpdating(),requestAnimationFrame(animate)},resize:function(){},init:function(){var _this=this;WebAPI.get("/get_plant/"+AppConfig.projectId+"/"+this.id).done(function(result){_this.store=JSON.parse(result),_this.initScreen(),_this.isDetailPage||_this.initToolBar(),_this.initImageDictionary(),_this.renderElements(),_this.isPlayback?ToolCurrent.requestDataForCurrentMoment(_this):_this.initWorkerForUpdating(),_this.initAnimation()}).error(function(e){alert(I18n.resource.observer.widgets.DATA_REQUEST_FAILED),Spinner.stop()})},renderElements:function(){this.hitModel=new HitModel(this.canvas),this.dictRefreshMap={},this.initPipelines(),this.initEquipments(),this.initCharts(),this.initGages(),this.initRulers(),this.initCheckboxs(),this.initButtons(),this.initTexts(),this.initTempDistribution(),this.initHitModel()},initToolBar:function(){var _this=this;this.toolContainer=$("#divObserverTools");var btnTimeShaft=$("<li><a>").addClass("toolBacktrace");btnTimeShaft.children().text(I18n.resource.observer.widgets.BACKTRACE).click(function(e){function enterBacktraceMode(e){_this.isPlayback=!0,e.currentTarget.classList.add("toolbar-btn-selected"),ToolCurrent=new TimeShaft(_this),ToolCurrent.containerHeight=100,ToolCurrent.show(),_this.workerUpdate&&_this.workerUpdate.terminate();var jCanvas=$("#divObserverCanvas"),height=jCanvas.height()-ToolCurrent.containerHeight;jCanvas.animate({height:height,width:height*_this.canvas.width/_this.canvas.height},300,function(){_this.initScreen(),_this.renderElements()})}function quitBacktraceMode(e){_this.isPlayback=!1,e.currentTarget.classList.remove("toolbar-btn-selected"),ToolCurrent.close(),ToolCurrent=null,$("#divObserverCanvas").animate({height:"100%",width:"100%"},300,function(){_this.initScreen(),_this.renderElements(),_this.initWorkerForUpdating()})}_this.isPlayback?quitBacktraceMode(e):enterBacktraceMode(e)}),$("#ulTools").html("");var divider=$("<li>").addClass("divider");$("#right-nav").find("li:first li:last").before(btnTimeShaft).before(divider)},initScreen:function(){function convertPositionToReal(arr){if(arr)for(var i=0;i<arr.length;i++){var temp=arr[i];temp.x=temp.x-paddingLeft,temp.y=temp.y-paddingTop}}function convertTempDistributionsToReal(dis){dis&&(dis.x-=paddingLeft,dis.y-=paddingTop,convertPositionToReal(dis.data))}if(this.isDetailPage="fullscreen"!=this.store.page.type,this.isDetailPage){var _this=this,dialogWidth=this.store.page.width+40>$(window).width()?$(window).width()-200:this.store.page.width+40,detailScreenModal=$("#detailScreenModal");if(I18n.fillArea($("#detailScreenModal")),this.dialogTitle){var oldDialogTitle=detailScreenModal.find(".modal-title").text();detailScreenModal.find(".modal-title").text(this.dialogTitle)}detailScreenModal.find(".modal-dialog").css("margin","0 auto 0 auto").css("width",dialogWidth),detailScreenModal.off("hidden.bs.modal").on("hidden.bs.modal",function(e){_this.close(),_this.initToolBar(),ScreenModal=null,Spinner.stop(),oldDialogTitle&&$(this).find(".modal-title").text(oldDialogTitle)}).modal({}),Spinner.spin(ElScreenContainer.getElementsByClassName("modal-body")[0]);var paddingLeft=(1920-this.store.page.width)/2,paddingTop=(955-this.store.page.height)/2;convertPositionToReal(this.store.equipments),convertPositionToReal(this.store.buttons),convertPositionToReal(this.store.texts),convertTempDistributionsToReal(this.store.tempDistributions)}else ScreenModal&&(ScreenCurrent&&ScreenCurrent.close(),ScreenCurrent=ScreenModal,ScreenModal=null),$("#page-"+this.id).parent().addClass("active");this.canvas=document.getElementById(this.isDetailPage?"canvasDetail":"canvasOverview"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.store.page.width,this.canvas.height=this.store.page.height},initWorkerForUpdating:function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js"),this.workerUpdate.self=this,this.workerUpdate.addEventListener("message",this.refreshData,!0),this.workerUpdate.addEventListener("error",function(e){console.log(e)},!0),this.workerUpdate.postMessage({projectId:AppConfig.projectId,id:this.id,pointList:Object.keys(this.dictRefreshMap),type:"dataRealtime"})},initAnimation:function(){function animate(){if(_this.isRunning){_this.ctx.clearRect(0,0,_this.canvas.width,_this.canvas.height);var item,element,time=_this.stopWatch.getElapsedTime();for(item in _this.dictPipelines)element=_this.dictPipelines[item],element.update(_this.ctx,250);for(item in _this.dictEquipments)element=_this.dictEquipments[item],element.update(null,time),element.refreshImage(_this.store.animationList,_this.dictImages);for(var i=0;10>i;i++){for(item in _this.dictPipelines)element=_this.dictPipelines[item],element.layer==i&&element.paint(_this.ctx);for(item in _this.dictEquipments)element=_this.dictEquipments[item],element.layer==i&&element.paint(_this.ctx);for(item in _this.dictButtons)element=_this.dictButtons[item],element.layer==i&&element.paint(_this.ctx);for(item in _this.dictTempDistributions)element=_this.dictTempDistributions[item],element.layer==i&&element.paint(_this.ctx)}for(item in _this.dictCharts)_this.dictCharts[item].paint(_this.ctx);for(item in _this.dictGages)_this.dictGages[item].paint(_this.ctx);for(item in _this.dictRulers)_this.dictRulers[item].paint(_this.ctx);for(item in _this.dictTexts)element=_this.dictTexts[item],element.paint(_this.ctx);for(item in _this.dictCheckboxs)_this.dictCheckboxs[item].paint(_this.ctx);requestAnimationFrame(animate)}}var _this=this;this.stopWatch=new Stopwatch,this.stopWatch.start(),requestAnimationFrame(animate)},initHitModel:function(){var _this=this,canvasId=this.isDetailPage?"#canvasDetail":"#canvasOverview";_this.canvas.scrollWidth>0&&(_this.hitModel.scaleX=_this.store.page.width/_this.canvas.scrollWidth,_this.hitModel.scaleY=_this.store.page.height/_this.canvas.scrollHeight),$(canvasId).off("click").click(function(e){if(_this.hitModel){var result=_this.hitModel.firstHitId(e.clientX,e.clientY,null);if(result&&result.id&&""!=result.id){var item=_getHitModelItem(result.type,result.id);item&&item.mouseDown&&item.mouseDown(e),item instanceof ModelRuler.ModelRulerCurrentReference?console.log("click ModelRulerCurrentReference"):item instanceof ModelText?console.log("click ModelText"):item&&item.link?_this.showDetailDialog(item.link,item.name):new OperatingPane(item.idCom,item.setValue,item.description,_this).show()}e.preventDefault()}});var _getHitModelItem=function(type,id){var item;switch(Number(type)){case _this.enmuElementType.equipment:item=_this.dictEquipments[id];break;case _this.enmuElementType.button:item=_this.dictButtons[id];break;case _this.enmuElementType.ruler:var index_array=id.split("_");if(!index_array||2!=index_array.length){item=null;break}var rulerId=index_array[0],refIndex=index_array[1];item=_this.dictRulers[rulerId].references[refIndex];break;case _this.enmuElementType.text:item=_this.dictTexts[id];break;default:item=null}return item};$(canvasId).mousemove(function(e){if(_this.hitModel){var result=_this.hitModel.firstHitId(e.clientX,e.clientY,null);if(result&&result.id&&""!=result.id){_this.canvas.style.cursor="pointer",_this.hitModel.currentModel=result;var item=_getHitModelItem(result.type,result.id);item&&item.mouseEnter&&item.mouseEnter(e)}else if(_this.canvas.style.cursor="auto",_this.hitModel.currentModel&&_this.hitModel.currentModel.id){var item=_getHitModelItem(_this.hitModel.currentModel.type,_this.hitModel.currentModel.id);item&&item.mouseOut&&item.mouseOut(),_this.hitModel.currentModel=null}e.preventDefault()}})},renderData:function(data){this.refreshData({data:data})},refreshData:function(e){var _this=this.self?this.self:this;if(e.data.error)new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[e.data.error]).showAtTop(5e3);else{for(var i=0;i<e.data.length;i++){var item=_this.dictRefreshMap[e.data[i].name];

if(item){if(item.pipelines)for(var j=0;j<item.pipelines.length;j++){var pipline=_this.dictPipelines[item.pipelines[j]];pipline.dictIdCom[e.data[i].name]=1==e.data[i].value?!0:!1}if(item.equipments)for(var j=0;j<item.equipments.length;j++){var equipment=_this.dictEquipments[item.equipments[j]];equipment.value=e.data[i].value,equipment.update(null,null)}if(item.texts)for(var j=0;j<item.texts.length;j++)_this.dictTexts[item.texts[j]].update(e.data[i].value);if(item.charts)for(var j=0;j<item.charts.length;j++)_this.dictCharts[item.charts[j]].update(e.data[i].name,e.data[i].value);if(item.gages)for(var j=0;j<item.gages.length;j++)_this.dictGages[item.gages[j]].update(e.data[i].value);if(item.tempDistributions)for(var j=0;j<item.tempDistributions.length;j++)_this.dictTempDistributions[item.tempDistributions[j]].update(e.data[i].name,e.data[i].value);if(item.rulers)for(var j=0;j<item.rulers.length;j++)_this.dictRulers[item.rulers[j]].update(e.data[i].name,e.data[i].value)}}for(var pointName in _this.dictCharts){var chart=_this.dictCharts[pointName];chart.isRunning||(chart.isRunning=!0,chart.renderChart(chart))}}_this.isDataReady=!0},initCanvasCache:function(){this.cacheCanvas=document.createElement("canvas"),this.cacheCtx=this.cacheCanvas.getContext("2d"),this.cacheCanvas.width=this.canvas.width,this.cacheCanvas.height=this.canvas.height;for(var item,element,i=0;10>i;i++){for(item in this.dictEquipments)element=this.dictEquipments[item],element.idCom&&""!=element.idCom||element.layer!=i||element.paint(this.cacheCtx);for(item in this.dictButtons)element=this.dictButtons[item],element.idCom&&""!=element.idCom||element.layer!=i||element.paint(this.cacheCtx)}for(item in this.dictTexts)element=this.dictTexts[item],element.idCom&&""!=element.idCom||element.paint(this.cacheCtx)},initImageDictionary:function(){if(this.store.images)for(var item,i=0;i<this.store.images.length;i++)item=this.store.images[i],this.addImageIntoRequestQueue(item);if(this.store.animationImages)for(var item,i=0;i<this.store.animationImages.length;i++)item=this.store.animationImages[i],this.addImageIntoRequestQueue("animation_"+item);var _this=this,interval=setInterval(function(e){var isCompleted=!0;for(var key in _this.dictImages)if(!_this.dictImages[key].complete){isCompleted=!1;break}isCompleted&&_this.isDataReady&&(clearInterval(interval),Spinner.stop())},300)},initPipelines:function(){if(this.dictPipelines={},this.store.pipelines)for(var item,tempLine,i=0;i<this.store.pipelines.length;i++){if(item=this.store.pipelines[i],tempLine=new ModelPipeline(item.id,null,null),tempLine.x=parseInt(item.startX),tempLine.y=parseInt(item.startY),tempLine.startX=parseInt(item.startX),tempLine.startY=parseInt(item.startY),tempLine.endX=parseInt(item.endX),tempLine.endY=parseInt(item.endY),tempLine.lineWidth=parseInt(item.width),tempLine.direction="1"==item.direction?!1:!0,tempLine.speed=1,tempLine.layer=item.layer,tempLine.waterType=item.waterType,tempLine.color=item.color,item.idCom&&""!=item.idCom.toString()){tempLine.idCom=item.idCom;for(var arr=item.idCom.split(","),j=0;j<arr.length;j++)arr[j]&&""!=arr[j].toString()&&(tempLine.dictIdCom[arr[j]]=!1,this.addElementIdIntoDictRefreshMap(arr[j],this.enmuElementType.pipeline,item.id))}this.dictPipelines[item.id]=tempLine}},initEquipments:function(){if(this.dictEquipments={},this.store.equipments)for(var item,tempEquip,i=0;i<this.store.equipments.length;i++)item=this.store.equipments[i],tempEquip=new ModelEquipment(item.id,null,null),tempEquip.x=item.x,tempEquip.y=item.y,tempEquip.width=item.width,tempEquip.height=item.height,tempEquip.animation=item.animation,tempEquip.idCom=item.idCom,tempEquip.layer=item.layer,item.isFromAnimation?tempEquip.image=this.dictImages[tempEquip.animation[0].animationId]:tempEquip.image=this.dictImages[item.idPicture],"0.0"!=item.rotate&&(tempEquip.rotate=item.rotate),item.idCom&&""!=item.id&&this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.equipment,item.id),item.link&&item.link>-1&&(tempEquip.link=item.link,this.hitModel.add(item.id,this.enmuElementType.equipment,item.x,item.y,item.width,item.height)),this.dictEquipments[item.id]=tempEquip},initCharts:function(){function ChartFactory(elementType){var chart;switch(Number(elementType)){case 52:chart=LineChart;break;case 53:chart=BarChart;break;case 54:chart=PieChart;break;default:chart=LineChart}return chart}if(this.dictCharts={},this.store.charts)for(var item,tempChart,i=0;i<this.store.charts.length;i++){item=this.store.charts[i];var ElementChart=ChartFactory(item.elementType);tempChart=new ElementChart(item.id,null,null),tempChart.x=item.x,tempChart.y=item.y,tempChart.width=item.width,tempChart.height=item.height,tempChart.units=item.data,item.interval&&""!=item.interval&&(tempChart.interval=item.interval),tempChart.init();for(var j=0;j<item.data.length;j++)this.addElementIdIntoDictRefreshMap(item.data[j].pointName,this.enmuElementType.chart,item.id);this.dictCharts[item.id]=tempChart}},initGages:function(){if(this.dictGages={},this.store.gages)for(var item,tempGage,i=0;i<this.store.gages.length;i++)item=this.store.gages[i],tempGage=new ModelGage(item.id,null,null),tempGage.width=item.width,tempGage.height=item.height,tempGage.idCom=item.idCom,tempGage.minValue=item.min,tempGage.maxValue=item.max,"floating"===item.pagetype&&item.xposition&&item.yposition?(tempGage.x=item.x-item.xposition,tempGage.y=item.y-item.yposition):(tempGage.x=item.x,tempGage.y=item.y),this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.gage,item.id),this.dictGages[item.id]=tempGage},initRulers:function(){if(this.dictRulers={},this.store.rulers)for(var item,tempRuler,i=0;i<this.store.rulers.length;i++){item=this.store.rulers[i],tempRuler=new ModelRuler(item.id,null,null),tempRuler.x=item.x,tempRuler.y=item.y,tempRuler.width=item.width,tempRuler.height=item.height,tempRuler.minValue=item.min,tempRuler.maxValue=item.max,tempRuler.name=item.name,tempRuler.decimal=item.decimal,tempRuler.mainScale=item.mainScale,tempRuler.minorScale=item.minorScale;for(var j=0;j<item.levels.length;j++)tempRuler.levels.push(item.levels[j]);for(var j=0;j<item.references.length;j++)""!=item.references[j].idCom&&this.addElementIdIntoDictRefreshMap(item.references[j].idCom,this.enmuElementType.ruler,item.id),tempRuler.references.push(item.references[j]);tempRuler.init(),this.dictRulers[item.id]=tempRuler;for(var n=0,len=tempRuler.references.length;len>n;n++){var ref=tempRuler.references[n];1!==Number(ref.isInUp)&&ref.panel&&this.hitModel.add(item.id+"_"+n,this.enmuElementType.ruler,ref.panel.x,ref.panel.y,ref.panel.w,ref.panel.h)}}},initButtons:function(){if(this.dictButtons={},this.store.buttons)for(var item,tempButton,i=0;i<this.store.buttons.length;i++)item=this.store.buttons[i],tempButton=new ModelButton(item.id,null,null),tempButton.x=item.x,tempButton.y=item.y,tempButton.width=item.width,tempButton.height=item.height,tempButton.image=this.dictImages[item.comm],tempButton.imageComm=this.dictImages[item.comm],tempButton.imageOver=this.dictImages[item.over],tempButton.imageDown=this.dictImages[item.down],tempButton.imageDisable=this.dictImages[item.disable],tempButton.idCom=item.idCom,tempButton.setValue=item.setValue,tempButton.description=item.description,tempButton.layer=item.layer,tempButton.fontSize=item.fontSize,tempButton.fontColor=item.fontColor,item.text&&""!=item.text&&(tempButton.text=item.text),item.link&&item.link>-1&&(tempButton.link=item.link),this.hitModel.add(item.id,this.enmuElementType.button,item.x,item.y,item.width,item.height),this.dictButtons[item.id]=tempButton},initCheckboxs:function(){if(this.dictCheckboxs={},this.store.checkboxs)for(var item,tempCheckbox,i=0;i<this.store.checkboxs.length;i++)item=this.store.checkboxs[i],tempCheckbox=new ModelButton(item.id,null,null),tempCheckbox.x=item.x,tempCheckbox.y=item.y,tempCheckbox.width=item.width,tempCheckbox.height=item.height,tempCheckbox.layer=item.layer,tempCheckbox.idCom=item.idCom,tempCheckbox.type=item.type,tempCheckbox.fontColor=item.fontColor,tempCheckbox.fontSize=item.fontSize,tempCheckbox.setValue=item.setValue,tempCheckbox.unsetValue=item.unsetValue,tempCheckbox.text=item.text,tempCheckbox.idGroup=item.idGroup,tempCheckbox.expression=item.expression,this.dictCheckboxs[item.id]=tempCheckbox},initTempDistribution:function(){if(this.dictTempDistributions={},this.store.tempDistributions&&this.store.tempDistributions.data&&this.store.tempDistributions.data.length){var item,tempDistribution;item=this.store.tempDistributions,tempDistribution=new ModelTempDistribution(item.pageid,null,null),tempDistribution.layer=item.layer,tempDistribution.data=item.data,tempDistribution.width=item.width,tempDistribution.height=item.height,tempDistribution.x=item.x,tempDistribution.y=item.y,tempDistribution.init(),this.dictTempDistributions[item.pageid]=tempDistribution;for(var n=0,len=item.data.length;len>n;n++){var point=item.data[n];this.addElementIdIntoDictRefreshMap(point.idCom,this.enmuElementType.temperature,item.pageid)}}},initTexts:function(){this.dictTexts={};String.prototype.concat;if(this.store.texts)for(var item,tempText,i=0;i<this.store.texts.length;i++){if(item=this.store.texts[i],tempText=new ModelText(item.id,null,null),tempText.x=item.x,tempText.y=item.y,tempText.width=item.width,tempText.height=item.height,tempText.value=item.text,tempText.fontSize=item.fontSize,tempText.decimalplace=item.decimalplace,tempText.font=item.font,tempText.showMode=item.showMode,tempText.readWrite=item.rw,0==item.showMode&&item.bindString&&""!=item.bindString)for(var strs,arr=item.bindString.split("|"),j=0;j<arr.length;j++)strs=arr[j].split(":"),tempText.dictBindString[strs[0]]=strs[1];item.color&&(tempText.color="rgb("+item.color.b+","+item.color.g+","+item.color.r+")"),item.idCom&&""!=item.id&&(tempText.idCom=item.idCom,tempText.value="--",this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.text,item.id)),null!==item.rw&&this.hitModel.add(item.id,this.enmuElementType.text,item.x,item.y-item.height/2,item.width,item.height),this.dictTexts[item.id]=tempText}},addElementIdIntoDictRefreshMap:function(idCom,enmuElementType,elementId){switch(this.dictRefreshMap[idCom]||(this.dictRefreshMap[idCom]={pipelines:[],equipments:[],buttons:[],texts:[],charts:[],gages:[],rulers:[],tempDistributions:[]}),enmuElementType){case this.enmuElementType.pipeline:this.dictRefreshMap[idCom].pipelines.push(elementId);break;case this.enmuElementType.equipment:this.dictRefreshMap[idCom].equipments.push(elementId);break;case this.enmuElementType.chart:this.dictRefreshMap[idCom].charts.push(elementId);break;case this.enmuElementType.button:this.dictRefreshMap[idCom].buttons.push(elementId);break;case this.enmuElementType.text:this.dictRefreshMap[idCom].texts.push(elementId);break;case this.enmuElementType.gage:this.dictRefreshMap[idCom].gages.push(elementId);break;case this.enmuElementType.temperature:this.dictRefreshMap[idCom].tempDistributions.push(elementId);break;case this.enmuElementType.ruler:this.dictRefreshMap[idCom].rulers.push(elementId)}},addImageIntoRequestQueue:function(id){if(this.dictImages[id])return this.dictImages[id];var img=new Image;img.src=(new StringBuilder).append("/static/images/plant/").append(AppConfig.projectName).append("/").append(id).append(".png").toString();var _this=this;return img.addEventListener("load",function(e){_this.indexImageLoaded++}),this.dictImages[id]=img,img},showDetailDialog:function(pageid,dialogTitle){ScreenModal&&ScreenModal.close(),ScreenModal=new ObserverScreen(pageid),dialogTitle&&(ScreenModal.dialogTitle=dialogTitle),this.isPlayback&&(ScreenModal.isPlayback=!0),ScreenModal.isDetailPage=!0,ScreenModal.show()},enmuElementType:{pipeline:0,equipment:1,button:2,text:3,chart:4,gage:5,ruler:6,temperature:7}},ObserverScreen}(),AnalysisScreen=function(){function AnalysisScreen(){this.store=void 0,this.factoryIoC=void 0,this.container=void 0,this.arrColor=echarts.config.color,this.paneDatasource=void 0,this.paneWorkspace=void 0,this.paneCenter=void 0,this.chartImageBin=void 0,this.saveModalJudge=void 0,this.modalConfig=void 0,this.targetSlide=void 0,this.curModal={startTime:void 0,endTime:void 0,format:void 0,mode:void 0,itemDS:[]},this.spinnerSave=void 0}return AnalysisScreen.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get("/static/views/observer/analysisScreen.html").done(function(resultHtml){Spinner.stop(),$(ElScreenContainer).html(resultHtml),_this.init();new SidebarMenuEffect("#paneContent","#leftCt","#rightCt");document.querySelector("#leftCt").click(),document.querySelector("#rightCt").click()})},close:function(){this.store=null,this.factoryIoC=null,this.container=null,this.curModal=null,this.modalConfig&&this.modalConfig.close&&this.modalConfig.close(),AppConfig.datasource=null,this.paneDatasource&&this.paneDatasource.close&&this.paneDatasource.close(),this.paneWorkspace&&this.paneWorkspace.close&&this.paneWorkspace.close(),this.paneCenter&&this.paneCenter.close&&this.paneCenter.close()},init:function(){this.spinnerSave=new LoadingSpinner({color:"#00FFFF"});var _this=this;Spinner.spin(ElScreenContainer);var localStorageFlag;localStorageFlag=localStorage.getItem("workSpacePicStorageEnable")?0:1,WebAPI.get("/analysis/getAll/"+AppConfig.userId+"/"+localStorageFlag).done(function(result){_this.store=JSON.parse(result),localStorage.setItem("workSpacePicStorageEnable",!0),_this.container=document.getElementById("anlsPane"),_this.initIoc(),_this.paneDatasource=new DataSource(_this),AppConfig.datasource=_this.paneDatasource,_this.paneWorkspace=new AnlsWorkspace(_this),_this.paneDatasource.show(),_this.paneWorkspace.show(),_this.refreshPaneCenter(new AnalysisTemplate(_this)),_this.modalConfig=new modalConfigurePane(document.getElementById("modalConfigContainer"),_this,"dataAnalysis"),_this.modalConfig.show(),I18n.fillArea($(ElScreenContainer)),Spinner.stop()})},refreshPaneCenter:function(entity){this.paneCenter&&this.paneCenter.close&&this.paneCenter.close(),this.paneCenter=entity,this.paneCenter.show()},hideAnlsPane:function(){$("#anlsPaneContain").hide(),$("#anlsWSPaneContain").hide()},showAnlsPane:function(){$("#anlsPaneContain").show(),$("#anlsWSPaneContain").show()},initIoc:function(){this.factoryIoC=new FactoryIoC("analysis")},renderModal:function(){var option=this.curModal;this.targetSlide=$("#divWSPane .selected");var modalClass=this.factoryIoC.getModel(option.type);this.refreshPaneCenter(modalClass?new modalClass(this.container,null,this):new AnalysisTemplate(this)),$("#anlsPaneContain .panel-heading").get(0).childNodes[0].textContent=$("#divWSPane .selected").find(".modalNameSp").text(),this.saveModal()},renderModalById:function(modalId){for(var workspace,i=0;i<this.store.workspaces.length;i++){workspace=this.store.workspaces[i];for(var j=0;j<workspace.modalList.length;j++)if(workspace.modalList[j].id==modalId){this.curModal=workspace.modalList[j].option,this.renderModal();var _this=this;return void this.saveModalJudge.rejectWith(_this,[_this])}}},saveModal:function(){this.saveModalJudge=$.Deferred(),$.when(this.saveModalJudge).done(function(_this,_chart){0==_this.targetSlide.length&&(_this.paneWorkspace.pageAdd(!0),_this.targetSlide=$(".divPage").last());var $selModalImg=_this.targetSlide,selectTemp=$(".selectTemp");if(void 0==_chart)_this.chartImageBin=$selModalImg[0].style.backgroundImage.replace("url(","").replace(")","");else{var imageSm=_chart.getImage("jpeg"),canvas=document.createElement("canvas");canvas.width=imageSm.width/2,canvas.height=imageSm.height/2,canvas.getContext("2d").drawImage(imageSm,0,0,imageSm.width/2,imageSm.height/2),canvas.getContext("2d").fillStyle="white",canvas.getContext("2d").fillRect(3*imageSm.width/8,0,imageSm.width/8,imageSm.height/60),_this.chartImageBin=canvas.toDataURL("image/jpeg"),$selModalImg.css({"background-image":"url("+_this.chartImageBin+")"})}var option=_this.curModal;for(var key in option)option[key]instanceof Date&&(option[key]=option[key].format("yyyy-MM-dd HH:mm:ss"));var data={workspaceId:$(".divPageCt").not(":hidden").attr("ws-id"),workspaceName:$("#ddlWorkspace").text(),modal:{name:$selModalImg.find(".modalNameSp").text(),type:_this.curModal.type?_this.curModal.type:"",note:"",imagebin:_this.chartImageBin,option:_this.curModal}};_this.spinnerSave.spin($selModalImg.get(0));var modalId=$(".divPage.selected").attr("id");modalId&&"divPageTemp"!=modalId&&(data.modal.id=modalId),WebAPI.post("/analysis/modal/save/"+AppConfig.userId,data).done(function(result){if(result&&null!=result){var result=JSON.parse(result);data=JSON.stringify(data),_this.curModal.id||(_this.paneWorkspace.replaceNewModal(result.workspaceId,result.modalId,data),localStorage.setItem("img_"+result.modalId,_this.chartImageBin))}selectTemp.length>0&&($selModalImg.removeClass("selected"),selectTemp.removeClass("selectTemp").addClass("selected")),_this.chartImageBin=void 0,_this.spinnerSave.stop()})}).fail(function(_this){var selModalImg=$("#divWSPane .selected"),selectTemp=$(".selectTemp");setTimeout(function(){selectTemp.length>0&&(selModalImg.removeClass("selected"),selectTemp.removeClass("selectTemp").addClass("selected"))},1e3)})},updateDataSources:function(updateData){this.store.group=updateData},alertNoData:function(){var _this=this,$dataAlert=$("#dataAlert");new Alert($dataAlert,"danger","<strong>"+I18n.resource.analysis.paneConfig.ERR11+"</strong>").show().close(),setTimeout(function(){_this.refreshPaneCenter(new AnalysisTemplate(_this)),$(".selected").removeClass("selected")},2e3)}},AnalysisScreen}(),AnalysisTemplate=function(){function AnalysisTemplate(screen){this.screen=screen}return AnalysisTemplate.prototype={show:function(){this.initAnlysTemplate(),this.initDrag()},initAnlysTemplate:function(){$("#anlsPaneContain .panel-heading").get(0).childNodes[0].textContent=I18n.resource.analysis.TITLE;var paneAnalysis=document.getElementById("anlsPane"),imgOnloadNum=0,_this=this;paneAnalysis.innerHTML="";var list,option,strAnlysPara,strTemplateImg,strAnlysTemplate,strTemplateImgColor,template;list=this.screen.factoryIoC.getList(),Spinner.spin(ElScreenContainer);for(var ele=0;ele<list.length;ele++){template=list[ele],option=template.prototype.optionTemplate,strAnlysPara="",option=this.screen.factoryIoC.getModel(template.name).prototype.optionTemplate,strTemplateImg="/static/images/analysis/templateImg/"+(option.imgName?option.imgName:"anlsDefault.png"),strTemplateImgColor=option.imgColor?option.imgColor:"65,131,189";for(var i=0;i<option.templateParams.paraName.length;i++)strAnlysPara+='<p dataType="'+option.templateParams.paraName[i]+'">'+option.templateParams.paraName[i]+"</p>";var numOfPara=option.templateParams.paraName.length>5?"long":option.templateParams.paraName.length;strAnlysTemplate='<div class="anlsTemplate" anlysParaMode="'+option.templateParams.paraAnlysMode+'" templateType="'+template.name+'" style="background-color:rgba('+strTemplateImgColor+',0.1)">\r\n                                    <img src="'+strTemplateImg+'" style="background-color:rgba('+strTemplateImgColor+',1)">\r\n                                            <h3>'+I18n.findContent(option.templateName)+"</h3>\r\n                                        <p>"+I18n.resource.analysis.paneConfig.DATA_DRAG_TIP+'</p>\r\n                                        <div class = "templatePara numOfPara-'+numOfPara+'">'+strAnlysPara+"</div>\r\n                                    </div>",paneAnalysis.innerHTML+=strAnlysTemplate}$(".anlsTemplate img").on("load",function(){imgOnloadNum+=1,imgOnloadNum==list.length&&Spinner.stop()});$("#anlsConfigModal");$(".anlsTemplate").on("click",function(e){var option={},optionTemplate=_this.screen.factoryIoC.getModel($(e.currentTarget).attr("templateType")).prototype.optionTemplate;option.modeUsable=optionTemplate.chartConfig,option.dataTypeMaxNum=[],option.dataTypeMaxNum=optionTemplate.templateParams.dataTypeMaxNum,option.rowDataType=[],option.templateType=$(e.currentTarget).attr("templateType");for(var i=0;i<e.currentTarget.children[3].children.length;++i)option.rowDataType.push(e.currentTarget.children[3].children[i].getAttribute("dataType"));option.optionPara={},option.optionPara.dataItem={};var allDataNeed=$(e.currentTarget).attr("anlysParaMode");allDataNeed="all"==allDataNeed?!0:!1,option.allDataNeed=allDataNeed,_this.screen.modalConfig.showModalInit(!0,option)})},initDrag:function(){{var targetId,_this=this,templateParaPane=$(".templatePara"),$tempPara=templateParaPane.children();$("#anlsConfigModal"),$("#startAnlys")}$tempPara.on("dragenter",function(e){e.preventDefault(),e.stopPropagation()}),$tempPara.on("dragleave",function(e){e.preventDefault(),$(e.target).removeClass("paraSel"),$(e.target).closest(".anlsTemplate").removeClass("templateSel")}),$tempPara.on("dragover",function(e){e.preventDefault(),$(e.target).addClass("paraSel"),$(e.target).closest(".anlsTemplate").addClass("templateSel")}),$tempPara.on("drop",function(e){e.preventDefault(),e.stopPropagation();var option={},optionTemplate=_this.screen.factoryIoC.getModel($(e.currentTarget).closest(".anlsTemplate").attr("templateType")).prototype.optionTemplate;option.modeUsable=optionTemplate.chartConfig,option.templateType=$(e.currentTarget).closest(".anlsTemplate").attr("templateType"),option.dataTypeMaxNum=[],option.dataTypeMaxNum=optionTemplate.templateParams.dataTypeMaxNum,option.rowDataType=[];for(var i=0;i<$(e.currentTarget).parent().children().length;++i)option.rowDataType.push($(e.currentTarget).parent().children().get(i).getAttribute("dataType"));option.optionPara={},targetId=e.originalEvent.dataTransfer.getData("dsItemId"),option.optionPara.dataItem=[{dsId:[targetId],dsName:[AppConfig.datasource.getDSItemById(targetId).alias],dsType:e.currentTarget.getAttribute("dataType")}];var allDataNeed=$(e.currentTarget).closest(".anlsTemplate").attr("anlysParaMode");allDataNeed="all"==allDataNeed?!0:!1,option.allDataNeed=allDataNeed,_this.screen.modalConfig.showModalInit(!0,option)}),$("#dataSrcPanel").on("dragend",function(e){e.preventDefault(),$(".templateSel").removeClass("templateSel"),$(".paraSel").removeClass("paraSel"),$(".paraRowSel").removeClass("paraRowSel"),$(".templatePara").css("display","none")})},close:function(){}},AnalysisTemplate}(),EnergyScreen=function(){function EnergyScreen(id,store){id?this.id=id:this.id=ScreenCurrent.id,this.factoryIoC=void 0,this.factoryIoCAnalysis=void 0,this.listEntity=void 0,this.mapRefresh={},this.arrEntityOrder=void 0,this.requestPoints=[],this.configParams=void 0,this.store=store?store:void 0,this.container=void 0,this.isForReport=store?!0:!1,this.modalConfigPane=void 0,this.isConfigMode=!1,this.workerUpdate=void 0,this.paneDatasource=void 0,this.arrColor=echarts.config.color,this.spinnerRender=new LoadingSpinner({color:"#00FFFF"})}return EnergyScreen.prototype={show:function(){var _this=this;ElScreenContainer.innerHTML="",$.get("/static/views/observer/energyScreen.html").done(function(resultHtml){var divMain=document.createElement("div");divMain.className="indexContent st-pusher",divMain.innerHTML=resultHtml;var stCt=$('<div id="st-container" class="st-container">')[0];stCt.appendChild(divMain),ElScreenContainer.appendChild(stCt),_this.container=document.getElementById("paneCenter"),_this.modalConfigPane=new modalConfigurePane(document.getElementById("energyModal"),_this,"dashboard"),_this.modalConfigPane.show(),_this.init()})},close:function(){for(var key in this.listEntity)this.listEntity[key].chart&&this.listEntity[key].chart.clear();this.workerUpdate&&this.workerUpdate.terminate(),this.workerUpdate=null,this.factoryIoC=null,this.factoryIoCAnalysis=null,this.listEntity=null,this.arrEntityOrder=null,this.store=null,this.container=null,this.UNIT_WIDTH=null,this.UNIT_HEIGHT=null,AppConfig.datasource=null,$("#ulTools").html(""),this.paneDatasource&&this.paneDatasource.close&&this.paneDatasource.close()},stop:function(){this.workerUpdate&&this.workerUpdate.terminate()},init:function(){function initByData(){WebAPI.get("/datasource/get/"+AppConfig.userId).done(function(result){_this.store.group=JSON.parse(result).group,_this.paneDatasource=new DataSource(_this),AppConfig.datasource=_this.paneDatasource,_this.initIoc(),_this.initLayout(),_this.initToolBar(),_this.initWorkerForUpdating()}).always(function(e){Spinner.stop()})}var _this=this;Spinner.spin(ElScreenContainer),this.store?(initByData(),Spinner.stop()):WebAPI.get("/spring/get/"+this.id).done(function(result){_this.store=JSON.parse(result),initByData()}).error(function(e){Spinner.stop()}),$("#btnModalAdd").off("click").click(function(e){var entity=new ModalNone(_this,{id:+new Date,spanC:6,spanR:2,modal:{}});_this.arrEntityOrder.push(entity.entity.id),_this.listEntity[entity.entity.id]=entity,entity.render(),entity.configure()})},initToolBar:function(){var _this=this;if(!AppConfig.isMobile){if(this.isForReport)var btnMode=$("<span>").addClass("badge grow").text("sure").css("cursor","pointer").css("background-color","#5bc0de").click(function(e){_this.saveLayout()});else var btnMode=$("<span>").addClass("badge grow").text(I18n.resource.observer.widgets.CONFIG_MODE).css("cursor","pointer").css("background-color","#5bc0de").click(function(e){_this.isConfigMode?(_this.isConfigMode=!1,e.currentTarget.classList.remove("toolbar-btn-selected"),_this.saveLayout()):(_this.isConfigMode=!0,e.currentTarget.classList.add("toolbar-btn-selected"),_this.showConfigMode(),$(".sideTrans").fadeIn(),document.querySelector("#leftCt").click(),$($(".nav-header")[0]).click(),$(this).text(I18n.resource.observer.widgets.CONFIG_SAVE))});var ulTools=$("#ulTools");ulTools.html(""),btnMode.appendTo($("<li><a>")).appendTo(ulTools)}},initIoc:function(){this.factoryIoC=new FactoryIoC("dashboard"),this.factoryIoCAnalysis=new FactoryIoC("analysis")},initLayout:function(){this.listEntity={},this.arrEntityOrder=[];new SidebarMenuEffect("#paneContent","#leftCt","#rightCt");if(I18n.fillArea($("#toolBox")),this.store&&this.store.layout)for(var item,i=0;i<this.store.layout.length;i++)for(var j=0;j<this.store.layout[i].length;j++)if(item=this.store.layout[i][j],item.modal.type){var modelClass=this.factoryIoC.getModel(item.modal.type),entity=new modelClass(this,item);if(this.listEntity[item.id]=entity,this.arrEntityOrder.push(item.id),item.modal.interval&&item.modal.interval>=0)for(var point,k=0,kLen=item.modal.points.length;kLen>k;k++)point=item.modal.points[k],this.requestPoints.indexOf(point)<0&&this.requestPoints.push(point);entity.render(),this.isForReport&&entity.configure()}},initWorkerForUpdating:function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js"),this.workerUpdate.self=this,this.workerUpdate.addEventListener("message",this.refreshData,!0),this.workerUpdate.addEventListener("error",function(e){console.log(e)},!0),this.workerUpdate.postMessage({pointList:this.requestPoints,type:"datasourceRealtime"})},refreshData:function(e){var _this=this.self?this.self:this;if(e.data.error)new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[e.data.error]).showAtTop(5e3);else{for(var point,i=0,iLen=e.data.length;iLen>i;i++)point=e.data[i],_this.mapRefresh[point.dsItemId]=point;var entity,arrUpdataData;for(var key in _this.listEntity){entity=_this.listEntity[key],arrUpdataData=[];for(var i=0,iLen=e.data.length;iLen>i;i++){var point=entity.entity.modal.points[i];point&&arrUpdataData.push(_this.mapRefresh[point])}entity.update(arrUpdataData)}}},saveLayout:function(){for(var _this=this,arrEntity=[],i=0;i<this.arrEntityOrder.length;i++)this.listEntity[this.arrEntityOrder[i]].entity.modal.points&&0!=this.listEntity[this.arrEntityOrder[i]].entity.modal.points.length&&arrEntity.push(this.listEntity[this.arrEntityOrder[i]].entity);var data={creatorId:AppConfig.userId,menuItemId:this.id,layout:[arrEntity]};this.store.id&&(data.id=this.store.id),Spinner.spin(ElScreenContainer),WebAPI.post("/spring/saveLayout",data).done(function(result){if(_this.isForReport){window.open("/share/db/"+AppConfig.userId+"/"+_this.id);var retCon=confirm("Your analysis result has been shared at the new brower tab.");!0===retCon&&ScreenManager.show(AnalysisScreen)}else ScreenManager.show(EnergyScreen)}).always(function(result){Spinner.stop()})},setEntity:function(entity){},replaceEntity:function(sourceId,targetId){var source=($("#divContainer_"+sourceId),$("#divContainer_"+targetId),this.listEntity[sourceId]),target=this.listEntity[targetId];source.entity.id=+new Date,target.entity.id=+new Date+1,this.listEntity[source.entity.id]=source,this.listEntity[target.entity.id]=target,delete this.listEntity[sourceId],delete this.listEntity[targetId],source.initContainer(targetId).configure(),target.initContainer(sourceId).configure(),this.arrEntityOrder[this.arrEntityOrder.indexOf(targetId)]=source.entity.id,this.arrEntityOrder[this.arrEntityOrder.indexOf(sourceId)]=target.entity.id},rebornEntity:function(entityParams,tragetType,targetTitle){this.removeEntity(entityParams.id),entityParams.modal.type=tragetType,entityParams.modal.title=targetTitle;var modelClass=this.factoryIoC.getModel(tragetType);entityParams.spanC=modelClass.prototype.optionTemplate.minWidth,entityParams.spanR=modelClass.prototype.optionTemplate.minHeight;var entity=new modelClass(this,entityParams);this.listEntity[entity.entity.id]=entity,this.arrEntityOrder.push(entity.entity.id),entity.configure()},removeEntity:function(id){this.listEntity[id]=null,delete this.listEntity[id],this.arrEntityOrder.splice(this.arrEntityOrder.indexOf(id),1)},render:function(data){for(var key in this.listEntity)this.listEntity[key].render()},showConfigMode:function(){this.stop();for(var key in this.listEntity)this.listEntity[key].configure();this.initToolBox(),this.initDataSourcePanel()},initToolBox:function(){function getModalList(group){var $ul=$('<ul class="nav nav-list accordion-group">'),$liList=$('<li class="rows" style="display: none;">').appendTo($ul);for(var i in group)if(0==i){var $liHd=$('<li class="nav-header">').append('<i class="icon-plus icon-white"></i>'+I18n.findContent(group[i].name)).click(function(){var $otherUl=$(this).parent("ul").siblings("ul");$otherUl.find(".rows").slideUp(),$otherUl.find("i").removeClass("icon-minus").addClass("icon-plus"),$(this).next(".rows").slideToggle();var $i=$(this).find("i"),toggleClass=function(){return $i.hasClass("icon-minus")?"icon-plus icon-white":"icon-minus icon-white"}();$(this).find("i").removeClass().addClass(toggleClass)});$ul.prepend($liHd)}else{var $div=$('<div class="lyrow ui-draggable" draggable="true"> ').html(I18n.findContent(group[i].name)).attr("type",group[i].type);$div[0].ondragstart=function(e){e.dataTransfer.setData("type",$(this).attr("type")),e.dataTransfer.setData("title",$(this).text())},$liList.append($div)}return $ul}var list,template,option,$toolBox=$($(".col-sm-2")[0].children[0]),$modals=$('<div id="modalCt" class="panel-body">').appendTo($toolBox),groupList=[];list=this.factoryIoC.getList();for(var ele=0;ele<list.length;ele++)template=list[ele],option=template.prototype.optionTemplate,option&&null!=option.parent&&(groupList[option.parent]||(groupList[option.parent]=new Array),groupList[option.parent].push(option));for(var i=0;i<groupList.length;i++)$modals.append(getModalList(groupList[i]))},initDataSourcePanel:function(){var _this=this;_this.paneDatasource.show()},hideAnlsPane:function(){$("#paneCenter").hide(),$("#energyModal").hide()},showAnlsPane:function(){$("#paneCenter").show(),$("#energyModal").show()},getDSItemById:function(datasourceItemId){for(var i=0,len=this.store.datasources[0].list.length;len>i;i++)if(this.store.datasources[0].list[i].id===datasourceItemId)return this.store.datasources[0].list[i];return null},updateDataSources:function(updateData){this.store.group=updateData}},EnergyScreen}(),ReportScreen=function(){function ReportScreen(reportType){this.$reportNavigation=null,this.$ElScreenContainer=$(ElScreenContainer),this.reportType=reportType}var getThisWeekReportNum=function(){var weekNum=DateUtil.getWeekNumber(new Date);return DateUtil.getLastWeekNumberOf(weekNum[0],weekNum[1]);

};return ReportScreen.prototype={displayWeek:getThisWeekReportNum(),baseChartOption:{title:{x:"center",textStyle:{fontSize:15}},tooltip:{trigger:"axis"},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!0},restore:{show:!0},saveAsImage:{show:!0}}},axis:{scale:!0}},chartYOffsetSetting:{grid:{y:100},legend:{y:40}},chartType:{pie:"pie",line:"line",scatter:"scatter",bar:"bar",area:"area",table:"table"},chartList:{},reportTypes:{"554b08407ddcf319bcd61b23":{folder:1,name:"能效分析"},"554b207f7ddcf319bcd61b26":{folder:2,name:"设备诊断"},"554b22467ddcf36310cf62a8":{folder:3,name:"控制诊断"},"554c904f7ddcf35c680b5843":{folder:4,name:"系统缺陷诊断"},"554c904f7ddcf35c680b5844":{folder:5,name:"运营评估"},"555db74894022d08983dc047":{folder:"default",name:"运营日报"},"555c45e17ddcf3353c3eb409":{folder:1,name:"能效分析"},"555c45e27ddcf3353c3eb40a":{folder:2,name:"设备诊断"},"555c45e27ddcf3353c3eb40b":{folder:3,name:"控制诊断"},"555c45e27ddcf3353c3eb40c":{folder:4,name:"系统缺陷诊断"},"555c45e27ddcf3353c3eb40d":{folder:5,name:"运营评估"},"555e8f5994022d06b05f3fdc":{folder:"default",name:"运营日报"}},show:function(){this.init()},close:function(){this.unregisterChartResize(),this.clearHash(),this.chartList={},$(window).off("resize"),this.unregisterPrintEvent()},init:function(){this.getReport(),this.chartList={},this.registerPrintEvent()},registerChartResize:function(){var _this=this;this.unregisterChartResize(),$(window).on("resize.beop.report.echarts",function(){for(var m in _this.chartList)_this.chartList[m].resize()})},unregisterChartResize:function(){$(window).off("resize.beop.report.echarts")},beforePrintReportScreen:function(){var image,$chart,chart=null;for(var m in this.chartList)chart=this.chartList[m],chart&&(image=this.chartList[m].getImage(),$(image).addClass("chartImage"),$chart=$(chart.dom),$chart.parent().append(image),$chart.hide())},afterPrintReportSceen:function(){var $chart,chart=null;for(var m in this.chartList)chart=this.chartList[m],chart&&($chart=$(chart.dom),$chart.show(),$chart.parent().children(".chartImage").remove(),chart.resize())},mediaPrintEvent:function(mql){mql.matches?this.beforePrintReportScreen():this.afterPrintReportSceen()},registerPrintEvent:function(){window.matchMedia&&window.matchMedia("print").addListener(this.mediaPrintEvent.bind(this)),$(window).on("beforeprint.beop.report.echarts",this.beforePrintReportScreen.bind(this)),$(window).on("afterprint.beop.report.echarts",this.afterPrintReportSceen.bind(this))},unregisterPrintEvent:function(){window.matchMedia&&window.matchMedia("print").removeListener(this.mediaPrintEvent.bind(this)),$(window).off("beforeprint.beop.report.echarts"),$(window).off("afterprint.beop.report.echarts")},registerMousewheelEvent:function(){var _this=this;$("#indexMain").on("mousewheel.beop.report",".step-container",function(event){var $target=$(this);return event.originalEvent.wheelDelta>0?0===$target.scrollTop()?(_this.preReportUnit(),event.stopPropagation(),!1):(event.stopPropagation(),!0):$target.scrollTop()+$target.innerHeight()+1>=$target[0].scrollHeight?(_this.nextReportUnit(),event.stopPropagation(),!1):(event.stopPropagation(),!0)}).on("mousewheel.beop.report",function(event){return event.originalEvent.wheelDelta>0?_this.preReportUnit():_this.nextReportUnit(),!1})},unregisterMousewheelEvent:function(){$("#indexMain").off("mousewheel.beop.report")},clearHash:function(){window.location.replace("#")},_getNextReportUnitItem:function(nextItemFunc){var currentIndex,nextIndex,nextReportUnit,nextListItemId,$reportUnitList=this.$ElScreenContainer.find(".report-unit");return $reportUnitList.each(function(index,item){$(item).hasClass("active")&&(currentIndex=index)}),nextIndex=nextItemFunc($reportUnitList.length-1,currentIndex),nextReportUnit=$reportUnitList.get(nextIndex),nextReportUnit?(nextListItemId=nextReportUnit.id,this.$reportNavigation.find('a[report-unit="'+nextListItemId+'"]').closest("li")):null},nextReportUnit:function(){var $nextItem=this._getNextReportUnitItem(function(total,current){return current===total?0:current+1});$nextItem&&$nextItem.trigger("click")},preReportUnit:function(){var $nextItem=this._getNextReportUnitItem(function(total,current){return 0===current?total:current-1});$nextItem&&$nextItem.trigger("click",!0)},getReportFolder:function(key){return key||(key=this.reportType),key&&this.reportTypes[key]?this.reportTypes[key].folder:"default"},getReport:function(year,month){var version,_this=this;Spinner.spin(ElScreenContainer);var reportType=this.getReportFolder();return version=month&&year?year+"-"+StringUtil.padLeft(month,2,"0"):(new Date).getFullYear()+"-"+StringUtil.padLeft(DateUtil.getLastMonth(),2,"0"),$.ajax({url:"/static/projectReports/reports/"+AppConfig.projectName+"/"+reportType+"/"+version+".html",cache:!1}).done(function(resultHtml){I18n.fillArea($(ElScreenContainer).html(resultHtml)),_this.renderCharts($("#beopReport .report-unit")),_this.$reportNavigation=$(".reportNavigation"),_this.initDatePicker(year,month),BEOPUtil.setRelativePosition($(".step-container"),_this.$reportNavigation,0,50),$(window).resize(function(){BEOPUtil.setRelativePosition($(".step-container"),_this.$reportNavigation,0,50)}),_this.$reportNavigation.affix({offset:{top:100}}),$(".step-container").scrollspy({target:".reportNavigation"})}).always(function(){Spinner.stop()}).fail(function(){$.get("/static/projectReports/emptyReport.html").done(function(resultHtml){I18n.fillArea($(ElScreenContainer).html(resultHtml)),_this.initDatePicker(year,month),BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50),$(window).resize(function(){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50)})})})},renderCharts:function($chartContainer){for(var charts=$chartContainer.find(".chart-param"),i=0;i<charts.length;i++)this.initCharts($(charts[i]))},initDatePicker:function(year,month){var dateDisplay,now=new Date,year=year?year:now.getFullYear(),month=DateUtil.getMonthName(month?month-1:DateUtil.getLastMonth()-1),$datePick=$(".form_datetime"),_this=this;$datePick.find("input").val(year+" "+month),$datePick.datetimepicker({format:"yyyy MM",minView:"year",startView:"year",todayBtn:!0,autoclose:!0,endDate:new Date}).on("changeDate",function(ev){try{var date=new Date(ev.date.valueOf());_this.getReport(date.getFullYear(),date.getMonth()+1)}catch(e){return!1}}).on("show",function(ev){dateDisplay=ev.date.getFullYear()+" "+DateUtil.getMonthName(ev.date.getMonth())})},initReportNavigation:function(){var _this=this;this.$reportNavigation.on("click","li.reportChapter",function(){var $reportUnit,reportUnitId,$sub_li,$this=$(this);return $this.hasClass("active")?!1:($this.closest(".reportNavigation").find("li.active").removeClass("active"),$this.addClass("active"),$sub_li=$this.find("li:first"),$sub_li.size()>0&&(reportUnitId=$sub_li.addClass("active").find("a").attr("report-unit")),$reportUnit=$("#"+reportUnitId),void _this.showReportUnit($reportUnit).done(function(){_this.renderCharts($reportUnit),_this.chartList[reportUnitId]&&_this.chartList[reportUnitId].resize()}))})},showReportUnit:function($reportUnit,isUp){$reportUnit.closest(".step-play-list").find(".report-unit.active").removeClass("active");var dfd=$.Deferred();return $(".step-container").animate({top:isUp?"-200px":"100px",opacity:"toggle"},"fast",function(){$reportUnit.addClass("active"),$(".step-container").css("top",isUp?"200px":"-100px").animate({top:"0px",opacity:"toggle"},function(){dfd.resolve()})}),dfd},generateChartId:function(){return(new Date).getTime()},initCharts:function($canvasChart){var chartOpts=this.getChartParam($canvasChart);if(chartOpts){var chartInstance,chartDom=$canvasChart.parent()[0],chartId=this.generateChartId();switch($(chartDom).attr("chart-id",chartId),chartOpts.type){case this.chartType.line:chartInstance=this.initChartLine(chartDom,chartOpts);break;case this.chartType.pie:chartInstance=this.initChartPie(chartDom,chartOpts);break;case this.chartType.bar:chartInstance=this.initChartBar(chartDom,chartOpts);break;case this.chartType.scatter:chartInstance=this.initChartScatter(chartDom,chartOpts);break;case this.chartType.area:chartInstance=this.initChartArea(chartDom,chartOpts);break;case this.chartType.table:chartInstance=this.initChartTable(chartDom,chartOpts);break;default:console.log("生成图像错误:没有类型"+chartOpts.type)}chartInstance&&(this.chartList[chartId]=chartInstance,this.registerChartResize())}},initChartLine:function(chartDom,chartParam){var option=$.extend(!0,{},this.baseChartOption,this.getChartOptsFromParam(chartParam,this.chartType.line),this.chartYOffsetSetting);return echarts.init(chartDom).setOption(option)},initChartPie:function(chartDom,chartParam){var option=$.extend(!0,{},this.getChartOptsFromParam(chartParam,this.chartType.pie),this.baseChartOption,{legend:{orient:"vertical",x:"left",y:40},tooltip:{trigger:"item",formatter:"{a} <br/> {b} : {c} ({d}%)"}});return echarts.init(chartDom).setOption(option)},getChartParam:function($chartParam){try{var unitString=$chartParam.text();return unitString?(unitString=unitString.replace(/'/g,'"'),JSON.parse(unitString)):null}catch(e){return console.error(e),null}},getChartSeriesData:function(type,x,yData,y){var result=[];switch(type){case this.chartType.bar:case this.chartType.line:case this.chartType.scatter:case this.chartType.area:result=yData;break;case this.chartType.pie:for(var i=0;i<y.length;i++)result.push({name:y[i].name,value:y[i].value});break;default:result=yData}return result},getChartOptsFromParam:function(chartParam,type){var yItem,seriesItem,result,y=chartParam.chartItems.y,x=chartParam.chartItems.x,series=[],legend=[],yAxis=[];if(type===this.chartType.pie)legend=x,seriesItem={},seriesItem.name=chartParam.title,seriesItem.data=this.getChartSeriesData(type,x,null,y),seriesItem.type=type,seriesItem.selectedMode="single",series.push(seriesItem);else{if(!$.isArray(y)){var temp=[];for(var key in y){var obj={name:key,value:y[key],yAxisIndex:0};temp.push(obj)}y=temp}for(var m=0,length=y.length;length>m;m++){yItem=y[m];var seriesItem={};seriesItem.yAxisIndex=Number(yItem.yAxisIndex)||0,seriesItem.name=yItem.name,seriesItem.data=this.getChartSeriesData(type,x,yItem.value,yItem),type===this.chartType.area?(seriesItem.type=this.chartType.line,seriesItem.stack=I18n.resource.observer.widgets.TOTAL_AMOUNT,seriesItem.itemStyle={normal:{areaStyle:{type:"default"}}}):yItem.type?seriesItem.type=yItem.type:seriesItem.type=type,series.push(seriesItem),legend.push(yItem.name)}if($.isArray(chartParam.Options.y))for(var i=0;i<chartParam.Options.y.length;i++)yAxis.push(type===this.chartType.line?{name:chartParam.Options.y[i],type:"value",scale:!0}:{name:chartParam.Options.y[i],type:"value",scale:!0});else yAxis.push({name:chartParam.Options.y,type:"value",scale:!0})}return result={title:{text:chartParam.title},noDataLoadingOption:{text:I18n.resource.observer.reportScreen.TITLE_NO_DATA,effect:"whirling"},legend:{data:this._sortLegend(legend)},series:series,xAxis:[{scale:!0,name:chartParam.Options.x}],yAxis:yAxis},x&&x.length>0?(result.xAxis[0].data=x,result.xAxis[0].type="category"):result.xAxis[0].type="value",type===this.chartType.pie&&(delete result.xAxis,delete result.yAxis),result},_sortLegend:function(legend){if(!legend)return[];legend.sort();for(var ret=[],i=0,j=legend.length;j>i;i++)ret.push(legend[i]),(i+1)%5===0&&ret.push("");return ret},initChartBar:function(chartDom,chartParam){var option=$.extend(!0,{},this.baseChartOption,this.getChartOptsFromParam(chartParam,this.chartType.bar),this.chartYOffsetSetting);return echarts.init(chartDom).setOption(option)},initChartScatter:function(chartDom,chartParam){var option=$.extend(!0,{},this.baseChartOption,this.getChartOptsFromParam(chartParam,this.chartType.scatter),this.chartYOffsetSetting);return echarts.init(chartDom).setOption(option)},initChartArea:function(chartDom,chartParam){var option=$.extend(!0,{},this.baseChartOption,this.getChartOptsFromParam(chartParam,this.chartType.area),this.chartYOffsetSetting);return echarts.init(chartDom).setOption(option)},initChartTable:function(chartDom,chartParam){chartParam&&chartParam.chartItems&&chartDom&&$(chartDom).replaceWith(beopTmpl("tmpl_table",chartParam.chartItems))}},ReportScreen}(),DiagnosisScreen=function(){function DiagnosisScreen(){this.dictZone=void 0,this.dictEquipment=void 0,this.dictFault=void 0,this.arrLastNotice=void 0,this.workerUpdate=void 0,this.floorCount=0,this.dialog=void 0}return DiagnosisScreen.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get("/static/views/observer/diagnosisScreen.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),I18n.fillArea($(ElScreenContainer)),Spinner.spin(ElScreenContainer),_this.init()})},close:function(){this.dictZone=null,this.dictEquipment=null,this.dictFault=null,this.arrLastNotice=null,this.floorCount=null,this.workerUpdate&&this.workerUpdate.terminate(),this.workerUpdate=null,this.dialog&&this.dialog.close()},init:function(){var _this=this;WebAPI.get("/diagnosis/getAll/"+AppConfig.projectId).done(function(result){_this.initData(JSON.parse(result)),_this.initPaneBuilding(),_this.initPaneNav(),_this.initWorkerForUpdating()}),$("#btnNoticeHistory").click(function(e){ScreenModal=new DiagnosisHistory(_this),ScreenModal.show()}),$("#btnNoticeConfig").click(function(e){ScreenModal=new DiagnosisConfig(_this),ScreenModal.show()})},initData:function(data){var item,arr;this.dictZone=new Object,this.dictEquipment=new Object,this.dictFault=new Object,this.buildings=[],arr=data.equipments;for(var i=0,len=arr.length;len>i;i++)item=arr[i],item.faultIds=new Array,this.dictEquipment[item.id]=item;arr=data.zones,this.floorCount=arr.length;for(var index=-1,tempBuildingId=void 0,i=0,len=arr.length;len>i;i++){item=arr[i],item.equipmentIds=new Array;for(var equipments=[],j=0;j<data.equipments.length;j++)data.equipments[j].zoneId==item.id&&(item.equipmentIds.push(data.equipments[j].id),equipments.push({equipmentId:data.equipments[j].id,equipmentName:data.equipments[j].name}));if(this.dictZone[item.id]=item,tempBuildingId!=item.buildingId){tempBuildingId=item.buildingId,index++;var building={buildId:item.buildingId,buildName:item.buildingName,subBuilds:[{subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}]};this.buildings.push(building)}else{var subBuilding={subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments};this.buildings[index].subBuilds.push(subBuilding)}}arr=data.faults;for(var elapse,i=0,len=arr.length;len>i;i++)item=arr[i],item.display=!0,item.grade=void 0,item.isUserDefined&&item.userFaultDelay&&(-1==item.userFaultDelay?item.display=!1:item.userFaultDelay>0&&(elapse=new Date-new Date(item.userModifyTime),0>elapse&&(item.display=!1))),item.isUserDefined?item.grade=item.userFaultGrade:item.grade=item.defaultGrade,this.dictFault[item.id]=item;this.arrLastNotice=data.notices},initWorkerForUpdating:function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js"),this.workerUpdate.self=this,this.workerUpdate.addEventListener("message",this.refreshData,!0),this.workerUpdate.addEventListener("error",function(e){console.log(e)},!0),this.workerUpdate.postMessage({projectId:AppConfig.projectId,type:"diagnosisScreen"})},refreshData:function(e){if(e.data.error)new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[e.data.error]).showAtTop(5e3);else{this.self.arrLastNotice=e.data;for(var key in this.self.dictEquipment)this.self.dictEquipment[key].faultIds=new Array;for(var i=0;i<e.data.length;i++){var faultId=e.data[i].faultId;this.self.dictEquipment[this.self.dictFault[faultId].equipmentId].faultIds.push(faultId)}this.self.renderPaneNotice(),Spinner.stop()}},initPaneBuilding:function(){var body=document.getElementById("divCanvas"),divMain=document.createElement("div");divMain.className="box",divMain.style.position="relative";var div,divContainer,divElement,span,item,unitTop=.5*body.scrollHeight/this.floorCount,top=.1*body.scrollHeight,unitDeg=60/this.floorCount,arrZone=new Array;for(var zoneId in this.dictZone)arrZone.push(this.dictZone[zoneId]);for(var i=0,len=arrZone.length;len>i;i++){index=this.floorCount-1-i,item=arrZone[i],div=document.createElement("div"),div.id="div-floor-"+item.id.toString(),div.className="floor",1==arrZone.length&&(div.className+=" hover"),div.style.top=unitTop*index+top+"px",div.style.transform="rotateX("+(120-unitDeg*index)+"deg) rotateZ(60deg)",div.style.backgroundImage="url('/static/images/diagnosis/"+AppConfig.projectName+"/"+item.image+"')",span=document.createElement("span"),span.className="span-floor-number",divContainer=document.createElement("div"),divContainer.className="floor-equipment-pane";for(var j=0;j<item.equipmentIds.length;j++){var equipmentId=item.equipmentIds[j],equipment=this.dictEquipment[equipmentId];divElement=document.createElement("div"),divElement.className="floor-equipment",divElement.id="div-floor-icon-"+item.id+"-"+equipmentId,divElement.textContent=equipment.name,divContainer.appendChild(divElement)}div.appendChild(divContainer),divMain.appendChild(div)}body.appendChild(divMain),arrZone=null},initPaneNav:function(){var spanFloor,spanIcon,div,item,_this=this,pane=document.createElement("div");for(var zoneId in this.dictZone)if(item=this.dictZone[zoneId],!item.equipmentIds||0!=item.equipmentIds.length){if(div=document.createElement("div"),div.id="div-icon-"+zoneId,div.className="div-nav-row",$(div).hover(function(e){id="div-floor-"+e.currentTarget.id.split("-")[2],document.getElementById(id).classList.add("hover")},function(e){id="div-floor-"+e.currentTarget.id.split("-")[2],document.getElementById(id).classList.remove("hover")}),spanFloor=document.createElement("span"),spanFloor.id="navFloor-"+zoneId,spanFloor.setAttribute("pageId",item.pageId),spanFloor.className="badge div-row-icon-badge grow",spanFloor.textContent=item.subBuildingName,spanFloor.onclick=function(e){var id=e.currentTarget.getAttribute("pageId");id&&""!=id&&0!=id?ScreenManager.show(ObserverScreen,id):alert("This floor has no details")},div.appendChild(spanFloor),0==item.equipmentIds.length)div.innerHTML+="none";else for(var j=0,len=item.equipmentIds.length;len>j;j++){var equipmentId=item.equipmentIds[j];spanIcon=document.createElement("span"),spanIcon.id="spanNav-icon-"+zoneId+"-"+equipmentId,spanIcon.title=this.dictEquipment[equipmentId].name,$(spanIcon).hover(function(e){var path=e.currentTarget.id.replace("spanNav-icon-","");setTimeout(function(){$(".tooltip").remove(),$("#div-floor-icon-"+path).tooltip("show")},500)},function(e){id="div-floor-icon-"+e.currentTarget.id.replace("spanNav-icon-",""),$("#"+id).tooltip("hide")}),spanIcon.onclick=function(e){_this.showEquipmentDetail(e.currentTarget.id.split("-")[3])},spanIcon=this.updatePaneNavWarning(spanIcon,null),div.appendChild(spanIcon)}pane.appendChild(div)}var paneIcon=document.getElementById("paneIcon");paneIcon.innerHTML="",paneIcon.appendChild(pane)},renderPaneNotice:function(){var divNotice,item,fault,equipment,zone,sb,span,_this=this;$("#divPaneNotice .panel-body").remove();var divPane=document.createElement("div");divPane.className="panel-body",divPane.style.height="calc(100% - 41px)",divPane.style.overflowY="auto";for(var i=0,len=this.arrLastNotice.length;len>i;i++)if(item=this.arrLastNotice[i],fault=this.dictFault[item.faultId],fault.display){equipment=this.dictEquipment[fault.equipmentId],zone=this.dictZone[equipment.zoneId],divNotice=document.createElement("div"),divNotice.id="divLog-"+i,divNotice.setAttribute("path",zone.id+"-"+equipment.id),divNotice.className="div-pane-log",$(divNotice).hover(function(e){var index=e.currentTarget.id.replace("divLog-",""),id="div-floor-"+_this.dictEquipment[_this.dictFault[_this.arrLastNotice[index].faultId].equipmentId].zoneId;document.getElementById(id).classList.add("hover");var path=e.currentTarget.getAttribute("path");setTimeout(function(){$(".tooltip").remove(),$("#div-floor-icon-"+path).tooltip("show")},500)},function(e){var index=e.currentTarget.id.replace("divLog-","");document.getElementById("div-floor-"+_this.dictEquipment[_this.dictFault[_this.arrLastNotice[index].faultId].equipmentId].zoneId).classList.remove("hover"),$("#div-floor-icon-"+e.currentTarget.getAttribute("path")).tooltip("hide")});var parent=$(divNotice);switch(sb=new StringBuilder,sb.append(fault.name),item.status&&""!=item.status&&0!=item.status&&sb.append(" (").append(item.status).append(")"),span=$("<span>").addClass("badge").attr("title","Fault name").css("display","block").css("color","#555").text(sb.toString()),fault.grade){case 0:break;case 1:span.css("background-color","rgba(240, 173, 78, 0.7)");break;case 2:span.css("background-color","rgba(217, 83, 79, 0.7)")}parent.append(span),span=$("<span>").addClass("badge grow span-hover-pointer").attr("title","Equipment name").attr("equipment",equipment.pageId).text(equipment.name),span.click(function(e){this.dialog=new ObserverScreen(e.currentTarget.getAttribute("equipment")),this.dialog.isDetailPage=!0,this.dialog.show()}),parent.append(span),$("<span>").addClass("badge grow span-hover-pointer").attr("pageId",zone.pageId).attr("title","Zone ID").text(zone.subBuildingName).click(function(e){var id=e.currentTarget.getAttribute("pageId");id&&""!=id&&0!=id?ScreenManager.show(ObserverScreen,id):alert("This floor has no details")}).appendTo(parent),$("<span>").attr("title","Triggering time").text(new Date(1e3*item.time).format("MM-dd HH:mm")).css("text-decoration","underline").css("font-weight","bold").appendTo(parent),item.grade&&0!=item.grade&&""!=item.grade&&$("<span>").attr("title","Show workflow order").addClass("glyphicon glyphicon-tags grow span-hover-pointer").attr("workflow",item.grade).css("float","right").css("margin-right","10px").css("margin-top","4px").css("color","#666").click(function(e){ScreenCurrent&&ScreenCurrent.close(),ScreenCurrent=new workflowNoticeDetail(e.currentTarget.getAttribute("workflow"),null,null),ScreenCurrent.show()}).appendTo(parent),$("<span>").attr("title","Show workflow order").addClass("glyphicon glyphicon-ok-sign grow span-hover-pointer").attr("workflow",item.grade).css("float","right").css("margin-right","10px").css("margin-top","4px").css("color","#666").click(function(e){}).appendTo(parent),$("<span>").attr("title","Show workflow order").addClass("glyphicon glyphicon-cog grow span-hover-pointer").attr("workflow",item.grade).css("float","right").css("margin-right","10px").css("margin-top","4px").css("color","#666").click(function(e){}).appendTo(parent);for(var strDesc=fault.description,arr=item.detail.toString().split(","),j=0;j<arr.length;j++)strDesc=strDesc.replace("{"+j.toString()+"}",'<span class="variable">'+arr[j]+"</span>");$("<p>").text(strDesc).appendTo(parent),$(divPane).append(parent),this.renderPaneBuilding(item,fault,equipment,zone),this.renderPaneNav(item,fault,equipment)}document.getElementById("divPaneNotice").appendChild(divPane)},renderPaneBuilding:function(notice,fault,equipment,zone){var element=document.getElementById("div-floor-"+equipment.zoneId);if(element){var color,divIcon=$("#div-floor-icon-"+zone.id+"-"+equipment.id);switch(fault.grade){case 0:color="window";break;case 1:color="rgb(238, 170, 100)";break;case 2:color="rgb(200, 100, 100)"}color&&(element.style.backgroundColor=color,divIcon.css("background-color",color));var sb=new StringBuilder;sb.append('<div class="tooltip" role="tooltip">'),sb.append('    <div class="tooltipTitle tooltip-inner">Equipment</div>'),sb.append('    <div class="tooltipContent">'),sb.append('        <p style="white-space:nowrap;">Name: <span style="font-weight: bold;">').append(equipment.name).append("</span></p> "),sb.append('        <p style="white-space:nowrap;">System: <span style="font-weight: bold;">').append(equipment.systemName).append("</span></p> "),sb.append('        <p style="white-space:nowrap;">Subsystem: <span style="font-weight: bold;">').append(equipment.subSystemName).append("</span></p> "),sb.append('        <p style="white-space:nowrap;">Faults:</p> ');for(var i=0;i<equipment.faultIds.length;i++){sb.append('<p style="margin-left: 20px; white-space:nowrap;"><span style="font-weight: bold;">').append(this.dictFault[equipment.faultIds[i]].name);for(var j=0;j<this.arrLastNotice.length;j++){var noticeTemp=this.arrLastNotice[j];noticeTemp.faultId==equipment.faultIds[i]&&noticeTemp.status&&""!=noticeTemp.status&&0!=noticeTemp.status&&sb.append(" (").append(noticeTemp.status).append(")")}sb.append("</span></p> ")}sb.append("    </div>"),sb.append('    <div class="tooltip-arrow"></div>'),sb.append("</div>");var options={title:"Equipment",template:sb.toString()};divIcon.tooltip(options)}},renderPaneNav:function(notice,fault,equipment){var element=document.getElementById("spanNav-icon-"+equipment.zoneId+"-"+equipment.id);this.updatePaneNavWarning(element,fault.grade)},updatePaneNavWarning:function(element,level){var strClass,spanIcon=element;return 0==level?(strClass="glyphicon glyphicon-ok-sign",spanIcon.style.color="#009999",spanIcon.style.opacity=.7):1==level?(strClass="glyphicon glyphicon-info-sign",spanIcon.style.color="#EEAA00"):2==level?(strClass="glyphicon glyphicon-remove-sign animation-warning",spanIcon.style.color="#CC3333"):(strClass="glyphicon glyphicon-minus-sign",spanIcon.style.color="#009999",spanIcon.style.opacity=.7),spanIcon.className=strClass+" div-row-icon grow",spanIcon},showEquipmentDetail:function(equipmentId){this.dialog=new ObserverScreen(this.dictEquipment[equipmentId].pageId),this.dialog.isDetailPage=!0,this.dialog.show()},showZoneDetail:function(zoneId){}},DiagnosisScreen}(),DiagnosisHistory=function(){function DiagnosisHistory(parent){_this=this,this.parent=parent,this.m_tableInfo=[],this.m_bSortTimeAscend=!1,this.m_bSortGradeAscend=!1,this.m_bSortEquipAscend=!1,this.m_bSortZoneAscend=!1,this.m_bSortFaultAscend=!1,this.m_bSortStatusAscend=!1}var _this=void 0;return DiagnosisHistory.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get("/static/views/observer/diagnosis/paneHistory.html").done(function(resultHtml){var dialog=$("#dialogModal");dialog.find("#dialogContent").html(resultHtml),$("#dialogContent .modal-content").css("height",document.body.scrollHeight-100),dialog.off("hidden.bs.modal").on("hidden.bs.modal",function(e){_this.close(),ScreenModal=null,Spinner.stop()}).modal({}),Spinner.spin(dialog.find(".modal-body")[0]),_this.init(),$("#datePickerLog").datetimepicker({minView:"month",autoclose:!0,todayBtn:!0,initialDate:new Date}),$("#txtLogDate").val((new Date).toLocaleDateString().replace("/","-").replace("/","-")),$("#txtLogDate").change(function(e){_this.refreshData()}),$("#btnLogPre").click(function(e){var preDay=new Date(Date.parse($("#txtLogDate").val())-864e5);$("#txtLogDate").val(preDay.toLocaleDateString().replace("/","-").replace("/","-")),_this.refreshData()}),$("#btnLogNext").click(function(e){var nextDay=new Date(Date.parse($("#txtLogDate").val())+864e5);$("#txtLogDate").val(nextDay.toLocaleDateString().replace("/","-").replace("/","-")),_this.refreshData()}),$("#thTime").click(function(e){_this.sortTable(0)}),$("#thGrade").click(function(e){_this.sortTable(1)}),$("#thEquip").click(function(e){_this.sortTable(2)}),$("#thZone").click(function(e){_this.sortTable(3)}),$("#thFault").click(function(e){_this.sortTable(4)}),$("#thStatus").click(function(e){_this.sortTable(5)}),$("#btnSearchFault").click(function(e){_this.searchFaultInfo()}),$("#inputSearchFault").keyup(function(e){13===e.keyCode&&_this.searchFaultInfo()})})},close:function(){},init:function(){var _this=this;WebAPI.get("/diagnosis/notice/getAll/"+AppConfig.projectId).done(function(result){_this.m_tableInfo=JSON.parse(result),_this.initTable(_this.m_tableInfo)}).error(function(result){dialog.find("#dialogContent").html("Error query.")}).always(function(){Spinner.stop()})},refreshData:function(){},initTable:function(data){for(var tr,item,sb,fault,equipment,zone,tbody=document.createElement("tbody"),i=0,len=data.length;len>i;i++){switch(item=data[i],fault=this.parent.dictFault[item.faultId],equipment=this.parent.dictEquipment[fault.equipmentId],zone=this.parent.dictZone[equipment.zoneId],tr=document.createElement("tr"),tr.id="diagHistory_"+item.id,sb=new StringBuilder,sb.append("<td>").append(new Date(1e3*item.time).format("yyyy-MM-dd HH:mm:ss")).append("</td>"),item.grade){case 0:sb.append('<td><span class="badge" style="background-color: #5bc0de;" title="Grade">Normal</span></td>');break;case 1:sb.append('<td><span class="badge" style="background-color: #f0ad4e;" title="Grade">Alert</span></td>');break;case 2:sb.append('<td><span class="badge" style="background-color: #d9534f;" title="Grade">Fault</span></td>');break;default:sb.append('<td><span class="badge" style="background-color: #d9534f;" title="Grade">Unknown</span></td>')}switch(sb.append("<td>").append(equipment.name).append("</td>"),sb.append("<td>").append(zone.subBuildingName).append("</td>"),sb.append("<td>").append(fault.name).append("</td>"),item.status){case 0:sb.append("<td>Disable</td>");break;case 1:sb.append("<td>Delayed</td>");break;case 2:sb.append("<td>Realtime</td>")}for(var strDesc=fault.description,arr=item.detail.toString().split(","),j=0;j<arr.length;j++)strDesc=strDesc.replace("{"+j.toString()+"}",'<span class="variable">'+arr[j]+"</span>");tr.title=strDesc,tr.innerHTML=sb.toString(),tbody.appendChild(tr)}$("#tableNoticeHistory").append(tbody)},sortTable:function(type){$("#tableNoticeHistory tbody").html(""),0===type?(_this.m_tableInfo.sort(_this.m_bSortTimeAscend?_this.sortTimeDescending:_this.sortTimeAscending),_this.m_bSortTimeAscend=!_this.m_bSortTimeAscend):1===type?(_this.m_tableInfo.sort(_this.m_bSortGradeAscend?_this.sortGradeDescending:_this.sortGradeAscending),_this.m_bSortGradeAscend=!_this.m_bSortGradeAscend):2===type?(_this.m_tableInfo.sort(_this.m_bSortEquipAscend?_this.sortEquipDescending:_this.sortEquipAscending),_this.m_bSortEquipAscend=!_this.m_bSortEquipAscend):3===type?(_this.m_tableInfo.sort(_this.m_bSortZoneAscend?_this.sortZoneDescending:_this.sortZoneAscending),_this.m_bSortZoneAscend=!_this.m_bSortZoneAscend):4===type?(_this.m_tableInfo.sort(_this.m_bSortFaultAscend?_this.sortFaultDescending:_this.sortFaultAscending),_this.m_bSortFaultAscend=!_this.m_bSortFaultAscend):5===type&&(_this.m_tableInfo.sort(_this.m_bSortStatusAscend?_this.sortStatusDescending:_this.sortStatusAscending),_this.m_bSortStatusAscend=!_this.m_bSortStatusAscend),_this.initTable(_this.m_tableInfo)},sortTimeAscending:function(a,b){return a.time-b.time},sortTimeDescending:function(a,b){return b.time-a.time},sortGradeAscending:function(a,b){return a.grade-b.grade},sortGradeDescending:function(a,b){return b.grade-a.grade},sortEquipAscending:function(a,b){var fault=_this.parent.dictFault[a.faultId],equipA=_this.parent.dictEquipment[fault.equipmentId];fault=_this.parent.dictFault[b.faultId];var equipB=_this.parent.dictEquipment[fault.equipmentId];return equipA.name.localeCompare(equipB.name)},sortEquipDescending:function(a,b){var fault=_this.parent.dictFault[a.faultId],equipA=_this.parent.dictEquipment[fault.equipmentId];fault=_this.parent.dictFault[b.faultId];var equipB=_this.parent.dictEquipment[fault.equipmentId];return equipB.name.localeCompare(equipA.name)},sortZoneAscending:function(a,b){var fault=_this.parent.dictFault[a.faultId],equip=_this.parent.dictEquipment[fault.equipmentId],zoneA=_this.parent.dictZone[equip.zoneId];fault=_this.parent.dictFault[b.faultId],equip=_this.parent.dictEquipment[fault.equipmentId];var zoneB=_this.parent.dictZone[equip.zoneId];return zoneA.subBuildingName.localeCompare(zoneB.subBuildingName)},sortZoneDescending:function(a,b){var fault=_this.parent.dictFault[a.faultId],equip=_this.parent.dictEquipment[fault.equipmentId],zoneA=_this.parent.dictZone[equip.zoneId];fault=_this.parent.dictFault[b.faultId],equip=_this.parent.dictEquipment[fault.equipmentId];var zoneB=_this.parent.dictZone[equip.zoneId];return zoneB.subBuildingName.localeCompare(zoneA.subBuildingName);

},sortFaultAscending:function(a,b){var faultA=_this.parent.dictFault[a.faultId],faultB=_this.parent.dictFault[b.faultId];return faultA.name.localeCompare(faultB.name)},sortFaultDescending:function(a,b){var faultA=_this.parent.dictFault[a.faultId],faultB=_this.parent.dictFault[b.faultId];return faultB.name.localeCompare(faultA.name)},sortStatusAscending:function(a,b){return a.status-b.status},sortStatusDescending:function(a,b){return b.status-a.status},searchFaultInfo:function(){var searchVal=$("#inputSearchFault").val();if(null!=searchVal&&void 0!=searchVal){if($("#tableNoticeHistory tbody").html(""),""==searchVal)return void _this.initTable(_this.m_tableInfo);var faultName,item,arrSuit=[];searchVal=searchVal.toLowerCase();for(var i=0,len=_this.m_tableInfo.length;len>i;i++)item=_this.m_tableInfo[i],faultName=_this.parent.dictFault[item.faultId].name,faultName=faultName.toLowerCase(),-1!=faultName.indexOf(searchVal)&&arrSuit.push(item);_this.initTable(arrSuit)}}},DiagnosisHistory}(),DataCenter3D=function(){function Room(domElement,dataSource){this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.domElement=domElement,this.dataSource=dataSource,this.data=null,this.projector=new THREE.Projector,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.stats=null,this.INTERSECTED=null,this.cameraHelper=null}function DataCenter3D(){}return Room.prototype={initScene:function(){this.scene=new THREE.Scene,this.scene.rotation.x=Math.PI/2},initCamera:function(){this.camera=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,2e5),this.resetView(),this.camera.up=new THREE.Vector3(0,0,1),this.scene.add(this.camera)},initRender:function(){this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(15790320,1),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!0,this.renderer.shadowMapEnabled=!0,this.domElement.appendChild(this.renderer.domElement)},initControl:function(){this.controls=new THREE.TrackballControls(this.camera),this.controls.staticMoving=!0,this.controls.addEventListener("change",this.render.bind(this))},initLight:function(){var light_ambient=new THREE.AmbientLight(0);this.scene.add(light_ambient);var hemiLight=new THREE.HemisphereLight(16777215,16777215,.6);hemiLight.color.setHSL(.6,1,.6),hemiLight.groundColor.setHSL(.095,1,.75),hemiLight.position.set(0,0,500),this.scene.add(hemiLight);var light=new THREE.DirectionalLight(16777215,2.25);light.position.set(0,450,500),light.castShadow=!0,light.shadowMapWidth=1024,light.shadowMapHeight=1024,this.scene.add(light)},initStats:function(){this.stats=new Stats,this.stats.domElement.style.position="absolute",this.stats.domElement.style.bottom="0px",this.stats.domElement.style.zIndex=100,this.domElement.appendChild(this.stats.domElement)},initObjects:function(){if(this.data){for(var unitItem,units=this.data.units,n=0,length=units.length;length>n;n++){unitItem=units[n];var unitObj=this.executeUnitType(unitItem.type,unitItem,this);unitObj.castShadow=!0,unitObj.receiveShadow=!0,this.scene.add(unitObj)}var gt=THREE.ImageUtils.loadTexture("/static/scripts/dataCenter3D/floor.jpg"),gg=new THREE.PlaneGeometry(this.data.width,this.data.height),gm=new THREE.MeshBasicMaterial({color:16777215,map:gt}),ground=new THREE.Mesh(gg,gm);ground.position.z=-300,ground.material.map.repeat.set(18,18),ground.material.map.wrapS=ground.material.map.wrapT=THREE.RepeatWrapping,ground.receiveShadow=!0,this.scene.add(ground)}},loadData:function(){var _this=this;return $.getJSON(this.dataSource).done(function(data){_this.data=data})},executeUnitType:function(unitType,arg,scene){for(var namespaces=unitType.split("."),func=namespaces.pop(),context=window,i=0;i<namespaces.length;i++)context=context[namespaces[i]];return new context[func](arg,scene)},attachEvent:function(){window.addEventListener("mousemove",this.onMouseMove.bind(this),!1),document.addEventListener("mousedown",this.onMouseDown.bind(this),!1)},cleanScene:function(){for(var elementsInTheScene=this.scene.children.length,i=elementsInTheScene-1;i>0;i--)"camera"!=this.scene.children[i].name&&"ambientLight"!=this.scene.children[i].name&&"directionalLight"!=this.scene.children[i].name&&this.scene.remove(this.scene.children[i])},resetView:function(){this.camera.position.x=6925.764174941334,this.camera.position.y=12.494895273811855,this.camera.position.z=4320.172377978487,this.controls&&this.controls.reset()},findMouseIntersection:function(type){if(!type)return[];var vector=new THREE.Vector3(this.mouse.x,this.mouse.y,1);this.projector.unprojectVector(vector,this.camera),this.raycaster.set(this.camera.position,vector.sub(this.camera.position).normalize());for(var machines=this.scene.children.filter(function(item){return item instanceof type}),machinesChildren=[],m=0;m<machines.length;m++)machinesChildren=machinesChildren.concat(machines[m].children);var intersects=this.raycaster.intersectObjects(machinesChildren);return intersects.map(function(item){return item.object.parent})[0]},enableCameraHelper:function(){this.cameraHelper.update(),this.cameraHelper.visible=!0},disableCameraHelper:function(){this.cameraHelper.visible=!1},animate:function(time){requestAnimationFrame(this.animate.bind(this)),TWEEN.update(time);var curObj=this.findMouseIntersection(threeData.unitType.Machine);if(curObj){if(curObj instanceof threeData.unitType.Machine){if(curObj.userData.isMoving)return;this.INTERSECTED&&this.INTERSECTED.id!=curObj.id&&this.INTERSECTED.beopHideMachineName(),this.INTERSECTED=curObj,this.INTERSECTED.beopShowMachineName(),this.domElement.style.cursor="pointer"}}else this.INTERSECTED&&(this.INTERSECTED.beopHideMachineName(),this.domElement.style.cursor="auto"),this.INTERSECTED=null;this.render(),this.controls.update(),this.stats.update()},render:function(){this.renderer.render(this.scene,this.camera)},start:function(){var _this=this;this.initScene(),this.initCamera(),this.initRender(),this.initLight(),this.loadData().done(function(){_this.initObjects()}).fail(function(){alert("load data failed.")}),this.initControl(),this.attachEvent(),this.initStats(),this.animate()},showMouseClickedObj:function(obj){if(obj){return obj.userData.isMoving=!0,new TWEEN.Tween(obj.position).to({x:2500,y:0,z:2e3},2e3).easing(TWEEN.Easing.Cubic.Out).onComplete(function(){obj.userData.isSingleShow=!0,obj.userData.isMoving=!1}).start()}},hideMouseClickedObj:function(obj){return obj?(obj.userData.isMoving=!0,new TWEEN.Tween(obj.position).to({x:obj.userData.originPosition.x,y:obj.userData.originPosition.y,z:obj.userData.originPosition.z},2e3).easing(TWEEN.Easing.Quartic.Out).onComplete(function(){obj.userData.isMoving=!1,obj.userData.isSingleShow=!1}).start()):void 0},onMouseMove:function(event){this.mouse.x=event.clientX/window.innerWidth*2-1,this.mouse.y=2*-(event.clientY/window.innerHeight)+1},onMouseDown:function(event){var curObj=this.findMouseIntersection(threeData.unitType.Machine);curObj&&!curObj.userData.isMoving&&(curObj.userData.isSingleShow?this.hideMouseClickedObj(curObj):(this.hideMouseClickedObj(this.showingObj),this.showMouseClickedObj(curObj),this.showingObj=curObj))}},DataCenter3D.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer),$.get("/static/views/dataCenter3D/index.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml),_this.init()}).always(function(){Spinner.stop()})},init:function(){var room=new Room(document.getElementById("t3Container"),"/static/scripts/dataCenter3D/data_machine1.json");room.start(),$(".showSkin").click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine}).forEach(function(machine){machine.showSkin()})}),$(".hideSkin").click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine}).forEach(function(machine){machine.hideSkin()})}),$(".showTemperature").click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine})[0].beopShowTemperature()}),$(".resetView").click(function(){room.resetView()})},close:function(){}},DataCenter3D}();