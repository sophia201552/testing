<link rel="stylesheet" type="text/css" href="/static/scripts/lib/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/static/content/index.css">
<link rel="stylesheet" type="text/css" href="/static/content/index-black.css">
<link rel="stylesheet" type="text/css" href="/static/app/Benz/env.css">
<script src="/static/scripts/lib/jquery-2.1.4.min.js"></script>
<script src="/static/scripts/lib/bootstrap/js/bootstrap.min.js"></script>

<script src="/static/app/Benz/qrcode.js"></script>
<script src="/static/app/Benz/jquery.qrcode.js"></script>
<script>
    (function (window) {
        if (!window.beopTmpl) {
            window.beopTmpl = function tmpl(str, data) {
                var fn = !/\W/.test(str) ?

                        tmpl(document.getElementById(str).innerHTML) :

                        new Function("obj",
                                "var p=[],print=function(){p.push.apply(p,arguments);};" +

                                "with(obj){p.push('" +

                                str
                                        .replace(/[\r\t\n]/g, " ")
                                        .split(/<!/).join("\t")
                                        .replace(/((^|!>)[^\t]*)'/g, "$1\r")
                                        .replace(/\t=(.*?)!>/g, "',$1,'")
                                        .split("\t").join("');")
                                        .split(/!>/).join("p.push('")
                                        .split("\r").join("\\'")
                                + "');}return p.join('');");

                return data ? fn(data) : fn;
            }
        }
    })(window);
    $(function () {
        var ConfigMap = {
            el: {
                patrolPointContainer: "#patrol-point-container",
                //巡更点信息查看modal
                PatrolPointInfo: "#PatrolPointInfo"
            },
            temp: {
                patrolPointContainer: "temp_patrol_point"
            }
        };

        var patrolPointData, page = 1, num = 10;
        var printData = [];
        var $container = $(ConfigMap.el.patrolPointContainer),
                $pagination = $('.pagination');
        $pagination.find('a[href!="#"]').off().click(function () {
            var $paginationA = $pagination.find('a');
            $paginationA.removeClass('active');
            $(this).addClass('active');
            page = $paginationA.index(this);
            getData(true);
        });

        function getData(isPage) {
            if (isPage) {
                $container.empty().html($(beopTmpl(ConfigMap.temp.patrolPointContainer, {
                    data: patrolPointData.slice((page - 1) * num, num * page)
                })).fadeIn(300)).fadeIn();
            } else {
                $.getJSON('xgd.json').done(function (result) {
                    if (result.success) {
                        patrolPointData = result.data.reverse();
                        $container.html($(beopTmpl(ConfigMap.temp.patrolPointContainer, {
                            data: patrolPointData.slice((page - 1) * num, num * page)
                        })).fadeIn(300)).fadeIn();
                    }
                });
            }
        }

        getData();

        //打印生成二维码
        var $print = $('#print');
        $print.off().click(function () {
            $('#print-modal').modal('show').find('.modal-body .row').empty().html(beopTmpl('temp_print_data', {
                data: printData
            }));
            $('.qrcodes').each(function (index, item) {
                $(item).qrcode({
                    text: printData[index].PatrolAddressOrDevice + new Date().getTime()
                })
            })
        });
        $container.off('click').on('click', 'tbody tr', function (ev) {
            var $this = $(this), target = $(ev.target);
            if (target.hasClass('myModal')) {
                var $tr = $(this).closest('tr'), id = $tr.attr('data-id'), data;
                patrolPointData.forEach(function (item) {
                    if (item.id == id) {
                        data = item;
                    }
                });
                $('#qrcodeCanvas').empty().qrcode({
                    text: data.PatrolAddressOrDevice + new Date().getTime()
                });
                $('#myModal').modal('show').find('.modal-body').find('p').text(data.PatrolAddressOrDevice);
            }
            //显示巡更路线
            if (target.closest('td').hasClass('patrol-control')) {
                return;
            }
            if (target.hasClass('patrol-router')) {
                $('#PatrolPointInfo').modal('show').
                    //查看
                        off('.watchPatrolRouter').on('click.watchPatrolRouter', '.watchPatrolRouter', function () {
                            var $this = $(this), $li = $this.closest('.list-group-item'), $ul = $this.next();
                            if ($ul.hasClass('active')) {
                                $ul.slideUp();
                                $this.text('查看');
                            } else {
                                $ul.slideDown();
                                $this.text('收起');
                            }
                            $ul.toggleClass('active');
                        }).find('.watchPatrolRouter').text('查看').next().hide().removeClass('active').end();

            } else {
                //批量选择巡更点
                var id = $this.attr('data-id');
                if ($this.hasClass('active')) {
                    $this.find('input[type="checkbox"]').prop('checked', false);
                    printData.forEach(function (item, index, array) {
                        if (item.id == id) {
                            array.splice(index, 1);
                        }
                    })
                } else {
                    if (printData.length >= 6) {
                        alert('最多选择6个');
                        return false;
                    }
                    $this.find('input[type="checkbox"]').prop('checked', true);
                    patrolPointData.forEach(function (item) {
                        if (item.id == id) {
                            printData.push(item);
                        }
                    });
                }
                $this.toggleClass('active');
                if (printData.length > 0) {
                    $print.prop('disabled', '');
                } else {
                    $print.prop('disabled', 'disabled');
                }
            }
        });
        //添加巡更点
        var $addPatrolPointContainer = $('#addPatrolPointData');
        $addPatrolPointContainer.on('show.bs.modal', function () {
            $(this).find('#patrol-router').val('');
            $(this).find('#patrol-name').val('');
        });
        var number = 50;
        $('#addPatrolPointBtn').off().click(function () {
            $('#addPatrolPoint-form').off().on('submit', function () {
                var patrolRouter = $addPatrolPointContainer.find('#patrol-router').val(),
                        patrolName = $addPatrolPointContainer.find('#patrol-name').val();
                $addPatrolPointContainer.modal('hide');
                number++;
                var date = new Date(),
                        month = date.getMonth() + 1,
                        day = date.getDate();
                if (month < 9) {
                    month = '0' + month;
                }
                if (day < 9) {
                    day = '0' + day;
                }
                var model = {
                    number: '0' + number,
                    PatrolAddressOrDevice: patrolName,
                    creator: "李小龙",
                    createTime: date.getFullYear() + '-' + month + '-' + day,
                    relatedPatrolRoute: patrolRouter
                };
                patrolPointData.unshift(model);
                $container.find('table').prepend($(beopTmpl("temp_add_patrol_point", {
                    item: model
                })).fadeIn(300));

            }).submit();
        });
    })
</script>

<body>

<style>
    .xungeng {
        margin: 10px auto;
    }

    div img {
        width: 75%;
    }

    .pagination a.active {
        color: #fff !important;
    }

    #patrol-point-container table tr {
        cursor: pointer;
    }

    #patrol-point-container table tr.active {
        background: rgb(37, 48, 70);
    }

    #patrol-point-container table td, #patrol-point-container table th {
        text-align: center;
    }

    .list-group-item {
        cursor: default !important;
    }

    .breadcrumb {
        margin: 10px 0;
        color: #333 !important;
        display: none;
    }

    .breadcrumb a {
        color: #333 !important;
    }

    #print-modal .modal-body .row > div {
        margin-bottom: 15px;
    }

    .ewm-p {
        font-size: 20px;
        margin-top: 25px;
        border-top: 1px solid #ddd;
        padding-top: 20px;
        color: mediumseagreen;
    }

    .ewm-container {
        text-align: center;
        background: #fff;
        padding: 30px 0 15px;
        border-radius: 5px;
    }
</style>

<div class="xungeng">

    <div class="btn-toolbar" role="toolbar">
        <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#addPatrolPointData">
            <span class="glyphicon glyphicon-plus"></span> 新增
        </button>
        <button type="button" class="btn btn-default btn-sm" disabled><span class="glyphicon glyphicon-pencil"
                                                                            aria-hidden="true"></span> 修改
        </button>
        <button type="button" class="btn btn-default btn-sm" disabled><span class="glyphicon glyphicon-remove"
                                                                            aria-hidden="true"></span> 删除
        </button>
        <button type="button" id="print" class="btn btn-default btn-sm" disabled><span class="glyphicon glyphicon-print"
                                                                                       aria-hidden="true"></span>
            批量打印二维码
        </button>
    </div>

    <script type="text/html" id="temp_print_data">
        <! data.forEach(function(item){!>
        <div class="col-xs-4 col-md-4">
            <div class="ewm-container">
                <div class="qrcodes"></div>

                <p class="ewm-p"><!=item.PatrolAddressOrDevice!></p>
            </div>
        </div>
        <!});!>
    </script>
    <script type="text/html" id="temp_add_patrol_point">
        <tr data-correspondPatrolRoute="">
            <td>
                <input type="checkbox">
                <!=item.number!>
            </td>
            <td><!=item.PatrolAddressOrDevice!></td>
            <td><!=item.creator!></td>
            <td><!=item.createTime!></td>
            <td class="patrol-router">0</td>
            <td>
                <button class="btn btn-success btn-xs myModal">查看</button>
                <button class="btn btn-warning btn-xs">重新生成</button>
            </td>
        </tr>
    </script>
    <script type="text/html" id="temp_patrol_point">
        <table class="table  table-hover">
            <caption></caption>
            <thead>
            <tr>
                <th>编号</th>
                <th>巡更地址或设备</th>
                <th>创建人</th>
                <th>创建时间</th>
                <th>相关的巡更路线</th>
                <th>二维码管理</th>
            </tr>
            </thead>
            <tbody>
            <!data.forEach(function(item){!>
            <tr data-correspondPatrolRoute="<!=item.correspondPatrolRoute!>" data-id="<!=item.id!>">
                <td>
                    <input type="checkbox"/>
                    <!=item.number!>
                </td>
                <td><!=item.PatrolAddressOrDevice!></td>
                <td><!=item.creator!></td>
                <td><!=item.createTime!></td>
                <td class="patrol-router" title="查看相关的巡更路线"><!=item.relatedPatrolRoute!></td>
                <td class="patrol-control">
                    <button class="btn btn-success btn-xs myModal"><span class="glyphicon glyphicon-qrcode"></span> 查看</button>
                    <button class="btn btn-warning btn-xs"><span class="glyphicon glyphicon-refresh"></span> 重新生成</button>
                </td>
            </tr>
            <!});!>
            </tbody>
        </table>
    </script>
    <div class="table-responsive" id="patrol-point-container"></div>

    <nav>
        <ul class="pagination">
            <li>
                <a href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>
            <li><a class="active">1</a></li>
            <li><a>2</a></li>
            <li><a>3</a></li>
            <li><a>4</a></li>
            <li><a>5</a></li>
            <li>
                <a href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
</div>
<div class="modal fade" id="PatrolPointInfo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">巡更点信息查看</h4>
            </div>
            <div class="modal-body">
                <div class="panel panel-info">
                    <div class="panel-heading">巡更任务</div>
                    <div class="panel-body">
                        <ul class="list-group">
                            <li class="list-group-item">
                                B1层污水泵房
                                <button type="button" class="pull-right btn btn-default btn-xs watchPatrolRouter">
                                    查看
                                </button>
                                <ol class="breadcrumb">
                                    <li class="active"><a href="javascript:void(0)">巡更点-1</a></li>
                                    <li><a href="javascript:void(0)">巡更点-2</a></li>
                                    <li><a href="javascript:void(0)">巡更点-3</a></li>
                                    <li><a href="javascript:void(0)">巡更点-4</a></li>
                                </ol>
                            </li>
                            <li class="list-group-item">
                                B2层污水泵房
                                <button type="button" class="pull-right btn btn-default btn-xs watchPatrolRouter">
                                    查看
                                </button>
                                <ol class="breadcrumb">
                                    <li class="active"><a href="javascript:void(0)">巡更点-1</a></li>
                                    <li><a href="javascript:void(0)">巡更点-2</a></li>
                                    <li><a href="javascript:void(0)">巡更点-3</a></li>
                                </ol>
                            </li>
                            <li class="list-group-item">
                                B3层污水泵房
                                <button type="button" class="pull-right btn btn-default btn-xs watchPatrolRouter">
                                    查看
                                </button>
                                <ol class="breadcrumb">
                                    <li class="active"><a href="javascript:void(0)">巡更点-1</a></li>
                                    <li><a href="javascript:void(0)">巡更点-2</a></li>
                                    <li><a href="javascript:void(0)">巡更点-3</a></li>
                                </ol>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default">打印</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="print-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">打印二维码</h4>
            </div>
            <div class="modal-body">
                <div class="row"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default">打印</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">二维码查看</h4>
            </div>
            <div class="modal-body">
                <div style="background: #fff;text-align: center;padding: 20px 5px;border-radius: 5px;">
                    <div id="qrcodeCanvas"></div>

                    <p class="ewm-p"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default">打印</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="addPatrolPointData" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">添加新的巡更点</h4>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" id="addPatrolPoint-form" action="javascript:void(0)">
                    <div class="form-group">
                        <label for="patrol-name" class="col-sm-3 control-label">巡更地址或设备</label>

                        <div class="col-sm-9">
                            <input type="text" class="form-control" placeholder="巡更地址或设备" id="patrol-name" required>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button type="submit" class="btn btn-primary" id="addPatrolPointBtn">添加</button>
            </div>
        </div>
    </div>
</div>

</body>