<link rel="stylesheet" type="text/css" href="/static/scripts/lib/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="/static/content/index.css">
<link rel="stylesheet" type="text/css" href="/static/content/index-black.css">
<link rel="stylesheet" type="text/css" href="/static/app/Benz/env.css">
<script src="/static/scripts/lib/jquery-2.1.4.min.js"></script>
<script src="/static/scripts/lib/bootstrap/js/bootstrap.min.js"></script>
<body>

<style>
    .xungeng {
        margin-top: 10px;
    }

    .pagination .active a {
        color: #EBC124 !important;
    }

    #xldy-points td {
        color: black;
    }

    .chosen-container {
        position: relative;
        display: inline-block;
        vertical-align: middle;
        font-size: 13px;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
    }

    .chosen-container * {
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
    }

    .chosen-container .chosen-drop {
        position: absolute;
        top: 100%;
        z-index: 1010;
        width: 100%;
        border: 1px solid #aaa;
        border-top: 0;
        background: #fff;
        box-shadow: 0 4px 5px rgba(0, 0, 0, 0.15);
        display: none;
    }

    .chosen-container .chosen-results li {
        display: none;
        margin: 0;
        padding: 5px 6px;
        list-style: none;
        line-height: 15px;
        word-wrap: break-word;
        -webkit-touch-callout: none;
    }

    .chosen-container .chosen-results {
        color: #444;
        position: relative;
        overflow-x: hidden;
        overflow-y: auto;
        margin: 0 4px 4px 0;
        padding: 0 0 0 4px;
        max-height: 240px;
        -webkit-overflow-scrolling: touch;
    }

    .chosen-container .chosen-results li.active-result {
        display: list-item;
        cursor: pointer;
    }

    .chosen-container-multi .chosen-drop .result-selected {
        display: list-item;
        color: #ccc;
        cursor: default;
    }

    .chosen-drop li:hover {
        background-color: #3875d7;
        background-image: -webkit-gradient(linear, 50% 0%, 50% 100%, color-stop(20%, #3875d7), color-stop(90%, #2a62bc));
        background-image: -webkit-linear-gradient(#3875d7 20%, #2a62bc 90%);
        background-image: -moz-linear-gradient(#3875d7 20%, #2a62bc 90%);
        background-image: -o-linear-gradient(#3875d7 20%, #2a62bc 90%);
        background-image: linear-gradient(#3875d7 20%, #2a62bc 90%);
        color: #fff;
    }

</style>

<div class="xungeng col-md-12">

    <div class="btn-toolbar" role="toolbar">
        <button type="button" class="btn btn-default btn-sm" data-toggle="modal" data-target="#addTask">
            <span class="glyphicon glyphicon-plus"></span> 新增
        </button>
        <button type="button" class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-pencil"></span> 修改
        </button>
        <button type="button" class="btn btn-default btn-sm">
            <span class="glyphicon glyphicon-remove"></span> 删除
        </button>
    </div>

    <div>

        <div class="table-responsive">
            <table class="table  table-hover">
                <caption></caption>
                <thead>
                <tr>
                    <th>任务编号</th>
                    <th>任务名称</th>
                    <th>任务类型</th>
                    <th>任务周期</th>
                    <th>任务人员分配方式</th>
                    <th>任务路线</th>
                </tr>
                </thead>
                <tbody id="xglxTable">

                </tbody>
            </table>
        </div>
    </div>

    <nav style="float: right;">
        <ul class="pagination">
            <li class="active" data-page="1"><a>1</a></li>
            <li data-page="2"><a href="#">2</a></li>
        </ul>
    </nav>

    <div class="modal fade" id="addTask" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">新增巡更任务</h4>
                </div>
                <div class="modal-body clearfix">
                    <form>
                        <div class="form-group col-md-12">
                            <label for="taskName">任务名称</label>
                            <input type="text" class="form-control" id="taskName" required>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="taskType">任务类型</label>
                            <select class="form-control" id="taskType">
                                <option>日常巡更</option>
                                <option>设备巡更</option>
                            </select>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="taskType">任务周期</label>
                            <select class="form-control" id="taskCycle">
                                <option>每半天一次</option>
                                <option>每天一次</option>
                                <option>每周一次</option>
                                <option>每月一次</option>
                            </select>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="memberType">人员分配方式</label>
                            <select class="form-control" id="memberType">
                                <option>任意员工申领</option>
                                <option>指定员工组</option>
                            </select>
                        </div>
                        <div class="form-group col-md-12">
                            <label for="pointNum">任务节点数</label>
                            <input type="number" class="form-control" id="pointNum">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveTask">保存</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="lx" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">路线定义<span id="xldy-taskName"
                                                                        style="margin-left: 10px;"></span></h4>

                </div>
                <div class="modal-body clearfix">
                    <form style="height: 500px;overflow-y: scroll;">

                        <table class="table">

                            <tbody id="xldy-points">

                            </tbody>
                        </table>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveTaskPoints">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="temp_xglx_item">
    <! data.forEach(function(item){!>
    <tr data-id="<!=item['_id']!>">
        <td><!=item['任务编号']!></td>
        <td><!=item['任务名称']!></td>
        <td><!=item['任务类型']!></td>
        <td><!=item['任务周期']!></td>
        <td><!=item['任务人员分配方式']!></td>
        <td><!=item['任务路线']!>个节点
            <button class="btn btn-success btn-xs lxdy">路线定义</button>
        </td>
    </tr>
    <!});!>
</script>

<script type="text/html" id="temp_xglx_points">
    <! for(var m = 0; m < num; m++){!>
    <tr>
        <td>节点 <!=m+1!></td>
        <td>
            <div class="chosen-container">
                <input type="text" class="xgd" placeholder="选择巡更点"/>

                <div class="chosen-drop">
                    <ul class="chosen-results">
                        <! for(var n= 0; n < xgd.length; n++){!>
                        <li class="active-result"><!=xgd[n].PatrolAddressOrDevice!></li>
                        <!}!>
                    </ul>
                </div>
            </div>
        </td>
    </tr>
    <!}!>
</script>
<script>
    (function (window) {
        if (!window.beopTmpl) {
            window.beopTmpl = function tmpl(str, data) {
                var fn = !/\W/.test(str) ?

                        tmpl(document.getElementById(str).innerHTML) :

                        new Function("obj",
                                "var p=[],print=function(){p.push.apply(p,arguments);};" +

                                "with(obj){p.push('" +

                                str
                                        .replace(/[\r\t\n]/g, " ")
                                        .split(/<!/).join("\t")
                                        .replace(/((^|!>)[^\t]*)'/g, "$1\r")
                                        .replace(/\t=(.*?)!>/g, "',$1,'")
                                        .split("\t").join("');")
                                        .split(/!>/).join("p.push('")
                                        .split("\r").join("\\'")
                                + "');}return p.join('');");

                return data ? fn(data) : fn;
            }
        }
    })(window);
    $(function () {
        var num = 15, xglxResult = [], xgdPromise = $.getJSON('xgd.json');

        function render(data, page) {
            $('#xglxTable').empty().html(beopTmpl('temp_xglx_item', {
                data: data.slice((page - 1) * num, num * page)
            })).fadeIn(300);
        }

        function getData(page) {
            if (xglxResult && xglxResult.length) {
                render(xglxResult, page);
            } else {
                $.getJSON('xglx.json').done(function (result) {
                    try {
                        xglxResult = result.reverse();
                    } catch (e) {
                        return;
                    }
                    render(xglxResult, page);
                });
            }

        }

        getData(1);

        $('.pagination').on('click', 'li', function () {
            $('.pagination li.active').removeClass('active');
            $(this).addClass('active');
            getData($(this).data('page'));
        });

        $('#saveTask').click(function () {
            var num = xglxResult.length + 1;
            var data = {
                "_id": num,
                "任务编号": "0" + num,
                "任务名称": $('#taskName').val().trim(),
                "任务类型": $('#taskType').val(),
                "任务周期": $('#taskCycle').val(),
                "任务人员分配方式": $('#memberType').val(),
                "任务路线": Number($('#pointNum').val())
            };

            if (data['任务名称'] == '') {
                alert('任务名称不能为空');
                return;
            }

            if (data['任务路线'] > 200 || data['任务路线'] < 0) {
                alert('任务路线不合理,请输入在1-200之间的数值.');
                return;
            }

            xglxResult.unshift(data);
            getData(1);
            $('#addTask').modal('hide');
        });

        $('#xglxTable').on('click', '.lxdy', function () {
            var $this = $(this), $thisWrapper = $this.closest('tr');
            var data = {};
            xglxResult.forEach(function (item) {
                if (item['_id'] === $thisWrapper.data('id')) {
                    data = item;
                }
            });
            $('#xldy-taskName').text(data['任务名称']);
            xgdPromise.done(function (result) {
                if (result.success) {
                    $('#xldy-points').empty().html(beopTmpl('temp_xglx_points', {
                        num: data['任务路线'],
                        xgd: result.data
                    }));
                    $('#lx').modal('show');
                }
            });


        });

        $('#saveTaskPoints').click(function () {
            $('#lx').modal('hide');
        });

        $('#xldy-points').on('click', '.active-result', function () {
            var $this = $(this);
            $this.closest('.chosen-container').find('.xgd').val($this.text()).end().find('.chosen-drop').hide();

        }).on('focus', '.xgd', function () {
            var $this = $(this), html = '';
            $this.closest('.chosen-container').find('.chosen-drop').show();
            xgdPromise.done(function (result) {
                if (result.success) {
                    for (var m = 0; m < result.data.length; m++) {
                        html += '<li class="active-result">' + result.data[m].PatrolAddressOrDevice + '</li>';
                    }
                    $this.closest('.chosen-container').find('.chosen-results').html(html);
                }
            });
        }).on('keyup', '.xgd', function (e) {
            if (e.which == 13) {

            } else {
                var $this = $(this), text = $(this).val().trim(), html = '';
                xgdPromise.done(function (result) {
                    if (result.success) {
                        if (text == '') {
                            for (var m = 0; m < result.data.length; m++) {
                                html += '<li class="active-result">' + result.data[m].PatrolAddressOrDevice + '</li>';
                            }

                        } else {
                            for (var m = 0; m < result.data.length; m++) {
                                if (result.data[m].PatrolAddressOrDevice.indexOf(text) !== -1) {
                                    html += '<li class="active-result">' + result.data[m].PatrolAddressOrDevice + '</li>';
                                }
                            }

                        }
                        $this.closest('.chosen-container').find('.chosen-results').html(html);
                    }
                });

            }
        })

    })
</script>

</body>