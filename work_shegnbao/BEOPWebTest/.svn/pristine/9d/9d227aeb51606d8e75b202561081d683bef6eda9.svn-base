(function(root,factory){if(typeof exports=='object')module.exports=factory()
else if(typeof define=='function'&&define.amd)define(factory)
else root.LoadingSpinner=factory()}
(this,function(){"use strict";var prefixes=['webkit','Moz','ms','O'],animations={},useCssAnimations;function createEl(tag,prop){var el=document.createElement(tag||'div'),n;for(n in prop)el[n]=prop[n]
return el}
function ins(parent){for(var i=1,n=arguments.length;i<n;i++)
parent.appendChild(arguments[i])
return parent}
var sheet=(function(){var el=createEl('style',{type:'text/css'})
ins(document.getElementsByTagName('head')[0],el)
return el.sheet||el.styleSheet}())
function addAnimation(alpha,trail,i,lines){var name=['opacity',trail,~~(alpha*100),i,lines].join('-'),start=0.01+i/lines*100,z=Math.max(1-(1-alpha)/trail*(100-start),alpha),prefix=useCssAnimations.substring(0,useCssAnimations.indexOf('Animation')).toLowerCase(),pre=prefix&&'-'+prefix+'-'||''
if(!animations[name]){sheet.insertRule('@'+pre+'keyframes '+name+'{'+'0%{opacity:'+z+'}'+
start+'%{opacity:'+alpha+'}'+
(start+0.01)+'%{opacity:1}'+
(start+trail)%100+'%{opacity:'+alpha+'}'+'100%{opacity:'+z+'}'+'}',sheet.cssRules.length)
animations[name]=1}
return name}
function vendor(el,prop){var s=el.style,pp,i
prop=prop.charAt(0).toUpperCase()+prop.slice(1)
for(i=0;i<prefixes.length;i++){pp=prefixes[i]+prop
if(s[pp]!==undefined)return pp}
if(s[prop]!==undefined)return prop}
function css(el,prop){for(var n in prop)
el.style[vendor(el,n)||n]=prop[n]
return el}
function merge(obj){for(var i=1;i<arguments.length;i++){var def=arguments[i]
for(var n in def)
if(obj[n]===undefined)obj[n]=def[n]}
return obj}
function pos(el){var o={x:el.offsetLeft,y:el.offsetTop}
while((el=el.offsetParent))
o.x+=el.offsetLeft,o.y+=el.offsetTop
return o}
function getColor(color,idx){return typeof color=='string'?color:color[idx%color.length]}
var defaults={lines:12,length:10,width:5,radius:15,rotate:0,corners:1,color:'#000',direction:1,speed:1,trail:100,opacity:1/4,fps:20,zIndex:1001,className:'spinner',top:'50%',left:'50%',position:'absolute'}
function LoadingSpinner(o){this.opts=merge(o||{},LoadingSpinner.defaults,defaults)}
LoadingSpinner.defaults={}
merge(LoadingSpinner.prototype,{spin:function(target){this.stop()
this.opts.target=target;var divMask=document.createElement("div");divMask.className="spinnerMask";divMask.style.width=target.width;divMask.style.height=target.height;target.appendChild(divMask);this.divMask=divMask;var self=this,o=self.opts,el=self.el=css(createEl(0,{className:o.className}),{position:o.position,width:0,zIndex:o.zIndex}),mid=o.radius+o.length+o.width
css(el,{left:o.left,top:o.top})
if(target){target.insertBefore(el,target.firstChild||null)}
el.setAttribute('role','progressbar')
self.lines(el,self.opts)
if(!useCssAnimations){var i=0,start=(o.lines-1)*(1-o.direction)/2,alpha,fps=o.fps,f=fps/o.speed,ostep=(1-o.opacity)/(f*o.trail/100),astep=f/o.lines;(function anim(){i++;for(var j=0;j<o.lines;j++){alpha=Math.max(1-(i+(o.lines-j)*astep)%f*ostep,o.opacity)
self.opacity(el,j*o.direction+start,alpha,o)}
self.timeout=self.el&&setTimeout(anim,~~(1000/fps))})()}
return self},stop:function(){var el=this.el
if(el){clearTimeout(this.timeout)
if(el.parentNode)el.parentNode.removeChild(el)
this.el=undefined
if(this.divMask){if(this.divMask.parentNode)this.divMask.parentNode.removeChild(this.divMask)
this.el=undefined}}
return this},lines:function(el,o){var i=0,start=(o.lines-1)*(1-o.direction)/2,seg
function fill(color,shadow){return css(createEl(),{position:'absolute',width:(o.length+o.width)+'px',height:o.width+'px',background:color,boxShadow:shadow,transformOrigin:'left',transform:'rotate('+~~(360/o.lines*i+o.rotate)+'deg) translate('+o.radius+'px'+',0)',borderRadius:(o.corners*o.width>>1)+'px'})}
for(;i<o.lines;i++){seg=css(createEl(),{position:'absolute',top:1+~(o.width/2)+'px',transform:o.hwaccel?'translate3d(0,0,0)':'',opacity:o.opacity,animation:useCssAnimations&&addAnimation(o.opacity,o.trail,start+i*o.direction,o.lines)+' '+1/o.speed+'s linear infinite'})
if(o.shadow)ins(seg,css(fill('#000','0 0 4px '+'#000'),{top:2+'px'}))
ins(el,ins(seg,fill(getColor(o.color,i),'0 0 1px rgba(0,0,0,.1)')))}
return el},opacity:function(el,i,val){if(i<el.childNodes.length)el.childNodes[i].style.opacity=val}})
function initVML(){function vml(tag,attr){return createEl('<'+tag+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',attr)}
sheet.addRule('.spin-vml','behavior:url(#default#VML)')
LoadingSpinner.prototype.lines=function(el,o){var r=o.length+o.width,s=2*r
function grp(){return css(vml('group',{coordsize:s+' '+s,coordorigin:-r+' '+-r}),{width:s,height:s})}
var margin=-(o.width+o.length)*2+'px',g=css(grp(),{position:'absolute',top:margin,left:margin}),i
function seg(i,dx,filter){ins(g,ins(css(grp(),{rotation:360/o.lines*i+'deg',left:~~dx}),ins(css(vml('roundrect',{arcsize:o.corners}),{width:r,height:o.width,left:o.radius,top:-o.width>>1,filter:filter}),vml('fill',{color:getColor(o.color,i),opacity:o.opacity}),vml('stroke',{opacity:0}))))}
if(o.shadow)
for(i=1;i<=o.lines;i++)
seg(i,-2,'progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)')
for(i=1;i<=o.lines;i++)seg(i)
return ins(el,g)}
LoadingSpinner.prototype.opacity=function(el,i,val,o){var c=el.firstChild
o=o.shadow&&o.lines||0
if(c&&i+o<c.childNodes.length){c=c.childNodes[i+o];c=c&&c.firstChild;c=c&&c.firstChild
if(c)c.opacity=val}}}
var probe=css(createEl('group'),{behavior:'url(#default#VML)'})
if(!vendor(probe,'transform')&&probe.adj)initVML()
else useCssAnimations=vendor(probe,'animation')
return LoadingSpinner}));(function($){'use strict';var readFileIntoDataUrl=function(fileInfo){var loader=$.Deferred(),fReader=new FileReader();fReader.onload=function(e){loader.resolve(e.target.result);};fReader.onerror=loader.reject;fReader.onprogress=loader.notify;fReader.readAsDataURL(fileInfo);return loader.promise();};$.fn.cleanHtml=function(){var html=$(this).html();return html&&html.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,'');};$.fn.wysiwyg=function(userOptions){var editor=this,selectedRange,options,toolbarBtnSelector,updateToolbar=function(){if(options.activeToolbarClass){$(options.toolbarSelector).find(toolbarBtnSelector).each(function(){var command=$(this).data(options.commandRole);if(document.queryCommandState(command)){$(this).addClass(options.activeToolbarClass);}else{$(this).removeClass(options.activeToolbarClass);}});}},execCommand=function(commandWithArgs,valueArg){var commandArr=commandWithArgs.split(' '),command=commandArr.shift(),args=commandArr.join(' ')+(valueArg||'');document.execCommand(command,0,args);updateToolbar();},bindHotkeys=function(hotKeys){$.each(hotKeys,function(hotkey,command){editor.keydown(hotkey,function(e){if(editor.attr('contenteditable')&&editor.is(':visible')){e.preventDefault();e.stopPropagation();execCommand(command);}}).keyup(hotkey,function(e){if(editor.attr('contenteditable')&&editor.is(':visible')){e.preventDefault();e.stopPropagation();}});});},getCurrentRange=function(){var sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){return sel.getRangeAt(0);}},saveSelection=function(){selectedRange=getCurrentRange();},restoreSelection=function(){var selection=window.getSelection();if(selectedRange){try{selection.removeAllRanges();}catch(ex){document.body.createTextRange().select();document.selection.empty();}
selection.addRange(selectedRange);}},insertFiles=function(files){editor.focus();$.each(files,function(idx,fileInfo){if(/^image\//.test(fileInfo.type)){$.when(readFileIntoDataUrl(fileInfo)).done(function(dataUrl){execCommand('insertimage',dataUrl);}).fail(function(e){options.fileUploadError("file-reader",e);});}else{options.fileUploadError("unsupported-file-type",fileInfo.type);}});},markSelection=function(input,color){restoreSelection();if(document.queryCommandSupported('hiliteColor')){document.execCommand('hiliteColor',0,color||'transparent');}
saveSelection();input.data(options.selectionMarker,color);},bindToolbar=function(toolbar,options){toolbar.find(toolbarBtnSelector).click(function(){restoreSelection();editor.focus();execCommand($(this).data(options.commandRole));saveSelection();});toolbar.find('[data-toggle=dropdown]').click(restoreSelection);toolbar.find('input[type=text][data-'+options.commandRole+']').on('webkitspeechchange change',function(){var newValue=this.value;this.value='';restoreSelection();if(newValue){editor.focus();execCommand($(this).data(options.commandRole),newValue);}
saveSelection();}).on('focus',function(){var input=$(this);if(!input.data(options.selectionMarker)){markSelection(input,options.selectionColor);input.focus();}}).on('blur',function(){var input=$(this);if(input.data(options.selectionMarker)){markSelection(input,false);}});toolbar.find('input[type=file][data-'+options.commandRole+']').change(function(){restoreSelection();if(this.type==='file'&&this.files&&this.files.length>0){insertFiles(this.files);}
saveSelection();this.value='';});},initFileDrops=function(){editor.on('dragenter dragover',false).on('drop',function(e){var dataTransfer=e.originalEvent.dataTransfer;e.stopPropagation();e.preventDefault();if(dataTransfer&&dataTransfer.files&&dataTransfer.files.length>0){insertFiles(dataTransfer.files);}});};options=$.extend({},$.fn.wysiwyg.defaults,userOptions);toolbarBtnSelector='a[data-'+options.commandRole+'],button[data-'+options.commandRole+'],input[type=button][data-'+options.commandRole+']';bindHotkeys(options.hotKeys);if(options.dragAndDropImages){initFileDrops();}
bindToolbar($(options.toolbarSelector),options);editor.attr('contenteditable',true).on('mouseup keyup mouseout',function(){saveSelection();updateToolbar();});$(window).bind('touchend',function(e){var isInside=(editor.is(e.target)||editor.has(e.target).length>0),currentRange=getCurrentRange(),clear=currentRange&&(currentRange.startContainer===currentRange.endContainer&&currentRange.startOffset===currentRange.endOffset);if(!clear||isInside){saveSelection();updateToolbar();}});return this;};$.fn.wysiwyg.defaults={hotKeys:{},toolbarSelector:'[data-role=editor-toolbar]',commandRole:'edit',activeToolbarClass:'btn-info',selectionMarker:'edit-focus-marker',selectionColor:'darkgrey',dragAndDropImages:true,fileUploadError:function(reason,detail){console.log("File upload error",reason,detail);}};}(window.jQuery));Detector={canvas:!!window.CanvasRenderingContext2D,webgl:(function(){try{return!!window.WebGLRenderingContext&&!!document.createElement('canvas').getContext('experimental-webgl');}catch(e){return false;}})(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var domElement=document.createElement('div');domElement.style.fontFamily='monospace';domElement.style.fontSize='13px';domElement.style.textAlign='center';domElement.style.background='#eee';domElement.style.color='#000';domElement.style.padding='1em';domElement.style.width='475px';domElement.style.margin='5em auto 0';if(!this.webgl){domElement.innerHTML=window.WebGLRenderingContext?['Sorry, your graphics card doesn\'t support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>'].join('\n'):['Sorry, your browser doesn\'t support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a><br/>','Please try with','<a href="http://www.google.com/chrome">Chrome 10</a>, ','<a href="http://www.mozilla.com/en-US/firefox/all-beta.html">Firefox 4</a> or','<a href="http://nightly.webkit.org/">Safari 6</a>'].join('\n');}
return domElement;},addGetWebGLMessage:function(parameters){var parent,id,domElement;parameters=parameters||{};parent=parameters.parent!==undefined?parameters.parent:document.body;id=parameters.id!==undefined?parameters.id:'oldie';domElement=Detector.getWebGLErrorMessage();domElement.id=id;parent.appendChild(domElement);}};﻿var FactoryIoC=(function(){function FactoryIoC(strType){this.listClass=[];this.init(strType);};FactoryIoC.prototype={init:function(strType){switch(strType){case'analysis':this.initAnalysisModule();break;case'dashboard':this.initDashboardModule();break;default:break;}},add:function(entityClass){this.listClass.push(entityClass);},getModel:function(strModelName){for(var i=0,len=this.listClass.length;i<len;i++){if(strModelName.toLowerCase()==this.listClass[i].name.toLowerCase()){return this.listClass[i];}}
return null;},getList:function(){return this.listClass;},initAnalysisModule:function(){this.add(AnlzTendency);this.add(AnlzSpectrum);this.add(AnlzScatter);this.add(AnlzHistoryCompare);this.add(AnlzHistoryCompare_Line);this.add(AnlzStack);this.add(AnlzPieRealtime);this.add(AnlzEnergy);this.add(AnlzCluster);this.add(AnlzCluster_AHU);this.add(AnlzCluster_Chiller);},initDashboardModule:function(){this.add(ModalNone);this.add(ModalAnalysis);this.add(ModalHistoryChart);this.add(ModalHistoryChartNormal);this.add(ModalHistoryChartEnergyConsume);this.add(ModalHistoryChartYearOnYearLine);this.add(ModalHistoryChartYearOnYearBar);this.add(ModalChart);this.add(ModalRealtimePieEnegBrkd);this.add(ModalRealtimeLineOutdoor);this.add(ModalRealtimeBarSub);this.add(ModalRealtimeGauge);this.add(ModalRealtimeBarEnegBrkd);this.add(ModalMultiple);this.add(ModalWeather);this.add(ModalKPIChart);this.add(ModalObserver);this.add(ModalPredictPointLine);this.add(ModalNote);this.add(ModalRank);this.add(ModalRankNormal);this.add(ModalMix);this.add(ModalHtml);this.add(ModalChartCustom);this.add(ModalPointKPI);this.add(ModalReportChapter);}}
return FactoryIoC;})();﻿var ScreenManager=(function(){var slice=Array.prototype.slice;var m_dictScreen={};var panPrjSel;var preScreenName,nowScreenName;var isMobile=false;if(navigator.userAgent.match(/iP(ad|hone|od)|Android|Version/i))isMobile=true;if(!isMobile&&window.history&&history.replaceState){$(window).on("popstate",function(event){var curId=location.hash;if(Boolean(curId)){curId=curId.substring(1,curId.length);if(Boolean(m_dictScreen[curId])){preScreenName=nowScreenName;nowScreenName=m_dictScreen[curId].name;if('PaneProjectSelector'==preScreenName&&'PaneProjectSelector'!=nowScreenName){if(Boolean(panPrjSel)&&Boolean(AppConfig.projectId)){panPrjSel.initProject(AppConfig.projectId,AppConfig.projectName,AppConfig.projectShowName,m_dictScreen[curId].navSelPageId);}}
else{var navLi=$('#ulPages').children('li');if(Boolean(navLi)&&navLi.length){navLi.filter('.active').attr('class','');var navBtnA=navLi.children('a');for(var i=0,len=navBtnA.length;i<len;i++){var item=navBtnA.eq(i);if(item.attr('pageid')==m_dictScreen[curId].navSelPageId){item.closest('li').attr('class','active');break;}}}}
m_dictScreen[curId].screen.show();}}
else{m_dictScreen={};location.href=location.origin;}});}
function ScreenManager(){};ScreenManager.show=function(){if(arguments.length===0){return;}
var screenClass=arguments[0];if(typeof screenClass!=='function'){return;}
var screenObj=Object.create(screenClass.prototype);if(ScreenCurrent){window.onresize=null;if(ScreenCurrent.close()===false){return;}}
ScreenCurrent=(screenClass.apply(screenObj,slice.call(arguments,1))||screenObj);if(ScreenCurrent.onresize)window.onresize=ScreenCurrent.onresize;ScreenCurrent.show();if(!isMobile&&'IndexScreen'!=screenClass.name){nowScreenName=screenClass.name;var navSelPageId=Boolean(arguments[1])?arguments[1]:null;var id=+new Date();location.hash=id;m_dictScreen[id]={'screen':ScreenCurrent,'name':screenClass.name,'navSelPageId':navSelPageId};history.replaceState(null,'',window.location.href);}
if('PaneProjectSelector'==screenClass.name&&Boolean(ScreenCurrent)){panPrjSel=ScreenCurrent;}};ScreenManager.clearHistory=function(){if(isMobile)return;m_dictScreen={};location.hash='';};return ScreenManager;})();﻿
var beop=beop||{};beop.constant={project_img_path:'/static/images/project_img/',project_default_img:'default.jpg'};var ObjectId=function(){var hex8=('00000000'+Math.floor(Math.random()*0xFFFFFFFF).toString(16)).slice(-8);var userId=('000'+(AppConfig.userId||'000')).slice(-3);var timestamp=new Date().valueOf();return hex8+userId+timestamp;};var FullScreenManager=(function(){var manager=Object.create({init:function(){var _this=this;$(document).off('webkitfullscreenchange');$(document).on('webkitfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('mozfullscreenchange');$(document).on('mozfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});$(document).off('msfullscreenchange');$(document).on('msfullscreenchange',function(){var isFullScreen=!!document.webkitFullscreenElement;if(isFullScreen){_this.onFullScreenEnter();}else{_this.onFullScreenOut();}});if(typeof onError==='function'){$(document).off('webkitfullscreenerror');$(document).on('webkitfullscreenerror',this.onFullScreenError);$(document).off('mozfullscreenerror');$(document).on('mozfullscreenerror',this.onFullScreenError);$(document).off('msfullscreenerror');$(document).on('msfullscreenerror',this.onFullScreenError);}},onFullScreenEnter:function(){},onFullScreenOut:function(){},onFullScreenError:function(){},toggle:function(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement&&!document.msFullscreenElement){if(document.documentElement.requestFullscreen){document.documentElement.requestFullscreen();}else if(document.documentElement.msRequestFullscreen){document.documentElement.msRequestFullscreen();}else if(document.documentElement.mozRequestFullScreen){document.documentElement.mozRequestFullScreen();}else if(document.documentElement.webkitRequestFullscreen){document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}}else{if(document.exitFullscreen){document.exitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}}}});manager.init();return manager;}());function StringBuilder(){this.data=Array("");}
StringBuilder.prototype.append=function(){this.data.push(arguments[0]);return this;};StringBuilder.prototype.toString=function(){return this.data.join("");};StringBuilder.prototype.getLength=function(){return this.data.length;};if(!String.prototype.format){String.prototype.format=function(){if(arguments[0]===undefined){return'';}
if(arguments[0].constructor===Array){var args=arguments[0];}else{var args=arguments;}
return this.replace(/{(\d+)}/g,function(match,number){return typeof args[number]!='undefined'?args[number]:match;});};}
if(!String.prototype.formatEL){String.prototype.formatEL=function(o){var str=this.toString();if(!str||!o)return'';for(var p in o){if(o.hasOwnProperty(p)){str=str.replace(new RegExp('{'+p+'}','g'),o[p]);}}
return str;};}
String.prototype.toDate=function(){var str=this;if(str.indexOf('-')>-1)
str=str.replace('-','/').replace('-','/');return new Date(str);}
Number.prototype.toDate=function(){return new Date(this);};function Alert(targetElement,type,msg){this.element=targetElement;this.str=new StringBuilder();this.str.append('<div class="alert alert-').append(type).append(' alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>').append('<div class="alert-msg">'+msg+'</div>').append('</div>');this.$alert=$(this.str.toString());}
Alert.danger=function(targetElement,msg){return new Alert(targetElement,Alert.type.danger,msg).show();};Alert.warning=function(targetElement,msg){return new Alert(targetElement,Alert.type.warning,msg).show();};Alert.success=function(targetElement,msg){return new Alert(targetElement,Alert.type.success,msg).show();};Alert.info=function(targetElement,msg){return new Alert(targetElement,Alert.type.info,msg).show();};Alert.type={danger:'danger',warning:'warning',success:'success',info:'info'};Alert.prototype.show=function(duration){if(duration){var _this=this;setTimeout(function(){_this.close();},duration);}
$(this.element).append(this.$alert);return this;};Alert.prototype.close=function(){var _this=this;this.$alert.fadeOut(3000,function(){_this.$alert.remove();_this=null;});};Alert.prototype.setMessage=function(msg){if(!msg){return false}
this.$alert.find('.alert-msg').text(msg);};Alert.prototype.setStyle=function(style){if(style&&typeof style!=='string'){this.$alert.css(style);}
return this;};Alert.prototype.showAtTop=function(duration){this.setStyle({position:'absolute',top:0,left:0,right:0,margin:'auto',width:'50%',textAlign:'center'})
this.show(duration);};function showDialog(url){return WebAPI.get(url).done(function(resultHtml){$("#dialogContent").html(resultHtml);$('#dialogModal').modal({});});}
function clone(obj){if(obj==null||typeof(obj)!='object')
return obj;var temp=obj.constructor();for(var key in obj){if(obj.hasOwnProperty(key)){temp[key]=clone(obj[key]);}}
return temp;}
Date.prototype.format=function(fmt){var o={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours()%12==0?12:this.getHours()%12,"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};var week={"0":"/u65e5","1":"/u4e00","2":"/u4e8c","3":"/u4e09","4":"/u56db","5":"/u4e94","6":"/u516d"};if(/(y+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));}
if(/(E+)/.test(fmt)){fmt=fmt.replace(RegExp.$1,((RegExp.$1.length>1)?(RegExp.$1.length>2?"/u661f/u671f":"/u5468"):"")+week[this.getDay()+""]);}
for(var k in o){if(new RegExp("("+k+")").test(fmt)){fmt=fmt.replace(RegExp.$1,(RegExp.$1.length==1)?(o[k]):(("00"+o[k]).substr((""+o[k]).length)));}}
return fmt;}
var DateUtil=(function(){var dateLocale={month:{en:{month_names:['January','February','March','April','May','June','July','August','September','October','November','December'],month_names_short:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']},zh:{month_names:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月'],month_names_short:['一月','二月','三月','四月','五月','六月','七月','八月','九月','十月','十一月','十二月']}}};function getWeekNumber(d){d=new Date(+d);d.setHours(0,0,0);d.setDate(d.getDate()+4-(d.getDay()||7));var yearStart=new Date(d.getFullYear(),0,1);var weekNo=Math.ceil((((d-yearStart)/86400000)+1)/7)
return[d.getFullYear(),weekNo];}
function getLastWeekNumberOf(y,w){w-=1;if(w===0){y=y-1;w=52;}
return[y,w];}
function getNextWeekNumberOf(y,w){w+=1;if(w===53){y+=1;w=1;}
return[y,w];}
function isLeapYear(y){if(Object.prototype.toString.call(y)==='[object Date]'){y=y.getUTCFullYear();}
return((y%4===0)&&(y%100!==0))||(y%400===0);}
function daysInMonth(dt){var m=dt.getUTCMonth();if(m===1){return isLeapYear(dt)?29:28;}
return[31,28,31,30,31,30,31,31,30,31,30,31][m];}
function getFirstDayOfWeek(year,week){var d=new Date(year,0,1),offset=d.getTimezoneOffset();d.setDate(d.getDate()+4-(d.getDay()||7));d.setTime(d.getTime()+7*24*60*60*1000*(week+(year==d.getFullYear()?-1:0)));d.setTime(d.getTime()
+(d.getTimezoneOffset()-offset)*60*1000);d.setDate(d.getDate()-3);return d;}
function getDateRangeOnWeekNumber(year,week){if(!year||!week){return;}
var firstDay=getFirstDayOfWeek(year,week),lastDay=new Date(firstDay);lastDay.setDate(firstDay.getDate()+6);return[firstDay,lastDay];}
function getMonthName(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names:dateLocale.month['en'].month_names;return monthList[index];}
function getMonthNameShort(index,language){var monthList=language&&language in dateLocale.month?dateLocale.month[language].month_names_short:dateLocale.month['en'].month_names_short;return monthList[index];}
function getLastMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===1){return 12;}else{return currentMonth-1;}}
function getNextMonth(currentMonth){if(!currentMonth){currentMonth=new Date().getMonth()+1;}
if(currentMonth===12){return 1;}else{return currentMonth+1;}}
function getRelativeDateInfo(date1,date2){var now=new Date();var lang=I18n.type;var value1,value2,ts,info;if(!date1&&!date2)return'';value1=(date1||now).valueOf();value2=(date2||now).valueOf();ts=Math.floor(Math.abs(value1-value2)/1000);switch(true){case ts<60:info=ts+(ts===1?' second':' seconds');break;case ts<60*60:ts=Math.floor(ts/60);info=ts+(ts===1?' minute':' minutes');break;case ts<60*60*24:ts=Math.floor(ts/(60*60));info=ts+(ts===1?' hour':' hours');break;case ts<60*60*24*365:ts=Math.floor(ts/(60*60*24));info=ts+(ts===1?' day':' days');break;default:ts=Math.floor(ts/(60*60*24*365));info=ts+(ts===1?' year':' years');break;}
info+=value1>value2?' ago':' later';if(lang==='zh'){info=info.replace(/\s(seconds?|minutes?|hours?|days?|years?)\s(ago|later)$/,function($0,$1,$2){var rs='';if($1.indexOf('second')>-1)rs+='秒钟';if($1.indexOf('minute')>-1)rs+='分钟';if($1.indexOf('hour')>-1)rs+='小时';if($1.indexOf('day')>-1)rs+='天';if($1.indexOf('year')>-1)rs+='年';if($2==='ago')rs+='前';if($2==='later')rs+='后';return rs;});}
return info;}
return{getWeekNumber:getWeekNumber,isLeapYear:isLeapYear,daysInMonth:daysInMonth,getLastWeekNumberOf:getLastWeekNumberOf,getNextWeekNumberOf:getNextWeekNumberOf,getDateRangeOnWeekNumber:getDateRangeOnWeekNumber,getFirstDayOfWeek:getFirstDayOfWeek,getMonthName:getMonthName,getMonthNameShort:getMonthNameShort,getLastMonth:getLastMonth,getNextMonth:getNextMonth,getRelativeDateInfo:getRelativeDateInfo}})();var StringUtil=(function(){var HTML_ENTITIES={'&':'&amp;','>':'&gt;','<':'&lt;','"':'&quot;',"'":'&#39;','`':'&#x60;'},HTML_ENTITIES_INVERT=invert(HTML_ENTITIES);function invert(obj){var result={},keys=Object.keys(obj);for(var i=0,length=keys.length;i<length;i++){result[obj[keys[i]]]=keys[i];}
return result;};function padLeft(oldStr,padNum,padStr){if(!padStr){return oldStr;}
return Array(padNum-String(oldStr).length+1).join(padStr)+oldStr;}
function htmlEscape(text){if(!text){return text}
var source='(?:'+Object.keys(HTML_ENTITIES).join('|')+')',replaceRegexp=RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES[character];});}
function htmlUnEscape(text){if(!text){return text}
var source='(?:'+Object.keys(HTML_ENTITIES_INVERT).join('|')+')',replaceRegexp=RegExp(source,'g');return text.replace(replaceRegexp,function(character){return HTML_ENTITIES_INVERT[character];});}
var getI18nProjectName=function(project){if(!I18n||!project){return'';}
var result='';switch(I18n.type){case'en':{result=project.name_english;break;}
case'zh':{result=project.name_cn;break;}
default:{result=project.name_english;}}
return result||'';};return{padLeft:padLeft,htmlEscape:htmlEscape,htmlUnEscape:htmlUnEscape,getI18nProjectName:getI18nProjectName}})();var BEOPUtil=(function(){var jsType={function:typeof $.noop,number:typeof 0,string:typeof'',undefined:typeof undefined};var projectImgPath=beop.constant.project_img_path;var setRelativePosition=function($obj,$target,topOffset,leftOffset){var offset=$obj.offset();var topOffset=topOffset||10;var leftOffset=leftOffset||5;var top=offset.top+topOffset;var left=offset.left+$obj.width()+leftOffset;$target.css({"left":left,"top":top});};var projectDefaultImgPath=projectImgPath+beop.constant.project_default_img;var getProjectImgPath=function(project){if(!project){return;}else{return project.pic?projectImgPath+project.pic:projectDefaultImgPath;}};function getFunctionName(func){if(!func||typeof func!=jsType.function){return'';}
var ret=func.toString();ret=ret.substr('function '.length);ret=ret.substr(0,ret.indexOf('('));return ret;}
function isUndefined(obj){return typeof obj===jsType.undefined;}
return{setRelativePosition:setRelativePosition,getProjectImgPath:getProjectImgPath,getFunctionName:getFunctionName,isUndefined:isUndefined}})();(function(){var beop_tmpl_cache={};this.beopTmpl=function tmpl(str,data){var fn=!/\W/.test(str)?beop_tmpl_cache[str]=beop_tmpl_cache[str]||tmpl(document.getElementById(str).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};"+"with(obj){p.push('"+
str.replace(/[\r\t\n]/g," ").split(/<!/).join("\t").replace(/((^|!>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)!>/g,"',$1,'").split("\t").join("');").split(/!>/).join("p.push('").split("\r").join("\\'")
+"');}return p.join('');");return data?fn(data):fn;};})();var SidebarMenuEffect=(function(){function SidebarMenuEffect(){}
SidebarMenuEffect.prototype.init=function(center,left,right){var _this=this;this.$paneCt=$(center);this.$leftBtn=$(center).find('#leftCt');this.$rightBtn=$(center).find('#rightCt');var container=document.getElementById('st-container'),buttons=Array.prototype.slice.call(document.querySelectorAll('.sideTrans')),refresh=function(){var leftCol=0,rightCol=0,centerCol=0;var leftArrow='<span class="glyphicon glyphicon-chevron-left"></span>';var rightArrow='<span class="glyphicon glyphicon-chevron-right"></span>';if(_this.$leftBtn.length>0){if(container.className.indexOf('st-effect-7')>0){var prev=_this.$paneCt.prev('div')[0];if(prev&&prev.className.indexOf('col-')>-1){leftCol=parseInt(prev.classList[0].split('-')[2]);}else{leftCol=0;}
_this.$leftBtn.removeClass('leftCtClose').addClass('leftCtOpen').html(leftArrow);}else{leftCol=0;_this.$leftBtn.removeClass('leftCtOpen').addClass('leftCtClose').html(rightArrow);}}
if(_this.$rightBtn.length>0){if(container.className.indexOf('st-effect-1')>0){var next=_this.$paneCt.next('div')[0];if(next&&next.className.indexOf('col-')>-1){rightCol=parseInt(next.classList[0].split('-')[2]);}else{rightCol=0;}
_this.$rightBtn.removeClass('rightCtClose').addClass('rightCtOpen').html(rightArrow);}else{rightCol=0;_this.$rightBtn.removeClass('rightCtOpen').addClass('rightCtClose').html(leftArrow);}}
centerCol=12-leftCol-rightCol;_this.$paneCt.removeClass().addClass('col-sm-'+centerCol+' st-content');};buttons.forEach(function(el,i){var effect=el.getAttribute('data-effect');el.addEventListener('click',function(ev){var target=ev.target.getAttribute('data-effect')!=null?ev.target.getAttribute('data-effect'):ev.target.parentNode.getAttribute('data-effect');var stCtClass=document.getElementById('st-container').className;if(stCtClass.indexOf(target)<0){ev.stopPropagation();ev.preventDefault();container.classList.add(effect);setTimeout(function(){if($(container.children[0]).children('div').length==3){container.classList.add('st-menu-open');}
refresh();},250);}else{container.classList.remove(target)
refresh();}});});}
return SidebarMenuEffect;})();(function(window){{var unknown='-';var screenSize='';if(screen.width){var width=(screen.width)?screen.width:'';var height=(screen.height)?screen.height:'';screenSize+=''+width+" x "+height;}
var nVer=navigator.appVersion;var nAgt=navigator.userAgent;var browser=navigator.appName;var version=''+parseFloat(navigator.appVersion);var majorVersion=parseInt(navigator.appVersion,10);var nameOffset,verOffset,ix;if((verOffset=nAgt.indexOf('Opera'))!=-1){browser='Opera';version=nAgt.substring(verOffset+6);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('MSIE'))!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(verOffset+5);}
else if((verOffset=nAgt.indexOf('Chrome'))!=-1){browser='Chrome';version=nAgt.substring(verOffset+7);}
else if((verOffset=nAgt.indexOf('Safari'))!=-1){browser='Safari';version=nAgt.substring(verOffset+7);if((verOffset=nAgt.indexOf('Version'))!=-1){version=nAgt.substring(verOffset+8);}}
else if((verOffset=nAgt.indexOf('Firefox'))!=-1){browser='Firefox';version=nAgt.substring(verOffset+8);}
else if(nAgt.indexOf('Trident/')!=-1){browser='Microsoft Internet Explorer';version=nAgt.substring(nAgt.indexOf('rv:')+3);}
else if((nameOffset=nAgt.lastIndexOf(' ')+1)<(verOffset=nAgt.lastIndexOf('/'))){browser=nAgt.substring(nameOffset,verOffset);version=nAgt.substring(verOffset+1);if(browser.toLowerCase()==browser.toUpperCase()){browser=navigator.appName;}}
if((ix=version.indexOf(';'))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(' '))!=-1)version=version.substring(0,ix);if((ix=version.indexOf(')'))!=-1)version=version.substring(0,ix);majorVersion=parseInt(''+version,10);if(isNaN(majorVersion)){version=''+parseFloat(navigator.appVersion);majorVersion=parseInt(navigator.appVersion,10);}
var mobile=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(nVer);var cookieEnabled=(navigator.cookieEnabled)?true:false;if(typeof navigator.cookieEnabled=='undefined'&&!cookieEnabled){document.cookie='testcookie';cookieEnabled=(document.cookie.indexOf('testcookie')!=-1)?true:false;}
var os=unknown;var clientStrings=[{s:'Windows 3.11',r:/Win16/},{s:'Windows 95',r:/(Windows 95|Win95|Windows_95)/},{s:'Windows ME',r:/(Win 9x 4.90|Windows ME)/},{s:'Windows 98',r:/(Windows 98|Win98)/},{s:'Windows CE',r:/Windows CE/},{s:'Windows 2000',r:/(Windows NT 5.0|Windows 2000)/},{s:'Windows XP',r:/(Windows NT 5.1|Windows XP)/},{s:'Windows Server 2003',r:/Windows NT 5.2/},{s:'Windows Vista',r:/Windows NT 6.0/},{s:'Windows 7',r:/(Windows 7|Windows NT 6.1)/},{s:'Windows 8.1',r:/(Windows 8.1|Windows NT 6.3)/},{s:'Windows 8',r:/(Windows 8|Windows NT 6.2)/},{s:'Windows NT 4.0',r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:'Windows ME',r:/Windows ME/},{s:'Android',r:/Android/},{s:'Open BSD',r:/OpenBSD/},{s:'Sun OS',r:/SunOS/},{s:'Linux',r:/(Linux|X11)/},{s:'iOS',r:/(iPhone|iPad|iPod)/},{s:'Mac OS X',r:/Mac OS X/},{s:'Mac OS',r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:'QNX',r:/QNX/},{s:'UNIX',r:/UNIX/},{s:'BeOS',r:/BeOS/},{s:'OS/2',r:/OS\/2/},{s:'Search Bot',r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}];for(var id in clientStrings){var cs=clientStrings[id];if(cs.r.test(nAgt)){os=cs.s;break;}}
var osVersion=unknown;if(/Windows/.test(os)){osVersion=/Windows (.*)/.exec(os)[1];os='Windows';}
switch(os){case'Mac OS X':osVersion=/Mac OS X (10[\.\_\d]+)/.exec(nAgt)[1];break;case'Android':osVersion=/Android ([\.\_\d]+)/.exec(nAgt)[1];break;case'iOS':osVersion=/OS (\d+)_(\d+)_?(\d+)?/.exec(nVer);osVersion=osVersion[1]+'.'+osVersion[2]+'.'+(osVersion[3]|0);break;}}
window.jscd={screen:screenSize,browser:browser,browserVersion:version,mobile:mobile,os:os,osVersion:osVersion,cookies:cookieEnabled};}(this));var getWysiwyg=function(hasEditor){hasEditor=hasEditor===undefined?true:hasEditor;var wysiwyg='\
        <div class="btn-toolbar" data-role="editor-toolbar" data-target="#editor">\
          <div class="btn-group">\
            <a class="btn dropdown-toggle" data-toggle="dropdown" title="Font" data-original-title="Font"><i class="icon-font"></i><b class="caret"></b></a>\
              <ul class="dropdown-menu">\
              <li><a data-edit="fontName Serif" style="font-family:\'Serif\'">Serif</a></li><li><a data-edit="fontName Sans" style="font-family:\'Sans\'">Sans</a></li><li><a data-edit="fontName Arial" style="font-family:\'Arial\'">Arial</a></li><li><a data-edit="fontName Arial Black" style="font-family:\'Arial Black\'">Arial Black</a></li><li><a data-edit="fontName Courier" style="font-family:\'Courier\'">Courier</a></li><li><a data-edit="fontName Courier New" style="font-family:\'Courier New\'">Courier New</a></li><li><a data-edit="fontName Comic Sans MS" style="font-family:\'Comic Sans MS\'">Comic Sans MS</a></li><li><a data-edit="fontName Helvetica" style="font-family:\'Helvetica\'">Helvetica</a></li><li><a data-edit="fontName Impact" style="font-family:\'Impact\'">Impact</a></li><li><a data-edit="fontName Lucida Grande" style="font-family:\'Lucida Grande\'">Lucida Grande</a></li><li><a data-edit="fontName Lucida Sans" style="font-family:\'Lucida Sans\'">Lucida Sans</a></li><li><a data-edit="fontName Tahoma" style="font-family:\'Tahoma\'">Tahoma</a></li><li><a data-edit="fontName Times" style="font-family:\'Times\'">Times</a></li><li><a data-edit="fontName Times New Roman" style="font-family:\'Times New Roman\'">Times New Roman</a></li><li><a data-edit="fontName Verdana" style="font-family:\'Verdana\'">Verdana</a></li></ul>\
            </div>\
          <div class="btn-group">\
            <a class="btn dropdown-toggle" data-toggle="dropdown" title="Font Size" data-original-title="Font Size"><i class="icon-text-height"></i>&nbsp;<b class="caret"></b></a>\
              <ul class="dropdown-menu">\
              <li><a data-edit="fontSize 5"><font size="5">Huge</font></a></li>\
              <li><a data-edit="fontSize 3"><font size="3">Normal</font></a></li>\
              <li><a data-edit="fontSize 1"><font size="1">Small</font></a></li>\
              </ul>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="bold" title="Bold (Ctrl/Cmd+B)" data-original-title="Bold (Ctrl/Cmd+B)"><i class="icon-bold"></i></a>\
            <a class="btn" data-edit="italic" title="Italic (Ctrl/Cmd+I)" data-original-title="Italic (Ctrl/Cmd+I)"><i class="icon-italic"></i></a>\
            <a class="btn" data-edit="strikethrough" title="Strikethrough" data-original-title="Strikethrough"><i class="icon-strikethrough"></i></a>\
            <a class="btn" data-edit="underline" title="Underline (Ctrl/Cmd+U)" data-original-title="Underline (Ctrl/Cmd+U)"><i class="icon-underline"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="insertunorderedlist" title="Bullet list" data-original-title="Bullet list"><i class="icon-list-ul"></i></a>\
            <a class="btn" data-edit="insertorderedlist" title="Number list" data-original-title="Number list"><i class="icon-list-ol"></i></a>\
            <a class="btn" data-edit="outdent" title="Reduce indent" data-original-title="Reduce indent (Shift+Tab)"><i class="icon-indent-left"></i></a>\
            <a class="btn" data-edit="indent" title="Indent" data-original-title="Indent (Tab)"><i class="icon-indent-right"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="justifyleft" title="Align Left" data-original-title="Align Left (Ctrl/Cmd+L)"><i class="icon-align-left"></i></a>\
            <a class="btn" data-edit="justifycenter" title="Center" data-original-title="Center (Ctrl/Cmd+E)"><i class="icon-align-center"></i></a>\
            <a class="btn" data-edit="justifyright" title="Align Right" data-original-title="Align Right (Ctrl/Cmd+R)"><i class="icon-align-right"></i></a>\
            <a class="btn btn-info" data-edit="justifyfull" title="Justify" data-original-title="Justify (Ctrl/Cmd+J)"><i class="icon-align-justify"></i></a>\
          </div>\
          <div class="btn-group" style="display:none;">\
              <a class="btn dropdown-toggle" data-toggle="dropdown" title="Hyperlink" data-original-title="Hyperlink"><i class="icon-link"></i></a>\
                <div class="dropdown-menu input-append">\
                    <input class="span2" placeholder="URL" type="text" data-edit="createLink">\
                    <button class="btn" type="button">Add</button>\
            </div>\
            <a class="btn" data-edit="unlink" title="Remove Hyperlink" data-original-title="Remove Hyperlink"><i class="icon-cut"></i></a>\
          </div>\
          <div class="btn-group">\
            <a class="btn" title="Insert picture" id="pictureBtn" data-original-title="Insert picture (or just drag &amp; drop)"><i class="icon-picture"></i></a>\
            <input type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage" style="opacity: 0; position: absolute; top: 0px; left: 0px; width: 41px; height: 30px;">\
          </div>\
          <div class="btn-group">\
            <a class="btn" data-edit="undo" title="Undo (Ctrl/Cmd+Z)" data-original-title="Undo (Ctrl/Cmd+Z)"><i class="icon-undo"></i></a>\
            <a class="btn" data-edit="redo" title="Redo (Ctrl/Cmd+Y)" data-original-title="Redo (Ctrl/Cmd+Y)"><i class="icon-repeat"></i></a>\
          </div>\
          <input type="text" data-edit="inserttext" id="voiceBtn" x-webkit-speech="" style="display: none;">\
        </div>';wysiwyg+=hasEditor?'<div id="editor" contenteditable="true" class="form-control gray-scrollbar">':'';wysiwyg+='</div>';return wysiwyg;}
﻿var WebAPI=(function(){var siteId;switch(window.location.hostname){case'beop.rnbtech.com.hk':siteId='b79c068f77198848e22fe79758836e53';break;case'beop6.rnbtech.com.hk':siteId='f1f6b2b9e6b64592c0b4cb5e9b8bd79e';break;case'beopdemo.rnbtech.com.hk':siteId='ac0df98f274d9a5980a571297248d80b';break;default:break;}
(function(){if(siteId){var hm=document.createElement("script");hm.src="//hm.baidu.com/hm.js?"+siteId;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);}})();var mockList={'/static/mock/analysis_workspace_saveLayout.json':/\/analysis\/workspace\/saveLayout\/\d+\/[01]/i,'/static/mock/analysis_template_get.json':/\/analysis\/template\/get\/\d+/i};function mock(url){var match=null;for(var i in mockList){match=url.match(mockList[i]);if(match!==null)return i;}
return url;}
function WebAPI(){}
WebAPI.isMock=false;$.ajaxSetup({dataFilter:function(result,type){if(result&&result.substring(2,7)=='error'){var data=JSON.parse(result);if(data.error=='token_invalid'){console.log(this.url+' ('+data.error+': code"'+data.msg+'")');if(confirm(i18n_resource.error.token[data.msg]+'. '+i18n_resource.error.relogin+'.')){location.reload();}
throw data.error;}}
return result;}});WebAPI.post=function(url,data,isMock){var mockUrl;isMock=isMock===undefined?WebAPI.isMock:isMock;if(isMock){mockUrl=mock(url);if(url!==mockUrl)return this.get(mockUrl,false);}
return $.ajax({url:url,type:'POST',data:JSON.stringify(data),contentType:'application/json'});};WebAPI.get=function(url,isMock){isMock=isMock===undefined?WebAPI.isMock:isMock;url=isMock?mock(url):url;if(_hmt&&url.indexOf('.html')>0)_hmt.push(['_trackPageview',url]);return $.ajax({url:url,type:'Get',contentType:'application/json'});};WebAPI.getHistoryDS=function(callback){};WebAPI.getHistory=function(callback){};return WebAPI;})();(function(){'use strict';var indexedDB=indexedDB||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(!indexedDB){return;}
function _initStorage(options){var _this=this;this._dbInfo=$.extend({db:null},options);var promise=$.Deferred();(function(){var _this=this;var dbInfo=this._dbInfo;var openreq=indexedDB.open(dbInfo.name,dbInfo.version);openreq.onerror=function(){promise.reject(openreq.error);};openreq.onsuccess=function(){dbInfo.db=openreq.result;promise.resolve();};openreq.onupgradeneeded=function(){var names=openreq.result.objectStoreNames;var length,key;var indexOf=([]).indexOf;if(indexOf.call(names,'cache')>-1){openreq.result.deleteObjectStore('cache');}
if(indexOf.call(names,'datasource')>-1){openreq.result.deleteObjectStore('datasource');}
if(indexOf.call(names,'thumbnail')>-1){openreq.result.deleteObjectStore('thumbnail');}
if(indexOf.call(names,'buffer')===-1){openreq.result.createObjectStore('buffer');}
openreq.result.createObjectStore('datasource');openreq.result.createObjectStore('thumbnail');for(var i=0,len=localStorage.length;i<len;i++){key=localStorage.key(i);if(key.indexOf('workSpacePicStorageEnable')===0){localStorage.removeItem(key);}}};}).call(this);}
function length(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.count();req.onsuccess=function(){promise.resolve(req.result);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.get(key);req.onsuccess=function(){var value=req.result;value=value===undefined?null:value;promise.resolve(value);};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var result={};var promise=this.iterate(function(key,value,i){if(keyList.indexOf(key)>-1){result[key]=value;}}).then(function(){return result;},function(){console.warn('getItemList error!');});excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=_this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.put(value,key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();try{(function(){var _this=this;var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var result={};kvList.forEach(function(kv,i){var key=kv.key,value=kv.value;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
store.put(value,key);});transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=transaction.error;promise.reject(err);};}).call(this);}catch(e){console.warn('setItemList error!');promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.delete(key);transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;var request;if(!cursor){promise.resolve();return;}
if(keyList.indexOf(cursor.key)>-1){cursor.delete();}
cursor.continue();};req.onerror=function(err){promise.reject(err);};}).call(this);}catch(e){promise.reject();}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var transaction=dbInfo.db.transaction(dbInfo.storeName,'readwrite');var store=transaction.objectStore(dbInfo.storeName);var req=store.clear();transaction.oncomplete=function(){promise.resolve();};transaction.onabort=transaction.onerror=function(){var err=req.error?req.error:req.transaction.error;promise.reject(err);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var advanced=false;req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(null);return;}
if(n===0){promise.resolve(cursor.key);}else{if(!advanced){advanced=true;cursor.advance(n);}else{promise.resolve(cursor.key);}}};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var keys=[];var req=store.openCursor();req.onsuccess=function(){var cursor=req.result;if(!cursor){promise.resolve(keys);return;}
keys.push(cursor.key);cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var dbInfo=this._dbInfo;var store=dbInfo.db.transaction(dbInfo.storeName,'readonly').objectStore(dbInfo.storeName);var req=store.openCursor();var index=0;req.onsuccess=function(){var cursor=req.result;var result;if(!cursor){promise.resolve();return;}
result=iterator(cursor.key,cursor.value,index++);if(result===false){promise.resolve();return;}
cursor.continue();};req.onerror=function(){promise.reject(req.error);};}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var indexDBWrapper={_driver:'indexedDBWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.indexedDB=indexDBWrapper;}).call(this);(function($){'use strict';var localStorage;try{if(!this.localStorage||!('setItem'in this.localStorage)){return;}
localStorage=this.localStorage;}catch(e){return;}
function _initStorage(options){this._dbInfo=$.extend({},options);this._dbInfo.keyPrefix=this._dbInfo.name+'/';}
function length(callback){var _this=this;var promise=this.keys().then(function(keys){return keys.length;});excuteCallback(promise,callback);return promise;}
function getItem(key,callback){var _this=this;if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var result;result=localStorage.getItem(this._dbInfo.keyPrefix+key);try{result=JSON.parse(result);}catch(e){}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function getItemList(keyList,callback){var _this=this;var promise=$.Deferred();(function(){var result={};keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
result[key]=localStorage.getItem(_this._dbInfo.keyPrefix+key);try{result[key]=JSON.parse(result[key]);}catch(e){}});promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function setItem(key,value,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();(function(){var _this=this;var result;try{try{value=JSON.stringify(value);}catch(e){}
result=localStorage.setItem(_this._dbInfo.keyPrefix+key,value);promise.resolve(result);}catch(e){result=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}
promise.reject(e);}}).call(this);excuteCallback(promise,callback);return promise;}
function setItemList(kvList,callback){var promise=$.Deferred();(function(){var _this=this;var result={};kvList.forEach(function(kv,i){var value;if(typeof kv.key!=='string'){console.warn('The key is not a string!');kv.key=String(kv.key);}
try{try{value=JSON.stringify(kv.value);}catch(e){value=kv.value;}
result[kv.key]=localStorage.setItem(_this._dbInfo.keyPrefix+kv.key,value);}catch(e){console.warn('occur error when set data into storage [key: "'+kv.key+'", value: "'+kv.value+'"]');result[kv.key]=null;if(e.name==='QuotaExceededError'||e.name==='NS_ERROR_DOM_QUOTA_REACHED'){promise.reject(e);return;}}});promise.resolve();}).call(this);excuteCallback(promise,callback);return promise;}
function removeItem(key,callback){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
var promise=$.Deferred();try{(function(){localStorage.removeItem(this._dbInfo.keyPrefix+key);promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function removeItemList(keyList,callback){var promise=$.Deferred();try{(function(){var _this=this;keyList.forEach(function(key,i){if(typeof key!=='string'){console.warn('The key is not a string!');key=String(key);}
localStorage.removeItem(_this._dbInfo.keyPrefix+key);});promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function clear(callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){localStorage.removeItem(key);}}
promise.resolve();}).call(this);}catch(e){proimse.reject(e);}
excuteCallback(promise,callback);return promise;}
function key(n,callback){var _this=this;var promise=$.Deferred();(function(){var result;result=localStorage.key(n);if(result){result=result.substring(_this._dbInfo.keyPrefix.length);}
promise.resolve(result);}).call(this);excuteCallback(promise,callback);return promise;}
function keys(callback){var _this=this;var promise=$.Deferred();(function(){var keyPrefix=this._dbInfo.keyPrefix;var length=localStorage.length;var keys=[],key;for(var i=0;i<length;i++){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){keys.push(key.substring(keyPrefix.length));}}
promise.resolve(keys);}).call(this);excuteCallback(promise,callback);return promise;}
function iterate(iterator,callback){var _this=this;var promise=$.Deferred();try{(function(){var keyPrefix=this._dbInfo.keyPrefix;var key,value;var result;for(var i=localStorage.length-1;i>=0;i--){key=localStorage.key(i);if(key.indexOf(keyPrefix)===0){value=localStorage.getItem(key);try{value=JSON.parse(value);}catch(e){}
result=iterator(key.substring(keyPrefix.length),value,i);}
if(result===false){break;}}
promise.resolve();}).call(this);}catch(e){promise.reject(e);}
excuteCallback(promise,callback);return promise;}
function excuteCallback(promise,callback){if(typeof callback==='function'){promise.then(function(result){callback(null,result);},function(error){callback(erro);});}}
var localStorageWrapper={_driver:'localStorageWrapper',_initStorage:_initStorage,length:length,getItem:getItem,getItemList:getItemList,setItem:setItem,setItemList:setItemList,removeItem:removeItem,removeItemList:removeItemList,clear:clear,key:key,keys:keys,iterate:iterate};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.drivers=this.Beop.cache.drivers||{};this.Beop.cache.drivers.localStorage=localStorageWrapper;}).call(this,jQuery);(function($){function BaseCache(options){this.options=$.extend({},DEFAULTS,options);this.storage=Object.create(Beop.cache.drivers[this.options.driver]);this.init();}
BaseCache.prototype.init=function(){this.storage._initStorage(this.options);};BaseCache.prototype.length=function(){return this.storage.length();};BaseCache.prototype.key=function(n,callback){return this.storage.key(n,callback);};BaseCache.prototype.keys=function(callback){return this.storage.keys(callback);};BaseCache.prototype.getItem=function(key,callback){return this.storage.getItem(key,callback);};BaseCache.prototype.getItemList=function(keyList,callback){return this.storage.getItemList(keyList,callback);};BaseCache.prototype.setItem=function(key,value,callback){return this.storage.setItem(key,value,callback);};BaseCache.prototype.setItemList=function(kvList,callback){return this.storage.setItemList(kvList,callback);};BaseCache.prototype.removeItem=function(key,callback){return this.storage.removeItem(key,callback);};BaseCache.prototype.removeItemList=function(keyList,callback){return this.storage.removeItemList(keyList,callback);};BaseCache.prototype.clear=function(callback){return this.storage.clear(callback);};BaseCache.prototype.iterate=function(iterator,callback){return this.storage.iterate(iterator,callback);};var DEFAULTS={dbType:'localStorage',name:'beopcache',version:3};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.BaseCache=BaseCache;}).call(this,jQuery);(function($,undefined){var TIME_STAMP={m1:60000,m5:300000,h1:3600000,d1:86400000};var DB_INFO={driver:'indexedDB',storeName:'datasource'};function DSCache(){this.db=new Beop.cache.BaseCache(DB_INFO);this.keyTpl='anal_{id}_{fmt}_{start}_{end}';};DSCache.prototype.get=function(id,tmFmt,tmStart,tmEnd){var _this=this;var key;var promise=$.Deferred();if(tmFmt==='M1'){promise.resolve(null);return promise;}
if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=this.formatTime(tmStart,tmFmt);tmEnd=this.formatTime(tmEnd,tmFmt);key=this.keyTpl.formatEL({id:id,fmt:tmFmt,start:tmStart.valueOf(),end:tmEnd.valueOf()});this.db.getItem(key).done(function(rs){var index1,index2;if(rs!==null){promise.resolve(rs);return promise;};tmStart=tmStart.format('yyyy-MM-dd HH:mm:ss');tmEnd=tmEnd.format('yyyy-MM-dd HH:mm:ss');_this.db.iterate(function(key,value,i){if(_this.isExist(key,id,tmFmt,tmStart,tmEnd)){index1=value.timeShaft.indexOf(tmStart);index2=value.timeShaft.indexOf(tmEnd);value.list[0].data=value.list[0].data.slice(index1,index2+1);value.timeShaft=value.timeShaft.slice(index1,index2+1);rs=value;return false;}}).done(function(){promise.resolve(rs);}).fail(function(e){promise.reject(e);});}).fail(function(e){promise.reject(e);});return promise;};DSCache.prototype.getBatch=function(ids,tmFmt,tmStart,tmEnd){var find,rs=null;var promiseArr=[];var idsNotFound=[];for(var i=0,len=ids.length;i<len;i++){(function(i){promiseArr.push(this.get(ids[i],tmFmt,tmStart,tmEnd).done(function(find){if(find!==null){if(rs===null)rs=find;else rs.list.push(find.list[0]);}else{idsNotFound.push(ids[i]);}}));}).call(this,i);}
return $.when.apply($,promiseArr).then(function(){return{data:rs,idsNotFound:idsNotFound};});};DSCache.prototype.set=function(data,tmFmt,tmStart,tmEnd){var promise=$.Deferred();var list=data.list.concat();if(tmFmt==='M1'){promise.resolve(null);return promise;}
if(data===null||!data.timeShaft||!data.timeShaft.length){promise.resolve(null);return promise;}
if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=this.formatTime(tmStart,tmFmt);tmEnd=this.formatTime(tmEnd,tmFmt);function circle(){var _this=this;var item=list.shift();var id,key;if(!item){promise.resolve();return;}
id=item.dsItemId;key=this.keyTpl.formatEL({id:id,fmt:tmFmt,start:tmStart.valueOf(),end:tmEnd.valueOf()});this.merge2Cache(key,{list:[item],timeShaft:data.timeShaft}).done(function(){circle.call(_this);}).fail(function(e){promise.reject(e);});}
circle.call(this);return promise;};DSCache.prototype.remove=function(itemIds){var _this=this;var keys=[];var promise=$.Deferred();if(typeof itemIds==='string'){itemIds=[itemIds];}
this.db.keys().done(function(rs){console.log(rs);});this.db.iterate(function(key){var isExist=itemIds.some(function(row,i){if(key.indexOf('anal_'+row)>-1)return true;});if(isExist)keys.push(key);}).done(function(){if(keys.length>0){_this.db.removeItemList(keys).done(function(){promise.resolve();}).fail(function(){promise.reject();});return;}
promise.reject();}).fail(function(){console.warn('remove ds key failed! key: '+keys.join(','));promise.reject();});return promise;};DSCache.prototype.merge2Cache=function(newKey,newValue){var _this=this;var arr=newKey.split('_');var kk=[arr[0],arr[1],arr[2]].join('_');var filter=[];var promise=$.Deferred();this.db.iterate(function(key,value,index){if(key.indexOf(kk)>-1){filter.push({key:key,value:value});}}).done(function(){if(filter.length===0){_this.db.setItem(newKey,newValue).done(function(){promise.resolve();});return;}
_this.merge2group({key:newKey,value:newValue,fmt:arr[2],start:parseInt(arr[3]),end:parseInt(arr[4])},filter).then(function(){promise.resolve();},function(e){promise.reject(e);});}).fail(function(e){promise.reject(e);});return promise;};DSCache.prototype.merge2group=function(row,group){var _this=this;var timeArr=[],arr,ts,item;var start1,end1,start2,end2;var srcData;var promise=$.Deferred();for(var i=0,len=group.length;i<len;i++){arr=group[i].key.split('_');item={key:group[i].key,fmt:arr[2],start:parseInt(arr[3]),end:parseInt(arr[4])};timeArr.push(item);}
ts=TIME_STAMP[row.fmt];if(ts===undefined){promise.reject();return;}
start1=row.start-ts;end1=row.end+ts;srcData={key:row.key,value:row.value};function circle(){var _this=this;var item=timeArr.shift();var start2,end2;if(!item){this.db.setItem(srcData.key,srcData.value);promise.resolve();return;}
start2=item.start;end2=item.end;if(start1>end2||end1<start2){circle.call(this);}else{this.db.getItem(item.key).done(function(value){_this.mergeData(srcData,{key:item.key,value:value}).done(function(rs){srcData=rs;if(srcData===null){promise.resolve();return;}
circle.call(_this);});}).fail(function(){promise.reject();return;});}}
circle.call(this);return promise;};DSCache.prototype.mergeData=function(d1,d2){var key1=d1.key,key2=d2.key;var item1=d1.value,item2=d2.value;var arr=key1.split('_');var dsId=arr[1];var prefix=this.keyTpl.formatEL({id:arr[1],fmt:arr[2]});var start1,end1,start2,end2;var start,end;var index,data,ts,result;var promise=$.Deferred();startStr1=item1.timeShaft[0];endStr1=item1.timeShaft[item1.timeShaft.length-1];startStr2=item2.timeShaft[0];endStr2=item2.timeShaft[item2.timeShaft.length-1];start1=startStr1.toDate().valueOf();end1=endStr1.toDate().valueOf();start2=startStr2.toDate().valueOf();end2=endStr2.toDate().valueOf();start=Math.min(start1,start2);end=Math.max(end1,end2);if(start===start2&&end===end2){promise.resolve(null);return promise;}
if(start===start1&&end===end1){this.db.removeItem(key2).done(function(){promise.resolve(d1);});return promise;}
if(start===start1&&end===end2){index=item1.timeShaft.indexOf(startStr2);if(index===-1)index=item1.timeShaft.length;data=item1.list[0].data.slice(0,index).concat(item2.list[0].data);ts=item1.timeShaft.slice(0,index).concat(item2.timeShaft);this.db.removeItem(key2).done(function(){promise.resolve({key:prefix.formatEL({start:start1,end:end2}),value:{list:[{data:data,dsItemId:dsId}],timeShaft:ts}});});return promise;}
if(start===start2&&end===end1){index=item1.timeShaft.indexOf(endStr2);if(index===-1)index=0;data=item2.list[0].data.concat(item1.list[0].data.slice(index));ts=item2.timeShaft.concat(item1.timeShaft.slice(index));this.db.removeItem(key2).done(function(){promise.resolve({key:prefix.formatEL({start:start2,end:end1}),value:{list:[{data:data,dsItemId:dsId}],timeShaft:ts}});});return promise;}
promise.resolve(d1);return promise;};DSCache.prototype.isExist=function(key,id,tmFmt,tmStart,tmEnd){var arr=[];var rangeStart,rangeEnd;if(key.indexOf('anal_'+id+'_'+tmFmt)===-1)return false;arr=key.split('_');if(typeof tmStart==='string')tmStart=tmStart.toDate();if(typeof tmEnd==='string')tmEnd=tmEnd.toDate();tmStart=tmStart.valueOf();tmEnd=tmEnd.valueOf();if(tmStart>=parseInt(arr[3])&&tmEnd<=parseInt(arr[4]))return true;return false;};DSCache.prototype.formatTime=function(time,fmt,mode){var ts=TIME_STAMP[fmt];mode=mode==='up'?'ceil':'floor';if(ts===undefined)return;if(typeof time==='string')time=time.toDate();time=time.valueOf();if(fmt==='d1'){time=new Date(Math[mode](time/ts)*ts).format('yyyy-MM-dd 00:mm:ss');}else{time=new Date(Math[mode](time/ts)*ts).format('yyyy-MM-dd HH:mm:ss');}
return new Date(time);};this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.ds=new DSCache();}).call(this,jQuery);(function($,undefined){var DB_INFO={driver:'indexedDB',storeName:'thumbnail'};function imgCache(){this.db=new Beop.cache.BaseCache(DB_INFO);}
imgCache.prototype.getChkByWs=function(workspace){var keyList=wsList2keyList([workspace]);return this.db.getItemList(keyList).then(function(rs){var index;for(var k in rs){if(!rs.hasOwnProperty(k)){continue;}
if((index=keyList.indexOf(k))>-1){keyList.splice(index,1);}}
return{data:rs,absentList:keyList.map(function(row){return row.split('_')[1];})};});};imgCache.prototype.getByWsList=function(workspaceList){var keyList=wsList2keyList(workspaceList);return this.db.getItemList(keyList);};imgCache.prototype.setByWs=function(workspace){return this.setByWsList([workspace]);};imgCache.prototype.setByWsList=function(workspaceList){var kvList=wsList2kvList(workspaceList);return this.db.setItemList(kvList);};imgCache.prototype.removeByWsList=function(workspaceList){var keyList=wsList2keyList(workspaceList);return this.db.removeItemList(keyList);};imgCache.prototype.set=function(wsId,modalId,imagebin){return this.db.setItem(wsId+'_'+modalId,imagebin);};function wsList2keyList(workspaceList){var keyList=[];workspaceList.forEach(function(workspace){var wsId=workspace.id;keyList=keyList.concat(workspace.modalList.map(function(modal){return wsId+'_'+modal.id;}));});return keyList;}
function wsList2kvList(workspaceList){var kvList=[];workspaceList.forEach(function(workspace){var wsId=workspace.id;workspace.modalList.forEach(function(modal){if(!modal.imagebin||!modal.id||!wsId){return false;}
kvList.push({key:wsId+'_'+modal.id,value:modal.imagebin});});});return kvList;}
this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.img=new imgCache();}).call(this,jQuery);(function($,undefined){'use strict';var DB_INFO={driver:'indexedDB',storeName:'buffer'};var log=console.warn.bind(console);var assert={equal:function(val1,val2){if(val1!==val2)console.warn('assert - equal not expected!');}}
var key_version,uId;function BufferCache(){this.db=new Beop.cache.BaseCache(DB_INFO);}
+function(){this.init=function(){var _this=this;uId=AppConfig.userId;key_version='version?u='+uId;return this.db.getItem(key_version).then(function(v){if(v===null){_this.db.setItem(key_version,1).then(function(){_this.activeVersion=1;_this.frozenVersion=0;});}else{v=parseInt(v);_this.activeVersion=v;_this.frozenVersion=v-1;}},function(){_this.db.setItem(key_version,1).then(function(){_this.activeVersion=1;_this.frozenVersion=0;});});};this.getBuffer=function(key,version){var promise;version=version===undefined?this.activeVersion:version;if(!key){log('getBuffer - arguments can not be empty');promise=$.Deferred();promise.reject();return promise;}
return this.db.getItem(key+'?u='+uId+'&v='+version).then(function(rs){if(rs===null){rs=[];}
return rs;});};this.setBuffer=function(data,key,version){var promise;version=version===undefined?this.activeVersion:version;if(!key){log('setBuffer - arguments can not be empty');promise=$.Deferred();promise.reject();return promise;}
return this.db.setItem(key+'?u='+uId+'&v='+version,data);};this.removeBuffer=function(key,version){var promise;version=version===undefined?this.frozenVersion:version;if(!key){log('removeBuffer - arguments can not be empty');promise=$.Deferred();promise.reject();return promise;}
return this.db.removeItem(key+'?u='+uId+'&v='+version);};this.findDataById=function(id,type){var promise=$.Deferred();this.getBuffer(type).then(function(rs){for(var i=0,len=rs.length;i<len;i++){if(rs[i].id===id){break;}}
if(i!==len){promise.resolve(rs,i);}else{promise.resolve(rs,-1);}},function(){promise.reject();});return promise;};this.findModalById=function(modalId,id,type){var promise=$.Deferred();this.findDataById(id,type).then(function(rs,i){var row,row2;var t,len;if(i===-1){promise.resolve(rs,-1);return;}
row=rs[i];for(t=0,len=row.modalList.length;t<len;t++){row2=row.modalList[t];if(row2.id===modalId){break;}}
if(t!==len){promise.resolve(rs,i,t);}
else{promise.resolve(rs,i,-1)}},function(rs,i){promise.reject();});return promise;};this.addWsCreateOp=function(data,type){var _this=this;var promise=$.Deferred();type=type===undefined?'ws':type;data.op='create';this.getBuffer(type).then(function(rs){rs.push(data);_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addWsCreateOp - '+type+' - setBuffer failed');promise.reject();});},function(){log('addWsCreateOp - '+type+' - getBuffer failed');promise.reject();});return promise;};this.addWsUpdateOp=function(data,type){var _this=this;var promise=$.Deferred();type=type===undefined?'ws':type;this.findDataById(data.id,type).then(function(rs,index){var ws;if(index!==-1){ws=rs[index];ws.name=data.name;ws.modifyTime=data.modifyTime;}
else{rs.push({id:data.id,name:data.name,modifyTime:data.modifyTime,modalList:[],op:'update'});}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addWsUpdateOp - '+type+' - setBuffer failed');promise.reject();});},function(){log('addWsUpdateOp - '+type+' - findDataById failed');promise.reject();});return promise;};this.addWsDeleteOp=function(data,type){var _this=this;var promise=$.Deferred();type=type===undefined?'ws':type;this.findDataById(data.id,type).then(function(rs,index){var ws;if(index!==-1){ws=rs[index];if(ws.op==='create'){rs.splice(index,1);}else{rs[index]={id:data.id,op:'delete'};}}
else{rs.push({id:data.id,op:'delete'});}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addWsDeleteOp - '+type+' - setBuffer failed');promise.reject();});},function(){log('addWsDeleteOp - '+type+' - findDataById failed');promise.reject();});return promise;};this.addModalCreateOp=function(modal,id,type){var _this=this;var promise=$.Deferred();this.findDataById(id,type).then(function(rs,i){if(i!==-1){rs[i].modalList.push(modal);}
else{rs.push({id:id,modalList:[modal],op:'update'});}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addModalCreateOp - setBuffer failed');promise.reject();});},function(){log('addModalCreateOp - findDataById failed');promise.reject();});return promise;};this.addModalUpdateOp=function(modal,id,type){var _this=this;var promise=$.Deferred();this.findModalById(modal.id,id,type).then(function(rs,i,t){if(i===-1){rs.push({id:id,op:'update',modalList:[modal]});}
else if(t===-1){assert.equal(rs[i].op,'update');rs[i].modalList.push(modal);}
else{modal.op=rs[i].modalList[t].op;modal=$.extend(false,rs[i].modalList.splice(t,1),modal);rs[i].modalList.push(modal);}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addModalDeleteOp - setBuffer failed');promise.reject();});},function(){log('addModalDeleteOp - findModalById failed');promise.reject();});return promise;};this.addModalDeleteOp=function(modalId,id,type){var _this=this;var promise=$.Deferred();this.findModalById(modalId,id,type).then(function(rs,i,t){var op;if(i===-1){rs.push({id:id,op:'update',modalList:[{id:modalId,op:'delete'}]});}
else if(t===-1){assert.equal(rs[i].op,'update');rs[i].modalList.push({id:modalId,op:'delete'});}
else{op=rs[i].modalList[t].op;if(op==='create'){rs[i].modalList.splice(t,1);}else if(op==='update'){rs[i].modalList[t]={id:modalId,op:'delete'};}}
_this.setBuffer(rs,type).then(function(){promise.resolve();},function(){log('addModalDeleteOp - setBuffer failed');promise.reject();});},function(){log('addModalDeleteOp - findModalById failed');promise.reject();});return promise;};this.freeze=function(){var promise=$.Deferred();this.db.keys().done(function(keys){if((keys.indexOf('ws?u='+uId+'&v='+this.frozenVersion)===-1&&keys.indexOf('tpl?u='+uId+'&v='+this.frozenVersion)===-1)&&(keys.indexOf('ws?u='+uId+'&v='+this.activeVersion)!==-1||keys.indexOf('tpl?u='+uId+'&v='+this.activeVersion)!==-1)){this.db.setItem(key_version,this.activeVersion+1).done(function(){this.frozenVersion=this.activeVersion;this.activeVersion+=1;promise.resolve();}.bind(this));}else{promise.resolve();}}.bind(this));return promise;};this.getFrozenData=function(){function getDisplayData(data){var rs={};if(!data.length)return null;data.forEach(function(ws){switch(ws.op){case'create':case'delete':rs[ws.op]=rs[ws.op]||[];rs[ws.op].push(ws);delete ws.op;ws.modalList&&ws.modalList.forEach(function(row){delete row.op;});break;case'update':rs.update=rs.update||[];if(!!ws.modalList&&!!ws.modalList.length){ws.modal={};ws.modalList.forEach(function(modal){ws.modal[modal.op]=ws.modal[modal.op]||[];ws.modal[modal.op].push(modal);delete modal.op;});}
delete ws.op;delete ws.modalList;rs.update.push(ws);break;default:break;}});return rs;}
return function(){var arr=[];var promise=$.Deferred();this.freeze().then(function(){arr.push(this.getBuffer('ws',this.frozenVersion).then(function(ws){return getDisplayData(ws);}));arr.push(this.getBuffer('tpl',this.frozenVersion).then(function(tpl){return getDisplayData(tpl);}));$.when.apply($,arr).then(function(){var rs=null;if(arguments[0]!==null){rs=rs||{};rs['ws']=arguments[0];}
if(arguments[1]!==null){rs=rs||{};rs['tpl']=arguments[1];}
promise.resolve(rs);});}.bind(this),function(){log('getFrozenData - freeze failed');promise.reject();});return promise;};}.call(this);this.removeFrozenData=function(){var arr=[];arr.push(this.removeBuffer('ws',this.frozenVersion));arr.push(this.removeBuffer('tpl',this.frozenVersion));return $.when.apply($,arr);};}.call(BufferCache.prototype);this.Beop=this.Beop||{};this.Beop.cache=this.Beop.cache||{};this.Beop.cache.buffer=new BufferCache();}).call(this,jQuery);﻿
var Internationalization=(function(){function Internationalization(){this.type=localStorage["language"];this.resource=JSON.parse(localStorage["i18n"]);this.setDefautFont();};Internationalization.prototype={getResource:function(){return this.resource;},setDefautFont:function(strFont){if(!strFont){if(/OS/.test(window.jscd.os))strFont='Helvetica';if(window.jscd.os=='windows')strFont='微软雅黑';}
if(strFont)document.getElementsByTagName('body')[0].style.fontFamily=strFont;},fillPage:function(){this.fill2($('[i18n]'));},fillArea:function(element){this.fill2(element.find('[i18n]'));},fillAreaAttribute:function(element,attributeName){this.fill(element.find('[i18n]['+attributeName+']'),attributeName);},fill:function(arrElement,attributeName){for(var i=0,arrPath,text,len=arrElement.length;i<len;i++){arrPath=arrElement[i].attributes["i18n"].value.split('.');text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
if(!attributeName){arrElement[i].innerHTML=text;}
else{arrElement[i].setAttribute(attributeName,text);}}},getI18nValue:function(i18nKey){if(!i18nKey){return'';}
var arrPath=i18nKey.split('.');var text=this.resource;for(var j=0;j<arrPath.length;j++){text=text&&text[arrPath[j]];}
return text;},fill2:function(arrElement){for(var i=0,len=arrElement.length;i<len;i++){var i18nValue=arrElement[i].attributes["i18n"];var items=i18nValue.value.split(';'),item,i18nValue,attrMap;for(var j=0;j<items.length;j++){item=items[j];if(!item){continue;}
if(item.indexOf('=')===-1){i18nValue=this.getI18nValue(item);arrElement[i].innerHTML=i18nValue;}else{attrMap=item.split('=');if(!attrMap[0]){continue;}
arrElement[i].setAttribute(attrMap[0],this.getI18nValue(attrMap[1]));}}}},findContent:function(strPath){var arrPath=strPath.split('.');var text=this.resource;for(var i=0,len=arrPath.length;i<len;i++){text=text&&text[arrPath[i]];}
return text;}}
return Internationalization;})();﻿
var PaneProjectSelector=(function(){var _this=this;var configMap={paneTemplate:'/static/views/admin/paneProjectSelector.html',mapTemplate:'/static/views/admin/mapProjectSelector.html',selectorType:{panel:'panel',map:'map'},isMapAvailable:true,currentSelector:null};function PaneProjectSelector(){_this=this;this.i18=I18n.resource.admin.projectManager;if(!BackgroundWorkers.alarmReporter){BackgroundWorkers.alarmReporter=new Worker("/static/views/js/worker/workerUpdate.js");BackgroundWorkers.alarmReporter.onmessage=function(e){var rs=e.data;if(rs.status==='OK'){_this.refreshAlarmPanel(_this.filterByAlarmRule(rs.data));}
else{}}}
if(!BackgroundWorkers.schedulerReporter){BackgroundWorkers.schedulerReporter=new Worker("/static/views/js/worker/workerUpdate.js");BackgroundWorkers.schedulerReporter.receivedMessage=function(data){var $paneWorkflow=$('#paneWorkflow'),$badge=$paneWorkflow.find('.badge'),totalCount='',$imgBadge=$('#iconList a:eq(0) .badge'),$alarmBadge=$('#liProjectAlarm .badge');totalCount=data.transaction.length+data.scheduler.length;if(totalCount){$badge.text(totalCount);$imgBadge.html('&nbsp;')}else{$badge.text('');if($alarmBadge.is(':empty')){$imgBadge.html('');}}
if(data.scheduler.length){$paneWorkflow.find('.menuItemCalendar .badge').text(data.scheduler.length);}else{$paneWorkflow.find('.menuItemCalendar .badge').text('');}
if(data.transaction.length){$paneWorkflow.find('.menuItemMine .badge').text(data.transaction.length);}else{$paneWorkflow.find('.menuItemMine .badge').text('');}};BackgroundWorkers.schedulerReporter.onmessage=function(e){var rs=e.data;if(rs.success){BackgroundWorkers.schedulerReporter.receivedMessage(rs.data);}};BackgroundWorkers.schedulerReporter.postMessage({type:'fetchWorkflowData',userId:AppConfig.userId});}}
PaneProjectSelector.prototype={show:function(selectorType){I18n.fillArea($('#navPane'));this.clearMenu();if(!selectorType){selectorType=configMap.currentSelector;}
if(selectorType===configMap.selectorType.panel){this.showPanelView();}else{if(configMap.isMapAvailable){this.showMapView();}else{this.showPanelView();}}
Spinner.stop();},showMapView:function(){var _this=this;this.showMapSelector().done(function(){_this.init();var map=new beop.getMapInstance();map.load();});},showPanelView:function(){var _this=this;this.showPanelSelector().done(function(){_this.init();BEOPUtil.setRelativePosition($("#imgListCon"),$("#funList"),-45,5)
$(window).resize(function(){BEOPUtil.setRelativePosition($("#imgListCon"),$("#funList"),-45,5)});});},setMapAvailable:function(available){configMap.isMapAvailable=!!available;},close:function(){$(window).off('resize');$('#scrollPages').height($('#divPages').height());_this.initNav();$(window).off('resize.nav').on('resize.nav',function(e){if($('html').hasClass('sharpview-mode'))return;_this.initNav();});},showPanelSelector:function(){configMap.currentSelector=configMap.selectorType.panel;return WebAPI.get(configMap.paneTemplate).done(function(resultHtml){var $resultHtml=$(resultHtml);$(ElScreenContainer).html($resultHtml);$("#ulPages").hide();I18n.fillArea($resultHtml);var paneSelector=$("#paneSelector");var imgListCon=paneSelector.find('.project-media-container');paneSelector.html('');imgListCon.html('');for(var i=0;i<AppConfig.projectList.length;i++){var project=AppConfig.projectList[i];var divMedia=$('<div class="media effect"><a><div class="img"><img class="media-object" src="'+BEOPUtil.getProjectImgPath(project)+'"></div></a></div>');divMedia.attr('id','project-'+project.id+"-"+project.name_en+"-"+project.level);var divMediaBody=$('<div class="media-body info"></div>').append($('<h4 class="media-heading">'+StringUtil.getI18nProjectName(project)+'</h4>'));divMedia.find('a').append(divMediaBody);imgListCon.append(divMedia);}
paneSelector.append(imgListCon);});},showMapSelector:function(){configMap.currentSelector=configMap.selectorType.map;return WebAPI.get(configMap.mapTemplate).done(function(resultHtml){$(ElScreenContainer).html(resultHtml);I18n.fillArea($('.map-row'));});},init:function(){var _this=this;$("#rowLogin").animate({left:'-250px',opacity:'0.5',height:'10px',width:'10px',marginTop:'0'},null,function(){$("#rowLogin").css("display","none");});$("#rowSelector").eventOn('click','.media',function(e){var arrConfig=e.currentTarget.id.split("-");var projectId=parseInt(arrConfig[1]);var projectEnName=arrConfig[2];var projectName='';Spinner.spin(document.getElementById('paneSelector'));AppConfig.level=parseInt(arrConfig[3]);for(var i=0,len=AppConfig.projectList.length;i<len;i++){if(projectId===AppConfig.projectList[i].id){projectName=StringUtil.getI18nProjectName(AppConfig.projectList[i]);break;}}
if(!projectName){Spinner.stop();return;}
_this.initProject(projectId,projectEnName,projectName).done(function(result){_this.initDefaultPage(result);}).always(function(){Spinner.stop();});}).animate({opacity:'1'}).show();if(AppConfig.userOfRole==1){$('.adminFeature').show();}
if(configMap.isMapAvailable){$('#btnMapSelector').show().eventOn('click',function(){var selector=new PaneProjectSelector();selector.show(configMap.selectorType.map);})}
$("#btnUpdate").eventOn('click',function(e){Spinner.spin(document.getElementById('paneSelector'));var alert;WebAPI.get("/observer/update").done(function(result){if(result=="success"){alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectManager.UPDATE_COMPLETE);alert.showAtTop(1000);}else{alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectManager.UPDATE_FAILED);alert.showAtTop(1000);}}).fail(function(result){alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectManager.UPDATE_FAILED);alert.showAtTop(1000);}).always(function(e){Spinner.stop();});});$('#btnDataAnalys').eventOff('click').eventOn('click',function(){var screen=_this.menuScreenFactory('analysis');if(!screen){return false;}
ScreenManager.show(screen);var $ulPages=$('#ulPages');if($ulPages.length){}});$('#btnWikiManage').eventOff('click').eventOn('click',function(){ScreenManager.show(ModalWiki);});$('#btnShareLog').eventOff('click').eventOn('click',function(){ScreenManager.show(shareLogging,AppConfig.userId);});$("#btnAccountManage").eventOff('click').eventOn('click',function(){ScreenManager.show(UserManagerController,AccountManager);});$("#btnMemberManage").eventOff('click').eventOn('click',function(){ScreenManager.show(UserManagerController,MemberManager);});if(AppConfig.userOfRole==1){$("#btnBenchmark").parent('li').show().end().eventOff('click').eventOn('click',function(){ScreenManager.show(UserManagerController,BenchmarkConfigure);$('#ulPages').empty();});}
$("#btnPermissionManage").eventOff('click').eventOn('click',function(){ScreenManager.show(UserManagerController,ProjectPermissionManager);});$("#right-nav").show();$("#paneUser").html(AppConfig.userProfile.fullname||AppConfig.account);$('#iconList .userPic.small').attr('src','http://images.rnbtech.com.hk'+AppConfig.userProfile.picture).attr('alt',AppConfig.userProfile.fullname||AppConfig.account);$('#btnAccountManage .userPic').attr('src','http://images.rnbtech.com.hk'+AppConfig.userProfile.picture).attr('alt',AppConfig.userProfile.fullname||AppConfig.account);$("#paneWorkflow").eventOff('click').eventOn('click',function(e){ScreenManager.show(beop.main);});$("#btnOperatingRecord").eventOff('click').eventOn('click',function(e){new OperatingRecord().show();});if(AppConfig.userOfRole==1){$("#btnTemperatureSetting").show().eventOff('click').eventOn('click',function(e){new TemperatureSetting().show();});}
$('#btnAlarmLogging').eventOff().eventOn('click',function(e){ScreenManager.show(AlarmLogging);e.preventDefault();});$('#liProjectAlarm').eventOff().eventOn('click',function(e){var $ulAlarmPanel=$('#ulAlarmPanel');$ulAlarmPanel.toggle().next('.card-close').toggle().off().one('click',function(e){e.stopPropagation();$ulAlarmPanel.hide();$(this).hide();});e.stopPropagation();e.preventDefault();});$("#btnChangeProject").eventOff('click').eventOn('click',function(e){ScreenManager.show(PaneProjectSelector);});$("#btnLogout").eventOff('click').eventOn('click',function(e){_this.logout();ScreenManager(IndexScreen);ScreenManager.clearHistory();});var $btnChangeSkin=$("#btnChangeSkin");var $labelChangeSkin=$('#labelChangeSkin');$labelChangeSkin.eventOff('click').eventOn('click',function(e){e.stopPropagation();$btnChangeSkin.toggle();});$btnChangeSkin.eventOff('click').eventOn('click',function(e){e.stopPropagation();});var skinTimeout=null;$btnChangeSkin.eventOff('change').eventOn('change',function(e){var systemSkin=localStorage.getItem('systemSkin_'+AppConfig.userId);if(systemSkin!=this.value){if(this.value=='dark'){loadDarkSkin();}else{var cssDark=document.querySelector('#darkSkin');if(cssDark){cssDark.remove();}
AppConfig.chartTheme='macarons';localStorage.setItem('systemSkin_'+AppConfig.userId,'default');}}
skinTimeout=setTimeout(function(){$btnChangeSkin.fadeOut(1000);},5000);});$btnChangeSkin.hover(function(){clearTimeout(skinTimeout);},function(){skinTimeout=setTimeout(function(){$btnChangeSkin.fadeOut(1000);},5000);});var systemSkin=localStorage.getItem('systemSkin_'+AppConfig.userId);if(systemSkin){$btnChangeSkin.val(systemSkin);}else{$btnChangeSkin.val('dark');systemSkin='dark';}
if(systemSkin=='dark'){loadDarkSkin();}
function loadDarkSkin(){var head=document.querySelector('head');var $darkSkin=$('#darkSkin');if($darkSkin.length==0){var $cssDark=$('<link id="darkSkin" rel="stylesheet" type="text/css" href="/static/content/index-black.css?'+new Date().getTime()+'">');head.appendChild($cssDark[0]);$cssDark[0].onload=function(){localStorage.setItem('systemSkin_'+AppConfig.userId,'dark');}}
AppConfig.chartTheme=theme.Dark;}
$("#btnResetPassword").eventOff('click').eventOn('click',function(e){WebAPI.get("/static/views/admin/resetPassword"+".html",null,function(resultHtml){$('#dialogContent').html(resultHtml);$('#dialogModal').modal();})});$("#btnPointManager").eventOff('click').eventOn('click',function(e){new PointManager().show();});if(AppConfig.userOfRole==1){$("#btnMenuConfigure").show().eventOff('click').eventOn('click',function(e){new MenuConfigure().show();}).show();}
$('#ulAlarmPanel').eventOff().eventOn('click','a',function(e){ScreenManager.show(AlarmLogging);});$("#navHeader").eventOff().eventOn('click','li',function(e){var $this=$(this);if($this.find("ul").length==0){$("#navHeader li").removeClass("active");$this.closest("li").addClass("active");}});$('#divPages>span').css('display','none');$('ulPages').css('left','0');},setImgHeight:function(){var $img=$("#paneSelector").find("img")
var $obj=$img.eq(0);var oh=$obj.height();$img.css({height:oh+"px"});},initProject:function(projectId,projectEnName,projectName,pageId){var _this=this;return WebAPI.get("/get_plant_pagedetails/"+projectId+"/"+AppConfig.userId).done(function(result){var result_obj=result;AppConfig.projectId=projectId;AppConfig.projectName=projectEnName;AppConfig.projectShowName=projectName;AppConfig.projectBenchmark=result_obj.benchmark;AppConfig.navItems=result_obj.navItems;$('#projectMenu').text(projectName).show();$('#liProjectMenu').show();$('#liProjectAlarm').show();BackgroundWorkers.alarmReporter.postMessage({type:'dataAlarmRealtime',projectId:projectId});_this.initNavigationPane(result_obj.navItems);_this.initMenu(result_obj.observerPages);_this.initNav();if(Boolean(pageId)){var navBtnA=$('#ulPages').find('.nav-btn-a');for(var i=0,len=navBtnA.length;i<len;i++){var item=navBtnA.eq(i);if(pageId==item.attr('pageid')){item.closest('li').attr('class','active');break;}}}
$(window).off('resize.nav').on('resize.nav',(function(){_this.initNav();}));if(beop.benchMark){beop.benchMark.refresh();}}).fail(function(msg){console.log(msg);var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectSelector.PROJECT_OPEN_FAILED.format(projectName));alert.showAtTop(2000);});},initNav:function(){var divPageWidth=window.innerWidth-document.getElementById('right-nav').offsetWidth-document.getElementById('navHomeLogo').offsetWidth-100;var scrollPageWidth=divPageWidth-50;var $scrollPages=$('#scrollPages');var ulPageWidth=0;var $ulPages=$('#ulPages'),$divPages=$('#divPages');var isPlay=false;$ulPages.children('li').each(function(){ulPageWidth+=this.clientWidth+2;});$scrollPages.css('width',scrollPageWidth+'px');$ulPages.css('width',ulPageWidth+'px');document.getElementById('divPages').style.width=divPageWidth+'px';if(divPageWidth<ulPageWidth){$('#divPages>span').css('display','inline');$('#btnPageScrollLeft').eventOff('click').eventOn('click',function(){if(isPlay)return;if(-parseInt($ulPages.css('left'))>ulPageWidth-scrollPageWidth)return;isPlay=true;$ulPages.animate({"left":"-=100px"},function(){isPlay=false;})});$('#btnPageScrollRight').eventOff('click').eventOn('click',function(){if(isPlay)return;if(-parseInt($ulPages.css('left'))<100)return;isPlay=true;$ulPages.animate({"left":"+=100px"},function(){isPlay=false;})});}else{$('#divPages>span').css('display','none');}
function showDropDownEvent(){var $this=$(this),$ulPages=$('#ulPages'),height=$this.attr('data-h');if(height===undefined){height=$('#navPane').outerHeight()+$this.children('.dropdown-menu').outerHeight();$this.attr('data-h',height);}
$scrollPages.height(height);if($this.outerWidth()+$ulPages.offset().left<0)
$scrollPages.width($divPages.outerWidth()+$this.outerWidth());}
function hideDropDownEvent(){$scrollPages.height($divPages.height());$scrollPages.width($divPages.outerWidth()-50);}
function showSubDropDownEvent(){var $this=$(this);$scrollPages.height($('#navPane').outerHeight()+$this.children('.dropdown-menu').outerHeight()+$this.parent('.dropdown-menu').outerHeight());$scrollPages.width($divPages.outerWidth()+$this.children('.dropdown-menu').outerWidth());}
$scrollPages.off('show.bs.dropdown','.dropdown').off('show.bs.dropdown','.dropdown').off('mouseenter','.dropdown-submenu').off('mouserleave','.dropdown-submenu');$scrollPages.on('show.bs.dropdown','.dropdown',showDropDownEvent).on('hide.bs.dropdown','.dropdown',hideDropDownEvent);$scrollPages.on('mouseenter','.dropdown-submenu',showSubDropDownEvent).on('mouserleave','.dropdown-submenu',hideDropDownEvent);},refreshAlarmPanel:function(data){var arrHtml=[];var $panel=$('#liProjectAlarm'),$imgBadge=$('#iconList a:eq(0) .badge'),$workflowBadge=$('#paneWorkflow .badge');;if(!data)return;if(data.length===0){$($panel.find('a>.badge').text(''));arrHtml.push('<li class="dropdown-header">There is No Alarms Now.</li>');arrHtml.push('<li class="dropdown-header"><a href="javascript:;">Go To Alarms Page></a></li>');if($workflowBadge.is(':empty')){$imgBadge.html('');}}
else{$($panel.find('a>.badge').text(data.length));for(var i=0,len=Math.min(3,data.length);i<len;i++){arrHtml.push('<li>\
                        <a href="javascript:;">\
                            <div class="divAlarmInfo">\
                                <span class="glyphicon glyphicon-exclamation-sign"></span> {0}\
                            </div>\
                            <div class="clearfix">\
                                <span class="pull-left text-muted small">Level-{1}</span>\
                                <span class="pull-right text-muted small">{2}</span>\
                            </div>\
                        </a>\
                    </li>'.format(data[i]['info'],data[i]['level'],DateUtil.getRelativeDateInfo(new Date(),new Date(data[i]['time']))));}
arrHtml.push('<li class="dropdown-header"><a href="javascript:;">See All Alarms></a></li>');$imgBadge.html('&nbsp;');}
$('#ulAlarmPanel').html(arrHtml.join(''));},menuScreenFactory:function(type){var screen=undefined;switch(type){case'ObserverScreen':case'observer':screen='temp';break;case'DiagnosisScreen':case'diagnosis':screen=DiagnosisScreen;break;case'AnalysisScreen':case'analysis':screen=AnalysisScreen;break;case'ReportScreen':case'report':screen=ReportScreen;break;case'WorkflowMine':case'workFlow':screen=WorkflowMine;break;case'EnergyScreen':case'energy':screen=EnergyScreen;break;case'DataCenter3D':screen=DataCenter3D;break;case'DropDownList':case'dropDownList':screen='temp';break;default:break;}
return screen;},initMenu:function(pages){var _this=this;var ulPages=$("#ulPages");var navBtnA=$('#ulPages .nav-btn-a')
I18n.fillArea(ulPages);var ulTag=document.getElementById('ulObserverScreenList');if(ulTag){ulTag.innerHTML='<div class="arrow"></div>';for(var i=0,page,liTag,aTag,len=pages.length;i<len;i++){page=pages[i];liTag=document.createElement("li");aTag=document.createElement("a");aTag.textContent=page.name;aTag.id="page-"+page.id;$(aTag).eventOn('click',function(e){Spinner.spin(ElScreenContainer);ScreenManager.show(ObserverScreen,e.currentTarget.id.split('-')[1]);});liTag.appendChild(aTag);ulTag.appendChild(liTag);}}
navBtnA.eventOff('click').eventOn('click',function(e){var currentTarget=e.currentTarget;var screen=_this.menuScreenFactory(currentTarget.getAttribute('page-type'));if(!screen){return false;}
if(currentTarget.attributes['pageId']){var pageId=currentTarget.attributes['pageId'].value;if(screen===ReportScreen){var pageFolder=currentTarget.attributes['report-folder'].value,pageType=currentTarget.attributes['report-type'].value;ScreenManager.show(screen,pageId,pageType,pageFolder);}else{ScreenManager.show(screen,pageId);}}else{ScreenManager.show(screen);}});ulPages.show();},initDefaultPage:function(result){var navItems=result.navItems,observerPages=result.observerPages,firstItem,firstItemType,screen,pageId;if(!navItems.length){return false;}
firstItem=navItems[0],firstItemType=firstItem.type,pageId=firstItem.id;if(!firstItemType){return false;}
screen=this.menuScreenFactory(firstItemType);switch(firstItemType){case'ObserverScreen':{pageId=observerPages&&observerPages[0]&&observerPages[0].id;ScreenManager.show(ObserverScreen,pageId);break;}
case'DropDownList':{for(var m=0,len=navItems.length;m<len;m++){if(navItems[m].parent===pageId){pageId=navItems[m].id;screen=this.menuScreenFactory(navItems[m].type);if(navItems[m].type==='ReportScreen'){ScreenManager.show(screen,pageId,navItems[m].reportType,navItems[m].reportFolder);}else{ScreenManager.show(screen,pageId);}
break;}}
break;}
case'ReportScreen':{ScreenManager.show(screen,pageId,firstItem.reportType,firstItem.reportFolder);break;}
default:ScreenManager.show(screen,pageId);}},initDropDownItem:function(dropdownItem){var _this=this,$liTag,$aTag,$dropDownWrapper=$('#DropDownList'+dropdownItem.parent);if(dropdownItem.text.indexOf('observer.menu.')>=0){dropdownItem.text=I18n.findContent(dropdownItem.text);}
$liTag=$('<li></li>').attr('pageid',dropdownItem.id);$aTag=$('<a></a>').text(dropdownItem.text);if(dropdownItem.type!=='DropDownList'){$aTag.eventOn('click',function(){Spinner.spin(ElScreenContainer);if(_this.menuScreenFactory(dropdownItem.type)===ReportScreen){ScreenManager.show(_this.menuScreenFactory(dropdownItem.type),dropdownItem.id,dropdownItem.reportType,dropdownItem.reportFolder);}else{ScreenManager.show(_this.menuScreenFactory(dropdownItem.type),dropdownItem.id);}});}
$liTag.append($aTag);if(dropdownItem.type==='EnergyScreen'||dropdownItem.type==='ReportScreen'){AppConfig.menu[dropdownItem.id]=dropdownItem.text;}else if(dropdownItem.type==='DropDownList'){$liTag.addClass('dropdown-submenu');$liTag.append('<ul class="dropdown-menu popover bottom" id="'+'DropDownList'+dropdownItem.id+'"></ul>');}
$dropDownWrapper.append($liTag);},initNavigationPane:function(navItems){var liTag,spanTag;var uLPages=document.getElementById('ulPages');uLPages.style.width='';uLPages.style.left='';uLPages.innerHTML='';var strLiObserver='<li class="dropdown">\
                    <a class="dropdown-toggle nav-btn-a" id="<%menuId%>" page-type="<%pageType%>" data-toggle="dropdown" aria-expanded="false">\
                        <span>\
                            <svg class="nav-icon-svg" version="1.1" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">\
                            <g class="nav-icon-svg-g">\
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M12.208,0.504h-9c-1.104,0-2,0.896-2,2v9c0,1.104,0.896,2,2,2h9\
                            			c1.104,0,2-0.896,2-2v-9C14.208,1.399,13.313,0.504,12.208,0.504z M27.208,0.504h-9c-1.104,0-2,0.896-2,2v9c0,1.104,0.896,2,2,2h9\
                            			c1.104,0,2-0.896,2-2v-9C29.208,1.399,28.313,0.504,27.208,0.504z M12.208,15.504h-9c-1.104,0-2,0.896-2,2v10c0,1.104,0.896,2,2,2\
                            			h9c1.104,0,2-0.896,2-2v-10C14.208,16.399,13.313,15.504,12.208,15.504z M27.208,15.504h-9c-1.104,0-2,0.896-2,2v10\
                            			c0,1.104,0.896,2,2,2h9c1.104,0,2-0.896,2-2v-10C29.208,16.399,28.313,15.504,27.208,15.504z" />\
                            	</g>\
                            </svg>\
                        </span>\
                        <%menuName%>\
                        <span class="caret"></span>\
                    </a>\
                    <ul id="ulObserverScreenList" class="dropdown-menu popover bottom"></ul>\
                </li>';var strLiDiagnosis='<li>\
                    <a class="nav-btn-a" pageId="<%menuId%>" page-type="<%pageType%>">\
                        <svg class="nav-icon-svg" version="1.1" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">\
                        <g class="nav-icon-svg-g">\
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M20.976,6.535l-0.953-0.531L19,9.008h1L20.976,6.535z\
                                        M18.527,15.022L14.766,0l-3.371,15.157c-0.257,0.549-0.39,1.151-0.392,1.762l-0.002,0.007h0.002\
                                	    c-0.001,0.696,0.167,1.402,0.532,2.048c1.104,1.956,3.548,2.627,5.46,1.497c1.282-0.757,1.995-2.131,1.995-3.545h0.014\
                                	    l-0.013-0.049C18.984,16.247,18.832,15.613,18.527,15.022z M15.003,19.998c-1.658,0-3.001-1.375-3.001-3.072\
                                	    c0-1.695,1.343-3.07,3.001-3.07c1.657,0,3.001,1.375,3.001,3.07C18.004,18.623,16.66,19.998,15.003,19.998z M17.745,2.28\
                                	    l-0.392,1.962C22.854,5.336,27,10.187,27,16.008c0,6.627-5.373,12-12,12s-12-5.373-12-12c0-5.821,4.146-10.672,9.646-11.766\
                                	    L12.254,2.28C5.838,3.557,1,9.216,1,16.008c0,7.732,6.268,14,14,14s14-6.268,14-14C29,9.216,24.162,3.557,17.745,2.28z M22,11.008\
                                	    v1l2.801-1.387L24.251,9.7L22,11.008z M4,16.008h3v-1H4V16.008z M26,16.008v-1h-3v1H26z M10,9.008h1L9.976,6.004L9.023,6.535\
                                	    L10,9.008z M8.606,11.295L5.749,9.7l-0.55,0.921l2.858,1.595L8.606,11.295z M15.003,14.879c-1.105,0-2.001,0.917-2.001,2.047\
                                	    c0,1.131,0.896,2.048,2.001,2.048c1.104,0,2-0.917,2-2.048C17.003,15.796,16.107,14.879,15.003,14.879z" />\
                                </g>\
                            </svg>\
                        <%menuName%>\
                    </a>\
                </li>';var strLiAnalysis='<li>\
                <a class="nav-btn-a" pageId="<%menuId%>" page-type="<%pageType%>">\
                    <span>\
                        <svg class="nav-icon-svg" version="1.1" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">\
                        <g class="nav-icon-svg-g">\
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M28.775,15.645c0-4.414-2.228-8.306-5.619-10.619\
                                    c0.066-0.275,0.11-0.559,0.11-0.854c0-2.027-1.644-3.671-3.672-3.671c-1.546,0-2.862,0.957-3.405,2.308\
                                    c-0.09-0.002-0.178-0.014-0.268-0.014c-7.035,0-12.742,5.651-12.845,12.66c-1.35,0.543-2.305,1.858-2.305,3.402\
                                    c0,2.027,1.644,3.671,3.672,3.671c0.205,0,0.402-0.028,0.599-0.061c2.274,3.616,6.29,6.027,10.878,6.027\
                                    c1.729,0,3.376-0.347,4.882-0.966c0.652,0.594,1.512,0.966,2.463,0.966c2.028,0,3.673-1.645,3.673-3.672\
                                    c0-0.662-0.189-1.274-0.496-1.811C27.908,20.925,28.775,18.388,28.775,15.645z M25.133,21.678\
                                    c-0.549-0.326-1.182-0.526-1.867-0.526c-2.028,0-3.672,1.645-3.672,3.672c0,0.395,0.079,0.769,0.194,1.125\
                                    c-1.205,0.452-2.504,0.711-3.867,0.711c-3.842,0-7.22-1.969-9.192-4.948c0.839-0.673,1.388-1.694,1.388-2.854\
                                    c0-1.864-1.394-3.387-3.193-3.623C5.141,9.343,9.974,4.631,15.92,4.631c0.016,0,0.031,0.002,0.046,0.002\
                                    c0.229,1.808,1.756,3.21,3.626,3.21c1.064,0,2.015-0.46,2.686-1.183c2.816,1.995,4.66,5.271,4.66,8.984\
                                    C26.938,17.873,26.271,19.944,25.133,21.678z" />\
                            </g>\
                        </svg>\
                    </span>\
                        <%menuName%>\
                </a>\
            </li>';var strLiReport='<li>\
                    <a class="nav-btn-a" pageId="<%menuId%>" page-type="<%pageType%>" report-type="<%reportType%>" report-folder="<%reportFolder%>">\
                        <span>\
                            <svg class="nav-icon-svg" version="1.1" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">\
                            <g class="nav-icon-svg-g">\
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M20.008,1h-15c-2.319,0-2,1.135-2,3v22c0,2.479-0.32,3,2,3h19\
                                		c2.748,0,3-0.608,3-3V8C22.81,3.891,25.614,5.949,20.008,1z M25.008,25c0,1.813-0.071,2-2,2h-16c-1.603,0-2-0.014-2-2V5\
                                		c0-2.797-0.031-2,2-2h12c0.015,2.575,0,4,0,4c0,2.089,0.906,3,3,3h3V25z M9.008,15h13v-2h-13V15z M9.008,20h13v-2h-13V20z" />>\
                                </g>\
                            </svg>\
                        </span>\
                        <%menuName%>\
                    </a>\
                </li>';var strLiEnergy='<li>\
                    <a class="nav-btn-a" pageId="<%menuId%>" page-type="<%pageType%>">\
                        <span>\
                            <svg class="nav-icon-svg" version="1.1" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">\
                            <g class="nav-icon-svg-g">\
                            <path d="M4,1H1v28h28v-3H4V1z M9.339,21c1.292,0,2.339-1.091,2.339-2.437c0-0.491-0.14-0.947-0.379-1.33l4.1-4.849\
                                        c0.067,0.006,0.135,0.009,0.204,0.009s0.137-0.003,0.204-0.009l2.982,4.849c-0.239,0.383-0.379,0.839-0.379,1.33\
                                        c0,1.346,1.047,2.437,2.338,2.437c1.292,0,2.34-1.091,2.34-2.437c0-0.51-0.15-0.982-0.407-1.374l3.825-6.322\
                                        c0.051,0.004,0.103,0.006,0.154,0.006c1.292,0,2.34-1.091,2.34-2.437S27.952,6,26.66,6c-1.291,0-2.339,1.091-2.339,2.437\
                                        c0,0.51,0.15,0.982,0.407,1.373l-3.825,6.323c-0.052-0.004-0.103-0.006-0.155-0.006c-0.068,0-0.137,0.004-0.204,0.01l-2.982-4.85\
                                        c0.24-0.383,0.38-0.839,0.38-1.33c0-1.346-1.047-2.437-2.339-2.437s-2.339,1.091-2.339,2.437c0,0.491,0.14,0.947,0.379,1.33\
                                        l-4.099,4.85c-0.067-0.006-0.136-0.01-0.205-0.01C8.047,16.127,7,17.218,7,18.563S8.047,21,9.339,21z" />\
                                </g>\
                            </svg>\
                        </span>\
                        <%menuName%>\
                    </a>\
                </li>';var strLiDropDownList='<li class="dropdown">\
                    <a class="dropdown-toggle nav-btn-a" page-type="dropDownList" pageId="<%menuId%>" data-toggle="dropdown" aria-expanded="false">\
                        <span>\
                            <svg class="nav-icon-svg" version="1.1" x="0px" y="0px" width="30px" height="30px" viewBox="0 0 30 30" enable-background="new 0 0 30 30" xml:space="preserve">\
                            <g class="nav-icon-svg-g">\
                            <path d="M4,1H1v28h28v-3H4V1z M9.339,21c1.292,0,2.339-1.091,2.339-2.437c0-0.491-0.14-0.947-0.379-1.33l4.1-4.849\
                                        c0.067,0.006,0.135,0.009,0.204,0.009s0.137-0.003,0.204-0.009l2.982,4.849c-0.239,0.383-0.379,0.839-0.379,1.33\
                                        c0,1.346,1.047,2.437,2.338,2.437c1.292,0,2.34-1.091,2.34-2.437c0-0.51-0.15-0.982-0.407-1.374l3.825-6.322\
                                        c0.051,0.004,0.103,0.006,0.154,0.006c1.292,0,2.34-1.091,2.34-2.437S27.952,6,26.66,6c-1.291,0-2.339,1.091-2.339,2.437\
                                        c0,0.51,0.15,0.982,0.407,1.373l-3.825,6.323c-0.052-0.004-0.103-0.006-0.155-0.006c-0.068,0-0.137,0.004-0.204,0.01l-2.982-4.85\
                                        c0.24-0.383,0.38-0.839,0.38-1.33c0-1.346-1.047-2.437-2.339-2.437s-2.339,1.091-2.339,2.437c0,0.491,0.14,0.947,0.379,1.33\
                                        l-4.099,4.85c-0.067-0.006-0.136-0.01-0.205-0.01C8.047,16.127,7,17.218,7,18.563S8.047,21,9.339,21z" />\
                                </g>\
                            </svg>\
                        </span>\
                        <%menuName%>\
                        <span class="caret"></span>\
                    </a>\
                    <ul class="dropdown-menu popover bottom" id="<%parentId%>"><div class="arrow"></div></ul>\
                </li>';var dropDownItems=[];AppConfig.menu={};if(!navItems)return;for(var i=0;i<navItems.length;i++){if(!navItems[i].parent||navItems[i].parent==''){spanTag=navItems[i].text;if(AppConfig.isMobile){spanTag='';}else{if(spanTag.indexOf('observer.menu.')>=0){spanTag='<span class="nav-btn-text">'+I18n.findContent(spanTag)+'</span>';}else{spanTag='<span class="nav-btn-text">'+spanTag+'</span>';}}switch(navItems[i].type){case'ObserverScreen':liTag=strLiObserver;break;case'DiagnosisScreen':liTag=strLiDiagnosis;break;case'AnalysisScreen':liTag=strLiAnalysis;break;case'ReportScreen':liTag=strLiReport;liTag=liTag.replace('<%reportType%>',navItems[i].reportType).replace('<%reportFolder%>',navItems[i].reportFolder);AppConfig.menu[navItems[i].id]=navItems[i].text;break;case'EnergyScreen':liTag=strLiEnergy;AppConfig.menu[navItems[i].id]=navItems[i].text;break;case'DropDownList':liTag=strLiDropDownList.replace('<%parentId%>','DropDownList'+navItems[i].id);break;case'WorkflowMine':liTag=strLiReport;break;default:break;}
uLPages.innerHTML+=liTag.replace('<%menuName%>',spanTag).replace('<%menuId%>',navItems[i].id).replace('<%pageType%>',navItems[i].type);}else{dropDownItems.push(navItems[i]);}}
for(var ele in dropDownItems){this.initDropDownItem(dropDownItems[ele]);}},filterByAlarmRule:function(data){var result=[];var rules=JSON.parse(localStorage.getItem('alarm_rules'));var row=deadline=key=null;if(!rules||!(rules=rules[AppConfig.projectId]))return data;for(var i=0,len=data.length;i<len;i++){row=data[i];key=window.encodeURIComponent(row['bindpointname']+'_'+row['time']);if(!(deadline=rules[key])){result.push(row);continue;}
if(data[i]['endtime']>=deadline){result.push(row);}}
return result;},clearMenu:function(){$('#liProjectMenu').hide();$('#projectMenu').hide();$('#liProjectAlarm').hide();BackgroundWorkers.alarmReporter.postMessage({type:'clearTimer',name:'dataAlarmRealtime'});this.refreshAlarmPanel([]);$("#ulPages").empty();},clearMenuActive:function(){},logout:function(){WebAPI.get('/logout/'+AppConfig.userId);AppConfig={};localStorage.removeItem("userInfo");location.reload();}};return PaneProjectSelector;})();var VersionHistory=(function(){function VersionHistory(){this.configMap={templateURL:"static/views/admin/versionHistory.html",addVersionHistoryTitleGreed:I18n.resource.admin.versionHistory.VERSION_HISTORY_TITLE,addVersionHistoryContentGreed:I18n.resource.admin.versionHistory.VERSION_HISTORY_CONTENT,versionHistoryEditBtnClass:'.version-history-edit',versionHistoryDeleteBtnClass:'.version-history-delete'};this.jqueryMap={};this.apiMap={getVersionHistory:'workflow/versionHistory/getAll',addVersionHistory:'workflow/versionHistory/add',updateVersionHistory:'workflow/versionHistory/update',getAccurateVersionHistory:'workflow/versionHistory/getAccurate',deleteVersionHistory:'workflow/versionHistory/delete'};this.templateId={setVersionPanelList:'versionHistoryPlate_init'};this.UEeditor=null;}
VersionHistory.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.configMap.templateURL+'?t='+new Date().getTime()).done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.init().done(function(){_this.attachEvent();I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});});},init:function(){var _this=this;return WebAPI.get(this.apiMap.getVersionHistory).done(function(result){var isPermission,html='<button type="button" class="btn btn-success pull-right" id="versionHistory-add" i18n="admin.versionHistory.ADD_VERSION_HISTORY"></button>';AppConfig.userId==1?(isPermission=true,$('.versionHistory-add-container').append(html)):isPermission=false;_this.setJqueryMap();if(result.data!==null&&result.data.length){$('#versionHistory-container').html(beopTmpl(_this.templateId.setVersionPanelList,{versionList:result.data,isPermission:isPermission}));}})},setJqueryMap:function(){this.jqueryMap={UEditor:$('#versionHistory-UEditor'),UEditorIdName:'versionHistory-UEditor',modal:$('#versionHistory-modal')}},attachEvent:function(){var _this=this;this.jqueryMap.modal=$('#versionHistory-modal');var UEDITOR,verisonDescription,versionTitle,versionId;var $versionHistoryTitle=this.jqueryMap.modal.find('#versionHistory-modal-title'),$versionHistoryCommit=this.jqueryMap.modal.find('#versionHistory-commit'),$versionHistoryBody=$('#versionHistory'),$versionHistoryEditBtn=$(this.configMap.versionHistoryEditBtnClass),$versionHistoryAdd=$('#versionHistory-add'),$versionHistoryDeleteBtn=$(this.configMap.versionHistoryDeleteBtnClass);$versionHistoryEditBtn.off();$versionHistoryBody.on('click',this.configMap.versionHistoryEditBtnClass,function(){var $this=$(this);verisonDescription=$.trim($this.parent().next().html());versionTitle=$.trim($this.prev().text());$versionHistoryCommit.attr('data-type','edit');versionId=$this.parent().parent().attr('data-version-history-id');$versionHistoryTitle.text(versionTitle).attr('contenteditable',false);_this.jqueryMap.modal.modal({keyboard:false,backdrop:'static'});});$versionHistoryDeleteBtn.off();$versionHistoryBody.on('click',this.configMap.versionHistoryDeleteBtnClass,function(){var $this=$(this),$parent=$this.parent().parent();versionId=$parent.attr('data-version-history-id');var isSureDelete=confirm(I18n.resource.admin.versionHistory.VERSION_HISTORY_DELETE);if(isSureDelete){Spinner.spin(ElScreenContainer);WebAPI.post(_this.apiMap.deleteVersionHistory+'/'+AppConfig.userId+'/'+versionId).done(function(){$parent.remove();Alert.success(ElScreenContainer,I18n.resource.admin.versionHistory.VERSION_HISTORY_DELETE_SUCCESS).showAtTop(200);}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.versionHistory.VERSION_HISTORY_DELETE_FAILED).showAtTop(200);}).always(function(){Spinner.stop();})}});$versionHistoryAdd.off().on('click',function(){verisonDescription=_this.configMap.addVersionHistoryContentGreed;versionTitle=_this.configMap.addVersionHistoryTitleGreed;$versionHistoryCommit.attr('data-type','new');$versionHistoryTitle.text(versionTitle).attr('contenteditable',false);_this.jqueryMap.modal.modal({keyboard:false,backdrop:'static'});});_this.jqueryMap.modal.on('shown.bs.modal',function(){var $modalBody=_this.jqueryMap.modal.find('.modal-body'),width=$modalBody.width();Spinner.spin($modalBody.get(0));UEDITOR=new UE.ui.Editor({initialFrameHeight:400,initialFrameWidth:width});UEDITOR.setOpt(window.UEDITOR_CONFIG.toolbars);UEDITOR.render(_this.jqueryMap.UEditorIdName);UEDITOR.ready(function(){_this.UEeditor=UEDITOR;UEDITOR.setContent(verisonDescription);Spinner.stop();});});this.jqueryMap.modal.find('button[data-close="modal"]').off().on('click',function(ev){ev.stopPropagation();ev.preventDefault();var isHide=confirm(I18n.resource.admin.versionHistory.VERSION_HISTORY_ALERT);if(isHide){_this.jqueryMap.modal.modal('hide');}else{return false;}});this.jqueryMap.modal.on('hidden.bs.modal',function(){UEDITOR.destroy();});$versionHistoryTitle.off().on('click',function(){var html='<input type="text"/',$this=$(this),text=$this.text();$this.attr('contenteditable',true);});$versionHistoryCommit.off().on('click',function(){var $this=$(this),attr=$this.attr('data-type');switch(attr){case'new':_this.addVersion();break;case'edit':_this.updateVersion(versionId);break;}});},addVersion:function(){var UE=this.UEeditor,_this=this;var html=$.trim(UE.getContent()),txt=$.trim(UE.getContentTxt()),userId=AppConfig.userId,title=$.trim(this.jqueryMap.modal.find('#versionHistory-modal-title').text());if(title==this.configMap.addVersionHistoryTitleGreed||txt==this.configMap.addVersionHistoryContentGreed){Alert.danger(ElScreenContainer,I18n.resource.admin.versionHistory.TIPS).showAtTop(200);return false;}
Spinner.spin(this.jqueryMap.modal.get(0));WebAPI.post(this.apiMap.addVersionHistory+'/'+userId,{title_version:title,userId:userId,html:html,txt:txt}).done(function(result){var getNewVersion=function(id){return WebAPI.get(_this.apiMap.getAccurateVersionHistory+'/'+id).done(function(result){if(result.data){var data=result.data;$('#versionHistory-container').prepend(beopTmpl('versionHistoryPlate_init',{versionList:[{version:data.version,log:data.log,id:data.id,userId:userId}],isPermission:true}));}})};getNewVersion(result.data.versionId).done(function(){Alert.success(ElScreenContainer,I18n.resource.admin.versionHistory.ADD_SUCCESS).showAtTop(200);}).always(function(){Spinner.stop();_this.jqueryMap.modal.modal('hide');});}).always(function(){}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.versionHistory.ADD_FAILED).showAtTop(200);})},updateVersion:function(versionId){var UE=this.UEeditor,_this=this;var html=UE.getContent(),txt=UE.getContentTxt(),userId=AppConfig.userId,title=$(this.jqueryMap.modal.find('#versionHistory-modal-title')).text();Spinner.spin(this.jqueryMap.modal.get(0));WebAPI.post(this.apiMap.updateVersionHistory+'/'+userId+'/'+versionId,{title_version:title,userId:userId,html:html,txt:txt,versionId:versionId}).done(function(){var getNewVersion=function(id){return WebAPI.get(_this.apiMap.getAccurateVersionHistory+'/'+id).done(function(result){if(result.data){var data=result.data;$('#versionHistory-container').find('div').each(function(){var $this=$(this),versionHistoryID=$this.attr('data-version-history-id');if(versionHistoryID==versionId){$this.replaceWith(beopTmpl('versionHistoryPlate_init',{versionList:[{version:data.version,log:data.log,id:data.id,userId:userId}],isPermission:true}))}});}})};getNewVersion(versionId).done(function(){Alert.success(ElScreenContainer,I18n.resource.admin.versionHistory.UPDATE_SUCCESS).showAtTop(200);}).always(function(){Spinner.stop();_this.jqueryMap.modal.modal('hide');});}).always(function(){_this.jqueryMap.modal.modal('show');}).fail(function(){Alert.danger(ElScreenContainer,I18n.resource.admin.versionHistory.UPDATE_FAILED).showAtTop(200);})},detachEvents:function(){this.jqueryMap.modal.off();},close:function(){this.detachEvents();}};return VersionHistory;})();﻿var ElScreenContainer=document.getElementById('indexMain');var ScreenCurrent=undefined;var ScreenModal=undefined;var ScreenPrevious=undefined;var ToolCurrent=undefined;var Spinner=new LoadingSpinner({color:'#00FFFF'});var AppConfig={projectId:undefined,projectName:undefined,userId:undefined,account:undefined,level:undefined,projectList:undefined,isMobile:false,chartTheme:'macarons'};var I18n=undefined;var BackgroundWorkers={};LoadingAnimationStep=2;$(document).ready(function(){if(navigator.userAgent.match(/iP(ad|hone|od)|Android/i))AppConfig.isMobile=true;$("#ulPages").hide();InitI18nResource(navigator.language.split('-')[0]);});var IndexScreen=(function(){function IndexScreen(){};IndexScreen.prototype={show:function(){this.init();if(I18n.type=='en'){$('#indexMain').off('mousewheel');}else{$('.totalDown').show();$('#indexMain').on('mousewheel',function(e){location.href='/static/views/homeSlider/showPage.html';});}},close:function(){document.onkeydown=false;$('.totalDown').hide();$('#indexMain').off('mousewheel');},init:function(){var _this=this;$("#containerBackground").remove();$("#navHomeLogo").off('click').click(function(e){if(!AppConfig.userId)return;ScreenManager.show(PaneProjectSelector);});_this.initLogin();_this.initRegister();_this.initResetPassword();$("#selectLanguage a").off('click').click(function(e){InitI18nResource(e.currentTarget.attributes.value.value,true);e.preventDefault();});$(".login-feature-pane > div").hover(function(e){document.getElementsByName('div-img-default')[0].style.display='none';var element=document.getElementsByName(e.currentTarget.className.replace('grow login-','div-img-'))[0];element.style.display='block';},function(e){document.getElementsByName('div-img-default')[0].style.display='block';var element=document.getElementsByName(e.currentTarget.className.replace('grow login-','div-img-'))[0];element.style.display='none';});I18n.fillArea($('#divLanguage').fadeIn());I18n.fillArea($('#divLogin').css('visibility','visible').fadeIn());I18n.fillArea($('#navPane'));},initLogin:function(){this.restorePwd();var _this=this;$("#btnLogin").click(function(e){_this.login();});$(document).on("keydown","#divLogin input",function(event){var e=event||window.event||arguments.callee.caller.arguments[0];if(e&&e.keyCode==13){_this.login();}});I18n.fillArea($('#paneLogin'));$('#txtName').attr('placeholder',I18n.resource.admin.login.PANE_PLACEHOLDER_ACCOUNT);$('#txtPwd').attr('placeholder',I18n.resource.admin.login.PANE_PLACEHOLDER_PWD);},initResetPassword:function(){var $resetModal=$('#resetPasswordModal'),$passwordResetBtn=$('#passwordResetBtn'),$inputEmail=$resetModal.find('#inputEmail'),isValidEmail,addValidStatus,removeValidStatus,errorTooltip;I18n.fillArea($resetModal);addValidStatus=function(msg){errorTooltip=$inputEmail.tooltip({container:'body',placement:"right",trigger:"manual",template:'<div class="tooltip" role="tooltip">'+'<div class="tooltip-arrow" style="border-right-color: rgb(165, 42, 42);"></div>'+'<div class="tooltip-inner" style="background-color: rgb(165, 42, 42);"></div>'+'</div>',html:true,title:(msg||'')})
errorTooltip.tooltip('show');};removeValidStatus=function(){errorTooltip&&errorTooltip.tooltip('destroy');};isValidEmail=function(email){if(!email){return false;}
return RegExp('^[a-zA-Z0-9_-|\\.]+@[a-zA-Z0-9_-]+(?:\\.[a-zA-Z0-9_-]+)+$','g').test(email);};$inputEmail.on('keydown',removeValidStatus);$resetModal.on('shown.bs.modal',function(){$inputEmail.val($('#txtName').val());}).on('hide.bs.modal',function(){removeValidStatus();});$passwordResetBtn.click(function(){if(!$inputEmail.val()){addValidStatus(I18n.resource.observer.widgets.EMAIL_ADDRESS_REQUIRED);return false;}
if(!isValidEmail($inputEmail.val())){addValidStatus(I18n.resource.observer.widgets.INVALID_EMAIL_ADDRESS);return false;}
Spinner.spin($("#resetPasswordModal .modal-content").get(0));WebAPI.post('/send_reset_pwd_email',{email:$inputEmail.val(),serverURL:location.origin}).done(function(result){if(result==='success'){$passwordResetBtn.addClass('btn-success');setTimeout(function(){$passwordResetBtn.removeClass('btn-success').removeAttr('disabled');Spinner.stop();},3000);}else{if(result==='email was sent'){addValidStatus(I18n.resource.observer.widgets.EMAIL_PASSWORD_SENT+'！');}else if(result==="email is not exist"){addValidStatus(I18n.resource.observer.widgets.EMAIL_NOT_EXIST+'！');}else if(result==="account is not activated."){addValidStatus(I18n.resource.observer.widgets.EMAIL_NOT_ACTIVATED+'！');}}}).fail(function(){addValidStatus(I18n.resource.observer.widgets.EMAIL_FAILED_SEND);}).always(function(){Spinner.stop();});});},initRegister:function(){var _this=this;var $iptMailAddr=$('#iptMailAddr');var $panes=$('#regContent').find('.modal-body');var util={panes:{show:function(index){$panes.hide();$panes.eq(index).show();}},tooltip:{show:function($ele,cnt,delay){$ele.attr('data-original-title',cnt);$ele.tooltip('show');if($ele[0].timer){window.clearTimeout($ele[0].timer);$ele[0].timer=null;}
$ele[0].timer=window.setTimeout(function(){$ele.tooltip('hide');},delay||3000);},hide:function($ele){$ele.tooltip('hide');}},mail:{changeStatus:function(mail,status,msg){var $tipWrap=$('#mailTipWrap'),$tip=$tipWrap.children('span').eq(1),$links=$('#mailLinksWrap').children('a'),$linkReturn=$links.eq(0),$linkMail=$links.eq(1),$icon=$tipWrap.find('.glyphicon').eq(0),cls=$icon.attr('class').replace(/\s*\b(?:glyphicon-).+?\b\s*/,' ').trim();var mailhost=null;$icon.attr('class',cls);$tip.text(msg);switch(status){case'success':$tipWrap.addClass('txt-success');$icon.addClass('glyphicon-ok');$linkReturn.show();mailhost=this.getMailHost(mail);mailhost&&$linkMail.attr('href','http://'+mailhost).show();break;case'warn':$tipWrap.addClass('txt-warning');$icon.addClass('glyphicon-alert');$linkReturn.show();mailhost=this.getMailHost(mail);mailhost&&$linkMail.attr('href','http://'+mailhost).show();break;case'error':$tipWrap.addClass('txt-danger');$icon.addClass('glyphicon-remove');$linkReturn.show();$linkMail.hide();break;default:$tipWrap.removeClass('txt-danger txt-success');$icon.addClass('glyphicon-exclamation-sign');$linkReturn.show();$linkMail.hide();break;}},getMailHost:function(mail){var str=mail.split('@')[1].toLowerCase();switch(str){case'163.com':return'mail.163.com';case'vip.163.com':return'vip.163.com';case'mail.126.com':return'mail.126.com';case'qq.com':case'vip.qq.com':case'foxmail.com':return'mail.qq.com';case'gmail.com':return'mail.google.com';case'sohu.com':return'mail.sohu.com';case'tom.com':return'mail.tom.com';case'vip.sina.com':return'vip.sina.com';case'sina.com.cn':case'sina.com':return'mail.sina.com.cn';case'yahoo.com.cn':case'yahoo.cn':return'mail.cn.yahoo.com';case'yeah.net':return'www.yeah.net';case'21cn.com':return'mail.21cn.com';case'hotmail.com':return'www.hotmail.com';case'sogou.com':return'mail.sogou.com';case'188.com':return'www.188.com';case'139.com':return'mail.10086.cn';case'189.cn':return'webmail15.189.cn/webmail';case'wo.com.cn':return'mail.wo.com.cn/smsmail';case'rnbtech.com.hk':return'mail.rnbtech.com.hk';default:return false;}}},inputbox:{changeStatus:function($ele,status){var $wrap=$ele.parentsUntil('.form-group'),$icon=$wrap.find('.glyphicon').eq(0),cls=$icon.attr('class').replace(/\s*\b(?:glyphicon-).+?\b\s*/,' ').trim();$icon.attr('class',cls);switch(status){case'success':$wrap.addClass('has-success');$icon.addClass('glyphicon-ok');break;case'error':$wrap.addClass('has-error');$icon.addClass('glyphicon-remove');break;case'default':default:$wrap.removeClass('has-error has-success');$icon.addClass('glyphicon-pencil');break;}}}};$iptMailAddr.tooltip({title:'',trigger:'manual'});$('#btnRegister').click(function(){util.inputbox.changeStatus($iptMailAddr,'default');I18n.fillArea($('#regContent'));$('#regContent').modal('show');});$('#mailReinput').click(function(){util.panes.show(0);});$('#userSave').click(function(){var addr=$iptMailAddr.val().trim();var $this=$(this);var $mailLoadingWrap=$('#mailLoadingWrap');var $mailRstWrap=$('#mailRstWrap');if(!addr){util.tooltip.show($iptMailAddr,'邮箱地址不能为空！');util.inputbox.changeStatus($iptMailAddr,'error');return;}
if(!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(addr)){util.tooltip.show($iptMailAddr,'邮箱格式有误！');util.inputbox.changeStatus($iptMailAddr,'error');return;};util.inputbox.changeStatus($iptMailAddr,'default');$this.prop('disabled',true);util.panes.show(1);WebAPI.post('/apply_for_registration',{email:addr,server_url:window.location.origin}).done(function(rs){rs=JSON.parse(rs);var tips='';var s='success';var status=rs.status;switch(status){case 0:s='success';tips='邮件已经成功发送至您的邮箱，10分钟内有效，请您及时访问注册！';break;case-1:s='error';tips='该邮箱地址已经被注册过，请直接登录！';break;case-2:s='warn';tips='邮件已经发送，10分钟内不能重发，请检查您的邮箱！';break;case-3:default:s='error';tips='邮件发送失败，可能是网络故障，请稍后重试！';break;}
util.mail.changeStatus(addr,s,tips);}).fail(function(err){util.mail.changeStatus(addr,'error','邮件发送失败，可能是网络故障，请稍后重试！');}).always(function(){util.panes.show(2);$this.prop('disabled',false);});});},login:function(){var _this=this;var $btnLogin=$('#btnLogin');$btnLogin.find('.spinner').show();$btnLogin.find('span').hide();$btnLogin.attr('disabled','disabled');var txtName=$("#txtName").val(),txtPwd=$("#txtPwd").val();var loginFail=function(msg){$('.alert').remove();new Alert($("#divLogin"),"danger",msg).show().close();$btnLogin.find('.spinner').hide();$btnLogin.find('span').show();$btnLogin.removeAttr('disabled');}
if(!(txtName&&txtPwd)){loginFail(I18n.resource.observer.widgets.WARNING_EMPTY_ACCOUTN_OR_PASSWORD)
return;}
WebAPI.post("/login",{name:txtName,pwd:txtPwd,agent:jscd?jscd:{}}).then(function(_login_result){try{var login_result=JSON.parse(_login_result);var after_login=function(){if(login_result.status!=undefined&&login_result.status==true){if(login_result.userProfile.isManager==0||login_result.userProfile.fullname!='admin'){$('#btnWikiManage').remove();$('#btnBenchmark').remove();}
if(login_result.userProfile.isManager===0){$("#btnMemberManage").remove();}
if(login_result.projects&&login_result.projects.length>0){_this.rememberPwd();window.localStorage.setItem("versionHistory",login_result.version);AppConfig.userId=login_result.id;AppConfig.account=$("#txtName").val();AppConfig.projectList=login_result.projects;AppConfig.userProfile=login_result.userProfile;AppConfig.userOfRole=login_result.userProfile.userOfRole;$('#navHeader').fadeIn();$('#indexMain').animate({top:'55px'});LoadingAnimationStep='end';ScreenManager.show(PaneProjectSelector);}else{loginFail("<strong>"+I18n.resource.observer.widgets.LOAD_PROJECT_FAILED+"</strong> "+I18n.resource.observer.widgets.NO_PERMISSION_PROJECT+"！");}}else{loginFail("<strong>"+I18n.resource.observer.widgets.LOG_IN_FAILED+"</strong> "+I18n.resource.observer.widgets.INVALID_ACCOUNT_PASSWORD+"！");}}}catch(e){loginFail("<strong>"+I18n.resource.observer.widgets.LOG_IN_FAILED+"！");return false;}
if(!login_result.ip){after_login();}else{$.ajax({url:'http://int.dpool.sina.com.cn/iplookup/iplookup.php?format=js&ip='+login_result.ip,dataType:"script",timeout:2000}).done(function(){try{if(remote_ip_info&&remote_ip_info.ret>0){AppConfig.isGoogleServiceAvailable=_this.isGoogleServiceAvailable(remote_ip_info.country,remote_ip_info.province);}else{AppConfig.isGoogleServiceAvailable=false;}}catch(e){AppConfig.isGoogleServiceAvailable=false;}}).fail(function(){console.warn('无法获得IP地址解析');}).always(function(){after_login();})}}).always(function(){Spinner.stop();})},isGoogleServiceAvailable:function(country,province){if(country==='中国'){switch(province){case'香港':return true;case'澳门':return true;case'台湾':return true;default:return false;}}else{return true;}},rememberPwd:function(){if($("#cbRememberPwd").is(":checked")){localStorage["userInfo"]=JSON.stringify({name:$("#txtName").val(),pwd:$("#txtPwd").val()});}
else{localStorage.removeItem("userInfo");}},restorePwd:function(){if(localStorage["userInfo"]){var data=JSON.parse(localStorage["userInfo"]);if(data.pwd&&data.pwd!=""){$("#cbRememberPwd").attr("checked",true);$("#txtName").val(data.name);$("#txtPwd").val(data.pwd);}}}};return IndexScreen;})();function InitI18nResource(strLanguage,isForce){if(strLanguage=='')return;if(isForce){localStorage["isUserSelectedLanguage"]=strLanguage;}
else if(localStorage["isUserSelectedLanguage"]){strLanguage=localStorage["isUserSelectedLanguage"];}
$.getScript("/static/views/js/i18n/"+strLanguage+".js").done(function(e){localStorage["language"]=strLanguage;localStorage["i18n"]=JSON.stringify(i18n_resource);Init();}).error(function(e){if(!localStorage["i18n"]){$.getScript("/static/views/js/i18n/en.js").done(function(e){localStorage["language"]="en";localStorage["i18n"]=JSON.stringify(i18n_resource);Init();})}});if(I18n){if(I18n.type=='en'){$('.totalDown').show();}else{$('.totalDown').hide();}}}
function Init(){I18n=new Internationalization();ScreenManager.show(IndexScreen);I18n.fillArea($(".navbar"));}
var beop;(function(beop){var configMap={AmapKey:'9cc89c68a4bd6f3f5f65589f85ad7685',AmapUrl:'http://webapi.amap.com/maps',AmapVersion:'1.3',GmapKey:'AIzaSyAzzOzAmrGov5GLacve9w8_Q8dS-xBYCgc',GmapUrl:'https://maps.googleapis.com/maps/api/js',GmapVersion:'3.0',mapContainer:'map-canvas',project_img_path:'/static/images/project_img/',mapLoadCallBack:'mapLoadCallBack',defaultLatlng:'31.2114943,121.6283679',projectStatus:{online:'Online',offline:'Offline'},online_img_path:'/static/images/map_marker_online.png',offline_img_path:'/static/images/map_marker_offline.png',neighbouringRadius:80000,loadMapTimeout:3000};function inherits(clazz,base){var clazzPrototype=clazz.prototype;function F(){}
F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;}
function buildSrc(url,opts){if(!url){return null}
if(!opts){return url}
var paramArr=[];for(var prop in opts){if(opts[prop]){paramArr.push(prop+'='+opts[prop]);}}
return url+'?'+paramArr.join('&');}
function initPanelBtns(pageInfo){if(typeof pageInfo==='string'){try{pageInfo=JSON.parse(pageInfo);}catch(e){pageInfo={};console.error(e);}}
if(!pageInfo.funcNavItems||!pageInfo.funcNavItems.length){$('#cardBtnPanel').hide();}else{$('#cardBtnPanel').show();var firstEnergy;if(pageInfo.navItems.length>0){for(var item in pageInfo.navItems){if(pageInfo.navItems[item].type=='EnergyScreen'){firstEnergy=pageInfo.navItems[item];break;}}}
pageInfo.firstObserverScreenId=pageInfo.observerPages[0]&&pageInfo.observerPages[0].id;var btnsHtml=beopTmpl('mapCardBtnsTmpl',pageInfo);var $mapNavFunc=$('#map-nav-func').empty().html(btnsHtml);I18n.fillArea($mapNavFunc);}}
function getProject(id){for(var n=0,len=AppConfig.projectList.length;n<len;n++){var item=AppConfig.projectList[n];if(item.id==id){return item;}}}
function BeopMap(){this.url='';this.key='';this.container=configMap.mapContainer;this.map=null;this.zoom=5;this.markers={};this.infoWindows={};this.paneProjectSelector=new PaneProjectSelector();this.$projectDetailCard=$('#projectDetailCard');this.$projectsCard=$('#projectsCard');this.$nearbyProjects=this.$projectDetailCard.find('.nearby-projects');}
BeopMap.prototype.init=function(){this.attachPanelEvent();this.openProjectsCard();try{beop.benchMark=new BenchMark();}catch(e){console.error(e);}
I18n.fillArea(this.$projectsCard);I18n.fillArea(this.$projectDetailCard);};BeopMap.prototype.openProjectsCard=function(){var $projectContainer=this.$projectsCard.find('.project-media-container').html('');if(AppConfig.projectList.length===1){var mediaHtml=beopTmpl('mapCardItemTmpl',{project:AppConfig.projectList[0]});$projectContainer.append(mediaHtml);$('#projectsCard').addClass('singleItem');this.initSingleProject(AppConfig.projectList[0]);}else{for(var i=0;i<AppConfig.projectList.length;i++){var mediaHtml=beopTmpl('mapCardItemTmpl',{project:AppConfig.projectList[i]});$projectContainer.append(mediaHtml);}
this.$projectsCard.show();}};BeopMap.prototype.attachPanelEvent=function(){var _this=this;this.$projectDetailCard.off('click').on('click','.nav-item',function(){var $this=$(this),$pageType=$this.find('div[page-type]'),destination=$pageType.attr('page-type'),screen=_this.paneProjectSelector.menuScreenFactory(destination);if(destination==='ObserverScreen'){ScreenManager.show(ObserverScreen,$pageType.attr('page-id'));}else if(screen==EnergyScreen){ScreenManager.show(screen,$pageType.attr('page-id'));}else if(screen==ReportScreen){ScreenManager.show(screen,$pageType.attr('page-id'),$pageType.attr('report-folder'),$pageType.attr('report-type'));}else{var project_id=_this.$projectDetailCard.attr('project-id');if(!project_id){return false;}
AppConfig.projectId=project_id;var projectItem=getProject(project_id);if(projectItem){AppConfig.projectName=projectItem.name_en;}
ScreenManager.show(screen,$pageType.attr('page-id'));}}).on('click','.card-close',function(){_this.paneProjectSelector.clearMenu();_this.closeAllInfoWindow();_this.collapseProjectPanel(function(){this.openProjectsCard();});AppConfig.projectId=undefined;});$('.map-card').on('click','.media',function(){var $this=$(this);var arrConfig=$this.attr("id").split("-");var projectId=parseInt(arrConfig[1]);var projectEnName=arrConfig[2];var projectName='';Spinner.spin(document.getElementById('projectsCard'));AppConfig.level=parseInt(arrConfig[3]);for(var i=0,len=AppConfig.projectList.length;i<len;i++){if(projectId===AppConfig.projectList[i].id){projectName=StringUtil.getI18nProjectName(AppConfig.projectList[i]);break;}}
if(!projectName){Spinner.stop();return;}
_this.paneProjectSelector.initProject(projectId,projectEnName,projectName).done(function(result){_this.paneProjectSelector.initDefaultPage(result);}).always(function(){Spinner.stop();});});};BeopMap.prototype.loadMapScriptFailed=function(msg){console.log(this.mapName+I18n.resource.core.beopMap.LOADED_FAILED);if(msg){console.log(msg);}
this.paneProjectSelector.setMapAvailable(false);this.paneProjectSelector.showPanelView();};BeopMap.prototype.loadScript=function(opts){if(!opts){opts={};}
$.extend(opts,{key:this.key});var src=buildSrc(this.url,opts),_this=this;$.ajax({url:src,dataType:"script",success:function(){if(_this instanceof GoogleMap){isMapAsyncLoadSuccess=true;}
if(typeof isMapAsyncLoadSuccess=='undefined'&&_this instanceof GaodeMap){isMapAsyncLoadSuccess=false;return false;}
if(isMapAsyncLoadSuccess){console.log(_this.mapName+I18n.resource.core.beopMap.LOADED_SUCCESSFUL+'.');}else{_this.loadMapScriptFailed('');}},error:function(jqXHR,errorText){_this.loadMapScriptFailed(errorText);},timeout:configMap.loadMapTimeout});};BeopMap.prototype.clickMarker=function(marker){if(!marker){return;}
this.trigger(marker,'click');};BeopMap.prototype.getInfoWindowContent=function(project){var info=[];info.push("<div style=\"padding:0px 0px 0px 4px;\"><b>"+StringUtil.getI18nProjectName(project)+"</b>");if(project.online){info.push(I18n.resource.admin.projectSelector.PROJECT_STATUS+" : "+project.online);}
if(project.lastReceivedTime){info.push(I18n.resource.admin.projectSelector.PROJECT_LAST_RECEIVED_TIME+" : "+project.lastReceivedTime);}
info.push("</div'>");return info.join('<br/>')};BeopMap.prototype.getMarkerImagePath=function(isOnline){return isOnline?configMap.online_img_path:configMap.offline_img_path;};BeopMap.prototype.expandNearbyProject=function(){if(this.$nearbyProjects.find('.media').length===0){return;}
this.$nearbyProjects.slideDown(500);};BeopMap.prototype.addMarkers=function(markerCollection){var item,marker,infoWindow,isOnline;if(!markerCollection||!markerCollection.length){return false}
var _this=this;for(var m=0;m<markerCollection.length;m++){item=markerCollection[m];isOnline=item.online&&item.online===configMap.projectStatus.online?true:false;marker=this.addMarker(item.id,item.latlng,isOnline);if(!marker){continue;}
infoWindow=this.addInfoWindow(item.id,this.getInfoWindowContent(item));_this.addMarkerClick(marker,(function(item){return function(){Spinner.spin($(ElScreenContainer).find('.map-card:visible')[0]);_this.initSingleProject(item);}})(item));}};BeopMap.prototype.initSingleProject=function(project){var _this=this,nearbyProjectList;return this.paneProjectSelector.initProject(project.id,project.name_en,StringUtil.getI18nProjectName(project)).done(function(result){_this.$projectsCard.hide();_this.collapseProjectPanel(function(){_this.loadProjectPanel(project);_this.$nearbyProjects.hide();initPanelBtns(result);_this.openInfoWindow(_this.infoWindows[project.id],_this.markers[project.id]);_this.expandProjectPanel(_this.expandNearbyProject);nearbyProjectList=_this.getNearbyProjects(project.id,configMap.neighbouringRadius);_this.renderNearbyProjects(nearbyProjectList);});}).always(function(){Spinner.stop();});};BeopMap.prototype.renderNearbyProjects=function(projectList){var $projectsContainer=this.$nearbyProjects.find('.projects-section');$projectsContainer.empty();for(var m=0,len=projectList.length;m<len;m++){$projectsContainer.append(this.createProjectItemOfCard(projectList[m]));}};BeopMap.prototype.createProjectItemOfCard=function(project){var projectName=StringUtil.getI18nProjectName(project);var divMedia=$('<div class="media wobble-horizontal"><a class="pull-left"><img class="media-object" src="'+BEOPUtil.getProjectImgPath(project)+'" style="width: 48px; height: 48px;"></a></div>')
divMedia.attr('id',project.id+"-"+project.name_en+"-"+project.level);divMedia.attr('title',projectName);var divMediaBody=$('<div class="media-body"></div>').append($('<h4 class="media-heading"></h4>').text(projectName));divMedia.append(divMediaBody);return divMedia;};BeopMap.prototype.expandProjectPanel=function(callback){this.$projectDetailCard.slideDown("normal",callback?callback.bind(this):$.noop);};BeopMap.prototype.collapseProjectPanel=function(callback){this.$projectDetailCard.slideUp("normal",callback?callback.bind(this):$.noop);};BeopMap.prototype.addToListControl=function(){var $controlBtn=this.createControlBtn('glyphicon glyphicon-list',i18n_resource.admin.projectSelector.TITLE_PANELSELECTOR);this.addControl($controlBtn,function(){this.paneProjectSelector.show('panel');})};BeopMap.prototype.addToMapControl=function(){var $controlBtn=this.createControlBtn('glyphicon glyphicon-map-marker',i18n_resource.core.beopMap.AMAP,'active');this.addControl($controlBtn,function(){})};BeopMap.prototype.addToVersionHistory=function(){var versionHistory=window.localStorage.getItem('versionHistory'),$controlBtn;if(versionHistory==null||versionHistory=='undefined'||versionHistory==undefined){$controlBtn=this.createVersionHistory('');}else{$controlBtn=this.createVersionHistory(versionHistory);}
this.addControl($controlBtn,function(){ScreenManager.show(UserManagerController,VersionHistory);})};BeopMap.prototype.createVersionHistory=function(text){var versionHistoryUI;versionHistoryUI=$('<div class="map-beop-version-history" title="beop版本历史记录"><a  id="beopVersionHistory"> beop version: '+text+' </a></div>');return versionHistoryUI;};BeopMap.prototype.loadProjectPanel=function(project){if(!project){return false;}
var name=StringUtil.getI18nProjectName(project);this.$projectDetailCard.attr('project-id',project.id).find('.project-img').attr('src',BEOPUtil.getProjectImgPath(project)).attr('alt',name).end().find('.name').text(name);if(!project.address){this.$projectDetailCard.find('.address').hide();}else{this.$projectDetailCard.find('.address').show().find('address').text(project.address);}};BeopMap.prototype.createControlBtn=function(btnClass,btnText,className){if(className){var $controlUI=$('<div class="map-control-btn '+className+'"><span class="'+btnClass+'" aria-hidden="true"></span></div>');}else{var $controlUI=$('<div class="map-control-btn"><span class="'+btnClass+'" aria-hidden="true"></span></div>');}
$controlUI.attr("title",btnText);return $controlUI;};BeopMap.prototype.addUpdateProjectControl=function(){var $controlBtn=this.createControlBtn('glyphicon glyphicon-refresh',I18n.resource.admin.projectSelector.PANE_BTN_UPDATE);this.addControl($controlBtn,function(){Spinner.spin(ElScreenContainer);var alert;WebAPI.post("/observer/update_project_by_user",{user_id:AppConfig.userId}).done(function(result){if(result.indexOf('error')!=-1){alert=new Alert(ElScreenContainer,Alert.type.success,I18n.resource.admin.projectSelector.PROJECT_UPDATE_SUCCESS);}else{alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectSelector.PROJECT_UPDATE_FAILED);}
alert.showAtTop(2000);}).error(function(){alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.projectSelector.PROJECT_UPDATE_FAILED);alert.showAtTop(2000);}).always(function(){Spinner.stop();});})};BeopMap.prototype.addManagePanelControl=function(){var $controlBtn=this.createControlBtn('glyphicon glyphicon-user',I18n.resource.admin.projectSelector.PANE_BTN_MANAGER);this.addControl($controlBtn,function(){ScreenManager.show(UserManagerController,AccountManager);});};BeopMap.prototype.setFitView=function(){};BeopMap.prototype.getNearbyProjects=function(centerProjectId,radius){var centerProjectMarker=this.markers[centerProjectId],centerProjectLnglat=this.getMarkerPosition(centerProjectMarker),nearbyList=[];for(var projectId in this.markers){if((projectId+'')===(centerProjectId+'')){continue;}
var marker=this.markers[projectId],markLnglat=this.getMarkerPosition(marker);if(this.computeDistanceBetween(centerProjectLnglat,markLnglat)<=radius){nearbyList.push(getProject(projectId));}}
return nearbyList;};function GaodeMap(){BeopMap.call(this);this.url=configMap.AmapUrl;this.key=configMap.AmapKey;this.mapName=I18n.resource.core.beopMap.AMAP;}
GaodeMap.prototype.init=function(){BeopMap.prototype.init.call(this);if(this.map){this.map.destroy&&this.map.destroy();}
this.map=new AMap.Map(this.container,{view:new AMap.View2D({zoom:this.zoom})});};GaodeMap.prototype.getLatLng=function(lat,lng){return new AMap.LngLat(lng,lat);};GaodeMap.prototype.isMapLoaded=function(){try{if(AMap&&AMap.Map){return true;}}catch(e){return false;}};GaodeMap.prototype.addControl=function($controlUI,callback){var _this=this;var controlDiv=function(){};controlDiv.prototype={addTo:function(map,dom){dom.appendChild(this._getHtmlDom(map));},_getHtmlDom:function(map){this.map=map;$controlUI.click(function(){callback.call(_this);});this.container=$controlUI[0];return $controlUI[0];}};this.map.addControl(new controlDiv(this.map));};GaodeMap.prototype.load=function(){if(this.isMapLoaded()){mapLoadCallBack();}else{this.loadScript({v:configMap.AmapVersion,callback:configMap.mapLoadCallBack});}};GaodeMap.prototype.trigger=function(instance,eventName,var_args){AMap.event.trigger(instance,eventName,var_args)};GaodeMap.prototype.openInfoWindow=function(infoWindow,marker){infoWindow.open(this.map,marker.getPosition());};GaodeMap.prototype.addMarker=function(identifier,lnglat,isOnline,opts){if(!identifier||!lnglat){return null;}
if(!lnglat){lnglat=configMap.defaultLatlng;}
if(typeof lnglat==='string'){var temp=lnglat.split(',');lnglat={'lat':+temp[0],'lng':+temp[1]};}
var defaultOpts={map:this.map,position:this.getLatLng(lnglat.lat,lnglat.lng),offset:new AMap.Pixel(-8,-8),content:'<div class="map-marker" data-id="'+identifier+'"></div>',extData:{id:identifier}};if(opts){$.extend(defaultOpts,opts);}
var marker=new AMap.Marker(defaultOpts);this.markers[identifier]=marker;return marker;};GaodeMap.prototype.removeMarker=function(identifier){if(!identifier){return false}
var marker=this.markers[identifier];if(!marker){return false;}
marker.setMap(null);return true;};GaodeMap.prototype.addInfoWindow=function(id,content){var infoWindow=new AMap.InfoWindow({offset:new AMap.Pixel(0,0),content:content});this.infoWindows[id]=infoWindow;return infoWindow;};GaodeMap.prototype.addMarkerClick=function(marker,eventFunc){var _this=this;AMap.event.addListener(marker,'click',function(){eventFunc.call(_this);});};GaodeMap.prototype.setFitView=function(){this.map.setFitView();};GaodeMap.prototype.computeDistanceBetween=function(from,to){if(!from||!to){return}
return from.distance(to);};GaodeMap.prototype.getMarkerPosition=function(marker){if(!marker){return}
return marker.getPosition();};GaodeMap.prototype.closeAllInfoWindow=function(){this.map.clearInfoWindow();};inherits(GaodeMap,BeopMap);function GoogleMap(){BeopMap.call(this);this.url=configMap.GmapUrl;this.key=configMap.GmapKey;this.zoom=4;this.mapName='google'+I18n.resource.core.beopMap.MAP;}
GoogleMap.prototype.init=function(){BeopMap.prototype.init.call(this);this.map=new google.maps.Map($('#'+this.container)[0],{zoom:this.zoom,disableDefaultUI:true});GMarker=function(latlng,map,args){this.latlng=latlng;this.args=args;this.setMap(map);}
GMarker.prototype=new google.maps.OverlayView();GMarker.prototype.draw=function(){var self=this;var div=this.div;if(!div){div=this.div=document.createElement('div');div.className='map-marker';div.style.position='absolute';if(typeof(self.args.id)!=='undefined'){div.dataset.id=self.args.id;}
google.maps.event.addDomListener(div,"click",function(event){google.maps.event.trigger(self,"click");});var panes=this.getPanes();panes.overlayImage.appendChild(div);}
var point=this.getProjection().fromLatLngToDivPixel(this.latlng);if(point){div.style.left=(point.x-8)+'px';div.style.top=(point.y-8)+'px';}};GMarker.prototype.onRemove=function(){if(this.div){this.div.parentNode.removeChild(this.div);this.div=null;}};GMarker.prototype.getPosition=function(){return this.latlng;};GMarker.prototype.getExtData=function(){return this.args;};GMarker.prototype.show=function(){this.div.style.display='';};GMarker.prototype.hide=function(){this.div.style.display='none';};};GoogleMap.prototype.isMapLoaded=function(){try{if(google&&google.maps){return true;}}catch(e){return false;}};GoogleMap.prototype.load=function(){if(this.isMapLoaded()){mapLoadCallBack();}else{this.loadScript({callback:configMap.mapLoadCallBack,sensor:false,libraries:'geometry,places',language:'en'});}};GoogleMap.prototype.getLatLng=function(lat,lng){return new google.maps.LatLng(lat,lng);};GoogleMap.prototype.openInfoWindow=function(infoWindow,marker){infoWindow.open(this.map,marker);};GoogleMap.prototype.addMarker=function(identifier,lnglat,isOnline,opts){if(!identifier||!lnglat){return null;}
if(typeof lnglat==='string'){var temp=lnglat.split(',');lnglat={'lat':+temp[0],'lng':+temp[1]};}
if(opts){$.extend(defaultOpts,opts);}
var marker=new GMarker(this.getLatLng(lnglat.lat,lnglat.lng),this.map,{id:identifier});this.markers[identifier]=marker;return marker;};GoogleMap.prototype.addInfoWindow=function(id,content){var infoWindow=new google.maps.InfoWindow({content:content,pixelOffset:new google.maps.Size(0,0)});this.infoWindows[id]=infoWindow;return infoWindow;};GoogleMap.prototype.addControl=function($controlUI,callback){var _this=this,controlUIDom=$controlUI[0];this.map.controls[google.maps.ControlPosition.TOP_RIGHT].push(controlUIDom);google.maps.event.addDomListener(controlUIDom,'click',function(){callback.call(_this);});};GoogleMap.prototype.closeAllInfoWindow=function(){for(var m=0,len=this.infoWindows.length;m<len;m++){this.infoWindows[m].close();}};GoogleMap.prototype.addMarkerClick=function(marker,eventFunc){var _this=this;google.maps.event.addListener(marker,'click',function(){_this.closeAllInfoWindow();eventFunc.call(_this);});};GoogleMap.prototype.setFitView=function(){var bounds=new google.maps.LatLngBounds();for(var project in this.markers){bounds.extend(this.markers[project].getPosition());}
this.map.fitBounds(bounds);};GoogleMap.prototype.computeDistanceBetween=function(from,to){if(!from||!to){return}
return google.maps.geometry.spherical.computeDistanceBetween(from,to);};GoogleMap.prototype.getMarkerPosition=function(marker){if(!marker){return}
return marker.getPosition();};GoogleMap.prototype.trigger=function(instance,eventName,var_args){google.maps.event.trigger(instance,eventName,var_args);};inherits(GoogleMap,BeopMap);var GMarker=null;beop.getMapInstance=function(){if(typeof AppConfig.isGoogleServiceAvailable==='boolean'){return AppConfig.isGoogleServiceAvailable?new GoogleMap():new GaodeMap();}else{if(I18n.type==='zh'){return new GaodeMap();}else{return new GoogleMap();}}};beop.GaodeMap=GaodeMap;beop.GoogleMap=GoogleMap;})(beop||(beop={}));var isMapAsyncLoadSuccess=undefined;function mapLoadCallBack(){try{var mapIns=beop.getMapInstance();mapIns.init();mapIns.addToListControl();if(AppConfig.userOfRole==1){mapIns.addUpdateProjectControl();}
mapIns.addToMapControl();if(window.localStorage.getItem('language')=='zh'){mapIns.addToVersionHistory();}
mapIns.addMarkers(AppConfig.projectList);mapIns.setFitView();isMapAsyncLoadSuccess=true;mapIns.customCtrls=mapIns.customCtrls||{};mapIns.customCtrls.dataRange=new window.map.controls.DataRange(mapIns,document.getElementById(mapIns.container));beop.benchMark.addDataRangeCtrl(mapIns.customCtrls.dataRange);}catch(e){console.error(e);}}
var beop=window.beop||{};beop.baseMap=beop.baseMap||{};(function(window,$,nsBaseMap){var CONSTS={AMap:{name:'高德地图',url:'http://webapi.amap.com/maps',params:{key:'9cc89c68a4bd6f3f5f65589f85ad7685',v:'1.3'}},GLoader:{name:'Google Loader',url:'https://www.google.com/jsapi'},GMap:{name:'Google Map',url:'http://maps.googleapis.com/maps/api/js',params:{key:'AIzaSyAzzOzAmrGov5GLacve9w8_Q8dS-xBYCgc',sensor:'false',libraries:'geometry,places'}}};var defaults={mapContainer:'mapContainer',defaultLng:'121.6283679',defaultLat:'31.2114943',markerImgPath:'/static/images/map_marker_online.png'};var util={inherits:function(clazz,base){var clazzPrototype=clazz.prototype;var F=function(){};F.prototype=base.prototype;clazz.prototype=new F();for(var prop in clazzPrototype){clazz.prototype[prop]=clazzPrototype[prop];}
clazz.constructor=clazz;},loadJS:function(url,callback){var done=false;var script=document.createElement('script');script.type='text/javascript';script.language='javascript';script.src=url;script.onload=script.onreadystatechange=function(){if(!done&&(!script.readyState||script.readyState=='loaded'||script.readyState=='complete')){done=true;script.onload=script.onreadystatechange=null;typeof callback==='function'&&callback.call(script);}}
document.getElementsByTagName("head")[0].appendChild(script);},runJS:function(url,callback){this.loadJS(url,function(){document.getElementsByTagName('head')[0].removeChild(this);typeof callback==='function'&&callback();});}};function PaneMapSearch(map,iptSch,paneSchRes){this.map=map;this.$iptSch=$(iptSch);this.$paneSchRes=$(paneSchRes);this.$liSets=[];this.rs=null;this.rsCount=0;this.showLimits=5;this.curSelect=-1;this.isPaneShow=false;this.bindEvents();this.$iptSch.parent('div').show();}
PaneMapSearch.prototype.bindEvents=function(){var _this=this;this.$iptSch.keyup(function(e){var kc=e.keyCode;switch(kc){case 38:_this.prev();e.preventDefault();break;case 40:_this.next();e.preventDefault();break;case 13:_this.doSearch();break;default:_this.autoComplete();break;}});this.$paneSchRes.on('click','a',function(e){var $this=$(this);var index=$this.attr('data-sort')||0;_this.to(index);_this.doSearch();e.preventDefault();});};PaneMapSearch.prototype.showPane=function(){this.$paneSchRes.show();this.isPaneShow=true;};PaneMapSearch.prototype.hidePane=function(){this.$paneSchRes.hide();this.isPaneShow=false;};PaneMapSearch.prototype.prev=function(){this.to(this.curSelect-1);};PaneMapSearch.prototype.next=function(){this.to(this.curSelect+1);};PaneMapSearch.prototype.to=function(index){if(!this.isPaneShow){this.showPane();return;}
index=Math.min(Math.max(0,index),this.rsCount-1);if(index===this.curSelect)return;this.curSelect=index;this.$liSets.removeClass('on');this.$liSets.eq(index).addClass('on');this.$iptSch.val(this.rs[index].name);};PaneMapSearch.prototype.doSearch=function(){var _this=this;var keywords=this.$iptSch.val().trim();var options;if(keywords==='')return;_this.hidePane();if(this.curSelect>-1){options={pageSize:1,city:this.rs[this.curSelect].adcode}}
this.map.placeSearch(keywords,options,function(rs){if(rs.status!==0)return;rs=rs.data;if(_this.curSelect<0){_this.map.setCenter(rs[0].lng,rs[0].lat);_this.map.setZoom(15);}else{_this.map.trigger('click',{lnglat:rs[0]});}});};PaneMapSearch.prototype.autoComplete=function(){var _this=this;var keywords=this.$iptSch.val().trim();keywords=keywords.replace(/[\\\?\.\+\^\$]/g,'');if(keywords==='')return;this.map.search(keywords,function(rs){if(rs.status!==0)return;rs=rs.data;var arrHtml=[];_this.rsCount=Math.min(rs.length,_this.showLimits);_this.rs=rs;_this.curSelect=-1;if(_this.rsCount<=0){_this.hidePane();return;}
for(var i=0;i<_this.rsCount;i++){arrHtml.push('<li><a data-sort="'+i+'" href="javascript:;"><span class="rs-name">'+
rs[i].name.replace(new RegExp(keywords.replace(/([\(\)])/g,'\\$1')),'<span class="keywords">'+keywords+'</span>')+'</span><span class="rs-district">'+
rs[i].district+'</span</a></li>');};_this.$paneSchRes.html(arrHtml.join(''));_this.showPane();_this.$liSets=_this.$paneSchRes.children('li');});};PaneMapSearch.prototype.destroy=function(){this.$iptSch.unbind();this.$paneSchRes.off();};var BaseMap=function(options){this.options=$.extend({},defaults,options);this.markers=[];};BaseMap.load=function(type,callback){var _this=this;var url=CONSTS[type].url;var params=CONSTS[type].params;var p=[];for(var i in params){if(params.hasOwnProperty(i)){p.push(i+'='+params[i]);}}
if(p.length)url=url+'?';util.runJS(url+p.join('&'),function(){window.console&&console.log('load JS: '+url+' success!');typeof callback&&callback.call(_this);});};var GDMap=function(options){BaseMap.call(this,options);this.markers=[];this.controls=[];this.zoom=15;this.init();};GDMap.load=function(options,callback){if(typeof options==='function'){callback=options;options=null;}
if(!GDMap.isLoaded()){BaseMap.load('AMap',function(){callback(new GDMap(options));});}else{callback(new GDMap(options));}};GDMap.isLoaded=function(){return window.AMap&&window.AMap.Map;};GDMap.prototype.init=function(){this.map=new AMap.Map(this.options.mapContainer,{resizeEnable:true,view:new AMap.View2D({zoom:this.zoom})});};GDMap.prototype.setCenter=function(lng,lat){return this.map.setCenter(this.getPoint(lng,lat));};GDMap.prototype.setZoom=function(level){return this.map.setZoom(level);};GDMap.prototype.getPoint=function(lng,lat){return new AMap.LngLat(lng,lat);};GDMap.prototype.addMarker=function(lng,lat){var marker;lng=lng||this.options.defaultLng;lat=lat||this.options.defaultLat;marker=new AMap.Marker({map:this.map,icon:this.options.markerImgPath,position:this.getPoint(lng,lat)});marker&&this.markers.push(marker);return marker;};GDMap.prototype.removeMarker=function(marker){var removed;for(var i=this.markers.length-1;i>=0;i--){if(this.markers[i]===marker){removed=this.markers.splice(i,1);removed.setMap(null);}};};GDMap.prototype.removeAllMarkers=function(){for(var i=this.markers.length-1;i>=0;i--){this.markers[i].setMap(null);}
this.markers.length=0;};GDMap.prototype.addListener=function(eventName,handler){AMap.event.addListener(this.map,eventName,handler);};GDMap.prototype.trigger=function(eventName,args){AMap.event.trigger(this.map,eventName,args);};GDMap.prototype.getAddress=function(lng,lat,callback){var _this=this;var geocoder;var format=[],statusCode=-1;AMap.service(["AMap.Geocoder"],function(){var geocoder=new AMap.Geocoder();geocoder.getAddress(_this.getPoint(lng,lat),function(status,rs){var geoinfo=rs.regeocode;if(status==='complete'&&rs.info==='OK'){format.push({name:geoinfo.formattedAddress,components:{city:geoinfo.addressComponent.city,province:geoinfo.addressComponent.province}});statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.getLocation=function(addr,callback){var _this=this;var format=[],statusCode=-1;AMap.service(["AMap.Geocoder"],function(){var geocoder=new AMap.Geocoder();geocoder.getLocation(addr,function(status,rs){var point;if(status==='complete'&&rs.info==='OK'){for(var i=0,len=rs.geocodes.length;i<len;i+=1){point=rs.geocodes[i].location;format.push({lng:point.lng,lat:point.lat});}
statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.search=function(keywords,callback){var format=[],statusCode=-1;AMap.service(['AMap.Autocomplete'],function(){var auto=new AMap.Autocomplete();if(keywords.length>0){auto.search(keywords,function(status,result){if(status==='complete'&&result.info==='OK'){for(var i=0,len=result.tips.length;i<len;i++){format.push({name:result.tips[i].name,district:result.tips[i].district,adcode:result.tips[i].adcode});};statusCode=0;typeof callback==='function'&&callback({status:statusCode,data:format});}});}});};GDMap.prototype.placeSearch=function(keywords,options,callback){var pSearch;if(typeof options==='function'){callback=options;options=null;}
AMap.service(['AMap.PlaceSearch'],function(){pSearch=new AMap.PlaceSearch(options);pSearch.search(keywords,function(status,rs){var format=[],statusCode=-1;var row;if(status==='complete'&&rs.info==='OK'){for(var i=0,len=rs.poiList.pois.length;i<len;i++){row=rs.poiList.pois[i];format.push({lng:row.location.getLng(),lat:row.location.getLat(),address:row.address});}
statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});});};GDMap.prototype.setFitView=function(){this.map.setFitView();};GDMap.prototype.addSearchBox=function(iptSch,mapSchPane){this.controls.push(new PaneMapSearch(this,iptSch,mapSchPane));};GDMap.prototype.destroy=function(){for(var i=this.controls.length-1;i>=0;i--){if(typeof this.controls[i].destroy!=='function'){console.warn('one map UI control not destroy!');continue;}
this.controls[i].destroy();};this.map.destroy();};var GoogleMap=function(options){BaseMap.call(this,options);this.markers=[];this.controls=[];this.zoom=16;this.init();};GoogleMap.load=function(options,callback){if(typeof options==='function'){callback=options;options=null;}
if(!GoogleMap.isLoaded()){BaseMap.load('GLoader',function(){var params=CONSTS['GMap'].params;var p=[];for(var i in params){if(params.hasOwnProperty(i)){p.push(i+'='+params[i]);}}
google.load('maps',3,{other_params:p.join('&'),callback:function(){callback(new GoogleMap(options));}});});}else{callback(new GoogleMap(options));}};GoogleMap.isLoaded=function(){return window.google&&window.google.maps;};GoogleMap.prototype.init=function(){this.map=new google.maps.Map($('#'+this.options.mapContainer)[0],{zoom:this.zoom,disableDefaultUI:true,center:this.getPoint(this.options.defaultLng,this.options.defaultLat)});};GoogleMap.prototype.setCenter=function(lng,lat){return this.map.setCenter(this.getPoint(lng,lat));};GoogleMap.prototype.setZoom=function(level){return this.map.setZoom(level);};GoogleMap.prototype.getPoint=function(lng,lat){return new google.maps.LatLng(lat,lng);};GoogleMap.prototype.addMarker=function(lng,lat){var marker;lng=lng||this.options.defaultLng;lat=lat||this.options.defaultLat;marker=new google.maps.Marker({map:this.map,icon:this.options.markerImgPath,position:this.getPoint(lng,lat)});marker&&this.markers.push(marker);return marker;};GoogleMap.prototype.removeMarker=function(marker){var removed;for(var i=this.markers.length-1;i>=0;i--){if(this.markers[i]===marker){removed=this.markers.splice(i,1);removed.setMap(null);}};};GoogleMap.prototype.removeAllMarkers=function(){for(var i=this.markers.length-1;i>=0;i--){this.markers[i].setMap(null);}
this.markers.length=0;};GoogleMap.prototype.addListener=function(eventName,handler){var _this=this;return google.maps.event.addListener(this.map,eventName,function(e){_this.formatEventResult(e);handler.call(this,e);});};GoogleMap.prototype.removeAllListener=function(){google.maps.event.clearInstanceListeners(this.map);};GoogleMap.prototype.trigger=function(eventName,args){args.latLng=args.lnglat;return google.maps.event.trigger(this.map,eventName,args);};GoogleMap.prototype.formatEventResult=function(rs){rs.lnglat={lng:rs.latLng.lng(),lat:rs.latLng.lat()};};GoogleMap.prototype.getAddress=function(lng,lat,callback){var _this=this;var geocoder=new google.maps.Geocoder();var format=[],statusCode=-1;geocoder.geocode({latLng:this.getPoint(lng,lat)},function(rs,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0,len=rs.length;i<len;i++){format.push({name:rs[0].formatted_address,components:_this._formatAddressComponents(rs[i].address_components)});};statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});};GoogleMap.prototype.getLocation=function(addr,callback){var geocoder=new google.maps.Geocoder();var format=[],statusCode=-1;geocoder.geocode({address:addr},function(rs,status){if(status==google.maps.GeocoderStatus.OK){for(var i=0,len=rs.length;i<len;i++){format.push({name:rs[i].formatted_address,lng:rs[i].geometry.location.lng(),lat:rs[i].geometry.location.lat()});};statusCode=0;}
typeof callback==='function'&&callback({status:statusCode,data:format});});};GoogleMap.prototype.search=function(keywords,callback){};GoogleMap.prototype.setFitView=function(){if(this.markers.length<=0)return;this.map.panTo(this.markers[0].getPosition());};GoogleMap.prototype.addSearchBox=function(iptSch){var _this=this;var input=document.getElementById('btnGoogleSch');var searchBox;this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);searchBox=new google.maps.places.SearchBox((input));google.maps.event.addListener(searchBox,'places_changed',function(){var places=searchBox.getPlaces();if(places.length<=0)return;_this.trigger('click',{latLng:places[0].geometry.location});});input.style.display='';};GoogleMap.prototype.destroy=function(){for(var i=this.controls.length-1;i>=0;i--){if(typeof this.controls[i].destroy!=='function'){console.warn('one map UI control does not destroy!');continue;}
this.controls[i].destroy();};this.removeAllMarkers();this.removeAllListener();};GoogleMap.prototype._formatAddressComponents=function(addressComponents,type){var format={};for(var i=addressComponents.length-1;i>=0;i--){switch(addressComponents[i].types[0]){case'administrative_area_level_1':format.province=addressComponents[i].long_name;break;case'locality':format.city=addressComponents[i].long_name;break;}};return format;};nsBaseMap.load=function(callback){if(I18n.type.indexOf('zh')>-1){GDMap.load(callback);}else{GoogleMap.load(callback);}};}(window,jQuery,beop.baseMap,undefined));window.map=window.map||{};window.map.controls=window.map.controls||{};window.map.controls.DataRange=(function(window,$,undefined){'use strict';var utils={color:{getColorValue:function(arr){if($.type(arr)!=='array'){arr=[arr];}
return arr.map(function(row,i){var matches=null;matches=row.match(/^#(\w{2})(\w{2})(\w{2})$/);return[parseInt(matches[1],16),parseInt(matches[2],16),parseInt(matches[3],16)];});}}}
function DataRange(mapIns,container){this.mapIns=mapIns;this.$container=$(container);this.options=$.extend({},DEFAULTS);this.colorsRange=null;this.visibleRangeValue={};this.data=null;this.$markers=null;this.init();}
DataRange.prototype={constructor:DataRange,init:function(){this.initColors();this.buildUI();this.attachEvents();},show:function(){this.$divWrap.show();},initColors:function(){var colors=utils.color.getColorValue(this.options.colors);var optMin=this.options.range.min;var optMax=this.options.range.max;var range=optMax-optMin;var step=1/(colors.length-1);var row,prev;this.colorsRange=[];for(var i=1,len=colors.length;i<len;i++){row=colors[i];prev=colors[i-1];this.colorsRange.push({from:optMin+range*step*(i-1),to:i===len-1?optMax:range*step*i,colorFrom:prev,colorTo:row});}},initMarkers:function(data){var newData={},t;var _this=this;var $markers=this.$markers;var projectId,value,row;if(!$markers)$markers=this.$markers=$('.map-marker',this.$container);data.forEach(function(row,i){newData[row.projectId]=row.value;});this.data=newData;([]).forEach.call($markers,function(row,i){var $this=$(row),color;projectId=$this.attr('data-id');value=_this.data[projectId];if(value===-1||value===undefined){_this.mapIns.markers[projectId].hide();}else{color=_this.getColorByValue(value)
$this.css({'background-color':color});_this.mapIns.markers[projectId].show();}});this.setVisibleMarkers();},buildUI:function(){var halfHeight;var options=this.options;this.$divWrap=$('<div>').css({'width':options.width,'height':options.height,'position':'absolute','bottom':50,'left':40,'background-image':'linear-gradient(to top, '+this.options.colors.join(',')+')','border-radius':'2px','z-index':1,'display':'none','box-shadow':'0 2px 6px rgba(0,0,0,0.4)'});this.$divRangeCoverUp=$('<div>').css({'position':'absolute','left':0,'top':0,'right':0,'background-color':'#ccc'});this.$divRangeCoverDown=$('<div>').css({'position':'absolute','left':0,'bottom':0,'right':0,'background-color':'#ccc'});this.$divRange=$('<div>').css({'position':'absolute','left':0,'top':0,'bottom':0,'right':0,'background-color':'transparent','font-family':'Microsoft YaHei','font-weight':'bold','cursor':'move'});halfHeight=options.arrowSize/2;this.$arrowUp=$('<span>').css({'position':'absolute','left':options.width,'top':-halfHeight,'width':options.arrowSize,'height':options.arrowSize,'border-top-width':halfHeight,'border-left-width':0,'border-bottom-width':halfHeight,'border-right-width':options.arrowSize,'border-color':'transparent #555 transparent transparent','border-style':'solid'});this.$arrowDown=$('<span>').css({'position':'absolute','left':options.width,'bottom':-halfHeight,'width':options.arrowSize,'height':options.arrowSize,'border-top-width':halfHeight,'border-left-width':0,'border-bottom-width':halfHeight,'border-right-width':options.arrowSize,'border-color':'transparent #555 transparent transparent','border-style':'solid'});this.$labelUp=$('<span>High</span>').css({'height':25,'line-height':'25px','position':'absolute','left':0,'right':0,'top':-25,'font-weight':'bold'});this.$labelDown=$('<span>Low</span>').css({'height':25,'line-height':'25px','position':'absolute','left':0,'right':0,'bottom':-25,'font-weight':'bold'});this.$arrowLabelUp=$('<span>').css({'position':'absolute','left':this.options.arrowSize+4,'top':-this.options.arrowSize/2,'line-height':this.options.arrowSize+'px'});this.$arrowLableDown=$('<span>').css({'position':'absolute','left':this.options.arrowSize+4,'top':-this.options.arrowSize/2,'line-height':this.options.arrowSize+'px'})
this.$arrowUp.append(this.$arrowLabelUp);this.$arrowDown.append(this.$arrowLableDown);this.$divRange.append(this.$arrowUp).append(this.$arrowDown);this.$divWrap.append(this.$divRangeCoverUp).append(this.$divRangeCoverDown).append(this.$divRange);this.$container.append(this.$divWrap)},changeColors:function(top,bottom){var height=_this.options.height;var ratioTop=top/height;var ratioBottom=bottom/height;var colors=this.colors;},getColorByValue:function(value){var percent,color=[];for(var i=0,row,len=this.colorsRange.length;i<len;i++){row=this.colorsRange[i];if(value<=row.to){percent=(value-row.from)/(row.to-row.from);color.push((row.colorFrom[0]+(row.colorTo[0]-row.colorFrom[0])*percent)/255*100+'%');color.push((row.colorFrom[1]+(row.colorTo[1]-row.colorFrom[1])*percent)/255*100+'%');color.push((row.colorFrom[2]+(row.colorTo[2]-row.colorFrom[2])*percent)/255*100+'%');break;}}
return'rgb('+color.join(',')+')';},setVisibleMarkers:function(topValue,bottomValue){var _this=this;var $markers=this.$markers;var projectId,value,row;if(!this.data)return;topValue=[null,undefined].indexOf(topValue)>-1?this.options.range.max:topValue;bottomValue=[null,undefined].indexOf(bottomValue)>-1?this.options.range.min:bottomValue;([]).forEach.call($markers,function(row,i){var $this=$(row);projectId=$this.attr('data-id');value=_this.data[projectId];if(value===-1||value===undefined||value>topValue||value<bottomValue){_this.mapIns.markers[projectId].hide();}else{_this.mapIns.markers[projectId].show();}});},setVisibleRange:function(top,bottom){var optMin=this.options.range.min===undefined?DEFAULTS.range.min:this.options.range.min;var optMax=this.options.range.max===undefined?DEFAULTS.range.max:this.options.range.max;var range=optMax-optMin;var topRatio,topValue;var bottomRatio,bottomValue;if(top!==undefined&&top!==null){topRatio=1-(top-0)/this.options.height;topValue=Math.round((optMin+topRatio*range)*100)/100;this.$arrowLabelUp.text(topValue);this.$divRange.css('top',top);this.$divRangeCoverUp.css('bottom',this.options.height-top);this.visibleRangeValue.top=topValue;}
if(bottom!==undefined&&bottom!==null){bottomRatio=1-(bottom-0)/this.options.height;bottomValue=Math.round((optMin+bottomRatio*range)*100)/100;this.$arrowLableDown.text(bottomValue);this.$divRange.css('bottom',this.options.height-bottom);this.$divRangeCoverDown.css('top',bottom);this.visibleRangeValue.bottom=bottomValue;}
this.setVisibleMarkers(this.visibleRangeValue.top,this.visibleRangeValue.bottom);typeof this.options.onRangeChange==='function'&&this.options.onRangeChange();},attachEvents:function(){var _this=this;var minHeight=20;this.$arrowUp.on('mousedown',function(e){var position=_this.$divRange.position();var delta=position.top-e.pageY;var mDownBottom=_this.$divRange.height()+position.top;_this.$container.on('mousemove',function(e){var top=delta+e.pageY;top=Math.max(0,Math.min(top,mDownBottom-minHeight));_this.setVisibleRange(top);e.stopPropagation();});e.stopPropagation();});_this.$container.on('mouseup mouseleave',function(e){$(this).off('mousemove');e.preventDefault();});this.$arrowDown.on('mousedown',function(e){var position=_this.$divRange.position();var mDownTop=position.top;var delta=_this.$divRange.height()+position.top-e.pageY;_this.$container.on('mousemove',function(e){var bottom=delta+e.pageY;bottom=Math.max(mDownTop+minHeight,Math.min(_this.options.height,bottom));_this.setVisibleRange(null,bottom);e.stopPropagation();});e.stopPropagation();});_this.$divRange.on('mousedown',function(e){var position=_this.$divRange.position();var deltaTop=position.top-e.pageY;var height=_this.$divRange.height();var deltaBottom=height+position.top-e.pageY;_this.$container.on('mousemove',function(e){var top=deltaTop+e.pageY;var bottom=deltaBottom+e.pageY;if(top<0){top=0;bottom=height;}
if(bottom>_this.options.height){top=_this.options.height-height;bottom=_this.options.height;};_this.setVisibleRange(top,bottom);e.stopPropagation();});e.stopPropagation();});},setOptions:function(options){var originColors=this.options.colors||[];this.options=$.extend({},this.options,options);if(this.options.colors&&(originColors.join('')!==this.options.colors.join(''))){this.$divWrap.css({'background-image':'linear-gradient(to top, '+this.options.colors.join(',')+')'});}
this.initColors();this.setVisibleRange(0,this.options.height);}}
var DEFAULTS={width:20,height:180,arrowSize:12,colors:['#87E034','#EDE24C','#F53F52'],range:{min:0,max:100}};return DataRange;}(window,jQuery));var EventAdapter=(function(){var eventData,eventStatus;function EventAdapter($){}
EventAdapter.on=function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;eventHmt=true;if(arguments.length<3||arguments.length>5){console.log('EventAdapter.on arguments.length error');return;}
if(typeof arguments[0]!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}}
if(typeof arguments[1]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[1];}
if(typeof arguments[2]=='function'){eventFunction=arguments[2];eventSelector=null;if(typeof arguments[3]=='boolean'){eventHmt=arguments[3]}}else if(typeof arguments[2]=='string'){if(arguments[3]&&typeof arguments[3]=='function'){eventSelector=arguments[2];eventFunction=arguments[3];if(typeof arguments[4]=='boolean'){eventHmt=arguments[4]}}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(eventHmt){EventAdapter.analyse(eventTarget,eventType);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':eventTarget.on('touchstart',eventSelector,function(e){mobileDragStart.call(this,e,eventTarget,finalFunction)});break;case'dragover':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragOver.call(this,e,eventTarget,finalFunction)});break;case'dragleave':$(document).on('touchmove.drag',eventSelector,function(e){mobileDragLeave.call(this,e,eventTarget,finalFunction)});break;case'drop':$(document).on('touchend.drop',eventSelector,function(e){mobileDrop.call(this,e,eventTarget,finalFunction)});break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;};EventAdapter.off=function(){if((arguments.length>3||arguments.length<1)||(arguments[0]&&typeof arguments[1]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(arguments[0]instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=arguments[0];}
if(arguments.length==1){eventTarget.off();return eventTarget;}
if(typeof arguments[1]=='string'){eventType=arguments[1]}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[2]=='string'){eventSelector=arguments[2];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;};$.fn.extend({'eventOn':function(){var eventTarget,eventType,eventFunction,eventSelector,eventHmt,finalFunction;eventHmt=true;if(arguments.length<2||arguments.length>4){console.log('EventAdapter.on arguments.length error');return;}
if(typeof this!='object'){console.log('EventAdapter.on arguments[0] type error');return;}else{if(!(this instanceof jQuery)){eventTarget=jQuery(arguments[0]);}else{eventTarget=this;}}
if(typeof arguments[0]!='string'){console.log('EventAdapter.on arguments[1] type error');return;}else{eventType=arguments[0];}
if(typeof arguments[1]=='function'){eventFunction=arguments[1];eventSelector=null;if(typeof arguments[2]=='boolean'){eventHmt=arguments[2]}}else if(typeof arguments[1]=='string'){if(arguments[2]&&typeof arguments[2]=='function'){eventSelector=arguments[1];eventFunction=arguments[2];if(typeof arguments[3]=='boolean'){eventHmt=arguments[3]}}else{console.log('EventAdapter.on arguments[2 or 3] type error');return;}}
finalFunction=function(e){if(eventHmt){EventAdapter.analyse(eventTarget,eventType);}
eventFunction.call(this,e);};if(!AppConfig.isMobile){eventTarget.on(eventType,eventSelector,finalFunction)}else{switch(eventType){case'click':eventTarget.on('touchstart',eventSelector,finalFunction);break;case'dragstart':mobileDragStart(eventTarget,eventSelector,finalFunction);break;case'dragover':mobileDragOver(eventTarget,eventSelector,finalFunction);break;case'dragleave':mobileDragLeave(eventTarget,eventSelector,finalFunction);break;case'drop':mobileDrop(eventTarget,eventSelector,finalFunction);break;default:eventTarget.on(eventType,eventSelector,finalFunction);break;}}
return eventTarget;},'eventOff':function(){if((arguments.length>2)||(arguments[0]&&typeof arguments[0]!='string')){console.log('EventAdapter.off arguments error');return;}
var eventTarget,eventType,eventSelector;if(!(this instanceof jQuery)){eventTarget=jQuery(this);}else{eventTarget=this;}
if(arguments.length==0){eventTarget.off();return eventTarget;}
if(typeof arguments[0]=='string'){eventType=arguments[0];}else{console.log('EventAdapter.off eventType Error');return}
if(typeof arguments[1]=='string'){eventSelector=arguments[1];}else{eventSelector=null;}
if(!AppConfig.isMobile){eventTarget.off(eventType,eventSelector)}else{switch(eventType){case'click':eventTarget.off('touchstart',eventSelector,mobileDragStart);break;case'dragstart':eventTarget.draggable('destroy');break;case'dragover':eventTarget.droppable('destroy');break;case'dragleave':eventTarget.droppable('destroy');break;case'drop':eventTarget.droppable('destroy');break;default:eventTarget.off(eventType,eventSelector);break;}}
return eventTarget;}});EventAdapter.setData=function(date){if(date==undefined)return;eventData=date;};EventAdapter.getData=function(){return eventData;};document.addEventListener('drop',function(){eventData=null;},false);document.addEventListener('touchend',function(){eventData=null;},false);EventAdapter.clearEvent=function(){$(document).off('touchmove.copy');$(document).off('touchmove.drag');$(document).off('touchend.drop');};EventAdapter.analyse=function(eventTarget,eventType){if(eventTarget.length==0)return;var eventTargetName;if(eventTarget.attr('id')){eventTargetName=eventTarget.attr('id');}else if(eventTarget.attr('i18n')){eventTargetName=eventTarget.attr('i18n');}else if(eventTarget.attr('title')){eventTargetName=eventTarget.attr('title');}else{eventTargetName=eventTarget[0].textContent.substr(0,30);}
if(!eventTargetName)return;_hmt.push(['_trackEvent',eventTargetName,eventType,'']);};var mobileDragStart=function(e,target,eventFunction){var originalTarget=$(e.target).closest('[draggable="true"]')[0];var ev=e.type=='touchstart'?e.originalEvent.touches[0]:e,startPos={left:$(originalTarget).css('left'),top:$(originalTarget).css('top'),zIndex:$(originalTarget).css('z-index')},disX=originalTarget.offsetWidth/2,disY=originalTarget.offsetHeight/2;var $copyTarget=$(originalTarget).clone();$copyTarget.data('startPos',startPos);$copyTarget.css('z-index',10000);$copyTarget.css('position','absolute');$copyTarget.css('opacity','0.5');$copyTarget.css('pointer-events','none');var $container=$('body');$container.append($copyTarget);var sPos=$(originalTarget)[0].getBoundingClientRect();$copyTarget.css('left',sPos.left-$container[0].offsetLeft+'px');$copyTarget.css('top',sPos.top-$container[0].offsetTop+'px');$copyTarget[0].cssText=originalTarget.cssText;$copyTarget.css('width',originalTarget.offsetWidth);$copyTarget.css('height',originalTarget.offsetHeight);eventStatus='dragStart';eventFunction.call(this,ev);$(document).off('touchend.copy').on('touchend.copy',function(e){$copyTarget.remove();eventStatus='dragEnd';});$(document).on('touchmove.copy',function(e){eventStatus='dragMove';var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var $parent=$copyTarget.offsetParent();$parent=$parent.is(':root')?$(window):$parent;var targetLeft=ev.pageX-disX;var targetTop=ev.pageY-disY;$copyTarget.css({left:targetLeft+'px',top:targetTop+'px','z-index':10000});})};var mobileDragOver=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn'&&eventStatus!='dragMoveOut')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveIn';eventFunction.call(this,e);break;}}};var mobileDragLeave=function(e,target,eventFunction){if(eventStatus!='dragMoveIn')return;var ev=e.type=='touchmove'?e.originalEvent.touches[0]:e;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if(!((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY))){e.target=target[i];e.currentTarget=target[i];eventStatus='dragMoveOut';eventFunction.call(this,e);}}};var mobileDragEnd=function(e,target,eventFunction){eventFunction.call(this,e);};var mobileDrop=function(e,target,eventFunction){if(eventStatus!='dragMove'&&eventStatus!='dragMoveIn')return;var ev=e.type=='touchend'?e.originalEvent.changedTouches[0]:e;var eventTarget=target;var targetWidth,targetHeight;for(var i=0;i<target.length;i++){targetWidth=target[i].offsetWidth;targetHeight=target[i].offsetHeight;if((target.eq(i).offset().left<ev.pageX&&target.eq(i).offset().left+targetWidth>ev.pageX)&&(target.eq(i).offset().top<ev.pageY&&target.eq(i).offset().top+targetHeight>ev.pageY)){e.target=target[i];e.currentTarget=target[i];eventFunction.call(this,e);break;}}};return EventAdapter;})(jQuery);(function($,undefined){var util={string:{formatEL:function(str,o){if(!str||!o)return'';for(var i in o){if(o.hasOwnProperty(i)){str=str.replace(new RegExp('{'+i+'}','g'),o[i]);}}
return str;}}};function Table(ele,options){var $ele=this.$tblBody=$(ele);var id=$ele.attr('id');this.options=$.extend({},Table.DEFAULTS,options);this.$wrap=$('<div class="ui-tbl-w"></div>').insertAfter($ele);this.$hWrap=$('<div class="ui-tbl-whead"></div>').appendTo(this.$wrap);this.$bWrap=$('<div class="ui-tbl-wbody"></div>').appendTo(this.$wrap);this.$fWrap=$('<div class="ui-tbl-wfoot"></div>').appendTo(this.$wrap);this.$tblHeader=$('<table class="ui-tbl-htable table table-bordered">').appendTo(this.$hWrap);this.$tblBody=$ele.addClass('ui-tbl-btable table table-bordered').appendTo(this.$bWrap);this.$tblFooter=$('<div class="ui-tbl-footer">').appendTo(this.$fWrap);this.$thead=$('<thead>').appendTo(this.$tblHeader);this.$tbody=$('<tbody>').appendTo(this.$tblBody);typeof id==='string'&&this.$tblBody.attr('id',id);this.data=null;this.total=null;this._buildHeader();}
Table.prototype._buildHeader=function(){var prefix=this.options.colPrefix;var cols=this.options.columns;var arrHtml=[];arrHtml.push('<tr>');for(var i=0,len=cols.length;i<len;i++){arrHtml.push(util.string.formatEL('<th class="{prefix}{name}">{title}</th>',{prefix:prefix,name:cols[i].name,title:cols[i].title}));}
arrHtml.push('</tr>');this.$thead.html(arrHtml.join(''));};Table.prototype._buildFooter=function(ds){var tpl=this.options.footerTpl;this.$tblFooter.html(util.string.formatEL(tpl,{total:ds.length})).show();};Table.prototype.loading=function(){this.$tblFooter.hide();this.$tbody.html('<tr><td class="ui-tbl-col-i-info" col-span="'+this.options.columns.length+'"><img src="/static/images/ballsline.gif" alt="loading" /></td></tr>');};Table.prototype.load=function(ds){this._renderTable(ds);this.total=ds.length;this.data=ds;};Table.prototype._renderTable=function(ds){var arrHtml=[];var row=null;var cssCls=null;var formatter=null;var column=null;if(!ds||ds.length<=0){this._showNoData();return;}
for(var i=0,leni=ds.length;i<leni;i++){row=ds[i];arrHtml.push('<tr data-rowindex="'+i+'">');for(var t=0,lent=this.options.columns.length;t<lent;t++){column=this.options.columns[t];cssCls=this.options.colPrefix+column.name;arrHtml.push('<td class="'+cssCls+'">');switch(typeof column.formatter){case'string':arrHtml.push(util.string.formatEL(column.formatter,row));break;case'function':arrHtml.push(column.formatter(i,row)||'');break;}
arrHtml.push('</td>');}
arrHtml.push('</tr>');}
this.$tbody.html(arrHtml.join(''));this._buildFooter(ds);};Table.prototype.filter=function(rule){var ds=this.data;var result=[];if(!rule){result=ds;}else{for(var i=0,len=ds.length;i<len;i++){for(var r in rule){if(ds[i].hasOwnProperty(r)){if(ds[i][r].toLowerCase().indexOf(rule[r].toLowerCase())>-1){result.push(ds[i]);}}}}}
this._renderTable(result);};Table.prototype.setStretchHeight=function(l){this.$bWrap.css('height',l);};Table.prototype.getData=function(){return this.data;};Table.prototype._showNoData=function(){this.$tblFooter.hide();this.$tbody.html('<tr><td class="ui-tbl-col-i-info" col-span="'+this.options.columns.length+'">no records</td></tr>');};Table.prototype.destroy=function(){};Table.DEFAULTS={colPrefix:'ui-tbl-col-',footerTpl:'<strong>{total}</strong> records in total'};function Plugin(option,args){var $this=this;var data=$this.data('ui.w.table');var options=typeof option=='object'&&option;if(!data&&option=='destroy')return;if(!data)$this.data('ui.w.table',(data=new Table(this,options)));if(typeof option=='string')return data[option](args);}
$.fn.table=Plugin;}(jQuery));var Validator=(function($,undefined){var push=[].push;var rulesMap={};function RuleWrap(ele,name,rule){this.$ele=$(ele);this.name=name;this.rule=rule;this.defer=$.Deferred();this.value=this.$ele.val();};RuleWrap.prototype.valid=function(){var handler=this.rule.valid;var _this=this;var type=$.type(handler);if(type!=='function'&&type!=='string'){console.warn('rule is illigal!');return;}
else if(type==='string'&&rulesMap[handler]===undefined){console.warn('rule is not exists!');return;}
else if(type==='string'){handler=rulesMap[handler];}
return handler;};RuleWrap.prototype.success=function(){this.defer.resolveWith(this);};RuleWrap.prototype.fail=function(){this.defer.rejectWith(this);};function Validator(ele,options){if(arguments.length===0)return this;if(arguments.length===1){options=ele;ele='body';}
this.$ele=$.type(ele)==='object'?ele:$(ele);this.options=$.extend({},Validator.DEFAULTS,options);this.__merge(this,this.options.elements||[]);this.__init();return this;}
Validator.prototype.__init=function(){var $selectors;var html='<span class="glyphicon'+
(this.options.icon?' glyphicon-pencil':'')+' form-control-feedback"></span>';for(var i=0,row,len=this.length;i<len;i++){row=this[i];$selectors=$.type(row['selector'])==='object'?row['selector']:$(row['selector'],this.$ele);$selectors.each(function(i,ele){var $ele=$(ele),$formGroup;$formGroup=$ele.closest('.form-group');$formGroup.addClass('has-feedback');if($formGroup.children('form-control-feedback').length===0){$(html).insertAfter($ele);}});}};Validator.prototype.valid=function(callback){var self=this;var row,results=[];var $selectors;var deferGroups=[];this.resetStatus();for(var i=0,len=this.length;i<len;i++){row=this[i];$selectors=$.type(row['selector'])==='object'?row['selector']:$(row['selector'],this.$ele);if($selectors.length===0)continue;$selectors.each(function(i,ele){var $ele=$(ele);var val=$ele.val();var defers=[];var obj;for(var t=0,len2=row.rules.length;t<len2;t++){obj=new RuleWrap(ele,row.name,row.rules[t]);defers.push(obj);}
defers[0].valid().call(defers[0],defers[0].value);defers=defers.map(function(row,i,arr){if(i+1<len2){row.defer.done(function(){arr[i+1].valid().call(arr[i+1],defers[0].value);});}
return row.defer;});deferGroups.push(defers);});}
deferGroups=deferGroups.map(function(deferGrp,i){var newDefer=$.Deferred();$.when.apply($,deferGrp).done(function(){var $ele,$formGroup;var _this,obj={};if(this.length)_this=this[0];else _this=this;$ele=_this.$ele;self.setStatus($ele,'success');obj[_this.name]=_this.value;newDefer.resolve(obj);}).fail(function(){var $ele=this.$ele,ele=$ele[0];self.setStatus($ele,'error');if(ele.timer!==null){window.clearTimeout(ele.timer);ele.timer=null;}
$ele.tooltip({placement:'top',trigger:'manual'}).attr('data-original-title',this.rule['msg']).tooltip('show');ele.timer=window.setTimeout((function($ele){return function(){$ele.tooltip('hide');$ele[0].timer=null;}}($ele)),2000);newDefer.reject();});return newDefer;});return $.when.apply($,deferGroups).then(function(rs){return $.extend.apply($,([]).slice.call(arguments));});};Validator.prototype.setStatus=function($ele,type){if(!this.options.icon)return;if(type==='error'){$ele.closest('.form-group').addClass('has-error').children('.form-control-feedback').removeClass(['glyphicon-ok','glyphicon-pencil'].join(' ')).addClass('glyphicon-remove');}else if(type==='success'){$ele.closest('.form-group').addClass('has-success').children('.form-control-feedback').removeClass(['glyphicon-pencil','glyphicon-remove'].join(' ')).addClass('glyphicon-ok');}};Validator.prototype.resetStatus=function(){var $selectors,row,$ele,ele,data;for(var i=0,len=this.length;i<len;i++){row=this[i];$selectors=typeof row['selector']==='object'?row['selector']:$(row['selector'],this.$ele);for(var t=0,len2=$selectors.length;t<len2;t++){$ele=$selectors.eq(t);ele=$selectors[t];$ele.parents('.form-group').removeClass('has-error has-success');if(ele.timer){window.clearTimeout(ele.timer);ele.timer=null;}
if(data=$ele.data('bs.tooltip')){data.$tip.detach();}}}};Validator.prototype.filter=function(selector){return this.__seek(selector,true);};Validator.prototype.not=function(selector){return this.__seek(selector,false);};Validator.prototype.__seek=function(selector,isNeed){var results=[],ret;var eles=this.options.elements;var regx=$.type(selector)==='string'?new RegExp('^'+selector+'$'):regx;if($.type(regx)!=='regexp'){throw'selector is not a RegExp object or a string!';}
isNeed=isNeed||false;for(var i=0,len=eles.length;i<len;i++){if(!!regx.test(eles[i]['name'])===isNeed)results.push(eles[i]);}
ret=this.__merge(new this.constructor(),results);ret.prevObj=this;ret.$ele=this.$ele;ret.options=this.options;return ret;}
Validator.prototype.__merge=function(newObj,arr){for(var i=0,len=arr.length;i<len;i++){push.call(newObj,arr[i]);}
return newObj;};Validator.prototype.length=0;Validator.prototype.splice=[].splice;Validator.extendRules=function(name,handler){var rules={},fn;if($.type(name)==='string')rules[name]=handler;else if($.type(name)==='object')rules=name;else return;for(var i in rules){if(!rules.hasOwnProperty(i))continue;fn=rules[i]
if($.type(fn)!=='function')continue;rulesMap[i]=fn;}};Validator.extendRules({'require':function(val){if(val.trim()==='')this.fail();else this.success();},'word':function(val){if(/^\w+$/.test(val))this.success();else this.fail();}});Validator.DEFAULTS={tooltipDelay:2000,icon:true};return Validator;}(jQuery))
﻿
var OperatingPane=(function(){function OperatingPane(pointName,value,description,screen){this.pointName=pointName;this.value=value;this.description=description;this.screen=screen;this.element=undefined;this.i18=I18n.resource.observer.widgets;this.init();};OperatingPane.prototype={show:function(){$('#dialogOperatingPane').modal({});},close:function(){this.pointName=null;this.value=null;this.description=null;this.screen=null;this.element.parentNode.removeChild(this.element);},init:function(){var _this=this;$("#dialogOperatingPane").remove();this.element=document.createElement("div");this.element.id="dialogOperatingPane";this.element.className="modal fade";this.element.attributes["tabindex"]=-1;this.element.attributes["role"]="dialog";this.element.attributes["aria-labelledby"]="myModalLabel";this.element.attributes["aria-hidden"]=true;var divModal=document.createElement("div");divModal.className="modal-dialog";var sb=new StringBuilder();sb.append('<div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span>\
                <span class="sr-only">Close</span></button><h4 class="modal-title" id="myModalLabel" i18n="observer.widgets.ACTION_CONFIRM"></h4></div>\
                <div class="modal-body">');sb.append(I18n.resource.observer.widgets.CONFIRM).append(this.description).append("？");sb.append('</div><div class="modal-footer"></div></div>')
divModal.innerHTML=sb.toString();var btnSure=document.createElement("button");btnSure.type="button";btnSure.className="btn btn-primary";btnSure.attributes["data-dismiss"]="modal";btnSure.textContent=this.i18.CONFIRM;btnSure.onclick=function(e){$("#dialogOperatingPane .modal-footer").hide();$("#dialogOperatingPane .modal-body").html(_this.i18.EXECUTING+"...");_this.initProcessBar();_this.setValue();};var btnCancel=document.createElement("button");btnCancel.type="button";btnCancel.className="btn";btnCancel.attributes["data-dismiss"]="modal";btnCancel.textContent=this.i18.CANCEL;btnCancel.onclick=function(e){$('#dialogOperatingPane').modal('hide');};this.element.appendChild(divModal);$("body").append(this.element);var $footer=$("#dialogOperatingPane .modal-footer");$footer.append(btnSure);$footer.append(btnCancel);$('#dialogOperatingPane').on('hidden.bs.modal',function(e){_this.close();})},setValue:function(){var _this=this;this.updateProcess("10%： "+this.i18.START_SENDING_REQUEST+"...",10);WebAPI.post("/set_realtimedata",{db:AppConfig.projectId,point:this.pointName,value:this.value}).done(function(result){_this.updateProcess("40%： "+_this.i18.REQUEST_SENT_CONFIRM+"...+",40);var count=1;var interval=setInterval(function(){WebAPI.post("/get_realtimedata",{proj:AppConfig.projectId,pointList:[_this.pointName]}).done(function(result){var data=JSON.parse(result);if(!data.error&&data[0].value&&data[0].value==_this.value){_this.updateProcess("100%: "+I18n.resource.observer.widgets.DATA_OPERATION_COMPLETE+"！",100);clearInterval(interval);_this.screen.refreshData({data:data});setTimeout(function(){$('#dialogOperatingPane').modal('hide');},1000);}
else{if(count<5){var percen=40+count*10;_this.updateProcess(percen.toString()+"%: 第 "+count.toString()+I18n.resource.observer.widgets.TIMES_DATA_CONFIRM,40+count*10);count++;}
else{_this.processError("error： "+I18n.resource.observer.widgets.FAIL_TRY_AGAIN+"！");clearInterval(interval);}}})},2000)}).error(function(result){_this.processError("error： "+I18n.resource.observer.widgets.FAIL_SEND_REQUEST);});},processError:function(strMessage){var $bars=$("#divOperatingBar .progress-bar");$bars.removeClass("progress-bar-success");$bars.addClass("progress-bar-danger");this.updateProcess(strMessage,100);},initProcessBar:function(){var divProcessBar=document.createElement("div");divProcessBar.id="divOperatingBar";divProcessBar.className="progress";divProcessBar.style.height="30px";divProcessBar.style.marginTop="10px";var divBar=document.createElement("div");divBar.className="progress-bar progress-bar-success progress-bar-striped active";divBar.style.lineHeight="30px";divBar.setAttribute("role","progressbar");divBar.setAttribute("role","progressbar");divProcessBar.appendChild(divBar);$('#dialogOperatingPane .modal-body').append(divProcessBar);},updateProcess:function(strProcess,value){var $bars=$("#divOperatingBar .progress-bar");$bars.html(strProcess);$bars.width(value+"%");}}
return OperatingPane;})();﻿
var OperatingRecord=(function(){function OperatingRecord(){this.init();};OperatingRecord.prototype={show:function(){$('#dialogModal').modal({});},init:function(){var _this=this;WebAPI.get("/static/views/observer/widgets/operatingRecord.html").done(function(resultHtml){var $dialogContent=$("#dialogContent");$dialogContent.html(resultHtml);$("#datePickerLog").datetimepicker({minView:"month",autoclose:true,todayBtn:true,initialDate:new Date()});$("#txtLogDate").val(new Date().toLocaleDateString().replace('/','-').replace('/','-'));$("#txtLogDate").change(function(e){_this.refreshData();});$("#btnLogPre").click(function(e){var preDay=new Date($("#txtLogDate").val().toDate()-86400000);$("#txtLogDate").val(preDay.toLocaleDateString().replace('/','-').replace('/','-'));_this.refreshData();});$("#btnLogNext").click(function(e){var nextDay=new Date($("#txtLogDate").val().toDate()+86400000);$("#txtLogDate").val(nextDay.toLocaleDateString().replace('/','-').replace('/','-'));_this.refreshData();});_this.refreshData();I18n.fillArea($dialogContent);});},refreshData:function(){Spinner.spin($("#dialogContent .modal-body")[0]);var _this=this;WebAPI.post("/get_operation_log",{proj:AppConfig.projectId,date:$("#txtLogDate").val()}).done(function(result){var data=JSON.parse(result);_this.renderData(data);}).always(function(){Spinner.stop();});},renderData:function(data){var sb=new StringBuilder();if(data.length&&data.length>0){for(var i=0;i<data.length;i++){sb.append("<tr><td>").append(new Date(data[i].RecordTime*1000).format("yyyy-MM-dd HH:mm:ss")).append("</td>");sb.append("<td>").append(data[i].user).append("</td>");sb.append("<td>").append(data[i].OptRemart).append("</td></tr>");}}
else{sb.append("<tr><td colspan=3 i18n='observer.widgets.NO_OPERATIONS_TODAY'></td></tr>");}
$("#tableOperatingRecord tbody").html(sb.toString());}}
return OperatingRecord;})();var HistoryChart=(function(){function HistoryChart(data,startDate,endDate){this.historyData=data;this.startDate=startDate;this.endDate=endDate;this.$dialogContent=$("#dialogContent");this.historyChart=null;}
HistoryChart.prototype={show:function(){var _this=this;$('#dialogModal').one('hidden.bs.modal',function(){_this.historyChart&&_this.historyChart.dispose&&_this.historyChart.dispose();$(this).find('#dialogContent').removeClass('historyChartBigModel');_this.$dialogContent.empty();}).one('shown.bs.modal',function(){_this.$dialogContent.addClass('historyChartBigModel');_this.init();}).modal();},init:function(){var _this=this;return WebAPI.get("/static/views/observer/widgets/historyChart.html").done(function(resultHtml){_this.$dialogContent.html(resultHtml);_this.refreshData();});},refreshData:function(){var legends=[],series=[];if(!this.historyData.data){series.push({data:[]});}else{for(var pointName in this.historyData.data){legends.push(pointName);series.push({name:pointName,type:'line',data:this.historyData.data[pointName],markPoint:{data:[{type:'max',name:I18n.resource.observer.widgets.MAXIMUM},{type:'min',name:I18n.resource.observer.widgets.MINIMUM}]}});}}
var legends_handled=[];for(var l=0,l_length=legends.length;l<l_length;l++){legends_handled.push(legends[l]);if((l+1)%3===0){legends_handled.push('');}}
var option={title:{text:I18n.resource.dataManage.HISTORY_CURVE,subtext:this.startDate.format('yyyy-MM-dd HH:mm:ss')+'  -  '+this.endDate.format('yyyy-MM-dd HH:mm:ss'),x:'center'},tooltip:{trigger:'axis',axisPointer:{type:'line',lineStyle:{type:'dashed',width:1}}},legend:{data:legends_handled,x:'left'},toolbox:{show:true,feature:{mark:{show:true},dataZoom:{show:true,readOnly:false},dataView:{show:true,readOnly:true,optionToContent:this.optionToContent},restore:{show:true},saveAsImage:{show:true}}},dataZoom:{show:true},xAxis:[{type:'category',data:this.historyData.timeStamp}],yAxis:[{type:'value'}],series:series};var $tableOperatingRecord=$('#tableOperatingRecord');$tableOperatingRecord.css('width',($tableOperatingRecord.parent().width()*0.9).toFixed(1)+'px');this.historyChart=echarts.init($tableOperatingRecord.get(0),AppConfig.chartTheme).setOption(option);},optionToContent:function(opt){var axisData=opt.xAxis&&opt.xAxis[0].data,series=opt.series;var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+opt.title.text+'</p>';var html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';if(BEOPUtil.isUndefined(axisData)){html+='<tr>';for(var i=0,l=series.length;i<l;i++){html+='<td colspan="2">'+series[i].name+'</td>';}
html+='</tr>';var longestSeriesData=[],longestLength=0;for(var j=0,sl=series.length;j<sl;j++){if(series[j].data.length>longestLength){longestSeriesData=series[j].data;longestLength=longestSeriesData.length;}}
for(var i=0,il=longestSeriesData.length;i<il;i++){html+='<tr>';for(var m=0,ml=series.length;m<ml;m++){if(!BEOPUtil.isUndefined(series[m].data[i])){for(var n=0,nl=series[m].data[i].length;n<nl;n++){html+='<td>'+series[m].data[i][n]+'</td>';}}}
html+='</tr>';}}else{html+='<tr><td>'+opt.xAxis[0].name+'</td>';for(var i=0,l=series.length;i<l;i++){html+='<td>'+series[i].name+'</td>';}
html+='</tr>';for(var i=0,l=axisData.length;i<l;i++){html+='<tr>'+'<td>'+axisData[i]+'</td>';for(var j=0,sl=series.length;j<sl;j++){html+='<td>'+series[j].data[i]+'</td>';}
html+='</tr>';}}
html+='</tbody></table>';return html;}};return HistoryChart;})();var UploadFile=(function(){function UploadFile(data){this.init();this.m_data=data;};UploadFile.prototype={show:function(){$('#dialogModal').modal({});},init:function(){var _this=this;WebAPI.get("/static/views/observer/widgets/uploadFile.html").done(function(resultHtml){$("#dialogContent").html(resultHtml);_this.refreshData();$("#btn_write_pt").click(function(e){var ptList=[];var name;var value;var row;$(".chkPtSel").each(function(){name=$(this).closest('tr').find('.ptName').text();value=$(this).closest('tr').find('.ptValue').text();row={pointName:name,pointValue:value};ptList.push(row);})
if(0==ptList.length){alert(I18n.resource.observer.widgets.PLEASE_SELECT_POINT+"！");return;}
WebAPI.post("/update_realtimedata_input_value",{project:AppConfig.projectName,listInfo:ptList}).done(function(result){}).error(function(e){alert(I18n.resource.observer.widgets.UPDATE_TABLE+"realtimedata_input"+I18n.resource.observer.widgets.FAILED+"！");Spinner.stop();});});$("#chk_all_sel").click(function(e){var state=$("#chk_all_sel").is(":checked");var arr=document.getElementsByClassName('chkFlag');for(var i=0;i<arr.length;i++){arr[i].checked=state;}});});},refreshData:function(){this.initData(this.m_data);},initData:function(data){var table=$("#tableOperatingRecord tbody");var tr;var td;var jsonData=JSON.parse(data);if(jsonData.length&&jsonData.length>0){for(var i=0;i<jsonData.length;i++){tr=document.createElement('tr');td=document.createElement('td');td.className='chkPtSel';td.innerHTML="<input type='checkbox' class='chkFlag' />";tr.appendChild(td);td=document.createElement('td');td.className='ptName';td.innerHTML=jsonData[i][0].name;tr.appendChild(td);td=document.createElement('td');td.className='ptValue';td.innerHTML=jsonData[i][1].value;tr.appendChild(td);table.append(tr);}}
else{table.append("<tr><td colspan=3 i18n='observer.widgets.NO_DATA_READ'></td></tr>");}}}
return UploadFile;})();var PointManager=(function(){function PointManager(){this.i18=I18n.resource.observer.widgets;this.pointInfoList=[];}
PointManager.prototype={show:function(){var _this=this;$("#ulPages li").removeClass("active");$("#page-DataWatch").parent().addClass("active");WebAPI.get("/static/views/observer/pointManager.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);if(AppConfig.projectName==null){$('#myTab li:last-child').hide();}else{$('#stPjName').html(AppConfig.projectName);}
I18n.fillArea($('#divUploadWrap'));_this.initProjectPointList();_this.attachEvents();I18n.fillArea($(ElScreenContainer));});},close:function(){this.detachEvents();},attachEvents:function(){var _this=this;var $pjData=$('#iptPjData');var $btnConfirm=$('#btnConfirmUpload');var $spUploadInfo=$('#spUploadInfo');var $btnUploadCSV=$('#btnUploadCSV');var $divPjDataDropHandler=$('#divPjDataDropHandler');var $tip=$divPjDataDropHandler.children('p');var $uploadMask=$('#uploadMask');var $body=$('body');var uploadStatus=-1;var fileSelected;var dragFix=false;$spUploadInfo.tooltip({title:'',trigger:'manual',placement:'right'});var uploadHandler=function(file){var formData=new FormData();var match=file.name.match(/\.[A-Za-z0-9]+$/);var supportFiles=['.csv','.xls','.xlsx'];if(!file||!match||supportFiles.indexOf(match[0].toLowerCase())<0){util.tooltip.show($spUploadInfo,'文件格式有误，请上传正确的 .csv/.xls/.xlsx 格式文件！');isDataUploadReady=false;return;}
fileSelected=file;formData.append('config-file',file);$.ajax({url:'/get_config_data/'+AppConfig.userId,type:'post',data:formData,dataType:'json',xhr:function(){var xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener('progress',function(e){var progress=Math.round(e.loaded/e.total);if(e.lengthComputable){$('#spUploadInfo').html('正在上传...'+progress*100+'%');}},false);xhr.upload.addEventListener('load',function(e){$('#spUploadInfo').html('正在处理数据...');},false);}
return xhr;},cache:false,contentType:false,processData:false}).done(function(rs){$('#spUploadInfo').removeClass().addClass('text-success').html('上传成功 - '+file.name);uploadStatus=0;}).fail(function(err){$('#spUploadInfo').removeClass().addClass('text-danger').html('上传失败，文件中有错误！');uploadStatus=-1;});};$btnUploadCSV.click(function(e){$pjData.click();});$pjData.change(function(){uploadHandler($(this)[0].files[0]);});$divPjDataDropHandler.on('dragenter',function(e){dragFix=true;$tip.html('松开鼠标开始上传');e.stopPropagation();e.preventDefault();});$divPjDataDropHandler.on('dragleave',function(e){dragFix=false;$tip.html('请将文件拖拽到此处进行上传');e.stopPropagation();e.preventDefault();});$divPjDataDropHandler.on('drop',function(e){var files,file;$divPjDataDropHandler.hide();$uploadMask.hide();$tip.html('请将文件拖拽到此处进行上传');files=e.originalEvent.dataTransfer.files;if(files.length>1)alert('请注意：\n目前系统不支持同时上传多个文件，将会使用您选择的第一个文件进行上传！');file=files[0];uploadHandler(file);e.stopPropagation();e.preventDefault();});$uploadMask.on('dragleave',function(e){e.stopPropagation();if(dragFix)return;$uploadMask.hide();$divPjDataDropHandler.hide();});$body.on('dragenter',function(e){$divPjDataDropHandler.show();$uploadMask.show();e.preventDefault();});$body.add($uploadMask).add($divPjDataDropHandler).on('dragover',function(e){e.preventDefault();});$body.on('keydown',function(e){if(e.keyCode===27){$uploadMask.hide();$divPjDataDropHandler.hide();e.preventDefault();}});$body.on('drop',function(e){$uploadMask.hide();$divPjDataDropHandler.hide();e.preventDefault();});$btnConfirm.click(function(){if(AppConfig.projectId==null){alert('请您先选择一个项目，再进行上传！');return;}
if(uploadStatus!==0){alert('请您先上传数据，并保证数据的正确性！');return;}
Spinner.spin($body[0]);WebAPI.post('/project/import_user_data/'+AppConfig.userId,{dataFileName:fileSelected.name,projId:AppConfig.projectId}).done(function(rs){rs=JSON.parse(rs);if(typeof rs==='object'&&rs.error==='successful'){alert('数据导入成功！');ScreenManager.show(PointManager);}else{alert('服务器忙碌中，请稍后重试！');}}).fail(function(){alert('服务器忙碌中，请稍后重试！');}).always(function(){Spinner.stop();});});$("#divPointManagerPage").on('click','.pointList tbody tr',function(){var $this=$(this);if($this.is('.active')){$this.removeClass('active');}else{$this.addClass('active');}});$("#delSelect").click(function(){var pointsToUpdateList,$selectedItem,$notSelectedItem;$selectedItem=$('#tableMonitor tr.pointItem.active');$notSelectedItem=$('#tableMonitor tr.pointItem:not(.active)');pointsToUpdateList=$notSelectedItem.map(function(index,item){return $(item).data('point');});WebAPI.post('/admin/dataManager/update/',{userId:AppConfig.userId,projectId:AppConfig.projectId,points:pointsToUpdateList.toArray().join(',')}).done(function(result){if(result.success){$selectedItem.remove();}});});$("#joinMonitoring").click(function(){var $item,$selectedItem,pointsToAdd,pointsMonitored,pointUpdateObject={},pointUpdateList;$selectedItem=$('#tableWatch tr.active');pointsToAdd=$selectedItem.map(function(index,item){$item=$(item);return{name:$item.data('point'),value:$item.data('value')}}),pointsMonitored=$('#tableMonitor tr.pointItem').map(function(index,item){$item=$(item);return{name:$item.data('point'),value:$item.data('value')}});for(var i=0,i_len=pointsToAdd.length;i<i_len;i++){pointUpdateObject[pointsToAdd[i].name]=pointsToAdd[i].value;}
for(var i=0,i_len=pointsMonitored.length;i<i_len;i++){pointUpdateObject[pointsMonitored[i].name]=pointsMonitored[i].value;}
pointUpdateList=Object.keys(pointUpdateObject);WebAPI.post('/admin/dataManager/update/',{userId:AppConfig.userId,projectId:AppConfig.projectId,points:pointUpdateList.join(',')}).done(function(result){if(result.success){var renderList=[];for(var pointName in pointUpdateObject){renderList.push({name:pointName,value:pointUpdateObject[pointName]});}
_this.loadMonitorList(renderList);$selectedItem.removeClass('active');}});});$("#joinCurve").click(function(){var $selectedItem=$("#tableWatch tbody tr.active, #tableMonitor tbody tr.active"),$point_name_list,point_name_list,alert;if(!$selectedItem.length){return;}
if($selectedItem.length>10){alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.dataManage.UP_TO_TEN_RECORDS);alert.showAtTop(2000);return;}
Spinner.spin($("#divPointManagerPage")[0]);$point_name_list=$selectedItem.map(function(index,item){return $(item).data('point');});point_name_list=$point_name_list.toArray();point_name_list=point_name_list.filter(function(item,pos){return point_name_list.indexOf(item)==pos;});var date_start=new Date();var data_end=new Date();date_start.setDate(data_end.getDate()-3);WebAPI.post("/get_history_data_padded_reduce",{projectId:AppConfig.projectId,pointList:point_name_list,timeStart:date_start.format("yyyy-MM-dd HH:mm:ss"),timeEnd:data_end.format("yyyy-MM-dd HH:mm:ss"),timeFormat:"m5"}).done(function(result){try{var data=JSON.parse(result);}catch(e){console.error(result);alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.observer.widgets.HISTORY_CURVE_FAILED);alert.showAtTop(2000);return;}
new HistoryChart(data,date_start,data_end).show();}).fail(function(e){console.log('历史数据请求失败'+e);alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.observer.widgets.HISTORY_CURVE_FAILED);alert.showAtTop(2000);}).always(function(){Spinner.stop();});});$("#pointRefresh").click(function(){Spinner.spin($("#divPointManagerPage")[0]);$("#searchPointName").val("");_this.refreshPointList();});$("#searchPointName").keyup(function(){_this.searchList();});$("#serachDel").click(function(){$("#searchPointName").val("");_this.searchList();});},detachEvents:function(){$('#divPjDataDropHandler').off();$('#uploadMask').off();$('body').off();},searchList:function(){var keyWordVal=$.trim($("#searchPointName").val());var val=keyWordVal.toLowerCase();var $tbody=$("#tableWatch tbody");var pointHtml='';if(val==""){for(var i=0;i<this.pointInfoList.length;i++){var ptList=this.pointInfoList[i];pointHtml+='<tr data-point="'+ptList.name+'" data-value="'+ptList.value+'"><td>'+(i+1)+'</td><td class="point_'+ptList.name+'">'+ptList.name+'</td><td class="value_'+ptList.value+'">'+ptList.value+'</td></tr>';}}else{var showPointArr=[];for(var i=0;i<this.pointInfoList.length;i++){var ptList=this.pointInfoList[i];var ptListName=ptList.name.toLowerCase();if(ptListName.indexOf(val)>-1){if(ptListName.indexOf(val)==0){showPointArr.unshift(ptList);}else{showPointArr.push(ptList);}}}
for(var i=0;i<showPointArr.length;i++){var ptList=showPointArr[i];var name=ptList.name;var reg=new RegExp("("+keyWordVal+")","gi");var keyWordName=name.replace(reg,'<span class="keyword">$1</span>');pointHtml+='<tr data-point="'+name+'" data-value="'+ptList.value+'"><td>'+(i+1)+'</td><td class="point_'+name+'">'+keyWordName+'</td><td class="value_'+ptList.value+'">'+ptList.value+'</td></tr>';}}
$tbody.html(pointHtml);},refreshPointList:function(){var _this=this;return WebAPI.post("/get_realtimedata",{proj:AppConfig.projectId}).done(function(result){var ptLists=JSON.parse(result);if(!ptLists.length){alert("'"+AppConfig.projectShowName+"' "+_this.i18.FAIL_FIND_POINT+"！");return;}
ptLists.sort(function(a,b){if(a.name.toLowerCase()<b.name.toLowerCase())return-1;if(a.name.toLowerCase()>b.name.toLowerCase())return 1;return 0;});_this.pointInfoList=ptLists;var pointListHtml='';for(var i=0;i<ptLists.length;i++){var point=ptLists[i];pointListHtml+='<tr data-point="'+point.name+'" data-value="'+point.value+'"><td>'+(i+1)+'</td><td class="point_'+point.name+'">'+point.name+'</td><td class="value_'+point.value+'">'+point.value+'</td></tr>';}
$("#tableWatch tbody").html(pointListHtml);}).fail(function(){alert(I18n.resource.analysis.paneConfig.ERR1);}).always(function(){Spinner.stop();});},loadMonitorList:function(pointList){$("#tableMonitor tbody").empty();var html='';for(var i=0;i<pointList.length;i++){var point=pointList[i];html+='<tr class="pointItem" data-point="'+point.name+'" data-value="'+point.value+'"><td class="point_'+point.name+'">'+point.name+'</td><td class="value_'+point.value+'">'+point.value+'</td></tr>';}
$("#tableMonitor tbody").append(html);},initProjectPointList:function(){var _this=this,savedPointsPromise,savedPoints=[];savedPointsPromise=WebAPI.get('/admin/dataManager/load/'+AppConfig.userId+'/'+AppConfig.projectId);$.when(this.refreshPointList(),savedPointsPromise).done(function(pointListResult,savedPointsResult){if(!savedPointsResult[0].success){}else{if(savedPointsResult[0].data&&savedPointsResult[0].data.points){savedPoints=savedPointsResult[0].data.points.split(',').sort();}}
var monitorList=[];for(var i=0,p_length=_this.pointInfoList.length;i<p_length;i++){for(var j=0,s_length=savedPoints.length;j<s_length;j++){if(_this.pointInfoList[i].name===savedPoints[j]){monitorList.push(_this.pointInfoList[i]);savedPoints.splice(j,1)}}}
_this.loadMonitorList(monitorList);});}};return PointManager;})();var AlarmLogging=(function(){var _this=this;var ALARM_RULE_NAME='alarm_rules';var alarmMode={LIMIT_VALUE:0,LIMIT_VALUE_TITLE:'Limit-Value Alarm Mode',BOOL:1,BOOL_TITLE:'Bool Alarm Mode',DIAGNOSIS:2,DIAGNOSIS_TITLE:'Diagnosis Alarm Mode'};var util={checkbox:{selectAll:function($eles){$eles.each(function(){var $this=$(this);if(!$this.is(':checked'))$this.prop('checked',true);});},selectInverse:function($eles){$eles.each(function(i){var $this=$(this);$this.prop('checked',$this.is(':checked')?false:true);});},unSelectAll:function($eles){$eles.each(function(i){var $this=$(this);if($this.is(':checked'))$this.prop('checked',false);});},isAllChecked:function($eles){return $eles.not(':checked').length<=0;},keepOneCheckbox:function($cbs){var $checkedCb=$cbs.filter(':checked');if($checkedCb.length<=1){$checkedCb.prop('disabled',true);}else{$cbs.prop('disabled',false);}}}};function AlarmLogging(){_this=this;this.timer=null;this.onmessage_global=BackgroundWorkers.alarmReporter.onmessage;this.validator=null;}
AlarmLogging.prototype={show:function(){Spinner.spin(ElScreenContainer);$("#ulPages li").removeClass("active");$("#page-DataWatch").parent().addClass("active");WebAPI.get("/static/views/observer/widgets/alarmLogging.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.init();}).always(function(){Spinner.stop();});},init:function(){this.$alarmLoggingPane=$('#alarmLoggingPane');this.$btnClose=$('#btnClose');this.$iptStartTime=$('#iptStartTime');this.$iptEndTime=$('#iptEndTime');this.$panelLog=$('#panelLog');this.$tbAlarm=$('#tbAlarm');this.$btnAlarmSrch=$('#btnAlarmSrch');this.$btnReload=$('#btnReload');this.$spLoading=this.$btnReload.children('span');this.$btnCog=$('#btnConfig');this.$btnAddRule=$('#btnAddRule');this.$btnDelRule=$('#btnDelRule');this.$tbRule=$('#tbRule');this.$panelCog=$('#panelCog');this.$btnRuleSrch=$('#btnRuleSrch');this.$iptRuleSrch=$('#iptRuleSrch');this.$btnLogList=$('#btnLogList');this.$btnSelectAll=$('#btnSelectAll');this.$cbSelectAll=this.$btnSelectAll.children('input');this.$lkSelectAll=$('#lkSelectAll');this.$lkSelectInverse=$('#lkSelectInverse');this.$lkUnSelectAll=$('#lkUnSelectAll');this.$ruleModal=$('#ruleModal');this.$divRuleForm=$('#divRuleForm');this.$divAlarmInfo=$('#divAlarmInfo');this.$divRuleEnable=$('#divRuleEnable');this.$divRuleValue=$('#divRuleValue');this.$divAlarmLevel=$('#divAlarmLevel');this.$cbLL=$('#cbLL');this.$cbL=$('#cbL');this.$cbH=$('#cbH');this.$cbHH=$('#cbHH');this.$iptLL=$('#iptLL');this.$iptL=$('#iptL');this.$iptH=$('#iptH');this.$iptHH=$('#iptHH');this.$iptLLInfo=$('#iptLLInfo');this.$iptLInfo=$('#iptLInfo');this.$iptHInfo=$('#iptHInfo');this.$iptHHInfo=$('#iptHHInfo');this.$iptPointName=$('#iptPointName');this.$iptAlarmInfo=$('#iptAlarmInfo');this.$iptAlarmLevel=$('#iptAlarmLevel');this.$btnRuleSubmit=$('#btnRuleSubmit');this.$divFormTip=$('#divFormTip');this.$ddAlarmMode=$('#ddAlarmMode');this.$btnAlarmMode=this.$ddAlarmMode.find('button');this.$spAlarmModeTitle=this.$btnAlarmMode.find('span').eq(0);this.$lkAlarmModeItems=this.$ddAlarmMode.find('ul>li>a');$(".form-datetime").datetimepicker({format:'yyyy-mm-dd hh:ii:ss',autoclose:true,todayBtn:true,minuteStep:20});this.attachEvents();this.initTable();this.resize();this.$iptEndTime.val(new Date().format('yyyy-MM-dd HH:mm:ss')).datetimepicker('update');this.startAutoload();this.initFormValidation();},startAutoload:function(runAtStart){runAtStart=(runAtStart===undefined||runAtStart===null)?true:runAtStart;runAtStart&&this.$btnReload.trigger('click');BackgroundWorkers.alarmReporter.onmessage=function(e){var rs=e.data;if(rs.status==='LOADING'){_this.$tbAlarm.table('loading');_this.$spLoading.addClass('loading');return;}
_this.reloadRecord(rs.data);_this.onmessage_global(e);};},stopAutoload:function(){BackgroundWorkers.alarmReporter.onmessage=this.onmessage_global;},initTable:function(){this.$tbAlarm.table({columns:[{name:'no',title:'No',formatter:function(i,row){return i+1;}},{name:'time',title:'Time',formatter:'{time}'},{name:'bindpointname',title:'Point Name',formatter:'{bindpointname}'},{name:'info',title:'Info',formatter:'{info}'},{name:'level',title:'Level',formatter:function(i,row){switch(row['level']){case 1:case 2:return'<span class="label label-warning">Warning</span>';case 3:case 4:default:return'<span class="label label-danger">Danger</span>';}}},{name:'operations',title:'Operations',formatter:'\
                    <div class="dropdown">\
                        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">\
                            Delay this alarm <span class="caret"></span>\
                        </button>\
                        <ul class="dropdown-menu" role="menu">\
                            <li data-value="30"><a href="javascript:">Delay 30 minutes</a></li>\
                            <li data-value="60"><a href="javascript:">Delay 1 hour</a></li>\
                            <li data-value="180"><a href="javascript:">Delay 3 hours</a></li>\
                            <li data-value="360"><a href="javascript:">Delay 6 hours</a></li>\
                            <li data-value="1440"><a href="javascript:">Delay 1 day</a></li>\
                        </ul>\
                    </div>'}]});this.$tbRule.table({columns:[{name:'cb',title:'',formatter:function(i,row){return'<input type="checkbox" data-rowindex="'+i+'" />'}},{name:'pointname',title:'Point',formatter:'{pointname}'},{name:'warningtype',title:'Warning Type',formatter:function(i,row){switch(row['boolwarning']){case alarmMode.LIMIT_VALUE:return alarmMode.LIMIT_VALUE_TITLE;case alarmMode.BOOL:return alarmMode.BOOL_TITLE;default:return'Unknow';}}},{name:'warninglevel',title:'Warning Level',formatter:'{boolwarninglevel}'},{name:'warningvalue',title:'Warning Value',formatter:function(i,row){var arrHtml=[];switch(row['boolwarning']){case alarmMode.LIMIT_VALUE:arrHtml.push('LL: '+(row['LLEnable']===1?row['LLLimit']:'disabled'));arrHtml.push('L: '+(row['LEnable']===1?row['LLimit']:'disabled'));arrHtml.push('H: '+(row['HEnable']===1?row['HLimit']:'disabled'));arrHtml.push('HH: '+(row['HHEnable']===1?row['HHLimit']:'disabled'));return arrHtml.join('<br/>');case alarmMode.BOOL:return'/';default:return'/';}}},{name:'warninginfo',title:'Warning Info',formatter:function(i,row){var arrHtml=[];switch(row['boolwarning']){case alarmMode.LIMIT_VALUE:arrHtml.push('LL: '+(row['LLEnable']===1?row['LLwarninginfo']:'disabled'));arrHtml.push('L: '+(row['LEnable']===1?row['Lwarninginfo']:'disabled'));arrHtml.push('H: '+(row['HEnable']===1?row['Hwarninginfo']:'disabled'));arrHtml.push('HH: '+(row['HHEnable']===1?row['HHwarninginfo']:'disabled'));return arrHtml.join('<br/>');case alarmMode.BOOL:return row['boolwarninginfo'];default:return'/';}}},{name:'operations',title:'Operations',formatter:function(i,row){var htmlTpl='\
                        <button class="btn btn-primary btn-rule-edit" type="button" title="edit this rule">\
                            <span class="glyphicon glyphicon-pencil"></span>\
                        </button>\
                        <button class="btn btn-primary btn-rule-del" type="button" title="delete this rule">\
                            <span class="glyphicon glyphicon-trash"></span>\
                        </button>';return htmlTpl;}}]});},initFormValidation:function(){this.validator=new Validator({elements:[{name:'pointName',selector:this.$iptPointName,rules:[{valid:'require',msg:'"Point Name" cannot be empty!'}]},{name:'alarmInfo',selector:this.$iptAlarmInfo,rules:[{valid:'require',msg:'"Alarm Info" cannot be empty!'}]},{name:'limitValueInfo',selector:'#divRuleValue :text:enabled',rules:[{valid:'require',msg:'This field cannot be empty!'}]},{name:'alarmLevel',selector:this.$iptAlarmLevel,rules:[{valid:'require',msg:'"Alarm Level" cannot be empty!'}]}]});},attachEvents:function(){this.$btnClose.click(function(e){ScreenManager.show(PaneProjectSelector);});this.$btnCog.click(function(e){_this.stopAutoload();_this.$panelLog.hide();_this.$panelCog.show();_this.$tbRule.table('loading');WebAPI.getJSON('/warning/getConfig/'+AppConfig.projectId,function(rs){_this.$tbRule.table('load',rs);});e.preventDefault();});this.$btnLogList.click(function(e){_this.$panelCog.hide();_this.$panelLog.show();_this.startAutoload();});this.$btnReload.click(function(){_this.reloadRecord();});this.$tbAlarm.on('click','.dropdown-menu>li',function(e){var $this=$(this);var rowIndex=parseInt($this.parents('tr').attr('data-rowindex'));var rowData=_this.$tbAlarm.table('getData')[rowIndex];var minutes=parseInt($this.attr('data-value'));var deadline=new Date(new Date().valueOf()+minutes*60*1000).format('yyyy-MM-dd HH:mm:ss');var msg='You have chosen "{0}", this alarm will not be shown until the time below:\n{1}\nAre you sure to do this?'.format($this.children('a').text(),deadline);_this.stopAutoload();if(confirm(msg)){_this.setDelayTime(rowData,deadline);_this.startAutoload();}else{_this.startAutoload(false);}
e.stopPropagation();});this.$btnRuleSrch.click(function(e){var key=_this.$iptRuleSrch.val().trim();_this.$cbSelectAll.prop('checked',false);if(!key){_this.$tbRule.table('filter');}else{_this.$tbRule.table('filter',{pointname:key});}
e.preventDefault();});this.$btnAddRule.click(function(){_this.$ruleModal.find('.modal-title').text('Add Rule');_this.$btnRuleSubmit.attr('data-action','add');_this.setModal();_this.$ruleModal.modal('show');});this.$btnDelRule.click(function(){var $chosen=$('.ui-tbl-col-cb>input:checked');var names=[];var data=_this.$tbRule.table('getData');var index=null;if($chosen.length===0){alert('You should choose one row at least!');return}
$chosen.each(function(i,item){index=parseInt($(item).attr('data-rowindex'));names.push(data[index]['pointname']);});_this.delRule('Are you sure to delete these rules?',names);});this.$btnSelectAll.click(function(e){_this.$cbSelectAll.trigger('click');e.preventDefault();});this.$cbSelectAll.click(function(e){var $ckbs=$('.ui-tbl-col-cb').children('input');if($(this).is(':checked')){util.checkbox.selectAll($ckbs);}else{util.checkbox.unSelectAll($ckbs);}
e.stopPropagation();});this.$lkSelectAll.click(function(e){var $ckbs=$('.ui-tbl-col-cb').children('input');util.checkbox.selectAll($ckbs);_this.$cbSelectAll.prop('checked',true);});this.$lkSelectInverse.click(function(e){var $ckbs=$('.ui-tbl-col-cb').children('input');util.checkbox.selectInverse($ckbs);_this.$cbSelectAll.prop('checked',util.checkbox.isAllChecked($ckbs));});this.$lkUnSelectAll.click(function(e){var $ckbs=$('.ui-tbl-col-cb').children('input');util.checkbox.unSelectAll($ckbs);_this.$cbSelectAll.prop('checked',false);});this.$tbRule.on('click','.ui-tbl-col-cb',function(){var $this=$(this);var $ckbs=$('.ui-tbl-col-cb').children('input');_this.$cbSelectAll.prop('checked',util.checkbox.isAllChecked($ckbs));});this.$cbLL.click(function(){_this.$iptLL.add(_this.$iptLLInfo).prop('disabled',!$(this).is(':checked'));util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));});this.$cbL.click(function(){_this.$iptL.add(_this.$iptLInfo).prop('disabled',!$(this).is(':checked'));util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));});this.$cbH.click(function(){_this.$iptH.add(_this.$iptHInfo).prop('disabled',!$(this).is(':checked'));util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));});this.$cbHH.click(function(){_this.$iptHH.add(_this.$iptHHInfo).prop('disabled',!$(this).is(':checked'));util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));});this.$tbRule.on('click','.btn-rule-edit',function(){var $this=$(this);var index=$this.parents('tr').attr('data-rowindex');var rowData=_this.$tbRule.table('getData')[index];_this.$btnRuleSubmit.attr('data-action','edit');_this.$ruleModal.find('.modal-title').text('Edit Rule');_this.setModal(rowData);_this.$ruleModal.modal('show');});this.$tbRule.on('click','.btn-rule-del',function(){var $this=$(this);var index=$this.parents('tr').attr('data-rowindex');var pointName=_this.$tbRule.table('getData')[index]['pointname'];_this.delRule('Are you sure to delete this rule?',[pointName]);});this.$lkAlarmModeItems.click(function(e){var $this=$(this);var value=parseInt($this.attr('data-value'));var title=$this.text();_this.$spAlarmModeTitle.attr('data-value',value).text(title);switch(value){case alarmMode.LIMIT_VALUE:_this.$divAlarmInfo.hide();_this.$divRuleEnable.show();_this.$divRuleValue.show();break;case alarmMode.BOOL:default:_this.$divAlarmInfo.show();_this.$divRuleEnable.hide();_this.$divRuleValue.hide();break;}});this.$btnRuleSubmit.click(function(){var p={},valid;var url=$(this).attr('data-action')==='add'?'/warning/addWarningConfig/':'/warning/modifyWarningConfig/';p.pointname=_this.$iptPointName.val();p.unitproperty01=0;p.warninglevel=_this.$iptAlarmLevel.val();p.warningtype=parseInt(_this.$spAlarmModeTitle.attr('data-value'));if(p.warningtype!==alarmMode.LIMIT_VALUE){p.HHEnable=0;p.HEnable=0;p.LEnable=0;p.LLEnable=0;p.HHLimit=0;p.HLimit=0;p.LLimit=0;p.LLLimit=0;p.HHwarninginfo='';p.Hwarninginfo='';p.Lwarninginfo='';p.LLwarninginfo='';p.boolwarninginfo=_this.$iptAlarmInfo.val();valid=_this.validator.not('limitValueInfo').valid();}else{p.HHEnable=_this.$cbHH.is(':checked')?1:0;p.HEnable=_this.$cbH.is(':checked')?1:0;p.LEnable=_this.$cbL.is(':checked')?1:0;p.LLEnable=_this.$cbLL.is(':checked')?1:0;p.HHLimit=p.HHEnable===1?parseInt(_this.$iptHH.val()):0;p.HLimit=p.HEnable===1?parseInt(_this.$iptH.val()):0;p.LLimit=p.LEnable===1?parseInt(_this.$iptL.val()):0;p.LLLimit=p.LLEnable===1?parseInt(_this.$iptLL.val()):0;p.HHwarninginfo=p.HHEnable===1?_this.$iptHHInfo.val():'';p.Hwarninginfo=p.HEnable===1?_this.$iptHInfo.val():'';p.Lwarninginfo=p.LEnable===1?_this.$iptLInfo.val():'';p.LLwarninginfo=p.LLEnable===1?_this.$iptLLInfo.val():'';p.boolwarninginfo='';valid=_this.validator.not('alarmInfo').valid();}
valid.done(function(){console.log(arguments);Spinner.spin(_this.$ruleModal[0]);$.post(url+AppConfig.projectId,p).done(function(rs){rs=JSON.parse(rs);if(rs.status!==0){alert('Sorry, operation faild, we will fix this as soon as possible.');return;}
_this.$tbRule.table('loading');WebAPI.getJSON('/warning/getConfig/'+AppConfig.projectId,function(rs){_this.$tbRule.table('load',rs);});}).always(function(){_this.$ruleModal.modal('hide');Spinner.stop();});});});$(window).resize(this.resize);},setDelayTime:function(row,delayTime){var rules=JSON.parse(localStorage.getItem(ALARM_RULE_NAME))||{};var key=window.encodeURIComponent(row['bindpointname']+'_'+row['time']);var projectId=AppConfig.projectId;var datetimeNow=new Date().format('yyyy-MM-dd HH:mm:ss');rules[projectId]=rules[projectId]||{};for(var i in rules[projectId]){if(rules[projectId].hasOwnProperty(i)){if(rules[projectId][i]<=datetimeNow)delete rules[projectId][i];}}
rules[AppConfig.projectId][key]=delayTime;localStorage.setItem(ALARM_RULE_NAME,JSON.stringify(rules));},filterByDelayRule:function(data){var result=[];var rules=JSON.parse(localStorage.getItem(ALARM_RULE_NAME));var row=deadline=key=null;if(!rules||!(rules=rules[AppConfig.projectId]))return data;for(var i=0,len=data.length;i<len;i++){row=data[i];key=window.encodeURIComponent(row['bindpointname']+'_'+row['time']);if(!(deadline=rules[key])){result.push(row);continue;}
if(data[i]['endtime']>=deadline){result.push(row);}}
return result;},setModal:function(data){this.validator.resetStatus();this.$iptPointName.val('');this.$iptAlarmLevel.val('');this.$iptAlarmInfo.val('');this.$iptLL.val('').prop('disabled',false);this.$iptL.val('').prop('disabled',true);this.$iptH.val('').prop('disabled',true);this.$iptHH.val('').prop('disabled',true);this.$cbLL.prop('checked',true);this.$cbL.prop('checked',false);this.$cbH.prop('checked',false);this.$cbHH.prop('checked',false);util.checkbox.keepOneCheckbox(this.$divRuleEnable.find(':checkbox'));this.$iptLLInfo.val('').prop('disabled',false);this.$iptLInfo.val('').prop('disabled',true);this.$iptHInfo.val('').prop('disabled',true);this.$iptHHInfo.val('').prop('disabled',true);if(!data){this.$iptPointName.prop('disabled',false);this.$btnAlarmMode.prop('disabled',false);this.$lkAlarmModeItems.eq(0).trigger('click');}else{this.$iptPointName.val(data['pointname']).prop('disabled',true);this.$btnAlarmMode.prop('disabled',true);this.$iptAlarmLevel.val(data['boolwarninglevel']);switch(data['boolwarning']){case alarmMode.LIMIT_VALUE:this.$lkAlarmModeItems.eq(1).trigger('click');this.$iptLL.val(data['LLLimit']).prop('disabled',data['LLEnable']===0?true:false);this.$iptL.val(data['LLimit']).prop('disabled',data['LEnable']===0?true:false);this.$iptH.val(data['HLimit']).prop('disabled',data['HEnable']===0?true:false);this.$iptHH.val(data['HHLimit']).prop('disabled',data['HHEnable']===0?true:false);this.$cbLL.prop('checked',data['LLEnable']===0?false:true);this.$cbL.prop('checked',data['LEnable']===0?false:true);this.$cbH.prop('checked',data['HEnable']===0?false:true);this.$cbHH.prop('checked',data['HHEnable']===0?false:true);util.checkbox.keepOneCheckbox(_this.$divRuleEnable.find(':checkbox'));this.$iptLLInfo.val(data['LLwarninginfo']).prop('disabled',data['LLEnable']===0?true:false);this.$iptLInfo.val(data['Lwarninginfo']).prop('disabled',data['LEnable']===0?true:false);this.$iptHInfo.val(data['Hwarninginfo']).prop('disabled',data['HEnable']===0?true:false);this.$iptHHInfo.val(data['HHwarninginfo']).prop('disabled',data['HHEnable']===0?true:false);break;case alarmMode.BOOL:this.$iptAlarmInfo.val(data['boolwarninginfo']);this.$lkAlarmModeItems.eq(0).trigger('click');break;default:return'Unknow';}}},reloadRecord:function(data){var startTime,endTime;if(!data){if(_this.$spLoading.hasClass('loading'))return;window.BackgroundWorkers.alarmReporter.postMessage({type:'dataAlarmRealtime',projectId:AppConfig.projectId});}
else{_this.$tbAlarm.table('load',_this.filterByDelayRule(data));_this.$spLoading.removeClass('loading');}},delRule:function(msg,names){msg=msg||'Are you sure to do this operation?';if(confirm(msg)){Spinner.spin(_this.$alarmLoggingPane[0]);$.post('/warning/deleteWarningConfig/'+AppConfig.projectId,{pointNames:names.join('\',\'')}).done(function(rs){rs=JSON.parse(rs);if(rs.status!==0){alert('Sorry, operation faild, we will fix this as soom as possible.');return;}
_this.$tbRule.table('loading');WebAPI.getJSON('/warning/getConfig/'+AppConfig.projectId,function(rs){_this.$tbRule.table('load',rs);});}).always(function(){Spinner.stop();});}},resize:function(){var totalHeight=$(window).height();var height=totalHeight-278;if(height<100)return;_this.$tbAlarm.table('setStretchHeight',height);_this.$tbRule.table('setStretchHeight',height);},close:function(){this.stopAutoload();}}
return AlarmLogging;})();﻿var DataSourceConfigure=(function(){function DataSourceConfigure(_parent,_showType,_bIsAdd,_customName,_ptName,_ptDesc,_prjId){this.parent=_parent;this.container=undefined;this.m_showType=_showType;this.m_bIsAdd=_bIsAdd;this.m_customName=_customName;this.m_pointName=_ptName;this.m_pointDesc=_ptDesc;this.m_projectId=_prjId;}
DataSourceConfigure.prototype={show:function(){var _this=this;_this.container=document.createElement('div');_this.container.className='panel panel-default';_this.container.id='addPointPanelContain';_this.container.style.height='100%';_this.container.style.width='99%';_this.container.style.position='absolute';_this.container.style.zIndex='2';document.getElementById('dialogContent').style.height='50%';WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(resultHtml){if(_this.parent.m_parent!=undefined){_this.parent.m_parent.hideAnlsPane();}
_this.container.innerHTML=resultHtml;document.getElementById('paneContent').appendChild(_this.container);I18n.fillArea($('#addPointPanelContain'));$('#dataSrcPtSearch').attr('placeholder',I18n.resource.dataSource.PROJECT_SEARCH);if(0===_this.m_showType){$('#divDataSourceFormula').css('display','none');$('#formulaHeading').css('display','none');$('#formulaFooter').css('display','none');$('#divDataSourceAddPage').css('display','');$('#originalHeading').css('display','');$('#originalFooter').css('display','');new DataSourceOriginal(_this.parent,_this).show();}
else if(1===_this.m_showType){$('#divDataSourceAddPage').css('display','none');$('#originalHeading').css('display','none');$('#originalFooter').css('display','none');$('#divDataSourceFormula').css('display','');$('#formulaHeading').css('display','');$('#formulaFooter').css('display','');new DataSourceFormula(_this.parent,_this).show();}
else if(2===_this.m_showType){new DataSourceOriginal(_this.parent,_this).show();new DataSourceFormula(_this.parent,_this).show();}});},close:function(){$(this.container).remove();}};return DataSourceConfigure;})();var DataSourceOriginal=(function(){function DataSourceOriginal(_parent,_dsCfg){this.parent=_parent;this.m_strPrjName='';this.m_pointList='';this.m_dsCfg=_dsCfg;this.m_parseFmt={'search':'','arrCustom':[],'arrSystem':[],'arrDevice':[],'arrType':[]};this.m_lang=I18n.resource.dataSource;this.m_iconColor=new Array('#ff7f50','#87cefa','#da70d6','#32cd32','#6495ed','#ff69b4','#ba55d3','#cd5c5c','#ffa500','#40e0d0','#1e90ff','#ff6347','#7b68ee','#00fa9a','#ffd700','#6b8e23','#ff00ff','#3cb371','#b8860b','#30e0e0');}
DataSourceOriginal.prototype={show:function(){var _this=this;_this.initElement();},initElement:function(){var _this=this;if(_this.m_dsCfg.m_bIsAdd){$('#dsConfig').css('display','none');$('#dsPtName').css('display','none');}
else{$('#divPointsBody').css('height','calc(100% - 194px)');$('#inputCustomName').attr('placeholder',_this.m_lang.CUSTOM_NAME);$('#inputPointDesc').attr('placeholder',_this.m_lang.POINT_DESC);$('#inputCustomName').val(_this.m_dsCfg.m_customName);$('#inputPointName').val(_this.m_dsCfg.m_pointName);$('#inputPointDesc').val(_this.m_dsCfg.m_pointDesc);}
var iconTitSys=$('#dataSrcSys li');iconTitSys.eq(1).attr('title',_this.m_lang.ICON_SYS_HVAC);iconTitSys.eq(2).attr('title',_this.m_lang.ICON_SYS_POWER);iconTitSys.eq(3).attr('title',_this.m_lang.ICON_SYS_LIGHT);iconTitSys.eq(4).attr('title',_this.m_lang.ICON_SYS_CRAC);var iconTitDev=$('#dataSrcEquip li');iconTitDev.eq(1).attr('title',_this.m_lang.ICON_DEV_CHIL);iconTitDev.eq(2).attr('title',_this.m_lang.ICON_DEV_PUMP);iconTitDev.eq(3).attr('title',_this.m_lang.ICON_DEV_COOL);iconTitDev.eq(4).attr('title',_this.m_lang.ICON_DEV_AHU);iconTitDev.eq(5).attr('title',_this.m_lang.ICON_DEV_VAV);iconTitDev.eq(6).attr('title',_this.m_lang.ICON_DEV_SYS);var iconTitType=$('#dataSrcType li');iconTitType.eq(1).attr('title',_this.m_lang.ICON_TYPE_ELEPOWMET);iconTitType.eq(2).attr('title',_this.m_lang.ICON_TYPE_THER);iconTitType.eq(3).attr('title',_this.m_lang.ICON_TYPE_TEMP);iconTitType.eq(4).attr('title',_this.m_lang.ICON_TYPE_FLOW);iconTitType.eq(5).attr('title',_this.m_lang.ICON_TYPE_PRES);iconTitType.eq(6).attr('title',_this.m_lang.ICON_TYPE_CURFLOW);iconTitType.eq(7).attr('title',_this.m_lang.ICON_TYPE_ELEPOW);iconTitType.eq(8).attr('title',_this.m_lang.ICON_TYPE_FREQ);iconTitType.eq(9).attr('title',_this.m_lang.ICON_TYPE_ONOFF);iconTitType.eq(10).attr('title',_this.m_lang.ICON_TYPE_ALARM);var selectPrj=$('#dataSrcPrjName');var prjId=0;var opt;var nSize=AppConfig.projectList.length;var nColorSize=_this.m_iconColor.length;if(!_this.m_dsCfg.m_bIsAdd&&_this.m_dsCfg.m_projectId!=-1){prjId=_this.m_dsCfg.m_projectId;}
else{prjId=Number(AppConfig.projectId);}
selectPrj.empty();for(var i=0;i<nSize;i++){var project=AppConfig.projectList[i];opt=document.createElement('option');if('en'==localStorage['language']){opt.textContent=project.name_english;}
else{opt.textContent=project.name_cn;}
opt.value=project.id;opt.setAttribute('iconColor',_this.m_iconColor[i-parseInt(i/nColorSize)*nColorSize]);selectPrj.append(opt);}
selectPrj.val(prjId);_this.initNavControls();selectPrj.change(function(e){var prjId=$('#dataSrcPrjName').find('option:selected').val();if(typeof(prjId)=="undefined"||''==prjId){$('#dataSrcPtSearch').attr('disabled','');return;}
$('#dataSrcPtSearch').removeAttr('disabled');_this.clearSearch();var ulCust=$('#dataSrcCustom .pagination');ulCust.empty();ulCust.append('<li><span class="filterCustom filterCustomSelected" id="filterCustomAll" i18n="dataSource.POINT_TYPE_CUSTOM"  style="width: 55px;">All</span></li>');var selectPt=$('#divPointsBody tbody');selectPt.html('');var s3dbData;Spinner.spin($('#divDataSourceAddPage')[0]);WebAPI.get('/analysis/get_pointList_from_s3db/'+prjId).done(function(result){_this.m_pointList={'pointList':result.pointList,'customName':result.customName};_this.initNavCustomControls();_this.showPointListAll();}).error(function(e){document.getElementById('dialogContent').style.height='50%';}).always(function(e){Spinner.stop();});});$('#btnAddDataSrc').click(function(e){if(_this.selectPoint()){_this.parent.m_parent.showAnlsPane();$(_this.m_dsCfg.container).remove();}});$('#btnCancelDataSrc').click(function(e){_this.parent.m_parent.showAnlsPane();$(_this.m_dsCfg.container).remove();});$('#dataSrcPtSearch').keyup(function(e){if(13==e.keyCode){_this.m_parseFmt.search=$('#dataSrcPtSearch').val();var show=_this.parsePointListByFmt(_this.m_parseFmt);_this.showFmtIntoList(show);}});$('#btnSearch').click(function(e){_this.m_parseFmt.search=$('#dataSrcPtSearch').val();var show=_this.parsePointListByFmt(_this.m_parseFmt);_this.showFmtIntoList(show);});$('#divPointsHead li').click(function(e){_this.clearSearch();var target=$(e.currentTarget);var showChar=target.find('a').text();if('All'==showChar){_this.showPointListAll();}
else{_this.clearNavSelect();target.attr('class','active');var upChar=showChar.toUpperCase();var lowChar=showChar.toLowerCase();_this.parsePointListByAlphabet(upChar,lowChar);}});var iconSys=$('#dataSrcSys .filterIcon');iconSys.click(function(e){var target=$(e.currentTarget);var id=target.attr('id');if('filterSystemAll'==id){_this.m_parseFmt.arrSystem=[];iconSys.removeClass('filterIconSysSelected');target.addClass('filterIconSysSelected');}
else{if('filterSystem1'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrSystem.push(1);target.addClass('filterIconSysSelected');}
else{_this.delInArray(_this.m_parseFmt.arrSystem,1);target.removeClass('filterIconSysSelected');}}
else if('filterSystem2'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrSystem.push(2);target.addClass('filterIconSysSelected');}
else{_this.delInArray(_this.m_parseFmt.arrSystem,2);target.removeClass('filterIconSysSelected');}}
else if('filterSystem3'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrSystem.push(3);target.addClass('filterIconSysSelected');}
else{_this.delInArray(_this.m_parseFmt.arrSystem,3);target.removeClass('filterIconSysSelected');}}
else if('filterSystem4'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrSystem.push(4);target.addClass('filterIconSysSelected');}
else{_this.delInArray(_this.m_parseFmt.arrSystem,4);target.removeClass('filterIconSysSelected');}}
if(_this.m_parseFmt.arrSystem.length>0){$('#filterSystemAll').removeClass('filterIconSysSelected');}
else{$('#filterSystemAll').addClass('filterIconSysSelected');}}
_this.m_parseFmt.search=$('#dataSrcPtSearch').val();var show=_this.parsePointListByFmt(_this.m_parseFmt);_this.showFmtIntoList(show);});var iconDev=$('#dataSrcEquip .filterIcon');iconDev.click(function(e){var target=$(e.currentTarget);var id=target.attr('id');if('filterDeviceAll'==id){_this.m_parseFmt.arrDevice=[];iconDev.removeClass('filterIconDevSelected');target.addClass('filterIconDevSelected');}
else{if('filterDevice1'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(1);target.addClass('filterIconDevSelected');}
else{_this.delInArray(_this.m_parseFmt.arrDevice,1);target.removeClass('filterIconDevSelected');}}
else if('filterDevice2'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(2);target.addClass('filterIconDevSelected');}
else{_this.delInArray(_this.m_parseFmt.arrDevice,2);target.removeClass('filterIconDevSelected');}}
else if('filterDevice3'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(3);target.addClass('filterIconDevSelected');}
else{_this.delInArray(_this.m_parseFmt.arrDevice,3);target.removeClass('filterIconDevSelected');}}
else if('filterDevice4'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(4);target.addClass('filterIconDevSelected');}
else{_this.delInArray(_this.m_parseFmt.arrDevice,4);target.removeClass('filterIconDevSelected');}}
else if('filterDevice5'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(5);target.addClass('filterIconDevSelected');}
else{_this.delInArray(_this.m_parseFmt.arrDevice,5);target.removeClass('filterIconDevSelected');}}
else if('filterDevice6'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrDevice.push(6);target.addClass('filterIconDevSelected');}
else{_this.delInArray(_this.m_parseFmt.arrDevice,6);target.removeClass('filterIconDevSelected');}}
if(_this.m_parseFmt.arrDevice.length>0){$('#filterDeviceAll').removeClass('filterIconDevSelected');}
else{$('#filterDeviceAll').addClass('filterIconDevSelected');}}
_this.m_parseFmt.search=$('#dataSrcPtSearch').val();var show=_this.parsePointListByFmt(_this.m_parseFmt);_this.showFmtIntoList(show);});var iconType=$('#dataSrcType .filterIcon');iconType.click(function(e){var target=$(e.currentTarget);var id=target.attr('id');if('filterTypeAll'==id){_this.m_parseFmt.arrType=[];iconType.removeClass('filterIconTypeSelected');target.addClass('filterIconTypeSelected');}
else{if('filterType1'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(1);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,1);target.removeClass('filterIconTypeSelected');}}
else if('filterType2'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(2);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,2);target.removeClass('filterIconTypeSelected');}}
else if('filterType3'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(3);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,3);target.removeClass('filterIconTypeSelected');}}
else if('filterType4'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(4);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,4);target.removeClass('filterIconTypeSelected');}}
else if('filterType5'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(5);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,5);target.removeClass('filterIconTypeSelected');}}
else if('filterType6'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(6);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,6);target.removeClass('filterIconTypeSelected');}}
else if('filterType7'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(7);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,7);target.removeClass('filterIconTypeSelected');}}
else if('filterType8'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(8);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,8);target.removeClass('filterIconTypeSelected');}}
else if('filterType9'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(9);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,9);target.removeClass('filterIconTypeSelected');}}
else if('filterType10'==id){if('filterIcon'==target.eq(0).attr('class')){_this.m_parseFmt.arrType.push(10);target.addClass('filterIconTypeSelected');}
else{_this.delInArray(_this.m_parseFmt.arrType,10);target.removeClass('filterIconTypeSelected');}}
if(_this.m_parseFmt.arrType.length>0){$('#filterTypeAll').removeClass('filterIconTypeSelected');}
else{$('#filterTypeAll').addClass('filterIconTypeSelected');}}
_this.m_parseFmt.search=$('#dataSrcPtSearch').val();var show=_this.parsePointListByFmt(_this.m_parseFmt);_this.showFmtIntoList(show);});selectPrj.change();},selectPointName:function(clickTarget){if(this.m_dsCfg.m_bIsAdd){var target=$(clickTarget);var flag=target.attr('class');if('info'==flag){target.attr('class','');}
else{target.attr('class','info');}}
else{$('#tableWatch tbody tr').attr('class','');var target=$(clickTarget);target.attr('class','info');$('#inputPointName').val(target.find('td').eq(1).text());}},showPointListAll:function(){var _this=this;if(null==_this.m_pointList.pointList){return;}
var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td,item,div;var nSize=_this.m_pointList.pointList.length;for(var i=0;i<nSize;i++){item=_this.m_pointList.pointList[i];tr=document.createElement('tr');tr.className='';tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target);};td=document.createElement('td');td.textContent=i;tr.appendChild(td);td=document.createElement('td');td.textContent=item.name;td.title=item.name;$(td).css('max-width','250px');$(td).css('overflow-x','hidden');$(td).css('text-overflow','ellipsis');tr.appendChild(td);td=document.createElement('td');td.textContent=item.description;td.title=item.description;$(td).css('max-width','250px');$(td).css('overflow-x','hidden');$(td).css('text-overflow','ellipsis');tr.appendChild(td);if(item.system!=undefined&&item.device!=undefined&&item.type!=undefined){td=document.createElement('td');$(td).css('min-width','90px');if(''!=item.custom){div=document.createElement('div');div.textContent=item.custom;$(div).css('float','left');$(div).css('display','inline');$(div).css('color','#fff');$(div).css('border-radius','8px');$(div).css('padding','0 5px 0 5px');$(div).css('background-color','#428bca');td.appendChild(div);}
if(0!=item.system){div=document.createElement('div');div.className='iconComm';if(1==item.system){div.id='iconSys1';}
else if(2==item.system){div.id='iconSys2';}
else if(3==item.system){div.id='iconSys3';}
else if(4==item.system){div.id='iconSys4';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
if(0!=item.device){div=document.createElement('div');div.className='iconComm';if(1==item.device){div.id='iconDev1';}
else if(2==item.device){div.id='iconDev2';}
else if(3==item.device){div.id='iconDev3';}
else if(4==item.device){div.id='iconDev4';}
else if(5==item.device){div.id='iconDev5';}
else if(6==item.device){div.id='iconDev6';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
if(0!=item.type){div=document.createElement('div');div.className='iconComm';if(1==item.type){div.id='iconType1';}
else if(2==item.type){div.id='iconType2';}
else if(3==item.type){div.id='iconType3';}
else if(4==item.type){div.id='iconType4';}
else if(5==item.type){div.id='iconType5';}
else if(6==item.type){div.id='iconType6';}
else if(7==item.type){div.id='iconType7';}
else if(8==item.type){div.id='iconType8';}
else if(9==item.type){div.id='iconType9';}
else if(10==item.type){div.id='iconType10';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
tr.appendChild(td);}
selectPt.append(tr);}},parsePointListByAlphabet:function(upCharName,lowCharName){var _this=this;if(null==_this.m_pointList.pointList){return;}
var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td;var nSize=_this.m_pointList.pointList.length;for(var i=0;i<nSize;i++){var firstChar=(_this.m_pointList.pointList[i].name)[0];if(upCharName!=firstChar&&lowCharName!=firstChar){continue;}
tr=document.createElement('tr');tr.className='';tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target);};td=document.createElement('td');td.textContent=i;tr.appendChild(td);td=document.createElement('td');td.textContent=_this.m_pointList.pointList[i].name;tr.appendChild(td);td=document.createElement('td');td.textContent=_this.m_pointList.pointList[i].description;tr.appendChild(td);selectPt.append(tr);}},parsePointListByInput:function(){var _this=this;if(null==_this.m_pointList.pointList){var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td;tr=document.createElement('tr');tr.style.height='100px';td=document.createElement('td');td.colSpan=3;td.style.lineHeight='100%';td.style.verticalAlign='middle';td.style.fontSize='20px';td.style.fontWeight='bold';td.style.color='darkred';td.textContent=_this.m_lang.NO_MATCH_FOUND;tr.appendChild(td);selectPt.append(tr);return;}
var strSearchVal;strSearchVal=$('#dataSrcPtSearch').val();if(null==strSearchVal){return;}
if(''==strSearchVal){_this.showPointListAll();}
strSearchVal=strSearchVal.toLowerCase();var arrSearchVal=strSearchVal.split(' ');var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td;var nSize=_this.m_pointList.pointList.length;var strGetName,strGetDesc,nIdxName,nIdxDesc,nIdxNameFlag,nIdxDescFlag;for(var i=0;i<nSize;i++){nIdxNameFlag=true;nIdxDescFlag=true;for(var j=0;j<arrSearchVal.length;++j){if(arrSearchVal[j]=='')continue;strGetName=_this.m_pointList.pointList[i].name;strGetName=strGetName.toLowerCase();strGetName.indexOf(arrSearchVal[j],0);nIdxName=strGetName.indexOf(arrSearchVal[j],0);strGetDesc=_this.m_pointList.pointList[i].description;strGetDesc=strGetDesc.toLowerCase();strGetDesc.indexOf(arrSearchVal[j],0);nIdxDesc=strGetDesc.indexOf(arrSearchVal[j],0);if(-1==nIdxName){nIdxNameFlag=false;}
if(-1==nIdxDesc){nIdxDescFlag=false;}
if(!nIdxNameFlag&&!nIdxDescFlag){break;}}
if(!nIdxNameFlag&&!nIdxDescFlag){continue;}
tr=document.createElement('tr');tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target);};td=document.createElement('td');td.textContent=i;tr.appendChild(td);td=document.createElement('td');td.textContent=_this.m_pointList.pointList[i].name;tr.appendChild(td);td=document.createElement('td');td.textContent=_this.m_pointList.pointList[i].description;tr.appendChild(td);selectPt.append(tr);}
if(''===selectPt.html()){tr=document.createElement('tr');tr.style.height='100px';td=document.createElement('td');td.colSpan=3;td.style.lineHeight='100%';td.style.verticalAlign='middle';td.style.fontSize='20px';td.style.fontWeight='bold';td.style.color='darkred';td.textContent=_this.m_lang.NO_MATCH_FOUND;tr.appendChild(td);selectPt.append(tr);}},clearNavSelect:function(){$('#divPointsHead').find('li').each(function(){$(this).attr('class','');});},initNavControls:function(){$('#filterSystemAll').addClass('filterIconSysSelected');$('#filterDeviceAll').addClass('filterIconDevSelected');$('#filterTypeAll').addClass('filterIconTypeSelected');},initNavCustomControls:function(){var _this=this;var ulCust=$('#dataSrcCustom .pagination');for(var i=0,len=_this.m_pointList.customName.length;i<len;i++){var item=_this.m_pointList.customName[i];if(''==item){continue;}
var li=$('<li><span class="filterCustom">'+item+'</span></li>');ulCust.append(li);}
var iconCust=$('#dataSrcCustom .filterCustom');iconCust.click(function(e){var target=$(e.currentTarget);var showChar=target.text();if('All'==showChar){_this.m_parseFmt.arrCustom=[];iconCust.removeClass('filterCustomSelected');target.addClass('filterCustomSelected');}
else{if('filterCustom'==target.eq(0).attr('class')){_this.m_parseFmt.arrCustom.push(showChar);target.addClass('filterCustomSelected');}
else{_this.delInArray(_this.m_parseFmt.arrCustom,showChar);target.removeClass('filterCustomSelected');}
if(_this.m_parseFmt.arrCustom.length>0){$('#filterCustomAll').removeClass('filterCustomSelected');}
else{$('#filterCustomAll').addClass('filterCustomSelected');}}
_this.m_parseFmt.search=$('#dataSrcPtSearch').val();var show=_this.parsePointListByFmt(_this.m_parseFmt);_this.showFmtIntoList(show);});},selectPoint:function(){var _this=this;var ctlSelectPrj=$('#dataSrcPrjName');_this.m_strPrjName=ctlSelectPrj.find('option:selected').text();if(''==_this.m_strPrjName){alert(I18n.resource.observer.widgets.PLEASE_SELECT_PROJECT+'！');return false;}
var newPointList=[];var row;var strUserId=AppConfig.userId;var strUserName=AppConfig.account;var strCustName='';var prjId=Number(ctlSelectPrj.find('option:selected').attr('value'));var langFlag=('zh'==localStorage['language'])?0:1;var prjName=_this.parent.getProjectNameFromId(prjId,langFlag);var iconColor=ctlSelectPrj.find('option:selected').attr('iconColor');var strPtName='';var strPtDesc='';var groupId=_this.parent.m_selectGroupId;if(_this.m_dsCfg.m_bIsAdd){$('#tableWatch tbody tr').each(function(){if('info'==this.className){strPtName=$(this).find('td:eq(1)').text();strPtDesc=$(this).find('td:eq(2)').text();row={'userId':strUserId,'userName':strUserName,'customName':strPtName,'prjId':prjId,'prjName':prjName,'ptName':strPtName,'ptDesc':strPtDesc,'iconColor':iconColor,'itemType':0,'groupId':groupId,'groupName':''};newPointList.push(row);}});}
else{$('#tableWatch tbody tr').each(function(){if('info'==this.className){strPtName=$(this).find('td:eq(1)').text();strPtDesc=$(this).find('td:eq(2)').text();row={'itemId':_this.parent.m_selectItemId,'userId':strUserId,'userName':strUserName,'customName':strPtName,'prjId':prjId,'prjName':prjName,'ptName':strPtName,'ptDesc':strPtDesc,'iconColor':iconColor,'itemType':0,'groupId':groupId,'groupName':''};newPointList.push(row);return false;}});if(newPointList.length<1){return true;}
_this.parent.m_newPointList=newPointList;_this.parent.modifyTable();return true;}
if(newPointList.length<=0){alert(_this.m_lang.NO_SELECT_POINT);return;}
_this.parent.m_newPointList=newPointList;_this.parent.renderTabel();return true;},clearSearch:function(){$('#dataSrcPtSearch').val('');},parsePointListByFmt:function(src){var _this=this;var item;var parseList=[];for(var i=0,len=_this.m_pointList.pointList.length;i<len;i++){item=_this.m_pointList.pointList[i];if((_this.findInArray(src.arrCustom,item.custom)||0==src.arrCustom.length)&&(_this.findInArray(src.arrSystem,item.system)||0==src.arrSystem.length)&&(_this.findInArray(src.arrDevice,item.device)||0==src.arrDevice.length)&&(_this.findInArray(src.arrType,item.type)||0==src.arrType.length)){var search=src.search.toLowerCase();var ptName=item.name.toLowerCase();var nIdxName=ptName.indexOf(search);var bFindName=true;if(-1==nIdxName){bFindName=false;}
var ptDesc=item.description.toLowerCase();var nIdxDesc=ptDesc.indexOf(search);var bFindDesc=true;if(-1==nIdxDesc){bFindDesc=false;}
if(bFindName||bFindDesc){parseList.push(item);}}}
return parseList;},findInArray:function(array,findVal){if(0==findVal){return false;}
var bFind=false;for(var i=0,len=array.length;i<len;i++){if(findVal==array[i]){bFind=true;break;}}
return bFind;},delInArray:function(array,delVal){for(var i=0,len=array.length;i<len;i++){if(delVal==array[i]){array.splice(i,1);break;}}},showFmtIntoList:function(showList){var _this=this;if(null==showList){return;}
var selectPt=$('#divPointsBody tbody');selectPt.html('');var tr,td,item,div;var nSize=showList.length;for(var i=0;i<nSize;i++){item=showList[i];tr=document.createElement('tr');tr.className='';tr.onclick=function(e){var target=e.currentTarget;_this.selectPointName(target);};td=document.createElement('td');td.textContent=i;tr.appendChild(td);td=document.createElement('td');td.textContent=item.name;td.title=item.name;$(td).css('max-width','350px');$(td).css('overflow-x','hidden');$(td).css('text-overflow','ellipsis');tr.appendChild(td);td=document.createElement('td');td.textContent=item.description;td.title=item.name;$(td).css('max-width','350px');$(td).css('overflow-x','hidden');$(td).css('text-overflow','ellipsis');tr.appendChild(td);if(item.system!=undefined&&item.device!=undefined&&item.type!=undefined){td=document.createElement('td');$(td).css('min-width','90px');if(''!=item.custom){div=document.createElement('div');div.textContent=item.custom;$(div).css('float','left');$(div).css('display','inline');$(div).css('color','#fff');$(div).css('border-radius','8px');$(div).css('padding','0 5px 0 5px');$(div).css('background-color','#428bca');td.appendChild(div);}
if(0!=item.system){div=document.createElement('div');div.className='iconComm';if(1==item.system){div.id='iconSys1';}
else if(2==item.system){div.id='iconSys2';}
else if(3==item.system){div.id='iconSys3';}
else if(4==item.system){div.id='iconSys4';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
if(0!=item.device){div=document.createElement('div');div.className='iconComm';if(1==item.device){div.id='iconDev1';}
else if(2==item.device){div.id='iconDev2';}
else if(3==item.device){div.id='iconDev3';}
else if(4==item.device){div.id='iconDev4';}
else if(5==item.device){div.id='iconDev5';}
else if(6==item.device){div.id='iconDev6';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
if(0!=item.type){div=document.createElement('div');div.className='iconComm';if(1==item.type){div.id='iconType1';}
else if(2==item.type){div.id='iconType2';}
else if(3==item.type){div.id='iconType3';}
else if(4==item.type){div.id='iconType4';}
else if(5==item.type){div.id='iconType5';}
else if(6==item.type){div.id='iconType6';}
else if(7==item.type){div.id='iconType7';}
else if(8==item.type){div.id='iconType8';}
else if(9==item.type){div.id='iconType9';}
else if(10==item.type){div.id='iconType10';}
$(div).css('float','left');$(div).css('display','inline');$(div).css('margin-left','3px');$(div).css('border-radius','6px');td.appendChild(div);}
tr.appendChild(td);}
selectPt.append(tr);}}}
return DataSourceOriginal;})();var DataSourceFormula=(function(){function DataSourceFormula(_parent,_dsCfg){this.m_parent=_parent;this.m_dsCfg=_dsCfg;this.m_lang=I18n.resource.dataSource;}
DataSourceFormula.prototype={show:function(){this.init();},init:function(){var _this=this;$('#inputCustName').attr('placeholder',_this.m_lang.CUSTOM_NAME);$('#inputFormulaDesc').attr('placeholder',_this.m_lang.POINT_DESC);$('.mathquill-editable:not(.mathquill-rendered-math)').mathquill('editable');if(!_this.m_dsCfg.m_bIsAdd){$('#inputCustName').val(_this.m_dsCfg.m_customName);$('#inputFormulaDesc').val(_this.m_dsCfg.m_pointDesc);var strFormula=_this.m_dsCfg.m_pointName;var idSearchReg=/<%\w*%>/g;var arrPtName=strFormula.match(idSearchReg);var arrValName=[],arrValId=[];var valIdExistFlag;var valNameIndex=0;for(var i=0;i<arrPtName.length;++i){valIdExistFlag=false;for(var j=0;j<arrValId.length;++j){if(arrPtName[i].slice(2,arrPtName[i].length-2)==arrValId[j]){valIdExistFlag=true;break;}}
if(!valIdExistFlag){arrValId.push(arrPtName[i].slice(2,arrPtName[i].length-2));arrValName.push(String.fromCharCode("a".charCodeAt(0)+valNameIndex));valNameIndex+=1;}}
$('.varRow').parent().remove();var strValRow,strValIdDiv;var $varConfig=$('#varConfig');for(var i=0;i<arrValId.length;++i){strValIdDiv='<div class="col-lg-6 col-xs-8 formulaVarValue grow" varId="'+arrValId[i]+'">\
                                            <span></span>\
                                            <div>'+AppConfig.datasource.getDSItemById(arrValId[i]).alias+'</div>\
                                            <span class="glyphicon glyphicon-remove-sign grow removeVarValue" aria-hidden="true" ></span>\
                                            </div>';strValRow='<div class="row">\
                                    <div class="col-xs-12 varRow">\
                                        <div class="varRemove glyphicon glyphicon-remove-sign grow" aria-hidden="true"></div>\
                                        <div class="col-xs-4 formulaVarName"><input type="text" name="inputVarValue" class="varNameChange">'+arrValName[i]+'</div>\
                                        <div class="col-xs-6 divVarValue">'+strValIdDiv+'</div>\
                                    </div>\
                                </div>';$varConfig.get(0).innerHTML+=strValRow;strFormula=strFormula.replace(new RegExp('<%'+arrValId[i]+'%>','g'),arrValName[i])}
$('#editable-math').mathquill('latex',strFormula);}
_this.initElement();_this.dragInit();_this.varConfigInit();_this.varAddInit();$('.removeVarValue').on('click',function(){$(this).parents('.formulaVarValue').remove();})},initElement:function(){var _this=this;var formulaResult;$('#btnFormulaDataAdd').click(function(e){var input=$('#inputCustName');var name;var preName=$('#inputCustName').val();if(''==preName){var list=_this.m_parent.m_allPointList;var count=0;for(var i=0,len=list.length;i<len;i++){if(1==list[i].itemType){count++;}}
name='Formula'+count;}
else{name=preName;}
if(name==''){input.focus();alert(_this.m_lang.CUSTOM_NOT_NULL);return;}
var strFormulaVal=_this.formulaGet();if('error'!=strFormulaVal){if(_this.m_dsCfg.m_bIsAdd){_this.m_parent.renderFormula(name,strFormulaVal,$('#inputFormulaDesc').val());}
else{_this.m_parent.modifyFormula(name,strFormulaVal,$('#inputFormulaDesc').val());}
_this.m_parent.m_parent.showAnlsPane();$(_this.m_dsCfg.container).remove();}});$('#btnCancelFormulaData').click(function(e){_this.m_parent.m_parent.showAnlsPane();$(_this.m_dsCfg.container).remove();});},dragInit:function(){var _this=this;var $formulaVarRow=$('#varConfig .varRow').not('#varConfig .row:first-child');$formulaVarRow.on('dragenter',function(e){e.preventDefault();e.stopPropagation();});$formulaVarRow.on('dragover',function(e){e.preventDefault();$(e.currentTarget).addClass('varSel');});$formulaVarRow.on('dragleave',function(e){e.preventDefault();$(e.currentTarget).removeClass('varSel');});for(var i=0;i<$formulaVarRow.length;++i){$formulaVarRow[i].ondrop=function(e){var targetId;e.preventDefault();targetId=EventAdapter.getData().dsItemId;var formulaVarValue='<div class="col-lg-6 col-xs-8 formulaVarValue grow" varId="'+targetId+'">\
                                            <span></span>\
                                            <div>'+AppConfig.datasource.getDSItemById(targetId).alias+'</div>\
                                            <span class="glyphicon glyphicon-remove-sign grow removeVarValue" aria-hidden="true" ></span>\
                                            </div>';$(e.currentTarget).find('.divVarValue').html(formulaVarValue);$(e.currentTarget).find('.removeVarValue').on('click',function(){$(this).parents('.formulaVarValue').remove();})}}
$('#dataSrcPanel').on('dragend',function(e){e.preventDefault();$('.varSel').removeClass('varSel')});},varConfigInit:function(){var $varConfig=$('#varConfig');$('.formulaVarName').click(function(){$(this).children().css('display','inline');$(this).children().val(this.childNodes[1].textContent).focus();$(this).children('span').css('display','none');});$('.varNameChange').blur(function(){this.style.display='none';if(this.value!=''){this.parentNode.childNodes[1].textContent=this.value;}
$(this).next('span').css('display','inline');});$varConfig.find('.varRemove').on('click',function(){$(this).parents('.row').remove();});$varConfig.find('.removeVarValue').on('click',function(){$(this).parents('.formulaVarValue').remove();})},varAddInit:function(){var $varConfig=$('#varConfig');var newVarName;var _this=this;$varConfig.find('.glyphicon-plus-sign').click(function(){newVarName=$('.formulaVarName').last().text();newVarName=newVarName.substr(0,newVarName.length-1)+String.fromCharCode(newVarName.charCodeAt(newVarName.length-1)+1);if(newVarName.charCodeAt(0)==0){newVarName='a';}
$varConfig.get(0).innerHTML+='<div class="row"><div class="col-xs-12 varRow">\
                                                    <div class="varRemove glyphicon glyphicon-remove-sign grow" aria-hidden="true"></div>\
                                                    <div class="col-lg-4 col-xs-4 formulaVarName"><input type="text" name="inputVarValue" class="varNameChange">'+newVarName+'</div>\
                                                    <div class="col-xs-6 divVarValue"></div>\
                                                </div></div>';_this.varAddInit();_this.dragInit();_this.varConfigInit();});},formulaGet:function(){var $editableMath=$('#editable-math');var $varRow=$('#varConfig .varRow');var latexMathValue=$editableMath.mathquill('latex');var varNum=$varRow.length;var varId,varName;var searchReg;var varError=new Array;$('.varLack').remove();for(var i=0;i<varNum;++i){varName=$($varRow.find('.formulaVarName').get(i));varId=$($varRow.find('.divVarValue').get(i)).children().attr('varId');searchReg=new RegExp('\\b'+varName.text()+'\\b','g');if(searchReg.test(latexMathValue)){if(varId){latexMathValue=latexMathValue.replace(searchReg,'<%'+varId+'%>');}else{varError.push(varName);}}}
if(varError.length>0){for(var ele=0;ele<varError.length;++ele){varError[ele].append($('<span class="varLack">Unassigned!<span>'));}
alert('Lack Variable in Formula');return'error';}
return latexMathValue;}};return DataSourceFormula;})();var DataSource=(function(){function DataSource(parent){this.m_parent=parent;this.m_newPointList=[];this.m_allPointList=[];this.m_allGroupList=[];this.m_arrProjIdColorMap={};this.m_dataSourceId;this.m_lang=I18n.resource.dataSource;this.m_selectItemId=0;this.m_selectGroupId=0;this.m_groupIconOpen='/static/images/dataSource/group_head_sel.png';this.m_groupIconClose='/static/images/dataSource/group_head_normal.png';this.m_cfgPanel;this.m_unassigned='unassigned';this.m_langFlag=('zh'==localStorage['language'])?0:1;}
DataSource.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);I18n.fillArea($('#divAnlsDatasourcePane'));I18n.fillArea($('#divEnergyAnlsPane'));_this.initContain();_this.initElement();_this.loadDataSourceRecord();_this.initDrag();Spinner.stop();},close:function(){this.m_newPointList=null;this.m_allPointList=null;},initContain:function(){var _this=this;var dsContain=$('#dataSrcContain');dsContain.html('');var panel=$('<div id="dataSrcPanel"></div>');dsContain.append(panel);var addGroup=$('<div id="dataSrcAddGroup"><input type="text" id="inputAddGroup" placeholder="+ Add group" ></input></div>');dsContain.append(addGroup);dsContain.keyup(function(e){if(13==e.keyCode){_this.addNewGroup();}});var inputAdd=addGroup.find('#inputAddGroup');inputAdd.attr('placeholder',_this.m_lang.ADD_GROUP);inputAdd.blur(function(e){_this.addNewGroup();});},initElement:function(){var _this=this;var len=AppConfig.projectList.length;var item;var nColorSize=_this.m_parent.arrColor.length;for(var i=0;i<len;i++){item=AppConfig.projectList[i];_this.m_arrProjIdColorMap[item.id]=_this.m_parent.arrColor[i-parseInt(i/nColorSize)*nColorSize];}
EventAdapter.on($('#data_source_add'),'click',function(e){if(0==_this.m_selectGroupId){alert(_this.m_lang.NO_SELECT_GROUP);return;}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});EventAdapter.on($('#data_source_formula_add'),'click',function(e){if(0==_this.m_selectGroupId){alert(_this.m_lang.NO_SELECT_GROUP);return;}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});EventAdapter.on($('#divAnlsDatasourcePane'),'click',function(e){_this.clearSelect();},false);$('#inputDsSearch').keyup(function(e){var searchVal=$(e.currentTarget).val();if(13==e.keyCode){$('#dataSrcPanel').empty();searchVal=searchVal.toLowerCase();_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,searchVal);$('#dataSrcAddGroup').hide();}
if(''==searchVal){$('#dataSrcPanel').empty();_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,'');_this.colapseGroups();$('#dataSrcAddGroup').show();}});},insertIntoDataList:function(customName,ptName,ptDesc,prjName,iconColor,itemId,baseNode,bIsAppend,bIsSelected){var _this=this;var div;if(bIsSelected){div=$('<div draggable="true" class="dsItem grow dsSelected" style="height:34px"></div>');}
else{div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');}
div.attr('id',itemId);div.click(function(e){_this.clearSelect();var target=$(e.currentTarget);if('dsItem grow'==target.attr('class')){target.attr('class','dsItem grow dsSelected');}else{target.attr('class','dsItem grow');}
_this.stopBubble(e);});var icon=$('<div class="dsMark"></div>');icon.css('background-color',iconColor);div.append(icon);var custName=$('<div class="dsValue" style="height:36px;">'+customName+'</div>');div.append(custName);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
_this.m_selectItemId=$(e.currentTarget).closest('.dsItem').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){var retCon=confirm(_this.m_lang.REMOVE_CONFIRM_TIPS);if(true===retCon){var div=$(e.currentTarget).closest('.dsItem');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(result){var data=JSON.parse(result);if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=data.deleteModal;var len=arr.length;if(len>0){var delMod;var arrDelTitle=[];for(var i=0;i<len;i++){delMod=$('#'+arr[i]);arrDelTitle.push(delMod.find('.newDivPageTitle').val());delMod.remove();}
var delTitle=_this.m_lang.WORKSPACE+':';for(var i=0,len=arrDelTitle.length;i<len;i++){delTitle+=arrDelTitle[i]+' ';}
delTitle+=_this.m_lang.REMOVE_RESULT;alert(delTitle);}}}).error(function(){});}}).error(function(e){});div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>');var ctlPrjName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.PROJECT_NAME+': '+prjName+'</label></div>');ctlPrjName.click(function(e){_this.stopBubble(e);});divChange.append(ctlPrjName);var ctlPtName=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.POINT_NAME+': '+ptName+'</label></div>');ctlPtName.click(function(e){_this.stopBubble(e);});divChange.append(ctlPtName);var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find('label').text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find('input');ctlInput.attr('value',customName);ctlInput.attr('placeholder',_this.m_lang.CUSTOM_NAME);inputCustName.click(function(e){_this.stopBubble(e);});divChange.append(inputCustName);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find('label').text(_this.m_lang.POINT_DESC);ctlInput=inputDesc.find('input');ctlInput.attr('value',ptDesc);ctlInput.attr('placeholder',_this.m_lang.POINT_DESC);inputDesc.click(function(e){_this.stopBubble(e);});divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE);btnOk.click(function(e){var temp=$(e.currentTarget).closest('.dsDivChange').find('input');var strName=$(temp[0]).val();var strDesc=$(temp[1]).val();var prjId,ptName,item;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){prjId=item.prjId;ptName=item.ptName;break;}}
var postData={itemList:[{id:itemId,type:0,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:''}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){var data=JSON.parse(result);var id=(data.itemIdList)[0].id;for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName;_this.m_allPointList[i].ptDesc=strDesc;break;}}
_this.setToolTipsCustomName(div,strName);_this.setToolTipsDesc(div,strDesc);_this.calUpdateDataSources();$('#'+id).find('.dsValue').text(strName);}).error(function(e){});});divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL);btnCancel.click(function(e){});divChange.append(btnCancel);div.append(divChange);if(bIsAppend){baseNode.append(div);}
else{baseNode.after(div);}},initToolTips:function(parent,customName,projectName,pointName,pointDesc){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:300px;">');show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="customName" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="projectName" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.m_lang.PROJECT_NAME).append('</span>: ').append(projectName).append('</p> ');show.append('        <p class="pointName" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.m_lang.POINT_NAME).append('</span>: ').append(pointName).append('</p> ');show.append('        <p class="pointDesc" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(pointDesc).append('</p> ');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var options={placement:'left',title:_this.m_lang.PARAM,template:show.toString()};parent.tooltip(options);},setToolTipsAll:function(row,userName,customName,projectName,pointName,pointDesc){var tip=row.data('bs.tooltip').$tip;userName=': '+userName;customName=': '+customName;projectName=': '+projectName;pointName=': '+pointName;pointDesc=': '+pointDesc;tip.find('.userName').text(this.m_lang.USER_NAME+userName);tip.find('.customName').text(this.m_lang.CUSTOM_NAME+customName);tip.find('.projectName').text(this.m_lang.PROJECT_NAME+projectName);tip.find('.pointName').text(this.m_lang.POINT_NAME+pointName);tip.find('.pointDesc').text(this.m_lang.POINT_DESC+pointDesc);},setToolTipsCustomName:function(row,customName){var tip=row.data('bs.tooltip').$tip;tip.find('.customName').text(this.m_lang.CUSTOM_NAME+': '+customName);},setToolTipsDesc:function(row,ptDesc){var tip=row.data('bs.tooltip').$tip;tip.find('.pointDesc').text(this.m_lang.POINT_DESC+': '+ptDesc);},renderTabel:function(){var _this=this;var len=_this.m_newPointList.length;if(len<=0){return;}
var div=$('#dataSrcPanel');var rowBaseNum=div.find('.dsItem').length;var rowCount;var item;var eachItem;var postData;len=_this.m_newPointList.length;if(len>0){postData={itemList:[]};for(var i=0;i<len;i++){item=_this.m_newPointList[i];eachItem={type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId}
postData.itemList.push(eachItem);}
var projName=_this.m_newPointList[0].prjName;var iconColor=_this.m_newPointList[0].iconColor;WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){if(result!=''){var data=JSON.parse(result);if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var len=list.length;for(var i=0;i<len;i++){if(_this.m_newPointList[i].customName==list[i].alias){_this.m_newPointList[i].itemId=list[i].id;}}
var divInsert=$('#'+_this.m_selectGroupId);if(undefined!=divInsert){for(var i=0;i<len;i++){_this.insertTreeItem(divInsert,list[i].id,iconColor,list[i].alias,0,'',true);_this.initToolTips($('#'+list[i].id),list[i].alias,projName,list[i].value,list[i].note);}}
_this.m_allPointList=_this.m_allPointList.concat(_this.m_newPointList);_this.calUpdateDataSources();}}).error(function(){}).always(function(){});}},modifyTable:function(){var _this=this;var item;var eachItem;var postData;var len=_this.m_newPointList.length;if(len>0){postData={itemList:[]};item=_this.m_newPointList[0];eachItem={id:item.itemId,type:0,projId:item.prjId,alias:item.customName,note:item.ptDesc,value:item.ptName,groupId:item.groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){if(result!=''){var data=JSON.parse(result);if(data.id!=''){_this.m_dataSourceId=data.id;}
for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(item.itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].prjId=item.prjId;_this.m_allPointList[i].prjName=_this.m_newPointList[0].prjName;_this.m_allPointList[i].customName=item.customName;_this.m_allPointList[i].ptName=item.ptName;_this.m_allPointList[i].ptDesc=item.ptDesc;break;}}
var divItem=$('#'+item.itemId);divItem.find('.showName').text(item.customName);_this.setToolTipsAll(divItem,item.userName,item.customName,item.prjName,item.ptName,item.ptDesc);_this.calUpdateDataSources();Beop.cache.ds.remove(item.itemId);}}).error(function(){}).always(function(){});}},initDrag:function(){var _this=this;_this.dragOperateSrc($('#dataSrcPanel').get(0));_this.dragOperateCfg($('.springConfigMask').parent().get(0));},dragOperateSrc:function(tableList){if(undefined==tableList){return;}
var _this=this;EventAdapter.on($(tableList),'dragstart',function(e){var tar=$(e.target);var className=tar.attr('class');if(-1!=className.indexOf('nav nav-list tree-group')){var dragSrcId=tar.attr('id');EventAdapter.setData({'dsGroupId':dragSrcId});}
else if(-1!=className.indexOf('treeRow ui-draggable')){var dragSrcId=tar.attr('id');EventAdapter.setData({'dsItemId':dragSrcId});}
else{return;}
$('.templatePara').css('display','block');});EventAdapter.on($(tableList),'dragover',function(e){e.preventDefault();});EventAdapter.on($(tableList),'drop',function(e){var tarItem=$(e.target);var tarId=0;var dstGroupId=0;var srcGroupId=0;var rowClass=tarItem.attr('class');var dragType=-1;var draggedID=0;if(-1!=rowClass.indexOf('nav nav-list tree-group')||-1!=rowClass.indexOf('dsTreeHeader')){tarId=tarItem.closest('.nav').attr('id');draggedID=EventAdapter.getData().dsGroupId;if(Boolean(draggedID)){dragType=0;}
else{draggedID=EventAdapter.getData().dsItemId;if(Boolean(draggedID)){dragType=2;tarId=tarItem.closest('.nav').attr('id');dstGroupId=tarId;srcGroupId=$('#'+draggedID).closest('.nav').attr('id');}}}
else if(-1!=rowClass.indexOf('showName')||-1!=rowClass.indexOf('treeRow ui-draggable')){dragType=1;draggedID=EventAdapter.getData().dsItemId;tarId=tarItem.closest('.treeRow').attr('id');dstGroupId=tarItem.closest('.nav').attr('id');srcGroupId=$('#'+draggedID).closest('.nav').attr('id');}
else{return;}
if(draggedID==tarId||!draggedID){return;}
if(0===dragType){var item,groupName;for(var i=0,len=_this.m_allGroupList.length;i<len;i++){item=_this.m_allGroupList[i];if(draggedID==item.id){groupName=item.name;break;}}
$('#'+draggedID).remove();_this.insertTreeGroup(draggedID,groupName,1,$('#'+tarId));for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(draggedID==item.groupId){if(item.itemType==0){_this.insertTreeItem($('#'+draggedID),item.itemId,item.iconColor,item.customName,0,'',true);}else{_this.insertTreeItem($('#'+draggedID),item.itemId,item.iconColor,item.customName,0,'',false);}
var prjName=_this.getProjectNameFromId(item.prjId,_this.m_langFlag);_this.initToolTips($('#'+item.itemId),item.customName,prjName,item.ptName,item.ptDesc);}}
var dstGroup,srcGroup;var arrDst=[],arrSrc=[];dstGroup=$('#'+tarId).find('.rows').find('.treeRow');srcGroup=$('#'+draggedID).find('.rows').find('.treeRow');$.each(dstGroup,function(i,n){arrDst.push(n.id);});$.each(srcGroup,function(i,n){arrSrc.push(n.id);});var postData={};postData[tarId]=arrDst;postData[draggedID]=arrSrc;WebAPI.post('/datasource/saveDataSourceGroupLayout/'+AppConfig.userId,postData).done(function(result){var data=JSON.parse(result);if('successful'==data.error){}}).error(function(){}).always(function(){});}
else if(1===dragType||2===dragType){var itemType=0;var iconColor='';var custName='';var projId=0;var pointName='';var pointDesc='';for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(draggedID==_this.m_allPointList[i].itemId){_this.m_allPointList[i].groupId=dstGroupId;itemType=_this.m_allPointList[i].itemType;iconColor=_this.m_allPointList[i].iconColor;custName=_this.m_allPointList[i].customName;projId=_this.m_allPointList[i].prjId;pointName=_this.m_allPointList[i].ptName;pointDesc=_this.m_allPointList[i].ptDesc;break;}}
var selItem=$('#'+draggedID);selItem.tooltip('destroy');selItem.remove();if(itemType==0){_this.insertTreeItem($('#'+dstGroupId),draggedID,iconColor,custName,dragType,$('#'+tarId),true);}else{_this.insertTreeItem($('#'+dstGroupId),draggedID,iconColor,custName,dragType,$('#'+tarId),false);}
if(0==itemType){var prjName=_this.getProjectNameFromId(projId,_this.m_langFlag);_this.initToolTips($('#'+draggedID),custName,prjName,showName,pointDesc);}
else if(1==itemType){var showName=_this.getShowNameFromFormula(pointName);_this.initFormulaToolTips($('#'+draggedID),custName,showName,pointDesc);}
else{return;}
var postData={};if(dstGroupId==srcGroupId){var srcGroup,arrSrc=[];srcGroup=$('#'+srcGroupId).find('.rows').find('.treeRow');$.each(srcGroup,function(i,n){arrSrc.push(n.id);});postData[srcGroupId]=arrSrc;}
else{var dstGroup,srcGroup;var arrDst=[],arrSrc=[];dstGroup=$('#'+dstGroupId).find('.rows').find('.treeRow');srcGroup=$('#'+srcGroupId).find('.rows').find('.treeRow');$.each(dstGroup,function(i,n){arrDst.push(n.id);});$.each(srcGroup,function(i,n){arrSrc.push(n.id);});var dstGroupCnt=0,srcGroupCnt=0;var groups=$('#dataSrcPanel .nav');$.each(groups,function(i,n){if(n.id==dstGroupId){dstGroupCnt=i;}
if(n.id==srcGroupId){srcGroupCnt=i;}});if(dstGroupCnt<srcGroupCnt){postData[dstGroupId]=arrDst;postData[srcGroupId]=arrSrc;}
else{postData[dstGroupId]=arrDst;postData[srcGroupId]=arrSrc;}}
WebAPI.post('/analysis/datasource/saveLayout/'+AppConfig.userId,postData).done(function(result){var data=JSON.parse(result);if(data.success){}}).error(function(){}).always(function(){});}});},dragOperateCfg:function(divItem){if(undefined==divItem){return;}
var _this=this;EventAdapter.on($(divItem),'dragstart',function(e){var target=$(e.target);var className=target.attr('class');if('dsItem grow'!=className&&'dsItem grow dsSelected'!=className){return;}
var dragSrcId=target.attr('id');EventAdapter.setData({'dsItemId':dragSrcId});});EventAdapter.on($(divItem),'dragover',function(e){e.preventDefault();});EventAdapter.on($(divItem),'drop',function(e){var target=$(e.target);});},saveCurrentRecords:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.post('/delete_data_source_records_by_userid',{userId:AppConfig.userId}).done(function(result){if(result!=0){Spinner.stop();return;}
var newPtList=[];var id;var len=_this.m_allPointList.length;var newRow;var item;$('#dataSrcPanel .dsItem').each(function(){id=$(this).attr('id');for(var i=0;i<len;i++){item=_this.m_allPointList[i];if(id==item.itemId){newRow={'itemId':id,'userId':item.userId,'userName':item.userName,'customName':item.customName,'prjId':item.prjId,'prjName':item.prjName,'ptName':item.ptName,'ptDesc':item.ptDesc,'iconColor':item.iconColor,'itemId':item.itemId}
newPtList.push(newRow);break;}}});_this.m_allPointList=newPtList;var row;var data=[];var len=_this.m_allPointList.length;for(var i=0;i<len;i++){item=_this.m_allPointList[i];row={'userId':item.userId,'customName':item.customName,'projectId':item.prjId,'pointName':item.ptName,'pointDesc':item.ptDesc,'iconColor':item.iconColor}
data.push(row);}
WebAPI.post('/save_data_source_record',{sourceList:data}).done(function(result){if(0==result){}}).error(function(result){alert(I18n.resource.observer.widgets.DATABASE_OPERATION_FAILED+'！');return;});}).error(function(result){alert(I18n.resource.observer.widgets.FAIL_BEFORE_EXECUTING+'！');return;}).always(function(){Spinner.stop();});},loadDataSourceRecord:function(){var _this=this;var dataPanel=$('#dataSrcPanel');var groupInfo=_this.m_parent.store.group;if(!groupInfo){return;}
_this.m_allGroupList=[];_this.m_allPointList=[];var itemDefault=null;for(var m=0,n=groupInfo.length;m<n;m++){var groupId=groupInfo[m].groupId;var groupName=groupInfo[m].groupName;var groupIsDefault=(Boolean(groupInfo[m].isDefault))?true:false;var data=groupInfo[m].datasourceList;var groupItem={'id':groupId,'name':groupName,'isDefault':groupIsDefault};if(groupIsDefault){itemDefault=groupItem;}
else{_this.m_allGroupList.push(groupItem);}
if(data){var len=data.length;var item;for(var i=0;i<len;i++){item={userId:AppConfig.userId,userName:AppConfig.account,customName:data[i].alias,prjId:data[i].projId,prjName:_this.getProjectNameFromId(data[i].projId),ptName:data[i].value,ptDesc:data[i].note,iconColor:_this.m_arrProjIdColorMap[data[i].projId],itemId:data[i].id,itemType:data[i].type,itemValue:data[i].value,groupId:groupId,groupName:groupName}
if(item.itemType==1){item.iconColor='#000000';}
_this.m_allPointList.push(item);}}}
if(itemDefault){_this.m_allGroupList.push(itemDefault);}
_this.insertTreeAllGroupItem(_this.m_allGroupList,_this.m_allPointList,'');},colapseGroups:function(){var treeAllHead=$('.dsTreeHeader .dsGroupName');var item;for(var i=0,len=treeAllHead.length;i<len;i++){item=treeAllHead.eq(i);if(item.text()!=this.m_unassigned){item.closest('.dsTreeHeader').click();}}},getProjectNameFromId:function(id,langFlag){var name;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(id==item.id){if(0==langFlag){name=item.name_cn;}
else{name=item.name_en;}
break;}}
return name;},getProjectIdFromName:function(projectName){var id;var len=AppConfig.projectList.length;var item;for(var i=0;i<len;i++){item=AppConfig.projectList[i];if(projectName==item.name_cn){id=item.id;break;}}
return id;},calUpdateDataSources:function(){var _this=this;var updateData=[];for(var i=0,len=_this.m_allGroupList.length;i<len;i++){var groupItem={'groupId':_this.m_allGroupList[i].id,'groupName':_this.m_allGroupList[i].name,'parentId':'','datasourceList':''};var dsList=[];for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){var curItem=_this.m_allPointList[j];if(groupItem.groupId==curItem.groupId){var pushItem={'id':curItem.itemId,'type':curItem.itemType,'projId':curItem.prjId,'alias':curItem.customName,'note':curItem.ptDesc,'value':curItem.ptName,'groupId':curItem.groupId};dsList.push(pushItem);}}
groupItem.datasourceList=dsList;updateData.push(groupItem);}
this.m_parent.updateDataSources(updateData);},renderFormula:function(_customName,_formulaVal,_formulaDesc){var _this=this;var postData={itemList:[]};var prjId=0;var eachItem={type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){if(result!=''){var data=JSON.parse(result);if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var item;for(var i=0,len=list.length;i<len;i++){item={'itemId':list[i].id,'itemType':1,'customName':list[i].alias,'itemValue':list[i].value,'ptName':list[i].value,'prjId':prjId,'iconColor':'#000000','ptDesc':_formulaDesc,'groupId':list[i].groupId};_this.m_allPointList.push(item);_this.insertTreeItem($('#'+_this.m_selectGroupId),item.itemId,item.iconColor,item.customName,0,'',false);var showName=_this.getShowNameFromFormula(list[i].value);_this.initFormulaToolTips($('#'+item.itemId),item.customName,showName,_formulaDesc);}
_this.calUpdateDataSources();}});},modifyFormula:function(_customName,_formulaVal,_formulaDesc){var _this=this;var postData={itemList:[]};var itemId=_this.m_selectItemId;var prjId=Number(AppConfig.projectId);var eachItem={id:itemId,type:1,projId:prjId,alias:_customName,note:_formulaDesc,value:_formulaVal,groupId:_this.m_selectGroupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){if(result!=''){var data=JSON.parse(result);if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;if(list.length>0){var showName=list[0].value;var arr=showName.split('<%');for(var j=0,len2=arr.length;j<len2;j++){var id=arr[j].split('%>')[0];if(''==id){continue;}
var retVal=_this.getDSItemById(id);if(null==retVal){continue;}
showName=showName.replace(id,retVal.value);}
showName=showName.replace(/<%/g,'');showName=showName.replace(/%>/g,'');for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(itemId===_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=list[0].alias;_this.m_allPointList[i].ptName=list[0].value;_this.m_allPointList[i].ptDesc=list[0].note;break;}}
var divFormula=$('#'+itemId);divFormula.find('.showName').text(list[0].alias);_this.setFormulaToolTipsAll(divFormula,list[0].alias,showName,list[0].note);_this.calUpdateDataSources();Beop.cache.ds.remove(itemId);}}});},insertFormula:function(itemId,customName,iconColor,formula,desc){var _this=this;var div=$('<div draggable="true" class="dsItem grow" style="height:34px"></div>');div.attr('id',itemId);div.click(function(e){_this.clearSelect();var tar=$(e.currentTarget);if('dsItem grow'==tar.attr('class')){tar.attr('class','dsItem grow dsSelected');}
else{tar.attr('class','dsItem grow');}
_this.stopBubble(e);});var icon=$('<div class="dsMark"></div>');icon.css('background-color',iconColor);div.append(icon);var name=$('<div class="dsValue" style="height:36px"></div>');name.text(customName);div.append(name);var btnRename=$('<span class="dsBtnRename grow glyphicon glyphicon-wrench"></span>');btnRename.click(function(e){var show=$(e.currentTarget).prevAll('.dsValue');show.css('display','none');var target=$(e.currentTarget).nextAll('.dsDivChange');target.attr('class','dsDivChange show');div.css('height','240px');div.css('width','100%');var item;var strName='';var strFormula='';var strDesc='';for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){strName=item.customName;strFormula=item.ptName;strDesc=item.ptDesc;break;}}
var temp=target.find('input');if(temp.length==2){$(temp[0]).val(strName);$(temp[1]).val(strDesc);}
_this.stopBubble(e);}).error(function(e){});div.append(btnRename);var btnRemove=$('<span class="dsBtnRemove grow glyphicon glyphicon-remove-sign"></span>');btnRemove.click(function(e){var retCon=confirm(_this.m_lang.REMOVE_CONFIRM);if(true===retCon){var div=$(e.currentTarget).closest('.dsItem');var dataSrcId=_this.m_dataSourceId;var dataSrcItemId=div.attr('id');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(result){var data=JSON.parse(result);if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();}}).error(function(){});}});div.append(btnRemove);var divChange=$('<div class="dsDivChange"></div>');var inputCustName=$('<div class="form-group"><label style="color:#eee">Custom Name</label><input type="text" class="form-control" value="" placeholder="Custom Name"></input></div>');inputCustName.find('label').text(_this.m_lang.CUSTOM_NAME);var ctlInput=inputCustName.find('input');ctlInput.attr('value',customName);ctlInput.attr('placeholder',_this.m_lang.CUSTOM_NAME);inputCustName.click(function(e){_this.stopBubble(e);});divChange.append(inputCustName);var ctlFormula=$('<div class="form-group"><label style="color:#eee">'+_this.m_lang.FORMULA_NAME+': </label></div>');var showFormula=$('<span>'+formula+'</span>');showFormula.appendTo(ctlFormula.find('label')).mathquill();ctlFormula.click(function(e){_this.stopBubble(e);});divChange.append(ctlFormula);var inputDesc=$('<div class="form-group"><label style="color:#eee">Description</label><input type="text" class="form-control" value="" placeholder="Description"></input></div>');inputDesc.find('label').text(_this.m_lang.POINT_DESC);ctlInput=inputDesc.find('input');ctlInput.attr('value',desc);ctlInput.attr('placeholder',_this.m_lang.POINT_DESC);inputDesc.click(function(e){_this.stopBubble(e);});divChange.append(inputDesc);var btnOk=$('<button class="btn btn-default btn-sm" style="position:absolute; right:70px;">OK</button>');btnOk.text(_this.m_lang.SURE);btnOk.click(function(e){var temp=$(e.currentTarget).closest('.dsDivChange').find('input');var strName=$(temp[0]).val();var strDesc=$(temp[1]).val();var prjId,ptName,item;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){prjId=item.prjId;ptName=item.ptName;break;}}
var postData={itemList:[{id:itemId,type:1,projId:prjId,alias:strName,note:strDesc,value:ptName,groupId:''}]};WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){var data=JSON.parse(result);if(0==data.itemIdList.length){return;}
var id=(data.itemIdList)[0].id;for(var i=0,len=_this.m_allPointList.length;i<len;i++){if(id==_this.m_allPointList[i].itemId){_this.m_allPointList[i].customName=strName;_this.m_allPointList[i].ptDesc=strDesc;break;}}
_this.setToolTipsCustomName(div,strName);_this.setToolTipsDesc(div,strDesc);_this.calUpdateDataSources();$('#'+id).find('.dsValue').text(strName);}).error(function(e){});});divChange.append(btnOk);var btnCancel=$('<button class="btn btn-default btn-sm" style="position:absolute; right:15px;">Cancel</button>');btnCancel.text(_this.m_lang.CANCEL);btnCancel.click(function(e){});divChange.append(btnCancel);div.append(divChange);$('#dataSrcPanel').append(div);},initFormulaToolTips:function(parent,customName,formula,desc){var _this=this;var show=new StringBuilder();show.append('<div class="tooltip" role="tooltip" style="z-index:10;position:fixed;max-width:400px;">');show.append('    <div class="tooltipTitle tooltip-inner">GeneralRegressor</div>');show.append('    <div class="tooltipContent">');show.append('        <p class="customName" style=word-break:break-all;"><span style="font-weight:bold">').append(_this.m_lang.CUSTOM_NAME).append('</span>: ').append(customName).append('</p>');show.append('        <p class="formula" style="word-break:normal;"><span style="font-weight:bold">').append(_this.m_lang.FORMULA_NAME).append('</span>: ').append('</p>');show.append('        <p class="pointDesc" style="word-break:break-all;"><span style="font-weight:bold">').append(_this.m_lang.POINT_DESC).append('</span>: ').append(desc).append('</p>');show.append('    </div>');show.append('    <div class="tooltip-arrow"></div>');show.append('</div>');var showFormula=$('<span>'+formula+'</span>');var showObj=$(show.toString());showFormula.appendTo(showObj.find('.formula')).mathquill();var options={placement:'left',title:_this.m_lang.PARAM,template:showObj};parent.tooltip(options);},setFormulaToolTipsAll:function(row,customName,formulaVal,formulaDesc){var tip=row.data('bs.tooltip').$tip;tip.find('.customName').html('<span style="font-weight:bold">'+this.m_lang.CUSTOM_NAME+'</span>: '+customName);tip.find('.pointDesc').html('<span style="font-weight:bold">'+this.m_lang.POINT_DESC+'</span>: '+formulaDesc);var showFormula=$('<span>'+formulaVal+'</span>');var dst=tip.find('.formula').html('<span style="font-weight:bold">'+this.m_lang.FORMULA_NAME+'</span>: ');showFormula.appendTo(dst).mathquill();},checkRepeatWithCustomName:function(_name){var _this=this;var bRet=false;var grids=$('#dataSrcPanel .dsItem .dsValue');$.each(grids,function(i,n){if(_name==$(n).text()){bRet=true;return false;}});return bRet;},stopBubble:function(e){if(e&&e.stopPropagation){e.stopPropagation();}else{window.event.cancelBubble=true;}},clearSelect:function(e){var itemList=$('#dataSrcPanel .dsItem');itemList.attr('class','dsItem grow');itemList.css('height','34px');itemList.css('width','33%');var panel=$('#dataSrcPanel');panel.find('.dsDivChange').attr('class','dsDivChange');panel.find('.dsValue').css('display','inline');},insertTreeGroup:function(groupId,groupName,type,baseGroup){var _this=this;var divContain=$('#dataSrcPanel');var $ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true">');var $liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon open"></span></li>');var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);if(groupName!=_this.m_unassigned){var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true"></span>');EventAdapter.on(btnRemove,'click',function(e){var retCon=confirm(_this.m_lang.REMOVE_CONFIRM);if(true===retCon){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
var div=$(e.currentTarget).closest('.nav');var groupId=div.attr('id');div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+groupId).done(function(result){var data=JSON.parse(result);if(('successful'==data.error)){var len=_this.m_allGroupList.length;for(var i=0;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1);div.remove();break;}}
_this.calUpdateDataSources();}}).fail(function(e){});}}).error(function(e){});$liHd.append(btnRemove);}
var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add"></span>');EventAdapter.on(btnAddDs,'click',function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add" /></span>');EventAdapter.on(btnAddFormula,'click',function(e){var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_hover.png');img.css('width','23px');img.css('height','20px');}).error(function(e){});btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_normal.png');img.css('width','21px');img.css('height','19px');}).error(function(e){});$liHd.append(btnAddFormula);if(groupName!=_this.m_unassigned){var spanEdit=$('<span class="glyphicon glyphicon-pencil panel-heading-btn grow dsEditGroupName" aria-hidden="true"></span>');EventAdapter.on(spanEdit,'click',function(e){var tar=$(e.currentTarget);var groupName=tar.siblings('.dsGroupName');groupName.hide();var input=tar.siblings('.inputEditGroup');input.val(groupName.text());input.show();input.select();tar.siblings('.btn').show();_this.stopBubble(e);});$liHd.append(spanEdit);var inputEdit=$('<input type="text" value="'+groupName+'" class="inputEditGroup">');inputEdit.hide();EventAdapter.on(inputEdit,'click',function(e){_this.stopBubble(e);});inputEdit.keyup(function(e){if(13==e.keyCode){var tar=$(e.currentTarget);tar.siblings('button').click();}
_this.stopBubble(e);});$liHd.append(inputEdit);var btnEdit=$('<button class="btn btn-default btn-sm" type="submit">Change</button>');btnEdit.hide();EventAdapter.on(btnEdit,'click',function(e){var tar=$(e.currentTarget);tar.hide();var input=tar.siblings('.inputEditGroup');var newName=input.val();input.hide();var groupName=tar.siblings('.dsGroupName');var oldName=groupName.text();groupName.show();if(oldName!=newName&&''!=newName){var postData={'groupId':groupId,'name':newName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){var data=JSON.parse(result);if(undefined==data){return;}
if('successful'==data.error){for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList[i].name=data.groupName;break;}}
spanName.text(data.groupName);}}).fail(function(e){});}
_this.stopBubble(e);});$liHd.append(btnEdit);}
EventAdapter.on($liHd,'click',function(e){divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');divContain.find('.dsEditGroupName').css('display','none');var curTarHead=$(e.currentTarget);curTarHead.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarHead.closest('.tree-group').get(0).id;$(this).next('.rows').slideToggle();var icon=$(this).find('.dsTreeHeaderIcon');var imgPath=icon.attr('src');if(icon.hasClass('open')){icon.removeClass('open');curTarHead.find('.dsGroupName').css('font-weight','400');curTarHead.find('.dsTreeBtnFormula').css('display','none');curTarHead.find('.dsTreeBtnAdd').css('display','none');curTarHead.find('.dsTreeBtnDel').css('display','none');curTarHead.find('.dsEditGroupName').css('display','none');}
else{icon.addClass('open');curTarHead.find('.dsGroupName').css('font-weight','700');curTarHead.find('.dsTreeBtnFormula').css('display','inline');curTarHead.find('.dsTreeBtnAdd').css('display','inline');curTarHead.find('.dsTreeBtnDel').css('display','inline');curTarHead.find('.dsEditGroupName').css('display','inline');}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');$ul.append(divLiRow);if(0===type){divContain.append($ul);}
else if(1===type){if(''!=baseGroup){baseGroup.after($ul);}}
else if(2===type){if(''!=baseGroup){baseGroup.before($ul);}}},insertTreeItem:function(divParentGroup,itemId,iconColor,itemName,insertType,baseItem,bIsPoint){var _this=this;var div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true"> ');var icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css('background-color',iconColor);div.append(icon);var divShowName=$('<span class="showName">'+itemName+'</span>');EventAdapter.on(divShowName,'click',function(e){var oldCustName=$(e.currentTarget).text();var input=$('<input type="text" value="'+oldCustName+'" style="width:300px;position: absolute;top: 4px">');input.blur(function(e){var newCustName=$(e.currentTarget).val();if(oldCustName!=newCustName){var item,type,prjId,ptName,ptDesc,groupId,postData;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId==item.itemId){type=item.itemType;prjId=item.prjId;ptName=item.ptName;ptDesc=item.ptDesc;groupId=item.groupId;break;}}
postData={itemList:[]};var eachItem={id:itemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){if(result!=''){var data=JSON.parse(result);if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var dstId,dstCustomName;for(var i=0,len=list.length;i<len;i++){dstId=list[i].id;dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break;}}
divShowName.text(dstCustomName);_this.setToolTipsCustomName(divShowName.closest('.treeRow'),dstCustomName);}
_this.calUpdateDataSources();}});}
input.remove();divShowName.css('display','inline');});input.keyup(function(e){if(13==e.keyCode){input.blur();}
_this.stopBubble(e);});divShowName.after(input);divShowName.css('display','none');input.select();});div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');EventAdapter.on(btnRemove,'click',function(e){var promise=$.Deferred();var div=$(e.currentTarget).closest('.treeRow');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;if(typeof _this.m_parent.doSync==='function'){_this.m_parent.doSync().done(function(){promise.resolve();});}else{promise.resolve();}
promise.done(function(){WebAPI.get('/analysis/checkDatasourceBeforeDelete/'+dataSrcItemId+'/'+AppConfig.userId).done(function(result){var chkData=JSON.parse(result);var nWorkSpLen=chkData.workspaceInfo.length;var nDashBoLen=chkData.dashboardInfo.length;if(nWorkSpLen>0||nDashBoLen>0){var show=_this.m_lang.REMOVE_CONFIRM_TIPS;var name;for(var i=0;i<nWorkSpLen;i++){if(0==i){show+='workspace: ';}
name=chkData.workspaceInfo[i].modalName;name=Boolean(name)?name:'Untitled';show+=name+',';}
for(var j=0;j<nDashBoLen;j++){if(0==j){show+='dashboard: ';}
show+=chkData.dashboardInfo[j].modalType+',';}
show+=_this.m_lang.REMOVE_CONFIRM;if(false===confirm(show)){return;}
else{if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}}}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(result){var data=JSON.parse(result);if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});}).fail(function(e){});});}).error(function(e){});div.append(btnRemove);if(bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on(btnCfg,'click',function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}else{var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on(btnCfg,'click',function(e){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});}).error(function(e){});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}
EventAdapter.on(div,'click',function(e){var divContain=$('#dataSrcPanel');divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');var curTarItem=$(e.currentTarget);curTarItem.find('.dsTreeBtnCfg').css('display','inline');curTarItem.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarItem.closest('.tree-group').get(0).id;});if(0===insertType){divParentGroup.find('.rows').append(div);}
else if(1===insertType){if(''!=baseItem){baseItem.after(div);}}
else if(2===insertType){var lyRow=divParentGroup.find('.rows').find('.treeRow');if(0==lyRow.length){divParentGroup.find('.rows').append(div);}
else{lyRow.eq(0).before(div);}}},insertTreeAllGroupItem:function(groupList,pointList,searchPointName){var _this=this;var divContain=$('#dataSrcPanel');var groupId,groupName,bIsDefault;for(var i=0,len=groupList.length;i<len;i++){groupId=groupList[i].id;groupName=groupList[i].name;bIsDefault=groupList[i].isDefault;var $ul=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true" dropable="true" isDefault="'+bIsDefault+'">');var $liHd;if(groupName==this.m_unassigned){$liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon open"></span></li>');}
else{$liHd=$('<li class="dsTreeHeader"><span class="dsTreeHeaderIcon"></span></li>');}
var spanName=$('<span class="dsGroupName">'+groupName+'</span>');$liHd.append(spanName);if(groupName!=_this.m_unassigned){var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnDel" aria-hidden="true" style="display:none"></span>');EventAdapter.on($(btnRemove),'click',function(e){var retCon=confirm(_this.m_lang.REMOVE_CONFIRM);if(true===retCon){if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}
var div=$(e.currentTarget).closest('.nav');var groupId=div.attr('id');div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/datasource/deleteDataSourceGroup/'+AppConfig.userId+'/'+groupId).done(function(result){var data=JSON.parse(result);if(('successful'==data.error)){var len=_this.m_allGroupList.length;for(var i=0;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList.splice(i,1);div.remove();break;}}
_this.calUpdateDataSources();}}).fail(function(e){});}});$liHd.append(btnRemove);}
var btnAddDs=$('<span class="glyphicon glyphicon-plus-sign panel-heading-btn grow dsTreeBtnAdd" aria-hidden="true" id="data_source_add" style="display:none"></span>');if(groupName==this.m_unassigned){btnAddDs.css('display','inline');}
EventAdapter.on($(btnAddDs),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});$liHd.append(btnAddDs);var btnAddFormula=$('<span><img src="/static/images/dataSource/formula_add_normal.png" alt="Formula add" class="dsTreeBtnFormula" id="data_source_formula_add"  style="display:none"/></span>');if(groupName==this.m_unassigned){btnAddFormula.children('img').css('display','inline');}
EventAdapter.on($(btnAddFormula),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
var tar=$(e.currentTarget);_this.m_selectGroupId=tar.closest('.tree-group').get(0).id;_this.stopBubble(e);if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,true,'','','',-1);_this.m_cfgPanel.show();}).error(function(result){}).always(function(e){});});btnAddFormula.mouseenter(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_hover.png');img.css('width','23px');img.css('height','20px');}).error(function(e){});btnAddFormula.mouseleave(function(e){var img=btnAddFormula.find('img');img.attr('src','/static/images/dataSource/formula_add_normal.png');img.css('width','21px');img.css('height','19px');}).error(function(e){});$liHd.append(btnAddFormula);if(groupName!=_this.m_unassigned){var spanEdit=$('<span class="glyphicon glyphicon-pencil panel-heading-btn grow dsEditGroupName" aria-hidden="true" style="display:none"></span>');EventAdapter.on($(spanEdit),'click',function(e){var tar=$(e.currentTarget);var groupName=tar.siblings('.dsGroupName');groupName.hide();var input=tar.siblings('.inputEditGroup');input.val(groupName.text());input.show();input.select();tar.siblings('.btn').show();_this.stopBubble(e);});$liHd.append(spanEdit);var inputEdit=$('<input type="text" value="'+groupName+'" class="inputEditGroup">');inputEdit.hide();EventAdapter.on($(inputEdit),'click',function(e){_this.stopBubble(e);});inputEdit.keyup(function(e){if(13==e.keyCode){var tar=$(e.currentTarget);tar.siblings('button').click();}
_this.stopBubble(e);});$liHd.append(inputEdit);var btnEdit=$('<button class="btn btn-default btn-sm" type="submit">Change</button>');btnEdit.hide();EventAdapter.on($(btnEdit),'click',function(e){var tar=$(e.currentTarget);tar.hide();var input=tar.siblings('.inputEditGroup');var newName=input.val();input.hide();var groupName=tar.siblings('.dsGroupName');var oldName=groupName.text();groupName.show();if(oldName!=newName&&''!=newName){var ulNav=tar.closest('.nav');var groupId=ulNav.attr('id');var postData={'groupId':groupId,'name':newName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){var data=JSON.parse(result);if(undefined==data){return;}
if('successful'==data.error){for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId==_this.m_allGroupList[i].id){_this.m_allGroupList[i].name=data.groupName;break;}}
var spanName=ulNav.find('.dsGroupName');if(Boolean(spanName)){spanName.text(data.groupName);}}}).fail(function(e){});}
_this.stopBubble(e);});$liHd.append(btnEdit);}
EventAdapter.on($($liHd),'click',function(e){divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');divContain.find('.dsEditGroupName').css('display','none');var curTarHead=$(e.currentTarget);curTarHead.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarHead.closest('.tree-group').get(0).id;$(this).next('.rows').slideToggle();var icon=$(this).find('.dsTreeHeaderIcon');if(icon.hasClass('open')){icon.removeClass('open');curTarHead.find('.dsGroupName').removeClass('selected');curTarHead.find('.dsTreeBtnFormula').css('display','none');curTarHead.find('.dsTreeBtnAdd').css('display','none');curTarHead.find('.dsTreeBtnDel').css('display','none');curTarHead.find('.dsEditGroupName').css('display','none');}
else{icon.addClass('open');curTarHead.find('.dsGroupName').addClass('selected');curTarHead.find('.dsTreeBtnFormula').css('display','inline-block');curTarHead.find('.dsTreeBtnAdd').css('display','inline');curTarHead.find('.dsTreeBtnDel').css('display','inline');curTarHead.find('.dsEditGroupName').css('display','inline');}});$ul.prepend($liHd);var divLiRow=$('<li class="rows"></li>');if(groupName==_this.m_unassigned){divLiRow.css('display','block');}
else{divLiRow.css('display','none');}
$ul.append(divLiRow);var itemId,iconColor,itemName,itemPtName;var bHasSearched=false;for(var j=0,len2=pointList.length;j<len2;j++){if(groupId==pointList[j].groupId){itemId=pointList[j].itemId;iconColor=pointList[j].iconColor;itemName=pointList[j].customName;itemPtName=pointList[j].ptName;if(''!=searchPointName){var custNameLower=itemName.toLowerCase();var ptNameLower=itemPtName.toLowerCase();if(-1==custNameLower.indexOf(searchPointName)&&-1==ptNameLower.indexOf(searchPointName)){continue;}
else{bHasSearched=true;}}
var div=$('<div class="treeRow ui-draggable" id="'+itemId+'" draggable="true" dropable="true"> ');var icon=$('<div class="dsMark" style="margin-top: -1px"></div>');icon.css('background-color',iconColor);div.append(icon);var divShowName=$('<span class="showName">'+itemName+'</span>');EventAdapter.on($(divShowName),'click',function(e){var divCurShowName=$(e.currentTarget);var oldCustName=divCurShowName.text();var selItemId=divCurShowName.closest('.treeRow').attr('id');var input=$('<input type="text" value="'+oldCustName+'" style="width:300px;position: absolute;top: 4px">');input.blur(function(e){var newCustName=$(e.currentTarget).val();if(oldCustName!=newCustName){var item,type,prjId,ptName,ptDesc,groupId,postData;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(selItemId==item.itemId){type=item.itemType;prjId=item.prjId;ptName=item.ptName;ptDesc=item.ptDesc;groupId=item.groupId;break;}}
postData={itemList:[]};var eachItem={id:selItemId,type:type,projId:prjId,alias:newCustName,note:ptDesc,value:ptName,groupId:groupId}
postData.itemList.push(eachItem);WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){if(result!=''){var data=JSON.parse(result);if(data.id!=''){_this.m_dataSourceId=data.id;}
var list=data.itemIdList;var dstId,dstCustomName;for(var i=0,len=list.length;i<len;i++){dstId=list[i].id;dstCustomName=list[i].alias;for(var j=0,len2=_this.m_allPointList.length;j<len2;j++){if(dstId==_this.m_allPointList[j].itemId){_this.m_allPointList[j].customName=dstCustomName;break;}}
divCurShowName.text(dstCustomName);_this.setToolTipsCustomName(divCurShowName.closest('.treeRow'),dstCustomName);}
_this.calUpdateDataSources();}});}
input.remove();divCurShowName.css('display','inline');});input.keyup(function(e){if(13==e.keyCode){input.blur();}
_this.stopBubble(e);});divCurShowName.after(input);divCurShowName.css('display','none');input.select();});div.append(divShowName);var btnRemove=$('<span class="glyphicon glyphicon-remove-sign panel-heading-btn grow dsTreeBtnRemove" aria-hidden="true"></span>');EventAdapter.on($(btnRemove),'click',function(e){var promise=$.Deferred();var div=$(e.currentTarget).closest('.treeRow');var dataSrcItemId=div.attr('id');var dataSrcId=_this.m_dataSourceId;if(typeof _this.m_parent.doSync==='function'){_this.m_parent.doSync().done(function(){promise.resolve();});}else{promise.resolve();}
Spinner.spin(div[0]);promise.done(function(){WebAPI.get('/analysis/checkDatasourceBeforeDelete/'+dataSrcItemId+'/'+AppConfig.userId).done(function(result){var chkData=JSON.parse(result);var nWorkSpLen=chkData.workspaceInfo.length;var nDashBoLen=chkData.dashboardInfo.length;if(nWorkSpLen>0||nDashBoLen>0){var show=_this.m_lang.REMOVE_CONFIRM_TIPS;var name;for(var i=0;i<nWorkSpLen;i++){if(0==i){show+='workspace: ';}
name=chkData.workspaceInfo[i].modalName;name=Boolean(name)?name:'Untitled';show+=name+',';}
for(var j=0;j<nDashBoLen;j++){if(0==j){show+='dashboard: ';}
show+=chkData.dashboardInfo[j].modalType+',';}
show+=_this.m_lang.REMOVE_CONFIRM;if(false===confirm(show)){return;}
else{if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();_this.m_parent.showAnlsPane();}}}
div.css('position','relative');div.css('animation','dsRemove 3s infinite');div.css('-moz-animation','dsRemove 3s infinite');div.css('-webkit-animation','dsRemove 3s infinite');div.css('-o-animation','dsRemove 3s infinite');WebAPI.get('/analysis/datasource/removeSingle/'+dataSrcItemId).done(function(result){var data=JSON.parse(result);if(Boolean(data.success)){var len=_this.m_allPointList.length;for(var i=0;i<len;i++){if(dataSrcItemId==_this.m_allPointList[i].itemId){_this.m_allPointList.splice(i,1);break;}}
_this.calUpdateDataSources();div.tooltip('destroy');div.remove();var arr=chkData.workspaceInfo;for(var i=0,len=arr.length;i<len;i++){var divWoSp=$('.divPage');for(var j=0,len2=divWoSp.length;j<len2;j++){if(arr[i].modalName==divWoSp.eq(j).find('.modalNameSp').text()){divWoSp.eq(j).remove();}}}
Beop.cache.ds.remove(dataSrcItemId);}}).fail(function(e){});}).fail(function(e){}).always(function(e){Spinner.stop();});});});div.append(btnRemove);var bIsPoint=(0==pointList[j].itemType)?true:false;if(bIsPoint){var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on($(btnCfg),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,0,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}else{var btnCfg=$('<img src="/static/images/dataSource/item_edit.png" alt="png" class="dsTreeBtnCfg">');EventAdapter.on($(btnCfg),'click',function(e){var $pageFilter=$('#pageDataFilter');if($pageFilter.length>0){$pageFilter.find('#btnCancel').click();}
if(undefined!=_this.m_cfgPanel){_this.m_cfgPanel.close();}
var curTar=$(e.currentTarget);_this.m_selectItemId=curTar.closest('.treeRow').get(0).id;_this.m_selectGroupId=curTar.closest('.tree-group').get(0).id;var customName,ptDesc,ptName,item,prjId;for(var i=0,len=_this.m_allPointList.length;i<len;i++){item=_this.m_allPointList[i];if(itemId===item.itemId){customName=item.customName;ptName=item.ptName;ptDesc=item.ptDesc;prjId=item.prjId;break;}}
WebAPI.get('/static/views/observer/dataSourceAdd.html').done(function(result){_this.m_cfgPanel=new DataSourceConfigure(_this,1,false,customName,ptName,ptDesc,prjId);_this.m_cfgPanel.show();}).fail(function(result){}).always(function(e){});});btnCfg.mouseenter(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit_hover.png');btnCfg.css('width','18px');btnCfg.css('height','18px');}).error(function(e){});btnCfg.mouseleave(function(e){btnCfg.attr('src','/static/images/dataSource/item_edit.png');btnCfg.css('width','16px');btnCfg.css('height','16px');}).error(function(e){});div.append(btnCfg);}
EventAdapter.on($(div),'click',function(e){var divContain=$('#dataSrcPanel');divContain.find('.dsTreeBtnCfg').css('display','none');divContain.find('.dsTreeBtnRemove').css('display','none');var curTarItem=$(e.currentTarget);curTarItem.find('.dsTreeBtnCfg').css('display','inline');curTarItem.find('.dsTreeBtnRemove').css('display','inline');_this.m_selectGroupId=curTarItem.closest('.tree-group').get(0).id;});$ul.find('.rows').append(div);if(bIsPoint){var prjName=_this.getProjectNameFromId(pointList[j].prjId,_this.m_langFlag);_this.initToolTips(div,pointList[j].customName,prjName,pointList[j].ptName,pointList[j].ptDesc);}
else{var showName=_this.getShowNameFromFormula(pointList[j].ptName);_this.initFormulaToolTips(div,pointList[j].customName,showName,pointList[j].ptDesc);}}}
if(''==searchPointName){divContain.append($ul);}
else{if(bHasSearched){divContain.append($ul);}}}},getDSItemById:function(datasourceItemId){if(undefined!=this.m_parent.store.group){var itemGroup,lenItem;for(var i=0,len=this.m_parent.store.group.length;i<len;i++){itemGroup=this.m_parent.store.group[i];lenItem=itemGroup.datasourceList.length;for(var j=0;j<lenItem;j++){if(datasourceItemId==itemGroup.datasourceList[j].id){return itemGroup.datasourceList[j];}}}}
if(undefined!=this.m_parent.store.dsInfoList){var itemInfo;for(var i=0,len=this.m_parent.store.dsInfoList.length;i<len;i++){itemInfo=this.m_parent.store.dsInfoList[i];if(datasourceItemId==itemInfo.id){return itemInfo;}}}
return{};},getDSItemData:function(target,arrDSItemIds){var _this=this.m_parent;var tmStart=_this.curModal.startTime.toDate();var tmEnd=_this.curModal.endTime.toDate();var tmFmt=_this.curModal.format;var key;var preloadIds=[];var row=null,arrId;var ids=arrDSItemIds.concat();var postData={dsItemIds:ids,timeStart:tmStart.format('yyyy-MM-dd HH:mm:ss'),timeEnd:tmEnd.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt};var promise=$.Deferred();Beop.cache.ds.getBatch(ids,tmFmt,tmStart,tmEnd).done(function(rs){promise.resolve(rs);}).fail(function(e){console.warn(e);promise.reject();});promise.always(function(rs){var idsNotFound,cacheData;if(rs){idsNotFound=rs.idsNotFound;cacheData=rs.data;if(idsNotFound.length>0){postData.dsItemIds=idsNotFound;}else{target.spinnerStop();target.renderModal(cacheData);return;}}
WebAPI.post('/analysis/startWorkspaceDataGenHistogram',postData).done(function(result){var data=JSON.parse(result);if(data.error&&data.error.length>0){target.errAlert(data.error);target.spinnerStop();return;}
Beop.cache.ds.set(data,tmFmt,tmStart,tmEnd).done(function(){if(cacheData!==null){data={list:data.list.concat(cacheData.list),timeShaft:data.timeShaft};}}).fail(function(e){console.warn(e);}).always(function(){target.renderModal(data);});}).error(function(e){_this.paneCenter.spinnerStop();_this.alertNoData();});});},getDSItemDataMulti:function(target,arrDSItemIds){var _this=this.m_parent;_this.curModal.arrComparePeriodLabel=[];var tmStart=_this.curModal.startTime;tmStart=tmStart.length<=10?tmStart+' 00:00:00':tmStart;var tmEnd=_this.curModal.endTime;tmEnd=tmEnd.length<=10?tmEnd+' 00:00:00':tmEnd;var tmFmt=_this.curModal.format;var comparePeriod=_this.curModal.comparePeriod;var period1,period2,time;var startDate=new Date(tmStart);var endDate=new Date(tmEnd);var compareDateI18n=I18n.resource.analysis.historyCompare;if(comparePeriod=='hour'){time=3600000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1)+'-'+startDate.getDate()+' '+startDate.getHours()+':00');_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1)+'-'+endDate.getDate()+' '+endDate.getHours()+':00');}
if(comparePeriod=='day'){time=86400000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1)+'-'+startDate.getDate());_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1)+'-'+endDate.getDate());}
if(comparePeriod=='week'){time=604800000;period1=new Date(startDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');period2=new Date(endDate.getTime()+time).format('yyyy-MM-dd HH:mm:ss');_this.curModal.arrComparePeriodLabel.push(compareDateI18n.YEAR_WEEK.replace('<%year%>',startDate.getFullYear()).replace('<%week%>',getWeekNumber(tmStart)));_this.curModal.arrComparePeriodLabel.push(compareDateI18n.YEAR_WEEK.replace('<%year%>',endDate.getFullYear()).replace('<%week%>',getWeekNumber(tmEnd)));}
if(comparePeriod=='month'){period1=getCurrentMonthLastDay(tmStart);period2=getCurrentMonthLastDay(tmEnd);function getCurrentMonthLastDay(date){var current=date.toDate();var currentMonth=current.getMonth();var nextMonth=++currentMonth;var nextMonthDayOne=new Date(current.getFullYear(),nextMonth,1);return new Date(nextMonthDayOne.getTime());}
_this.curModal.arrComparePeriodLabel.push(startDate.getFullYear()+'-'+(startDate.getMonth()+1));_this.curModal.arrComparePeriodLabel.push(endDate.getFullYear()+'-'+(endDate.getMonth()+1));}
var postData=[{dsItemIds:arrDSItemIds,timeStart:tmStart.format('yyyy-MM-dd HH:mm:ss'),timeEnd:period1.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt},{dsItemIds:arrDSItemIds,timeStart:tmEnd.format('yyyy-MM-dd HH:mm:ss'),timeEnd:period2.format('yyyy-MM-dd HH:mm:ss'),timeFormat:tmFmt}];var ItemKey='anal_'+tmFmt+'_'+arrDSItemIds[0];WebAPI.post('/analysis/startWorkspaceDataGenHistogramMulti',postData).done(function(result){var data=JSON.parse(result);if(data.error&&data.error.length>0){target.errAlert(data.error);target.spinnerStop();return;}
sessionStorage.setItem(ItemKey,result);target.renderModal(data);}).error(function(e){_this.paneCenter.spinnerStop();_this.alertNoData();});function isLeapYear(year){return(year%400==0)||(year%4==0&&year%100!=0);}
function getMonthDays(year,month){return[31,null,31,30,31,30,31,31,30,31,30,31][month]||(isLeapYear(year)?29:28);}
function getWeekNumber(date){var now=date.toDate(),year=now.getFullYear(),month=now.getMonth(),days=now.getDate();for(var i=0;i<month;i++){days+=getMonthDays(year,i);}
var yearFirstDay=new Date(year,0,1).getDay()||7;var week=null;if(yearFirstDay==1){week=Math.ceil(days/yearFirstDay);}else{days-=(7-yearFirstDay+1);week=Math.ceil(days/7)+1;}
return week;}},getShowNameFromFormula:function(formula){var _this=this;var inputStr=formula;var nStart=inputStr.indexOf('<%');var nEnd=inputStr.indexOf('%>');if(-1==nStart||-1==nEnd){return inputStr;}
var id=inputStr.substring(nStart+2,nEnd);if(''==id){return _this.getShowNameFromFormula(inputStr);}
var retVal=_this.getDSItemById(id);if(null==retVal){return _this.getShowNameFromFormula(inputStr);}
inputStr=inputStr.replace('<%'+id+'%>',retVal.value);return _this.getShowNameFromFormula(inputStr);},addNewGroup:function(){var groupName=$('#inputAddGroup').val();if(''==groupName){return;}
var _this=this;var postData={'groupId':'','name':groupName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){var data=JSON.parse(result);if(!data){return;}
var groupId=data.groupId;if(groupId){var bIsFind=false;for(var i=0,len=_this.m_allGroupList.length;i<len;i++){if(groupId===_this.m_allGroupList[i].id){bIsFind=true;break;}}
if(!bIsFind){_this.m_allGroupList.push({'id':groupId,'name':data.groupName,'isDefault':false});var ulCnt=$('#dataSrcPanel').find('ul').length;if(ulCnt>1){var defaultGroup=$('#dataSrcPanel ul[isDefault=true]').eq(0);if(defaultGroup&&defaultGroup.length>0){_this.insertTreeGroup(data.groupId,data.groupName,1,defaultGroup.prev());}
else{_this.insertTreeGroup(data.groupId,data.groupName,0,null);}}
else{var defaultGroup=$('#dataSrcPanel ul[isDefault=true]').eq(0);if(defaultGroup&&defaultGroup.length>0){_this.insertTreeGroup(data.groupId,data.groupName,2,defaultGroup.prev());}
else{_this.insertTreeGroup(data.groupId,data.groupName,0,null);}}
$('#'+data.groupId).find('.dsTreeHeader').click();}
$('#inputAddGroup').val('');}}).fail(function(result){}).always(function(e){});}}
return DataSource;})();var modalConfigurePane=(function(){var _this;function modalConfigurePane(container,screen,modalType){_this=this;this.container=container;this.screen=screen;this.modalType=modalType;this.templateObj=undefined;this.optionType=undefined;this.option=undefined;this.dataLose=undefined;this.editorData=undefined;this.ue=undefined;}
modalConfigurePane.prototype={show:function(){WebAPI.get("/static/views/observer/widgets/modalConfigurePane.html").done(function(resultHtml){_this.container.innerHTML+=resultHtml;if(_this.modalType=="dataAnalysis"){document.getElementById('startConfig').setAttribute('i18n','modalConfig.btnStartConfig.TYPE1');}else if(_this.modalType=="dashboard"){document.getElementById('startConfig').setAttribute('i18n','modalConfig.btnStartConfig.TYPE2');}
I18n.fillArea($('#modalConfig'));});},showModalInit:function(optionType,option,templateObj){this.optionType=optionType;this.option=option;this.templateObj=templateObj;this.init();if(_this.option.templateType=="ModalNote"){_this.initEditor();}
$('#modalConfig').modal('show');},init:function(){var $modalConfig=$('#modalConfig');$modalConfig.off('show.bs.modal').on('show.bs.modal',function(e){if(e.namespace!=='bs.modal')return true;_this.initOption();_this.initConfigData();$('#inputAddGroup').click(function(e){$(e.target).focus();});if(_this.modalType=="dashboard"){_this.toggleDataSource(true);}});$modalConfig.off('shown.bs.modal').on('shown.bs.modal',function(){_this.initTime();_this.initDrag();_this.initConfigStart();});$modalConfig.off('hidden.bs.modal').on('hidden.bs.modal',function(){$modalConfig.find('#dataConfig').html('<div><span I18n="modalConfig.data.DATA_CONFIG_TITLE"></span></div>');I18n.fillArea($modalConfig.find('#dataConfig'));if(_this.modalType=="dashboard"){_this.toggleDataSource(false);}
$('#divChartPointCog').css('display','none');_this.dataLose=undefined;});},toggleDataSource:function(bool){var colCount=$('#paneContent')[0].classList.contains('col-sm-10');if(bool&&colCount){document.getElementById('rightCt').click();}
if(!bool&&!colCount){document.getElementById('rightCt').click();}},initDataTypeWidth:function(ele){if(window.innerWidth>1200){if(ele.outerWidth()<ele.parent().outerWidth()/4){ele.addClass('col-lg-3');}else if(ele.outerWidth()<ele.parent().outerWidth()/2){ele.addClass('col-lg-6');}else if(ele.outerWidth()<ele.parent().outerWidth()*3/4){ele.addClass('col-lg-9');}else{ele.addClass('col-lg-12');}}else{if(ele.outerWidth()<ele.parent().outerWidth()/3){ele.addClass('col-xs-4');}else if(ele.outerWidth()<ele.parent().outerWidth()*2/3){ele.addClass('col-xs-8');}else{ele.addClass('col-xs-12');}}},initOption:function(){var $inputMode=$('#inputMode');var $divMode=$inputMode.parent();var $inputInterval=$('#inputInterval');var $divInterval=$inputInterval.parent();var $divInputGroupPeriod=$('#divInputGroupPeriod');var $divPeriod=$divInputGroupPeriod.parent();var $inputPeriodUnit=$('#inputPeriodUnit');var $inputPeriodValue=$('#inputPeriodValue');var $inputPeriodDropDown=$('#inputPeriodDropDown');var $divPeriodDropDown=$inputPeriodDropDown.parent();var $divInputGroupTimeRange=$('#divInputGroupTimeRange');var $divTimeRange=$divInputGroupTimeRange.parent();var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');var $gaugeMode=$('#gaugeMode');var $divGaugeMode=$gaugeMode.parent();var $divGauge=$('#divGauge');var $gaugeLowerLimit=$('#gaugeLowerLimit');var $gaugeUpperLimit=$('#gaugeUpperLimit');var $normalLowerLimit=$('#normalLowerLimit');var $normalUpperLimit=$('#normalUpperLimit');var $inputComparePeriod=$('#inputComparePeriod');var $divComparePeriod=$inputComparePeriod.parent();var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');var $divCompareDate=$('#divCompareDate');var $inputRealTimeInterval=$('#inputRealTimeInterval');var $divRealTimeInterval=$inputRealTimeInterval.parent();var $divHistoryRange=$('#divHistoryRange');var $inputHistoryRange=$('#inputHistoryRange');var $divChartSelect=$('#divChartSelect');var i;var totalModeType={easy:[$divPeriodDropDown],fixed:[$divInterval,$divTimeRange],recent:[$divInterval,$divPeriod],realTime:[],easyEnergy:[$divPeriodDropDown],realTimeDashboard:[$divRealTimeInterval],easyCompareAnalyz:[$divCompareDate],easyCompare:[$divComparePeriod],compareSensor:[$divInterval,$divComparePeriod,$divCompareDate],compareMeter:[$divInterval,$divComparePeriod,$divCompareDate],gauge:[$divGauge,$divGaugeMode],weather:[],easyHistory:[$divHistoryRange],easyHistorySelect:[$divHistoryRange,$divChartSelect],multiple:[$divRealTimeInterval],modalRankNormal:[$divPeriodDropDown]};var $dataConfig=$('#dataConfig');var $startConfig=$('#startConfig');$dataConfig.css('display','block');$startConfig.removeClass('alwaysEnable');$inputMode.children().css('display','none');var modeSelectInit=false;for(i=0;i<_this.option.modeUsable.length;i++){$inputMode.children('option[value='+_this.option.modeUsable[i]+']').css('display','block');if(_this.optionType){if(sessionStorage.getItem('mode')==_this.option.modeUsable[i]&&!modeSelectInit){$inputMode.val(_this.option.modeUsable[i]);modeSelectInit=true;}}else{if(_this.option.modeUsable[i]=='fixed'&&!modeSelectInit){$inputMode.val('fixed');modeSelectInit=true;}}}
if(!modeSelectInit){$inputMode.val(_this.option.modeUsable[0]);}
function initMode(mode){sessionStorage.setItem('mode',$inputMode.val());$divMode.siblings().css('display','none');$inputInterval.children().removeClass('forbid');for(var i=0;i<totalModeType[mode].length;i++){totalModeType[mode][i].css('display','block');}
switch(mode){case'easy':initPeriodDropDown(mode);initInterval(mode);break;case'recent':initInterval(mode);break;case'easyEnergy':initPeriodDropDown(mode);initInterval(mode);break;case'weather':$dataConfig.css('display','none');$startConfig.addClass('alwaysEnable');break;case'easyCompareAnalyz':$inputComparePeriod.val('month');break;case'easyCompare':$inputComparePeriod.val('day');break;default:break;}}
if(this.optionType){if(sessionStorage.getItem('interval')!=null){if($inputInterval.children('option[value="'+sessionStorage.getItem('interval')+'"]').hasClass('forbid')){$inputInterval.val($inputInterval.children(':not(.forbid)').first());}else{$inputInterval.val(sessionStorage.getItem('interval'));}}else{sessionStorage.setItem('interval',$inputInterval.val());}}else{if(_this.option.optionPara.interval){$inputInterval.val(_this.option.optionPara.interval);}else{$inputInterval.val($inputInterval.children(':not(.forbid)').first());}}
$inputInterval.off('change').change(function(e){sessionStorage.setItem('interval',$(e.target).val());});function initInterval(mode){$inputInterval.children().addClass('forbid');if(mode=='recent'){switch($inputPeriodUnit.children(':selected').val()){case'second':firstSelect='m5';secondSelect='m1';break;case'minute':firstSelect='m5';secondSelect='m1';break;case'hour':firstSelect='h1';secondSelect='m5';break;case'day':firstSelect='d1';secondSelect='h1';break;case'month':firstSelect='M1';secondSelect='d1';break;}
$inputInterval.find('option[value="'+secondSelect+'"]').removeClass('forbid');}
if(mode=='easy'){switch($inputPeriodDropDown.val()){case'today':firstSelect='h1';break;case'yesterday':firstSelect='h1';break;case'thisWeek':firstSelect='d1';break;case'lastWeek':firstSelect='d1';break;case'thisYear':firstSelect='M1';break;}}
$inputInterval.find('option[value="'+firstSelect+'"]').removeClass('forbid').attr('selected',true);sessionStorage.setItem('interval',$inputInterval.val());}
var firstSelect,secondSelect;if(this.optionType){if(sessionStorage.getItem('periodValue')){$inputPeriodValue.val(sessionStorage.getItem('periodValue'));}
if(sessionStorage.getItem('periodUnit')){$inputPeriodUnit.val(sessionStorage.getItem('periodUnit'));}
if(sessionStorage.getItem('periodDropDown')){if($inputPeriodDropDown.children('option[value="'+sessionStorage.getItem('periodDropDown')+'"]').hasClass('forbid')){$inputPeriodDropDown.val($inputPeriodDropDown.children(':not(.forbid)').first());}
$inputPeriodDropDown.val(sessionStorage.getItem('periodDropDown'));}}
$inputPeriodValue.off('change').change(function(e){sessionStorage.setItem('periodValue',e.target.value)});$inputPeriodUnit.off('change').change(function(e){sessionStorage.setItem('periodUnit',e.target.value);initInterval($inputMode.val());});$divPeriodDropDown.off('change').change(function(e){sessionStorage.setItem('periodDropDown',e.target.value);initInterval($inputMode.val());});function initPeriodDropDown(mode){$inputPeriodDropDown.children('').removeClass('forbid');if(mode=='easy'){$inputPeriodDropDown.children().eq(1).addClass('forbid');}else if(mode=='easyEnergy'){$inputPeriodDropDown.children().eq(2).addClass('forbid');$inputPeriodDropDown.children().eq(4).addClass('forbid');$inputPeriodDropDown.children().eq(5).addClass('forbid');}}
if(_this.optionType&&sessionStorage.getItem('anlzTimeStart')!=null){$inputTimeStart.val(sessionStorage.getItem('anlzTimeStart'));$inputCompareDate1.val(sessionStorage.getItem('anlzTimeStart'));}else{$inputTimeStart.val(_this.option.optionPara.startTime);$inputCompareDate1.val(_this.option.optionPara.startTime);}
$inputTimeStart.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeStart',e.target.value)}});$inputCompareDate1.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeStart',e.target.value)}});if(_this.optionType&&sessionStorage.getItem('anlzTimeEnd')!=null){$inputTimeEnd.val(sessionStorage.getItem('anlzTimeEnd'));$inputCompareDate2.val(sessionStorage.getItem('anlzTimeEnd'));}else{$inputTimeEnd.val(_this.option.optionPara.endTime);$inputCompareDate2.val(_this.option.optionPara.endTime);}
$inputTimeEnd.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeEnd',e.target.value)}});$inputCompareDate2.off('change').change(function(e){if(e.target.value!=''){sessionStorage.setItem('anlzTimeEnd',e.target.value)}});if(_this.option.optionPara.timeType&&$inputMode.val()=='easyCompareAnalyz'){$inputComparePeriod.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('comparePeriodAnalyz')!=null){$inputComparePeriod.val(sessionStorage.getItem('comparePeriodAnalyz'));}
if(_this.option.optionPara.timeType&&$inputMode.val()=='easyCompare'){$inputComparePeriod.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('comparePeriod')!=null){$inputComparePeriod.val(sessionStorage.getItem('comparePeriod'));}
$inputComparePeriod.change(function(e){sessionStorage.setItem('comparePeriod',$inputComparePeriod.val());});if(sessionStorage.getItem('gaugeMode')!=null){$gaugeMode.val(sessionStorage.getItem('gaugeMode'))}
$gaugeMode.change(function(){sessionStorage.setItem('gaugeMode',$gaugeMode.val())});initGaugeMode();$gaugeMode.change(function(){initGaugeMode();});function initGaugeMode(){var green='<span class="input-group-addon gaugeGreen" i18n="modalConfig.option.GAUGE_GREEN"></span>';var red='<span class="input-group-addon gaugeRed" i18n="modalConfig.option.GAUGE_RED"></span>';if($gaugeMode.val()=='high'){$gaugeLowerLimit.next().remove();$gaugeLowerLimit.after(green);$normalUpperLimit.next().remove();$normalUpperLimit.after(red);}else if($gaugeMode.val()=='low'){$gaugeLowerLimit.next().remove();$gaugeLowerLimit.after(red);$normalUpperLimit.next().remove();$normalUpperLimit.after(green);}
I18n.fillArea($('#divGauge'));}
if(_this.option.optionPara.scaleList){_this.option.optionPara.scaleList.sort(function(a,b){return a>b?1:-1});}
if(_this.optionType&&sessionStorage.getItem('gaugeLowerLimit')!=null){$gaugeLowerLimit.val(sessionStorage.getItem('gaugeLowerLimit'))}else if(!_this.optionType&&_this.option.optionPara.scaleList){$gaugeLowerLimit.val(_this.option.optionPara.scaleList[0])}
$gaugeLowerLimit.change(function(){sessionStorage.setItem('gaugeLowerLimit',$gaugeLowerLimit.val())});if(_this.optionType&&sessionStorage.getItem('gaugeUpperLimit')!=null){$gaugeUpperLimit.val(sessionStorage.getItem('gaugeUpperLimit'))}else if(!_this.optionType&&_this.option.optionPara.scaleList){$gaugeUpperLimit.val(_this.option.optionPara.scaleList[3])}
$gaugeUpperLimit.change(function(){sessionStorage.setItem('gaugeUpperLimit',$gaugeUpperLimit.val())});if(_this.optionType&&sessionStorage.getItem('normalLowerLimit')!=null){$normalLowerLimit.val(sessionStorage.getItem('normalLowerLimit'))}else if(!_this.optionType&&_this.option.optionPara.scaleList){$normalLowerLimit.val(_this.option.optionPara.scaleList[1])}
$normalLowerLimit.change(function(){sessionStorage.setItem('normalLowerLimit',$normalLowerLimit.val())});if(_this.optionType&&sessionStorage.getItem('normalUpperLimit')!=null){$normalUpperLimit.val(sessionStorage.getItem('normalUpperLimit'))}else if(!_this.optionType&&_this.option.optionPara.scaleList){$normalUpperLimit.val(_this.option.optionPara.scaleList[2])}
$normalUpperLimit.change(function(){sessionStorage.setItem('normalUpperLimit',$normalUpperLimit.val())});if(_this.option.optionPara.timeType&&($inputMode.val()=='realTimeDashboard'||$inputMode.val()=='multiple')){$inputHistoryRange.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('historyRange')!=null){$inputHistoryRange.val(sessionStorage.getItem('historyRange'));}
$inputHistoryRange.change(function(){sessionStorage.setItem('historyRange',$inputHistoryRange.val());});if(_this.option.optionPara.timeType&&($inputMode.val()=='easyHistory'||$inputMode.val()=='easyHistorySelect')){$inputHistoryRange.val(_this.option.optionPara.timeType);}else if(sessionStorage.getItem('historyRange')!=null){$inputHistoryRange.val(sessionStorage.getItem('historyRange'));}
$inputHistoryRange.change(function(){sessionStorage.setItem('historyRange',$inputHistoryRange.val());})
initMode($inputMode.val());$inputMode.change(function(e){initMode($inputMode.val())});if('AnlzTendency'==this.option.templateType){$('#dataConfig').css('height','100%');$('#modifyChart').show();var opt=_this.screen.curModal.chartOption;if(opt){$('#modifyChartTitle').val(opt.chartName);$('#modifyChartYMax').val(opt.yMax);$('#modifyChartYMin').val(opt.yMin);$('#modifyChartYMark').val(opt.yMark);var yUnit=opt.yUnit;var flag=' ';var index=yUnit.indexOf(flag);$('#modifyChartYUnitName').val(yUnit.substr(0,index));$('#modifyChartYUnitEx').val(yUnit.substr(index+1));}}
else{$('#dataConfig').css('height','350px');$('#modifyChart').hide();}},initConfigData:function(){var $dataConfig=$('#dataConfig');$dataConfig.html('<div><span I18n="modalConfig.data.DATA_CONFIG_TITLE"></span></div>');var strConfigModalBody=$dataConfig.html();var strDataTypeShowName=[];if(_this.option.rowDataTypeShowName){for(var i=0;i<_this.option.rowDataType.length;++i){strDataTypeShowName.push(_this.option.rowDataTypeShowName[_this.option.rowDataType[i]])}}else{strDataTypeShowName=_this.option.rowDataType;}
for(var i=0;i<_this.option.rowDataType.length;++i){strConfigModalBody+='<div class="divConfigData" dataType="'+_this.option.rowDataType[i]+'">\
                                                <div class="dataTypeName">'+
strDataTypeShowName[i]+'</div>\
                                                <span class="chartPointCog glyphicon glyphicon-cog grow"></span>\
                                                <div class="row rowDataValue"><div class="dataDragTip col-lg-3 col-xs-4"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></div></div>\
                                    </div>';}
$dataConfig.html(strConfigModalBody);var btnStartConfigEnable;for(i=0;i<_this.option.optionPara.dataItem.length;++i){var $dataDragTip=$dataConfig.find('[dataType="'+_this.option.optionPara.dataItem[i].dsType+'"]').find('.dataDragTip');if($dataDragTip.length==0){$dataDragTip=$('.dataDragTip').eq(i);}
var strDSConfig;var loseJudge;for(var j=0;j<_this.option.optionPara.dataItem[i].dsId.length;++j){loseJudge="ptExist";if(_this.option.optionPara.dataItem[i].dsName[j]==undefined){_this.option.optionPara.dataItem[i].dsName[j]=I18n.resource.modalConfig.data.DATA_LOSE;_this.dataLose=true;loseJudge="ptLose";}
strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow '+loseJudge+'" dsid="'+_this.option.optionPara.dataItem[i].dsId[j]+'"><span class="contentDS" title="'+_this.option.optionPara.dataItem[i].dsName[j]+'">'+
_this.option.optionPara.dataItem[i].dsName[j]+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig);btnStartConfigEnable=true;}}
if(_this.modalType=="dataAnalysis"){$('.chartPointCog').css('display','none');}else if(_this.modalType=="dashboard"){$('.chartPointCog').css('display','');}
$dataConfig.off('click').on('click','.chartPointCog',function(e){$('#divChartPointCog').css('display','block');_this.initChartPtCog($('.chartPointCog').index($(e.target)))});if(_this.dataLose){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE11+"</strong>").show().close();}
initDataTipAndButton();$('.alwaysEnable').removeClass('disabled');$('.divDSConfigure span').on('click',function(e){var $thisPar=$(e.target).parent();$thisPar.remove();if($('.ptLose').length==0){_this.dataLose=false;}
initDataTipAndButton();$('#dataConfig').css('height','100%');});function initDataTipAndButton(){var NumOfDataTypeWithValue=0;var $rowDataValue=$('.rowDataValue');for(var i=0;i<$rowDataValue.length;++i){if($rowDataValue.eq(i).children().length>1){NumOfDataTypeWithValue+=1;}}
if(_this.option.allDataNeed==true){if(NumOfDataTypeWithValue==$rowDataValue.length){$('#startConfig').removeClass('disabled');}else{$('#startConfig').addClass('disabled');}}else{if(NumOfDataTypeWithValue){$('#startConfig').removeClass('disabled');}else{$('#startConfig').addClass('disabled');}}
if(_this.dataLose){$('#startConfig').addClass('disabled');}
if(_this.templateObj&&_this.templateObj.entity.modal.type=='ModalNote'){$('#startConfig').removeClass('disabled');}}
_this.renderEditor();},initChartPtCog:function(index){var $inputUpper=$('#inputPtValUpper');var $inputLower=$('#inputPtValLower');var $inputUnit=$('#inputPtUnit');var $inputAccuracy=$('#inputPtAccuracy');var $inputLineVal1=$('#inputLineVal1');var $inputLineName1=$('#inputLineName1');var $inputLineVal2=$('#inputLineVal2');var $inputLineName2=$('#inputLineName2');var $inputLineVal3=$('#inputLineVal3');var $inputLineName3=$('#inputLineName3');var $inputLineVal4=$('#inputLineVal4');var $inputLineName4=$('#inputLineName4');var $inputLineNameTotal=$('.inputLineName');var $inputLineValTotal=$('.inputLineVal');if(_this.option.dsChartCog&&_this.option.dsChartCog[index]){$inputUpper.val(_this.option.dsChartCog[index].upper);$inputLower.val(_this.option.dsChartCog[index].lower);$inputUnit.val(_this.option.dsChartCog[index].unit);$inputAccuracy.val(_this.option.dsChartCog[index].accuracy);for(var i=0;i<4;i++){$inputLineNameTotal.eq(i).val(_this.option.dsChartCog[index].markLine[i].name);$inputLineValTotal.eq(i).val(_this.option.dsChartCog[index].markLine[i].value);}}else{$('#divChartPointCog').find('input').val('');}
$('#btnPtCogSure').off('click').click(function(){if(!_this.option.dsChartCog){_this.option.dsChartCog=[];for(var i=0;i<_this.option.rowDataType.length;++i){_this.option.dsChartCog[i]={};_this.option.dsChartCog[i].markLine=[{},{},{},{}];}}
if(isNaN(Number($inputUpper.val()))||isNaN(Number($inputLower.val()))||isNaN(Number($inputAccuracy.val()))||isNaN(Number($inputLineVal1.val()))||isNaN(Number($inputLineVal2.val()))||isNaN(Number($inputLineVal3.val()))||isNaN(Number($inputLineVal4.val()))){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE10+"</strong>").show().close();return;}
if($inputUpper.val()!=''&&$inputLower.val()!=''&&Number($inputUpper.val())<Number($inputLower.val())){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE12+"</strong>").show().close();return;}
_this.option.dsChartCog[index].upper=$inputUpper.val();_this.option.dsChartCog[index].lower=$inputLower.val();_this.option.dsChartCog[index].unit=$inputUnit.val();_this.option.dsChartCog[index].accuracy=$inputAccuracy.val();for(var i=0;i<4;++i){if(!_this.option.dsChartCog[index].markLine[i]){_this.option.dsChartCog[index].markLine[i]={}}
_this.option.dsChartCog[index].markLine[i].value=$inputLineValTotal.eq(i).val();_this.option.dsChartCog[index].markLine[i].name=$inputLineNameTotal.eq(i).val();}
$('#divChartPointCog').css('display','none');});$('#btnPtCogCancel').off('click').click(function(){$inputUpper.val('');$inputLower.val('');$inputUnit.val('');$inputAccuracy.val('');$('#divChartPointCog').css('display','none');});$('#btnPtCogRemove').off('click').click(function(){$inputUpper.val('');$inputLower.val('');$inputUnit.val('');$inputAccuracy.val('');$('#divChartPointCog').css('display','none');});},initTime:function(){var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');$inputTimeStart.datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:true,todayBtn:true,initialDate:new Date()});$inputTimeEnd.datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:true,todayBtn:true,initialDate:new Date()});var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');$inputCompareDate1.datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:true,todayBtn:true,initialDate:new Date()});$inputCompareDate2.datetimepicker({format:"yyyy-mm-dd hh:ii",minView:"hour",autoclose:true,todayBtn:true,initialDate:new Date()});if(_this.optionType){var now=new Date();var time=new Date(now-259200000).format('yyyy-MM-dd HH:mm');var initCompareDate1=new Date(now.getFullYear(),now.getMonth()-2).format('yyyy-MM-dd HH:mm');var initCompareDate2=new Date(now.getFullYear(),now.getMonth()-1).format('yyyy-MM-dd HH:mm');if(!sessionStorage.getItem('anlzTimeStart')){$inputTimeStart.val(time);$inputCompareDate1.val(initCompareDate1)}
now=now.format('yyyy-MM-dd HH:mm');if(!sessionStorage.getItem('anlzTimeEnd')){$inputTimeEnd.val(now);$inputCompareDate2.val(initCompareDate2)}}},initDrag:function(){var $divConfigData=$('.divConfigData');var $btnConfigStart=$('#startConfig');var _this=this;$divConfigData.on('dragover',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');});$divConfigData.on('dragleave',function(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');});var targetId,targetContent;var initBtnStartEnable;var initDragTipShow=[];var index;$divConfigData.on('drop',function(e,arg){$('.addData').removeClass('addData');var $note=$('#noteEditor');if(!$note.is(':hidden')&&!arg){return;}
index=$(e.currentTarget).index()-1;var $rowTempData=$(e.currentTarget).find('.rowDataValue');var $dataDragTip=$rowTempData.find('.dataDragTip');targetId=EventAdapter.getData().dsItemId;if(!targetId)return;targetContent=AppConfig.datasource.getDSItemById(targetId).alias;if($rowTempData.find('.divDSConfigure[dsid="'+targetId+'"]').length>0){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE2+"</strong>").show().close();return;}
var strDSConfig='<div class="col-lg-3 col-xs-4 divDSConfigure grow" dsid="'+targetId+'"><span class="contentDS" title="'+targetContent+'">'+
targetContent+'</span><span class="glyphicon glyphicon-remove btnRemoveDS" aria-hidden="true" ></span></div>';$dataDragTip.before(strDSConfig);initBtnStartAndDragTip(index);$(e.currentTarget).find('.divDSConfigure span').last().on('click',function(e){var $thisPar=$(e.target).parent();var dsid=$thisPar.attr('dsid');$thisPar.remove();if($('.ptLose').length==0){_this.dataLose=false;}
initBtnStartAndDragTip(index);var $dataConfig=$('#dataConfig');$dataConfig.css('height','100%');});var $dataConfig=$('#dataConfig');if('AnlzTendency'!=_this.option.templateType){$dataConfig.height('');}
if($dataConfig.height()>window.innerHeight-80){$dataConfig.css('height','100%');}
if(!$note.is(':hidden')&&arg){var format='&nbsp;<span id = "'+targetId+'" contenteditable="false" class="pointValue" title="'+targetContent+'"><%'+targetContent+'%></span>&nbsp;';insertHtmlAtCaret(format,targetId);function insertHtmlAtCaret(html,targetId){var sel,range;var iframeWin=document.querySelector('iframe').contentWindow;if(iframeWin.getSelection){sel=iframeWin.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var el=document.createElement("div");el.innerHTML=html;var frag=document.createDocumentFragment(),node,lastNode;while((node=el.firstChild)){lastNode=frag.appendChild(node);}
range.insertNode(frag);if(lastNode){range=range.cloneRange();range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range);}
$(iframeWin.document).find('#'+targetId)[0].addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);_this.$editor.find('#'+targetId).off('click').on('click',function(e){_this.initNotePtCfg(_this.$editor.find('.pointValue').index($(e.target)));});}}}}});function initBtnStartAndDragTip(indexOfDataType){var tempDivDS=$divConfigData.find('.rowDataValue').eq(indexOfDataType).children();if(_this.option.allDataNeed==true){initBtnStartEnable=true;for(var i=0;i<$divConfigData.length;++i){if($divConfigData.find('.rowDataValue').eq(i).children().length<=1){initBtnStartEnable=false;break;}}
if(tempDivDS.length>1){}else{initBtnStartEnable-=1;initDragTipShow[indexOfDataType]=true;}}else{if($divConfigData.find('.divDSConfigure').length>0){initBtnStartEnable=true;}else{initBtnStartEnable=false;}}
if(initBtnStartEnable>0){$btnConfigStart.removeClass('disabled');}else{$btnConfigStart.addClass('disabled');}
if(_this.dataLose){$btnConfigStart.addClass('disabled');}}},initConfigStart:function(){var $modalConfig=$('#modalConfig');var $inputModal=$('#inputMode');document.getElementById('startConfig').onclick=function(){var tempStartTime,tempEndTime,tempPeriodTime;var tempInterval=0;var $inputPeriodValue=$('#inputPeriodValue');var periodValue=$inputPeriodValue.val();var tempDSId,tempDS,arrItemDS=[];var $rowDataValue=$('.rowDataValue');var $inputInterval=$('#inputInterval');var $inputTimeStart=$('#inputTimeStart');var $inputTimeEnd=$('#inputTimeEnd');var $inputPeriodUnit=$('#inputPeriodUnit');var $inputPeriodDropDown=$('#inputPeriodDropDown');var $inputCompareDate1=$('#inputCompareDate1');var $inputCompareDate2=$('#inputCompareDate2');var $inputComparePeriod=$('#inputComparePeriod');var $gaugeMode=$('#gaugeMode');var $gaugeLowerLimit=$('#gaugeLowerLimit');var $gaugeUpperLimit=$('#gaugeUpperLimit');var $normalLowerLimit=$('#normalLowerLimit');var $normalUpperLimit=$('#normalUpperLimit');var $inputRealTimeInterval=$('#inputRealTimeInterval');var $inputHistoryRange=$('#inputHistoryRange');var timeType,scaleList;var now;for(var i=0;i<$rowDataValue.length;++i){tempDS={};tempDS.type=$rowDataValue[i].parentNode.getAttribute('dataType');tempDSId=[];for(var j=0;j<$rowDataValue[i].children.length-1;++j){tempDSId.push($rowDataValue[i].children[j].getAttribute('dsid'));}
tempDS.arrId=tempDSId;arrItemDS.push(tempDS);}
var totalModeType={easy:'easy',fixed:'fixed',recent:'recent',realTime:'realTime',easyCompareAnalyz:'easyCompareAnalyz',easyCompare:'easyCompare',compareSensor:'compareSensor',compareMeter:'compareMeter',realTimeDashboard:"realTimeDashboard",gauge:'gauge',weather:'weather',easyHistory:"easyHistory",easyHistorySelect:"easyHistorySelect",multiple:'multiple'};switch($inputModal.val()){case totalModeType['fixed']:tempStartTime=$inputTimeStart.val().toDate().format('yyyy-MM-dd HH:mm:ss');tempEndTime=$inputTimeEnd.val().toDate().format('yyyy-MM-dd HH:mm:ss');if(tempStartTime.toDate()>=tempEndTime.toDate()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE3+"</strong>").show().close();return;}
if(tempEndTime.toDate()>=new Date()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE4+"</strong>").show().close();return;}
break;case totalModeType['recent']:tempEndTime=new Date().format('yyyy-MM-dd HH:mm:ss');switch($inputPeriodUnit.val()){case'hour':tempPeriodTime=periodValue*3600000;break;case'day':tempPeriodTime=periodValue*86400000;break;case'month':tempPeriodTime=periodValue*2592000000;break;case'year':tempPeriodTime=periodValue*31536000000;break;}
now=new Date();tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case totalModeType['realTime']:tempStartTime='';tempEndTime='';break;case totalModeType['easy']:now=new Date();switch($inputPeriodDropDown.val()){case'today':tempPeriodTime=86400000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case'yesterday':var yesterday=new Date();yesterday=new Date(yesterday.setDate(yesterday.getDate()-1));tempEndTime=new Date(getTimeOfMidnightZero(now).getTime()-1000).format('yyyy-MM-dd HH:mm:ss');tempStartTime=getTimeOfMidnightZero(yesterday).format('yyyy-MM-dd HH:mm:ss');break;case'thisWeek':tempPeriodTime=604800000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;case'lastWeek':tempPeriodTime=604800000;tempEndTime=getTimeOfMidnightZero(new Date(now-(now.getDay()+1)*86400000)).format('yyyy-MM-dd HH:mm:ss');tempStartTime=getTimeOfMidnightZero(new Date(now-(now.getDay()+7)*86400000)).format('yyyy-MM-dd HH:mm:ss');break;case'thisYear':tempPeriodTime=31536000000;tempEndTime=now.format('yyyy-MM-dd HH:mm:ss');tempStartTime=new Date(now-tempPeriodTime).format('yyyy-MM-dd HH:mm:ss');break;}
break;case totalModeType['realTimeDashboard']:tempStartTime='';tempEndTime='';tempInterval=$inputRealTimeInterval.val();timeType=$inputRealTimeInterval.val();break;case totalModeType['multiple']:tempStartTime='';tempEndTime='';tempInterval=$inputInterval.val();timeType=$inputRealTimeInterval.val();var paraType=arrItemDS;break;case totalModeType['easyCompareAnalyz']:tempPeriodTime='month';$inputInterval.val('d1');timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['easyCompare']:tempPeriodTime='month';$inputInterval.val('d1');timeType=$inputComparePeriod.val();break;case totalModeType['compareSensor']:tempPeriodTime=$inputComparePeriod.val();timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['compareMeter']:tempPeriodTime=$inputComparePeriod.val();timeType=$inputComparePeriod.val();tempStartTime=initCompareTime(tempPeriodTime,$inputCompareDate1.val());tempEndTime=initCompareTime(tempPeriodTime,$inputCompareDate2.val());break;case totalModeType['gauge']:if($gaugeMode.val()=='high'){scaleList=[$gaugeLowerLimit.val(),$normalLowerLimit.val(),$normalUpperLimit.val(),$gaugeUpperLimit.val()];}else{scaleList=[$gaugeUpperLimit.val(),$normalUpperLimit.val(),$normalLowerLimit.val(),$gaugeLowerLimit.val()];}
for(i=0;i<scaleList.length;i++){if(isNaN(Number(scaleList[i]))){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE10+"</strong>").show().close();return;}
scaleList[i]=parseFloat(scaleList[i]);}
var tempArr=scaleList.concat();if($gaugeMode.val()=='high'){tempArr.sort(function(a,b){return a>b?1:-1});}else{tempArr.sort(function(a,b){return a<b?1:-1});}
if(tempArr.toString()!=scaleList.toString()){new Alert($("#configAlert"),"danger","<strong>"+I18n.resource.modalConfig.err.TYPE5+"</strong>").show().close();return;}
break;case totalModeType['weather']:tempStartTime='';tempEndTime='';break;case totalModeType['easyHistory']:timeType=$inputHistoryRange.val();break;case totalModeType['easyHistorySelect']:timeType=$inputHistoryRange.val();var chartType=$('#inputChartSelect').val();break;default:break;}
function initCompareTime(period,time){var startTime;switch(period){case'hour':startTime=time.toDate().format('yyyy-MM-dd HH')+':00:00';break;case'day':startTime=time.toDate().format('yyyy-MM-dd')+' 00:00:00';break;case'week':var weekDay=time.toDate().getDay();var date=time.toDate().getDate();startTime=new Date(time.toDate().setDate(date-weekDay+1)).format('yyyy-MM-dd')+' 00:00:00';break;case'month':startTime=time.toDate().format('yyyy-MM')+'-01 00:00:00';break;default:break;}
return startTime;}
function getTimeOfMidnightZero(date){var tempDate;if(date){tempDate=date}else{tempDate=new Date();}
return(date.format('yyyy-MM-dd')+' 00:00:00').toDate();}
if(_this.modalType=="dataAnalysis"){if(_this.optionType){_this.screen.curModal={startTime:tempStartTime,endTime:tempEndTime,format:$inputInterval.val(),mode:$inputModal.val(),type:_this.option.templateType,itemDS:arrItemDS,comparePeriod:tempPeriodTime,dsChartCog:_this.option.dsChartCog,noteList:[],graphList:[]};}else{_this.screen.curModal={startTime:tempStartTime,endTime:tempEndTime,format:$inputInterval.val(),mode:$inputModal.val(),type:_this.option.templateType,itemDS:arrItemDS,comparePeriod:tempPeriodTime,dsChartCog:_this.option.dsChartCog,noteList:_this.screen.curModal.noteList,graphList:_this.screen.curModal.graphList};}}else if(_this.modalType=="dashboard"){_this.templateObj.configParams={};var $divDSConfigure=$('.divDSConfigure');_this.templateObj.entity.modal.title=$('.springSel .chartTitle input').val();_this.templateObj.entity.modal.points=[];_this.templateObj.entity.modal.StartTime=tempStartTime;_this.templateObj.entity.modal.EndTime=tempEndTime;_this.templateObj.entity.modal.dsChartCog=_this.option.dsChartCog;if(_this.templateObj.entity.modal.type=='ModalNote'){var bodyEditor=document.querySelector('iframe').contentWindow.document.querySelector('body');var $divModalTextSpan=$(bodyEditor).find('.pointValue');_this.templateObj.entity.modal.modalText=_this.ue.getContent();for(var i=0;i<$divModalTextSpan.length;++i){_this.templateObj.entity.modal.points.push($divModalTextSpan.get(i).attributes['id'].value);}
_this.templateObj.entity.modal.modalTextUrl=_this.editorData;}else{for(var i=0;i<$divDSConfigure.length;++i){_this.templateObj.entity.modal.points.push($divDSConfigure.get(i).attributes['dsid'].value);}}
var option={};timeType&&(option.timeType=timeType);scaleList&&(option.scaleList=scaleList);paraType&&(option.paraType=paraType);chartType&&(option.showType=chartType);}
$modalConfig.modal('hide');_this.newPageFlag=true;if(_this.modalType=='dataAnalysis'){var yMax=$('#modifyChartYMax').val();var yMin=$('#modifyChartYMin').val();if(yMax){yMax=parseInt(yMax,10);}
if(yMin){yMin=parseInt(yMin,10);}
var chartOpt={'chartName':$('#modifyChartTitle').val(),'yUnit':$('#modifyChartYUnitName').val()+' '+$('#modifyChartYUnitEx').val(),'yMax':yMax,'yMin':yMin,'yMark':$('#modifyChartYMark').val()};_this.screen.curModal.chartOption=chartOpt;_this.screen.renderModal();}else if(_this.modalType=='dashboard'){_this.templateObj.setModalOption(option);_this.templateObj.render();}}},close:function(){this.screen=null;this.container=null;this.modalType=null;this.ue=null},initEditor:function(){var _this=this;var bodyEditor;this.editorData=_this.templateObj.entity.modal.modalTextUrl?_this.templateObj.entity.modal.modalTextUrl:[];if(!this.ue){UE.delEditor('noteEditor');this.ue=UE.getEditor('noteEditor',{lang:(I18n.type=='zh'?'zh-cn':'en'),enableAutoSave:false});this.ue.ready(function(){$('#noteEditor').slideDown('fast');$('#dataConfig').hide();this.setContent(_this.templateObj.entity.modal.modalText?_this.templateObj.entity.modal.modalText:'');bodyEditor=document.querySelector('iframe').contentWindow.document.querySelector('body');$(bodyEditor).css({height:'100%',overflow:'auto'});bodyEditor.ondrop=dropBody;bodyEditor.ondragover=ondragoverBody;bodyEditor.ondragleave=dragleaveBody;bodyEditor.onmouseup=onmouseupBody;bodyEditor.onkeydown=onkeydownBody;$(bodyEditor).find('.pointValue').each(function(){this.addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);});});}
function dropBody(e){e.preventDefault();this.focus();var $divConfigData=$('.divConfigData');$divConfigData.trigger('drop',[e]);var $editorPoint=$(bodyEditor).find('.pointValue');var modalTextUrl=_this.editorData?_this.editorData:[];var tempModalTexUrl=[];var flag;for(var i=0;i<$editorPoint.length;i++){flag=false;for(var j=0;j<modalTextUrl.length;j++){if($editorPoint[i].id==modalTextUrl[j].ptId){tempModalTexUrl[i]=modalTextUrl[j];flag=true;break;}}
if(!flag){tempModalTexUrl[i]={ptId:$editorPoint[i].id,ptName:$editorPoint[i].innerText.match(/\b\w+\b/g),ptTextUrl:[]}}}
_this.editorData=tempModalTexUrl;}
function ondragoverBody(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').addClass('addData');}
function dragleaveBody(e){e.preventDefault();$(e.currentTarget).find('.dataDragTip').removeClass('addData');}
function onmouseupBody(e){var selection=window.getSelection();if(selection.type=="Range"){var content=selection.getRangeAt(0).cloneContents();for(var i in content.childNodes){if(content.childNodes[i].className=='pointValue'){$('.pointValue').attr("contenteditable",true);_this.isSelection=true;return;}}}else{$('.pointValue').attr("contenteditable",false);}
_this.isSelection=false;}
function onkeydownBody(e){if(_this.isSelection)window.event.returnValue=false;};},renderEditor:function(){var $note=$('#noteEditor');var $dataConfig=$('#dataConfig');if(this.templateObj&&this.templateObj.entity.modal.type=='ModalNote'){$dataConfig.hide();$note.show();if(this.editorData){var $editor=$('#editor');$editor.find('.pointValue').off('click').on('click',function(e){_this.initNotePtCfg($editor.find('.pointValue').index($(e.target)));})}}else{$dataConfig.show();$note.hide();}},domNodeRemoved:function(){var id=$(this).attr('id');var bodyEditor=document.querySelector('iframe').contentWindow.document.querySelector('body');var $target=$('.divDSConfigure[dsid="'+id+'"]');var index=$target.parent().children('.divDSConfigure').index($target);setTimeout(function(){var newDom=$(bodyEditor).find('#'+id);if(newDom.length<1){$target.find('.btnRemoveDS').trigger('click');var tempArray=[];for(var i=0;i<_this.editorData.length;i++){if(i==index)continue;tempArray.push(_this.editorData[i]);}
_this.editorData=tempArray;}else{newDom[0].addEventListener('DOMNodeRemoved',_this.domNodeRemoved,false);}},1000);},initNotePtCfg:function(index){var modalTextUrl;var bodyEditor=document.querySelector('iframe').contentWindow.document.querySelector('body');var $editorPoint=$(bodyEditor).find('.pointValue');if(_this.editorData&&$editorPoint.length==_this.editorData.length){modalTextUrl=_this.editorData;}else{modalTextUrl=[];for(var i=0;i<$editorPoint.length;++i){modalTextUrl.push({ptId:$editorPoint[i].id,ptName:$editorPoint[i].innerText.match(/\b\w+\b/g),ptTextUrl:[]})}}
var temp;var $tempDivUrl=$('<div class="col-xs-4 "><select type="text" class="form-control inputNotePtCfgUrl"></select></div>');var $tempSelUrl=$tempDivUrl.children();$tempSelUrl[0].options.add(new Option(I18n.resource.dashboard.show.SELECT_LINK,'',true));for(var i in AppConfig.menu){var option=new Option(AppConfig.menu[i],i);$tempSelUrl[0].options.add(option);}
$tempSelUrl[0].onchange=function(){_this.templateObj.entity.modal.link=$tempSelUrl[0].value;};var strNotePtCfg=new StringBuilder();strNotePtCfg.append('<div id="containerNotePtCfg">');strNotePtCfg.append('   <span class="glyphicon glyphicon-plus" id="btnNotePtCfgAdd" aria-hidden="true"></span>');strNotePtCfg.append('   <span class="glyphicon glyphicon-remove" id="btnNotePtCfgExit" aria-hidden="true"></span>');strNotePtCfg.append('   <div class="rowNotePtCfgTitle row">');strNotePtCfg.append('       <div class="col-xs-3">Value</div>');strNotePtCfg.append('       <div class="col-xs-5">Name</div>');strNotePtCfg.append('       <div class="col-xs-4">Url</div>');strNotePtCfg.append('   </div>');strNotePtCfg.append('   <div id="divNotePtCfg">');strNotePtCfg.append('   </div>');strNotePtCfg.append('   <div id="divBtnNotePtCfg">');strNotePtCfg.append('       <button type="button" class="btn btn-primary" id="btnNotePtCogSure" i18n="modalConfig.data.PT_COG_SURE"></button>');strNotePtCfg.append('       <button type="button" class="btn btn-primary" id="btnNotePtCogCancel" i18n="modalConfig.data.PT_COG_CANCEL"></button>');strNotePtCfg.append('   </div>');strNotePtCfg.append('</div>');$('#noteEditor').append(strNotePtCfg.toString());strNotePtCfg=new StringBuilder();if(modalTextUrl[index]&&modalTextUrl[index].ptTextUrl.length>0){for(var i=0;i<modalTextUrl[index].ptTextUrl.length;i++){temp=modalTextUrl[index].ptTextUrl[i];strNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal" value="'+temp.value+'"></div>');strNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName" value="'+temp.name+'"></div>');strNotePtCfg.append('   </div>');}}
else
{strNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal"></div>');strNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName"></div>');strNotePtCfg.append('   </div>');}
$('#divNotePtCfg').append(strNotePtCfg.toString());var $rowNotePtCfg=$('.rowNotePtCfg');var tempVal;for(var i=0;i<$rowNotePtCfg.length;i++){$rowNotePtCfg.eq(i).append($tempDivUrl.clone());tempVal=modalTextUrl[index].ptTextUrl[i]?modalTextUrl[index].ptTextUrl[i].url:'';$rowNotePtCfg.eq(i).find('.inputNotePtCfgUrl').val(tempVal)}
I18n.fillArea($('#divBtnNotePtCfg'));var $self=$('#containerNotePtCfg');$('#btnNotePtCfgAdd').off('click').on('click',function(e){var strRowNotePtCfg=new StringBuilder();strRowNotePtCfg.append('   <div class="row rowNotePtCfg form-group">');strRowNotePtCfg.append('      <span class="glyphicon glyphicon-remove btnRowNoteCfgRemove" aria-hidden="true"></span> ');strRowNotePtCfg.append('       <div class="col-xs-3 "><input type="text" class="form-control inputNotePtCfgVal"></div>');strRowNotePtCfg.append('       <div class="col-xs-5 "><input type="text" class="form-control inputNotePtCfgName"></div>');strRowNotePtCfg.append('   </div>');$('#divNotePtCfg').append(strRowNotePtCfg.toString());$('.rowNotePtCfg').last().append($tempDivUrl.clone());$('.btnRowNoteCfgRemove').last().off('click').on('click',function(e){var tempPtTextUrl=[];var tempIndex=$('.btnRowNoteCfgRemove').index($(e.target));tempPtTextUrl=[_this.editorData[index].ptTextUrl.slice(0,tempIndex),_this.editorData[index].ptTextUrl.slice(tempIndex+1)];tempPtTextUrl=tempPtTextUrl[0].concat(tempPtTextUrl[1]);_this.editorData[index].ptTextUrl=tempPtTextUrl.concat();$(e.target).parent().remove();});});$('#btnNotePtCfgExit').off('click').on('click',function(e){$self.remove();});$('#btnNotePtCogSure').off('click').on('click',function(e){$rowNotePtCfg=$('.rowNotePtCfg');modalTextUrl[index].ptTextUrl=[];for(var j=0;j<$rowNotePtCfg.length;j++){modalTextUrl[index].ptTextUrl.push({value:$rowNotePtCfg.eq(j).find('.inputNotePtCfgVal').val(),name:$rowNotePtCfg.eq(j).find('.inputNotePtCfgName').val(),url:$rowNotePtCfg.eq(j).find('.inputNotePtCfgUrl').val()})}
_this.editorData=modalTextUrl;$self.remove();});$('#btnNotePtCogCancel').off('click').on('click',function(e){$self.remove();});$('.btnRowNoteCfgRemove').off('click').on('click',function(e){var tempPtTextUrl=[];var tempIndex=$('.btnRowNoteCfgRemove').index($(e.target));tempPtTextUrl=[_this.editorData[index].ptTextUrl.slice(0,tempIndex),_this.editorData[index].ptTextUrl.slice(tempIndex+1)];tempPtTextUrl=tempPtTextUrl[0].concat(tempPtTextUrl[1]);_this.editorData[index].ptTextUrl=tempPtTextUrl.concat();$(e.target).parent().remove();});}};return modalConfigurePane;})();var shareLogging=(function(){var _this=this;function shareLogging(userId){this.userId=userId;_this=this;_this.shareLogList=undefined;}
shareLogging.prototype={show:function(){WebAPI.get('/static/views/observer/widgets/shareLogging.html').done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.init();});},init:function(){Spinner.spin(ElScreenContainer);WebAPI.get('/analysis/getShareLog/'+this.userId).done(function(result){_this.shareLogList=JSON.parse(result).shareLogList;var totalShareLog='';for(var i=0;i<_this.shareLogList.length;++i){var shareTime=new Date(_this.shareLogList[i].shareDate.slice(0,_this.shareLogList[i].shareDate.indexOf('GMT'))).format('yyyy-MM-dd HH:mm');var strShareLog=new StringBuilder();strShareLog.append('<div class="row rowShareLogContent" menuId ="'+_this.shareLogList[i].menuItemId+'" id="'+_this.shareLogList[i].shareLogId+'">');strShareLog.append('    <div class="shareOrder">'+'<span class="shareLogIndex">'+String(i+1)+'</span></div>');strShareLog.append('    <div class="shareDescribe shareCon"><span style="text-align:left;vertical-align:middle;display:inline-block;width:90%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" class="shareVal" title="">'+
_this.shareLogList[i].shareDesc+'</span></div>');strShareLog.append('    <div class="shareDate shareDate">'+shareTime+'</div>');strShareLog.append('    <div class="shareOperate"><span class="glyphicon glyphicon-pencil shareDesc grow" style="vertical-align:middle;" title="'+I18n.resource.analysis.shareLog.EDIT_DESCRIPTION+'"></span><span class="glyphicon glyphicon-edit btnSharePageEdit grow" title="'+I18n.resource.analysis.shareLog.EDIT_PAGE+'"></span><span class="glyphicon glyphicon-remove btnShareRemove grow" title="'+I18n.resource.analysis.shareLog.DELETE_SHARE_LOG+'"></span></div>');strShareLog.append('<br style="clear:both;"></div>');totalShareLog+=strShareLog;}
if(totalShareLog==''){$('.divShareLog').parent().html('<div class="shareNone">'+I18n.resource.analysis.shareLog.NONE_LOG+'</div>');$('.shareNone').off('click').click(function(){ScreenManager.show(AnalysisScreen);});}else{$('.divShareLog').html(totalShareLog);}
$('.shareURL').click(function(e){window.open(e.target.innerHTML)});$('.btnShareLogClose').off('click').click(function(){ScreenManager.show(AnalysisScreen);});$('.rowShareLogContent').off('click').hover(function(){$(this).children('.shareOperate').show();if($('.shareCon input').length>0)return;$(this).children('.shareVal').attr('title',$(this).children('.shareVal').text());},function(){$(this).children('.shareOperate').hide();});$('.rowShareLogContent').click(function(e){window.open(window.location.origin+'/share/db/'+AppConfig.userId+'/'+$(e.currentTarget).attr('menuId'),'_blank');})
_this.initEdit();_this.initDelete();_this.initDashboardPageEdit();I18n.fillArea($(ElScreenContainer));Spinner.stop();});},initEdit:function(){$('.shareDesc').click(function(e){e.preventDefault();e.stopPropagation();var shareOldVal=$(e.currentTarget).parent('.shareOperate').siblings('.shareCon').children('span').text();$(e.currentTarget).parent('.shareOperate').siblings('.shareCon').children('span').css('display','none');var inputDescEdit=document.createElement('input');inputDescEdit.setAttribute('type','text');inputDescEdit.setAttribute('placeholder',I18n.resource.analysis.shareLog.DESC_TIP);inputDescEdit.style.width='80%';inputDescEdit.value=shareOldVal;$(e.currentTarget).parent('.shareOperate').siblings('.shareCon').append(inputDescEdit);inputDescEdit.focus();var oldDesc=inputDescEdit.value;$(inputDescEdit).click(function(e){e.stopPropagation();});inputDescEdit.onblur=function(e){var postData={desc:e.target.value,shareId:$(e.target).closest('.rowShareLogContent').attr('id')};if(oldDesc!=e.target.value){WebAPI.post('/analysis/editShareLog/0',postData).done(function(result){console.log(result);}).error(function(){alert('Edit ShareLog Error');});}
$(e.target).prev().html(e.target.value).css('display','');$(e.target).parent('.shareCon').children('.shareVal').css('display','inline-block').html(e.target.value);$(e.target).parent('.shareCon').siblings('.shareOperate').children('.shareDesc').html('');e.target.remove();}});},initDelete:function(){$('.btnShareRemove').click(function(e){var retCon=confirm(I18n.resource.analysis.shareLog.REMOVE_ALERT);if(true===retCon){var index=$('.btnShareRemove').index($(e.target));var postData={menuItemId:_this.shareLogList[index].menuItemId,shareId:$(e.target).closest('.rowShareLogContent').attr('id')};WebAPI.post('/analysis/editShareLog/1',postData).done(function(result){console.log(result);}).error(function(){alert('Remove ShareLog Error');});_this.shareLogList.splice(index,1);$(e.target).closest('.rowShareLogContent').remove();$('.shareLogIndex').each(function(index){$(this).text(index+1)});if($('.rowShareLogContent').length==0){$('#shareLogPanel .panel-body').html('<div class="shareNone">'+I18n.resource.analysis.shareLog.NONE_LOG+'</div>');$('.shareNone').off('click').click(function(){ScreenManager.show(AnalysisScreen);});}}});},initDashboardPageEdit:function(){$('.btnSharePageEdit').click(function(e){e.preventDefault();e.stopPropagation();var index=$('.btnSharePageEdit').index($(e.target));var menuItemId=_this.shareLogList[index].menuItemId;var postData={shareLogId:_this.shareLogList[index].shareLogId,desc:_this.shareLogList[index].shareDesc};ScreenManager.show(EnergyScreen,menuItemId,null,postData);});},close:function(){_this.shareLogList=null;}};return shareLogging;})();var DiagnosisConfig=(function(){var _this;function DiagnosisConfig(parent){this.parent=parent;_this=this;_this.orderList=[];_this.enableList=[];_this.limitList=[];_this.template=undefined;}
DiagnosisConfig.prototype={show:function(){var _this=this;WebAPI.get("/static/views/observer/diagnosis/diagnosisConfig.html").done(function(resultHtml){var $dialog=$('#dialogModal');$dialog.find('#dialogContent').html(resultHtml);Spinner.spin($dialog.find('.modal-body')[0]);_this.template=$('#createCase')[0].outerHTML.replace(' active in','').replace('confirmCreateCase','confirmEditCase');$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.close();Spinner.stop();}).modal({});$dialog.on('click','.caseTab',function(){_this.caseId=$(this).children('a')[0].id;});I18n.fillArea($('#dialogContent'));_this.bindEvent();_this.init();});},close:function(){},init:function(){_this.isInit=true;WebAPI.get('/diagnosis/config/get/'+AppConfig.projectId).done(function(result){var rs=JSON.parse(result);if(rs.limit){renderLimit(rs.limit)}
if(rs.order){renderOrder(rs.order)}
if(rs.enable){renderEnable(rs.enable)}}).always(function(){Spinner.stop();});_this.getGroupsMembers();function renderLimit(result){_this.limitList=result;if(!_this.limitList||_this.limitList.length<1)return;for(var i=0;i<_this.limitList.length;i++){var item=_this.limitList[i];var buildings=_this.createBuildingsFromDB(item.equipList)
var curtCase={id:item.id,name:item.name,notice:item.notice,alert:item.alert,fault:item.fault,buildings:buildings}
_this.createCaseDom(curtCase,'limit')}}
function renderOrder(result){_this.orderList=result;if(!_this.orderList||_this.orderList.length<1)return;for(var i=0;i<_this.orderList.length;i++){var item=_this.orderList[i];var buildings=_this.createBuildingsFromDB(item.equipList)
var curtCase={id:item.id,name:item.name,groupId:item.groupId,operatorId:item.operatorId,faultGrade:item.faultGrade,buildings:buildings}
_this.createCaseDom(curtCase,'order')}}
function renderEnable(result){_this.enableList=result;if(!_this.enableList||_this.enableList.length<1)return;for(var i=0;i<_this.enableList.length;i++){var item=_this.enableList[i];var buildings=_this.createBuildingsFromDB(item.equipList)
var curtCase={id:item.id,name:item.name,endTime:item.endTime,buildings:buildings}
_this.createCaseDom(curtCase,'enable');}}},getGroupsMembers:function(){WebAPI.get('/diagnosis/getGroupsMembers/'+AppConfig.userId).done(function(result){var data=JSON.parse(result);if(!data)return;var $group=$('#group');var $operatorId=$('#operatorId');_this.group=new Object();for(var i=0;i<data.groups.length;i++){var group=data.groups[i];var $option=$('<option value="'+group.id+'">'+group.name+'</option>');$group.append($option);_this.group[group.id]={id:group.id,name:group.name,member:[]};for(var j=0;j<data.groupMembers[i].length;j++){var member=data.groupMembers[i][j];_this.group[group.id].member.push({id:member.userid,name:member.userfullname});}}
_this.groupHTML=$group[0].innerHTML;_this.operatorHTML=$operatorId[0].innerHTML;$group.change(function(){var selectId=this.value;_this.showSelectOption($operatorId,selectId);});var selectId=$group.children('option:first-child').attr('selected',true).val();_this.showSelectOption($operatorId,selectId);}).fail(function(result){alert(result.error);});},bindEvent:function(){$('#btnDiagnosisShow').click(_this.showDiagnosisShow);$('#btnAutoPushWO').click(_this.showAutoPushWO);$('#btnDiagnosisPause').click(_this.showDiagnosisPauseConfig);$('#btnAlarmRule').click(function(e){new DiagnosisFaultConfig(_this.parent).show();});$('#limitCheckbox').change(function(){var enable=$(this).is(':checked')?1:0;WebAPI.get('/diagnosis/limit/enable/'+AppConfig.projectId+'/'+enable).done(function(){}).fail(function(){});});$('#orderCheckbox').change(function(){var enable=$(this).is(':checked')?1:0;WebAPI.get('/diagnosis/order/enable/'+AppConfig.projectId+'/'+enable).done(function(){}).fail(function(){});});$('#enableCheckbox').change(function(){var enable=$(this).is(':checked')?1:0;WebAPI.get('/diagnosis/enable/enable/'+AppConfig.projectId+'/'+enable).done(function(){}).fail(function(){});});},showSelectOption:function($operator,selectId){$operator[0].options.length=0;for(var i in _this.group[selectId].member){var member=_this.group[selectId].member[i];$operator[0].options.add(new Option(member.name,member.id));}},createBuildingsFromDB:function(equipList){var arr=equipList.toString().split(',');var buildingDict={};var subBuildingDict={};var equipmentDict={};if(arr.length<1)return;var dict=_this.parent;for(var i=0;i<arr.length;i++){var zone=dict.dictZone[dict.dictEquipment[arr[i]].zoneId];var building={buildingId:zone.buildingId,buildingName:zone.buildingName};var subBuilding={subBuildingId:zone.subBuildingId,subBuildingName:zone.subBuildingName};var equipment={equipmentId:arr[i],equipmentName:dict.dictEquipment[arr[i]].name};if(!buildingDict[zone.buildingId]){buildingDict[zone.buildingId]=building;}
if(!subBuildingDict[zone.subBuildingId]){subBuildingDict[zone.subBuildingId]=subBuilding;}
if(!equipmentDict[equipment.equipmentId]){equipmentDict[arr[i]]=equipment;}}
return{buildingDict:buildingDict,subBuildingDict:subBuildingDict,equipmentDict:equipmentDict};},showSetPane:function(){var $tabPane=$('#createCase');var $diagnosisConfig=$('#diagnosisConfig');var $commonPane=$('.commonPane');if(_this.isInit){var $caseList=$tabPane.find('#caseList');_this.initBuildingConfig($tabPane,_this.parent.buildings);_this.isInit=false;$caseList.on('click','.close',function(){_this.removeFromCaseList();});$tabPane.off('click').on('click','.btnItem',function(){_this.chooseValue($tabPane,this);});$tabPane.children('.title').click(function(){$(this).next('.row').slideToggle();$(this).children('.glyphicon').toggleClass('glyphicon-plus-sign glyphicon-minus-sign')});$commonPane.on('click','#confirmCreateCase',function(){_this.createCase($tabPane);});$commonPane.on('click','.cancelCreateCase',function(){$diagnosisConfig.show();$commonPane.hide();});$commonPane.on('click','#btnCreateCase',function(){var $createCase=$('#createCase');$createCase.find('.chosen').addClass('notChosen').removeClass('chosen');$createCase.find('#caseName').val('');$('#createCase input').val('');});}else{$tabPane.find('.chosen').addClass('notChosen').removeClass('chosen');}
$diagnosisConfig.hide();$commonPane.show();},removeFromCaseList:function(){var $a=$(this).prev('a');var targetName=$a.attr('href').replace('#','');var id=$a.attr('id');var $dialog=$('#dialogModal');Spinner.spin($dialog.find('.commonPane')[0]);var curtPaneId=$('.commonPane').attr('id');if(curtPaneId=='diagShow'){WebAPI.get('/diagnosis/limit/delete/'+AppConfig.projectId+'/'+id).done(function(){removeDom('limit');}).fail(function(){}).always(function(){Spinner.stop();});}else if(curtPaneId=='WOPush'){WebAPI.get('/diagnosis/order/delete/'+AppConfig.projectId+'/'+id).done(function(){removeDom('order');}).fail(function(){}).always(function(){Spinner.stop();});}else if(curtPaneId=='diagPause'){WebAPI.get('/diagnosis/enable/delete/'+AppConfig.projectId+'/'+id).done(function(){removeDom('enable');}).fail(function(){}).always(function(){Spinner.stop();});}
function removeDom(str){$a.parent('li').remove();$('.tab-content').find('#'+targetName).remove();$('#'+str+'Nav').find('#btnCreateCase').click();}},initBuildingConfig:function($tab,data){var $buildList=$tab.find('#buildList'),$areaList=$tab.find('#areaList'),$equipmentList=$tab.find('#equipmentList');for(var i=0;i<data.length;i++){var build=data[i];var $liBuild=$('<li class="grow notChosen"><span class="btnItem enabled" id="'+build.buildId+'">'+build.buildName+'</span></li>');$buildList.append($liBuild)
for(var j=0;j<build.subBuilds.length;j++){var area=build.subBuilds[j];var $liArea=$('<li class="grow notChosen" parentId="'+build.buildId+'" title="'+build.buildName+'"><span class="btnItem disabled" id="'+area.subBuildId+'" style="background:'+echarts.config.color[j]+'">'+area.subBuildName+'</span></li>');$areaList.append($liArea);for(var k=0;k<area.equipments.length;k++){var equipment=area.equipments[k];var $liEquipment=$('<li class="grow notChosen" parentId="'+area.subBuildId+'" title="'+area.subBuildName+'"><span class="btnItem disabled" id="'+equipment.equipmentId+'" style="background:'+echarts.config.color[j]+'">'+equipment.equipmentName+'</span></li>');$equipmentList.append($liEquipment);}}}},chooseValue:function($tabPane,target){var $li=$(target).parent('li');var $ul=$li.parent('ul');var urId=$ul.attr('id');var $buildList=$tabPane.find('#buildList');var $areaList=$tabPane.find('#areaList');if($li.hasClass('notChosen')){if(urId=='buildList'){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();dealWithChildLevelAbleStatus('build','area');}
if(urId=='areaList'){var parentIds=getChosenParentIds($buildList);if($li.hasClass('all')){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();dealWithChildLevelAbleStatus('area','equipment');}else if($.inArray($li.attr('parentId'),parentIds)>-1){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();dealWithChildLevelAbleStatus('area','equipment');}}
if(urId=='equipmentList'){var parentIds=getChosenParentIds($areaList);if($li.hasClass('all')){if($areaList.children('.all').hasClass('chosen')){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();}}else if($.inArray($li.attr('parentId'),parentIds)>-1){$li.removeClass('notChosen').addClass('chosen');dealWithSameLevel();}}}else{if(urId=='buildList'){$li.removeClass('chosen').addClass('notChosen');dealWithSameLevel();dealWithChildLevelToNotChosen('build','area');dealWithChildLevelAbleStatus('build','area');}
if(urId=='areaList'){$li.removeClass('chosen').addClass('notChosen');dealWithSameLevel();dealWithChildLevelToNotChosen('area','equipment');dealWithChildLevelAbleStatus('area','equipment');}
if(urId=='equipmentList'){$li.removeClass('chosen').addClass('notChosen');dealWithSameLevel();}}
function dealWithSameLevel(){var classList=$li[0].classList;if($li.hasClass('all')){if(classList.contains('chosen')){$li.siblings('li').removeClass('notChosen').addClass('chosen');}else{$li.siblings('li').removeClass('chosen').addClass('notChosen');}}else{if($ul.find('.chosen').not('.all').length<$ul.find('li').length-1){$li.siblings('.all').removeClass('chosen').addClass('notChosen');}else{$li.siblings('li').removeClass('notChosen').addClass('chosen');}}}
function dealWithChildLevelToNotChosen(parent,children){var parentIds=[];$tabPane.find('#'+parent+'List .chosen').not('.all').children('.btnItem').each(function(){parentIds.push(this.id);});$tabPane.find('#'+children+'List .chosen').each(function(){var eqpId=$(this).attr('parentId');if(eqpId){if($.inArray(eqpId,parentIds)<0){$(this).children('.btnItem').click();$(this).siblings('.all').removeClass('chosen').addClass('notChosen');}}});}
function dealWithChildLevelAbleStatus(parent,children){var parentIds=[];var $children=$tabPane.find('#'+children+'List').children().not('.all');$tabPane.find('#'+parent+'List .chosen').not('.all').children('.btnItem').each(function(){parentIds.push(this.id);});$children.each(function(){var eqpId=$(this).attr('parentId');if(eqpId){if($.inArray(eqpId,parentIds)<0){$(this).children('.btnItem').addClass('disabled').removeClass('enabled');}else{$(this).children('.btnItem').addClass('enabled').removeClass('disabled');}
$(this).click();}});var childrenCount=$children.length;var enabledCount=$children.children('.enabled').length;var $all=$tabPane.find('#'+children+'List').children('.all');if(childrenCount==enabledCount){$all.children('.btnItem').addClass('enabled').removeClass('disabled');}else{$all.children('.btnItem').addClass('disabled').removeClass('enabled');}}
function getChosenParentIds($obj){var idList=[];$obj.children('.chosen').not('.all').children('.btnItem').each(function(){idList.push($(this).attr('id'));});return idList;}},createCase:function($tabPane){var caseName=$tabPane.find('#caseName').val();_this.operateCaseList($tabPane);$tabPane.find('#confirmCreateSave').click(function(){var $tabPane=$(this).closest('.tab-pane');var curtPaneId=$('.commonPane').attr('id');if(curtPaneId=='btnDiagnosisShow'){}else if(curtPaneId=='btnAutoPushWO'){var id=$('.caseTab.active a').attr('id');var caseName=$tabPane.find('#caseName');var buildings=_this.createBuildingData($tabPane);var $projectId=$tabPane.find('#projectId');var $userId=$tabPane.find('#userId');var curtCase={id:id,name:caseName,buildings:buildings,projectId:$projectId.val(),projectName:$projectId.find("option:selected").text(),userId:$userId.val(),userName:$userId.find("option:selected").text(),alarmLevel:$('#alarm').val()}
for(var i=0;i<_this.orderList.length;i++){if(curtCase.id==id){_this.orderList[i]=curtCase;}}}else if(curtPaneId=='btnDiagnosisPause'){}});},operateCaseList:function($tabPane){var equipList=_this.getChosenEquipList($tabPane);if(equipList.length<1){alert(I18n.resource.diagnosis.config.subConfig.MUST_CHOOSE_EQUIP);return;}
if(!_this.checkRequire())return;var curtPaneId=$('.commonPane').attr('id');var caseName=$tabPane.find('#caseName').val();var curtCase=new Object();var $dialog=$('#dialogModal');if(curtPaneId=='diagShow'){curtCase={name:caseName,equipList:equipList,fault:$tabPane.find('#warning').val(),alert:$tabPane.find('#alert').val(),notice:$tabPane.find('#normal').val(),project:AppConfig.projectId,enabled:1};Spinner.spin($dialog.find('.commonPane')[0]);WebAPI.post('/diagnosis/limit/add/'+AppConfig.projectId,curtCase).done(function(result){curtCase.buildings=_this.createBuildingsFromDB(equipList);curtCase.id=result;_this.createCaseDom(curtCase,'limit')}).error(function(result){alert(result.error);}).always(function(){Spinner.stop()});}else if(curtPaneId=='WOPush'){curtCase={name:caseName,operatorId:$tabPane.find('#operatorId').val(),group:$tabPane.find('#group').val(),equipList:equipList,faultGrade:$tabPane.find('#alarm').val(),project:AppConfig.projectId,enable:1};Spinner.spin($dialog.find('.commonPane')[0]);WebAPI.post('/diagnosis/order/add/'+AppConfig.projectId,curtCase).done(function(result){curtCase.buildings=_this.createBuildingsFromDB(equipList);curtCase.id=result;_this.createCaseDom(curtCase,'order')}).error(function(result){alert(result.error);}).always(function(){Spinner.stop()});}else if(curtPaneId=='diagPause'){curtCase={name:caseName,endTime:$tabPane.find('.form-datetime').val(),equipList:equipList,project:AppConfig.projectId,enable:1};_this.enableList.push(curtCase);Spinner.spin($dialog.find('.commonPane')[0]);WebAPI.post('/diagnosis/enable/add/'+AppConfig.projectId,curtCase).done(function(result){curtCase.buildings=_this.createBuildingsFromDB(equipList);curtCase.id=result;_this.createCaseDom(curtCase,'enable')}).fail(function(result){alert(result.error);}).always(function(){Spinner.stop()});}
return curtCase;},checkRequire:function(){var flag=true;$('.tab-pane.fade.active.in :input').not(':hidden').each(function(){if(this.type!='button'){var val=$(this).val();if(val==undefined||$.trim(val)==''){alert(I18n.resource.diagnosis.config.subConfig.MUST_FILL_IN);flag=false;return flag;}}});return flag;},createBuildingData:function($tabPane){var buildings=[];var index=0;var $buildList=$tabPane.find('#buildList');var $areaList=$tabPane.find('#areaList');var $equipmentList=$tabPane.find('#equipmentList');$buildList.children('.chosen').not('.all').each(function(){var $btnItem=$(this).children('.btnItem');var building={buildId:$btnItem[0].id,buildName:$btnItem[0].innerHTML,subBuilds:[]}
$areaList.children('.chosen').not('.all').each(function(){var parentId=$(this).attr('parentId');if($btnItem[0].id==parentId){var $btnItemSub=$(this).children('.btnItem');var subBuilding={subBuildId:$btnItemSub[0].id,subBuildName:$btnItemSub[0].innerHTML,equipments:[]}
building.subBuilds.push(subBuilding);$equipmentList.children('.chosen').not('.all').each(function(){var parentId=$(this).attr('parentId');if($btnItemSub[0].id==parentId){var $btnItemEqpmt=$(this).children('.btnItem');var equipment={equipmentId:$btnItemEqpmt[0].id,equipmentName:$btnItemEqpmt[0].innerHTML}
building.subBuilds[index].equipments.push(equipment);}});index++;}});buildings.push(building);});return buildings;},getChosenEquipList:function($tabPane){var equipList='';$tabPane.find('#equipmentList').children('.chosen').not('.all').children('.btnItem').each(function(){equipList+=(this.id+',');});return equipList.substring(0,equipList.length-1);},createCaseDom:function(data,type){$('.tab-content').append(_this.template);var $tabPane=$('.tab-pane:last-child');$tabPane.attr('id',data.name+data.id);$tabPane.find('#confirmEditCase').click(function(){_this.updateCase($tabPane);});I18n.fillArea($tabPane);_this.initBuildingConfig($tabPane,_this.parent.buildings);_this.signChosenItem($tabPane,data.buildings);_this.createTabNavItem(data,type);$tabPane.off('click').on('click','.btnItem',function(){_this.chooseValue($tabPane,this);});$tabPane.children('.title').click(function(){$(this).next('.row').slideToggle();$(this).children('.glyphicon').toggleClass('glyphicon-plus-sign glyphicon-minus-sign')});if(type=='limit'){$tabPane.find('#normal').val(data.notice);$tabPane.find('#alert').val(data.alert);$tabPane.find('#warning').val(data.fault);}else if(type=='order'){var $operator=$tabPane.find('#operatorId');$tabPane.find('#group').html(_this.groupHTML).change(function(){var selectId=this.value;_this.showSelectOption($operator,selectId);});$operator.html(_this.operatorHTML);$tabPane.find('#group option').each(function(){if(this.value==data.groupId){$(this).siblings().attr('selected',false);$(this).attr('selected',true);_this.showSelectOption($operator,this.value);}});$operator.children('option').each(function(){if(this.value==data.operatorId){$(this).siblings().attr('selected',false);$(this).attr('selected',true);}});$tabPane.find('#alarm option').each(function(){if(this.value==data.faultGrade){$(this).siblings().attr('selected',false);$(this).attr('selected',true);}});}else if(type=='enable'){$tabPane.find('.form-datetime').val(data.endTime);}},updateCase:function($tab){var curtPaneId=$('.commonPane').attr('id');var curtCase=new Object();var caseName=$tab.find('#caseName').val();var equipList=_this.getChosenEquipList($tab);var $dialog=$('#dialogModal');Spinner.spin($dialog.find('.commonPane')[0]);$tab.find('#caseName').val(caseName);$('.caseTab.active a').text(caseName)
if(curtPaneId=='WOPush'){curtCase={name:caseName,operatorId:$tab.find('#operatorId').val(),group:$tab.find('#group').val(),equipList:equipList,faultGrade:$tab.find('#alarm').val(),project:AppConfig.projectId,enable:1};WebAPI.post('/diagnosis/order/update/'+AppConfig.projectId+'/'+_this.caseId,curtCase).done(function(result){}).fail(function(){alert(I18n.diagnosis.config.subConfig.UPDATE_FAIL);}).always(function(){Spinner.stop();});}else if(curtPaneId=='diagPause'){curtCase={name:caseName,endTime:$tab.find('.form-datetime').val(),equipList:equipList,project:AppConfig.projectId,enable:1};WebAPI.post('/diagnosis/enable/update/'+AppConfig.projectId+'/'+_this.caseId,curtCase).done(function(result){}).fail(function(){alert(I18n.diagnosis.config.subConfig.UPDATE_FAIL);}).always(function(){Spinner.stop();});}else if(curtPaneId=='diagShow'){curtCase={name:caseName,equipList:equipList,fault:$tab.find('#warning').val(),alert:$tab.find('#alert').val(),notice:$tab.find('#normal').val(),project:AppConfig.projectId,enable:1};WebAPI.post('/diagnosis/limit/update/'+AppConfig.projectId+'/'+_this.caseId,curtCase).done(function(result){}).fail(function(){alert(I18n.diagnosis.config.subConfig.UPDATE_FAIL);}).always(function(){Spinner.stop();});}},createTabNavItem:function(data,type){var $caseNav=$('#'+type+'Nav');var $close=$('<button type="button" class="close"><span>×</span> </button>').click(_this.removeFromCaseList);var $caseTab=$('<li class="caseTab"><a id="'+data.id+'" data-toggle="tab" href="#'+data.name+data.id+'">'+data.name+'</a></li>').append($close);$caseNav.append($caseTab);$caseTab.children('a').click(function(){$('#'+data.name+data.id).find('#caseName').val(data.name);_this.showRelative();});},signChosenItem:function($tab,buildings){var $buildList=$tab.find('#buildList');var $areaList=$tab.find('#areaList');var $equipmentList=$tab.find('#equipmentList');var chosenBuildingIds=[];var chosenAreaIds=[];for(var i in buildings.buildingDict){var building=buildings.buildingDict[i];$buildList.children('.notChosen').not('.all').children('.btnItem').each(function(){if(this.id==building.buildingId){$(this).parent().removeClass('notChosen').addClass('chosen');chosenBuildingIds.push(this.id)}});}
_this.setBtnAllStatus($buildList);for(var j in buildings.subBuildingDict){var subBuilding=buildings.subBuildingDict[j];$areaList.children('.notChosen').not('.all').children('.btnItem').each(function(){var $li=$(this).parent('li');var parentId=$li.attr('parentId');if(this.id==subBuilding.subBuildingId){$(this).parent().removeClass('notChosen').addClass('chosen');chosenAreaIds.push(this.id)}
if($.inArray(parentId,chosenBuildingIds)>-1){$(this).addClass('enable').removeClass('disabled');}});}
_this.setBtnAllStatus($areaList);for(var k in buildings.equipmentDict){var equipment=buildings.equipmentDict[k];$equipmentList.children('.notChosen').not('.all').children('.btnItem').each(function(){var $li=$(this).parent('li');var parentId=$li.attr('parentId');if(this.id==equipment.equipmentId){$(this).parent().removeClass('notChosen').addClass('chosen');}
if($.inArray(parentId,chosenAreaIds)>-1){$(this).addClass('enabled').removeClass('disabled');}});}
_this.setBtnAllStatus($equipmentList);},setBtnAllStatus:function($buildList){var $lis=$buildList.children('li').not('.all');var $all=$buildList.children('.all');var liCount=$lis.length;var enableCount=$lis.children('.btnItem').length;if(liCount==enableCount){$all.children('.btnItem').addClass('enabled').removeClass('disabled');}else{$all.children('.btnItem').addClass('disabled').removeClass('enable');}
var chosenCount=$buildList.children('.chosen').length;if(chosenCount==$lis.length){$all.addClass('chosen').removeClass('notChosen');}else{$all.addClass('notChosen').removeClass('chosen');}},showAutoPushWO:function(){$('.caseNav').hide();$('#orderNav').show();var $commonPane=$('.commonPane').attr('id','WOPush');I18n.fillArea($commonPane);_this.showSetPane();_this.showRelative();},showDiagnosisPauseConfig:function(){$('.caseNav').hide();$('#enableNav').show();var $commonPane=$('.commonPane').attr('id','diagPause');I18n.fillArea($commonPane);_this.showSetPane();$('.form-datetime').datetimepicker({autoclose:true,todayBtn:true,initialDate:new Date(),startDate:new Date()});_this.showRelative()},showDiagnosisShow:function(){$('.caseNav').hide();$('#limitNav').show();var $commonPane=$('.commonPane').attr('id','diagShow');I18n.fillArea($commonPane);_this.showSetPane();_this.showRelative();},showRelative:function(id){$('.row.option').hide().next('.list').hide();var curtPaneId=$('.commonPane').attr('id');if(curtPaneId=='WOPush'){$('.order').show().next('.list').show();}else if(curtPaneId=='diagPause'){$('.enable').show().next('.list').show();}else if(curtPaneId=='diagShow'){$('.limit').show().next('.list').show();}}}
return DiagnosisConfig;})();var DiagnosisFaultConfig=(function(){function DiagnosisFaultConfig(parent){this.parent=parent;};DiagnosisFaultConfig.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/diagnosis/paneFaultConfiguration.html").done(function(resultHtml){var dialog=$('#dialogModal');dialog.find('#dialogContent').html(resultHtml);$('#dialogContent .modal-content').css('height',document.body.scrollHeight-100);dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.close();ScreenModal=null;Spinner.stop();}).modal({});Spinner.spin(dialog.find('.modal-body')[0]);_this.init();});},close:function(){},init:function(){var _this=this;var tbody=document.createElement('tbody');var tr,td,item,sb;for(var id in this.parent.dictFault){item=this.parent.dictFault[id];tr=document.createElement('tr');tr.id='config-fault-'+id;tr.onclick=function(e){};sb=new StringBuilder();switch(item.defaultGrade){case 0:sb.append('<td><span class="badge" style="background-color: #5bc0de;" title="Grade">Normal</span></td>');break;case 1:sb.append('<td><span class="badge" style="background-color: #f0ad4e;" title="Grade">Alert</span></td>');break;case 2:sb.append('<td><span class="badge" style="background-color: #d9534f;" title="Grade">Fault</span></td>');break;default:break;}
sb.append('<td>').append(item.name).append('</td>');sb.append('<td>').append(this.parent.dictEquipment[item.equipmentId].name).append('</td>');sb.append('<td>').append(item.description).append('</td>');sb.append('<td>').append(item.userName).append('</td>');sb.append(this.getFaultStatus(item));tr.innerHTML=sb.toString();tbody.appendChild(tr);}
$('#tableListFaults').find('tbody').remove();$('#tableListFaults').append(tbody);Spinner.stop();},renderEditPane:function(element){var _this=this;var id=element.id.replace('config-fault-','');var fault=this.parent.dictFault[id];var rowIndex=element.sectionRowIndex;if(document.getElementById('paneFaultEdit-'+id))return;element.style.backgroundColor='rgb(180, 221, 221)';$(element).find('input').removeAttr("disabled");var tr=document.getElementById('tableListFaults').getElementsByTagName('tbody')[0].insertRow(rowIndex+1);tr.id='paneFaultEdit-'+id;var td=document.createElement('td');td.colSpan=7;td.style.backgroundColor='rgb(180, 221, 221)';var sb=new StringBuilder();sb.append('<span style="float: left; padding: 7px; margin-left: 5px; margin-right: 5px;">UserGrade:</span>');var optionContent='value="'+fault.userFaultGrade+'"';sb.append('<select class="form-control markGrade" style="width: 120px; float: left;"><option value="0">Normal</option><option value="1">Alert</option><option value="2">Fault</option></select>'.replace(optionContent,optionContent+" selected"));sb.append('<span style="float: left; padding: 7px; margin-left: 10px; margin-right: 5px;">Advaced:</span>');optionContent='value="'+fault.userFaultDelay+'"'
sb.append('<select class="form-control markAdvanced" style="width: 160px; float: left;">\
                        <option value="0">Real-time</option>\
                        <option value="3600">Delay 1 hour</option>\
                        <option value="43200">Delay 12 hours</option>\
                        <option value="86400">Delay 24 hours</option>\
                        <option value="604800">Delay 7 days</option>\
                        <option value="2419200">Delay 1 month</option>\
                        <option value="-1">Disable this fault</option>\
                        </select>'.replace(optionContent,optionContent+' selected'));td.innerHTML=sb.toString();var btnAccept=document.createElement('button');btnAccept.className="btn btn-primary";btnAccept.textContent='Accept';btnAccept.style.cssFloat='right';btnAccept.style.marginRight='5px';btnAccept.onclick=function(e){var faultId=e.currentTarget.parentElement.parentElement.id.replace('paneFaultEdit-','');var data={id:faultId,userId:AppConfig.userId,isUserDefined:document.getElementById('config-fault-'+faultId).getElementsByClassName('maskUserDefined')[0].checked,userFaultGrade:e.currentTarget.parentElement.getElementsByClassName('markGrade')[0].value,userFaultDelay:e.currentTarget.parentElement.getElementsByClassName('markAdvanced')[0].value};WebAPI.post('/diagnosis/fault/customUpdate/'+AppConfig.projectId,data).done(function(result){if(result!='true')new Alert(e.currentTarget.parentElement,'warning','Refused modify')
var fault=_this.parent.dictFault[faultId];fault.userFaultGrade=data.userFaultGrade;fault.userFaultDelay=data.userFaultDelay;fault.isUserDefined=data.isUserDefined;fault.userId=data.userId;fault.userName=AppConfig.account;_this.init();});};var btnCancel=document.createElement('button');btnCancel.className="btn btn-default";btnCancel.textContent='Cancel';btnCancel.style.cssFloat='right';btnCancel.style.marginRight='5px';btnCancel.onclick=function(e){_this.init();};td.appendChild(btnCancel);td.appendChild(btnAccept);tr.appendChild(td);},getFaultStatus:function(fault){if(fault.isUserDefined){if(fault.userFaultDelay==-1)return'Disable';if(fault.userFaultDelay==0)return'Real-time';var remain=fault.userFaultDelay*1000-(new Date()-new Date(fault.userModifyTime*1000));if(remain>0){var remain=new Date(remain);var sb=new StringBuilder();sb.append('<td title="Remaining ').append(remain.getDay()?remain.getDay()+'Day ':'').append(remain.getHours()?remain.getHours()+'Hour ':'').append(remain.getMinutes()?remain.getMinutes()+'Min ':'').append('">').append(remain.getDay()?remain.getDay()+'D_':'').append(remain.getHours()?remain.getHours()+':':'').append(remain.getMinutes()?remain.getMinutes():'').append('</td>');return sb.toString();}
else{return'Real-time';}}
else{return'Real-time';}}}
return DiagnosisFaultConfig;})();var TemperatureSetting=(function(){function TemperatureSetting(){this.viewModel=null;this.init();}
TemperatureSetting.prototype={show:function(){$('#dialogModal').modal();},init:function(){var _this=this;WebAPI.get("/static/views/observer/widgets/temperatureSetting.html").done(function(resultHtml){var $dialogContent=$("#dialogContent");$dialogContent.html(resultHtml);_this.renderView();_this.attachEvent();$('#dialogContent').removeClass('modal-lg');I18n.fillArea($dialogContent);});},renderView:function(){var _this=this;this.loadModel().done(function(){var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){$("#slider-range").ionRangeSlider({min:0,max:50,from:parseInt(_this.viewModel[0].value),to:parseInt(_this.viewModel[1].value),type:'double',step:1,prefix:"",postfix:"℃",prettify:true,hasGrid:true,onChange:function(obj){$rangeLeft.css("width",obj.fromX+11+'px');$rangeRight.css("width",$("#rangeWrapper").width()-obj.toX+11+'px');},onFinish:function(obj){$rangeLeft.css("width",obj.fromX+11+'px');$rangeRight.css("width",$("#rangeWrapper").width()-obj.toX+11+'px');}});var $rangeLeft=$("#rangeWrapper .irs-line-left");var $rangeRight=$("#rangeWrapper .irs-line-right");var leftStr=$("#rangeWrapper .irs-slider").eq(0).css("left");var rightStr=$("#rangeWrapper .irs-slider").eq(1).css("left");var widthLeft=parseFloat(leftStr.substr(0,leftStr.length-2))+11+'px';var widthRight=parseFloat($("#rangeWrapper").width()-rightStr.substr(0,leftStr.length-2))+11+'px';$rangeLeft.css("width",widthLeft);$rangeRight.css("width",widthRight);},300);});},loadModel:function(){var _this=this;return WebAPI.post('/admin/getColorSetting',{userId:AppConfig.userId}).done(function(result){if(result.success){_this.viewModel=result.data;}})},attachEvent:function(){var _this=this;$('#btnSaveSetting').off().click(function(){_this.viewModel[0].value=parseFloat($("#rangeWrapper .irs-from").text());_this.viewModel[1].value=parseFloat($("#rangeWrapper .irs-to").text());WebAPI.post('/admin/setColorSetting',{'setting':_this.viewModel,userId:AppConfig.userId}).done(function(result){if(result.success){var alert=new Alert($('#dialogModal'),Alert.type.success,I18n.resource.code['2002']);alert.showAtTop(2000);}})});$('#dialogModal').on('hidden.bs.modal',function(){$('#dialogContent').addClass('modal-lg');});}};return TemperatureSetting;})();var DataCalcFilter=(function(){function DataCalcFilter(base){this.m_base=base;this.m_screen=base.screen;this.m_curModal=base.screen.curModal;if(!this.m_curModal.arrFilter){this.m_curModal.arrFilter=[];}
if(base.chart){this.m_chartOption=base.chart.getOption();}
this.m_dictShowData=this.m_curModal.dictShowData;this.m_arrDsItem=[];this.m_arrDsId=this.m_curModal.itemDS[0].arrId;for(var i=0,len=this.m_arrDsId.length;i<len;i++){var itemTemp=AppConfig.datasource.getDSItemById(this.m_arrDsId[i]);itemTemp.alphabet=this.getAlphabetByNum(i);this.m_arrDsItem.push(itemTemp);}
this.m_nInterval=0;var format=this.m_curModal.format;switch(format){case'm1':this.m_nInterval=60000;break;case'm5':this.m_nInterval=300000;break;case'h1':this.m_nInterval=3600000;break;case'd1':this.m_nInterval=86400000;break;default:this.m_nInterval=3600000;break;}
this.$parentContain=$('#paneContent');this.$anlsPaneContain=$('#anlsPaneContain');this.$wrap;this.m_tmStart;this.m_tmEnd;this.m_tmCycle;};DataCalcFilter.prototype={show:function(){var _this=this;WebAPI.get('/static/views/observer/widgets/dataCalcFilter.html').done(function(resultHTML){_this.$wrap=$('<div class="modal-db-history-wrap" id="wrapDataFilter">').html(resultHTML);_this.$parentContain.append(_this.$wrap);_this.$anlsPaneContain.css('display','none');_this.$page=_this.$wrap.children('#pageDataFilter');I18n.fillArea($('#pageDataFilter'));_this.init();});},init:function(){this.$btnFilter=$('#btnFilter',this.$page);this.$btnCancel=$('#btnCancel',this.$page);this.$iconCancel=$('#iconCancel',this.$page);this.$selPtList=$('#selectPtList',this.$page);this.$chkPtList=$('#checkPtList',this.$page);this.$filterCodition=$('#filterCondition',this.$page);this.$mathCfgData=$('#varConfigData',this.$page);this.$radioFilTp1=$('#radioFilterType1',this.$page);this.$radioFilTp2=$('#radioFilterType2',this.$page);this.$tmStart=$('#timeStart',this.$page);this.$inputValLen=$('#inputValLen',this.$page);this.$inputCycleLen=$('#inputCycleLen',this.$page);this.$tmEnd=$('#timeEnd',this.$page);this.$tmCycle=$('#timeCycle',this.$page);this.$divInputValLen=$('#divValLen',this.$page);this.$divInputCycleLen=$('#divCycleLen',this.$page);this.$divTmEnd=$('#divTmEnd',this.$page);this.$divTmCycle=$('#divTmCycle',this.$page);this.$radioShowNone=$('#radioShowNone',this.$page);this.$radioShowColor=$('#radioShowColor',this.$page);this.$btnLogicAnd=$('#btnLogicAnd',this.$page);this.$btnLogicOr=$('#btnLogicOr',this.$page);this.$btnLogicNot=$('#btnLogicNot',this.$page);this.initCloseControl();this.initCheckButton();this.initFilterCondition();this.initVarGrid();this.initRadioControl();this.initTimeControl();this.initLogicButton();},initCloseControl:function(){var _this=this;this.$btnFilter.off().click(function(e){_this.filterOperationCheckButton();});this.$btnCancel.off().click(function(e){_this.close();});this.$iconCancel.off().click(function(e){_this.close();});},close:function(){this.$wrap.remove();this.$anlsPaneContain.css('display','block');},initComboBox:function(){var _this=this;this.$selPtList.empty();var item;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){item=$('<option value="'+this.m_arrDsItem[i].id+'">'+this.m_arrDsItem[i].alias+'</option>');this.$selPtList.append(item);}
this.$selPtList.change(function(e){var selPtId=_this.$selPtList.val();for(var i=0,len=_this.m_curModal.arrFilter.length;i<len;i++){var item=_this.m_curModal.arrFilter[i];if(selPtId==item.pointId){_this.$filterCodition.val(item.filterCondition);_this.$tmStart.val(item.timeStart);_this.$inputValLen.val(item.valLen);_this.$inputCycleLen.val(item.cycleLen);_this.$tmEnd.val(item.timeEnd);_this.$tmCycle.val(item.timeCycle);(0==item.showType)?(_this.$radioShowNone.click()):(_this.$radioShowColor.click());(0==item.filterType)?(_this.$radioFilTp1.click()):(_this.$radioFilTp2.click());break;}}});},initCheckButton:function(){this.$chkPtList.empty();var item;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){item='<div class="checkbox"><label><input type="checkbox" value="'+this.m_arrDsItem[i].id+'">'+this.m_arrDsItem[i].alias+'</label></div>';this.$chkPtList.append(item);}},initFilterCondition:function(){this.$filterCodition.mathquill('editable');var arrFilter=this.m_curModal.arrFilter;var codition;for(var i=0,len=arrFilter.length;i<len;i++){if(true){codition=arrFilter[i].filterCondition;break;}}
if(codition){this.$filterCodition.mathquill('latex',codition);}},initVarGrid:function(){this.$mathCfgData.empty();var item;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){item=$('<div class="row">\
                                <div class="col-xs-12 varRow">\
                                    <div class="col-xs-4 formulaVarName"><input type="text" name="inputVarValue" class="varNameChange">'+this.m_arrDsItem[i].alphabet+'</div>\
                                    <div class="col-xs-6 divVarValue" varid="'+this.m_arrDsItem[i].id+'">'+this.m_arrDsItem[i].alias+'</div>\
                                </div>\
                            </div>');this.$mathCfgData.append(item);}},initRadioControl:function(){var _this=this;this.$radioFilTp1.next().text(I18n.resource.analysis.dataFilter.COUNT_SELECT);this.$radioFilTp2.next().text(I18n.resource.analysis.dataFilter.TIME_SELECT);this.$radioShowNone.next().text(I18n.resource.analysis.dataFilter.SHOW_NONE);this.$radioShowColor.next().text(I18n.resource.analysis.dataFilter.SHOW_DOT);this.$radioFilTp1.click();this.setFilterTypeControl(true);this.$radioFilTp1.click(function(e){_this.setFilterTypeControl(true);});this.$radioFilTp2.click(function(e){_this.setFilterTypeControl(false);});this.$radioShowNone.click();this.$radioShowNone.click(function(e){});this.$radioShowColor.click(function(e){});},initTimeControl:function(){var _this=this;var tmStart=new Date(this.m_chartOption.xAxis[0].data[0]);var xLen=this.m_chartOption.xAxis[0].data.length;var tmEnd=new Date(this.m_chartOption.xAxis[0].data[xLen-1]);this.m_tmStart=tmStart;this.$tmStart.val(tmStart.format('yyyy-MM-dd HH:00'));this.$tmStart.datetimepicker({format:'yyyy-mm-dd hh:00',startView:'month',minView:'day',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmStart,startDate:tmStart,endDate:tmEnd,keyboardNavigation:false}).off('changeDate').on('changeDate',function(e){var timeVal=_this.$tmStart.val();_this.m_tmStart=new Date(timeVal.replace(/-/,'/'));});this.m_tmEnd=tmEnd;this.$tmEnd.val(tmEnd.format('yyyy-MM-dd HH:00'));this.$tmEnd.datetimepicker({format:'yyyy-mm-dd hh:00',startView:'month',minView:'day',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmStart,startDate:tmStart,endDate:tmEnd,keyboardNavigation:false}).off('changeDate').on('changeDate',function(e){var timeVal=_this.$tmEnd.val();_this.m_tmEnd=new Date(timeVal.replace(/-/,'/'));});this.m_tmCycle=tmStart;this.$tmCycle.val(tmStart.format('yyyy-MM-dd HH:00'));this.$tmCycle.datetimepicker({format:'yyyy-mm-dd hh:00',startView:'month',minView:'day',autoclose:true,todayBtn:false,pickerPosition:'top-right',initialDate:tmStart,startDate:tmStart,endDate:tmEnd,keyboardNavigation:false}).off('changeDate').on('changeDate',function(e){var timeVal=_this.$tmCycle.val();_this.m_tmCycle=new Date(timeVal.replace(/-/,'/'));});},initLogicButton:function(){var _this=this;this.$btnLogicAnd.click(function(e){_this.$filterCodition.mathquill('write','&');});this.$btnLogicOr.click(function(e){_this.$filterCodition.mathquill('write','\\mid');});this.$btnLogicNot.click(function(e){_this.$filterCodition.mathquill('write','!');});},getAlphabetByNum:function(num){var alphabet;num=num%26;switch(num){case 0:alphabet='a';break;case 1:alphabet='b';break;case 2:alphabet='c';break;case 3:alphabet='d';break;case 4:alphabet='e';break;case 5:alphabet='f';break;case 6:alphabet='g';break;case 7:alphabet='h';break;case 8:alphabet='i';break;case 9:alphabet='j';break;case 10:alphabet='k';break;case 11:alphabet='l';break;case 12:alphabet='m';break;case 13:alphabet='n';break;case 14:alphabet='o';break;case 15:alphabet='p';break;case 16:alphabet='q';break;case 17:alphabet='r';break;case 18:alphabet='s';break;case 19:alphabet='t';break;case 20:alphabet='u';break;case 21:alphabet='v';break;case 22:alphabet='w';break;case 23:alphabet='x';break;case 24:alphabet='y';break;case 25:alphabet='z';break;default:alphabet='a';break;}
return alphabet;},setFilterTypeControl:function(bIsType1){if(bIsType1){this.$divInputValLen.css('display','block');this.$divInputCycleLen.css('display','block');this.$divTmEnd.css('display','none');this.$divTmCycle.css('display','none');}
else{this.$divInputValLen.css('display','none');this.$divInputCycleLen.css('display','none');this.$divTmEnd.css('display','block');this.$divTmCycle.css('display','block');}},getFormula:function(){var $varRow=$('#varConfig .varRow');var latexMathValue=this.$filterCodition.mathquill('latex');var varNum=$varRow.length;var varId,varName;var searchReg;var varError=new Array;$('.varLack').remove();for(var i=0;i<varNum;i++){varName=$($varRow.find('.formulaVarName').get(i));varId=$varRow.children('.divVarValue').eq(i).attr('varid');searchReg=new RegExp('\\b'+varName.text()+'\\b','g');if(searchReg.test(latexMathValue)){if(varId){latexMathValue=latexMathValue.replace(searchReg,'<%'+varId+'%>');}else{varError.push(varName);}}}
if(varError.length>0){for(var ele=0;ele<varError.length;++ele){varError[ele].append($('<span class="varLack">Unassigned!<span>'));}
alert('Lack Variable in Formula');return'error';}
return latexMathValue;},filterDataByInput:function(nCnt,nStartCnt,nValLen,nCycleLen,fmtType){var oneUnit=0;switch(fmtType){case'm1':oneUnit=1440;break;case'm5':oneUnit=288;break;case'h1':oneUnit=24;break;case'd1':oneUnit=30;break;case'M1':oneUnit=12;break;default:oneUnit=24;}
if(nCnt<nStartCnt||nCnt>nStartCnt+nCycleLen){return 2;}
else{if(nValLen<nCycleLen){var bFind=false;var loopCnt=Math.ceil(nCycleLen/oneUnit);for(var i=0;i<loopCnt;i++){var begin=nStartCnt+oneUnit*i;if(nCnt>=begin&&nCnt<=begin+nValLen){bFind=true;break;}}
if(bFind){return 0;}
else{return 1;}}
else{return 0;}}},filterOperationCombox:function(){var _this=this;var filterCondition=this.$filterCodition.mathquill('latex');if(!filterCondition){alert('Please input filter condition !');this.$filterCodition.select();return;}
var strPtId=this.$selPtList.val();var radioFilterVal=this.$page.find('input:radio[name=radioFilterType]:checked').val();var radioShowVal=this.$page.find('input:radio[name=radioShowType]:checked').val();var nFilterType=('optionFilterType1'==radioFilterVal)?0:1;var nShowType=('optionShowType1'==radioShowVal)?0:1;var item={'pointId':strPtId,'filterCondition':filterCondition,'filterType':nFilterType,'timeStart':_this.$tmStart.val().format("yyyy-MM-dd HH:mm:ss"),'valLen':parseInt(_this.$inputValLen.val()),'cycleLen':parseInt(_this.$inputCycleLen.val()),'timeEnd':_this.$tmEnd.val().format("yyyy-MM-dd HH:mm:ss"),'timeCycle':_this.$tmCycle.val().format("yyyy-MM-dd HH:mm:ss"),'showType':nShowType,'filterDrawObj':{},'appendData':[]};var condition=this.$filterCodition.mathquill('latex');var dataObj={};for(var i=0,len1=this.m_arrDsItem.length;i<len1;i++){var alph=this.m_arrDsItem[i].alphabet;if(-1!=condition.indexOf(alph)){var id=this.m_arrDsItem[i].id;dataObj[alph]=this.m_dictShowData[id];}}
var dataTarget;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(strPtId==this.m_arrDsItem[i].id){dataTarget=this.m_arrDsItem[i].alphabet;break;}}
if(-1==condition.indexOf(dataTarget)){alert(I18n.resource.analysis.dataFilter.ERR2);return;}
var postData={'express':condition,'params':dataObj,'target':dataTarget};WebAPI.post('/expressAnalysis/calc',postData).done(function(result){var res=JSON.parse(result);if(res.error){return;}
for(var i=0,len=res.data.length;i<len;i++){if(!res.data[i]){res.data[i]=undefined;}}
var id='';for(var i=0,len=_this.m_arrDsItem.length;i<len;i++){if(res.name==_this.m_arrDsItem[i].alphabet){id=_this.m_arrDsItem[i].id;break;}}
var nStartVal=Date.parse(item.timeStart);var nStartCnt=0;var xLen=_this.m_chartOption.xAxis[0].data.length;if(nStartVal>Date.parse(_this.m_chartOption.xAxis[0].data[xLen-1])){alert('Out of range!');return;}
if(nStartVal<Date.parse(_this.m_chartOption.xAxis[0].data[0])){nStartVal=Date.parse(_this.m_chartOption.xAxis[0].data[0]);}
for(var i=0;i<xLen;i++){if(Date.parse(_this.m_chartOption.xAxis[0].data[i])>=nStartVal){nStartCnt=i;break;}}
var nValidateLen=0;var nCycleLen=0;if(1==item.filterType){var nStart=Date.parse(item.timeStart);var nEnd=Date.parse(item.timeEnd);var nCycle=Date.parse(item.timeCycle);var unit=0;switch(_this.m_curModal.format){case'm1':unit=60000;break;case'm5':unit=300000;break;case'h1':unit=3600000;break;case'd1':unit=86400000;break;default:unit=3600000;break;}
nValidateLen=Math.floor((nEnd-nStart)/unit);nCycleLen=Math.floor((nCycle-nStart)/unit);}
else{nValidateLen=item.valLen;nCycleLen=item.cycleLen;}
var filterVal=[];for(var i=0,len=res.data.length;i<len;i++){var flag=_this.filterDataByInput(i,nStartCnt,nValidateLen,nCycleLen,_this.m_curModal.format);switch(flag){case 0:filterVal.push(res.data[i]);break;case 1:case 2:filterVal.push(undefined);break;default:filterVal.push(undefined);break;}}
var redrawObj={list:[],timeShaft:[]};redrawObj.list.push({'dsItemId':id,'data':filterVal});redrawObj.timeShaft=_this.m_chartOption.xAxis[0].data;item.filterDrawObj=redrawObj;var dataLen=res.data.length;for(var j=0;j<dataLen;j++){var arrOrigData=dataObj[res.name];if(Boolean(arrOrigData)&&Boolean(arrOrigData[j])&&!filterVal[j]){item.appendData.push(arrOrigData[j]);}
else{item.appendData.push(undefined);}}
var tempCnt=[];for(var k=0;k<dataLen;k++){if(0==k){if(!item.appendData[k]&&item.appendData[k+1]&&filterVal[k]){tempCnt.push(k);}
if(item.appendData[k]&&!item.appendData[k+1]&&filterVal[k+1]){tempCnt.push(k+1);}}
else{if(!item.appendData[k-1]&&item.appendData[k]&&filterVal[k-1]){tempCnt.push(k-1);}
if(item.appendData[k-1]&&!item.appendData[k]&&filterVal[k]){tempCnt.push(k);}}}
for(var m=0,lenM=tempCnt.length;m<lenM;m++){item.appendData[tempCnt[m]]=filterVal[tempCnt[m]];}
var bFind=false;for(var i=0,len=_this.m_curModal.arrFilter.length;i<len;i++){if(id==_this.m_curModal.arrFilter[i].pointId){bFind=true;break;}}
if(bFind){_this.m_curModal.arrFilter[i]=item;}
else{_this.m_curModal.arrFilter.push(item);}
_this.m_base.showFilterCharts();_this.m_screen.saveModal();_this.m_screen.saveModalJudge.resolveWith(_this.m_screen,[_this.m_screen,1,null,$('#divWSPane .selected'),_this.m_screen.curModal,false]);_this.close();}).always(function(e){});},filterOperationCheckButton:function(){var _this=this;var condition=this.$filterCodition.mathquill('latex');if(!condition){alert('Please input filter condition !');this.$filterCodition.select();return;}
var arrChk=this.$chkPtList.find('input');var arrPtId=[];for(var i=0,len=arrChk.length;i<len;i++){if(this.$chkPtList.find('input')[i].checked){arrPtId.push(this.$chkPtList.find('input')[i].value);}}
if(arrPtId.length<=0){alert(I18n.resource.analysis.dataFilter.ERR1);return;}
var nCnt=0;var arrTargetId=[];var bCheckOk=false;for(var n=0,lenN=arrPtId.length;n<lenN;n++){for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(this.m_arrDsItem[i].id==arrPtId[n]){if(-1!=condition.indexOf(this.m_arrDsItem[i].alphabet)){bCheckOk=true;break;}}}
if(bCheckOk){break;}}
if(!bCheckOk){alert(I18n.resource.analysis.dataFilter.ERR2);return;}
for(var n=0,lenN=arrPtId.length;n<lenN;n++){var strPtId=arrPtId[n];var radioFilterVal=this.$page.find('input:radio[name=radioFilterType]:checked').val();var radioShowVal=this.$page.find('input:radio[name=radioShowType]:checked').val();var nFilterType=('optionFilterType1'==radioFilterVal)?0:1;var nShowType=('optionShowType1'==radioShowVal)?0:1;var tmStart=_this.$tmStart.val().format("yyyy-MM-dd HH:mm:ss");var nValLen=parseInt(_this.$inputValLen.val());var nCycLen=parseInt(_this.$inputCycleLen.val());var tmEnd=_this.$tmEnd.val().format("yyyy-MM-dd HH:mm:ss");var tmCyc=_this.$tmCycle.val().format("yyyy-MM-dd HH:mm:ss");var dataObj={};for(var i=0,len1=this.m_arrDsItem.length;i<len1;i++){var alph=this.m_arrDsItem[i].alphabet;if(-1!=condition.indexOf(alph)){var id=this.m_arrDsItem[i].id;dataObj[alph]=this.m_dictShowData[id];}}
var dataTarget;for(var i=0,len=this.m_arrDsItem.length;i<len;i++){if(strPtId==this.m_arrDsItem[i].id){dataTarget=this.m_arrDsItem[i].alphabet;break;}}
var postData={'express':condition,'params':dataObj,'target':dataTarget};WebAPI.post('/expressAnalysis/calc',postData).done(function(result){var res=JSON.parse(result);if(res.error){_this.close();return;}
for(var i=0,len=res.data.length;i<len;i++){if(!res.data[i]){res.data[i]=undefined;}}
var id='';for(var i=0,len=_this.m_arrDsItem.length;i<len;i++){if(res.name==_this.m_arrDsItem[i].alphabet){id=_this.m_arrDsItem[i].id;arrTargetId.push(id);break;}}
var item={'pointId':id,'filterCondition':condition,'filterType':nFilterType,'timeStart':tmStart,'valLen':nValLen,'cycleLen':nCycLen,'timeEnd':tmEnd,'timeCycle':tmCyc,'showType':nShowType,'filterDrawObj':{},'appendData':[]};var nStartVal=Date.parse(item.timeStart);var nStartCnt=0;var xLen=_this.m_chartOption.xAxis[0].data.length;if(nStartVal>Date.parse(_this.m_chartOption.xAxis[0].data[xLen-1])){alert('Out of range!');return;}
if(nStartVal<Date.parse(_this.m_chartOption.xAxis[0].data[0])){nStartVal=Date.parse(_this.m_chartOption.xAxis[0].data[0]);}
for(var i=0;i<xLen;i++){if(Date.parse(_this.m_chartOption.xAxis[0].data[i])>=nStartVal){nStartCnt=i;break;}}
var nValidateLen=0;var nCycleLen=0;if(1==item.filterType){var nStart=Date.parse(item.timeStart);var nEnd=Date.parse(item.timeEnd);var nCycle=Date.parse(item.timeCycle);var unit=0;switch(_this.m_curModal.format){case'm1':unit=60000;break;case'm5':unit=300000;break;case'h1':unit=3600000;break;case'd1':unit=86400000;break;default:unit=3600000;break;}
nValidateLen=Math.floor((nEnd-nStart)/unit);nCycleLen=Math.floor((nCycle-nStart)/unit);}
else{nValidateLen=item.valLen;nCycleLen=item.cycleLen;}
var filterVal=[];for(var i=0,len=res.data.length;i<len;i++){var flag=_this.filterDataByInput(i,nStartCnt,nValidateLen,nCycleLen,_this.m_curModal.format);switch(flag){case 0:filterVal.push(res.data[i]);break;case 1:case 2:filterVal.push(undefined);break;default:filterVal.push(undefined);break;}}
var redrawObj={list:[],timeShaft:[]};redrawObj.list.push({'dsItemId':id,'data':filterVal});redrawObj.timeShaft=_this.m_chartOption.xAxis[0].data;item.filterDrawObj=redrawObj;var dataLen=res.data.length;for(var j=0;j<dataLen;j++){var arrOrigData=dataObj[res.name];if(Boolean(arrOrigData)&&Boolean(arrOrigData[j])&&!filterVal[j]){item.appendData.push(arrOrigData[j]);}
else{item.appendData.push(undefined);}}
var tempCnt=[];for(var k=0;k<dataLen;k++){if(0==k){if(!item.appendData[k]&&item.appendData[k+1]&&filterVal[k]){tempCnt.push(k);}
if(item.appendData[k]&&!item.appendData[k+1]&&filterVal[k+1]){tempCnt.push(k+1);}}
else{if(!item.appendData[k-1]&&item.appendData[k]&&filterVal[k-1]){tempCnt.push(k-1);}
if(item.appendData[k-1]&&!item.appendData[k]&&filterVal[k]){tempCnt.push(k);}}}
for(var m=0,lenM=tempCnt.length;m<lenM;m++){item.appendData[tempCnt[m]]=filterVal[tempCnt[m]];}
var bFind=false;for(var i=0,len=_this.m_curModal.arrFilter.length;i<len;i++){if(id==_this.m_curModal.arrFilter[i].pointId){bFind=true;break;}}
item.pointId=id;if(bFind){_this.m_curModal.arrFilter[i]=item;}
else{_this.m_curModal.arrFilter.push(item);}
nCnt++;if(nCnt>=lenN){for(var p=0,lenP=arrTargetId.length;p<lenP;p++){_this.m_screen.curModal.dictShowFlag[arrTargetId[p]]=false;_this.m_screen.curModal.dictShowFlag[arrTargetId[p]+'_filter']=true;}
_this.m_base.showFilterCharts(_this.m_chartOption.series);for(var p=0,lenP=_this.m_curModal.arrFilter.length;p<lenP;p++){var itemTemp=_this.m_curModal.arrFilter[p];_this.m_base.resetShowData(itemTemp.filterDrawObj,1);_this.m_base.resetShowData({list:[{'dsItemId':item.pointId,'data':itemTemp.appendData}],timeShaft:item.filterDrawObj.timeShaft},2);}
for(var p=0,lenP=arrTargetId.length;p<lenP;p++){for(var q=0,lenQ=_this.m_chartOption.series.length;q<lenQ;q++){if(arrTargetId[p]==_this.m_chartOption.series[q].id){_this.m_chartOption.series[q].data=[];break;}}}
_this.m_base.resetIcon(arrTargetId);_this.m_base.setTendencyOption(_this.m_chartOption.series);_this.m_screen.saveModal();_this.m_screen.saveModalJudge.resolveWith(_this.m_screen,[_this.m_screen,1,null,$('#divWSPane .selected'),_this.m_screen.curModal,false]);_this.close();}}).always(function(e){});}}};return DataCalcFilter;})();var ModalAppendPointToDs=(function(){function ModalAppendPointToDs(bPtHasId,pointIdList,pointNameList){this.bPointHasId=bPtHasId;this.arrDs=[];this.groupInfo=undefined;if(bPtHasId){for(var i=0,len=pointIdList.length;i<len;i++){var id=pointIdList[i];this.arrDs.push({'id':id,'name':AppConfig.datasource.getDSItemById(id).alias});}}
else{for(var i=0,len=pointNameList.length;i<len;i++){this.arrDs.push({'id':null,'name':pointNameList[i]});}}}
ModalAppendPointToDs.prototype.show=function(){var _this=this;if(this.bPointHasId){domPanelContent=document.getElementById('paneCenter');}
else{var domTemp=document.getElementById('divObserverCanvas');if(!domTemp){domTemp=document.getElementById('paneCenter');}
domPanelContent=domTemp;}
if(domPanelContent){Spinner.spin(domPanelContent);}
WebAPI.get('/static/views/observer/widgets/modalAppendPointToDs.html').done(function(html){_this.$wrap=$('<div class="modal-db-history-wrap" id="modalJumpPageWrap">').appendTo(domPanelContent).html(html);_this.$modal=_this.$wrap.children('.modal');_this.$modal.modal('show');if(_this.bPointHasId){_this.groupInfo=AppConfig.datasource.m_parent.store.group;_this.init();}
else{WebAPI.get('/datasource/getGroupInfo/'+AppConfig.userId).done(function(result){_this.groupInfo=JSON.parse(result);_this.init();}).always(function(e){Spinner.stop();});}}).always(function(e){Spinner.stop();});};ModalAppendPointToDs.prototype.init=function(){I18n.fillArea(this.$modal);this.$divPtList=$('#ptList',this.$modal);this.$selGroup=$('#selectGroup',this.$modal);this.$btnImport=$('#btnImport',this.$modal);this.$inputNewGroup=$('#inputNewGroup',this.$modal);this.initPointList();this.initComboBox();this.attachEvents();};ModalAppendPointToDs.prototype.initPointList=function(){this.$divPtList.empty();var item;for(var i=0,len=this.arrDs.length;i<len;i++){item=$('<label class="checkboxShow"><input type="checkbox" value="'+this.arrDs[i].id+'" checked>'+this.arrDs[i].name+'</label>');this.$divPtList.append(item);}};ModalAppendPointToDs.prototype.initComboBox=function(){var _this=this;this.$selGroup.empty();var item;for(var i=0,len=this.groupInfo.length;i<len;i++){item=$('<option value="'+this.groupInfo[i].groupId+'">'+this.groupInfo[i].groupName+'</option>');this.$selGroup.append(item);}
var itemNew=$('<option value="new" style="color:#0000ff;font-weight:900;">New Group</option>');this.$selGroup.append(itemNew);this.$selGroup.click(function(e){var selGroupVal=_this.$selGroup.find("option:selected")[0].value;if('new'==selGroupVal){_this.$inputNewGroup.css('display','block');}
else{_this.$inputNewGroup.css('display','none');}});};ModalAppendPointToDs.prototype.attachEvents=function(){var _this=this;this.$btnImport.off().click(function(e){var arrPoint=[];var check=_this.$divPtList.find('input');for(var i=0,len=check.length;i<len;i++){if(check[i].checked){arrPoint.push({id:check[i].value,name:$(check[i]).parent().text()});}}
if(0==arrPoint.length){alert(I18n.resource.dashboard.modalJumpPages.NO_FIT_POINT);return;}
var selGroupVal=_this.$selGroup.find("option:selected")[0].value;if('new'==selGroupVal){var groupName=_this.$inputNewGroup.val();if(''==groupName){alert('Please input group name !');_this.$inputNewGroup.focus();return;}
var postData={'groupId':'','name':groupName,'parent':'','userId':AppConfig.userId}
WebAPI.post('/datasource/saveDataSourceGroup',postData).done(function(result){var data=JSON.parse(result);if(!data.error){return;}
var groupId=data.groupId;var groupItem={'datasourceList':[],'groupId':groupId,'groupName':data.groupName,'parentId':''};_this.groupInfo.push(groupItem);_this.insertItemIntoGroup(groupId,arrPoint);}).always(function(e){});}
else{_this.insertItemIntoGroup(selGroupVal,arrPoint);}});};ModalAppendPointToDs.prototype.insertItemIntoGroup=function(groupId,arrPoint){var _this=this;var postData={itemList:[]};var arrItem=[];if(this.bPointHasId){for(var i=0,len=arrPoint.length;i<len;i++){var dsItem={};var temp=AppConfig.datasource.getDSItemById(arrPoint[i].id);dsItem.alias=temp.alias;dsItem.groupId=groupId;dsItem.note=temp.note;dsItem.projId=temp.projId;dsItem.type=temp.type;dsItem.value=temp.value;arrItem.push(dsItem);}}
else{for(var i=0,len=arrPoint.length;i<len;i++){var dsItem={};var ptName=arrPoint[i].name;dsItem.alias=ptName;dsItem.groupId=groupId;dsItem.note='';dsItem.projId=AppConfig.projectId;dsItem.type=0;dsItem.value=ptName;arrItem.push(dsItem);}}
postData.itemList=arrItem;WebAPI.post('/analysis/datasource/saveMulti',postData).done(function(result){var itemList=JSON.parse(result).itemIdList;var bSuccess=false;if(itemList&&_this.bPointHasId){for(var i=0,len=itemList.length;i<len;i++){for(var j=0,len1=_this.groupInfo.length;j<len1;j++){if(itemList[i].groupId==_this.groupInfo[j].groupId){_this.groupInfo[j].datasourceList.push(itemList[i]);bSuccess=true;break;}}}}
if(bSuccess||!_this.bPointHasId){if(confirm(I18n.resource.dashboard.modalJumpPages.SUCCESS_TIPS)){var pageTitle=$('#ulPages').children('li');if(Boolean(pageTitle)&&pageTitle.length>0){pageTitle.filter('.active').attr('class','');}
ScreenManager.show(AnalysisScreen);}
_this.$modal.modal('hide');}
else{alert(I18n.resource.dashboard.modalJumpPages.FAIL_TIPS);}}).always(function(e){});};return ModalAppendPointToDs;})();﻿
var ObserverScreen=(function(){var tObscreen=null;function ObserverScreen(id){this.id=id;this.container=undefined;this.$obCanvasContainer=undefined;this.$canvasContainer=undefined;this.canvas=undefined;this.ctx=undefined;this.cacheCanvas=undefined;this.cacheCtx=undefined;this.hitModel=undefined;this.workerUpdate=undefined;this.isRunning=true;this.store={};this.dictRefreshMap=undefined;this.stopWatch=undefined;this.dictPipelines=undefined;this.dictEquipments=undefined;this.dictCharts=undefined;this.dictGages=undefined;this.dictRulers=undefined;this.dictButtons=undefined;this.dictCheckboxs=undefined;this.dictTexts=undefined;this.dictTempDistributions=undefined;this.dictImages={};this.indexImageLoaded=0;this.isDetailPage=false;this.dialogTitle=undefined;this.isDataReady=false;this.isPlayback=false;this.toolContainer=undefined;}
ObserverScreen.prototype={show:function(container){var _this=this;if(_this.isDetailPage){_this.container=ElScreenContainer;_this.initContainer();Spinner.spin(_this.container);_this.init();}
else{_this.container=container||_this.container;if(_this.container){_this.initContainer();initHtml(_this.container);}else{_this.container=ElScreenContainer;WebAPI.get("/static/views/observer/observerScreen.html").done(function(resultHtml){$(_this.container).html(resultHtml);_this.initContainer();initHtml();});}
function initHtml(){Spinner.spin(_this.container);_this.init();I18n.fillArea($(_this.container));}}},initContainer:function(){if(this.container===ElScreenContainer){this.$obCanvasContainer=$('#divObserverCanvas');this.$canvasContainer=$('#canvasOverview');}else{this.$obCanvasContainer=$('.div-canvas-ctn',$(this.container));this.$canvasContainer=$('.canvas-ctn',$(this.container));}},close:function(){$('.observer-text-editor').remove();ModelText.destroy();var $toolBacktrace=$('.toolBacktrace');$toolBacktrace.remove();if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;for(var item in this.dictCharts)this.dictCharts[item].close();this.isRunning=null;this.canvas=null;this.ctx=null;this.cacheCanvas=null;this.store=null;this.dictRefreshMap=null;this.dictPipelines=null;this.dictGages=null;this.dictRulers=null;this.dictEquipments=null;this.dictButtons=null;this.dictTexts=null;this.dictCheckboxs=null;this.dictImages=null;this.hitModel=null;this.stopWatch=null;if(!this.isDetailPage){$('#ulTools').html('');if(ToolCurrent)ToolCurrent.close();ToolCurrent=null;}},stop:function(){this.isRunning=false;if(this.workerUpdate){this.workerUpdate.terminate();this.workerUpdate=null;}},resume:function(){this.isRunning=true;this.initWorkerForUpdating();requestAnimationFrame(animate);},resize:function(){this.initScreen();this.renderElements();if(this.workerUpdate){this.workerUpdate.terminate();this.initWorkerForUpdating();}},onresize:function(){ScreenCurrent.resize();},init:function(){var _this=this;WebAPI.get("/get_plant/"+AppConfig.projectId+"/"+this.id+"/"+AppConfig.userId).done(function(result){_this.store=JSON.parse(result);_this.initScreen();if(!_this.isDetailPage&&!_this.isInDashBoard)_this.initToolBar();_this.initImageDictionary();_this.renderElements();if(_this.isPlayback){ToolCurrent.requestDataForCurrentMoment(_this);}else{_this.initWorkerForUpdating();}
_this.initAnimation();}).error(function(e){alert(I18n.resource.observer.widgets.DATA_REQUEST_FAILED);Spinner.stop();});},renderElements:function(){this.hitModel=new HitModel(this.canvas);this.dictRefreshMap={};this.initPipelines();this.initEquipments();this.initCharts();this.initGages();this.initRulers();this.initCheckboxs();this.initButtons();this.initTexts();this.initTempDistribution();this.initHitModel();},initToolBar:function(ins){var _this=!ins?this:ins;var $btnDropdownNavList=$('#btnDropdownNavList');var $ele=$btnDropdownNavList.find('.toolBacktrace');if($ele.length>0){$ele.remove();}
this.toolContainer=$('#divObserverTools');var btnTimeShaft=$('<li class="iconWrap"><span class="glyphicon glyphicon-play-circle"></span><span class="dropdownNav"></span></li>').addClass('toolBacktrace');btnTimeShaft.children('.dropdownNav').text(I18n.resource.observer.widgets.BACKTRACE);btnTimeShaft.click(function(e){if(_this.isPlayback){_this.quitBacktraceMode(_this,e);}else{_this.enterBacktraceMode(_this,e);}});$('#ulTools').html('');$('#right-nav').find('#btnOperatingRecord').after(btnTimeShaft);if(_this.isInDiagnosis&&!_this.isPlayback)ToolCurrent=new TimeShaft(_this);},enterBacktraceMode:function(screen,e){var _this=screen?screen:this;_this.isPlayback=true;if(e){e.currentTarget.classList.add('selected');$(e.currentTarget).find('.dropdownNav').html(I18n.resource.observer.widgets.QUIT_TRACE);}
if(!ToolCurrent)ToolCurrent=new TimeShaft(_this);ToolCurrent.containerHeight=100;ToolCurrent.show();if(_this.workerUpdate){this.workerUpdate.terminate();this.workerUpdate=null;}
$.when(ToolCurrent.defer).done(function(){var jCanvas=_this.$obCanvasContainer;jCanvas.css({height:'100%',width:'100%'});var jParent=jCanvas.parent();var height=jCanvas.height()-ToolCurrent.containerHeight;var width=height*_this.canvas.width/_this.canvas.height;if(width>jParent.width()){width=jParent.width();height=width/(_this.canvas.width/_this.canvas.height);}
jCanvas.animate({height:height,width:width,marginTop:(jParent.height()-height-ToolCurrent.containerHeight)/2+'px'},400,function(){_this.initScreen();_this.renderElements();});});},quitBacktraceMode:function(screen,e){var _this=screen?screen:this;_this.isPlayback=false;if(e){e.currentTarget.classList.remove('selected');$(e.currentTarget).find('.dropdownNav').html(I18n.resource.observer.widgets.BACKTRACE);}
ToolCurrent.close();ToolCurrent=null;_this.$obCanvasContainer.animate({height:'100%',width:'100%'},300,function(){_this.initScreen();_this.renderElements();_this.initWorkerForUpdating();});},initScreen:function(){this.isDetailPage=(this.store.page.type!="fullscreen")&&!this.isInDashBoard;if(this.isDetailPage){var _this=this;var dialogWidth=this.store.page.width+40>$(window).width()?$(window).width()-200:this.store.page.width+40;var detailScreenModal=$('#detailScreenModal');var $toolBacktrace=$('.toolBacktrace');I18n.fillArea($('#detailScreenModal'));$toolBacktrace.remove();if(this.dialogTitle){var oldDialogTitle=detailScreenModal.find('.modal-title').text();detailScreenModal.find('.modal-title').text(this.dialogTitle);}
detailScreenModal.find('.modal-dialog').css("margin","0 auto 0 auto").css("width",dialogWidth);detailScreenModal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){if(ScreenModal){ScreenModal.close();ScreenModal=null;}
_this.initToolBar(tObscreen);Spinner.stop();oldDialogTitle&&$(this).find('.modal-title').text(oldDialogTitle);}).modal({});Spinner.spin(detailScreenModal.find('.modal-body')[0]);var paddingLeft=(1920-this.store.page.width)/2;var paddingTop=(955-this.store.page.height)/2;convertPositionToReal(this.store.equipments);convertPositionToReal(this.store.buttons);convertPositionToReal(this.store.texts);convertTempDistributionsToReal(this.store.tempDistributions);function convertPositionToReal(arr){if(arr){for(var i=0;i<arr.length;i++){var temp=arr[i];temp.x=temp.x-paddingLeft;temp.y=temp.y-paddingTop;}}}
function convertTempDistributionsToReal(dis){if(!dis){return}
dis.x-=paddingLeft;dis.y-=paddingTop;convertPositionToReal(dis.data);}}else{if(ScreenModal&&!this.isInDiagnosis){if(ScreenCurrent)ScreenCurrent.close();ScreenCurrent=ScreenModal;ScreenModal=null;}
if(this.isInDiagnosis)this.diagScreen.obScreen=this;tObscreen=this;$("#page-"+this.id).parent().addClass("active");if(!this.isPlayback){$('.div-canvas-ctn').css({marginTop:0});}}
if(this.isDetailPage){this.canvas=document.getElementById("canvasDetail");}else{this.canvas=this.$canvasContainer[0];}
this.ctx=this.canvas.getContext("2d");this.canvas.width=this.store.page.width;this.canvas.height=this.store.page.height;},initWorkerForUpdating:function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);this.workerUpdate.postMessage({projectId:AppConfig.projectId,id:this.id,pointList:Object.keys(this.dictRefreshMap),type:"dataRealtime"});},initAnimation:function(){var _this=this;this.stopWatch=new Stopwatch();this.stopWatch.start();requestAnimationFrame(animate);function animate(){if(_this.isRunning){_this.ctx.clearRect(0,0,_this.canvas.width,_this.canvas.height);var item,element,time=_this.stopWatch.getElapsedTime();for(item in _this.dictPipelines){element=_this.dictPipelines[item];element.update(_this.ctx,250);}
for(item in _this.dictEquipments){element=_this.dictEquipments[item];element.update(null,time);element.refreshImage(_this.store.animationList,_this.dictImages);}
for(var i=0;i<10;i++){for(item in _this.dictPipelines){element=_this.dictPipelines[item];if(element.layer==i)element.paint(_this.ctx);}
for(item in _this.dictEquipments){element=_this.dictEquipments[item];if(element.layer==i)element.paint(_this.ctx);}
for(item in _this.dictButtons){element=_this.dictButtons[item];if(element.layer==i)element.paint(_this.ctx);}
for(item in _this.dictTempDistributions){element=_this.dictTempDistributions[item];if(element.layer==i)element.paint(_this.ctx);}}
for(item in _this.dictCharts){_this.dictCharts[item].paint(_this.ctx);}
for(item in _this.dictGages){_this.dictGages[item].paint(_this.ctx);}
for(item in _this.dictRulers){_this.dictRulers[item].paint(_this.ctx);}
for(item in _this.dictTexts){element=_this.dictTexts[item];element.paint(_this.ctx);}
for(item in _this.dictCheckboxs)_this.dictCheckboxs[item].paint(_this.ctx);requestAnimationFrame(animate);}}},initHitModel:function(){var _this=this;var $canvas=this.isDetailPage?$("#canvasDetail"):this.$canvasContainer;if(_this.canvas.scrollWidth>0){_this.hitModel.scaleX=_this.store.page.width/_this.canvas.scrollWidth;_this.hitModel.scaleY=_this.store.page.height/_this.canvas.scrollHeight;}
$canvas.off('click').click(function(e){if(!_this.hitModel)return;var result=_this.hitModel.firstHitId(e.clientX,e.clientY,null);if(result&&result.id&&result.id!=""){var item=_getHitModelItem(result.type,result.id);item&&item.mouseDown&&item.mouseDown(e);if(item instanceof ModelRuler.ModelRulerCurrentReference){console.log('click ModelRulerCurrentReference');}else if(item instanceof ModelText){console.log('click ModelText');}else{if(item&&item.link){_this.showDetailDialog(item.link,item.name);}else{new OperatingPane(item.idCom,item.setValue,item.description,_this).show();}}}
e.preventDefault();});var _getHitModelItem=function(type,id){var item;switch(Number(type)){case _this.enmuElementType.equipment:item=_this.dictEquipments[id];break;case _this.enmuElementType.button:item=_this.dictButtons[id];break;case _this.enmuElementType.ruler:var index_array=id.split('_');if(!index_array||index_array.length!=2){item=null;break;}
var rulerId=index_array[0],refIndex=index_array[1];item=_this.dictRulers[rulerId].references[refIndex];break;case _this.enmuElementType.text:item=_this.dictTexts[id];break;default:item=null;}
return item;}
$canvas.mousemove(function(e){if(!_this.hitModel)return;var result=_this.hitModel.firstHitId(e.clientX,e.clientY,null);if(result&&result.id&&result.id!=""){_this.canvas.style.cursor="pointer";_this.hitModel.currentModel=result;var item=_getHitModelItem(result.type,result.id);item&&item.mouseEnter&&item.mouseEnter(e);}else{_this.canvas.style.cursor="auto";if(_this.hitModel.currentModel&&_this.hitModel.currentModel.id){var item=_getHitModelItem(_this.hitModel.currentModel.type,_this.hitModel.currentModel.id);item&&item.mouseOut&&item.mouseOut();_this.hitModel.currentModel=null;}}
e.preventDefault();});},renderData:function(data){this.refreshData({data:data});},refreshData:function(e){var _this=this.self?this.self:this;if(e.data&&!e.data.error){var tempDistributionsUpdated={};for(var i=0;i<e.data.length;i++){var item=_this.dictRefreshMap[e.data[i].name];if(item){if(item.pipelines){for(var j=0;j<item.pipelines.length;j++){var pipline=_this.dictPipelines[item.pipelines[j]];pipline.dictIdCom[e.data[i].name]=e.data[i].value==1?true:false;}}
if(item.equipments){for(var j=0;j<item.equipments.length;j++){var equipment=_this.dictEquipments[item.equipments[j]];equipment.value=e.data[i].value;equipment.update(null,null);}}
if(item.texts){for(var j=0;j<item.texts.length;j++){_this.dictTexts[item.texts[j]].update(e.data[i].value);}}
if(item.charts){for(var j=0;j<item.charts.length;j++){_this.dictCharts[item.charts[j]].update(e.data[i].name,e.data[i].value);}}
if(item.gages){for(var j=0;j<item.gages.length;j++){_this.dictGages[item.gages[j]].update(e.data[i].value);}}
if(item.tempDistributions){for(var j=0;j<item.tempDistributions.length;j++){if(!tempDistributionsUpdated[item.tempDistributions[j]]){tempDistributionsUpdated[item.tempDistributions[j]]=[];}
tempDistributionsUpdated[item.tempDistributions[j]].push(e.data[i]);}}
if(item.rulers){for(var j=0;j<item.rulers.length;j++){_this.dictRulers[item.rulers[j]].update(e.data[i].name,e.data[i].value);}}}}
for(var tempId in tempDistributionsUpdated){var tempUpdatedData=tempDistributionsUpdated[tempId];_this.dictTempDistributions[tempId].update(tempUpdatedData);}
for(var pointName in _this.dictCharts){var chart=_this.dictCharts[pointName];if(!chart.isRunning){chart.isRunning=true;chart.renderChart(chart);}}}else{new Alert(_this.container,Alert.type.danger,I18n.resource.code[e.data.error]).showAtTop(5000);}
_this.isDataReady=true;},initCanvasCache:function(){this.cacheCanvas=document.createElement("canvas");this.cacheCtx=this.cacheCanvas.getContext("2d");this.cacheCanvas.width=this.canvas.width;this.cacheCanvas.height=this.canvas.height;var item,element;for(var i=0;i<10;i++){for(item in this.dictEquipments){element=this.dictEquipments[item];if((!element.idCom||element.idCom=="")&&element.layer==i)element.paint(this.cacheCtx);}
for(item in this.dictButtons){element=this.dictButtons[item];if((!element.idCom||element.idCom=="")&&element.layer==i)element.paint(this.cacheCtx);}}
for(item in this.dictTexts){element=this.dictTexts[item];if(!element.idCom||element.idCom=="")element.paint(this.cacheCtx);}},initImageDictionary:function(){if(this.store.images){var item;for(var i=0;i<this.store.images.length;i++){item=this.store.images[i];this.addImageIntoRequestQueue(item);}}
if(this.store.animationImages){var item;for(var i=0;i<this.store.animationImages.length;i++){item=this.store.animationImages[i];this.addImageIntoRequestQueue("animation_"+item);}}
var _this=this;var interval=setInterval(function(e){var isCompleted=true;for(var key in _this.dictImages){if(!_this.dictImages[key].complete){isCompleted=false;break;}}
if(isCompleted&&_this.isDataReady){clearInterval(interval);Spinner.stop();}},300);},initPipelines:function(){this.dictPipelines={};if(this.store.pipelines){var item,tempLine;for(var i=0;i<this.store.pipelines.length;i++){item=this.store.pipelines[i];tempLine=new ModelPipeline(item.id,null,null);tempLine.x=parseInt(item.startX);tempLine.y=parseInt(item.startY);tempLine.startX=parseInt(item.startX);tempLine.startY=parseInt(item.startY);tempLine.endX=parseInt(item.endX);tempLine.endY=parseInt(item.endY);tempLine.lineWidth=parseInt(item.width);tempLine.direction=item.direction=="1"?false:true;tempLine.speed=1;tempLine.layer=item.layer;tempLine.waterType=item.waterType;tempLine.color=item.color
if(item.idCom&&item.idCom.toString()!=""){tempLine.idCom=item.idCom;var arr=item.idCom.split(',');for(var j=0;j<arr.length;j++){if(arr[j]&&arr[j].toString()!=""){tempLine.dictIdCom[arr[j]]=false;this.addElementIdIntoDictRefreshMap(arr[j],this.enmuElementType.pipeline,item.id);}}}
this.dictPipelines[item.id]=tempLine;}}},initEquipments:function(){this.dictEquipments={};if(this.store.equipments){var item,tempEquip;for(var i=0;i<this.store.equipments.length;i++){item=this.store.equipments[i];tempEquip=new ModelEquipment(item.id,null,null);tempEquip.x=item.x;tempEquip.y=item.y;tempEquip.width=item.width;tempEquip.height=item.height;tempEquip.animation=item.animation;tempEquip.idCom=item.idCom;tempEquip.layer=item.layer;if(!item.isFromAnimation){tempEquip.image=this.dictImages[item.idPicture];}
else{if(tempEquip.animation[0]){tempEquip.image=this.dictImages[tempEquip.animation[0].animationId];}}
if(item.rotate!="0.0")tempEquip.rotate=item.rotate;if(item.idCom&&item.id!="")
this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.equipment,item.id);if(item.link&&item.link>-1){tempEquip.link=item.link;this.hitModel.add(item.id,this.enmuElementType.equipment,item.x,item.y,item.width,item.height);}
this.dictEquipments[item.id]=tempEquip;}}},initCharts:function(){this.dictCharts={};function ChartFactory(elementType){var chart;switch(Number(elementType)){case 52:chart=LineChart;break;case 53:chart=BarChart;break;case 54:chart=PieChart;break;default:chart=LineChart;}
return chart;}
if(this.store.charts){var item,tempChart;for(var i=0;i<this.store.charts.length;i++){item=this.store.charts[i];var ElementChart=ChartFactory(item.elementType)
tempChart=new ElementChart(item.id,null,null);tempChart.x=item.x;tempChart.y=item.y;tempChart.width=item.width;tempChart.height=item.height;tempChart.units=item.data;if(item.interval&&item.interval!='')tempChart.interval=item.interval;tempChart.init();for(var j=0;j<item.data.length;j++)
this.addElementIdIntoDictRefreshMap(item.data[j].pointName,this.enmuElementType.chart,item.id);this.dictCharts[item.id]=tempChart;}}},initGages:function(){this.dictGages={};if(this.store.gages){var item,tempGage;for(var i=0;i<this.store.gages.length;i++){item=this.store.gages[i];tempGage=new ModelGage(item.id,null,null);tempGage.width=item.width;tempGage.height=item.height;tempGage.idCom=item.idCom;tempGage.minValue=item.min;tempGage.maxValue=item.max;if(item.pagetype==='floating'&&item.xposition&&item.yposition){tempGage.x=item.x-item.xposition;tempGage.y=item.y-item.yposition;}else{tempGage.x=item.x;tempGage.y=item.y;}
this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.gage,item.id);this.dictGages[item.id]=tempGage;}}},initRulers:function(){this.dictRulers={};if(this.store.rulers){var item,tempRuler;for(var i=0;i<this.store.rulers.length;i++){item=this.store.rulers[i];tempRuler=new ModelRuler(this,item.id,null,null);tempRuler.x=item.x;tempRuler.y=item.y;tempRuler.width=item.width;tempRuler.height=item.height;tempRuler.minValue=item.min;tempRuler.maxValue=item.max;tempRuler.name=item.name;tempRuler.decimal=item.decimal;tempRuler.mainScale=item.mainScale;tempRuler.minorScale=item.minorScale;for(var j=0;j<item.levels.length;j++)tempRuler.levels.push(item.levels[j]);for(var j=0;j<item.references.length;j++){if(item.references[j].idCom!=""){this.addElementIdIntoDictRefreshMap(item.references[j].idCom,this.enmuElementType.ruler,item.id);}
tempRuler.references.push(item.references[j]);}
tempRuler.init();this.dictRulers[item.id]=tempRuler;for(var n=0,len=tempRuler.references.length;n<len;n++){var ref=tempRuler.references[n];Number(ref.isInUp)!==1&&ref.panel&&this.hitModel.add(item.id+'_'+n,this.enmuElementType.ruler,ref.panel.x,ref.panel.y,ref.panel.w,ref.panel.h);}}}},initButtons:function(){this.dictButtons={};if(this.store.buttons){var item,tempButton;for(var i=0;i<this.store.buttons.length;i++){item=this.store.buttons[i];tempButton=new ModelButton(item.id,null,null);tempButton.x=item.x;tempButton.y=item.y;tempButton.width=item.width;tempButton.height=item.height;tempButton.image=this.dictImages[item.comm];tempButton.imageComm=this.dictImages[item.comm];tempButton.imageOver=this.dictImages[item.over];tempButton.imageDown=this.dictImages[item.down];tempButton.imageDisable=this.dictImages[item.disable];tempButton.idCom=item.idCom;tempButton.setValue=item.setValue;tempButton.description=item.description;tempButton.layer=item.layer;tempButton.fontSize=item.fontSize;tempButton.fontColor=item.fontColor;if(item.text&&item.text!="")tempButton.text=item.text;if(item.link&&item.link>-1)tempButton.link=item.link;this.hitModel.add(item.id,this.enmuElementType.button,item.x,item.y,item.width,item.height);this.dictButtons[item.id]=tempButton;}}},initCheckboxs:function(){this.dictCheckboxs={};if(this.store.checkboxs){var item,tempCheckbox;for(var i=0;i<this.store.checkboxs.length;i++){item=this.store.checkboxs[i];tempCheckbox=new ModelButton(item.id,null,null);tempCheckbox.x=item.x;tempCheckbox.y=item.y;tempCheckbox.width=item.width;tempCheckbox.height=item.height;tempCheckbox.layer=item.layer;tempCheckbox.idCom=item.idCom;tempCheckbox.type=item.type;tempCheckbox.fontColor=item.fontColor;tempCheckbox.fontSize=item.fontSize;tempCheckbox.setValue=item.setValue;tempCheckbox.unsetValue=item.unsetValue;tempCheckbox.text=item.text;tempCheckbox.idGroup=item.idGroup;tempCheckbox.expression=item.expression;this.dictCheckboxs[item.id]=tempCheckbox;}}},initTempDistribution:function(){this.dictTempDistributions={};if(this.store.tempDistributions&&!!this.store.tempDistributions.data&&this.store.tempDistributions.data.length){var item,tempDistribution;item=this.store.tempDistributions;tempDistribution=new ModelTempDistribution(item.pageid,null,null);tempDistribution.layer=item.layer;tempDistribution.data=item.data;tempDistribution.width=item.width;tempDistribution.height=item.height;tempDistribution.x=item.x;tempDistribution.y=item.y;tempDistribution.init();this.dictTempDistributions[item.pageid]=tempDistribution;for(var n=0,len=item.data.length;n<len;n++){var point=item.data[n];this.addElementIdIntoDictRefreshMap(point.idCom,this.enmuElementType.temperature,item.pageid);}}},initTexts:function(){var _this=this;var concat=String.prototype.concat;var modalTextIds={};var dicEquipments,dicFaults,getErrData,getErrDataNew;if(this.isInDiagnosis){dicEquipments=this.diagScreen.dictEquipment;dicFaults=this.diagScreen.dictFault;getErrData=function(id){var data=[];for(var t in dicEquipments){if(dicEquipments[t].modalTextId===id){data=data.concat(dicEquipments[t].faultIds.concat());}}
return data;};if(AppConfig.projectId==80){getErrDataNew=function(id){var dataNew=[];for(var t in dicEquipments){if(dicEquipments[t].modalTextId===id){dataNew=dataNew.concat(dicEquipments[t].name);}}
return dataNew;};}}
this.dictTexts={};if(this.isInDiagnosis){for(var i in dicEquipments){modalTextIds[dicEquipments[i].modalTextId]=dicEquipments[i].id;}}
if(this.store.texts){var item,tempText;for(var i=0;i<this.store.texts.length;i++){item=this.store.texts[i];tempText=new ModelText(item.id,null,null);tempText.x=item.x;tempText.y=item.y;tempText.width=item.width;tempText.height=item.height;tempText.value=item.text;tempText.fontSize=item.fontSize;tempText.decimalplace=item.decimalplace;tempText.font=item.font;tempText.showMode=item.showMode;tempText.readWrite=item.rw;if(item.showMode==0&&item.bindString&&item.bindString!=""){var arr=item.bindString.split('|');var strs;for(var j=0;j<arr.length;j++){strs=arr[j].split(":");tempText.dictBindString[strs[0]]=strs[1];}}
if(item.color){tempText.color='rgb('+item.color.b+','+item.color.g+','+item.color.r+')';}
if(item.idCom&&item.id!=""){tempText.idCom=item.idCom;tempText.value="--";this.addElementIdIntoDictRefreshMap(item.idCom,this.enmuElementType.text,item.id);}
if(this.isInDiagnosis){if(modalTextIds[item.id]){tempText.isErrTip=true;tempText.getErrData=getErrData;if(AppConfig.projectId==80){tempText.getErrDataNew=getErrDataNew;}
tempText.retrunToMoment=function(date){_this.enterBacktraceMode();Spinner.spin(ElScreenContainer);ToolCurrent.showFramePane();var time=date.toDate();ToolCurrent.requestData(new Date(+time-7200000),new Date(+time+7200000),null,true);}
this.diagScreen.dictObserverText[modalTextIds[item.id]]=tempText;tempText.updateDiagnosisGrade(0);}}
if((item.idCom&&item.id!="")||this.isInDiagnosis)
this.hitModel.add(item.id,this.enmuElementType.text,item.x,item.y-(item.height/2),item.width,item.height);this.dictTexts[item.id]=tempText;}}
if(this.isInDiagnosis)this.diagScreen.resetFloor();},addElementIdIntoDictRefreshMap:function(idCom,enmuElementType,elementId){if(!this.dictRefreshMap[idCom])
this.dictRefreshMap[idCom]={pipelines:[],equipments:[],buttons:[],texts:[],charts:[],gages:[],rulers:[],tempDistributions:[]};switch(enmuElementType){case this.enmuElementType.pipeline:this.dictRefreshMap[idCom].pipelines.push(elementId);break;case this.enmuElementType.equipment:this.dictRefreshMap[idCom].equipments.push(elementId);break;case this.enmuElementType.chart:this.dictRefreshMap[idCom].charts.push(elementId);break;case this.enmuElementType.button:this.dictRefreshMap[idCom].buttons.push(elementId);break;case this.enmuElementType.text:this.dictRefreshMap[idCom].texts.push(elementId);break;case this.enmuElementType.gage:this.dictRefreshMap[idCom].gages.push(elementId);break;case this.enmuElementType.temperature:this.dictRefreshMap[idCom].tempDistributions.push(elementId);break;case this.enmuElementType.ruler:this.dictRefreshMap[idCom].rulers.push(elementId);break;default:break;}},addImageIntoRequestQueue:function(id){if(this.dictImages[id])return this.dictImages[id];var img=new Image();img.src=new StringBuilder().append("/static/images/plant/").append(AppConfig.projectName).append("/").append(id).append(".png").toString();var _this=this;img.addEventListener("load",function(e){_this.indexImageLoaded++;});this.dictImages[id]=img;return img;},showDetailDialog:function(pageid,dialogTitle){var obScreen;if(!this.isInDiagnosis){if(ScreenModal)ScreenModal.close();ScreenModal=new ObserverScreen(pageid);dialogTitle&&(ScreenModal.dialogTitle=dialogTitle);if(this.isPlayback)ScreenModal.isPlayback=true;ScreenModal.isDetailPage=true;ScreenModal.show();}else{obScreen=new ObserverScreen(pageid);obScreen.isInDiagnosis=true;obScreen.diagScreen=this.diagScreen;dialogTitle&&(obScreen.dialogTitle=dialogTitle);if(this.isPlayback)obScreen.isPlayback=true;obScreen.isDetailPage=false;obScreen.show(this.container);obScreen=null;}},showErrTip:function(modalTextId){try{var text=this.dictTexts[modalTextId];var scaleX=this.hitModel.scaleX;var scaleY=this.hitModel.scaleY;var rect=this.canvas.getBoundingClientRect();var e={pageX:text.x/scaleX+rect.left+this.canvas.scrollLeft,pageY:text.y/scaleY+rect.top+this.canvas.scrollTop};text.mouseEnter(e);}catch(e){console.log('click too fast!');}},hideErrTip:function(modalTextId){try{var text=this.dictTexts[modalTextId];text.mouseOut(null);}catch(e){console.log('click too fast!');}},enmuElementType:{pipeline:0,equipment:1,button:2,text:3,chart:4,gage:5,ruler:6,temperature:7}};return ObserverScreen;})();﻿
var AnalysisScreen=(function(){var syncDelayTimer=null;function AnalysisScreen(){this.store=undefined;this.factoryIoC=undefined;this.container=undefined;this.ltContainer=undefined;this.arrColor=echarts.config.color;this.saveModalJudge=undefined;this.modalConfig=undefined;this.curModal={startTime:undefined,endTime:undefined,format:undefined,mode:undefined,itemDS:[]};this.path=[];this.paneDatasource=undefined;this.paneCenter=undefined;this.paneLeft=undefined;}
AnalysisScreen.prototype={show:function(){var _this=this;var promise=$.Deferred();Spinner.spin(ElScreenContainer);if(syncDelayTimer!==null){window.clearTimeout(syncDelayTimer);syncDelayTimer=null;}
WebAPI.get("/static/views/observer/analysisScreen.html").done(function(resultHtml){Spinner.stop();$(ElScreenContainer).html(resultHtml);var side=new SidebarMenuEffect();side.init('#paneContent');document.querySelector('#leftCt').click();document.querySelector('#rightCt').click();_this.syncCheck();});},close:function(){var _this=this;var isExistSpinner=(function(){var $spinner=$('#anlsPaneContain').find('.spinner');return $spinner.length>0;}());if(isExistSpinner){if(!confirm('Exit now will interrupt the current operation，continue？')){return false;}}
this.store=null;this.factoryIoC=null;this.container=null;this.curModal=null;this.modalConfig&&this.modalConfig.close&&this.modalConfig.close();AppConfig.datasource=null;this.paneDatasource&&this.paneDatasource.close&&this.paneDatasource.close();this.wsPanel&&this.wsPanel.close&&this.wsPanel.close();this.tplPanel&&this.tplPanel.close&&this.tplPanel.close();this.paneCenter&&this.paneCenter.close&&this.paneCenter.close();delete FullScreenManager.onFullScreenEnter;delete FullScreenManager.onFullScreenOut;this.detachResizeEvents();if(this.syncWorker.status==='processing'){this.syncWorker.stop();}else{this.syncWorker.stop();this.syncWorker.setOptions({onProcessing:null,onSuccess:null,onFailed:null});syncDelayTimer=window.setTimeout(function(){_this.syncWorker.start(0,'once');},500);}},syncCheck:function(){var _this=this;this.syncWorker=new SyncWorker();this.syncWorker.setOptions({onSuccess:function(){_this.init();_this.initSyncWorker();},onFailed:function(){alert('数据分析经历非法关闭，请确认您的数据完整');window.Beop.cache.buffer.removeFrozenData().done(function(){_this.init();_this.initSyncWorker();});}});window.Beop.cache.buffer.init().done(function(){_this.syncWorker.start(0);});},initSyncWorker:function(e){var _this=this;this.syncWorker.setOptions({onProcessing:function(){console.log('processing');},onSuccess:function(){console.log('success');},onFailed:function(){console.warn('failed');}});},doSync:function(){var _this=this;var promise=$.Deferred();this.syncWorker.setOptions({onSuccess:function(){_this.initSyncWorker();promise.resolve();}});this.syncWorker.start(0);return promise;},onresize:function(){if(ScreenCurrent.paneCenter&&ScreenCurrent.paneCenter.chart){ScreenCurrent.paneCenter.chart.resize();}},init:function(){var _this=this;var localStorageFlag;this.container=document.getElementById('anlsPane');this.ltContainer=document.getElementById('workspacePane');this.rtContainer=document.getElementById('divAnlsDatasourcePane');this.$breadcrumb=$('.breadcrumb').eq(0);this.$itemTools=$('.itemTools').eq(0);this.arrToolBox=[[{type:'glyphicon',value:'glyphicon glyphicon-search',id:'btnPreview',title:'Preview Workspaces'},{type:'glyphicon',value:'glyphicon glyphicon-list-alt',id:'btnShowTemplate',title:'Show Template'}],[{type:'glyphicon',value:'glyphicon glyphicon-random',id:'btnMoveTo',title:'Move to Other workspace'},{type:'glyphicon',value:'glyphicon glyphicon-share',id:'btnShareTo',title:'Create Share Report'},{type:'glyphicon',value:'glyphicon glyphicon-play',id:'btnPlay',title:'Play Sliders'},{type:'button',value:i18n_resource.analysis.workspace.REVERSE_SELECT,id:'btnSelectReverse',title:i18n_resource.analysis.workspace.REVERSE_SELECT},{type:'button',value:i18n_resource.analysis.workspace.SELECT_ALL,id:'btnSelectAll',title:i18n_resource.analysis.workspace.SELECT_ALL}],[{type:'glyphicon',value:'glyphicon glyphicon-cog',id:'btnConfigModal',title:'Config'},{type:'glyphicon',value:'glyphicon glyphicon-edit',id:'btnCreateNote',title:'Create Notes'},{type:'glyphicon',value:'glyphicon glyphicon-eye-open',id:'btnNoteHideOrShow',title:'Notes Hide Or Show'},{type:'glyphicon',value:'glyphicon glyphicon-th-large',id:'graphSelsect',title:'Select Graphs'},{type:'glyphicon',value:'glyphicon glyphicon-filter',id:'btnDataFilter',title:'Data Filter'}],[{type:'glyphicon',value:'glyphicon glyphicon-log-in',id:'btnReturnToWorkspace',title:'Return To Workspace'}],[]]
this.attachResizeEvents();this.initBreadCrumb();this.initItemTools();Spinner.spin(ElScreenContainer);var lastOpenWorkspaceId=localStorage.getItem('lastOpenWorkspaceId_'+AppConfig.userId);if(lastOpenWorkspaceId===null)lastOpenWorkspaceId=0;WebAPI.get('/analysis/getWorkspaces/'+AppConfig.userId+'/'+lastOpenWorkspaceId).done(function(result){var temp;_this.store=JSON.parse(result);_this.initIoc();_this.paneDatasource=AppConfig.datasource=new DataSource(_this);_this.initWsObserver();_this.initPathObserver();if(_this.store.workspaces.length>0){if(lastOpenWorkspaceId!==0){for(var i=0;i<_this.store.workspaces.length;i++){if(_this.store.workspaces[i].id==lastOpenWorkspaceId){temp=_this.store.workspaces[i];break;}}
if(!temp){temp=_this.store.workspaces[0];}}else{temp=_this.store.workspaces[0];}
_this.path.splice(0,_this.path.length,{type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:_this.store.workspaces},{type:'CenterSliderPanel',title:temp.name,data:temp});}
else{_this.path.push({type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:_this.store.workspaces});}
_this.paneDatasource.show();_this.modalConfig=new modalConfigurePane(document.getElementById('modalConfigContainer'),_this,'dataAnalysis');_this.modalConfig.show();I18n.fillArea($(ElScreenContainer));Spinner.stop();});},attachResizeEvents:function(){var _this=this;var handler=function(e){if(e.originalEvent.propertyName!=='transform')return;if(e.target!==_this.ltContainer&&e.target!==_this.rtContainer)return;if(typeof _this.onresize==='function'){_this.onresize();}};$(this.ltContainer).off('transitionend').on('transitionend',handler);$(this.rtContainer).off('transitionend').on('transitionend',handler);},detachResizeEvents:function(){$(this.ltContainer).off('transitionend');$(this.rtContainer).off('transitionend');},mergeDsInfoList:function(dsList){var dsInfoMap={},dsMap={};if(!dsList||!dsList.length)return;if(!this.store.dsInfoList||!this.store.dsInfoList.length){this.store.dsInfoList=dsList;return;}
this.store.dsInfoList.forEach(function(row){dsInfoMap[row.id]=row;});dsList.forEach(function(row){dsMap[row.id]=row;});for(var p in dsMap){if(!dsMap.hasOwnProperty(p))continue;if(dsInfoMap.hasOwnProperty(p))continue;dsInfoMap[p]=dsMap[p];this.store.dsInfoList.push(dsMap[p]);}},initWsObserver:function(){var _this=this;var addModalArrayOb=function(arr){observeHelper.watchArray(arr,'modalList',function(sign,type,data){var changeData;switch(type){case'push':observeHelper.watchProp(data.changeData,['name','imagebin'],'modal',function(sign,data){var params;switch(sign){case'modal_name':params={id:data.id,name:data.name,modifyTime:data.modifyTime}
break;case'modal_imagebin':params={id:data.id,imagebin:data.imagebin,modifyTime:data.modifyTime}
break;}
if(!_this.path[_this.path.length-1].isSlider)_this.paneCenter.updateSlider(params);_this.paneLeft.updateSlider(params);});if(!_this.path[_this.path.length-1].isSlider)_this.paneCenter.addSlider(data.changeData);_this.paneLeft.addSlider(data.changeData);break;case'splice':changeData=data.changeData[0];if(!_this.path[_this.path.length-1].isSlider)_this.paneCenter.removeSlider(changeData);_this.paneLeft.removeSlider(changeData);break;case'move':_this.saveModalLayout();break;}});arr.forEach(function(modal){observeHelper.watchProp(modal,['name','imagebin'],'modal',function(sign,data){var params;switch(sign){case'modal_name':params={id:data.id,name:data.name,modifyTime:data.modifyTime};break;case'modal_imagebin':params={id:data.id,imagebin:data.imagebin,modifyTime:data.modifyTime};break;}
if(!_this.path[_this.path.length-1].isSlider)_this.paneCenter.updateSlider(params);_this.paneLeft.updateSlider(params);});});};var addWsArrayOb=function(arr,name){observeHelper.watchArray(arr,name,function(sign,type,data){switch(type){case'push':addWorkspaceOb(data.changeData);_this.paneCenter.addOne(data.changeData);break;case'splice':_this.paneCenter.removeOne(data.changeData[0]);break;case'move':_this.saveWorkspaceLayout();break;}});arr.forEach(function(row){addWorkspaceOb(row);});};var addWorkspaceOb=function(ws){observeHelper.watchProp(ws,['name','modalList'],'workspace',function(sign,data){var item;switch(sign){case'workspace_name':_this.paneCenter.updateOne(data);break;case'workspace_modalList':addModalArrayOb(data.modalList);if(_this.path.length===2&&_this.path[0].type==='WorkspacePanel'){_this.paneCenter.init();}
break;};});addModalArrayOb(ws.modalList);};addWsArrayOb(this.store.workspaces,'workspace');observeHelper.watchProp(this.store,'templates','analysis',function(sign,data){addWsArrayOb(data.templates.preTemplate,'analysis');addWsArrayOb(data.templates.userTemplate,'analysis');});},initPathObserver:function(){var _this=this;observeHelper.watchArray(this.path,'analysis',function(sign,type,data){var len=_this.path.length,oldLen=data.oldData.length;var item,modalClass;_this.renderBreadCrumb();_this.$itemTools.children().hide();item=_this.path[len-1];switch(len){case 1:if(_this.paneLeft&&_this.paneLeft.close)_this.paneLeft.close();_this.panelLeft=null;break;case 2:_this.refreshPaneLeft(new window.analysis.panels.LeftSliderPanel(_this,item.data));break;case 3:if(len-oldLen<=1)break;_this.refreshPaneLeft(new window.analysis.panels.LeftSliderPanel(_this,item.data));break;}
if(item.isSlider&&item.type!=='AnalysisTemplate'){_this.renderModalById(item.data);}else{_this.refreshPaneCenter(new window.analysis.panels[item.type](_this,item.data));}
_this.renderItemtools();});},refreshPaneLeft:function(entity){if(this.paneLeft&&this.paneLeft.close)this.paneLeft.close();this.paneLeft=entity;this.paneLeft.show(this.ltContainer);},refreshPaneCenter:function(entity){if(this.paneCenter&&this.paneCenter.close)this.paneCenter.close();this.paneCenter=entity;if(this.path[this.path.length-1].isSlider&&this.paneLeft.readonly){$(this.container).addClass('panel-readonly');}else{$(this.container).removeClass('panel-readonly');}
this.paneCenter.show(this.container);},initBreadCrumb:function(){var _this=this;EventAdapter.on(this.$breadcrumb,'click','a',function(){var $this=$(this);var level=parseInt($this.attr('data-level'));var type=_this.path[level].type;_this.path.splice(level+1);});},renderBreadCrumb:function(){var arrHtml=[];var len=this.path.length;this.path.forEach(function(row,i){if(len-1===i){arrHtml.push('<li class="active">'+row.title+'</li>');return;}
arrHtml.push('<li><a href="javascript:;" data-level="'+i+'">'+row.title+'</a></li>');});this.$breadcrumb.html(arrHtml.join(''));},initItemTools:function(){var arrToolHtml=[],_this=this;for(var i=0,len=this.arrToolBox.length;i<len;i++){var toolBox=this.arrToolBox[i];for(var j in toolBox){var tool=toolBox[j];tool.level=i;if(tool.type=='glyphicon'){arrToolHtml.push('<span class="glyphicon {value} panel-heading-btn grow" id="{id}" data-level="{level}" title="{title}"></span>'.formatEL(tool))}else if(tool.type=='button'){arrToolHtml.push('<button type="button" class="btn btn-default btn-xs" id="{id}" data-level="{level}" title="{title}">{value}</button>'.formatEL(tool));}}}
this.$itemTools.html(arrToolHtml.join(''))
EventAdapter.on($(this.$itemTools.children('#btnPreview').off('click')),'click',function(e){_this.preview();});EventAdapter.on($(this.$itemTools.children('#btnShareTo').off('click')),'click',function(e){_this.shareTo();});EventAdapter.on($(this.$itemTools.children('#btnPlay').off('click')),'click',function(e){_this.play();});EventAdapter.on($(this.$itemTools.children('#btnSelectAll').off('click')),'click',function(e){_this.selectAll();});EventAdapter.on($(this.$itemTools.children('#btnSelectReverse').off('click')),'click',function(e){_this.selectReverse();});EventAdapter.on($(this.$itemTools.children('#btnShowTemplate').off('click')),'click',function(e){_this.showTemplate();});EventAdapter.on($(this.$itemTools.children('#btnReturnToWorkspace').off('click')),'click',function(e){_this.returnToWorkspace();});EventAdapter.on($(this.$itemTools.children('#btnMoveTo').off('click')),'click',function(e){_this.moveTo();});},renderItemtools:function(){var index=this.path.length-1;if(this.path[0].type==='TemplatePanel')index+=3;if(index===5)index=2;if(this.path.length===3&&this.paneLeft.readonly)return;this.$itemTools.children('[data-level="'+index+'"]').show();if(this.path.length===2&&this.paneLeft.readonly){this.$itemTools.children('#btnMoveTo').hide();}
if(this.curModal&&this.curModal.type=='AnlzTendency'){if($(this.container).find('div').hasClass('divHover')){$('#chartModify').show();$('#btnDataFilter').show();}else{$('#chartModify').hide();$('#btnDataFilter').hide();}}else{$('#chartModify').hide();$('#btnDataFilter').hide();}},hideAnlsPane:function(){$('#anlsPaneContain').hide();this.detachResizeEvents();},showAnlsPane:function(){$('#anlsPaneContain').show();this.attachResizeEvents();this.onresize();},initIoc:function(){this.factoryIoC=new FactoryIoC('analysis');},renderModal:function(){var option=this.curModal;var modalClass=this.factoryIoC.getModel(option.type);if(modalClass){var param2=('AnlzTendency'==option.type)?option:null;this.refreshPaneCenter(new modalClass(this.container,param2,this));}
else this.refreshPaneCenter(new window.analysis.panels.AnalysisTemplate(this));this.saveModal();},renderModalById:function(modal){this.curModal=modal.option;this.renderModal();this.saveModalJudge.rejectWith(this,[this,$('#divWSPane .selected')]);this.saveModalJudge.rejectWith(this,[this,$('#divWSPane .selected')]);},saveWorkspaceLayout:function(){var _this=this;var workspaces=this.store.workspaces;WebAPI.post('/analysis/workspace/saveOrder/'+AppConfig.userId,{idList:this.store.workspaces.map(function(row){return row.id;})}).done(function(){_this.paneCenter.close();_this.paneCenter.show(_this.container);});},saveModalLayout:function(){var _this=this;var ws=this.paneLeft.ws;WebAPI.post('/analysis/modal/saveOrder/'+AppConfig.userId+'/0',{workspaceId:ws.id,idList:ws.modalList.map(function(row){return row.id;})}).done(function(){_this.paneLeft.close();_this.paneLeft.show(_this.ltContainer);if(!_this.path[_this.path.length-1].isSlider){_this.paneCenter.close();_this.paneCenter.show(_this.container);}});},saveModal:function(){this.saveModalJudge=$.Deferred();$.when(this.saveModalJudge).done(function(_this,_mode,_chart,_targetSlider,_curModal,imgSaveJudge){var currentWs=_this.paneLeft.ws;var modalList=currentWs.modalList;var imageSm,canvas,tempChartImageBin;var params,modal;var type;var modalId=_targetSlider.attr('data-id');for(var key in _curModal){if(_curModal[key]instanceof Date)
_curModal[key]=_curModal[key].format('yyyy-MM-dd HH:mm:ss');}
params={id:modalId,type:_curModal.type||'',note:'',option:_curModal,modifyTime:new Date().format('yyyy-MM-dd HH:mm')}
if(imgSaveJudge){if(!_chart){tempChartImageBin=_targetSlider.get(0).style.backgroundImage.replace('url(','').replace(')','');}else{if(AppConfig.chartTheme==theme.Dark){_chart.setOption({backgroundColor:"#fff"});imageSm=_chart.getImage('jpeg');_chart.setOption({backgroundColor:"transparent"});}else{imageSm=_chart.getImage('jpeg');}
canvas=document.createElement("canvas");canvas.width=480;canvas.height=300;tempChartImageBin=imageSm.getAttribute('src');}
Beop.cache.img.set(currentWs.id,modalId,tempChartImageBin);params.imagebin=tempChartImageBin;}
type=!currentWs.templateId?'ws':'tpl';_this.paneLeft.model.update(params,currentWs.id,type).done(function(){var i=0;while(modal=modalList[i++]){if(modal.id===modalId){modal.type=params.type;modal.option=params.option;modal.modifyTime=params.modifyTime;params.imagebin!==undefined&&(modal.imagebin=params.imagebin);break;}}});});},updateDataSources:function(updateData){this.store.group=updateData;},alertNoData:function(){var _this=this;var $dataAlert=$("#dataAlert");new Alert($dataAlert,"danger","<strong>"+I18n.resource.analysis.paneConfig.ERR11+"</strong>").show().close();},shareTo:function(){var selectedIds=$.makeArray(this.paneCenter.$container.find('.slider-item.checked').map(function(){return this.dataset.id;}));var selectedNames;var workAndReport;var modalList,data=[];if(selectedIds.length<=0){alert('You should choose one slider at least!');return;}
modalList=this.paneCenter.ws.modalList;if(!modalList||!modalList.length)return false;for(var i=0,item,arrPoints,len=modalList.length;i<len;i++){if(selectedIds.indexOf(modalList[i]['id'])>-1){item=modalList[i];if(item.id==selectedIds[0]){selectedNames=item.name;}
arrPoints=[];if(!item.option.itemDS)continue;for(var j=0;j<item.option.itemDS.length;j++){arrPoints=arrPoints.concat(item.option.itemDS[j].arrId);}
for(var p in item.__observeProps){if(!item.hasOwnProperty(p))continue;Object.defineProperty(item,p,{writable:true,value:item.__observeProps[p]});}
delete item.__observeProps;delete item.imagebin;data.push({"id":(+new Date()).toString()+i.toString(),"spanC":6,"spanR":4,"modal":{"interval":0,"option":item,"title":item.name,"points":arrPoints,"type":"ModalAnalysis"}});}}
workAndReport=new Date().format('yyyy-MM-dd')+' '+this.paneCenter.ws.name+' <i style="font-weight:600;">'+selectedNames+'  </i>  '+I18n.resource.analysis.shareLog.DESC_TIP_ETC+'  '+selectedIds.length+'  '+I18n.resource.analysis.shareLog.DESC_TIP_TABLE;var strShare='SHARE'+AppConfig.userId.toString()+(+new Date()).toString(),postData;postData={projectId:'',menuItemId:strShare,layout:[data],desc:workAndReport};var dsInfoList=[].concat(this.store.dsInfoList);ScreenManager.show(EnergyScreen,strShare,postData,null,dsInfoList);},selectAll:function(){this.paneCenter.$container.find('.slider-item').addClass('checked');},selectReverse:function(){this.paneCenter.$container.find('.slider-item').toggleClass('checked');},play:function(){var _this=this;var sliders;var selectedIds=$.makeArray(this.paneCenter.$container.find('.slider-item.checked').map(function(){return this.dataset.id;}));if(selectedIds.length<=0){alert('You should choose one slider at least!');return;}
$('html').addClass('sharpview-mode');sliders=_this.paneCenter.ws.modalList.filter(function(row){return selectedIds.indexOf(row.id)>-1;});FullScreenManager.onFullScreenEnter=function(){_this.sharpViewScreen=new SharpViewScreen(sliders,_this.store);_this.sharpViewScreen.show();};FullScreenManager.onFullScreenOut=function(){$('html').removeClass('sharpview-mode');_this.sharpViewScreen.destroy();};FullScreenManager.toggle();},preview:function(){var _this=this;var promise=$.Deferred();var modalList=[],workspaces=this.store.workspaces;var wsIdsNeedLoad=[];var selectedWsIds=([]).map.call($(this.container).find('.wsSet.on'),function(row){return row.dataset.id;});var selectedWsList=[];var dsInfoList;if(selectedWsIds.length==0){alert('Please select at least one workspace!');return;}
workspaces.forEach(function(ws){if(selectedWsIds.indexOf(ws.id)===-1){return false;}
if(ws.modalCount===undefined){modalList=modalList.concat(ws.modalList);}
else if(ws.modalCount>0){wsIdsNeedLoad.push(ws.id);}});if(!modalList.length&&!wsIdsNeedLoad.length)return false;if(wsIdsNeedLoad.length>0){WebAPI.post('/analysis/getModals',{idList:wsIdsNeedLoad}).done(function(rs){rs=JSON.parse(rs);for(var prop in rs){if(!rs.hasOwnProperty(prop)){continue;}
modalList=modalList.concat(rs[prop].modalList);_this.mergeDsInfoList(rs[prop].dsInfoList);}
promise.resolve();});}else{promise.resolve();}
promise.done(function(){var postData;var data=[];for(var i=0,item,arrPoints,len=modalList.length;i<len;i++){item=modalList[i];arrPoints=[];if(!item.option.itemDS)continue;for(var j=0,arrId;j<item.option.itemDS.length;j++){arrPoints=arrPoints.concat(item.option.itemDS[j].arrId);}
data.push({"id":(+new Date()).toString()+i.toString(),"spanC":6,"spanR":4,"modal":{"interval":0,"option":item,"title":item.name,"points":arrPoints,"type":"ModalAnalysis"}});}
postData={projectId:'',layout:[data]};dsInfoList=_this.store.dsInfoList;ScreenCurrent.close();ScreenCurrent=new EnergyScreen();ScreenCurrent.dsInfolist=dsInfoList;ScreenCurrent.store=postData;ScreenCurrent.isForBencMark=true;ScreenCurrent.show();});},showModal:function(){var $dialog=$('#dialogModal');var $dialogContent=$dialog.find('#dialogContent').css({height:'90%',width:'90%',margin:'auto',marginTop:'2.5%',backgroundColor:'#fff'});$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$dialogContent.removeAttr('style').html('');}).modal({});var energyScreen=new EnergyScreen();energyScreen.container=$dialogContent[0];energyScreen.isForBencMark=true;energyScreen.init();},showTemplate:function(){var _this=this;var len=this.path.length;var pjIds;if(!this.store.templates){pjIds=AppConfig.projectList.map(function(row,i){return row.id;});Spinner.spin(this.container);WebAPI.post('/analysis/template/get/'+AppConfig.userId,{projectIds:pjIds}).done(function(rs){rs=JSON.parse(rs);_this.store.templates=rs;_this.path.splice(0,len,{type:'TemplatePanel',title:'Templates',data:rs});}).always(function(){Spinner.stop();});}else{this.path.splice(0,len,{type:'TemplatePanel',title:'Templates',data:this.store.templates});}},returnToWorkspace:function(){this.path.splice(0,this.path.length,{type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:this.store.workspaces});},moveTo:function(){var selectedModalIds=Array.prototype.map.call($('.slider-item.checked',this.container),function(row){return row.dataset.id;});if(selectedModalIds.length==0){alert('Please select at least one Slider!');return;}
var $dialog=$('#dialogModal'),workspaceHtml=[],modalHtml,_this=this,targetWs={};var wsTpl='<div class="wsSet{isEmpty} moveTo" data-id="{id}"><div class="wsCtn"><div class="wsName">{name}</div></div></div>';this.store.workspaces.forEach(function(ws){if(_this.paneCenter.ws.id===ws.id||ws.templateId)return;workspaceHtml.push(wsTpl.formatEL({id:ws.id,name:ws.name,isEmpty:ws.modalList.length>0?'':' empty'}));});modalHtml='<div class="modal-content" id="" style="height: calc(100% - 200px);">\
                <div class="modal-header">\
                    <button type="button" class="close" onclick="">\
                        <span aria-hidden="true">&times;</span>\
                    </button>\
                    <h3 class="modal-title">Move to Workspace</h3>\
                </div>\
                <div class="modal-body" style="height: calc(100% - 120px); overflow-y: auto;">'+
workspaceHtml.join('')+'<div style="clear: both;"></div>\
                </div>\
                <div class="modal-footer">\
                    <button id="confirmMove" class="btn btn-primary disabled">Confirm</button>\
                </div>\
            </div>';$dialog.find('#dialogContent').css({height:'100%'}).html(modalHtml);$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){Spinner.stop();}).modal({});EventAdapter.on($dialog.find('.close').off('click'),'click',function(e){$dialog.modal('hide');e.stopPropagation();});EventAdapter.on($dialog.find('#confirmMove').off('click'),'click',function(e){e.stopPropagation();var data,modalIdList=[];var targetModalList=targetWs.modalList;var srcModalList=_this.paneLeft.ws.modalList;var moveModals=[];var modalModel=_this.paneLeft.model;var ws=_this.paneLeft.ws;$dialog.modal('hide');Spinner.spin(ElScreenContainer);_this.doSync().done(function(){WebAPI.post('/analysis/modalMove/'+AppConfig.userId,{srcWsId:ws.id,destWsId:targetWs.id,moveModalIdList:selectedModalIds}).done(function(rs){rs=JSON.parse(rs);if(rs.status==='OK'){for(var i=0,len=srcModalList.length;i<len;i++){if(selectedModalIds.indexOf(srcModalList[i].id)>-1){moveModals.push(srcModalList.splice(i,1)[0]);len--;i--}}
moveModals.forEach(function(row){Array.prototype.push.call(targetModalList,row);});}}).always(function(){Spinner.stop();_this.initSyncWorker();});});});EventAdapter.on($($dialog.find('.wsSet').off('click')),'click',function(e){var targetWsId=$(this).attr('data-id');var workspaces=_this.store.workspaces;$(this).siblings('.wsSet').removeAttr('style');$(this).css({backgroundColor:'rgba(90, 155, 226, 0.2)'});$dialog.find('#confirmMove').removeClass('disabled');for(var i=0;i<workspaces.length;i++){if(workspaces[i].id===targetWsId){targetWs=workspaces[i];break;}}});}}
var observeHelper={watchProp:function(target,props,sign,callback){var _this=this;if(!target.__observeProps)target.__observeProps={};props=typeof props==='string'?[props]:props;props.forEach(function(prop,i){if(target.__observeProps.hasOwnProperty(prop))return;target.__observeProps[prop]=target[prop];Object.defineProperty(target,prop,{configurable:true,enumerable:true,get:function(){return this.__observeProps[prop];},set:function(value){if(value===this.__observeProps[prop])return;this.__observeProps[prop]=value;callback(sign+'_'+prop,this);}});});},watchArray:function(target,sign,callback){var _this=this;target.push=function(data){var old=this.concat();var rs=Array.prototype.push.call(this,data);callback(sign+'_push','push',{oldData:old,newData:this,changeData:data});return rs;};target.pop=function(){var old=this.concat();var data=Array.prototype.pop.call(this,data);callback(sign+'_pop','pop',{oldData:old,newData:this,changeData:data});return data;};target.splice=function(){var old=this.concat();var del=Array.prototype.splice.apply(this,Array.prototype.slice.call(arguments));callback(sign+'_splice','splice',{oldData:old,newData:this,changeData:del});return del;};target.move=function(from,to){var old=this.concat();var change=Array.prototype.splice.call(this,to,0,Array.prototype.splice.call(this,from,1)[0]);callback(sign+'_move','move',{oldData:old,newData:this,changeData:change});};target.moveBatch=function(fromlist,toList){fromList.forEach(function(row,i){Array.prototype.splice.call(this,row,1);});};}};var SyncWorker=(function(window,$,buffer){function SyncWorker(options){this.options=$.extend({},DEFAULTS,options);this.timer=null;this.status='stop';}
+function(){this.start=(function(){function process(once){var _this=this;var promise=$.Deferred();_this.excuteCallback('onProcessing');_this.status='processing';buffer.getFrozenData().then(function(data){if(data===null){buffer.removeFrozenData().done(function(){promise.resolve();});return;}
console.log('transfer',data);WebAPI.post('/analysis/anlySync/'+AppConfig.userId,data).then(function(rs){rs=JSON.parse(rs);if(rs.status==='OK'){buffer.removeFrozenData().done(function(){promise.resolve();});}else{promise.reject(-2);}},function(rs){promise.reject(-3);});},function(){promise.reject(-1);});promise.then(function(){_this.excuteCallback('onSuccess');},function(errCode){switch(errCode){case-1:console.warn('获取冻结版本数据失败');break;case-2:console.warn('同步数据失败，接口执行错误');break;case-3:console.warn('同步请求发送失败');break;default:break;}
_this.excuteCallback('onFailed',errCode);});if(once){_this.stop();return;}else{promise.always(function(){if(_this.timer===null)return;_this.timer=window.setTimeout(process.bind(_this),_this.options.interval);_this.status='ready';});}}
return function(delay,mode){var once=mode==='once'?true:false;delay=delay===undefined?this.options.interval:delay;if(this.timer!==null){this.stop();}
this.timer=window.setTimeout(process.bind(this,once),delay);this.status='ready';};}());this.stop=function(){if(this.timer){window.clearTimeout(this.timer);this.timer=null;}
this.status='stop';};this.setOptions=function(options){this.options=$.extend({},this.options,options);};this.excuteCallback=function(type,data){typeof this.options[type]==='function'&&this.options[type](data);};}.call(SyncWorker.prototype);var DEFAULTS={interval:60000};return SyncWorker;}(window,jQuery,window.Beop.cache.buffer));return AnalysisScreen;})();+function($){var useBuffer=true;!useBuffer&&function(){this.analysis=this.analysis||{};function WorkspaceModel(){}
+function(){this.create=function(data){var params;var promise;if(!data.templateId){params={workspaceName:data.name,modalList:data.modalList||[],modifyTime:data.modifyTime,modal:{option:{},imagebin:''}};promise=WebAPI.post('/analysis/modal/save/'+AppConfig.userId,params);}
else{params={workspaceName:data.name,templateId:data.templateId};promise=WebAPI.post('/analysis/template/apply/'+AppConfig.userId,params);}
return promise;};this.update=function(data){return WebAPI.post('/analysis/modal/save/'+AppConfig.userId,{workspaceId:data.id,workspaceName:data.name});};this.read=function(){};this.delete=function(wsId){return WebAPI.get('/analysis/workspace/remove/'+AppConfig.userId+'/'+wsId+'/0');};}.call(WorkspaceModel.prototype);function TemplateModel(){}
+function(){this.create=function(data){return WebAPI.post('/analysis/template/create/'+AppConfig.userId,{templateName:data.name,projectId:AppConfig.userId===1?'':AppConfig.projectId});};this.update=function(data){return WebAPI.post('/analysis/modal/save/'+AppConfig.userId,{templateId:data.id,templateName:data.name});};this.read=function(){};this.delete=function(tplId){return WebAPI.get('/analysis/workspace/remove/'+AppConfig.userId+'/'+tplId+'/1');};}.call(TemplateModel.prototype);function ModalModel(){}
+function(){this.create=function(){};this.update=function(data,ws){if(!ws.templateId){params={workspaceId:ws.id,workspaceName:ws.name,modal:data};}else{params={templateId:ws.templateId,modal:data};}
return WebAPI.post('/analysis/modal/save/'+AppConfig.userId,params);};this.read=function(){};this.delete=function(){};}.call(ModalModel.prototype);this.analysis.models={WorkspaceModel:WorkspaceModel,TemplateModel:TemplateModel,ModalModel:ModalModel}}.call(this,window.Beop.cache.buffer);useBuffer&&function(buffer){this.analysis=this.analysis||{};function WorkspaceModel(){}
+function(){this.create=function(data){var params;if(!data.templateId){params={id:data.id,name:data.name,modalList:data.modalList||[],modifyTime:data.modifyTime};params=$.extend(false,params,{modalList:params.modalList.concat()});params.modalList=params.modalList.map(function(row){var newRow=$.extend(false,row,{});delete newRow['__observeProps'];return newRow;});}
else{params={id:data.id,templateId:data.templateId,name:data.name,modifyTime:data.modifyTime,modalList:[]};}
if(data['dsOwnerId']!==undefined){params['dsOwnerId']=data['dsOwnerId'];}
return buffer.addWsCreateOp(params);};this.update=function(data){return buffer.addWsUpdateOp({id:data.id,name:data.name,modifyTime:data.modifyTime});};this.read=function(){};this.delete=function(wsId){return buffer.addWsDeleteOp({id:wsId});};}.call(WorkspaceModel.prototype);function TemplateModel(){}
+function(){this.create=function(data){var params;params={id:data.id,name:data.name,modalList:data.modalList||[],creatorId:data.creatorId,projectId:data.projectId,modifyTime:data.modifyTime};params=$.extend(false,params,{modalList:params.modalList.concat()});return buffer.addWsCreateOp(params,'tpl');};this.update=function(data){return buffer.addWsUpdateOp({id:data.id,name:data.name,modifyTime:data.modifyTime},'tpl');};this.read=function(){};this.delete=function(tplId){return buffer.addWsDeleteOp({id:tplId},'tpl');};}.call(TemplateModel.prototype);function ModalModel(){}
+function(){this.create=function(modal,id,type){var params={};params.id=modal.id;params.modifyTime=modal.modifyTime;params.type=modal.type;params.op='create';modal.note!==undefined&&(params.note=modal.note);modal.option!==undefined&&(params.option=modal.option);modal.name!==undefined&&(params.name=modal.name);modal.imagebin!==undefined&&(params.imagebin=modal.imagebin);return buffer.addModalCreateOp(params,id,type);};this.update=function(modal,id,type){var params={};params.id=modal.id;params.modifyTime=modal.modifyTime;params.type=modal.type;params.op='update';modal.note!==undefined&&(params.note=modal.note);modal.option!==undefined&&(params.option=modal.option);modal.name!==undefined&&(params.name=modal.name);modal.imagebin!==undefined&&(params.imagebin=modal.imagebin);return buffer.addModalUpdateOp(params,id,type);};this.read=function(){};this.delete=function(modalId,id,type){return buffer.addModalDeleteOp(modalId,id,type);};}.call(ModalModel.prototype);this.analysis.models={WorkspaceModel:WorkspaceModel,TemplateModel:TemplateModel,ModalModel:ModalModel};}.call(this,window.Beop.cache.buffer);}.call(this,jQuery);window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.AnalysisTemplate=(function(){function AnalysisTemplate(screen){this.screen=screen;}
AnalysisTemplate.prototype={show:function(){this.initAnlysTemplate();this.initDrag();$('#graphSelsect').click(function(){$('#graphBox').hide();return;});$('#chartModify').hide();$('#btnDataFilter').hide();},initAnlysTemplate:function(){var paneAnalysis=document.getElementById('anlsPane');var _this=this;paneAnalysis.innerHTML='';var list,option,strAnlysPara,strTemplateImg,strAnlysTemplate,strTemplateImgColor,template,strImgIndex;list=this.screen.factoryIoC.getList();for(var ele=0;ele<list.length;ele++){template=list[ele];option=template.prototype.optionTemplate;strAnlysPara='';option=this.screen.factoryIoC.getModel(template.name).prototype.optionTemplate;strTemplateImg='/static/images/analysis/templateImg/templateImg.png';strTemplateImgColor=(option.imgColor?option.imgColor:'65,131,189');strImgIndex=option.imgIndex?-(option.imgIndex*59):0;for(var i=0;i<option.templateParams.paraName.length;i++){strAnlysPara+='<p dataType="'+option.templateParams.paraName[i]+'">'+option.templateParams.paraName[i]+'</p>';}
var numOfPara=(option.templateParams.paraName.length>5)?'long':option.templateParams.paraName.length;strAnlysTemplate='<div class="anlsTemplate" anlysParaMode="'+option.templateParams.paraAnlysMode+'" templateType="'+template.name+'" style="background-color:rgba('+strTemplateImgColor+',0.1)">\
                                    <div class="templateImgBg" style="background-color:rgba('+strTemplateImgColor+',1)"></div>\
                                        <div class="templateImg" style="background-image:url('+strTemplateImg+'); background-repeat:no-repeat; background-position:'+strImgIndex+'px 0"></div>\
                                            <h3>'+I18n.findContent(option.templateName)+'</h3>\
                                        <p>'+I18n.resource.analysis.paneConfig.DATA_DRAG_TIP+'</p>\
                                        <div class = "templatePara numOfPara-'+numOfPara+'">'+strAnlysPara+'</div>\
                                    </div>';paneAnalysis.innerHTML+=strAnlysTemplate;}
var $anlsConfigModal=$('#anlsConfigModal');EventAdapter.on($('.anlsTemplate'),'click',function(e){var option={};var optionTemplate=_this.screen.factoryIoC.getModel($(e.currentTarget).attr('templateType')).prototype.optionTemplate;option.modeUsable=optionTemplate.chartConfig;option.dataTypeMaxNum=[];option.dataTypeMaxNum=optionTemplate.templateParams.dataTypeMaxNum;option.rowDataType=[];option.templateType=$(e.currentTarget).attr('templateType');for(var i=0;i<e.currentTarget.children[4].children.length;++i){option.rowDataType.push(e.currentTarget.children[4].children[i].getAttribute('dataType'))}
option.optionPara={};option.optionPara.dataItem=[];var allDataNeed=$(e.currentTarget).attr('anlysParaMode');if(allDataNeed=='all'){allDataNeed=true;}else{allDataNeed=false;}
option.allDataNeed=allDataNeed;_this.screen.modalConfig.showModalInit(true,option);})},initDrag:function(){var _this=this;var templateParaPane=$('.templatePara');var $tempPara=templateParaPane.children();var $anlysConfigModal=$('#anlsConfigModal');var $rowAnlysPara,strAnlysModalBody,targetId,targetContent;var $startAnlys=$('#startAnlys');$tempPara.on('dragenter',function(e){e.preventDefault();e.stopPropagation();});$tempPara.on('dragleave',function(e){e.preventDefault();$(e.target).removeClass('paraSel');$(e.target).closest('.anlsTemplate').removeClass('templateSel');});$tempPara.on('dragover',function(e){e.preventDefault();$(e.target).addClass('paraSel');$(e.target).closest('.anlsTemplate').addClass('templateSel');});$tempPara.on('drop',function(e){e.preventDefault();e.stopPropagation();var option={};var optionTemplate=_this.screen.factoryIoC.getModel($(e.currentTarget).closest('.anlsTemplate').attr('templateType')).prototype.optionTemplate;option.modeUsable=optionTemplate.chartConfig;option.templateType=$(e.currentTarget).closest('.anlsTemplate').attr('templateType');option.dataTypeMaxNum=[];option.dataTypeMaxNum=optionTemplate.templateParams.dataTypeMaxNum;option.rowDataType=[];for(var i=0;i<$(e.currentTarget).parent().children().length;++i){option.rowDataType.push($(e.currentTarget).parent().children().get(i).getAttribute('dataType'))}
option.optionPara={};targetId=EventAdapter.getData().dsItemId;if(!targetId)return;option.optionPara.dataItem=[{dsId:[targetId],dsName:[AppConfig.datasource.getDSItemById(targetId).alias],dsType:e.currentTarget.getAttribute('dataType')}];var allDataNeed=$(e.currentTarget).closest('.anlsTemplate').attr('anlysParaMode');allDataNeed=='all'?allDataNeed=true:allDataNeed=false;option.allDataNeed=allDataNeed;_this.screen.modalConfig.showModalInit(true,option);});$('#dataSrcPanel').on('dragend',function(e){e.preventDefault();$('.templateSel').removeClass('templateSel');$('.paraSel').removeClass('paraSel');$('.paraRowSel').removeClass('paraRowSel');$('.templatePara').css('display','none');})},close:function(){}}
return AnalysisTemplate;})();window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.CenterSliderPanel=(function(window,$,Model,undefined){function CenterSliderPanel(screen,ws){this.screen=screen;this.ws=ws;this.readonly=(ws.templateId&&(ws.templateId!==ws.id))?true:false;this.referTo=ws.templateId===ws.id?'tpl':'ws';this.model=new Model();};CenterSliderPanel.prototype.tpl='\
    <div class="divPage slider-item{cls}" id="cp_{id}" data-id="{id}" draggable="true" style="{imagebin}">\
        <h4 class="divPageTitle">\
            <div class="modalNameSp">{name}</div>\
        </h4>\
        {sign}\
        <div class="effect"></div>\
        <span class="slider-cb-wrap"><i class="slider-cb"></i></span>\
        <div class="sliderInfo">\
            <span class="modifyTime">Recently:&nbsp;&nbsp;{modifyTime}</span>\
        </div>\
    </div>';CenterSliderPanel.prototype.show=function(container){this.$container=$(container);this.init();};CenterSliderPanel.prototype.init=function(){var _this=this;if(this.ws.modalCount===undefined){this.renderPanel();}};CenterSliderPanel.prototype.renderPanel=function(){var _this=this,tempHTML=[];var sign=this.readonly?'<span class="btnRemove glyphicon glyphicon-link" title="From Template"></span>':'<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove"></span>';var cls=this.readonly?' slider-readonly':'';this.$itemCtn=this.$container;this.ws.modalList.forEach(function(modal){tempHTML.push(_this.tpl.formatEL({id:modal.id,name:modal.name||'Untitled',sign:sign,modifyTime:modal.modifyTime,cls:cls,imagebin:(function(){if(modal.imagebin)return'background-image: url('+modal.imagebin+')';else return'';}())}));});if(!this.readonly){tempHTML.push('<div class="divPage slider-item-add" style="background-image: none;">\
            <h4 style="cursor: pointer;z-index: 1;position: absolute;left: 50%;top: 50%;margin-left: -16px;margin-top: -16px;" id="btnAddSlider">\
                <span class="glyphicon glyphicon-plus" style="font-size: 32px;"></span>\
            </h4>\
            <div class="effect"></div>\
            </div>');}
this.$container.html(tempHTML.join(''));this.attachEvent();this.attachItemEvents(this.$container.find('.slider-item'));};CenterSliderPanel.prototype.attachEvent=function($container){var _this=this;EventAdapter.on($(this.$container.find('.slider-item-add')),'click',function(e){var modal={id:ObjectId(),name:"",note:"",option:{},type:"",modifyTime:new Date().format('yyyy-MM-dd HH:mm')}
return _this.model.create(modal,_this.ws.id,_this.referTo).done(function(){_this.ws.modalList.push(modal);});});}
CenterSliderPanel.prototype.attachItemEvents=function($items){var _this=this;var $btnRemoveList=$('.btnRemove ',$items);var $titleList=$('.divPageTitle',$items);var $checkBoxList=$('.slider-cb',$items);!this.readonly&&EventAdapter.on($btnRemoveList,'click',function(e){e.stopPropagation();var modalId=$(this).closest('.divPage').attr('data-id');return _this.model.delete(modalId,_this.ws.id,_this.referTo).done(function(){var modal,i=0;for(;(modal=_this.ws.modalList[i]);i++){if(modal.id===modalId){_this.ws.modalList.splice(i,1);return;}}});});!this.readonly&&EventAdapter.on($titleList,'click',function(e){e.stopPropagation();var $target=$(e.target);var $textarea=$('<textarea value="" placeholder="Input name"/>');$textarea.blur(function(){var modal,i=0;var modalId=$(this).closest('.divPage').attr('data-id');var params;$(this).closest('.divPage').attr('draggable',true);$(this).prev('.modalNameSp').show();$(this).remove();for(;(modal=_this.ws.modalList[i]);i++){if(modal.id===modalId){params={id:modalId,name:$(this).val(),modifyTime:new Date().format('yyyy-MM-dd HH:mm')};_this.model.update(params,_this.ws.id,_this.referTo).done(function(modal){modal.modifyTime=params.modifyTime;modal.name=params.name;}.bind(this,modal));break;}}}).keypress(function(e){if(e.keyCode===13)$(this).blur();}).focus(function(){$(this).closest('.divPage').attr('draggable',false);$(this).select().prev('.modalNameSp').hide();});EventAdapter.on($textarea,'click',function(e){e.stopPropagation();});$target.hide().after($textarea);$textarea.val($target.html()).focus();});EventAdapter.on($checkBoxList,'click',function(e){e.stopPropagation();var $slider=$(this).closest('.divPage');$slider.toggleClass('checked');});EventAdapter.on($items,'click',function(e){e.stopPropagation();var sliderId=$(this).attr('data-id');$('#lp_'+sliderId).trigger('click');});!this.ws.templateId&&this.attachDragEvents(this.$container.find('.slider-item'));};CenterSliderPanel.prototype.updateSlider=function(modal){var _this=this;var $modal=$('#cp_'+modal.id);var $name,$modifyTime;if(!$modal||!$modal.length)return;if(modal.name){$name=$('.modalNameSp',$modal);$name.text(modal.name||'Untitled');}
$modifyTime=$('.modifyTime',$modal);$modifyTime.text('Recently:  '+modal.modifyTime||'');if(modal.imagebin)$modal.css('background-image','url('+modal.imagebin+')');}
CenterSliderPanel.prototype.removeSlider=function(modal){$('#cp_'+modal.id,this.$container).remove();}
CenterSliderPanel.prototype.addSlider=function(modal){var $slider;var sign=this.readonly?'<span class="btnRemove glyphicon glyphicon-link" title="From Template"></span>':'<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove"></span>';var cls=this.readonly?' slider-readonly':'';$slider=$(this.tpl.formatEL({id:modal.id,name:modal.name||'Untitled',modifyTime:modal.modifyTime,sign:sign,cls:cls}));this.$itemCtn.find('.slider-item-add').before($slider);this.$itemCtn[0].scrollTop=this.$itemCtn[0].scrollHeight;this.attachItemEvents($slider);return $slider;}
CenterSliderPanel.prototype.close=function(){this.$container.empty();this.$container.off();};CenterSliderPanel.prototype.attachDragEvents=function($items){var _this=this;var startIndex,$dragEle;var dataUrl;var sliderWidth=$items.eq(0).width();var sliderHeight=$items.eq(0).height();$items.off('dragstart').on('dragstart',function(e){var $target=$dragEle=$(e.target);startIndex=$target.index();dataUrl=$target[0].style.backgroundImage;$target[0].style.backgroundImage='none';$target.addClass('on-drag');});$items.off('dragover').on('dragover',function(e){var $target=$(e.target);var oEvent=e.originalEvent;var offset;if($target===$dragEle)return;if(!$target.hasClass('divPage'))$target=$target.closest('.divPage');offset=$target.offset();if((oEvent.pageX-offset.left)>sliderWidth/2){$dragEle.insertAfter($target);}
else{$dragEle.insertBefore($target);}
e.stopPropagation();});$items.off('dragend').on('dragend',function(e){var endIndex=$dragEle.index();$dragEle[0].style.backgroundImage=dataUrl;$dragEle.removeClass('on-drag');if(startIndex===endIndex)return;_this.ws.modalList.move(startIndex,endIndex);});};return CenterSliderPanel;}(window,jQuery,window.analysis.models.ModalModel));window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.LeftSliderPanel=(function(window,$,Model,undefined){function LeftSliderPanel(screen,ws){this.screen=screen;this.ws=ws;this.readonly=(ws.templateId&&(ws.templateId!==ws.id))?true:false;this.referTo=ws.templateId===ws.id?'tpl':'ws';this.model=new Model();};LeftSliderPanel.prototype.tpl='\
    <div class="divPage slider-item{cls}" id="lp_{id}" data-id="{id}" draggable="true" style="{imagebin}" >\
        <h4 class="divPageTitle">\
        <div class="modalNameSp">{name}</div>\
        </h4>\
        {sign}\
        <div class="effect"></div>\
    </div>';LeftSliderPanel.prototype.show=function(container){this.$container=$(container);this.init();};LeftSliderPanel.prototype.init=function(){var _this=this;if(this.ws.modalCount!==undefined){if(this.ws.modalCount===0){delete this.ws.modalCount;this.renderPanel();}
else if(this.ws.modalCount===-1){delete this.ws.modalCount;_this.displayThumbnail(this.ws.modalList).done(function(){_this.renderPanel();});}
else{Spinner.spin(ElScreenContainer);WebAPI.post('/analysis/getModals',{idList:[this.ws.id]}).done(function(rs){rs=JSON.parse(rs);rs=rs[_this.ws.id];_this.displayThumbnail(rs.modalList).done(function(){delete _this.ws.modalCount;_this.ws.modalList=rs.modalList;_this.renderPanel();}).always(function(){Spinner.stop();});_this.screen.mergeDsInfoList(rs.dsInfoList);}).fail(function(){Spinner.stop();});}}else{this.renderPanel();}};LeftSliderPanel.prototype.displayThumbnail=function(modalList){var wsId=this.ws.id;var promise=$.Deferred();modalList=modalList.filter(function(row){return!!row.type;});window.Beop.cache.img.getChkByWs({id:wsId,modalList:modalList}).done(function(rs){var imgData=rs.data;var absentList=rs.absentList;modalList.forEach(function(modal){var key=wsId+'_'+modal.id;if(imgData[key]!==undefined){modal.imagebin=imgData[key];}});if(!absentList.length){promise.resolve();return;}
WebAPI.post('/analysis/getThumbnails',{modalIdList:absentList}).done(function(rs){var modalsNeedCache=[];rs=JSON.parse(rs);modalList.forEach(function(modal){if(rs[modal.id]!==undefined){modal.imagebin=rs[modal.id];modalsNeedCache.push(modal);}});window.Beop.cache.img.setByWs({id:wsId,modalList:modalsNeedCache}).fail(function(){console.warn('thumbnail save to cache failed!');});}).fail(function(){console.warn('get thumbnail failed!');}).always(function(){promise.resolve();});});return promise;};LeftSliderPanel.prototype.renderPanel=function(){var _this=this,tempHTML=[];var sign=this.readonly?'<span class="btnRemove glyphicon glyphicon-link" title="From Template"></span>':'<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove"></span>';var cls=this.readonly?' slider-readonly':'';this.$itemCtn=this.$container.find('.panel-body');this.$divWsName=$('.dropdownWS',this.$container);this.$panelHead=$('.panel-heading',this.$container);this.$btnGroup=$('#btnGroup',this.$container);this.$btnAddSlider=$('#btnPageAdd',this.$container);this.ws.modalList.forEach(function(modal){tempHTML.push(_this.tpl.formatEL({id:modal.id,name:modal.name||'Untitled',sign:sign,cls:cls,imagebin:(function(){if(modal.imagebin)return'background-image: url('+modal.imagebin+')';else return'';}())}));});this.$divWsName.text(this.ws.name);this.$panelHead.children().show();this.$btnGroup.show();if(this.readonly)this.$container.addClass('panel-readonly');this.$itemCtn.html(tempHTML.join(''));this.attachEvent();this.attachItemEvents(this.$itemCtn.find('.slider-item'));};LeftSliderPanel.prototype.updateSlider=function(modal){var $modal=$('#lp_'+modal.id);var $name;if(!$modal||!$modal.length)return;if(modal.name){$name=$('.modalNameSp','#lp_'+modal.id);$name.html(modal.name||'Untitled');}
if(modal.imagebin)$modal.css('background-image','url('+modal.imagebin+')');}
LeftSliderPanel.prototype.removeSlider=function(modal){var newIndex,$newModal;var $modal=$('#lp_'+modal.id,this.$container);if($modal.hasClass('selected')&&this.ws.modalList.length>0){newIndex=Math.min($modal.index(),this.ws.modalList.length-1);$newModal=$('#lp_'+this.ws.modalList[newIndex].id,this.$container);}else if(this.ws.modalList.length<=0){this.screen.path.pop();}
$modal.remove();if($newModal!==undefined){$newModal.trigger('click');}}
LeftSliderPanel.prototype.addSlider=function(modal){var sign='<span class="btnRemove glyphicon glyphicon-remove-sign" title="Remove"></span>';var $slider=$(this.tpl.formatEL({id:modal.id,name:modal.name||'Untitled',modifyTime:modal.modifyTime,sign:sign,cls:''}));this.$itemCtn.append($slider);this.$itemCtn[0].scrollTop=this.$itemCtn[0].scrollHeight;this.attachItemEvents($slider);$slider.trigger('click');};LeftSliderPanel.prototype.attachEvent=function(){var _this=this;EventAdapter.on(this.$btnAddSlider.off('click'),'click',function(e){var modal={id:ObjectId(),name:'',type:'',note:'',modifyTime:new Date().format('yyyy-MM-dd HH:mm:ss'),option:{}};return _this.model.create(modal,_this.ws.id,_this.referTo).done(function(){_this.ws.modalList.push(modal);});});};LeftSliderPanel.prototype.detachEvent=function(){};LeftSliderPanel.prototype.attachItemEvents=function($items){var _this=this;var $btnRemoveList=$('.btnRemove ',$items);var $titleList=$('.divPageTitle',$items);!this.readonly&&EventAdapter.on($btnRemoveList,'click',function(e){e.stopPropagation();var modalId=$(this).closest('.divPage').attr('data-id');return _this.model.delete(modalId,_this.ws.id,_this.referTo).done(function(){var modal,i=0;for(;(modal=_this.ws.modalList[i]);i++){if(modal.id===modalId){_this.ws.modalList.splice(i,1);return;}}});});!this.readonly&&EventAdapter.on($titleList,'click',function(e){e.stopPropagation();var $target=$(e.target);var $textarea=$('<textarea value="" placeholder="Input name"/>');$textarea.blur(function(){var modal,i=0;var modalId=$(this).closest('.divPage').attr('data-id');var params;$(this).closest('.divPage').attr('draggable',true);$(this).prev('.modalNameSp').show();$(this).remove();for(;(modal=_this.ws.modalList[i]);i++){if(modal.id===modalId){params={id:modalId,name:$(this).val(),modifyTime:new Date().format('yyyy-MM-dd HH:mm')};_this.model.update(params,_this.ws.id,_this.referTo).done(function(modal){var path=_this.screen.path[_this.screen.path.length-1];modal.modifyTime=params.modifyTime;modal.name=params.name;if(modalId===path.data['id']){path.title=params.name;_this.screen.renderBreadCrumb();}}.bind(this,modal));break;}}}).keypress(function(e){if(e.keyCode===13)$(this).blur();}).focus(function(){$(this).closest('.divPage').attr('draggable',false);$(this).select().prev('.modalNameSp').hide();});EventAdapter.on($textarea,'click',function(e){e.stopPropagation();});$target.hide().after($textarea);$textarea.val($target.html()).focus();});EventAdapter.on($items,'click',function(e){var modalList=_this.ws.modalList;var modalId=this.dataset.id;var modal,i=0;var path=_this.screen.path;_this.$container.find('.selected').removeClass('selected');$(this).addClass('selected');for(;modal=modalList[i++];){if(modal.id===modalId)break;};_this.renderPath(modal);e.stopPropagation();});!this.ws.templateId&&this.attachDragEvents(this.$container.find('.slider-item'));};LeftSliderPanel.prototype.attachDragEvents=function($items){var _this=this;var startIndex,$dragEle;var dataUrl;var sliderWidth=$items.eq(0).width();var sliderHeight=$items.eq(0).height();$items.off('dragstart').on('dragstart',function(e){var $target=$dragEle=$(e.target);startIndex=$target.index();dataUrl=$target[0].style.backgroundImage;$target[0].style.backgroundImage='none';$target.addClass('on-drag');});$items.off('dragover').on('dragover',function(e){var $target=$(e.target);var oEvent=e.originalEvent;var offset;if($target===$dragEle)return;if(!$target.hasClass('divPage'))$target=$target.closest('.divPage');offset=$target.offset();if((oEvent.pageY-offset.top)>sliderHeight/2){$dragEle.insertAfter($target);}
else{$dragEle.insertBefore($target);}
e.stopPropagation();});$items.off('dragend').on('dragend',function(e){var endIndex=$dragEle.index();$dragEle[0].style.backgroundImage=dataUrl;$dragEle.removeClass('on-drag');if(startIndex===endIndex)return;_this.ws.modalList.move(startIndex,endIndex);});};LeftSliderPanel.prototype.close=function(){this.$itemCtn.empty();this.$divWsName.text('');this.$panelHead.children().hide();this.$btnGroup.hide();this.$container.removeClass('panel-readonly');};LeftSliderPanel.prototype.renderPath=function(modal){var path=this.screen.path;if(path[path.length-1].isSlider){path.splice(path.length-1,1,{isSlider:true,type:modal.type||'AnalysisTemplate',title:modal.name||'Untitled',data:modal});}else{path.push({isSlider:true,type:modal.type||'AnalysisTemplate',title:modal.name||'Untitled',data:modal});}};return LeftSliderPanel;}(window,jQuery,window.analysis.models.ModalModel));window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.WorkspacePanel=(function(window,$,Model,undefined){function WorkspacePanel(screen,wsList){this.screen=screen;this.wsList=wsList;this.model=new Model();};WorkspacePanel.prototype.tpl='\
    <div class="wsSet ws-item{cls}{tplCls}" draggable="true" data-id ="{id}">\
        <div class="wsCtn">\
            <div class="dragHere"></div>\
            <span class="check-cb-wrap"><i class="check-cb"></i></span>\
            <div class="infoWrap">\
                <span class="name">{name}</span><span class="glyphicon glyphicon-pencil wsNameEdit"></span>\
                <div class="modifyTime">{modifyTime}</div>\
            </div>\
            <div class="btnWsRemove"><span class="glyphicon glyphicon-remove-sign"></span></div>\
        </div>\
    </div>';WorkspacePanel.prototype.show=function(container){this.$container=$(container);this.init();};WorkspacePanel.prototype.init=function(){var _this=this;var arrHtml=[];this.screen.store.workspaces.forEach(function(row,i){arrHtml.push(_this.tpl.formatEL({id:row.id,name:row.name||'Untitled',modifyTime:row.modifyTime||'',cls:(function(){if(row.modalCount!==undefined){len=row.modalCount;}else{len=row.modalList.length;}
return len>0?'':' empty';}()),tplCls:row.templateId?' fromTemplate':''}));});arrHtml.push('<div class="wsSet ws-add empty">\
                        <div class="wsCtn">\
                            <h3 style="color: #fff;position: absolute;left: 66px;top: 40px;"><span class="glyphicon glyphicon-plus"></span></h3>\
                        </div>\
                    </div>');this.$container.html(arrHtml.join(''));this.attachEvents();this.attachItemsEvents($('.ws-item',this.$container));};WorkspacePanel.prototype.attachEvents=function(){var _this=this;EventAdapter.on(this.$container,'click','.check-cb-wrap',function(e){$(this).closest('.wsSet').toggleClass('on');e.stopPropagation();});EventAdapter.on(this.$container,'click','.wsNameEdit',function(e){e.stopPropagation();var _that=this;var $wsSet=$(this).closest('.wsSet');$wsSet.attr('draggable',false);$wsSet.find('.dragHere')[0].style.cursor='initial';var oldName=$(this).prev('.name').html();var $input=$('<input type="text" style="display: inline-block; width: 120px;"/>').val(oldName);EventAdapter.on($input,'click',function(e){e.stopPropagation();});var $button=$('<button type="button" class="btn btn-default" style="display: inline-block;padding: 1px 5px;margin-left: 9px;margin-top: -2px;">OK</button>');EventAdapter.on($button,'click',function(e){e.stopPropagation();var newName=$input.val();$(_that).removeAttr('style');$(_that).prev('.name').show();$(_that).closest('.wsSet').attr('draggable',true);$wsSet.find('.dragHere').removeAttr('style');$input.remove();$(this).remove();if(!newName||newName.length==0||oldName==newName)return;var wsId=$(_that).closest('.ws-item').attr('data-id');var match=getWorkspaceById(wsId);if(match!==undefined){match.name=newName;}});$(this).hide().prev('.name').hide();$(this).after($button).after($input);$input.focus();});EventAdapter.on(this.$container,'click','.ws-item',function(e){var wsId=this.dataset.id;var match=getWorkspaceById(wsId);if(match!==undefined){_this.screen.path.push({type:'CenterSliderPanel',title:match.name,data:match});}
localStorage.setItem('lastOpenWorkspaceId_'+AppConfig.userId,wsId);});EventAdapter.on(this.$container,'click','.btnWsRemove',function(e){e.stopPropagation();var wsId=$(this).closest('.ws-item').attr('data-id');var match=getWorkspaceById(wsId);if(confirm(I18n.resource.analysis.workspace.CONFIRM_WORKSPACE_DELETE)){if(match!==undefined){_this.screen.store.workspaces.forEach(function(ws,index){if(ws.id==wsId){_this.screen.store.workspaces.splice(index,1);}});}}});EventAdapter.on(this.$container.find('.ws-add').off('click'),'click',function(e){e.stopPropagation();var ws={id:ObjectId(),name:'new Workspace',modalList:[],modifyTime:new Date().format('yyyy-MM-dd HH:mm')}
_this.screen.store.workspaces.push(ws);});function getWorkspaceById(wsId){var workspaces=_this.screen.store.workspaces;for(var i=0,len=workspaces.length;i<len;i++){if(workspaces[i].id===wsId){match=workspaces[i];break;}}
return match;}};WorkspacePanel.prototype.detachEvents=function(){this.$container.off('click');};WorkspacePanel.prototype.attachItemsEvents=function($items){this.attachDragEvents($('.ws-item',this.$container));};WorkspacePanel.prototype.detachItemsEvents=function($items){};WorkspacePanel.prototype.addOne=function(data){var _this=this;var $item,idList;var spinner;$item=$(_this.tpl.formatEL({id:data.id,name:data.name||'Untitled',modifyTime:data.modifyTime||'',cls:data.modalList.length>0?'':' empty',tplCls:data.templateId?' fromTemplate':''}));_this.$container.find('.ws-add').before($item);if(data.dsOwnerId!==undefined){idList=[];data.modalList.forEach(function(modal){var itemDs=modal.option['itemDS'];if(itemDs&&itemDs.length){itemDs.forEach(function(item){item['arrId'].forEach(function(dsId){if(idList.indexOf(dsId)===-1){idList.push(dsId);}});});}});if(idList.length>0){spinner=new LoadingSpinner({color:'#00FFFF'});spinner.spin($item[0])
WebAPI.post('/analysis/getDsList/'+data.dsOwnerId,{idList:idList}).done(function(rs){rs=JSON.parse(rs);if(!!rs['dsInfoList']){_this.screen.mergeDsInfoList(rs['dsInfoList']);}}).always(function(){spinner.stop();});}}
this.model.create(data).done(function(){_this.attachItemsEvents($item);if(data.modalList&&data.modalList.length){Beop.cache.img.setByWsList([data]);}});};WorkspacePanel.prototype.removeOne=function(data){var _this=this;var wsId=data.id;var modalList=data.modalList;var $workSpace=_this.$container.find('[data-id="'+wsId+'"]');modalList.forEach(function(row){localStorage.removeItem('ws_'+wsId+'_modal_'+row.id);});$workSpace.remove();this.model.delete(wsId).done(function(result){Beop.cache.img.removeByWsList([data]);});};WorkspacePanel.prototype.updateOne=function(data){var _this=this;$('[data-id="'+data.id+'"]',_this.$container).find('.name').text(data.name);this.model.update(data).done(function(){});};WorkspacePanel.prototype.close=function(){this.$container.empty();this.detachEvents();};WorkspacePanel.prototype.attachDragEvents=function($items){var _this=this;var startIndex,$dragEle;var dataUrl;var sliderWidth=$items.eq(0).width();var sliderHeight=$items.eq(0).height();$items.off('dragstart').on('dragstart',function(e){var $target=$dragEle=$(e.target);startIndex=$target.index();dataUrl=$target[0].style.backgroundImage;$target[0].style.backgroundImage='none';$dragEle.addClass('on-drag');});$items.off('dragover').on('dragover',function(e){var $target=$(e.target);var oEvent=e.originalEvent;var offset;if($target===$dragEle)return;if(!$target.hasClass('ws-item'))$target=$target.closest('.ws-item');offset=$target.offset();if((oEvent.pageX-offset.left)>sliderWidth/2){$dragEle.insertAfter($target);}
else{$dragEle.insertBefore($target);}
e.stopPropagation();});$items.off('dragend').on('dragend',function(e){var endIndex=$dragEle.index();$dragEle[0].style.backgroundImage=dataUrl;$dragEle.removeClass('on-drag');_this.wsList.move(startIndex,endIndex);});};return WorkspacePanel;}(window,jQuery,window.analysis.models.WorkspaceModel));window.analysis=window.analysis||{};window.analysis.panels=window.analysis.panels||{};window.analysis.panels.TemplatePanel=(function(window,$,Model,undefined){function templatePanel(screen,tplData){this.screen=screen;this.tplData=tplData;this.tplType=AppConfig.userId===1?'pre':'user';this.model=new Model();};templatePanel.prototype.preTpl='\
    <div class="template preTemplate template-item" data-id="{id}">\
    <div class="templateImgBg"></div>\
    <div class="templateImg"></div>\
    <div class="divTemplateBtnGroup">{btns}</div>\
    <h3>{name}</h3>\
    <div class="infoWrap">\
        <span class="name">Creator:&nbsp;{creatorName}</span>\
        <div class="modifyTime">{modifyTime}</div>\
    </div>\
    </div>';templatePanel.prototype.userTpl='\
    <div class="template userTemplate template-item{isMyTpl}" data-id="{id}">\
    <div class="templateImgBg"></div>\
    <div class="templateImg"></div>\
    <div class="divTemplateBtnGroup">{btns}</div>\
    <h3><span class="tplName">{name}</span><span class="glyphicon glyphicon-pencil tplNameEdit"></span></h3>\
    <div class="infoWrap">\
        <span class="name">Creator:&nbsp;{creatorName}</span>\
        <div class="modifyTime">{modifyTime}</div>\
    </div>\
    </div>';templatePanel.prototype.show=function(container){this.$container=$(container);this.init();};templatePanel.prototype.init=function(){var _this=this;var arrHtml=[];this.tplData.preTemplate.forEach(function(row){arrHtml.push(_this.preTpl.formatEL({id:row.id,name:row.name,btns:(function(){if(AppConfig.userId===row.creatorId){return['<span class="glyphicon glyphicon-edit grow btn-rt-corner"></span>','<span class="glyphicon glyphicon-remove-sign grow btn-rt-corner"></span>'].join('');}
return'';}()),creatorName:row.creatorName||'Unknow',modifyTime:row.modifyTime||''}));});this.tplData.userTemplate.forEach(function(row){arrHtml.push(_this.userTpl.formatEL({id:row.id,name:row.name,btns:(function(){if(AppConfig.userId===row.creatorId){return['<span class="glyphicon glyphicon-edit grow btn-rt-corner"></span>','<span class="glyphicon glyphicon-remove-sign grow btn-rt-corner"></span>'].join('');}
return'';}()),creatorName:row.creatorName||'Unknow',modifyTime:row.modifyTime||'',isMyTpl:row.creatorId==AppConfig.userId?' myTpl':''}));});arrHtml.push('<div class="template template-add"><h3><span class="glyphicon glyphicon-plus" style="font-size: 28px;margin-left: -88px;"></span></h3></div>');this.$container.html(arrHtml.join(''));this.attachEvents();this.attachItemsEvents($('.template-item',this.$container));};templatePanel.prototype.removeOne=function(data){var _this=this;var tplId=data.id;var $item=_this.$container.children('[data-id="'+tplId+'"]');$item.remove();this.model.delete(tplId).done(function(){});};templatePanel.prototype.addOne=function(data){var _this=this;var $item,data;var tpl=AppConfig.userId===1?'preTpl':'userTpl';$item=$(_this[tpl].formatEL({id:data.id,name:data.name,btns:(function(){return['<span class="glyphicon glyphicon-edit grow btn-rt-corner"></span>','<span class="glyphicon glyphicon-remove-sign grow btn-rt-corner"></span>'].join('');}()),creatorName:AppConfig.userProfile.fullname,modifyTime:new Date().format('yyyy-MM-dd HH:mm'),isMyTpl:' myTpl'}));$item.insertBefore(_this.$container.find('.template-add').eq(0));this.model.create(data).done(function(rs){});};templatePanel.prototype.updateOne=function(data){var _this=this;var $tpl=$('[data-id="'+data.id+'"]',_this.$container);$tpl.find('.tplName').text(data.name);$tpl.find('.modifyTime').text(data.modifyTime);this.model.update(data).done(function(){});};templatePanel.prototype.findTemplateById=function(id){var hit=null;var t,i,row,tpl;for(t in this.tplData){row=this.tplData[t];i=0;while(tpl=row[i++]){if(tpl.id===id){hit=tpl;break;}}
if(hit)return hit;}
return null;};templatePanel.prototype.attachEvents=function(){var _this=this;var templates=_this.tplData[_this.tplType+'Template'];EventAdapter.on($(this.$container.find('.template-add')),'click',function(e){var template,i=0,inputName;if(!AppConfig.projectId){alert('Please choose a project in home page first.');return;}
inputName=prompt('Please input template name: ');if(!inputName||$.trim(inputName).length==0)return;templates.push({id:ObjectId(),creatorId:AppConfig.userId,modalList:[],name:inputName,projectId:AppConfig.projectId});e.stopPropagation();});EventAdapter.on(this.$container,'click','.glyphicon-remove-sign',function(e){var tplId,template,i=0;if(confirm(I18n.resource.analysis.workspace.CONFIRM_TEMPLATE_DELETE)){tplId=$(this).closest('.template-item').attr('data-id');while(template=templates[i++]){if(template.id===tplId){templates.splice(i-1,1);break;}};}
e.stopPropagation();});EventAdapter.on(this.$container,'click','.glyphicon-edit',function(e){var tplId=$(this).closest('.template-item').attr('data-id');var template,i=0;while(template=templates[i++]){if(template.id===tplId){break;}};template.templateId=template.id;_this.screen.path.push({type:'CenterSliderPanel',title:template.name+' [Template Edit Mode]',data:template});e.stopPropagation();});EventAdapter.on(this.$container,'click','.template-item',function(e){e.stopPropagation();if(e.target.tagName.toLowerCase()=='input')return;var tplId=this.dataset.id;var template=_this.findTemplateById(tplId);var modelName=template.name;var $divModalSel=$('#modelSelsect',ElScreenContainer);if($divModalSel.length===0){$divModalSel=$('<div class="modal fade" id="modelSelsect" role="dialog" style="padding-top: 110px;"><div class="modal-dialog" role="document"><div class="modal-content">'+'<div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>'+'<h4 class="modal-title">'+I18n.resource.analysis.workspace.APPLICATION_TEMPLATE+' -  '+modelName+'</h4></div>'+'<div class="modal-body">'+'<p style="width:550px;margin:0 auto 10px;line-height:1.5;">'+I18n.resource.analysis.workspace.IS_SAVE_COPY_OF_TEMP+'</p>'+'<p style="color:#A3A3A3;width:550px;margin:0 auto;line-height:1.5;">'+
I18n.resource.analysis.workspace.IF_SAVE_COPY+'</p>'+'</div>'+'<div class="modal-footer">'+'<button type="button" class="btn btn-default retain">'+I18n.resource.analysis.workspace.SAVE+'</button>'+'<button type="button" class="btn btn-default notRetain">'+I18n.resource.analysis.workspace.NOT_SAVE+'</button>'+'<button type="button" class="btn btn-default" data-dismiss="modal">'+I18n.resource.analysis.workspace.CANCEL+'</button></div>'+'</div></div></div>');$(ElScreenContainer).append($divModalSel);}
$('.modal-title',$divModalSel).html(I18n.resource.analysis.workspace.APPLICATION_TEMPLATE+'  -  '+modelName);EventAdapter.on($('.retain',$divModalSel).off('click'),'click',function(e){$divModalSel.modal('hide');_this.screen.path.splice(0,_this.screen.path.length,{type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:_this.screen.store.workspaces});_this.screen.store.workspaces.push({id:ObjectId(),name:template.name,dsOwnerId:template.creatorId,modalList:(function(){var modalList=template.modalList.concat();modalList.forEach(function(modal){modal.id=ObjectId();});return modalList;}()),modifyTime:new Date().format('yyyy-MM-dd HH:mm')});});EventAdapter.on($('.notRetain',$divModalSel).off('click'),'click',function(e){$divModalSel.modal('hide');_this.screen.path.splice(0,_this.screen.path.length,{type:'WorkspacePanel',title:I18n.resource.analysis.workspace.WORKSPACE_NAME,data:_this.screen.store.workspaces});_this.screen.store.workspaces.push({id:ObjectId(),templateId:template.id,name:template.name,dsOwnerId:template.creatorId,modalList:template.modalList,modifyTime:new Date().format('yyyy-MM-dd HH:mm')});});$divModalSel.modal('show');});EventAdapter.on(this.$container,'click','.myTpl .tplNameEdit',function(e){e.stopPropagation();var _that=this;var oldName=$(this).prev('.tplName').html();var $editCt=$('<div style="position: absolute;top: 48%;left: 50%;margin-left: -50px;"></div>');var $input=$('<input type="text" style="display: inline-block; width: 120px;"/>').val(oldName);var $button=$('<button type="button" class="btn btn-default" style="display: inline-block;padding: 1px 5px;margin-left: 9px;margin-top: -2px;">OK</button>');EventAdapter.on($button,'click',function(e){e.stopPropagation();var newName=$input.val();$(_that).removeAttr('style');$(_that).prev('.tplName').show();$input.remove();$(this).remove();if(!newName||newName.length==0||oldName==newName)return;var tplId=$(_that).closest('.userTemplate ').attr('data-id');var match=undefined;_this.tplData.userTemplate.forEach(function(userTpl){if(userTpl.id==tplId){match=userTpl;}});if(match!==undefined){match.modifyTime=new Date().format('yyyy-MM-dd HH:mm');match.name=newName;}});$(this).hide().prev('.tplName').hide();$editCt.append($input).append($button);$(this).after($editCt);$input.focus();});};templatePanel.prototype.detachEvents=function(){this.$container.off('click');};templatePanel.prototype.attachItemsEvents=function($items){};templatePanel.prototype.detachItemsEvents=function($items){};templatePanel.prototype.close=function(){this.$container.empty();this.detachEvents();};return templatePanel;}(window,jQuery,window.analysis.models.TemplateModel));﻿
var EnergyScreen=(function(){function EnergyScreen(id,store,shareSaveChange,dsInfoList){if(!id){this.id=ScreenCurrent.id;}else{this.id=id;}
this.factoryIoC=undefined;this.factoryIoCAnalysis=undefined;this.listEntity=undefined;this.mapRefresh={};this.popRefresh={};this.arrEntityOrder=undefined;this.requestPoints=[];this.dictPopToEntity={};this.store=store?store:undefined;this.container=undefined;this.dsInfolist=dsInfoList;if(store){this.sharedesc=store.desc;}else if(shareSaveChange){this.sharedesc=shareSaveChange.desc;}
this.isForReport=store?true:false;this.shareLogId=shareSaveChange?shareSaveChange.shareLogId:false;if(this.shareLogId){this.isForReport=true;}
this.isForBencMark=undefined;this.modalConfigPane=undefined;this.isConfigMode=false;this.workerUpdate=undefined;this.paneDatasource=undefined;this.arrColor=echarts.config.color;this.isScreenChange=undefined;this.isPlayback=false;this.$obCanvasContainer=undefined;this.canvas=undefined;this.toolContainer=undefined;}
EnergyScreen.prototype={show:function(){var _this=this;ElScreenContainer.innerHTML='';WebAPI.get("/static/views/observer/energyScreen.html").done(function(resultHtml){var divMain=document.createElement('div');divMain.className='indexContent st-pusher';divMain.innerHTML=resultHtml;var stCt=$('<div id="st-container" class="st-container">')[0];stCt.appendChild(divMain);ElScreenContainer.appendChild(stCt);_this.container=document.getElementById('paneCenter');_this.$obCanvasContainer=$(_this.container);_this.modalConfigPane=new modalConfigurePane(document.getElementById('energyModal'),_this,'dashboard');_this.modalConfigPane.show();_this.init();});},close:function(){if(this.isConfigMode){if(this.isScreenChange){var saveConfirm=confirm('There are some changes haven\'t been saved, do you want to save them before quit? ');if(saveConfirm){this.saveLayout();}}}
for(var key in this.listEntity){this.listEntity[key].close();}
if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;this.factoryIoC=null;this.factoryIoCAnalysis=null;this.listEntity=null;this.arrEntityOrder=null;this.store=null;this.container=null;this.dictPopToEntity=null;this.UNIT_WIDTH=null;this.UNIT_HEIGHT=null;AppConfig.datasource=null;this.paneDatasource&&this.paneDatasource.close&&this.paneDatasource.close();this.$obCanvasContainer=null;this.canvas=null;this.arrColor=null;this.dsInfolist=null;this.mapRefresh=null;this.modalConfigPane=null;this.popRefresh=null;this.requestPoints=null;this.toolContainer=null;this.isForBencMark=null;this.isForReport=null;this.isPlayback=null;this.shareLogId=null;if(ToolCurrent)ToolCurrent.close();ToolCurrent=null;$('#ulTools').html('');var $toolBacktrace=$('.toolBacktrace');$toolBacktrace.remove();$('#btnConfigDashboard').remove();},stop:function(){if(this.workerUpdate)this.workerUpdate.terminate();},onresize:function(){var entity;for(var key in ScreenCurrent.listEntity){entity=ScreenCurrent.listEntity[key];if(entity.chart)entity.chart.resize();if(entity.entityAnalysis&&entity.entityAnalysis.chart)entity.entityAnalysis.chart.resize();}},init:function(){var _this=this;Spinner.spin(ElScreenContainer);if(this.store){initByData();Spinner.stop();}else{WebAPI.get("/spring/get/"+this.id+'/'+AppConfig.userId).done(function(result){_this.store=JSON.parse(result);initByData();}).always(function(e){Spinner.stop();});}
if(this.dsInfolist){_this.store.dsInfoList=this.dsInfolist;}
function initByData(){_this.paneDatasource=new DataSource(_this);AppConfig.datasource=_this.paneDatasource;_this.initIoc();_this.initLayout();_this.initToolBar();_this.initWorkerForUpdating();_this.initScreen();_this.initReplay();};$('#btnModalAdd').off('click').click(function(e){var entity=new ModalNone(_this,{id:(+new Date()).toString(),spanC:6,spanR:2,modal:{type:"ModalNone"}});_this.arrEntityOrder.push(entity.entity.id);_this.listEntity[entity.entity.id]=entity;entity.render();entity.configure();});},initToolBar:function(){var _this=this;if(AppConfig.isMobile)return;if(this.isForBencMark)return;if(this.isForReport){var btnMode=$('<span>').addClass('badge grow toolbar-btn-selected').text('ok').css('cursor','pointer').css('background-color','#5bc0de').click(function(e){_this.saveLayout();_this.isConfigMode=false;});_this.isConfigMode=true;$('.springLinkBtn').hide();$('.sideTrans').fadeIn();$($('.nav-header')[0]).click();}
else{var $liConfig=$('<li class="iconWrap" id="btnConfigDashboard"><span class="glyphicon glyphicon-cog"></span><span class="dropdownNav">'+I18n.resource.observer.widgets.CONFIG_MODE+'</span> </li>');var btnMode=$('<span>').addClass('badge grow').text('').css('cursor','pointer').css('background-color','#5bc0de').click(function(e){_this.isConfigMode=false;e.currentTarget.classList.remove('toolbar-btn-selected');_this.saveLayout();$('.springLinkBtn').removeAttr('style');});$liConfig.click(function(e){_this.isConfigMode=true;$('.springLinkBtn').hide();_this.showConfigMode();$('.sideTrans').fadeIn();document.querySelector('#leftCt').click();$($('.nav-header')[0]).click();btnMode.text(I18n.resource.observer.widgets.CONFIG_SAVE);});}
var ulTools=$('#ulTools');ulTools.html('');btnMode.appendTo($('<li><a>')).appendTo(ulTools);$('#btnConfigDashboard').remove();$('#btnChangeProject').before($liConfig);},initIoc:function(){this.factoryIoC=new FactoryIoC('dashboard');this.factoryIoCAnalysis=new FactoryIoC('analysis');},initLayout:function(){this.listEntity={};this.arrEntityOrder=[];if(!this.isForBencMark){var side=new SidebarMenuEffect();side.init('#paneContent');}
I18n.fillArea($('#toolBox'));if(!(this.store&&this.store.layout))return;for(var i=0,item;i<this.store.layout.length;i++){for(var j=0;j<this.store.layout[i].length;j++){item=this.store.layout[i][j];var modelClass,entity;if(item.modal.type&&(item.modal.type!='ModalNone'||item.isNotRender==true)){modelClass=this.factoryIoC.getModel(item.modal.type);if(!modelClass)continue;if(item.isNotRender)continue;entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);if(item.modal.interval&&item.modal.interval>=0){for(var k=0,point,kLen=item.modal.points.length;k<kLen;k++){point=item.modal.points[k];if(this.requestPoints.indexOf(point)<0){this.requestPoints.push(point);}}}
if(item.modal.popId){if(!this.dictPopToEntity[item.modal.popId])this.dictPopToEntity[item.modal.popId]=[];this.dictPopToEntity[item.modal.popId].push(item.id);if(this.requestPoints.indexOf(item.modal.popId)<0){this.requestPoints.push(item.modal.popId);}}
entity.render();}else if(item.modal.type=='ModalNone'){modelClass=this.factoryIoC.getModel(item.modal.type);entity=new modelClass(this,item);this.listEntity[item.id]=entity;this.arrEntityOrder.push(item.id);entity.render();}}}
var $springCtn=$('#paneCenter').children('.springContainer');if($springCtn.length==1&&parseFloat($springCtn[0].style.height)>=parseFloat("99%")&&parseFloat($springCtn[0].style.width)>=parseFloat("99%")){$springCtn.children('.panel-default').css({border:'none'});}
var _this=this;if(_this.isForReport){_this.showConfigMode();document.querySelector('#leftCt').click();}},initWorkerForUpdating:function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);this.workerUpdate.postMessage({pointList:this.requestPoints,type:"datasourceRealtime"});},refreshData:function(e){var _this=this.self?this.self:this;if(!e.data.error&&e.data.dsItemList){var point;for(var i=0,iLen=e.data.dsItemList.length;i<iLen;i++){point=e.data.dsItemList[i];_this.mapRefresh[point.dsItemId]=point;if(_this.dictPopToEntity[point.dsItemId]){_this.popRefresh[point.dsItemId]=point;}}
var entity,arrUpdataData;for(var key in _this.listEntity){entity=_this.listEntity[key];if(entity.entity.modal.type=="ModalNone"||entity.entity.modal.type=="ModalMix")continue;arrUpdataData=[];if(entity.entity.modal&&entity.entity.modal.points){for(var i=0,iLen=entity.entity.modal.points.length;i<iLen;i++){var point=entity.entity.modal.points[i];if(!point)continue;if(entity.entity.modal.points.indexOf(point)!=i)continue;if(_this.mapRefresh[point]!=undefined)
arrUpdataData.push(_this.mapRefresh[point]);}
entity.entity.modal.popId&&entity.renderPop(_this.popRefresh[entity.entity.modal.popId]);entity.update(arrUpdataData);}}}else{new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[e.data.error]).showAtTop(5000);}},refreshDataTrace:function(e){var _this=this;_this.refreshData(e);for(var key in this.listEntity){if(undefined!=_this.listEntity[key].goBackTrace){_this.listEntity[key].goBackTrace(e);}}},saveLayout:function(){var _this=this;var arrEntity=[];var entity=null;for(var i=0;i<this.arrEntityOrder.length;i++){entity=this.listEntity[this.arrEntityOrder[i]].entity;if(['ModalObserver','ModalNote','ModalMix','ModalHtml','ModalChartCustom','ModalWeather'].indexOf(entity.modal.type)>-1){arrEntity.push(entity);}else if(entity.modal.type=='ModalPointKPI'){arrEntity.push(this.dealWithEntity(entity));}else if(entity.modal.type=='ModalReportChapter'){if(entity.modal.option&&entity.modal.option.menuId&&entity.modal.option.menuId!=''){arrEntity.push(entity);}}else{if(entity.modal.type!='ModalNone'&&(!entity.modal.points||entity.modal.points.length==0))continue;arrEntity.push(entity);}}
var data={creatorId:AppConfig.userId,menuItemId:this.id,layout:[arrEntity]};this.store.id&&(data.id=this.store.id);Spinner.spin(ElScreenContainer);WebAPI.post('/spring/saveLayout',data).done(function(result){if(_this.isForReport){var argSkin=AppConfig.chartTheme=='macarons'?'':'?skin=dark';_this.initShareIframe("/share/db/"+AppConfig.userId+"/"+_this.id+argSkin);ScreenManager.show(shareLogging,AppConfig.userId);}else{if(_this.isConfigMode&&_this.isScreenChange)return;ScreenManager.show(EnergyScreen);}}).always(function(result){if(_this.isConfigMode&&_this.isScreenChange)return;Spinner.stop();});if(_this.isForReport){var modeType;if(_this.shareLogId){modeType=true;}else{modeType=false;}
var argSkin=AppConfig.chartTheme=='macarons'?'':'?skin=dark';var postData={menuId:_this.id+argSkin,mode:modeType,shareLogId:_this.shareLogId,desc:_this.sharedesc}
WebAPI.post('/analysis/saveShareLog/'+AppConfig.userId,postData).done(function(result){console.log(JSON.parse(result).status)})}},dealWithEntity:function(entity){entity.modal.points=[];entity.modal.interval=5;entity.modal.option&&entity.modal.option.kpiList&&entity.modal.option.kpiList.forEach(function(kpiItem){traverseTree(kpiItem);});function traverseTree(tree){dealWithNode(tree);traverse(tree,0);}
function traverse(node,i){var children=node.list;if(children!=null&&children.length>0){dealWithNode(children[i]);if(i==children.length-1){for(var j=0;j<children.length;j++){traverse(children[j],0);}}else{traverse(node,i+1);}}}
function dealWithNode(child){delete child.pointPassData;delete child.show;if(child.pointKPI){entity.modal.points.push(child.pointKPI);}
if(child.pointGrade){entity.modal.points.push(child.pointGrade);}
if(child.pointPass){entity.modal.points.push(child.pointPass);}}
return entity;},setEntity:function(entity){},replaceEntity:function(sourceId,targetId,parentId){if(sourceId==targetId)return;var _this=this;var source=this.listEntity[sourceId];var target=this.listEntity[targetId];source.entity.id=(+new Date()).toString();target.entity.id=(+new Date()+1).toString();this.listEntity[source.entity.id]=source;this.listEntity[target.entity.id]=target;delete this.listEntity[sourceId];delete this.listEntity[targetId];source.initContainer(targetId).configure();target.initContainer(sourceId).configure();this.arrEntityOrder[this.arrEntityOrder.indexOf(targetId)]=source.entity.id;this.arrEntityOrder[this.arrEntityOrder.indexOf(sourceId)]=target.entity.id;if(parentId){this.listEntity[parentId].entity.modal.option.subChartIds.forEach(function(i){if(i.id==sourceId){i.id=target.entity.id;}});this.listEntity[parentId].entity.modal.option.subChartIds.forEach(function(i){if(i.id==targetId){i.id=source.entity.id;}});}
if(source.entity.modal.type=='ModalMix'){source.entity.modal.option&&source.entity.modal.option.subChartIds&&source.entity.modal.option.subChartIds.forEach(function(i){var entity=_this.listEntity[i.id].entity,modelClass,item;modelClass=_this.factoryIoC.getModel(entity.modal.type);_this.container=$('#divContainer_'+source.entity.id).find('.chartsCt')[0];item=new modelClass(_this,entity);item.configure()});}
if(target.entity.modal.type=='ModalMix'&&target.entity.modal.option&&target.entity.modal.option.subChartIds){target.entity.modal.option.subChartIds.forEach(function(i){var entity=_this.listEntity[i.id].entity,modelClass,item;modelClass=_this.factoryIoC.getModel(entity.modal.type);_this.container=$('#divContainer_'+target.entity.id).find('.chartsCt')[0];item=new modelClass(_this,entity);item.configure()});}},rebornEntity:function(entityParams,tragetType,targetTitle){this.removeEntity(entityParams.id);entityParams.modal.type=tragetType;entityParams.modal.title='';var modelClass=this.factoryIoC.getModel(tragetType);if((!entityParams.isNotRender)&&entityParams.modal.type!=='ModalMix'){entityParams.spanC=modelClass.prototype.optionTemplate.minWidth;entityParams.spanR=modelClass.prototype.optionTemplate.minHeight;}
var entity=new modelClass(this,entityParams);this.listEntity[entity.entity.id]=entity;this.arrEntityOrder.push(entity.entity.id);entity.configure();},removeEntity:function(id){this.listEntity[id]=null;delete this.listEntity[id];this.arrEntityOrder.splice(this.arrEntityOrder.indexOf(id),1);},render:function(data){for(var key in this.listEntity){this.listEntity[key].render();}},showConfigMode:function(){this.stop();Spinner.spin(document.getElementById('paneCenter'));for(var key in this.listEntity){this.listEntity[key].configure();}
this.initToolBox();this.initDataSourcePanel();Spinner.stop();},initToolBox:function(){var $toolBox=$($('.col-sm-2')[0].children[0]);var $modals=$('<div id="modalCt" class="panel-body">').appendTo($toolBox);var list,template,option,groupList=[];list=this.factoryIoC.getList();for(var ele=0;ele<list.length;ele++){template=list[ele];option=template.prototype.optionTemplate;if(!option)continue;if(option.parent!=null){if(!groupList[option.parent]){groupList[option.parent]=new Array();}
groupList[option.parent].push(option)}}
for(var i=0;i<groupList.length;i++){$modals.append(getModalList(groupList[i]));}
function getModalList(group){var $ul=$('<ul class="nav nav-list accordion-group">');var $liList=$('<li class="rows" style="display: none;">').appendTo($ul);for(var i in group){if(i==0){var $liHd=$('<li class="nav-header">').append('<i class="icon-plus icon-white"></i>'+I18n.findContent(group[i].name)).click(function(){var $otherUl=$(this).parent('ul').siblings('ul');$otherUl.find('.rows').slideUp();$otherUl.find('i').removeClass('icon-minus').addClass('icon-plus');$(this).next('.rows').slideToggle();var $i=$(this).find('i');var toggleClass=(function(){if($i.hasClass('icon-minus'))
return'icon-plus icon-white'
else
return'icon-minus icon-white'})();$(this).find('i').removeClass().addClass(toggleClass)});$ul.prepend($liHd);}else{var $div=$('<div class="lyrow ui-draggable" draggable="true"> ').html(I18n.findContent(group[i].name)).attr('type',group[i].type);$div[0].ondragstart=function(e){e.dataTransfer.setData("type",$(this).attr('type'));e.dataTransfer.setData("title",$(this).text());}
$liList.append($div);}}
return $ul;}},initDataSourcePanel:function(){var _this=this;WebAPI.get('/datasource/get/'+AppConfig.userId).done(function(result){_this.store.group=JSON.parse(result).group;_this.paneDatasource=new DataSource(_this);AppConfig.datasource=_this.paneDatasource;_this.paneDatasource.show();}).always(function(e){Spinner.stop();});},hideAnlsPane:function(){$('#paneCenter').hide();$('#energyModal').hide();},showAnlsPane:function(){$('#paneCenter').show();$('#energyModal').show();},getDSItemById:function(datasourceItemId){for(var i=0,len=this.store.datasources[0].list.length;i<len;i++){if(this.store.datasources[0].list[i].id===datasourceItemId){return this.store.datasources[0].list[i];}}
return null;},updateDataSources:function(updateData){this.store.group=updateData;},screenChangeJudge:function(){var _this=this;var entity;var arrEntity=[];for(var i=0;i<this.arrEntityOrder.length;i++){entity=this.listEntity[this.arrEntityOrder[i]].entity;if(entity.modal.type==='ModalObserver'||entity.modal.type==='ModalNote'){arrEntity.push(entity);}else{if(entity.modal.type!='ModalNone'&&(!entity.modal.points||entity.modal.points.length==0))continue;arrEntity.push(entity);}}},initReplay:function(){var _this=this;var $ele=$('#right-nav').find('li:first ul>.toolBacktrace');if($ele.length>0){$ele.remove();}
this.toolContainer=$('#divEnergyTools');var btnTimeShaft=$('<li class="iconWrap"><span class="glyphicon glyphicon-play-circle"></span><span class="dropdownNav"></span></li>').addClass('toolBacktrace');btnTimeShaft.children('.dropdownNav').text(I18n.resource.observer.widgets.BACKTRACE);btnTimeShaft.click(function(e){if(_this.isPlayback){_this.quitBacktraceMode(_this,e);}else{_this.enterBacktraceMode(_this,e);}});$('#right-nav').find('#btnOperatingRecord').after(btnTimeShaft);if(this.isInDiagnosis)ToolCurrent=new TimeShaftDashboard(_this);},enterBacktraceMode:function(screen,e){var _this=screen?screen:this;_this.isPlayback=true;if(e){e.currentTarget.classList.add('selected');$(e.currentTarget).find('.dropdownNav').html(I18n.resource.observer.widgets.QUIT_TRACE);}
if(!ToolCurrent)ToolCurrent=new TimeShaftDashboard(_this);ToolCurrent.containerHeight=100;ToolCurrent.show();if(_this.workerUpdate){_this.workerUpdate.terminate();_this.workerUpdate=null;}
$.when(ToolCurrent.defer).done(function(){var jCanvas=_this.$obCanvasContainer;jCanvas.css({height:'100%',width:'100%'});var jParent=jCanvas.parent();var height=jCanvas.height()-ToolCurrent.containerHeight;var width=jCanvas.width();if(width>jParent.width()){width=jParent.width();height=width/(_this.canvas.width/_this.canvas.height);}
jCanvas.animate({height:height,width:width,marginTop:(jParent.height()-height-ToolCurrent.containerHeight)/2+'px'},400,function(){_this.initScreen();_this.renderElements();_this.initWorkerForUpdating();});});},quitBacktraceMode:function(screen,e){var _this=screen?screen:this;_this.isPlayback=false;if(e){e.currentTarget.classList.remove('selected');$(e.currentTarget).find('.dropdownNav').html(I18n.resource.observer.widgets.BACKTRACE);}
ToolCurrent.close();ToolCurrent=null;_this.$obCanvasContainer.animate({height:'100%',width:'100%'},300,function(){_this.initScreen();_this.renderElements();_this.initWorkerForUpdating();});},initScreen:function(){if(this.isDetailPage){var _this=this;var dialogWidth=this.store.page.width+40>$(window).width()?$(window).width()-200:this.store.page.width+40;var detailScreenModal=$('#detailScreenModal');var $toolBacktrace=$('.toolBacktrace');I18n.fillArea($('#detailScreenModal'));$toolBacktrace.remove();if(this.dialogTitle){var oldDialogTitle=detailScreenModal.find('.modal-title').text();detailScreenModal.find('.modal-title').text(this.dialogTitle);}
detailScreenModal.find('.modal-dialog').css("margin","0 auto 0 auto").css("width",dialogWidth);detailScreenModal.off('hidden.bs.modal').on('hidden.bs.modal',function(e){if(ScreenModal){ScreenModal.close();ScreenModal=null;}
_this.initToolBar(tObscreen);Spinner.stop();oldDialogTitle&&$(this).find('.modal-title').text(oldDialogTitle);}).modal({});Spinner.spin(detailScreenModal.find('.modal-body')[0]);var paddingLeft=(1920-this.store.page.width)/2;var paddingTop=(955-this.store.page.height)/2;convertPositionToReal(this.store.equipments);convertPositionToReal(this.store.buttons);convertPositionToReal(this.store.texts);convertTempDistributionsToReal(this.store.tempDistributions);function convertPositionToReal(arr){if(arr){for(var i=0;i<arr.length;i++){var temp=arr[i];temp.x=temp.x-paddingLeft;temp.y=temp.y-paddingTop;}}}
function convertTempDistributionsToReal(dis){if(!dis){return}
dis.x-=paddingLeft;dis.y-=paddingTop;convertPositionToReal(dis.data);}}else{if(ScreenModal&&!this.isInDiagnosis){if(ScreenCurrent)ScreenCurrent.close();ScreenCurrent=ScreenModal;ScreenModal=null;}
if(this.isInDiagnosis)this.diagScreen.obScreen=this;tObscreen=this;$("#page-"+this.id).parent().addClass("active");}},renderElements:function(){this.dictRefreshMap={};},renderData:function(data,curTm,startTm,endTm){this.refreshDataTrace({data:data,currentTime:curTm,startTime:startTm,endTime:endTm});},initShareIframe:function(shareURL){var strIframe=new StringBuilder();strIframe.append('<div class="modal fade" id="modalShareIframe" style="overflow-y:hidden">');strIframe.append('  <div class="modal-dialog" style="height:95%;width:80%">');strIframe.append('      <div class="modal-content" style="height:100%;">');strIframe.append('          <div class="modal-header" style="height:60px">');strIframe.append('              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>');strIframe.append('              <h4 class="modal-title">'+this.sharedesc+'</h4>');strIframe.append('          </div>');strIframe.append('          <div class="modal-body" id="divShareIframe" style="height:calc(100% - 60px);padding:0">');strIframe.append('              <iframe src="'+shareURL+'" style="height:100%;width:100%;border:none;"></iframe>');strIframe.append('          </div>');strIframe.append('      </div>');strIframe.append('  </div>');strIframe.append('</div>');$('body').append(strIframe.toString());var $modalShareIframe=$('#modalShareIframe');I18n.fillArea($modalShareIframe);$modalShareIframe.modal({show:true});$modalShareIframe.on('hidden.bs.modal',function(e){$modalShareIframe.remove();})}}
return EnergyScreen;})();﻿
var ReportScreen=(function(){var getThisWeekReportNum=function(){var weekNum=DateUtil.getWeekNumber(new Date());return DateUtil.getLastWeekNumberOf(weekNum[0],weekNum[1]);};function ReportScreen(reportStringId,reportType,reportFolder,reportDate){this.$reportNavigation=null;this.$ElScreenContainer=$(ElScreenContainer);this.reportStringId=reportStringId;this.reportType=reportType;this.reportFolder=reportFolder;this.dateList=[];this.pdfMap=[];this.datePickerInstance=null;this.reportDate=reportDate;this.reportName='';this.week=null;this.getMonthFirst=true;this.currentTR=null;this.currentDatePicker=null;this.currentYear=null;this.currentGoToday=false;this.firstOpen=true;this.dateTimePickerInline=false;this.i18nEcharts=I18n.resource.echarts;}
ReportScreen.prototype={displayWeek:getThisWeekReportNum(),reportTypeMap:{daily:'0',monthly:'1',weekly:'2'},baseChartOption:{title:{x:'center',textStyle:{fontSize:15}},tooltip:{trigger:'axis'},toolbox:{show:true,feature:{mark:{show:true},dataView:{show:true,readOnly:true},restore:{show:true},saveAsImage:{show:true}}},animation:false},chartYOffsetSetting:{grid:{y:100},legend:{y:40}},chartType:{pie:'pie',line:'line',scatter:'scatter',bar:'bar',area:'area',table:'table'},chartList:{},show:function(){this.init();},close:function(){this.unregisterChartResize();this.clearHash();this.disposeChart();this.chartList={};$(window).off('resize');this.unregisterPrintEvent();},disposeChart:function(){for(var chartId in this.chartList){this.chartList[chartId].dispose();}},init:function(){if(this.reportDate){this.getReport.apply(this,this.reportDate.split('-'));}else{this.getReport();}
this.chartList={};this.registerPrintEvent();this.registerExportPDFEvent();},pieOptionToContent:function(opt){var html='';var series=$.extend(true,[],opt.series);for(var m=0,ml=series.length;m<ml;m++){series[m].data.sort(function(a,b){return a.name.localeCompare(b.name);});var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+series[m].name+'</p>';html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';for(var n=0,nl=series[m].data.length;n<nl;n++){html+='<tr>'+'<td>'+series[m].data[n].name+'</td>';for(var j=0,jl=series[m].data[n].value.length;j<jl;j++){html+='<td>'+series[m].data[n].value[j]+'</td>'}
html+='</tr>'}
html+='</tbody></table>';}
return html;},optionToContent:function(opt){var axisData=opt.xAxis&&opt.xAxis[0].data,series=opt.series;var title='<p style=" text-align: center; font-size: 15px;font-weight: bold;">'+opt.title.text+'</p>';var html=title+'<table  class="table table-bordered table-hover table-striped" style="-webkit-user-select: initial;  width: 80%;margin: 0 auto;"><tbody>';if(BEOPUtil.isUndefined(axisData)){html+='<tr>';for(var i=0,l=series.length;i<l;i++){html+='<td colspan="2">'+series[i].name+'</td>';}
html+='</tr>';var longestSeriesData=[],longestLength=0;for(var j=0,sl=series.length;j<sl;j++){if(series[j].data.length>longestLength){longestSeriesData=series[j].data;longestLength=longestSeriesData.length;}}
for(var i=0,il=longestSeriesData.length;i<il;i++){html+='<tr>';for(var m=0,ml=series.length;m<ml;m++){if(!BEOPUtil.isUndefined(series[m].data[i])){for(var n=0,nl=series[m].data[i].length;n<nl;n++){html+='<td>'+series[m].data[i][n]+'</td>';}}}
html+='</tr>';}}else{html+='<tr><td>'+opt.xAxis[0].name+'</td>';for(var i=0,l=series.length;i<l;i++){html+='<td>'+series[i].name+'</td>';}
html+='</tr>';for(var i=0,l=axisData.length;i<l;i++){html+='<tr>'+'<td>'+axisData[i]+'</td>';for(var j=0,sl=series.length;j<sl;j++){html+='<td>'+series[j].data[i]+'</td>';}
html+='</tr>';}}
html+='</tbody></table>';return html;},registerChartResize:function(){var _this=this;this.unregisterChartResize();$(window).on('resize.beop.report.echarts',function(){for(var m in _this.chartList){_this.chartList[m].resize();}});},unregisterChartResize:function(){$(window).off('resize.beop.report.echarts');},beforePrintReportScreen:function(){var chart=null,image,$chart;for(var m in this.chartList){chart=this.chartList[m];if(chart){image=this.chartList[m].getImage();$(image).addClass('chartImage');$chart=$(chart.dom);$chart.parent().append(image);$chart.hide();}}},afterPrintReportSceen:function(){var chart=null,$chart;for(var m in this.chartList){chart=this.chartList[m];if(chart){$chart=$(chart.dom);$chart.show();$chart.parent().children('.chartImage').remove();chart.resize();}}},mediaPrintEvent:function(mql){if(mql.matches){this.beforePrintReportScreen();}else{this.afterPrintReportSceen();}},registerExportPDFEvent:function(){var _this=this;var downloadPDF=function(href,filename){var a=$("<a id='test' download='"+filename+"' target='_self'' href='"+href+"'>Download2</a>")[0];try{try{a.click();}catch(ex){var evObj=document.createEvent('MouseEvents');evObj.initEvent('click',true,true,window);a.dispatchEvent(evObj);}}catch(ex){alert('download failed.Please contact the administrator.');return false;}};$(ElScreenContainer).off('click','#exportPDF').on('click','#exportPDF',function(){var chart=null,$image,$chart,$this=$(this),$report=$('.step-play-list').clone(),reportFolderName=$this.attr('reportFolderName'),version=$this.attr('version'),pdfName=AppConfig.projectShowName+'.'+_this.getReportName()+'.'+version+'.pdf';if(_this.pdfMap[version]){downloadPDF(_this.pdfMap[version],pdfName);}else{Spinner.spin(ElScreenContainer);for(var m in _this.chartList){chart=_this.chartList[m];if(chart){$chart=$report.find('[chart-id='+$(chart.dom).attr('chart-id')+']');$image=$(_this.chartList[m].getImage()).addClass('chartImage');$chart.replaceWith($image);}}
$('.canvas-container',$report).each(function(index,item){$(item).prev('.summary').addBack().wrapAll('<div class="pageHeaderWrapper"></div>');});$('.step-item-container',$report).each(function(index,item){$(item).find('.page-header').next().addBack().wrapAll('<div class="pageHeaderWrapper"></div>');});WebAPI.post('/admin/getReportPDF',{html:$report.html(),folder:reportFolderName,version:version,projectName:AppConfig.projectName}).done(function(result){if(result.success){downloadPDF(result.data.createdPDF,pdfName);_this.pdfMap=result.data.pdfMap;}}).always(function(){Spinner.stop();});}})},registerPrintEvent:function(){if(window.matchMedia){window.matchMedia('print').addListener(this.mediaPrintEvent.bind(this));}
$(window).on('beforeprint.beop.report.echarts',this.beforePrintReportScreen.bind(this));$(window).on('afterprint.beop.report.echarts',this.afterPrintReportSceen.bind(this));},unregisterPrintEvent:function(){if(window.matchMedia){window.matchMedia('print').removeListener(this.mediaPrintEvent.bind(this));}
$(window).off('beforeprint.beop.report.echarts');$(window).off('afterprint.beop.report.echarts');},registerMousewheelEvent:function(){var _this=this;$('#indexMain').on('mousewheel.beop.report','.step-container',function(event){var $target=$(this);if(event.originalEvent.wheelDelta>0){if($target.scrollTop()===0){_this.preReportUnit();event.stopPropagation();return false;}else{event.stopPropagation();return true;}}else{if($target.scrollTop()+$target.innerHeight()+1>=$target[0].scrollHeight){_this.nextReportUnit();event.stopPropagation();return false;}else{event.stopPropagation();return true;}}}).on('mousewheel.beop.report',function(event){if(event.originalEvent.wheelDelta>0){_this.preReportUnit();}else{_this.nextReportUnit();}
return false;});},unregisterMousewheelEvent:function(){$('#indexMain').off('mousewheel.beop.report');},clearHash:function(){},_getNextReportUnitItem:function(nextItemFunc){var $reportUnitList=this.$ElScreenContainer.find('.report-unit'),currentIndex,nextIndex,nextReportUnit,nextListItemId;$reportUnitList.each(function(index,item){if($(item).hasClass('active')){currentIndex=index;}});nextIndex=nextItemFunc($reportUnitList.length-1,currentIndex);nextReportUnit=$reportUnitList.get(nextIndex);if(nextReportUnit){nextListItemId=nextReportUnit.id;return this.$reportNavigation.find('a[report-unit="'+nextListItemId+'"]').closest('li');}else{return null;}},nextReportUnit:function(){var $nextItem=this._getNextReportUnitItem(function(total,current){return current===total?0:current+1;});$nextItem&&$nextItem.trigger('click');},preReportUnit:function(){var $nextItem=this._getNextReportUnitItem(function(total,current){return current===0?total:current-1;});$nextItem&&$nextItem.trigger('click',true);},getReportFolder:function(key){return this.reportFolder;},getReportType:function(){return this.reportType;},getReportName:function(){if(!this.reportStringId){return'';}
if(!this.reportName){for(var i=0;i<AppConfig.navItems.length;i++){var navItem=AppConfig.navItems[i];if(navItem.id===this.reportStringId){this.reportName=navItem.text;}}}
return this.reportName;},initReportList:function(){if(!AppConfig.navItems){return false;}
var reportItem,reportItemList,$reportItemBtn,_this=this,$listGroup=$('<ul id="reportNavList" class="list-group reportList" style="width:110px;overflow-y: auto;height: 90%;overflow-x: hidden;"></ul>');reportItemList=AppConfig.navItems.filter(function(item){return item.type==='ReportScreen';});for(var i=0;i<reportItemList.length;i++){reportItem=reportItemList[i];$reportItemBtn=$('<li class="list-group-item ellipsis" id="'+reportItem.id+'" title="'+reportItem.text+'">'+reportItem.text+'</li>');$reportItemBtn.click((function(reportItem){return function(){ScreenManager.show(ReportScreen,reportItem.id,reportItem.reportType,reportItem.reportFolder,_this.reportDate?_this.reportDate.format('yyyy-MM-dd'):null);};})(reportItem));$listGroup.append($reportItemBtn);}
$('#indexMain').append($listGroup);$("#"+_this.reportStringId).addClass("active");var $reportNavList=$("#reportNavList");$reportNavList.css({left:parseInt($(".step-container").offset().left)-parseInt($reportNavList.width())+1-2+'px'});$(window).resize(function(){$reportNavList.css({left:parseInt($(".step-container").offset().left)-parseInt($reportNavList.width())+1-2+'px'});});},getReport:function(year,month,day,isWeekly){var _this=this,version,thisDay;Spinner.spin(ElScreenContainer);var reportFolderName=this.getReportFolder();if(this.getReportType()===this.reportTypeMap.daily){if(!month||!year||!day){thisDay=new Date();thisDay.setDate(thisDay.getDate()-1);version=thisDay.format('yyyy-MM-dd');year=thisDay.getFullYear();month=thisDay.getMonth()+1;day=thisDay.getDate();}else{version=year+"-"+StringUtil.padLeft(month,2,'0')+"-"+StringUtil.padLeft(day,2,'0');}}
else if(this.getReportType()===this.reportTypeMap.monthly){if(!month||!year){thisDay=new Date();year=thisDay.getFullYear();month=DateUtil.getLastMonth();}
version=year+'-'+StringUtil.padLeft(month,2,'0');}else{thisDay=new Date();year=thisDay.getFullYear();month=month?month:(_this.iso8601Week(new Date(year,thisDay.getMonth()-1)));version=year+'-'+month+'-w';}
var getReportFailed=function(){Spinner.spin(ElScreenContainer);WebAPI.get('/static/projectReports/emptyReport.html').done(function(resultHtml){I18n.fillArea($(ElScreenContainer).html(resultHtml));Spinner.spin(ElScreenContainer);if(day){day=day<10?day.length==2?day:'0'+day:day;}
_this.initDatePicker(year,month,day);if(_this.dateTimePickerInline){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,-10);}else{BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50);}
$(window).resize(function(){if(_this.dateTimePickerInline){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,39);}else{BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50);}});_this.initReportList();Spinner.stop();})};return WebAPI.get("/report/getReport/"+AppConfig.projectName+"/"+reportFolderName+'/'+version).done(function(resultHtml){I18n.fillArea($(ElScreenContainer).html(resultHtml));Spinner.stop($(ElScreenContainer));_this.renderCharts($('#beopReport .report-unit'));_this.$reportNavigation=$('.reportNavigation');_this.initDatePicker(year,month,day);if(_this.dateTimePickerInline){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,-10);}else{BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50);}
$(window).resize(function(){if(_this.dateTimePickerInline){BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,39);}else{BEOPUtil.setRelativePosition($(".step-container"),$(".reportNavigation"),0,50);}});_this.$reportNavigation.affix({offset:{top:100}});$('.step-container').scrollspy({target:'.reportNavigation'});var $pdfContent='<a id="exportPDF" class="pdf_download exportPDF pa"><span class="add-on"><img class="pdf_img" src="/static/images/pdf_download.png"　alt="PDF" /></span><span class="pdf_text" i18n="observer.reportScreen.PDF_DOWNLOAD"></span></a>';$(".reportNavigation").prepend($pdfContent);var $exportPDF=$('#beopReport #exportPDF');if(!$exportPDF.length){$('#beopReport').append($exportPDF);}
$exportPDF.attr('reportFolderName',reportFolderName).attr('version',version);_this.initReportList();Spinner.stop();}).fail(function(){getReportFailed();}).always(function(){WebAPI.get("/report/getReportList/"+AppConfig.projectName+"/"+reportFolderName+'/'+version).done(function(result){if(result.success){_this.dateList=$.unique(result.data.htmlReport);_this.pdfMap=result.data.pdfReportMap;}});I18n.fillArea($(ElScreenContainer));Spinner.stop();});},addActiveWeeksStyle:function(){var $con=this.datePickerInstance.picker,yearMonth=this.datePickerInstance.viewDate.format('yyyy-MM').split('-'),year=yearMonth[0],i,timeList;this.filterDateList('week');for(i=0;i<this.dateList.length;i++){timeList=this.dateList[i].split('-');if(timeList[0]==year){$con.find('.datetimepicker-days table tbody td.ui-week-col').each(function(){if($(this).text()==timeList[1]){$(this).parent().addClass('hasReport');}});}}},addActiveDaysStyle:function(){var $con=this.datePickerInstance.picker;var yearMonth=this.datePickerInstance.viewDate.format('yyyy-MM').split("-");var year=yearMonth[0];var month=yearMonth[1];this.filterDateList('day');for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList[0]==year&&timeList[1]==month){$con.find(".day:not('.old,.new')").eq(Number(timeList[2])-1).addClass("hasReport");}}},addActiveMonthsStyle:function(){var $con=this.datePickerInstance.picker;var year=this.datePickerInstance.viewDate.format('yyyy').split("-");this.filterDateList('month');for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList[0]==year){$con.find(".month").eq(Number(timeList[1])-1).addClass("hasReport");}}},filterDateList:function(val){var dayList=[];var monthList=[];var weekList=[];for(var i=0;i<this.dateList.length;i++){var timeList=this.dateList[i].split("-");if(timeList.length==3&&this.getReportType()==this.reportTypeMap.weekly){weekList.push(this.dateList[i]);}
else if(timeList.length>2){dayList.push(this.dateList[i]);}else{monthList.push(this.dateList[i]);}}
if(val=="day"){this.dateList=dayList;}else if(val=='month'){this.dateList=monthList;}else{this.dateList=weekList;}},triggerDateStyle:function(val){var _this=this;var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){if(val=="day"){_this.addActiveDaysStyle();}else if(val=="month"){_this.addActiveMonthsStyle();}else if(val=='weekly'){_this.addActiveWeeksStyle();}},50);},iso8601Week:function(date){var time,checkDate=new Date(date.getTime());checkDate.setDate(checkDate.getDate()+4-(checkDate.getDay()||7));time=checkDate.getTime();checkDate.setMonth(0);checkDate.setDate(1);return Math.floor(Math.round((time-checkDate)/86400000)/7)+1;},renderCharts:function($chartContainer){var echartForI18Option={};if(this.i18nEcharts){echartForI18Option={toolbox:{feature:{mark:{show:true,title:{mark:this.i18nEcharts.MARK,markUndo:this.i18nEcharts.MARKUNDO,markClear:this.i18nEcharts.MARKCLEAR}},dataZoom:{title:{dataZoom:this.i18nEcharts.DATAZOOM,dataZoomReset:this.i18nEcharts.DATAZOOMRESET}},dataView:{title:this.i18nEcharts.DATAVIEW,lang:[this.i18nEcharts.DATAVIEW,this.i18nEcharts.CLOSE,this.i18nEcharts.REFRESH],show:true,readOnly:true},magicType:{title:{line:this.i18nEcharts.LINE,bar:this.i18nEcharts.BAR,stack:this.i18nEcharts.STACK,tiled:this.i18nEcharts.TILED,force:this.i18nEcharts.FORCE,chord:this.i18nEcharts.CHORD,pie:this.i18nEcharts.PIE,funnel:this.i18nEcharts.FUNNEL}},restore:{show:true,title:this.i18nEcharts.REDUCTION},saveAsImage:{show:true,title:this.i18nEcharts.SAVE_AS_PICTURE,lang:[this.i18nEcharts.SAVE]}}}};}
if(jscd.mobile){var _this=this;window.addEventListener('load',function(){$('canvas').off().remove();var m=0;ReportScreen=null;for(m=0;m<_this.chartList.length;m++){_this.chartList[m].clear();_this.chartList[m].dispose();}
_this.chartList=null;$('.canvas-container').off();$('.step-container').off();$(".form_datetime").off();},false);var extraOptionsForMobile={toolbox:{show:false},title:{textStyle:{fontSize:2.5}},grid:{x:2,y:2,x2:2,y2:2},xAxis:[{axisLabel:{textStyle:{fontSize:12},interval:'auto'},nameTextStyle:{fontSize:1.8}}],yAxis:[{axisLabel:{textStyle:{fontSize:2}},nameTextStyle:{fontSize:1.8}}],legend:{textStyle:{fontSize:2}},renderAsImage:true};this.baseChartOption=$.extend(true,this.baseChartOption,extraOptionsForMobile,echartForI18Option);}else{this.baseChartOption=$.extend(true,this.baseChartOption,echartForI18Option);}
var charts=$chartContainer.find('.chart-param');for(var i=0;i<charts.length;i++){this.initCharts($(charts[i]));}},initDatePicker:function(year,month,day){var now=new Date();var year=!year?now.getFullYear():year;var monthNameShort=!month?DateUtil.getMonthNameShort(DateUtil.getLastMonth()-1):DateUtil.getMonthNameShort(month-1);var monthName=!month?DateUtil.getMonthName(DateUtil.getLastMonth()-1):DateUtil.getMonthName(month-1);var day=!day?now.getDate():day;var $datePick=$(".form_datetime");if(this.dateTimePickerInline==true){$datePick.empty();}
var _this=this;var dateDisplay;if(this.getReportType()==this.reportTypeMap.daily){if(!_this.dateTimePickerInline){$datePick.find('input').val(monthNameShort+' '+day+','+year);}
$datePick.datetimepicker({format:"MM dd,yyyy",minView:"month",startView:"month",todayBtn:true,inline:true,sideBySide:true,autoclose:true,endDate:new Date()}).on('changeDate',function(ev){try{var date=ev.date.valueOf().toDate();_this.reportDate=date;_this.getReport(date.getFullYear(),date.getMonth()+1,date.getDate());}catch(e){return false;}}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('day');}).on('show',function(ev){var dayFormat=ev.date.getDate()>=10?ev.date.getDate():'0'+ev.date.getDate();dateDisplay=DateUtil.getMonthNameShort(ev.date.getMonth())+' '+dayFormat+','+ev.date.getFullYear();if(!_this.dateTimePickerInline){$datePick.find('input').val(dateDisplay);}
_this.addActiveDaysStyle();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('day');});});this.dateTimePickerInline==true?updateDaily():'';function updateDaily(){setTimeout(function(){_this.triggerDateStyle('day');$datePick.datetimepicker('update',new Date(year,Number(month)-1,day));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('day');});},0)}}else if(this.getReportType()==this.reportTypeMap.monthly){if(!_this.dateTimePickerInline){$datePick.find('input').val(monthNameShort+','+year);}
$datePick.datetimepicker({format:"MM,yyyy",minView:"year",startView:"year",todayBtn:true,inline:true,sideBySide:true,autoclose:true,endDate:new Date(),monthAbbreviation:true}).on('changeDate',function(ev){try{var date=ev.date.valueOf().toDate();_this.reportDate=date;_this.getReport(date.getFullYear(),date.getMonth()+1);}catch(e){return false;}}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('month');}).on('show',function(ev){dateDisplay=DateUtil.getMonthNameShort(ev.date.getMonth())+','+ev.date.getFullYear();_this.addActiveMonthsStyle();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('month');});});this.dateTimePickerInline==true?updateMonthly():'';function updateMonthly(){setTimeout(function(){_this.triggerDateStyle('month');$datePick.datetimepicker('update',new Date(year,Number(month)-1))
_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('month');});},0)}}else if(this.getReportType()==this.reportTypeMap.weekly){var week;if(this.week!=null){week=this.week;}else if(this.getMonthFirst=true){var date=new Date();week=this.iso8601Week(new Date(date.getFullYear(),date.getMonth()-1));}else{week=this.iso8601Week(new Date(year,['January','February','March','April','May','June','July','August','September','October','November','December'].indexOf(monthName)));}
this.getMonthFirst=false;if(this.currentYear){year=this.currentYear;}
if(!_this.dateTimePickerInline){$datePick.find('input').val(year+'-'+week+'-周');}
$datePick.datetimepicker({format:'yyyy-mm-dd hh:ii',todayBtn:true,autoclose:true,showWeek:true,inline:true,sideBySide:true,minView:2,endDate:new Date()}).on('changeYear changeMonth',function(ev){_this.triggerDateStyle('weekly');}).on('show',function(ev){_this.addActiveWeeksStyle();if(_this.currentTR!==null&&_this.currentTR!==undefined&&_this.currentTR!=='undefined'){if(_this.currentDatePicker){if(!_this.currentGoToday){$datePick.datetimepicker('update',new Date(_this.currentDatePicker).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();$('.datetimepicker:last .datetimepicker-days table tbody tr').eq(_this.currentTR).addClass('active');}else{var weekNow=_this.iso8601Week(new Date())-1;$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});_this.currentGoToday=false;}
_this.addActiveWeeksStyle();}}else{if(_this.firstOpen){$datePick.datetimepicker('update',new Date(year,date.getMonth()-1).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();}else{var weekNow=_this.iso8601Week(new Date())-1;$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});}}
dateDisplay=DateUtil.getMonthName(ev.date.getMonth())+','+ev.date.getFullYear();_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.triggerDateStyle('weekly');});}).on('changeDay',function(date){try{_this.reportDate=date.date;_this.getReport(new Date(date.date).getFullYear(),date.week,null,true);_this.week=date.week;_this.currentTR=date.currentTr;_this.currentDatePicker=date.date;_this.currentYear=new Date(date.date).getFullYear();}catch(e){return false;}}).on('goToToday',function(date){_this.currentGoToday=false;_this.firstOpen=false;try{_this.reportDate=date.date;_this.getReport(new Date(date.date).getFullYear(),date.week,null,true);_this.week=date.week;_this.currentTR=date.currentTr;_this.currentDatePicker=date.date;_this.currentYear=new Date(date.date).getFullYear();}catch(e){return false;}});this.dateTimePickerInline==true?updateWeekly():'';function updateWeekly(){setTimeout(function(){_this.triggerDateStyle('weekly');$datePick.datetimepicker('update',new Date(year,Number(month)-1));_this.datePickerInstance.picker.find(".prev,.next").off().click(function(){_this.triggerDateStyle('weekly');});_this.addActiveWeeksStyle();if(_this.currentTR!==null&&_this.currentTR!==undefined&&_this.currentTR!=='undefined'){if(_this.currentDatePicker){if(!_this.currentGoToday){$datePick.datetimepicker('update',new Date(_this.currentDatePicker).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();$('.datetimepicker:last .datetimepicker-days table tbody tr').eq(_this.currentTR).addClass('active');}else{var weekNow=_this.iso8601Week(new Date())-1;$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});_this.currentGoToday=false;}
_this.addActiveWeeksStyle();}}else{if(_this.firstOpen){$datePick.datetimepicker('update',new Date(year,date.getMonth()-1).format('yyyy-MM-dd'));_this.addActiveWeeksStyle();}else{var weekNow=_this.iso8601Week(new Date())-1;$('.datetimepicker .datetimepicker-days table tbody').find('td').each(function(){if($(this).text()==weekNow){$(this).parent().addClass('active');}});}}},0)}}
this.datePickerInstance=$datePick.data('datetimepicker');},initReportNavigation:function(){var _this=this;this.$reportNavigation.on('click','li.reportChapter',function(){var $this=$(this),$reportUnit,reportUnitId,$sub_li;if($this.hasClass('active')){return false;}
$this.closest('.reportNavigation').find('li.active').removeClass('active');$this.addClass('active');$sub_li=$this.find('li:first');if($sub_li.size()>0){reportUnitId=$sub_li.addClass('active').find('a').attr('report-unit');}
$reportUnit=$('#'+reportUnitId);_this.showReportUnit($reportUnit).done(function(){_this.renderCharts($reportUnit);if(_this.chartList[reportUnitId]){_this.chartList[reportUnitId].resize();}});})},showReportUnit:function($reportUnit,isUp){$reportUnit.closest('.step-play-list').find('.report-unit.active').removeClass('active');var dfd=$.Deferred();$('.step-container').animate({top:isUp?'-200px':'100px',opacity:"toggle"},'fast',function(){$reportUnit.addClass('active');$('.step-container').css('top',isUp?'200px':'-100px').animate({top:'0px',opacity:"toggle"},function(){dfd.resolve();});});return dfd;},generateChartId:function(){return new Date().getTime();},initCharts:function($canvasChart){var chartOpts=this.getChartParam($canvasChart);if(!chartOpts){return;}
var chartDom=$canvasChart.parent()[0],chartId=this.generateChartId(),chartInstance;$(chartDom).attr('chart-id',chartId);switch(chartOpts.type){case this.chartType.line:chartInstance=this.initChartLine(chartDom,chartOpts);break;case this.chartType.pie:chartInstance=this.initChartPie(chartDom,chartOpts);break;case this.chartType.bar:chartInstance=this.initChartBar(chartDom,chartOpts);break;case this.chartType.scatter:chartInstance=this.initChartScatter(chartDom,chartOpts);break;case this.chartType.area:chartInstance=this.initChartArea(chartDom,chartOpts);break;case this.chartType.table:chartInstance=this.initChartTable(chartDom,chartOpts);break;default:console.log('生成图像错误:没有类型'+chartOpts.type);break;}
if(chartOpts.theme){chartInstance.setTheme(chartOpts.theme);}
if(chartInstance){chartInstance.on(echarts.config.EVENT.MAGIC_TYPE_CHANGED,function(event,chart){if(event.magicType.line){chart.setOption({tooltip:{axisPointer:{type:'line'}}})}else if(event.magicType.bar){chart.setOption({tooltip:{axisPointer:{type:'shadow'}}})}});this.chartList[chartId]=chartInstance;this.registerChartResize();}},getChartParam:function($chartParam){try{var unitString=$chartParam.text();if(!unitString){return null;}
unitString=unitString.replace(/"/g,"\\\"").replace(/'/g,"\"");return JSON.parse(unitString);}catch(e){console.error(e);return null;}},getChartSeriesData:function(type,x,yData,y){var result=[];switch(type){case this.chartType.bar:case this.chartType.line:case this.chartType.scatter:case this.chartType.area:{result=yData;break;}
case this.chartType.pie:{for(var i=0;i<y.length;i++){result.push({name:y[i].name,value:y[i].value})}
break;}
default:{result=yData;}}
return result;},getChartOptsFromParam:function(chartParam,type){var y=chartParam.chartItems.y,x=chartParam.chartItems.x,series=[],legend=[],yItem,seriesItem,result,yAxis=[],_this=this;if(type===this.chartType.pie){legend=x;seriesItem={};seriesItem.name=chartParam.title;seriesItem.data=this.getChartSeriesData(type,x,null,y);seriesItem.type=type;seriesItem.selectedMode='single';series.push(seriesItem);}else{if(!$.isArray(y)){var temp=[];for(var key in y){var obj={name:key,value:y[key],yAxisIndex:0};temp.push(obj);}
y=temp;}
for(var m=0,length=y.length;m<length;m++){yItem=y[m];var seriesItem={};seriesItem.yAxisIndex=Number(yItem.yAxisIndex)||0;seriesItem.name=yItem.name;seriesItem.data=this.getChartSeriesData(type,x,yItem.value,yItem);if(yItem.stack){seriesItem.stack=yItem.stack;}
if(type===this.chartType.area){seriesItem.type=this.chartType.line;seriesItem.stack=I18n.resource.observer.widgets.TOTAL_AMOUNT;seriesItem.itemStyle={normal:{areaStyle:{type:'default'}}};}else{if(yItem.type){seriesItem.type=yItem.type;}else{seriesItem.type=type;}}
if(yItem.otherOptions){$.extend(seriesItem,yItem.otherOptions);}
seriesItem._name=yItem.name;series.push(seriesItem);legend.push(yItem.name);}
if(!$.isArray(chartParam.Options.y)){yAxis.push({name:chartParam.Options.y,type:'value',scale:true})}else{for(var i=0;i<chartParam.Options.y.length;i++){var yAxisItem={name:chartParam.Options.y[i],type:'value',scale:true};if(!BEOPUtil.isUndefined(chartParam.yMax)&&chartParam.yMax.length){yAxisItem.max=+chartParam.yMax[i];yAxisItem.scale=false;}
if(!BEOPUtil.isUndefined(chartParam.yMin)&&chartParam.yMin.length){yAxisItem.min=+chartParam.yMin[i];yAxisItem.scale=false;}
yAxis.push(yAxisItem);}}}
result={title:{text:chartParam.title},noDataLoadingOption:{text:I18n.resource.observer.reportScreen.TITLE_NO_DATA,effect:'whirling'},legend:{data:this._sortLegend(legend)},series:series.sort(function(a,b){return _this._sortFunction(a._name,b._name);}),xAxis:[{scale:true,name:chartParam.Options.x}],yAxis:yAxis};if(x&&x.length>0){result.xAxis[0].data=x;result.xAxis[0].type='category';}else{result.xAxis[0].type='value';}
if(type===this.chartType.pie){delete result.xAxis;delete result.yAxis;}
if(chartParam.commonChartOptions){var convertTheFunction=function(obj){for(var prop in obj){if(typeof obj[prop]==='string'&&obj[prop].indexOf('function(')!=-1){obj[prop]=eval(obj[prop]);}else if($.isPlainObject(obj[prop])){convertTheFunction(obj[prop]);}}};try{convertTheFunction(chartParam.commonChartOptions);$.extend(result,chartParam.commonChartOptions);}catch(e){}}
return result;},_sortFunction:function(a,b){var ax=[],bx=[];a.replace(/(\d+)|(\D+)/g,function(_,$1,$2){ax.push([$1||Infinity,$2||""])});b.replace(/(\d+)|(\D+)/g,function(_,$1,$2){bx.push([$1||Infinity,$2||""])});while(ax.length&&bx.length){var an=ax.shift();var bn=bx.shift();var nn=(an[0]-bn[0])||an[1].localeCompare(bn[1]);if(nn)return nn;}
return ax.length-bx.length;},_sortLegend:function(legend){if(!legend){return[];}
legend.sort(this._sortFunction);var ret=[],splitNum;if(legend.length>15){splitNum=Math.ceil(legend.length/3);}else{splitNum=5;}
for(var i=0,j=legend.length;i<j;i++){ret.push(legend[i]);if((i+1)%splitNum===0){ret.push('');}}
return ret;},initChartLine:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{magicType:{show:true,type:['line','bar','stack','tiled']},dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.line));return echarts.init(chartDom).setOption(option);},initChartPie:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.pieOptionToContent}}},legend:{orient:'vertical',x:'left',y:40}};var option=$.extend(true,defaultOption,this.getChartOptsFromParam(chartParam,this.chartType.pie),this.baseChartOption);if(!option.tooltip.formatter||$.isEmptyObject(option.tooltip.formatter)){$.extend(true,option,{tooltip:{trigger:'item',formatter:"{a} <br/> {b} : {c} ({d}%)"}})}
return echarts.init(chartDom).setOption(option);},initChartBar:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{magicType:{show:true,type:['line','bar','stack','tiled']},dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}},tooltip:{trigger:'axis',axisPointer:{type:'shadow'}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.bar));return echarts.init(chartDom).setOption(option);},initChartScatter:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.scatter));return echarts.init(chartDom).setOption(option);},initChartArea:function(chartDom,chartParam){var _this=this;var defaultOption={toolbox:{feature:{dataView:{show:true,readOnly:true,optionToContent:_this.optionToContent}}}};var option=$.extend(true,defaultOption,this.baseChartOption,this.chartYOffsetSetting,this.getChartOptsFromParam(chartParam,this.chartType.area));return echarts.init(chartDom).setOption(option);},initChartTable:function(chartDom,chartParam){if(chartParam&&chartParam.chartItems&&chartDom){chartParam.chartItems.title=chartParam.title?chartParam.title:'';chartParam.chartItems.firstColumn=chartParam.Options&&chartParam.Options.x?chartParam.Options.x:'';$(chartDom).replaceWith(beopTmpl('tmpl_table',chartParam.chartItems));}}};return ReportScreen;})();﻿
var DiagnosisScreen=(function(){var _this=undefined;function DiagnosisScreen(){this.dictZone=undefined;this.dictEquipment=undefined;this.dictFault=undefined;this.dictObserverText=undefined;this.arrLastNotice=undefined;this.workerUpdate=undefined;this.tabelModelData=undefined;this.tableModelUpdate=undefined;this.floorCount=0;this.dialog=undefined;this.lang=I18n.resource.diagnosis;this.langCfg=this.lang.config;this.faId=0;this.faUserId=0;this.obScreen=undefined;this.$obContainer=undefined;this.urgentCount=0;this.criticalCount=0;this.judgeProjectId=(AppConfig.projectId==80)?true:false;_this=this;}
DiagnosisScreen.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/diagnosisScreen.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.logCtWidth=parseInt($('#diagnosisLogCt')[0].classList[0].split('-')[2]);I18n.fillArea($(ElScreenContainer));Spinner.spin(ElScreenContainer);_this.init();});},close:function(){this.dictZone=null;this.dictEquipment=null;this.dictFault=null;this.dictObserverText=null;this.tabelModelData=null;this.arrLastNotice=null;this.floorCount=null;if(this.workerUpdate)this.workerUpdate.terminate();this.workerUpdate=null;if(this.tableModelUpdate)this.tableModelUpdate.terminate();this.tableModelUpdate=null;if(this.dialog)this.dialog.close();if(this.obScreen)this.obScreen.close();if(ToolCurrent)ToolCurrent.close();},onresize:function(){ScreenCurrent.obScreen.resize();},init:function(){var side=new SidebarMenuEffect();side.init('#divCanvas');this.$obContainer=$('#obContainer');this.dictObserverText={};var _this=this;WebAPI.get('/diagnosis/getAll/'+AppConfig.projectId).done(function(result){_this.initData(JSON.parse(result));_this.initPaneNav();if(_this.judgeProjectId){_this.changeModal();}
_this.initWorkerForUpdating();if(_this.judgeProjectId){$('#btnChangeModal').show().off('click').click(function(){var $tabelModelPanel=$('#panelIconNew');if($tabelModelPanel[0].style.display=='none'||$tabelModelPanel[0].style.display==''){Spinner.spin(ElScreenContainer);_this.tableModelDataUpdating();$tabelModelPanel.show();$('#errTipNew').hide();$('.tdFirst').off('click').click(function(e){var id=e.target.getAttribute('pageId');if(id){if(_this.obScreen===undefined){$tabelModelPanel.hide();_this.obScreen=new ObserverScreen(id);_this.initObScreen();_this.obScreen.show(_this.$obContainer[0]);}else if(_this.obScreen.id===id){$tabelModelPanel.hide();return;}else{$tabelModelPanel.hide();_this.obScreen.close();_this.obScreen=new ObserverScreen(id);_this.initObScreen();_this.obScreen.show(_this.$obContainer[0]);}
$(ElScreenContainer).off('click').on('click','#btnFloorsSP',_this.topFloors);}
else{$tabelModelPanel.hide();alert('This floor has no details');}});$('.tdFirst').hover(function(){$(this).parent('tr').children('td:not(:first)').addClass('tdShadow');$(this).addClass('tdFirstHover');},function(){$(this).removeClass('tdFirstHover');$(this).parent('tr').children('td:not(:first)').removeClass('tdShadow');});}else{$tabelModelPanel.hide();if(_this.tableModelUpdate)_this.tableModelUpdate.terminate();_this.tableModelUpdate=null;}});}
$('.div-nav-row','#paneIcon').eq(0).children('span:first').trigger('click');});if(_this.judgeProjectId){$('#divPaneNotice').find('div.panel-body:eq(0)').addClass('noticeAll');var $reuseDemand=$('<div id="reuseDemand" class="panel-body gray-scrollbar"></div>');$('#divPaneNotice').append($reuseDemand);}
$("#btnNoticeHistory").off().click(function(e){ScreenModal=new DiagnosisHistory(_this);ScreenModal.show();});$("#btnNoticeConfig").off().click(function(e){ScreenModal=new DiagnosisConfig(_this);ScreenModal.show();});$('#btnWarningLog').off().click(function(){viewLog(this);if(_this.judgeProjectId){$('#reuseDemand').hide();$('#divPaneNotice .noticeAll').show();}
$('#groupUrgent .rows').slideUp();$('#groupCritical .rows').slideDown();});$('#btnAlertLog').off().click(function(){viewLog(this);if(_this.judgeProjectId){$('#reuseDemand').hide();$('#divPaneNotice .noticeAll').show();}
$('#groupCritical .rows').slideUp();$('#groupUrgent .rows').slideDown();});if(_this.judgeProjectId){$('#changeDemandPool').show().off().click(function(){viewLog(this);var taskPool=new TaskPool();taskPool.show($('#reuseDemand'),80);$('#reuseDemand').show();$('#divPaneNotice .noticeAll').hide();});}
$('#btnStickyPost').off().click(function(){var $diagnosisLogCt=$('#diagnosisLogCt');var $divPaneNotice=$('#divPaneNotice');var $divCanvas=$('#divCanvas');var $stContainer=$('#st-container');var divCanvasWidth=parseInt($divCanvas[0].classList[0].split('-')[2]);if($stContainer.find('#diagnosisLogCt')[0]){$diagnosisLogCt.insertAfter($('#st-container'));$diagnosisLogCt.removeClass('st-effect-1');$divPaneNotice.addClass('top');$divCanvas[0].className='col-sm-'+(divCanvasWidth+3);$divCanvas[0].style.positions='absolute';$diagnosisLogCt.css({position:'fixed',top:'54px',zIndex:2});if(_this.isMin){$diagnosisLogCt.addClass('minLog');$diagnosisLogCt.find('.panel-body').hide();$('#logTitle').hide();$('#btnStickyPost').hide();$('#btnMinimize').hide();$diagnosisLogCt[0].style.minWidth='';}}else{$diagnosisLogCt.insertAfter($divCanvas);$divCanvas[0].className='col-sm-'+(divCanvasWidth-3)+' st-content';$diagnosisLogCt.addClass('st-effect-1');$divPaneNotice.removeClass('top');$diagnosisLogCt.css({position:'relative',top:0});_this.obScreen.$obCanvasContainer.css('width','100%');}
$(this).toggleClass('top notTop');_this.obScreen.resize();});$('#btnMinimize').off().click(function(){var $diagnosisLogCt=$('#diagnosisLogCt');var $paneBody=$diagnosisLogCt.find('.panel-body');var $noticeAll,$reuseDemand;if(_this.judgeProjectId){$noticeAll=$diagnosisLogCt.find('.noticeAll');$reuseDemand=$('#reuseDemand');}
if($diagnosisLogCt.parent().prop('className').indexOf("indexContent")>-1){_this.isMin=true;$('#btnStickyPost').click();}else{if(_this.judgeProjectId){if(!$noticeAll.is(':hidden')||!$reuseDemand.is(':hidden')){$diagnosisLogCt.addClass('minLog');$paneBody.hide();$('#logTitle').hide();$('#btnStickyPost').hide();$('#btnMinimize').hide();$diagnosisLogCt[0].style.minWidth='';}}else{if(!$paneBody.is(':hidden')){$diagnosisLogCt.addClass('minLog');$paneBody.hide();$('#logTitle').hide();$('#btnStickyPost').hide();$('#btnMinimize').hide();$diagnosisLogCt[0].style.minWidth='';}}}});function viewLog(obj){var $diagnosisLogCt=$('#diagnosisLogCt');var $paneBody=$diagnosisLogCt.find('.panel-body');if($paneBody.is(':hidden')){$diagnosisLogCt.removeClass('minLog');$paneBody.show();$('#logTitle').show();$('#btnStickyPost').show();$('#btnMinimize').show();$diagnosisLogCt.css({minWidth:'260px'});}}
$('#btnChangeAlarm').click(function(e){var $this=$(this);var level=parseInt($('#selectAlarmLevel').find('option:selected').attr('setval'));var delayVal=$('#selectAlarmTime').find('option:selected').attr('setval');var now=(new Date()).getTime();var time,status=0;if(0==delayVal){time=new Date(now);status=1;}
else if(1==delayVal){time=new Date(now+3600000);}
else if(2==delayVal){time=new Date(now+43200000);}
else if(3==delayVal){time=new Date(now+86400000);}
else if(4==delayVal){time=new Date(now+604800000);}
else if(5==delayVal){time=new Date(now);time.setMonth(now.getMonth()+1);}
else if(6==delayVal){time=new Date(now+999999999);}
time=time.format("yyyy-MM-dd HH:mm:ss");var postData={'id':_this.faId,'userId':_this.faUserId,'isUserDefined':true,'userFaultGrade':level,'userFaultDelay':time,status:status};var text=$this.text();$this.text('Waiting').prop('disabled',true);WebAPI.post('/diagnosis/fault/customUpdate/'+AppConfig.projectId,postData).done(function(result){var data=JSON.parse(result);if(data){var oldLevel=_this.dictFault[_this.faId].userFaultGrade;var $divFault=$('.rows div[faultid="'+_this.faId+'"]');var groupId=$divFault.closest('ul').attr('id');if(delayVal!=0){if(groupId=='groupCritical'){_this.criticalCount--;}else{_this.urgentCount--;}
$divFault.remove();}else if(oldLevel!=level){var $newRows=undefined;if(groupId=='groupCritical'){$newRows=$('#groupUrgent .rows');_this.criticalCount--;_this.urgentCount++;}else{$newRows=$('#groupCritical .rows');_this.urgentCount--;_this.criticalCount++;}
$divFault.detach().prependTo($newRows);}
$('#btnAlertLog .badge').html(_this.urgentCount);$('#btnWarningLog .badge').html(_this.criticalCount);_this.dictFault[_this.faId].isUserDefined=true;_this.dictFault[_this.faId].userFaultGrade=level;_this.dictFault[_this.faId].userFaultDelay=time;_this.dictFault[_this.faId].grade=level;var highestGrade=level;var modelTextId=$divFault[0].dataset.modaltextid;if(delayVal!=0){highestGrade=0;}else{var faultIdList=[];for(var t in _this.dictEquipment){if(_this.dictEquipment[t].modalTextId==modelTextId){faultIdList=faultIdList.concat(_this.dictEquipment[t].faultIds.concat());}}
faultIdList.forEach(function(id){if(highestGrade>_this.dictFault[id].grade){highestGrade=_this.dictFault[id].grade;}});}
_this.obScreen.dictTexts[modelTextId].updateDiagnosisGrade(highestGrade);var $ele=$('#paneIcon').find('[data-modaltextid="'+modelTextId+'"]');_this.updatePaneNavWarning($ele[0],highestGrade);}}).error(function(result){}).always(function(e){$('#dlgChangeRule').modal('hide');$('#dlgChangeRule').one('hidden.bs.modal',function(){$this.text(text).prop('disabled',false);});});});},topFloors:function(){var $floorCt=$('#floorCt');var $divCanvas=$('#divCanvas');if(AppConfig.projectId==80){var $panelIconNew=$('#panelIconNew');}
var $stContainer=$('#st-container');var divCanvasWidth=parseInt($divCanvas[0].classList[0].split('-')[2]);var $paneIcon=$('#paneIcon');if($stContainer.find('#floorCt')[0]){$floorCt.insertBefore($('#st-container'));$floorCt.removeClass('st-effect-7').removeClass('st-menu').addClass('floorTop');$stContainer.removeClass('st-menu-open');$divCanvas[0].className='col-sm-'+(divCanvasWidth+2);if(AppConfig.projectId==80){$panelIconNew[0].className='col-sm-'+(divCanvasWidth+2);$panelIconNew.find('table').css('margin-left','20%');}
$divCanvas[0].style.positions='absolute';$paneIcon[0].style.height=($('#floorCt').height()-34)+'px';}else{$floorCt.insertBefore($divCanvas);$divCanvas[0].className='col-sm-'+(divCanvasWidth-2);if(AppConfig.projectId==80){$panelIconNew[0].className='col-sm-'+(divCanvasWidth-2);$panelIconNew.find('table').css('margin-left','10%');}
$floorCt.addClass('st-effect-7').addClass('st-menu').removeClass('floorTop');$stContainer.addClass('st-menu-open');$paneIcon.removeAttr('style');}
$(this).toggleClass('top notTop');_this.obScreen.resize();},initData:function(data){var item,arr;this.dictZone=new Object();this.dictEquipment=new Object();this.dictFault=new Object();this.buildings=[];arr=data.equipments;for(var i=0,len=arr.length;i<len;i++){item=arr[i];item.faultIds=new Array();this.dictEquipment[item.id]=item;}
arr=data.zones;this.floorCount=arr.length;var index=-1,tempBuildingId=undefined;for(var i=0,len=arr.length;i<len;i++){item=arr[i];item.equipmentIds=new Array();var equipments=[];for(var j=0;j<data.equipments.length;j++){if(data.equipments[j].zoneId==item.id){item.equipmentIds.push(data.equipments[j].id);equipments.push({equipmentId:data.equipments[j].id,equipmentName:data.equipments[j].name})}}
this.dictZone[item.id]=item;if(tempBuildingId!=item.buildingId){tempBuildingId=item.buildingId;index++;var building={buildId:item.buildingId,buildName:item.buildingName,subBuilds:[{subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}]}
this.buildings.push(building)}else{var subBuilding={subBuildId:item.subBuildingId,subBuildName:item.subBuildingName,equipments:equipments}
this.buildings[index].subBuilds.push(subBuilding);}}
var zoneOffset=-(new Date()).getTimezoneOffset()/60;if(zoneOffset>0){zoneOffset='+'+zoneOffset;}
zoneOffset+='00';arr=data.faults;for(var i=0,elapse,len=arr.length;i<len;i++){item=arr[i];item.display=true;item.grade=undefined;item.userFaultDelay+=zoneOffset;if(item.isUserDefined&&item.userFaultDelay){if(item.userFaultDelay==-1){item.display=false;}
else if(item.userFaultDelay>0){elapse=new Date()-(item.userModifyTime).toDate();if(elapse<0)item.display=false;}}
if(item.isUserDefined){item.grade=item.userFaultGrade;}
else{item.grade=item.defaultGrade;}
this.dictFault[item.id]=item;}
this.arrLastNotice=data.notices;},initWorkerForUpdating:function(){this.workerUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.workerUpdate.self=this;this.workerUpdate.addEventListener("message",this.refreshData,true);this.workerUpdate.addEventListener("error",function(e){console.log(e)},true);this.workerUpdate.postMessage({projectId:AppConfig.projectId,type:"diagnosisScreen"});},tableModelDataUpdating:function(){this.tableModelUpdate=new Worker("/static/views/js/worker/workerUpdate.js");this.tableModelUpdate.self=this;this.tableModelUpdate.addEventListener("message",this.refreshTableModelData,true);this.tableModelUpdate.addEventListener("error",function(e){console.log(e);Spinner.stop();},true);this.tableModelUpdate.postMessage({pointList:this.tabelModelData,projectId:AppConfig.projectId,type:"dataRealtime"});},initObScreen:function(){this.obScreen.isInDiagnosis=true;this.obScreen.diagScreen=this;},resetFloor:function(){this.refreshData({data:this.arrLastNotice});},clearNullArr:function(arr){for(var i=0,len=arr.length;i<len;i++)
{if(arr[i]==""||typeof(arr[i])=="undefined")
{arr.splice(i,1);len--;i--;}}
return arr;},gradientColors:function(colorArr,$gradientDom,valueCurrent,max,min){var valueMark=(max-min)/(colorArr.length-1);var regexp=/[0-9]{0,3}/g;for(var i=0;i<colorArr.length-1;i++){var colorMaxValue=min+(i+1)*valueMark;if(valueCurrent>colorMaxValue)continue;var colorSelPre=colorArr[i];var colorSelTo=colorArr[i+1];var colorValPreArr=[];colorValPreArr=colorSelPre.match(regexp);_this.clearNullArr(colorValPreArr);var colorValToArr=[];colorValToArr=colorSelTo.match(regexp);_this.clearNullArr(colorValToArr);var colorMinValue=min+i*valueMark;if(i==colorArr.length-2){colorMaxValue=max;}
if(valueCurrent<=colorMaxValue){$gradientDom.css('background','rgb('+(parseInt((parseInt(colorValToArr[0]-colorValPreArr[0])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[0]))+','+(parseInt((parseInt(colorValToArr[1]-colorValPreArr[1])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[1]))+','+(parseInt((parseInt(colorValToArr[2]-colorValPreArr[2])*(valueCurrent-colorMinValue)/(colorMaxValue-colorMinValue)).toFixed(0))+parseInt(colorValPreArr[2]))+')');i=colorArr.length-1;}}},refreshTableModelData:function(e){var dataNumber=e.data;for(var beforeN in dataNumber){if((dataNumber[beforeN].name).split('_')[1]=='InFiAvT'){var beforeNumber=(dataNumber[beforeN].name).split('_')[0];var beforeValue=Math.random()*10+20;var valueCurrent;for(var resultN in dataNumber){resultName=dataNumber[resultN].name;if(resultName.split('_')[1]=='OutFiAvT'&&resultName.split('_')[0].split('FZ')[0]==beforeNumber.split('FZ')[0]&&resultName.split('_')[0].split('FZ')[1]==beforeNumber.split('FZ')[1]){dataNumber[resultN].value=Math.random()*10+20;$('.rc'+beforeNumber.split('FZ')[0]+'_'+beforeNumber.split('FZ')[1]).html(((beforeValue+dataNumber[resultN].value)/2).toFixed(0));valueCurrent=((dataNumber[resultN].value)+beforeValue)/2;_this.gradientColors(['rgb(61,100,255)','rgb(70,215,31)','rgb(255,190,0)'],$('.rc'+beforeNumber.split('FZ')[0]+'_'+beforeNumber.split('FZ')[1]),valueCurrent,30,20);}}}}
Spinner.stop();},refreshData:function(e){_this=this.self?this.self:this;if(e.data&&!e.data.error&&e.data[0]){var existedIds=[];for(var i in _this.arrLastNotice){existedIds.push(_this.arrLastNotice[i].id);}
if($.inArray(e.data[0].id,existedIds)<0){Array.prototype.push.apply(e.data,_this.arrLastNotice);_this.arrLastNotice=e.data;}
for(var key in _this.dictEquipment){_this.dictEquipment[key].faultIds=new Array();}
var dictFaultHighestGrade={};for(var i=0;i<e.data.length;i++){var faultId=e.data[i].faultId,equipmentId=_this.dictFault[faultId].equipmentId;var grade;_this.dictEquipment[equipmentId].faultIds.push(faultId);grade=dictFaultHighestGrade[equipmentId];if(!grade||_this.dictFault[faultId].grade>grade)
dictFaultHighestGrade[equipmentId]=_this.dictFault[faultId].grade;}
for(var key in dictFaultHighestGrade){if(_this.dictObserverText[key])
_this.dictObserverText[key].updateDiagnosisGrade(dictFaultHighestGrade[key]);}
if(this.self)_this.renderPaneNoticeGroup();Spinner.stop();}else{}},initPaneBuilding:function(){var count=15;var body=document.getElementById('divCanvas');var divMain=document.createElement('div');divMain.className='box';divMain.style.position='relative';var div,divContainer,divElement,span,item,sb;var unitTop=body.scrollHeight*0.5/this.floorCount;var top=body.scrollHeight*0.1;var unitDeg=60/this.floorCount;var arrZone=new Array();for(var zoneId in this.dictZone){arrZone.push(this.dictZone[zoneId]);}
for(var i=0,len=arrZone.length;i<len;i++){index=this.floorCount-1-i;item=arrZone[i];div=document.createElement('div');div.id='div-floor-'+item.id.toString();div.className='floor';if(arrZone.length==1)div.className+=' hover';div.style.top=(unitTop*index+top)+"px";div.style.transform='rotateX('+(120-unitDeg*index)+'deg) rotateZ(60deg)';div.style.backgroundImage="url('/static/images/diagnosis/"+AppConfig.projectName+"/"+item.image+"')";span=document.createElement('span');span.className='span-floor-number';divContainer=document.createElement('div');divContainer.className='floor-equipment-pane';for(var j=0;j<item.equipmentIds.length;j++){var equipmentId=item.equipmentIds[j];var equipment=this.dictEquipment[equipmentId];divElement=document.createElement('div');divElement.className='floor-equipment';divElement.id='div-floor-icon-'+item.id+'-'+equipmentId;divElement.textContent=equipment.name;divContainer.appendChild(divElement);}
div.appendChild(divContainer);divMain.appendChild(div);}
body.appendChild(divMain);arrZone=null;},initPaneNav:function(){var _this=this;var pane=document.createElement('div');var spanFloor,spanIcon,div,item;for(var zoneId in this.dictZone){item=this.dictZone[zoneId];if(item.equipmentIds&&item.equipmentIds.length==0)continue;div=document.createElement('div');div.id='div-icon-'+zoneId;div.className='div-nav-row';spanFloor=document.createElement('span');spanFloor.id='navFloor-'+zoneId;spanFloor.setAttribute('pageId',item.pageId)
spanFloor.className='badge div-row-icon-badge grow';spanFloor.textContent=item.subBuildingName;spanFloor.onclick=function(e){if(AppConfig.projectId==80){$('#panelIconNew').hide();}
var id=e.target.getAttribute('pageId');if(id){if(_this.obScreen===undefined){_this.obScreen=new ObserverScreen(id);_this.initObScreen();_this.obScreen.show(_this.$obContainer[0]);}else if(_this.obScreen.id===id){return;}else{_this.obScreen.close();_this.obScreen=new ObserverScreen(id);_this.initObScreen();_this.obScreen.show(_this.$obContainer[0]);}
$(ElScreenContainer).off('click').on('click','#btnFloorsSP',_this.topFloors);$('#btnFloorsSP').removeClass('btn').removeClass('disabled');}
else{alert('This floor has no details');}};div.appendChild(spanFloor);if(item.equipmentIds.length==0){div.innerHTML+="none";}else{for(var j=0,len=item.equipmentIds.length;j<len;j++){var equipmentId=item.equipmentIds[j];spanIcon=document.createElement('span');spanIcon.id='spanNav-icon-'+zoneId+'-'+equipmentId;spanIcon.title=this.dictEquipment[equipmentId].name;spanIcon.onclick=function(e){_this.showEquipmentDetail(e.currentTarget.id.split('-')[3]);};spanIcon.onmouseenter=function(e){var $this=$(e.currentTarget);var modalTextId=$this.attr('data-modaltextid');var pageId=$this.siblings('[pageid]').attr('pageid');if(modalTextId===undefined||_this.obScreen===undefined)return;if(_this.obScreen.id!==pageId)return;_this.obScreen.showErrTip(modalTextId);};spanIcon.onmouseleave=function(e){var $this=$(e.currentTarget);var modalTextId=$(e.currentTarget).attr('data-modaltextid');var pageId=$this.closest('div').children('span:first').attr('pageid');if(modalTextId===undefined||_this.obScreen===undefined)return;if(_this.obScreen.id!==pageId)return;_this.obScreen.hideErrTip(modalTextId);};spanIcon=this.updatePaneNavWarning(spanIcon,null);div.appendChild(spanIcon);}}
pane.appendChild(div);}
var paneIcon=document.getElementById('paneIcon');paneIcon.innerHTML="";paneIcon.appendChild(pane);paneIcon.style.height=($('#floorCt').height()-34)+'px';if(_this.judgeProjectId){$('#showSurveyChart').show().off('click').click(function(){var $spanIconTotal;if($(this).hasClass('glyphicon-eye-open')){for(var i=0;i<$('.div-nav-row').length;i++){$($('.div-nav-row')[i]).addClass('div-nav-row-hide');$spanIconTotal=$($('.div-nav-row')[i]).find('span:not(:first)');if($spanIconTotal){$spanIconTotal.css('display','none');}}
$(this).removeClass('glyphicon-eye-open').addClass('glyphicon glyphicon-eye-close');$('#floorCt').find('.panel-default').addClass('panelViewHide');}else if($(this).hasClass('glyphicon-eye-close')){for(var i=0;i<$('.div-nav-row').length;i++){$($('.div-nav-row')[i]).removeClass('div-nav-row-hide');$spanIconTotal=$($('.div-nav-row')[i]).find('span:not(:first)');if($spanIconTotal){$spanIconTotal.css('display','inline-block');}}
$(this).removeClass('glyphicon-eye-close').addClass('glyphicon glyphicon-eye-open');$('#floorCt').find('.panel-default').removeClass('panelViewHide');}});}},changeModal:function(){var _this=this;var $spanRow,$spanCeil,item,$spanRowOne;var $tabelModelPanel=$('#panelIconNew');var inFiAvTDt,outFiAvTDt;var requestData=[];$tabelModelPanel=$('<div id="panelIconNew" class="col-sm-12"><table></table></div>');var $tabelHead=$('<tr class="tabelHead"></tr>')
for(var k=19;k>0;k--){$spanRowOne=$('<td></td>');if(k==19){$spanRowOne.html('');}else{$spanRowOne.html(k);}
$tabelHead.append($spanRowOne);}
$tabelModelPanel.find('table').append($tabelHead);for(var i=44;i>0;i--){$spanRow=$('<tr></tr>');if(i<10){i='0'+i;}
for(var j=19;j>0;j--){$spanCeil=$('<td></td>');if(j==19){$spanCeil.html(i+'F');$spanCeil.addClass('tdFirst');if(i==44){$spanCeil.attr('pageId','1');}else if(i==43){$spanCeil.attr('pageId','2');}else if(i==42){$spanCeil.attr('pageId','120000221');}else if(i==41){$spanCeil.attr('pageId','100000173');}}
else{if(j<10){j='0'+j;}
inFiAvTDt=i+'FZ'+j+'_InFiAvT';outFiAvTDt=i+'FZ'+j+'_OutFiAvT';requestData.push(inFiAvTDt);requestData.push(outFiAvTDt);$spanCeil.addClass('rc'+i+'_'+j);$spanCeil.addClass('tdData');}
$spanRow.append($spanCeil);}
$tabelModelPanel.find('table').append($spanRow);}
this.tabelModelData=requestData;$tabelModelPanel.insertBefore($('#divCanvas'));},createWorkflowOrder:function(notice,fault){var momentTime=notice.time.toDate();ScreenManager.show(WorkflowInsert,{noticeId:notice.id,title:fault.name,detail:fault.description,dueDate:new Date(+new Date()+172800000).format('yyyy-MM-dd'),critical:fault.grade,projectId:AppConfig.projectId,chartPointList:fault.points,chartQueryCircle:'m5',chartStartTime:new Date(momentTime-43200000).format('yyyy-MM-dd HH:mm:ss'),chartEndTime:new Date(momentTime+43200000).format('yyyy-MM-dd HH:mm:ss'),userId:AppConfig.userId});},renderPaneBuilding:function(notice,fault,equipment,zone){var element=document.getElementById('div-floor-'+equipment.zoneId);if(!element)return;var divIcon=$('#div-floor-icon-'+zone.id+'-'+equipment.id);var color;switch(fault.grade){case 0:color='window';break;case 1:color='rgb(238, 170, 100)';break;case 2:color='rgb(200, 100, 100)';break;default:break;}
if(color){element.style.backgroundColor=color;divIcon.css('background-color',color);}
var sb=new StringBuilder();sb.append('<div class="tooltip" role="tooltip">');sb.append('    <div class="tooltipTitle tooltip-inner">Equipment</div>');sb.append('    <div class="tooltipContent">');sb.append('        <p style="white-space:nowrap;">Name: <span style="font-weight: bold;">').append(equipment.name).append('</span></p> ');sb.append('        <p style="white-space:nowrap;">System: <span style="font-weight: bold;">').append(equipment.systemName).append('</span></p> ');sb.append('        <p style="white-space:nowrap;">Subsystem: <span style="font-weight: bold;">').append(equipment.subSystemName).append('</span></p> ');sb.append('        <p style="white-space:nowrap;">Faults:</p> ');for(var i=0;i<equipment.faultIds.length;i++){sb.append('<p style="margin-left: 20px; white-space:nowrap;"><span style="font-weight: bold;">').append(this.dictFault[equipment.faultIds[i]].name);for(var j=0;j<this.arrLastNotice.length;j++){var noticeTemp=this.arrLastNotice[j];if(noticeTemp.faultId==equipment.faultIds[i]){if(noticeTemp.status&&noticeTemp.status!=''&&noticeTemp.status!=0){sb.append(' (').append(noticeTemp.status).append(')');}}}
sb.append('</span></p> ');}
sb.append('    </div>');sb.append('    <div class="tooltip-arrow"></div>');sb.append('</div>');var options={title:'Equipment',template:sb.toString()};divIcon.tooltip(options);},renderPaneNav:function(notice,fault,equipment){var element=document.getElementById('spanNav-icon-'+equipment.zoneId+'-'+equipment.id);this.updatePaneNavWarning(element,fault.grade);$(element).attr('data-modaltextid',equipment.modalTextId);},updatePaneNavWarning:function(element,level){var spanIcon=element;var strClass;if(level==0){strClass="glyphicon glyphicon-ok-sign"
spanIcon.style.color='#009999';spanIcon.style.opacity=0.7;}
else if(level==1){strClass="glyphicon glyphicon-info-sign"
spanIcon.style.color='#EEAA00';}
else if(level==2){strClass="glyphicon glyphicon-remove-sign animation-warning"
spanIcon.style.color='#CC3333';}
else{strClass="glyphicon glyphicon-minus-sign";spanIcon.style.color='#009999';spanIcon.style.opacity=0.7;}
spanIcon.className=strClass+' div-row-icon grow';return spanIcon;},showEquipmentDetail:function(equipmentId){this.dialog=new ObserverScreen(this.dictEquipment[equipmentId].pageId);this.dialog.isDetailPage=true;this.dialog.show();},showZoneDetail:function(zoneId){},renderPaneNoticeGroup:function(){var _this=this;var urgentCount=0,criticalCount=0;$('#divPaneNotice .panel-body').remove();var divBody=$('<div class="panel-body gray-scrollbar" style="height:calc(100% - 41px);overflow-y:auto;display:none;"></div>');$('#divPaneNotice').append(divBody);var gCritical=_this.insertLogGroup('groupCritical',_this.langCfg.LEVEL_SET.CRITICAL,'rgba(240, 173, 78, 0.7)');var gUrgent=_this.insertLogGroup('groupUrgent',_this.langCfg.LEVEL_SET.URGENT,'rgba(217, 83, 79, 0.7)');var item,parent;for(var i=0,len=_this.arrLastNotice.length;i<len;i++){item=_this.arrLastNotice[i];var grade=_this.dictFault[item.faultId].grade;if(1==grade){parent=gCritical.find('.rows');criticalCount++;}
else if(2==grade){parent=gUrgent.find('.rows');urgentCount++;}
else{continue;}
_this.insertLogItem(parent,item,i);}
_this.urgentCount+=urgentCount;_this.criticalCount+=criticalCount;if(_this.criticalCount>0){$('#btnWarningLog').find('.badge').html(_this.criticalCount);}
if(_this.urgentCount>0){$('#btnAlertLog').find('.badge').html(_this.urgentCount);}},insertLogGroup:function(groupId,groupName,bkgColor){var group=$('<ul class="nav nav-list tree-group" id="'+groupId+'" draggable="true">');var head=$('<li><span class="badge" style="background-color:#5bc0de;width:100%;height:22px;">'+groupName+'</span></li>');head.find('span').css('background-color',bkgColor);head.click(function(e){$(e.currentTarget).next('.rows').slideToggle();});group.append(head);var rowTitle=$('<li class="rows" style="display:none;"></li>');group.append(rowTitle);$('#divPaneNotice .panel-body').append(group);return group;},insertLogItem:function(divParent,item,itemNum){var _this=this;var divNotice,fault,equipment,zone,sb,span,textId;fault=this.dictFault[item.faultId];if(!fault.display){return;};equipment=this.dictEquipment[fault.equipmentId];textId=equipment.modalTextId;zone=this.dictZone[equipment.zoneId];divNotice=document.createElement('div');divNotice.id='divLog-'+itemNum;divNotice.setAttribute('path',zone.id+'-'+equipment.id);divNotice.setAttribute('faultid',item.faultId);if(textId!==null)divNotice.setAttribute('data-modaltextid',textId);divNotice.className='div-pane-log';divNotice.onmouseenter=function(e){var $this=$(e.currentTarget);var modalTextId=$this.attr('data-modaltextid');var pageId=$this.children('[pageid]').attr('pageid');if(modalTextId===undefined||_this.obScreen===undefined)return;if(_this.obScreen.id!==pageId)return;_this.obScreen.showErrTip(modalTextId);};divNotice.onmouseleave=function(e){var $this=$(e.currentTarget);var modalTextId=$this.attr('data-modaltextid');var pageId=$this.children('[pageid]').attr('pageid');if(modalTextId===undefined||_this.obScreen===undefined)return;if(_this.obScreen.id!==pageId)return;_this.obScreen.hideErrTip(modalTextId);};var parent=$(divNotice);var $spWrap=$('<div style="white-space: nowrap;">');sb=new StringBuilder();sb.append(fault.name);if(item.status&&item.status!=''&&item.status!=0){sb.append(' (').append(item.status).append(')');}
span=$('<span>').addClass('badge grow span-hover-pointer').attr('title','Equipment name').attr('equipment',equipment.pageId).text(equipment.name);span.click(function(e){this.dialog=new ObserverScreen(e.currentTarget.getAttribute('equipment'));this.dialog.isDetailPage=true;this.dialog.show();});$spWrap.append(span);$('<span>').addClass('badge grow span-hover-pointer').attr({'pageId':zone.pageId,'title':'Zone ID','data-zoneId':zone.id}).text(zone.subBuildingName).click(function(e){var pageId=e.currentTarget.getAttribute('pageId');var zoneId=e.currentTarget.getAttribute('data-zoneId');if(pageId&&pageId!=''&&pageId!=0){$('#navFloor-'+zoneId).click();}
else{alert('This floor has no details');}}).appendTo($spWrap);$('<span>').attr({'title':'Triggering time','data-time':item.time}).text(item.time.toDate().format("MM-dd HH:mm")).css('text-decoration','underline').css('font-weight','bold').appendTo($spWrap);$('<span>').addClass('glyphicon glyphicon-ok-sign grow span-hover-pointer span-btn').attr('title','Check').click(function(e){var faultId=$(e.currentTarget).closest('.div-pane-log').attr('faultid');var item=_this.dictFault[faultId];if(undefined!=item){_this.faId=item.id;_this.faUserId=item.userId;var level;if(item.isUserDefined){level=item.userFaultGrade;}
else{level=item.defaultGrade;}
var selectLevel=$('#selectAlarmLevel');if(0==level){selectLevel.val(_this.langCfg.LEVEL_SET.NORMAL);}
else if(1==level){selectLevel.val(_this.langCfg.LEVEL_SET.CRITICAL);}
else if(2==level){selectLevel.val(_this.langCfg.LEVEL_SET.URGENT);}
else{selectLevel.val(_this.langCfg.LEVEL_SET.NORMAL);}
var selectTm=$('#selectAlarmTime');var userFaDelay=item.userFaultDelay;if(undefined!=userFaDelay&&null!=userFaDelay){var timeDelay=userFaDelay.toDate();var timeNow=new Date();var interval=timeDelay.getTime()-timeNow.getTime();if(interval<0){selectTm.val(_this.langCfg.defaultPeriod.REAL_TIME);}
else if(interval<=3600000){selectTm.val(_this.langCfg.defaultPeriod.DELAY_1H);}
else if(interval<=43200000){selectTm.val(_this.langCfg.defaultPeriod.DELAY_12H);}
else if(interval<=86400000){selectTm.val(_this.langCfg.defaultPeriod.DELAY_24H);}
else if(interval<=604800000){selectTm.val(_this.langCfg.defaultPeriod.DELAY_7D);}
else if(interval<=18144000000){selectTm.val(_this.langCfg.defaultPeriod.DELAY_1M);}
else{selectTm.val(_this.langCfg.defaultPeriod.DELAY_FOREVER);}}
else{selectTm.val(_this.langCfg.defaultPeriod.DELAY_FOREVER);}}
$('#dlgChangeRule').modal('show');}).appendTo($spWrap);if(item.orderId&&item.orderId!=0&&item.orderId!=''){$('<span>').addClass('glyphicon glyphicon-tags grow span-hover-pointer span-btn').attr('title','Show workflow order').attr('workflow',item.orderId).click(function(e){if(ScreenCurrent)ScreenCurrent.close();ScreenCurrent=new workflowNoticeDetail(e.currentTarget.getAttribute('workflow'),null,null);ScreenCurrent.show();}).appendTo($spWrap);}else{$('<span>').addClass('glyphicon glyphicon-share grow span-hover-pointer span-btn').attr('title','Create workflow order').click(function(e){_this.createWorkflowOrder(item,fault);}).appendTo($spWrap);}
parent.append($spWrap);$('<p>').addClass('pFaultName').css({'font-weight':'bold','padding':'0 8px 0 0'}).text(fault.name).appendTo(parent);var strDesc=fault.description;var arr=item.detail.toString().split(',');for(var j=0;j<arr.length;j++){strDesc=strDesc.replace('{'+j.toString()+'}','<span class="variable">'+arr[j]+'</span>');}
$('<p>').text(strDesc).appendTo(parent);divParent.append(parent);_this.renderPaneBuilding(item,fault,equipment,zone);_this.renderPaneNav(item,fault,equipment);}}
return DiagnosisScreen;})();var DiagnosisHistory=(function(){var _this=undefined;function DiagnosisHistory(parent){_this=this;this.parent=parent;this.m_tableInfo=[];this.m_bSortTimeAscend=false;this.m_bSortGradeAscend=false;this.m_bSortEquipAscend=false;this.m_bSortZoneAscend=false;this.m_bSortFaultAscend=false;this.m_bSortStatusAscend=false;};DiagnosisHistory.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/observer/diagnosis/paneHistory.html").done(function(resultHtml){var dialog=$('#dialogModal');dialog.find('#dialogContent').html(resultHtml);$('#dialogContent .modal-content').css('height',document.body.scrollHeight-100);dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){_this.close();ScreenModal=null;Spinner.stop();}).modal({});Spinner.spin(dialog.find('.modal-body')[0]);_this.init();$("#datePickerLog").datetimepicker({minView:"month",autoclose:true,todayBtn:true,initialDate:new Date()});$("#txtLogDate").val(new Date().toLocaleDateString().replace('/','-').replace('/','-'));$('#thTime').click(function(e){_this.sortTable(0);});$('#thGrade').click(function(e){_this.sortTable(1);});$('#thEquip').click(function(e){_this.sortTable(2);});$('#thZone').click(function(e){_this.sortTable(3);});$('#thFault').click(function(e){_this.sortTable(4);});$('#thStatus').click(function(e){_this.sortTable(5);});$('#btnSearchFault').click(function(e){_this.searchFaultInfo();});$('#inputSearchFault').keyup(function(e){if(13===e.keyCode){_this.searchFaultInfo();}});});},close:function(){},init:function(){var _this=this;var now=new Date();var startTime=new Date(now.getFullYear(),now.getMonth(),now.getDate());this.refreshData(startTime,now);$("#txtLogDate").change(function(e){var startTime=($("#txtLogDate").val()+' 00:00:00').toDate();var endTime=new Date(+startTime+86400000);_this.refreshData(startTime,endTime);});$("#btnLogPre").off('click').click(function(e){var endTime=($("#txtLogDate").val()+' 00:00:00').toDate();var preDay=new Date(+endTime-86400000);$("#txtLogDate").val(preDay.toLocaleDateString().replace('/','-').replace('/','-'));_this.refreshData(preDay,endTime);});$("#btnLogNext").off('click').click(function(e){var startTime=new Date($("#txtLogDate").val()+' 00:00:00');startTime=new Date(+startTime+86400000);var nextDay=new Date(+startTime+86400000);$("#txtLogDate").val(nextDay.toLocaleDateString().replace('/','-').replace('/','-'));_this.refreshData(startTime,nextDay);});},refreshData:function(startTime,endTime){var _this=this;startTime=startTime.format("yyyy-MM-dd HH:mm:ss");endTime=endTime.format("yyyy-MM-dd HH:mm:ss");Spinner.spin(document.getElementById('tableNoticeHistory'));WebAPI.get('/diagnosis/notice/get/'+AppConfig.projectId+'/'+startTime+'/'+endTime).done(function(result){_this.m_tableInfo=JSON.parse(result);_this.initTable(_this.m_tableInfo);}).error(function(result){dialog.find('#dialogContent').html('Error query.');}).always(function(){Spinner.stop();});},initTable:function(data){$('#tableNoticeHistory tbody').remove();var tbody=document.createElement('tbody');if(data.length==0)tbody.innerHTML='no history data';var tr,td,item,sb,fault,equipment,zone;for(var i=0,len=data.length;i<len;i++){item=data[i];fault=this.parent.dictFault[item.faultId];equipment=this.parent.dictEquipment[fault.equipmentId];zone=this.parent.dictZone[equipment.zoneId];tr=document.createElement('tr');tr.id='diagHistory_'+item.id;sb=new StringBuilder();sb.append('<td>').append(item.time.toDate().format("yyyy-MM-dd HH:mm:ss")).append('</td>');switch(this.parent.dictFault[item.faultId].grade){case 0:sb.append('<td><span class="badge" style="background-color: #5bc0de;" title="Grade">Normal</span></td>');break;case 1:sb.append('<td><span class="badge" style="background-color: #f0ad4e;" title="Grade">Alert</span></td>');break;case 2:sb.append('<td><span class="badge" style="background-color: #d9534f;" title="Grade">Fault</span></td>');break;default:sb.append('<td><span class="badge" style="background-color: #d9534f;" title="Grade">Unknown</span></td>');break;}
sb.append('<td>').append(equipment.name).append('</td>');sb.append('<td>').append(zone.subBuildingName).append('</td>');sb.append('<td>').append(fault.name).append('</td>');switch(item.status){case 0:sb.append('<td>Disable</td>');break;case 1:sb.append('<td>Delayed</td>');break;case 2:sb.append('<td>Realtime</td>');break;default:break;}
var strDesc=fault.description;var arr=item.detail.toString().split(',');for(var j=0;j<arr.length;j++){strDesc=strDesc.replace('{'+j.toString()+'}','<span class="variable">'+arr[j]+'</span>');}
tr.title=strDesc;tr.innerHTML=sb.toString();tbody.appendChild(tr);}
$('#tableNoticeHistory').append(tbody);},sortTable:function(type){$('#tableNoticeHistory tbody').html('');if(0===type){if(!_this.m_bSortTimeAscend){_this.m_tableInfo.sort(_this.sortTimeAscending);}
else{_this.m_tableInfo.sort(_this.sortTimeDescending);}
_this.m_bSortTimeAscend=!_this.m_bSortTimeAscend;}
else if(1===type){if(!_this.m_bSortGradeAscend){_this.m_tableInfo.sort(_this.sortGradeAscending);}
else{_this.m_tableInfo.sort(_this.sortGradeDescending);}
_this.m_bSortGradeAscend=!_this.m_bSortGradeAscend;}
else if(2===type){if(!_this.m_bSortEquipAscend){_this.m_tableInfo.sort(_this.sortEquipAscending);}
else{_this.m_tableInfo.sort(_this.sortEquipDescending);}
_this.m_bSortEquipAscend=!_this.m_bSortEquipAscend;}
else if(3===type){if(!_this.m_bSortZoneAscend){_this.m_tableInfo.sort(_this.sortZoneAscending);}
else{_this.m_tableInfo.sort(_this.sortZoneDescending);}
_this.m_bSortZoneAscend=!_this.m_bSortZoneAscend;}
else if(4===type){if(!_this.m_bSortFaultAscend){_this.m_tableInfo.sort(_this.sortFaultAscending);}
else{_this.m_tableInfo.sort(_this.sortFaultDescending);}
_this.m_bSortFaultAscend=!_this.m_bSortFaultAscend;}
else if(5===type){if(!_this.m_bSortStatusAscend){_this.m_tableInfo.sort(_this.sortStatusAscending);}
else{_this.m_tableInfo.sort(_this.sortStatusDescending);}
_this.m_bSortStatusAscend=!_this.m_bSortStatusAscend;}
_this.initTable(_this.m_tableInfo);},sortTimeAscending:function(a,b){return a.time-b.time;},sortTimeDescending:function(a,b){return b.time-a.time;},sortGradeAscending:function(a,b){return a.grade-b.grade;},sortGradeDescending:function(a,b){return b.grade-a.grade;},sortEquipAscending:function(a,b){var fault=_this.parent.dictFault[a.faultId];var equipA=_this.parent.dictEquipment[fault.equipmentId];fault=_this.parent.dictFault[b.faultId];var equipB=_this.parent.dictEquipment[fault.equipmentId];return(equipA.name).localeCompare(equipB.name);},sortEquipDescending:function(a,b){var fault=_this.parent.dictFault[a.faultId];var equipA=_this.parent.dictEquipment[fault.equipmentId];fault=_this.parent.dictFault[b.faultId];var equipB=_this.parent.dictEquipment[fault.equipmentId];return(equipB.name).localeCompare(equipA.name);},sortZoneAscending:function(a,b){var fault=_this.parent.dictFault[a.faultId];var equip=_this.parent.dictEquipment[fault.equipmentId];var zoneA=_this.parent.dictZone[equip.zoneId];fault=_this.parent.dictFault[b.faultId];equip=_this.parent.dictEquipment[fault.equipmentId];var zoneB=_this.parent.dictZone[equip.zoneId];return(zoneA.subBuildingName).localeCompare(zoneB.subBuildingName);},sortZoneDescending:function(a,b){var fault=_this.parent.dictFault[a.faultId];var equip=_this.parent.dictEquipment[fault.equipmentId];var zoneA=_this.parent.dictZone[equip.zoneId];fault=_this.parent.dictFault[b.faultId];equip=_this.parent.dictEquipment[fault.equipmentId];var zoneB=_this.parent.dictZone[equip.zoneId];return(zoneB.subBuildingName).localeCompare(zoneA.subBuildingName);},sortFaultAscending:function(a,b){var faultA=_this.parent.dictFault[a.faultId];var faultB=_this.parent.dictFault[b.faultId];return(faultA.name).localeCompare(faultB.name);},sortFaultDescending:function(a,b){var faultA=_this.parent.dictFault[a.faultId];var faultB=_this.parent.dictFault[b.faultId];return(faultB.name).localeCompare(faultA.name);},sortStatusAscending:function(a,b){return a.status-b.status;},sortStatusDescending:function(a,b){return b.status-a.status;},searchFaultInfo:function(){var searchVal=$('#inputSearchFault').val();if(null==searchVal||undefined==searchVal){return;}
$('#tableNoticeHistory tbody').html('');if(''==searchVal){_this.initTable(_this.m_tableInfo);return;}
var faultName,item;var arrSuit=[];searchVal=searchVal.toLowerCase();for(var i=0,len=_this.m_tableInfo.length;i<len;i++){item=_this.m_tableInfo[i];faultName=(_this.parent.dictFault[item.faultId]).name;faultName=faultName.toLowerCase();if(-1!=faultName.indexOf(searchVal)){arrSuit.push(item);}}
_this.initTable(arrSuit);}}
return DiagnosisHistory;})();var DataCenter3D=(function(){function Room(domElement,dataSource){this.scene=null;this.camera=null;this.renderer=null;this.controls=null;this.domElement=domElement;this.dataSource=dataSource;this.data=null;this.projector=new THREE.Projector();this.raycaster=new THREE.Raycaster();this.mouse=new THREE.Vector2();this.stats=null;this.INTERSECTED=null;this.cameraHelper=null;}
Room.prototype={initScene:function(){this.scene=new THREE.Scene();this.scene.rotation.x=Math.PI/2;},initCamera:function(){this.camera=new THREE.PerspectiveCamera(35,window.innerWidth/window.innerHeight,1,200000);this.resetView();this.camera.up=new THREE.Vector3(0,0,1);this.scene.add(this.camera);},initRender:function(){this.renderer=new THREE.WebGLRenderer({antialias:true});this.renderer.setSize(window.innerWidth,window.innerHeight);this.renderer.setClearColor(0xf0f0f0,1);this.renderer.gammaInput=true;this.renderer.gammaOutput=true;this.renderer.shadowMapEnabled=true;this.domElement.appendChild(this.renderer.domElement)},initControl:function(){this.controls=new THREE.TrackballControls(this.camera);this.controls.staticMoving=true;this.controls.addEventListener('change',this.render.bind(this));},initLight:function(){var light_ambient=new THREE.AmbientLight(0x000000);this.scene.add(light_ambient);var hemiLight=new THREE.HemisphereLight(0xffffff,0xffffff,0.6);hemiLight.color.setHSL(0.6,1,0.6);hemiLight.groundColor.setHSL(0.095,1,0.75);hemiLight.position.set(0,0,500);this.scene.add(hemiLight);var light=new THREE.DirectionalLight(0xffffff,2.25);light.position.set(0,450,500);light.castShadow=true;light.shadowMapWidth=1024;light.shadowMapHeight=1024;this.scene.add(light);},initStats:function(){this.stats=new Stats();this.stats.domElement.style.position='absolute';this.stats.domElement.style.bottom='0px';this.stats.domElement.style.zIndex=100;this.domElement.appendChild(this.stats.domElement);},initObjects:function(){if(!this.data){return;}
var units=this.data.units,unitItem;for(var n=0,length=units.length;n<length;n++){unitItem=units[n];var unitObj=this.executeUnitType(unitItem.type,unitItem,this);unitObj.castShadow=true;unitObj.receiveShadow=true;this.scene.add(unitObj);}
var gt=THREE.ImageUtils.loadTexture("/static/scripts/dataCenter3D/floor.jpg");var gg=new THREE.PlaneGeometry(this.data.width,this.data.height);var gm=new THREE.MeshBasicMaterial({color:0xffffff,map:gt});var ground=new THREE.Mesh(gg,gm);ground.position.z=-300;ground.material.map.repeat.set(18,18);ground.material.map.wrapS=ground.material.map.wrapT=THREE.RepeatWrapping;ground.receiveShadow=true;this.scene.add(ground);},loadData:function(){var _this=this;return WebAPI.getJSON(this.dataSource).done(function(data){_this.data=data;});},executeUnitType:function(unitType,arg,scene){var namespaces=unitType.split(".");var func=namespaces.pop();var context=window;for(var i=0;i<namespaces.length;i++){context=context[namespaces[i]];}
return new context[func](arg,scene);},attachEvent:function(){window.addEventListener('mousemove',this.onMouseMove.bind(this),false);document.addEventListener('mousedown',this.onMouseDown.bind(this),false);},cleanScene:function(){var elementsInTheScene=this.scene.children.length;for(var i=elementsInTheScene-1;i>0;i--){if(this.scene.children[i].name!='camera'&&this.scene.children[i].name!='ambientLight'&&this.scene.children[i].name!='directionalLight'){this.scene.remove(this.scene.children[i]);}}},resetView:function(){this.camera.position.x=6925.764174941334;this.camera.position.y=12.494895273811855;this.camera.position.z=4320.172377978487;if(this.controls){this.controls.reset();}},findMouseIntersection:function(type){if(!type){return[];}
var vector=new THREE.Vector3(this.mouse.x,this.mouse.y,1);this.projector.unprojectVector(vector,this.camera);this.raycaster.set(this.camera.position,vector.sub(this.camera.position).normalize());var machines=this.scene.children.filter(function(item){return item instanceof type;});var machinesChildren=[];for(var m=0;m<machines.length;m++){machinesChildren=machinesChildren.concat(machines[m].children);}
var intersects=this.raycaster.intersectObjects(machinesChildren);return intersects.map(function(item){return item.object.parent})[0];},enableCameraHelper:function(){this.cameraHelper.update();this.cameraHelper.visible=true;},disableCameraHelper:function(){this.cameraHelper.visible=false;},animate:function(time){requestAnimationFrame(this.animate.bind(this));TWEEN.update(time);var curObj=this.findMouseIntersection(threeData.unitType.Machine);if(curObj){if(curObj instanceof threeData.unitType.Machine){if(curObj.userData.isMoving){return;}
if(this.INTERSECTED&&this.INTERSECTED.id!=curObj.id){this.INTERSECTED.beopHideMachineName();}
this.INTERSECTED=curObj;this.INTERSECTED.beopShowMachineName();this.domElement.style.cursor='pointer';}}else{if(this.INTERSECTED){this.INTERSECTED.beopHideMachineName();this.domElement.style.cursor='auto';}
this.INTERSECTED=null;}
this.render();this.controls.update();this.stats.update();},render:function(){this.renderer.render(this.scene,this.camera);},start:function(){var _this=this;this.initScene();this.initCamera();this.initRender();this.initLight();this.loadData().done(function(){_this.initObjects();}).fail(function(){alert('load data failed.');});this.initControl();this.attachEvent();this.initStats();this.animate();},showMouseClickedObj:function(obj){if(!obj){return;}
var _this=this;obj.userData.isMoving=true;return new TWEEN.Tween(obj.position).to({x:2500,y:0,z:2000},2000).easing(TWEEN.Easing.Cubic.Out).onComplete(function(){obj.userData.isSingleShow=true;obj.userData.isMoving=false;}).start();},hideMouseClickedObj:function(obj){if(!obj){return;}
obj.userData.isMoving=true;return new TWEEN.Tween(obj.position).to({x:obj.userData.originPosition.x,y:obj.userData.originPosition.y,z:obj.userData.originPosition.z},2000).easing(TWEEN.Easing.Quartic.Out).onComplete(function(){obj.userData.isMoving=false;obj.userData.isSingleShow=false;}).start();},onMouseMove:function(event){this.mouse.x=(event.clientX/window.innerWidth)*2-1;this.mouse.y=-(event.clientY/window.innerHeight)*2+1;},onMouseDown:function(event){var _this=this,curObj=this.findMouseIntersection(threeData.unitType.Machine);if(!curObj||curObj.userData.isMoving){return;}
if(!curObj.userData.isSingleShow){this.hideMouseClickedObj(this.showingObj);this.showMouseClickedObj(curObj);this.showingObj=curObj;}else{this.hideMouseClickedObj(curObj);}}};function DataCenter3D(){}
DataCenter3D.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/dataCenter3D/index.html").done(function(resultHtml){$(ElScreenContainer).html(resultHtml);_this.init();}).always(function(){Spinner.stop();});},init:function(){var room=new Room(document.getElementById('t3Container'),'/static/scripts/dataCenter3D/data_machine1.json');room.start();$('.showSkin').click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine;}).forEach(function(machine){machine.showSkin();})});$('.hideSkin').click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine;}).forEach(function(machine){machine.hideSkin();})});$('.showTemperature').click(function(){room.scene.children.filter(function(item){return item instanceof threeData.unitType.Machine;})[0].beopShowTemperature();});$('.resetView').click(function(){room.resetView();})},close:function(){}}
return DataCenter3D;})();var ProductDownload=(function(){function ProductDownload(){this.curr=undefined;this.interval=undefined;this.all=undefined;}
ProductDownload.prototype={show:function(){WebAPI.get('/static/views/admin/productDownload.html').done(function(resultHtml){$('#indexMain').html(resultHtml);});this.init();},init:function(){this.curr=1;this.interval=5000;this.all=0;var len=this.elemNodesLen(document.getElementById('scroll_product_list').childNodes);this.all=len;var _this=this;var $scrollProductList=$("#scroll_product_list");var $mediaAndSupport=$(".mediaandsupport .list-group-item");var $panel=$(".panel");var $divideTitle=$(".divide-title");$("#scroll_btn_list li").each(function(index,domEle){$(domEle).mouseover(function(event){_this.pause();var prev=_this.curr;if(prev==index){return;}
var curr=index+1;_this.timeoutSet=setTimeout(function(){_this.go(curr);},500);event.stopPropagation();}).mouseout(function(){_this.timeoutSet&&clearTimeout(_this.timeoutSet);_this.play();});});$scrollProductList.mouseover(function(){_this.pause();});$scrollProductList.mouseout(function(){_this.play();});_this.play();$(".panel>.panel-heading:first").css('background','#bce8f1');$panel.on('show.bs.collapse',function(){$(this).find('.panel-heading').css('background','#bce8f1')});$panel.on('hide.bs.collapse',function(){$(this).find('.panel-heading').css('background','white')});$mediaAndSupport.not($divideTitle).mouseenter(function(){$(this).css('border','1px solid #bce8f1')});$mediaAndSupport.not($divideTitle).mouseleave(function(){$(this).css('border','1px solid transparent')});$mediaAndSupport.mouseenter(function(){$(this).find('.btn').css('display','inline')});$mediaAndSupport.mouseleave(function(){$(this).find('.btn').css('display','none')});},next:function(){var to;if(this.curr==this.all){to=1;}
else{to=this.curr+1;}
this.go(to);},prev:function(){var to;if(this.curr==1){to=this.all}
else{to=this.curr-1;}
this.go(to);},go:function(index){var curr=this.curr;if(curr==index){return;}
var elems_b=$("#scroll_product_list li");var curr_elem=elems_b.eq(curr-1);curr_elem.animate({opacity:0},500,null,function(){curr_elem.removeClass('on');});elems_b.eq(index-1).css('opacity',0).addClass('on').animate({opacity:1},500);var elems_btn=$("#scroll_btn_list li");elems_btn.removeClass('on');elems_btn.eq(index-1).addClass('on');var elems_download=$("#scroll_download_list li");elems_download.removeClass('on');elems_download.eq(index-1).addClass('on');this.curr=index;},pause:function(){this.timeSet&&clearInterval(this.timeSet);},play:function(){this.timeSet&&clearInterval(this.timeSet);var e=this;this.timeSet=setInterval(function(){this.next()},this.interval)},elemNodesLen:function(elems){if(!elems||typeof elems.length=='undefined'||elems.length==0)return 0;var len_true=0;for(var i=0,len=elems.length;i<len;i++){if(elems[i].nodeType==1){len_true++;}}
return len_true;}};return ProductDownload;})();var UserManagerController=(function(){function User(){this.id=null;this.username=null;this.userfullname=null;this.userpic=null;}
User.prototype={updateUserfullname:function(userfullname){var _this=this;return WebAPI.post('/admin/updateUser',{id:this.id,userfullname:userfullname}).done(function(result){if(result.success){_this.userfullname=userfullname;}});},updatePassword:function(oldPwd,newPwd){return WebAPI.post('/admin/updateUser',{id:this.id,oldPassword:oldPwd,password:newPwd})},updateAvatar:function(fileData){var _this=this;var formData=new FormData();formData.append('file',fileData);formData.append('userId',this.id);return $.ajax({url:'/admin/updateAvatar',type:'POST',data:formData,cache:false,processData:false,contentType:false,success:function(result,textStatus,jqXHR){if(typeof result.error==='undefined'&&result.success){_this.userpic=result.data;}else{var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[result.code]);alert.showAtTop(2000);}}});}};function Records(){this.recordType={0:I18n.resource.admin.panelManagement.ALL_RECORDS,1:I18n.resource.admin.panelManagement.ACCOUNT_LOGIN_RECORD,2:I18n.resource.admin.panelManagement.USER_MANAGEMENT_RECORD,3:I18n.resource.admin.panelManagement.PAGE_MANAGEMENT_RECORD};this.loginRecords=[];this.userManageRecords=[];this.pageManageRecords=[];this.allRecords=[];}
Records.prototype={fetchRecords:function(recordType,userId,beginTime,endTime){var postData={userId:userId,beginTime:beginTime,endTime:endTime};return WebAPI.post('/admin/getRecords',postData);},fetchLoginRecords:function(userId,beginTime,endTime){var _this=this;if(arguments.length!=1){return this.fetchRecords(1,userId,beginTime,endTime).done(function(result){_this.loginRecords=(result&&result.data)||[];});}else{return this.fetchRecords(1,userId).done(function(result){_this.loginRecords=(result&&result.data)||[];});}}};function UserManagerController(manager){this.manager=manager;this.recordVM=new Records();this.viewSource="/static/views/admin/userManager/userManagerController.html";}
UserManagerController.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.viewSource).done(function(resultHtml){var $ElScreenContainer=$(ElScreenContainer).html($(resultHtml));var $tab=beopTmpl('managerTabTmpl',AppConfig);$ElScreenContainer.find('#manageTab').append($tab);_this.init();ScreenManager.show(_this.manager);I18n.fillArea($(ElScreenContainer));$('#manageTab li[screen="'+BEOPUtil.getFunctionName(_this.manager)+'"] a').tab('show');}).always(function(){Spinner.stop();});},init:function(){var _this=this;$('#manageTab a').click(function(e){var screen=$(this).parent().attr('screen');if(screen&&window[screen]){_this.manager=window[screen];ScreenManager.show(_this.manager);}});},close:function(){$(document).off('click.userManager');this.addValidStatus("hide",$("#editInput"),'top');this.addValidStatus("hide",$('#editOldPwd'));this.addValidStatus("hide",$('#editNewPwd'));this.addValidStatus("hide",$('#editCheckNewPwd'));},addValidStatus:function(msg,$obj,placement){var placement=placement||'right';var errorTooltip=$obj.tooltip({container:'body',placement:placement,trigger:"manual",template:'<div class="tooltip" role="tooltip">'+'<div class="tooltip-arrow"></div>'+'<div class="tooltip-inner"></div>'+'</div>',html:true,title:(msg||'')});if(msg!="hide"){errorTooltip.tooltip('show');}else{errorTooltip&&errorTooltip.tooltip('destroy');}},loadUser:function(userId){var dfd=$.Deferred();if(!userId){dfd.reject()}
return WebAPI.get('admin/accountManger/'+userId).pipe(function(result){if(result.success){var user=$.extend(true,new User(),result.data);dfd.resolve(user);}else{dfd.reject(result)}
return dfd;})},loadRecords:function(){var dfd=$.Deferred();dfd.resolve(new Records());return dfd;},setFloatingWin:function($win,h){var wh=$(window).height();var top=(wh-h)/2;$win.find(".modal-dialog").css({'top':top});$win.modal();},checkEmail:function(str){var flag=true;var re=/^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;if(re.test(str)){flag=true;return flag;}else{flag=false;return flag;}},buildSubTree:function(buildTreeItemFunc,root,childField){if(!buildTreeItemFunc||typeof buildTreeItemFunc!=='function'){return'';}
if(!childField){childField='children';}
if(root[childField]&&root[childField].length>0){var $container=$('<ul></ul>')
for(var i=0;i<root[childField].length;i++){var child=root[childField][i];var $li=$(buildTreeItemFunc(child));if(child[childField]&&child[childField].length){$li.append(this.buildSubTree(buildTreeItemFunc,child,childField));}
$container.append($li);}
return $container;}},validateTime:function($startTime,$endTime,$msg){var flag=false;var startTimeVal=$startTime.val();var endTimeVal=$endTime.val();if(startTimeVal==""){$msg.text(I18n.resource.admin.panelManagement.START_TIME_CHECKINFO).css("display","block");flag=false;}else if(endTimeVal==""){$msg.text(I18n.resource.admin.panelManagement.END_TIME_CHECKINFO).css("display","block");flag=false;}else if(startTimeVal>endTimeVal){$msg.text(I18n.resource.admin.panelManagement.TIME_GREATER_CHECKINFO).css("display","block");flag=false;}else{flag=true;}
if(flag){$msg.hide();}else{$msg.show();}
return flag;},isArrayRepeat:function(arr){return/(\x0f[^\x0f]+)\x0f[\s\S]*\1/.test("\x0f"+arr.join("\x0f\x0f")+"\x0f");},renderLoginRecords:function($container){var compiledTemplate=beopTmpl('loginRecordTmpl',this.recordVM.loginRecords);$container.html(compiledTemplate);},renderRecordsEvent:function(userId,$startTime,$endTime,$msg,$container,isWinFlag){var flag=this.validateTime($startTime,$endTime,$msg);if(flag){if(!userId){return false;}
if(isWinFlag){$("#userAllRecord").show();}
var beginTime=$startTime.val(),endTime=$endTime.val(),_this=this;this.recordVM.fetchLoginRecords(userId,beginTime,endTime).done(function(){_this.renderLoginRecords($container);});}else{if(isWinFlag){$("#userAllRecord").hide();}}},getRecordsOne:function(userId,$container,isWinFlag){if(!userId){return false;}
if(isWinFlag){$("#userAllRecord").show();}
var _this=this;this.recordVM.fetchLoginRecords(userId).done(function(){_this.renderLoginRecords($container);});}};return UserManagerController;})();var AccountManager=(function(){function AccountManager(){this.viewSource="/static/views/admin/userManager/accountManager.html";this.managerCtrl=new UserManagerController();this.userVM=null;this.recordVM=null;this.$container=$();this.i18=I18n.resource.admin.panelManagement;this.datePickerInstance=null;this.reportEmailSetting={name:null,sex:null,email:{email1:null,email2:null,email3:null},data:[]};this.reportEmailSettingIDList=[];}
AccountManager.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.viewSource).done(function(resultHtml){_this.$container=$('#accountManageWrapper').html(resultHtml).find('#accountManage');$("#panelContentWrapper").hide();_this.init();_this.managerCtrl.getRecordsOne.call(_this.managerCtrl,AppConfig.userId,$('#allRecord'),false);I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});},setUserInfoHeight:function(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-20);$("#allRecord").height($(window).height()-$(".navbar").height()-320);},resetMonth:function(ev){var _this=this;var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){var year=_this.datePickerInstance.viewDate.format('yyyy-MM').split("-")[0];var currentYear=new Date().getFullYear();var currentMonth=new Date().getMonth()+1;var monthItem=_this.datePickerInstance.picker.find(".month");if(year==currentYear){for(var i=0;i<currentMonth;i++){monthItem.eq(i).removeClass("disabled");}}},50);},init:function(){var _this=this;this.setUserInfoHeight();$("#panelContentWrapper").show();this.renderManageUserInfo(AppConfig.userId);this.managerCtrl.loadRecords().done(function(result){_this.recordVM=result;});var $txtLogDateStart=$("#txtLogDateStart");$txtLogDateStart.datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true,endDate:new Date()}).on('show',function(ev){_this.resetMonth(ev);_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.resetMonth(ev);});}).on('changeYear changeMonth',function(ev){_this.resetMonth(ev);});this.datePickerInstance=$txtLogDateStart.data('datetimepicker');$("#txtLogDateEnd").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true});this.attachEvents();},renderManageUserInfo:function(userId){var _this=this;Spinner.spin(ElScreenContainer);this.managerCtrl.loadUser(userId).done(function(user){_this.userVM=user;_this.refreshManageUserInfo();I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});},refreshManageUserInfo:function(){var compiledTemplate=beopTmpl('paneProjectUserInfoTmpl',this.userVM);this.$container.find('#userInfo').html(compiledTemplate);},attachEvents:function(){var _this=this;this.$container.on('click','#editName',function(){$("#confrimEditName").show();$(this).hide();$('#accountManage .nameEditor').toggleClass("editing");});this.$container.on("click","#confrimEditName",function(){var userfullname=$.trim($('#accountManage #editInput').val());var flag=/^(\w|-|[\u4E00-\u9FA5]){2,10}$/g.test(userfullname);if(!flag){_this.managerCtrl.addValidStatus(_this.i18.EMAIL_FORMAT,$("#editInput"),"top");return;}else{_this.managerCtrl.addValidStatus("hide",$("#editInput"),"top");if(userfullname&&userfullname.trim()!==_this.userVM.userfullname){Spinner.spin(ElScreenContainer);_this.userVM.updateUserfullname(userfullname.trim()).done(function(result){if(result.success){_this.refreshManageUserInfo();AppConfig.userProfile.fullname=userfullname.trim();}}).always(function(){I18n.fillArea($(ElScreenContainer));Spinner.stop();});}
$('#accountManage .nameEditor').removeClass("editing");$("#paneUser").text(userfullname);$("#confrimEditName").hide();$("#editName").show();}});this.$container.on('click','.userPwd',function(){var wh=$(window).height();var top=(wh-300)/2;$(".modal-dialog").css({'top':top});$('#editPwdWin').modal();});$('#submitResetPwd').click(function(){var $oldPwd=$('#editOldPwd'),$newPwd=$('#editNewPwd'),$editCheckNewPwd=$('#editCheckNewPwd');var oldPwd=$oldPwd.val(),newPwd=$newPwd.val(),editCheckNewPwd=$editCheckNewPwd.val();var $returnInfo=$("#returnInfo"),$returnInfoCon=$("#returnInfoCon");if(oldPwd==""){_this.managerCtrl.addValidStatus(_this.i18.ORIGINAL_PASSWORD_NULL,$oldPwd);$returnInfoCon.hide();return;}else{_this.managerCtrl.addValidStatus('hide',$oldPwd);}
if(newPwd==""){_this.managerCtrl.addValidStatus(_this.i18.NEW_PASSWORD_NULL,$newPwd);$returnInfoCon.hide();return;}else{_this.managerCtrl.addValidStatus('hide',$newPwd);}
if(editCheckNewPwd==""){_this.managerCtrl.addValidStatus(_this.i18.CONFIRMED_PASSWORD_NULL,$editCheckNewPwd);$returnInfoCon.hide();return;}else{_this.managerCtrl.addValidStatus('hide',$editCheckNewPwd);}
if(newPwd!=editCheckNewPwd){_this.managerCtrl.addValidStatus(_this.i18.PASSWORD_CONSISTENT_ERROR,$newPwd);$returnInfoCon.hide();return;}else{_this.managerCtrl.addValidStatus('hide',$newPwd);}
if(!(newPwd.length>5&&newPwd.length<16)){_this.managerCtrl.addValidStatus(_this.i18.PASSWORD_FORMAT_ERROR,$newPwd);$returnInfoCon.hide();return;}
_this.userVM.updatePassword(oldPwd,newPwd).done(function(result){$returnInfo.text(I18n.resource.code[result.code[0]]);$returnInfoCon.show();if(result.success){$oldPwd.val("");$newPwd.val("");$editCheckNewPwd.val("");$returnInfoCon.hide();$("#editPwdWin").modal("hide");}else{return false;}}).fail(function(){$returnInfo.text(_this.i18.REQUEST_ERROR);$returnInfoCon.show();}).always(function(){I18n.fillArea($(ElScreenContainer));});});$('#editPwdWin').on('hide.bs.modal',function(){_this.managerCtrl.addValidStatus('hide',$('#editOldPwd'));_this.managerCtrl.addValidStatus('hide',$('#editNewPwd'));_this.managerCtrl.addValidStatus('hide',$('#editCheckNewPwd'));});this.$container.on('change','#file-input',function(event){Spinner.spin(ElScreenContainer);event.stopPropagation();event.preventDefault();var fileData=event.target.files[0];if(fileData.size>1024*1024){$(".modal-dialog").css({'top':($(window).height()-200)/2});$("#PromptWinInfo").text(_this.i18.FILE_SIZE_LIMITED);$("#PromptWin").modal();var t=null;t&&clearTimeout(t);t=setTimeout(function(){$("#PromptWin").modal("hide");},2000);Spinner.stop();return false;}
_this.userVM.updateAvatar(fileData).done(function(result){Spinner.spin(ElScreenContainer);if(result.success){$('.image-upload img').attr('src',result.data);AppConfig.userProfile.picture=result.data;}}).always(function(){Spinner.stop();});});$("#searchRecord").click(function(){_this.managerCtrl.renderRecordsEvent.call(_this.managerCtrl,AppConfig.userId,$("#txtLogDateStart"),$("#txtLogDateEnd"),$("#infoDate"),$('#allRecord'),false);});var accountPanel=_this.$container.find('#accountManagePanel');accountPanel.find('a[data-toggle="tab"]').on('shown.bs.tab',function(){var param=$(this).data('shown'),togglePlans=accountPanel.find('.panel-body div.row');togglePlans.hide();accountPanel.find('#'+param).show();if(param=='reportEmailSetting'){_this.renderProjectList();}});$(window).on("resize.setUserInfoHeight",function(){_this.setUserInfoHeight();});},detachEvents:function(){$(window).off("resize.setUserInfoHeight");},close:function(){this.detachEvents();this.managerCtrl.addValidStatus("hide",$("#editInput"),'top');this.managerCtrl.addValidStatus("hide",$('#editOldPwd'));this.managerCtrl.addValidStatus("hide",$('#editNewPwd'));this.managerCtrl.addValidStatus("hide",$('#editCheckNewPwd'));},renderProjectList:function(){this.reportEmailSetting.data=[];this.reportEmailSettingIDList=[];Spinner.spin(ElScreenContainer);I18n.fillArea($(ElScreenContainer));var projectList=AppConfig.projectList,_this=this;if(projectList==null||projectList=='undefined'){alert(I18n.resource.admin.reportEmailSetting.READ_USER_FAIL);}
var i=0,projectNameList=[];var language=window.localStorage.getItem('language');if(language=='en'){for(i=0;i<projectList.length;i++){projectNameList.push({title:projectList[i].name_en,id:projectList[i].id})}
document.documentElement.setAttribute('lang','en-us');}else if(language=='zh'){for(i=0;i<projectList.length;i++){projectNameList.push({title:projectList[i].name_cn,id:projectList[i].id})}
document.documentElement.setAttribute('lang','zh');}
var $container=$('#reportEmailSetting');var $projectListContainer=$container.find('.wf-project-list');$projectListContainer.html(beopTmpl('projectNameList',{projectNameList:projectNameList}));this.getUserReportEmailSetting().done(function(){_this.bindProjectListEvent();Spinner.stop();});},getUserReportEmailSetting:function(){var _this=this;return WebAPI.get('workflow/reportEmailSetting/get/'+AppConfig.userId).done(function(result){if(Object.keys(result.data).length){_this.renderUserReporterEmailSetting(result.data);}else{return $.Deferred().resolve();}}).always(function(){Spinner.stop();})},renderUserReporterEmailSetting:function(data){if(!data){alert(I18n.resource.admin.reportEmailSetting.NO_DATA);return false;}else{data.data.forEach(function(item,index,array){item.navItemIdList=JSON.parse(item.navItemIdList);});var dataList=data.data,nickName=data.nickname,mail=[],sex=data.sex,_this=this;var reportIdList=[],reportNavItems=[],i=0,mailItem,item;for(i=0;i<3;i++){mailItem=data['mail'+(i+1)];if(mailItem!==null&&mailItem!==undefined&&mailItem!==''){mail.push(mailItem);}}
for(i=0;i<dataList.length;i++){item=dataList[i];reportIdList.push(item.projectId);this.reportEmailSettingIDList.push({projectId:item.projectId,navItemIdList:item.navItemIdList});}
$('#wf-report-setting-name').val(nickName);var html='';for(i=0;i<mail.length;i++){item=$.trim(mail[i]);html+='<div class="col-sm-3 wf-report-setting-email"><input oninvalid="alert(I18n.resource.admin.reportEmailSetting.PLEASE_INPUT_RIGHT_EMAIL);return false;" value="'+item+'" type="email" class="form-control" placeholder="email" required/>'+'<span class="glyphicon glyphicon-remove wf-report-remove-email"></span></div>';}
if(mail.Length<3){html+='<span class="glyphicon glyphicon-plus-sign wf-report-email-add" id="wf-report-email-add"></span>';$('.wf-report-setting-email-container').empty().append(html);}else{$('.wf-report-setting-email-container').empty().append(html);}
$('#wf-report-setting-sex').find('input[type="radio"]').each(function(){var $this=$(this);if($this.parent().attr('data-wf-report-setting-sex-type')==sex){$this.prop('checked','checked');_this.reportEmailSetting.sex=sex;}});var $projectList=$('.wf-project-list>li');$projectList.each(function(){var $this=$(this);for(i=0;i<reportIdList.length;i++){if($this.data('project-id')==reportIdList[i]){$this.addClass('wf-hasAddReporter');$this.find('input[type="checkbox"]').prop('checked','checked');}}});for(i=0;i<dataList.length;i++){this.reportEmailSetting.data.push(dataList[i]);}}},bindProjectListEvent:function(){var $container=$('#reportEmailSetting');var projectList=$container.find('.wf-project-list>li>label'),_this=this;projectList.off().on('change',function(ev){ev.stopPropagation();var $this=$(this),isHasAddReporter=$this.parent().hasClass('wf-hasAddReporter');if(isHasAddReporter){_this.enableProjectList($this).done(function(){$this.find('input').prop('checked','checked');});}else{if($this.find('input').is(':checked')){_this.enableProjectList($this);}else{_this.disableProjectList($this);}}});var submit=$container.find('#submit-report-email-list');submit.off().on('submit',_this.submitReportEmailSetting.bind(_this));var sexSelected=$('#wf-report-setting-sex').find('input');sexSelected.parent().each(function(){$(this).on('change',function(){var $this=$(this);var checkBox=$this.find('input');if(checkBox.is(':checked')){_this.reportEmailSetting.sex=$.trim(checkBox.parent().data('wf-report-setting-sex-type'));sexSelected.prop('checked',false);checkBox.prop('checked','checked');}else{}})});var emailAdd=$('#wf-report-email-add'),emailLength;emailAdd.off().on('click',function(){var html='<div class="col-sm-3 wf-report-setting-email"><input oninvalid="alert(I18n.resource.admin.reportEmailSetting.PLEASE_INPUT_RIGHT_EMAIL);return false;" type="email" class="form-control" placeholder="email" required>'+'<span class="glyphicon glyphicon-remove wf-report-remove-email"></span></div>',$this=$(this);emailLength=$('.wf-report-setting-email').find('input').length;if(emailLength<3){$this.prev().append(html);if(emailLength==2){emailAdd.hide();}}else{alert(I18n.resource.admin.reportEmailSetting.MAX_EMAIL_ADD)}});$('#accountManagePanel').on('click','.wf-report-remove-email',function(){$(this).parent().remove();if(emailLength<3){emailAdd.show();}})},disableProjectList:function($this){var $parent=$this.parent(),$projectDetail=$parent.find('ul.wf-project-detail'),projectId=$projectDetail.parent().attr('data-project-id');$projectDetail.toggleClass('dn');},enableProjectList:function($this){var projectListLI=$this.parent(),projectId=projectListLI.attr('data-project-id'),$projectDetail=projectListLI.find('ul.wf-project-detail'),_this=this;var isHasProject=_this.reportEmailSetting.data.some(function(item,index,array){return(item.projectId==projectId)});if(projectListLI.hasClass('hasGotData')){$projectDetail.toggleClass('dn');projectId=$projectDetail.parent().attr('data-project-id');if(!isHasProject){_this.reportEmailSetting.data.push({projectId:projectId,navItemIdList:[]});}
return $.Deferred().resolve();}else{Spinner.spin(ElScreenContainer);return WebAPI.get('/get_plant_pagedetails/'+projectId+'/'+AppConfig.userId).done(function(result){var projectDetailList=result.navItems,reportDeatilList=[],i;for(i=0;i<projectDetailList.length;i++){if(projectDetailList[i].type=="ReportScreen"){reportDeatilList.push(projectDetailList[i])}}
projectListLI.append(beopTmpl('projectDetailList',{projectDetailList:reportDeatilList}));var newProjectDetail=projectListLI.find('ul.wf-project-detail');if(!isHasProject){_this.reportEmailSetting.data.push({projectId:projectId,navItemIdList:[]});}
var navItemIdList=[];for(i=0;i<_this.reportEmailSettingIDList.length;i++){var item=_this.reportEmailSettingIDList[i];if(item.projectId==projectId){navItemIdList=item.navItemIdList}}
if(navItemIdList.length){newProjectDetail.find('li').each(function(){var $this=$(this);for(i=0;i<navItemIdList.length;i++){if($this.data('navitems-id')==navItemIdList[i].navItemsId){$this.find('input[type="checkbox"]').prop('checked','checked');}}});}
_this.bindProjectListDetailChecked(newProjectDetail);}).always(function(){Spinner.stop();projectListLI.addClass('hasGotData');})}},bindProjectListDetailChecked:function($projectDetail){if($projectDetail.hasClass('no-data')){}else{var _this=this;$projectDetail.find('li>label').off().on('change',function(){var $this=$(this),$parent=$this.parent(),projectId=$parent.parent().parent().attr('data-project-id'),navItemsId=$parent.attr('data-navitems-id'),reportFolder=$parent.attr('data-navItems-reportFolder');var reportProjectList,i=0,item;reportProjectList=_this.reportEmailSetting.data;if($this.find('input').is(':checked')){for(i=0;i<reportProjectList.length;i++){item=reportProjectList[i];if(item.projectId==projectId){item.navItemIdList.push({navItemsId:navItemsId,reportFolder:reportFolder,text:$.trim($this.text())});}}}else{for(i=0;i<reportProjectList.length;i++){item=reportProjectList[i];if(item.projectId==projectId){item.navItemIdList.forEach(function(result,index,array){if(result.navItemsId==navItemsId){item.navItemIdList.splice(index,1);}})}}}});}},submitReportEmailSetting:function(ev){var data=this.reportEmailSetting,userId=AppConfig.userId;if(data.data.length==0){alert(I18n.resource.admin.reportEmailSetting.PLEASE_CHOOSE_PROJECT);ev.preventDefault();return false;}else if(data.sex==null){alert(I18n.resource.admin.reportEmailSetting.PLEASE_CHOOSE_SEX);ev.preventDefault();return false;}else{var email=$('.wf-report-setting-email-container').find('input');if(email.length==0){alert(I18n.resource.admin.reportEmailSetting.LEAST_ONE_EMAIL);ev.preventDefault();return false;}
Spinner.spin(ElScreenContainer);data.name=$('#wf-report-setting-name').val();email.each(function(i){data.email['email'+(i+1)]=$.trim($(this).val());});var extendData=$.extend(true,{},data);extendData.data=extendData.data.filter(function(item,index,array){return(item.navItemIdList.length!==0)});if(extendData.data.length==0){alert(I18n.resource.admin.reportEmailSetting.PLEASE_CHOOSE_REPORT);Spinner.stop();ev.preventDefault();return false;}else{extendData.data.forEach(function(item,index,array){item.navItemIdList=JSON.stringify(item.navItemIdList);});WebAPI.post('workflow/reportEmailSetting/update/'+userId,extendData).done(function(result){if(result.success){alert(I18n.resource.admin.reportEmailSetting.ADD_SUCCESS);}}).fail(function(){}).always(function(){Spinner.stop();});}}}};return AccountManager;})();var MemberManager=(function(){function MemberManager(){this.viewSource="/static/views/admin/userManager/memberManager.html";this.managerCtrl=new UserManagerController();this.$container=$();this.userTree={};this.i18=I18n.resource.admin.panelManagement;this.datePickerInstance=null;}
MemberManager.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.viewSource).done(function(resultHtml){_this.$container=$('#memberManageWrapper').html(resultHtml).find('#memberManage');$("#manageTab li[screen='AccountManager']").remove();$("#manageTab").show();$("#panelContentWrapper").hide();_this.init();I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});},setMemberManagerHeight:function(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-62);$("#userTreeCon").height($(window).height()-$(".navbar").height()-205);},init:function(){this.setMemberManagerHeight();$("#panelContentWrapper").show();this.loadUserTree();this.attachEvents();},resetMonth:function(ev){var _this=this;var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){var year=_this.datePickerInstance.viewDate.format('yyyy-MM').split("-")[0];var currentYear=new Date().getFullYear();var currentMonth=new Date().getMonth()+1;var monthItem=_this.datePickerInstance.picker.find(".month");if(year==currentYear){for(var i=0;i<currentMonth;i++){monthItem.eq(i).removeClass("disabled");}}},50);},attachEvents:function(){var _this=this;var $startDateRecord;var $endDateRecord;var $userSettingWin=$("#userSettingWin");var $userTreeCon=$("#userTreeCon");var $expiryDatePicker=null;$userTreeCon.on('click','.setting',function(event){var userId=$(this).closest('li').attr('userId');$userTreeCon.find("span").removeClass("selected");$(this).parents("span").addClass("selected");Spinner.spin(ElScreenContainer);WebAPI.post('/admin/loadUsersSetting',{userId:userId,currentUser:AppConfig.userId}).done(function(result){if(result.success){result.data.managers.sort(function(a,b){return a.userfullname>b.userfullname});$userSettingWin.find('.modal-body').empty().append(beopTmpl('userSettingTmpl',result.data));_this.managerCtrl.setFloatingWin($userSettingWin,700);$userSettingWin.attr("userId",userId);$startDateRecord=$("#recordLogDateStart").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true,endDate:new Date()}).on('show',function(ev){_this.resetMonth(ev);_this.datePickerInstance.picker.find(".prev,.next").click(function(){_this.resetMonth(ev);});}).on('changeYear changeMonth',function(ev){_this.resetMonth(ev);});_this.datePickerInstance=$startDateRecord.data('datetimepicker');$endDateRecord=$("#recordLogDateEnd").datetimepicker({minView:2,format:"yyyy-mm-dd",autoclose:true});_this.managerCtrl.getRecordsOne.call(_this.managerCtrl,AppConfig.userId,$('#userAllRecord'),true);}
I18n.fillArea($(ElScreenContainer));}).always(function(){Spinner.stop();});}).on('click','.icon-minus-sign',function(){var $this=$(this);var $ul=$this.parents("span").next("ul");if($ul.length){$ul.slideUp(300);$this.removeClass("icon-minus-sign").addClass("icon-plus-sign");}}).on('click','.icon-plus-sign',function(){var $this=$(this);var $ul=$this.parents("span").next("ul");if($ul.length){$ul.slideDown(300);$this.removeClass("icon-plus-sign").addClass("icon-minus-sign");}});$userSettingWin.on("click","#userDel",function(){_this.managerCtrl.setFloatingWin($("#isUserDelWin"),300);}).on("click","#userEditConfrim",function(){var userId=$userSettingWin.attr("userId");if(AppConfig.userId==userId){$userSettingWin.modal("hide");}
var isManager=$("#isManager option:selected").val();var supervisor=$('#supervisor  option:selected').val();var oldSupervisor=$('#oldSupervisor').val();var oldIsManager=$('#oldIsManager').val();if(supervisor!=oldSupervisor||isManager!=oldIsManager){WebAPI.post('/admin/updateUsersSetting',{userId:userId,isManager:isManager,supervisor:supervisor}).done(function(result){if(result.success){_this.loadUserTree();$userSettingWin.modal("hide");}
I18n.fillArea($(ElScreenContainer));})}else{$userSettingWin.modal("hide");}}).on("click","#btnRecord",function(){var userId=$userSettingWin.attr('userId');if(!userId){return false;}
_this.managerCtrl.renderRecordsEvent.call(_this.managerCtrl,userId,$('#recordLogDateStart'),$('#recordLogDateEnd'),$('#recordInfoDate'),$('#userAllRecord'),true);}).on('click','#setAccountExpiry',function(){$('#expiryDisplay').hide();$('#expiryEditor').show();$expiryDatePicker=$('#expiryDatePicker').datetimepicker({format:'yyyy-mm-dd',minView:'month',autoclose:true});}).on('click','#setAccountExpiryCancel',function(){$('#expiryDisplay').show();$('#expiryEditor').hide();$('#expiryDatePicker').val('');$expiryDatePicker&&$expiryDatePicker.datetimepicker('remove');}).on('click','#setAccountExpirySave',function(){if(!$expiryDatePicker||!$expiryDatePicker.val()){Alert.danger($userSettingWin.find('.modal-content'),'时间不能为空').showAtTop(2000);return false;}
WebAPI.post('admin/setUserExpiredDate',{userId:$userSettingWin.attr('userid'),expiredDate:$expiryDatePicker.val()}).done(function(result){if(result.success){$('#expiryDisplay').show().find('.expiryText').show().end().find('.expiryDate').text($expiryDatePicker.val());$('#expiryEditor').hide();}})});$("#deleteUser").click(function(){var userId=$userSettingWin.attr("userId");WebAPI.post('/admin/deleteUser',{userId:userId,currentUserId:AppConfig.userId}).done(function(result){if(result.success){_this.loadUserTree();$userSettingWin.modal("hide");$("#isUserDelWin").modal("hide");I18n.fillArea($(ElScreenContainer));}});});$("#addPerson").on("click",function(){_this.loadManagersByUserId(AppConfig.userId).done(function(result){if(!result.success){return false;}
var $addPersonWin=$('#addPersonWin');$(".modal-dialog").css({'top':($(window).height()-600)/2});$addPersonWin.find('.modal-body').empty().append(beopTmpl('addUserTmpl',{addCount:5,managers:result.data}));I18n.fillArea($(ElScreenContainer));$addPersonWin.modal();});});var projectPermission={},selectedUserId,selectedProjectId;$('#addPersonWin').on('change','#selectSupervisor',function(){selectedUserId=$(this).find('option:checked').val();if(!selectedUserId){return false;}
WebAPI.post('/admin/getProjectPermissionByUserId',{userId:selectedUserId}).done(function(result){if(result.success){projectPermission=result.data;var $selectInitProject=$('#selectInitProject').empty();$('#selectInitRole option.roles').remove();var newSelectInitProjectHtml=beopTmpl('selectInitProjectTmpl',projectPermission);$selectInitProject.replaceWith(newSelectInitProjectHtml);}else{$('#selectInitProject').find('option.projects').remove();projectPermission={};}
I18n.fillArea($(ElScreenContainer));}).fail(function(){$('#selectInitProject').find('option.projects').remove();projectPermission={};});}).on('change','#selectInitProject',function(){selectedProjectId=$(this).find('option:checked').val();var $selectInitRole=$('#selectInitRole').empty();var roles=projectPermission[selectedProjectId].roles;if(roles){var newSelectInitRoleHtml=beopTmpl('selectInitRoleTmpl',roles);$selectInitRole.replaceWith(newSelectInitRoleHtml);}});$('#addPersonOK').click(function(){var $this=$(this);var $addPersonWin=$('#addPersonWin');var emails=[];var userName=[];var $userEmails=$addPersonWin.find(".userEmail");var supervisorId=$('#selectSupervisor option:selected').val();var $addPersonErr=$("#addPersonErr");$addPersonErr.text("").hide();if(supervisorId=="0"){$addPersonErr.text(_this.i18.IMMEDIATE_SUPERIOR_NULL+"！").show();return false;}
for(var i=0;i<$userEmails.length;i++){var $email=$userEmails.eq(i);var email=$email.val();if(email!=""){if(!_this.managerCtrl.checkEmail(email)){$email.focus();$addPersonErr.text(_this.i18.MAILBOX_FORMAT_WRONG+"！").show();return false;}
emails.push(email);userName.push($addPersonWin.find('.userName').eq(i).val());}}
$addPersonErr.text("").hide();if(_this.managerCtrl.isArrayRepeat(emails)){$addPersonErr.text(_this.i18.MAILBOX_CHECKINFO_REPEATED+"！").show();return false;}
var initProjectId=$('#selectInitProject option:selected').val(),initRoleId=$('#selectInitRole option:selected').val();if(initProjectId==='0'){$addPersonErr.text(_this.i18.INITIAL_PROJECT_NOTNULL+"！").show();return false;}
if(initRoleId==='0'){$addPersonErr.text(_this.i18.INITIAL_ROLE_NOTNULL+"！").show();return false;}
$addPersonErr.text("").hide();var postData={'inviterId':AppConfig.userId,'supervisorId':supervisorId,'isManager':$('#givenMR').get(0).checked?1:0,'userInfo':[],'initRole':initRoleId};if(userName!=undefined){var postUserInfo=[];for(var i=0,len=userName.length;i<len;i++){if(undefined!=userName[i]){if(undefined==emails[i]){emails[i]='';}
postUserInfo.push({'userfullname':userName[i],'email':emails[i]});}}
postData.userInfo=postUserInfo;}
if(!postData.userInfo.length){$addPersonErr.text(_this.i18.PLEASE_ADD_USER+"。").show();return false;}
$this.button('loading');WebAPI.post('/admin/inviteUsers',postData).done(function(result){if(result.success){_this.loadUserTree().done(function(result){});result.data.info={"apply":_this.i18.MAILBOX_CHECKINFO_APPLY,"invited":_this.i18.MAILBOX_CHECKINFO_INVITED,"registered":_this.i18.MAILBOX_CHECKINFO_REGISTERED,"token_failed":_this.i18.SEND_MAIL_FAILED,"succeed":_this.i18.SEND_EMAIL_SUCCESS};var compiledTemplate=beopTmpl('inviteMsgTmpl',result.data);$("#inviteMsg").empty().html(compiledTemplate);$addPersonErr.text("").hide();}}).fail(function(){$addPersonErr.text(_this.i18.REQUEST_ERROR+"！").show();}).always(function(){I18n.fillArea($(ElScreenContainer));$this.button('reset');});});$("#memberManage").on("click",".re-invite",function(){var postData={'reactivateId':parseInt($(this).closest("li").attr("userid")),'userId':AppConfig.userId};WebAPI.post('/admin/reactivateUser',postData).done(function(result){if(result.success){var alert=new Alert(ElScreenContainer,Alert.type.success,I18n.resource.admin.panelManagement.SUCCEED);alert.showAtTop(2000);}else{var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.panelManagement.FAILED);alert.showAtTop(2000);}}).fail(function(e){console.error('员工管理的一键激活错误'+e);}).always(function(){I18n.fillArea($(ElScreenContainer));});});$("#searchUserIc").click(function(){var val=$("#searchUser").val();_this.searchUserObj(val,$(".userTree"));});$("#searchUser").keyup(function(e){var val=$("#searchUser").val();_this.searchUserObj(val,$(".userTree"));if(e.keyCode==40){$("#userListUl li").eq(0).find("input").focus();}});$(document).on("click.memberManager",function(e){var $target=$(e.target);if(!($target.parents("#searchUserCon").length)){$("#userListUl").slideUp(300);}});$("#userListUl").on("click","li",function(){var userid=$(this).attr("userid");var val=$(this).find("input").val();_this.selectedUserObj(userid,val);});$("#userListUl").on("keydown","li input",function(e){var $li=$(this).parents("li");var $liAll=$("#userListUl li");if(e.keyCode==38){if($liAll.index($li)+1==1){$liAll.eq($liAll.length-1).find("input").focus();var t2=null;t2&&clearTimeout(t2);t2=setTimeout(function(){$("#userListUl").scrollTop(10000);},30);}else{$li.prev().find("input").focus();$("#userListUl").scrollTop($liAll.index($li)*28);}}else if(e.keyCode==40){if($liAll.index($li)+1==$liAll.length){$liAll.eq(0).find("input").focus();var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){$("#userListUl").scrollTop(0);},30);}else{$("#userListUl").scrollTop($liAll.index($li)*28);$li.next().find("input").focus();}}else if(e.keyCode==13){$("#userListUl").slideUp(300);_this.selectedUserObj($li.attr("userid"),$(this).val());}});$(window).on("resize.setMemberManagerHeight",function(){_this.setMemberManagerHeight();});},detachEvents:function(){$(window).off("resize.setMemberManagerHeight");$(window).off("click.memberManager");},close:function(){this.detachEvents();},loadUserTree:function(){var _this=this;Spinner.spin(ElScreenContainer);return WebAPI.post('/admin/loadUsersTree',{userId:AppConfig.userId}).done(function(result){if(result.success){Spinner.spin(ElScreenContainer);_this.userTree=result.data;var $userTree=_this.buildUserTree(_this.userTree);$('.userTree').empty().append($userTree);$("#treeUl .setting").eq(0).find("img").css({"position":"relative","z-index":8});I18n.fillArea($(ElScreenContainer));Spinner.stop();}}).always(function(){Spinner.stop();});},buildUserTree:function(root){var buildUserTreeItem=function(item){return beopTmpl('userTreeItemTmpl',item);};var $root=$('<ul id="treeUl"></ul>').append(buildUserTreeItem(root));$root.find('li').append(this.managerCtrl.buildSubTree(buildUserTreeItem,root,'sub'));return $root;},loadManagersByUserId:function(userId){return WebAPI.post('/admin/loadManagersByUserId',{userId:userId});},loadInvitePanel:function(userId){return WebAPI.post('/admin/loadInvitePanel',{userId:userId});},searchUserObj:function(val,$tree){var arrNameInfo=[];var arrPicInfo=[];var arrIdInfo=[];var userNameArr=[];var userPicArr=[];var userIdArr=[];var $userLiAll=$tree.find("li");var $userNameAll=$userLiAll.find(".userfullname");var $userPicAll=$userLiAll.find(".setting>img");for(var i=0;i<$userNameAll.length;i++){userNameArr.push($userNameAll.eq(i).text());userPicArr.push($userPicAll.eq(i).attr("src"));userIdArr.push($userLiAll.eq(i).attr("userid"));}
for(var i=0;i<userNameArr.length;i++){if((userNameArr[i].toLowerCase()).indexOf(val.toLowerCase())>-1){arrNameInfo.push(userNameArr[i]);arrPicInfo.push(userPicArr[i]);arrIdInfo.push(userIdArr[i]);}}
var li='';for(var i=0;i<arrNameInfo.length;i++){var userNameStr=arrNameInfo[i];var userPicUrl=arrPicInfo[i];var userId=arrIdInfo[i];li+='<li userId="'+userId+'" class="pr"><input type="text" value="'+userNameStr+'" class="pa" readonly /><img src="'+userPicUrl+'" class="pa" style="z-index:55" /></li>';}
$("#userListUl").empty().append(li).slideDown(300);},selectedUserObj:function(userid,searchText){$("#userListUl").slideUp(300);var $treeUl=$("#treeUl");var $userTreeCon=$("#userTreeCon");var $span=$treeUl.find("span");var $userSpan=$treeUl.find("li[userid="+userid+"]>span");var $targetUl=$userSpan.parents("ul");var $targetI=$targetUl.prev("span").find(".icon-plus-sign");$span.removeClass("selected");$userSpan.addClass('selected');$targetI.removeClass("icon-plus-sign").addClass("icon-minus-sign");$targetUl.slideDown(300);$("#searchUser").val(searchText);var t1=null;t1&&clearTimeout(t1);t1=setTimeout(function(){$userTreeCon.scrollTop($userSpan.offset().top+$userTreeCon.scrollTop()-300);$userTreeCon.scrollLeft($userSpan.offset().left+$userTreeCon.scrollLeft()-$treeUl.width()-15);$("#searchUser").focus();},500);}};return MemberManager;})();var ProjectPermissionManager=(function(){function ProjectPermissionManager(){this.viewSource="/static/views/admin/userManager/projectPermissionManager.html";this.managerCtrl=new UserManagerController();this.$container=$();this.pageViewModel={};this.i18=I18n.resource.admin.panelManagement;}
ProjectPermissionManager.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get(this.viewSource).done(function(resultHtml){_this.$container=$('#permissionManageWrapper').html(resultHtml).find('#permissionManage');$("#manageTab li[screen='AccountManager']").remove();$("#manageTab").show();$("#panelContentWrapper").hide();_this.init();I18n.fillArea($(ElScreenContainer));}).always(function(){});},setPermissionManagerHeight:function(){$("#panelContentWrapper").height($(window).height()-$(".navbar").height()-62);$("#projectCon").height($(window).height()-$(".navbar").height()-185);},init:function(){this.setPermissionManagerHeight();$("#panelContentWrapper").show();this.loadProjectPermission();},attachEvents:function(){var _this=this,$isDelUserWin=$("#isDelUserWin"),deleteUserId=null,roleOfDeleteUser=null,$permissionManage=$('#permissionManage');$('#selectProject').change(function(){if(this.value){$('.proCompany').hide();$('#'+this.value).show();}else{$('.proCompany').show();}});$("#addProject").click(function(){ScreenManager.show(PaneProjectCreator);});$("#permissionManage").off().on("mouseover",'.proUser',function(){var $this=$(this);if($this.attr('userId')!=AppConfig.userId){$(this).find(".closed").show();}}).on("mouseout",'.proUser',function(){$(this).find(".closed").hide();}).on("click",'.closed',function(){var $this=$(this);deleteUserId=$this.attr('userId');roleOfDeleteUser=$this.attr('roleId');_this.managerCtrl.setFloatingWin($isDelUserWin,300);}).on("click",'.addGroup',function(){var $this=$(this);$("#groupName").val("");$("#groupNameInfo").hide();$(".proCompany>ul").removeClass("isAdd");$this.parents(".addGroupWrapper").prev("ul").addClass("isAdd");var obj=$('#addGroupWin');$(".modal-dialog").css({'top':($(window).height()-300)/2});obj.modal();}).on('click','.modify-btn',function(){var $this=$(this),projectId=$this.data('project-id');if(!BEOPUtil.isUndefined(projectId)){ScreenManager.show(PaneProjectCreator,projectId);}});$isDelUserWin.off().on("click",".btn-primary",function(){if(!BEOPUtil.isUndefined(deleteUserId)&&!BEOPUtil.isUndefined(roleOfDeleteUser)){WebAPI.post('/admin/deleteRoleUser',{'roleId':roleOfDeleteUser,'userId':deleteUserId}).done(function(result){if(result.success){$permissionManage.find('.proList[roleId="'+roleOfDeleteUser+'"] .proUser[userId="'+deleteUserId+'"]').remove();$isDelUserWin.modal("hide");}}).fail(function(){})}});$('#addGroupWin').off().on("click",".addGroupWinOK",function(){var $addGroupWin=$('#addGroupWin');var $roleNameInput=$("#groupName");var $groupNameInfo=$("#groupNameInfo");if($roleNameInput.val()==""){$groupNameInfo.text(_this.i18.GROUP_NAME_NOTNULL).show();return false;}else{var projectId=$('.isAdd').parent('.proCompany').attr('id');var groupNameArr=[];$("#"+projectId).find(".role").each(function(){groupNameArr.push($(this).text());});if($.inArray($roleNameInput.val(),groupNameArr)>=0){$groupNameInfo.text(_this.i18.GROUPINGNAME_NOT_REPEAT).show();return false;}else{$groupNameInfo.hide();WebAPI.post('/admin/addProjectRole',{'projectId':projectId,'roleName':$roleNameInput.val(),'userId':AppConfig.userId}).done(function(result){if(result.success){_this.loadProjectPermission().done(function(result){if(result.success){$addGroupWin.modal("hide");}});}});$roleNameInput.val("");}}});$("#projectCon").off().on("click",".delCon",function(){var $this=$(this);var $op=$this.parents(".proListWrapper");var wh=$(window).height();var $isDelWin=$('#isDelWin');var top=(wh-300)/2;$(".proListWrapper").removeClass("isDel");$op.addClass("isDel");var dataRoleId=$this.attr("data-roleid");var dataProjectid=$this.attr("data-projectid");$("#isDelWin").attr("data-roleid",dataRoleId).attr("data-projectid",dataProjectid);$(".modal-dialog").css({'top':top});$isDelWin.modal();});$('#isDelWin').off().on("click",".btn-primary",function(){var $isDelWin=$('#isDelWin');$isDelWin.modal("hide");var $isDel=$("#projectCon .isDel");var projectId=$isDelWin.attr('data-projectid');var roleId=$isDelWin.attr('data-roleid');WebAPI.post('/admin/deleteProjectRole',{'projectId':projectId,'roleId':roleId,'userId':AppConfig.userId}).done(function(result){if(result.success){$isDelWin.attr('data-projectid',"").attr('data-roleid',"");$isDel.remove();}else{var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code[result.code]);alert.showAtTop(2000);}}).fail(function(){var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.code['0']);alert.showAtTop(2000);})});$("#searchProjectUser").keyup(function(e){var $listNameAll=$("#userList .listName");for(var i=0;i<$listNameAll.length;i++){var $listName=$listNameAll.eq(i);if(($listName.text().toLowerCase()).indexOf($(this).val().toLowerCase())<0){$listName.parents("li").hide();}else{$listName.parents("li").show();}}});$('#userList li').each(function(){this.draggable=true;this.ondragstart=function(e){var $this=$(this);var userInfo={userId:$this.attr('userid'),userName:$this.find(".listName").text(),userPic:$this.attr("userPic")};$("#dragObj").val("user");e.dataTransfer.setData("user",JSON.stringify(userInfo));};});$('.proUser').each(function(){this.draggable=true;this.ondragstart=function(e){var $this=$(this);var userInfo={userId:$this.attr('userid'),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser");e.dataTransfer.setData("itemUser",JSON.stringify(userInfo));};});$('.proList').each(function(){this.ondragover=function(e){e.preventDefault();};this.ondrop=_this.dropUserToRoleEvent;});$("#projectCon").off('click','.benchmark-btn').on('click','.benchmark-btn',function(){Spinner.spin(ElScreenContainer);var $this=$(this);var projectId=$this.data('project-id');WebAPI.post('/admin/loadBenchmarkMenu',{projectId:projectId}).done(function(result){if(result.success){var data=result.data,nav=data.nav,$menuTree,$benchmarkSet=$('#benchmarkSet');if(nav&&nav.length){$menuTree=_this.buildMenuTree(nav,'benchmarkMenuTreeItemTmpl');$benchmarkSet.find('.winCon').empty().append($menuTree);$benchmarkSet.find('#saveBenchmarkMenu').attr('project-id',projectId);_this.renderTreeView();}else{$benchmarkSet.find('.winCon').empty().append(_this.i18.MENU_NOT_CONFIGURED+'！');}
I18n.fillArea($(ElScreenContainer));$benchmarkSet.modal();}}).always(function(){Spinner.stop();});});$('#saveBenchmarkMenu').click(function(){var $benchmarkSet=$('#benchmarkSet');if($benchmarkSet.find('.winCon ul').size()===0){$benchmarkSet.modal('hide');return false;}
var benchmarkNavChecked=$benchmarkSet.find('input.benchmarkNav:checked').map(function(){return $(this).val()}).get();var $this=$(this);var projectId=$this.attr('project-id');$this.button('loading');WebAPI.post('/admin/savePageMenu',{projectId:projectId,benchmarkList:benchmarkNavChecked}).done(function(result){if(result.success){var alert=new Alert($benchmarkSet.find('.modal-content').get(0),Alert.type.success,I18n.resource.code[result.code]);alert.showAtTop(2000);setTimeout(function(){$benchmarkSet.modal('hide');},1000);}}).always(function(){$this.button('reset');I18n.fillArea($(ElScreenContainer));});});$("#projectCon").off('click','.setPage').on('click','.setPage',function(){Spinner.spin(ElScreenContainer);var wh=$(window).height();var top=(wh-800)/2;$("#pageSet .modal-dialog").css({'top':top});var $this=$(this);var projectId=$this.data('projectid'),roleId=$this.data('roleid');WebAPI.post('/admin/loadPageMenu',{projectId:projectId,roleId:roleId}).done(function(result){if(result.success){var data=result.data,nav=data.nav,$menuTree,$pageSet=$('#pageSet');if(nav&&nav.length){$menuTree=_this.buildMenuTree(nav);$pageSet.find('.winCon').empty().append($menuTree);$pageSet.find('#savePageMenu').attr('project-id',projectId).attr('role-id',roleId);_this.renderTreeView();}else{$pageSet.find('.winCon').empty().append(_this.i18.MENU_NOT_CONFIGURED+'！');}
I18n.fillArea($(ElScreenContainer));$pageSet.modal();}}).always(function(){Spinner.stop();});});$("#pageSet").off().on("click",'input:checkbox',function(){var $this=$(this);var parent_liL=$this.parents(".parent_li").length;if(parent_liL){var $rootSpan=$this.parents(".parent_li").children("span");var $checkboxRoot=$rootSpan.find("input:checkbox");var $checkboxLeaf=$this.closest(".parent_li").find("ul").find("input:checkbox");var iL=$this.parents("label").prev("i").length;if($this.is(':checked')){if(iL){$checkboxLeaf.each(function(){this.checked=true;});$checkboxRoot.each(function(){this.checked=true;});}else{$checkboxRoot.each(function(){this.checked=true;});}}else{if(iL){$checkboxLeaf.each(function(){this.checked=false;});}}}});$('#savePageMenu').click(function(){var $pageSet=$('#pageSet');if($pageSet.find('.winCon ul').size()===0){$pageSet.modal('hide');return false;}
var allTopNavChecked=$pageSet.find('input.topNav:checked').map(function(){return $(this).val()}).get();var allFuncNavChecked=$pageSet.find('input.funcNav:checked').map(function(){return $(this).val()}).get();var $this=$(this);var projectId=$this.attr('project-id'),roleId=$this.attr('role-id');$this.button('loading');WebAPI.post('/admin/savePageMenu',{projectId:projectId,roleId:roleId,topNavList:allTopNavChecked,funcNavList:allFuncNavChecked}).done(function(result){if(result.success){var alert=new Alert($pageSet.find('.modal-content').get(0),Alert.type.success,I18n.resource.code[result.code]);alert.showAtTop(2000);setTimeout(function(){$pageSet.modal('hide');},1000);}}).always(function(){$this.button('reset');I18n.fillArea($(ElScreenContainer));});});$(window).on("resize.permissionManager",function(){_this.setPermissionManagerHeight();_this.setUserListPosition();});},detachEvents:function(){$(window).off("resize.permissionManager");},close:function(){this.detachEvents();},dropUserToRoleEvent:function(e){Spinner.spin(ElScreenContainer);e.preventDefault();var $target=$(e.target);var dragObjStr=$("#dragObj").val();if(!$target.hasClass('proList')){$target=$target.closest('.proList');}
if(dragObjStr=="user"){var data=JSON.parse(e.dataTransfer.getData("user"));}else{var data=JSON.parse(e.dataTransfer.getData("itemUser"));}
var isExisted=false;if(!data){Spinner.stop();return;}
$target.find('.userId').each(function(){if($(this).attr('userid')==data.userId){isExisted=true;Spinner.stop();return;}});if(!isExisted){var roleId=$target.attr('roleId');if(dragObjStr=="itemUser"){if(AppConfig.userId==data.userId){Spinner.stop();return false;}
var dragRoleId=data.roleid;if(roleId===dragRoleId){Spinner.stop();return false;}}
if(typeof data.userId===typeof undefined||typeof roleId===typeof undefined){Spinner.stop();return false;}
if(dragObjStr=="user"){WebAPI.post('/admin/addRoleUser',{roleId:roleId,userId:data.userId}).done(function(result){if(result.success){data.roleId=roleId;$target.find('.userList').append(beopTmpl('proUserTmpl',data));$target.find('.proUser').each(function(){this.draggable=true;this.ondragstart=function(e){var $this=$(this);var userInfo={userId:$this.attr('userid'),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser");e.dataTransfer.setData("itemUser",JSON.stringify(userInfo));};});}
return false;}).fail(function(){var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.panelManagement.REQUEST_ERROR);alert.showAtTop(2000);}).always(function(){I18n.fillArea($(ElScreenContainer));Spinner.stop();})}else{WebAPI.post('/admin/deleteRoleUser',{'roleId':dragRoleId,'userId':data.userId}).then(function(result){if(result.success){$("#permissionManage").find('.proList[roleId="'+dragRoleId+'"] .proUser[userId="'+data.userId+'"]').remove();$("#isDelUserWin").modal("hide");}
WebAPI.post('/admin/addRoleUser',{roleId:roleId,userId:data.userId}).done(function(result){if(result.success){data.roleId=roleId;$target.find('.userList').append(beopTmpl('proUserTmpl',data));$target.find('.proUser').each(function(){this.draggable=true;this.ondragstart=function(e){var $this=$(this);var userInfo={userId:$this.attr('userid'),userName:$this.find(".userName").text(),userPic:$this.find("img").attr("src"),roleid:$this.closest(".proList").attr("roleid")};$("#dragObj").val("itemUser");e.dataTransfer.setData("itemUser",JSON.stringify(userInfo));};});}
return false;}).fail(function(){var alert=new Alert(ElScreenContainer,Alert.type.danger,I18n.resource.admin.panelManagement.REQUEST_ERROR);alert.showAtTop(2000);}).always(function(){I18n.fillArea($(ElScreenContainer));Spinner.stop();})});}}},loadProjectPermission:function(){var _this=this;return WebAPI.post('/admin/loadProjectPermission',{'userId':AppConfig.userId}).done(function(result){if(result.success){_this.pageViewModel=result.data;_this.renderSelectProject();_this.renderUserList();_this.renderProjectList();_this.attachEvents();I18n.fillArea($(ElScreenContainer));}}).always(function(){Spinner.stop();})},setUserListPosition:function(){var $manageTab=$("#manageTab");$("#staffList").css({"left":$manageTab.width()+30});},renderSelectProject:function(){var compiledTemplate=beopTmpl('selectProjectListTmpl',this.pageViewModel);$('#selectProject').html(compiledTemplate)},renderUserList:function(){var compiledTemplate=beopTmpl('userListTmpl',this.pageViewModel);$('#userList').html(compiledTemplate);this.setUserListPosition();$("#staffList").show();},renderProjectList:function(){var compiledTemplate=beopTmpl('permissionManageTmpl',this.pageViewModel);$('#projectCon').html(compiledTemplate);},buildMenuTree:function(nav,template){var buildMenuTreeItem=function(item){return beopTmpl(template?template:'menuTreeItemTmpl',item);};var $html=$('<ul></ul>');for(var i=0,length=nav.length;i<length;i++){var root=nav[i];var $root=$(buildMenuTreeItem(root));$root.append(this.managerCtrl.buildSubTree(buildMenuTreeItem,root));$html.append($root);}
return $html;},renderTreeView:function(){$('.tree li:has(ul)').addClass('parent_li').find(' > span');$('.tree li.parent_li > span > i').on('click',function(e){var children=$(this).closest('li.parent_li').find(' > ul > li');if(children.is(":visible")){children.hide('fast');$(this).parent('span').find(' > i').addClass('icon-plus-sign').removeClass('icon-minus-sign');}else{children.show('fast');$(this).parent('span').find(' > i').addClass('icon-minus-sign').removeClass('icon-plus-sign');}
e.stopPropagation();});}};return ProjectPermissionManager;})();﻿var PaneProjectCreator=(function(){var util={upload:{readURL:function(ele,onSuccess,onError){var file;if(!(ele.files&&ele.files[0])){alert('上传文件出错了，请刷新页面后重试！');typeof onError==='function'&&onError(1);return false;}
if(!(window.File&&window.FileReader&&window.FileList&&window.Blob)){alert('当前浏览器不支持最新的文件接口！');typeof onError==='function'&&onError(2);return false;}
if(typeof FileReader==="undefined"){alert("当前浏览器不支持 FileReader 接口！");typeof onError==='function'&&onError(3);return false;}
file=ele.files[0];if(!(/image/i).test(file.type)){alert("当前文件不是图片，请选择正确的图片进行上传！");typeof onError==='function'&&onError(4);return false;}
var reader=new FileReader();reader.onload=onSuccess;reader.readAsDataURL(file);}}}
function PaneProjectCreator(projId){this.map=null;this.projId=projId;this.validator=null;}
PaneProjectCreator.prototype={show:function(){var _this=this;Spinner.spin(ElScreenContainer);WebAPI.get("/static/views/admin/paneProjectCreator.html").done(function(resultHtml){Spinner.stop();$(ElScreenContainer).html(resultHtml);if(_this.projId!==undefined)
$('.header','#reg-wizard').children('span').eq(0).attr('i18n','admin.projectCreator.REGIST_STEP1_TITLE_2');I18n.fillArea($('#reg-wizard').not('input, .map_wrap'));I18n.fillAreaAttribute($('.pi_left_ct').eq(0).find('input'),'placeholder');_this.init();});},init:function(){var _this=this;this.$formWrap=$('#formWrap');this.$pjCode=$('#iptPjCode',this.$formWrap);this.$pjNameZh=$('#iptPjNameZh',this.$formWrap);this.$pjNameEn=$('#iptPjNameEn',this.$formWrap);this.$pjAddr=$('#iptPjAddr',this.$formWrap);this.$pjLnglat=$('#iptPjLnglat',this.$formWrap);this.$imgPreview=$('#imgPreview');this.$pjFile=$('#iptPjFile');this.$btnSubmit=$('#btnSubmit');beop.baseMap.load(function(map){_this.map=map;_this.attachMapEvents();_this.map.addSearchBox('#btnMapSch','#mapSchPane');});this.attachEvents();this.initValidator();if(this.projId!==undefined){this.recoverForm(AppConfig.projectList.filter(function(row){return row.id===_this.projId;})[0]);}},recoverForm:function(form){var latlng;if(!form)return;this.$pjCode.val(form.name_en).prop('readonly',true);this.$pjNameZh.val(form.name_cn);this.$pjNameEn.val(form.name_english);latlng=form.latlng.split(',');this.map.trigger('click',{lnglat:this.map.getPoint(latlng[1],latlng[0])});this.$imgPreview.attr({'src':'/static/images/project_img/'+form.pic,'data-name':form.pic});},initValidator:function(){this.validator=new Validator(this.$formWrap,{elements:[{name:'pjCode',selector:this.$pjCode,rules:[{valid:'require',msg:'Project code must not be empty!'},{valid:'word',msg:'Project code should only containes letters, numbers and \'_\''},{valid:function(val){var _this=this;WebAPI.post("/proj_name/check",{proName:val}).done(function(rs){rs=JSON.parse(rs);if(rs.status==='OK'&&!rs.data.isExist){_this.success();}else{_this.fail();}});},msg:'Project code already exists!'}]},{name:'pjNameZh',selector:this.$pjNameZh,rules:[{valid:'require',msg:'Project chinese name cannot be empty!'}]},{name:'pjNameEn',selector:this.$pjNameEn,rules:[{valid:'require',msg:'Project english name cannot be empty!'},{valid:'word',msg:'Project english name should only containes letters, numbers and \'_\''}]},{name:'pjAddr',selector:this.$pjAddr,rules:[{valid:'require',msg:'Project address cannot be empty!'}]}]});},attachEvents:function(){var _this=this;var isImgUploadReady=false;this.$imgPreview.click(function(e){_this.$pjFile.click();e.preventDefault();});this.$pjFile.change(function(e){var file=$(this)[0].files[0];if(file.name.match(/\.[A-Za-z0-9]+$/)[0].toLowerCase()!=='.jpg'){isImgUploadReady=false;alert('图片格式有误，请上传正确的 .jpg 格式文件！');return;}
util.upload.readURL($(this)[0],function(e){$('#imgPreview').attr('src',e.target.result);isImgUploadReady=true;},function(errCode){isImgUploadReady=false;});e.preventDefault();});this.$btnSubmit.click(function(){var defer;if(_this.projId!==undefined)defer=_this.validator.not('pjCode').valid();else defer=_this.validator.valid();defer.then(function(form){var formData=new FormData();if(isImgUploadReady)formData.append('pro-pic-file',_this.$pjFile[0].files[0]);if(_this.projId!==undefined){formData.append('projId',_this.projId);formData.append('projCode',_this.$pjCode.val());}else{formData.append('projCode',form.pjCode);}
formData.append('userId',AppConfig.userId);formData.append('projNameZh',form.pjNameZh);formData.append('projNameEn',form.pjNameEn);formData.append('address',form.pjAddr);formData.append('latlng',_this.$pjLnglat.val());formData.append('weatherStationId',101020100);Spinner.spin($('body')[0]);$.ajax({url:'/project/create',type:'post',data:formData,dataType:'json',cache:false,contentType:false,processData:false}).done(function(rs){if(rs.status==='OK'){alert(rs.msg);window.location.reload();}else{alert('服务器正在忙碌，请稍后重试！');}}).fail(function(e){alert('服务器正在忙碌，请稍后重试！');}).always(function(e){Spinner.stop();});});});$('#cancelRegist').click(function(){ScreenManager.show(UserManagerController,ProjectPermissionManager);});},attachMapEvents:function(){var _this=this;this.map.addListener('click',function(e){var point=e.lnglat;_this.map.removeAllMarkers();_this.map.addMarker(point.lng,point.lat);_this.map.setFitView();_this.map.getAddress(point.lng,point.lat,function(rs){if(rs.status!==0)return;rs=rs.data;var components=rs[0].components;var city=components.city||components.province||rs[0].name;_this.$pjAddr.val(rs[0].name);_this.$pjLnglat.val(point.lat+','+point.lng);});});},detachEvents:function(){this.$btnSubmit.unbind();this.$pjCode.unbind();this.$pjAddr.unbind();this.$imgPreview.unbind();$('body').off();},close:function(){this.detachEvents();this.map.destroy();}}
return PaneProjectCreator;})();var PaneProjectConfigure;PaneProjectConfigure=(function(){function PaneProjectConfigure(){this.proName=undefined;this.stepCur=undefined;this.stepNext=undefined;this.stepPre=undefined;this.stepPreShow=undefined;this.stepAll=undefined;this.curPic=undefined;this.nextPic=undefined;this.prePic=undefined;this.preShowPic=undefined;this.allPic=undefined;this.initData=undefined;this.chartData=undefined;this.dataFlag=undefined;this.nameFlag=undefined;this.btnNext=undefined;this.scrollRange=undefined;this.i18=I18n.resource.admin.projectConfigure;}
PaneProjectConfigure.prototype={show:function(){var _this=this;WebAPI.get('/static/views/admin/paneProjectConfigure.html').done(function(resultHtml){$('#indexMain').html(resultHtml);_this.init();});},init:function(){this.stepCur=0;this.stepNext=-1;this.stepPre=-1;this.stepPreShow=-1;this.stepAll=4;this.curPic=0;this.nextPic=-1;this.prePic=-1;this.preShowPic=-1;this.allPic=$('.step3LiLg').length;this.dataFlag=0;this.nameFlag=0;this.btnNext=this.i18.NEXT;this.btnFinish=this.i18.FINISH;var _this=this;var windowWidth=$(window).width();if(windowWidth>1200){this.scrollRange=6;}else if(windowWidth>992){this.scrollRange=5;}else{this.scrollRange=3;this.scrollRange=3}
_this.stepInit();$('#returnMain').click(function(){ScreenManager.show(ProjectManager);});$('.configNavA').click(function(){if(!$(this).hasClass('configNavEdit')){var i=$('.configNavA').index(this);if(i>-1){_this.stepJump(i);_this.wholeJudge();}else{alert("No configNavA exist.");}}});$('#stepPre').click(function(){_this.stepMinus();});$('#stepNext').click(function(){_this.stepPlus();});$('a[data-toggle="tab"]').on('shown.bs.tab',function(e){var activeTab=$(e.target)[0].id;if(_this.stepCur==3)
_this.chartDraw();});$('#newProName').change(function(e){var $newProName=$('#newProName');if(($newProName.val()==null)||($newProName.val()==undefined)||($newProName.val()=='')){_this.dataFlag=0;}else{_this.dataFlag=1;}
if(_this.dataFlag&&_this.nameFlag){$('#configNavA4').removeClass('disabled');}else{$('#configNavA4').addClass('disabled');}});$('#newProData').change(function(e){document.getElementById('newProPath').value=this.value;_this.uploadConfigData();});$('#step2-data-delete').click(function(){_this.tableInit();});$('#step2DataDllSel').click(function(e){var arr=document.getElementsByClassName('chk-flag');for(var i=0;i<arr.length;i++){arr[i].checked=true;}});$('#step2DataReverseSel').click(function(e){var arr=document.getElementsByClassName('chk-flag');for(var i=0;i<arr.length;i++){arr[i].checked=!(arr[i].checked);}});_this.modelSelInit();_this.btnlgInit();_this.btnsmInit();_this.smallPicSelected();$('#step3BtnLgLeft').click(function(){_this.modelSelMinus();});$('#step3BtnLgRight').click(function(){_this.modelSelPlus();});$('.step3LiSm').click(function(){if($(this).attr('class')!='step3ModelSelSm'){var i=$(".step3LiSm").index(this);_this.modelSelJump(i);_this.btnlgInit();_this.smallPicSelected();}});$('#step3BtnSmLeft').click(function(){var $step3ModelNavUl=$('#step3ModelNavUl');var $step3BtnSmRight=$('#step3BtnSmRight');var leftPosition=$step3ModelNavUl.css('left');var leftPositionNum=Number(leftPosition.substring(0,(leftPosition.length-2)));leftPosition=leftPositionNum+147+'px';var bestLeftNum=-($('.step3LiSm').length-_this.scrollRange)*147;if(leftPosition=='0px'){if(!$(this).hasClass('disabled')){$(this).addClass('disabled');}}
if((leftPositionNum+147)>bestLeftNum&&$step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.removeClass('disabled');}
if($step3ModelNavUl.attr('rel')=='stop'){$step3ModelNavUl.attr('rel','moving');$step3ModelNavUl.stop();$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr('rel','stop');});}});$('#step3BtnSmRight').click(function(){var $step3ModelNavUl=$('#step3ModelNavUl');var $step3BtnSmLeft=$('#step3BtnSmLeft');var leftPosition=$step3ModelNavUl.css('left');var leftPositionNum=Number(leftPosition.substring(0,(leftPosition.length-2)));leftPosition=leftPositionNum-147+'px';var bestLeftNum=-($('.step3LiSm').length-_this.scrollRange)*147;if((leftPositionNum-147)==bestLeftNum){$(this).addClass('disabled');}
if(leftPositionNum==0&&$step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.removeClass('disabled');}
if($step3ModelNavUl.attr('rel')=='stop'){$step3ModelNavUl.attr('rel','moving');$step3ModelNavUl.stop();$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr('rel','stop');});}});},stepInit:function(){this.stepNext=this.stepCur+1;this.stepPre=this.stepAll-1;},stepPlus:function(){var $stepPre=$('#stepPre');var $stepNext=$('#stepNext');if(this.stepCur<(this.stepAll-1)){this.stepPre=this.stepCur;this.stepCur=this.stepNext;this.stepNext=this.stepCur+1;this.stepPreShow=this.stepPre;$('#configNavA'+(this.stepCur+1)).tab('show');}
$('#configNavSpan'+(this.stepPre+1)).removeClass('glyphicon-edit configNavEdit').addClass('glyphicon-check configNavComplete');$('#configNavSpan'+(this.stepCur+1)).removeClass('glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete').addClass('glyphicon-edit configNavEdit');this.wholeJudge();if(this.stepCur>0&&($stepPre.hasClass('disabled'))){$stepPre.removeClass('disabled');}
if(this.stepCur==(this.stepAll-1)){if($stepNext.text()!=this.btnFinish){$stepNext.text(this.btnFinish);}else{this.finalDataUpload();}}},stepMinus:function(){var $stepPre=$('#stepPre');var $stepNext=$('#stepNext');this.stepNext=this.stepCur;this.stepCur=this.stepPre;this.stepPre=this.stepCur-1;this.stepPreShow=this.stepNext;$('#configNavA'+(this.stepCur+1)).tab('show');$('#configNavSpan'+(this.stepNext+1)).removeClass('glyphicon-edit configNavEdit').addClass('glyphicon-check configNavComplete');$('#configNavSpan'+(this.stepCur+1)).removeClass('glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete').addClass('glyphicon-edit configNavEdit');this.wholeJudge();if(this.stepCur==0&&(!$stepPre.hasClass('disabled'))){$stepPre.addClass('disabled');}
if(this.stepCur<this.stepAll&&($stepNext.text()!=this.btnNext)){$stepNext.text(this.btnNext);}},stepJump:function(num){var $stepPre=$('#stepPre');var $stepNext=$('#stepNext');this.stepPreShow=this.stepCur;this.stepCur=num;this.stepPre=num-1;this.stepNext=num+1;$('#configNavSpan'+(this.stepPreShow+1)).removeClass('glyphicon-edit configNavEdit').addClass('glyphicon-check configNavComplete');$('#configNavSpan'+(this.stepCur+1)).removeClass('glyphicon-check glyphicon-exclamation-sign configNavErr configNavPend configNavComplete').addClass('glyphicon-edit configNavEdit');if(this.stepCur==0){$stepPre.addClass('disabled');$stepNext.text(this.btnNext);}else if(this.stepCur==(this.stepAll-1)){$stepNext.text(this.btnFinish);$stepPre.removeClass('disabled');}else{$stepPre.removeClass('disabled');$stepNext.text(this.btnNext);}},dataJudge:function(){var dataFlag=0;if((this.chartData==undefined)||(this.chartData[0].value.length==0)){$('#configNavSpan2').removeClass('glyphicon-check glyphicon-edit configNavPend configNavComplete configNavEdit').addClass('glyphicon-exclamation-sign configNavErr');dataFlag=0;}else{$('#configNavSpan2').removeClass('glyphicon-exclamation-sign configNavErr').addClass('glyphicon-check configNavComplete');dataFlag=1;}
return dataFlag;},proNameJudge:function(){var $newProName=$('#newProName');var nameFlag=0;if(($newProName.val()==null)||($newProName.val()==undefined)||($newProName.val()=='')){$('#configNavSpan1').removeClass('glyphicon-check glyphicon-edit configNavPend configNavComplete configNavEdit').addClass('glyphicon-exclamation-sign configNavErr');nameFlag=0;}else{$('#configNavSpan1').removeClass('glyphicon-exclamation-sign configNavErr').addClass('glyphicon-check configNavComplete');nameFlag=1;}
return nameFlag;},wholeJudge:function(){var $stepNext=$('#stepNext');if(this.stepPreShow==0){this.nameFlag=this.proNameJudge();}
if(this.stepPreShow==1){this.dataGet();this.dataFlag=this.dataJudge();}
if(this.dataFlag&&this.nameFlag){$stepNext.removeClass('disabled');$('#configNavA4').removeClass('disabled');}else{$('#configNavA4').addClass('disabled');if(this.stepCur==2){$stepNext.addClass('disabled');}else{$stepNext.removeClass('disabled');}}},tableInit:function(){var $initData=$('#initData');$initData.find('thead').remove();$initData.find('tr').remove();this.initData=undefined;this.chartData=undefined;},modelSelInit:function(){if(this.allPic>1){this.nextPic=this.curPic+1;this.prePic=this.allPic-1;}else if(this.allPic==1){this.nextPic=0;this.prePic=0;}
$('.step3LiLg:eq('+this.curPic+')').fadeIn().css('display','inline');},modelSelPlus:function(){var $step3LiLg=$('.step3LiLg');var $step3BtnLgLeft=$('#step3BtnLgLeft');this.preShowPic=this.curPic;this.prePic=this.curPic;this.curPic=this.nextPic;if(this.curPic<(this.allPic-1)){this.nextPic=this.curPic+1;}else if(this.curPic==(this.allPic-1)){this.nextPic=0;}
$step3LiLg.eq(this.curPic).fadeIn().css('display','inline');if(this.preShowPic!=this.curPic){$step3LiLg.eq(this.preShowPic).css('display','none');}
this.btnsmInit();this.smallPicSelected();this.smallPicScroll();if(this.curPic==(this.allPic-1)){$('#step3BtnLgRight').addClass('disabled');}
if(this.curPic>0&&$step3BtnLgLeft.hasClass('disabled')){$step3BtnLgLeft.removeClass('disabled');}},modelSelMinus:function(){var $step3LiLg=$('.step3LiLg');var $step3BtnLgRight=$('#step3BtnLgRight');this.preShowPic=this.curPic;this.nextPic=this.curPic;this.curPic=this.prePic;if(this.curPic>0){this.prePic=this.curPic-1;}else if(this.curPic==0&&this.allPic>1){this.prePic=this.allPic-1;}
$step3LiLg.eq(this.curPic).fadeIn().css('display','inline');if(this.preShowPic!=this.curPic){$step3LiLg.eq(this.preShowPic).css('display','none');}
this.btnsmInit();this.smallPicSelected();this.smallPicScroll();if(this.curPic==0){$('#step3BtnLgLeft').addClass('disabled');}
if(this.curPic<(this.allPic-1)&&$step3BtnLgRight.hasClass('disabled')){$step3BtnLgRight.removeClass('disabled');}},modelSelJump:function(num){var $step3LiLg=$('.step3LiLg');this.preShowPic=this.curPic;this.curPic=num;if(this.curPic==(this.allPic-1)){this.nextPic=0;if(this.allPic>1){this.prePic=this.curPic-1;}else if(this.allPic==1){this.prePic=0;}}else if(this.curPic==0){this.prePic=this.allPic-1;if(this.allPic>1){this.nextPic=1;}else if(this.allPic==1){this.nextPic=0;}}else{this.nextPic=this.curPic+1;this.prePic=this.curPic-1;}
$step3LiLg.eq(this.curPic).fadeIn().css('display','inline');if(this.preShowPic!=this.curPic){$step3LiLg.eq(this.preShowPic).css('display','none');}},btnlgInit:function(){var $step3BtnLgLeft=$('#step3BtnLgLeft');var $step3BtnLgRight=$('#step3BtnLgRight');if(this.allPic<2){$step3BtnLgLeft.addClass('disabled');$step3BtnLgRight.addClass('disabled');}else{if(this.curPic==0){$step3BtnLgLeft.addClass('disabled');$step3BtnLgRight.removeClass('disabled');}else if(this.curPic==(this.allPic-1)){$step3BtnLgRight.addClass('disabled');$step3BtnLgLeft.removeClass('disabled');}else{$step3BtnLgRight.removeClass('disabled');$step3BtnLgLeft.removeClass('disabled');}}},btnsmInit:function(){var $step3BtnSmLeft=$('#step3BtnSmLeft');var $step3BtnSmRight=$('#step3BtnSmRight');if(this.curPic>2&&(this.allPic-this.curPic)>4){if($step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.removeClass('disabled');}
if($step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.removeClass('disabled');}}else if(this.curPic<3){if(!$step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.addClass('disabled');}
if(this.allPic>6){if($step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.removeClass('disabled');}}else{if(!$step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.addClass('disabled');}}}else if(this.curPic>(this.allPic-4)){if(!$step3BtnSmRight.hasClass('disabled')){$step3BtnSmRight.addClass('disabled');}
if(this.allPic>6){if($step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.removeClass('disabled');}}else{if(!$step3BtnSmLeft.hasClass('disabled')){$step3BtnSmLeft.addClass('disabled');}}}},smallPicSelected:function(){var $step3LiSm=$('.step3LiSm');if(!$step3LiSm.eq(this.curPic).hasClass('step3ModelSelSm')){$step3LiSm.eq(this.curPic).addClass('step3ModelSelSm');}
if(this.preShowPic!=(-1)){if($step3LiSm.eq(this.preShowPic).hasClass('step3ModelSelSm')){$step3LiSm.eq(this.preShowPic).removeClass('step3ModelSelSm');}}},smallPicScroll:function(){var $step3ModelNavUl=$('#step3ModelNavUl');var $step3LiSm=$('.step3LiSm');if(this.curPic!=this.preShowPic){var leftPosition=0;if(this.curPic>2&&this.curPic<($step3LiSm.length-3)){leftPosition=-(this.curPic-2)*147;}else if(this.curPic>($step3LiSm.length-4)&&$step3LiSm.length>6){leftPosition=-($step3LiSm.length-this.scrollRange)*147;}
leftPosition+='px';$step3ModelNavUl.attr('rel','moving');$step3ModelNavUl.animate({left:leftPosition},200,function(){$step3ModelNavUl.attr('rel','stop');});}},uploadConfigData:function(){var _this=this;var fileObj=document.getElementById("newProData").files[0];var form=new FormData();if(this.initData!=undefined){this.tableInit();}
form.append("config-file",fileObj);var xhr=new XMLHttpRequest();xhr.onload=function(){if(xhr.readyState==4&&xhr.status==200){_this.initData=JSON.parse(xhr.responseText);new UploadConfigData(_this.initData).show();}
else{alert(this.i18.READ_DATA_FAILED);}};xhr.open('post','/get_config_data',true);xhr.send(form);},dataGet:function(){if(this.initData!=undefined){var selDateNum=$(".chkPtSel input:checked").length;var ptSelData=new Array();for(var i=0;i<this.initData.length;++i){ptSelData[i]=new Object();ptSelData[i].pointName=this.initData[i].pointName;ptSelData[i].value=new Array();}
this.proName=$('#newProName').val();var selIndex;for(var i=0;i<selDateNum;++i){selIndex=$(".chkPtSel input:checked").eq(i).closest('tr').index();for(var j=0;j<this.initData.length;++j){ptSelData[j].value.push(this.initData[j].value[selIndex]);}}
this.chartData=ptSelData;}},chartDraw:function(){var myChart1=echarts.init(document.getElementById('step4Chart1'),AppConfig.chartTheme);var myChart2=echarts.init(document.getElementById('step4Chart2'),AppConfig.chartTheme);var myChart3=echarts.init(document.getElementById('step4Chart3'),AppConfig.chartTheme);var myChart4=echarts.init(document.getElementById('step4Chart4'),AppConfig.chartTheme);var legendData=new Array();var seriesData1=new Array();var seriesData2=new Array();var xAxisData=new Array();legendData.push('2013'+this.chartData[0].pointName);legendData.push('2014'+this.chartData[0].pointName);for(var i=0;i<this.chartData[0].value.length/2;++i){xAxisData[i]=this.chartData[0].value[i].time.substr(5);}
for(var i=0;i<this.chartData[0].value.length/2;++i){seriesData1.push(this.chartData[0].value[i].value);}
for(var i=this.chartData[0].value.length/2;i<this.chartData[0].value.length;++i){seriesData2.push(this.chartData[0].value[i].value);}
var option1={backgroundColor:'rgba(0,0,0,0)',grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:'axis'},legend:{data:legendData},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:xAxisData}],yAxis:[{type:'value'}],series:[{name:'2013低温冰机',type:'line',data:seriesData1},{name:'2014低温冰机',type:'line',data:seriesData2}]};legendData=new Array();seriesData1=new Array();seriesData2=new Array();xAxisData=new Array();legendData.push('2013'+this.chartData[1].pointName);legendData.push('2014'+this.chartData[1].pointName);for(var i=0;i<this.chartData[1].value.length/2;++i){xAxisData[i]=this.chartData[1].value[i].time.substr(5);}
for(var i=0;i<this.chartData[1].value.length/2;++i){seriesData1.push(this.chartData[1].value[i].value);}
for(var i=this.chartData[1].value.length/2;i<this.chartData[1].value.length;++i){seriesData2.push(this.chartData[1].value[i].value);}
var option2={backgroundColor:'rgba(0,0,0,0)',grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:'axis'},legend:{data:legendData},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:xAxisData}],yAxis:[{type:'value'}],series:[{name:'2013低温冷冻泵',type:'line',data:seriesData1},{name:'2014低温冷冻泵',type:'line',data:seriesData2}]};legendData=new Array();seriesData1=new Array();seriesData2=new Array();xAxisData=new Array();legendData.push('2013'+this.chartData[2].pointName);legendData.push('2014'+this.chartData[2].pointName);for(var i=0;i<this.chartData[2].value.length/2;++i){xAxisData[i]=this.chartData[2].value[i].time.substr(5);}
for(var i=0;i<this.chartData[2].value.length/2;++i){seriesData1.push(this.chartData[2].value[i].value);}
for(var i=this.chartData[2].value.length/2;i<this.chartData[2].value.length;++i){seriesData2.push(this.chartData[2].value[i].value);}
var option3={backgroundColor:'rgba(0,0,0,0)',grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:'axis'},legend:{data:legendData},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:xAxisData}],yAxis:[{type:'value'}],series:[{name:'2013低冷却泵',type:'line',data:seriesData1},{name:'2014低温冷却泵',type:'line',data:seriesData2}]};legendData=new Array();seriesData1=new Array();seriesData2=new Array();xAxisData=new Array();legendData.push('2013');legendData.push('2014');var dataSum=0;for(var i=0;i<10;++i){xAxisData[i]=this.chartData[i].pointName;}
for(var i=0;i<10;++i){dataSum=0;for(var j=0;j<this.chartData[i].value.length/2;++j){if(!isNaN(parseInt(this.chartData[i].value[j].value))){dataSum=dataSum+parseInt(this.chartData[i].value[j].value);}}
seriesData1.push(dataSum);}
for(var i=0;i<10;++i){dataSum=0;for(var j=this.chartData[i].value.length/2;j<this.chartData[i].value.length;++j){if(!isNaN(parseInt(this.chartData[i].value[j].value))){dataSum=dataSum+parseInt(this.chartData[i].value[j].value);}}
seriesData2.push(dataSum);}
var option4={backgroundColor:'rgba(0,0,0,0)',grid:{x:70,y:25,x2:15,y2:25},tooltip:{trigger:'axis'},legend:{data:legendData},toolbox:{show:false},calculable:true,xAxis:[{type:'category',data:xAxisData}],yAxis:[{type:'value'}],series:[{name:'2013能效',type:'bar',data:seriesData1},{name:'2014能效',type:'bar',data:seriesData2}]};myChart1.setOption(option1);myChart2.setOption(option2);myChart3.setOption(option3);myChart4.setOption(option4);},finalDataUpload:function(){var _this=this;WebAPI.post('/project/create',{projName:this.proName,pointData:this.chartData,userName:AppConfig.account,userId:AppConfig.userId}).done(function(result){var data=JSON.parse(result);if(data.error)alert(I18n.resource.admin.projectConfigure.UPLOAD_PROJECT_FAILED);else{WebAPI.post('/project/update',{userId:AppConfig.userId}).done(function(pro_result){var proList=JSON.parse(pro_result);if(proList.error)alert(I18n.resource.admin.projectConfigure.UPDATE_FAILED);else AppConfig.projectList=proList;});new PaneProjectSelector().initProject(data,_this.proName).done(function(){ScreenManager.show(EnergyScreen);});}})}}
return PaneProjectConfigure;})();var UploadConfigData=(function(){function UploadConfigData(data){this.m_data=data;this.i18=I18n.admin.projectConfigure;}
UploadConfigData.prototype={show:function(){var _this=this;var $tbody=$('#initDataTbody');var tr;var thead;var th;var td;var jsonData=_this.m_data;if(jsonData.length&&jsonData.length>0){thead=document.getElementById('initData').createTHead();th=document.createElement('th');th.innerHTML=this.i18.SELECT;thead.appendChild(th);th=document.createElement('th');th.innerHTML=this.i18.DATE;thead.appendChild(th);for(var i=0;i<jsonData.length;++i){th=document.createElement('th');th.className='ptName';th.innerHTML=jsonData[i].pointName;thead.appendChild(th);}
for(var i=0;i<jsonData[0].value.length;i++){tr=document.createElement('tr');td=document.createElement('td');td.className='chkPtSel';td.innerHTML="<input type='checkbox' class='chk-flag' />";tr.appendChild(td);td=document.createElement('td');td.className='ptTime';td.innerHTML=jsonData[0].value[i].time;tr.appendChild(td);for(var j=0;j<jsonData.length;j++){td=document.createElement('td');td.className='ptValue';td.innerHTML=jsonData[j].value[i].value;tr.appendChild(td);}
tbody=document.createElement('tbody');$tbody.append(tr);}}else{$tbody.append("<tr><td colspan=3>"+i18.NO_DATA_READ+"</td></tr>");}}}
return UploadConfigData;})();var MenuConfigure=(function(){var static_id=0,reportType={0:'日报',1:'月报',2:'周报'},menuType={ObserverScreen:'ObserverScreen',DiagnosisScreen:'DiagnosisScreen',AnalysisScreen:'AnalysisScreen',ReportScreen:'ReportScreen',DropDownList:'DropDownList',EnergyScreen:'EnergyScreen'};function MenuItem(id,text,type,reportType,reportFolder,children,parentId){this.text=text;this.type=type;this.reportType=reportType;this.reportFolder=reportFolder;if(!children){this.children=[]}else{this.children=children;}
if(!id){this._id=this.uniqueId();}else{this._id=id;}
if(parentId){this.parent=parentId;}}
MenuItem.prototype={uniqueId:function(){return'new_'+(static_id++);}};function MenuConfigure(){this.viewModel={traverseNav:function(navCollection,id,cb){if(!id){if(cb&&typeof cb==='function'){return cb(navCollection);}else{return navCollection;}}
if(navCollection&&navCollection.length!==0){for(var m=0;m<navCollection.length;m++){var collectionItem=navCollection[m];if(collectionItem._id===id){if(cb&&typeof cb==='function'){cb(navCollection,m);}else{return collectionItem;}}else{this.traverseNav(collectionItem.children,id,cb);}}}},setNav:function(id,text,type,reportType,reportFolder){var ret={};this.traverseNav(this.nav,id,function(collection,index){if(collection&&collection.length){ret=collection[index];if(ret.type===menuType.DropDownList&&type!==menuType.DropDownList){ret.children=[];}
ret.text=text;ret.type=type;if(type===menuType.ReportScreen){ret.reportType=reportType;ret.reportFolder=reportFolder;}}});return ret;},getNav:function(id){if(!id){return{};}
var ret={};this.traverseNav(this.nav,id,function(collection,index){ret=collection[index];});return ret;},removeNav:function(id){var ret={};this.traverseNav(this.nav,id,function(collection,index){if(collection&&collection.length){ret=collection.splice(index,1);}});return ret;},clearChildren:function(id){this.traverseNav(this.nav,id,function(collection,index){collection[index].children=[]});},addNav:function(parentId,text,type,reportType,reportFolder){if(!type){return{};}
var nav=this.nav,ret={};this.traverseNav(this.nav,parentId,function(collection,index){if(!parentId){ret=new MenuItem(null,text,type,reportType,reportFolder);nav.push(ret);}else{if(collection&&collection.length&&collection[index]){if(BEOPUtil.isUndefined(collection[index].children)){collection[index].children=[];}
ret=new MenuItem(null,text,type,reportType,reportFolder,null,parentId);collection[index].children.push(ret);}}});return ret;}}}
MenuConfigure.prototype={defaultTopNavNum:8,defaultSubNavNum:10,init:function(){var _this=this;WebAPI.get('/static/views/admin/menuConfigure.html').done(function(htmlResult){$(ElScreenContainer).html(htmlResult);Spinner.spin(ElScreenContainer);WebAPI.post('/admin/menuConfigure',{userId:AppConfig.userId,projectId:AppConfig.projectId}).done(function(result){if(result.success){$.extend(_this.viewModel,result.data.firstProjectMenu);}
_this.renderProjectMenu(_this.viewModel);_this.renderProjectSelector(result.data.projects);_this.initDrag();}).always(function(){Spinner.stop();});_this.bindEvents();}).always(function(){I18n.fillArea($(ElScreenContainer));})},show:function(){$("#ulPages").empty();this.init();},close:function(){},getIndexedMenuIds:function(){var indexedIds=[],$item;$.each($('#navTop').find('li[nav-id]'),function(index,item){$item=$(item);if($item.attr('nav-id')){indexedIds.push($item.attr('nav-id'));}});return indexedIds;},getLevels:function(){},bindEvents:function(){var _this=this;var $con=$("#menuConfigure");var $topNavConfigWin=$('#menuConfigureInfo');$con.on('click','#projectSelector li',function(){var projectId=parseInt($(this).attr("project-id"));var projectName=$(this).find("a").text();var projectSrc=$(this).find("img").attr("src");Spinner.spin(ElScreenContainer);WebAPI.post('/admin/loadProjectMenu',{projectId:projectId}).done(function(result){if(result.success){$("#projectMenu").text(projectName);$("#projectName").text(projectName).attr("project-id",projectId);$("#itemMainPic").attr("src",projectSrc);AppConfig.projectId=projectId;_this.viewModel.nav=result.data.nav;_this.renderProjectMenu();}}).always(function(){Spinner.stop();});});$con.off("liShow").on("mouseover.liShow",'.itemLi',function(e){$(this).find(".menuOperation .itemEdit").show();}).on("mouseout",'.itemLi',function(e){$(this).find(".menuOperation .itemEdit").hide();});$con.off('change','select').on('change','select',function(){var $this=$(this);var val=$this.val();var $li=$this.closest('li');var $input=$li.find(".displayName");var $itemInfo=$this.next(".itemInfo");var $configDropDownDenuUl=$this.parent("li").children(".configDropDownDenuUl");if($this.hasClass("reportTypeSelect")){return;}
$li.find("input").val("").attr("draggable",true);$li.find(".itemTextContent").remove();$li.find(".itemInfo").html('<input type="text" value="" class="form-control displayName menuName" placeholder="请填入显示名称" draggable="true" />');if($this.hasClass("mainMenu")){$this.parents(".itemLi").find(".menuOperation").remove();if(val==menuType.DropDownList){$configDropDownDenuUl.html(beopTmpl('sub_nav_tmpl',_this.viewModel)).slideDown(100);$configDropDownDenuUl.find("li").attr("parent-id",$(this).parents(".itemLi").attr("nav-id"));}else{$configDropDownDenuUl.slideUp(100).html("");}}else{if(val==menuType.DropDownList){$configDropDownDenuUl.html(beopTmpl('three_nav_tmpl',_this.viewModel)).slideDown(100);$configDropDownDenuUl.find("li").attr("parent-id",$(this).parent("li").attr("nav-id"));}else{$configDropDownDenuUl.slideUp(100).html("");}}
$li.attr("draggable",true);if(!val){$li.find(".displayName").attr({"value":"","disabled":true,"placeholder":""});$itemInfo.find(".reportContent").remove();$li.attr("draggable",false);}else if(val==menuType.DropDownList){$input.attr("disabled",false).attr("draggable",false);$itemInfo.find(".reportContent").remove();}else if(val=="ReportScreen"){$input.attr("disabled",false).attr("draggable",false);$itemInfo.append(beopTmpl('operating_Report_tmpl'));}else{$input.attr("disabled",false).attr("draggable",false);$itemInfo.find(".reportContent").remove();}});$con.on('click','.itemEdit',function(){var $itemLi=$(this).parents(".itemLi");var $mainMenu=$itemLi.find(".mainMenu");var $itemInfo=$mainMenu.next(".itemInfo");var mainMenuText=$mainMenu.next('.itemInfo').find(".mainMenuText").text();var $ul=$itemLi.children(".configDropDownDenuUl");if($mainMenu.val()==menuType.DropDownList){if($ul.children("li").length>0){$ul.slideDown(100);$ul.find(".threeUL").has('li').slideDown(200);}else{$ul.html(beopTmpl('sub_nav_tmpl',_this.viewModel)).slideDown(100);$ul.find("li").attr("parent-id",$itemLi.attr("nav-id"));}
$itemLi.find(".menuOperation").html(beopTmpl('dropDown_okOrNo_tmpl'));$itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="请填入显示名称" draggable="true" />');$itemLi.find(".itemCancel").show();}else if($mainMenu.val()=='ReportScreen'){var directoryTypeText=$itemInfo.find(".directoryType").text();var reportTypeText=$itemInfo.find(".reportType").text();$itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="请填入显示名称" draggable="true" />').append(beopTmpl('operating_Report_tmpl'));$itemInfo.find(".directoryTypeInput").val(directoryTypeText).attr("originalValue",directoryTypeText);var selectVal;if(reportTypeText=="日报"){selectVal=0;}else{selectVal=1;}
$itemInfo.find(".reportTypeSelect").val(selectVal).attr("originalValue",reportTypeText);}else{$itemInfo.html('<input type="text" originalValue="'+mainMenuText+'" value="'+mainMenuText+'" class="form-control displayName menuName" placeholder="请填入显示名称" draggable="true" />');}
$itemInfo.find(".displayName").focus();$(this).remove();});$con.on('click','.itemCancel',function(){var $itemLi=$(this).parents(".itemLi");var index=$("#navTopUl>li").index($itemLi);var $li=$itemLi.find(".configDropDownDenuUl li");var dataNav=_this.viewModel.nav[index].children;$itemLi.find(".mainInfo").html(beopTmpl('itemText_Content_tmpl',{'text':_this.viewModel.nav[index].text}));$.each($li,function(indexItem,item){var $item=$(item);if(indexItem<dataNav.length){var originalSelectValue=$(item).find(".secondaryMenu").val();$item.find(".secondaryMenu").val(dataNav[indexItem].type);$item.find(".displayName").val(dataNav[indexItem].text).attr("disabled",false);if(dataNav[indexItem].type=='ReportScreen'){if(originalSelectValue!='ReportScreen'){$item.find(".itemInfo").append(beopTmpl('operating_Report_tmpl'));$item.css("width",'100%');}
$item.find(".reportTypeSelect").val(dataNav[indexItem].reportType);$item.find(".directoryTypeInput").val(dataNav[indexItem].reportFolder);}}else{$item.find(".secondaryMenu").val("");$item.find(".displayName").val("").attr({"disabled":"disabled","placeholder":""});}});$itemLi.find("ul").slideUp();$itemLi.find(".menuOperation").html(beopTmpl('item_edit_tmpl'));});var getMenuModelFromPage=function($item){return{navId:$item.attr('nav-id'),text:$item.find(".menuName").text()||$item.find('.menuName').val(),type:$item.find('.typeSelector option:selected').val(),reportFolder:$item.find('.directoryType').text()||$item.find('.directoryTypeInput').val(),reportType:$item.find('.reportTypeSelect').length?$item.find('.reportTypeSelect option:selected').val():$item.find('.reportType').attr('report-type')}};var updateMenuModel=function($item,parentId){var menuModel=getMenuModelFromPage($item);if(!menuModel.type){if(menuModel.navId){_this.viewModel.removeNav(menuModel.navId);$item.attr('nav-id','');}}else{if(menuModel.navId){_this.viewModel.setNav(menuModel.navId,menuModel.text,menuModel.type,menuModel.reportType,menuModel.reportFolder);}else{var newItem=_this.viewModel.addNav(parentId,menuModel.text,menuModel.type,menuModel.reportType,menuModel.reportFolder);$item.attr('nav-id',newItem._id);}}};$("#saveSet").click(function(){var commitFlag=true;$.each($("#navTopUl input:enabled"),function(i,inputItem){var val=$.trim($(inputItem).val());if(val==""){$(inputItem).focus();commitFlag=false;$("#errorConfigure").text("文本框不能为空！").show();return false;}});if(!commitFlag){return false;}
Spinner.spin(ElScreenContainer);$.each($("#navTopUl>li"),function(index,item){var $item=$(item);updateMenuModel($item);if($item.children(".configDropDownDenuUl").children("li").length){var $li=$item.children(".configDropDownDenuUl").children("li");$.each($li,function(indexChild,itemChild){updateMenuModel($(itemChild),$item.attr('nav-id'));if($(itemChild).children(".configDropDownDenuUl").children("li").length){var $threeli=$(itemChild).children(".configDropDownDenuUl").children("li");$.each($threeli,function(indexThreeChild,itemThreeChild){updateMenuModel($(itemThreeChild),$(itemChild).attr('nav-id'));});}});}});_this.resetViewModelNav();WebAPI.post('/admin/menuEdit',{userId:AppConfig.userId,projectId:parseInt($("#projectName").attr("project-id")),menu:_this.viewModel,indexedMenuIds:_this.getIndexedMenuIds()}).done(function(result){if(result.success){new Alert($topNavConfigWin,Alert.type.success,I18n.resource.code[result.code]).showAtTop(2000);_this.renderProjectMenu();}else{new Alert($topNavConfigWin,Alert.type.danger,I18n.resource.code[result.code]).showAtTop(2000);}
$("#errorConfigure").text("").hide();}).always(function(){_this.initDrag();Spinner.stop();});});},resetViewModelNav:function(){var _this=this;var navList=[];$.each($("#navTopUl>li"),function(index,item){var $item=$(item);if($item.attr("nav-id")!=''){for(var i=0;i<_this.viewModel.nav.length;i++){if($item.attr("nav-id")==_this.viewModel.nav[i]._id){navList.push(_this.viewModel.nav[i]);}}}});_this.viewModel.nav=navList;},resetSubViewModel:function(){var _this=this;for(var i=0;i<_this.viewModel.nav.length;i++){if(_this.viewModel.nav[i].children){var navSubList=[];var $li=$("#navTopUl>li[nav-id='"+_this.viewModel.nav[i]._id+"']").find("li");$.each($li,function(index,item){var $item=$(item);if($item.attr("nav-id")!=''){for(var j=0;j<_this.viewModel.nav[i].children.length;j++){if($item.attr("nav-id")==_this.viewModel.nav[i].children[j]._id){navSubList.push(_this.viewModel.nav[i].children[j]);}}}});_this.viewModel.nav[i].children=navSubList;}}},resetSubTwoModel:function(id_source,id_target){var _this=this;var i_source,i_target;for(var i=0;i<_this.viewModel.nav.length;i++){if(_this.viewModel.nav[i].children){if(_this.viewModel.nav[i]._id==id_source){i_source=i;continue;}
if(_this.viewModel.nav[i]._id==id_target){i_target=i;continue;}}}
var $li_target=$("#navTopUl>li[nav-id='"+id_target+"']").find("li");var targetId_list=[];for(var i=0;i<_this.viewModel.nav[i_target].children.length;i++){targetId_list.push(_this.viewModel.nav[i_target].children[i]._id);}
$.each($li_target,function(index,item){var $item=$(item);if($item.attr("nav-id")!=''){if($.inArray($item.attr("nav-id"),targetId_list)<0){for(var i=0;i<_this.viewModel.nav[i_source].children.length;i++){if(_this.viewModel.nav[i_source].children[i]._id==$item.attr("nav-id")){_this.viewModel.nav[i_source].children[i].parent=id_target;_this.viewModel.nav[i_target].children.unshift(_this.viewModel.nav[i_source].children[i]);_this.viewModel.nav[i_source].children.splice(i,1);}}}}});},initDrag:function(){var _this=this;var $navTopUl=$("#navTopUl");var $li_source;$navTopUl.find(".itemLi").each(function(){this.ondragstart=function(e){var $target=$(e.target);if(e.target.tagName.toLowerCase()=="input"){$target.draggable=true;e.preventDefault();e.stopPropagation();return false;}
var $li=$target.closest("li");var $ul_source=$li.closest("ul");var index_drag;if(!$li.children("select").val()){return;}
if(typeof($li.attr("parent-id"))!="undefined"){index_drag=$ul_source.find("li").index($li);e.dataTransfer.setData("source",'subItem');e.dataTransfer.setData("parent-id",$li.parents(".itemLi").attr("nav-id"));$li_source=$li;if(!$(this).attr("nav-id")){return;}}else{e.dataTransfer.setData("source",'mainItem');index_drag=$("#navTopUl>li").index($(this));}
e.dataTransfer.setData("index_drag",index_drag);};this.ondragover=function(e){var $li=$(e.target).closest("li");if($li.children("select").val()){$li.addClass("color_drop");};e.preventDefault();e.stopPropagation();};this.ondragleave=function(e){$("#navTopUl .color_drop").removeClass("color_drop");e.preventDefault();e.stopPropagation();};this.ondrop=function(e){var $target=$(e.target);var $li=$target.closest("li");var $ul_target=$li.closest("ul");var index_drag=parseInt(e.dataTransfer.getData("index_drag"));var index_target;$("#navTopUl .color_drop").removeClass("color_drop");$li.closest(".itemLi").removeClass("color_drop");if(typeof($li.attr("parent-id"))!="undefined"){if(e.dataTransfer.getData("source")=="mainItem"){return;}else{index_target=Number($ul_target.find("li").index($li));var parentId_source=e.dataTransfer.getData("parent-id");var parentId_target=$li.attr("parent-id");if(parentId_source==parentId_target){var $li_sub=$ul_target.find("li");if(index_drag<index_target){$li_sub.eq(index_target).after($li_sub.eq(index_drag));}else{$li_sub.eq(index_target).before($li_sub.eq(index_drag));}
_this.resetSubViewModel();}else{$ul_target.prepend($li_source.attr("parent-id",$li.attr("parent-id")));if(parentId_source){_this.resetSubTwoModel(parentId_source,$li.closest(".itemLi").attr("nav-id"));}}}}else{if(!$li.children("select").val()){return;}
if(!$(this).find(".mainMenu").val()){return;}
if(e.dataTransfer.getData("source")=="subItem"){return;}else{index_target=Number($("#navTopUl>li").index($(this)));var $li_main=$("#navTopUl>li");if(index_drag<index_target){$li_main.eq(index_target).after($li_main.eq(index_drag));}else{$li_main.eq(index_target).before($li_main.eq(index_drag));}}}};});},interactionLine:function($con,index_drag,index_target){var $li=$con.children('li');var itemList=[];for(var i=0;i<$li.length;i++){itemList.push($li[i]);}
var temp=itemList[index_target];itemList[index_target]=itemList[index_drag];itemList[index_drag]=temp;$con.empty();for(var i=0;i<itemList.length;i++){$con.append(itemList[i]);}},renderProjectMenu:function(model){if(!model){model=this.viewModel;}
var html=beopTmpl('top_nav_tmpl',{nav:model.nav,type:model.type,defaultNum:this.defaultTopNavNum,reportType:reportType});$('#navTop').empty().append(html);$.each($(".configDropDownDenuUl li"),function(index,item){var $item=$(item);$item.attr("parent-id",$item.parents(".itemLi").attr("nav-id"));});this.initDrag();},renderProjectSelector:function(projects){var html=beopTmpl('project_selector_tmpl',{projects:projects});var $projectSelector=$('#projectSelector').empty().append(html);var projectName=$projectSelector.find("li[project-id="+AppConfig.projectId+"] a").text();var projectSrc=$projectSelector.find("li[project-id="+AppConfig.projectId+"] img").attr("src");$("#projectName").text(projectName).attr("project-id",AppConfig.projectId);$("#itemMainPic").attr("src",projectSrc);$("#saveSet").show();}};return MenuConfigure;})();var BenchmarkConfigure=(function(){var static_id=0;function MenuItem(id,name,type,title,points,unit,description,desc,children,parentId){this.name=name;this.type=type;this.title=title;this.points=points;this.unit=unit;this.description=description;this.desc=isNaN(+desc)?0:(+desc);if(!children){this.children=[]}else{this.children=children;}
if(!id){this._id=this.uniqueId();}else{this._id=id;}
if(parentId){this.parent=parentId;}}
MenuItem.prototype={uniqueId:function(){return'new_'+(static_id++);}};function BenchmarkConfigure(){this.viewModel={traverseNav:function(navCollection,id,cb){if(!id){if(cb&&typeof cb==='function'){return cb(navCollection);}else{return navCollection;}}
if(navCollection&&navCollection.length!==0){for(var m=0;m<navCollection.length;m++){var collectionItem=navCollection[m];if(collectionItem._id===id){if(cb&&typeof cb==='function'){cb(navCollection,m);}else{return collectionItem;}}else{this.traverseNav(collectionItem.children,id,cb);}}}},setNav:function(id,name,type,title,points,unit,description,desc,menuId){var ret={};this.traverseNav(this.nav,id,function(collection,index){if(collection&&collection.length){ret=collection[index];ret.name=name;ret.type=type;ret.title=title;if($.isArray(points)){ret.points=points;}else{ret.points=points&&points.split&&points.split(',');}
ret.unit=unit;ret.description=description;ret.desc=isNaN(+desc)?0:(+desc);ret.menuId=menuId;}});return ret;},getNav:function(id){if(!id){return{};}
var ret={};this.traverseNav(this.nav,id,function(collection,index){ret=collection[index];});return ret;},removeNav:function(id){var ret={};this.traverseNav(this.nav,id,function(collection,index){if(collection&&collection.length){ret=collection.splice(index,1);}});return ret;},clearChildren:function(id){this.traverseNav(this.nav,id,function(collection,index){collection[index].children=[]});},addNav:function(parentId,name,type,title,points,unit,description,desc){if(!type){return{};}
var nav=this.nav,ret={};this.traverseNav(this.nav,parentId,function(collection,index){if(!parentId){ret=new MenuItem(null,name,type,title,points,unit,description,desc);nav.push(ret);}else{if(collection&&collection.length&&collection[index]){if(BEOPUtil.isUndefined(collection[index].children)){collection[index].children=[];}
ret=new MenuItem(null,name,type,title,points,unit,description,desc,null,parentId);collection[index].children.push(ret);}}});return ret;}}}
BenchmarkConfigure.prototype={defaultTopNavNum:8,defaultSubNavNum:10,init:function(){Spinner.spin(ElScreenContainer);var _this=this;WebAPI.get('/static/views/admin/benchmark/benchmarkConfigure.html').done(function(htmlResult){$(ElScreenContainer).html(htmlResult);I18n.fillArea($(ElScreenContainer));WebAPI.post('/admin/benchmarkConfigure',{userId:AppConfig.userId}).done(function(result){if(result.success){$.extend(_this.viewModel,result.data);}
_this.renderBenchmarkMenu(_this.viewModel);Spinner.stop();});_this.bindEvents();})},show:function(){$("#ulPages").empty();this.init();},close:function(){},bindEvents:function(){var _this=this;var $con=$("#benchmarkConfigure");var $topNavConfigWin=$('#benchmarkConfigureInfo');$con.on('click','.benchmarkSetMenuBtn',function(){ScreenManager.show(EnergyScreen,event.target.attributes['data-menu-id'].value);})
$con.on('click','#projectSelector li',function(){var projectId=parseInt($(this).attr("project-id"));var projectName=$(this).find("a").text();var projectSrc=$(this).find("img").attr("src");Spinner.spin(ElScreenContainer);WebAPI.post('/admin/loadProjectMenu',{projectId:projectId}).done(function(result){if(result.success){$("#projectMenu").text(projectName);$("#projectName").text(projectName).attr("project-id",projectId);$("#itemMainPic").attr("src",projectSrc);AppConfig.projectId=projectId;_this.viewModel.nav=result.data.nav;_this.renderBenchmarkMenu();}}).always(function(){Spinner.stop();});});$con.on("mouseover",'.itemLi',function(e){$(this).find(".menuOperation .subItemEdit").show();}).on("mouseout",'.itemLi',function(e){$(this).find(".menuOperation .subItemEdit").hide();});$con.off('change','select').on('change','select',function(){var $this=$(this),selectText=$this.val();$this.closest('li.itemLi').addClass('editing');if(!selectText){$this.next(".itemInfo").empty();}else{$this.next(".itemInfo").html(beopTmpl('benchmark_editing_tmpl',{nav:{}}));}});$con.on('click','.subItemEdit',function(){var $item=$(this).parents(".itemLi"),itemId=$item.attr('nav-id');var $mainMenu=$item.find(".mainMenu");var $itemInfo=$mainMenu.next(".itemInfo");var mainMenuText=$mainMenu.next('.itemInfo').find(".mainMenuText").text();var $ul=$item.find(".configDropDownDenuUl");var navModel=_this.viewModel.getNav(itemId);if($ul.find("li").length>0){$ul.slideDown(100);}else{$ul.html(beopTmpl('sub_nav_tmpl',{type:_this.viewModel.type})).slideDown(100);}
$item.find(".menuOperation").html(beopTmpl('dropDown_okOrNo_tmpl'));$itemInfo.html(beopTmpl('benchmark_editing_tmpl',{nav:navModel}));$item.addClass('editing');$(this).remove();});$con.on('click','.itemCancel',function(){var $itemLi=$(this).parents(".itemLi");var index=$("#navTopUl>li").index($itemLi);var $li=$itemLi.find(".configDropDownDenuUl li");var dataNav=_this.viewModel.nav[index].children;$itemLi.find(".mainInfo").html(beopTmpl('itemText_Content_tmpl',{'text':_this.viewModel.nav[index].text}));$.each($li,function(indexItem,item){var $item=$(item);if(indexItem<dataNav.length){var originalSelectValue=$(item).find(".secondaryMenu").val();$item.find(".secondaryMenu").val(dataNav[indexItem].type);$item.find(".displayName").val(dataNav[indexItem].text).attr("disabled",false);if(dataNav[indexItem].type=='ReportScreen'){if(originalSelectValue!='ReportScreen'){$item.find(".itemInfo").append(beopTmpl('operating_Report_tmpl'));$item.css("width",'100%');}
$item.find(".reportTypeSelect").val(dataNav[indexItem].reportType);$item.find(".directoryTypeInput").val(dataNav[indexItem].reportFolder);}}else{$item.find(".secondaryMenu").val("");$item.find(".displayName").val("").attr({"disabled":"disabled","placeholder":""});}});$itemLi.find("ul").slideUp();$itemLi.find(".menuOperation").html(beopTmpl('item_edit_tmpl'));});var getMenuModelFromPage=function($item){var model={navId:$item.attr('nav-id'),name:$item.find('.benchmark-name').val(),title:$item.find('.benchmark-title').val(),points:$item.find('.benchmark-points').val(),description:$item.find('.benchmark-description').val(),unit:$item.find('.benchmark-unit').val(),type:$item.find('.typeSelector option:selected').val(),desc:$item.find('.benchmark-desc option:selected').val(),menuId:$item.find('.benchmarkSetMenuBtn').data('menu-id')};if(model.points){model.points=model.points.split(',');}
return model;};var updateMenuModel=function($item,parentId){var menuModel=getMenuModelFromPage($item);if(!menuModel.type){if(menuModel.navId){_this.viewModel.removeNav(menuModel.navId);$item.attr('nav-id','');}}else{if(menuModel.navId){_this.viewModel.setNav(menuModel.navId,menuModel.name,menuModel.type,menuModel.title,menuModel.points,menuModel.unit,menuModel.description,menuModel.desc,menuModel.menuId);}else{var newItem=_this.viewModel.addNav(parentId,menuModel.name,menuModel.type,menuModel.title,menuModel.points,menuModel.unit,menuModel.description,menuModel.desc);$item.attr('nav-id',newItem._id);}}};$("#saveSet").click(function(){var commitFlag=true;$.each($("#navTopUl input.benchmark-name:visible:enabled"),function(i,inputItem){var val=$.trim($(inputItem).val());if(val==""){$(inputItem).focus();commitFlag=false;$("#errorConfigure").text("文本框不能为空！").show();return false;}});if(!commitFlag){return false;}
Spinner.spin(ElScreenContainer);$.each($("#navTopUl>li"),function(index,item){var $item=$(item);if(!$item.hasClass('editing')){return;}
updateMenuModel($item);if($item.find(".configDropDownDenuUl li").length){var $li=$item.find(".configDropDownDenuUl li");$.each($li,function(indexChild,itemChild){updateMenuModel($(itemChild),$item.attr('nav-id'))});}});WebAPI.post('/admin/benchmarkEdit',{userId:AppConfig.userId,menu:_this.viewModel}).done(function(result){if(result.success){new Alert($topNavConfigWin,Alert.type.success,I18n.resource.code[result.code]).showAtTop(2000);_this.viewModel.nav=result.data.nav;_this.renderBenchmarkMenu();}else{new Alert($topNavConfigWin,Alert.type.danger,I18n.resource.code[result.code]).showAtTop(2000);}
$("#errorConfigure").text("").hide();}).always(function(){Spinner.stop();});});},renderBenchmarkMenu:function(model){if(!model){model=this.viewModel;}
var html=beopTmpl('benchmark_tmpl',{nav:model.nav,type:model.type,defaultNum:this.defaultTopNavNum,reportType:this.viewModel.type});$('#navTop').empty().append(html);$.each($(".configDropDownDenuUl li"),function(index,item){var $item=$(item);$item.attr("parent-id",$item.parents(".itemLi").attr("nav-id"));});}};return BenchmarkConfigure;})();var BenchMark=(function(){var _this=undefined;function BenchMark(){_this=this;this.init();}
BenchMark.prototype={init:function(){var $benchWrap=$('#benchWrap');I18n.fillArea($benchWrap);this.attachEvent();},showModal:function(menuId){var $dialog=$('#dialogModal');var energyScreen=new EnergyScreen();var $dialogContent=$dialog.find('#dialogContent').css({height:'90%',width:'90%',margin:'auto',marginTop:'2.5%',backgroundColor:'#fff'});$dialog.off('hidden.bs.modal').on('hidden.bs.modal',function(e){$dialogContent.removeAttr('style').html('');energyScreen.workerUpdate&&energyScreen.workerUpdate.terminate();}).modal({});energyScreen.id=menuId;energyScreen.container=$dialogContent[0];energyScreen.isForBencMark=true;energyScreen.init();},close:function(){},getData:function(callbk){var data=[];for(var i in AppConfig.projectList){data.push(AppConfig.projectList[i].id);}
var $KPICt=$('#KPICt');if($KPICt[0]){$KPICt.css({opacity:'0.8'});Spinner.spin($KPICt[0]);}
$KPICt.find('.spinnerMask').css({borderRadius:'5px',backgroundColor:"rgba(170,170,170,0.5)"});WebAPI.post('/benchmark/getAll',data).done(function(result){AppConfig.benchMark=JSON.parse(result);if(AppConfig.benchMark.length>0){_this.initDom(AppConfig.benchMark);$KPICt.css({opacity:'1'});if(callbk){callbk();}}}).fail(function(){}).always(function(){Spinner.stop();});},getDataByTargetId:function(id){var find=null;var data=AppConfig.benchMark;for(var i=0,row,len=data.length;i<len;i++){row=data[i];if(row.id===id){find=row;break;}}
return find;},getMaxAndMin:function(data){var max,min;for(var i=0,len=data.length;i<len;i++){if(data[i].value===-1)continue;if(max===undefined||data[i].value>max)max=data[i].value;if(min===undefined||data[i].value<min)min=data[i].value;}
return{min:min,max:max}},initDom:function(data){var _this=this,prevRank={};var $KPICt=$('#KPICt');var $navTab=$KPICt.find('.navTab');var $targetUlCt=$('#targetUlCt');var tempDataParent=[];var tempDataChildren=[];var tempDate=[];if(!data||data.length<1)return;for(var i=0;i<data.length;i++){if(!data[i].parent){tempDataParent.push(data[i]);}else{tempDataChildren.push(data[i]);}}
tempDate=tempDataParent.concat(tempDataChildren);for(var i=0;i<tempDate.length;i++){var benchmark=tempDate[i];var $targetUl=$('<ul class="nav nav-stacked targetUl" data-angle="all">').attr('id',benchmark.id);var $liTab=undefined;if(!benchmark.parent){$liTab=$('<li role="presentation" data-target="'+benchmark.id+'" unit="'+benchmark.unit+'">').attr('menu-id',benchmark.menuId);$navTab.append($liTab);}else{var isParentExist=findParent(benchmark.parent);if(!isParentExist){continue;}
var $parentLi=$('.rows[parent-id="'+benchmark.parent+'"]');if($parentLi.length<1){$parentLi=$('<li class="rows">').attr('parent-id',benchmark.parent);var $prevLi=$('[data-target="'+benchmark.parent+'"]');$prevLi.after($parentLi);}
var $liTab=$('<div class="subRows" unit="'+benchmark.unit+'">').attr('data-target',benchmark.id).attr('menu-id',benchmark.menuId);$parentLi.append($liTab)}
$liTab.click(function(){var _that=this;var targetId=$(this).attr('data-target');var data=_this.getDataByTargetId(targetId);var maxmin=_this.getMaxAndMin(data.list);var options={range:{min:maxmin.min,max:maxmin.max}};options.colors=data.desc===0?['#87E034','#EDE24C','#F53F52']:['#F53F52','#EDE24C','#87E034'];_this.dataRangeCtrl.setOptions(options);_this.dataRangeCtrl.initMarkers(data.list);_this.dataRangeCtrl.show();$navTab.find('.selected').removeClass('selected').children('.glyphicon').remove();var $play=$('<span class="glyphicon glyphicon-play"></span>');$(this).addClass('selected').append($play);var unit=$(this).attr('unit');$('#spanUnit span').html(unit!=''?unit:'--');$('#btnViewDetail').off('click').click(function(){ScreenModal=new BenchMark(_this);ScreenModal.showModal($(_that).attr('menu-id'));});}).prepend('<span class="KPIName" title="'+benchmark.name+'">'+benchmark.name+'</span>');for(var j in benchmark.list){var rank={};var project=benchmark.list[j];var projectName=getNameByProjectId(project.projectId);var value='--';if(j>0&&project.value==benchmark.list[j-1].value){rank=prevRank;}else{rank=getRank(j)}
if(project.value!=-1){value=project.value.toFixed(2);}
var $orderItem=$('<li class="item" project-id="'+project.projectId+'" style="top:'+(j*35.5)+'px" index="'+rank.index+'"><span class="trophy"></span><span class="rank">'+rank.order+'</span><span class="name" title="'+projectName+'">'+projectName+'</span><span class="value">'+value+'</span></li>');$targetUl.append($orderItem);}
$targetUlCt.append($targetUl);}
$navTab.children('li:eq(0)').addClass('selected').append($('<span class="glyphicon glyphicon-play" style="-webkit-transform: rotate(-180deg) scaleX(0.8);">'));$targetUlCt.children('ul:eq(0)').show();$navTab.children('li:eq(0)').trigger('click');$('#benchTop').show();$navTab.find('[data-target]').wheelmenu({trigger:"click",animation:"fade",animationSpeed:"fast"});if($('#ulPages').children('li').length>0){_this.renderOrder();}
function getRank(i){var rank={};i=parseInt(i);switch(i){case 0:rank.order='1st';rank.index=1;break;case 1:rank.order='2st';rank.index=2;break;case 2:rank.order='3st';rank.index=3;break;default:rank.order=(i+1)+'th';rank.index=i+1;break;}
prevRank=rank;return rank;}
function getNameByProjectId(id){var name=undefined;for(var i in AppConfig.projectList){if(AppConfig.projectList[i].id==id){if(I18n.type=='zh'){name=AppConfig.projectList[i].name_cn;}else if(I18n.type=='en'){name=AppConfig.projectList[i].name_english;}}}
return name;}
function findParent(parent){for(var i in AppConfig.benchMark){var benchmark=AppConfig.benchMark[i];if(benchmark.id==parent){if(!benchmark.parent){if($navTab.find('[data-target="'+benchmark.id+'"]').length==1){return true;}else{return false;}}else{findParent(benchmark.parent);}}}
return false;}},attachEvent:function(){var $btnViewKPI=$('#btnViewKPI');var $KPICt=$('#KPICt');$btnViewKPI.off('click').click(function(){if(!AppConfig.benchMark||AppConfig.benchMark.length==0){_this.getData();}else if($('.navTab').children('li').length<1){_this.initDom(AppConfig.benchMark);}
$btnViewKPI.children('.arrow').toggle();$btnViewKPI.children('.glyphicon').toggleClass('glyphicon-star-empty');$KPICt.toggle();});},refresh:function(){var $navTab=$('.navTab');$('.selectedProj').removeClass('selectedProj');$navTab.find('.order').remove();if($navTab.children('li').length<1){if(AppConfig.benchMark&&AppConfig.benchMark.length>0){_this.initDom(AppConfig.benchMark);_this.renderOrder();}}else{_this.renderOrder();}},renderOrder:function(){var $navTab=$('.navTab');var $list=$('.targetUl [project-id="'+AppConfig.projectId+'"]').addClass('selectedProj');$list.each(function(){var id=$(this).parent().attr('id');var $all=$(this).closest('.targetUl').children('li');var index=$(this).attr('index');var len=$all.length;var $index=$('<span class="rankIndex">').html(index).css({color:'#FFCC00'});var $len=$('<span class="rankLen">').html('/'+len);var $order=$('<span class="order"></span>').append($index).append($len);$navTab.find('[data-target="'+id+'"]').prepend($order);});$navTab.find('[data-target]').each(function(){var target=$(this).attr('data-target');if($.inArray(target,AppConfig.projectBenchmark)<0){$(this).hide();}else{$(this).show();}});},addDataRangeCtrl:function(ctrl){this.dataRangeCtrl=ctrl;}}
return BenchMark;})();!function($){var defaults={trigger:"click",animation:"fade",angle:[0,360],animationSpeed:"medium"};$.fn.flyIn=function(el,button,width,height,angle,step,radius,settings){var d=0;this.stop(true,true);this.each(function(index){angle=(settings.angle[0]+(step*index))*(Math.PI/180);var x=Math.round(width/2+radius*Math.cos(angle)-$(this).find("a").outerWidth()/2),y=Math.round(height/2+radius*Math.sin(angle)-$(this).find("a").outerHeight()/2);$(this).animateRotate(360).css({position:'absolute',opacity:0,left:"50%",top:"50%",marginLeft:"-"+$(this).outerWidth()/2,marginTop:"-"+$(this).outerHeight()/2}).delay(d).animate({opacity:1,left:x+'px',top:y+'px'},settings.animationSpeed[1]);d+=settings.animationSpeed[0];});}
$.fn.flyOut=function(el,button){var d=0;this.stop(true,true);$(this.get().reverse()).each(function(){$(this).animateRotate(-360).delay(d).animate({opacity:0,left:el.outerWidth()/2+"px",top:el.outerHeight()/2+"px"},150);d+=15;}).promise().done(function(){el.removeClass("active").css("visibility","hidden").hide();button.removeClass("active")});}
$.fn.fadeInIcon=function(el,button,width,height,angle,step,radius,settings){var d=0;el.siblings('.targetUl').hide();this.stop(true,true);this.each(function(index){$(this).css({position:'absolute',opacity:0}).delay(d).animate({opacity:1},settings.animationSpeed[1]);d+=settings.animationSpeed[0];});}
$.fn.fadeOutIcon=function(el,button){button.removeClass("active");}
$.fn.hideIcon=function(button,settings){var fields=this.find(".item"),el=this;switch(settings.animation){case'fade':fields.fadeOutIcon(el,button)
break;case'fly':fields.flyOut(el,button)
break;}}
$.fn.showIcon=function(button,settings){var el=this,zindex='6';if(settings.trigger=="hover"){zindex='3';}
button.addClass("active").css({'z-index':zindex});el.show();el.addClass("wheel active").css("visibility","visible").show();if(el.attr('data-angle')){settings.angle=el.attr('data-angle')}
settings=predefineAngle(settings);var radius=el.width()/2,fields=el.find(".item"),container=el,width=container.innerWidth(),height=container.innerHeight(),angle=0,step=(settings.angle[1]-settings.angle[0])/fields.length;switch(settings.animation){case'fade':fields.fadeInIcon(el,button,width,height,angle,step,radius,settings)
break;case'fly':fields.flyIn(el,button,width,height,angle,step,radius,settings)
break;}}
function predefineAngle(settings){var convert=false
if($.type(settings.angle)=="string"){try{if(eval(settings.angle).length>1)convert=true}
catch(err){convert=false}
if(convert==true){settings.angle=JSON.parse(settings.angle);}else{switch(settings.angle){case'N':settings.angle=[180,380]
break;case'NE':settings.angle=[270,380]
break;case'E':settings.angle=[270,470]
break;case'SE':settings.angle=[360,470]
break;case'S':settings.angle=[360,560]
break;case'SW':settings.angle=[90,200]
break;case'W':settings.angle=[90,290]
break;case'NW':settings.angle=[180,290]
break;case'all':settings.angle=[0,360]
break;}}}
return settings;}
function predefineSpeed(settings){if($.type(settings.animationSpeed)=="string"){switch(settings.animationSpeed){case'slow':settings.animationSpeed=[75,700]
break;case'medium':settings.animationSpeed=[50,500]
break;case'fast':settings.animationSpeed=[25,250]
break;case'instant':settings.animationSpeed=[0,0]
break;}}
return settings;}
$.fn.wheelmenu=function(options){var settings=$.extend({},defaults,options);settings=predefineSpeed(settings);return this.each(function(){var button=$(this)
var el=$('#'+$(this).attr("data-target"));el.addClass("wheel");button.css("opacity",0).animate({opacity:1})
if(settings.trigger=="hover"){button.bind({mouseenter:function(){el.showIcon(button,settings);}});button.bind({mouseleave:function(){el.hideIcon(button,settings);}});}else{button.click(function(){if(el.css('display')!='none'){el.hideIcon(button,settings);}else{el.showIcon(button,settings);}});}});}}(window.jQuery);var theme={};theme.Dark={backgroundColor:'transparent',color:['#FE8463','#FAD860','#60C0DD','#0084C6','#D7504B','#C6E579','#26C0C0','#F0805A','#F4E001','#B5C334'],title:{textStyle:{fontWeight:'normal',color:'#fff'}},legend:{textStyle:{color:'#ccc'}},dataRange:{itemWidth:15,color:['#FFF808','#21BCF9'],textStyle:{color:'#ccc'}},toolbox:{color:['#fff','#fff','#fff','#fff'],effectiveColor:'#FE8463',disableColor:'#666'},tooltip:{backgroundColor:'rgba(250,250,250,0.9)',axisPointer:{type:'line',lineStyle:{color:'#aaa'},crossStyle:{color:'#aaa'},shadowStyle:{color:'rgba(200,200,200,0.2)'}},textStyle:{color:'#333'}},dataZoom:{dataBackgroundColor:'#555',fillerColor:'rgba(200,200,200,0.2)',handleColor:'#eee'},grid:{borderWidth:0},categoryAxis:{axisLine:{show:false},axisTick:{show:false},axisLabel:{textStyle:{color:'#ccc'}},splitLine:{show:false}},valueAxis:{axisLine:{lineStyle:{color:'rgba(217,237,247,0.3)'}},axisTick:{show:false},axisLabel:{textStyle:{color:'#ccc'}},splitLine:{lineStyle:{color:['rgba(100,100,100,0.3)'],type:'solid'}},splitArea:{show:false}},polar:{name:{textStyle:{color:'#ccc'}},axisLine:{lineStyle:{color:'#ddd'}},splitArea:{show:true,areaStyle:{color:['rgba(250,250,250,0.2)','rgba(200,200,200,0.2)']}},splitLine:{lineStyle:{color:'#ddd'}}},timeline:{label:{textStyle:{color:'#ccc'}},lineStyle:{color:'#aaa'},controlStyle:{normal:{color:'#fff'},emphasis:{color:'#FE8463'}},symbolSize:3},line:{smooth:true},k:{itemStyle:{normal:{color:'#FE8463',color0:'#9BCA63',lineStyle:{width:1,color:'#FE8463',color0:'#9BCA63'}}}},radar:{symbol:'emptyCircle',symbolSize:3},pie:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(255, 255, 255, 0.5)'},emphasis:{borderWidth:1,borderColor:'rgba(255, 255, 255, 1)'}}},map:{itemStyle:{normal:{borderColor:'rgba(255, 255, 255, 0.5)',areaStyle:{color:'#ddd'},label:{textStyle:{}}},emphasis:{areaStyle:{color:'#FE8463'},label:{textStyle:{}}}}},force:{itemStyle:{normal:{linkStyle:{color:'#fff'}}}},chord:{itemStyle:{normal:{borderWidth:1,borderColor:'rgba(228, 228, 228, 0.2)',chordStyle:{lineStyle:{color:'rgba(228, 228, 228, 0.2)'}}},emphasis:{borderWidth:1,borderColor:'rgba(228, 228, 228, 0.9)',chordStyle:{lineStyle:{color:'rgba(228, 228, 228, 0.9)'}}}}},gauge:{axisLine:{show:true,lineStyle:{color:[[0.2,'#9BCA63'],[0.8,'#60C0DD'],[1,'#D7504B']],width:3}},axisTick:{length:15,lineStyle:{color:'auto'}},axisLabel:{textStyle:{fontWeight:'bolder',color:'#fff'}},splitLine:{length:25,lineStyle:{width:3,color:'#fff'}},pointer:{},title:{textStyle:{fontWeight:'bolder',fontStyle:'italic',color:'#fff'}},detail:{offsetCenter:[0,'50%'],textStyle:{color:'#fff'}}},funnel:{itemStyle:{normal:{borderColor:'rgba(255, 255, 255, 0.5)',borderWidth:1},emphasis:{borderColor:'rgba(255, 255, 255, 1)',borderWidth:1}}},textStyle:{fontFamily:'Microsoft YaHei, Arial, Verdana, sans-serif'}};