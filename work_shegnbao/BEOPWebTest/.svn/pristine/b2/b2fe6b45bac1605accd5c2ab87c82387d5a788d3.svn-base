/**
 * Created by vicky on 2016/11/3.
 */

var Spinner = new LoadingSpinner({ color: '#00FFFF' });
class BillManageScreen {
    constructor(screen) {
        this.screen = screen;
        this.data = [{
                projId: 'xxx12312',
                page: [{
                        id: 'elec12312',
                        title: 'Electricity',
                        content: {
                            serviceInfo: [{
                                    name: 'Account Num',
                                    value: '014102326923'
                                },
                                {
                                    name: 'Account Name',
                                    value: 'Peter'
                                },
                                {
                                    name: 'Address',
                                    value: '321 MAIN STREET ANYWHERE,TX,54321'
                                },
                                {
                                    name: 'Rate Class',
                                    value: 'Residential'
                                }
                            ],
                            billSummary: [{
                                    name: 'Bill Date',
                                    value: '10/26/16'
                                },
                                {
                                    name: 'Bill Period',
                                    value: '09/27/16 - 10/26/16'
                                },
                                {
                                    name: 'Consumption',
                                    value: '10,642kW.h'
                                },
                                {
                                    name: 'Due Date',
                                    value: '11/16/16'
                                },
                                {
                                    name: 'Total Amount',
                                    value: 774.73
                                }
                            ],
                            billDetail: [{
                                    name: 'Basic Charge',
                                    value: 3.71
                                },
                                {
                                    name: 'Usage Charge',
                                    value: [{
                                        name: 'step1',
                                        value: 39.78
                                    }, {
                                        name: 'step2',
                                        value: 719.34
                                    }]
                                },
                                {
                                    name: 'Rate Rider at 0.5%',
                                    value: '3.81'
                                },
                                {
                                    name: 'Innovative Clean Energy Fund Levy at 0.4%',
                                    value: 3.05
                                },
                                {
                                    name: 'Regional transit levy',
                                    value: 1.87
                                },
                                {
                                    name: '*GST',
                                    value: 3.71
                                }
                            ],
                            ReadingInfo: [
                                [{
                                        name: 'ServicePeriod',
                                        value: '08/27/16 - 09/26/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '17,738kW.h of electricity'
                                    },
                                    {
                                        name: 'Amount',
                                        value: '1,102.35'
                                    }
                                ],
                                [{
                                        name: 'ServicePeriod',
                                        value: '07/27/16 - 08/26/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '22,591kW.h of electricity'
                                    },
                                    {
                                        name: 'Amount',
                                        value: '1,762.68'
                                    }
                                ]
                            ]
                        }
                    },
                    {
                        id: 'water12312',
                        title: 'Water',
                        content: {
                            serviceInfo: [{
                                    name: 'Account Num',
                                    value: '006000113859'
                                },
                                {
                                    name: 'Account Name',
                                    value: 'Peter'
                                },
                                {
                                    name: 'Address',
                                    value: '321 MAIN STREET ANYWHERE,TX,54321'
                                },
                                {
                                    name: 'Rate Class',
                                    value: 'Residential'
                                }
                            ],
                            billSummary: [{
                                    name: 'Bill Date',
                                    value: '10/15/16'
                                },
                                {
                                    name: 'Bill Period',
                                    value: '09/16/16 - 10/15/16'
                                },
                                {
                                    name: 'Consumption',
                                    value: '70,225gal'
                                },
                                {
                                    name: 'Due Date',
                                    value: '11/05/16'
                                },
                                {
                                    name: 'Total Amount',
                                    value: 757.22
                                }
                            ],
                            billDetail: [{
                                    name: 'Water',
                                    value: 659.35
                                },
                                {
                                    name: 'Sewage',
                                    value: 48.56
                                },
                                {
                                    name: 'Garbage',
                                    value: 36,
                                },
                                {
                                    name: 'Act903',
                                    value: 2.17
                                },
                                {
                                    name: 'SalesTax',
                                    value: 11.19
                                }
                            ],
                            ReadingInfo: [
                                [{
                                        name: 'ServicePeriod',
                                        value: '08/16/16 - 09/15/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '91,682 gallons of water'
                                    },
                                    {
                                        name: 'Amount',
                                        value: 962.84
                                    }
                                ],
                                [{
                                        name: 'Service Period',
                                        value: '07/16/16 - 08/15/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '116,657 gallons of water'
                                    },
                                    {
                                        name: 'Amount',
                                        value: '1,215.16'
                                    }
                                ]
                            ]
                        }
                    },
                    {
                        id: 'gas12312',
                        title: 'Natural Gas',
                        content: {
                            serviceInfo: [{
                                    name: 'Account Num',
                                    value: 2358171749
                                },
                                {
                                    name: 'Account Name',
                                    value: 'Peter'
                                },
                                {
                                    name: 'Address',
                                    value: '321 MAIN STREET ANYWHERE,TX,54321'
                                },
                                {
                                    name: 'Rate Class',
                                    value: 'Residential'
                                }
                            ],
                            billSummary: [{
                                    name: 'Bill Date',
                                    value: '10/15/16'
                                },
                                {
                                    name: 'Bill Period',
                                    value: '09/16/16 - 10/15/16'
                                },
                                {
                                    name: 'Consumption',
                                    value: '10,220cf'
                                },
                                {
                                    name: 'Due Date',
                                    value: '11/05/16'
                                },
                                {
                                    name: 'Total Amount',
                                    value: 852.18
                                }
                            ],
                            billDetail: [{
                                    name: 'Customer Charge',
                                    value: 34.67
                                },
                                {
                                    name: 'Delivery Charge',
                                    value: 348.37
                                },
                                {
                                    name: 'BGSS',
                                    value: 469.14
                                }
                            ],
                            ReadingInfo: [
                                [{
                                        name: 'Service Period',
                                        value: '08/16/16 - 09/15/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '7,935cf of natural gas'
                                    },
                                    {
                                        name: 'Amount',
                                        value: 611.27
                                    }
                                ],
                                [{
                                        name: 'ServicePeriod',
                                        value: '07/16/16 - 08/15/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '6,047cf of natural gas'
                                    },
                                    {
                                        name: 'Amount',
                                        value: 521.45
                                    }
                                ]
                            ]
                        }
                    }
                ]
            },
            {
                projId: 'xxx12313',
                page: [{
                        id: 'elec12313',
                        title: 'Electricity',
                        content: {
                            serviceInfo: [{
                                    name: 'Account Num',
                                    value: 180060330524
                                },
                                {
                                    name: 'Account Name',
                                    value: 'Michele'
                                },
                                {
                                    name: 'Address',
                                    value: '2613 EVERGREEN AV B'
                                },
                                {
                                    name: 'Rate Class',
                                    value: 'Residential'
                                }
                            ],
                            billSummary: [{
                                    name: 'Bill Date',
                                    value: '10/26/16'
                                },
                                {
                                    name: 'Bill Period',
                                    value: '09/27/16 - 10/26/16'
                                },
                                {
                                    name: 'Consumption',
                                    value: '10,642kW.h'
                                },
                                {
                                    name: 'Due Date',
                                    value: '11/16/16'
                                },
                                {
                                    name: 'Total Amount',
                                    value: 774.73
                                }
                            ],
                            billDetail: [{
                                    name: 'Basic Charge',
                                    value: 3.71
                                },
                                {
                                    name: 'Usage Charge',
                                    value: [{
                                        name: 'step1',
                                        value: 39.78
                                    }, {
                                        name: 'step2',
                                        value: 719.34
                                    }]
                                },
                                {
                                    name: 'Rate Rider at 0.5%',
                                    value: '3.81'
                                },
                                {
                                    name: 'Innovative Clean Energy Fund Levy at 0.4%',
                                    value: 3.05
                                },
                                {
                                    name: 'Regional transit levy',
                                    value: 1.87
                                },
                                {
                                    name: '*GST',
                                    value: 3.71
                                }
                            ],
                            ReadingInfo: [
                                [{
                                        name: 'ServicePeriod',
                                        value: '08/27/16 - 09/26/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '17,738kWh of electricity'
                                    },
                                    {
                                        name: 'Amount',
                                        value: '1,102.35'
                                    }
                                ],
                                [{
                                        name: 'ServicePeriod',
                                        value: '06/27/16 - 07/26/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '22,591kWh of electricity'
                                    },
                                    {
                                        name: 'Amount',
                                        value: '1,762.68'
                                    }
                                ]
                            ]
                        }
                    },
                    {
                        id: 'water12313',
                        title: 'Water',
                        content: {
                            serviceInfo: [{
                                    name: 'Account Num',
                                    value: '006000113859'
                                },
                                {
                                    name: 'Account Name',
                                    value: 'Michele'
                                },
                                {
                                    name: 'Address',
                                    value: '321 MAIN STREET ANYWHERE,TX,54321'
                                },
                                {
                                    name: 'Rate Class',
                                    value: 'Residential'
                                }
                            ],
                            billSummary: [{
                                    name: 'Bill Date',
                                    value: '10/15/16'
                                },
                                {
                                    name: 'Bill Period',
                                    value: '09/16/16 - 10/15/16'
                                },
                                {
                                    name: 'Consumption',
                                    value: '70,225gal'
                                },
                                {
                                    name: 'Due Date',
                                    value: '11/05/16'
                                },
                                {
                                    name: 'Total Amount',
                                    value: 757.22
                                }
                            ],
                            billDetail: [{
                                    name: 'Water',
                                    value: 659.35
                                },
                                {
                                    name: 'Sewage',
                                    value: 48.56
                                },
                                {
                                    name: 'Garbage',
                                    value: 36,
                                },
                                {
                                    name: 'Act903',
                                    value: 2.17
                                },
                                {
                                    name: 'SalesTax',
                                    value: 11.19
                                }
                            ],
                            ReadingInfo: [
                                [{
                                        name: 'ServicePeriod',
                                        value: '08/16/16 - 09/15/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '91,682 gallons of water'
                                    },
                                    {
                                        name: 'Amount',
                                        value: 962.84
                                    }
                                ],
                                [{
                                        name: 'Service Period',
                                        value: '07/16/16 - 08/15/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '116,657 gallons of water'
                                    },
                                    {
                                        name: 'Amount',
                                        value: '1,215.16'
                                    }
                                ]
                            ]
                        }
                    },
                    {
                        id: 'gas12313',
                        title: 'Natural Gas',
                        content: {
                            serviceInfo: [{
                                    name: 'Account Num',
                                    value: 2358171749
                                },
                                {
                                    name: 'Account Name',
                                    value: 'Michele'
                                },
                                {
                                    name: 'Address',
                                    value: '321 MAIN STREET ANYWHERE,TX,54321'
                                },
                                {
                                    name: 'Rate Class',
                                    value: 'Residential'
                                }
                            ],
                            billSummary: [{
                                    name: 'Bill Date',
                                    value: '10/15/16'
                                },
                                {
                                    name: 'Bill Period',
                                    value: '09/16/16 - 10/15/16'
                                },
                                {
                                    name: 'Consumption',
                                    value: '10,220cf'
                                },
                                {
                                    name: 'Due Date',
                                    value: '11/05/16'
                                },
                                {
                                    name: 'Total Amount',
                                    value: 852.18
                                }
                            ],
                            billDetail: [{
                                    name: 'Customer Charge',
                                    value: 34.67
                                },
                                {
                                    name: 'Delivery Charge',
                                    value: 348.37
                                },
                                {
                                    name: 'BGSS',
                                    value: 469.14
                                }
                            ],
                            ReadingInfo: [
                                [{
                                        name: 'Service Period',
                                        value: '08/16/16 - 09/15/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '7,935cf of natural gas'
                                    },
                                    {
                                        name: 'Amount',
                                        value: 611.27
                                    }
                                ],
                                [{
                                        name: 'ServicePeriod',
                                        value: '07/16/16 - 08/15/16'
                                    },
                                    {
                                        name: 'Descripition',
                                        value: '6,047cf of natural gas'
                                    },
                                    {
                                        name: 'Amount',
                                        value: 521.45
                                    }
                                ]
                            ]
                        }
                    }
                ]
            }
        ];
        this.currentProjectData = null;
    }

    show(ids) {
        this.container = $(this.screen.ctn).find(".panelBmModule");
        this.init(ids[0]);
    }

    init(projId) {
        var _this = this;
        var newDate = new Date().format("yyyy-MM-dd");

        WebAPI.get('static/app/Bill/views/screens/billManageScreen.html').done(function(result) {
            $(_this.container).html(result);
            $(".billManagePanel .form_datetime").val(newDate);
            // 无需升级
            $(".billManagePanel .form_datetime").datetimepicker({
                format: 'yyyy-mm-dd',
                minView: 'month',
                autoclose: true
            });
            _this.initTitle(projId);
            _this.attachEvent();
            $(_this.container).find(".reportListName").eq(0).trigger('click');
        });
    }

    initTitle(projId) {
        var $titlesCtn = $(this.container).find(".repotChapList");
        for (var j = 0, jLen = this.data.length; j < jLen; j++) {
            if (projId === this.data[j].projId) {
                this.currentProjectData = this.data[j];
                for (var i = 0, len = this.data[j].page.length; i < len; i++) {
                    let str = '<li class="reportListName" title="' + this.data[j].page[i].title + '" data-id="' + this.data[j].page[i].id + '">\
		    						<img src="/static/app/WebFactory/themes/default/images/down.svg">\
		    						<a class="report-item selected">' + this.data[j].page[i].title + '</a>\
		    					</li>';
                    if (i === 0) {
                        $titlesCtn.append($(str).addClass("in"));
                    } else {
                        $titlesCtn.append($(str));
                    }
                }
                return
            }
        }
        //只有两组数据 没有数据的项目名过来 默认使用第一组数据的  将来会删掉的 
        if ($(this.container).find(".reportListName").length === 0) {
            projId = 'xxx12312';
            this.initTitle(projId);
        }
    }

    initContent(pageId) {
        var allPageDate = this.currentProjectData.page;
        var rightCtn = $(this.container).find(".rightCtn");
        for (var i = 0, len = allPageDate.length; i < len; i++) {
            if (pageId === allPageDate[i].id) {
                let currentPageDate = allPageDate[i].content;

                let serviceInfo = currentPageDate.serviceInfo;
                let billSummary = currentPageDate.billSummary;
                let billDetail = currentPageDate.billDetail;
                let readingInfo = currentPageDate.ReadingInfo;
                let strTabel = (function(readingInfo) {
                    var headStr = '';
                    var bodyStr = '';
                    for (var i = 0, len = readingInfo.length; i < len; i++) {
                        var trStr = ''
                        for (var j = 0, jLen = readingInfo[i].length; j < jLen; j++) {
                            if (i === 0) {
                                headStr += '<th>' + readingInfo[0][j].name + '</th>';
                            }
                            trStr += '<td>' + readingInfo[i][j].value + '</td>';
                        }
                        bodyStr += '<tr>' + trStr + '</tr>';
                    }
                    var realStr = `<thead><tr>${ headStr }</tr></thead><tbody><tr>${ bodyStr }</tr></tbody>`;
                    return realStr;
                })(readingInfo);

                let content = `<div class="summary">
									<table>
										<tr>
											<td>${serviceInfo[0].name}</td>
											<td>${billSummary[0].name}</td>
											<td>${billSummary[4].name}</td>
										</tr>
										<tr>
											<td class="accouneNum">${ serviceInfo[0].value }</td>
											<td class="billDate">${ billSummary[0].value }</td>
											<td class="balanceDue" style="color:rgb(0,151,0)">$${ billSummary[4].value }</td>
										</tr>
									</table>
								</div>
								<div class="serviceInfo billManageContainer">
									<h4>Service Information</h4>
									<table>${ createTable(serviceInfo, 'service') }</table>
								</div>
								<div class="billSummary billManageContainer">
									<h4>Billing Summary</h4>
									<table>${ createTable(billSummary, 'billSummary') }</table>
								</div>
								<div class="billDetail billManageContainer">
									<h4>Billing Details</h4>
									<table>${ createTable(billDetail, 'billDetail') }</table>
								</div>
								<div class="readingInfo billManageContainer">
									<h2>Total</h2>
									<h4>Meter Reading Information</h4>
									<table>${ strTabel }</table>
								</div>`;
                rightCtn.html(content);

                function createTable(info, type) {
                    var name = type === 'billDetail' ? 'Current Charges' : 'Name';
                    var value = type === 'billDetail' ? 'Amount' : 'Information';
                    var bodyStr = '';
                    for (var i = 0, len = info.length; i < len; i++) {
                        if (type === 'billDetail' && typeof(info[i].value) === 'object') {
                            bodyStr += '<tr><td>' + info[i].name + ':</td><td></td></tr>';
                            for (var j = 0, jLen = info[i].value.length; j < jLen; j++) {
                                bodyStr += '<tr><td style="padding-left:50px;">' + info[i].value[j].name + '</td><td>' + info[i].value[j].value + '</td></tr>';
                            }
                        } else {
                            bodyStr += '<tr><td>' + info[i].name + '</td><td>' + info[i].value + '</td></tr>';
                        }
                    }
                    var realStr = `<thead>
										<tr>
											<th>${ name }</th>
											<th>${ value }</th>
										</tr>
									</thead>
									<tbody>
										<tr>${ bodyStr }</tr>
									</tbody>`;
                    return realStr;
                }
            }
        }
    }

    attachEvent() {
        var $reportList = $(this.container).find(".reportListName");
        var _this = this;
        //章节替换
        $reportList.off("click").on("click", function() {
                $reportList.removeClass("in");
                $reportList.find("img").attr("src", "/static/app/WebFactory/themes/default/images/left.svg");

                $(this).find("img").attr("src", "/static/app/WebFactory/themes/default/images/down.svg");
                $(this).addClass("in");

                _this.initContent($(this).attr("data-id"));
            })
            //pdf下载
        $('.pdfDownCtn').on('click', function() {
                // 先去服务端拉打印需要的模板
                var promise;
                var arrHtml = [];
                Spinner.spin(document.body);
                var str = '<div class="billManageContainer">' + $(".rightCtn").html() + '</div>';
                arrHtml.push(str);
                var reportTitle = 'Bill Information'
                WebAPI.get('/static/views/share/reportWrap/coverPage.html').done(function(result) {
                    result = result.formatEL({
                        projectImg: 'http://images.rnbtech.com.hk/custom/project_img/error.png',
                        title: reportTitle,
                        logo: 'http://images.rnbtech.com.hk/custom/project_img/error.png',
                        date: $('.calendarCtn').children('input').val(),
                        projName: reportTitle
                    })

                    //处理echart的数据var pageHeight = 750;
                    var allEchartsArr = Array.prototype.map.call($('[_echarts_instance_]'), function(row) { return echarts.getInstanceByDom(row); });
                    var allEchartsDom = $('[_echarts_instance_]');
                    for (var i = 0, len = allEchartsArr.length; i < len; i++) {
                        var echartsId = allEchartsArr[i].id;
                        var echartsDom = allEchartsDom.filter('div[_echarts_instance_ = ' + echartsId + ']');
                        var echartsHtml = echartsDom.html();
                        var imgWidth = 210 * (echartsDom.width() / $('#centerCtn').width());
                        var imgUrl = allEchartsArr[i].getDataURL({ backgroundColor: '#fff' });
                        var img;
                        if (imgUrl) {
                            img = '<img src="' + imgUrl + '" style=" width:' + imgWidth + 'mm;"/>';
                        } else {
                            img = '<h4 style="width:' + imgWidth + 'px; height: 20px;">This chart has no data.</h4>';
                        }
                        arrHtml[0] = arrHtml[0].replace(echartsHtml, img);
                    }

                    // 先去服务端拉打印需要的模板
                    promise = WebAPI.get('/static/views/share/reportWrap/pdfTemplate.html');

                    // 在这里定义成功事件
                    promise.done(function(html) {
                        var xhr, formData;
                        // 生成最终的 html
                        html = html.formatEL({
                            projectImg: 'http://images.rnbtech.com.hk/custom/project_img/error.png',
                            title: reportTitle,
                            encoding: 'UTF-8',
                            entitiesHtml: arrHtml[0],
                            projName: reportTitle,
                            logo: 'http://images.rnbtech.com.hk/custom/project_img/error.png',
                            date: $('.calendarCtn').children('input').val(),
                            footerLeft: 'Generated by BeOP',
                            footerRight: "Page [page] of [topage]"
                        });

                        // 表单数据
                        formData = new FormData();
                        formData.append('html', html);
                        formData.append('cover', result);
                        formData.append('skin', 'default');

                        xhr = new XMLHttpRequest();
                        xhr.responseType = 'arraybuffer';
                        xhr.open('POST', '/admin/getShareReportWrapPDF');
                        xhr.onload = function() {
                            var blob, url, lkPdfFile;
                            if (this.status === 200) {
                                blob = new Blob([xhr.response], { type: "application/pdf" });
                                url = URL.createObjectURL(blob);

                                // 这里用 a 标签来模拟下载，而不直接使用 window.open
                                // 是因为 window.open 不能自定义下载文件的名称
                                // 而 a 标签可以通过设置 download 属性来自定义下载文件的名称
                                lkPdfFile = document.createElement('a');
                                lkPdfFile.style = "display: none";
                                lkPdfFile.id = "lkPdfFile";
                                lkPdfFile.href = url;
                                lkPdfFile.download = reportTitle + ' ' + $('.calendarCtn').children('input').val() + '.pdf';

                                document.body.appendChild(lkPdfFile);
                                lkPdfFile.click();
                                window.URL.revokeObjectURL(url);
                                window.setTimeout(function() {
                                    lkPdfFile.parentNode.removeChild(lkPdfFile);
                                }, 0);
                            } else {
                                alert('Generate report failed, please try it again soon!');
                            }
                            // 隐藏 loading
                            Spinner.stop();
                        };
                        xhr.send(formData);
                        // })

                    }).fail(function(e) {
                        throw e;
                    });
                })
            })
            //时间选择 内容切换 todo
    }

    destroy() {
        this.screen = null;
    }
}