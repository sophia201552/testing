/**
 * 模糊规则面板
 */
/**
 * State:
 * selectedItems: 选中的行
 * isShowConfigModal: 是否显示配置模态框
 *
 */
/**
 * Event
 *
 * addRow: 添加一行图形 x 轴配置
 * deleteRow: 删除一行图形 x 轴配置
 * _confirmRowArgs: 确认当前图形配置
 * _closeConfigModal: 关闭图形配置模态框
 * _inputValueChanged: 图形配置 input 轴值变化
 * _dropselectChange: 下拉
 *
 */

import React from 'react';
import PropTypes from 'prop-types';
import $ from 'jquery';
import {
  DetailsList,
  DetailsListLayoutMode,
  CheckboxVisibility,
  Selection
} from 'office-ui-fabric-react/lib/DetailsList';
import { Modal } from 'office-ui-fabric-react/lib/Modal';
import { Dropdown } from 'office-ui-fabric-react/lib/Dropdown';
import { DefaultButton } from 'office-ui-fabric-react/lib/Button';
import {
  Pivot,
  PivotItem,
  PivotLinkFormat
} from 'office-ui-fabric-react/lib/Pivot';

import { dataTypes } from 'StrategyV2-Engine/src/enum.js';

import {
  fuzzyRuleUnitNames,
  fuzzyRuleUnit,
  fuzzyRuleInputOutputTypes,
  fuzzyRuleInputOutputTypeNames
} from '../../../common/enum.js';
import TextToggle from '../../../components/TextToggle/TextToggle.js';
import Confirm from '../../../components/Confirm/Confirm.js';
import UnknownTooltip from '../../../components/UnknownTooltip';
import FuzzyRuleChartView from '../../../components/FuzzyRuleChartView';

import FuzzyRulesModalView from './FuzzyRuleModalView.js';
import s from './FuzzyRulesPanel.css';

// 单位下拉框
let unit_options = [
  {
    key: 'TEMPERATURE',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.TEMPERATURE]
  },
  {
    key: 'TEMPERATURE_F',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.TEMPERATURE_F]
  },
  {
    key: 'WEIGHT',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.WEIGHT]
  },
  {
    key: 'ENERGY',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.ENERGY]
  },
  {
    key: 'K_ENERGY',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.K_ENERGY]
  },
  {
    key: 'M_ENERGY',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.M_ENERGY]
  },
  {
    key: 'POWER',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.POWER]
  },
  {
    key: 'ELECTRIC',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.ELECTRIC]
  },
  {
    key: 'FREQUENCY',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.FREQUENCY]
  },
  {
    key: 'FREQUENCY_P',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.FREQUENCY_P]
  },
  {
    key: 'FLOW_S',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.FLOW_S]
  },
  {
    key: 'FLOW_H',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.FLOW_H]
  },
  {
    key: 'FLOW_M',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.FLOW_M]
  },
  {
    key: 'LEVEL',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.LEVEL]
  },
  {
    key: 'LEVEL_C',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.LEVEL_C]
  },
  {
    key: 'WATER_LEVEL',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.WATER_LEVEL]
  },
  {
    key: 'WATER_LEVEL_C',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.WATER_LEVEL_C]
  },
  {
    key: 'HIGHT',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.HIGHT]
  },
  {
    key: 'HIGHT_C',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.HIGHT_C]
  },
  {
    key: 'HIGHT_D',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.HIGHT_D]
  },
  {
    key: 'HIGHT_M',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.HIGHT_M]
  },
  {
    key: 'SPEED',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.SPEED]
  },
  {
    key: 'SPEED_K',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.SPEED_K]
  },
  {
    key: 'RADIATION',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.RADIATION]
  },
  {
    key: 'ILLUMINATION',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.ILLUMINATION]
  },
  {
    key: 'PRESSURE',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.PRESSURE]
  },
  {
    key: 'K_PRESSURE',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.K_PRESSURE]
  },
  {
    key: 'B_PRESSURE',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.B_PRESSURE]
  },
  {
    key: 'LOAD',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.LOAD]
  },
  {
    key: 'LOAD_H',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.LOAD_H]
  },
  {
    key: 'RATIO_E',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.RATIO_E]
  },
  {
    key: 'RATIO_O',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.RATIO_O]
  },
  {
    key: 'CONCENTRATION',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.CONCENTRATION]
  },
  {
    key: 'REN_MIN_BI',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.REN_MIN_BI]
  },
  {
    key: 'DOLLAR',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.DOLLAR]
  },
  {
    key: 'STATUS',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.STATUS]
  },
  {
    key: 'COMMOND',
    text: fuzzyRuleUnitNames[fuzzyRuleUnit.COMMOND]
  }
];
// 类型下拉框
let type_options = [
  {
    key: 'UNDEFINED',
    text: fuzzyRuleInputOutputTypeNames[fuzzyRuleInputOutputTypes.UNDEFINED]
  },
  {
    key: 'CONTINUOUS',
    text: fuzzyRuleInputOutputTypeNames[fuzzyRuleInputOutputTypes.CONTINUOUS]
  },
  {
    key: 'BOOL',
    text: fuzzyRuleInputOutputTypeNames[fuzzyRuleInputOutputTypes.BOOL]
  },
  {
    key: 'SETPOINT',
    text: fuzzyRuleInputOutputTypeNames[fuzzyRuleInputOutputTypes.SETPOINT]
  },
  {
    key: 'FORMULA',
    text: fuzzyRuleInputOutputTypeNames[fuzzyRuleInputOutputTypes.FORMULA]
  },
  {
    key: 'CONTINUOUSWITHSETPOINT',
    text:
      fuzzyRuleInputOutputTypeNames[
        fuzzyRuleInputOutputTypes.CONTINUOUSWITHSETPOINT
      ]
  },
  {
    key: 'SERIESANALYSISCODE',
    text:
      fuzzyRuleInputOutputTypeNames[
        fuzzyRuleInputOutputTypes.SERIESANALYSISCODE
      ]
  },
  {
    key: 'CUSTORMIZEDCONTINUOUS',
    text:
      fuzzyRuleInputOutputTypeNames[
        fuzzyRuleInputOutputTypes.CUSTORMIZEDCONTINUOUS
      ]
  }
];

class DiagnosisRelatedModal extends React.PureComponent {
  constructor(props) {
    super(props);
    this.state = {
      alias: '',
      status: 0,
      unit: 0,
      type: 0,
      check: 0,
      precision: 0
    };
    this._valueChange = this._valueChange.bind(this);
  }
  render() {
    const { params, index, selItem, i18n } = this.props;
    let { alias, status, precision, unit, check, type } =
      params[index] || selItem[0];
    return (
      <form className={s['formWrap']}>
        <ul>
          <li className={s['listWrap'] + ' clear-both'}>
            <div className={s['listName']}>
              <label>
                <span>{i18n.ALIAS}</span>
                <UnknownTooltip content={i18n.ANNOTATION_ALIAS} />
              </label>
              <div>
                <input
                  value={alias}
                  placeholder={i18n.ENTER_ALIAS}
                  onChange={this._valueChange.bind(this, 'alias')}
                />
              </div>
            </div>
            <div className={s['listdropDown']}>
              <label>
                <span>{i18n.UNIT}</span>
                <UnknownTooltip content={i18n.ANNOTATION_UNIT} />
              </label>
              <div>
                <Dropdown
                  className={s['Dropdown']}
                  onChanged={drop => {
                    this._dropdownChange(drop, 'unit');
                  }}
                  placeHolder={i18n.SELECT_UNIT}
                  options={unit_options}
                  selectedKey={
                    typeof unit !== 'number'
                      ? unit
                      : unit_options[unit] ? unit_options[unit].key : ''
                  }
                />
              </div>
            </div>
          </li>
          <li className={s['listWrap'] + ' clear-both'}>
            <div style={{ width: '100%' }}>
              <label>
                <span>{i18n.TYPE}</span>
                <UnknownTooltip content={i18n.ANNOTATION_ALIAS} />
              </label>
              <div>
                <Dropdown
                  className={s['Dropdown']}
                  onChanged={drop => {
                    this._dropdownChange(drop, 'type');
                  }}
                  options={type_options}
                  selectedKey={
                    typeof type !== 'number'
                      ? type
                      : type_options[type] ? type_options[type].key : 'BOOL'
                  }
                />
              </div>
            </div>
          </li>
          <li className={s['listWrap'] + ' clear-both'}>
            <div>
              <label>
                <span>{i18n.TIME_CHECK}</span>
                <UnknownTooltip content={i18n.ANNOTATION_TIME_CHECK} />
              </label>
              <div>
                <Dropdown
                  className={s['Dropdown']}
                  onChanged={drop => {
                    this._dropdownChange(drop, 'check');
                  }}
                  placeHolder={i18n.SELECT_UNIT}
                  options={[
                    {
                      key: 'YES',
                      text: i18n.YES
                    },
                    {
                      key: 'NO',
                      text: i18n.NO
                    }
                  ]}
                  selectedKey={
                    typeof check !== 'number'
                      ? check
                      : check === 0 ? 'YES' : 'NO'
                  }
                />
              </div>
            </div>
            <div className={s['listName']}>
              <label>
                <span>{i18n.SENSING_ACCURACY}</span>
                <UnknownTooltip content={i18n.ANNOTATION_SENSING_ACCURACY} />
              </label>
              <div>
                <input
                  value={precision}
                  placeholder={i18n.ENTER_NUMERIC_VALUE}
                  onChange={this._valueChange.bind(this, 'precision')}
                />
              </div>
            </div>
          </li>
          <li className={s['listWrap'] + ' clear-both'} />
          <li className={s['listWrap'] + ' clear-both'}>
            <div className={s['status']}>
              <label>
                <span>{i18n.STATE}</span>
              </label>
              <div>
                <TextToggle
                  defaultChecked={!!status}
                  offText="OFF"
                  onText="ON"
                  onClick={this._statusUpdate.bind(this, status)}
                />
              </div>
            </div>
          </li>
        </ul>
      </form>
    );
  }
  // 输入框值改变
  _valueChange(args, e) {
    let newValue = e.currentTarget.value;
    switch (args) {
      case 'precision':
        this.setState({
          precision: newValue
        });
        break;
      case 'alias':
        this.setState({
          alias: newValue
        });
        break;
    }
    this._onChange(args, args == 'precision' ? Number(newValue) : newValue);
  }
  _onChange(field, value) {
    const { index, onChange, params } = this.props;
    onChange('params', params.set(index, params[index].set(field, value)));
  }
  // 状态图表切换
  _statusUpdate(status) {
    this.setState({
      status: status ? 0 : 1
    });
    this._onChange('status', status ? 0 : 1);
  }
  // 下拉选项改变
  _dropdownChange(dropOpt, value) {
    const key = dropOpt.key;
    let newValue;
    switch (value) {
      case 'unit':
        this.setState({
          unit: key
        });
        newValue =
          typeof key === 'number'
            ? key
            : unit_options.findIndex(row => row.key === key);
        break;
      case 'type':
        this.setState({
          type: key
        });
        newValue =
          typeof key === 'number'
            ? key
            : type_options.findIndex(row => row.key === key);
        break;
      case 'check':
        this.setState({
          check: key
        });
        newValue = typeof key === 'number' ? key : key === 'YES' ? 0 : 1;
        break;
    }
    this._onChange(value, newValue);
  }
}

class FuzzyRulesPanel extends React.PureComponent {
  constructor(props) {
    super(props);
    this.state = {
      selectedItems: [],
      items: [],
      isShowConfigModal: false,
      isShowDiagnosisModal: false,
      selItem: [],
      isShowAddModal: false,
      addNewName: ''
    };

    this._selection = new Selection({
      onSelectionChanged: () => {
        let { data, updateModule } = this.props;
        let { params } = data.options;
        const { items } = this.state;
        const selectedItems = this._selection.getSelection();
        this.setState({ selectedItems });
        if (params.length == 0) {
          params = params.concat(items);
        }
        data = data.setIn(['options', 'params'], params);
        updateModule(data);
      }
    });
    this._columns = [
      {
        key: 'name',
        name: this.props.i18n.FUZZY_PARAM_NAME,
        minWidth: 140,
        maxWidth: 180,
        onRender: item => <div>{item['name']}</div>
      },
      {
        key: 'fuzzyView',
        name: this.props.i18n.FUZZY_VIEW,
        minWidth: 200,
        maxWidth: 200,
        onRender: (item, index) => {
          return (
            <div className={s['fuzzy_view']}>
              <FuzzyRuleChartView
                terms={item.terms}
                pos={item.pos}
                min={item.min}
                max={item.max}
                isDrawReact={false}
              />
            </div>
          );
        }
      },
      {
        key: 'realtimeValue',
        name: this.props.i18n.REAL_TIME_VALUE,
        minWidth: 50,
        maxWidth: 100,
        onRender: item => <div>{item['realtimeValue']}</div>
      },
      {
        key: 'results',
        name: this.props.i18n.RESULT,
        minWidth: 60,
        maxWidth: 100,
        onRender: item => <div>{item['results']}</div>
      },
      {
        key: 'otherConfig',
        name: this.props.i18n.OTHER_CONFIGURATION,
        minWidth: 100,
        maxWidth: 100,
        onRender: item => {
          return (
            <span className={s['other_config']}>
              {this.props.i18n.DIAGNOSIS_RELATED}
            </span>
          );
        }
      }
    ];
    this.showAddModal = this.showAddModal.bind(this);
    this._closeModal = this._closeModal.bind(this);
    this._addItem = this._addItem.bind(this);
    this.changeName = this.changeName.bind(this);
  }
  componentWillMount() {
    this.setState({
      items: []
    });
  }
  componentWillUpdate(nextProps, nextState) {
    const { selectedItems } = nextState;
  }
  componentWillReceiveProps(nextProps) {
    const { data, moduleInputData } = nextProps;
    const { params } = data.options;
    let inputData = moduleInputData.find(
      row => row.dataType === dataTypes['DS_OPT']
    );
    let newItems = [];
    if (params) {
      params.forEach(row => newItems.push(row));
    }
    if (inputData.data) {
      inputData.data.forEach(row => {
        if (newItems.findIndex(v => v.name === row.name) === -1) {
          let singleItem = {
            name: row.name,
            type: 0,
            alias: '',
            status: 1,
            unit: 0,
            check: 0,
            enabled: 1,
            min: 0,
            max: 100,
            precision: 0,
            pos: [0, 0],
            type: 0,
            terms: []
          };
          newItems.push(singleItem);
        }
      });
    }
    this.setState({
      items: newItems
    });
  }
  render() {
    let {
      items,
      selItem,
      selectedItems,
      isShowConfigModal,
      isShowDiagnosisModal,
      isShowAddModal,
      addNewName
    } = this.state;
    const { i18n, data } = this.props;
    let { params } = data.options;
    const paramsIndex =
      items.length !== 0 && selectedItems.length !== 0
        ? items.findIndex(v => v.name == selectedItems[0].name)
        : 0;
    return (
      <div className={s['container']}>
        <div
          className={s['leftWrap']}
          style={{
            width: selectedItems.length == 0 ? '100%' : 'calc(100% - 300px)'
          }}
        >
          <div className={s['toolsWrap'] + ' clear-both'}>
            <div className={s['fuzzy_text']}>
              <span>
                {i18n.MODULE_NAME} <UnknownTooltip content={i18n.ANNOTATION_MODULE_NAME} />
              </span>
            </div>
            <div className={s['tools'] + ' clear-both'}>
              <div className={s['toolItem']} onClick={this.showAddModal}>
                <i className={'ms-Icon ms-Icon--AddEvent'} />
                <span className={s['toolName']}>{i18n.ADD}</span>
              </div>
              <div className={s['icon-line']} />
              <div
                className={s['toolItem']}
                onClick={this._deleteItem.bind(this)}
              >
                <i className={'ms-Icon ms-Icon--Delete'} />
                <span className={s['toolName']}>{i18n.DELETE}</span>
              </div>
            </div>
          </div>
          <div className={s['list']}>
            <DetailsList
              headerClassName="strategy-list-header"
              items={items}
              columns={this._columns}
              setKey="set"
              layoutMode={DetailsListLayoutMode.justified}
              selection={this._selection}
              selectionPreservedOnEmptyClick={true}
              checkboxVisibility={CheckboxVisibility.always}
            />
            <Modal
              isOpen={isShowAddModal}
              onDismiss={this._closeModal}
              isBlocking={false}
            >
              <div className={s['addModal']}>
                <div className={s['modal-title']}>{i18n.ADD}</div>
                <div className={s['modal-body']}>
                  <label>Name:</label>
                  <input
                    type="text"
                    value={addNewName}
                    onChange={this.changeName}
                  />
                </div>
                <div className={s['modal-footer']}>
                  <DefaultButton
                    onClick={this._addItem}
                    text={i18n.OK}
                    primary={true}
                  />
                  <DefaultButton
                    onClick={this._closeModal}
                    text={i18n.CANCEL}
                  />
                </div>
              </div>
            </Modal>
          </div>
        </div>
        {items.length !== 0 && selectedItems.length !== 0 ? (
          <div className={s['rightWrap']}>
            <Pivot
              linkFormat={PivotLinkFormat.tabs}
              onLinkClick={this._handleLinkClick.bind(this)}
            >
              <PivotItem linkText={i18n.TERM_CONFIG} itemIcon="Diagnostic">
                <FuzzyRulesModalView
                  selItem={selectedItems}
                  onChange={this._onChange.bind(this)}
                  params={params}
                  index={paramsIndex == -1 ? 0 : paramsIndex}
                  i18n={i18n}
                />
              </PivotItem>
              <PivotItem
                linkText={i18n.DIAGNOSIS_RELATED}
                itemIcon="Questionnaire"
              >
                <DiagnosisRelatedModal
                  selItem={selectedItems}
                  onChange={this._onChange.bind(this)}
                  params={params}
                  index={paramsIndex == -1 ? 0 : paramsIndex}
                  i18n={i18n}
                />
              </PivotItem>
            </Pivot>
          </div>
        ) : (
          undefined
        )}
      </div>
    );
  }
  _handleLinkClick() {
    let { selectedItems, items } = this.state;
    const index = items.findIndex(v => v.name == selectedItems[0].name);
    const newSelectedItems = Object.assign(
      {},
      selectedItems[0],
      this.props.data.options.params[index]
    );
    this.setState({
      selectedItems: [newSelectedItems]
    });
  }
  // 删除
  _deleteItem() {
    let { selectedItems, items } = this.state;
    const { moduleInputData, i18n } = this.props;
    let inputData = moduleInputData.find(
      row => row.dataType === dataTypes['DS_OPT']
    ) || { data: false };
    let dsoptData = inputData.data || [],
      dsoptDataNamesSet = new Set(dsoptData.map(v => v.name));
    if (selectedItems.length <= 0) {
      Confirm({
        title: i18n.SELECT_DELETE_OF_THE_CONFIG,
        type: 'warning',
        onOk: () => {},
        onCancel: () => {}
      });
      return;
    }
    if (
      selectedItems.filter(item => dsoptDataNamesSet.has(item.name)).length > 0
    ) {
      Confirm({
        title: i18n.UNABLE_DELETE_DEFAULT_CONFIG,
        type: 'warning',
        onOk: () => {},
        onCancel: () => {}
      });
      return;
    }
    let newItems = [];
    if (selectedItems.length == 1) {
      newItems = items.filter(v => v.name !== selectedItems[0].name);
    } else {
      newItems = items.concat([]);
      for (var i = 0; i < selectedItems.length; i++) {
        newItems = newItems.filter(v => v.name !== selectedItems[i].name);
      }
    }
    this.setState({
      items: newItems
    });
    let propsData = this.props.data;
    propsData = propsData.setIn(['options', 'params'], newItems);
    this.props.updateModule(propsData);
  }
  showAddModal() {
    this.setState({
      isShowAddModal: true
    });
  }
  _closeModal() {
    this.setState({
      isShowAddModal: false,
      addNewName: ''
    });
  }
  changeName(e) {
    this.setState({
      addNewName: e.target.value
    });
  }
  // 添加
  _addItem() {
    let items = this.state.items.concat([]);
    const { addNewName } = this.state;
    let sameNameItem = items.find(row => {
      return row.name === addNewName;
    });
    if (!addNewName || sameNameItem) {
      Confirm({
        title: this.props.i18n.REQUIRED_NAME,
        type: 'warning',
        onOk: () => {},
        onCancel: () => {}
      });
      return;
    }
    let item = {
      name: addNewName,
      type: 0,
      alias: '',
      status: 1,
      unit: 0,
      check: 0,
      enabled: 1,
      min: 0,
      max: 100,
      precision: 0,
      pos: [0, 0],
      type: 0,
      terms: []
    };
    items.push(item);
    this.setState({
      items
    });
    let propsData = this.props.data;
    propsData = propsData.setIn(['options', 'params'], items);
    this.props.updateModule(propsData);
    this._closeModal();
  }
  /** 改变配置项 */
  _onChange(field, value) {
    if (typeof field === 'string') {
      field = [field];
    }
    this.props.updateModule(
      this.props.data.setIn(['options', ...field], value)
    );
  }
}
FuzzyRulesPanel.propTypes = {};

export default FuzzyRulesPanel;
