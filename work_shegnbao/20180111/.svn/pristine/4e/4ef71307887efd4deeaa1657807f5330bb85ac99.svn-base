/**
 * 以何种方式搜索控件
 */
import React, { PureComponent } from 'react';
import PropTypes from 'prop-types';

import { Dropdown } from 'office-ui-fabric-react/lib/Dropdown';
import { SearchBox } from 'office-ui-fabric-react/lib/SearchBox';
import moment from 'moment';
import {
  DatePicker,
  DayOfWeek,
  IDatePickerStrings
} from 'office-ui-fabric-react/lib/DatePicker';

import s from './SearchGroup.css';

/**
 * Props
 *
 * type: regex|range 搜索类型
 * selectedValue: '' | [] 搜索值
 * selectedKey: '' 搜索名
 * onChange: ()=>{} 选项改变
 * onSearch: ()=>{} 点击搜索按钮开始搜索
 */

/**
 * State
 *
 * key: '' 搜索名
 * value: ''| [] 搜索值
 * type: regex|range 搜索类型
 * placeholder: '' | []
 * startTime: 开始时间(以时间搜索时存在)
 * endTime: 结束时间(以时间搜索时存在)
 * pointValueRange: [最小值, 最大值](以点值范围搜索是存在)
 *
 */

class SearchGroup extends React.PureComponent {
  constructor(props) {
    super(props);
    this.state = {
      key: props.selectedKey || 'originalPointName',
      value: props.selectedValue || '',
      startTime: '',
      endTime: '',
      pointValueRange: ['', ''],
      placeholder: props.i18n.ENTER_ORIGINAL_POINT_NAME,
      type: props.type || 'regex'
    };
    this._onChange = this._onChange.bind(this);
    this.options = [
      {
        key: 'originalPointName',
        text: props.i18n.SEACH_BY_ORIGINAL_POINT_NAME,
        type: 'regex'
      },
      {
        key: 'tag',
        text: props.i18n.SEARCH_BY_TAG,
        type: 'regex'
      },
      {
        key: 'sitePointName',
        text: props.i18n.SEARCH_BY_SITE_POINT_NAME,
        type: 'regex'
      },
      {
        key: 'realtimeValue',
        text: props.i18n.SEARCH_BY_POINT_VALUE,
        type: 'regex'
      },
      {
        key: 'realtimeValue_range',
        text: props.i18n.SEARCH_BY_POINT_VALUE_RANGE,
        type: 'range'
      },
      {
        key: 'realtimeValueUpdateTime',
        text: props.i18n.SEARCH_BY_UPDATE_TIME,
        type: 'range'
      },
      {
        key: 'pointAnnotation',
        text: props.i18n.SEARCH_BY_ANNOTATION,
        type: 'regex'
      }
    ];
  }
  render() {
    const {
      startTime,
      endTime,
      pointValueRange,
      placeholder,
      key,
      value
    } = this.state;
    const { i18n } = this.props;
    return (
      <div className={s['SearchGroupWrap']}>
        <div className={s['dropDownWrap']}>
          <Dropdown
            className={s['Dropdown']}
            onChanged={this._onChange}
            selectedKey={key}
            options={this.options}
          />
        </div>
        <div className={s['searchWrap']}>
          <div
            className={`${s['timePickerWrap']}${
              key === 'realtimeValueUpdateTime' ? '' : ' hide'
            } `}
          >
            <DatePicker
              highlightCurrentMonth={true}
              isMonthPickerVisible={false}
              allowTextInput={true}
              value={startTime}
              disabled={false}
              placeholder={placeholder[0] ? placeholder[0] : ''}
              formatDate={value => moment(value).format('YYYY-MM-DD')}
              showGoToToday={false}
              disableAutoFocus={true}
              onSelectDate={date => this._onSelectDate(date, 'startTime')}
            />
            <div className={s['toTime']}>
              <span>to</span>
            </div>
            <DatePicker
              highlightCurrentMonth={true}
              isMonthPickerVisible={false}
              allowTextInput={true}
              value={endTime}
              disabled={false}
              placeholder={placeholder[1] ? placeholder[1] : ''}
              formatDate={value => moment(value).format('YYYY-MM-DD')}
              showGoToToday={false}
              disableAutoFocus={true}
              onSelectDate={date => this._onSelectDate(date, 'endTime')}
            />
          </div>
          <div
            className={`${s['search']}${
              key === 'realtimeValue_range' || key === 'realtimeValueUpdateTime'
                ? ' hide'
                : ''
            } `}
          >
            <SearchBox
              labelText={placeholder}
              onChange={this._onSearchValueChange.bind(this)}
              value={value}
            />
          </div>
          <div
            className={`${s['pointValueWrap']}${
              key === 'realtimeValue_range' ? '' : ' hide'
            } `}
          >
            <div className={s['spinButtonWrap']}>
              <SpinButton
                value={
                  (key === 'realtimeValue_range' && value[0]) ||
                  pointValueRange[0]
                }
                typeText={placeholder[0] ? placeholder[0] : ''}
                changeValue={this._changeValue.bind(this, 'min')}
              />
            </div>
            <div className={s['toTime']}>
              <span>to</span>
            </div>
            <div className={s['spinButtonWrap']}>
              <SpinButton
                value={
                  (key === 'realtimeValue_range' && value[1]) ||
                  pointValueRange[1]
                }
                typeText={placeholder[1] ? placeholder[1] : ''}
                changeValue={this._changeValue.bind(this, 'max')}
              />
            </div>
          </div>
        </div>
        <div className={s['searchBtn']} onClick={this._onSearch.bind(this)}>
          <span>{i18n.SEARCH}</span>
        </div>
      </div>
    );
  }
  _onChange(dropOpt) {
    let {
      pointValueRange,
      startTime,
      endTime,
      placeholder,
      value,
      key
    } = this.state;
    let { onChange = () => {}, i18n } = this.props;
    key = dropOpt.key;
    switch (dropOpt.key) {
      case 'originalPointName':
        placeholder = i18n.ENTER_ORIGINAL_POINT_NAME;
        value = '';
        break;
      case 'tag':
        placeholder = i18n.ENTER_ORIGINAL_POINT_NAME;
        value = '';
        break;
      case 'sitePointName':
        placeholder = i18n.ENTER_SITE_POINT_NAME;
        value = '';
        break;
      case 'realtimeValue':
        placeholder = i18n.ENTER_POINT_VALUE;
        value = '';
        break;
      case 'realtimeValue_range':
        placeholder = [i18n.MIN, i18n.MAX];
        value = pointValueRange;
        break;
      case 'realtimeValueUpdateTime':
        placeholder = [
          i18n.START_TIME,
          i18n.END_TIME
        ];
        value = [startTime, endTime];
        break;
      case 'pointAnnotation':
        placeholder = i18n.ENTER_ANNOTATION;
        value = '';
        break;
    }
    this.setState({
      placeholder,
      type: dropOpt.type,
      key,
      value
    });
    onChange(key, value, dropOpt.type);
  }
  /* 时间改变*/
  _onSelectDate(date, timeType) {
    const { value } = this.state;
    if (timeType == 'startTime') {
      this.setState({
        startTime: date,
        value: [moment(date).format('YYYY-MM-DD'), value[1]]
      });
    } else {
      this.setState({
        endTime: date,
        value: [value[0], moment(date).format('YYYY-MM-DD')]
      });
    }
  }
  _changeValue(arg, value) {
    let { pointValueRange } = this.state;
    pointValueRange = pointValueRange.concat([]);
    if (arg == 'min') {
      pointValueRange = [value, pointValueRange[1]];
    } else {
      pointValueRange = [pointValueRange[0], value];
    }
    this.setState({
      pointValueRange,
      value: pointValueRange
    });
  }
  _onSearchValueChange(value) {
    this.setState({
      value
    });
  }
  _onSearch() {
    let { key, value, type } = this.state;
    let { onSearch = () => {} } = this.props;
    onSearch(key, value, type);
  }
}

class SpinButton extends React.PureComponent {
  render() {
    const { value, typeText } = this.props;
    return (
      <div className={s['inputWrap']}>
        <input
          id="input"
          placeholder={typeText}
          onChange={this._changeValue.bind(this)}
          value={value}
        />
        <label
          className={s['ChevronUp']}
          onClick={this._changeValue.bind(this, 'add')}
        >
          <i className="ms-Icon ms-Icon--ChevronUp" aria-hidden="true" />
        </label>
        <label
          className={s['ChevronDown']}
          onClick={this._changeValue.bind(this, 'delete')}
        >
          <i className="ms-Icon ms-Icon--ChevronDown" aria-hidden="true" />
        </label>
      </div>
    );
  }

  _changeValue(e) {
    const { value, changeValue = () => {} } = this.props;
    let newValue = Number(value);
    if (e.target) {
      newValue = e.target.value;
    } else {
      if (e === 'add') {
        newValue = newValue + 1;
      } else if (e === 'delete') {
        newValue = newValue - 1;
      }
    }
    changeValue(newValue);
  }
}
export default SearchGroup;
