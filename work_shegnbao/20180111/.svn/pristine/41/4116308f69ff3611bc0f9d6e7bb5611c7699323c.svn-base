var TagTree = (function(){
    function TagTree(screen,container,option){
        this.screen = screen;
        this.container = container;
        this.option = option;
        this.settting = undefined;

        this.async = [];
        this.instance = undefined;
        this.store = [];
        this.$initPromise;
        this.init();
    }
    TagTree.prototype = {
        onNodeCreated:function(e, treeId, treeNode) {
            
            // treeNode.config = {
            //     'energy':'57e1edf6833c974ea4f43a3c',
            //     'cost' :'57b6a4e4833c9749a498c523',
            //     'power':'57a98db41c95477ae88f694c',
            //     'detail':[
            //         {'name':'Ia','point':'57a98db41c95477ae88f694c'},
            //         {'name':'Ib','point':'57a98db41c95477ae88f694c'},
            //         {'name':'Ic','point':'57a98db41c95477ae88f694c'},
            //         {'name':'ua','point':'57a98db41c95477ae88f694c'},
            //         {'name':'ub','point':'57a98db41c95477ae88f694c'},
            //         {'name':'uc','point':'57a98db41c95477ae88f694c'},
            //         {'name':'uab','point':'57a98db41c95477ae88f694c'},
            //         {'name':'ucb','point':'57a98db41c95477ae88f694c'},
            //         {'name':'uac','point':'57a98db41c95477ae88f694c'},
            //         {'name':'fac','point':'57a98db41c95477ae88f694c'},
            //         {'name':'energy','point':'57a98db41c95477ae88f694c'}
            //     ]
            // }
        },
        onNodeClick:function(event, treeId, treeNode, flag) {
            if(flag == 0){
                this.cancelGroup(treeNode);
            }
            this.instance.expandNode(treeNode)
            let selectedNodes = this.instance.getSelectedNodes();
            this.screen.onNodeClick && this.screen.onNodeClick(selectedNodes)
        },
        cancelGroup:function(treeNode) {
            if(!treeNode.isParent){
                return;
            }
            treeNode.children.forEach(node=>{
                this.instance.cancelSelectedNode(node);
                this.cancelGroup(node);
            });
        },
        // addHideIdSet:function(children,idSet,isNeedAdd=false) {
        //     children.forEach(c=>{
        //         if(isNeedAdd){
        //             idSet.add(c.id);
        //         }
        //         if(c.isParent && c.children){
        //             this.addHideIdSet(c.children, idSet, true);
        //         }
        //     });
        // },
        // selectGroup:function(treeNodes, idSet) {
        //     let activeEntities = [];
        //     treeNodes.forEach(node=>{
        //         if(!idSet.has(node.id)){
        //             activeEntities.push(node);
        //         }
        //     });
        //     return activeEntities;
        // },
        init:function(){
            var _this = this;
            this.initSetting();
            this.$initPromise = $.Deferred();
            this.async.forEach(item=>{item.abort()})
            this.async = [];
            this.async.push(this.getData())
            this.async.push(this.getConfigData())
            $.when(...this.async).done((data,config)=>{
                _this.initTagTree(config);
            }).always(()=>{
                this.async = [];
            });
        },
        initSetting:function(){
            this.setting={
                view:{
                    addDiyDom: null,
                    showLine: false,
                    dblClickExpand: false,
                    autoCancelSelected: true,
                    showIcon: true,
                },
                data:{
                    keep:{
                        leaf: true,
                        parent: true
                    },
                    simpleData:{
                        enable: true,
                        pIdKey: 'parent'
                    }
                },
                edit:{
                    enable: true,
                    showRemoveBtn: false,
                    showRenameBtn: false,
                },
                callback:{
                    onNodeCreated: this.onNodeCreated.bind(this),
                    onClick: this.onNodeClick.bind(this)
                }
            }
        },
        getData:function() {
            // return $.get('/diagnosis_v2/getEntities',{"projectId": this.option.projectId}).done(rs=>{
            //     if(rs && rs.status=='OK'){
            //         this.store = rs.data;
            //     }
            // })
            var point = '@' + AppConfig.projectId + '|EnergyManagement_Entity_List' ;
            if (AppConfig.energyCurrent){
                point += '_' + AppConfig.energyCurrent
            }
            return WebAPI.post('/analysis/startWorkspaceDataGenPieChart',{"dsItemIds": [point]}).done(rs=>{
//                 rs ={dsItemList: [{data:`{
//     "data": [
//         {
//             "id": 1001,
//             "name": "2FMIC-A",
//             "parent": 0
//         },
//         {
//             "id": 2001,
//             "name": "2FMIC-B",
//             "parent": 0
//         },
//         {
//             "id": 3001,
//             "name": "2FMIC-C",
//             "parent": 0
//         },
//         {
//             "id": 4001,
//             "name": "2FMIC-D",
//             "parent": 0
//         },
//         {
//             "id": 1101,
//             "name": "2F2MIC-2A",
//             "parent": 1001
//         },
//         {
//             "id": 1201,
//             "name": "2F3MIC-3A",
//             "parent": 1001
//         },
//         {
//             "id": 1301,
//             "name": "2FCMIC-A",
//             "parent": 1001
//         },
//         {
//             "id": 1302,
//             "name": "2FC4MIC-CA",
//             "parent": 1301
//         },
//         {
//             "id": 1312,
//             "name": "1FC4MIC-CA",
//             "parent": 1302
//         },
//         {
//             "id": 1303,
//             "name": "2FCMIC-AA",
//             "parent": 1301
//         },
//         {
//             "id": 1401,
//             "name": "2FMIC-AA",
//             "parent": 1001
//         },
//         {
//             "id": 1501,
//             "name": "2FMIC-WNA",
//             "parent": 1001
//         },
//         {
//             "id": 1601,
//             "name": "2FMIC-WSA",
//             "parent": 1001
//         },
//         {
//             "id": 1701,
//             "name": "AIR COMP-N",
//             "parent": 1001
//         },
//         {
//             "id": 1801,
//             "name": "AIR COMP-S",
//             "parent": 1001
//         },
//         {
//             "id": 2101,
//             "name": "2F3MIC-3B",
//             "parent": 2001
//         },
//         {
//             "id": 2201,
//             "name": "2F3MIC-AB",
//             "parent": 2001
//         },
//         {
//             "id": 2301,
//             "name": "2F3MIC-CB",
//             "parent": 2001
//         },
//         {
//             "id": 2401,
//             "name": "2FMIC-1B",
//             "parent": 2001
//         },
//         {
//             "id": 2501,
//             "name": "2FMIC-BB",
//             "parent": 2001
//         },
//         {
//             "id": 2601,
//             "name": "NewTripUnit",
//             "parent": 2001
//         },
//         {
//             "id": 3101,
//             "name": "2F3MIC-BC",
//             "parent": 3001
//         },
//         {
//             "id": 3201,
//             "name": "2F3MIC-DC",
//             "parent": 3001
//         },
//         {
//             "id": 3301,
//             "name": "2FCMIC-C",
//             "parent": 3001
//         },
//         {
//             "id": 3302,
//             "name": "2FC4MIC-DC",
//             "parent": 3301
//         },
//         {
//             "id": 3312,
//             "name": "1FC4MIC-DC",
//             "parent": 3302
//         },
//         {
//             "id": 3303,
//             "name": "2FCMIC-1C",
//             "parent": 3301
//         },
//         {
//             "id": 3304,
//             "name": "2FCMIC-BC",
//             "parent": 3301
//         },
//         {
//             "id": 3401,
//             "name": "2FMIC-1C",
//             "parent": 3001
//         },
//         {
//             "id": 3501,
//             "name": "Chiller1",
//             "parent": 3001
//         },
//         {
//             "id": 3601,
//             "name": "Chiller2",
//             "parent": 3001
//         },
//         {
//             "id": 3701,
//             "name": "Chiller3",
//             "parent": 3001
//         },
//         {
//             "id": 4101,
//             "name": "2F4MIC-CD",
//             "parent": 4001
//         },
//         {
//             "id": 4102,
//             "name": "1F4MIC-CD",
//             "parent": 4101
//         },
//         {
//             "id": 4201,
//             "name": "2F4MIC-DD",
//             "parent": 4001
//         },
//         {
//             "id": 4202,
//             "name": "1F4MIC-DD",
//             "parent": 4201
//         },
//         {
//             "id": 4301,
//             "name": "2FCMIC-D",
//             "parent": 4001
//         },
//         {
//             "id": 4302,
//             "name": "2FC3MIC-BD",
//             "parent": 4301
//         },
//         {
//             "id": 4303,
//             "name": "2FC4MIC-END",
//             "parent": 4301
//         },
//         {
//             "id": 4304,
//             "name": "2FC4MIC-ESD",
//             "parent": 4301
//         },
//         {
//             "id": 4305,
//             "name": "2FCMIC-AD",
//             "parent": 4301
//         },
//         {
//             "id": 4401,
//             "name": "2FMIC-MCD",
//             "parent": 4001
//         }
//     ],
//     "unit": {"name":"Wh","level":1},
//     "status": "OK"
// }`}]}
                var data = {};
                try {
                    if (AppConfig.projectCurrent && AppConfig.projectCurrent.i18n == 1) {
                        data = JSON.parse(JSON.parse(I18n.trans(JSON.stringify(rs.dsItemList[0].data))))
                    } else {
                        data = JSON.parse(rs.dsItemList[0].data)
                    }
                    this.store = data.data;
                    if (data.unit){
                        if (data.unit.name)AppConfig.energyUnit.name = data.unit.name;
                        if (data.unit.level || data.unit.level == 0)AppConfig.energyUnit.level = data.unit.level
                        if (data.unit.name_power)AppConfig.energyUnit.name_power = data.unit.name_power;
                    }
                }catch(e){
                    this.store = [];
                }
            })
        },
        getConfigData:function() {
            return this.screen.getNodeConfig()
            // return $.get('/tag/energyConfig/'+ this.option.projectId).done(rs=>{
            //     if(rs && rs.status=='OK'){
            //         this.store = rs.data;
            //     }
            // })
        },
        initTagTree:function(configData){
            let $wrap = $(this.container).find('.itemList');
            if($wrap.length == 0){
                $wrap=$(`<ul id="${+new Date()}" class="itemList ztree"></ul>`)
                $(this.container).append($wrap)
            }
            let parentIdSet = new Set();
            this.store.forEach((v)=>{
                parentIdSet.add(v.parent);
            });
            this.instance && this.instance.destroy();
            this.store.forEach((v)=>{
                if (configData instanceof Array){
                    for (var j = 0 ; j < configData.length ;j++){
                        if (configData[j].entityId == v.id){
                            v.config = configData[j]
                            break;
                        }
                    }
                }
                if(parentIdSet.has(v.id)){
                    v.iconSkin = `id_${v.id} iconfont icon-xiayiji none`;
                }else{
                    v.iconSkin = `id_${v.id} no-icon none`;
                }
            });
            this.instance = $.fn.zTree.init($wrap, this.setting, this.store);
            this.$initPromise.resolve();
        },
        getRootNode:function(){

        },
        getChildNode:function(node){
            var point = node
            if (typeof point == 'undefined'){
                point = this.screen.store[0]
            }
            if(point && point.hasOwnProperty('id')){
                return this.instance.getNodesByParam('parent',point['id'])
            }else{
                return [];
            }
        },
        attachEvent:function(){

        },
        destroy:function(){
            this.async.forEach(item=>{
                item.abort && item.abort()
                item.reject && item.reject()
            })
            this.instance && this.instance.destroy();
        }
    }
    return TagTree
}())